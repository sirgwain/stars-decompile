# ExportAllDecompiled.py
# @category Stars
# @description: Export decompiled code for ALL functions to a file
#
# Usage (headless): -postScript ExportAllDecompiled.py <output_file> [segment_filter]
# Example: ExportAllDecompiled.py all_funcs.c
# Example: ExportAllDecompiled.py segment_1078.c 1078

import os
import sys

from ghidra.app.decompiler import DecompInterface
from ghidra.util.task import ConsoleTaskMonitor


def decompile_function(func, decomp):
    """Decompile a function and return the C code."""
    try:
        monitor = ConsoleTaskMonitor()
        result = decomp.decompileFunction(func, 60, monitor)

        if result.decompileCompleted():
            return result.getDecompiledFunction().getC()
        else:
            return "// Decompilation failed: %s" % result.getErrorMessage()
    except Exception as e:
        return "// Decompilation error: %s" % str(e)


def main():
    args = getScriptArgs()

    if len(args) < 1:
        println("Usage: ExportAllDecompiled.py <output_file> [segment_filter]")
        println("")
        println("Example: ExportAllDecompiled.py all_funcs.c")
        println("Example: ExportAllDecompiled.py segment_1078.c 1078")
        return

    output_file = args[0]
    segment_filter = args[1] if len(args) > 1 else None

    println("Output file: %s" % output_file)
    if segment_filter:
        println("Segment filter: %s" % segment_filter)

    fm = currentProgram.getFunctionManager()

    decomp = DecompInterface()
    decomp.openProgram(currentProgram)

    try:
        with open(output_file, "w") as f:
            f.write("// Decompiled code from stars.exe\n")
            f.write("// Generated by Ghidra - ExportAllDecompiled.py\n")
            f.write("// \n\n")

            count = 0
            total = fm.getFunctionCount()
            println("Total functions: %d" % total)

            for func in fm.getFunctions(True):
                addr = str(func.getEntryPoint())
                name = func.getName()

                # Apply segment filter if specified
                if segment_filter and not addr.startswith(segment_filter):
                    continue

                count += 1
                if count % 100 == 0:
                    println("Progress: %d functions processed" % count)

                f.write("// " + "=" * 70 + "\n")
                f.write("// Function: %s\n" % name)
                f.write("// Address: %s\n" % addr)
                f.write("// " + "=" * 70 + "\n\n")

                code = decompile_function(func, decomp)
                if code:
                    f.write(code)
                    f.write("\n\n")
                else:
                    f.write("// No code generated\n\n")

            println("Exported %d functions to: %s" % (count, output_file))

    finally:
        decomp.dispose()


if __name__ == "__main__":
    main()
