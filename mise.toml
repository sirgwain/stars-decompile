# Stars! Decompilation Project Tasks
# Configure Ghidra path via GHIDRA_HOME environment variable

# If you want to customize something locally
# just create a file named mise.local.toml (which is git ignored)
# and modify any value from this file into the
# local version.
#
# To know from which file an env var comes from
# use the `mise set` command

[env]
# Default Ghidra path - override with: export GHIDRA_HOME=/path/to/ghidra
# Uses shell's GHIDRA_HOME if set, otherwise falls back to default in scripts
GHIDRA_HOME_ = "~/.local/ghidra/ghidra_12.1_DEV"

# Project paths (relative to this file)
PROJECT_DIR = "{{ cwd }}"
GHIDRA_PROJECT = "{{ cwd }}/ghidra_project"
SCRIPTS_DIR = "{{ cwd }}/scripts/ghidra_scripts"
TARGET_EXE = "{{ cwd }}/target/stars.exe"
JSON_GLOBALS = "{{ cwd }}/scripts/nb09_ghidra_globals.json"
JSON_STRUCTS = "{{ cwd }}/scripts/nb09_structmeta.json"
WINDOWS_H = "{{ cwd }}/scripts/ghidra_scripts/includes/WINDOWS.H"
ENUMS_H = "{{ cwd }}/scripts/ghidra_scripts/includes/enums.h"

[tasks.unzip-stars]
description = "Extract stars.exe from the archive"
run = '''
#!/bin/bash
set -e

cd "$PROJECT_DIR/target"
if [ ! -f "stars.exe" ]; then
    echo "Extracting stars26jrc3.zip..."
    unzip -o stars26jrc3.zip
else
    echo "stars.exe already exists"
fi
'''

[tasks.ghidra-import]
description = "Import stars.exe into Ghidra project (16-bit Protected Mode)"
depends = ["unzip-stars"]
run = '''
#!/bin/bash
set -e

mkdir -p "$GHIDRA_PROJECT"

# Use GHIDRA_HOME if set, otherwise fall back to GHIDRA_HOME_
GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
# Expand tilde
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

if [ ! -f "$ANALYZER" ]; then
    echo "Error: Ghidra not found at $GHIDRA_EXPANDED"
    echo "Set GHIDRA_HOME environment variable to your Ghidra installation"
    exit 1
fi

# Fix decompiler permissions if needed
chmod +x "$GHIDRA_EXPANDED/Ghidra/Features/Decompiler/os/linux_x86_64/decompile" 2>/dev/null || true

echo "Importing $TARGET_EXE into Ghidra project..."
bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -import "$TARGET_EXE" \
    -processor "x86:LE:16:Protected Mode" \
    -overwrite
'''

[tasks.ghidra-apply-structs]
description = "Apply NB09 struct definitions to Ghidra project"
run = '''
#!/bin/bash
set -e

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

if [ ! -f "$ANALYZER" ]; then
    echo "Error: Ghidra not found at $GHIDRA_EXPANDED"
    exit 1
fi

echo "Applying struct definitions from $JSON_STRUCTS..."
bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript ApplyNb09StructPackingFromJson.py "$JSON_STRUCTS"
'''

[tasks.ghidra-apply-names]
description = "Apply NB09 function and global names to Ghidra project"
run = '''
#!/bin/bash
set -e

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

if [ ! -f "$ANALYZER" ]; then
    echo "Error: Ghidra not found at $GHIDRA_EXPANDED"
    exit 1
fi

echo "Applying names from $JSON_GLOBALS..."
bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript ApplyNb09NamesFromJson.py "$JSON_GLOBALS"
'''

[tasks.ghidra-apply-globals]
description = "Apply NB09 global variable types to Ghidra project"
run = '''
#!/bin/bash
set -e

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

if [ ! -f "$ANALYZER" ]; then
    echo "Error: Ghidra not found at $GHIDRA_EXPANDED"
    exit 1
fi

echo "Applying global types from $JSON_GLOBALS..."
bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript ApplyNb09GlobalsFromJson.py "$JSON_GLOBALS"
'''

[tasks.ghidra-apply-funcsigs]
description = "Apply NB09 function signatures to Ghidra project"
run = '''
#!/bin/bash
set -e

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

if [ ! -f "$ANALYZER" ]; then
    echo "Error: Ghidra not found at $GHIDRA_EXPANDED"
    exit 1
fi

echo "Applying function signatures from $JSON_GLOBALS..."
bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript ApplyNb09FuncSigsFromJson.py "$JSON_GLOBALS"
'''

[tasks.ghidra-apply-win16api]
description = "Apply Win16 Windows API signatures to Ghidra project"
run = '''
#!/bin/bash
set -e

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

if [ ! -f "$ANALYZER" ]; then
    echo "Error: Ghidra not found at $GHIDRA_EXPANDED"
    exit 1
fi

echo "Renaming Win16 API functions..."
bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript FixWin16LibraryFunctionNames.java

echo "Applying Win16 API signatures..."
bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript UpdateWin16WindowsApiSignatures.py "$WINDOWS_H"
'''

[tasks.ghidra-analyze]
description = "Run the analyzer"
run = '''
#!/bin/bash
set -e

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

if [ ! -f "$ANALYZER" ]; then
    echo "Error: Ghidra not found at $GHIDRA_EXPANDED"
    exit 1
fi

echo "Applying struct definitions from $JSON_STRUCTS..."
bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe
'''

[tasks.ghidra-setup]
description = "Full Ghidra setup: import binary and apply all symbol scripts"
run = [
    { task = "unzip-stars" },
    { task = "ghidra-import" },
    { task = "ghidra-create-enums" },
    { task = "ghidra-apply-win16api" },
    { task = "ghidra-apply-structs" },
    { task = "ghidra-apply-names" },
    { task = "ghidra-apply-globals" },
    { task = "ghidra-apply-funcsigs" },
    { task = "ghidra-update-runtime-helpers" },
    { task = "ghidra-retype-doubles" },
]

[tasks.ghidra-gui]
description = "Launch Ghidra GUI"
run = '''
#!/bin/bash
GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"

if [ ! -f "$GHIDRA_EXPANDED/support/pyghidraRun" ]; then
    echo "Error: Ghidra not found at $GHIDRA_EXPANDED"
    echo "Set GHIDRA_HOME environment variable to your Ghidra installation"
    exit 1
fi

echo "Launching Ghidra..."
echo "Project location: $GHIDRA_PROJECT/Stars.gpr"
"$GHIDRA_EXPANDED/support/pyghidraRun" &
'''

[tasks.ghidra-parse-windowsh]
description = "Parse WINDOWS.H and import Win16 types (GUI recommended instead)"
run = '''
#!/bin/bash
set -e

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

if [ ! -f "$WINDOWS_H" ]; then
    echo "Error: WINDOWS.H not found at $WINDOWS_H"
    exit 1
fi

echo "Parsing WINDOWS.H for Win16 types..."
echo ""
echo "NOTE: Headless C parsing can be unreliable. If this fails, use the GUI:"
echo "  1. Open Ghidra GUI: mise run ghidra-gui"
echo "  2. File > Parse C Source..."
echo "  3. Add: $WINDOWS_H"
echo "  4. Parse"
echo ""

bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript ImportWindowsH.py "$WINDOWS_H" 2>&1
'''

[tasks.ghidra-update-runtime-helpers]
description = "Update the known runtime helper functions (i.e. __aFl*/__aFul*) signatures"
run = '''
#!/bin/bash
set -e

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

echo "Updating runtime helper signatures..."
echo ""

bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript UpdateStarsRuntimeHelperSignatures.py  2>&1
'''

[tasks.ghidra-retype-doubles]
description = "Update the unknown8 vars in 1120:* to be doubles"
run = '''
#!/bin/bash
set -e

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

echo "Updating runtime helper signatures..."
echo ""

bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript RetypeUndefined8Doubles1120.py  2>&1
'''

[tasks.ghidra-create-enums]
description = "Create enum types from enums.h"
run = '''
#!/bin/bash
set -e

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

echo "Updating runtime helper signatures..."
echo ""

bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript CreateEnumsFromHeader.py "$ENUMS_H" 2>&1
'''

[tasks.extract-symbols]
description = "Re-extract symbols from the NE executable (requires Python)"
run = '''
#!/bin/bash
cd "$PROJECT_DIR/scripts"
python3 extract_nb09.py ../target/stars.exe
'''

[tasks.list-functions]
description = "List functions matching a pattern (usage: mise run list-functions -- pattern)"
run = '''
#!/bin/bash
set -e

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript ListFunctions.py "${1:-}" 2>&1
'''

[tasks.decompile]
description = "Decompile a function by name (usage: mise run decompile -- FunctionName)"
run = '''
#!/bin/bash
set -e

if [ -z "$1" ]; then
    echo "Usage: mise run decompile -- <function_name>"
    echo ""
    echo "Examples:"
    echo "  mise run decompile -- LpflFromId"
    echo "  mise run decompile -- LpthFromId"
    echo "  mise run decompile -- LpplFromId"
    exit 1
fi

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

if [ ! -f "$ANALYZER" ]; then
    echo "Error: Ghidra not found at $GHIDRA_EXPANDED"
    exit 1
fi

bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript DecompileFunction.py "$1" 2>&1
'''

[tasks.dump-asm]
description = "Dump assembly listing for a function (usage: mise run dump-asm -- FunctionName)"
run = '''
#!/bin/bash
set -e

if [ -z "$1" ]; then
    echo "Usage: mise run dump-asm -- <function_name>"
    echo ""
    echo "Example: mise run dump-asm -- CalcPlayerScore"
    exit 1
fi

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

if [ ! -f "$ANALYZER" ]; then
    echo "Error: Ghidra not found at $GHIDRA_EXPANDED"
    exit 1
fi

bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript DumpAsm.py "$1" 2>&1
'''

[tasks.export-decompiled]
description = "Export decompiled code to a file (usage: mise run export-decompiled -- output.c Func1 Func2 ...)"
run = '''
#!/bin/bash
set -e

if [ -z "$1" ] || [ -z "$2" ]; then
    echo "Usage: mise run export-decompiled -- <output_file> <func1> [func2] ..."
    echo ""
    echo "Example: mise run export-decompiled -- decompiled/util.c LpflFromId LpplFromId"
    exit 1
fi

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

OUTPUT_FILE="$1"
shift

# Create output directory if needed
mkdir -p "$(dirname "$OUTPUT_FILE")"

bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript ExportDecompiled.py "$OUTPUT_FILE" "$@" 2>&1 | \
    grep -E "^INFO.*GhidraScript|Processing|OK|NOT FOUND|Output written" || true
'''

[tasks.export-call-tree]
description = "Export a function and all functions it calls (usage: mise run export-call-tree -- output.c FuncName [depth])"
run = '''
#!/bin/bash
set -e

if [ -z "$1" ] || [ -z "$2" ]; then
    echo "Usage: mise run export-call-tree -- <output_file> <root_func> [max_depth]"
    echo ""
    echo "Example: mise run export-call-tree -- decompiled/io.c FLoadGame 3"
    exit 1
fi

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

OUTPUT_FILE="$1"
ROOT_FUNC="$2"
MAX_DEPTH="${3:-3}"

# Create output directory if needed
mkdir -p "$(dirname "$OUTPUT_FILE")"

bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript ExportCallTree.py "$OUTPUT_FILE" "$ROOT_FUNC" "$MAX_DEPTH" 2>&1
'''

[tasks.export-p1-functions]
description = "Export all P1 utility functions to decompiled/p1_util.c"
run = '''
#!/bin/bash
set -e

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

mkdir -p "$PROJECT_DIR/decompiled"

# P1 utility functions (using actual Ghidra function names)
bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript ExportDecompiled.py "$PROJECT_DIR/decompiled/p1_util.c" \
        LpplFromId LpflFromId LpthFromId \
        LpAlloc LpReAlloc LphbAlloc LphbReAlloc \
        Random Randomize \
    2>&1 | grep -E "^INFO.*GhidraScript|Processing|OK|NOT FOUND|Output written" || true

echo ""
echo "Output: $PROJECT_DIR/decompiled/p1_util.c"
'''

[tasks.export-all-decompiled]
description = "Export ALL decompiled code (usage: mise run export-all-decompiled -- output.c [segment])"
run = '''
#!/bin/bash
set -e

OUTPUT_FILE="${1:-decompiled/all_funcs.c}"
SEGMENT="${2:-}"

GHIDRA_PATH="${GHIDRA_HOME:-$GHIDRA_HOME_}"
GHIDRA_EXPANDED="${GHIDRA_PATH/#~/$HOME}"
ANALYZER="$GHIDRA_EXPANDED/support/pyghidraRun"

if [ ! -f "$ANALYZER" ]; then
    echo "Error: Ghidra not found at $GHIDRA_EXPANDED"
    exit 1
fi

# Create output directory if needed
mkdir -p "$(dirname "$OUTPUT_FILE")"

echo "Exporting all decompiled functions to $OUTPUT_FILE..."
if [ -n "$SEGMENT" ]; then
    echo "Filtering to segment: $SEGMENT"
fi

bash "$ANALYZER" -H "$GHIDRA_PROJECT" Stars \
    -process stars.exe \
    -noanalysis \
    -scriptPath "$SCRIPTS_DIR" \
    -postScript ExportAllDecompiled.py "$OUTPUT_FILE" "$SEGMENT" 2>&1
'''

[tasks.dump-structmeta-json]
description = "dump the nb09_structmeta.json"
run = '''
#!/bin/bash
set -e

python3 $PROJECT_DIR/scripts/dump_nb09_structmeta.py \
  $PROJECT_DIR/scripts/stars26jrc3.codeview.nb09.bin \
  --struct-overrides $PROJECT_DIR/scripts/struct_overrides.json \
  --out $PROJECT_DIR/scripts/nb09_structmeta.json

echo ""
echo "Output: $PROJECT_DIR/scripts/nb09_structmeta"
'''

[tasks.dump-globals-json]
description = "dump the nb09_ghidra_globals.json"
run = '''
#!/bin/bash
set -e

python3 $PROJECT_DIR/scripts/dump_nb09_ghidra.py \
  $PROJECT_DIR/scripts/stars26jrc3.codeview.nb09.bin \
  --segments $PROJECT_DIR/scripts/segments.csv \
  --sig-overrides $PROJECT_DIR/scripts/sig_overrides.json \
  --seg-overrides $PROJECT_DIR/scripts/seg_overrides.json \
  --out $PROJECT_DIR/scripts/nb09_ghidra_globals.json

echo ""
echo "Output: $PROJECT_DIR/scripts/nb09_ghidra_globals"
'''
