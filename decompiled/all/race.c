// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: RaceCreationWizard
// Address: 10e0:0000
// Segment: MEMORY_RACE
// ======================================================================


short RaceCreationWizard(HWND hwndParent,short fReadOnly,short fDontWrite)

{
  short sVar1;
  int iVar2;
  char *pcVar3;
  FARPROC pvVar4;
  long lVar5;
  short cpts;
  RECT rgrcStack [17];
  void *lpProc;
  short mdRet;
  
                    /* Segment:    29
                       Offset:     000c8f00
                       Length:     662c
                       Min Alloc:  662c
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  vrgrcRCW = rgrcStack;
  fRCWReadOnly = fReadOnly;
  hwndRaceParent = hwndParent;
RACE_Step1:
  iPanelActive = 1;
  pvVar4 = MakeProcInstance(RaceWizardDlg1,hInst);
  sVar1 = DialogBox(0,(LPCSTR)CONCAT22(0x92,hwndRaceParent),(HWND)((ulong)pvVar4 >> 0x10),
                    (void *)pvVar4);
  FreeProcInstance(pvVar4);
  if (sVar1 == 0) {
    sVar1 = 0;
    lVar5 = lSaltCur;
LAB_10e0_03a6:
    lSaltCur._2_2_ = (undefined2)((ulong)lVar5 >> 0x10);
    lSaltCur._0_2_ = (undefined2)lVar5;
    return sVar1;
  }
  if (sVar1 == 3) goto RACE_Finish;
RACE_Step2:
  do {
    iPanelActive = 2;
    pvVar4 = MakeProcInstance(RaceWizardDlg4,hInst);
    sVar1 = DialogBox(0,(LPCSTR)CONCAT22(0x95,hwndRaceParent),
                      (HWND)((ulong)pvVar4 >> 0x10),(void *)pvVar4);
    FreeProcInstance(pvVar4);
    if (sVar1 == 0) {
      sVar1 = 0;
      lVar5 = lSaltCur;
      goto LAB_10e0_03a6;
    }
    if (sVar1 == 1) goto RACE_Step1;
    if (sVar1 == 3) goto RACE_Finish;
RACE_Step3:
    iPanelActive = 3;
    pvVar4 = MakeProcInstance(RaceWizardDlg5,hInst);
    sVar1 = DialogBox(0,(LPCSTR)CONCAT22(0x96,hwndRaceParent),
                      (HWND)((ulong)pvVar4 >> 0x10),(void *)pvVar4);
    FreeProcInstance(pvVar4);
    if (sVar1 == 0) {
      sVar1 = 0;
      lVar5 = lSaltCur;
      goto LAB_10e0_03a6;
    }
    if (sVar1 != 1) {
      if (sVar1 == 3) goto RACE_Finish;
RACE_Step4:
      iPanelActive = 4;
      pvVar4 = MakeProcInstance(RaceWizardDlg2,hInst);
      sVar1 = DialogBox(0,(LPCSTR)CONCAT22(0x93,hwndRaceParent),
                        (HWND)((ulong)pvVar4 >> 0x10),(void *)pvVar4);
      FreeProcInstance(pvVar4);
      if (sVar1 == 0) {
        sVar1 = 0;
        lVar5 = lSaltCur;
        goto LAB_10e0_03a6;
      }
      if (sVar1 != 1) {
        if (sVar1 == 3) goto RACE_Finish;
RACE_Step5:
        iPanelActive = 5;
        pvVar4 = MakeProcInstance(RaceWizardDlg3,hInst);
        sVar1 = DialogBox(0,(LPCSTR)CONCAT22(0x94,hwndRaceParent),
                          (HWND)((ulong)pvVar4 >> 0x10),(void *)pvVar4);
        FreeProcInstance(pvVar4);
        if (sVar1 == 0) {
          sVar1 = 0;
          lVar5 = lSaltCur;
          goto LAB_10e0_03a6;
        }
        if (sVar1 != 1) {
          if (sVar1 == 3) goto RACE_Finish;
          while( true ) {
            iPanelActive = 6;
            pvVar4 = MakeProcInstance(RaceWizardDlg6,hInst);
            sVar1 = DialogBox(0,(LPCSTR)CONCAT22(0x97,hwndRaceParent),
                              (HWND)((ulong)pvVar4 >> 0x10),(void *)pvVar4);
            FreeProcInstance(pvVar4);
            if (sVar1 == 0) {
              sVar1 = 0;
              lVar5 = lSaltCur;
              goto LAB_10e0_03a6;
            }
            if (sVar1 == 1) break;
RACE_Finish:
            if (fRCWReadOnly != 0) {
              sVar1 = 0;
              lVar5 = lSaltCur;
              goto LAB_10e0_03a6;
            }
            sVar1 = CAdvantagePoints((PLAYER *)&vplr);
            if (-1 < sVar1) {
              lVar5 = LSaltFromSz((char *)&szRacePass);
              lSaltLast._0_2_ = 0xfffb;
              lSaltLast._2_2_ = 0xffff;
              lSaltCur = lVar5;
              sVar1 = FCheckPassword();
              if (sVar1 == 0) goto RACE_Step1;
              if (szRaceFile == '\0') {
                pcVar3 = (char *)s_stars_r1_1120_1328;
              }
              else {
                pcVar3 = (char *)&szRaceFile;
              }
              sVar1 = FSaveRace(pcVar3,(PLAYER *)&vplr);
              if (sVar1 == 0) goto RACE_Step1;
              sVar1 = 1;
              lVar5 = lSaltCur;
              goto LAB_10e0_03a6;
            }
            iVar2 = -sVar1;
            pcVar3 = PszGetCompressedString(idsAdvantagePointsCurrentlyHoleDPointsCannot);
            _WSPRINTF((LPSTR)CONCAT22(iVar2,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
            AlertSz((char *)szWork,0x10);
            if (iPanelActive == 2) goto RACE_Step2;
            if (iPanelActive == 3) goto RACE_Step3;
            if (iPanelActive == 4) goto RACE_Step4;
            if (iPanelActive == 5) break;
            if (iPanelActive != 6) goto RACE_Step1;
          }
          goto RACE_Step5;
        }
        goto RACE_Step4;
      }
      goto RACE_Step3;
    }
  } while( true );
}



// ======================================================================
// Function: RaceWizardDlg1
// Address: 10e0:03ac
// Segment: MEMORY_RACE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: k */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short RaceWizardDlg1(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  undefined2 uVar1;
  PLAYER *pPVar2;
  WPARAM WVar3;
  BOOL BVar4;
  UINT UVar5;
  HWND HVar6;
  short sVar7;
  uint uVar8;
  char *pcVar9;
  HBRUSH HVar10;
  int iVar11;
  undefined2 unaff_SI;
  undefined2 *puVar12;
  undefined2 unaff_DI;
  PLAYER *pPVar13;
  undefined2 unaff_SS;
  undefined2 *puVar14;
  ulong uVar15;
  LRESULT LVar16;
  long lVar17;
  byte k;
  RECT rcGBox;
  short cch;
  short j;
  undefined2 auStack_38 [2];
  uint uStack_34;
  char *psz_2;
  char szBuf [32];
  PLAYER *pplr_2;
  RECT rc;
  short i;
  
  if (message == WM_PAINT) {
    szBuf._30_2_ = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,auStack_38));
    for (j = 0x10f; j < 0x117; j = j + 1) {
      UVar5 = IsDlgButtonChecked(hwnd,j);
      if (UVar5 != 0) break;
    }
    if (j < 0x116) {
      szBuf._28_2_ = (j + -0x10f) * 0xc0 + 0xda2;
    }
    else {
      szBuf._28_2_ = SUB42(&vplr,0);
    }
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    DrawRaceAdvantagePoints(szBuf._30_2_,&rc,(PLAYER *)szBuf._28_2_);
    HVar6 = GetDlgItem(hwnd,0x10f);
    GetWindowRect(HVar6,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
    ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
    HVar6 = GetDlgItem(hwnd,0x116);
    GetWindowRect(HVar6,(undefined2 *)CONCAT22(unaff_SS,&rc));
    ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&rc.right));
    rcGBox.right = rc.right;
    rcGBox.bottom = rc.bottom;
    ExpandRc(&rcGBox,dyArial8,dyArial8 >> 1);
    _Draw3dFrame();
    SelectObject(szBuf._30_2_,rghfontArial8[1]);
    SetBkColor(szBuf._30_2_,
               CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    sVar7 = CchGetString(idsPredefinedRaces,(char *)szWork);
    TextOut(szBuf._30_2_,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,
            sVar7);
    HVar6 = GetDlgItem(hwnd,0x81a);
    GetWindowRect(HVar6,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
    ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&rcGBox.right));
    szBuf._24_2_ = rcGBox.right + 0x20;
    szBuf._26_2_ = rcGBox.bottom + -0x20;
    pplr_2 = (PLAYER *)((uint)vplr.wMdPlr >> 3 & 0x1f);
    if ((PLAYER *)((int)(HBRUSH *)&hbrDesktop + 1U) < pplr_2) {
      pplr_2 = (PLAYER *)0x0;
    }
    SelectPalette(szBuf._30_2_,vhpal,0);
    RealizePalette(szBuf._30_2_);
    DibBlt(szBuf._30_2_,szBuf._24_2_,szBuf._26_2_,0x20,0x20,hdibRaces,
                    ((uint)pplr_2 & 7) << 5,(3 - ((int)pplr_2 >> 3)) * 0x20,0x20,0x20,0xcc0020);
    if (fRCWReadOnly == 0) {
      SetRect(&rgrcBuildSpin[0].left,szBuf._24_2_ + 2,szBuf._26_2_ + 0x23,
              szBuf._24_2_ + 0x10,szBuf._26_2_ + 0x31);
      rgrcBuildSpin[1].left = rgrcBuildSpin[0].left;
      rgrcBuildSpin[1].top = rgrcBuildSpin[0].top;
      rgrcBuildSpin[1].right = rgrcBuildSpin[0].right;
      rgrcBuildSpin[1].bottom = rgrcBuildSpin[0].bottom;
      OffsetRect(&rgrcBuildSpin[1].left,0xe,0);
      for (i = 0; i < 2; i = i + 1) {
        if (i == 0) {
          uVar8 = 2;
        }
        else {
          uVar8 = 3;
        }
        DrawBtn(szBuf._30_2_,(RECT *)rgrcBuildSpin + i,uVar8 | 0x20,0,(char *)0x0
                        );
      }
    }
    EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,auStack_38));
    HVar10 = 1;
    lVar17 = vplr.lSalt;
    goto LAB_10e0_1057;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    HVar10 = 1;
    lVar17 = vplr.lSalt;
    goto LAB_10e0_1057;
  }
  if (message == WM_CTLCOLOR) {
    for (i = 0x10f; i < 0x117; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,i);
      if ((HWND)lParam == HVar6) break;
    }
    if (0x116 < i) {
      uVar15 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),_k);
      if ((int)uVar15 != 6) goto LAB_10e0_1051;
    }
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    HVar10 = hbrButtonFace;
    lVar17 = vplr.lSalt;
    goto LAB_10e0_1057;
  }
  if (message == WM_INITDIALOG) {
    uVar8 = (uint)vplr.wMdPlr >> 3;
    SetRCWTitle(hwnd,iPanelActive);
    SetDlgItemText(hwnd,0x10c,vplr.szName);
    SetDlgItemText(hwnd,0x81b,vplr.szNames);
    if (vplr.szName[0] == '\0') {
      GetDlgItemText(hwnd,0x10f,vplr.szName,0x10);
      SetDlgItemText(hwnd,0x10c,vplr.szName);
    }
    StickyDlgPos(hwnd,(POINT *)&ptStickyRaceDlg,1);
    if (((((uint)game.wCrap >> 3 & 1) == 0) || (idPlayer != 0)) ||
       (fRCWReadOnly == 0)) {
      for (i = 0; i < 7; i = i + 1) {
        szBuf._26_2_ = *(uint *)(i * 0xc0 + 0xda8) >> 3 & 0x1f;
        vplr.wMdPlr = vplr.wMdPlr & 0xff07U | szBuf._26_2_ << 3;
        sVar7 = __fmemcmp(&vplr,
                                  (void *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                                   (void *)(i * 0xc0 + 0xda2)),0x80);
        if (sVar7 == 0) break;
      }
      vplr.wMdPlr = vplr.wMdPlr & 0xff07U | (uVar8 & 0x1f) << 3;
    }
    else {
      i = 0;
    }
    CheckRadioButton(hwnd,0x10f,0x116,i + 0x10f);
    SendDlgItemMessage(hwnd,0x10c,0x415,0xf,0);
    SendDlgItemMessage(hwnd,0x81b,0x415,0xf,0);
    SendDlgItemMessage(hwnd,0x10d,0x415,0x10,0);
    szBuf._30_2_ = GetDlgItem(hwnd,0x81a);
    for (i = 0x106; i < 0x10b; i = i + 1) {
      szBuf._28_2_ = PszGetCompressedString(i);
      SendMessage(szBuf._30_2_,0x403,0,(LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,szBuf._28_2_));
    }
    WVar3 = GetRaceStat((PLAYER *)&vplr,rsUseLeftover);
    SendMessage(szBuf._30_2_,0x40e,WVar3,0);
    if (vplr.lSalt != 0) {
      SetDlgItemText(hwnd,0x10d,&szRacePass);
    }
    if (fRCWReadOnly != 0) {
      for (i = 0x10c; i < 0x10e; i = i + 1) {
        HVar6 = GetDlgItem(hwnd,i);
        EnableWindow(HVar6,0);
      }
      HVar6 = GetDlgItem(hwnd,0x81b);
      EnableWindow(HVar6,0);
      for (i = 0x10f; i < 0x117; i = i + 1) {
        HVar6 = GetDlgItem(hwnd,i);
        EnableWindow(HVar6,0);
      }
      EnableWindow(szBuf._30_2_,0);
    }
    HVar10 = 1;
    lVar17 = vplr.lSalt;
    goto LAB_10e0_1057;
  }
  if (message == WM_COMMAND) {
    if (wParam == 0x76) {
      WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x3ff);
      HVar10 = 1;
      lVar17 = vplr.lSalt;
      goto LAB_10e0_1057;
    }
    for (i = 0; (i < 4 && (wParam != ((undefined2 *)&rgidRaceBtn)[i])); i = i + 1) {
    }
    if (i < 4) {
      if (wParam != 2) {
        uVar8 = (uint)vplr.wMdPlr >> 3;
        szBuf[0x1e] = '\x0f';
        szBuf[0x1f] = '\x01';
        for (; (int)szBuf._30_2_ < 0x117; szBuf._30_2_ = szBuf._30_2_ + 1) {
          UVar5 = IsDlgButtonChecked(hwnd,szBuf._30_2_);
          if (UVar5 != 0) break;
        }
        if ((int)szBuf._30_2_ < 0x116) {
          szBuf._28_2_ = szBuf._30_2_ + -0x10f;
          puVar12 = (undefined2 *)(szBuf._28_2_ * 0xc0 + 0xda2);
          pPVar13 = (PLAYER *)&vplr;
          for (iVar11 = 0x60; iVar11 != 0; iVar11 = iVar11 + -1) {
            pPVar2 = pPVar13;
            pPVar13 = (PLAYER *)&pPVar13->cPlanet;
            puVar14 = puVar12;
            puVar12 = puVar12 + 1;
            uVar1 = *puVar14;
            pPVar2->iPlayer = (char)uVar1;
            pPVar2->cShDef = (char)((uint)uVar1 >> 8);
          }
        }
        GetDlgItemText(hwnd,0x10c,vplr.szName,0x20);
        GetDlgItemText(hwnd,0x81b,vplr.szNames,0x20);
        GetRaceStat((PLAYER *)&vplr,rsUseLeftover);
        GetDlgItemText(hwnd,0x10d,&szRacePass,0x10);
        HVar6 = GetDlgItem(hwnd,0x81a);
        LVar16 = SendMessage(HVar6,0x407,0,0);
        szBuf._30_2_ = (undefined2)LVar16;
        SetRaceStat((PLAYER *)&vplr,rsUseLeftover,szBuf._30_2_);
        lVar17 = LSaltFromSz((char *)&szRacePass);
        vplr.wMdPlr = vplr.wMdPlr & 0xff07U | (uVar8 & 0x1f) << 3;
        vplr.lSalt = lVar17;
      }
      StickyDlgPos(hwnd,(POINT *)&ptStickyRaceDlg,0);
      EndDialog(hwnd,i);
      HVar10 = 1;
      lVar17 = vplr.lSalt;
      goto LAB_10e0_1057;
    }
    uVar15 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),_k);
    if ((((int)uVar15 == 0) && (0x10e < wParam)) && (wParam < 0x117)) {
      _memset((void *)vplr.szName,0,0x20);
      GetDlgItemText(hwnd,0x10c,vplr.szName,0x20);
      _memset((void *)vplr.szNames,0,0x20);
      GetDlgItemText(hwnd,0x81b,vplr.szNames,0x20);
      GetDlgItemText(hwnd,wParam,(LPSTR)CONCAT22(unaff_SS,szBuf),0x20);
      for (i = 0; i < 7; i = i + 1) {
        pcVar9 = PszGetCompressedString(i + idsHumanoid);
        sVar7 = _strcmp((char *)vplr.szName,pcVar9);
        if (sVar7 == 0) break;
      }
      if ((i < 7) && (wParam < 0x116)) {
        _memset((void *)vplr.szName,0,0x20);
        CchGetString
                  (wParam + idsWarningReceivingPlanetMustHaveMassDriver2,
                   (char *)vplr.szName);
        SetDlgItemText(hwnd,0x10c,vplr.szName);
        _memset((void *)vplr.szNames,0,0x20);
        psz_2 = PszPlayerName(0,1,1,0,0,(PLAYER *)&vplr);
        _strcpy((char *)vplr.szNames,psz_2);
        SetDlgItemText(hwnd,0x81b,vplr.szNames);
      }
      if (wParam < 0x116) {
        pplr_2 = (PLAYER *)((wParam - 0x10f) * 0xc0 + 0xda2);
      }
      else {
        pplr_2 = (PLAYER *)&vplr;
      }
      InvalidateAdvPtsRect(hwnd);
      WVar3 = GetRaceStat(pplr_2,rsUseLeftover);
      HVar6 = GetDlgItem(hwnd,0x81a);
      SendMessage(HVar6,0x40e,WVar3,0);
      HVar6 = GetDlgItem(hwnd,0x42f);
      EnableWindow(HVar6,(uint)(wParam != 0x115));
      psz_2 = (char *)((uint)pplr_2->wMdPlr >> 3 & 0x1f);
      vplr.wMdPlr = vplr.wMdPlr & 0xff07U | (int)psz_2 << 3;
      HVar6 = GetDlgItem(hwnd,0x81a);
      GetWindowRect(HVar6,(undefined2 *)CONCAT22(unaff_SS,&rc));
      ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&rc.right));
      rc.left = rc.right + 0x20;
      rc.top = rc.bottom + -0x20;
      rc.right = rc.right + 0x40;
      InvalidateRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc),1);
    }
  }
  else if ((message == WM_LBUTTONDOWN) || (message == WM_LBUTTONDBLCLK)) {
    szBuf[0x1e] = (undefined1)lParam;
    szBuf[0x1f] = lParam._1_1_;
    puVar14 = (undefined2 *)__aFulshr(CONCAT22(unaff_SI,unaff_DI),_k);
    puVar12 = (undefined2 *)puVar14;
    if (fRCWReadOnly == 0) {
      BVar4 = PtInRect((undefined2 *)CONCAT22((RECT *)rgrcBuildSpin,puVar12),szBuf._30_2_)
      ;
      if (BVar4 == 0) {
        BVar4 = PtInRect((undefined2 *)CONCAT22(0x592e,puVar12),szBuf._30_2_);
        if (BVar4 == 0) goto LAB_10e0_1051;
      }
      BVar4 = PtInRect((undefined2 *)CONCAT22((RECT *)rgrcBuildSpin,puVar12),szBuf._30_2_)
      ;
      if (BVar4 == 0) {
        psz_2 = (char *)0x1;
        builtin_strncpy(szBuf,".Y#",4);
      }
      else {
        psz_2 = (char *)0xffff;
        szBuf[2] = '\"';
        szBuf[3] = '\0';
        szBuf._0_2_ = SUB42(rgrcBuildSpin,0);
      }
      uStack_34 = (uint)vplr.wMdPlr >> 3 & 0x1f;
      if (0x1f < uStack_34) {
        uStack_34 = 0;
      }
      szBuf._28_2_ = GetDC(hwnd);
      SelectPalette(szBuf._28_2_,vhpal,0);
      RealizePalette(szBuf._28_2_);
      InitBtnTrack
                ((BTNT *)(szBuf + 4),hwnd,0,(RECT *)szBuf._0_2_,szBuf._2_2_,0x50,0,0,(char *)0x0);
      while( true ) {
        sVar7 = FTrackBtn((BTNT *)(szBuf + 4));
        if (sVar7 == 0) break;
        uStack_34 = (int)(psz_2 + uStack_34 + 0x20) % 0x20;
        DibBlt(szBuf._28_2_,rgrcBuildSpin[0].left + -2,
                        rgrcBuildSpin[0].top + -0x23,0x20,0x20,hdibRaces,
                        (uStack_34 & 7) << 5,(3 - ((int)uStack_34 >> 3)) * 0x20,0x20,0x20,0xcc0020);
      }
      vplr.wMdPlr = vplr.wMdPlr & 0xff07U | (uStack_34 & 0x1f) << 3;
      ReleaseDC(hwnd,szBuf._28_2_);
      HVar10 = 1;
      lVar17 = vplr.lSalt;
      goto LAB_10e0_1057;
    }
  }
LAB_10e0_1051:
  HVar10 = 0;
  lVar17 = vplr.lSalt;
LAB_10e0_1057:
  vplr.lSalt._2_2_ = (undefined2)((ulong)lVar17 >> 0x10);
  vplr.lSalt._0_2_ = (undefined2)lVar17;
  return HVar10;
}



// ======================================================================
// Function: RaceWizardDlg2
// Address: 10e0:1060
// Segment: MEMORY_RACE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short RaceWizardDlg2(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  POINT pt;
  POINT pt_00;
  RECT *pRVar1;
  int iVar2;
  HWND HVar3;
  short sVar4;
  undefined2 unaff_SI;
  RECT *pRVar5;
  undefined2 unaff_DI;
  RECT *pRVar6;
  undefined2 unaff_SS;
  DWORD DVar7;
  ulong uVar8;
  LRESULT LVar9;
  ushort in_stack_0000ffce;
  HGDIOBJ HStack_30;
  char acStack_2e [20];
  short sStack_1a;
  int iStack_18;
  int iStack_16;
  int iStack_14;
  short iVar;
  HDC HStack_10;
  RECT rc;
  short i;
  
  uVar8 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    HStack_10 = BeginPaint(hwnd,(HGDIOBJ *)CONCAT22(unaff_SS,&HStack_30));
    viStore = -2;
    DrawRace2(hwnd,HStack_10,-1);
    EndPaint(hwnd,(HGDIOBJ *)CONCAT22(unaff_SS,&HStack_30));
    sVar4 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar4 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      for (i = 0x123; i < 0x126; i = i + 1) {
        HStack_10 = (HWND)lParam;
        HVar3 = GetDlgItem(hwnd,i);
        if (HStack_10 == HVar3) break;
      }
      if ((i < 0x126) || (uVar8 = __aFulshr(uVar8,in_stack_0000ffce), (int)uVar8 == 6)) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else if (message == WM_SETCURSOR) {
      GetCursorPos((short *)CONCAT22(unaff_SS,&iVar));
      ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&iVar));
      pt.y = HStack_10;
      pt.x = iVar;
      sVar4 = IrcRaceDlgHitTest(pt);
      if (-1 < sVar4) {
        setcursor(hcurHand);
        return 1;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        SetRCWTitle(hwnd,iPanelActive);
        viStore = -1;
        HStack_10 = GetDC(hwnd);
        GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
        HStack_30 = SelectObject(HStack_10,rghfontArial8[1]);
        sStack_1a = CchGetString(idsTemperature,acStack_2e);
        DVar7 = GetTextExtent(HStack_10,(LPCSTR)CONCAT22(unaff_SS,acStack_2e),sStack_1a);
        iStack_18 = (int)DVar7 + 10;
        DVar7 = GetTextExtent(HStack_10,s_200mR_1120_1331,5);
        iStack_16 = (rc.right - iStack_18) - ((int)DVar7 + 10);
        iStack_14 = (dyArial8 * 3) / 2;
        iVar = dyArial8 * 3;
        SetRect((undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,vrgrcRCW),iStack_18,
                iVar,iStack_18 + iStack_14,iVar + iStack_14);
        SetRect((undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,vrgrcRCW + 1),
                iStack_18 + iStack_14 + 6,iVar,((iStack_18 + iStack_16) - iStack_14) + -6,
                iVar + iStack_14);
        SetRect((undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,vrgrcRCW + 2),
                (iStack_18 + iStack_16) - iStack_14,iVar,iStack_18 + iStack_16,iVar + iStack_14);
        SetRect((undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,vrgrcRCW + 3),
                iStack_18,iVar + iStack_14 + 4,iStack_14 * 3 + iStack_18,iStack_14 * 2 + iVar + 4);
        SetRect((undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,vrgrcRCW + 4),
                iStack_18 + iStack_16 + iStack_14 * -3,iVar + iStack_14 + 4,iStack_18 + iStack_16,
                iStack_14 * 2 + iVar + 4);
        for (i = 0; i < 5; i = i + 1) {
          pRVar5 = vrgrcRCW + i;
          pRVar6 = vrgrcRCW + i + 5;
          pRVar6->left = pRVar5->left;
          pRVar6->top = pRVar5->top;
          pRVar6->right = pRVar5->right;
          pRVar6->bottom = pRVar5->bottom;
          OffsetRect((undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,vrgrcRCW + i + 5)
                     ,0,iStack_14 * 3);
          pRVar5 = vrgrcRCW + i;
          pRVar6 = vrgrcRCW + i + 10;
          pRVar6->left = pRVar5->left;
          pRVar6->top = pRVar5->top;
          pRVar6->right = pRVar5->right;
          pRVar6->bottom = pRVar5->bottom;
          OffsetRect((undefined2 *)
                     CONCAT22((undefined1 *)&DAT_1120_1120,vrgrcRCW + i + 10),0,
                     iStack_14 * 6);
        }
        for (i = 0; i < 3; i = i + 1) {
          HVar3 = GetDlgItem(hwnd,i + 0x123);
          SetWindowPos(HVar3,0,iStack_14 * 3 + iStack_18 + 6,vrgrcRCW[i * 5 + 3].top,
                       iStack_16 + iStack_14 * -6 + -0xc,iStack_14,4);
          CheckDlgButton(hwnd,i + 0x123,
                         (uint)(*(char *)((int)vplr.rgEnvVarMax + i) < '\0'));
        }
        sStack_1a = CchGetString
                              (idsMaximumColonistGrowthRatePerYear,(char *)szWork);
        DVar7 = GetTextExtent(HStack_10,&DAT_1120_1337,3);
        iVar2 = (int)DVar7;
        DVar7 = GetTextExtent(HStack_10,szWork,sStack_1a);
        (vrgrcRCW + 0xf)->left = iStack_18 + (int)DVar7 + iVar2 + 4;
        vrgrcRCW[0xf].top = iStack_14 * 9 + iVar + -3;
        vrgrcRCW[0xf].right = (vrgrcRCW + 0xf)->left + 0xf;
        vrgrcRCW[0xf].bottom = (dyArial8 >> 1) + vrgrcRCW[0xf].top + 3
        ;
        pRVar1 = vrgrcRCW;
        pRVar5 = vrgrcRCW + 0x10;
        pRVar6 = vrgrcRCW + 0xf;
        (vrgrcRCW + 0x10)->left = (vrgrcRCW + 0xf)->left;
        pRVar5->top = pRVar6->top;
        pRVar1[0x10].right = pRVar1[0xf].right;
        pRVar1[0x10].bottom = pRVar1[0xf].bottom;
        OffsetRect((undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,vrgrcRCW + 0x10),0,
                   (vrgrcRCW[0xf].bottom - vrgrcRCW[0xf].top) + -1);
        crcRCW = 0x11;
        SelectObject(HStack_10,HStack_30);
        ReleaseDC(hwnd,HStack_10);
        if (fRCWReadOnly != 0) {
          for (i = 0x123; i < 0x126; i = i + 1) {
            HVar3 = GetDlgItem(hwnd,i);
            EnableWindow(HVar3,0);
          }
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyRaceDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        if (wParam == 0x76) {
          WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x41d);
          return 1;
        }
        for (i = 0; (i < 4 && (wParam != ((undefined2 *)&rgidRaceBtn)[i])); i = i + 1) {
        }
        if (i < 4) {
          StickyDlgPos(hwnd,(POINT *)&ptStickyRaceDlg,0);
          EndDialog(hwnd,i);
          return 1;
        }
        if ((0x122 < wParam) && (wParam < 0x126)) {
          HVar3 = GetDlgItem(hwnd,wParam);
          LVar9 = SendMessage(HVar3,0x400,0,0);
          HStack_10 = wParam - 0x123;
          if ((int)LVar9 == 1) {
            ((char *)rgbCur + 0x2ef)[wParam] = -1;
            ((char *)rgbCur + 0x2f5)[wParam] = -1;
            ((char *)rgbCur + 0x2f2)[wParam] = -1;
          }
          else {
            ((char *)rgbCur + 0x2f2)[wParam] = '\x14';
            ((char *)rgbCur + 0x2f5)[wParam] = 'P';
            ((char *)rgbCur + 0x2ef)[wParam] = '2';
          }
          DrawRace2(hwnd,0,1 << ((byte)HStack_10 & 0x1f) | 0xff00);
        }
      }
      else if ((message == WM_LBUTTONDOWN) || (message == WM_LBUTTONDBLCLK)) {
        iVar = (HWND)lParam;
        uVar8 = __aFulshr(uVar8,in_stack_0000ffce);
        HStack_10 = (HDC)uVar8;
        pt_00.y = HStack_10;
        pt_00.x = iVar;
        sVar4 = FTrackRaceDlg2(hwnd,pt_00,wParam);
        return sVar4;
      }
    }
    sVar4 = 0;
  }
  return sVar4;
}



// ======================================================================
// Function: DrawRace2
// Address: 10e0:179a
// Segment: MEMORY_RACE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10e01fce) */

void DrawRace2(HWND hwnd,HDC hdc,short iDraw)

{
  char cVar1;
  int iVar2;
  uint uVar3;
  short sVar4;
  int iVar5;
  char *pcVar6;
  short sVar7;
  uint uVar8;
  uint uVar9;
  int iVar10;
  int iVar11;
  int iVar12;
  int iVar13;
  StringId ids;
  ushort unaff_DI;
  char *unaff_SS;
  bool bVar14;
  bool bVar15;
  DWORD DVar16;
  ulong uVar17;
  long lVar18;
  undefined2 uVar19;
  HDC HVar21;
  undefined2 uVar22;
  ulong uVar20;
  long l;
  short cch_3;
  short iStore;
  char szT_2 [100];
  long l2;
  RECT rc;
  short bt1;
  short cch;
  short dx;
  char *psz;
  short iMod;
  short i;
  short xRLabel;
  short fCreatedDC;
  short bkMode;
  short iMin;
  short dy;
  char szT [32];
  short iMax;
  short bt;
  short iPit;
  
  if (fRCWReadOnly == 0) {
    uVar3 = 0;
  }
  else {
    uVar3 = 4;
  }
  bVar15 = hdc == 0;
  if (bVar15) {
    hdc = GetDC(hwnd);
  }
  GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
  DrawRaceAdvantagePoints(hdc,&rc,(PLAYER *)0x0);
  sVar4 = SetBkMode(hdc,1);
  SelectObject(hdc,rghfontArial8[1]);
  iVar5 = (rc.right - vrgrcRCW[2].right) / 2 + vrgrcRCW[2].right;
  for (i = 0; i < 3; i = i + 1) {
    if ((1 << ((byte)i & 0x1f) & iDraw) != 0) {
      if (iDraw != -1) {
        SelectObject(hdc,hbrButtonFace);
        PatBlt(hdc,vrgrcRCW[2].right,vrgrcRCW[i * 5 + 2].top,
               rc.right - vrgrcRCW[2].right,
               vrgrcRCW[i * 5 + 4].bottom - vrgrcRCW[i * 5 + 2].top,0xf00021);
      }
      if (*(char *)((int)vplr.rgEnvVarMax + i) < '\0') {
        sVar7 = CchGetString(idsN2,szT);
        CtrTextOut(hdc,iVar5,vrgrcRCW[i * 5 + 2].top + 1 + dyArial8,szT
                            ,sVar7);
      }
      else {
        pcVar6 = PszCalcEnvVar(i,(int)*(char *)((int)vplr.rgEnvVarMin + i));
        CtrTextOut(hdc,iVar5,vrgrcRCW[i * 5 + 2].top + 1,pcVar6,0);
        sVar7 = CchGetString(idsTo2,szT);
        CtrTextOut(hdc,iVar5,vrgrcRCW[i * 5 + 2].top + 1 + dyArial8,szT
                            ,sVar7);
        pcVar6 = PszCalcEnvVar(i,(int)*(char *)((int)vplr.rgEnvVarMax + i));
        CtrTextOut(hdc,iVar5,vrgrcRCW[i * 5 + 2].top + 1 + dyArial8 * 2
                            ,pcVar6,0);
      }
      if (iDraw == -1) {
        RightTextOut
                  (hdc,(vrgrcRCW + i * 5)->left + -4,
                   dyArial8 / 4 + vrgrcRCW[i * 5].top,
                   (char *)*(undefined2 *)(i * 2 + 0x47e),0,0);
      }
    }
  }
  iPit = 0;
  iMod = 0;
  for (i = 0; i < 0xf; i = i + 1) {
    if (4 < iMod) {
      iMod = 0;
    }
    if (*(char *)((int)vplr.rgEnvVarMax + i / 5) < '\0') {
      uVar8 = 4;
    }
    else {
      uVar8 = 0;
    }
    if ((iMod == 0) || (iMod == 2)) {
      if ((iDraw & 0xfff0U) != 0) {
        if (iMod == 0) {
          uVar9 = 2;
        }
        else {
          uVar9 = 3;
        }
        DrawBtn(hdc,vrgrcRCW + i,uVar9 | uVar8 | uVar3,0,(char *)0x0);
      }
    }
    else if (iMod == 1) {
      if (((1 << ((byte)iPit & 0x1f) & iDraw) != 0) &&
         (PatBlt(hdc,(vrgrcRCW + i)->left,vrgrcRCW[i].top,
                 vrgrcRCW[i].right - (vrgrcRCW + i)->left,
                 vrgrcRCW[i].bottom - vrgrcRCW[i].top,0x42), uVar8 == 0)) {
        iVar10 = (int)*(char *)((int)vplr.rgEnvVarMin + iPit);
        cVar1 = *(char *)((int)vplr.rgEnvVarMax + iPit);
        iVar11 = (vrgrcRCW[i].right - (vrgrcRCW + i)->left) + -2;
        iVar5 = vrgrcRCW[i].bottom;
        iVar2 = vrgrcRCW[i].top;
        SelectObject(hdc,(*((ushort (*) [2])rghbrPlanetAttr + iPit))[0]);
        HVar21 = hdc;
        sVar7 = MulDiv(iVar10,iVar11,100);
        iVar12 = sVar7 + (vrgrcRCW + i)->left + 1;
        iVar13 = vrgrcRCW[i].top + 1;
        sVar7 = MulDiv(cVar1 - iVar10,iVar11,100);
        PatBlt(HVar21,iVar12,iVar13,sVar7,(iVar5 - iVar2) + -2,0xf00021);
      }
      iPit = iPit + 1;
    }
    else if ((iDraw & 0xfff0U) != 0) {
      if (iMod == 3) {
        pcVar6 = (char *)&DAT_1120_133b;
      }
      else {
        pcVar6 = (char *)s_>>_<<_1120_1345;
      }
      DrawBtn(hdc,vrgrcRCW + i,uVar8 | 8 | uVar3,0,pcVar6);
    }
    iMod = iMod + 1;
  }
  if ((iDraw & 8U) != 0) {
    if (iDraw == -1) {
      sVar7 = CchGetString(idsMaximumColonistGrowthRatePerYear,(char *)szWork);
      TextOut(hdc,vrgrcRCW->left,vrgrcRCW[0xf].top + 3,szWork,sVar7);
      DrawBtn(hdc,vrgrcRCW + 0xf,uVar3 | 0xa0,0,(char *)0x0);
      DrawBtn(hdc,vrgrcRCW + 0x10,uVar3 | 0xa1,0,(char *)0x0);
    }
    else {
      DVar16 = GetTextExtent(hdc,&DAT_1120_134f,3);
      SelectObject(hdc,hbrButtonFace);
      PatBlt(hdc,((vrgrcRCW + 0xf)->left + -4) - (int)DVar16,
             vrgrcRCW[0xf].top + 3,(int)DVar16,dyArial8,0xf00021);
    }
    sVar7 = _WSPRINTF((LPSTR)CONCAT22((int)vplr.pctIdealGrowth,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(PCTDPCTPCT,(char *)&DAT_1120_1120),
                      (char *)szWork);
    RightTextOut
              (hdc,(vrgrcRCW + 0xf)->left + -4,vrgrcRCW[0xf].top + 3,
               (char *)szWork,sVar7,0);
  }
  if ((iDraw & 7U) != 0) {
    uVar17 = 1;
    for (i = 0; i < 3; i = i + 1) {
      if ((*(char *)((int)vplr.rgEnvVarMax + i) < '\0') ||
         ((int)*(char *)((int)vplr.rgEnvVarMax + i) -
          (int)*(char *)((int)vplr.rgEnvVarMin + i) == 100)) {
        uVar17 = __aFulmul(uVar17,100);
      }
      else if (i == 2) {
        uVar17 = __aFulmul(uVar17,(long)((int)vplr.rgEnvVarMax[2] -
                                                (int)vplr.rgEnvVarMin[2]));
      }
      else {
        l2._0_2_ = 0;
        l2._2_2_ = 0;
        for (iStore = (short)*(char *)((int)vplr.rgEnvVarMin + i);
            iStore <= *(char *)((int)vplr.rgEnvVarMax + i); iStore = iStore + 1) {
          if (iStore < 10) {
            bVar14 = CARRY2((uint)l2,iStore);
            l2._0_2_ = (uint)l2 + iStore;
            l2._2_2_ = l2._2_2_ + (iStore >> 0xf) + (uint)bVar14;
          }
          else if (iStore < 0x5a) {
            bVar14 = 0xfff5 < (uint)l2;
            l2._0_2_ = (uint)l2 + 10;
            l2._2_2_ = l2._2_2_ + (uint)bVar14;
          }
          else {
            uVar3 = 100 - iStore;
            bVar14 = CARRY2((uint)l2,uVar3);
            l2._0_2_ = (uint)l2 + uVar3;
            l2._2_2_ = l2._2_2_ + ((int)uVar3 >> 0xf) + (uint)bVar14;
          }
        }
        uVar22 = 0;
        uVar19 = 9;
        uVar17 = __aFulmul(uVar17,CONCAT22(l2._2_2_,(uint)l2));
        uVar17 = __aFldiv(uVar17,CONCAT22(uVar22,uVar19));
      }
    }
    if ((long)uVar17 < 1) {
      uVar17 = 1;
    }
    uVar20 = uVar17;
    lVar18 = __aFlshr(uVar17,unaff_DI);
    lVar18 = __aFldiv(lVar18 + 1000000,uVar20);
    iStore = (short)lVar18;
    if (uVar17 == 1000000) {
      iStore = 0;
    }
    if (iStore != viStore) {
      viStore = iStore;
      if (lVar18 == 1) {
        if (uVar17 == 1000000) {
          ids = idsPlanetsWillHabitableRace;
        }
        else {
          ids = idsVirtuallyPlanetsWillHabitableRace;
        }
        cch_3 = CchGetString(ids,(char *)szWork);
      }
      else {
        CchGetString(idsCanExpect1DPlanetsWillHabitable,szT_2);
        cch_3 = _WSPRINTF((LPSTR)CONCAT22((short)lVar18,unaff_SS),
                          (LPCSTR)CONCAT22(szT_2,(char *)&DAT_1120_1120),(char *)szWork);
      }
      rc.left = vrgrcRCW->left;
      rc.top = vrgrcRCW[0xf].top + dyArial8 + 8;
      rc.right = vrgrcRCW[0xf].right + 0x14;
      rc.bottom = dyArial8 * 3 + rc.top;
      SelectObject(hdc,hbrButtonFace);
      PatBlt(hdc,rc.left,rc.top,rc.right - rc.left,rc.bottom - rc.top,0xf00021);
      DRAWTEXT(hdc,szWork,cch_3,(undefined2 *)CONCAT22(unaff_SS,&rc),0x10);
    }
  }
  SetBkMode(hdc,sVar4);
  if (bVar15) {
    ReleaseDC(hwnd,hdc);
  }
  return;
}



// ======================================================================
// Function: IrcRaceDlgHitTest
// Address: 10e0:2164
// Segment: MEMORY_RACE
// ======================================================================


short IrcRaceDlgHitTest(POINT pt)

{
  BOOL BVar1;
  short i;
  
  if (fRCWReadOnly == 0) {
    for (i = 0; i < crcRCW; i = i + 1) {
      BVar1 = PtInRect((undefined2 *)CONCAT22(vrgrcRCW + i,pt.y),pt.x);
      if (BVar1 != 0) break;
    }
    if (i < crcRCW) {
      if ((iPanelActive == 4) &&
         (*(char *)((int)vplr.rgEnvVarMax + i / 5) < '\0')) {
        i = -1;
      }
    }
    else {
      i = -1;
    }
  }
  else {
    i = -1;
  }
  return i;
}



// ======================================================================
// Function: FTrackRaceDlg2
// Address: 10e0:2204
// Segment: MEMORY_RACE
// ======================================================================


short FTrackRaceDlg2(HWND hwnd,POINT pt,short kbd)

{
  char cVar1;
  char cVar2;
  short sVar3;
  int iVar4;
  int iVar5;
  int iVar6;
  short sVar7;
  int iVar8;
  short dx;
  short dWidth;
  char *psz;
  short iMod;
  short irc;
  short i;
  char iMin;
  char iMax;
  short dShift;
  short bt;
  BTNT btnt;
  
  sVar3 = IrcRaceDlgHitTest(pt);
  if (sVar3 < 0) {
    sVar3 = 0;
  }
  else {
    iVar8 = sVar3 % 5;
    iVar4 = sVar3 / 5;
    if ((iVar8 == 1) && (sVar3 < 0xf)) {
      SetCapture(hwnd);
      setcursor(hcurCloseGrab);
      iVar8 = ((int)*(char *)((int)vplr.rgEnvVarMax + iVar4) -
              (int)*(char *)((int)vplr.rgEnvVarMin + iVar4)) / 2;
      while (sVar7 = FGetMouseMove(&pt), sVar7 != 0) {
        if (pt.x < (vrgrcRCW + sVar3)->left) {
          pt.x = (vrgrcRCW + sVar3)->left;
        }
        if (vrgrcRCW[sVar3].right < pt.x) {
          pt.x = vrgrcRCW[sVar3].right;
        }
        sVar7 = MulDiv(pt.x - (vrgrcRCW + sVar3)->left,100,
                       vrgrcRCW[sVar3].right - (vrgrcRCW + sVar3)->left);
        iVar5 = sVar7;
        if (100 - iVar8 <= sVar7) {
          iVar5 = 100 - iVar8;
        }
        iVar6 = iVar8;
        if ((iVar8 <= iVar5) && (iVar6 = sVar7, 100 - iVar8 <= sVar7)) {
          iVar6 = 100 - iVar8;
        }
        if ((int)*(char *)((int)vplr.rgEnvVarMax + iVar4) != iVar6 + iVar8) {
          *(char *)((int)vplr.rgEnvVarMin + iVar4) = (char)iVar6 - (char)iVar8;
          *(char *)((int)vplr.rgEnvVarMax + iVar4) = (char)iVar6 + (char)iVar8;
          *(char *)((int)vplr.rgEnvVar + iVar4) =
               *(char *)((int)vplr.rgEnvVarMin + iVar4) +
               (char)(((int)*(char *)((int)vplr.rgEnvVarMax + iVar4) -
                      (int)*(char *)((int)vplr.rgEnvVarMin + iVar4)) / 2);
          DrawRace2(hwnd,0,1 << ((byte)iVar4 & 0x1f));
        }
      }
      ReleaseCapture();
      sVar3 = 1;
    }
    else {
      dWidth = 0;
      dShift = 0;
      psz = (char *)0x0;
      if (sVar3 == 0xf) {
        dShift = 1;
        bt = 0xa0;
      }
      else if (sVar3 == 0x10) {
        dShift = -1;
        bt = 0xa1;
      }
      else if (iVar8 == 0) {
        dShift = -1;
        bt = 2;
      }
      else if (iVar8 == 2) {
        dShift = 1;
        bt = 3;
      }
      else if (iVar8 == 3) {
        dWidth = 1;
        bt = 8;
        psz = vrgszRCWWidth[0];
      }
      else {
        dWidth = -1;
        bt = 8;
        psz = DAT_1120_1306;
      }
      InitBtnTrack(&btnt,hwnd,0,vrgrcRCW + sVar3,bt,0x50,0,0,psz);
      if ((kbd & 4U) != 0) {
        dWidth = dWidth * 10;
        dShift = dShift * 10;
      }
      while (sVar7 = FTrackBtn(&btnt), sVar7 != 0) {
        cVar1 = (char)dShift;
        if ((sVar3 == 0xf) || (sVar3 == 0x10)) {
          cVar1 = vplr.pctIdealGrowth + cVar1;
          cVar2 = cVar1;
          if (cVar1 < '\x01') {
            cVar2 = '\x01';
          }
          if (cVar2 < '\x15') {
            if (cVar1 < '\x01') {
              cVar1 = '\x01';
            }
          }
          else {
            cVar1 = '\x14';
          }
          if (cVar1 != vplr.pctIdealGrowth) {
            vplr.pctIdealGrowth = cVar1;
            DrawRace2(hwnd,btnt.hdc,8);
          }
        }
        else {
          iMin = *(char *)((int)vplr.rgEnvVarMin + iVar4) - ((char)dWidth - cVar1);
          iMax = *(char *)((int)vplr.rgEnvVarMax + iVar4) + (char)dWidth + cVar1;
          if ('d' < iMax) {
            iMin = iMin - (iMax + -100);
            iMax = 'd';
          }
          if (iMin < '\0') {
            if ((int)iMax - (int)iMin < 0x65) {
              iMax = iMax - iMin;
            }
            else {
              iMax = 'd';
            }
            iMin = '\0';
          }
          if ((int)iMax - (int)iMin < 0x14) {
            cVar1 = (char)(0x14 - ((int)iMax - (int)iMin) >> 1);
            iMin = iMin - cVar1;
            iMax = iMax + cVar1;
          }
          if ((*(char *)((int)vplr.rgEnvVarMin + iVar4) != iMin) ||
             (*(char *)((int)vplr.rgEnvVarMax + iVar4) != iMax)) {
            *(char *)((int)vplr.rgEnvVarMin + iVar4) = iMin;
            *(char *)((int)vplr.rgEnvVarMax + iVar4) = iMax;
            *(char *)((int)vplr.rgEnvVar + iVar4) =
                 *(char *)((int)vplr.rgEnvVarMin + iVar4) +
                 (char)(((int)*(char *)((int)vplr.rgEnvVarMax + iVar4) -
                        (int)*(char *)((int)vplr.rgEnvVarMin + iVar4)) / 2);
            DrawRace2(hwnd,btnt.hdc,1 << ((byte)iVar4 & 0x1f));
          }
        }
      }
      if (sVar3 < 0xf) {
        *(char *)((int)vplr.rgEnvVar + iVar4) =
             *(char *)((int)vplr.rgEnvVarMin + iVar4) +
             (char)(((int)*(char *)((int)vplr.rgEnvVarMax + iVar4) -
                    (int)*(char *)((int)vplr.rgEnvVarMin + iVar4)) / 2);
      }
      sVar3 = 1;
    }
  }
  return sVar3;
}



// ======================================================================
// Function: RaceWizardDlg3
// Address: 10e0:2792
// Segment: MEMORY_RACE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: ps */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short RaceWizardDlg3(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  POINT pt;
  POINT pt_00;
  WPARAM WVar1;
  HWND HVar2;
  HDC hdc_00;
  short sVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar4;
  LRESULT LVar5;
  UINT UVar6;
  PAINTSTRUCT ps;
  HDC hdc;
  RECT rc;
  short i;
  
  uVar4 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    hdc_00 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    DrawRace3(hwnd,hdc_00,-1);
    EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    sVar3 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar3 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      HVar2 = GetDlgItem(hwnd,0x123);
      if (((HWND)lParam == HVar2) || (uVar4 = __aFulshr(uVar4,ps.hdc), (int)uVar4 == 6)) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else if (message == WM_SETCURSOR) {
      GetCursorPos((undefined2 *)CONCAT22(unaff_SS,ps.rgbReserved + 0xe));
      ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,ps.rgbReserved + 0xe));
      pt.y = hdc;
      pt.x._0_1_ = ps.rgbReserved[0xe];
      pt.x._1_1_ = ps.rgbReserved[0xf];
      sVar3 = IrcRaceDlgHitTest(pt);
      if (-1 < sVar3) {
        setcursor(hcurHand);
        return 1;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        SetRCWTitle(hwnd,iPanelActive);
        HVar2 = GetDlgItem(hwnd,0x123);
        UVar6 = 0x401;
        WVar1 = GetRaceGrbit((PLAYER *)&vplr,ibitRaceCheapFact);
        SendMessage(HVar2,UVar6,WVar1,0);
        if ((fRCWReadOnly != 0) ||
           (sVar3 = GetRaceStat((PLAYER *)&vplr,rsMajorAdv), sVar3 == 8)) {
          HVar2 = GetDlgItem(hwnd,0x123);
          EnableWindow(HVar2,0);
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyRaceDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        if (wParam == 0x76) {
          WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x420);
          return 1;
        }
        for (i = 0; (i < 4 && (wParam != ((undefined2 *)&rgidRaceBtn)[i])); i = i + 1) {
        }
        if (i < 4) {
          StickyDlgPos(hwnd,(POINT *)&ptStickyRaceDlg,0);
          EndDialog(hwnd,i);
          return 1;
        }
        if (wParam == 0x123) {
          HVar2 = GetDlgItem(hwnd,0x123);
          LVar5 = SendMessage(HVar2,0x400,0,0);
          SetRaceGrbit((PLAYER *)&vplr,ibitRaceCheapFact,(short)LVar5);
          DrawRace3(hwnd,0,99);
        }
      }
      else if ((message == WM_LBUTTONDOWN) || (message == WM_LBUTTONDBLCLK)) {
        ps.rgbReserved[0xe] = (undefined1)lParam;
        ps.rgbReserved[0xf] = lParam._1_1_;
        uVar4 = __aFulshr(uVar4,ps.hdc);
        pt_00.y = (short)uVar4;
        pt_00.x._0_1_ = ps.rgbReserved[0xe];
        pt_00.x._1_1_ = ps.rgbReserved[0xf];
        sVar3 = FTrackRaceDlg3(hwnd,pt_00,wParam);
        return sVar3;
      }
    }
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: DrawRace3
// Address: 10e0:2aa4
// Segment: MEMORY_RACE
// ======================================================================


void DrawRace3(HWND hwnd,HDC hdc,short iDraw)

{
  int iVar1;
  int x;
  short sVar2;
  HWND HVar3;
  short sVar4;
  RECT *pRVar5;
  RECT *pRVar6;
  undefined2 unaff_SS;
  bool bVar7;
  bool bVar8;
  COLORREF CVar9;
  DWORD DVar10;
  DWORD DVar11;
  DWORD DVar12;
  RECT rc;
  short cch;
  short dx;
  short dxDig;
  short irc;
  short i;
  short dxkT;
  short fCreatedDC;
  short bkMode;
  COLORREF crBkSav;
  short ids;
  short bt;
  short yTop;
  short fMacintosh;
  short idsT;
  short dxItem;
  
  if (fRCWReadOnly == 0) {
    bt = 0;
  }
  else {
    bt = 4;
  }
  sVar2 = GetRaceStat((PLAYER *)&vplr,rsMajorAdv);
  bVar7 = sVar2 == 8;
  bVar8 = hdc == 0;
  if (bVar8) {
    hdc = GetDC(hwnd);
  }
  GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
  DrawRaceAdvantagePoints(hdc,&rc,(PLAYER *)0x0);
  sVar2 = SetBkMode(hdc,2);
  CVar9 = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
  SelectObject(hdc,rghfontArial8[1]);
  yTop = dyArial8 * 3 + 6;
  DVar10 = GetTextExtent(hdc,&DAT_1120_1353,1);
  DVar11 = GetTextExtent(hdc,&DAT_1120_1355,2);
  ids = 0xf6;
  irc = 0;
  for (i = 0; i < 7; i = i + 1) {
    if ((i == 1) && (bVar7)) {
      SetTextColor(hdc,CONCAT22(crButtonShadow._2_2_,(undefined2)crButtonShadow)
                  );
      bt = 4;
    }
    if (i == 4) {
      if (iDraw == -1) {
        HVar3 = GetDlgItem(hwnd,0x123);
        SetWindowPos(HVar3,0,6,yTop,rc.right + -0xc,(dyArial8 * 3) / 2,4);
      }
      yTop = yTop + (dyArial8 * 5) / 2;
    }
    if ((bVar7) && (ids == 0xf6)) {
      idsT = 0x104;
    }
    else {
      idsT = ids;
    }
    iVar1 = ids + 1;
    sVar4 = CchGetString(idsT,(char *)szWork);
    if (iDraw == -1) {
      TextOut(hdc,6,yTop,szWork,sVar4);
    }
    DVar12 = GetTextExtent(hdc,szWork,sVar4);
    sVar4 = _abs((int)((char *)rgRW3Width)[i]);
    dxItem = sVar4 * (int)DVar10;
    sVar4 = GetRaceStat((PLAYER *)&vplr,(int)((char *)rgRW3IStat)[i]);
    _WSPRINTF((LPSTR)CONCAT22(sVar4,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
    if ((((char *)rgRW3Width)[i] < '\0') && ((0 < i || (!bVar7)))) {
      dxItem = dxItem + (int)DVar11;
      if (i == 0) {
        _strcat((char *)szWork,(char *)&DAT_1120_1358);
      }
      else {
        _strcat((char *)szWork,(char *)&DAT_1120_135b);
      }
    }
    x = (int)DVar12 + 6 + dxItem;
    if ((iDraw == -1) || (iDraw == i)) {
      RightTextOut(hdc,x,yTop,(char *)szWork,0,dxItem);
    }
    (vrgrcRCW + irc)->left = x + 4;
    vrgrcRCW[irc].top = yTop + -3;
    vrgrcRCW[irc].right = (vrgrcRCW + irc)->left + 0xf;
    vrgrcRCW[irc].bottom = (dyArial8 >> 1) + vrgrcRCW[irc].top + 3;
    pRVar5 = vrgrcRCW + irc;
    pRVar6 = vrgrcRCW + irc + 1;
    pRVar6->left = pRVar5->left;
    pRVar6->top = pRVar5->top;
    pRVar6->right = pRVar5->right;
    pRVar6->bottom = pRVar5->bottom;
    OffsetRect((undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,vrgrcRCW + irc + 1),0,
               (vrgrcRCW[irc].bottom - vrgrcRCW[irc].top) + -1);
    if (iDraw == -1) {
      DrawBtn(hdc,vrgrcRCW + irc,bt | 0xa0,0,(char *)0x0);
      DrawBtn(hdc,vrgrcRCW + irc + 1,bt | 0xa1,0,(char *)0x0);
      idsT = iVar1;
      if ((bVar7) && (iVar1 == 0xf7)) {
        idsT = 0x105;
      }
      sVar4 = CchGetString(idsT,(char *)szWork);
      TextOut(hdc,vrgrcRCW[irc].right + 4,yTop,szWork,sVar4);
    }
    ids = ids + 2;
    irc = irc + 2;
    yTop = yTop + (((char *)rgRW3Spacing)[i] * dyArial8) / 2;
  }
  if (bVar7) {
    crcRCW = 2;
  }
  else {
    crcRCW = irc;
  }
  SetBkColor(hdc,CVar9);
  SetBkMode(hdc,sVar2);
  if (bVar8) {
    ReleaseDC(hwnd,hdc);
  }
  return;
}



// ======================================================================
// Function: FTrackRaceDlg3
// Address: 10e0:2fb8
// Segment: MEMORY_RACE
// ======================================================================


short FTrackRaceDlg3(HWND hwnd,POINT pt,short kbd)

{
  uint uVar1;
  int iDraw;
  short sVar2;
  short sVar3;
  short iStat;
  short iMod;
  short irc;
  short i;
  short dShift;
  short bt;
  BTNT btnt;
  
  uVar1 = IrcRaceDlgHitTest(pt);
  if ((int)uVar1 < 0) {
    sVar2 = 0;
  }
  else {
    iDraw = (int)uVar1 >> 1;
    if ((uVar1 & 1) == 0) {
      dShift = 1;
      bt = 0xa0;
    }
    else {
      dShift = -1;
      bt = 0xa1;
    }
    InitBtnTrack(&btnt,hwnd,0,vrgrcRCW + uVar1,bt,0x50,0,0,(char *)0x0);
    if ((kbd & 4U) != 0) {
      dShift = dShift * 3;
    }
    while (sVar2 = FTrackBtn(&btnt), sVar2 != 0) {
      sVar2 = GetRaceStat((PLAYER *)&vplr,(int)((char *)rgRW3IStat)[iDraw]);
      sVar3 = SetRaceStat((PLAYER *)&vplr,(int)((char *)rgRW3IStat)[iDraw],sVar2 + dShift)
      ;
      if (sVar3 != sVar2) {
        DrawRace3(hwnd,btnt.hdc,iDraw);
      }
    }
    sVar2 = 1;
  }
  return sVar2;
}



// ======================================================================
// Function: GetRaceStat
// Address: 10e0:30d2
// Segment: MEMORY_RACE
// ======================================================================


short GetRaceStat(PLAYER *pplr,RaceStat iStat)

{
  return (int)pplr->rgAttr[iStat];
}



// ======================================================================
// Function: SetRaceStat
// Address: 10e0:3114
// Segment: MEMORY_RACE
// ======================================================================


short SetRaceStat(PLAYER *pplr,RaceStat iStat,short iVal)

{
  if (iVal < ((char *)rgRaceStatMin)[iStat]) {
    iVal = (short)((char *)rgRaceStatMin)[iStat];
  }
  if (((char *)rgRaceStatMax)[iStat] < iVal) {
    iVal = (short)((char *)rgRaceStatMax)[iStat];
  }
  pplr->rgAttr[iStat] = (char)iVal;
  return iVal;
}



// ======================================================================
// Function: GetRaceGrbit
// Address: 10e0:3176
// Segment: MEMORY_RACE
// ======================================================================


short GetRaceGrbit(PLAYER *pplr,RaceGrbit ibit)

{
  short sVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar2;
  ushort in_stack_0000fffc;
  
  lVar2 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000fffc);
  if ((((uint)lVar2 & *(uint *)&pplr->grbitAttr) == 0) &&
     (((uint)((ulong)lVar2 >> 0x10) & *(uint *)((int)&pplr->grbitAttr + 2)) == 0)) {
    sVar1 = 0;
  }
  else {
    sVar1 = 1;
  }
  return sVar1;
}



// ======================================================================
// Function: SetRaceGrbit
// Address: 10e0:31b8
// Segment: MEMORY_RACE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: grMask */

void SetRaceGrbit(PLAYER *pplr,RaceGrbit ibit,short fSet)

{
  uint *puVar1;
  uint uVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar3;
  ulong grMask;
  
  lVar3 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),(ushort)grMask);
  uVar2 = (uint)((ulong)lVar3 >> 0x10);
  if (fSet == 0) {
    *(uint *)&pplr->grbitAttr = *(uint *)&pplr->grbitAttr & ~(uint)lVar3;
    puVar1 = (uint *)((int)&pplr->grbitAttr + 2);
    *puVar1 = *puVar1 & ~uVar2;
  }
  else {
    *(uint *)&pplr->grbitAttr = *(uint *)&pplr->grbitAttr | (uint)lVar3;
    puVar1 = (uint *)((int)&pplr->grbitAttr + 2);
    *puVar1 = *puVar1 | uVar2;
  }
  return;
}



// ======================================================================
// Function: RaceWizardDlg4
// Address: 10e0:320a
// Segment: MEMORY_RACE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: rcGBox */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short RaceWizardDlg4(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  HDC hdc_00;
  HWND HVar1;
  short sVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar3;
  short sVar4;
  short sVar5;
  RECT rcGBox;
  short cch;
  PAINTSTRUCT ps;
  short ids;
  char szT [600];
  HDC hdc;
  RECT rc;
  short i;
  
  uVar3 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    hdc_00 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    DrawRaceAdvantagePoints(hdc_00,&rc,(PLAYER *)0x0);
    SelectObject(hdc_00,rghfontArial8[1]);
    SetBkColor(hdc_00,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    HVar1 = GetDlgItem(hwnd,0x10f);
    GetWindowRect(HVar1,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
    ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
    HVar1 = GetDlgItem(hwnd,0x118);
    GetWindowRect(HVar1,(undefined2 *)CONCAT22(unaff_SS,&rc));
    ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&rc.right));
    rcGBox.right = rc.right;
    rcGBox.bottom = rc.bottom;
    ExpandRc(&rcGBox,dyArial8 + 2,dyArial8 >> 1);
    rcGBox.top = rcGBox.top + -4;
    _Draw3dFrame();
    sVar2 = CchGetString(idsPrimaryRacialTrait,(char *)szWork);
    TextOut(hdc_00,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,sVar2);
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    rc.top = rcGBox.bottom + 0xc;
    rc.left = rc.left + 0xc;
    rc.right = rc.right + -0xc;
    HVar1 = GetDlgItem(hwnd,0x76);
    GetWindowRect(HVar1,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
    ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
    rc.bottom = rcGBox.top + -6;
    _Draw3dFrame();
    sVar2 = CchGetString(idsDescriptionTrait,(char *)szWork);
    TextOut(hdc_00,rc.left + 8,rc.top - (dyArial8 >> 1),szWork,sVar2);
    sVar2 = GetRaceStat((PLAYER *)&vplr,rsMajorAdv);
    ids = sVar2 * 3 + 0x114;
    cch = 0;
    for (i = 0; i < 3; i = i + 1) {
      sVar2 = CchGetString(ids,szT + cch);
      cch = cch + sVar2;
      ids = ids + 1;
    }
    ExpandRc(&rc,-2 - dyArial8,-(dyArial8 >> 1));
    rc.top = rc.top + 4;
    DRAWTEXT(hdc_00,(LPCSTR)CONCAT22(unaff_SS,szT),cch,(undefined2 *)CONCAT22(unaff_SS,&rc),0x10);
    rcCargo.left = rc.left;
    rcCargo.top = rc.top;
    rcCargo.right = rc.right;
    rcCargo.bottom = rc.bottom;
    EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    sVar2 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar2 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      for (i = 0x10f; i < 0x119; i = i + 1) {
        HVar1 = GetDlgItem(hwnd,i);
        if ((HWND)lParam == HVar1) break;
      }
      if ((i < 0x119) || (uVar3 = __aFulshr(uVar3,rcGBox.left), (int)uVar3 == 6)) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        SetRCWTitle(hwnd,iPanelActive);
        sVar5 = 0x10f;
        sVar4 = 0x118;
        HVar1 = hwnd;
        sVar2 = GetRaceStat((PLAYER *)&vplr,rsMajorAdv);
        CheckRadioButton(HVar1,sVar5,sVar4,sVar2 + 0x10f);
        if (fRCWReadOnly != 0) {
          for (i = 0x10f; i < 0x119; i = i + 1) {
            HVar1 = GetDlgItem(hwnd,i);
            EnableWindow(HVar1,0);
          }
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyRaceDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        if (wParam == 0x76) {
          WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x408);
          return 1;
        }
        for (i = 0; (i < 4 && (wParam != ((undefined2 *)&rgidRaceBtn)[i])); i = i + 1) {
        }
        if (i < 4) {
          StickyDlgPos(hwnd,(POINT *)&ptStickyRaceDlg,0);
          EndDialog(hwnd,i);
          return 1;
        }
        uVar3 = __aFulshr(uVar3,rcGBox.left);
        if ((((int)uVar3 == 0) && (0x10e < wParam)) && (wParam < 0x119)) {
          SetRaceStat((PLAYER *)&vplr,rsMajorAdv,wParam - 0x10f);
          sVar2 = GetRaceStat((PLAYER *)&vplr,rsMajorAdv);
          if (sVar2 == 8) {
            SetRaceStat((PLAYER *)&vplr,rsFactProd,10);
            SetRaceStat((PLAYER *)&vplr,rsFactBuild,10);
            SetRaceStat((PLAYER *)&vplr,rsFactOperate,10);
            SetRaceStat((PLAYER *)&vplr,rsMineProd,10);
            SetRaceStat((PLAYER *)&vplr,rsMineBuild,5);
            SetRaceStat((PLAYER *)&vplr,rsMineOperate,10);
            SetRaceGrbit((PLAYER *)&vplr,ibitRaceCheapFact,0);
          }
          InvalidateAdvPtsRect(hwnd);
          InvalidateRect(hwnd,&rcCargo.left,0);
        }
      }
    }
    sVar2 = 0;
  }
  return sVar2;
}



// ======================================================================
// Function: RaceWizardDlg5
// Address: 10e0:378e
// Segment: MEMORY_RACE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: rcGBox */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short RaceWizardDlg5(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  HWND HVar1;
  char *pcVar2;
  WPARAM WVar3;
  HDC hdc_00;
  HWND HVar4;
  short sVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar6;
  LRESULT LVar7;
  UINT UVar8;
  RECT rcGBox;
  short cch;
  PAINTSTRUCT ps;
  HDC hdc;
  RECT rc;
  short i;
  
  uVar6 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    hdc_00 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    DrawRaceAdvantagePoints(hdc_00,&rc,(PLAYER *)0x0);
    SelectObject(hdc_00,rghfontArial8[1]);
    SetBkColor(hdc_00,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    HVar4 = GetDlgItem(hwnd,0x130);
    GetWindowRect(HVar4,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
    ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&rcGBox.right));
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    rc.top = rcGBox.bottom + 0xc;
    rc.left = rc.left + 0xc;
    rc.right = rc.right + -0xc;
    HVar4 = GetDlgItem(hwnd,0x76);
    GetWindowRect(HVar4,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
    ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
    rc.bottom = rcGBox.top + -0xc;
    _Draw3dFrame();
    rcCargo.left = rc.left;
    rcCargo.right = rc.right;
    rcCargo.bottom = rc.bottom;
    rcCargo.top = rc.top - (dyArial8 >> 1);
    sVar5 = CchGetString
                      (cColDrop + idsImprovedFuelEfficiency,(char *)szWork);
    TextOut(hdc_00,rc.left + 8,rc.top - (dyArial8 >> 1),szWork,sVar5);
    sVar5 = CchGetString
                      (cColDrop + idsGivesFuelMizerGalaxyScoopEnginesIncreases,
                       (char *)szWork);
    ExpandRc(&rc,-2 - dyArial8,-(dyArial8 >> 1));
    rc.top = rc.top + 4;
    DRAWTEXT(hdc_00,szWork,sVar5,(undefined2 *)CONCAT22(unaff_SS,&rc),0x10);
    EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    sVar5 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar5 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      for (i = 0x123; i < 0x131; i = i + 1) {
        HVar4 = GetDlgItem(hwnd,i);
        if ((HWND)lParam == HVar4) break;
      }
      if ((i < 0x131) || (uVar6 = __aFulshr(uVar6,rcGBox.left), (int)uVar6 == 6)) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        SetRCWTitle(hwnd,iPanelActive);
        cColDrop = 0;
        for (i = 0; i < 0xe; i = i + 1) {
          HVar1 = GetDlgItem(hwnd,i + 0x123);
          HVar4 = HVar1;
          pcVar2 = PszGetCompressedString(i + idsImprovedFuelEfficiency);
          SetWindowText(HVar4,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar2));
          UVar8 = 0x401;
          HVar4 = HVar1;
          WVar3 = GetRaceGrbit((PLAYER *)&vplr,i);
          SendMessage(HVar4,UVar8,WVar3,0);
          if (fRCWReadOnly != 0) {
            EnableWindow(HVar1,0);
          }
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyRaceDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        if (wParam == 0x76) {
          WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x411);
          return 1;
        }
        for (i = 0; (i < 4 && (wParam != ((undefined2 *)&rgidRaceBtn)[i])); i = i + 1) {
        }
        if (i < 4) {
          StickyDlgPos(hwnd,(POINT *)&ptStickyRaceDlg,0);
          EndDialog(hwnd,i);
          return 1;
        }
        if ((0x122 < wParam) && (wParam < 0x131)) {
          HVar4 = GetDlgItem(hwnd,wParam);
          LVar7 = SendMessage(HVar4,0x400,0,0);
          cColDrop = wParam - 0x123;
          SetRaceGrbit((PLAYER *)&vplr,cColDrop,(short)LVar7);
          InvalidateAdvPtsRect(hwnd);
          InvalidateRect(hwnd,&rcCargo.left,0);
        }
      }
    }
    sVar5 = 0;
  }
  return sVar5;
}



// ======================================================================
// Function: RaceWizardDlg6
// Address: 10e0:3bae
// Segment: MEMORY_RACE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: rcGBox */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short RaceWizardDlg6(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  int iVar1;
  int iVar2;
  char *pcVar3;
  WPARAM WVar4;
  HDC hdc_00;
  HWND HVar5;
  short sVar6;
  short sVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar8;
  LRESULT LVar9;
  UINT UVar10;
  RECT rcGBox;
  short cch;
  PAINTSTRUCT ps;
  HDC hdc;
  RECT rc;
  short i;
  
  uVar8 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    hdc_00 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    DrawRaceAdvantagePoints(hdc_00,&rc,(PLAYER *)0x0);
    SelectObject(hdc_00,rghfontArial8[1]);
    SetBkColor(hdc_00,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    for (i = 0; i < 6; i = i + 1) {
      HVar5 = GetDlgItem(hwnd,i * 3 + 0x10f);
      GetWindowRect(HVar5,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
      ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
      HVar5 = GetDlgItem(hwnd,i * 3 + 0x111);
      GetWindowRect(HVar5,(undefined2 *)CONCAT22(unaff_SS,&rc));
      ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&rc.right));
      rcGBox.right = rc.right;
      rcGBox.bottom = rc.bottom;
      ExpandRc(&rcGBox,dyArial8,dyArial8 >> 1);
      _Draw3dFrame();
      sVar6 = CchGetString(i + idsEnergy,(char *)szWork);
      sVar7 = CchGetString(idsResearch,(char *)szWork + sVar6);
      TextOut(hdc_00,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,
              sVar6 + sVar7);
    }
    EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    sVar6 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar6 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      i = 0x10f;
      while ((i < 0x121 && (HVar5 = GetDlgItem(hwnd,i), (HWND)lParam != HVar5))) {
        i = i + 1;
      }
      if (((i < 0x121) || (HVar5 = GetDlgItem(hwnd,0x123), (HWND)lParam == HVar5)) ||
         (uVar8 = __aFulshr(uVar8,rcGBox.left), (int)uVar8 == 6)) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        SetRCWTitle(hwnd,iPanelActive);
        for (i = 0; i < 6; i = i + 1) {
          iVar1 = i * 3 + 0x10f;
          iVar2 = i * 3 + 0x111;
          HVar5 = hwnd;
          sVar6 = GetRaceStat((PLAYER *)&vplr,i + rsTechBonus1);
          CheckRadioButton(HVar5,iVar1,iVar2,i * 3 + 0x10f + sVar6);
        }
        if (fRCWReadOnly != 0) {
          for (i = 0x10f; i < 0x121; i = i + 1) {
            HVar5 = GetDlgItem(hwnd,i);
            EnableWindow(HVar5,0);
          }
        }
        sVar6 = GetRaceStat((PLAYER *)&vplr,rsMajorAdv);
        iVar1 = (sVar6 == 9) + 3;
        pcVar3 = PszGetCompressedString(idsCosts75ExtraResearchFieldsStartTech);
        _WSPRINTF((LPSTR)CONCAT22(iVar1,(char *)&DAT_1120_1120),
                  (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
        HVar5 = GetDlgItem(hwnd,0x123);
        SetWindowText(HVar5,szWork);
        HVar5 = GetDlgItem(hwnd,0x123);
        UVar10 = 0x401;
        WVar4 = GetRaceGrbit((PLAYER *)&vplr,ibitRaceTech3);
        SendMessage(HVar5,UVar10,WVar4,0);
        if (fRCWReadOnly != 0) {
          HVar5 = GetDlgItem(hwnd,0x123);
          EnableWindow(HVar5,0);
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyRaceDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        if (wParam == 0x76) {
          WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x421);
          return 1;
        }
        for (i = 0; (i < 4 && (wParam != ((undefined2 *)&rgidRaceBtn)[i])); i = i + 1) {
        }
        if (i < 4) {
          StickyDlgPos(hwnd,(POINT *)&ptStickyRaceDlg,0);
          EndDialog(hwnd,i);
          return 1;
        }
        uVar8 = __aFulshr(uVar8,rcGBox.left);
        if ((((int)uVar8 == 0) && (0x10e < wParam)) && (wParam < 0x121)) {
          SetRaceStat((PLAYER *)&vplr,(int)(wParam - 0x10f) / 3 + rsTechBonus1,
                      (int)(wParam - 0x10f) % 3);
          InvalidateAdvPtsRect(hwnd);
        }
        else if (wParam == 0x123) {
          HVar5 = GetDlgItem(hwnd,0x123);
          LVar9 = SendMessage(HVar5,0x400,0,0);
          SetRaceGrbit((PLAYER *)&vplr,ibitRaceTech3,(short)LVar9);
          InvalidateAdvPtsRect(hwnd);
        }
      }
    }
    sVar6 = 0;
  }
  return sVar6;
}



// ======================================================================
// Function: BoundsCheckPlayer
// Address: 10e0:40ae
// Segment: MEMORY_RACE
// ======================================================================


void BoundsCheckPlayer(PLAYER *pplr)

{
  short i;
  
  for (i = 0; i < 3; i = i + 1) {
    if (pplr->rgEnvVarMin[i] == -1) {
      if ((pplr->rgEnvVarMax[i] != -1) || (pplr->rgEnvVar[i] != -1)) {
        pplr->rgEnvVar[i] = -1;
        pplr->rgEnvVarMax[i] = -1;
        pplr->wFlags = pplr->wFlags & 0xffefU | 0x10;
      }
    }
    else {
      if (pplr->rgEnvVarMin[i] < '\0') {
        pplr->rgEnvVarMin[i] = '\0';
        pplr->wFlags = pplr->wFlags & 0xffefU | 0x10;
      }
      if ('d' < pplr->rgEnvVarMin[i]) {
        pplr->rgEnvVarMin[i] = 'd';
        pplr->wFlags = pplr->wFlags & 0xffefU | 0x10;
      }
      if ('d' < pplr->rgEnvVarMax[i]) {
        pplr->rgEnvVarMax[i] = 'd';
        pplr->wFlags = pplr->wFlags & 0xffefU | 0x10;
      }
      if (pplr->rgEnvVarMax[i] < pplr->rgEnvVarMin[i]) {
        pplr->rgEnvVarMax[i] = pplr->rgEnvVarMin[i];
        pplr->wFlags = pplr->wFlags & 0xffefU | 0x10;
      }
      if ((int)pplr->rgEnvVar[i] !=
          (int)pplr->rgEnvVarMin[i] + ((int)pplr->rgEnvVarMax[i] - (int)pplr->rgEnvVarMin[i]) / 2) {
        pplr->rgEnvVar[i] =
             pplr->rgEnvVarMin[i] +
             (char)(((int)pplr->rgEnvVarMax[i] - (int)pplr->rgEnvVarMin[i]) / 2);
        pplr->wFlags = pplr->wFlags & 0xffefU | 0x10;
      }
    }
  }
  if ('\x14' < pplr->pctIdealGrowth) {
    pplr->pctIdealGrowth = '\x14';
    pplr->wFlags = pplr->wFlags & 0xffefU | 0x10;
  }
  for (i = 0; i < 0x10; i = i + 1) {
    if (pplr->rgAttr[i] < ((char *)rgRaceStatMin)[i]) {
      pplr->rgAttr[i] = ((char *)rgRaceStatMin)[i];
      pplr->wFlags = pplr->wFlags & 0xffefU | 0x10;
    }
    if (((char *)rgRaceStatMax)[i] < pplr->rgAttr[i]) {
      pplr->rgAttr[i] = ((char *)rgRaceStatMax)[i];
      pplr->wFlags = pplr->wFlags & 0xffefU | 0x10;
    }
  }
  return;
}



// ======================================================================
// Function: CAdvantagePoints
// Address: 10e0:444c
// Segment: MEMORY_RACE
// ======================================================================


short CAdvantagePoints(PLAYER *pplr)

{
  long lVar1;
  char cVar2;
  short sVar3;
  short sVar4;
  short sVar5;
  int iVar6;
  int iVar7;
  int iVar8;
  short sVar9;
  uint uVar10;
  bool bVar11;
  long lVar12;
  ulong uVar13;
  ulong uVar14;
  long lVar15;
  short cProduce;
  short cOperate;
  short raMajor;
  long lInnate;
  short cGood;
  short rgi [3];
  short i;
  short cCur;
  short cBad;
  long cPoints;
  short iSpread;
  short pctGrowth;
  
  cPoints._0_2_ = (char *)0x672;
  BoundsCheckPlayer(pplr);
  sVar3 = GetRaceStat(pplr,rsMajorAdv);
  lVar15 = 2000;
  lVar12 = LInnateRaceHabitability(pplr);
  uVar13 = __aFldiv(lVar12,lVar15);
  if (pplr->pctIdealGrowth < '\x15') {
    cVar2 = pplr->pctIdealGrowth;
  }
  else {
    cVar2 = '\x14';
  }
  if (cVar2 < '\x01') {
    iSpread = 1;
  }
  else if (pplr->pctIdealGrowth < '\x15') {
    iSpread = (short)pplr->pctIdealGrowth;
  }
  else {
    iSpread = 0x14;
  }
  if (iSpread != pplr->pctIdealGrowth) {
    iSpread = 1;
    pplr->pctIdealGrowth = '\x01';
    pplr->wFlags = pplr->wFlags & 0xffefU | 0x10;
  }
  sVar9 = iSpread;
  if (iSpread < 6) {
    uVar14 = __aFulmul((long)(6 - iSpread),0x1068);
    uVar14 = uVar14 + 0x672;
  }
  else {
    if (iSpread < 0xe) {
      if (iSpread == 6) {
        cPoints._0_2_ = (char *)s__s__d_1120_147d + 5;
      }
      else if (iSpread == 7) {
        cPoints._0_2_ = (char *)0xf3c;
      }
      else if (iSpread == 8) {
        cPoints._0_2_ = (char *)0x8ca;
      }
      else if (iSpread == 9) {
        cPoints._0_2_ = (char *)0x753;
      }
      iSpread = (iSpread + -5) * 2 + 5;
    }
    else if (iSpread < 0x14) {
      iSpread = (iSpread + -0xd) * 3 + 0x15;
    }
    else {
      iSpread = 0x2d;
    }
    uVar14 = ZEXT24((char *)cPoints);
  }
  lVar12 = 0x18;
  uVar13 = __aFulmul(uVar13,(long)iSpread);
  lVar12 = __aFldiv(uVar13,lVar12);
  lVar12 = uVar14 - lVar12;
  cGood = 0;
  i = 0;
  while( true ) {
    cPoints._2_2_ = (int)((ulong)lVar12 >> 0x10);
    cPoints._0_2_ = (char *)lVar12;
    if (2 < i) break;
    if (pplr->rgEnvVar[i] < '\0') {
      cGood = cGood + 1;
    }
    else {
      sVar4 = _abs(pplr->rgEnvVar[i] + -0x32);
      lVar12 = lVar12 + sVar4 * 4;
    }
    i = i + 1;
  }
  if (1 < cGood) {
    lVar12 = CONCAT22(cPoints._2_2_ - (uint)((char *)cPoints < 0x96),(int)(char *)cPoints - 0x96);
  }
  sVar4 = GetRaceStat(pplr,rsFactOperate);
  sVar5 = GetRaceStat(pplr,rsFactProd);
  if ((10 < sVar4) || (10 < sVar5)) {
    if (sVar4 + -9 < 1) {
      iVar6 = 1;
    }
    else {
      iVar6 = sVar4 + -9;
    }
    if (sVar5 + -9 < 1) {
      iVar7 = 1;
    }
    else {
      iVar7 = sVar5 + -9;
    }
    if (sVar3 == 0) {
      iVar8 = 3;
    }
    else {
      iVar8 = 2;
    }
    if (cGood < 2) {
      lVar15 = 9;
      uVar14 = (ulong)sVar9;
      uVar13 = __aFulmul((long)iVar6,(long)(iVar8 * iVar7));
      uVar13 = __aFulmul(uVar13,uVar14);
      lVar15 = __aFldiv(uVar13,lVar15);
      lVar12 = lVar12 - lVar15;
    }
    else {
      lVar15 = 2;
      uVar14 = (ulong)sVar9;
      uVar13 = __aFulmul((long)iVar6,(long)(iVar8 * iVar7));
      uVar13 = __aFulmul(uVar13,uVar14);
      lVar15 = __aFldiv(uVar13,lVar15);
      lVar12 = lVar12 - lVar15;
    }
  }
  cPoints._2_2_ = (int)((ulong)lVar12 >> 0x10);
  cPoints._0_2_ = (char *)lVar12;
  iVar6 = GetRaceStat(pplr,rsResGen);
  if (0x18 < iVar6) {
    iVar6 = 0x19;
  }
  if (iVar6 < 8) {
    lVar12 = CONCAT22(cPoints._2_2_ - (uint)((char *)cPoints < 0x960),(int)(char *)cPoints - 0x960);
  }
  else if (iVar6 == 8) {
    lVar12 = CONCAT22(cPoints._2_2_ - (uint)((char *)cPoints < 0x4ec),(int)(char *)cPoints - 0x4ec);
  }
  else if (iVar6 == 9) {
    lVar12 = CONCAT22(cPoints._2_2_ - (uint)((char *)cPoints < 600),(int)(char *)cPoints - 600);
  }
  else if (10 < iVar6) {
    lVar12 = lVar12 + (iVar6 + -10) * 0x78;
  }
  if (sVar3 == 8) {
    lVar12 = lVar12 + 0xd2;
  }
  else {
    sVar9 = GetRaceStat(pplr,rsFactProd);
    iVar7 = 10 - sVar9;
    sVar9 = GetRaceStat(pplr,rsFactBuild);
    iVar6 = 10 - sVar9;
    sVar9 = GetRaceStat(pplr,rsFactOperate);
    iVar8 = 10 - sVar9;
    if (iVar7 < 1) {
      cCur = iVar7 * 0x79;
    }
    else {
      cCur = iVar7 * 100;
    }
    if (iVar6 < 0) {
      iVar6 = iVar6 * -0x37;
    }
    else {
      iVar6 = iVar6 * iVar6 * -0x3c;
    }
    cCur = cCur + iVar6;
    if (iVar8 < 1) {
      iVar6 = iVar8 * 0x23;
    }
    else {
      iVar6 = iVar8 * 0x28;
    }
    cCur = cCur + iVar6;
    if (700 < cCur) {
      cCur = (cCur + -700) / 3 + 700;
    }
    if (iVar8 < -6) {
      if (iVar8 < -0xb) {
        if (iVar8 < -0xe) {
          cCur = cCur + -0x168;
        }
        else {
          cCur = cCur - ((-0xc - iVar8) * 0x2d + 0xe1);
        }
      }
      else {
        cCur = cCur + (-6 - iVar8) * -0x1e;
      }
    }
    if (iVar7 < -2) {
      cCur = cCur + (-2 - iVar7) * -0x3c;
    }
    lVar12 = lVar12 + cCur;
    sVar9 = GetRaceGrbit(pplr,ibitRaceCheapFact);
    if (sVar9 != 0) {
      lVar12 = CONCAT22((int)((ulong)lVar12 >> 0x10) - (uint)((uint)lVar12 < 0xaf),
                        (uint)lVar12 - 0xaf);
    }
    sVar9 = GetRaceStat(pplr,rsMineProd);
    iVar7 = 10 - sVar9;
    sVar9 = GetRaceStat(pplr,rsMineBuild);
    sVar4 = GetRaceStat(pplr,rsMineOperate);
    iVar6 = 10 - sVar4;
    if (iVar7 < 1) {
      cCur = iVar7 * 0xa9;
    }
    else {
      cCur = iVar7 * 100;
    }
    if (3 - sVar9 < 1) {
      cCur = cCur - ((3 - sVar9) * 0x41 + -0x50);
    }
    else {
      cCur = cCur + -0x168;
    }
    if (iVar6 < 1) {
      iVar6 = iVar6 * 0x23;
    }
    else {
      iVar6 = iVar6 * 0x28;
    }
    cCur = cCur + iVar6;
    lVar12 = lVar12 + cCur;
  }
  lVar12 = lVar12 - ((short *)rgRacePrimaryTrait)[sVar3];
  cBad = 0;
  cGood = 0;
  for (i = 0; i < 0xe; i = i + 1) {
    sVar9 = GetRaceGrbit(pplr,i);
    if (sVar9 != 0) {
      if (((short *)rgRaceAdvDisPts)[i] < 0) {
        cBad = cBad + 1;
      }
      else {
        cGood = cGood + 1;
      }
      lVar12 = lVar12 + ((short *)rgRaceAdvDisPts)[i];
    }
  }
  if (4 < cBad + cGood) {
    lVar12 = lVar12 - (cBad + cGood) * 10 * (cBad + cGood + -4);
  }
  cPoints._2_2_ = (int)((ulong)lVar12 >> 0x10);
  cPoints._0_2_ = (char *)lVar12;
  if (3 < cGood - cBad) {
    iVar6 = (cGood - cBad) + -3;
    uVar10 = iVar6 * 0x3c;
    lVar12 = CONCAT22((cPoints._2_2_ - ((int)uVar10 >> 0xf)) - (uint)((char *)cPoints < uVar10),
                      (int)(char *)cPoints + iVar6 * -0x3c);
  }
  cPoints._2_2_ = (int)((ulong)lVar12 >> 0x10);
  cPoints._0_2_ = (char *)lVar12;
  if (3 < cBad - cGood) {
    iVar6 = (cBad - cGood) + -3;
    uVar10 = iVar6 * 0x28;
    lVar12 = CONCAT22((cPoints._2_2_ - ((int)uVar10 >> 0xf)) - (uint)((char *)cPoints < uVar10),
                      (int)(char *)cPoints + iVar6 * -0x28);
  }
  cPoints._2_2_ = (int)((ulong)lVar12 >> 0x10);
  cPoints._0_2_ = (char *)lVar12;
  sVar9 = GetRaceGrbit(pplr,ibitRaceNoAdvScanner);
  if (sVar9 != 0) {
    if (sVar3 == 6) {
      lVar12 = CONCAT22(cPoints._2_2_ - (uint)((char *)cPoints < 0x118),(int)(char *)cPoints - 0x118
                       );
    }
    else if (sVar3 == 1) {
      lVar12 = CONCAT22(cPoints._2_2_ - (uint)((char *)cPoints < 200),(int)(char *)cPoints - 200);
    }
    else if (sVar3 == 9) {
      lVar12 = CONCAT22(cPoints._2_2_ - (uint)((char *)cPoints < 0x28),(int)(char *)cPoints - 0x28);
    }
  }
  cPoints._2_2_ = (int)((ulong)lVar12 >> 0x10);
  cPoints._0_2_ = (char *)lVar12;
  cCur = 0;
  for (i = 8; i < 0xe; i = i + 1) {
    sVar9 = GetRaceStat(pplr,i);
    cCur = cCur + sVar9 + -1;
  }
  if (cCur < 1) {
    if (cCur < 0) {
      iVar6 = ((short *)rgRaceDisEnvPts)[-1 - cCur];
      lVar1 = lVar12 + iVar6;
      uVar10 = (uint)lVar1;
      lVar15 = lVar12 + iVar6;
      lVar12 = lVar12 + iVar6;
      if ((cCur != -4 && 3 < -cCur) &&
         (sVar9 = GetRaceStat(pplr,rsResGen), lVar12 = lVar15, sVar9 < 10)) {
        lVar12 = CONCAT22((int)((ulong)lVar1 >> 0x10) - (uint)(uVar10 < 0xbe),uVar10 - 0xbe);
      }
    }
  }
  else {
    uVar10 = cCur * cCur * 0x82;
    bVar11 = (char *)cPoints < uVar10;
    cPoints._0_2_ = (char *)((int)(char *)cPoints + cCur * cCur * -0x82);
    cPoints._2_2_ = (cPoints._2_2_ - ((int)uVar10 >> 0xf)) - (uint)bVar11;
    if (cCur == 6) {
      bVar11 = 0xfa69 < (char *)cPoints;
      cPoints._0_2_ = (char *)((int)(char *)cPoints + 0x596);
      cPoints._2_2_ = cPoints._2_2_ + (uint)bVar11;
    }
    else if (cCur == 5) {
      bVar11 = 0xfdf7 < (char *)cPoints;
      cPoints._0_2_ = (char *)((int)(char *)cPoints + 0x208);
      cPoints._2_2_ = cPoints._2_2_ + (uint)bVar11;
    }
    lVar12 = CONCAT22(cPoints._2_2_,(char *)cPoints);
  }
  cPoints._2_2_ = (int)((ulong)lVar12 >> 0x10);
  cPoints._0_2_ = (char *)lVar12;
  sVar9 = GetRaceGrbit(pplr,ibitRaceTech3);
  if (sVar9 != 0) {
    lVar12 = CONCAT22(cPoints._2_2_ - (uint)((char *)cPoints < 0xb4),(int)(char *)cPoints - 0xb4);
  }
  cPoints._2_2_ = (int)((ulong)lVar12 >> 0x10);
  cPoints._0_2_ = (char *)lVar12;
  if ((sVar3 == 8) && (sVar3 = GetRaceStat(pplr,rsTechBonus1), sVar3 == 2)) {
    lVar12 = CONCAT22(cPoints._2_2_ - (uint)((char *)cPoints < 100),(int)(char *)cPoints - 100);
  }
  lVar12 = __aFldiv(lVar12,3);
  return (short)lVar12;
}



// ======================================================================
// Function: LInnateRaceHabitability
// Address: 10e0:4c6e
// Segment: MEMORY_RACE
// ======================================================================


long LInnateRaceHabitability(PLAYER *pplr)

{
  PLAYER *pPVar1;
  PLAYER *pPVar2;
  char cVar3;
  short sVar4;
  short sVar5;
  uint uVar6;
  int iVar7;
  undefined2 unaff_SI;
  PLAYER *pPVar8;
  PLAYER *pPVar9;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  bool bVar10;
  ulong uVar11;
  long lVar12;
  undefined2 uVar13;
  undefined2 uVar14;
  undefined2 in_stack_0000feac;
  undefined2 in_stack_0000feae;
  short pctTerra;
  double lInnate;
  short k;
  long pctDesire;
  short iDelta;
  double l3;
  short rgBase [3];
  long l1;
  short j;
  short iTerra;
  short i;
  short rgInc [3];
  short fTotalTerra;
  short rgDelta [3];
  PLAYER plrT;
  short rgSteps [3];
  double l2;
  PLANET pl;
  short iTry;
  
  pPVar8 = (PLAYER *)rgplr;
  pPVar9 = &plrT;
  for (iVar7 = 0x60; iVar7 != 0; iVar7 = iVar7 + -1) {
    pPVar2 = pPVar9;
    pPVar9 = (PLAYER *)&pPVar9->cPlanet;
    pPVar1 = pPVar8;
    pPVar8 = (PLAYER *)&pPVar8->cPlanet;
    cVar3 = pPVar1->cShDef;
    pPVar2->iPlayer = pPVar1->iPlayer;
    pPVar2->cShDef = cVar3;
  }
  sVar4 = GetRaceGrbit(pplr,ibitRaceTT);
  pPVar8 = (PLAYER *)rgplr;
  pPVar9 = pplr;
  for (iVar7 = 0x60; iVar7 != 0; iVar7 = iVar7 + -1) {
    pPVar2 = pPVar8;
    pPVar8 = (PLAYER *)&pPVar8->cPlanet;
    pPVar1 = pPVar9;
    pPVar9 = (PLAYER *)&pPVar9->cPlanet;
    cVar3 = pPVar1->cShDef;
    pPVar2->iPlayer = pPVar1->iPlayer;
    pPVar2->cShDef = cVar3;
  }
  rgDelta[2] = 0;
  rgDelta[1] = 0;
  rgDelta[0] = 0;
  for (iTerra = 0; iTerra < 3; iTerra = iTerra + 1) {
    if (iTerra == 0) {
      pctTerra = 0;
    }
    else if (iTerra == 1) {
      if (sVar4 == 0) {
        pctTerra = 5;
      }
      else {
        pctTerra = 8;
      }
    }
    else if (sVar4 == 0) {
      pctTerra = 0xf;
    }
    else {
      pctTerra = 0x11;
    }
    for (i = 0; i < 3; i = i + 1) {
      if (((((('d' < pplr->rgEnvVar[i]) || ('d' < pplr->rgEnvVarMin[i])) ||
            ('d' < pplr->rgEnvVarMax[i])) ||
           ((pplr->rgEnvVar[i] < '\0' || (pplr->rgEnvVarMin[i] < '\0')))) ||
          (pplr->rgEnvVarMax[i] < '\0')) &&
         (((pplr->rgEnvVar[i] != -1 || (pplr->rgEnvVarMin[i] != -1)) || (pplr->rgEnvVarMax[i] != -1)
          ))) {
        pplr->rgEnvVarMax[i] = -1;
        pplr->rgEnvVarMin[i] = -1;
        pplr->rgEnvVar[i] = -1;
        pplr->wFlags = pplr->wFlags & 0xffefU | 0x10;
        pPVar8 = (PLAYER *)rgplr;
        pPVar9 = pplr;
        for (iVar7 = 0x60; iVar7 != 0; iVar7 = iVar7 + -1) {
          pPVar2 = pPVar8;
          pPVar8 = (PLAYER *)&pPVar8->cPlanet;
          pPVar1 = pPVar9;
          pPVar9 = (PLAYER *)&pPVar9->cPlanet;
          cVar3 = pPVar1->cShDef;
          pPVar2->iPlayer = pPVar1->iPlayer;
          pPVar2->cShDef = cVar3;
        }
      }
      if (pplr->rgEnvVar[i] < '\0') {
        rgBase[i] = 0x32;
        rgInc[i] = 0xb;
        rgSteps[i] = 1;
      }
      else {
        rgBase[i] = pplr->rgEnvVarMin[i] - pctTerra;
        if (rgBase[i] < 0) {
          rgBase[i] = 0;
        }
        iTry = pplr->rgEnvVarMax[i] + pctTerra;
        if (100 < iTry) {
          iTry = 100;
        }
        rgInc[i] = iTry - rgBase[i];
        rgSteps[i] = 0xb;
      }
    }
    for (i = 0; i < rgSteps[0]; i = i + 1) {
      if ((i == 0) || (rgSteps[0] < 2)) {
        iTry = rgBase[0];
      }
      else {
        iTry = (i * rgInc[0]) / (rgSteps[0] + -1) + rgBase[0];
      }
      if ((iTerra != 0) && (-1 < pplr->rgEnvVar[0])) {
        iVar7 = pplr->rgEnvVar[0] - iTry;
        sVar5 = _abs(iVar7);
        if (pctTerra < sVar5) {
          if (iVar7 < 0) {
            iDelta = iVar7 + pctTerra;
          }
          else {
            iDelta = iVar7 - pctTerra;
          }
        }
        else {
          iDelta = 0;
        }
        rgDelta[0] = iDelta;
        iTry = pplr->rgEnvVar[0] - iDelta;
      }
      pl.rgEnvVar[0] = (char)iTry;
      for (j = 0; j < rgSteps[1]; j = j + 1) {
        if ((j == 0) || (rgSteps[1] < 2)) {
          iTry = rgBase[1];
        }
        else {
          iTry = (j * rgInc[1]) / (rgSteps[1] + -1) + rgBase[1];
        }
        if ((iTerra != 0) && (-1 < pplr->rgEnvVar[1])) {
          iVar7 = pplr->rgEnvVar[1] - iTry;
          sVar5 = _abs(iVar7);
          if (pctTerra < sVar5) {
            if (iVar7 < 0) {
              iDelta = iVar7 + pctTerra;
            }
            else {
              iDelta = iVar7 - pctTerra;
            }
          }
          else {
            iDelta = 0;
          }
          rgDelta[1] = iDelta;
          iTry = pplr->rgEnvVar[1] - iDelta;
        }
        pl.rgEnvVar[1] = (char)iTry;
        l1 = 0;
        for (k = 0; k < rgSteps[2]; k = k + 1) {
          if ((k == 0) || (rgSteps[2] < 2)) {
            iTry = rgBase[2];
          }
          else {
            iTry = (k * rgInc[2]) / (rgSteps[2] + -1) + rgBase[2];
          }
          if ((iTerra != 0) && (-1 < pplr->rgEnvVar[2])) {
            iVar7 = pplr->rgEnvVar[2] - iTry;
            sVar5 = _abs(iVar7);
            if (pctTerra < sVar5) {
              if (iVar7 < 0) {
                iDelta = iVar7 + pctTerra;
              }
              else {
                iDelta = iVar7 - pctTerra;
              }
            }
            else {
              iDelta = 0;
            }
            rgDelta[2] = iDelta;
            iTry = pplr->rgEnvVar[2] - iDelta;
          }
          pl.rgEnvVar[2] = (char)iTry;
          pctDesire._0_2_ = PctPlanetDesirability((PLANET *)CONCAT22(unaff_SS,&pl),0);
          pctDesire._2_2_ = (int)(uint)pctDesire >> 0xf;
          iVar7 = rgDelta[0] + rgDelta[1] + rgDelta[2];
          if (pctTerra < iVar7) {
            uVar6 = iVar7 - pctTerra;
            bVar10 = (uint)pctDesire < uVar6;
            pctDesire._0_2_ = (uint)pctDesire - uVar6;
            pctDesire._2_2_ = (pctDesire._2_2_ - ((int)uVar6 >> 0xf)) - (uint)bVar10;
            if ((pctDesire._2_2_ < 1) && (pctDesire._2_2_ < 0)) {
              pctDesire._0_2_ = 0;
              pctDesire._2_2_ = 0;
            }
          }
          uVar11 = __aFulmul(CONCAT22(pctDesire._2_2_,(uint)pctDesire),
                                     CONCAT22(pctDesire._2_2_,(uint)pctDesire));
          if (iTerra == 0) {
            uVar11 = __aFulmul(uVar11,7);
          }
          else if (iTerra == 1) {
            uVar11 = __aFulmul(uVar11,5);
          }
          else {
            uVar11 = __aFulmul(uVar11,6);
          }
          l1 = uVar11 + l1;
        }
        if (pplr->rgEnvVar[2] < '\0') {
          __aFulmul(l1,0xb);
        }
        else {
          uVar14 = 0;
          uVar13 = 100;
          uVar11 = __aFulmul(l1,(long)rgInc[2]);
          __aFldiv(uVar11,CONCAT22(uVar14,uVar13));
        }
      }
      if (-1 < pplr->rgEnvVar[1]) {
        in_stack_0000feac = 100;
        in_stack_0000feae = 0;
      }
    }
    if (-1 < pplr->rgEnvVar[0]) {
      in_stack_0000feac = 100;
      in_stack_0000feae = 0;
    }
  }
  if (pplr != (PLAYER *)rgplr) {
    pPVar9 = &plrT;
    pPVar8 = (PLAYER *)rgplr;
    for (iVar7 = 0x60; iVar7 != 0; iVar7 = iVar7 + -1) {
      pPVar2 = pPVar8;
      pPVar8 = (PLAYER *)&pPVar8->cPlanet;
      pPVar1 = pPVar9;
      pPVar9 = (PLAYER *)&pPVar9->cPlanet;
      cVar3 = pPVar1->cShDef;
      pPVar2->iPlayer = pPVar1->iPlayer;
      pPVar2->cShDef = cVar3;
    }
  }
  lVar12 = __ftol((double)CONCAT26(in_stack_0000feae,
                                           CONCAT24(in_stack_0000feac,CONCAT22(unaff_SI,unaff_DI))))
  ;
  return lVar12;
}



// ======================================================================
// Function: InvalidateAdvPtsRect
// Address: 10e0:54d4
// Segment: MEMORY_RACE
// ======================================================================


void InvalidateAdvPtsRect(HWND hwnd)

{
  undefined2 *puVar1;
  HDC HVar2;
  HFONT HVar3;
  HGDIOBJ HVar4;
  undefined2 unaff_SS;
  DWORD DVar5;
  HFONT hfontSav;
  RECT rc;
  short dx;
  HFONT hfont;
  short dyBig;
  LOGFONT *plf;
  TEXTMETRIC tm;
  HDC hdc;
  
  puVar1 = (undefined2 *)LocalAlloc(0x40,0x32);
  HVar2 = GetDC(hwnd);
  *puVar1 = 0xffe8;
  _strcpy((char *)(puVar1 + 9),*(char (*) [32])(rgszArial + 1));
  HVar3 = CreateFontIndirect((undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,puVar1));
  HVar4 = SelectObject(HVar2,HVar3);
  GetTextMetrics(HVar2,(undefined2 *)CONCAT22(unaff_SS,&tm));
  DVar5 = GetTextExtent(HVar2,s__99999_1120_135e,6);
  GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
  rc.left = rc.right - ((int)DVar5 + 8);
  rc.bottom = rc.top + tm.tmHeight + tm.tmExternalLeading + 4;
  SelectObject(HVar2,HVar4);
  DeleteObject(HVar3);
  LocalFree((HLOCAL)puVar1);
  ReleaseDC(hwnd,HVar2);
  InvalidateRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc),1);
  return;
}



// ======================================================================
// Function: DrawRaceAdvantagePoints
// Address: 10e0:55c6
// Segment: MEMORY_RACE
// ======================================================================


void DrawRaceAdvantagePoints(HDC hdc,RECT *prc,PLAYER *pplr)

{
  undefined2 *puVar1;
  HFONT HVar2;
  HGDIOBJ HVar3;
  short sVar4;
  short sVar5;
  uint uVar6;
  short cLen;
  undefined2 unaff_SS;
  DWORD DVar7;
  COLORREF CVar8;
  COLORREF CVar9;
  HFONT hfontSav;
  RECT rc;
  short cch;
  short iPts;
  short dx;
  HFONT hfont;
  COLORREF crSav;
  short c;
  char szAdvantage [32];
  short dyBig;
  short bkMode;
  COLORREF crBkSav;
  LOGFONT *plf;
  TEXTMETRIC tm;
  
  puVar1 = (undefined2 *)LocalAlloc(0x40,0x32);
  *puVar1 = 0xffe8;
  CchGetString(idsArialBold,(char *)(puVar1 + 9));
  HVar2 = CreateFontIndirect((undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,puVar1));
  HVar3 = SelectObject(hdc,HVar2);
  GetTextMetrics(hdc,(undefined2 *)CONCAT22(unaff_SS,&tm));
  DVar7 = GetTextExtent(hdc,s__99999_1120_1365,6);
  rc.top = prc->top;
  rc.right = prc->right;
  rc.left = rc.right - ((int)DVar7 + 8);
  rc.bottom = rc.top + tm.tmHeight + tm.tmExternalLeading + 4;
  if (pplr == (PLAYER *)0x0) {
    pplr = (PLAYER *)&vplr;
  }
  sVar4 = CAdvantagePoints(pplr);
  sVar5 = SetBkMode(hdc,2);
  if (sVar4 < 0) {
    uVar6 = 0x7f;
  }
  else {
    uVar6 = 0;
  }
  CVar8 = SetTextColor(hdc,(ulong)uVar6);
  CVar9 = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  _WSPRINTF((LPSTR)CONCAT22(sVar4,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
  RcCtrTextOut(hdc,&rc,(char *)szWork,-1);
  SetTextColor(hdc,0);
  SelectObject(hdc,rghfontArial8[1]);
  sVar4 = CchGetString(idsPointsLeft,(char *)szWork);
  DVar7 = GetTextExtent(hdc,szWork,sVar4);
  cLen = CchGetString(idsAdvantage,szAdvantage);
  RightTextOut(hdc,rc.left,3,szAdvantage,cLen,0);
  RightTextOut(hdc,rc.left,dyArial8 + 3,(char *)szWork,sVar4,0);
  rc.left = rc.left - ((int)DVar7 + 4);
  PatBlt(hdc,rc.left + -1,0,1,rc.bottom + 1,0x42);
  PatBlt(hdc,rc.left + -4,0,2,rc.bottom + 4,0x42);
  PatBlt(hdc,rc.left,rc.bottom,rc.right - rc.left,1,0x42);
  PatBlt(hdc,rc.left + -2,rc.bottom + 2,(rc.right - rc.left) + 2,2,0x42);
  SetBkColor(hdc,CVar9);
  SetTextColor(hdc,CVar8);
  SetBkMode(hdc,sVar5);
  SelectObject(hdc,HVar3);
  DeleteObject(HVar2);
  LocalFree((HLOCAL)puVar1);
  return;
}



// ======================================================================
// Function: IRaceChecksum
// Address: 10e0:5888
// Segment: MEMORY_RACE
// ======================================================================


ushort IRaceChecksum(PLAYER *pplr)

{
  short cs;
  short i;
  ushort *p;
  ushort ick;
  
  ick = 0;
  for (i = 0; i < 0x60; i = i + 1) {
    ick = ick ^ *(uint *)(pplr->rgEnvVar + i * 2 + -0x10);
  }
  return ick;
}



// ======================================================================
// Function: FSaveRace
// Address: 10e0:58d4
// Segment: MEMORY_RACE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: ofn */

short FSaveRace(char *szFileSuggest,PLAYER *pplr)

{
  int iVar1;
  char *sz;
  short sVar2;
  undefined2 unaff_SS;
  OFN ofn;
  char szFile [256];
  ushort i;
  char szFilter [256];
  char szDirName [256];
  char szFileTitle [256];
  ushort icksum;
  
  if (szFileSuggest == (char *)0x0) {
    szFile[0] = '\0';
  }
  else {
    _strcpy(szFile,szFileSuggest);
  }
  szDirName[0] = '\0';
  CchGetString(idsStarsRaceFilesR,szFilter);
  for (i = 0; szFilter[i] != '\0'; i = i + 1) {
    if (szFilter[i] == '|') {
      szFilter[i] = '\0';
    }
  }
  _memset(&ofn,0,0x48);
  ofn.lStructSize._0_2_ = 0x48;
  ofn.lStructSize._2_2_ = 0;
  ofn.hwndOwner = hwndRaceParent;
  ofn.lpstrFilter._0_2_ = szFilter;
  ofn.nFilterIndex._0_2_ = 1;
  ofn.nFilterIndex._2_2_ = 0;
  ofn.lpstrFile._0_2_ = szFile;
  ofn.nMaxFile._0_2_ = 0x100;
  ofn.nMaxFile._2_2_ = 0;
  ofn.lpstrFileTitle._0_2_ = szFileTitle;
  ofn.nMaxFileTitle._0_2_ = 0x100;
  ofn.nMaxFileTitle._2_2_ = 0;
  ofn.lpstrInitialDir._0_2_ = szDirName;
  ofn.lpstrDefExt._0_2_ = (char *)&DAT_1120_136c;
  ofn.lpstrDefExt._2_2_ = (undefined1 *)&DAT_1120_1120;
  ofn.Flags._0_2_ = 0x8806;
  ofn.Flags._2_2_ = 0;
  iVar1 = GetSaveFileName(0x1118,&ofn);
  if (iVar1 == 0) {
    sVar2 = 0;
  }
  else {
    sVar2 = FCreateFile(dtHist|dtLog,-1,szFile);
    if (sVar2 == 0) {
      sVar2 = 0x10;
      sz = PszFormatIds(idsStarsUnableSaveRaceDataFilePlease,(short *)0x0);
      AlertSz(sz,sVar2);
      sVar2 = 0;
    }
    else {
      WriteRtPlr(pplr,(byte *)0x0);
      icksum = IRaceChecksum(pplr);
      WriteRt(0,2,(ushort *)CONCAT22(unaff_SS,&icksum));
      StreamClose();
      _strcpy((char *)&szRaceFile,szFile + ofn.nFileOffset);
      sVar2 = 1;
    }
  }
  return sVar2;
}



// ======================================================================
// Function: SetRCWTitle
// Address: 10e0:5ab8
// Segment: MEMORY_RACE
// ======================================================================


void SetRCWTitle(HWND hwnd,short iStep)

{
  char *unaff_SS;
  short cch;
  char szBuf [50];
  
  CchGetString(fRCWReadOnly + idsCustomRaceWizardStepD6,szBuf);
  _WSPRINTF((LPSTR)CONCAT22(iStep,unaff_SS),(LPCSTR)CONCAT22(szBuf,(char *)&DAT_1120_1120),
            (char *)szWork);
  SetWindowText(hwnd,szWork);
  return;
}



// ======================================================================
// Function: CreateRandomRace
// Address: 10e0:5b08
// Segment: MEMORY_RACE
// ======================================================================


void CreateRandomRace(PLAYER *pplr)

{
  undefined2 *puVar1;
  PLAYER *pPVar2;
  undefined2 uVar3;
  PLAYER *pPVar4;
  char cVar5;
  short sVar6;
  short sVar7;
  int iVar8;
  char *pcVar9;
  int iVar10;
  RaceGrbit ibit;
  RaceStat iStat;
  undefined2 *puVar11;
  PLAYER *pPVar12;
  PLAYER *pPVar13;
  undefined2 unaff_SS;
  PLAYER plrT_2;
  short k;
  short dAwayCur;
  short dAwayNew;
  short iVal;
  short j;
  short cPass;
  short i;
  short cPts;
  
  pplr->szNames[0] = '\0';
  sVar6 = Random(0x19);
  if (sVar6 < 4) {
    for (i = 0; i < 3; i = i + 1) {
      pplr->rgEnvVarMax[i] = -1;
      pplr->rgEnvVarMin[i] = -1;
      pplr->rgEnvVar[i] = -1;
    }
    sVar6 = Random(4);
    pplr->pctIdealGrowth = (char)sVar6 + '\x02';
  }
  else if (sVar6 < 7) {
    for (i = 0; i < 3; i = i + 1) {
      pplr->rgEnvVar[i] = '2';
      pplr->rgEnvVarMin[i] = '\0';
      pplr->rgEnvVarMax[i] = 'd';
    }
    sVar6 = Random(4);
    pplr->pctIdealGrowth = (char)sVar6 + '\x03';
  }
  else if (sVar6 < 9) {
    for (i = 0; i < 3; i = i + 1) {
      j = Random(2);
      if ((i == 2) &&
         (plrT_2.szNames._30_2_ = SEXT12(pplr->rgEnvVar[0]),
         plrT_2.szNames._30_2_ == (int)pplr->rgEnvVar[1])) {
        j = (short)(pplr->rgEnvVar[0] != '\0');
      }
      if (j == 0) {
        pplr->rgEnvVar[i] = '2';
        pplr->rgEnvVarMin[i] = '\0';
        pplr->rgEnvVarMax[i] = 'd';
      }
      else {
        sVar6 = Random(4);
        pplr->pctIdealGrowth = (char)sVar6 + '\x02';
      }
    }
    sVar6 = Random(5);
    pplr->pctIdealGrowth = (char)sVar6 + '\x02';
  }
  else {
    for (i = 0; i < 3; i = i + 1) {
      sVar7 = Random(0x28);
      iVar8 = sVar7 * 2 + 0x14;
      sVar7 = Random(0x65 - iVar8);
      cVar5 = (char)sVar7;
      pplr->rgEnvVar[i] = (char)(iVar8 / 2) + cVar5;
      pplr->rgEnvVarMin[i] = cVar5;
      pplr->rgEnvVarMax[i] = cVar5 + (char)iVar8;
    }
    if (sVar6 < 0xc) {
      sVar6 = Random(3);
      pplr->rgEnvVarMax[sVar6] = -1;
      pplr->rgEnvVarMin[sVar6] = -1;
      pplr->rgEnvVar[sVar6] = -1;
    }
    else if (sVar6 < 0xe) {
      sVar6 = Random(3);
      pplr->rgEnvVar[sVar6] = '2';
      pplr->rgEnvVarMin[sVar6] = '\0';
      pplr->rgEnvVarMax[sVar6] = 'd';
    }
    else if (sVar6 < 0x11) {
      sVar6 = Random(3);
      sVar7 = Random(0x51);
      cVar5 = (char)sVar7;
      pplr->rgEnvVar[sVar6] = cVar5 + '\n';
      pplr->rgEnvVarMin[sVar6] = cVar5;
      pplr->rgEnvVarMax[sVar6] = cVar5 + '\x14';
    }
    sVar6 = Random(9);
    pplr->pctIdealGrowth = (char)sVar6 + '\a';
  }
  sVar6 = Random(3);
  for (i = 8; i < 0xe; i = i + 1) {
    if (sVar6 == 0) {
      sVar7 = 1;
    }
    else {
      sVar7 = Random(3);
    }
    SetRaceStat(pplr,i,sVar7);
  }
  sVar6 = Random(10);
  SetRaceStat(pplr,rsMajorAdv,sVar6);
  sVar6 = Random(4);
  for (i = 0; i < 0xe; i = i + 1) {
    if (sVar6 == 0) {
      sVar7 = 0;
    }
    else {
      sVar7 = Random(2);
    }
    SetRaceGrbit(pplr,i,sVar7);
  }
  sVar6 = Random(2);
  SetRaceGrbit(pplr,ibitRaceTech3,sVar6);
  sVar6 = Random(2);
  SetRaceGrbit(pplr,ibitRaceCheapFact,sVar6);
  sVar6 = Random(3);
  if (sVar6 == 0) {
    for (i = 0; i < 7; i = i + 1) {
      pplr->rgAttr[i] = *(char *)(i + 0xde0);
    }
    sVar6 = Random(5);
    pplr->rgAttr[7] = (char)sVar6;
  }
  else {
    for (i = 0; i < 8; i = i + 1) {
      plrT_2.szNames._30_2_ = SEXT12(((char *)rgRaceStatMin)[i]);
      plrT_2.szNames._28_2_ =
           Random((((char *)rgRaceStatMax)[i] + 1) - plrT_2.szNames._30_2_);
      pplr->rgAttr[i] = ((char *)rgRaceStatMin)[i] + (char)plrT_2.szNames._28_2_;
    }
  }
  pcVar9 = PszGetCompressedString(idsRandom2);
  sVar6 = _strcmp(pplr->szName,pcVar9);
  if (sVar6 == 0) {
    pcVar9 = pplr->szName;
    sVar6 = Random(0x18);
    CchGetString(sVar6 + idsBerserker,pcVar9);
  }
  sVar6 = CAdvantagePoints(pplr);
  if ((sVar6 < 0) || (0x32 < sVar6)) {
    cPass = 0;
LAB_10e0_6072:
    sVar6 = CAdvantagePoints(pplr);
    if ((-1 < sVar6) && (sVar6 < 0x33)) {
      return;
    }
    iVar8 = cPass + 1;
    if (cPass < 0xfb) {
      sVar7 = Random(10);
      if (-(sVar6 + -0x32) == sVar6 || -sVar6 < sVar6 + -0x32) {
        iVar10 = sVar6 + -0x32;
      }
      else {
        iVar10 = -sVar6;
      }
      cPass = iVar8;
      if (sVar7 < 3) {
        sVar6 = Random(6);
        cVar5 = pplr->rgAttr[sVar6 + 8];
        if ('\0' < cVar5) goto LAB_10e0_6143;
        goto LAB_10e0_61ad;
      }
      if (sVar7 < 6) {
        ibit = Random(0xe);
        sVar6 = GetRaceGrbit(pplr,ibit);
        for (i = 0; i < 2; i = i + 1) {
          SetRaceGrbit(pplr,ibit,i);
          sVar7 = CAdvantagePoints(pplr);
          if (-(sVar7 + -0x32) == sVar7 || -sVar7 < sVar7 + -0x32) {
            iVar8 = sVar7 + -0x32;
          }
          else {
            iVar8 = -sVar7;
          }
          if (iVar8 < iVar10) break;
        }
        if (1 < i) {
          SetRaceGrbit(pplr,ibit,sVar6);
        }
      }
      else {
        if (8 < sVar7) {
          sVar6 = Random(2);
          if (sVar6 == 0) {
            sVar6 = Random(3);
            if (pplr->rgEnvVar[sVar6] < '\0') {
              sVar7 = Random(0x1f);
              cVar5 = (char)sVar7;
              pplr->rgEnvVar[sVar6] = cVar5 + '#';
              pplr->rgEnvVarMin[sVar6] = cVar5;
              pplr->rgEnvVarMax[sVar6] = cVar5 + 'F';
              sVar7 = CAdvantagePoints(pplr);
              if (-(sVar7 + -0x32) == sVar7 || -sVar7 < sVar7 + -0x32) {
                iVar8 = sVar7 + -0x32;
              }
              else {
                iVar8 = -sVar7;
              }
              if (iVar10 <= iVar8) {
                pplr->rgEnvVarMax[sVar6] = -1;
                pplr->rgEnvVarMin[sVar6] = -1;
                pplr->rgEnvVar[sVar6] = -1;
              }
            }
            else {
              pPVar13 = &plrT_2;
              pPVar12 = pplr;
              for (iVar8 = 0x60; iVar8 != 0; iVar8 = iVar8 + -1) {
                pPVar4 = pPVar13;
                pPVar13 = (PLAYER *)&pPVar13->cPlanet;
                pPVar2 = pPVar12;
                pPVar12 = (PLAYER *)&pPVar12->cPlanet;
                cVar5 = pPVar2->cShDef;
                pPVar4->iPlayer = pPVar2->iPlayer;
                pPVar4->cShDef = cVar5;
              }
              pplr->rgEnvVarMax[sVar6] = -1;
              pplr->rgEnvVarMin[sVar6] = -1;
              pplr->rgEnvVar[sVar6] = -1;
              sVar6 = CAdvantagePoints(pplr);
              if (-(sVar6 + -0x32) == sVar6 || -sVar6 < sVar6 + -0x32) {
                iVar8 = sVar6 + -0x32;
              }
              else {
                iVar8 = -sVar6;
              }
              if (iVar10 <= iVar8) {
                pPVar13 = &plrT_2;
                pPVar12 = pplr;
                for (iVar8 = 0x60; iVar8 != 0; iVar8 = iVar8 + -1) {
                  pPVar4 = pPVar12;
                  pPVar12 = (PLAYER *)&pPVar12->cPlanet;
                  pPVar2 = pPVar13;
                  pPVar13 = (PLAYER *)&pPVar13->cPlanet;
                  cVar5 = pPVar2->cShDef;
                  pPVar4->iPlayer = pPVar2->iPlayer;
                  pPVar4->cShDef = cVar5;
                }
              }
            }
            goto LAB_10e0_6072;
          }
          cVar5 = pplr->pctIdealGrowth;
          if ('\x01' < cVar5) {
            pplr->pctIdealGrowth = cVar5 + -1;
            sVar6 = CAdvantagePoints(pplr);
            if (-(sVar6 + -0x32) == sVar6 || -sVar6 < sVar6 + -0x32) {
              iVar8 = sVar6 + -0x32;
            }
            else {
              iVar8 = -sVar6;
            }
            if (iVar8 < iVar10) goto LAB_10e0_6072;
          }
          if (cVar5 < '\x0f') {
            pplr->pctIdealGrowth = cVar5 + '\x01';
            sVar6 = CAdvantagePoints(pplr);
            if (-(sVar6 + -0x32) == sVar6 || -sVar6 < sVar6 + -0x32) {
              iVar8 = sVar6 + -0x32;
            }
            else {
              iVar8 = -sVar6;
            }
            if (iVar8 < iVar10) goto LAB_10e0_6072;
          }
          pplr->pctIdealGrowth = cVar5;
          goto LAB_10e0_6072;
        }
        iStat = Random(7);
        sVar6 = GetRaceStat(pplr,iStat);
        for (i = -1; i < 2; i = i + 2) {
          SetRaceStat(pplr,iStat,sVar6 + i);
          sVar7 = CAdvantagePoints(pplr);
          if (-(sVar7 + -0x32) == sVar7 || -sVar7 < sVar7 + -0x32) {
            iVar8 = sVar7 + -0x32;
          }
          else {
            iVar8 = -sVar7;
          }
          if (iVar8 < iVar10) break;
        }
        if (1 < i) {
          SetRaceStat(pplr,iStat,sVar6);
        }
      }
      goto LAB_10e0_6072;
    }
    pPVar13 = &plrT_2;
    pPVar12 = pplr;
    for (iVar8 = 0x60; iVar8 != 0; iVar8 = iVar8 + -1) {
      pPVar4 = pPVar13;
      pPVar13 = (PLAYER *)&pPVar13->cPlanet;
      pPVar2 = pPVar12;
      pPVar12 = (PLAYER *)&pPVar12->cPlanet;
      cVar5 = pPVar2->cShDef;
      pPVar4->iPlayer = pPVar2->iPlayer;
      pPVar4->cShDef = cVar5;
    }
    puVar11 = (undefined2 *)&vrgplrDef;
    pPVar13 = pplr;
    for (iVar8 = 0x60; iVar8 != 0; iVar8 = iVar8 + -1) {
      pPVar2 = pPVar13;
      pPVar13 = (PLAYER *)&pPVar13->cPlanet;
      puVar1 = puVar11;
      puVar11 = puVar11 + 1;
      uVar3 = *puVar1;
      pPVar2->iPlayer = (char)uVar3;
      pPVar2->cShDef = (char)((uint)uVar3 >> 8);
    }
    _strcpy(pplr->szName,plrT_2.szName);
  }
  return;
LAB_10e0_6143:
  pplr->rgAttr[sVar6 + 8] = pplr->rgAttr[sVar6 + 8] + -1;
  sVar7 = CAdvantagePoints(pplr);
  if (-(sVar7 + -0x32) == sVar7 || -sVar7 < sVar7 + -0x32) {
    iVar8 = sVar7 + -0x32;
  }
  else {
    iVar8 = -sVar7;
  }
  if (iVar10 <= iVar8) {
    pplr->rgAttr[sVar6 + 8] = cVar5;
LAB_10e0_61ad:
    if (cVar5 < '\x02') {
      pplr->rgAttr[sVar6 + 8] = pplr->rgAttr[sVar6 + 8] + '\x01';
      sVar7 = CAdvantagePoints(pplr);
      if (-(sVar7 + -0x32) == sVar7 || -sVar7 < sVar7 + -0x32) {
        iVar8 = sVar7 + -0x32;
      }
      else {
        iVar8 = -sVar7;
      }
      if (iVar10 <= iVar8) {
        pplr->rgAttr[sVar6 + 8] = cVar5;
      }
    }
  }
  goto LAB_10e0_6072;
}



// ======================================================================
// Function: PctTrueMaxGrowth
// Address: 10e0:65d4
// Segment: MEMORY_RACE
// ======================================================================


short PctTrueMaxGrowth(short iplr)

{
  short sVar1;
  
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  if (sVar1 == 0) {
    sVar1 = (int)*(char *)((int)&rgplr[0].pctIdealGrowth + iplr * 0xc0) << 1;
  }
  else {
    sVar1 = (short)*(char *)((int)&rgplr[0].pctIdealGrowth + iplr * 0xc0);
  }
  return sVar1;
}



