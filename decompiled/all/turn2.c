// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
//

// ======================================================================
// Function: Produce
// Address: 10b8:0000
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b80434) */
/* WARNING: Removing unreachable block (ram,0x10b805bf) */
/* WARNING: Removing unreachable block (ram,0x10b80508) */
/* WARNING: Removing unreachable block (ram,0x10b80461) */
/* WARNING: Removing unreachable block (ram,0x10b803e1) */
/* WARNING: Removing unreachable block (ram,0x10b806ca) */
/* WARNING: Removing unreachable block (ram,0x10b803dc) */
/* WARNING: Removing unreachable block (ram,0x10b80ac0) */
/* WARNING: Removing unreachable block (ram,0x10b80759) */
/* WARNING: Removing unreachable block (ram,0x10b807e0) */
/* WARNING: Removing unreachable block (ram,0x10b80414) */
/* WARNING: Removing unreachable block (ram,0x10b8050d) */
/* WARNING: Removing unreachable block (ram,0x10b80439) */
/* WARNING: Removing unreachable block (ram,0x10b80466) */
/* WARNING: Removing unreachable block (ram,0x10b80950) */
/* WARNING: Removing unreachable block (ram,0x10b80496) */
/* WARNING: Removing unreachable block (ram,0x10b80970) */
/* WARNING: Removing unreachable block (ram,0x10b80ac5) */
/* WARNING: Removing unreachable block (ram,0x10b80535) */
/* WARNING: Removing unreachable block (ram,0x10b8053a) */
/* WARNING: Removing unreachable block (ram,0x10b80975) */
/* WARNING: Removing unreachable block (ram,0x10b80821) */
/* WARNING: Removing unreachable block (ram,0x10b80849) */

void Produce(void)

{
    uint      *puVar1;
    int       *piVar2;
    byte      *pbVar3;
    bool       bVar4;
    uint       uVar5;
    int        iVar6;
    PROD      *pPVar7;
    short      sVar8;
    PLANET    *pPVar9;
    int        iVar10;
    PLPROD    *pPVar11;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar12;
    long       lVar13;
    ulong      uVar14;
    ulong      uVar15;
    ulong      uVar16;
    long       lVar17;
    PL        *pPVar18;
    undefined2 uVar19;
    undefined2 uVar20;
    long      *rgMinerals;
    ulong      uVar21;
    PLANET    *pPVar22;
    PLANET    *lpplMac;
    PROD      *lpprod;
    long       lResearchTake;
    short      fAutoBuildDone;
    short      fPrevProdIsAlch;
    PROD       prodPartial;
    short      idm;
    short      i;
    PLANET    *lppl;
    short      fNoResearch;
    short      cBuilt;
    short      mdStatus;
    short      iprodCur;
    long       rgResAvail[4];
    short      cMax;
    long       lResCur;

    /* Segment:    24
       Offset:     000a8b00
       Length:     8cbb
       Min Alloc:  8cbb
       Flags:      1d10
           Code
           Discardable
           Moveable
           LoadOnCall
           Impure (Non-shareable)
        */
    uVar21 = CONCAT22(unaff_SI, unaff_DI);
    MineMinerals();
    uVar16 = CONCAT22(rgResAvail[3]._2_2_, (uint)rgResAvail[3]);
    for (i = 0; i < game.cPlayer; i = i + 1) {
        *(undefined2 *)((int)&rgplr[0].lResLastYear + i * 0xc0) = 0;
        *(undefined2 *)((int)&rgplr[0].lResLastYear + 2 + i * 0xc0) = 0;
    }
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
    pPVar9 = (PLANET *)lpPlanets + cPlanet;
    pPVar22 = (PLANET *)lpPlanets;
    do {
        rgResAvail[3] = uVar16;
        if (pPVar9 <= (PLANET *)lppl) {
            UpdatePopulations();
            UpdateResearchStatus(1);
            if ((game.wCrap >> 7 & 1) == 0) {
                RandomEvents();
            }
            return;
        }
        uVar12 = (undefined2)((ulong)lppl >> 0x10);
        if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) && (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
            if (((PLANET *)lppl)->iPlayer != -1) {
                FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmProductionQueueEmpty, lppl->id, lppl->id, 0);
                uVar5 = CResourcesAtPlanet(lppl, ((PLANET *)lppl)->iPlayer);
                lVar17 = (long)(int)uVar5;
                uVar16 = rgResAvail[3];
                if (uVar5 == 0) {
                    lVar17 = 0;
                } else if (((ushort *)vrgPlanResExtra)[lppl->id] != 0) {
                    iVar6 = ((ushort *)vrgPlanResExtra)[lppl->id] + uVar5;
                    iVar10 = ((int)uVar5 >> 0xf) + (uint)CARRY2(((ushort *)vrgPlanResExtra)[lppl->id], uVar5);
                    uVar16 = __aFulmul((long)(int)uVar5, (ulong)((ushort *)vrgPlanResExtra)[lppl->id]);
                    lVar13 = __aFldiv(uVar16, CONCAT22(iVar10, iVar6));
                    lVar17 = lVar13 + lVar17;
                    uVar16 = rgResAvail[3];
                }
                lResCur._2_2_ = (int)((ulong)lVar17 >> 0x10);
                lResCur._0_2_ = (uint)lVar17;
                iVar6 = ((PLANET *)lppl)->iPlayer * 0xc0;
                puVar1 = (uint *)((int)&rgplr[0].lResLastYear + iVar6);
                uVar5 = *puVar1;
                *puVar1 = *puVar1 + (uint)lResCur;
                piVar2 = (int *)((int)&rgplr[0].lResLastYear + 2 + iVar6);
                *piVar2 = *piVar2 + lResCur._2_2_ + (uint)CARRY2(uVar5, (uint)lResCur);
            }
        } else if ((((PLANET *)lppl)->iPlayer != -1) && (((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac != 0)) {
            uVar14 = __aFulshr(uVar21, (ushort)pPVar22);
            for (i = 0; i < 3; i = i + 1) {
                uVar19 = *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                *(int *)(rgResAvail + i) = (int)((PLANET *)lppl)->rgwtMin[i];
                *(undefined2 *)((int)rgResAvail + i * 4 + 2) = uVar19;
            }
            uVar5 = CResourcesAtPlanet(lppl, ((PLANET *)lppl)->iPlayer);
            uVar16 = (ulong)(int)uVar5;
            if (uVar5 == 0) {
                uVar16 = 0;
            } else if (((ushort *)vrgPlanResExtra)[lppl->id] != 0) {
                iVar6 = ((ushort *)vrgPlanResExtra)[lppl->id] + uVar5;
                iVar10 = ((int)uVar5 >> 0xf) + (uint)CARRY2(((ushort *)vrgPlanResExtra)[lppl->id], uVar5);
                uVar15 = __aFulmul((long)(int)uVar5, (ulong)((ushort *)vrgPlanResExtra)[lppl->id]);
                lVar17 = __aFldiv(uVar15, CONCAT22(iVar10, iVar6));
                uVar16 = lVar17 + uVar16;
            }
            rgResAvail[3] = uVar16;
            if ((*(uint *)((int)&rgplr[0].wFlags + ((PLANET *)lppl)->iPlayer * 0xc0) >> 2 & 1) != 0) {
                uVar20 = 0;
                uVar19 = 5;
                lVar17 = __aFlshl(5, (ushort)uVar21);
                uVar16 = __aFldiv(lVar17, CONCAT22(uVar20, uVar19));
                rgResAvail[3] = uVar16;
            }
            if (uVar16 != 0) {
                if ((uVar14 & 1) == 0) {
                    uVar20 = 0;
                    uVar19 = 100;
                    rgResAvail[3] = uVar16;
                    uVar16 = __aFulmul(uVar16, (long)(int)*(char *)((int)&rgplr[0].pctResearch + ((PLANET *)lppl)->iPlayer * 0xc0));
                    lVar17 = __aFldiv(uVar16, CONCAT22(uVar20, uVar19));
                    uVar16 = rgResAvail[3] - lVar17;
                    rgResAvail[3] = uVar16;
                    iVar6 = ((PLANET *)lppl)->iPlayer * 0xc0;
                    puVar1 = (uint *)((int)&rgplr[0].lResLastYear + iVar6);
                    uVar5 = *puVar1;
                    *puVar1 = *puVar1 + (uint)lVar17;
                    piVar2 = (int *)((int)&rgplr[0].lResLastYear + 2 + iVar6);
                    *piVar2 = *piVar2 + (int)((ulong)lVar17 >> 0x10) + (uint)CARRY2(uVar5, (uint)lVar17);
                }
                bVar4 = true;
            TURN2_TopOfQueue:
                fPrevProdIsAlch = 0;
                iprodCur = 0;
                rgResAvail[3] = uVar16;
            LAB_10b8_037b:
                do {
                    uVar16 = rgResAvail[3];
                    if (((*(int *)&((PLANET *)lppl)->lpplprod == 0) && (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) ||
                        ((int)(uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac <= iprodCur)) {
                    LAB_10b8_0b9a:
                        if (((*(int *)&((PLANET *)lppl)->lpplprod == 0) && (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) ||
                            (((int)(uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac <= iprodCur && (bVar4)))) {
                            rgResAvail[3] = uVar16;
                            FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmHasCompletedOrdersProductionQueueEmpty, lppl->id, lppl->id, 0);
                            uVar16 = rgResAvail[3];
                        }
                        rgResAvail[3]._2_2_ = (int)(uVar16 >> 0x10);
                        rgResAvail[3]._0_2_ = (uint)uVar16;
                        for (i = 0; i < 3; i = i + 1) {
                            uVar19 = *(undefined2 *)((int)rgResAvail + i * 4 + 2);
                            *(int *)(((PLANET *)lppl)->rgwtMin + i) = (int)rgResAvail[i];
                            *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = uVar19;
                        }
                        iVar6 = ((PLANET *)lppl)->iPlayer * 0xc0;
                        puVar1 = (uint *)((int)&rgplr[0].lResLastYear + iVar6);
                        uVar5 = *puVar1;
                        *puVar1 = *puVar1 + (uint)rgResAvail[3];
                        piVar2 = (int *)((int)&rgplr[0].lResLastYear + 2 + iVar6);
                        *piVar2 = *piVar2 + rgResAvail[3]._2_2_ + (uint)CARRY2(uVar5, (uint)rgResAvail[3]);
                        break;
                    }
                    uVar19 = *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2);
                    pPVar7 = (PROD *)(*(int *)&((PLANET *)lppl)->lpplprod + 4 + iprodCur * 4);
                    lpprod = (PROD *)CONCAT22(uVar19, pPVar7);
                    if ((lpprod->dwFlags & 0x3ff) == 0) {
                    TURN2_RemoveFromQueue:
                        if ((uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac == fPrevProdIsAlch + 1U) {
                            FreePl((PL *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2), *(PL **)&((PLANET *)lppl)->lpplprod));
                            *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
                            *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
                            uVar16 = rgResAvail[3];
                            goto LAB_10b8_0b9a;
                        }
                        if (iprodCur < (int)(((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac - 1)) {
                            __fmemmove((void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                                        (void *)(*(int *)&((PLANET *)lppl)->lpplprod + 4 + (iprodCur - fPrevProdIsAlch) * 4)),
                                       (void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                                        (void *)(*(int *)&((PLANET *)lppl)->lpplprod + 4 + (iprodCur + 1) * 4)),
                                       (((uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac - iprodCur) + -1) * 4);
                        }
                        pbVar3 = &((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac;
                        *pbVar3 = *pbVar3 - ((char)fPrevProdIsAlch + '\x01');
                        iprodCur = iprodCur - (fPrevProdIsAlch + 1);
                    LAB_10b8_0b8e:
                        iprodCur = iprodCur + 1;
                        fPrevProdIsAlch = 0;
                        goto LAB_10b8_037b;
                    }
                    uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                    if (((uint)uVar16 & 7) == 1) {
                        uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                        if (((uint)uVar16 & 0x7f) < 0x12) {
                        LAB_10b8_0471:
                            uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                            if (((uint)uVar16 & 0x7f) != 0x1b) {
                                uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                                if (0xd < ((uint)uVar16 & 0x7f)) {
                                    uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                                    if (((uint)uVar16 & 0x7f) < 0x12) {
                                        sVar8 = IWarpMAFromLppl(lppl, 0);
                                        if ((sVar8 == 0) || ((*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0x3ff) == 0)) {
                                            FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmHasOrdersBuildMineralPacketEitherDoesnt, lppl->id, lppl->id, 0);
                                            goto TURN2_RemoveFromQueue;
                                        }
                                        goto LAB_10b8_07fc;
                                    }
                                }
                                uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                                if (((uint)uVar16 & 0x7f) == 7) {
                                    sVar8 = CMaxFactories(lppl, ((PLANET *)lppl)->iPlayer);
                                    cMax = CMaxOperableFactories(lppl, ((PLANET *)lppl)->iPlayer, 1);
                                    if (cMax <= sVar8) {
                                        cMax = sVar8;
                                    }
                                    uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                                    cMax = cMax - ((uint)uVar16 & 0xfff);
                                TURN2_LCantBuildP:
                                    idm = 0x12a;
                                } else {
                                    uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                                    if (((uint)uVar16 & 0x7f) == 8) {
                                        sVar8 = CMaxMines(lppl, ((PLANET *)lppl)->iPlayer);
                                        cMax = CMaxOperableMines(lppl, ((PLANET *)lppl)->iPlayer, 1);
                                        if (cMax <= sVar8) {
                                            cMax = sVar8;
                                        }
                                        uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                                        cMax = cMax - ((uint)uVar16 & 0xfff);
                                        goto TURN2_LCantBuildP;
                                    }
                                    uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                                    if (((uint)uVar16 & 0x7f) == 9) {
                                        sVar8 = CMaxDefenses(lppl, ((PLANET *)lppl)->iPlayer);
                                        cMax = CMaxOperableDefenses(lppl, ((PLANET *)lppl)->iPlayer, 1);
                                        if (cMax <= sVar8) {
                                            cMax = sVar8;
                                        }
                                        cMax = cMax - (*(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff);
                                        goto TURN2_LCantBuildP;
                                    }
                                    uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                                    if (((uint)uVar16 & 0x7f) != 0xc)
                                        goto LAB_10b8_07fc;
                                    cMax = IpctCanTerraformLppl(lppl);
                                    idm = 0x12f;
                                }
                                if (cMax < (int)((uint)lpprod->dwFlags & 0x3ff)) {
                                    FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idm, lppl->id, lppl->id, 0);
                                    if (cMax < 1)
                                        goto TURN2_RemoveFromQueue;
                                    lVar17 = __aFlshl(uVar21, (ushort)pPVar22);
                                    uVar5 = *(uint *)((int)&pPVar7->dwFlags + 2);
                                    *&lpprod->dwFlags = (uint)lpprod->dwFlags & 0xfc00 | (uint)lVar17;
                                    *(uint *)((int)&pPVar7->dwFlags + 2) = uVar5 | (uint)((ulong)lVar17 >> 0x10);
                                }
                                goto LAB_10b8_07fc;
                            }
                        } else {
                            uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                            if (0x1a < ((uint)uVar16 & 0x7f))
                                goto LAB_10b8_0471;
                        }
                        uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                        if (((uint)uVar16 & 0x1f) != 0x1f) {
                            FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmOrderBuildScannerCanceledAlreadyHaveScanner, lppl->id, lppl->id, 0);
                            goto TURN2_RemoveFromQueue;
                        }
                    }
                LAB_10b8_07fc:
                    uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                    if (((uint)uVar16 & 0x7f) != 3) {
                    LAB_10b8_0871:
                        prodPartial.dwFlags._0_2_ = (uint)prodPartial.dwFlags & 0xfc00;
                        sVar8 = CBuildProdItem(lppl, (PROD *)CONCAT22(uVar19, pPVar7), &prodPartial, rgResAvail, fPrevProdIsAlch, &mdStatus, 0);
                        if ((bVar4) && ((mdStatus == 3 || (mdStatus == 4)))) {
                            bVar4 = false;
                        }
                        uVar16 = rgResAvail[3];
                        if (0 < sVar8) {
                            rgMinerals = rgResAvail;
                            uVar16 = __aFulshr(CONCAT22(rgMinerals, sVar8), (ushort)uVar21);
                            uVar5 = (uint)uVar16 & 0x7f;
                            uVar16 = __aFulshr(CONCAT22(sVar8, (uint)uVar16) & 0xffff007f, (ushort)rgMinerals);
                            sVar8 = FBuildObject(lppl, (GrobjClass)uVar16 & (grobjOther | grobjFleet | grobjPlanet), uVar5, sVar8, rgMinerals);
                            uVar16 = rgResAvail[3];
                            if (sVar8 == 0) {
                                uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                                if (((uint)uVar16 & 7) == 1) {
                                    uVar14 = __aFulshr(uVar21, (ushort)pPVar22);
                                    uVar16 = rgResAvail[3];
                                    if (((uint)uVar14 & 0x7f) < 7)
                                        goto LAB_10b8_09a0;
                                }
                                uVar20 = *(undefined2 *)((int)&pPVar7->dwFlags + 2);
                                *&lpprod->dwFlags = (uint)lpprod->dwFlags & 0xfc00;
                                *(undefined2 *)((int)&pPVar7->dwFlags + 2) = uVar20;
                                uVar16 = rgResAvail[3];
                            }
                        }
                    LAB_10b8_09a0:
                        if (((((PLANET *)lppl)->iPlayer != -1) || (*(int *)&((PLANET *)lppl)->lpplprod != 0)) ||
                            (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) {
                            rgResAvail[3] = uVar16;
                            if (mdStatus == 0)
                                goto TURN2_RemoveFromQueue;
                            if (4 < mdStatus) {
                                if (((uint)prodPartial.dwFlags & 0x3ff) != 0) {
                                    if (((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac == ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMax) {
                                        pPVar18 = LpplReAlloc(
                                            (PL *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2), *(PL **)&((PLANET *)lppl)->lpplprod),
                                            ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac + 1);
                                        *(PL **)&((PLANET *)lppl)->lpplprod = (PL *)pPVar18;
                                        *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = (int)((ulong)pPVar18 >> 0x10);
                                        uVar16 = rgResAvail[3];
                                    }
                                    rgResAvail[3] = uVar16;
                                    __fmemmove((void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                                                (void *)(*(int *)&((PLANET *)lppl)->lpplprod + 8)),
                                               (void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                                                (void *)(*(int *)&((PLANET *)lppl)->lpplprod + 4)),
                                               (uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac << 2);
                                    uVar19 = (undefined2)((ulong)((PLANET *)lppl)->lpplprod >> 0x10);
                                    pPVar11 = (PLPROD *)((PLANET *)lppl)->lpplprod;
                                    (pPVar11 + 1)->wFlags = (uint)prodPartial.dwFlags;
                                    *(undefined2 *)&pPVar11[1].iprodMax = prodPartial.dwFlags._2_2_;
                                    pbVar3 = &((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac;
                                    *pbVar3 = *pbVar3 + 1;
                                    uVar16 = rgResAvail[3];
                                }
                                goto LAB_10b8_0b9a;
                            }
                            goto LAB_10b8_0b8e;
                        }
                        goto TURN2_TopOfQueue;
                    }
                    uVar16 = __aFulshr(uVar21, (ushort)pPVar22);
                    if ((((uint)uVar16 & 7) != 1) || ((int)(((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac - 1) <= iprodCur))
                        goto LAB_10b8_0871;
                    fPrevProdIsAlch = 1;
                    iprodCur = iprodCur + 1;
                } while (true);
            }
        }
        lppl = (PLANET *)CONCAT22(uVar12, (PLANET *)lppl + 1);
    } while (true);
}

// ======================================================================
// Function: CBuildProdItem
// Address: 10b8:0c92
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b81941) */
/* WARNING: Removing unreachable block (ram,0x10b818bd) */
/* WARNING: Removing unreachable block (ram,0x10b8173c) */
/* WARNING: Removing unreachable block (ram,0x10b810a5) */
/* WARNING: Removing unreachable block (ram,0x10b80e9c) */
/* WARNING: Removing unreachable block (ram,0x10b80ec3) */
/* WARNING: Removing unreachable block (ram,0x10b80d33) */
/* WARNING: Removing unreachable block (ram,0x10b80d38) */
/* WARNING: Removing unreachable block (ram,0x10b80d17) */
/* WARNING: Removing unreachable block (ram,0x10b80ffd) */
/* WARNING: Removing unreachable block (ram,0x10b810a0) */
/* WARNING: Removing unreachable block (ram,0x10b81784) */
/* WARNING: Removing unreachable block (ram,0x10b81849) */
/* WARNING: Removing unreachable block (ram,0x10b8193c) */
/* WARNING: Removing unreachable block (ram,0x10b81920) */
/* WARNING: Variable defined which should be unmapped: AddCost */
/* WARNING: Removing unreachable block (ram,0x10b80fcd) */
/* WARNING: Removing unreachable block (ram,0x10b81890) */
/* WARNING: Removing unreachable block (ram,0x10b81443) */
/* WARNING: Removing unreachable block (ram,0x10b8124d) */
/* WARNING: Removing unreachable block (ram,0x10b81465) */
/* WARNING: Removing unreachable block (ram,0x10b81283) */
/* WARNING: Removing unreachable block (ram,0x10b815db) */

short CBuildProdItem(PLANET *lppl, PROD *lpprod, PROD *pprodPartial, long *rgRes, short fAlchemy, short *pmdStatus, short fCalcOnly)

{
    int       *piVar1;
    uint      *puVar2;
    uint       uVar3;
    int        iVar4;
    bool       bVar5;
    bool       bVar6;
    uint       uVar7;
    uint       uVar8;
    uint       uVar9;
    short      sVar10;
    int        iVar11;
    PLANET    *pPVar12;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar13;
    undefined2 uVar14;
    ulong      uVar15;
    ulong      uVar16;
    ulong      uVar17;
    ulong      uVar18;
    long       lVar19;
    undefined2 uVar20;
    undefined2 uVar21;
    ulong      uVar22;
    long       AddCost;
    short      fMineralBlocked;
    long       rgCost[4];
    long       pct;
    long       pctTooBig;
    long       pctInitial;
    short      fResourceBlocked;
    short      i;
    long       rgCostPaid[4];
    short      cAlchemy;
    short      cBuilt;
    short      fAutoBuild;
    PROD       prod;
    long       lAlchCost;
    long       lMinNeeded;
    long       cCanBuild;
    ulong      iobjOther;
    short      cMax;
    long       pctT;

    uVar22 = CONCAT22(unaff_SI, unaff_DI);
    cAlchemy = 0;
    uVar15 = __aFulshr(uVar22, (uint)AddCost);
    uVar13 = (undefined2)((ulong)lpprod >> 0x10);
    prod.dwFlags._0_2_ = (uint)lpprod->dwFlags;
    prod.dwFlags._2_2_ = *(uint *)((int)&((PROD *)lpprod)->dwFlags + 2);
    uVar14 = (undefined2)((ulong)lppl >> 0x10);
    pPVar12 = (PLANET *)lppl;
    GetProductionCosts(lppl, lpprod, rgCost, pPVar12->iPlayer, 1);
    cBuilt = 0;
    uVar16 = __aFulshr(uVar22, (uint)AddCost);
    if ((((uint)uVar16 & 7) == 1) && (uVar16 = __aFulshr(uVar22, (uint)AddCost), ((uint)uVar16 & 0x7f) < 7)) {
        fAutoBuild = 1;
    } else {
        fAutoBuild = 0;
    }
    if (fAutoBuild != 0) {
        cMax = 1000;
        uVar16 = __aFulshr(uVar22, (uint)AddCost);
        uVar8 = (uint)uVar16 & 0x7f;
        if ((uVar16 & 0x7f) == 0) {
            uVar16 = __aFulshr(uVar22, (uint)AddCost);
            sVar10 = CMaxOperableMines(lppl, pPVar12->iPlayer, 1);
            cMax = sVar10 - ((uint)uVar16 & 0xfff);
        } else if (uVar8 == 1) {
            uVar16 = __aFulshr(uVar22, (uint)AddCost);
            sVar10 = CMaxOperableFactories(lppl, pPVar12->iPlayer, 1);
            cMax = sVar10 - ((uint)uVar16 & 0xfff);
        } else if (uVar8 == 2) {
            uVar8 = *(uint *)(pPVar12->rgbImp + 4);
            sVar10 = CMaxOperableDefenses(lppl, pPVar12->iPlayer, 1);
            cMax = sVar10 - (uVar8 & 0xfff);
        } else if (uVar8 != 3) {
            if ((uVar8 == 4) || (uVar8 == 5)) {
                cMax = IpctCanTerraformLppl(lppl);
                if ((0 < cMax) &&
                    (((uVar16 = __aFulshr(uVar22, (uint)AddCost), ((uint)uVar16 & 0x7f) == 4 && (lVar19 = ChgPopFromPlanet(lppl, 0), -1 < lVar19)) &&
                      (sVar10 = PctPlanetDesirability(lppl, pPVar12->iPlayer), 0 < sVar10)))) {
                    cMax = 0;
                }
            } else if ((uVar8 == 6) && ((sVar10 = IWarpMAFromLppl(lppl, 0), sVar10 == 0 || ((*(uint *)((int)&pPVar12->lStarbase + 2) & 0x3ff) == 0)))) {
                cMax = 0;
            }
        }
        if (cMax < 0) {
            cMax = 0;
        }
        AddCost._0_2_ = (uint)prod.dwFlags & 0x3ff;
        if (((-1 < cMax) && ((uint)cMax < (uint)AddCost)) || (uVar16 = __aFulshr(uVar22, (uint)AddCost), ((uint)uVar16 & 0x7f) == 3)) {
            lVar19 = __aFlshl(uVar22, (uint)AddCost);
            prod.dwFlags._0_2_ = (uint)prod.dwFlags & 0xfc00 | (uint)lVar19;
            prod.dwFlags._2_2_ = prod.dwFlags._2_2_ | (uint)((ulong)lVar19 >> 0x10);
        }
    }
    for (i = 0; i < 4; i = i + 1) {
        uVar21 = 0;
        uVar20 = 100;
        uVar16 = __aFulshr(100, (ushort)uVar22);
        uVar16 = __aFulmul(CONCAT22(*(undefined2 *)((int)rgCost + i * 4 + 2), (int)rgCost[i]), (ulong)((uint)uVar16 & 0x7f));
        uVar16 = __aFuldiv(uVar16, CONCAT22(uVar21, uVar20));
        *(int *)(rgCostPaid + i) = (int)uVar16;
        *(undefined2 *)((int)rgCostPaid + i * 4 + 2) = (int)(uVar16 >> 0x10);
    }
LAB_10b8_108f:
    do {
        if (((uint)prod.dwFlags & 0x3ff) == 0)
            goto LAB_10b8_1712;
        for (i = 0; i < 4; i = i + 1) {
            iVar11 = (*(int *)((int)rgCost + i * 4 + 2) - *(int *)((int)rgCostPaid + i * 4 + 2)) - (uint)(*(uint *)(rgCost + i) < *(uint *)(rgCostPaid + i));
            uVar8 = *(uint *)((int)(rgRes + i) + 2);
            if (((int)uVar8 <= iVar11) && (((int)uVar8 < iVar11 || (*(uint *)(rgRes + i) < *(uint *)(rgCost + i) - *(uint *)(rgCostPaid + i)))))
                break;
        }
        if (3 < i) {
            cBuilt = cBuilt + 1;
            AddCost._0_2_ = (uint)prod.dwFlags - 1 & 0x3ff;
            prod.dwFlags._0_2_ = (uint)prod.dwFlags & 0xfc00 | (uint)AddCost;
            prod.dwFlags._2_2_ = prod.dwFlags._2_2_ & 0xf80f;
            for (i = 0; i < 4; i = i + 1) {
                uVar7 = *(uint *)(rgCost + i);
                iVar11 = *(int *)((int)rgCost + i * 4 + 2);
                uVar3 = *(uint *)(rgCostPaid + i);
                uVar9 = uVar7 - *(uint *)(rgCostPaid + i);
                iVar4 = *(int *)((int)rgCostPaid + i * 4 + 2);
                puVar2 = (uint *)(rgRes + i);
                uVar8 = *puVar2;
                *puVar2 = *puVar2 - uVar9;
                puVar2 = (uint *)((int)(rgRes + i) + 2);
                *puVar2 = (*puVar2 - ((iVar11 - iVar4) - (uint)(uVar7 < uVar3))) - (uint)(uVar8 < uVar9);
                *(undefined2 *)(rgCostPaid + i) = 0;
                *(undefined2 *)((int)rgCostPaid + i * 4 + 2) = 0;
            }
            goto LAB_10b8_108f;
        }
        bVar5 = false;
        bVar6 = false;
        uVar16 = 100;
        for (i = 0; i < 4; i = i + 1) {
            iVar11 = *(int *)((int)rgCost + i * 4 + 2);
            if ((-1 < iVar11) && ((0 < iVar11 || ((int)rgCost[i] != 0)))) {
                iVar11 = *(int *)((int)rgCost + i * 4 + 2);
                uVar8 = *(uint *)((int)(rgRes + i) + 2);
                if (((int)uVar8 < iVar11) || (((int)uVar8 <= iVar11 && (*(uint *)(rgRes + i) < *(uint *)(rgCost + i))))) {
                    uVar20 = *(undefined2 *)((int)rgCost + i * 4 + 2);
                    uVar21 = (undefined2)rgCost[i];
                    uVar8 = *(uint *)(rgRes + i);
                    uVar17 = __aFulmul(
                        CONCAT22(*(uint *)((int)(rgRes + i) + 2) + *(int *)((int)rgCostPaid + i * 4 + 2) + (uint)CARRY2(uVar8, *(uint *)(rgCostPaid + i)),
                                 uVar8 + *(uint *)(rgCostPaid + i)),
                        100);
                    uVar17 = __aFldiv(uVar17, CONCAT22(uVar20, uVar21));
                    uVar20 = *(undefined2 *)((int)rgCost + i * 4 + 2);
                    uVar21 = (undefined2)rgCost[i];
                    uVar8 = *(uint *)(rgRes + i);
                    uVar7 = uVar8 + *(uint *)(rgCostPaid + i);
                    uVar18 = __aFulmul(CONCAT22(*(uint *)((int)(rgRes + i) + 2) + *(int *)((int)rgCostPaid + i * 4 + 2) +
                                                    (uint)CARRY2(uVar8, *(uint *)(rgCostPaid + i)) + (uint)(0xfffe < uVar7),
                                                uVar7 + 1),
                                       100);
                    lVar19 = __aFldiv(uVar18, CONCAT22(uVar20, uVar21));
                    if ((long)uVar17 <= lVar19 + -1) {
                        uVar17 = lVar19 - 1;
                    }
                } else {
                    uVar17 = 100;
                }
                if ((long)uVar17 < (long)uVar16) {
                    uVar8 = *(uint *)(rgCost + i) - *(uint *)(rgCostPaid + i);
                    puVar2 = (uint *)(rgRes + i);
                    lMinNeeded._0_2_ = uVar8 - *puVar2;
                    lMinNeeded._2_2_ = (((*(int *)((int)rgCost + i * 4 + 2) - *(int *)((int)rgCostPaid + i * 4 + 2)) -
                                         (uint)(*(uint *)(rgCost + i) < *(uint *)(rgCostPaid + i))) -
                                        *(uint *)((int)(rgRes + i) + 2)) -
                                       (uint)(uVar8 < *puVar2);
                    uVar16 = uVar17;
                    if (i == 3) {
                        bVar6 = true;
                    } else {
                        bVar5 = true;
                    }
                }
            }
        }
        if ((bVar5) && (fAutoBuild != 0)) {
            if (fAlchemy == 0) {
                fAutoBuild = 2;
                goto LAB_10b8_1712;
            }
        } else {
            for (i = 0; i < 4; i = i + 1) {
                uVar21 = 0;
                uVar20 = 100;
                uVar17 = __aFulmul(CONCAT22(*(undefined2 *)((int)rgCost + i * 4 + 2), (int)rgCost[i]), uVar16);
                lVar19 = __aFldiv(uVar17, CONCAT22(uVar21, uVar20));
                AddCost._0_2_ = (uint)lVar19 - *(uint *)(rgCostPaid + i);
                iVar11 = ((int)((ulong)lVar19 >> 0x10) - *(int *)((int)rgCostPaid + i * 4 + 2)) - (uint)((uint)lVar19 < *(uint *)(rgCostPaid + i));
                puVar2 = (uint *)(rgRes + i);
                uVar8 = *puVar2;
                *puVar2 = *puVar2 - (uint)AddCost;
                puVar2 = (uint *)((int)(rgRes + i) + 2);
                *puVar2 = (*puVar2 - iVar11) - (uint)(uVar8 < (uint)AddCost);
                puVar2 = (uint *)(rgCostPaid + i);
                uVar8 = *puVar2;
                *puVar2 = *puVar2 + (uint)AddCost;
                piVar1 = (int *)((int)rgCostPaid + i * 4 + 2);
                *piVar1 = *piVar1 + iVar11 + (uint)CARRY2(uVar8, (uint)AddCost);
            }
            lVar19 = __aFlshl(uVar22, (uint)AddCost);
            prod.dwFlags._0_2_ = (uint)prod.dwFlags | (uint)lVar19;
            prod.dwFlags._2_2_ = prod.dwFlags._2_2_ & 0xf80f | (uint)((ulong)lVar19 >> 0x10);
            if ((fAlchemy == 0) || (bVar6))
                goto LAB_10b8_1712;
        }
        sVar10 = GetRaceGrbit((PLAYER *)rgplr + pPVar12->iPlayer, ibitRaceMineralAlchemy);
        if (sVar10 == 0) {
            uVar8 = 100;
        } else {
            uVar8 = 0x19;
        }
        uVar16 = __aFldiv(CONCAT22(*(undefined2 *)((int)rgRes + 0xe), (int)rgRes[3]), (ulong)uVar8);
        if ((long)CONCAT22(lMinNeeded._2_2_, (int)lMinNeeded) < (long)uVar16) {
            uVar16 = CONCAT22(lMinNeeded._2_2_, (int)lMinNeeded);
        }
        cCanBuild._2_2_ = (int)(uVar16 >> 0x10);
        cCanBuild._0_2_ = (uint)uVar16;
        if (0 < (long)uVar16) {
            for (i = 0; i < 3; i = i + 1) {
                puVar2 = (uint *)(rgRes + i);
                uVar7 = *puVar2;
                *puVar2 = *puVar2 + (uint)cCanBuild;
                puVar2 = (uint *)((int)(rgRes + i) + 2);
                *puVar2 = *puVar2 + cCanBuild._2_2_ + (uint)CARRY2(uVar7, (uint)cCanBuild);
            }
            uVar17 = __aFulmul((ulong)uVar8, uVar16);
            puVar2 = (uint *)(rgRes + i);
            uVar7 = *puVar2;
            *puVar2 = *puVar2 - (uint)uVar17;
            puVar2 = (uint *)((int)(rgRes + i) + 2);
            *puVar2 = (*puVar2 - (int)(uVar17 >> 0x10)) - (uint)(uVar7 < (uint)uVar17);
            cAlchemy = cAlchemy + (uint)cCanBuild;
        }
        if (uVar16 != CONCAT22(lMinNeeded._2_2_, (int)lMinNeeded)) {
            if ((-1 < *(int *)((int)rgRes + 0xe)) && (((0 < *(int *)((int)rgRes + 0xe) || ((int)rgRes[3] != 0)) && (pprodPartial != 0)))) {
                _memset(pprodPartial, 0, 4);
                uVar7 = *(uint *)((int)&pprodPartial->dwFlags + 2);
                *&pprodPartial->dwFlags = (int)pprodPartial->dwFlags;
                *(uint *)((int)&pprodPartial->dwFlags + 2) = uVar7 & 0xfff1 | 2;
                uVar7 = *(uint *)((int)&pprodPartial->dwFlags + 2);
                *&pprodPartial->dwFlags = (uint)pprodPartial->dwFlags & 0x3ff | 0x2c00;
                *(uint *)((int)&pprodPartial->dwFlags + 2) = uVar7 & 0xfffe;
                uVar20 = *(undefined2 *)((int)&pprodPartial->dwFlags + 2);
                *&pprodPartial->dwFlags = (uint)pprodPartial->dwFlags & 0xfc00 | 1;
                *(undefined2 *)((int)&pprodPartial->dwFlags + 2) = uVar20;
                uVar20 = 0;
                uVar7 = uVar8;
                uVar16 = __aFulmul(CONCAT22(*(undefined2 *)((int)rgRes + 0xe), (int)rgRes[3]), 100);
                uVar16 = __aFldiv(uVar16, CONCAT22(uVar20, uVar7));
                uVar20 = 0;
                uVar7 = uVar8;
                uVar17 = __aFulmul(CONCAT22(*(int *)((int)rgRes + 0xe) + (uint)(0xfffe < *(uint *)(rgRes + 3)), *(uint *)(rgRes + 3) + 1), 100);
                lVar19 = __aFldiv(uVar17, CONCAT22(uVar20, uVar7));
                if ((long)uVar16 <= lVar19 + -1) {
                    uVar16 = lVar19 - 1;
                }
                lVar19 = __aFlshl(uVar22, (uint)AddCost);
                uVar7 = *(uint *)((int)&pprodPartial->dwFlags + 2);
                *&pprodPartial->dwFlags = (uint)pprodPartial->dwFlags | (uint)lVar19;
                *(uint *)((int)&pprodPartial->dwFlags + 2) = uVar7 & 0xf80f | (uint)((ulong)lVar19 >> 0x10);
                uVar21 = 0;
                uVar20 = 100;
                uVar16 = __aFulmul(uVar16, (ulong)uVar8);
                lVar19 = __aFldiv(uVar16, CONCAT22(uVar21, uVar20));
                puVar2 = (uint *)(rgRes + 3);
                uVar8 = *puVar2;
                *puVar2 = *puVar2 - (uint)lVar19;
                *(int *)((int)rgRes + 0xe) = (*(int *)((int)rgRes + 0xe) - (int)((ulong)lVar19 >> 0x10)) - (uint)(uVar8 < (uint)lVar19);
            }
        LAB_10b8_1712:
            if (((0 < cBuilt) && (uVar16 = __aFulshr(uVar22, (uint)AddCost), ((uint)uVar16 & 7) == 1)) &&
                ((uVar16 = __aFulshr(uVar22, (uint)AddCost),
                  ((uint)uVar16 & 0x7f) == 0xb || (uVar16 = __aFulshr(uVar22, (uint)AddCost), ((uint)uVar16 & 0x7f) == 3)))) {
                cAlchemy = cAlchemy + cBuilt;
                for (i = 0; i < 3; i = i + 1) {
                    puVar2 = (uint *)(rgRes + i);
                    uVar8 = *puVar2;
                    *puVar2 = *puVar2 + cBuilt;
                    puVar2 = (uint *)((int)(rgRes + i) + 2);
                    *puVar2 = *puVar2 + (cBuilt >> 0xf) + (uint)CARRY2(uVar8, cBuilt);
                }
            }
            if (((cAlchemy != 0) && (fCalcOnly == 0)) && (((uint)gd.grBits >> 1 & 1) != 0)) {
                FSendPlrMsg2(pPVar12->iPlayer, idmScientistsHaveTransmutedCommonMaterialsKtEach, lppl->id, lppl->id, cAlchemy);
            }
            if (pmdStatus != 0) {
                if (fAutoBuild == 2) {
                    if (cBuilt < 1) {
                        sVar10 = 4;
                    } else {
                        sVar10 = 3;
                    }
                    *pmdStatus = sVar10;
                } else if ((fAutoBuild == 0) || (((uint)prod.dwFlags & 0x3ff) != 0)) {
                    if (cBuilt == 0) {
                        uVar16 = __aFulshr(uVar22, (uint)AddCost);
                        if (((uint)uVar15 & 0x7f) == ((uint)uVar16 & 0x7f)) {
                            sVar10 = 7;
                        } else {
                            sVar10 = 6;
                        }
                        *pmdStatus = sVar10;
                    } else if (((uint)prod.dwFlags & 0x3ff) == 0) {
                        *pmdStatus = 0;
                    } else {
                        *pmdStatus = 5;
                    }
                } else {
                    if (cBuilt < 1) {
                        sVar10 = 2;
                    } else {
                        sVar10 = 1;
                    }
                    *pmdStatus = sVar10;
                }
            }
            if ((fCalcOnly == 0) && (fAutoBuild == 0)) {
                *&lpprod->dwFlags = (uint)prod.dwFlags;
                *(uint *)((int)&((PROD *)lpprod)->dwFlags + 2) = prod.dwFlags._2_2_;
            }
            if ((((fAutoBuild != 0) && (pprodPartial != 0)) && ((pprodPartial->dwFlags & 0x3ff) == 0)) &&
                (uVar15 = __aFulshr(uVar22, (uint)AddCost), (uVar15 & 0x7f) != 0)) {
                *&pprodPartial->dwFlags = (uint)prod.dwFlags;
                *(uint *)((int)&pprodPartial->dwFlags + 2) = prod.dwFlags._2_2_;
                uVar13 = *(undefined2 *)((int)&pprodPartial->dwFlags + 2);
                *&pprodPartial->dwFlags = (uint)pprodPartial->dwFlags & 0xfc00 | 1;
                *(undefined2 *)((int)&pprodPartial->dwFlags + 2) = uVar13;
                lVar19 = __aFlshl(uVar22, (uint)AddCost);
                uVar8 = *(uint *)((int)&pprodPartial->dwFlags + 2);
                *&pprodPartial->dwFlags = (uint)pprodPartial->dwFlags & 0x3ff | (uint)lVar19;
                *(uint *)((int)&pprodPartial->dwFlags + 2) = uVar8 & 0xfffe | (uint)((ulong)lVar19 >> 0x10);
            }
            return cBuilt;
        }
    } while (true);
}

// ======================================================================
// Function: FBuildObject
// Address: 10b8:19b2
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b81a59) */
/* WARNING: Variable defined which should be unmapped: l */
/* WARNING: Removing unreachable block (ram,0x10b827aa) */

short FBuildObject(PLANET *lppl, GrobjClass grobj, short iItem, short cBuilt, long *rgMinerals)

{
    ulong     *puVar1;
    int       *piVar2;
    uint      *puVar3;
    FLEET     *pFVar4;
    int        iVar5;
    PLORD     *pPVar6;
    THING     *pTVar7;
    char       cVar8;
    short      sVar9;
    char      *pcVar10;
    SHDEF     *pSVar11;
    int        iVar12;
    int        iVar13;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar14;
    HULDEF    *pHVar15;
    ulong      uVar16;
    long       lVar17;
    ulong      uVar18;
    THING     *pTVar19;
    ushort     uVar20;
    short      p5;
    short      p6;
    uint       uVar21;
    short      p7;
    undefined2 uVar22;
    undefined2 uVar23;
    long       l;
    short      rgwt[3];
    short      cSize;
    short      iWarpAsked;
    short      raMajor;
    undefined4 local_22;
    PART       local_1e;
    short      cAllowed;
    SHDEF     *lpshdef;
    short      fTwoMAs;
    short      idm;
    FLEET     *lpfl;
    short      i;
    short      iWarp;

    uVar16 = CONCAT22(unaff_SI, unaff_DI);
    if (grobj == grobjFleet) {
        if (0xf < iItem) {
            uVar21 = iItem - 0x10;
            iVar12 = ((PLANET *)lppl)->iPlayer * 4;
            uVar14 = *(undefined2 *)(iVar12 + rglpshdefSB_0x2);
            pSVar11 = (SHDEF *)(*(int *)(iVar12 + rglpshdefSB) + uVar21 * 0x93);
            lpshdef = (SHDEF *)CONCAT22(uVar14, pSVar11);
            if (((pSVar11->wFlags >> 9 & 1) == 0) && (sVar9 = FCanBuildShdef((SHDEF *)CONCAT22(uVar14, pSVar11), ((PLANET *)lppl)->iPlayer), sVar9 != 0)) {
                idm = 0xcd;
                uVar14 = (undefined2)((ulong)lpshdef >> 0x10);
                if (((((SHDEF *)lpshdef)->hul).wtCargoMax != 0) && (idm = 0xce, (((SHDEF *)lpshdef)->hul).wtCargoMax == 0xffff)) {
                    idm = 0xcf;
                }
                p7 = 0;
                p6 = 0;
                p5 = 0;
                sVar9 = 0;
                pHVar15 = LphuldefFromId((lpshdef->hul).ihuldef);
                FSendPlrMsg(((PLANET *)lppl)->iPlayer, idm, lppl->id, lppl->id, ((PLANET *)lppl)->iPlayer << 5 | iItem, (((HULDEF *)pHVar15)->hul).wtCargoMax,
                            sVar9, p5, p6, p7);
                if (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) &&
                    (iVar12 = ((PLANET *)lppl)->iPlayer * 4, local_1e.u_PART_0x0004._2_2_ = *(int *)(*(int *)(iVar12 + rglpshdefSB) + uVar21 * 0x93),
                     iVar12 = ((PLANET *)lppl)->iPlayer * 4,
                     (int)local_1e.u_PART_0x0004._2_2_ < *(int *)(*(int *)(iVar12 + rglpshdefSB) + (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93))) {
                    KillQueuedShips(lppl);
                }
                iWarp = IWarpMAFromLppl(lppl, &fTwoMAs);
                if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0) {
                    ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfdff | 0x200;
                } else {
                    iVar12 = ((PLANET *)lppl)->iPlayer * 4;
                    uVar14 = *(undefined2 *)(iVar12 + rglpshdefSB_0x2);
                    iVar13 = *(int *)(iVar12 + rglpshdefSB) + (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93;
                    piVar2 = (int *)(iVar13 + 0x83);
                    iVar12 = *piVar2;
                    *piVar2 = *piVar2 + -1;
                    piVar2 = (int *)(iVar13 + 0x85);
                    *piVar2 = *piVar2 - (uint)(iVar12 == 0);
                }
                *(uint *)&((PLANET *)lppl)->lStarbase = *(uint *)&((PLANET *)lppl)->lStarbase & 0xfff0 | uVar21 & 0xf;
                if (iWarp < 1) {
                    iWarp = IWarpMAFromLppl(lppl, &fTwoMAs);
                    if (iWarp < 1) {
                        *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) = *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0xc3ff;
                        *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) = *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0xfc00;
                        KillQueuedMassPackets(lppl);
                    } else {
                        *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) =
                            *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0xc3ff | ((iWarp + fTwoMAs) - 4U & 0xf) << 10;
                    }
                }
                uVar14 = (undefined2)((ulong)lpshdef >> 0x10);
                pSVar11 = (SHDEF *)lpshdef;
                puVar1 = &pSVar11->cBuilt;
                uVar16 = *puVar1;
                *puVar1 = (uint)*puVar1 + 1;
                piVar2 = (int *)((int)&pSVar11->cBuilt + 2);
                *piVar2 = *piVar2 + (uint)(0xfffe < (uint)uVar16);
                puVar1 = &pSVar11->cExist;
                uVar16 = *puVar1;
                *puVar1 = (uint)*puVar1 + 1;
                piVar2 = (int *)((int)&pSVar11->cExist + 2);
                *piVar2 = *piVar2 + (uint)(0xfffe < (uint)uVar16);
                return 1;
            }
            return 0;
        }
        if (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0) || (0xf < iItem)) {
            return 0;
        }
        iVar12 = ((PLANET *)lppl)->iPlayer * 4;
        uVar14 = *(undefined2 *)(iVar12 + rglpshdef_0x2);
        pSVar11 = (SHDEF *)(*(int *)(iVar12 + rglpshdef) + iItem * 0x93);
        lpshdef = (SHDEF *)CONCAT22(uVar14, pSVar11);
        if ((pSVar11->wFlags >> 9 & 1) == 0) {
            sVar9 = FCanBuildShdef((SHDEF *)CONCAT22(uVar14, pSVar11), ((PLANET *)lppl)->iPlayer);
            if (sVar9 != 0) {
                if ((*(uint *)((int)&rgplr[0].wFlags_0x4 + ((PLANET *)lppl)->iPlayer * 0xc0) & 0xfff) != 0x200) {
                    lpfl = LpflNew(((PLANET *)lppl)->iPlayer, lppl->id);
                    CreateShip(((PLANET *)lppl)->iPlayer, lpfl, iItem, cBuilt);
                    lVar17 = LGetFleetStat(lpfl, grStatFuel);
                    uVar14 = (undefined2)((ulong)lpfl >> 0x10);
                    *(int *)(((FLEET *)lpfl)->rgwtMin + 4) = (int)lVar17;
                    *(undefined2 *)((int)((FLEET *)lpfl)->rgwtMin + 0x12) = (int)((ulong)lVar17 >> 0x10);
                    if ((((PLANET *)lppl)->wRouting & 0x3ff) != 0) {
                        AutoRouteFleet(lpfl, lppl);
                        uVar14 = (undefined2)((ulong)lpfl >> 0x10);
                        if (cBuilt != 1) {
                            pPVar6 = ((FLEET *)lpfl)->lpplord;
                            if ((((PLORD *)pPVar6 + 7)->wFlags >> 4 & 0xf) == 0) {
                                idm = idmStarbaseHasBuiltNewShipsWhichWill;
                            } else {
                                idm = idmStarbaseHasBuiltNewShipsWhichRouted;
                            }
                            FSendPlrMsg(((PLANET *)lppl)->iPlayer, idm, lpfl->id | 0x8000, lppl->id, cBuilt, ((PLANET *)lppl)->iPlayer << 5 | iItem,
                                        (((PLANET *)lppl)->wRouting & 0x3ff) - 1, 0, 0, 0);
                            return 1;
                        }
                        pPVar6 = ((FLEET *)lpfl)->lpplord;
                        if ((((PLORD *)pPVar6 + 7)->wFlags >> 4 & 0xf) == 0) {
                            idm = idmStarbaseHasBuiltNewWhichWillRouted;
                        } else {
                            idm = idmStarbaseHasBuiltNewWhichRouted;
                        }
                        FSendPlrMsg(((PLANET *)lppl)->iPlayer, idm, lpfl->id | 0x8000, lppl->id, ((PLANET *)lppl)->iPlayer << 5 | iItem,
                                    (((PLANET *)lppl)->wRouting & 0x3ff) - 1, 0, 0, 0, 0);
                        return 1;
                    }
                    AutoFleetOrder(lpfl, lppl);
                    if (cBuilt != 1) {
                        FSendPlrMsg(((PLANET *)lppl)->iPlayer, idmStarbaseHasBuiltNewShips, lpfl->id | 0x8000, lppl->id, cBuilt,
                                    ((PLANET *)lppl)->iPlayer << 5 | iItem, 0, 0, 0, 0);
                        return 1;
                    }
                    FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmStarbaseHasBuiltNew, lpfl->id | 0x8000, lppl->id, ((PLANET *)lppl)->iPlayer << 5 | iItem);
                    return 1;
                }
                for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
                    pFVar4 = ((FLEET **)rglpfl)[i];
                    iVar12 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                    lpfl = (FLEET *)CONCAT22(iVar12, pFVar4);
                    if (((pFVar4 == 0) && (iVar12 == 0)) || (((PLANET *)lppl)->iPlayer < pFVar4->iPlayer))
                        break;
                    if (((((PLANET *)lppl)->iPlayer <= pFVar4->iPlayer) && (((PLORD *)pFVar4->lpplord + 1)->wFlags == ((POINT *)rgptPlan + lppl->id)->x)) &&
                        ((*(int *)&((PLORD *)pFVar4->lpplord)[1].iordMax == *(int *)((int)&rgptPlan[0].y + lppl->id * 4) &&
                          (pFVar4->rgcsh[iItem] < 0x7ffe - cBuilt)))) {
                        if ((pFVar4->rgcsh[iItem] == 0) || ((uint)pFVar4->rgcsh[iItem + 0x10] >> 7 == 0)) {
                            pFVar4->rgcsh[iItem + 0x10] = 0;
                        } else {
                            iVar13 = pFVar4->iPlayer * 4;
                            uVar21 = *(uint *)(*(int *)(iVar13 + rglpshdef) + iItem * 0x93 + 0x38);
                            local_1e.hs.grhst = pFVar4->rgcsh[iItem];
                            uVar22 = 0;
                            uVar14 = 100;
                            uVar16 = __aFulmul((ulong)(uint)pFVar4->rgcsh[iItem + 0x10] & 0xffff007f, (long)(int)local_1e.hs.grhst);
                            lVar17 = __aFldiv(uVar16, CONCAT22(uVar22, uVar14));
                            local_1e.hs.wFlags_0x2 = (ushort)lVar17;
                            if (local_1e.hs.wFlags_0x2 == 0) {
                                local_1e.hs.wFlags_0x2 = 1;
                            }
                            uVar22 = 0;
                            uVar14 = 0x32;
                            iVar12 = (int)local_1e.hs.wFlags_0x2 >> 0xf;
                            lVar17 = 10;
                            uVar20 = local_1e.hs.wFlags_0x2;
                            uVar16 = __aFulmul((ulong)uVar21, (ulong)((uint)((FLEET *)lpfl)->rgcsh[iItem + 0x10] >> 7));
                            uVar16 = __aFldiv(uVar16, lVar17);
                            uVar16 = __aFulmul(uVar16, CONCAT22(iVar12, uVar20));
                            local_1e.u_PART_0x0004 = (u_PART_0x0004)__aFldiv(uVar16, CONCAT22(uVar22, uVar14));
                            iVar12 = local_1e.hs.grhst + cBuilt;
                            iVar13 = iVar12 >> 0xf;
                            uVar16 = __aFulmul((long)(int)local_1e.hs.wFlags_0x2, 100);
                            lVar17 = __aFldiv(uVar16, CONCAT22(iVar13, iVar12));
                            ((FLEET *)lpfl)->rgcsh[iItem + 0x10] = ((FLEET *)lpfl)->rgcsh[iItem + 0x10] & 0xff80U | (uint)lVar17 & 0x7f;
                            if ((((FLEET *)lpfl)->rgcsh[iItem + 0x10] & 0x7fU) == 0) {
                                ((FLEET *)lpfl)->rgcsh[iItem + 0x10] = ((FLEET *)lpfl)->rgcsh[iItem + 0x10] & 0xff80U | 1;
                            }
                            uVar22 = 0;
                            uVar14 = 100;
                            uVar16 = __aFulmul((ulong)(uint)((FLEET *)lpfl)->rgcsh[iItem + 0x10] & 0xffff007f, (long)(int)(local_1e.hs.grhst + cBuilt));
                            lVar17 = __aFldiv(uVar16, CONCAT22(uVar22, uVar14));
                            local_1e.hs.wFlags_0x2 = (ushort)lVar17;
                            if (local_1e.hs.wFlags_0x2 == 0) {
                                local_1e.hs.wFlags_0x2 = 1;
                            }
                            uVar23 = 0;
                            uVar22 = 0;
                            uVar14 = 100;
                            lVar17 = (long)(int)local_1e.hs.wFlags_0x2;
                            uVar16 = __aFulmul((ulong)local_1e.u_PART_0x0004, 5);
                            uVar16 = __aFldiv(uVar16, lVar17);
                            uVar16 = __aFulmul(uVar16, CONCAT22(uVar22, uVar14));
                            lVar17 = __aFldiv(uVar16, CONCAT22(uVar23, uVar21));
                            ((FLEET *)lpfl)->rgcsh[iItem + 0x10] = ((FLEET *)lpfl)->rgcsh[iItem + 0x10] & 0x7fU | (int)lVar17 << 7;
                        }
                        CreateShip(((PLANET *)lppl)->iPlayer, lpfl, iItem, cBuilt);
                        FSendPlrMsg(((PLANET *)lppl)->iPlayer, idmStarbaseBuiltNewSDueLack27b, lpfl->id | 0x8000, lppl->id, cBuilt,
                                    ((PLANET *)lppl)->iPlayer << 5 | iItem, lpfl->id, 0, 0, 0);
                        return 1;
                    }
                }
                FSendPlrMsg(((PLANET *)lppl)->iPlayer, idmStarbaseBuiltNewShipSTypeLost, lppl->id, lppl->id, cBuilt, ((PLANET *)lppl)->iPlayer << 5 | iItem, 0,
                            0, 0, 0);
                return 0;
            }
        }
        FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmStarbaseFailedBuildNewShipTypeBecause, lppl->id, iItem + 1, 0);
        return 0;
    }
    if (grobj != grobjPlanet) {
        return 0;
    }
    switch (iItem) {
    case 0:
    case 8:
        uVar18 = __aFulshr(uVar16, (ushort)l);
        local_1e.u_PART_0x0004._2_2_ = (uint)uVar18 & 0xfff;
        sVar9 = CMaxMines(lppl, ((PLANET *)lppl)->iPlayer);
        cAllowed = sVar9 - local_1e.u_PART_0x0004._2_2_;
        if (cAllowed <= cBuilt) {
            cBuilt = cAllowed;
        }
        if (cBuilt < 1) {
            return 0;
        }
        lVar17 = __aFlshl(uVar16, (ushort)l);
        local_1e.u_PART_0x0004.parmor._0_2_ = (ARMOR *)((uint)lVar17 + *(uint *)((PLANET *)lppl)->rgbImp & 0xff00);
        local_1e.u_PART_0x0004._2_2_ =
            (int)((ulong)lVar17 >> 0x10) + *(int *)(((PLANET *)lppl)->rgbImp + 2) + (uint)CARRY2((uint)lVar17, *(uint *)((PLANET *)lppl)->rgbImp) & 0xf;
        *(uint *)((PLANET *)lppl)->rgbImp = *(uint *)((PLANET *)lppl)->rgbImp & 0xff;
        *(uint *)(((PLANET *)lppl)->rgbImp + 2) = *(uint *)(((PLANET *)lppl)->rgbImp + 2) & 0xfff0;
        *(uint *)((PLANET *)lppl)->rgbImp = *(uint *)((PLANET *)lppl)->rgbImp | (uint)local_1e.u_PART_0x0004.parmor._0_2_;
        *(uint *)(((PLANET *)lppl)->rgbImp + 2) = *(uint *)(((PLANET *)lppl)->rgbImp + 2) | local_1e.u_PART_0x0004._2_2_;
        idm = 0x37;
        goto TURN2_SendMsgFactMine;
    case 1:
    case 7:
        uVar18 = __aFulshr(uVar16, (ushort)l);
        local_1e.u_PART_0x0004._2_2_ = (uint)uVar18 & 0xfff;
        sVar9 = CMaxFactories(lppl, ((PLANET *)lppl)->iPlayer);
        cAllowed = sVar9 - local_1e.u_PART_0x0004._2_2_;
        if (cAllowed <= cBuilt) {
            cBuilt = cAllowed;
        }
        if (cBuilt < 1) {
            return 0;
        }
        lVar17 = __aFlshl(uVar16, (ushort)l);
        local_1e.u_PART_0x0004._2_2_ =
            (int)((ulong)lVar17 >> 0x10) + *(int *)(((PLANET *)lppl)->rgbImp + 2) + (uint)CARRY2((uint)lVar17, *(uint *)((PLANET *)lppl)->rgbImp) & 0xfff0;
        local_1e.u_PART_0x0004.parmor._0_2_ = 0;
        *(undefined2 *)((PLANET *)lppl)->rgbImp = *(undefined2 *)((PLANET *)lppl)->rgbImp;
        *(uint *)(((PLANET *)lppl)->rgbImp + 2) = *(uint *)(((PLANET *)lppl)->rgbImp + 2) & 0xf;
        *(undefined2 *)((PLANET *)lppl)->rgbImp = *(undefined2 *)((PLANET *)lppl)->rgbImp;
        *(uint *)(((PLANET *)lppl)->rgbImp + 2) = *(uint *)(((PLANET *)lppl)->rgbImp + 2) | local_1e.u_PART_0x0004._2_2_;
        idm = 0x35;
        goto TURN2_SendMsgFactMine;
    case 2:
    case 9:
        local_1e.u_PART_0x0004._2_2_ = *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff;
        sVar9 = CMaxDefenses(lppl, ((PLANET *)lppl)->iPlayer);
        cAllowed = sVar9 - local_1e.u_PART_0x0004._2_2_;
        if (cAllowed <= cBuilt) {
            cBuilt = cAllowed;
        }
        if (cBuilt < 1) {
            return 0;
        }
        lVar17 = __aFlshl(uVar16, (ushort)l);
        local_1e.u_PART_0x0004.parmor._0_2_ = (ARMOR *)((int)lVar17 + *(int *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff);
        local_1e.u_PART_0x0004._2_2_ = 0;
        *(uint *)(((PLANET *)lppl)->rgbImp + 4) = *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xf000;
        *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6) = *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6);
        *(uint *)(((PLANET *)lppl)->rgbImp + 4) = *(uint *)(((PLANET *)lppl)->rgbImp + 4) | (uint)local_1e.u_PART_0x0004.parmor._0_2_;
        *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6) = *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6);
        idm = 0x39;
    TURN2_SendMsgFactMine:
        sVar9 = FRemovePlayerMessage(((PLANET *)lppl)->iPlayer, idm, lppl->id);
        if (cBuilt + sVar9 < 2) {
            FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idm, lppl->id, lppl->id, 0);
        } else {
            FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idm + idmColonistsDroppedDestroyedPlanetaryDefensesRestMa, lppl->id, cBuilt + sVar9, lppl->id);
        }
        break;
    case 3:
    case 0xb:
        break;
    case 4:
    case 5:
    case 0xc:
        while (iVar12 = cBuilt + -1, cBuilt != 0) {
            i = IBestTerraform(lppl, 1);
            cBuilt = iVar12;
            if (i != 0) {
                sVar9 = _abs(i);
                local_1e.u_PART_0x0004._2_2_ = sVar9 + -1;
                if (i < 1) {
                    local_1e.u_PART_0x0004.parmor._0_2_ = (ARMOR *)0xffff;
                } else {
                    local_1e.u_PART_0x0004.parmor._0_2_ = (ARMOR *)0x1;
                }
                cAllowed = (short)((local_1e.u_PART_0x0004.parmor._0_2_)->rgTech + (char)((PLANET *)lppl)->rgMinConc[sVar9 + 2] + -2);
                pcVar10 = (char *)cAllowed;
                if (99 < cAllowed) {
                    pcVar10 = (char *)0x63;
                }
                if ((int)pcVar10 < 1) {
                    cAllowed = 1;
                } else if (99 < cAllowed) {
                    cAllowed = 99;
                }
                ((PLANET *)lppl)->rgMinConc[sVar9 + 2] = (byte)cAllowed;
                FSendPlrMsg(((PLANET *)lppl)->iPlayer, idmTerraformingEffortsHave, lppl->id, lppl->id, (uint)(0 < i), local_1e.u_PART_0x0004._2_2_,
                            cAllowed + local_1e.u_PART_0x0004._2_2_ * 0x100, 0, 0, 0);
            }
        }
        break;
    case 6:
    case 0xe:
    case 0xf:
    case 0x10:
    case 0x11:
        sVar9 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lppl)->iPlayer, rsMajorAdv);
        local_1e.hs.wFlags_0x2 = IWarpMAFromLppl(lppl, &fTwoMAs);
        if (local_1e.hs.wFlags_0x2 == 0) {
            FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmMineralPacketFormedHasDisintegratedBecausePlanet, lppl->id, lppl->id, 0);
            return 0;
        }
        if ((*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0x3ff) == 0) {
            FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmMineralPacketFormedHasDisintegratedBecauseDidnt, lppl->id, lppl->id, 0);
            return 0;
        }
        if (iItem == 6) {
            iItem = 0x11;
        }
        if (iItem == 0x11) {
            if (sVar9 == 6) {
                cSize = 0x19;
            } else {
                cSize = 0x28;
            }
        } else if (sVar9 == 6) {
            cSize = 0x46;
        } else {
            cSize = 100;
        }
        for (i = 0; i < 3; i = i + 1) {
            if ((i == iItem + -0xe) || (iItem == 0x11)) {
                uVar16 = __aFulmul((long)cSize, (long)cBuilt);
                if (0x7ff8 < (long)uVar16) {
                    uVar16 = 0x7ff8;
                }
                l._0_2_ = (ushort)uVar16;
                rgwt[i] = (ushort)l;
            } else {
                rgwt[i] = 0;
            }
        }
        iWarpAsked = (*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) >> 10 & 0xf) + 4;
        if (((uint)iWarpAsked < 5) || ((int)(local_1e.hs.wFlags_0x2 + 3) < iWarpAsked)) {
            iWarpAsked = local_1e.hs.wFlags_0x2 + fTwoMAs;
        }
        if ((int)(local_1e.hs.wFlags_0x2 + fTwoMAs) < iWarpAsked) {
            local_1e.hs.grhst = (iWarpAsked - local_1e.hs.wFlags_0x2) - fTwoMAs;
        } else {
            local_1e.hs.grhst = hstNone;
        }
        if ((sVar9 == 7) && ((int)local_1e.hs.grhst < 3)) {
            local_1e.hs.grhst = local_1e.hs.grhst + hstEngine;
        }
        local_1e.hs.wFlags_0x2 = iWarpAsked - 4U;
        local_22 = (ARMOR *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
        local_1e.u_PART_0x0004.parmor._0_2_ = (THING *)lpThings + cThing;
        local_1e.u_PART_0x0004._2_2_ = lpThings._2_2_;
        while (true) {
            if ((local_1e.u_PART_0x0004.parmor._0_2_ <= (ARMOR *)local_22) ||
                (((((((uint)local_22->id >> 9 & 0xf) == ((PLANET *)lppl)->iPlayer && ((uint)local_22->id >> 0xd == 1)) &&
                    (((ARMOR *)local_22)->rgTech->x == ((POINT *)rgptPlan + lppl->id)->x)) &&
                   ((((ARMOR *)local_22)->rgTech->y == *(int *)((int)&rgptPlan[0].y + lppl->id * 4) &&
                     ((((((ARMOR *)local_22)->rgTech + 1)->thp).wFlags >> 10 & 0xf) == iWarpAsked - 4U)))) &&
                  (((((((ARMOR *)local_22)->rgTech + 1)->thp).wFlags & 0x3ff) == (*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0x3ff) - 1 &&
                    ((*(uint *)(((ARMOR *)local_22)->szName + 6) >> 0xe == local_1e.hs.grhst &&
                      ((*(uint *)(((ARMOR *)local_22)->szName + 6) & 0x3fff) < 0x65e))))))))
                break;
            local_22 = (ARMOR *)CONCAT22(local_22._2_2_, ((ARMOR *)local_22)->szName + 10);
        }
        if (((ARMOR *)local_22 == local_1e.u_PART_0x0004.parmor._0_2_) && (local_22._2_2_ == lpThings._2_2_)) {
            pTVar19 = LpthNew(((PLANET *)lppl)->iPlayer, ithMineralPacket);
            iVar12 = (int)((ulong)pTVar19 >> 0x10);
            pTVar7 = (THING *)pTVar19;
            if ((pTVar7 == 0) && (iVar12 == 0)) {
                FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmHasOrdersBuildMineralPacketEitherDoesnt, lppl->id, lppl->id, 0);
            } else {
                for (i = 0; i < 3; i = i + 1) {
                    *(short *)((pTVar7->u_THING_0x0006).rgb + i * 2 + 2) = rgwt[i];
                    iVar13 = rgwt[i];
                    iVar5 = *(int *)((int)&pTVar7->u_THING_0x0006 + 8);
                    puVar3 = (uint *)((int)&pTVar7->u_THING_0x0006 + 8);
                    *puVar3 = *puVar3 & 0xc000;
                    puVar3 = (uint *)((int)&pTVar7->u_THING_0x0006 + 8);
                    *puVar3 = *puVar3 | (iVar13 + 9) / 10 + iVar5 & 0x3fffU;
                }
                ((&pTVar7->u_THING_0x0006)->thp).wFlags = ((&pTVar7->u_THING_0x0006)->thp).wFlags & 0xc3ff | (local_1e.hs.wFlags_0x2 & 0xf) << 10;
                *(uint *)((int)&pTVar7->u_THING_0x0006 + 8) = *(uint *)((int)&pTVar7->u_THING_0x0006 + 8) & 0x3fff | local_1e.hs.grhst << 0xe;
                ((&pTVar7->u_THING_0x0006)->thp).wFlags =
                    ((&pTVar7->u_THING_0x0006)->thp).wFlags & 0xfc00 | (*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0x3ff) - 1 & 0x3ff;
                sVar9 = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
                (&pTVar7->pt)->x = ((POINT *)rgptPlan + lppl->id)->x;
                (pTVar7->pt).y = sVar9;
                FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmHasProducedMineralPacketWhichHasDestination, lppl->id, lppl->id,
                             (*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0x3ff) - 1);
            }
        } else {
            *(uint *)(((ARMOR *)local_22)->szName + 6) = *(uint *)(((ARMOR *)local_22)->szName + 6) & 0xc000;
            for (i = 0; i < 3; i = i + 1) {
                *(int *)(((ARMOR *)local_22)->szName + i * 2) = *(int *)(((ARMOR *)local_22)->szName + i * 2) + rgwt[i];
                if (*(int *)(((ARMOR *)local_22)->szName + i * 2) < 0) {
                    (((ARMOR *)local_22)->szName + i * 2)[0] = -8;
                    (((ARMOR *)local_22)->szName + i * 2)[1] = '\x7f';
                }
                iVar12 = *(int *)(((ARMOR *)local_22)->szName + i * 2);
                iVar13 = *(int *)(((ARMOR *)local_22)->szName + 6);
                *(uint *)(((ARMOR *)local_22)->szName + 6) = *(uint *)(((ARMOR *)local_22)->szName + 6) & 0xc000;
                *(uint *)(((ARMOR *)local_22)->szName + 6) = *(uint *)(((ARMOR *)local_22)->szName + 6) | (iVar12 + 9) / 10 + iVar13 & 0x3fffU;
            }
            FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmHasProducedMineralPacketWhichHasCombined, lppl->id, lppl->id,
                         (*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0x3ff) - 1);
        }
        break;
    case 10:
        break;
    case 0xd:
        for (i = 0; i < game.cPlayer; i = i + 1) {
            FSendPlrMsg2(i, idmStrongFundamentalForcesHaveRebirthed, lppl->id, lppl->id, 0);
        }
        sVar9 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lppl)->iPlayer, rsMajorAdv);
        if (sVar9 != raMacintosh) {
            uVar21 = *(uint *)(((PLANET *)lppl)->rgbImp + 2);
            *(undefined2 *)((PLANET *)lppl)->rgbImp = *(undefined2 *)((PLANET *)lppl)->rgbImp;
            *(uint *)(((PLANET *)lppl)->rgbImp + 2) = uVar21 & 0xf;
            uVar21 = *(uint *)(((PLANET *)lppl)->rgbImp + 2);
            *(uint *)((PLANET *)lppl)->rgbImp = *(uint *)((PLANET *)lppl)->rgbImp & 0xff;
            *(uint *)(((PLANET *)lppl)->rgbImp + 2) = uVar21 & 0xfff0;
            uVar14 = *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6);
            *(uint *)(((PLANET *)lppl)->rgbImp + 4) = *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xf000;
            *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6) = uVar14;
            uVar21 = *(uint *)(((PLANET *)lppl)->rgbImp + 6);
            *(uint *)(((PLANET *)lppl)->rgbImp + 4) = *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff | 0xf000;
            *(uint *)(((PLANET *)lppl)->rgbImp + 6) = uVar21 & 0xfffe | 1;
        }
        for (i = 0; i < 3; i = i + 1) {
            *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = 0;
            *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
            local_1e.u_PART_0x0004._2_2_ = Random(0x32);
            sVar9 = Random(0x32);
            cVar8 = (char)sVar9 + '\x01' + (char)local_1e.u_PART_0x0004._2_2_;
            ((PLANET *)lppl)->rgEnvVarOrig[i] = cVar8;
            ((PLANET *)lppl)->rgEnvVar[i] = cVar8;
            local_1e.u_PART_0x0004._2_2_ = Random(0x28);
            sVar9 = Random(0x28);
            ((PLANET *)lppl)->rgMinConc[i] = (char)sVar9 + '\x19' + (char)local_1e.u_PART_0x0004._2_2_;
        }
        break;
    case 0x1b:
        idPlayer = ((PLANET *)lppl)->iPlayer;
        LookupBestPlanetaryScanner(&local_1e);
        idPlayer = -1;
        iItem = (local_1e.hs.wFlags_0x2 & 0xff) + 0x12;
    case 0x12:
    case 0x13:
    case 0x14:
    case 0x15:
    case 0x16:
    case 0x17:
    case 0x18:
    case 0x19:
    case 0x1a:
        FSendPlrMsg(((PLANET *)lppl)->iPlayer, idmHasBuiltNewPlanetaryScanner, lppl->id, lppl->id, -0x8000, iItem + -0x12, 0, 0, 0, 0);
        local_1e.u_PART_0x0004.parmor._0_2_ = (ARMOR *)(iItem + -0x12);
        local_1e.u_PART_0x0004._2_2_ = (int)local_1e.u_PART_0x0004.parmor._0_2_ >> 0xf;
        lVar17 = __aFlshl(uVar16, (ushort)l);
        uVar21 = *(uint *)(((PLANET *)lppl)->rgbImp + 6);
        *(uint *)(((PLANET *)lppl)->rgbImp + 4) = *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff | (uint)lVar17;
        *(uint *)(((PLANET *)lppl)->rgbImp + 6) = uVar21 & 0xfffe | (uint)((ulong)lVar17 >> 0x10);
        break;
    default:
        return 0;
    }
    return 1;
}

// ======================================================================
// Function: CreateShip
// Address: 10b8:2fd6
// Segment: MEMORY_TURN2
// ======================================================================

void CreateShip(short iPlr, FLEET *lpfl, short ishdef, short cShip)

{
    uint      *puVar1;
    int       *piVar2;
    uint       uVar3;
    undefined2 uVar4;
    int        iVar5;

    ((FLEET *)lpfl)->rgcsh[ishdef] = ((FLEET *)lpfl)->rgcsh[ishdef] + cShip;
    uVar4 = *(undefined2 *)(iPlr * 4 + rglpshdef_0x2);
    iVar5 = *(int *)(iPlr * 4 + rglpshdef) + ishdef * 0x93;
    puVar1 = (uint *)(iVar5 + 0x83);
    uVar3 = *puVar1;
    *puVar1 = *puVar1 + cShip;
    piVar2 = (int *)(iVar5 + 0x85);
    *piVar2 = *piVar2 + (cShip >> 0xf) + (uint)CARRY2(uVar3, cShip);
    uVar4 = *(undefined2 *)(iPlr * 4 + rglpshdef_0x2);
    iVar5 = *(int *)(iPlr * 4 + rglpshdef) + ishdef * 0x93;
    puVar1 = (uint *)(iVar5 + 0x7f);
    uVar3 = *puVar1;
    *puVar1 = *puVar1 + cShip;
    piVar2 = (int *)(iVar5 + 0x81);
    *piVar2 = *piVar2 + (cShip >> 0xf) + (uint)CARRY2(uVar3, cShip);
    return;
}

// ======================================================================
// Function: RandomEvents
// Address: 10b8:3064
// Segment: MEMORY_TURN2
// ======================================================================

void RandomEvents(void)

{
    MeteorStrike();
    PlanetaryClimateChange();
    DiscoverNewMinerals();
    MysteryTrader();
    return;
}

// ======================================================================
// Function: TransferToOthers
// Address: 10b8:3088
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Variable defined which should be unmapped: l */

void TransferToOthers(void)

{
    short      sVar1;
    ushort     p2;
    uint       uVar2;
    uint       uVar3;
    MessageId  MVar4;
    XFERFULL  *pXVar5;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar6;
    PLANET    *pPVar7;
    long       lVar8;
    ulong      uVar9;
    uint       uVar10;
    ushort     uVar11;
    short      sVar12;
    ushort     p2_00;
    short      sVar13;
    ulong      uVar14;
    long       l;
    XFERFULL  *lpxfCur;
    XFERFULL  *lpxfMax;
    short      idm;
    short      i;
    short      idSrc;
    XFER       rgxf[2];
    short      idDst;
    long       l2;

    uVar14 = CONCAT22(unaff_SI, unaff_DI);
    if (cXferFull != 0) {
        pXVar5 = (XFERFULL *)lpxf + cXferFull;
        lpxfCur = (XFERFULL *)CONCAT22(lpxf._2_2_, (XFERFULL *)lpxf);
        while ((XFERFULL *)lpxfCur < pXVar5) {
            uVar6 = (undefined2)((ulong)lpxfCur >> 0x10);
            sVar1 = FLookupObject((int)(uint)((XFERFULL *)lpxfCur)->bFlags_0x4 >> 4, ((XFERFULL *)lpxfCur)->id2, &rgxf[1].u_XFER_0x0004);
            if (sVar1 != 0) {
                if ((((XFERFULL *)lpxfCur)->bFlags_0x4 & 0xf) == 1) {
                    pPVar7 = LpplFromId(lpxfCur->id1);
                    rgxf[0].u_XFER_0x0004._2_2_ = ((PLANET *)pPVar7)->iPlayer;
                } else {
                    rgxf[0].u_XFER_0x0004._2_2_ = lpxfCur->id1 >> 9 & 0xf;
                }
                for (i = 0; i < 5; i = i + 1) {
                    p2_00 = *(ushort *)(((XFERFULL *)lpxfCur)->rgcQuan + i);
                    uVar11 = *(ushort *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                    if ((p2_00 != 0) || (uVar11 != 0)) {
                        lVar8 = ChgCargo((int)(uint)((XFERFULL *)lpxfCur)->bFlags_0x4 >> 4, ((XFERFULL *)lpxfCur)->id2, i, CONCAT22(uVar11, p2_00), 0);
                        p2 = (ushort)lVar8;
                        if (lVar8 == CONCAT22(uVar11, p2_00)) {
                            if (i == 4) {
                                MVar4 = idmSuccessfullyTransferred2;
                            } else {
                                MVar4 = idmSuccessfullyTransferred;
                            }
                            if ((((XFERFULL *)lpxfCur)->bFlags_0x4 & 0xf) == 2) {
                                uVar2 = 0x8000;
                            } else {
                                uVar2 = 0;
                            }
                            uVar2 = lpxfCur->id1 | uVar2;
                            if ((int)(uint)((XFERFULL *)lpxfCur)->bFlags_0x4 >> 4 == 2) {
                                uVar3 = 0x8000;
                            } else {
                                uVar3 = 0;
                            }
                            uVar3 = ((XFERFULL *)lpxfCur)->id2 | uVar3;
                            sVar13 = 0;
                            sVar12 = 0;
                            sVar1 = i;
                            uVar10 = uVar3;
                            uVar9 = __aFulshr(CONCAT22(uVar3, i), 0);
                            FSendPlrMsg(rgxf[0].u_XFER_0x0004.fl.iPlayer, MVar4, uVar2, uVar2, p2, (short)uVar9, sVar1, uVar10, sVar12, sVar13);
                            if (i == 4) {
                                MVar4 = idmSuccessfullyReceived2;
                            } else {
                                MVar4 = idmSuccessfullyReceived;
                            }
                            sVar13 = 0;
                            sVar12 = 0;
                            sVar1 = i;
                            uVar9 = __aFulshr(CONCAT22(uVar2, i), 0);
                            FSendPlrMsg(rgxf[1].u_XFER_0x0004.fl.iPlayer, MVar4, uVar3, uVar3, p2, (short)uVar9, sVar1, uVar2, sVar12, sVar13);
                        } else {
                            if (i == 4) {
                                idm = 0x47;
                            } else {
                                idm = 0x46;
                            }
                            if ((((XFERFULL *)lpxfCur)->bFlags_0x4 & 0xf) == 2) {
                                uVar2 = 0x8000;
                            } else {
                                uVar2 = 0;
                            }
                            uVar2 = lpxfCur->id1 | uVar2;
                            if ((int)(uint)((XFERFULL *)lpxfCur)->bFlags_0x4 >> 4 == 2) {
                                uVar3 = 0x8000;
                            } else {
                                uVar3 = 0;
                            }
                            uVar3 = ((XFERFULL *)lpxfCur)->id2 | uVar3;
                            if (lVar8 == 0) {
                                idm = idm + 4;
                            }
                            uVar9 = __aFulshr(uVar14, p2);
                            sVar12 = (short)uVar9;
                            sVar1 = i;
                            uVar10 = uVar3;
                            uVar11 = p2;
                            uVar9 = __aFulshr(CONCAT22(uVar3, i), p2);
                            FSendPlrMsg(rgxf[0].u_XFER_0x0004.fl.iPlayer, idm, uVar2, uVar2, p2_00, (short)uVar9, sVar1, uVar10, uVar11, sVar12);
                            if (i == 4) {
                                MVar4 = idmReceivedHoweverColonistsSentRemainsOtherColonist;
                            } else {
                                MVar4 = idmReceivedHoweverSentRemainderLostSpace;
                            }
                            if (lVar8 == 0) {
                                sVar13 = 0;
                                sVar12 = 0;
                                sVar1 = i;
                                uVar9 = __aFulshr(CONCAT22(uVar2, i), 0);
                                FSendPlrMsg(rgxf[1].u_XFER_0x0004.fl.iPlayer, MVar4 + idmPlanetaryDefensesGroundTroopsDestroyedInvadingTr, uVar3, uVar3, p2_00,
                                            (short)uVar9, sVar1, uVar2, sVar12, sVar13);
                            } else {
                                uVar9 = __aFulshr(uVar14, p2);
                                sVar12 = (short)uVar9;
                                sVar1 = i;
                                uVar9 = __aFulshr(CONCAT22(uVar2, i), p2_00);
                                FSendPlrMsg(rgxf[1].u_XFER_0x0004.fl.iPlayer, MVar4, uVar3, uVar3, p2, (short)uVar9, sVar1, uVar2, p2_00, sVar12);
                            }
                        }
                    }
                }
            }
            lpxfCur = (XFERFULL *)CONCAT22(uVar6, (XFERFULL *)lpxfCur + 1);
        }
    }
    return;
}

// ======================================================================
// Function: DropColonists
// Address: 10b8:34e2
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b84385) */
/* WARNING: Removing unreachable block (ram,0x10b838bb) */
/* WARNING: Removing unreachable block (ram,0x10b842e9) */

void DropColonists(void)

{
    uint      *puVar1;
    int       *piVar2;
    uint       uVar3;
    int        iVar4;
    undefined4 uVar5;
    short      sVar6;
    uint       uVar7;
    short      sVar8;
    short      sVar9;
    COLDROP   *pCVar10;
    int        iVar11;
    uint      *puVar12;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar13;
    undefined2 uVar14;
    undefined2 unaff_SS;
    bool       bVar15;
    ulong      uVar16;
    long       lVar17;
    long       lVar18;
    PLANET    *pPVar19;
    ulong      uVar20;
    short      sVar21;
    short      p5;
    short      p6;
    undefined2 uVar22;
    short      p7;
    undefined2 uVar23;
    uint       in_stack_0000fefe;
    undefined2 in_stack_0000ff00;
    short      ipq;
    PROD       prod;
    uint       local_f8;
    COLDROP   *lpcdMax;
    long       lPower;
    long       rgcCol[16];
    float      pctSurvive;
    short      cSides;
    long       rgcPower[16];
    short      i;
    long       c2nd;
    long       lOldPop;
    long       cColTot;
    short      iplrOldOwner;
    short      idPlanet;
    short      iMax;
    COLDROP   *lpcdCur;
    long       cPowerTot;
    long       lDefensePower;
    PLANET     pl;
    long       cMax;
    short      fTie;
    COLDROP   *lpcdLook;

    if (cColDrop != 0) {
        pCVar10 = (COLDROP *)lpcd + cColDrop;
        lpcdCur = (COLDROP *)CONCAT22(lpcd._2_2_, (COLDROP *)lpcd);
        while ((COLDROP *)lpcdCur < pCVar10) {
            uVar13 = (undefined2)((ulong)lpcdCur >> 0x10);
            if ((((COLDROP *)lpcdCur)->idPlanetDst != -1) &&
                (((int)((COLDROP *)lpcdCur)->cColonist != 0 || (*(int *)((int)&((COLDROP *)lpcdCur)->cColonist + 2) != 0)))) {
                _memset(rgcCol, 0, 0x40);
                _memset(rgcPower, 0, 0x40);
                uVar20 = 0;
                sVar8 = ((COLDROP *)lpcdCur)->idPlanetDst;
                FLookupPlanet(sVar8, &pl);
                sVar9 = pl.iPlayer;
                CalcPctSurvive(&pl, &pctSurvive, 0);
                pctSurvive = (fRam11201d8e - pctSurvive) / fRam11201d92 + pctSurvive;
                lpcdLook = lpcdCur;
                while ((COLDROP *)lpcdLook < pCVar10) {
                    uVar14 = (undefined2)((ulong)lpcdLook >> 0x10);
                    if (sVar8 == ((COLDROP *)lpcdLook)->idPlanetDst) {
                        sVar6 = GetRaceStat((PLAYER *)rgplr + ((COLDROP *)lpcdLook)->idPlr, rsMajorAdv);
                        if ((sVar6 == raMacintosh) && (((((COLDROP *)lpcdLook)->wFlags_0x6 & 1) == 0 || (pl.iPlayer != -1)))) {
                            FSendPlrMsg2(((COLDROP *)lpcdLook)->idPlr, idmColonistsAttemptingSetShopReducedProtoplasmicBlo, pl.id, pl.id, 0);
                        } else if ((pl.iPlayer == -1) && ((((COLDROP *)lpcdLook)->wFlags_0x6 & 1) == 0)) {
                            p7 = 0;
                            p6 = 0;
                            p5 = 0;
                            sVar21 = 0;
                            sVar6 = pl.id;
                            uVar16 = __aFulshr((ulong)(uint)pl.id, 0);
                            FSendPlrMsg(((COLDROP *)lpcdLook)->idPlr, idmColonistsForcedTransportDiedBecauseDidColonize, pl.id,
                                        (short)((COLDROP *)lpcdLook)->cColonist, (short)uVar16, sVar6, sVar21, p5, p6, p7);
                        } else if (((pl.wFlags_0x4 >> 9 & 1) == 0) || (pl.iPlayer == -1)) {
                            uVar3 = *(uint *)&((COLDROP *)lpcdLook)->cColonist;
                            iVar11 = *(int *)((int)&((COLDROP *)lpcdLook)->cColonist + 2);
                            iVar4 = ((COLDROP *)lpcdLook)->idPlr;
                            puVar1 = (uint *)(rgcCol + iVar4);
                            uVar7 = *puVar1;
                            *puVar1 = *puVar1 + uVar3;
                            piVar2 = (int *)((int)rgcCol + iVar4 * 4 + 2);
                            *piVar2 = *piVar2 + iVar11 + (uint)CARRY2(uVar7, uVar3);
                            sVar6 = GetRaceStat((PLAYER *)rgplr + ((COLDROP *)lpcdLook)->idPlr, rsMajorAdv);
                            if (sVar6 == raAttack) {
                                lPower._0_2_ = 0xa5;
                            } else {
                                sVar6 = GetRaceStat((PLAYER *)rgplr + ((COLDROP *)lpcdLook)->idPlr, rsMajorAdv);
                                if (sVar6 == raMacintosh) {
                                    lPower._0_2_ = 0;
                                } else {
                                    lPower._0_2_ = 0x6e;
                                }
                            }
                            uVar23 = 0;
                            uVar22 = 100;
                            uVar16 = __aFulmul(CONCAT22(*(undefined2 *)((int)&((COLDROP *)lpcdLook)->cColonist + 2), (int)((COLDROP *)lpcdLook)->cColonist),
                                               (ulong)(uint)lPower);
                            uVar16 = __aFldiv(uVar16, CONCAT22(uVar23, uVar22));
                            prod.dwFlags = uVar16;
                            lVar17 = __ftol((double)CONCAT26(in_stack_0000ff00, CONCAT24(in_stack_0000fefe, CONCAT22(unaff_SI, unaff_DI))));
                            uVar20 = lVar17 + uVar20;
                            iVar11 = ((COLDROP *)lpcdLook)->idPlr;
                            puVar1 = (uint *)(rgcPower + iVar11);
                            uVar7 = *puVar1;
                            *puVar1 = *puVar1 + (uint)lVar17;
                            piVar2 = (int *)((int)rgcPower + iVar11 * 4 + 2);
                            *piVar2 = *piVar2 + (int)((ulong)lVar17 >> 0x10) + (uint)CARRY2(uVar7, (uint)lVar17);
                        } else {
                            FSendPlrMsg2(((COLDROP *)lpcdLook)->idPlr, idmColonistsAssaultingHaveKilledForcesOrbitingStarb, pl.id, pl.id, 0);
                        }
                        ((COLDROP *)lpcdLook)->idPlanetDst = -1;
                    }
                    lpcdLook = (COLDROP *)CONCAT22(uVar14, (COLDROP *)lpcdLook + 1);
                }
                if (pl.iPlayer == -1) {
                    lVar17 = 0;
                LAB_10b8_3b02:
                    cMax._0_2_ = 0xffff;
                    cMax._2_2_ = -1;
                    c2nd._0_2_ = 0;
                    c2nd._2_2_ = 0;
                    cSides = 0;
                    bVar15 = false;
                    iMax = 0;
                    for (i = 0; i < game.cPlayer; i = i + 1) {
                        if (((int)rgcCol[i] != 0) || (*(int *)((int)rgcCol + i * 4 + 2) != 0)) {
                            cSides = cSides + 1;
                            iVar11 = *(int *)((int)rgcPower + i * 4 + 2);
                            if ((cMax._2_2_ <= iVar11) && ((cMax._2_2_ < iVar11 || ((uint)cMax <= *(uint *)(rgcPower + i))))) {
                                if ((*(uint *)(rgcPower + i) == (uint)cMax) && (*(int *)((int)rgcPower + i * 4 + 2) == cMax._2_2_)) {
                                    bVar15 = true;
                                } else {
                                    bVar15 = false;
                                    c2nd._0_2_ = (uint)cMax;
                                    c2nd._2_2_ = cMax._2_2_;
                                    cMax._0_2_ = *(uint *)(rgcPower + i);
                                    cMax._2_2_ = *(int *)((int)rgcPower + i * 4 + 2);
                                    iMax = i;
                                }
                            }
                        }
                    }
                    if ((cMax._2_2_ < 1) && (cMax._2_2_ < 0))
                        goto TURN2_IncCur;
                    if (bVar15) {
                        uVar20 = pl.rgwtMin[3];
                        for (i = 0; pl.rgwtMin[3] = uVar20, i < game.cPlayer; i = i + 1) {
                            if (((int)rgcCol[i] != 0) || (*(int *)((int)rgcCol + i * 4 + 2) != 0)) {
                                FSendPlrMsg2(i, idmInvolvedWayAssaultNobodysTroopsSurvivedBrutal, pl.id, cSides, pl.id);
                                uVar20 = pl.rgwtMin[3];
                            }
                        }
                        if (sVar9 != -1) {
                            FSendPlrMsg2(sVar9, idmMultitudeEnemiesHaveMountedProngAttackResulting, pl.id, cSides, pl.id);
                            pl.iPlayer = -1;
                            uVar20 = pl.rgwtMin[3];
                        }
                    } else {
                        if (sVar9 == -1) {
                            if (cSides < 2) {
                                sVar21 = 0;
                                sVar8 = pl.id;
                                sVar9 = pl.id;
                                sVar6 = GetRaceStat((PLAYER *)rgplr + iMax, rsMajorAdv);
                                FSendPlrMsg2(iMax, (sVar6 == raMacintosh) + idmColonistsControl, sVar8, sVar9, sVar21);
                            } else {
                                for (i = 0; i < 0x10; i = i + 1) {
                                    if (((int)rgcCol[i] != 0) || (*(int *)((int)rgcCol + i * 4 + 2) != 0)) {
                                        if (i == iMax) {
                                            FSendPlrMsg2(i, idmInvolvedWayRaceUninhabitedPlanetForcesCrush, pl.id, cSides, pl.id);
                                        } else {
                                            FSendPlrMsg(i, idmColonistsDestroyedWayRaceUninhabitedPlanetContro, pl.id, cSides, pl.id, iMax | 0xb0, 0, 0, 0, 0);
                                        }
                                    }
                                }
                            }
                        } else {
                            for (i = 0; i < 0x10; i = i + 1) {
                                if (((int)rgcCol[i] != 0) || (*(int *)((int)rgcCol + i * 4 + 2) != 0)) {
                                    if (i == iMax) {
                                        FSendPlrMsg2(i, idmTroopsCrushSColonistsControlPlanet, pl.id, sVar9 | 0x20, pl.id);
                                    } else {
                                        FSendPlrMsg2(i, idmColonistsDroppedDestroyedSpiritedFighting, pl.id, pl.id, 0);
                                    }
                                }
                            }
                            sVar21 = 0;
                            sVar6 = 0;
                            sVar8 = 0;
                            uVar16 = __aFulshr(0, 0);
                            FSendPlrMsg(sVar9, idmHaveAttackedFirstRateStormTroopersThough, pl.id, iMax | 0x30, pl.id, (short)rgcCol[iMax], (short)uVar16,
                                        sVar8, sVar6, sVar21);
                            _memset((byte *)rgTechBattle, 0, 6);
                            _memset((byte *)rgTechTrader, 0, 0xd);
                            for (i = 0; i < 6; i = i + 1) {
                                ((byte *)rgTechBattle)[i] = *(byte *)(sVar9 * 0xc0 + 0x59bc + i);
                            }
                            ITechLearnATech(iMax, -1, pl.id, idmWreckageDiscoveredBattleHasBoostedResearchResour, 0);
                            pl.iPlayer = -1;
                        }
                        if (iMax != -1) {
                            uVar7 = (uint) * (byte *)((int)&rgplr[0].zpq1 + 1 + iMax * 0xc0);
                            prod.dwFlags._2_2_ = (uint) * (byte *)((int)&rgplr[0].zpq1 + iMax * 0xc0);
                            lVar18 = __aFlshl(CONCAT22(unaff_SI, unaff_DI), in_stack_0000fefe);
                            pl.rgbImp._4_2_ = pl.rgbImp._4_2_ | (uint)lVar18;
                            pl.rgbImp._6_2_ = pl.rgbImp._6_2_ & 0xff7f | (uint)((ulong)lVar18 >> 0x10);
                            if (uVar7 != 0) {
                                pl.lpplprod = LpplAlloc(4, (uint) * (byte *)((int)&rgplr[0].zpq1 + 1 + iMax * 0xc0), htOrd);
                                _memset(&prod, 0, 4);
                                prod.dwFlags._2_2_ = prod.dwFlags._2_2_ & 0xfff1 | 2;
                                local_f8 = 0;
                                for (ipq = 0; ipq < (int)uVar7; ipq = ipq + 1) {
                                    sVar8 = GetRaceStat((PLAYER *)rgplr + iMax, rsMajorAdv);
                                    if ((sVar8 != raMacintosh) || (2 < (*(uint *)(iMax * 0xc0 + 0x59fa + ipq * 2) & 0x3f))) {
                                        sVar8 = GetRaceStat((PLAYER *)rgplr + iMax, rsMajorAdv);
                                        if ((sVar8 != raTerra) || (((*(uint *)(iMax * 0xc0 + 0x59fa + ipq * 2) & 0x3f) != 4 &&
                                                                    ((*(uint *)(iMax * 0xc0 + 0x59fa + ipq * 2) & 0x3f) != 5)))) {
                                            lVar18 = __aFlshl(CONCAT22(unaff_SI, unaff_DI), *(uint *)(iMax * 0xc0 + 0x59fa + ipq * 2) & 0x3f);
                                            prod.dwFlags._0_2_ = (uint)prod.dwFlags & 0x3ff | (uint)lVar18;
                                            prod.dwFlags._2_2_ = prod.dwFlags._2_2_ & 0xfffe | (uint)((ulong)lVar18 >> 0x10);
                                            in_stack_0000fefe = *(uint *)(iMax * 0xc0 + 0x59fa + ipq * 2) >> 6;
                                            in_stack_0000ff00 = 0;
                                            lVar18 = __aFlshl(CONCAT22(unaff_SI, unaff_DI), in_stack_0000fefe);
                                            prod.dwFlags._0_2_ = (uint)prod.dwFlags & 0xfc00 | (uint)lVar18;
                                            prod.dwFlags._2_2_ = prod.dwFlags._2_2_ | (uint)((ulong)lVar18 >> 0x10);
                                            ((PLPROD *)pl.lpplprod + local_f8 + 1)->wFlags = (uint)prod.dwFlags;
                                            *(uint *)&((PLPROD *)pl.lpplprod)[local_f8 + 1].iprodMax = prod.dwFlags._2_2_;
                                            local_f8 = local_f8 + 1;
                                        }
                                    }
                                }
                                if ((int)local_f8 < 1) {
                                    FreePl(pl.lpplprod);
                                    pl.lpplprod = 0;
                                } else {
                                    ((PLPROD *)pl.lpplprod)->iprodMac = (byte)local_f8;
                                    pPVar19 = LpplFromId(pl.id);
                                    uVar14 = (undefined2)((ulong)pPVar19 >> 0x10);
                                    *(PLPROD **)&((PLANET *)pPVar19)->lpplprod = (PLPROD *)pl.lpplprod;
                                    *(undefined2 *)((int)&((PLANET *)pPVar19)->lpplprod + 2) = pl.lpplprod._2_2_;
                                }
                            }
                        }
                        pl.iPlayer = iMax;
                        sVar8 = GetRaceStat((PLAYER *)rgplr + iMax, rsMajorAdv);
                        if (sVar8 == raMacintosh) {
                            pl.wFlags_0x4 = pl.wFlags_0x4 & 0xfdff | 0x200;
                            pl.lStarbase._0_2_ = (uint)pl.lStarbase & 0xfff0;
                            uVar5 = *(undefined4 *)(iMax * 4 + rglpshdefSB);
                            uVar14 = (undefined2)((ulong)uVar5 >> 0x10);
                            iVar11 = (int)uVar5;
                            puVar1 = (uint *)(iVar11 + 0x83);
                            uVar7 = *puVar1;
                            *puVar1 = *puVar1 + 1;
                            piVar2 = (int *)(iVar11 + 0x85);
                            *piVar2 = *piVar2 + (uint)(0xfffe < uVar7);
                            uVar5 = *(undefined4 *)(iMax * 4 + rglpshdefSB);
                            uVar14 = (undefined2)((ulong)uVar5 >> 0x10);
                            iVar11 = (int)uVar5;
                            puVar1 = (uint *)(iVar11 + 0x7f);
                            uVar7 = *puVar1;
                            *puVar1 = *puVar1 + 1;
                            piVar2 = (int *)(iVar11 + 0x81);
                            *piVar2 = *piVar2 + (uint)(0xfffe < uVar7);
                        }
                        if ((uVar20 == 0) || (((uint)cMax == 0 && (cMax._2_2_ == 0)))) {
                            uVar20 = CONCAT22(*(undefined2 *)((int)rgcCol + iMax * 4 + 2), (int)rgcCol[iMax]);
                        } else {
                            uVar16 = __aFulmul(CONCAT22(cMax._2_2_, (uint)cMax), uVar20 - lVar17);
                            uVar20 = __aFldiv(uVar16, uVar20);
                            uVar7 = (uint)cMax;
                            iVar11 = cMax._2_2_;
                            uVar20 = __aFulmul(CONCAT22(*(undefined2 *)((int)rgcCol + iMax * 4 + 2), (int)rgcCol[iMax]), uVar20);
                            uVar20 = __aFldiv(uVar20, CONCAT22(iVar11, uVar7));
                        }
                        if ((-1 < c2nd._2_2_) && ((0 < c2nd._2_2_ || ((uint)c2nd != 0)))) {
                            pl.rgwtMin[3] = uVar20;
                            uVar20 = __aFulmul(uVar20, CONCAT22((cMax._2_2_ - c2nd._2_2_) - (uint)((uint)cMax < (uint)c2nd), (uint)cMax - (uint)c2nd));
                            uVar20 = __aFldiv(uVar20, CONCAT22(cMax._2_2_, (uint)cMax));
                        }
                        if ((long)uVar20 < 1) {
                            uVar20 = 1;
                        }
                    }
                } else {
                    sVar8 = GetRaceStat((PLAYER *)rgplr + pl.iPlayer, rsMajorAdv);
                    if (sVar8 == raDefend) {
                        lPower._0_2_ = 200;
                    } else {
                        lPower._0_2_ = 100;
                    }
                    uVar22 = 0;
                    uVar14 = 100;
                    uVar16 = __aFulmul(pl.rgwtMin[3], (ulong)(uint)lPower);
                    lVar17 = __aFldiv(uVar16, CONCAT22(uVar22, uVar14));
                    if (lVar17 <= (long)uVar20) {
                        UninhabitPlanet(&pl);
                        goto LAB_10b8_3b02;
                    }
                    for (i = 0; i < 0x10; i = i + 1) {
                        if ((int)rgcCol[i] == 0) {
                            bVar15 = *(int *)((int)rgcCol + i * 4 + 2) == 0;
                            if (!bVar15)
                                goto code_r0x10b838ea;
                        } else {
                            bVar15 = false;
                        code_r0x10b838ea:
                            __aFfcompp();
                            if (bVar15) {
                                sVar21 = 0;
                                sVar6 = 0;
                                sVar9 = 0;
                                uVar7 = pl.iPlayer | 0x30;
                                sVar8 = pl.id;
                                uVar16 = __aFulshr(CONCAT22(pl.iPlayer, pl.id) | 0x300000, 0);
                                FSendPlrMsg(i, idmColonistsDroppedMassacredGroundTroops, pl.id, (short)rgcCol[i], (short)uVar16, sVar8, uVar7, sVar9, sVar6,
                                            sVar21);
                                sVar6 = 0;
                                sVar9 = 0;
                                sVar8 = 0;
                                uVar7 = i | 0x30;
                                uVar16 = __aFulshr((ulong)uVar7, 0);
                                FSendPlrMsg(pl.iPlayer, idmGroundTroopsValiantlyDestroyedAttackingBarbarian, pl.id, pl.id, (short)rgcCol[i], (short)uVar16,
                                            uVar7, sVar8, sVar9, sVar6);
                            } else {
                                sVar21 = 0;
                                sVar6 = 0;
                                uVar7 = pl.iPlayer | 0x30;
                                prod.dwFlags._0_2_ = 10000;
                                prod.dwFlags._2_2_ = 0;
                                lVar18 = __ftol((double)CONCAT26(unaff_DI, (uint6)uVar7));
                                sVar9 = (short)lVar18;
                                sVar8 = pl.id;
                                uVar16 = __aFulshr(CONCAT22(sVar9, pl.id), uVar7);
                                FSendPlrMsg(i, idmColonistsDroppedDestroyedPlanetaryDefensesRestMa, pl.id, (short)rgcCol[i], (short)uVar16, sVar8, sVar9, uVar7,
                                            sVar6, sVar21);
                                sVar6 = 0;
                                sVar9 = 0;
                                sVar8 = 0;
                                uVar7 = i | 0x30;
                                uVar16 = __aFulshr((ulong)uVar7, 0);
                                FSendPlrMsg(pl.iPlayer, idmPlanetaryDefensesGroundTroopsDestroyedInvadingTr, pl.id, pl.id, (short)rgcCol[i], (short)uVar16,
                                            uVar7, sVar8, sVar9, sVar6);
                            }
                        }
                    }
                    uVar20 = __aFulmul(pl.rgwtMin[3], uVar20);
                    lVar17 = __aFldiv(uVar20, lVar17);
                    uVar20 = pl.rgwtMin[3] - lVar17;
                }
                if (pl.iPlayer != -1) {
                    pl.rgwtMin[3] = uVar20;
                    uVar16 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), in_stack_0000fefe);
                    uVar20 = pl.rgwtMin[3];
                    if (((uVar16 & 1) != 0) && (pl.rgbImp._6_2_ = pl.rgbImp._6_2_ & 0xffbf, (game.wCrap >> 7 & 1) == 0)) {
                        sVar8 = Random(6);
                        sVar9 = Random(0x12d);
                        local_f8 = sVar9 + 100;
                        if (pl.rgwtMin[3] < 10) {
                            local_f8 = (int)((int)pl.rgwtMin[3] * local_f8) / 10;
                        }
                        FSendPlrMsg(pl.iPlayer, idmColonistsSettlingHaveFoundStrangeArtifactBoostin, -2, pl.id, sVar8, local_f8, 0, 0, 0, 0);
                        prod.dwFlags = (ulong)(int)local_f8;
                        puVar12 = (uint *)(pl.iPlayer * 0xc0 + 0x59c2 + sVar8 * 4);
                        puVar1 = puVar12;
                        uVar7 = *puVar1;
                        *puVar1 = *puVar1 + local_f8;
                        puVar1 = puVar12 + 1;
                        *puVar1 = *puVar1 + ((int)local_f8 >> 0xf) + (uint)CARRY2(uVar7, local_f8);
                        uVar20 = pl.rgwtMin[3];
                        if ((game.wCrap >> 1 & 1) == 0) {
                            prod.dwFlags = (long)(int)local_f8;
                        }
                    }
                }
                pl.rgwtMin[3] = uVar20;
                FLookupPlanet(-1, &pl);
            }
        TURN2_IncCur:
            lpcdCur = (COLDROP *)CONCAT22(uVar13, (COLDROP *)lpcdCur + 1);
        }
        cColDrop = 0;
    }
    return;
}

// ======================================================================
// Function: HealShips
// Address: 10b8:444c
// Segment: MEMORY_TURN2
// ======================================================================

void HealShips(void)

{
    uint      *puVar1;
    int        iVar2;
    int        iVar3;
    bool       bVar4;
    long       lVar5;
    short      sVar6;
    PLANET    *pPVar7;
    int        iVar8;
    undefined2 uVar9;
    PLANET    *pPVar10;
    HULDEF    *pHVar11;
    PLANET    *lpplMac;
    short      ishdef;
    short      pct;
    SHDEF     *lpshdef;
    FLEET     *lpfl;
    short      i;
    PLANET    *lppl;
    short      dpHeal;
    short      pctShipHeal;

    for (i = 0; i < cFleet; i = i + 1) {
        iVar2 = *(int *)((FLEET **)rglpfl + i);
        iVar3 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        if ((iVar2 == 0) && (iVar3 == 0))
            break;
        if (((*(uint *)(iVar2 + 4) >> 10 & 1) == 0) && ((*(uint *)(iVar2 + 4) >> 0xe & 1) == 0)) {
            bVar4 = false;
            pctShipHeal = 0;
            for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
                if (*(int *)(iVar2 + lpfnTutorDlgProc_0x2 + ishdef * 2) != 0) {
                    bVar4 = true;
                }
                if (*(int *)(iVar2 + 0xc + ishdef * 2) != 0) {
                    iVar8 = *(int *)(iVar2 + 2) * 4;
                    if (*(int *)(*(int *)(iVar8 + rglpshdef) + ishdef * 0x93) == 0x1a) {
                        pctShipHeal = 0x32;
                    } else if (((uint)pctShipHeal < 5) && (iVar8 = *(int *)(iVar2 + 2) * 4, *(int *)(*(int *)(iVar8 + rglpshdef) + ishdef * 0x93) == 0x19)) {
                        pctShipHeal = 0x19;
                    }
                }
            }
            if (bVar4) {
                if ((*(uint *)(iVar2 + 4) >> 0xd & 1) == 0) {
                    pct = 5;
                } else if (*(int *)(iVar2 + 6) == -1) {
                    pct = 10;
                } else {
                    pPVar10 = LpplFromId(*(short *)(iVar2 + 6));
                    uVar9 = (undefined2)((ulong)pPVar10 >> 0x10);
                    pPVar7 = (PLANET *)pPVar10;
                    if (pPVar7->iPlayer == *(int *)(iVar2 + 2)) {
                        if (((pPVar7->wFlags_0x4 >> 9 & 1) == 0) || ((*(uint *)((int)&pPVar7->lStarbase + 2) >> 0xe & 1) != 0)) {
                            pct = 0x19;
                        } else {
                            iVar8 = pPVar7->iPlayer * 4;
                            lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iVar8 + rglpshdefSB_0x2),
                                                        (SHDEF *)(*(int *)(iVar8 + rglpshdefSB) + (*(uint *)&pPVar7->lStarbase & 0xf) * 0x93));
                            pHVar11 = LphuldefFromId((lpshdef->hul).ihuldef);
                            if ((((HULDEF *)pHVar11)->hul).wtCargoMax == 0) {
                                pct = 0x28;
                            } else {
                                pct = 100;
                            }
                        }
                    } else if (pPVar7->iPlayer == -1) {
                        pct = 0xf;
                    } else {
                        pct = 0xf;
                    }
                }
                sVar6 = GetRaceStat((PLAYER *)rgplr + *(int *)(iVar2 + 2), rsMajorAdv);
                if (sVar6 == raDefend) {
                    pct = pct << 1;
                }
                for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
                    if (*(int *)(iVar2 + lpfnTutorDlgProc_0x2 + ishdef * 2) != 0) {
                        if ((uint)(pct + pctShipHeal) < *(uint *)(iVar2 + lpfnTutorDlgProc_0x2 + ishdef * 2) >> 7) {
                            iVar8 = *(int *)(iVar2 + lpfnTutorDlgProc_0x2 + ishdef * 2);
                            puVar1 = (uint *)(iVar2 + lpfnTutorDlgProc_0x2 + ishdef * 2);
                            *puVar1 = *puVar1 & 0x7f;
                            puVar1 = (uint *)(iVar2 + lpfnTutorDlgProc_0x2 + ishdef * 2);
                            *puVar1 = *puVar1 | iVar8 + (pct + pctShipHeal) * -0x80 & 0xff80U;
                        } else {
                            *(undefined2 *)(iVar2 + lpfnTutorDlgProc_0x2 + ishdef * 2) = 0;
                        }
                    }
                }
            }
        }
    }
    pPVar7 = (PLANET *)lpPlanets + cPlanet;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
    while ((PLANET *)lppl < pPVar7) {
        uVar9 = (undefined2)((ulong)lppl >> 0x10);
        if (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) && ((*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) >> 0xe & 1) == 0)) {
            sVar6 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lppl)->iPlayer, rsMajorAdv);
            if (sVar6 == raDefend) {
                pct = 0x4b;
            } else {
                pct = 0x32;
            }
            if (*(uint *)&((PLANET *)lppl)->lStarbase >> 4 != 0) {
                if (*(uint *)&((PLANET *)lppl)->lStarbase >> 4 < (uint)pct) {
                    *(uint *)&((PLANET *)lppl)->lStarbase = *(uint *)&((PLANET *)lppl)->lStarbase & 0xf;
                } else {
                    lVar5 = ((PLANET *)lppl)->lStarbase;
                    *(uint *)&((PLANET *)lppl)->lStarbase = *(uint *)&((PLANET *)lppl)->lStarbase & 0xf;
                    *(uint *)&((PLANET *)lppl)->lStarbase = *(uint *)&((PLANET *)lppl)->lStarbase | (int)lVar5 + pct * -0x10 & 0xfff0U;
                }
            }
        }
        lppl = (PLANET *)CONCAT22(uVar9, (PLANET *)lppl + 1);
    }
    return;
}

// ======================================================================
// Function: AutoTerraform
// Address: 10b8:48f6
// Segment: MEMORY_TURN2
// ======================================================================

void AutoTerraform(void)

{
    int        iVar1;
    bool       bVar2;
    short      sVar3;
    short      sVar4;
    PLANET    *pPVar5;
    undefined2 uVar6;
    PLANET    *lpplMac;
    short      fTerra;
    short      rgCost[3];
    short      rgMin[3];
    short      i;
    PLANET    *lppl;
    short      rgp[16];
    short      rgMax[3];

    bVar2 = false;
    for (i = 0; i < game.cPlayer; i = i + 1) {
        sVar3 = GetRaceStat((PLAYER *)rgplr + i, rsMajorAdv);
        rgp[i] = (uint)(sVar3 == raTerra);
        if (rgp[i] != 0) {
            bVar2 = true;
        }
    }
    if (bVar2) {
        pPVar5 = (PLANET *)lpPlanets + cPlanet;
        lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
        while ((PLANET *)lppl < pPVar5) {
            uVar6 = (undefined2)((ulong)lppl >> 0x10);
            if ((((PLANET *)lppl)->iPlayer != -1) && (rgp[((PLANET *)lppl)->iPlayer] != 0)) {
                if (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) && (((PLANET *)lppl)->iPlayer == -1)) {
                    ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfdff;
                }
                sVar3 = Random(3);
                if ((((*(char *)(((PLANET *)lppl)->iPlayer * 0xc0 + 0x59b2 + sVar3) != -1) &&
                      (*(char *)(((PLANET *)lppl)->iPlayer * 0xc0 + 0x59b2 + sVar3) != ((PLANET *)lppl)->rgEnvVarOrig[sVar3])) &&
                     (sVar4 = Random(10), sVar4 == 0)) &&
                    (((iVar1 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                       0 < iVar1 || ((-1 < iVar1 && (999 < *(uint *)(((PLANET *)lppl)->rgwtMin + 3))))) ||
                      (sVar4 = Random(1000), sVar4 < (int)((PLANET *)lppl)->rgwtMin[3])))) {
                    if (*(char *)(((PLANET *)lppl)->iPlayer * 0xc0 + 0x59b2 + sVar3) < ((PLANET *)lppl)->rgEnvVarOrig[sVar3]) {
                        ((PLANET *)lppl)->rgEnvVarOrig[sVar3] = ((PLANET *)lppl)->rgEnvVarOrig[sVar3] + -1;
                    } else {
                        ((PLANET *)lppl)->rgEnvVarOrig[sVar3] = ((PLANET *)lppl)->rgEnvVarOrig[sVar3] + '\x01';
                    }
                    FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmEngineersHaveManagedImproveUnderlying1, lppl->id, lppl->id, sVar3);
                }
                sVar3 = FCanTerraformLppl(lppl, rgMin, rgMax, rgCost, 1);
                if (sVar3 != 0) {
                    for (i = 0; i < 3; i = i + 1) {
                        if (rgMin[i] == -1) {
                            if (rgMax[i] != -1) {
                                ((PLANET *)lppl)->rgEnvVar[i] = (char)rgMax[i];
                            }
                        } else {
                            ((PLANET *)lppl)->rgEnvVar[i] = (char)rgMin[i];
                        }
                    }
                    sVar3 = PctPlanetDesirability(lppl, ((PLANET *)lppl)->iPlayer);
                    FSendPlrMsg2(((PLANET *)lppl)->iPlayer, idmHasAutoTerraformedValue, lppl->id, lppl->id, sVar3);
                }
            }
            lppl = (PLANET *)CONCAT22(uVar6, (PLANET *)lppl + 1);
        }
    }
    return;
}

// ======================================================================
// Function: RemoteTerraforming
// Address: 10b8:4c56
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b84d0f) */
/* WARNING: Removing unreachable block (ram,0x10b84df0) */

void RemoteTerraforming(void)

{
    FLEET     *pFVar1;
    int        iVar2;
    undefined2 uVar3;
    int        fHelp_00;
    short      p3;
    short      sVar4;
    int        iVar5;
    short      sVar6;
    int        iVar7;
    MessageId  iMsg;
    PLANET    *pPVar8;
    long       lVar9;
    short      pctNew;
    long       ipct;
    short      cAllowed;
    short      iEnv;
    short      cDone;
    FLEET     *lpfl;
    short      ifl;
    PLANET    *lppl;
    short      pctCur;
    short      iBest;
    short      fHelp;

    ifl = 0;
    while (true) {
        if (cFleet <= ifl) {
            return;
        }
        /* WARNING: Load size is inaccurate */
        pFVar1 = ((FLEET **)rglpfl)[ifl];
        iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar2, pFVar1);
        if ((pFVar1 == 0) && (iVar2 == 0))
            break;
        if (((((pFVar1->wFlags_0x4 >> 10 & 1) == 0) && (pFVar1->idPlanet != -1)) && (((PLANET *)lpPlanets)[pFVar1->idPlanet].iPlayer != -1)) &&
            (lVar9 = PctTerraFromLpfl((FLEET *)CONCAT22(iVar2, pFVar1)), uVar3 = lpPlanets._2_2_, 0 < lVar9)) {
            pPVar8 = (PLANET *)lpPlanets + pFVar1->idPlanet;
            lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, pPVar8);
            if (((pFVar1->iPlayer == pPVar8->iPlayer) || (*(char *)(pFVar1->iPlayer * 0xc0 + 0x5a12 + pPVar8->iPlayer) == '\x01')) ||
                (pFVar1->iPlayer == pPVar8->iPlayer)) {
                fHelp_00 = 1;
            } else {
                fHelp_00 = 0;
            }
            if ((fHelp_00 != 0) || ((pPVar8->wFlags_0x4 >> 9 & 1) == 0)) {
                p3 = PctPlanetDesirability((PLANET *)CONCAT22(lpPlanets._2_2_, pPVar8), pPVar8->iPlayer);
                while (true) {
                    ipct._2_2_ = (int)((ulong)lVar9 >> 0x10);
                    ipct._0_2_ = (int)lVar9;
                    if ((lVar9 < 1) || (sVar6 = IBestRemoteTerra((PLANET *)CONCAT22(uVar3, pPVar8), pFVar1->iPlayer, fHelp_00), sVar6 == 0))
                        break;
                    sVar4 = _abs(sVar6);
                    if (sVar6 < 1) {
                        iVar7 = -1;
                    } else {
                        iVar7 = 1;
                    }
                    iVar7 = (char)pPVar8->rgMinConc[sVar4 + 2] + iVar7;
                    iVar5 = iVar7;
                    if (99 < iVar7) {
                        iVar5 = 99;
                    }
                    if (iVar5 < 1) {
                        iVar7 = 1;
                    } else if (99 < iVar7) {
                        iVar7 = 99;
                    }
                    pPVar8->rgMinConc[sVar4 + 2] = (byte)iVar7;
                    lVar9 = CONCAT22(ipct._2_2_ - (uint)((int)ipct == 0), (int)ipct + -1);
                }
                sVar6 = PctPlanetDesirability((PLANET *)CONCAT22(uVar3, pPVar8), pPVar8->iPlayer);
                if (fHelp_00 == 0) {
                    iVar7 = 0x15a;
                } else {
                    iVar7 = 300;
                }
                FSendPlrMsg(pFVar1->iPlayer, iVar7 + (uint)(p3 == sVar6), lpfl->id | 0x8000, lpfl->id, lppl->id, p3, sVar6, 0, 0, 0);
                if ((pFVar1->iPlayer != pPVar8->iPlayer) && (sVar6 != p3)) {
                    if (fHelp_00 == 0) {
                        iMsg = idmHasDegradedValue;
                    } else {
                        iMsg = idmHasImprovedValue;
                    }
                    FSendPlrMsg(pPVar8->iPlayer, iMsg, lppl->id, lpfl->id, lppl->id, p3, sVar6, 0, 0, 0);
                }
            }
        }
        ifl = ifl + 1;
    }
    return;
}

// ======================================================================
// Function: FQueueColonistDrop
// Address: 10b8:4faa
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b84fc1) */

short FQueueColonistDrop(FLEET *lpfl, PLANET *lppl, long cColonists)

{
    uint    *puVar1;
    int     *piVar2;
    uint     uVar3;
    COLDROP *lpcdT;
    short    iColDrop;

    if (cColonists < 1) {
        cColonists._0_2_ = 1;
    } else {
        iColDrop = 0;
        lpcdT = (COLDROP *)CONCAT22(lpcd._2_2_, (COLDROP *)lpcd);
        while (true) {
            if ((cColDrop <= iColDrop) || ((lpcdT->idFleetSrc == lpfl->id && (((COLDROP *)lpcdT)->idPlanetDst == lppl->id))))
                break;
            lpcdT = (COLDROP *)lpcdT + 1;
            iColDrop = iColDrop + 1;
        }
        if (iColDrop == cColDrop) {
            if (999 < cColDrop) {
                return 0;
            }
            lpcdT->idFleetSrc = lpfl->id;
            ((COLDROP *)lpcdT)->idPlr = ((FLEET *)lpfl)->iPlayer;
            ((COLDROP *)lpcdT)->idPlanetDst = lppl->id;
            *(undefined2 *)&((COLDROP *)lpcdT)->cColonist = 0;
            *(undefined2 *)((int)&((COLDROP *)lpcdT)->cColonist + 2) = 0;
            ((COLDROP *)lpcdT)->wFlags_0x6 = ((COLDROP *)lpcdT)->wFlags_0x6 & 0xfffe | 1;
            cColDrop = cColDrop + 1;
        }
        puVar1 = (uint *)&((COLDROP *)lpcdT)->cColonist;
        uVar3 = *puVar1;
        *puVar1 = *puVar1 + (uint)cColonists;
        piVar2 = (int *)((int)&((COLDROP *)lpcdT)->cColonist + 2);
        *piVar2 = *piVar2 + cColonists._2_2_ + (uint)CARRY2(uVar3, (uint)cColonists);
    }
    return (uint)cColonists;
}

// ======================================================================
// Function: UpdatePopulations
// Address: 10b8:50a0
// Segment: MEMORY_TURN2
// ======================================================================

void UpdatePopulations(void)

{
    long       lVar1;
    short      sVar2;
    int        iVar3;
    PLANET    *pPVar4;
    ushort     unaff_DI;
    undefined2 uVar5;
    long       lVar6;
    ulong      uVar7;
    short      sVar8;
    ushort     p6;
    short      sVar9;
    short      p7;
    PLANET    *lpplMac;
    PLANET    *lppl;
    long       lPopChg;

    lVar6 = CONCAT22(lPopChg._2_2_, (undefined2)lPopChg);
    pPVar4 = (PLANET *)lpPlanets + cPlanet;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
    while ((PLANET *)lppl < pPVar4) {
        uVar5 = (undefined2)((ulong)lppl >> 0x10);
        if ((((PLANET *)lppl)->iPlayer != -1) && (((int)((PLANET *)lppl)->rgwtMin[3] != 0 || (*(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe) != 0)))) {
            lVar6 = ChgPopFromPlanet(lppl, 1);
            if ((lVar6 != 0) && ((((lVar6 < 0x10000 && (lVar6 < 0)) && (iVar3 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe), -1 < iVar3)) &&
                                  ((0 < iVar3 || ((int)((PLANET *)lppl)->rgwtMin[3] != 0)))))) {
                lVar1 = ((PLANET *)lppl)->rgwtMin[3];
                sVar2 = PctPlanetDesirability(lppl, ((PLANET *)lppl)->iPlayer);
                if (sVar2 < 0) {
                    sVar9 = 0;
                    p6 = 0;
                    uVar7 = __aFulshr(0, unaff_DI);
                    sVar8 = (short)uVar7;
                    sVar2 = (short)((PLANET *)lppl)->rgwtMin[3];
                    uVar7 = __aFulshr(CONCAT22(sVar8, sVar2), p6);
                    FSendPlrMsg(((PLANET *)lppl)->iPlayer, idmPopulationHasDecreased, lppl->id, lppl->id, (int)lVar1 - (int)lVar6, (short)uVar7, sVar2, sVar8,
                                p6, sVar9);
                } else {
                    p7 = 0;
                    sVar9 = 0;
                    sVar8 = 0;
                    sVar2 = 0;
                    uVar7 = __aFulshr(0, 0);
                    FSendPlrMsg(((PLANET *)lppl)->iPlayer, idmPopulationHasDecreasedColonistsDueOvercrowding, lppl->id, lppl->id, -(int)lVar6, (short)uVar7,
                                sVar2, sVar8, sVar9, p7);
                }
            }
        }
        lPopChg._2_2_ = (int)((ulong)lVar6 >> 0x10);
        if (((((PLANET *)lppl)->iPlayer != -1) && ((int)((PLANET *)lppl)->rgwtMin[3] == 0)) && (*(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe) == 0)) {
            sVar2 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lppl)->iPlayer, rsMajorAdv);
            if ((lPopChg._2_2_ < 1) && (lVar6 < 0)) {
                iVar3 = 0x23;
            } else {
                iVar3 = 0x40;
            }
            FSendPlrMsg2(((PLANET *)lppl)->iPlayer, iVar3 + (uint)(sVar2 == raMacintosh), lppl->id, lppl->id, 0);
            UninhabitPlanet(lppl);
        }
        if (((PLANET *)lppl)->iPlayer == -1) {
            UninhabitPlanet(lppl);
        }
        lppl = (PLANET *)CONCAT22(uVar5, (PLANET *)lppl + 1);
    }
    return;
}

// ======================================================================
// Function: UpdateGuesses
// Address: 10b8:532c
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b85499) */
/* WARNING: Removing unreachable block (ram,0x10b8541e) */
/* WARNING: Removing unreachable block (ram,0x10b85443) */
/* WARNING: Removing unreachable block (ram,0x10b8551f) */
/* WARNING: Removing unreachable block (ram,0x10b85543) */

void UpdateGuesses(void)

{
    int        iVar1;
    short      sVar2;
    PLANET    *pPVar3;
    PLANET    *pPVar4;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar5;
    long       lVar6;
    ushort     in_stack_0000ffe8;
    long       l;
    PLANET    *lpplMac;
    float      pct;
    PLANET    *lppl;

    pPVar3 = (PLANET *)lpPlanets + cPlanet;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
    while ((PLANET *)lppl < pPVar3) {
        uVar5 = (undefined2)((ulong)lppl >> 0x10);
        if (((int)((PLANET *)lppl)->rgwtMin[3] == 0) && (*(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe) == 0)) {
            ((PLANET *)lppl)->uGuesses = 0;
        } else {
            sVar2 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lppl)->iPlayer, rsMajorAdv);
            if (sVar2 == raMacintosh) {
                lVar6 = 0;
            } else {
                lVar6 = __aFlshr(CONCAT22(unaff_SI, unaff_DI), in_stack_0000ffe8);
                in_stack_0000ffe8 = Random((short)lVar6);
                __aFlshr(CONCAT22(unaff_SI, unaff_DI), in_stack_0000ffe8);
                lVar6 = __aFlshr(CONCAT22(unaff_SI, unaff_DI), in_stack_0000ffe8);
                if (lVar6 < 0xffb) {
                    if (lVar6 < 1) {
                        lVar6 = 1;
                    }
                } else {
                    lVar6 = 0xffa;
                }
            }
            l._0_2_ = (uint)lVar6;
            uVar5 = (undefined2)((ulong)lppl >> 0x10);
            pPVar4 = (PLANET *)lppl;
            pPVar4->uGuesses = pPVar4->uGuesses & 0xf000 | (uint)l & 0xfff;
            if ((*(uint *)(pPVar4->rgbImp + 4) & 0xfff) == 0) {
                pPVar4->uGuesses = pPVar4->uGuesses & 0xfff;
            } else {
                CalcPctSurvive(lppl, &pct, 0);
                lVar6 = __ftol((double)CONCAT26((uint)l, CONCAT24(in_stack_0000ffe8, CONCAT22(unaff_SI, unaff_DI))));
                iVar1 = -(uint)lVar6;
                lVar6 = __aFldiv(CONCAT22((-(uint)(100 < (uint)lVar6) - (int)((ulong)lVar6 >> 0x10)) + (uint)(0xfffb < iVar1 + 100U), iVar1 + 0x68), 6);
                l._0_2_ = (uint)lVar6;
                if (lVar6 < 1) {
                    l._0_2_ = 1;
                } else if (0xf < lVar6) {
                    l._0_2_ = 0xf;
                }
                uVar5 = (undefined2)((ulong)lppl >> 0x10);
                ((PLANET *)lppl)->uGuesses = ((PLANET *)lppl)->uGuesses & 0xfff | (uint)l << 0xc;
            }
        }
        lppl = (PLANET *)lppl + 1;
    }
    return;
}

// ======================================================================
// Function: MineMinerals
// Address: 10b8:55a4
// Segment: MEMORY_TURN2
// ======================================================================

void MineMinerals(void)

{
    undefined2 uVar1;
    PLANET    *pPVar2;
    PLANET    *lpplMac;
    PLANET    *lppl;
    long       rglQuan[3];

    uVar1 = lpPlanets._2_2_;
    pPVar2 = (PLANET *)lpPlanets + cPlanet;
    for (lppl._0_2_ = (PLANET *)lpPlanets; (PLANET *)lppl < pPVar2; lppl._0_2_ = (PLANET *)lppl + 1) {
        EstMineralsMined((PLANET *)CONCAT22(uVar1, (PLANET *)lppl), rglQuan, -1, 1);
    }
    return;
}

// ======================================================================
// Function: MeteorStrike
// Address: 10b8:560e
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Variable defined which should be unmapped: j */

void MeteorStrike(void)

{
    int       *piVar1;
    uint      *puVar2;
    uint       uVar3;
    byte       bVar4;
    undefined2 uVar5;
    short      sVar6;
    short      sVar7;
    short      sVar8;
    int        iVar9;
    uint       uVar10;
    PLANET    *pPVar11;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    ulong      uVar12;
    long       lVar13;
    short      iObj;
    undefined4 uVar14;
    undefined4 uVar15;
    long       lVar16;
    short      j;
    short      iConc;
    short      i;
    short      rgAffect[3];
    PLANET    *lppl;
    short      iSize;
    long       rgQuan[4];
    short      iT;
    short      rgEnv[3];

    lVar16 = CONCAT22(unaff_SI, unaff_DI);
    sVar6 = Random(0x14);
    if (sVar6 == 0) {
        sVar6 = Random(cPlanet);
        uVar5 = lpPlanets._2_2_;
        pPVar11 = (PLANET *)lpPlanets + sVar6;
        lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, pPVar11);
        if (((((pPVar11->iPlayer == -1) || (iVar9 = *(int *)((int)pPVar11->rgwtMin + 0xe), iVar9 < 0)) ||
              ((iVar9 < 1 && (*(uint *)(pPVar11->rgwtMin + 3) < 0x33)))) ||
             (0x13 < game.turn)) &&
            (9 < game.turn)) {
            sVar6 = Random(4);
            for (i = 0; i < 3; i = i + 1) {
                rgEnv[i] = i;
            }
            for (i = 0; i < 3; i = i + 1) {
                j = Random(3);
                sVar7 = rgEnv[i];
                rgEnv[i] = rgEnv[j];
                rgEnv[j] = sVar7;
            }
            for (i = 0; i < 3; i = i + 1) {
                rgAffect[i] = i;
                sVar7 = Random(0xfa);
                *(short *)(rgQuan + i) = sVar7 + 0x32;
                *(int *)((int)rgQuan + i * 4 + 2) = sVar7 + 0x32 >> 0xf;
            }
            for (i = 0; i < 2; i = i + 1) {
                sVar7 = Random(3 - i);
                j = sVar7 + i;
                sVar7 = rgAffect[i];
                rgAffect[i] = rgAffect[j];
                rgAffect[j] = sVar7;
            }
            for (i = 0; i < game.cPlayer; i = i + 1) {
                uVar15 = 0;
                uVar12 = (ulong)(uint)rgEnv[2];
                uVar14 = CONCAT22(rgEnv[1], rgEnv[0]);
                sVar7 = lppl->id;
                iObj = lppl->id;
                if ((i == pPVar11->iPlayer) && (sVar8 = GetRaceStat((PLAYER *)rgplr + i, rsMajorAdv), sVar8 != raMacintosh)) {
                    iVar9 = 0x87;
                } else {
                    iVar9 = 0x83;
                }
                FSendPlrMsg(i, iVar9 + sVar6, iObj, sVar7, (short)uVar14, (short)((ulong)uVar14 >> 0x10), (short)uVar12, (short)(uVar12 >> 0x10), (short)uVar15,
                            (short)((ulong)uVar15 >> 0x10));
            }
            if ((pPVar11->iPlayer != -1) && (sVar7 = GetRaceStat((PLAYER *)rgplr + pPVar11->iPlayer, rsMajorAdv), sVar7 != raMacintosh)) {
                lVar13 = 100;
                uVar12 = __aFulmul(CONCAT22(*(undefined2 *)((int)pPVar11->rgwtMin + 0xe), (int)pPVar11->rgwtMin[3]), (long)(sVar6 * 0x14 + 0x19));
                lVar13 = __aFldiv(uVar12, lVar13);
                puVar2 = (uint *)(pPVar11->rgwtMin + 3);
                uVar3 = *puVar2;
                *puVar2 = *puVar2 - (uint)lVar13;
                piVar1 = (int *)((int)pPVar11->rgwtMin + 0xe);
                *piVar1 = (*piVar1 - (int)((ulong)lVar13 >> 0x10)) - (uint)(uVar3 < (uint)lVar13);
            }
            for (i = 0; (i <= sVar6 && (i < 3)); i = i + 1) {
                sVar7 = Random(17000);
                uVar10 = sVar7 + 3000;
                iVar9 = rgAffect[i];
                puVar2 = (uint *)(rgQuan + iVar9);
                uVar3 = *puVar2;
                *puVar2 = *puVar2 + uVar10;
                piVar1 = (int *)((int)rgQuan + iVar9 * 4 + 2);
                *piVar1 = *piVar1 + ((int)uVar10 >> 0xf) + (uint)CARRY2(uVar3, uVar10);
                bVar4 = pPVar11->rgMinConc[rgAffect[i]];
                sVar7 = Random(0x32);
                iConc = (uint)bVar4 + sVar7 + 0x32;
                if (sVar6 == 3) {
                    sVar7 = Random(0xf);
                    iConc = iConc + sVar7 + 0xf;
                }
                if (200 < iConc) {
                    iConc = 200;
                }
                pPVar11->rgMinConc[rgAffect[i]] = (byte)iConc;
            }
            for (i = 0; i < 3; i = i + 1) {
                lVar13 = __aFlshr(lVar16, j);
                puVar2 = (uint *)(pPVar11->rgwtMin + i);
                uVar3 = *puVar2;
                *puVar2 = *puVar2 + (uint)lVar13;
                puVar2 = (uint *)((int)(pPVar11->rgwtMin + i) + 2);
                *puVar2 = *puVar2 + (int)((ulong)lVar13 >> 0x10) + (uint)CARRY2(uVar3, (uint)lVar13);
            }
            for (i = 0; (i < 3 && (i <= sVar6)); i = i + 1) {
                sVar7 = Random(3);
                iT = sVar7 + 3;
                if (sVar6 == 3) {
                    sVar7 = Random(3);
                    iT = iT + sVar7 + 3;
                }
                sVar7 = Random(2);
                if (sVar7 != 0) {
                    iT = -iT;
                }
                j = pPVar11->rgEnvVar[i] + iT;
                if (j < 1) {
                    j = 1;
                } else if (99 < j) {
                    j = 99;
                }
                pPVar11->rgEnvVar[i] = (char)j;
                j = pPVar11->rgEnvVarOrig[i] + iT;
                if (j < 1) {
                    j = 1;
                } else if (99 < j) {
                    j = 99;
                }
                pPVar11->rgEnvVarOrig[i] = (char)j;
            }
            TossNonAutoBuildItems(lppl);
        }
    }
    return;
}

// ======================================================================
// Function: TossNonAutoBuildItems
// Address: 10b8:5aec
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b85bac) */
/* WARNING: Removing unreachable block (ram,0x10b85b74) */
/* WARNING: Removing unreachable block (ram,0x10b85bb1) */
/* WARNING: Variable defined which should be unmapped: iSrc */

void TossNonAutoBuildItems(PLANET *lppl)

{
    undefined2  uVar1;
    undefined2  uVar2;
    undefined2  uVar3;
    PLANET     *pPVar4;
    undefined2 *puVar5;
    undefined2 *puVar6;
    undefined2  unaff_SI;
    undefined2  unaff_DI;
    undefined2  uVar7;
    ulong       uVar8;
    ulong       uVar9;
    short       iSrc;
    short       iDst;

    uVar9 = CONCAT22(unaff_SI, unaff_DI);
    uVar7 = (undefined2)((ulong)lppl >> 0x10);
    pPVar4 = (PLANET *)lppl;
    if ((*(int *)&pPVar4->lpplprod != 0) || (*(int *)((int)&pPVar4->lpplprod + 2) != 0)) {
        iDst = 0;
        for (iSrc = 0; iSrc < (int)(uint)((PLPROD *)pPVar4->lpplprod)->iprodMac; iSrc = iSrc + 1) {
            uVar8 = __aFulshr(uVar9, iSrc);
            if ((((uint)uVar8 & 7) == 1) && (uVar8 = __aFulshr(uVar9, iSrc), ((uint)uVar8 & 0x7f) < 7)) {
                if (iDst < iSrc) {
                    uVar1 = *(undefined2 *)((int)&pPVar4->lpplprod + 2);
                    puVar5 = (undefined2 *)(*(int *)&pPVar4->lpplprod + 4 + iSrc * 4);
                    uVar2 = puVar5[1];
                    uVar3 = *(undefined2 *)((int)&pPVar4->lpplprod + 2);
                    puVar6 = (undefined2 *)(*(int *)&pPVar4->lpplprod + 4 + iDst * 4);
                    *puVar6 = *puVar5;
                    puVar6[1] = uVar2;
                }
                iDst = iDst + 1;
            }
        }
        if (iDst < 1) {
            FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pPVar4->lpplprod + 2), *(PL **)&pPVar4->lpplprod));
            *(undefined2 *)&pPVar4->lpplprod = 0;
            *(undefined2 *)((int)&pPVar4->lpplprod + 2) = 0;
        } else {
            ((PLPROD *)pPVar4->lpplprod)->iprodMac = (byte)iDst;
        }
    }
    return;
}

// ======================================================================
// Function: PlanetaryClimateChange
// Address: 10b8:5c54
// Segment: MEMORY_TURN2
// ======================================================================

void PlanetaryClimateChange(void)

{
    int        iVar1;
    undefined2 uVar2;
    short      sVar3;
    short      sVar4;
    PLANET    *pPVar5;
    short      j;
    short      i;
    PLANET    *lppl;
    short      iT;

    sVar3 = Random(0x14);
    if (sVar3 == 0) {
        sVar3 = Random(cPlanet);
        uVar2 = lpPlanets._2_2_;
        pPVar5 = (PLANET *)lpPlanets + sVar3;
        lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, pPVar5);
        if ((((pPVar5->iPlayer == -1) || (iVar1 = *(int *)((int)pPVar5->rgwtMin + 0xe), iVar1 < 0)) ||
             ((iVar1 < 1 && (*(uint *)(pPVar5->rgwtMin + 3) < 0x33)))) ||
            (0x13 < game.turn)) {
            sVar3 = Random(3);
            if (pPVar5->iPlayer != -1) {
                FSendPlrMsg2(pPVar5->iPlayer, idmFundamentalChangesEnvironmentHavePermanentlyAlte, lppl->id, lppl->id, sVar3);
            }
            sVar4 = Random(3);
            iT = sVar4 + 3;
            if (iT == 3) {
                sVar4 = Random(3);
                iT = sVar4 + 6;
            }
            sVar4 = Random(2);
            if (sVar4 != 0) {
                iT = -iT;
            }
            j = pPVar5->rgEnvVar[sVar3] + iT;
            if (j < 1) {
                j = 1;
            } else if (99 < j) {
                j = 99;
            }
            pPVar5->rgEnvVar[sVar3] = (char)j;
            j = pPVar5->rgEnvVarOrig[sVar3] + iT;
            if (j < 1) {
                j = 1;
            } else if (99 < j) {
                j = 99;
            }
            pPVar5->rgEnvVarOrig[sVar3] = (char)j;
            TossNonAutoBuildItems((PLANET *)CONCAT22(uVar2, pPVar5));
        }
    }
    return;
}

// ======================================================================
// Function: DiscoverNewMinerals
// Address: 10b8:5e0c
// Segment: MEMORY_TURN2
// ======================================================================

void DiscoverNewMinerals(void)

{
    undefined2 uVar1;
    short      sVar2;
    short      sVar3;
    PLANET    *pPVar4;
    short      i;
    PLANET    *lppl;

    sVar2 = Random(0xf - game.mdSize);
    if (sVar2 == 0) {
        sVar2 = Random(cPlanet);
        uVar1 = lpPlanets._2_2_;
        pPVar4 = (PLANET *)lpPlanets + sVar2;
        lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, pPVar4);
        if (9 < game.turn) {
            sVar2 = Random(3);
            if (pPVar4->iPlayer != -1) {
                FSendPlrMsg(pPVar4->iPlayer, idmSurveyorsHaveDiscoveredPreviouslyUnknownDepositS, lppl->id, lppl->id, sVar2, 0, 0, 0, 0, 0);
            }
            if (pPVar4->rgMinConc[sVar2] < 0xb4) {
                sVar3 = Random(0xf);
                pPVar4->rgMinConc[sVar2] = pPVar4->rgMinConc[sVar2] + (char)sVar3 + '\x05';
            }
        }
    }
    return;
}

// ======================================================================
// Function: MysteryTrader
// Address: 10b8:5efa
// Segment: MEMORY_TURN2
// ======================================================================

void MysteryTrader(void)

{
    THING *pTVar1;
    short  sVar2;
    int    iVar3;
    THING *pTVar4;
    short  rgC[4];
    short  grbitTrader;
    THING *lpth;
    short  i;
    short  cRand;
    short  iSrc;

    if (0x27 < game.turn) {
        if (game.turn % 100 == 0x47) {
            cRand = 2;
        } else if (game.turn % 100 == 0x21) {
            cRand = 3;
        } else if ((game.turn & 0x7f) == 0x31) {
            cRand = 4;
        } else {
            if ((game.turn & 1) != 0) {
                return;
            }
            cRand = 7;
        }
        sVar2 = Random(cRand);
        if (sVar2 == 0) {
            pTVar4 = LpthNew(0, ithMysteryTrader);
            iVar3 = (int)((ulong)pTVar4 >> 0x10);
            pTVar1 = (THING *)pTVar4;
            if ((pTVar1 != 0) || (iVar3 != 0)) {
                sVar2 = Random(5);
                *(uint *)((int)&pTVar1->u_THING_0x0006 + 4) = *(uint *)((int)&pTVar1->u_THING_0x0006 + 4) & 0xfff0 | sVar2 + 8U & 0xf;
                for (i = 0; i < 4; i = i + 2) {
                    sVar2 = Random(game.mdSize * 400 + 0x169);
                    rgC[i] = sVar2 + 0x3fc;
                }
                sVar2 = Random(2);
                if (sVar2 == 0) {
                    rgC[1] = 0x3fc;
                    rgC[3] = game.mdSize * 400 + 0x564;
                } else {
                    rgC[1] = game.mdSize * 400 + 0x564;
                    rgC[3] = 0x3fc;
                }
                sVar2 = Random(2);
                (&pTVar1->pt)->x = rgC[sVar2];
                (pTVar1->pt).y = rgC[sVar2 == 0];
                *&pTVar1->u_THING_0x0006 = rgC[sVar2 + 2];
                *(short *)((int)&pTVar1->u_THING_0x0006 + 2) = rgC[(sVar2 == 0) + 2];
                if (game.turn < 100) {
                    cRand = 5;
                } else if (game.turn < 0xfa) {
                    cRand = 3;
                } else {
                    cRand = 2;
                }
                if ((*(uint *)((int)&pTVar1->u_THING_0x0006 + 4) & 0xf) < 10) {
                    cRand = cRand + 1;
                } else if (10 < (*(uint *)((int)&pTVar1->u_THING_0x0006 + 4) & 0xf)) {
                    cRand = cRand + -1;
                }
                sVar2 = Random(10);
                if (sVar2 < cRand) {
                    sVar2 = Random(6);
                    if (sVar2 == 0) {
                        *(undefined2 *)((int)&pTVar1->u_THING_0x0006 + 8) = 0x1000;
                    } else {
                        *(undefined2 *)((int)&pTVar1->u_THING_0x0006 + 8) = 0;
                    }
                } else {
                    sVar2 = Random(0xd);
                    grbitTrader = 1 << ((byte)sVar2 & 0x1f);
                    if ((((grbitTrader == 0x40) || (grbitTrader == 0x80)) || (grbitTrader == 0x400)) || (grbitTrader == 0x800)) {
                        sVar2 = Random(0xd);
                        grbitTrader = 1 << ((byte)sVar2 & 0x1f);
                        if (((((game.turn < 0x78) && (grbitTrader == 0x80)) || ((game.turn < 0x96 && (grbitTrader == 0x400)))) ||
                             ((game.turn < 0xb4 && (grbitTrader == 0x800)))) &&
                            (sVar2 = Random(2), sVar2 != 0)) {
                            grbitTrader = 0;
                        }
                    }
                    *(short *)((int)&pTVar1->u_THING_0x0006 + 8) = grbitTrader;
                }
                for (i = 0; i < game.cPlayer; i = i + 1) {
                    FSendPlrMsg2(i, idmMysteriousTradingVesselBroadcastingProposalHasDe, -6, pTVar4->idFull, 0);
                }
            }
        }
    }
    return;
}

// ======================================================================
// Function: UpdatePlayerScores
// Address: 10b8:6258
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b86ba8) */

void UpdatePlayerScores(void)

{
    int       *piVar1;
    SCORE     *pSVar2;
    SCORE     *pSVar3;
    char       cVar4;
    int        iVar5;
    undefined2 uVar6;
    short      sVar7;
    uint       uVar8;
    short      sVar9;
    uint       uVar10;
    int        iVar11;
    undefined2 unaff_SI;
    SCORE     *pSVar12;
    undefined2 unaff_DI;
    SCORE     *pSVar13;
    long       lVar14;
    ulong      uVar15;
    long       lVar16;
    uint       in_stack_0000ff76;
    long       lScoreMax;
    long       lScore2nd;
    short      imsg;
    ushort     wWinners;
    short      j;
    short      iScoreMax;
    long       rglScore[16];
    ushort     wWinners2;
    byte       rgcCond[16];
    short      i;
    short      c;
    short      cDead;
    SCORE      score;
    short      cFirst;
    long       lScoreTot;

    lVar16 = CONCAT22(unaff_SI, unaff_DI);
    cDead = 0;
    cFirst = 0;
    iScoreMax = 0;
    lScore2nd._0_2_ = 0;
    lScore2nd._2_2_ = 0;
    gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffe;
    _memset(rgcCond, 0, 0x10);
    for (i = 0; i < game.cPlayer; i = i + 1) {
        lVar14 = CalcPlayerScore(i, &score);
        *(int *)(rglScore + i) = (int)lVar14;
        *(undefined2 *)((int)rglScore + i * 4 + 2) = (int)((ulong)lVar14 >> 0x10);
        uVar6 = vlprgScoreX._2_2_;
        pSVar13 = &((SCOREX *)vlprgScoreX)[i].score;
        pSVar12 = &score;
        for (iVar11 = 10; iVar11 != 0; iVar11 = iVar11 + -1) {
            pSVar3 = pSVar13;
            pSVar13 = (SCORE *)((int)&pSVar13->lScore + 2);
            pSVar2 = pSVar12;
            pSVar12 = (SCORE *)((int)&pSVar12->lScore + 2);
            *&pSVar3->lScore = (int)pSVar2->lScore;
        }
        ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xffe0 | i & 0x1fU;
        ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xffdf | 0x20;
        ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xc03f;
        if ((((score.cPlanet == 0) && (score.rgcsh[0] == 0)) && (score.rgcsh[1] == 0)) &&
            ((score.rgcsh[2] == 0 && ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0)))) {
            *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) = *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xfffe | 1;
            for (j = 0; j < game.cPlayer; j = j + 1) {
                if (j != i) {
                    FSendPrependedPlrMsg(j, idmTracesHaveEliminatedGalaxyMayRestPeace, -4, i | 0x30, 0, 0, 0, 0, 0, 0);
                }
            }
        }
        sVar9 = cPlanet;
        sVar7 = GetVCVal((GAME *)&game, 0, 0);
        sVar9 = MulDiv(sVar9, sVar7, 100);
        if (sVar9 <= score.cPlanet) {
            in_stack_0000ff76 = ((SCOREX *)vlprgScoreX + i)->wWord & 0x3fc0 | 0x40;
            ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xc03f;
            ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord | in_stack_0000ff76;
            sVar9 = GetVCCheck((GAME *)&game, 0);
            if (sVar9 != 0) {
                rgcCond[i] = rgcCond[i] + 1;
            }
        }
        lVar14 = __aFlshl(lVar16, in_stack_0000ff76);
        iVar11 = (int)((ulong)lVar14 >> 0x10);
        uVar10 = (uint)lVar14;
        uVar8 = GetVCVal((GAME *)&game, 6, 0);
        if (((int)uVar8 >> 0xf <= iVar11) && (((int)uVar8 >> 0xf < iVar11 || (uVar8 <= uVar10)))) {
            uVar10 = ((SCOREX *)vlprgScoreX + i)->wWord;
            ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xc03f;
            ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord | uVar10 & 0x3fc0 | 0x800;
            sVar9 = GetVCCheck((GAME *)&game, 6);
            if (sVar9 != 0) {
                rgcCond[i] = rgcCond[i] + 1;
            }
        }
        uVar10 = GetVCVal((GAME *)&game, 3, 0);
        iVar11 = *(int *)((int)rglScore + i * 4 + 2);
        if (((int)uVar10 >> 0xf <= iVar11) && (((int)uVar10 >> 0xf < iVar11 || (uVar10 <= *(uint *)(rglScore + i))))) {
            uVar10 = ((SCOREX *)vlprgScoreX + i)->wWord;
            ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xc03f;
            ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord | uVar10 & 0x3fc0 | 0x100;
            sVar9 = GetVCCheck((GAME *)&game, 3);
            if (sVar9 != 0) {
                rgcCond[i] = rgcCond[i] + 1;
            }
        }
        c = 0;
        for (j = 0; j < 6; j = j + 1) {
            cVar4 = *(char *)(i * 0xc0 + 0x59bc + j);
            sVar9 = GetVCVal((GAME *)&game, 1, 0);
            if (sVar9 <= cVar4) {
                c = c + 1;
            }
        }
        sVar9 = GetVCVal((GAME *)&game, 2, 0);
        if (sVar9 <= c) {
            uVar10 = ((SCOREX *)vlprgScoreX + i)->wWord;
            ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xc03f;
            ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord | uVar10 & 0x3fc0 | 0x80;
            sVar9 = GetVCCheck((GAME *)&game, 1);
            if (sVar9 != 0) {
                rgcCond[i] = rgcCond[i] + 1;
            }
        }
        lVar14 = __aFldiv(CONCAT22(score.cResources._2_2_, (undefined2)score.cResources), 1000);
        iVar11 = (int)((ulong)lVar14 >> 0x10);
        in_stack_0000ff76 = (uint)lVar14;
        uVar10 = GetVCVal((GAME *)&game, 5, 0);
        if (((int)uVar10 >> 0xf <= iVar11) && (((int)uVar10 >> 0xf < iVar11 || (uVar10 <= in_stack_0000ff76)))) {
            in_stack_0000ff76 = ((SCOREX *)vlprgScoreX + i)->wWord & 0x3fc0 | 0x400;
            ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xc03f;
            ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord | in_stack_0000ff76;
            sVar9 = GetVCCheck((GAME *)&game, 5);
            if (sVar9 != 0) {
                rgcCond[i] = rgcCond[i] + 1;
            }
        }
    }
    if (game.cPlayer == 1) {
        (&((SCOREX *)vlprgScoreX)->u_SCOREX_0x0002)->iRank = 1;
    } else {
        for (i = 0; i < game.cPlayer; i = i + 1) {
            if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0) {
                cDead = cDead + 1;
            }
            *(undefined2 *)((int)&rgplr[0].wScore + i * 0xc0) = 1;
            for (j = 0; j < game.cPlayer; j = j + 1) {
                iVar11 = *(int *)((int)rglScore + i * 4 + 2);
                iVar5 = *(int *)((int)rglScore + j * 4 + 2);
                if ((iVar11 <= iVar5) && ((iVar11 < iVar5 || (*(uint *)(rglScore + i) < *(uint *)(rglScore + j))))) {
                    piVar1 = (int *)((int)&rgplr[0].wScore + i * 0xc0);
                    *piVar1 = *piVar1 + 1;
                }
            }
            if (*(int *)((int)&rgplr[0].wScore + i * 0xc0) == 1) {
                iScoreMax = i;
                lScoreMax._0_2_ = (undefined2)rglScore[i];
                lScoreMax._2_2_ = *(undefined2 *)((int)rglScore + i * 4 + 2);
                cFirst = cFirst + 1;
            } else if (*(int *)((int)&rgplr[0].wScore + i * 0xc0) == 2) {
                lScore2nd._0_2_ = (undefined2)rglScore[i];
                lScore2nd._2_2_ = *(undefined2 *)((int)rglScore + i * 4 + 2);
            }
        }
        if (1 < cFirst) {
            lScore2nd._0_2_ = (undefined2)lScoreMax;
            lScore2nd._2_2_ = lScoreMax._2_2_;
        }
        for (i = 0; i < game.cPlayer; i = i + 1) {
            ((SCOREX *)vlprgScoreX)[i].u_SCOREX_0x0002 = *(u_SCOREX_0x0002 *)((int)&rgplr[0].wScore + i * 0xc0);
        }
        sVar9 = GetVCVal((GAME *)&game, 7, 0);
        if ((sVar9 <= (int)game.turn) && (cFirst == 1)) {
            uVar10 = ((SCOREX *)vlprgScoreX + iScoreMax)->wWord;
            ((SCOREX *)vlprgScoreX + iScoreMax)->wWord = ((SCOREX *)vlprgScoreX + iScoreMax)->wWord & 0xc03f;
            ((SCOREX *)vlprgScoreX + iScoreMax)->wWord = ((SCOREX *)vlprgScoreX + iScoreMax)->wWord | uVar10 & 0x3fc0 | 0x1000;
            sVar9 = GetVCCheck((GAME *)&game, 7);
            if (sVar9 != 0) {
                rgcCond[iScoreMax] = rgcCond[iScoreMax] + 1;
            }
        }
        if (cDead + 1 < game.cPlayer) {
            lVar16 = 100;
            sVar9 = GetVCVal((GAME *)&game, 4, 0);
            uVar15 = __aFulmul(CONCAT22(lScore2nd._2_2_, (undefined2)lScore2nd), (long)(sVar9 + 100));
            lVar16 = __aFldiv(uVar15, lVar16);
            if (lVar16 <= CONCAT22(lScoreMax._2_2_, (undefined2)lScoreMax)) {
                uVar10 = ((SCOREX *)vlprgScoreX + iScoreMax)->wWord;
                ((SCOREX *)vlprgScoreX + iScoreMax)->wWord = ((SCOREX *)vlprgScoreX + iScoreMax)->wWord & 0xc03f;
                ((SCOREX *)vlprgScoreX + iScoreMax)->wWord = ((SCOREX *)vlprgScoreX + iScoreMax)->wWord | uVar10 & 0x3fc0 | 0x200;
                sVar9 = GetVCCheck((GAME *)&game, 4);
                if (sVar9 != 0) {
                    rgcCond[iScoreMax] = rgcCond[iScoreMax] + 1;
                }
            }
            uVar10 = GetVCVal((GAME *)&game, 9, 0);
            if (uVar10 <= game.turn) {
                wWinners = 0;
                sVar9 = GetVCVal((GAME *)&game, 8, 0);
                iVar11 = game.cPlayer;
                if (0 < sVar9) {
                    while (i = iVar11 + -1, -1 < i) {
                        wWinners = wWinners << 1;
                        iVar5 = iVar11 + -1;
                        iVar11 = i;
                        if (sVar9 <= (int)(uint)rgcCond[iVar5]) {
                            ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xbfff | 0x4000;
                            wWinners = wWinners | 1;
                        }
                    }
                    if (wWinners != 0) {
                        gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffe | 1;
                    }
                }
                if ((gd.grBits._2_2_ & 1) != 0) {
                    j = 1;
                    for (i = 0; i < game.cPlayer; i = i + 1) {
                        wWinners2 = wWinners;
                        if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0) {
                            if ((j & wWinners) == 0) {
                                imsg = 0xb5;
                            } else if (j == wWinners) {
                                imsg = 0xb6;
                            } else {
                                imsg = 0xb7;
                                wWinners2 = wWinners & ~j;
                            }
                        } else {
                            imsg = 0xb8;
                        }
                        FSendPrependedPlrMsg(i, imsg, -4, wWinners2, 0, 0, 0, 0, 0, 0);
                        j = j << 1;
                    }
                }
            }
        } else {
            gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffe | 1;
            if ((*(uint *)((int)&rgplr[0].wFlags + iScoreMax * 0xc0) & 1) == 0) {
                FSendPrependedPlrMsg(iScoreMax, idmTracesEveryOtherRivalHaveEliminatedGalaxy, -4, 0, 0, 0, 0, 0, 0, 0);
            }
            for (i = 0; i < game.cPlayer; i = i + 1) {
                if (i != iScoreMax) {
                    FSendPrependedPlrMsg(i, idmDeadPlanetsHaveOverrunSpaceshipsDefeated, -4, 0, 0, 0, 0, 0, 0, 0);
                }
            }
        }
    }
    return;
}

// ======================================================================
// Function: CreateBackupDir
// Address: 10b8:6dca
// Segment: MEMORY_TURN2
// ======================================================================

void CreateBackupDir(void)

{
    char *pcVar1;
    char *pchT;

    _strcpy((char *)szBackup, (char *)szBase);
    pcVar1 = _strrchr((char *)szBackup, 0x5c);
    if (pcVar1 == 0) {
        pchT = (char *)szBackup;
    } else {
        pchT = pcVar1 + 1;
    }
    *pchT = '\0';
    if (vcBackupDirs < 2) {
        _strcpy(pchT, (char *)"backup");
    } else if (vcBackupDirs < 100) {
        _wsprintf(pchT, "backup%d", game.turn % (uint)vcBackupDirs);
    } else {
        _wsprintf(pchT, "backup.%03d", game.turn % (uint)vcBackupDirs);
    }
    __mkdir((char *)szBackup);
    _strcat((char *)szBackup, (char *)0x9fc);
    return;
}

// ======================================================================
// Function: FPacketDecay
// Address: 10b8:6e9c
// Segment: MEMORY_TURN2
// ======================================================================

short FPacketDecay(THING *lpth, short pctRate)

{
    uint       uVar1;
    short      sVar2;
    THING     *pTVar3;
    undefined2 uVar4;
    bool       bVar5;
    ulong      uVar6;
    long       lVar7;
    ulong      uVar8;
    long       lDecay;
    ushort     wDecay;
    short      i;
    short      iRate;
    ushort     iRateMin;

    uVar4 = (undefined2)((ulong)lpth >> 0x10);
    pTVar3 = (THING *)lpth;
    if (*(uint *)((int)&pTVar3->u_THING_0x0006 + 8) >> 0xe == 0) {
        sVar2 = 0;
    } else {
        uVar1 = *(uint *)((int)&pTVar3->u_THING_0x0006 + 8) >> 0xe;
        if (uVar1 == 1) {
            iRate = 10;
        } else if (uVar1 == 2) {
            iRate = 0x19;
        } else if (uVar1 == 3) {
            iRate = 0x32;
        }
        sVar2 = GetRaceStat((PLAYER *)rgplr + (lpth->idFull >> 9 & 0xf), rsMajorAdv);
        if (sVar2 == raMassAccel) {
            iRate = iRate / 2;
            iRateMin = 5;
        } else {
            iRateMin = 10;
        }
        lDecay._0_2_ = 0;
        lDecay._2_2_ = 0;
        for (i = 0; i < 3; i = i + 1) {
            if (*(int *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2) != 0) {
                lVar7 = 10000;
                uVar8 = (ulong)pctRate;
                uVar6 = __aFulmul((long)*(int *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2), (long)iRate);
                uVar6 = __aFulmul(uVar6, uVar8);
                lVar7 = __aFldiv(uVar6, lVar7);
                wDecay = iRateMin;
                if (iRateMin <= (uint)lVar7) {
                    wDecay = (uint)lVar7;
                }
                if (*(int *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2) <= (int)wDecay) {
                    wDecay = *(ushort *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2);
                }
                *(ushort *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2) = *(int *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2) - wDecay;
                uVar1 = *(uint *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2);
                bVar5 = CARRY2((uint)lDecay, uVar1);
                lDecay._0_2_ = (uint)lDecay + uVar1;
                lDecay._2_2_ = lDecay._2_2_ + ((int)uVar1 >> 0xf) + (uint)bVar5;
            }
        }
        if (((uint)lDecay == 0) && (lDecay._2_2_ == 0)) {
            FreeLpth(lpth);
            sVar2 = 1;
        } else {
            lVar7 = __aFldiv(CONCAT22(lDecay._2_2_ + (uint)(0xfff6 < (uint)lDecay), (uint)lDecay + 9), 10);
            *(uint *)((int)&pTVar3->u_THING_0x0006 + 8) = *(uint *)((int)&pTVar3->u_THING_0x0006 + 8) & 0xc000 | (uint)lVar7 & 0x3fff;
            sVar2 = 0;
        }
    }
    return sVar2;
}

// ======================================================================
// Function: ThingDecay
// Address: 10b8:70c6
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b87483) */
/* WARNING: Removing unreachable block (ram,0x10b8757f) */
/* WARNING: Removing unreachable block (ram,0x10b875b8) */
/* WARNING: Removing unreachable block (ram,0x10b875ed) */

void ThingDecay(void)

{
    u_THING_0x0006 *puVar1;
    int            *piVar2;
    uint            uVar3;
    ushort          uVar4;
    FLEET          *pFVar5;
    POINT           pt;
    int             iVar6;
    short           sVar7;
    int             iVar8;
    int             iVar9;
    short           sVar10;
    undefined2      uVar11;
    bool            bVar12;
    ulong           uVar13;
    ulong           uVar14;
    long            lVar15;
    undefined2      uVar16;
    undefined2      uVar17;
    long            dx;
    long            dy;
    short           fMineExpert;
    long            lDecay;
    ushort          wDecay;
    THING          *lpth;
    FLEET          *lpfl;
    short           ifl;
    short           i;
    long            pctDecay;
    THING          *lpthMac;

    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
        iVar6 = *(int *)((FLEET **)rglpfl + ifl);
        iVar8 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        if ((iVar6 == 0) && (iVar8 == 0))
            break;
        *(uint *)(iVar6 + 4) = *(uint *)(iVar6 + 4) & 0xefff;
    }
    lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
    lpthMac._0_2_ = (THING *)lpThings + cThing;
    do {
        if ((THING *)lpthMac <= (THING *)lpth) {
            return;
        }
        uVar11 = (undefined2)((ulong)lpth >> 0x10);
        if (lpth->idFull >> 0xd == 1) {
            if ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) == 0) {
                if ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 0xe & 1) == 0) {
                    lDecay._0_2_ = 0;
                    lDecay._2_2_ = 0;
                    for (i = 0; i < 3; i = i + 1) {
                        if (*(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) != 0) {
                            if (*(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) / 10 < 10) {
                                iVar6 = 10;
                            } else {
                                iVar6 = *(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) / 10;
                            }
                            *(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) = *(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) - iVar6;
                            if (*(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) < 0) {
                                ((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2)[0] = 0;
                                ((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2)[1] = 0;
                            }
                            uVar3 = *(uint *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2);
                            bVar12 = CARRY2((uint)lDecay, uVar3);
                            lDecay._0_2_ = (uint)lDecay + uVar3;
                            lDecay._2_2_ = lDecay._2_2_ + ((int)uVar3 >> 0xf) + (uint)bVar12;
                        }
                    }
                    if (((uint)lDecay == 0) && (lDecay._2_2_ == 0)) {
                        FreeLpth(lpth);
                        goto TURN2_LFixUpLpth;
                    }
                    lVar15 = __aFldiv(CONCAT22(lDecay._2_2_ + (uint)(0xfff6 < (uint)lDecay), (uint)lDecay + 9), 10);
                    *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) =
                        *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) & 0xc000 | (uint)lVar15 & 0x3fff;
                } else {
                    ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0xbfff;
                }
            } else {
                sVar7 = FPacketDecay(lpth, 100);
                if (sVar7 != 0) {
                TURN2_LFixUpLpth:
                    lpth = (THING *)CONCAT22(uVar11, (THING *)lpth + -1);
                    lpthMac._0_2_ = (THING *)lpthMac + -1;
                }
            }
        } else if (lpth->idFull >> 0xd == 0) {
            sVar7 = GetRaceStat((PLAYER *)rgplr + (lpth->idFull >> 9 & 0xf), rsMajorAdv);
            if (*(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 7) != '\0') {
                uVar4 = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags;
                uVar16 = *(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
                for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
                    pFVar5 = ((FLEET **)rglpfl)[ifl];
                    iVar6 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                    if ((pFVar5 == 0) && (iVar6 == 0))
                        break;
                    if ((pFVar5->wFlags_0x4 >> 10 & 1) == 0) {
                        iVar8 = (&pFVar5->pt)->x - (&((THING *)lpth)->pt)->x;
                        iVar9 = (pFVar5->pt).y - (((THING *)lpth)->pt).y;
                        if ((pFVar5->wFlags_0x4 >> 0xc & 1) == 0) {
                            uVar14 = __aFulmul((long)iVar9, (long)iVar9);
                            uVar13 = __aFulmul((long)iVar8, (long)iVar8);
                            if ((long)(uVar13 + uVar14) <= CONCAT22(uVar16, uVar4)) {
                                FTravelThroughMineFields((FLEET *)CONCAT22(iVar6, pFVar5), 0, lpth);
                                pFVar5->wFlags_0x4 = pFVar5->wFlags_0x4 & 0xefff | 0x1000;
                            }
                        }
                    }
                }
            }
            pt.y = (((THING *)lpth)->pt).y;
            pt.x = (&((THING *)lpth)->pt)->x;
            sVar10 =
                CPlanetsInCircle(pt, CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2), ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags));
            pctDecay._0_2_ = ((uint)(sVar7 != raMines) * 3 + 1) * sVar10 + 2;
            pctDecay._2_2_ = (int)(uint)pctDecay >> 0xf;
            if ((-1 < pctDecay._2_2_) && ((0 < pctDecay._2_2_ || (0x32 < (uint)pctDecay)))) {
                pctDecay._0_2_ = 0x32;
                pctDecay._2_2_ = 0;
            }
            if (*(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 7) != '\0') {
                bVar12 = 0xffe6 < (uint)pctDecay;
                pctDecay._0_2_ = (uint)pctDecay + 0x19;
                pctDecay._2_2_ = pctDecay._2_2_ + (uint)bVar12;
            }
            uVar17 = 0;
            uVar16 = 100;
            uVar14 = __aFulmul(CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2), ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags),
                               CONCAT22(pctDecay._2_2_, (uint)pctDecay));
            lVar15 = __aFldiv(uVar14, CONCAT22(uVar17, uVar16));
            if (lVar15 < (long)CONCAT22(pctDecay._2_2_, (uint)pctDecay)) {
                lVar15 = CONCAT22(pctDecay._2_2_, (uint)pctDecay);
            }
            if ((*(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 6) != '\x02') && (lVar15 < 10)) {
                lVar15 = 10;
            }
            lDecay._2_2_ = (int)((ulong)lVar15 >> 0x10);
            lDecay._0_2_ = (uint)lVar15;
            if (lVar15 < CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2), ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags)) {
                puVar1 = &((THING *)lpth)->u_THING_0x0006;
                uVar3 = (puVar1->thp).wFlags;
                (puVar1->thp).wFlags = (puVar1->thp).wFlags - (uint)lDecay;
                piVar2 = (int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
                *piVar2 = (*piVar2 - lDecay._2_2_) - (uint)(uVar3 < (uint)lDecay);
            } else {
                FreeLpth(lpth);
                lpth = (THING *)CONCAT22(uVar11, (THING *)lpth + -1);
                lpthMac._0_2_ = (THING *)lpthMac + -1;
            }
        }
        lpth = (THING *)lpth + 1;
    } while (true);
}

// ======================================================================
// Function: UnmarkMineFields
// Address: 10b8:7638
// Segment: MEMORY_TURN2
// ======================================================================

void UnmarkMineFields(void)

{
    THING *pTVar1;
    THING *lpth;
    THING *lpthMac;

    pTVar1 = (THING *)lpThings + cThing;
    lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
    while ((THING *)lpth < pTVar1) {
        if (lpth->idFull >> 0xd == 0) {
            *(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) = 0;
        }
        lpth = (THING *)lpth + 1;
    }
    return;
}

// ======================================================================
// Function: SweepForMines
// Address: 10b8:76a4
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b87af0) */
/* WARNING: Removing unreachable block (ram,0x10b87716) */
/* WARNING: Removing unreachable block (ram,0x10b878a0) */
/* WARNING: Removing unreachable block (ram,0x10b87c85) */
/* WARNING: Removing unreachable block (ram,0x10b878dc) */
/* WARNING: Removing unreachable block (ram,0x10b87cc1) */
/* WARNING: Removing unreachable block (ram,0x10b87918) */
/* WARNING: Removing unreachable block (ram,0x10b87cfd) */

void SweepForMines(void)

{
    u_THING_0x0006 *puVar1;
    int            *piVar2;
    uint           *puVar3;
    byte            bVar4;
    FLEET          *pFVar5;
    uint            uVar6;
    int             iVar7;
    long            lVar8;
    short           sVar9;
    int             iVar10;
    int             iVar11;
    int             iVar12;
    uint            uVar13;
    uint            uVar14;
    uint            uVar15;
    PLANET         *pPVar16;
    int             iVar17;
    undefined2      uVar18;
    undefined2      uVar19;
    long            lVar20;
    ulong           uVar21;
    ulong           uVar22;
    long            lVar23;
    ushort          uVar24;
    short           sVar25;
    PLANET         *lpplMac;
    ushort          grbitPlr;
    long            cMine;
    long            dx;
    long            cMineCur;
    THING          *lpth;
    FLEET          *lpfl;
    short           ifl;
    PLANET         *lppl;
    long            lCur;
    long            dy;
    POINT           pt;
    THING          *lpthMac;
    short           iplr;

    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
        /* WARNING: Load size is inaccurate */
        pFVar5 = ((FLEET **)rglpfl)[ifl];
        iVar17 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar17, pFVar5);
        if ((pFVar5 == 0) && (iVar17 == 0))
            break;
        lVar20 = CMineSweepFromLpfl((FLEET *)CONCAT22(iVar17, pFVar5));
        if ((0 < lVar20) && ((pFVar5->wFlags_0x4 >> 10 & 1) == 0)) {
            uVar6 = lpfl->id;
            iVar7 = (&pFVar5->pt)->x;
            iVar11 = (pFVar5->pt).y;
            lpthMac._0_2_ = (THING *)lpThings + cThing;
            lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
            while ((THING *)lpth < (THING *)lpthMac) {
                if (((lpth->idFull >> 0xd == 0) && ((lpth->idFull >> 9 & 0xf) != (uVar6 >> 9 & 0xf))) &&
                    (sVar9 = FAttackPlayer((FLEET *)CONCAT22(iVar17, pFVar5), lpth->idFull >> 9 & 0xf), sVar9 != 0)) {
                    uVar18 = (undefined2)((ulong)lpth >> 0x10);
                    iVar12 = iVar7 - (&((THING *)lpth)->pt)->x;
                    iVar10 = iVar11 - (((THING *)lpth)->pt).y;
                    uVar21 = __aFulmul((long)iVar10, (long)iVar10);
                    uVar22 = __aFulmul((long)iVar12, (long)iVar12);
                    lVar8 = uVar22 + uVar21;
                    uVar13 = (uint)lVar8;
                    iVar10 = (int)((ulong)lVar8 >> 0x10);
                    iVar12 = *(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
                    if ((iVar10 <= iVar12) && ((iVar10 < iVar12 || (uVar13 <= ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags)))) {
                        lVar23 = lVar20;
                        if (*(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 6) == '\x02') {
                            lVar23 = __aFldiv(lVar20, 3);
                        }
                        if (lVar23 < 2) {
                            lVar23 = 2;
                        }
                        cMineCur._2_2_ = (int)((ulong)lVar23 >> 0x10);
                        cMineCur._0_2_ = (uint)lVar23;
                        uVar14 = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags;
                        if (CONCAT22((*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2) - cMineCur._2_2_) - (uint)(uVar14 < (uint)cMineCur),
                                     uVar14 - (uint)cMineCur) < lVar8 + -1) {
                            uVar14 = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags;
                            uVar15 = uVar14 - uVar13;
                            lVar23 =
                                CONCAT22(((*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2) - iVar10) - (uint)(uVar14 < uVar13)) + (uint)(0xfffe < uVar15),
                                         uVar15 + 1);
                        }
                        if (CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2), ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags) < lVar23) {
                            lVar23 = CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2), ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags);
                        }
                        sVar9 = (((THING *)lpth)->pt).y;
                        uVar24 = (&((THING *)lpth)->pt)->x;
                        bVar4 = *(byte *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
                        uVar13 = (uint)bVar4;
                        uVar14 = lpth->idFull >> 9;
                        uVar15 = uVar14 & 0xf;
                        uVar21 = __aFulshr((ulong)(CONCAT12(bVar4, uVar14) & 0xff000f), uVar24);
                        cMineCur._0_2_ = (uint)lVar23;
                        FSendPlrMsg(pFVar5->iPlayer, idmHasSweptMinesMineField, lpfl->id | 0x8000, lpfl->id, (uint)cMineCur, (short)uVar21, uVar15, uVar13,
                                    uVar24, sVar9);
                        sVar25 = 0;
                        uVar24 = (((THING *)lpth)->pt).y;
                        sVar9 = (&((THING *)lpth)->pt)->x;
                        uVar13 = (uint) * (byte *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
                        uVar21 = __aFulshr(CONCAT22(sVar9, uVar13), uVar24);
                        FSendPlrMsg(lpth->idFull >> 9 & 0xf, idmSomeoneHasSweptMinesMineField, -6, lpth->idFull, (uint)cMineCur, (short)uVar21, uVar13, sVar9,
                                    uVar24, sVar25);
                        cMineCur._2_2_ = (int)((ulong)lVar23 >> 0x10);
                        puVar1 = &((THING *)lpth)->u_THING_0x0006;
                        uVar13 = (puVar1->thp).wFlags;
                        (puVar1->thp).wFlags = (puVar1->thp).wFlags - (uint)cMineCur;
                        piVar2 = (int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
                        *piVar2 = (*piVar2 - cMineCur._2_2_) - (uint)(uVar13 < (uint)cMineCur);
                        iVar12 = *(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
                        if ((iVar12 < 1) && ((iVar12 < 0 || (((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags == 0)))) {
                            FreeLpth(lpth);
                            lpth = (THING *)CONCAT22(uVar18, (THING *)lpth + -1);
                            lpthMac._0_2_ = (THING *)lpthMac + -1;
                        } else {
                            puVar3 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4);
                            *puVar3 = *puVar3 | 1 << ((byte)pFVar5->iPlayer & 0x1f);
                        }
                    }
                }
                lpth = (THING *)lpth + 1;
            }
        }
    }
    pPVar16 = (PLANET *)lpPlanets + cPlanet;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
    while ((PLANET *)lppl < pPVar16) {
        uVar18 = (undefined2)((ulong)lppl >> 0x10);
        if ((((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) && (((PLANET *)lppl)->iPlayer != -1)) &&
            (iVar17 = ((PLANET *)lppl)->iPlayer * 4,
             lVar20 = CMineSweepFromLphul((HUL *)CONCAT22(*(undefined2 *)(iVar17 + rglpshdefSB_0x2),
                                                          (HUL *)(*(int *)(iVar17 + rglpshdefSB) + (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93))),
             0 < lVar20)) {
            uVar6 = ((PLANET *)lppl)->iPlayer;
            iVar17 = ((POINT *)rgptPlan + lppl->id)->x;
            iVar7 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
            lpthMac._0_2_ = (THING *)lpThings + cThing;
            lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
            while ((THING *)lpth < (THING *)lpthMac) {
                if (((lpth->idFull >> 0xd == 0) && ((lpth->idFull >> 9 & 0xf) != uVar6)) &&
                    ((uVar6 != (lpth->idFull >> 9 & 0xf) && (*(char *)(uVar6 * 0xc0 + 0x5a12 + (lpth->idFull >> 9 & 0xf)) != '\x01')))) {
                    uVar19 = (undefined2)((ulong)lpth >> 0x10);
                    iVar11 = iVar17 - (&((THING *)lpth)->pt)->x;
                    iVar12 = iVar7 - (((THING *)lpth)->pt).y;
                    uVar21 = __aFulmul((long)iVar12, (long)iVar12);
                    uVar22 = __aFulmul((long)iVar11, (long)iVar11);
                    lVar8 = uVar22 + uVar21;
                    uVar13 = (uint)lVar8;
                    iVar12 = (int)((ulong)lVar8 >> 0x10);
                    iVar11 = *(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
                    if ((iVar12 <= iVar11) && ((iVar12 < iVar11 || (uVar13 <= ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags)))) {
                        lVar23 = lVar20;
                        if (*(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 6) == '\x02') {
                            lVar23 = __aFldiv(lVar20, 3);
                        }
                        if (lVar23 < 2) {
                            lVar23 = 2;
                        }
                        cMineCur._2_2_ = (int)((ulong)lVar23 >> 0x10);
                        cMineCur._0_2_ = (uint)lVar23;
                        uVar14 = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags;
                        if (CONCAT22((*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2) - cMineCur._2_2_) - (uint)(uVar14 < (uint)cMineCur),
                                     uVar14 - (uint)cMineCur) < lVar8 + -1) {
                            uVar14 = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags;
                            uVar15 = uVar14 - uVar13;
                            lVar23 =
                                CONCAT22(((*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2) - iVar12) - (uint)(uVar14 < uVar13)) + (uint)(0xfffe < uVar15),
                                         uVar15 + 1);
                        }
                        if (CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2), ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags) < lVar23) {
                            lVar23 = CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2), ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags);
                        }
                        sVar9 = (((THING *)lpth)->pt).y;
                        uVar24 = (&((THING *)lpth)->pt)->x;
                        bVar4 = *(byte *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
                        uVar13 = (uint)bVar4;
                        uVar14 = lpth->idFull >> 9;
                        uVar15 = uVar14 & 0xf;
                        uVar21 = __aFulshr((ulong)(CONCAT12(bVar4, uVar14) & 0xff000f), uVar24);
                        cMineCur._0_2_ = (uint)lVar23;
                        FSendPlrMsg(uVar6, idmStarbaseHasSweptMinesMineField, lppl->id, lppl->id, (uint)cMineCur, (short)uVar21, uVar15, uVar13, uVar24, sVar9);
                        sVar25 = 0;
                        uVar24 = (((THING *)lpth)->pt).y;
                        sVar9 = (&((THING *)lpth)->pt)->x;
                        uVar13 = (uint) * (byte *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
                        uVar21 = __aFulshr(CONCAT22(sVar9, uVar13), uVar24);
                        FSendPlrMsg(lpth->idFull >> 9 & 0xf, idmSomeoneHasSweptMinesMineField, -6, lpth->idFull, (uint)cMineCur, (short)uVar21, uVar13, sVar9,
                                    uVar24, sVar25);
                        cMineCur._2_2_ = (int)((ulong)lVar23 >> 0x10);
                        puVar1 = &((THING *)lpth)->u_THING_0x0006;
                        uVar13 = (puVar1->thp).wFlags;
                        (puVar1->thp).wFlags = (puVar1->thp).wFlags - (uint)cMineCur;
                        piVar2 = (int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
                        *piVar2 = (*piVar2 - cMineCur._2_2_) - (uint)(uVar13 < (uint)cMineCur);
                        iVar11 = *(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
                        if ((iVar11 < 1) && ((iVar11 < 0 || (((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags == 0)))) {
                            FreeLpth(lpth);
                            lpth = (THING *)CONCAT22(uVar19, (THING *)lpth + -1);
                            lpthMac._0_2_ = (THING *)lpthMac + -1;
                        } else {
                            puVar3 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4);
                            *puVar3 = *puVar3 | 1 << ((byte)((PLANET *)lppl)->iPlayer & 0x1f);
                        }
                    }
                }
                lpth = (THING *)lpth + 1;
            }
        }
        lppl = (PLANET *)CONCAT22(uVar18, (PLANET *)lppl + 1);
    }
    return;
}

// ======================================================================
// Function: BreedColonistsInTransit
// Address: 10b8:7e4e
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b87f99) */
/* WARNING: Removing unreachable block (ram,0x10b87ffa) */
/* WARNING: Removing unreachable block (ram,0x10b8803c) */

void BreedColonistsInTransit(void)

{
    uint      *puVar1;
    int       *piVar2;
    uint       p2;
    FLEET     *pFVar3;
    int        iVar4;
    bool       bVar5;
    PLANET    *pPVar6;
    ulong      uVar7;
    long       dChg;
    long       lVar8;
    PLANET    *pPVar9;
    uint       uVar10;
    short      sVar11;
    undefined2 uVar12;
    short      p6;
    undefined2 uVar13;
    short      p7;
    long       lColGainAct;
    short      i;
    FLEET     *lpfl;
    short      ifl;
    PLANET    *lppl;
    long       lColGain;
    char       grfBreeder[16];
    short      fNoBreeders;

    bVar5 = true;
    for (i = 0; i < game.cPlayer; i = i + 1) {
        sVar11 = GetRaceStat((PLAYER *)rgplr + i, rsMajorAdv);
        grfBreeder[i] = sVar11 == raDefend;
        if (sVar11 == raDefend) {
            bVar5 = false;
        }
    }
    if (!bVar5) {
        for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
            /* WARNING: Load size is inaccurate */
            pFVar3 = ((FLEET **)rglpfl)[ifl];
            iVar4 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
            lpfl = (FLEET *)CONCAT22(iVar4, pFVar3);
            if ((pFVar3 == 0) && (iVar4 == 0)) {
                return;
            }
            if ((((pFVar3->wFlags_0x4 >> 10 & 1) == 0) && (grfBreeder[pFVar3->iPlayer] != '\0')) &&
                (((int)pFVar3->rgwtMin[3] != 0 || (*(int *)((int)pFVar3->rgwtMin + 0xe) != 0)))) {
                uVar13 = 0;
                uVar12 = 200;
                uVar7 = __aFulmul(CONCAT22(*(undefined2 *)((int)pFVar3->rgwtMin + 0xe), (int)pFVar3->rgwtMin[3]),
                                  (long)(int)*(char *)((int)&rgplr[0].pctIdealGrowth + pFVar3->iPlayer * 0xc0));
                dChg = __aFldiv(uVar7, CONCAT22(uVar13, uVar12));
                if (dChg < 1) {
                    sVar11 = Random(3);
                    if (sVar11 != 0)
                        goto LAB_10b8_7ec9;
                    dChg = 1;
                }
                lVar8 = ChgCargo(grobjFleet, lpfl->id, 3, dChg, 0);
                if (0 < lVar8) {
                    FSendPlrMsg2(pFVar3->iPlayer, idmColonistsHaveMadeGoodUseTimeIncreasing, lpfl->id | 0x8000, lpfl->id, (short)lVar8);
                }
                if ((lVar8 < dChg) && (pFVar3->idPlanet != -1)) {
                    pPVar9 = LpplFromId(pFVar3->idPlanet);
                    uVar12 = (undefined2)((ulong)pPVar9 >> 0x10);
                    pPVar6 = (PLANET *)pPVar9;
                    if ((pPVar9 != 0) && (pPVar6->iPlayer == pFVar3->iPlayer)) {
                        p2 = (uint)(dChg - lVar8);
                        puVar1 = (uint *)(pPVar6->rgwtMin + 3);
                        uVar10 = *puVar1;
                        *puVar1 = *puVar1 + p2;
                        piVar2 = (int *)((int)pPVar6->rgwtMin + 0xe);
                        *piVar2 = *piVar2 + (int)((ulong)(dChg - lVar8) >> 0x10) + (uint)CARRY2(uVar10, p2);
                        p7 = 0;
                        p6 = 0;
                        sVar11 = 0;
                        uVar10 = pFVar3->idPlanet;
                        uVar7 = __aFulshr((ulong)uVar10, 0);
                        FSendPlrMsg(pFVar3->iPlayer, idmBreedingActivitiesHaveOverflowedLivingSpaceColon, lpfl->id | 0x8000, lpfl->id, p2, (short)uVar7, uVar10,
                                    sVar11, p6, p7);
                    }
                }
            }
        LAB_10b8_7ec9:
        }
    }
    return;
}

// ======================================================================
// Function: UpdateResearchStatus
// Address: 10b8:80fe
// Segment: MEMORY_TURN2
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10b884bd) */
/* WARNING: Removing unreachable block (ram,0x10b88acf) */

void UpdateResearchStatus(short fUsePool)

{
    int        *piVar1;
    char       *pcVar2;
    uint       *puVar3;
    uint        uVar4;
    char        cVar5;
    uint        uVar6;
    bool        bVar7;
    bool        bVar8;
    uint        uVar9;
    MessageId   iMsg;
    short       sVar10;
    short       sVar11;
    int         iVar12;
    undefined2 *puVar13;
    char       *pcVar14;
    uint       *puVar15;
    undefined2  unaff_SI;
    undefined2  unaff_DI;
    ulong       uVar16;
    long        lVar17;
    long        lVar18;
    long        lVar19;
    uint        in_stack_0000ffb0;
    short       idm;
    uint        local_4c;
    int         local_48;
    long        l;
    PART        part;
    long        lSpent;
    short       cPlrAlive;
    short       grbitCur;
    long        rglFieldSpent[6];
    short       ibitCur;
    short       i;
    short       fChgNow;
    short       fGeneral;
    short       iItem;
    short       iT;
    short       iTechNext;
    short       fUsePoolOrig;
    short       iTechCur;
    short       fRedoItAll;
    short       mdAvail;

    sVar11 = fUsePool;
    uVar16 = (ulong)in_stack_0000ffb0;
    lVar19 = CONCAT22(unaff_SI, unaff_DI);
    cPlrAlive = 0;
    if (fUsePool != 0) {
        for (i = 0; i < 6; i = i + 1) {
            *(undefined2 *)(rglFieldSpent + i) = 0;
            *(undefined2 *)((int)rglFieldSpent + i * 4 + 2) = 0;
        }
    }
    i = 0;
    do {
        uVar9 = (uint)uVar16;
        if (game.cPlayer <= i) {
            idPlayer = -1;
            bVar8 = false;
            if ((sVar11 != 0) && (1 < cPlrAlive)) {
                for (i = 0; i < game.cPlayer; i = i + 1) {
                    sVar11 = GetRaceStat((PLAYER *)rgplr + i, rsMajorAdv);
                    if (sVar11 == raStealth) {
                        for (iT = 0; iT < 6; iT = iT + 1) {
                            iVar12 = *(int *)((int)rglFieldSpent + iT * 4 + 2);
                            if ((-1 < iVar12) && ((0 < iVar12 || ((int)rglFieldSpent[iT] != 0)))) {
                                lVar17 = 2;
                                lVar18 = __aFldiv(CONCAT22(*(undefined2 *)((int)rglFieldSpent + iT * 4 + 2), (int)rglFieldSpent[iT]), (long)cPlrAlive);
                                lVar18 = __aFldiv(lVar18, lVar17);
                                if (1 < lVar18) {
                                    bVar8 = true;
                                    FSendPlrMsg2(i, idmIntelligenceGatheringActivitiesCombinedSynergist, -2, iT, (short)lVar18);
                                    if ((game.wCrap >> 1 & 1) != 0) {
                                        lVar18 = __aFlshr(lVar19, uVar9);
                                    }
                                    lSpent._2_2_ = (int)((ulong)lVar18 >> 0x10);
                                    lSpent._0_2_ = (uint)lVar18;
                                    puVar15 = (uint *)(i * 0xc0 + 0x59c2 + iT * 4);
                                    puVar3 = puVar15;
                                    uVar4 = *puVar3;
                                    *puVar3 = *puVar3 + (uint)lSpent;
                                    puVar3 = puVar15 + 1;
                                    *puVar3 = *puVar3 + lSpent._2_2_ + (uint)CARRY2(uVar4, (uint)lSpent);
                                }
                            }
                        }
                    }
                }
                if (bVar8) {
                    UpdateResearchStatus(0);
                }
            }
            return;
        }
        fGeneral = GetRaceGrbit((PLAYER *)rgplr + i, ibitRaceGeneralizedResearch);
        uVar16 = (ulong)uVar9;
        iTechCur = (int)*(char *)((int)&rgplr[0].iTechCur + i * 0xc0) & 0xf;
        iTechNext = (short)(*(char *)((int)&rgplr[0].iTechCur + i * 0xc0) >> 4);
        idPlayer = i;
        fUsePool = sVar11;
        if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0) {
            cPlrAlive = cPlrAlive + 1;
            uVar16 = (ulong)uVar9;
        }
        do {
            bVar8 = false;
            for (iT = 0; uVar9 = (uint)uVar16, iT < 6; iT = iT + 1) {
                puVar13 = (undefined2 *)(i * 0xc0 + 0x59c2 + iT * 4);
                lVar18 = CONCAT22(puVar13[1], *puVar13);
                bVar7 = false;
                if ((game.wCrap >> 1 & 1) != 0) {
                    lVar18 = __aFlshl(lVar19, uVar9);
                }
                uVar16 = (ulong)uVar9;
                if (((iT == iTechCur) && (uVar16 = (ulong)uVar9, fUsePool != 0)) && (uVar16 = (ulong)uVar9, fGeneral < 2)) {
                    if (fGeneral == 0) {
                        lVar18 = lVar18 +
                                 CONCAT22(*(undefined2 *)((int)&rgplr[0].lResLastYear + 2 + i * 0xc0), *(undefined2 *)((int)&rgplr[0].lResLastYear + i * 0xc0));
                        uVar6 = *(uint *)((int)&rgplr[0].lResLastYear + i * 0xc0);
                        iVar12 = *(int *)((int)&rgplr[0].lResLastYear + 2 + i * 0xc0);
                        puVar3 = (uint *)(rglFieldSpent + iT);
                        uVar4 = *puVar3;
                        *puVar3 = *puVar3 + uVar6;
                        piVar1 = (int *)((int)rglFieldSpent + iT * 4 + 2);
                        *piVar1 = *piVar1 + iVar12 + (uint)CARRY2(uVar4, uVar6);
                        uVar16 = (ulong)uVar9;
                    } else {
                        bVar8 = true;
                        fGeneral = 2;
                        uVar4 = *(uint *)((int)&rgplr[0].lResLastYear + i * 0xc0);
                        lVar17 = __aFldiv(CONCAT22(*(int *)((int)&rgplr[0].lResLastYear + 2 + i * 0xc0) + (uint)(0xfffe < uVar4), uVar4 + 1), 2);
                        lVar18 = lVar17 + lVar18;
                        uVar4 = *(uint *)((int)&rgplr[0].lResLastYear + i * 0xc0);
                        lVar17 = __aFldiv(CONCAT22(*(int *)((int)&rgplr[0].lResLastYear + 2 + i * 0xc0) + (uint)(0xfffe < uVar4), uVar4 + 1), 2);
                        uVar16 = (ulong)uVar9;
                        puVar3 = (uint *)(rglFieldSpent + iT);
                        uVar9 = *puVar3;
                        *puVar3 = *puVar3 + (uint)lVar17;
                        piVar1 = (int *)((int)rglFieldSpent + iT * 4 + 2);
                        *piVar1 = *piVar1 + (int)((ulong)lVar17 >> 0x10) + (uint)CARRY2(uVar9, (uint)lVar17);
                        for (local_48 = 0; uVar9 = (uint)uVar16, local_48 < 6; local_48 = local_48 + 1) {
                            if (local_48 != iT) {
                                lVar17 = 0x14;
                                uVar16 = __aFulmul(CONCAT22(*(undefined2 *)((int)&rgplr[0].lResLastYear + 2 + i * 0xc0),
                                                            *(undefined2 *)((int)&rgplr[0].lResLastYear + i * 0xc0)),
                                                   3);
                                lVar17 = __aFldiv(uVar16 + 0x13, lVar17);
                                uVar16 = (ulong)uVar9;
                                iVar12 = (int)((ulong)lVar17 >> 0x10);
                                uVar9 = (uint)lVar17;
                                if ((game.wCrap >> 1 & 1) == 0) {
                                    puVar15 = (uint *)(i * 0xc0 + 0x59c2 + local_48 * 4);
                                    puVar3 = puVar15;
                                    uVar4 = *puVar3;
                                    *puVar3 = *puVar3 + uVar9;
                                    puVar3 = puVar15 + 1;
                                    *puVar3 = *puVar3 + iVar12 + (uint)CARRY2(uVar4, uVar9);
                                } else {
                                    uVar16 = __aFldiv(lVar17, 2);
                                    puVar15 = (uint *)(i * 0xc0 + 0x59c2 + local_48 * 4);
                                    puVar3 = puVar15;
                                    uVar4 = *puVar3;
                                    *puVar3 = *puVar3 + (uint)uVar16;
                                    puVar3 = puVar15 + 1;
                                    *puVar3 = *puVar3 + (int)(uVar16 >> 0x10) + (uint)CARRY2(uVar4, (uint)uVar16);
                                }
                                puVar3 = (uint *)(rglFieldSpent + local_48);
                                uVar4 = *puVar3;
                                *puVar3 = *puVar3 + uVar9;
                                piVar1 = (int *)((int)rglFieldSpent + local_48 * 4 + 2);
                                *piVar1 = *piVar1 + iVar12 + (uint)CARRY2(uVar4, uVar9);
                            }
                        }
                    }
                }
                do {
                    uVar9 = (uint)uVar16;
                    if ((('\x19' < *(char *)(i * 0xc0 + 0x59bc + iT)) ||
                         (((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 1 & 1) != 0 && ('\t' < *(char *)(i * 0xc0 + 0x59bc + iT))))) ||
                        (((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 2 & 1) != 0 && ('\t' < *(char *)(i * 0xc0 + 0x59bc + iT)))))
                        goto LAB_10b8_89f3;
                    lVar17 = GetTechLevelCost(iT, *(char *)(i * 0xc0 + 0x59bc + iT) + 1, i);
                    if ((lVar18 < lVar17) || (('\x19' < *(char *)(i * 0xc0 + 0x59bc + iT) && (((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 1 & 1) != 0 ||
                                                                                               ('\x19' < *(char *)(i * 0xc0 + 0x59bc + iT))))))) {
                        if ((game.wCrap >> 1 & 1) != 0) {
                            lVar18 = __aFlshr(lVar19, uVar9);
                        }
                        uVar16 = (ulong)uVar9;
                        lSpent._2_2_ = (int)((ulong)lVar18 >> 0x10);
                        lSpent._0_2_ = (uint)lVar18;
                        puVar13 = (undefined2 *)(i * 0xc0 + 0x59c2 + iT * 4);
                        *puVar13 = (uint)lSpent;
                        puVar13[1] = lSpent._2_2_;
                        goto LAB_10b8_89f3;
                    }
                    local_48 = iTechCur;
                    lVar18 = lVar18 - lVar17;
                    pcVar14 = (char *)(i * 0xc0 + 0x59bc + iT);
                    pcVar2 = pcVar14;
                    *pcVar2 = *pcVar2 + '\x01';
                    cVar5 = *pcVar14;
                    if ((cVar5 == '\x1a') && (iTechNext == 6)) {
                        iTechNext = 7;
                    }
                    if ((iTechCur == iT) && (iTechNext != 6)) {
                        if (iTechNext == 7) {
                            local_48 = 0;
                            for (local_4c = 1; (int)local_4c < 6; local_4c = local_4c + 1) {
                                if (*(char *)(i * 0xc0 + 0x59bc + local_4c) < *(char *)(i * 0xc0 + 0x59bc + local_48)) {
                                    local_48 = local_4c;
                                }
                            }
                        } else {
                            local_48 = iTechNext;
                        }
                        bVar7 = true;
                    }
                    if (fGeneral == 0) {
                        iMsg = idmScientistsHaveCompletedResearchTechLevelWill;
                    } else {
                        iMsg = idmScientistsHaveCompletedResearchTechLevelPrimary;
                    }
                    FSendPlrMsg(i, iMsg, -2, (int)cVar5, iT, local_48, 0, 0, 0, 0);
                    ibitCur = 0;
                    for (grbitCur = 1; uVar16 = (ulong)uVar9, grbitCur != 0; grbitCur = grbitCur << 1) {
                        if (grbitCur != 0) {
                            iItem = 0;
                            part.hs.grhst = grbitCur;
                        LAB_10b8_8653:
                            do {
                                part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | iItem & 0xffU;
                                sVar10 = FLookupPart(&part);
                                if (sVar10 == 0)
                                    break;
                                if ((sVar10 == 1) && (*(char *)(i * 0xc0 + 0x59bc + iT) == (part.u_PART_0x0004.parmor._0_2_)->rgTech[iT])) {
                                    if (grbitCur == 0x400) {
                                        idm = 0xd0;
                                        local_4c = 0xfffd;
                                    } else if (grbitCur == 0x4000) {
                                        idm = 0x78;
                                        local_4c = 0xfffd;
                                    } else {
                                        if (((grbitCur == 0x2000) && (sVar10 = GetRaceGrbit((PLAYER *)rgplr + i, ibitRaceTT), sVar10 != 0)) &&
                                            ((iItem == 8 || ((iItem == 0xc || (iItem == 0x10)))))) {
                                            iItem = iItem + 1;
                                            goto LAB_10b8_8653;
                                        }
                                        if ((grbitCur == -0x8000) && ((8 < iItem && (iItem < 0xe)))) {
                                            idm = 0x145;
                                        } else if ((grbitCur == -0x8000) && ((-1 < iItem && (iItem < 9)))) {
                                            idm = 0x157;
                                        } else {
                                            idm = 0x5f;
                                        }
                                        local_4c = ibitCur << 8 | 0xc000U | iItem;
                                    }
                                    FSendPlrMsg(i, idm, local_4c, iT, grbitCur, iItem, 0, 0, 0, 0);
                                }
                                iItem = iItem + 1;
                            } while (true);
                        }
                        ibitCur = ibitCur + 1;
                    }
                } while ((((fUsePool == 0) && (!bVar7)) && (iTechNext != 7)) || ((iTechNext == 6 || (iT != iTechCur))));
                if (iTechNext == 7) {
                    iTechNext = 0;
                    for (local_4c = 1; (int)local_4c < 6; local_4c = local_4c + 1) {
                        if (*(char *)(i * 0xc0 + 0x59bc + local_4c) < *(char *)(i * 0xc0 + 0x59bc + iTechNext)) {
                            iTechNext = local_4c;
                        }
                    }
                    *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) = *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xf0 | (byte)iTechNext;
                    puVar13 = (undefined2 *)(i * 0xc0 + 0x59c2 + iT * 4);
                    *puVar13 = 0;
                    puVar13[1] = 0;
                    iTechCur = iTechNext;
                    iTechNext = 7;
                } else {
                    *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) = *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xf | 0x60;
                    *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) = *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xf0 | (byte)iTechNext;
                    puVar13 = (undefined2 *)(i * 0xc0 + 0x59c2 + iT * 4);
                    *puVar13 = 0;
                    puVar13[1] = 0;
                    iTechCur = iTechNext;
                    iTechNext = 6;
                }
                if ((game.wCrap >> 1 & 1) != 0) {
                    lVar18 = __aFlshr(lVar19, uVar9);
                }
                uVar16 = (ulong)uVar9;
                lSpent._2_2_ = (int)((ulong)lVar18 >> 0x10);
                lSpent._0_2_ = (uint)lVar18;
                puVar15 = (uint *)(i * 0xc0 + 0x59c2 + iTechCur * 4);
                puVar3 = puVar15;
                uVar9 = *puVar3;
                *puVar3 = *puVar3 + (uint)lSpent;
                puVar3 = puVar15 + 1;
                *puVar3 = *puVar3 + lSpent._2_2_ + (uint)CARRY2(uVar9, (uint)lSpent);
                fUsePool = 0;
                bVar8 = true;
            LAB_10b8_89f3:
            }
        } while (bVar8);
        i = i + 1;
    } while (true);
}

// ======================================================================
// Function: IBestRemoteTerra
// Address: 10b8:8b70
// Segment: MEMORY_TURN2
// ======================================================================

short IBestRemoteTerra(PLANET *lppl, short iplr, short fHelp)

{
    PLAYER    *pPVar1;
    PLAYER    *pPVar2;
    char       cVar3;
    short      sVar4;
    int        iVar5;
    PLANET    *pPVar6;
    PLAYER    *pPVar7;
    PLAYER    *pPVar8;
    undefined2 uVar9;
    undefined2 unaff_SS;
    PLAYER     plrSav;
    short      i;
    short      iBest;

    uVar9 = (undefined2)((ulong)lppl >> 0x10);
    pPVar6 = (PLANET *)lppl;
    pPVar7 = (PLAYER *)rgplr + pPVar6->iPlayer;
    pPVar8 = &plrSav;
    for (iVar5 = 0x60; iVar5 != 0; iVar5 = iVar5 + -1) {
        pPVar2 = pPVar8;
        pPVar8 = &pPVar8->cPlanet;
        pPVar1 = pPVar7;
        pPVar7 = &pPVar7->cPlanet;
        cVar3 = pPVar1->cShDef;
        pPVar2->iPlayer = pPVar1->iPlayer;
        pPVar2->cShDef = cVar3;
    }
    pPVar8 = (PLAYER *)rgplr + iplr;
    pPVar7 = (PLAYER *)rgplr + pPVar6->iPlayer;
    for (iVar5 = 0x60; iVar5 != 0; iVar5 = iVar5 + -1) {
        pPVar2 = pPVar7;
        pPVar7 = &pPVar7->cPlanet;
        pPVar1 = pPVar8;
        pPVar8 = &pPVar8->cPlanet;
        cVar3 = pPVar1->cShDef;
        pPVar2->iPlayer = pPVar1->iPlayer;
        pPVar2->cShDef = cVar3;
    }
    for (i = 0; i < 3; i = i + 1) {
        *(char *)(pPVar6->iPlayer * 0xc0 + 0x59b2 + i) = plrSav.rgEnvVar[i];
        *(char *)(pPVar6->iPlayer * 0xc0 + 0x59b5 + i) = plrSav.rgEnvVarMin[i];
        *(char *)(pPVar6->iPlayer * 0xc0 + 0x59b8 + i) = plrSav.rgEnvVarMax[i];
    }
    sVar4 = IBestTerraform(lppl, fHelp);
    pPVar7 = (PLAYER *)rgplr + pPVar6->iPlayer;
    pPVar8 = &plrSav;
    for (iVar5 = 0x60; iVar5 != 0; iVar5 = iVar5 + -1) {
        pPVar2 = pPVar7;
        pPVar7 = &pPVar7->cPlanet;
        pPVar1 = pPVar8;
        pPVar8 = &pPVar8->cPlanet;
        cVar3 = pPVar1->cShDef;
        pPVar2->iPlayer = pPVar1->iPlayer;
        pPVar2->cShDef = cVar3;
    }
    return sVar4;
}
