// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: Produce
// Address: 10b8:0000
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10b80434) */
/* WARNING: Removing unreachable block (ram,0x10b805bf) */
/* WARNING: Removing unreachable block (ram,0x10b80508) */
/* WARNING: Removing unreachable block (ram,0x10b80461) */
/* WARNING: Removing unreachable block (ram,0x10b803e1) */
/* WARNING: Removing unreachable block (ram,0x10b806ca) */
/* WARNING: Removing unreachable block (ram,0x10b803dc) */
/* WARNING: Removing unreachable block (ram,0x10b80ac0) */
/* WARNING: Removing unreachable block (ram,0x10b80759) */
/* WARNING: Removing unreachable block (ram,0x10b807e0) */
/* WARNING: Removing unreachable block (ram,0x10b80414) */
/* WARNING: Removing unreachable block (ram,0x10b8050d) */
/* WARNING: Removing unreachable block (ram,0x10b80439) */
/* WARNING: Removing unreachable block (ram,0x10b80466) */
/* WARNING: Removing unreachable block (ram,0x10b80950) */
/* WARNING: Removing unreachable block (ram,0x10b80496) */
/* WARNING: Removing unreachable block (ram,0x10b80970) */
/* WARNING: Removing unreachable block (ram,0x10b80ac5) */
/* WARNING: Removing unreachable block (ram,0x10b80535) */
/* WARNING: Removing unreachable block (ram,0x10b8053a) */
/* WARNING: Removing unreachable block (ram,0x10b80975) */
/* WARNING: Removing unreachable block (ram,0x10b80821) */
/* WARNING: Removing unreachable block (ram,0x10b80849) */

void Produce(void)

{
  uint *puVar1;
  int *piVar2;
  byte *pbVar3;
  PLPROD *pPVar4;
  ulong uVar5;
  bool bVar6;
  uint uVar7;
  int iVar8;
  PROD *pPVar9;
  short sVar10;
  PLANET *pPVar11;
  int iVar12;
  PLANET *pPVar13;
  PLPROD *pPVar14;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar15;
  ulong uVar16;
  long lVar17;
  ulong uVar18;
  PL *pPVar19;
  undefined2 uVar20;
  long *rgMinerals;
  ulong uVar21;
  PLANET *pPVar22;
  short cMax2;
  PROD *lpprod;
  short fAutoBuildDone;
  short fPrevProdIsAlch;
  PROD prodPartial;
  short idm;
  short i;
  PLANET *lppl;
  short fNoResearch;
  short cBuilt;
  short mdStatus;
  short iprodCur;
  undefined4 rgResAvail;
  undefined4 local_e;
  short cMax;
  undefined4 lResCur;
  
                    /* Segment:    24
                       Offset:     000a8b00
                       Length:     8cbb
                       Min Alloc:  8cbb
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  uVar21 = CONCAT22(unaff_SI,unaff_DI);
  MineMinerals();
  uVar5 = CONCAT22(lResCur._2_2_,(uint)lResCur);
  uVar16 = CONCAT22(local_e._2_2_,(uint)local_e);
  for (i = 0; i < game.cPlayer; i = i + 1) {
    *(undefined2 *)((int)&rgplr[0].lResLastYear + i * 0xc0) = 0;
    *(undefined2 *)((int)&rgplr[0].lResLastYear + 2 + i * 0xc0) = 0;
  }
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  pPVar11 = (PLANET *)lpPlanets + cPlanet;
  pPVar22 = (PLANET *)lpPlanets;
  do {
    local_e = uVar16;
    lResCur = uVar5;
    if (pPVar11 <= (PLANET *)lppl) {
      UpdatePopulations();
      UpdateResearchStatus(1);
      if ((game.wCrap >> 7 & 1) == 0) {
        RandomEvents();
      }
      return;
    }
    uVar15 = (undefined2)((ulong)lppl >> 0x10);
    if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) &&
       (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
      if (((PLANET *)lppl)->iPlayer != -1) {
        FSendPlrMsg2(((PLANET *)lppl)->iPlayer,idmProductionQueueEmpty,lppl->id,lppl->id,0);
        uVar7 = CResourcesAtPlanet(lppl,((PLANET *)lppl)->iPlayer);
        lResCur._2_2_ = (int)uVar7 >> 0xf;
        uVar5 = (ulong)(int)uVar7;
        uVar16 = local_e;
        if (uVar7 == 0) {
          uVar5 = 0;
        }
        else if (((ushort *)vrgPlanResExtra)[lppl->id] != 0) {
          iVar8 = ((ushort *)vrgPlanResExtra)[lppl->id] + uVar7;
          iVar12 = lResCur._2_2_ + (uint)CARRY2(((ushort *)vrgPlanResExtra)[lppl->id],uVar7);
          lResCur._0_2_ = uVar7;
          uVar16 = __aFulmul((long)(int)uVar7,
                                     (ulong)((ushort *)vrgPlanResExtra)[lppl->id]);
          lVar17 = __aFldiv(uVar16,CONCAT22(iVar12,iVar8));
          uVar5 = lVar17 + CONCAT22(lResCur._2_2_,(uint)lResCur);
          uVar16 = local_e;
        }
        lResCur._2_2_ = (int)(uVar5 >> 0x10);
        lResCur._0_2_ = (uint)uVar5;
        iVar8 = ((PLANET *)lppl)->iPlayer * 0xc0;
        puVar1 = (uint *)((int)&rgplr[0].lResLastYear + iVar8);
        uVar7 = *puVar1;
        *puVar1 = *puVar1 + (uint)lResCur;
        piVar2 = (int *)((int)&rgplr[0].lResLastYear + 2 + iVar8);
        *piVar2 = *piVar2 + lResCur._2_2_ + (uint)CARRY2(uVar7,(uint)lResCur);
      }
    }
    else if ((((PLANET *)lppl)->iPlayer != -1) &&
            (((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac != 0)) {
      uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
      fNoResearch = (uint)uVar16 & 1;
      i = 0;
      while( true ) {
        if (2 < i) break;
        uVar15 = *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
        *(int *)(&rgResAvail + i) = (int)((PLANET *)lppl)->rgwtMin[i];
        *(undefined2 *)((int)&rgResAvail + i * 4 + 2) = uVar15;
        i = i + 1;
      }
      uVar7 = CResourcesAtPlanet(lppl,((PLANET *)lppl)->iPlayer);
      lResCur._0_2_ = uVar7;
      lResCur._2_2_ = (int)uVar7 >> 0xf;
      uVar16 = (ulong)(int)uVar7;
      if (uVar7 == 0) {
        uVar16 = 0;
      }
      else if (((ushort *)vrgPlanResExtra)[lppl->id] != 0) {
        iVar8 = ((ushort *)vrgPlanResExtra)[lppl->id] + uVar7;
        iVar12 = ((int)uVar7 >> 0xf) +
                 (uint)CARRY2(((ushort *)vrgPlanResExtra)[lppl->id],uVar7);
        uVar16 = __aFulmul((long)(int)uVar7,
                                   (ulong)((ushort *)vrgPlanResExtra)[lppl->id]);
        lVar17 = __aFldiv(uVar16,CONCAT22(iVar12,iVar8));
        uVar16 = lVar17 + CONCAT22(lResCur._2_2_,(uint)lResCur);
        lResCur = uVar16;
      }
      local_e = uVar16;
      uVar5 = uVar16;
      if ((*(uint *)((int)&rgplr[0].wFlags + ((PLANET *)lppl)->iPlayer * 0xc0) >> 2 & 1)
          != 0) {
        uVar20 = 0;
        uVar15 = 5;
        lResCur = uVar16;
        lVar17 = __aFlshl(5,(ushort)uVar21);
        uVar16 = __aFldiv(lVar17,CONCAT22(uVar20,uVar15));
        local_e = uVar16;
        uVar5 = lResCur;
      }
      if (uVar16 != 0) {
        if (fNoResearch == 0) {
          uVar20 = 0;
          uVar15 = 100;
          local_e = uVar16;
          lResCur = uVar5;
          uVar16 = __aFulmul(uVar16,(long)(int)*(char *)((int)&rgplr[0].
                                                                       pctResearch +
                                                                ((PLANET *)lppl)->iPlayer * 0xc0));
          lVar17 = __aFldiv(uVar16,CONCAT22(uVar20,uVar15));
          uVar16 = local_e - lVar17;
          local_e = uVar16;
          iVar8 = ((PLANET *)lppl)->iPlayer * 0xc0;
          puVar1 = (uint *)((int)&rgplr[0].lResLastYear + iVar8);
          uVar7 = *puVar1;
          *puVar1 = *puVar1 + (uint)lVar17;
          piVar2 = (int *)((int)&rgplr[0].lResLastYear + 2 + iVar8);
          *piVar2 = *piVar2 + (int)((ulong)lVar17 >> 0x10) + (uint)CARRY2(uVar7,(uint)lVar17);
          uVar5 = lResCur;
        }
        bVar6 = true;
TURN2_TopOfQueue:
        fPrevProdIsAlch = 0;
        iprodCur = 0;
        local_e = uVar16;
        lResCur = uVar5;
LAB_10b8_037b:
        do {
          uVar15 = (undefined2)((ulong)lppl >> 0x10);
          pPVar13 = (PLANET *)lppl;
          uVar5 = lResCur;
          uVar16 = local_e;
          if (((*(int *)&pPVar13->lpplprod == 0) && (*(int *)((int)&pPVar13->lpplprod + 2) == 0)) ||
             ((int)(uint)((PLPROD *)pPVar13->lpplprod)->iprodMac <= iprodCur)) {
LAB_10b8_0b9a:
            uVar15 = (undefined2)((ulong)lppl >> 0x10);
            pPVar13 = (PLANET *)lppl;
            if (((*(int *)&pPVar13->lpplprod == 0) && (*(int *)((int)&pPVar13->lpplprod + 2) == 0))
               || (((int)(uint)((PLPROD *)pPVar13->lpplprod)->iprodMac <= iprodCur && (bVar6)))) {
              local_e = uVar16;
              lResCur = uVar5;
              FSendPlrMsg2(pPVar13->iPlayer,idmHasCompletedOrdersProductionQueueEmpty,lppl->id,
                                lppl->id,0);
              uVar16 = local_e;
              uVar5 = lResCur;
            }
            local_e._2_2_ = (int)(uVar16 >> 0x10);
            local_e._0_2_ = (uint)uVar16;
            i = 0;
            while( true ) {
              if (2 < i) break;
              uVar15 = *(undefined2 *)((int)&rgResAvail + i * 4 + 2);
              *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = *(undefined2 *)(&rgResAvail + i);
              *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = uVar15;
              i = i + 1;
            }
            iVar8 = ((PLANET *)lppl)->iPlayer * 0xc0;
            puVar1 = (uint *)((int)&rgplr[0].lResLastYear + iVar8);
            uVar7 = *puVar1;
            *puVar1 = *puVar1 + (uint)local_e;
            piVar2 = (int *)((int)&rgplr[0].lResLastYear + 2 + iVar8);
            *piVar2 = *piVar2 + local_e._2_2_ + (uint)CARRY2(uVar7,(uint)local_e);
            break;
          }
          uVar20 = *(undefined2 *)((int)&pPVar13->lpplprod + 2);
          pPVar9 = (PROD *)(*(int *)&pPVar13->lpplprod + 4 + iprodCur * 4);
          lpprod = (PROD *)CONCAT22(uVar20,pPVar9);
          if ((lpprod->dwFlags & 0x3ff) == 0) {
TURN2_RemoveFromQueue:
            uVar15 = (undefined2)((ulong)lppl >> 0x10);
            pPVar13 = (PLANET *)lppl;
            if ((uint)((PLPROD *)pPVar13->lpplprod)->iprodMac == fPrevProdIsAlch + 1U) {
              FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pPVar13->lpplprod + 2),
                                            *(PL **)&pPVar13->lpplprod));
              uVar15 = (undefined2)((ulong)lppl >> 0x10);
              *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
              *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
              uVar16 = local_e;
              uVar5 = lResCur;
              goto LAB_10b8_0b9a;
            }
            if (iprodCur < (int)(((PLPROD *)pPVar13->lpplprod)->iprodMac - 1)) {
              __fmemmove((void *)CONCAT22(*(undefined2 *)((int)&pPVar13->lpplprod + 2),
                                                  (void *)(*(int *)&pPVar13->lpplprod + 4 +
                                                          (iprodCur - fPrevProdIsAlch) * 4)),
                                 (void *)CONCAT22(*(undefined2 *)((int)&pPVar13->lpplprod + 2),
                                                  (void *)(*(int *)&pPVar13->lpplprod + 4 +
                                                          (iprodCur + 1) * 4)),
                                 (((uint)((PLPROD *)pPVar13->lpplprod)->iprodMac - iprodCur) + -1) *
                                 4);
            }
            pPVar4 = ((PLANET *)lppl)->lpplprod;
            pbVar3 = &((PLPROD *)pPVar4)->iprodMac;
            *pbVar3 = *pbVar3 - ((char)fPrevProdIsAlch + '\x01');
            iprodCur = iprodCur - (fPrevProdIsAlch + 1);
LAB_10b8_0b8e:
            iprodCur = iprodCur + 1;
            fPrevProdIsAlch = 0;
            goto LAB_10b8_037b;
          }
          uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
          if (((uint)uVar16 & 7) == 1) {
            uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
            if (((uint)uVar16 & 0x7f) < 0x12) {
LAB_10b8_0471:
              uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
              if (((uint)uVar16 & 0x7f) != 0x1b) {
                uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
                if (0xd < ((uint)uVar16 & 0x7f)) {
                  uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
                  if (((uint)uVar16 & 0x7f) < 0x12) {
                    sVar10 = IWarpMAFromLppl(lppl,(short *)0x0);
                    uVar15 = (undefined2)((ulong)lppl >> 0x10);
                    if ((sVar10 == 0) ||
                       ((*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0x3ff) == 0)) {
                      FSendPlrMsg2(((PLANET *)lppl)->iPlayer,
                                        idmHasOrdersBuildMineralPacketEitherDoesnt,lppl->id,lppl->id
                                        ,0);
                      goto TURN2_RemoveFromQueue;
                    }
                    goto LAB_10b8_07fc;
                  }
                }
                uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
                if (((uint)uVar16 & 0x7f) == 7) {
                  cMax = CMaxFactories(lppl,((PLANET *)lppl)->iPlayer);
                  sVar10 = CMaxOperableFactories(lppl,((PLANET *)lppl)->iPlayer,1);
                  if (sVar10 <= cMax) {
                    sVar10 = cMax;
                  }
                  cMax = sVar10;
                  uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
                  cMax = cMax - ((uint)uVar16 & 0xfff);
TURN2_LCantBuildP:
                  idm = 0x12a;
                }
                else {
                  uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
                  if (((uint)uVar16 & 0x7f) == 8) {
                    cMax = CMaxMines(lppl,((PLANET *)lppl)->iPlayer);
                    sVar10 = CMaxOperableMines(lppl,((PLANET *)lppl)->iPlayer,1);
                    if (sVar10 <= cMax) {
                      sVar10 = cMax;
                    }
                    cMax = sVar10;
                    uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
                    cMax = cMax - ((uint)uVar16 & 0xfff);
                    goto TURN2_LCantBuildP;
                  }
                  uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
                  if (((uint)uVar16 & 0x7f) == 9) {
                    cMax = CMaxDefenses(lppl,((PLANET *)lppl)->iPlayer);
                    sVar10 = CMaxOperableDefenses(lppl,((PLANET *)lppl)->iPlayer,1);
                    if (sVar10 <= cMax) {
                      sVar10 = cMax;
                    }
                    cMax = sVar10;
                    cMax = cMax - (*(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff);
                    goto TURN2_LCantBuildP;
                  }
                  uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
                  if (((uint)uVar16 & 0x7f) != 0xc) goto LAB_10b8_07fc;
                  cMax = IpctCanTerraformLppl(lppl);
                  idm = 0x12f;
                }
                if (cMax < (int)((uint)lpprod->dwFlags & 0x3ff)) {
                  FSendPlrMsg2(((PLANET *)lppl)->iPlayer,idm,lppl->id,lppl->id,0);
                  if (cMax < 1) goto TURN2_RemoveFromQueue;
                  lVar17 = __aFlshl(uVar21,(ushort)pPVar22);
                  uVar7 = *(uint *)((int)&pPVar9->dwFlags + 2);
                  *(uint *)&lpprod->dwFlags = (uint)lpprod->dwFlags & 0xfc00 | (uint)lVar17;
                  *(uint *)((int)&pPVar9->dwFlags + 2) = uVar7 | (uint)((ulong)lVar17 >> 0x10);
                }
                goto LAB_10b8_07fc;
              }
            }
            else {
              uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
              if (0x1a < ((uint)uVar16 & 0x7f)) goto LAB_10b8_0471;
            }
            uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
            if (((uint)uVar16 & 0x1f) != 0x1f) {
              FSendPlrMsg2(((PLANET *)lppl)->iPlayer,
                                idmOrderBuildScannerCanceledAlreadyHaveScanner,lppl->id,lppl->id,0);
              goto TURN2_RemoveFromQueue;
            }
          }
LAB_10b8_07fc:
          uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
          if (((uint)uVar16 & 0x7f) != 3) {
LAB_10b8_0871:
            prodPartial.dwFlags._0_2_ = (uint)prodPartial.dwFlags & 0xfc00;
            sVar10 = CBuildProdItem(lppl,(PROD *)CONCAT22(uVar20,pPVar9),&prodPartial,&rgResAvail,
                                    fPrevProdIsAlch,&mdStatus,0);
            if ((bVar6) && ((mdStatus == 3 || (mdStatus == 4)))) {
              bVar6 = false;
            }
            cBuilt = sVar10;
            uVar16 = local_e;
            uVar5 = lResCur;
            if (0 < sVar10) {
              rgMinerals = &rgResAvail;
              uVar16 = __aFulshr(CONCAT22(rgMinerals,sVar10),(ushort)uVar21);
              uVar7 = (uint)uVar16 & 0x7f;
              uVar16 = __aFulshr(CONCAT22(sVar10,(uint)uVar16) & 0xffff007f,
                                         (ushort)rgMinerals);
              sVar10 = FBuildObject(lppl,(GrobjClass)uVar16 & (grobjOther|grobjFleet|grobjPlanet),
                                    uVar7,sVar10,rgMinerals);
              uVar16 = local_e;
              uVar5 = lResCur;
              if (sVar10 == 0) {
                uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
                if (((uint)uVar16 & 7) == 1) {
                  uVar18 = __aFulshr(uVar21,(ushort)pPVar22);
                  uVar16 = local_e;
                  uVar5 = lResCur;
                  if (((uint)uVar18 & 0x7f) < 7) goto LAB_10b8_09a0;
                }
                uVar15 = *(undefined2 *)((int)&pPVar9->dwFlags + 2);
                *(uint *)&lpprod->dwFlags = (uint)lpprod->dwFlags & 0xfc00;
                *(undefined2 *)((int)&pPVar9->dwFlags + 2) = uVar15;
                uVar16 = local_e;
                uVar5 = lResCur;
              }
            }
LAB_10b8_09a0:
            uVar15 = (undefined2)((ulong)lppl >> 0x10);
            pPVar13 = (PLANET *)lppl;
            if (((pPVar13->iPlayer != -1) || (*(int *)&pPVar13->lpplprod != 0)) ||
               (*(int *)((int)&pPVar13->lpplprod + 2) != 0)) {
              local_e = uVar16;
              lResCur = uVar5;
              if (mdStatus == 0) goto TURN2_RemoveFromQueue;
              if (4 < mdStatus) {
                if (((uint)prodPartial.dwFlags & 0x3ff) != 0) {
                  if (((PLPROD *)pPVar13->lpplprod)->iprodMac ==
                      ((PLPROD *)pPVar13->lpplprod)->iprodMax) {
                    pPVar19 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)
                                                                  ((int)&pPVar13->lpplprod + 2),
                                                                 *(PL **)&pPVar13->lpplprod),
                                                  ((PLPROD *)pPVar13->lpplprod)->iprodMac + 1);
                    uVar15 = (undefined2)((ulong)lppl >> 0x10);
                    *(PL **)&((PLANET *)lppl)->lpplprod = (PL *)pPVar19;
                    *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) =
                         (int)((ulong)pPVar19 >> 0x10);
                    uVar16 = local_e;
                    uVar5 = lResCur;
                  }
                  uVar15 = (undefined2)((ulong)lppl >> 0x10);
                  pPVar13 = (PLANET *)lppl;
                  local_e = uVar16;
                  lResCur = uVar5;
                  __fmemmove((void *)CONCAT22(*(undefined2 *)((int)&pPVar13->lpplprod + 2),
                                                      (void *)(*(int *)&pPVar13->lpplprod + 8)),
                                     (void *)CONCAT22(*(undefined2 *)((int)&pPVar13->lpplprod + 2),
                                                      (void *)(*(int *)&pPVar13->lpplprod + 4)),
                                     (uint)((PLPROD *)pPVar13->lpplprod)->iprodMac << 2);
                  uVar15 = (undefined2)((ulong)lppl >> 0x10);
                  pPVar4 = ((PLANET *)lppl)->lpplprod;
                  uVar20 = (undefined2)((ulong)pPVar4 >> 0x10);
                  pPVar14 = (PLPROD *)pPVar4;
                  (pPVar14 + 1)->wFlags = (uint)prodPartial.dwFlags;
                  *(undefined2 *)&pPVar14[1].iprodMax = prodPartial.dwFlags._2_2_;
                  pPVar4 = ((PLANET *)lppl)->lpplprod;
                  pbVar3 = &((PLPROD *)pPVar4)->iprodMac;
                  *pbVar3 = *pbVar3 + 1;
                  uVar16 = local_e;
                  uVar5 = lResCur;
                }
                goto LAB_10b8_0b9a;
              }
              goto LAB_10b8_0b8e;
            }
            goto TURN2_TopOfQueue;
          }
          uVar16 = __aFulshr(uVar21,(ushort)pPVar22);
          if ((((uint)uVar16 & 7) != 1) ||
             (pPVar4 = ((PLANET *)lppl)->lpplprod,
             (int)(((PLPROD *)pPVar4)->iprodMac - 1) <= iprodCur)) goto LAB_10b8_0871;
          fPrevProdIsAlch = 1;
          iprodCur = iprodCur + 1;
        } while( true );
      }
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  } while( true );
}



// ======================================================================
// Function: CBuildProdItem
// Address: 10b8:0c92
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10b81941) */
/* WARNING: Removing unreachable block (ram,0x10b818bd) */
/* WARNING: Removing unreachable block (ram,0x10b8173c) */
/* WARNING: Removing unreachable block (ram,0x10b810a5) */
/* WARNING: Removing unreachable block (ram,0x10b80e9c) */
/* WARNING: Removing unreachable block (ram,0x10b80ec3) */
/* WARNING: Removing unreachable block (ram,0x10b80d33) */
/* WARNING: Removing unreachable block (ram,0x10b80d38) */
/* WARNING: Removing unreachable block (ram,0x10b80d17) */
/* WARNING: Removing unreachable block (ram,0x10b80ffd) */
/* WARNING: Removing unreachable block (ram,0x10b810a0) */
/* WARNING: Removing unreachable block (ram,0x10b81784) */
/* WARNING: Removing unreachable block (ram,0x10b81849) */
/* WARNING: Removing unreachable block (ram,0x10b8193c) */
/* WARNING: Removing unreachable block (ram,0x10b81920) */
/* WARNING: Removing unreachable block (ram,0x10b80fcd) */
/* WARNING: Removing unreachable block (ram,0x10b81283) */
/* WARNING: Removing unreachable block (ram,0x10b8124d) */
/* WARNING: Removing unreachable block (ram,0x10b81443) */
/* WARNING: Removing unreachable block (ram,0x10b815db) */
/* WARNING: Removing unreachable block (ram,0x10b81465) */

short CBuildProdItem
          (PLANET *lppl,PROD *lpprod,PROD *pprodPartial,long *rgRes,short fAlchemy,short *pmdStatus,
          short fCalcOnly)

{
  uint *puVar1;
  uint uVar2;
  uint uVar3;
  bool bVar4;
  uint uVar5;
  uint uVar6;
  uint uVar7;
  short sVar8;
  int iVar9;
  PLANET *pPVar10;
  undefined2 unaff_SI;
  PLANET *unaff_DI;
  undefined2 uVar11;
  undefined2 uVar12;
  ulong uVar13;
  ulong uVar14;
  long lVar15;
  undefined2 uVar16;
  undefined2 uVar17;
  PLANET *pPVar18;
  uint in_stack_0000ffa6;
  short fMineralBlocked;
  undefined4 rgCost;
  undefined4 pct;
  undefined4 pctTooBig;
  uint pctInitial;
  int local_3a;
  short fResourceBlocked;
  short i;
  uint rgCostPaid [8];
  short cAlchemy;
  short cBuilt;
  short fAutoBuild;
  uint prod;
  uint local_1c;
  uint lAlchCost;
  undefined2 local_18;
  int lMinNeeded;
  int local_14;
  undefined4 cCanBuild;
  undefined2 iobjOther;
  undefined2 local_c;
  short cMax;
  undefined4 pctT;
  
  pPVar18 = (PLANET *)CONCAT22(unaff_SI,unaff_DI);
  cAlchemy = 0;
  uVar13 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6);
  pctInitial = (uint)uVar13 & 0x7f;
  local_3a = 0;
  uVar11 = (undefined2)((ulong)lpprod >> 0x10);
  prod = (uint)lpprod->dwFlags;
  local_1c = *(uint *)((int)&((PROD *)lpprod)->dwFlags + 2);
  uVar12 = (undefined2)((ulong)lppl >> 0x10);
  pPVar10 = (PLANET *)lppl;
  GetProductionCosts(lppl,lpprod,&rgCost,pPVar10->iPlayer,1);
  cBuilt = 0;
  uVar13 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6);
  if ((((uint)uVar13 & 7) == 1) &&
     (uVar13 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6), ((uint)uVar13 & 0x7f) < 7)) {
    fAutoBuild = 1;
  }
  else {
    fAutoBuild = 0;
  }
  if (fAutoBuild != 0) {
    cMax = 1000;
    uVar13 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6);
    uVar6 = (uint)uVar13 & 0x7f;
    if ((uVar13 & 0x7f) == 0) {
      iobjOther = 8;
      local_c = 0;
      uVar13 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6);
      sVar8 = CMaxOperableMines(lppl,pPVar10->iPlayer,1);
      cMax = sVar8 - ((uint)uVar13 & 0xfff);
    }
    else if (uVar6 == 1) {
      iobjOther = 7;
      local_c = 0;
      uVar13 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6);
      sVar8 = CMaxOperableFactories(lppl,pPVar10->iPlayer,1);
      cMax = sVar8 - ((uint)uVar13 & 0xfff);
    }
    else if (uVar6 == 2) {
      iobjOther = 9;
      local_c = 0;
      uVar6 = *(uint *)(pPVar10->rgbImp + 4);
      sVar8 = CMaxOperableDefenses(lppl,pPVar10->iPlayer,1);
      cMax = sVar8 - (uVar6 & 0xfff);
    }
    else if (uVar6 == 3) {
      iobjOther = 0xb;
      local_c = 0;
    }
    else if ((uVar6 == 4) || (uVar6 == 5)) {
      iobjOther = 0xc;
      local_c = 0;
      cMax = IpctCanTerraformLppl(lppl);
      if ((0 < cMax) &&
         (((uVar13 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6), ((uint)uVar13 & 0x7f) == 4
           && (lVar15 = ChgPopFromPlanet(lppl,0), -1 < lVar15)) &&
          (pPVar18 = lppl, sVar8 = PctPlanetDesirability(lppl,pPVar10->iPlayer), 0 < sVar8))
         )) {
        cMax = 0;
      }
    }
    else if (uVar6 == 6) {
      iobjOther = 0x11;
      local_c = 0;
      sVar8 = IWarpMAFromLppl(lppl,(short *)0x0);
      if ((sVar8 == 0) || ((*(uint *)((int)&pPVar10->lStarbase + 2) & 0x3ff) == 0)) {
        cMax = 0;
      }
    }
    if (cMax < 0) {
      cMax = 0;
    }
    in_stack_0000ffa6 = prod & 0x3ff;
    if (((-1 < cMax) && ((uint)cMax < in_stack_0000ffa6)) ||
       (uVar13 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6), ((uint)uVar13 & 0x7f) == 3)) {
      lVar15 = __aFlshl((long)pPVar18,in_stack_0000ffa6);
      prod = prod & 0xfc00 | (uint)lVar15;
      local_1c = local_1c | (uint)((ulong)lVar15 >> 0x10);
    }
  }
  i = 0;
  while( true ) {
    lVar15 = CONCAT22(pctTooBig._2_2_,(undefined2)pctTooBig);
    uVar13 = CONCAT22(cCanBuild._2_2_,(uint)cCanBuild);
    if (3 < i) break;
    uVar17 = 0;
    uVar16 = 100;
    uVar13 = __aFulshr(100,(ushort)(PLANET *)pPVar18);
    uVar13 = __aFulmul(CONCAT22(*(undefined2 *)((int)&rgCost + i * 4 + 2),
                                        *(undefined2 *)(&rgCost + i)),(ulong)((uint)uVar13 & 0x7f));
    uVar13 = __aFuldiv(uVar13,CONCAT22(uVar17,uVar16));
    rgCostPaid[i * 2] = (uint)uVar13;
    rgCostPaid[i * 2 + 1] = (uint)(uVar13 >> 0x10);
    i = i + 1;
  }
LAB_10b8_108f:
  do {
    if ((prod & 0x3ff) == 0) goto LAB_10b8_1712;
    for (i = 0; i < 4; i = i + 1) {
      iVar9 = (*(int *)((int)&rgCost + i * 4 + 2) - rgCostPaid[i * 2 + 1]) -
              (uint)(*(uint *)(&rgCost + i) < rgCostPaid[i * 2]);
      uVar6 = *(uint *)((int)(rgRes + i) + 2);
      if (((int)uVar6 <= iVar9) &&
         (((int)uVar6 < iVar9 || (*(uint *)(rgRes + i) < *(uint *)(&rgCost + i) - rgCostPaid[i * 2])
          ))) break;
    }
    if (3 < i) {
      cBuilt = cBuilt + 1;
      in_stack_0000ffa6 = prod - 1 & 0x3ff;
      prod = prod & 0xfc00 | in_stack_0000ffa6;
      local_1c = local_1c & 0xf80f;
      for (i = 0; i < 4; i = i + 1) {
        uVar5 = *(uint *)(&rgCost + i);
        iVar9 = *(int *)((int)&rgCost + i * 4 + 2);
        uVar2 = rgCostPaid[i * 2];
        uVar7 = uVar5 - rgCostPaid[i * 2];
        uVar3 = rgCostPaid[i * 2 + 1];
        puVar1 = (uint *)(rgRes + i);
        uVar6 = *puVar1;
        *puVar1 = *puVar1 - uVar7;
        puVar1 = (uint *)((int)(rgRes + i) + 2);
        *puVar1 = (*puVar1 - ((iVar9 - uVar3) - (uint)(uVar5 < uVar2))) - (uint)(uVar6 < uVar7);
        cCanBuild = uVar13;
        rgCostPaid[i * 2] = 0;
        rgCostPaid[i * 2 + 1] = 0;
        uVar13 = cCanBuild;
      }
      goto LAB_10b8_108f;
    }
    bVar4 = false;
    fResourceBlocked = 0;
    pct._0_2_ = 100;
    pct._2_2_ = 0;
    pct = 100;
    for (i = 0; pctTooBig = lVar15, cCanBuild = uVar13, i < 4; i = i + 1) {
      iVar9 = *(int *)((int)&rgCost + i * 4 + 2);
      if ((-1 < iVar9) && ((0 < iVar9 || (*(int *)(&rgCost + i) != 0)))) {
        iVar9 = *(int *)((int)&rgCost + i * 4 + 2);
        uVar6 = *(uint *)((int)(rgRes + i) + 2);
        if (((int)uVar6 < iVar9) ||
           (((int)uVar6 <= iVar9 && (*(uint *)(rgRes + i) < *(uint *)(&rgCost + i))))) {
          uVar16 = *(undefined2 *)((int)&rgCost + i * 4 + 2);
          uVar17 = *(undefined2 *)(&rgCost + i);
          uVar6 = *(uint *)(rgRes + i);
          uVar13 = __aFulmul(CONCAT22(*(uint *)((int)(rgRes + i) + 2) +
                                              rgCostPaid[i * 2 + 1] +
                                              (uint)CARRY2(uVar6,rgCostPaid[i * 2]),
                                              uVar6 + rgCostPaid[i * 2]),100);
          uVar13 = __aFldiv(uVar13,CONCAT22(uVar16,uVar17));
          pctT = uVar13;
          uVar16 = *(undefined2 *)((int)&rgCost + i * 4 + 2);
          uVar17 = *(undefined2 *)(&rgCost + i);
          uVar6 = *(uint *)(rgRes + i);
          uVar5 = uVar6 + rgCostPaid[i * 2];
          uVar13 = __aFulmul(CONCAT22(*(uint *)((int)(rgRes + i) + 2) +
                                              rgCostPaid[i * 2 + 1] +
                                              (uint)CARRY2(uVar6,rgCostPaid[i * 2]) +
                                              (uint)(0xfffe < uVar5),uVar5 + 1),100);
          lVar15 = __aFldiv(uVar13,CONCAT22(uVar16,uVar17));
          pctTooBig = lVar15;
          if ((long)pctT <= lVar15 + -1) {
            pctT = lVar15 - 1;
          }
          uVar13 = cCanBuild;
        }
        else {
          pctT._0_2_ = 100;
          pctT._2_2_ = 0;
          pctT = 100;
        }
        if ((long)pctT < (long)pct) {
          uVar6 = *(uint *)(&rgCost + i) - rgCostPaid[i * 2];
          puVar1 = (uint *)(rgRes + i);
          lMinNeeded = uVar6 - *puVar1;
          local_14 = (((*(int *)((int)&rgCost + i * 4 + 2) - rgCostPaid[i * 2 + 1]) -
                      (uint)(*(uint *)(&rgCost + i) < rgCostPaid[i * 2])) -
                     *(uint *)((int)(rgRes + i) + 2)) - (uint)(uVar6 < *puVar1);
          pct = pctT;
          if (i == 3) {
            fResourceBlocked = 1;
          }
          else {
            bVar4 = true;
          }
        }
      }
    }
    if ((bVar4) && (fAutoBuild != 0)) {
      if (fAlchemy == 0) {
        fAutoBuild = 2;
        goto LAB_10b8_1712;
      }
    }
    else {
      for (i = 0; i < 4; i = i + 1) {
        uVar17 = 0;
        uVar16 = 100;
        uVar13 = __aFulmul(CONCAT22(*(undefined2 *)((int)&rgCost + i * 4 + 2),
                                            *(undefined2 *)(&rgCost + i)),pct);
        lVar15 = __aFldiv(uVar13,CONCAT22(uVar17,uVar16));
        in_stack_0000ffa6 = (uint)lVar15 - rgCostPaid[i * 2];
        iVar9 = ((int)((ulong)lVar15 >> 0x10) - rgCostPaid[i * 2 + 1]) -
                (uint)((uint)lVar15 < rgCostPaid[i * 2]);
        puVar1 = (uint *)(rgRes + i);
        uVar6 = *puVar1;
        *puVar1 = *puVar1 - in_stack_0000ffa6;
        puVar1 = (uint *)((int)(rgRes + i) + 2);
        *puVar1 = (*puVar1 - iVar9) - (uint)(uVar6 < in_stack_0000ffa6);
        puVar1 = rgCostPaid + i * 2;
        uVar6 = *puVar1;
        *puVar1 = *puVar1 + in_stack_0000ffa6;
        rgCostPaid[i * 2 + 1] =
             rgCostPaid[i * 2 + 1] + iVar9 + (uint)CARRY2(uVar6,in_stack_0000ffa6);
      }
      lVar15 = __aFlshl((long)pPVar18,in_stack_0000ffa6);
      prod = prod | (uint)lVar15;
      local_1c = local_1c & 0xf80f | (uint)((ulong)lVar15 >> 0x10);
      lVar15 = pctTooBig;
      uVar13 = cCanBuild;
      if ((fAlchemy == 0) || (fResourceBlocked != 0)) goto LAB_10b8_1712;
    }
    pctTooBig = lVar15;
    cCanBuild = uVar13;
    sVar8 = GetRaceGrbit((PLAYER *)rgplr + pPVar10->iPlayer,ibitRaceMineralAlchemy);
    if (sVar8 == 0) {
      lAlchCost = 100;
    }
    else {
      lAlchCost = 0x19;
    }
    local_18 = 0;
    uVar13 = __aFldiv(CONCAT22(*(undefined2 *)((int)rgRes + 0xe),(int)rgRes[3]),
                              (ulong)lAlchCost);
    cCanBuild = uVar13;
    if (CONCAT22(local_14,lMinNeeded) < (long)uVar13) {
      cCanBuild._0_2_ = lMinNeeded;
      cCanBuild._2_2_ = local_14;
      uVar13 = CONCAT22(local_14,lMinNeeded);
    }
    cCanBuild._2_2_ = (int)(uVar13 >> 0x10);
    cCanBuild._0_2_ = (uint)uVar13;
    lVar15 = pctTooBig;
    if (0 < (long)uVar13) {
      for (i = 0; i < 3; i = i + 1) {
        puVar1 = (uint *)(rgRes + i);
        uVar6 = *puVar1;
        *puVar1 = *puVar1 + (uint)cCanBuild;
        puVar1 = (uint *)((int)(rgRes + i) + 2);
        *puVar1 = *puVar1 + cCanBuild._2_2_ + (uint)CARRY2(uVar6,(uint)cCanBuild);
      }
      cCanBuild = uVar13;
      uVar13 = __aFulmul(CONCAT22(local_18,lAlchCost),uVar13);
      puVar1 = (uint *)(rgRes + i);
      uVar6 = *puVar1;
      *puVar1 = *puVar1 - (uint)uVar13;
      puVar1 = (uint *)((int)(rgRes + i) + 2);
      *puVar1 = (*puVar1 - (int)(uVar13 >> 0x10)) - (uint)(uVar6 < (uint)uVar13);
      cAlchemy = cAlchemy + (uint)cCanBuild;
      uVar13 = cCanBuild;
      lVar15 = pctTooBig;
    }
  } while (uVar13 == CONCAT22(local_14,lMinNeeded));
  if ((-1 < *(int *)((int)rgRes + 0xe)) &&
     (((0 < *(int *)((int)rgRes + 0xe) || ((int)rgRes[3] != 0)) && (pprodPartial != (PROD *)0x0))))
  {
    pctTooBig = lVar15;
    cCanBuild = uVar13;
    _memset(pprodPartial,0,4);
    uVar6 = *(uint *)((int)&pprodPartial->dwFlags + 2);
    *(int *)&pprodPartial->dwFlags = (int)pprodPartial->dwFlags;
    *(uint *)((int)&pprodPartial->dwFlags + 2) = uVar6 & 0xfff1 | 2;
    uVar6 = *(uint *)((int)&pprodPartial->dwFlags + 2);
    *(uint *)&pprodPartial->dwFlags = (uint)pprodPartial->dwFlags & 0x3ff | 0x2c00;
    *(uint *)((int)&pprodPartial->dwFlags + 2) = uVar6 & 0xfffe;
    uVar16 = *(undefined2 *)((int)&pprodPartial->dwFlags + 2);
    *(uint *)&pprodPartial->dwFlags = (uint)pprodPartial->dwFlags & 0xfc00 | 1;
    *(undefined2 *)((int)&pprodPartial->dwFlags + 2) = uVar16;
    uVar6 = lAlchCost;
    uVar16 = local_18;
    uVar13 = __aFulmul(CONCAT22(*(undefined2 *)((int)rgRes + 0xe),(int)rgRes[3]),100);
    uVar13 = __aFldiv(uVar13,CONCAT22(uVar16,uVar6));
    uVar6 = lAlchCost;
    uVar16 = local_18;
    pctT = uVar13;
    uVar13 = __aFulmul(CONCAT22(*(int *)((int)rgRes + 0xe) +
                                        (uint)(0xfffe < *(uint *)(rgRes + 3)),
                                        *(uint *)(rgRes + 3) + 1),100);
    lVar15 = __aFldiv(uVar13,CONCAT22(uVar16,uVar6));
    if ((long)pctT <= lVar15 + -1) {
      pctT = lVar15 - 1;
    }
    pctTooBig = lVar15;
    lVar15 = __aFlshl((long)pPVar18,in_stack_0000ffa6);
    uVar6 = *(uint *)((int)&pprodPartial->dwFlags + 2);
    *(uint *)&pprodPartial->dwFlags = (uint)pprodPartial->dwFlags | (uint)lVar15;
    *(uint *)((int)&pprodPartial->dwFlags + 2) = uVar6 & 0xf80f | (uint)((ulong)lVar15 >> 0x10);
    uVar17 = 0;
    uVar16 = 100;
    uVar13 = __aFulmul(pctT,CONCAT22(local_18,lAlchCost));
    lVar15 = __aFldiv(uVar13,CONCAT22(uVar17,uVar16));
    puVar1 = (uint *)(rgRes + 3);
    uVar6 = *puVar1;
    *puVar1 = *puVar1 - (uint)lVar15;
    *(int *)((int)rgRes + 0xe) =
         (*(int *)((int)rgRes + 0xe) - (int)((ulong)lVar15 >> 0x10)) - (uint)(uVar6 < (uint)lVar15);
    lVar15 = pctTooBig;
    uVar13 = cCanBuild;
  }
LAB_10b8_1712:
  if (0 < cBuilt) {
    pctTooBig = lVar15;
    cCanBuild = uVar13;
    uVar14 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6);
    lVar15 = pctTooBig;
    uVar13 = cCanBuild;
    if (((uint)uVar14 & 7) == 1) {
      uVar13 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6);
      if (((uint)uVar13 & 0x7f) != 0xb) {
        uVar14 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6);
        lVar15 = pctTooBig;
        uVar13 = cCanBuild;
        if (((uint)uVar14 & 0x7f) != 3) goto LAB_10b8_17b7;
      }
      cAlchemy = cAlchemy + cBuilt;
      for (i = 0; lVar15 = pctTooBig, uVar13 = cCanBuild, i < 3; i = i + 1) {
        puVar1 = (uint *)(rgRes + i);
        uVar6 = *puVar1;
        *puVar1 = *puVar1 + cBuilt;
        puVar1 = (uint *)((int)(rgRes + i) + 2);
        *puVar1 = *puVar1 + (cBuilt >> 0xf) + (uint)CARRY2(uVar6,cBuilt);
      }
    }
  }
LAB_10b8_17b7:
  if (((cAlchemy != 0) && (fCalcOnly == 0)) && (((uint)gd.grBits >> 1 & 1) != 0)) {
    pctTooBig = lVar15;
    cCanBuild = uVar13;
    FSendPlrMsg2(pPVar10->iPlayer,idmScientistsHaveTransmutedCommonMaterialsKtEach,lppl->id,
                      lppl->id,cAlchemy);
    lVar15 = pctTooBig;
    uVar13 = cCanBuild;
  }
  if (pmdStatus != (short *)0x0) {
    if (fAutoBuild == 2) {
      if (cBuilt < 1) {
        sVar8 = 4;
      }
      else {
        sVar8 = 3;
      }
      *pmdStatus = sVar8;
    }
    else if ((fAutoBuild == 0) || ((prod & 0x3ff) != 0)) {
      if (cBuilt == 0) {
        pctTooBig = lVar15;
        cCanBuild = uVar13;
        uVar13 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6);
        if ((pctInitial == ((uint)uVar13 & 0x7f)) && (local_3a == 0)) {
          sVar8 = 7;
        }
        else {
          sVar8 = 6;
        }
        *pmdStatus = sVar8;
        lVar15 = pctTooBig;
        uVar13 = cCanBuild;
      }
      else if ((prod & 0x3ff) == 0) {
        *pmdStatus = 0;
      }
      else {
        *pmdStatus = 5;
      }
    }
    else {
      if (cBuilt < 1) {
        sVar8 = 2;
      }
      else {
        sVar8 = 1;
      }
      *pmdStatus = sVar8;
    }
  }
  if ((fCalcOnly == 0) && (fAutoBuild == 0)) {
    *(uint *)&lpprod->dwFlags = prod;
    *(uint *)((int)&((PROD *)lpprod)->dwFlags + 2) = local_1c;
  }
  if (((fAutoBuild != 0) && (pprodPartial != (PROD *)0x0)) && ((pprodPartial->dwFlags & 0x3ff) == 0)
     ) {
    pctTooBig = lVar15;
    cCanBuild = uVar13;
    uVar13 = __aFulshr((ulong)pPVar18,in_stack_0000ffa6);
    if ((uVar13 & 0x7f) != 0) {
      *(uint *)&pprodPartial->dwFlags = prod;
      *(uint *)((int)&pprodPartial->dwFlags + 2) = local_1c;
      uVar11 = *(undefined2 *)((int)&pprodPartial->dwFlags + 2);
      *(uint *)&pprodPartial->dwFlags = (uint)pprodPartial->dwFlags & 0xfc00 | 1;
      *(undefined2 *)((int)&pprodPartial->dwFlags + 2) = uVar11;
      lVar15 = __aFlshl((long)pPVar18,in_stack_0000ffa6);
      uVar6 = *(uint *)((int)&pprodPartial->dwFlags + 2);
      *(uint *)&pprodPartial->dwFlags = (uint)pprodPartial->dwFlags & 0x3ff | (uint)lVar15;
      *(uint *)((int)&pprodPartial->dwFlags + 2) = uVar6 & 0xfffe | (uint)((ulong)lVar15 >> 0x10);
    }
  }
  return cBuilt;
}



// ======================================================================
// Function: FBuildObject
// Address: 10b8:19b2
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10b81a59) */
/* WARNING: Removing unreachable block (ram,0x10b827aa) */

short FBuildObject(PLANET *lppl,GrobjClass grobj,short iItem,short cBuilt,long *rgMinerals)

{
  ulong *puVar1;
  int *piVar2;
  uint *puVar3;
  FLEET *pFVar4;
  int iVar5;
  PLORD *pPVar6;
  THING *pTVar7;
  char cVar8;
  short sVar9;
  char *pcVar10;
  SHDEF *pSVar11;
  int iVar12;
  int iVar13;
  undefined2 unaff_SI;
  short unaff_DI;
  undefined2 uVar14;
  HULDEF *pHVar15;
  ulong uVar16;
  ARMOR *pAVar17;
  long lVar18;
  THING *pTVar19;
  short p5;
  uint uVar20;
  short p6;
  undefined2 uVar21;
  undefined2 uVar22;
  ushort in_stack_0000ffce;
  short cSize;
  short iWarpAsked;
  short raMajor;
  THING *lpth;
  HullSlotType part;
  short cshDamaged;
  undefined2 dpOrig;
  short iEnv;
  short cAllowed;
  SHDEF *lpshdef;
  short fTwoMAs;
  short idm;
  FLEET *lpfl;
  short i;
  short iWarp;
  
  if (grobj == grobjFleet) {
    if (0xf < iItem) {
      uVar20 = iItem - 0x10;
      iVar12 = ((PLANET *)lppl)->iPlayer * 4;
      uVar14 = *(undefined2 *)(iVar12 + 0x14e);
      pSVar11 = (SHDEF *)(*(int *)(iVar12 + 0x14c) + uVar20 * 0x93);
      lpshdef = (SHDEF *)CONCAT22(uVar14,pSVar11);
      if (((pSVar11->wFlags >> 9 & 1) == 0) &&
         (sVar9 = FCanBuildShdef((SHDEF *)CONCAT22(uVar14,pSVar11),((PLANET *)lppl)->iPlayer),
         sVar9 != 0)) {
        idm = 0xcd;
        uVar14 = (undefined2)((ulong)lpshdef >> 0x10);
        if (((((SHDEF *)lpshdef)->hul).wtCargoMax != 0) &&
           (idm = 0xce, (((SHDEF *)lpshdef)->hul).wtCargoMax == 0xffff)) {
          idm = 0xcf;
        }
        p6 = 0;
        p5 = 0;
        sVar9 = 0;
        pHVar15 = LphuldefFromId((lpshdef->hul).ihuldef);
        FSendPlrMsg(((PLANET *)lppl)->iPlayer,idm,lppl->id,lppl->id,
                         ((PLANET *)lppl)->iPlayer << 5 | iItem,
                         (((HULDEF *)pHVar15)->hul).wtCargoMax,sVar9,p5,p6,unaff_DI);
        if (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) &&
           (iVar12 = ((PLANET *)lppl)->iPlayer * 4,
           iEnv = *(int *)(*(int *)(iVar12 + 0x14c) + uVar20 * 0x93),
           iVar12 = ((PLANET *)lppl)->iPlayer * 4,
           iEnv < *(int *)(*(int *)(iVar12 + 0x14c) +
                          (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93))) {
          KillQueuedShips(lppl);
        }
        iWarp = IWarpMAFromLppl(lppl,&fTwoMAs);
        if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0) {
          ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfdff | 0x200;
        }
        else {
          iVar12 = ((PLANET *)lppl)->iPlayer * 4;
          uVar14 = *(undefined2 *)(iVar12 + 0x14e);
          iVar13 = *(int *)(iVar12 + 0x14c) + (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93;
          piVar2 = (int *)(iVar13 + 0x83);
          iVar12 = *piVar2;
          *piVar2 = *piVar2 + -1;
          piVar2 = (int *)(iVar13 + 0x85);
          *piVar2 = *piVar2 - (uint)(iVar12 == 0);
        }
        *(uint *)&((PLANET *)lppl)->lStarbase =
             *(uint *)&((PLANET *)lppl)->lStarbase & 0xfff0 | uVar20 & 0xf;
        if (iWarp < 1) {
          iWarp = IWarpMAFromLppl(lppl,&fTwoMAs);
          if (iWarp < 1) {
            *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) =
                 *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0xc3ff;
            *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) =
                 *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0xfc00;
            KillQueuedMassPackets(lppl);
          }
          else {
            *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) =
                 *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0xc3ff |
                 ((iWarp + fTwoMAs) - 4U & 0xf) << 10;
          }
        }
        uVar14 = (undefined2)((ulong)lpshdef >> 0x10);
        pSVar11 = (SHDEF *)lpshdef;
        puVar1 = &pSVar11->cBuilt;
        uVar16 = *puVar1;
        *(uint *)puVar1 = (uint)*puVar1 + 1;
        piVar2 = (int *)((int)&pSVar11->cBuilt + 2);
        *piVar2 = *piVar2 + (uint)(0xfffe < (uint)uVar16);
        puVar1 = &pSVar11->cExist;
        uVar16 = *puVar1;
        *(uint *)puVar1 = (uint)*puVar1 + 1;
        piVar2 = (int *)((int)&pSVar11->cExist + 2);
        *piVar2 = *piVar2 + (uint)(0xfffe < (uint)uVar16);
        return 1;
      }
      return 0;
    }
    if (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0) || (0xf < iItem)) {
      return 0;
    }
    iVar12 = ((PLANET *)lppl)->iPlayer * 4;
    uVar14 = *(undefined2 *)(iVar12 + 0x100);
    pSVar11 = (SHDEF *)(*(int *)(iVar12 + 0xfe) + iItem * 0x93);
    lpshdef = (SHDEF *)CONCAT22(uVar14,pSVar11);
    if (((pSVar11->wFlags >> 9 & 1) != 0) ||
       (sVar9 = FCanBuildShdef((SHDEF *)CONCAT22(uVar14,pSVar11),((PLANET *)lppl)->iPlayer),
       sVar9 == 0)) {
      FSendPlrMsg2(((PLANET *)lppl)->iPlayer,idmStarbaseFailedBuildNewShipTypeBecause,lppl->id,
                        iItem + 1,0);
      return 0;
    }
    if ((*(uint *)((int)&rgplr[0].wFlags_0x4 + ((PLANET *)lppl)->iPlayer * 0xc0) & 0xfff)
        != 0x200) {
      lpfl = LpflNew(((PLANET *)lppl)->iPlayer,lppl->id);
      CreateShip(((PLANET *)lppl)->iPlayer,lpfl,iItem,cBuilt);
      lVar18 = LGetFleetStat(lpfl,1);
      uVar14 = (undefined2)((ulong)lpfl >> 0x10);
      *(int *)(((FLEET *)lpfl)->rgwtMin + 4) = (int)lVar18;
      *(undefined2 *)((int)((FLEET *)lpfl)->rgwtMin + 0x12) = (int)((ulong)lVar18 >> 0x10);
      if ((((PLANET *)lppl)->wRouting & 0x3ff) != 0) {
        AutoRouteFleet(lpfl,lppl);
        uVar14 = (undefined2)((ulong)lpfl >> 0x10);
        if (cBuilt != 1) {
          pPVar6 = ((FLEET *)lpfl)->lpplord;
          if ((((PLORD *)pPVar6 + 7)->wFlags >> 4 & 0xf) == 0) {
            idm = idmStarbaseHasBuiltNewShipsWhichWill;
          }
          else {
            idm = idmStarbaseHasBuiltNewShipsWhichRouted;
          }
          FSendPlrMsg(((PLANET *)lppl)->iPlayer,idm,lpfl->id | 0x8000,lppl->id,cBuilt,
                           ((PLANET *)lppl)->iPlayer << 5 | iItem,
                           (((PLANET *)lppl)->wRouting & 0x3ff) - 1,0,0,0);
          return 1;
        }
        pPVar6 = ((FLEET *)lpfl)->lpplord;
        if ((((PLORD *)pPVar6 + 7)->wFlags >> 4 & 0xf) == 0) {
          idm = idmStarbaseHasBuiltNewWhichWillRouted;
        }
        else {
          idm = idmStarbaseHasBuiltNewWhichRouted;
        }
        FSendPlrMsg(((PLANET *)lppl)->iPlayer,idm,lpfl->id | 0x8000,lppl->id,
                         ((PLANET *)lppl)->iPlayer << 5 | iItem,
                         (((PLANET *)lppl)->wRouting & 0x3ff) - 1,0,0,0,0);
        return 1;
      }
      AutoFleetOrder(lpfl,lppl);
      if (cBuilt != 1) {
        FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmStarbaseHasBuiltNewShips,lpfl->id | 0x8000,
                         lppl->id,cBuilt,((PLANET *)lppl)->iPlayer << 5 | iItem,0,0,0,0);
        return 1;
      }
      FSendPlrMsg2(((PLANET *)lppl)->iPlayer,idmStarbaseHasBuiltNew,lpfl->id | 0x8000,lppl->id,
                        ((PLANET *)lppl)->iPlayer << 5 | iItem);
      return 1;
    }
    for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar4 = ((FLEET **)rglpfl)[i];
      iVar12 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpfl = (FLEET *)CONCAT22(iVar12,pFVar4);
      if (((pFVar4 == (FLEET *)0x0) && (iVar12 == 0)) ||
         (((PLANET *)lppl)->iPlayer < pFVar4->iPlayer)) break;
      if (((((PLANET *)lppl)->iPlayer <= pFVar4->iPlayer) &&
          (((PLORD *)pFVar4->lpplord + 1)->wFlags == ((POINT *)rgptPlan + lppl->id)->x))
         && ((*(int *)&((PLORD *)pFVar4->lpplord)[1].iordMax ==
              *(int *)((int)&rgptPlan[0].y + lppl->id * 4) &&
             (pFVar4->rgcsh[iItem] < 0x7ffe - cBuilt)))) {
        if ((pFVar4->rgcsh[iItem] == 0) || ((uint)pFVar4->rgcsh[iItem + 0x10] >> 7 == 0)) {
          pFVar4->rgcsh[iItem + 0x10] = 0;
        }
        else {
          iVar13 = pFVar4->iPlayer * 4;
          uVar20 = *(uint *)(*(int *)(iVar13 + 0xfe) + iItem * 0x93 + 0x38);
          part = pFVar4->rgcsh[iItem];
          uVar21 = 0;
          uVar14 = 100;
          uVar16 = __aFulmul((ulong)(uint)pFVar4->rgcsh[iItem + 0x10] & 0xffff007f,
                                     (long)(int)part);
          lVar18 = __aFldiv(uVar16,CONCAT22(uVar21,uVar14));
          cshDamaged = (short)lVar18;
          if (cshDamaged == 0) {
            cshDamaged = 1;
          }
          uVar21 = 0;
          uVar14 = 0x32;
          iVar12 = cshDamaged >> 0xf;
          lVar18 = 10;
          sVar9 = cshDamaged;
          uVar16 = __aFulmul((ulong)uVar20,
                                     (ulong)((uint)((FLEET *)lpfl)->rgcsh[iItem + 0x10] >> 7));
          uVar16 = __aFldiv(uVar16,lVar18);
          uVar16 = __aFulmul(uVar16,CONCAT22(iVar12,sVar9));
          pAVar17 = (ARMOR *)__aFldiv(uVar16,CONCAT22(uVar21,uVar14));
          iEnv = (short)((ulong)pAVar17 >> 0x10);
          dpOrig = SUB42(pAVar17,0);
          iVar12 = part + cBuilt;
          iVar13 = iVar12 >> 0xf;
          uVar16 = __aFulmul((long)cshDamaged,100);
          lVar18 = __aFldiv(uVar16,CONCAT22(iVar13,iVar12));
          ((FLEET *)lpfl)->rgcsh[iItem + 0x10] =
               ((FLEET *)lpfl)->rgcsh[iItem + 0x10] & 0xff80U | (uint)lVar18 & 0x7f;
          if ((((FLEET *)lpfl)->rgcsh[iItem + 0x10] & 0x7fU) == 0) {
            ((FLEET *)lpfl)->rgcsh[iItem + 0x10] =
                 ((FLEET *)lpfl)->rgcsh[iItem + 0x10] & 0xff80U | 1;
          }
          uVar21 = 0;
          uVar14 = 100;
          uVar16 = __aFulmul((ulong)(uint)((FLEET *)lpfl)->rgcsh[iItem + 0x10] & 0xffff007f,
                                     (long)(int)(part + cBuilt));
          lVar18 = __aFldiv(uVar16,CONCAT22(uVar21,uVar14));
          cshDamaged = (short)lVar18;
          if (cshDamaged == 0) {
            cshDamaged = 1;
          }
          uVar22 = 0;
          uVar21 = 0;
          uVar14 = 100;
          lVar18 = (long)cshDamaged;
          uVar16 = __aFulmul((ulong)CONCAT22(iEnv,dpOrig),5);
          uVar16 = __aFldiv(uVar16,lVar18);
          uVar16 = __aFulmul(uVar16,CONCAT22(uVar21,uVar14));
          lVar18 = __aFldiv(uVar16,CONCAT22(uVar22,uVar20));
          ((FLEET *)lpfl)->rgcsh[iItem + 0x10] =
               ((FLEET *)lpfl)->rgcsh[iItem + 0x10] & 0x7fU | (int)lVar18 << 7;
        }
        CreateShip(((PLANET *)lppl)->iPlayer,lpfl,iItem,cBuilt);
        FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmStarbaseBuiltNewSDueLack27b,lpfl->id | 0x8000,
                         lppl->id,cBuilt,((PLANET *)lppl)->iPlayer << 5 | iItem,lpfl->id,0,0,0);
        return 1;
      }
    }
    FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmStarbaseBuiltNewShipSTypeLost,lppl->id,lppl->id,
                     cBuilt,((PLANET *)lppl)->iPlayer << 5 | iItem,0,0,0,0);
    return 0;
  }
  if (grobj != grobjPlanet) {
    return 0;
  }
  switch(iItem) {
  case 0:
  case 8:
    uVar16 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffce);
    iEnv = (uint)uVar16 & 0xfff;
    sVar9 = CMaxMines(lppl,((PLANET *)lppl)->iPlayer);
    cAllowed = sVar9 - iEnv;
    if (cAllowed <= cBuilt) {
      cBuilt = cAllowed;
    }
    if (cBuilt < 1) {
      return 0;
    }
    lVar18 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffce);
    dpOrig = (uint)lVar18 + *(uint *)((PLANET *)lppl)->rgbImp & 0xff00;
    iEnv = (int)((ulong)lVar18 >> 0x10) + *(int *)(((PLANET *)lppl)->rgbImp + 2) +
           (uint)CARRY2((uint)lVar18,*(uint *)((PLANET *)lppl)->rgbImp) & 0xf;
    *(uint *)((PLANET *)lppl)->rgbImp = *(uint *)((PLANET *)lppl)->rgbImp & 0xff;
    *(uint *)(((PLANET *)lppl)->rgbImp + 2) = *(uint *)(((PLANET *)lppl)->rgbImp + 2) & 0xfff0;
    *(uint *)((PLANET *)lppl)->rgbImp = *(uint *)((PLANET *)lppl)->rgbImp | dpOrig;
    *(uint *)(((PLANET *)lppl)->rgbImp + 2) = *(uint *)(((PLANET *)lppl)->rgbImp + 2) | iEnv;
    idm = 0x37;
    goto TURN2_SendMsgFactMine;
  case 1:
  case 7:
    uVar16 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffce);
    iEnv = (uint)uVar16 & 0xfff;
    sVar9 = CMaxFactories(lppl,((PLANET *)lppl)->iPlayer);
    cAllowed = sVar9 - iEnv;
    if (cAllowed <= cBuilt) {
      cBuilt = cAllowed;
    }
    if (cBuilt < 1) {
      return 0;
    }
    lVar18 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffce);
    iEnv = (int)((ulong)lVar18 >> 0x10) + *(int *)(((PLANET *)lppl)->rgbImp + 2) +
           (uint)CARRY2((uint)lVar18,*(uint *)((PLANET *)lppl)->rgbImp) & 0xfff0;
    dpOrig = (ARMOR *)0x0;
    *(undefined2 *)((PLANET *)lppl)->rgbImp = *(undefined2 *)((PLANET *)lppl)->rgbImp;
    *(uint *)(((PLANET *)lppl)->rgbImp + 2) = *(uint *)(((PLANET *)lppl)->rgbImp + 2) & 0xf;
    *(undefined2 *)((PLANET *)lppl)->rgbImp = *(undefined2 *)((PLANET *)lppl)->rgbImp;
    *(uint *)(((PLANET *)lppl)->rgbImp + 2) = *(uint *)(((PLANET *)lppl)->rgbImp + 2) | iEnv;
    idm = 0x35;
    goto TURN2_SendMsgFactMine;
  case 2:
  case 9:
    iEnv = *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff;
    sVar9 = CMaxDefenses(lppl,((PLANET *)lppl)->iPlayer);
    cAllowed = sVar9 - iEnv;
    if (cAllowed <= cBuilt) {
      cBuilt = cAllowed;
    }
    if (cBuilt < 1) {
      return 0;
    }
    lVar18 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffce);
    dpOrig = (int)lVar18 + *(int *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff;
    iEnv = 0;
    *(uint *)(((PLANET *)lppl)->rgbImp + 4) = *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xf000;
    *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6) = *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6);
    *(uint *)(((PLANET *)lppl)->rgbImp + 4) = *(uint *)(((PLANET *)lppl)->rgbImp + 4) | dpOrig;
    *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6) = *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6);
    idm = 0x39;
TURN2_SendMsgFactMine:
    sVar9 = FRemovePlayerMessage(((PLANET *)lppl)->iPlayer,idm,lppl->id);
    if (cBuilt + sVar9 < 2) {
      FSendPlrMsg2(((PLANET *)lppl)->iPlayer,idm,lppl->id,lppl->id,0);
    }
    else {
      FSendPlrMsg2(((PLANET *)lppl)->iPlayer,
                        idm + idmColonistsDroppedDestroyedPlanetaryDefensesRestMa,lppl->id,
                        cBuilt + sVar9,lppl->id);
    }
    break;
  case 3:
  case 0xb:
    break;
  case 4:
  case 5:
  case 0xc:
    while (iVar12 = cBuilt + -1, cBuilt != 0) {
      i = IBestTerraform(lppl,1);
      cBuilt = iVar12;
      if (i != 0) {
        sVar9 = _abs(i);
        iEnv = sVar9 + -1;
        if (i < 1) {
          dpOrig = (ARMOR *)0xffff;
        }
        else {
          dpOrig = (ARMOR *)0x1;
        }
        cAllowed = (short)(((ARMOR *)dpOrig)->rgTech +
                          (char)((PLANET *)lppl)->rgMinConc[sVar9 + 2] + -2);
        pcVar10 = (char *)cAllowed;
        if (99 < cAllowed) {
          pcVar10 = (char *)0x63;
        }
        if ((int)pcVar10 < 1) {
          cAllowed = 1;
        }
        else if (99 < cAllowed) {
          cAllowed = 99;
        }
        ((PLANET *)lppl)->rgMinConc[sVar9 + 2] = (byte)cAllowed;
        FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmTerraformingEffortsHave,lppl->id,lppl->id,
                         (uint)(0 < i),iEnv,(short)(cAllowed + iEnv * 0x100),0,0,0);
      }
    }
    break;
  case 6:
  case 0xe:
  case 0xf:
  case 0x10:
  case 0x11:
    sVar9 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lppl)->iPlayer,rsMajorAdv);
    cshDamaged = IWarpMAFromLppl(lppl,&fTwoMAs);
    if (cshDamaged == 0) {
      FSendPlrMsg2(((PLANET *)lppl)->iPlayer,
                        idmMineralPacketFormedHasDisintegratedBecausePlanet,lppl->id,lppl->id,0);
      return 0;
    }
    if ((*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0x3ff) == 0) {
      FSendPlrMsg2(((PLANET *)lppl)->iPlayer,idmMineralPacketFormedHasDisintegratedBecauseDidnt
                        ,lppl->id,lppl->id,0);
      return 0;
    }
    if (iItem == 6) {
      iItem = 0x11;
    }
    if (iItem == 0x11) {
      if (sVar9 == raMassAccel) {
        cSize = 0x19;
      }
      else {
        cSize = 0x28;
      }
    }
    else if (sVar9 == raMassAccel) {
      cSize = 0x46;
    }
    else {
      cSize = 100;
    }
    for (i = 0; i < 3; i = i + 1) {
      if ((i == iItem + -0xe) || (iItem == 0x11)) {
        uVar16 = __aFulmul((long)cSize,(long)cBuilt);
        uVar14 = (undefined2)uVar16;
        if (0x7ff8 < (long)uVar16) {
          uVar14 = 0x7ff8;
        }
        *(undefined2 *)(&stack0xffd2 + i * 2) = uVar14;
      }
      else {
        *(undefined2 *)(&stack0xffd2 + i * 2) = 0;
      }
    }
    iWarpAsked = (*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) >> 10 & 0xf) + 4;
    if (((uint)iWarpAsked < 5) || (cshDamaged + 3 < iWarpAsked)) {
      iWarpAsked = cshDamaged + fTwoMAs;
    }
    if (cshDamaged + fTwoMAs < iWarpAsked) {
      part = (iWarpAsked - cshDamaged) - fTwoMAs;
    }
    else {
      part = ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines
               |hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine);
    }
    if ((sVar9 == raStargate) && ((int)part < 3)) {
      part = part + hstEngine;
    }
    cshDamaged = iWarpAsked - 4U;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    dpOrig = (THING *)lpThings + cThing;
    iEnv = lpThings._2_2_;
    while( true ) {
      if (((uint)dpOrig <= (THING *)lpth) ||
         ((((((lpth->idFull >> 9 & 0xf) == ((PLANET *)lppl)->iPlayer && (lpth->idFull >> 0xd == 1))
            && ((&((THING *)lpth)->pt)->x == ((POINT *)rgptPlan + lppl->id)->x)) &&
           (((((THING *)lpth)->pt).y == *(int *)((int)&rgptPlan[0].y + lppl->id * 4) &&
            ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) == iWarpAsked - 4U))))
          && (((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0x3ff) ==
               (*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0x3ff) - 1 &&
              ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) >> 0xe == part &&
               ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) & 0x3fff) < 0x65e))))))))
      break;
      lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
    }
    if (((THING *)lpth == (THING *)dpOrig) && (lpth._2_2_ == lpThings._2_2_)) {
      pTVar19 = LpthNew(((PLANET *)lppl)->iPlayer,ithMineralPacket);
      iVar12 = (int)((ulong)pTVar19 >> 0x10);
      pTVar7 = (THING *)pTVar19;
      if ((pTVar7 == (THING *)0x0) && (iVar12 == 0)) {
        FSendPlrMsg2(((PLANET *)lppl)->iPlayer,idmHasOrdersBuildMineralPacketEitherDoesnt,
                          lppl->id,lppl->id,0);
      }
      else {
        for (i = 0; i < 3; i = i + 1) {
          *(undefined2 *)((pTVar7->u_THING_0x0006).rgb + i * 2 + 2) =
               *(undefined2 *)(&stack0xffd2 + i * 2);
          iVar13 = *(int *)(&stack0xffd2 + i * 2);
          iVar5 = *(int *)((int)&pTVar7->u_THING_0x0006 + 8);
          puVar3 = (uint *)((int)&pTVar7->u_THING_0x0006 + 8);
          *puVar3 = *puVar3 & 0xc000;
          puVar3 = (uint *)((int)&pTVar7->u_THING_0x0006 + 8);
          *puVar3 = *puVar3 | (iVar13 + 9) / 10 + iVar5 & 0x3fffU;
        }
        ((&pTVar7->u_THING_0x0006)->thp).wFlags =
             ((&pTVar7->u_THING_0x0006)->thp).wFlags & 0xc3ff | (cshDamaged & 0xfU) << 10;
        *(uint *)((int)&pTVar7->u_THING_0x0006 + 8) =
             *(uint *)((int)&pTVar7->u_THING_0x0006 + 8) & 0x3fff | part << 0xe;
        ((&pTVar7->u_THING_0x0006)->thp).wFlags =
             ((&pTVar7->u_THING_0x0006)->thp).wFlags & 0xfc00 |
             (*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0x3ff) - 1 & 0x3ff;
        sVar9 = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
        (&pTVar7->pt)->x = ((POINT *)rgptPlan + lppl->id)->x;
        (pTVar7->pt).y = sVar9;
        FSendPlrMsg2(((PLANET *)lppl)->iPlayer,idmHasProducedMineralPacketWhichHasDestination,
                          lppl->id,lppl->id,
                          (*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0x3ff) - 1);
      }
    }
    else {
      *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) =
           *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) & 0xc000;
      for (i = 0; i < 3; i = i + 1) {
        *(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) =
             *(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) +
             *(int *)(&stack0xffd2 + i * 2);
        if (*(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) < 0) {
          ((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2)[0] = 0xf8;
          ((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2)[1] = 0x7f;
        }
        iVar12 = *(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2);
        iVar13 = *(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 8);
        puVar3 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8);
        *puVar3 = *puVar3 & 0xc000;
        puVar3 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8);
        *puVar3 = *puVar3 | (iVar12 + 9) / 10 + iVar13 & 0x3fffU;
      }
      FSendPlrMsg2(((PLANET *)lppl)->iPlayer,idmHasProducedMineralPacketWhichHasCombined,
                        lppl->id,lppl->id,
                        (*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0x3ff) - 1);
    }
    break;
  case 10:
    break;
  case 0xd:
    for (i = 0; i < game.cPlayer; i = i + 1) {
      FSendPlrMsg2(i,idmStrongFundamentalForcesHaveRebirthed,lppl->id,lppl->id,0);
    }
    sVar9 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lppl)->iPlayer,rsMajorAdv);
    if (sVar9 != raMacintosh) {
      uVar20 = *(uint *)(((PLANET *)lppl)->rgbImp + 2);
      *(undefined2 *)((PLANET *)lppl)->rgbImp = *(undefined2 *)((PLANET *)lppl)->rgbImp;
      *(uint *)(((PLANET *)lppl)->rgbImp + 2) = uVar20 & 0xf;
      uVar20 = *(uint *)(((PLANET *)lppl)->rgbImp + 2);
      *(uint *)((PLANET *)lppl)->rgbImp = *(uint *)((PLANET *)lppl)->rgbImp & 0xff;
      *(uint *)(((PLANET *)lppl)->rgbImp + 2) = uVar20 & 0xfff0;
      uVar14 = *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6);
      *(uint *)(((PLANET *)lppl)->rgbImp + 4) = *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xf000;
      *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6) = uVar14;
      uVar20 = *(uint *)(((PLANET *)lppl)->rgbImp + 6);
      *(uint *)(((PLANET *)lppl)->rgbImp + 4) =
           *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff | 0xf000;
      *(uint *)(((PLANET *)lppl)->rgbImp + 6) = uVar20 & 0xfffe | 1;
    }
    for (i = 0; i < 3; i = i + 1) {
      *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = 0;
      *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
      iEnv = Random(0x32);
      sVar9 = Random(0x32);
      cVar8 = (char)sVar9 + '\x01' + (char)iEnv;
      ((PLANET *)lppl)->rgEnvVarOrig[i] = cVar8;
      ((PLANET *)lppl)->rgEnvVar[i] = cVar8;
      iEnv = Random(0x28);
      sVar9 = Random(0x28);
      ((PLANET *)lppl)->rgMinConc[i] = (char)sVar9 + '\x19' + (char)iEnv;
    }
    break;
  case 0x1b:
    idPlayer = ((PLANET *)lppl)->iPlayer;
    LookupBestPlanetaryScanner((PART *)&stack0xffe2);
    idPlayer = -1;
    iItem = (cshDamaged & 0xffU) + 0x12;
  case 0x12:
  case 0x13:
  case 0x14:
  case 0x15:
  case 0x16:
  case 0x17:
  case 0x18:
  case 0x19:
  case 0x1a:
    FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmHasBuiltNewPlanetaryScanner,lppl->id,lppl->id,
                     -0x8000,iItem + -0x12,0,0,0,0);
    dpOrig = iItem + -0x12;
    iEnv = (int)dpOrig >> 0xf;
    lVar18 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffce);
    uVar20 = *(uint *)(((PLANET *)lppl)->rgbImp + 6);
    *(uint *)(((PLANET *)lppl)->rgbImp + 4) =
         *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff | (uint)lVar18;
    *(uint *)(((PLANET *)lppl)->rgbImp + 6) = uVar20 & 0xfffe | (uint)((ulong)lVar18 >> 0x10);
    break;
  default:
    return 0;
  }
  return 1;
}



// ======================================================================
// Function: CreateShip
// Address: 10b8:2fd6
// Segment: MEMORY_TURN2
// ======================================================================


void CreateShip(short iPlr,FLEET *lpfl,short ishdef,short cShip)

{
  uint *puVar1;
  int *piVar2;
  uint uVar3;
  undefined2 uVar4;
  int iVar5;
  
  ((FLEET *)lpfl)->rgcsh[ishdef] = ((FLEET *)lpfl)->rgcsh[ishdef] + cShip;
  uVar4 = *(undefined2 *)(iPlr * 4 + 0x100);
  iVar5 = *(int *)(iPlr * 4 + 0xfe) + ishdef * 0x93;
  puVar1 = (uint *)(iVar5 + 0x83);
  uVar3 = *puVar1;
  *puVar1 = *puVar1 + cShip;
  piVar2 = (int *)(iVar5 + 0x85);
  *piVar2 = *piVar2 + (cShip >> 0xf) + (uint)CARRY2(uVar3,cShip);
  uVar4 = *(undefined2 *)(iPlr * 4 + 0x100);
  iVar5 = *(int *)(iPlr * 4 + 0xfe) + ishdef * 0x93;
  puVar1 = (uint *)(iVar5 + 0x7f);
  uVar3 = *puVar1;
  *puVar1 = *puVar1 + cShip;
  piVar2 = (int *)(iVar5 + 0x81);
  *piVar2 = *piVar2 + (cShip >> 0xf) + (uint)CARRY2(uVar3,cShip);
  return;
}



// ======================================================================
// Function: RandomEvents
// Address: 10b8:3064
// Segment: MEMORY_TURN2
// ======================================================================


void RandomEvents(void)

{
  MeteorStrike();
  PlanetaryClimateChange();
  DiscoverNewMinerals();
  MysteryTrader();
  return;
}



// ======================================================================
// Function: TransferToOthers
// Address: 10b8:3088
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lpxfCur */
/* WARNING: Variable defined which should be unmapped: idm */

void TransferToOthers(void)

{
  XFERFULL *p6;
  short sVar1;
  uint uVar2;
  uint uVar3;
  MessageId MVar4;
  int iVar5;
  undefined2 uVar6;
  PLANET *pPVar7;
  XFERFULL *pXVar8;
  ulong uVar9;
  ulong uVar10;
  ulong uVar11;
  XFERFULL *lpxfCur;
  XFERFULL *pXVar12;
  short idm;
  short i;
  short idSrc;
  uint local_104;
  undefined1 local_86 [2];
  short local_84;
  short idDst;
  XFERFULL *l2;
  int local_6;
  
  if (cXferFull != 0) {
    pXVar12 = (XFERFULL *)CONCAT22(lpxf._2_2_,(XFERFULL *)lpxf + cXferFull);
    lpxfCur = (XFERFULL *)CONCAT22(lpxf._2_2_,(XFERFULL *)lpxf);
    while ((XFERFULL *)lpxfCur < (XFERFULL *)pXVar12) {
      uVar6 = (undefined2)((ulong)lpxfCur >> 0x10);
      sVar1 = FLookupObject((int)(uint)((XFERFULL *)lpxfCur)->bFlags_0x4 >> 4,
                                  ((XFERFULL *)lpxfCur)->id2,local_86);
      if (sVar1 != 0) {
        if ((((XFERFULL *)lpxfCur)->bFlags_0x4 & 0xf) == 1) {
          pPVar7 = LpplFromId(lpxfCur->id1);
          local_104 = ((PLANET *)pPVar7)->iPlayer;
        }
        else {
          local_104 = lpxfCur->id1 >> 9 & 0xf;
        }
        for (i = 0; i < 5; i = i + 1) {
          l2 = *(XFERFULL **)(((XFERFULL *)lpxfCur)->rgcQuan + i);
          local_6 = *(int *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
          if ((l2 != (XFERFULL *)0x0) || (local_6 != 0)) {
            pXVar8 = (XFERFULL *)
                     ChgCargo((int)(uint)((XFERFULL *)lpxfCur)->bFlags_0x4 >> 4,
                                    ((XFERFULL *)lpxfCur)->id2,i,(long)CONCAT22(local_6,l2),
                                    (void *)0x0);
            iVar5 = (int)((ulong)pXVar8 >> 0x10);
            if (((XFERFULL *)pXVar8 == l2) && (iVar5 == local_6)) {
              if (i == 4) {
                MVar4 = idmSuccessfullyTransferred2;
              }
              else {
                MVar4 = idmSuccessfullyTransferred;
              }
              if ((((XFERFULL *)lpxfCur)->bFlags_0x4 & 0xf) == 2) {
                uVar2 = 0x8000;
              }
              else {
                uVar2 = 0;
              }
              uVar2 = lpxfCur->id1 | uVar2;
              if ((int)(uint)((XFERFULL *)lpxfCur)->bFlags_0x4 >> 4 == 2) {
                uVar3 = 0x8000;
              }
              else {
                uVar3 = 0;
              }
              idDst = ((XFERFULL *)lpxfCur)->id2 | uVar3;
              uVar10 = CONCAT22(idDst,i);
              uVar9 = __aFulshr(uVar10,0);
              FSendPlrMsg(local_104,MVar4,uVar2,uVar2,(short)uVar10,(short)uVar9,(short)uVar10,
                               (short)(uVar10 >> 0x10),0,0);
              if (i == 4) {
                MVar4 = idmSuccessfullyReceived2;
              }
              else {
                MVar4 = idmSuccessfullyReceived;
              }
              lpxfCur = (XFERFULL *)0x0;
              uVar10 = CONCAT22(uVar2,i);
              uVar9 = __aFulshr(uVar10,0);
              FSendPlrMsg(local_84,MVar4,idDst,idDst,(short)uVar10,(short)uVar9,(short)uVar10,
                               (short)(uVar10 >> 0x10),0,0);
            }
            else {
              if (i == 4) {
                idm = 0x47;
              }
              else {
                idm = 0x46;
              }
              if ((((XFERFULL *)lpxfCur)->bFlags_0x4 & 0xf) == 2) {
                uVar2 = 0x8000;
              }
              else {
                uVar2 = 0;
              }
              uVar2 = lpxfCur->id1 | uVar2;
              if ((int)(uint)((XFERFULL *)lpxfCur)->bFlags_0x4 >> 4 == 2) {
                uVar3 = 0x8000;
              }
              else {
                uVar3 = 0;
              }
              idDst = ((XFERFULL *)lpxfCur)->id2 | uVar3;
              if (((XFERFULL *)pXVar8 == (XFERFULL *)0x0) && (iVar5 == 0)) {
                idm = idm + 4;
              }
              uVar9 = __aFulshr((ulong)pXVar12,idm);
              uVar11 = CONCAT22(idDst,i);
              uVar10 = __aFulshr(uVar11,(ushort)(XFERFULL *)pXVar8);
              FSendPlrMsg(local_104,idm,uVar2,uVar2,(short)l2,(short)uVar10,(short)uVar11,
                               (short)(uVar11 >> 0x10),(short)(XFERFULL *)pXVar8,(short)uVar9);
              if (i == 4) {
                MVar4 = idmReceivedHoweverColonistsSentRemainsOtherColonist;
              }
              else {
                MVar4 = idmReceivedHoweverSentRemainderLostSpace;
              }
              if (((int)uVar11 == 0) && ((int)(uVar11 >> 0x10) == 0)) {
                lpxfCur = (XFERFULL *)0x0;
                uVar10 = CONCAT22(uVar2,i);
                uVar9 = __aFulshr(uVar10,0);
                FSendPlrMsg(local_84,MVar4 + 
                                          idmPlanetaryDefensesGroundTroopsDestroyedInvadingTr,idDst,
                                 idDst,(short)l2,(short)uVar9,(short)uVar10,(short)(uVar10 >> 0x10),
                                 0,0);
              }
              else {
                uVar9 = __aFulshr((ulong)pXVar12,MVar4);
                p6 = l2;
                lpxfCur = (XFERFULL *)CONCAT22((short)uVar9,l2);
                uVar11 = CONCAT22(uVar2,i);
                uVar10 = __aFulshr(uVar11,(ushort)l2);
                FSendPlrMsg(local_84,MVar4,idDst,idDst,(short)uVar11,(short)uVar10,
                                 (short)uVar11,(short)(uVar11 >> 0x10),(short)p6,(short)uVar9);
              }
            }
          }
        }
      }
      lpxfCur = (XFERFULL *)CONCAT22(lpxfCur._2_2_,(XFERFULL *)lpxfCur + 1);
    }
  }
  return;
}



// ======================================================================
// Function: DropColonists
// Address: 10b8:34e2
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Variable defined which should be unmapped: ipq */
/* WARNING: Variable defined which should be unmapped: prod */
/* WARNING: Removing unreachable block (ram,0x10b838bb) */
/* WARNING: Removing unreachable block (ram,0x10b842e9) */
/* WARNING: Removing unreachable block (ram,0x10b84385) */

void DropColonists(void)

{
  uint *puVar1;
  int *piVar2;
  int iVar3;
  undefined4 uVar4;
  short sVar5;
  uint uVar6;
  COLDROP *pCVar7;
  COLDROP *pCVar8;
  int iVar9;
  uint *puVar10;
  PL *unaff_SI;
  PL *unaff_DI;
  undefined2 uVar11;
  undefined2 unaff_SS;
  bool bVar12;
  ulong uVar13;
  long lVar14;
  PLANET *pPVar15;
  ulong uVar16;
  ushort uVar17;
  short sVar18;
  short sVar19;
  undefined2 uVar20;
  ushort p1;
  short p7;
  undefined2 uVar21;
  uint uVar22;
  PL *pPVar23;
  ushort in_stack_0000fefe;
  undefined2 in_stack_0000ff00;
  short ipq;
  PROD prod;
  short iDst;
  short cpq;
  uint lPower;
  uint rgcCol [32];
  float pctSurvive;
  short cSides;
  uint rgcPower [32];
  short i;
  uint c2nd;
  uint local_62;
  undefined4 lOldPop;
  uint cColTot;
  int local_5a;
  short iplrOldOwner;
  short idPlanet;
  short iMax;
  COLDROP *lpcdCur;
  undefined4 cPowerTot;
  undefined4 lDefensePower;
  PLANET pl;
  uint cMax;
  uint local_c;
  short fTie;
  COLDROP *lpcdLook;
  
  if (cColDrop != 0) {
    pCVar7 = (COLDROP *)lpcd + cColDrop;
    lpcdCur = (COLDROP *)CONCAT22(lpcd._2_2_,(COLDROP *)lpcd);
    while ((COLDROP *)lpcdCur < pCVar7) {
      uVar11 = (undefined2)((ulong)lpcdCur >> 0x10);
      if ((((COLDROP *)lpcdCur)->idPlanetDst != -1) &&
         (((int)((COLDROP *)lpcdCur)->cColonist != 0 ||
          (*(int *)((int)&((COLDROP *)lpcdCur)->cColonist + 2) != 0)))) {
        _memset(rgcCol,0,0x40);
        _memset(rgcPower,0,0x40);
        cPowerTot._0_2_ = 0;
        cPowerTot._2_2_ = 0;
        cColTot = 0;
        local_5a = 0;
        idPlanet = ((COLDROP *)lpcdCur)->idPlanetDst;
        FLookupPlanet(idPlanet,&pl);
        iplrOldOwner = pl.iPlayer;
        CalcPctSurvive((PLANET *)CONCAT22(unaff_SS,&pl),&pctSurvive,(float *)0x0);
        pctSurvive = (fRam11201d8e - pctSurvive) / fRam11201d92 + pctSurvive;
        lpcdLook = lpcdCur;
        while ((COLDROP *)lpcdLook < pCVar7) {
          uVar11 = (undefined2)((ulong)lpcdLook >> 0x10);
          if (idPlanet == ((COLDROP *)lpcdLook)->idPlanetDst) {
            sVar5 = GetRaceStat((PLAYER *)rgplr + ((COLDROP *)lpcdLook)->idPlr,
                                      rsMajorAdv);
            pCVar8 = (COLDROP *)lpcdLook;
            uVar11 = (undefined2)((ulong)lpcdLook >> 0x10);
            if ((sVar5 == raMacintosh) &&
               (((pCVar8->wFlags_0x6 & 1) == 0 || (pl.iPlayer != 0xffff)))) {
              FSendPlrMsg2(pCVar8->idPlr,idmColonistsAttemptingSetShopReducedProtoplasmicBlo,
                                pl.id,pl.id,0);
            }
            else if ((pl.iPlayer == 0xffff) && ((pCVar8->wFlags_0x6 & 1) == 0)) {
              p7 = 0;
              sVar19 = 0;
              sVar18 = 0;
              sVar5 = 0;
              uVar6 = pl.id;
              uVar13 = __aFulshr((ulong)(uint)pl.id,0);
              uVar11 = (undefined2)((ulong)lpcdLook >> 0x10);
              FSendPlrMsg(((COLDROP *)lpcdLook)->idPlr,
                               idmColonistsForcedTransportDiedBecauseDidColonize,pl.id,
                               (short)((COLDROP *)lpcdLook)->cColonist,(short)uVar13,uVar6,sVar5,
                               sVar18,sVar19,p7);
            }
            else if (((pl.wFlags_0x4 >> 9 & 1) == 0) || (pl.iPlayer == 0xffff)) {
              uVar22 = *(uint *)&pCVar8->cColonist;
              iVar9 = *(int *)((int)&pCVar8->cColonist + 2);
              iVar3 = pCVar8->idPlr;
              puVar1 = rgcCol + iVar3 * 2;
              uVar6 = *puVar1;
              *puVar1 = *puVar1 + uVar22;
              rgcCol[iVar3 * 2 + 1] = rgcCol[iVar3 * 2 + 1] + iVar9 + (uint)CARRY2(uVar6,uVar22);
              uVar11 = (undefined2)((ulong)lpcdLook >> 0x10);
              pCVar8 = (COLDROP *)lpcdLook;
              bVar12 = CARRY2(cColTot,*(uint *)&pCVar8->cColonist);
              cColTot = cColTot + *(uint *)&pCVar8->cColonist;
              local_5a = local_5a + *(int *)((int)&pCVar8->cColonist + 2) + (uint)bVar12;
              sVar5 = GetRaceStat((PLAYER *)rgplr + pCVar8->idPlr,rsMajorAdv);
              if (sVar5 == raAttack) {
                lPower = 0xa5;
              }
              else {
                sVar5 = GetRaceStat((PLAYER *)rgplr + ((COLDROP *)lpcdLook)->idPlr,
                                          rsMajorAdv);
                if (sVar5 == raMacintosh) {
                  lPower = 0;
                }
                else {
                  lPower = 0x6e;
                }
              }
              uVar21 = 0;
              uVar20 = 100;
              uVar11 = (undefined2)((ulong)lpcdLook >> 0x10);
              uVar13 = __aFulmul(CONCAT22(*(undefined2 *)
                                                   ((int)&((COLDROP *)lpcdLook)->cColonist + 2),
                                                  (int)((COLDROP *)lpcdLook)->cColonist),
                                         (ulong)lPower);
              uVar13 = __aFldiv(uVar13,CONCAT22(uVar21,uVar20));
              prod.dwFlags = uVar13;
              lVar14 = __ftol((double)CONCAT26(in_stack_0000ff00,
                                                       CONCAT24(in_stack_0000fefe,
                                                                (PL *)CONCAT22(unaff_SI,unaff_DI))))
              ;
              cPowerTot = lVar14 + cPowerTot;
              iVar9 = ((COLDROP *)lpcdLook)->idPlr;
              puVar1 = rgcPower + iVar9 * 2;
              uVar6 = *puVar1;
              *puVar1 = *puVar1 + (uint)lVar14;
              rgcPower[iVar9 * 2 + 1] =
                   rgcPower[iVar9 * 2 + 1] + (int)((ulong)lVar14 >> 0x10) +
                   (uint)CARRY2(uVar6,(uint)lVar14);
            }
            else {
              FSendPlrMsg2(pCVar8->idPlr,idmColonistsAssaultingHaveKilledForcesOrbitingStarb,
                                pl.id,pl.id,0);
            }
            ((COLDROP *)lpcdLook)->idPlanetDst = -1;
          }
          lpcdLook = (COLDROP *)CONCAT22(lpcdLook._2_2_,(COLDROP *)lpcdLook + 1);
        }
        if (pl.iPlayer == 0xffff) {
          lDefensePower._0_2_ = 0;
          lDefensePower._2_2_ = 0;
          lDefensePower = 0;
          lOldPop._0_2_ = 0;
          lOldPop._2_2_ = 0;
          lOldPop = 0;
LAB_10b8_3b02:
          cMax = 0xffff;
          local_c = 0xffff;
          c2nd = 0;
          local_62 = 0;
          cSides = 0;
          fTie = 0;
          iMax = 0;
          for (i = 0; i < game.cPlayer; i = i + 1) {
            if ((rgcCol[i * 2] != 0) || (rgcCol[i * 2 + 1] != 0)) {
              cSides = cSides + 1;
              if (((int)local_c <= (int)rgcPower[i * 2 + 1]) &&
                 (((int)local_c < (int)rgcPower[i * 2 + 1] || (cMax <= rgcPower[i * 2])))) {
                if ((rgcPower[i * 2] == cMax) && (rgcPower[i * 2 + 1] == local_c)) {
                  fTie = 1;
                }
                else {
                  fTie = 0;
                  c2nd = cMax;
                  local_62 = local_c;
                  cMax = rgcPower[i * 2];
                  local_c = rgcPower[i * 2 + 1];
                  iMax = i;
                }
              }
            }
          }
          if (((int)local_c < 1) && ((int)local_c < 0)) goto TURN2_IncCur;
          if (fTie == 0) {
            if (iplrOldOwner == -1) {
              if (cSides < 2) {
                sVar18 = 0;
                uVar17 = pl.id;
                p1 = pl.id;
                sVar5 = GetRaceStat((PLAYER *)rgplr + iMax,rsMajorAdv);
                FSendPlrMsg2(iMax,(sVar5 == raMacintosh) + idmColonistsControl,uVar17,p1,sVar18
                                 );
              }
              else {
                for (i = 0; i < 0x10; i = i + 1) {
                  if ((rgcCol[i * 2] != 0) || (rgcCol[i * 2 + 1] != 0)) {
                    if (i == iMax) {
                      FSendPlrMsg2(i,idmInvolvedWayRaceUninhabitedPlanetForcesCrush,pl.id,
                                        cSides,pl.id);
                    }
                    else {
                      FSendPlrMsg(i,idmColonistsDestroyedWayRaceUninhabitedPlanetContro,pl.id,
                                       cSides,pl.id,iMax | 0xb0,0,0,0,0);
                    }
                  }
                }
              }
            }
            else {
              for (i = 0; i < 0x10; i = i + 1) {
                if ((rgcCol[i * 2] != 0) || (rgcCol[i * 2 + 1] != 0)) {
                  if (i == iMax) {
                    FSendPlrMsg2(i,idmTroopsCrushSColonistsControlPlanet,pl.id,
                                      iplrOldOwner | 0x20,pl.id);
                  }
                  else {
                    FSendPlrMsg2(i,idmColonistsDroppedDestroyedSpiritedFighting,pl.id,pl.id,0);
                  }
                }
              }
              sVar19 = 0;
              sVar18 = 0;
              sVar5 = 0;
              uVar13 = __aFulshr(0,0);
              FSendPlrMsg(iplrOldOwner,idmHaveAttackedFirstRateStormTroopersThough,pl.id,
                               iMax | 0x30,pl.id,rgcCol[iMax * 2],(short)uVar13,sVar5,sVar18,sVar19)
              ;
              _memset((byte *)rgTechBattle,0,6);
              _memset((byte *)rgTechTrader,0,0xd);
              for (i = 0; i < 6; i = i + 1) {
                ((byte *)rgTechBattle)[i] = *(byte *)(iplrOldOwner * 0xc0 + 0x59bc + i);
              }
              i = ITechLearnATech
                            (iMax,-1,pl.id,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                             (ushort *)0x0);
              pl.iPlayer = 0xffff;
            }
            if (iMax != -1) {
              uVar6 = (uint)*(byte *)((int)&rgplr[0].zpq1 + 1 + iMax * 0xc0);
              prod.dwFlags._2_2_ = (uint)*(byte *)((int)&rgplr[0].zpq1 + iMax * 0xc0);
              lVar14 = __aFlshl((long)CONCAT22(unaff_SI,unaff_DI),in_stack_0000fefe);
              pl.rgbImp._4_2_ = pl.rgbImp._4_2_ | (uint)lVar14;
              pl.rgbImp._6_2_ = pl.rgbImp._6_2_ & 0xff7f | (uint)((ulong)lVar14 >> 0x10);
              if (uVar6 != 0) {
                pl.lpplprod = (PLPROD *)
                              LpplAlloc(4,(uint)*(byte *)((int)&rgplr[0].zpq1 + 1
                                                                 + iMax * 0xc0),htOrd);
                unaff_SI = (PL *)0x1118;
                _memset(&prod,0,4);
                prod.dwFlags._2_2_ = prod.dwFlags._2_2_ & 0xfff1 | 2;
                iDst = 0;
                for (ipq = 0; ipq < (int)uVar6; ipq = ipq + 1) {
                  unaff_SI = (PL *)0x10e0;
                  sVar5 = GetRaceStat((PLAYER *)rgplr + iMax,rsMajorAdv);
                  if ((sVar5 != raMacintosh) ||
                     (2 < (*(uint *)(iMax * 0xc0 + 0x59fa + ipq * 2) & 0x3f))) {
                    unaff_SI = (PL *)0x10e0;
                    sVar5 = GetRaceStat((PLAYER *)rgplr + iMax,rsMajorAdv);
                    if ((sVar5 != raTerra) ||
                       (((*(uint *)(iMax * 0xc0 + 0x59fa + ipq * 2) & 0x3f) != 4 &&
                        ((*(uint *)(iMax * 0xc0 + 0x59fa + ipq * 2) & 0x3f) != 5)))) {
                      lVar14 = __aFlshl((ulong)(uint)ipq << 0x10,(uint)prod.dwFlags);
                      prod.dwFlags._0_2_ = (uint)prod.dwFlags & 0x3ff | (uint)lVar14;
                      prod.dwFlags._2_2_ =
                           prod.dwFlags._2_2_ & 0xfffe | (uint)((ulong)lVar14 >> 0x10);
                      in_stack_0000ff00 = 0;
                      unaff_SI = (PL *)0x1118;
                      lVar14 = __aFlshl((ulong)(uint)ipq << 0x10,(uint)prod.dwFlags);
                      prod.dwFlags._0_2_ = (uint)prod.dwFlags & 0xfc00 | (uint)lVar14;
                      prod.dwFlags._2_2_ = prod.dwFlags._2_2_ | (uint)((ulong)lVar14 >> 0x10);
                      ((PL *)((PLPROD *)pl.lpplprod + iDst + 1))->wFlags = (uint)prod.dwFlags;
                      *(uint *)&((PL *)((PLPROD *)pl.lpplprod + iDst + 1))->iMax =
                           prod.dwFlags._2_2_;
                      iDst = iDst + 1;
                    }
                  }
                }
                if (iDst < 1) {
                  pPVar23 = (PL *)(PLPROD *)pl.lpplprod;
                  in_stack_0000fefe = pl.lpplprod._2_2_;
                  FreePl((PL *)pl.lpplprod);
                  pl.lpplprod = (PLPROD *)0x0;
                  unaff_DI = unaff_SI;
                  unaff_SI = pPVar23;
                }
                else {
                  ((PLPROD *)pl.lpplprod)->iprodMac = (byte)iDst;
                  unaff_DI = (PL *)((int)&rgshdef[4].hul + 0x12);
                  in_stack_0000fefe = pl.id;
                  pPVar15 = LpplFromId(pl.id);
                  uVar11 = (undefined2)((ulong)pPVar15 >> 0x10);
                  *(PLPROD **)&((PLANET *)pPVar15)->lpplprod = (PLPROD *)pl.lpplprod;
                  *(undefined2 *)((int)&((PLANET *)pPVar15)->lpplprod + 2) = pl.lpplprod._2_2_;
                }
              }
            }
            pl.iPlayer = iMax;
            sVar5 = GetRaceStat((PLAYER *)rgplr + iMax,rsMajorAdv);
            if (sVar5 == raMacintosh) {
              pl.wFlags_0x4 = pl.wFlags_0x4 & 0xfdff | 0x200;
              pl.lStarbase._0_2_ = (uint)pl.lStarbase & 0xfff0;
              uVar4 = *(undefined4 *)(iMax * 4 + 0x14c);
              uVar11 = (undefined2)((ulong)uVar4 >> 0x10);
              iVar9 = (int)uVar4;
              puVar1 = (uint *)(iVar9 + 0x83);
              uVar6 = *puVar1;
              *puVar1 = *puVar1 + 1;
              piVar2 = (int *)(iVar9 + 0x85);
              *piVar2 = *piVar2 + (uint)(0xfffe < uVar6);
              uVar4 = *(undefined4 *)(iMax * 4 + 0x14c);
              uVar11 = (undefined2)((ulong)uVar4 >> 0x10);
              iVar9 = (int)uVar4;
              puVar1 = (uint *)(iVar9 + 0x7f);
              uVar6 = *puVar1;
              *puVar1 = *puVar1 + 1;
              piVar2 = (int *)(iVar9 + 0x81);
              *piVar2 = *piVar2 + (uint)(0xfffe < uVar6);
            }
            if ((cPowerTot == 0) || ((cMax == 0 && (local_c == 0)))) {
              uVar13 = CONCAT22(rgcCol[iMax * 2 + 1],rgcCol[iMax * 2]);
            }
            else {
              uVar13 = cPowerTot;
              uVar16 = __aFulmul(CONCAT22(local_c,cMax),cPowerTot - lDefensePower);
              uVar13 = __aFldiv(uVar16,uVar13);
              uVar6 = cMax;
              uVar22 = local_c;
              uVar13 = __aFulmul(CONCAT22(rgcCol[iMax * 2 + 1],rgcCol[iMax * 2]),uVar13);
              uVar13 = __aFldiv(uVar13,CONCAT22(uVar22,uVar6));
            }
            if ((-1 < (int)local_62) && ((0 < (int)local_62 || (c2nd != 0)))) {
              uVar6 = cMax;
              uVar22 = local_c;
              pl.rgwtMin[3] = uVar13;
              uVar13 = __aFulmul(uVar13,CONCAT22((local_c - local_62) - (uint)(cMax < c2nd),
                                                         cMax - c2nd));
              uVar13 = __aFldiv(uVar13,CONCAT22(uVar22,uVar6));
            }
            if ((long)uVar13 < 1) {
              uVar13 = 1;
            }
          }
          else {
            uVar13 = pl.rgwtMin[3];
            for (i = 0; pl.rgwtMin[3] = uVar13, i < game.cPlayer; i = i + 1) {
              if ((rgcCol[i * 2] != 0) || (rgcCol[i * 2 + 1] != 0)) {
                FSendPlrMsg2(i,idmInvolvedWayAssaultNobodysTroopsSurvivedBrutal,pl.id,cSides,
                                  pl.id);
                uVar13 = pl.rgwtMin[3];
              }
            }
            if (iplrOldOwner != -1) {
              FSendPlrMsg2(iplrOldOwner,idmMultitudeEnemiesHaveMountedProngAttackResulting,
                                pl.id,cSides,pl.id);
              pl.iPlayer = 0xffff;
              uVar13 = pl.rgwtMin[3];
            }
          }
        }
        else {
          sVar5 = GetRaceStat((PLAYER *)rgplr + pl.iPlayer,rsMajorAdv);
          if (sVar5 == raDefend) {
            lPower = 200;
          }
          else {
            lPower = 100;
          }
          uVar20 = 0;
          uVar11 = 100;
          uVar13 = __aFulmul(pl.rgwtMin[3],(ulong)lPower);
          lVar14 = __aFldiv(uVar13,CONCAT22(uVar20,uVar11));
          lDefensePower = lVar14;
          if (lVar14 <= (long)cPowerTot) {
            lOldPop = pl.rgwtMin[3];
            UninhabitPlanet((PLANET *)CONCAT22(unaff_SS,&pl));
            goto LAB_10b8_3b02;
          }
          for (i = 0; lDefensePower = lVar14, i < 0x10; i = i + 1) {
            if (rgcCol[i * 2] == 0) {
              bVar12 = rgcCol[i * 2 + 1] == 0;
              if (!bVar12) goto code_r0x10b838ea;
            }
            else {
              bVar12 = false;
code_r0x10b838ea:
              __aFfcompp();
              if (bVar12) {
                sVar19 = 0;
                sVar18 = 0;
                sVar5 = 0;
                uVar6 = pl.iPlayer | 0x30;
                uVar17 = pl.id;
                uVar13 = __aFulshr(CONCAT22(pl.iPlayer,pl.id) | 0x300000,0);
                FSendPlrMsg(i,idmColonistsDroppedMassacredGroundTroops,pl.id,rgcCol[i * 2],
                                 (short)uVar13,uVar17,uVar6,sVar5,sVar18,sVar19);
                sVar19 = 0;
                sVar18 = 0;
                sVar5 = 0;
                uVar6 = i | 0x30;
                uVar13 = __aFulshr((ulong)uVar6,0);
                FSendPlrMsg(pl.iPlayer,idmGroundTroopsValiantlyDestroyedAttackingBarbarian,
                                 pl.id,pl.id,rgcCol[i * 2],(short)uVar13,uVar6,sVar5,sVar18,sVar19);
                lVar14 = lDefensePower;
              }
              else {
                sVar19 = 0;
                sVar18 = 0;
                uVar6 = pl.iPlayer | 0x30;
                prod.dwFlags._0_2_ = 10000;
                prod.dwFlags._2_2_ = 0;
                lVar14 = __ftol((double)CONCAT26(unaff_DI,(uint6)uVar6));
                sVar5 = (short)lVar14;
                uVar17 = pl.id;
                uVar13 = __aFulshr(CONCAT22(sVar5,pl.id),uVar6);
                FSendPlrMsg(i,idmColonistsDroppedDestroyedPlanetaryDefensesRestMa,pl.id,
                                 rgcCol[i * 2],(short)uVar13,uVar17,sVar5,uVar6,sVar18,sVar19);
                sVar19 = 0;
                sVar18 = 0;
                sVar5 = 0;
                uVar6 = i | 0x30;
                uVar13 = __aFulshr((ulong)uVar6,0);
                FSendPlrMsg(pl.iPlayer,idmPlanetaryDefensesGroundTroopsDestroyedInvadingTr,
                                 pl.id,pl.id,rgcCol[i * 2],(short)uVar13,uVar6,sVar5,sVar18,sVar19);
                lVar14 = lDefensePower;
              }
            }
          }
          uVar13 = __aFulmul(pl.rgwtMin[3],cPowerTot);
          lVar14 = __aFldiv(uVar13,lVar14);
          uVar13 = pl.rgwtMin[3] - lVar14;
        }
        if (pl.iPlayer != 0xffff) {
          pl.rgwtMin[3] = uVar13;
          uVar16 = __aFulshr((ulong)CONCAT22(unaff_SI,unaff_DI),in_stack_0000fefe);
          uVar13 = pl.rgwtMin[3];
          if (((uVar16 & 1) != 0) &&
             (pl.rgbImp._6_2_ = pl.rgbImp._6_2_ & 0xffbf, (game.wCrap >> 7 & 1) == 0)) {
            sVar5 = Random(6);
            sVar18 = Random(0x12d);
            iDst = sVar18 + 100;
            if (pl.rgwtMin[3] < 10) {
              iDst = ((int)pl.rgwtMin[3] * iDst) / 10;
            }
            FSendPlrMsg(pl.iPlayer,idmColonistsSettlingHaveFoundStrangeArtifactBoostin,-2,pl.id
                             ,sVar5,iDst,0,0,0,0);
            prod.dwFlags = (ulong)iDst;
            puVar10 = (uint *)(pl.iPlayer * 0xc0 + 0x59c2 + sVar5 * 4);
            puVar1 = puVar10;
            uVar6 = *puVar1;
            *puVar1 = *puVar1 + iDst;
            puVar1 = puVar10 + 1;
            *puVar1 = *puVar1 + (iDst >> 0xf) + (uint)CARRY2(uVar6,iDst);
            uVar13 = pl.rgwtMin[3];
            if ((game.wCrap >> 1 & 1) == 0) {
              prod.dwFlags = (long)iDst;
            }
          }
        }
        pl.rgwtMin[3] = uVar13;
        FLookupPlanet(-1,&pl);
      }
TURN2_IncCur:
      lpcdCur = (COLDROP *)CONCAT22(lpcdCur._2_2_,(COLDROP *)lpcdCur + 1);
    }
    cColDrop = 0;
  }
  return;
}



// ======================================================================
// Function: HealShips
// Address: 10b8:444c
// Segment: MEMORY_TURN2
// ======================================================================


void HealShips(void)

{
  uint *puVar1;
  int iVar2;
  int iVar3;
  bool bVar4;
  long lVar5;
  short sVar6;
  PLANET *pPVar7;
  int iVar8;
  undefined2 uVar9;
  PLANET *pPVar10;
  HULDEF *pHVar11;
  short ishdef;
  short pct;
  SHDEF *lpshdef;
  FLEET *lpfl;
  short i;
  PLANET *lppl;
  short dpHeal;
  short pctShipHeal;
  
  for (i = 0; i < cFleet; i = i + 1) {
    iVar2 = *(int *)((FLEET **)rglpfl + i);
    iVar3 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    if ((iVar2 == 0) && (iVar3 == 0)) break;
    if (((*(uint *)(iVar2 + 4) >> 10 & 1) == 0) && ((*(uint *)(iVar2 + 4) >> 0xe & 1) == 0)) {
      bVar4 = false;
      pctShipHeal = 0;
      for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
        if (*(int *)(iVar2 + 0x2c + ishdef * 2) != 0) {
          bVar4 = true;
        }
        if (*(int *)(iVar2 + 0xc + ishdef * 2) != 0) {
          iVar8 = *(int *)(iVar2 + 2) * 4;
          if (*(int *)(*(int *)(iVar8 + 0xfe) + ishdef * 0x93) == 0x1a) {
            pctShipHeal = 0x32;
          }
          else if (((uint)pctShipHeal < 5) &&
                  (iVar8 = *(int *)(iVar2 + 2) * 4,
                  *(int *)(*(int *)(iVar8 + 0xfe) + ishdef * 0x93) == 0x19)) {
            pctShipHeal = 0x19;
          }
        }
      }
      if (bVar4) {
        if ((*(uint *)(iVar2 + 4) >> 0xd & 1) == 0) {
          pct = 5;
        }
        else if (*(int *)(iVar2 + 6) == -1) {
          pct = 10;
        }
        else {
          pPVar10 = LpplFromId(*(short *)(iVar2 + 6));
          uVar9 = (undefined2)((ulong)pPVar10 >> 0x10);
          pPVar7 = (PLANET *)pPVar10;
          if (pPVar7->iPlayer == *(int *)(iVar2 + 2)) {
            if (((pPVar7->wFlags_0x4 >> 9 & 1) == 0) ||
               ((*(uint *)((int)&pPVar7->lStarbase + 2) >> 0xe & 1) != 0)) {
              pct = 0x19;
            }
            else {
              iVar8 = pPVar7->iPlayer * 4;
              lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iVar8 + 0x14e),
                                          (SHDEF *)(*(int *)(iVar8 + 0x14c) +
                                                   (*(uint *)&pPVar7->lStarbase & 0xf) * 0x93));
              pHVar11 = LphuldefFromId((lpshdef->hul).ihuldef);
              if ((((HULDEF *)pHVar11)->hul).wtCargoMax == 0) {
                pct = 0x28;
              }
              else {
                pct = 100;
              }
            }
          }
          else if (pPVar7->iPlayer == -1) {
            pct = 0xf;
          }
          else {
            pct = 0xf;
          }
        }
        sVar6 = GetRaceStat((PLAYER *)rgplr + *(int *)(iVar2 + 2),rsMajorAdv);
        if (sVar6 == raDefend) {
          pct = pct << 1;
        }
        for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
          if (*(int *)(iVar2 + 0x2c + ishdef * 2) != 0) {
            if ((uint)(pct + pctShipHeal) < *(uint *)(iVar2 + 0x2c + ishdef * 2) >> 7) {
              iVar8 = *(int *)(iVar2 + 0x2c + ishdef * 2);
              puVar1 = (uint *)(iVar2 + 0x2c + ishdef * 2);
              *puVar1 = *puVar1 & 0x7f;
              puVar1 = (uint *)(iVar2 + 0x2c + ishdef * 2);
              *puVar1 = *puVar1 | iVar8 + (pct + pctShipHeal) * -0x80 & 0xff80U;
            }
            else {
              *(undefined2 *)(iVar2 + 0x2c + ishdef * 2) = 0;
            }
          }
        }
      }
    }
  }
  pPVar7 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < pPVar7) {
    uVar9 = (undefined2)((ulong)lppl >> 0x10);
    if (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) &&
       ((*(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) >> 0xe & 1) == 0)) {
      sVar6 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lppl)->iPlayer,rsMajorAdv);
      if (sVar6 == raDefend) {
        pct = 0x4b;
      }
      else {
        pct = 0x32;
      }
      if (*(uint *)&((PLANET *)lppl)->lStarbase >> 4 != 0) {
        if (*(uint *)&((PLANET *)lppl)->lStarbase >> 4 < (uint)pct) {
          *(uint *)&((PLANET *)lppl)->lStarbase = *(uint *)&((PLANET *)lppl)->lStarbase & 0xf;
        }
        else {
          lVar5 = ((PLANET *)lppl)->lStarbase;
          *(uint *)&((PLANET *)lppl)->lStarbase = *(uint *)&((PLANET *)lppl)->lStarbase & 0xf;
          *(uint *)&((PLANET *)lppl)->lStarbase =
               *(uint *)&((PLANET *)lppl)->lStarbase | (int)lVar5 + pct * -0x10 & 0xfff0U;
        }
      }
    }
    lppl = (PLANET *)CONCAT22(uVar9,(PLANET *)lppl + 1);
  }
  return;
}



// ======================================================================
// Function: AutoTerraform
// Address: 10b8:48f6
// Segment: MEMORY_TURN2
// ======================================================================


void AutoTerraform(void)

{
  int iVar1;
  bool bVar2;
  short sVar3;
  PLANET *pPVar4;
  PLANET *pPVar5;
  undefined2 uVar6;
  short fTerra;
  short rgCost [3];
  short rgMin [3];
  short i;
  PLANET *lppl;
  uint rgp [16];
  short rgMax [4];
  
  bVar2 = false;
  for (i = 0; i < game.cPlayer; i = i + 1) {
    sVar3 = GetRaceStat((PLAYER *)rgplr + i,rsMajorAdv);
    rgp[i] = (uint)(sVar3 == raTerra);
    if (rgp[i] != 0) {
      bVar2 = true;
    }
  }
  if (bVar2) {
    pPVar4 = (PLANET *)lpPlanets + cPlanet;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    while ((PLANET *)lppl < pPVar4) {
      uVar6 = (undefined2)((ulong)lppl >> 0x10);
      if ((((PLANET *)lppl)->iPlayer != -1) && (rgp[((PLANET *)lppl)->iPlayer] != 0)) {
        if (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) && (((PLANET *)lppl)->iPlayer == -1)) {
          ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfdff;
        }
        i = Random(3);
        uVar6 = (undefined2)((ulong)lppl >> 0x10);
        pPVar5 = (PLANET *)lppl;
        if (((*(char *)(pPVar5->iPlayer * 0xc0 + 0x59b2 + i) != -1) &&
            (*(char *)(pPVar5->iPlayer * 0xc0 + 0x59b2 + i) != pPVar5->rgEnvVarOrig[i])) &&
           (sVar3 = Random(10), sVar3 == 0)) {
          uVar6 = (undefined2)((ulong)lppl >> 0x10);
          iVar1 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe);
          if (((0 < iVar1) || ((-1 < iVar1 && (999 < *(uint *)(((PLANET *)lppl)->rgwtMin + 3))))) ||
             (sVar3 = Random(1000), sVar3 < (int)((PLANET *)lppl)->rgwtMin[3])) {
            uVar6 = (undefined2)((ulong)lppl >> 0x10);
            pPVar5 = (PLANET *)lppl;
            if (*(char *)(pPVar5->iPlayer * 0xc0 + 0x59b2 + i) < pPVar5->rgEnvVarOrig[i]) {
              pPVar5->rgEnvVarOrig[i] = pPVar5->rgEnvVarOrig[i] + -1;
            }
            else {
              pPVar5->rgEnvVarOrig[i] = pPVar5->rgEnvVarOrig[i] + '\x01';
            }
            FSendPlrMsg2(pPVar5->iPlayer,idmEngineersHaveManagedImproveUnderlying1,lppl->id,
                              lppl->id,i);
          }
        }
        sVar3 = FCanTerraformLppl(lppl,rgMin,rgMax,rgCost,1);
        if (sVar3 != 0) {
          i = 0;
          while( true ) {
            if (2 < i) break;
            if (rgMin[i] == -1) {
              if (rgMax[i] != -1) {
                ((PLANET *)lppl)->rgEnvVar[i] = (char)rgMax[i];
              }
            }
            else {
              ((PLANET *)lppl)->rgEnvVar[i] = (char)rgMin[i];
            }
            i = i + 1;
          }
          i = PctPlanetDesirability(lppl,((PLANET *)lppl)->iPlayer);
          FSendPlrMsg2(((PLANET *)lppl)->iPlayer,idmHasAutoTerraformedValue,lppl->id,lppl->id,i
                           );
        }
      }
      lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
    }
  }
  return;
}



// ======================================================================
// Function: RemoteTerraforming
// Address: 10b8:4c56
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10b84d0f) */
/* WARNING: Removing unreachable block (ram,0x10b84df0) */

void RemoteTerraforming(void)

{
  FLEET *pFVar1;
  int iVar2;
  undefined2 uVar3;
  int fHelp_00;
  short p3;
  short sVar4;
  int iVar5;
  short sVar6;
  int iVar7;
  MessageId iMsg;
  PLANET *pPVar8;
  long lVar9;
  short pctNew;
  int ipct;
  int local_1c;
  short cAllowed;
  short iEnv;
  short cDone;
  FLEET *lpfl;
  short ifl;
  PLANET *lppl;
  short pctCur;
  short iBest;
  short fHelp;
  
  ifl = 0;
  while( true ) {
    if (cFleet <= ifl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[ifl];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    if (((((pFVar1->wFlags_0x4 >> 10 & 1) == 0) && (pFVar1->idPlanet != -1)) &&
        (((PLANET *)lpPlanets)[pFVar1->idPlanet].iPlayer != -1)) &&
       (lVar9 = PctTerraFromLpfl((FLEET *)CONCAT22(iVar2,pFVar1)),
       uVar3 = lpPlanets._2_2_, 0 < lVar9)) {
      pPVar8 = (PLANET *)lpPlanets + pFVar1->idPlanet;
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,pPVar8);
      if (((pFVar1->iPlayer == pPVar8->iPlayer) ||
          (*(char *)(pFVar1->iPlayer * 0xc0 + 0x5a12 + pPVar8->iPlayer) == '\x01')) ||
         (pFVar1->iPlayer == pPVar8->iPlayer)) {
        fHelp_00 = 1;
      }
      else {
        fHelp_00 = 0;
      }
      if ((fHelp_00 != 0) || ((pPVar8->wFlags_0x4 >> 9 & 1) == 0)) {
        p3 = PctPlanetDesirability
                       ((PLANET *)CONCAT22(lpPlanets._2_2_,pPVar8),pPVar8->iPlayer);
        while( true ) {
          local_1c = (int)((ulong)lVar9 >> 0x10);
          ipct = (int)lVar9;
          if ((lVar9 < 1) ||
             (sVar6 = IBestRemoteTerra((PLANET *)CONCAT22(uVar3,pPVar8),pFVar1->iPlayer,fHelp_00),
             sVar6 == 0)) break;
          sVar4 = _abs(sVar6);
          if (sVar6 < 1) {
            iVar7 = -1;
          }
          else {
            iVar7 = 1;
          }
          iVar7 = (char)pPVar8->rgMinConc[sVar4 + 2] + iVar7;
          iVar5 = iVar7;
          if (99 < iVar7) {
            iVar5 = 99;
          }
          if (iVar5 < 1) {
            iVar7 = 1;
          }
          else if (99 < iVar7) {
            iVar7 = 99;
          }
          pPVar8->rgMinConc[sVar4 + 2] = (byte)iVar7;
          lVar9 = CONCAT22(local_1c - (uint)(ipct == 0),ipct + -1);
        }
        sVar6 = PctPlanetDesirability((PLANET *)CONCAT22(uVar3,pPVar8),pPVar8->iPlayer);
        if (fHelp_00 == 0) {
          iVar7 = 0x15a;
        }
        else {
          iVar7 = 300;
        }
        FSendPlrMsg(pFVar1->iPlayer,iVar7 + (uint)(p3 == sVar6),lpfl->id | 0x8000,lpfl->id,
                         lppl->id,p3,sVar6,0,0,0);
        if ((pFVar1->iPlayer != pPVar8->iPlayer) && (sVar6 != p3)) {
          if (fHelp_00 == 0) {
            iMsg = idmHasDegradedValue;
          }
          else {
            iMsg = idmHasImprovedValue;
          }
          FSendPlrMsg(pPVar8->iPlayer,iMsg,lppl->id,lpfl->id,lppl->id,p3,sVar6,0,0,0);
        }
      }
    }
    ifl = ifl + 1;
  }
  return;
}



// ======================================================================
// Function: FQueueColonistDrop
// Address: 10b8:4faa
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10b84fc1) */

short FQueueColonistDrop(FLEET *lpfl,PLANET *lppl,long cColonists)

{
  uint *puVar1;
  int *piVar2;
  uint uVar3;
  COLDROP *lpcdT;
  short iColDrop;
  
  if (cColonists < 1) {
    cColonists._0_2_ = 1;
  }
  else {
    iColDrop = 0;
    lpcdT = (COLDROP *)CONCAT22(lpcd._2_2_,(COLDROP *)lpcd);
    while( true ) {
      if ((cColDrop <= iColDrop) ||
         ((lpcdT->idFleetSrc == lpfl->id && (((COLDROP *)lpcdT)->idPlanetDst == lppl->id)))) break;
      lpcdT = (COLDROP *)CONCAT22(lpcdT._2_2_,(COLDROP *)lpcdT + 1);
      iColDrop = iColDrop + 1;
    }
    if (iColDrop == cColDrop) {
      if (999 < cColDrop) {
        return 0;
      }
      lpcdT->idFleetSrc = lpfl->id;
      ((COLDROP *)lpcdT)->idPlr = ((FLEET *)lpfl)->iPlayer;
      ((COLDROP *)lpcdT)->idPlanetDst = lppl->id;
      *(undefined2 *)&((COLDROP *)lpcdT)->cColonist = 0;
      *(undefined2 *)((int)&((COLDROP *)lpcdT)->cColonist + 2) = 0;
      ((COLDROP *)lpcdT)->wFlags_0x6 = ((COLDROP *)lpcdT)->wFlags_0x6 & 0xfffe | 1;
      cColDrop = cColDrop + 1;
    }
    puVar1 = (uint *)&((COLDROP *)lpcdT)->cColonist;
    uVar3 = *puVar1;
    *puVar1 = *puVar1 + (uint)cColonists;
    piVar2 = (int *)((int)&((COLDROP *)lpcdT)->cColonist + 2);
    *piVar2 = *piVar2 + cColonists._2_2_ + (uint)CARRY2(uVar3,(uint)cColonists);
  }
  return (uint)cColonists;
}



// ======================================================================
// Function: UpdatePopulations
// Address: 10b8:50a0
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Variable defined which should be unmapped: fMac */

void UpdatePopulations(void)

{
  uint uVar1;
  short sVar2;
  int iVar3;
  PLANET *pPVar4;
  undefined2 uVar5;
  long lVar6;
  ulong uVar7;
  short sVar8;
  ushort p6;
  short sVar9;
  short p7;
  short fMac;
  PLANET *lppl;
  undefined2 lPopChg;
  int local_6;
  
  lVar6 = CONCAT22(local_6,lPopChg);
  pPVar4 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < pPVar4) {
    uVar5 = (undefined2)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl)->iPlayer != -1) &&
       (((int)((PLANET *)lppl)->rgwtMin[3] != 0 ||
        (*(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe) != 0)))) {
      lVar6 = ChgPopFromPlanet(lppl,1);
      if ((lVar6 != 0) &&
         ((((lVar6 < 0x10000 && (lVar6 < 0)) &&
           (iVar3 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe), -1 < iVar3)) &&
          ((0 < iVar3 || ((int)((PLANET *)lppl)->rgwtMin[3] != 0)))))) {
        uVar1 = *(uint *)(((PLANET *)lppl)->rgwtMin + 3);
        iVar3 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe);
        sVar2 = PctPlanetDesirability(lppl,((PLANET *)lppl)->iPlayer);
        if (sVar2 < 0) {
          sVar9 = 0;
          p6 = 0;
          uVar7 = __aFulshr(0,(iVar3 - (int)((ulong)lVar6 >> 0x10)) -
                                      (uint)(uVar1 < (uint)lVar6));
          sVar8 = (short)uVar7;
          sVar2 = (short)((PLANET *)lppl)->rgwtMin[3];
          uVar7 = __aFulshr(CONCAT22(sVar8,sVar2),p6);
          FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmPopulationHasDecreased,lppl->id,lppl->id,
                           sVar9,(short)uVar7,sVar2,sVar8,p6,sVar9);
        }
        else {
          p7 = 0;
          sVar9 = 0;
          sVar8 = 0;
          sVar2 = 0;
          uVar7 = __aFulshr(0,0);
          FSendPlrMsg(((PLANET *)lppl)->iPlayer,
                           idmPopulationHasDecreasedColonistsDueOvercrowding,lppl->id,lppl->id,
                           -(uint)lVar6,(short)uVar7,sVar2,sVar8,sVar9,p7);
        }
      }
    }
    if (((((PLANET *)lppl)->iPlayer != -1) && ((int)((PLANET *)lppl)->rgwtMin[3] == 0)) &&
       (*(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe) == 0)) {
      sVar2 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lppl)->iPlayer,rsMajorAdv);
      local_6 = (int)((ulong)lVar6 >> 0x10);
      if ((local_6 < 1) && (lVar6 < 0)) {
        iVar3 = 0x23;
      }
      else {
        iVar3 = 0x40;
      }
      FSendPlrMsg2(((PLANET *)lppl)->iPlayer,iVar3 + (uint)(sVar2 == raMacintosh),lppl->id,
                        lppl->id,0);
      UninhabitPlanet(lppl);
    }
    if (((PLANET *)lppl)->iPlayer == -1) {
      UninhabitPlanet(lppl);
    }
    lppl = (PLANET *)CONCAT22(uVar5,(PLANET *)lppl + 1);
  }
  return;
}



// ======================================================================
// Function: UpdateGuesses
// Address: 10b8:532c
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10b85499) */
/* WARNING: Removing unreachable block (ram,0x10b8541e) */
/* WARNING: Removing unreachable block (ram,0x10b85443) */
/* WARNING: Removing unreachable block (ram,0x10b8551f) */
/* WARNING: Removing unreachable block (ram,0x10b85543) */

void UpdateGuesses(void)

{
  int iVar1;
  short sVar2;
  PLANET *pPVar3;
  PLANET *pPVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  long lVar6;
  ushort in_stack_0000ffe8;
  uint l;
  float pct;
  PLANET *lppl;
  
  pPVar3 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < pPVar3) {
    uVar5 = (undefined2)((ulong)lppl >> 0x10);
    if (((int)((PLANET *)lppl)->rgwtMin[3] == 0) &&
       (*(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe) == 0)) {
      ((PLANET *)lppl)->uGuesses = 0;
    }
    else {
      sVar2 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lppl)->iPlayer,rsMajorAdv);
      if (sVar2 == raMacintosh) {
        lVar6 = 0;
      }
      else {
        lVar6 = __aFlshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffe8);
        in_stack_0000ffe8 = Random((short)lVar6);
        __aFlshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffe8);
        lVar6 = __aFlshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffe8);
        if (lVar6 < 0xffb) {
          if (lVar6 < 1) {
            lVar6 = 1;
          }
        }
        else {
          lVar6 = 0xffa;
        }
      }
      l = (uint)lVar6;
      uVar5 = (undefined2)((ulong)lppl >> 0x10);
      pPVar4 = (PLANET *)lppl;
      pPVar4->uGuesses = pPVar4->uGuesses & 0xf000 | l & 0xfff;
      if ((*(uint *)(pPVar4->rgbImp + 4) & 0xfff) == 0) {
        pPVar4->uGuesses = pPVar4->uGuesses & 0xfff;
      }
      else {
        CalcPctSurvive(lppl,&pct,(float *)0x0);
        lVar6 = __ftol((double)CONCAT26(l,CONCAT24(in_stack_0000ffe8,
                                                           CONCAT22(unaff_SI,unaff_DI))));
        iVar1 = -(uint)lVar6;
        lVar6 = __aFldiv(CONCAT22((-(uint)(100 < (uint)lVar6) - (int)((ulong)lVar6 >> 0x10))
                                          + (uint)(0xfffb < iVar1 + 100U),iVar1 + 0x68),6);
        l = (uint)lVar6;
        if (lVar6 < 1) {
          l = 1;
        }
        else if (0xf < lVar6) {
          l = 0xf;
        }
        uVar5 = (undefined2)((ulong)lppl >> 0x10);
        ((PLANET *)lppl)->uGuesses = ((PLANET *)lppl)->uGuesses & 0xfff | l << 0xc;
      }
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  return;
}



// ======================================================================
// Function: MineMinerals
// Address: 10b8:55a4
// Segment: MEMORY_TURN2
// ======================================================================


void MineMinerals(void)

{
  undefined2 uVar1;
  PLANET *pPVar2;
  PLANET *lppl;
  long rglQuan [3];
  
  uVar1 = lpPlanets._2_2_;
  pPVar2 = (PLANET *)lpPlanets + cPlanet;
  for (lppl = (PLANET *)lpPlanets; lppl < pPVar2; lppl = lppl + 1) {
    EstMineralsMined((PLANET *)CONCAT22(uVar1,lppl),rglQuan,-1,1);
  }
  return;
}



// ======================================================================
// Function: MeteorStrike
// Address: 10b8:560e
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Variable defined which should be unmapped: j */

void MeteorStrike(void)

{
  int *piVar1;
  uint *puVar2;
  uint uVar3;
  byte bVar4;
  short sVar5;
  short sVar6;
  int iVar7;
  uint uVar8;
  PLANET *pPVar9;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar10;
  ulong uVar11;
  long lVar12;
  short iObj;
  undefined4 uVar13;
  undefined4 uVar14;
  long lVar15;
  short j;
  short iConc;
  short i;
  short rgAffect [3];
  PLANET *lppl;
  short iSize;
  uint rgQuan [8];
  short iT;
  short rgEnv [4];
  
  lVar15 = CONCAT22(unaff_SI,unaff_DI);
  sVar5 = Random(0x14);
  if (sVar5 == 0) {
    sVar5 = Random(cPlanet);
    pPVar9 = (PLANET *)lpPlanets + sVar5;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,pPVar9);
    if (((((pPVar9->iPlayer == -1) || (iVar7 = *(int *)((int)pPVar9->rgwtMin + 0xe), iVar7 < 0)) ||
         ((iVar7 < 1 && (*(uint *)(pPVar9->rgwtMin + 3) < 0x33)))) || (0x13 < game.turn)) &&
       (9 < game.turn)) {
      iSize = Random(4);
      for (i = 0; i < 3; i = i + 1) {
        rgEnv[i] = i;
      }
      for (i = 0; i < 3; i = i + 1) {
        j = Random(3);
        iT = rgEnv[i];
        rgEnv[i] = rgEnv[j];
        rgEnv[j] = iT;
      }
      for (i = 0; i < 3; i = i + 1) {
        rgAffect[i] = i;
        sVar5 = Random(0xfa);
        rgQuan[i * 2] = sVar5 + 0x32U;
        rgQuan[i * 2 + 1] = (int)(sVar5 + 0x32U) >> 0xf;
      }
      for (i = 0; i < 2; i = i + 1) {
        sVar5 = Random(3 - i);
        j = sVar5 + i;
        iT = rgAffect[i];
        rgAffect[i] = rgAffect[j];
        rgAffect[j] = iT;
      }
      i = 0;
      while( true ) {
        pPVar9 = (PLANET *)lppl;
        uVar10 = (undefined2)((ulong)lppl >> 0x10);
        if (game.cPlayer <= i) break;
        uVar14 = 0;
        uVar11 = (ulong)(uint)rgEnv[2];
        uVar13 = CONCAT22(rgEnv[1],rgEnv[0]);
        sVar5 = lppl->id;
        iObj = lppl->id;
        if ((i == pPVar9->iPlayer) &&
           (sVar6 = GetRaceStat((PLAYER *)rgplr + i,rsMajorAdv),
           sVar6 != raMacintosh)) {
          iVar7 = 0x87;
        }
        else {
          iVar7 = 0x83;
        }
        FSendPlrMsg(i,iVar7 + iSize,iObj,sVar5,(short)uVar13,(short)((ulong)uVar13 >> 0x10),
                         (short)uVar11,(short)(uVar11 >> 0x10),(short)uVar14,
                         (short)((ulong)uVar14 >> 0x10));
        i = i + 1;
      }
      if ((pPVar9->iPlayer != -1) &&
         (sVar5 = GetRaceStat((PLAYER *)rgplr + pPVar9->iPlayer,rsMajorAdv),
         sVar5 != raMacintosh)) {
        lVar12 = 100;
        uVar10 = (undefined2)((ulong)lppl >> 0x10);
        uVar11 = __aFulmul(CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                                            (int)((PLANET *)lppl)->rgwtMin[3]),
                                   (long)(iSize * 0x14 + 0x19));
        lVar12 = __aFldiv(uVar11,lVar12);
        uVar10 = (undefined2)((ulong)lppl >> 0x10);
        puVar2 = (uint *)(((PLANET *)lppl)->rgwtMin + 3);
        uVar3 = *puVar2;
        *puVar2 = *puVar2 - (uint)lVar12;
        piVar1 = (int *)((int)((PLANET *)lppl)->rgwtMin + 0xe);
        *piVar1 = (*piVar1 - (int)((ulong)lVar12 >> 0x10)) - (uint)(uVar3 < (uint)lVar12);
      }
      for (i = 0; (i <= iSize && (i < 3)); i = i + 1) {
        sVar5 = Random(17000);
        uVar8 = sVar5 + 3000;
        iVar7 = rgAffect[i];
        puVar2 = rgQuan + iVar7 * 2;
        uVar3 = *puVar2;
        *puVar2 = *puVar2 + uVar8;
        rgQuan[iVar7 * 2 + 1] =
             rgQuan[iVar7 * 2 + 1] + ((int)uVar8 >> 0xf) + (uint)CARRY2(uVar3,uVar8);
        bVar4 = ((PLANET *)lppl)->rgMinConc[rgAffect[i]];
        sVar5 = Random(0x32);
        iConc = (uint)bVar4 + sVar5 + 0x32;
        if (iSize == 3) {
          sVar5 = Random(0xf);
          iConc = iConc + sVar5 + 0xf;
        }
        if (200 < iConc) {
          iConc = 200;
        }
        ((PLANET *)lppl)->rgMinConc[rgAffect[i]] = (byte)iConc;
      }
      for (i = 0; i < 3; i = i + 1) {
        lVar12 = __aFlshr(lVar15,j);
        puVar2 = (uint *)(((PLANET *)lppl)->rgwtMin + i);
        uVar3 = *puVar2;
        *puVar2 = *puVar2 + (uint)lVar12;
        puVar2 = (uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
        *puVar2 = *puVar2 + (int)((ulong)lVar12 >> 0x10) + (uint)CARRY2(uVar3,(uint)lVar12);
      }
      for (i = 0; (i < 3 && (i <= iSize)); i = i + 1) {
        sVar5 = Random(3);
        iT = sVar5 + 3;
        if (iSize == 3) {
          sVar5 = Random(3);
          iT = iT + sVar5 + 3;
        }
        sVar5 = Random(2);
        if (sVar5 != 0) {
          iT = -iT;
        }
        j = ((PLANET *)lppl)->rgEnvVar[i] + iT;
        if (j < 1) {
          j = 1;
        }
        else if (99 < j) {
          j = 99;
        }
        ((PLANET *)lppl)->rgEnvVar[i] = (char)j;
        j = ((PLANET *)lppl)->rgEnvVarOrig[i] + iT;
        if (j < 1) {
          j = 1;
        }
        else if (99 < j) {
          j = 99;
        }
        ((PLANET *)lppl)->rgEnvVarOrig[i] = (char)j;
      }
      TossNonAutoBuildItems(lppl);
    }
  }
  return;
}



// ======================================================================
// Function: TossNonAutoBuildItems
// Address: 10b8:5aec
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10b85bac) */
/* WARNING: Removing unreachable block (ram,0x10b85b74) */
/* WARNING: Removing unreachable block (ram,0x10b85bb1) */
/* WARNING: Variable defined which should be unmapped: iSrc */

void TossNonAutoBuildItems(PLANET *lppl)

{
  undefined2 uVar1;
  undefined2 uVar2;
  undefined2 uVar3;
  PLANET *pPVar4;
  undefined2 *puVar5;
  undefined2 *puVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar7;
  ulong uVar8;
  ulong uVar9;
  short iSrc;
  short iDst;
  
  uVar9 = CONCAT22(unaff_SI,unaff_DI);
  uVar7 = (undefined2)((ulong)lppl >> 0x10);
  pPVar4 = (PLANET *)lppl;
  if ((*(int *)&pPVar4->lpplprod != 0) || (*(int *)((int)&pPVar4->lpplprod + 2) != 0)) {
    iDst = 0;
    for (iSrc = 0; iSrc < (int)(uint)((PLPROD *)pPVar4->lpplprod)->iprodMac; iSrc = iSrc + 1) {
      uVar8 = __aFulshr(uVar9,iSrc);
      if ((((uint)uVar8 & 7) == 1) &&
         (uVar8 = __aFulshr(uVar9,iSrc), ((uint)uVar8 & 0x7f) < 7)) {
        if (iDst < iSrc) {
          uVar1 = *(undefined2 *)((int)&pPVar4->lpplprod + 2);
          puVar5 = (undefined2 *)(*(int *)&pPVar4->lpplprod + 4 + iSrc * 4);
          uVar2 = puVar5[1];
          uVar3 = *(undefined2 *)((int)&pPVar4->lpplprod + 2);
          puVar6 = (undefined2 *)(*(int *)&pPVar4->lpplprod + 4 + iDst * 4);
          *puVar6 = *puVar5;
          puVar6[1] = uVar2;
        }
        iDst = iDst + 1;
      }
    }
    if (iDst < 1) {
      FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pPVar4->lpplprod + 2),
                                    *(PL **)&pPVar4->lpplprod));
      *(undefined2 *)&pPVar4->lpplprod = 0;
      *(undefined2 *)((int)&pPVar4->lpplprod + 2) = 0;
    }
    else {
      ((PLPROD *)pPVar4->lpplprod)->iprodMac = (byte)iDst;
    }
  }
  return;
}



// ======================================================================
// Function: PlanetaryClimateChange
// Address: 10b8:5c54
// Segment: MEMORY_TURN2
// ======================================================================


void PlanetaryClimateChange(void)

{
  int iVar1;
  undefined2 uVar2;
  short sVar3;
  short sVar4;
  PLANET *pPVar5;
  short j;
  short i;
  PLANET *lppl;
  short iT;
  
  sVar3 = Random(0x14);
  if (sVar3 == 0) {
    sVar3 = Random(cPlanet);
    uVar2 = lpPlanets._2_2_;
    pPVar5 = (PLANET *)lpPlanets + sVar3;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,pPVar5);
    if ((((pPVar5->iPlayer == -1) || (iVar1 = *(int *)((int)pPVar5->rgwtMin + 0xe), iVar1 < 0)) ||
        ((iVar1 < 1 && (*(uint *)(pPVar5->rgwtMin + 3) < 0x33)))) || (0x13 < game.turn)) {
      sVar3 = Random(3);
      if (pPVar5->iPlayer != -1) {
        FSendPlrMsg2(pPVar5->iPlayer,idmFundamentalChangesEnvironmentHavePermanentlyAlte,
                          lppl->id,lppl->id,sVar3);
      }
      sVar4 = Random(3);
      iT = sVar4 + 3;
      if (iT == 3) {
        sVar4 = Random(3);
        iT = sVar4 + 6;
      }
      sVar4 = Random(2);
      if (sVar4 != 0) {
        iT = -iT;
      }
      j = pPVar5->rgEnvVar[sVar3] + iT;
      if (j < 1) {
        j = 1;
      }
      else if (99 < j) {
        j = 99;
      }
      pPVar5->rgEnvVar[sVar3] = (char)j;
      j = pPVar5->rgEnvVarOrig[sVar3] + iT;
      if (j < 1) {
        j = 1;
      }
      else if (99 < j) {
        j = 99;
      }
      pPVar5->rgEnvVarOrig[sVar3] = (char)j;
      TossNonAutoBuildItems((PLANET *)CONCAT22(uVar2,pPVar5));
    }
  }
  return;
}



// ======================================================================
// Function: DiscoverNewMinerals
// Address: 10b8:5e0c
// Segment: MEMORY_TURN2
// ======================================================================


void DiscoverNewMinerals(void)

{
  undefined2 uVar1;
  short sVar2;
  short sVar3;
  PLANET *pPVar4;
  short i;
  PLANET *lppl;
  
  sVar2 = Random(0xf - game.mdSize);
  if (sVar2 == 0) {
    sVar2 = Random(cPlanet);
    uVar1 = lpPlanets._2_2_;
    pPVar4 = (PLANET *)lpPlanets + sVar2;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,pPVar4);
    if (9 < game.turn) {
      sVar2 = Random(3);
      if (pPVar4->iPlayer != -1) {
        FSendPlrMsg(pPVar4->iPlayer,idmSurveyorsHaveDiscoveredPreviouslyUnknownDepositS,
                         lppl->id,lppl->id,sVar2,0,0,0,0,0);
      }
      if (pPVar4->rgMinConc[sVar2] < 0xb4) {
        sVar3 = Random(0xf);
        pPVar4->rgMinConc[sVar2] = pPVar4->rgMinConc[sVar2] + (char)sVar3 + '\x05';
      }
    }
  }
  return;
}



// ======================================================================
// Function: MysteryTrader
// Address: 10b8:5efa
// Segment: MEMORY_TURN2
// ======================================================================


void MysteryTrader(void)

{
  short sVar1;
  THING *pTVar2;
  undefined2 uVar3;
  int rgC [4];
  short grbitTrader;
  THING *lpth;
  short i;
  short cRand;
  short iSrc;
  
  if (0x27 < game.turn) {
    if (game.turn % 100 == 0x47) {
      cRand = 2;
    }
    else if (game.turn % 100 == 0x21) {
      cRand = 3;
    }
    else if ((game.turn & 0x7f) == 0x31) {
      cRand = 4;
    }
    else {
      if ((game.turn & 1) != 0) {
        return;
      }
      cRand = 7;
    }
    sVar1 = Random(cRand);
    if (sVar1 == 0) {
      lpth = LpthNew(0,ithMysteryTrader);
      if (((THING *)lpth != (THING *)0x0) || ((int)((ulong)lpth >> 0x10) != 0)) {
        sVar1 = Random(5);
        uVar3 = (undefined2)((ulong)lpth >> 0x10);
        *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) =
             *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) & 0xfff0 | sVar1 + 8U & 0xf;
        for (i = 0; i < 4; i = i + 2) {
          sVar1 = Random(game.mdSize * 400 + 0x169);
          rgC[i] = sVar1 + 0x3fc;
        }
        sVar1 = Random(2);
        if (sVar1 == 0) {
          rgC[1] = 0x3fc;
          rgC[3] = game.mdSize * 400 + 0x564;
        }
        else {
          rgC[1] = game.mdSize * 400 + 0x564;
          rgC[3] = 0x3fc;
        }
        iSrc = Random(2);
        uVar3 = (undefined2)((ulong)lpth >> 0x10);
        pTVar2 = (THING *)lpth;
        (&pTVar2->pt)->x = rgC[iSrc];
        (pTVar2->pt).y = rgC[iSrc == 0];
        *(int *)&pTVar2->u_THING_0x0006 = rgC[iSrc + 2];
        *(int *)((int)&pTVar2->u_THING_0x0006 + 2) = rgC[(iSrc == 0) + 2];
        if (game.turn < 100) {
          cRand = 5;
        }
        else if (game.turn < 0xfa) {
          cRand = 3;
        }
        else {
          cRand = 2;
        }
        if ((*(uint *)((int)&pTVar2->u_THING_0x0006 + 4) & 0xf) < 10) {
          cRand = cRand + 1;
        }
        else if (10 < (*(uint *)((int)&pTVar2->u_THING_0x0006 + 4) & 0xf)) {
          cRand = cRand + -1;
        }
        sVar1 = Random(10);
        if (sVar1 < cRand) {
          sVar1 = Random(6);
          uVar3 = (undefined2)((ulong)lpth >> 0x10);
          if (sVar1 == 0) {
            *(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) = 0x1000;
          }
          else {
            *(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) = 0;
          }
        }
        else {
          sVar1 = Random(0xd);
          grbitTrader = 1 << ((byte)sVar1 & 0x1f);
          if ((((grbitTrader == 0x40) || (grbitTrader == 0x80)) || (grbitTrader == 0x400)) ||
             (grbitTrader == 0x800)) {
            sVar1 = Random(0xd);
            grbitTrader = 1 << ((byte)sVar1 & 0x1f);
            if (((((game.turn < 0x78) && (grbitTrader == 0x80)) ||
                 ((game.turn < 0x96 && (grbitTrader == 0x400)))) ||
                ((game.turn < 0xb4 && (grbitTrader == 0x800)))) &&
               (sVar1 = Random(2), sVar1 != 0)) {
              grbitTrader = 0;
            }
          }
          *(short *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) = grbitTrader;
        }
        for (i = 0; i < game.cPlayer; i = i + 1) {
          FSendPlrMsg2(i,idmMysteriousTradingVesselBroadcastingProposalHasDe,-6,lpth->idFull,0)
          ;
        }
      }
    }
  }
  return;
}



// ======================================================================
// Function: UpdatePlayerScores
// Address: 10b8:6258
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10b86ba8) */

void UpdatePlayerScores(void)

{
  int *piVar1;
  SCORE *pSVar2;
  SCORE *pSVar3;
  char cVar4;
  short sVar5;
  uint uVar6;
  short sVar7;
  uint uVar8;
  int iVar9;
  SCORE *pSVar10;
  SCORE *pSVar11;
  undefined2 uVar12;
  bool bVar13;
  ulong uVar14;
  long lVar15;
  ushort lScoreMax;
  uint local_84;
  uint lScore2nd;
  uint local_80;
  short imsg;
  ushort wWinners;
  short j;
  short iScoreMax;
  uint rglScore [32];
  ushort wWinners2;
  byte rgcCond [16];
  short i;
  short c;
  short cDead;
  SCORE score;
  short cFirst;
  uint lScoreTot;
  int local_6;
  
  cDead = 0;
  cFirst = 0;
  iScoreMax = 0;
  lScore2nd = 0;
  local_80 = 0;
  lScoreTot = 0;
  local_6 = 0;
  gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffe;
  _memset(rgcCond,0,0x10);
  for (i = 0; i < game.cPlayer; i = i + 1) {
    lVar15 = CalcPlayerScore(i,&score);
    sVar7 = i;
    rglScore[i * 2] = (uint)lVar15;
    rglScore[sVar7 * 2 + 1] = (uint)((ulong)lVar15 >> 0x10);
    uVar12 = vlprgScoreX._2_2_;
    pSVar11 = &((SCOREX *)vlprgScoreX)[i].score;
    pSVar10 = &score;
    for (iVar9 = 10; iVar9 != 0; iVar9 = iVar9 + -1) {
      pSVar3 = pSVar11;
      pSVar11 = (SCORE *)((int)&pSVar11->lScore + 2);
      pSVar2 = pSVar10;
      pSVar10 = (SCORE *)((int)&pSVar10->lScore + 2);
      *(int *)&pSVar3->lScore = (int)pSVar2->lScore;
    }
    ((SCOREX *)vlprgScoreX + i)->wWord =
         ((SCOREX *)vlprgScoreX + i)->wWord & 0xffe0 | i & 0x1fU;
    ((SCOREX *)vlprgScoreX + i)->wWord =
         ((SCOREX *)vlprgScoreX + i)->wWord & 0xffdf | 0x20;
    ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xc03f;
    bVar13 = CARRY2(lScoreTot,rglScore[i * 2]);
    lScoreTot = lScoreTot + rglScore[i * 2];
    local_6 = local_6 + rglScore[i * 2 + 1] + (uint)bVar13;
    if ((((score.cPlanet == 0) && (score.rgcsh[0] == 0)) && (score.rgcsh[1] == 0)) &&
       ((score.rgcsh[2] == 0 && ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0)))
       ) {
      *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xfffe | 1;
      for (j = 0; j < game.cPlayer; j = j + 1) {
        if (j != i) {
          FSendPrependedPlrMsg
                    (j,idmTracesHaveEliminatedGalaxyMayRestPeace,-4,i | 0x30,0,0,0,0,0,0);
        }
      }
    }
    sVar7 = cPlanet;
    sVar5 = GetVCVal((GAME *)&game,0,0);
    uVar12 = 0x14f8;
    sVar7 = MulDiv(sVar7,sVar5,100);
    if (sVar7 <= score.cPlanet) {
      uVar8 = ((SCOREX *)vlprgScoreX + i)->wWord;
      ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xc03f
      ;
      ((SCOREX *)vlprgScoreX + i)->wWord =
           ((SCOREX *)vlprgScoreX + i)->wWord | uVar8 & 0x3fc0 | 0x40;
      uVar12 = 0x1078;
      sVar7 = GetVCCheck((GAME *)&game,0);
      if (sVar7 != 0) {
        rgcCond[i] = rgcCond[i] + 1;
      }
    }
    lVar15 = __aFlshl(CONCAT22(uVar12,0x655c),lScoreMax);
    iVar9 = (int)((ulong)lVar15 >> 0x10);
    uVar8 = (uint)lVar15;
    uVar6 = GetVCVal((GAME *)&game,6,0);
    if (((int)uVar6 >> 0xf <= iVar9) && (((int)uVar6 >> 0xf < iVar9 || (uVar6 <= uVar8)))) {
      uVar8 = ((SCOREX *)vlprgScoreX + i)->wWord;
      ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xc03f
      ;
      ((SCOREX *)vlprgScoreX + i)->wWord =
           ((SCOREX *)vlprgScoreX + i)->wWord | uVar8 & 0x3fc0 | 0x800;
      sVar7 = GetVCCheck((GAME *)&game,6);
      if (sVar7 != 0) {
        rgcCond[i] = rgcCond[i] + 1;
      }
    }
    uVar8 = GetVCVal((GAME *)&game,3,0);
    if (((int)uVar8 >> 0xf <= (int)rglScore[i * 2 + 1]) &&
       (((int)uVar8 >> 0xf < (int)rglScore[i * 2 + 1] || (uVar8 <= rglScore[i * 2])))) {
      uVar8 = ((SCOREX *)vlprgScoreX + i)->wWord;
      ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xc03f
      ;
      ((SCOREX *)vlprgScoreX + i)->wWord =
           ((SCOREX *)vlprgScoreX + i)->wWord | uVar8 & 0x3fc0 | 0x100;
      sVar7 = GetVCCheck((GAME *)&game,3);
      if (sVar7 != 0) {
        rgcCond[i] = rgcCond[i] + 1;
      }
    }
    c = 0;
    for (j = 0; j < 6; j = j + 1) {
      cVar4 = *(char *)(i * 0xc0 + 0x59bc + j);
      sVar7 = GetVCVal((GAME *)&game,1,0);
      if (sVar7 <= cVar4) {
        c = c + 1;
      }
    }
    sVar7 = GetVCVal((GAME *)&game,2,0);
    if (sVar7 <= c) {
      uVar8 = ((SCOREX *)vlprgScoreX + i)->wWord;
      ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xc03f
      ;
      ((SCOREX *)vlprgScoreX + i)->wWord =
           ((SCOREX *)vlprgScoreX + i)->wWord | uVar8 & 0x3fc0 | 0x80;
      sVar7 = GetVCCheck((GAME *)&game,1);
      if (sVar7 != 0) {
        rgcCond[i] = rgcCond[i] + 1;
      }
    }
    lVar15 = __aFldiv(CONCAT22(score.cResources._2_2_,(undefined2)score.cResources),1000);
    iVar9 = (int)((ulong)lVar15 >> 0x10);
    uVar8 = (uint)lVar15;
    uVar6 = GetVCVal((GAME *)&game,5,0);
    if (((int)uVar6 >> 0xf <= iVar9) && (((int)uVar6 >> 0xf < iVar9 || (uVar6 <= uVar8)))) {
      uVar8 = ((SCOREX *)vlprgScoreX + i)->wWord;
      ((SCOREX *)vlprgScoreX + i)->wWord = ((SCOREX *)vlprgScoreX + i)->wWord & 0xc03f
      ;
      ((SCOREX *)vlprgScoreX + i)->wWord =
           ((SCOREX *)vlprgScoreX + i)->wWord | uVar8 & 0x3fc0 | 0x400;
      sVar7 = GetVCCheck((GAME *)&game,5);
      if (sVar7 != 0) {
        rgcCond[i] = rgcCond[i] + 1;
      }
    }
  }
  if (game.cPlayer == 1) {
    (&((SCOREX *)vlprgScoreX)->u_SCOREX_0x0002)->iRank = 1;
  }
  else {
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0) {
        cDead = cDead + 1;
      }
      *(undefined2 *)((int)&rgplr[0].wScore + i * 0xc0) = 1;
      for (j = 0; j < game.cPlayer; j = j + 1) {
        if (((int)rglScore[i * 2 + 1] <= (int)rglScore[j * 2 + 1]) &&
           (((int)rglScore[i * 2 + 1] < (int)rglScore[j * 2 + 1] ||
            (rglScore[i * 2] < rglScore[j * 2])))) {
          piVar1 = (int *)((int)&rgplr[0].wScore + i * 0xc0);
          *piVar1 = *piVar1 + 1;
        }
      }
      if (*(int *)((int)&rgplr[0].wScore + i * 0xc0) == 1) {
        iScoreMax = i;
        lScoreMax = rglScore[i * 2];
        local_84 = rglScore[i * 2 + 1];
        cFirst = cFirst + 1;
      }
      else if (*(int *)((int)&rgplr[0].wScore + i * 0xc0) == 2) {
        lScore2nd = rglScore[i * 2];
        local_80 = rglScore[i * 2 + 1];
      }
    }
    if (1 < cFirst) {
      lScore2nd = lScoreMax;
      local_80 = local_84;
    }
    for (i = 0; i < game.cPlayer; i = i + 1) {
      ((SCOREX *)vlprgScoreX)[i].u_SCOREX_0x0002 =
           *(u_SCOREX_0x0002 *)((int)&rgplr[0].wScore + i * 0xc0);
    }
    sVar7 = GetVCVal((GAME *)&game,7,0);
    if ((sVar7 <= (int)game.turn) && (cFirst == 1)) {
      uVar8 = ((SCOREX *)vlprgScoreX + iScoreMax)->wWord;
      ((SCOREX *)vlprgScoreX + iScoreMax)->wWord =
           ((SCOREX *)vlprgScoreX + iScoreMax)->wWord & 0xc03f;
      ((SCOREX *)vlprgScoreX + iScoreMax)->wWord =
           ((SCOREX *)vlprgScoreX + iScoreMax)->wWord | uVar8 & 0x3fc0 | 0x1000;
      sVar7 = GetVCCheck((GAME *)&game,7);
      if (sVar7 != 0) {
        rgcCond[iScoreMax] = rgcCond[iScoreMax] + 1;
      }
    }
    if (cDead + 1 < game.cPlayer) {
      lVar15 = 100;
      sVar7 = GetVCVal((GAME *)&game,4,0);
      uVar14 = __aFulmul(CONCAT22(local_80,lScore2nd),(long)(sVar7 + 100));
      lVar15 = __aFldiv(uVar14,lVar15);
      if (lVar15 <= CONCAT22(local_84,lScoreMax)) {
        uVar8 = ((SCOREX *)vlprgScoreX + iScoreMax)->wWord;
        ((SCOREX *)vlprgScoreX + iScoreMax)->wWord =
             ((SCOREX *)vlprgScoreX + iScoreMax)->wWord & 0xc03f;
        ((SCOREX *)vlprgScoreX + iScoreMax)->wWord =
             ((SCOREX *)vlprgScoreX + iScoreMax)->wWord | uVar8 & 0x3fc0 | 0x200;
        sVar7 = GetVCCheck((GAME *)&game,4);
        if (sVar7 != 0) {
          rgcCond[iScoreMax] = rgcCond[iScoreMax] + 1;
        }
      }
      uVar8 = GetVCVal((GAME *)&game,9,0);
      if (uVar8 <= game.turn) {
        wWinners = 0;
        sVar7 = GetVCVal((GAME *)&game,8,0);
        if (0 < sVar7) {
          for (i = game.cPlayer + -1; -1 < i; i = i + -1) {
            wWinners = wWinners << 1;
            if (sVar7 <= (int)(uint)rgcCond[i]) {
              ((SCOREX *)vlprgScoreX + i)->wWord =
                   ((SCOREX *)vlprgScoreX + i)->wWord & 0xbfff | 0x4000;
              wWinners = wWinners | 1;
            }
          }
          if (wWinners != 0) {
            gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffe | 1;
          }
        }
        if ((gd.grBits._2_2_ & 1) != 0) {
          j = 1;
          for (i = 0; i < game.cPlayer; i = i + 1) {
            wWinners2 = wWinners;
            if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0) {
              if ((j & wWinners) == 0) {
                imsg = 0xb5;
              }
              else if (j == wWinners) {
                imsg = 0xb6;
              }
              else {
                imsg = 0xb7;
                wWinners2 = wWinners & ~j;
              }
            }
            else {
              imsg = 0xb8;
            }
            FSendPrependedPlrMsg(i,imsg,-4,wWinners2,0,0,0,0,0,0);
            j = j << 1;
          }
        }
      }
    }
    else {
      gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffe | 1;
      if ((*(uint *)((int)&rgplr[0].wFlags + iScoreMax * 0xc0) & 1) == 0) {
        FSendPrependedPlrMsg
                  (iScoreMax,idmTracesEveryOtherRivalHaveEliminatedGalaxy,-4,0,0,0,0,0,0,0);
      }
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if (i != iScoreMax) {
          FSendPrependedPlrMsg(i,idmDeadPlanetsHaveOverrunSpaceshipsDefeated,-4,0,0,0,0,0,0,0);
        }
      }
    }
  }
  return;
}



// ======================================================================
// Function: CreateBackupDir
// Address: 10b8:6dca
// Segment: MEMORY_TURN2
// ======================================================================


void CreateBackupDir(void)

{
  char *pcVar1;
  char *pchT;
  
  _strcpy((char *)&szBackup,(char *)szBase);
  pcVar1 = _strrchr((char *)&szBackup,0x5c);
  if (pcVar1 == (char *)0x0) {
    pchT = (char *)&szBackup;
  }
  else {
    pchT = pcVar1 + 1;
  }
  *pchT = '\0';
  if (vcBackupDirs < 2) {
    _strcpy(pchT,(char *)s_backup_1120_09e0);
  }
  else if (vcBackupDirs < 100) {
    _wsprintf((char *)CONCAT22(0x1120,pchT),s_backup_d_1120_09e7,
              game.turn % (uint)vcBackupDirs);
  }
  else {
    _wsprintf((char *)CONCAT22(0x1120,pchT),s_backup__03d_1120_09f0,
              game.turn % (uint)vcBackupDirs);
  }
  __mkdir((char *)&szBackup);
  _strcat((char *)&szBackup,(char *)0x9fc);
  return;
}



// ======================================================================
// Function: FPacketDecay
// Address: 10b8:6e9c
// Segment: MEMORY_TURN2
// ======================================================================


short FPacketDecay(THING *lpth,short pctRate)

{
  uint uVar1;
  short sVar2;
  THING *pTVar3;
  undefined2 uVar4;
  bool bVar5;
  ulong uVar6;
  long lVar7;
  ulong uVar8;
  uint lDecay;
  int local_e;
  ushort wDecay;
  short i;
  short iRate;
  ushort iRateMin;
  
  uVar4 = (undefined2)((ulong)lpth >> 0x10);
  pTVar3 = (THING *)lpth;
  if (*(uint *)((int)&pTVar3->u_THING_0x0006 + 8) >> 0xe == 0) {
    sVar2 = 0;
  }
  else {
    uVar1 = *(uint *)((int)&pTVar3->u_THING_0x0006 + 8) >> 0xe;
    if (uVar1 == 1) {
      iRate = 10;
    }
    else if (uVar1 == 2) {
      iRate = 0x19;
    }
    else if (uVar1 == 3) {
      iRate = 0x32;
    }
    sVar2 = GetRaceStat((PLAYER *)rgplr + (lpth->idFull >> 9 & 0xf),rsMajorAdv);
    if (sVar2 == raMassAccel) {
      iRate = iRate / 2;
      iRateMin = 5;
    }
    else {
      iRateMin = 10;
    }
    lDecay = 0;
    local_e = 0;
    for (i = 0; i < 3; i = i + 1) {
      if (*(int *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2) != 0) {
        lVar7 = 10000;
        uVar8 = (ulong)pctRate;
        uVar6 = __aFulmul((long)*(int *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2),
                                  (long)iRate);
        uVar6 = __aFulmul(uVar6,uVar8);
        lVar7 = __aFldiv(uVar6,lVar7);
        wDecay = iRateMin;
        if (iRateMin <= (uint)lVar7) {
          wDecay = (uint)lVar7;
        }
        if (*(int *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2) <= (int)wDecay) {
          wDecay = *(ushort *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2);
        }
        *(ushort *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2) =
             *(int *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2) - wDecay;
        uVar1 = *(uint *)((pTVar3->u_THING_0x0006).rgb + i * 2 + 2);
        bVar5 = CARRY2(lDecay,uVar1);
        lDecay = lDecay + uVar1;
        local_e = local_e + ((int)uVar1 >> 0xf) + (uint)bVar5;
      }
    }
    if ((lDecay == 0) && (local_e == 0)) {
      FreeLpth(lpth);
      sVar2 = 1;
    }
    else {
      lVar7 = __aFldiv(CONCAT22(local_e + (uint)(0xfff6 < lDecay),lDecay + 9),10);
      *(uint *)((int)&pTVar3->u_THING_0x0006 + 8) =
           *(uint *)((int)&pTVar3->u_THING_0x0006 + 8) & 0xc000 | (uint)lVar7 & 0x3fff;
      sVar2 = 0;
    }
  }
  return sVar2;
}



// ======================================================================
// Function: ThingDecay
// Address: 10b8:70c6
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10b87483) */
/* WARNING: Removing unreachable block (ram,0x10b8757f) */
/* WARNING: Removing unreachable block (ram,0x10b875b8) */
/* WARNING: Removing unreachable block (ram,0x10b875ed) */

void ThingDecay(void)

{
  u_THING_0x0006 *puVar1;
  int *piVar2;
  uint uVar3;
  ushort uVar4;
  FLEET *pFVar5;
  POINT pt;
  int iVar6;
  short sVar7;
  int iVar8;
  int iVar9;
  short sVar10;
  undefined2 uVar11;
  bool bVar12;
  ulong uVar13;
  ulong uVar14;
  long lVar15;
  undefined2 uVar16;
  undefined2 uVar17;
  short fMineExpert;
  uint lDecay;
  int local_1c;
  ushort wDecay;
  THING *lpth;
  FLEET *lpfl;
  short ifl;
  short i;
  uint pctDecay;
  int local_a;
  THING *lpthMac;
  
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
    iVar6 = *(int *)((FLEET **)rglpfl + ifl);
    iVar8 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    if ((iVar6 == 0) && (iVar8 == 0)) break;
    *(uint *)(iVar6 + 4) = *(uint *)(iVar6 + 4) & 0xefff;
  }
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  lpthMac = (THING *)lpThings + cThing;
  do {
    if (lpthMac <= (THING *)lpth) {
      return;
    }
    uVar11 = (undefined2)((ulong)lpth >> 0x10);
    if (lpth->idFull >> 0xd == 1) {
      if ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) == 0) {
        if ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 0xe & 1) == 0) {
          lDecay = 0;
          local_1c = 0;
          for (i = 0; i < 3; i = i + 1) {
            if (*(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) != 0) {
              if (*(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) / 10 < 10) {
                iVar6 = 10;
              }
              else {
                iVar6 = *(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) / 10;
              }
              *(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) =
                   *(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) - iVar6;
              if (*(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) < 0) {
                ((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2)[0] = 0;
                ((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2)[1] = 0;
              }
              uVar3 = *(uint *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2);
              bVar12 = CARRY2(lDecay,uVar3);
              lDecay = lDecay + uVar3;
              local_1c = local_1c + ((int)uVar3 >> 0xf) + (uint)bVar12;
            }
          }
          if ((lDecay == 0) && (local_1c == 0)) {
            FreeLpth(lpth);
            goto TURN2_LFixUpLpth;
          }
          lVar15 = __aFldiv(CONCAT22(local_1c + (uint)(0xfff6 < lDecay),lDecay + 9),10);
          *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) =
               *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) & 0xc000 | (uint)lVar15 & 0x3fff
          ;
        }
        else {
          ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags =
               ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0xbfff;
        }
      }
      else {
        sVar7 = FPacketDecay(lpth,100);
        if (sVar7 != 0) {
TURN2_LFixUpLpth:
          lpth = (THING *)CONCAT22(uVar11,(THING *)lpth + -1);
          lpthMac = lpthMac + -1;
        }
      }
    }
    else if (lpth->idFull >> 0xd == 0) {
      sVar7 = GetRaceStat((PLAYER *)rgplr + (lpth->idFull >> 9 & 0xf),rsMajorAdv);
      if (*(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 7) != '\0') {
        uVar4 = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags;
        uVar16 = *(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
        for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar5 = ((FLEET **)rglpfl)[ifl];
          iVar6 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
          if ((pFVar5 == (FLEET *)0x0) && (iVar6 == 0)) break;
          if ((pFVar5->wFlags_0x4 >> 10 & 1) == 0) {
            iVar8 = (&pFVar5->pt)->x - (&((THING *)lpth)->pt)->x;
            iVar9 = (pFVar5->pt).y - (((THING *)lpth)->pt).y;
            if ((pFVar5->wFlags_0x4 >> 0xc & 1) == 0) {
              uVar14 = __aFulmul((long)iVar9,(long)iVar9);
              uVar13 = __aFulmul((long)iVar8,(long)iVar8);
              if ((long)(uVar13 + uVar14) <= CONCAT22(uVar16,uVar4)) {
                FTravelThroughMineFields((FLEET *)CONCAT22(iVar6,pFVar5),(short *)0x0,lpth);
                pFVar5->wFlags_0x4 = pFVar5->wFlags_0x4 & 0xefff | 0x1000;
              }
            }
          }
        }
      }
      pt.y = (((THING *)lpth)->pt).y;
      pt.x = (&((THING *)lpth)->pt)->x;
      sVar10 = CPlanetsInCircle
                         (pt,CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2),
                                      ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags));
      pctDecay = ((uint)(sVar7 != raMines) * 3 + 1) * sVar10 + 2;
      local_a = (int)pctDecay >> 0xf;
      if ((-1 < local_a) && ((0 < local_a || (0x32 < pctDecay)))) {
        pctDecay = 0x32;
        local_a = 0;
      }
      if (*(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 7) != '\0') {
        bVar12 = 0xffe6 < pctDecay;
        pctDecay = pctDecay + 0x19;
        local_a = local_a + (uint)bVar12;
      }
      uVar17 = 0;
      uVar16 = 100;
      uVar14 = __aFulmul(CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2)
                                          ,((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags),
                                 CONCAT22(local_a,pctDecay));
      lVar15 = __aFldiv(uVar14,CONCAT22(uVar17,uVar16));
      if (lVar15 < (long)CONCAT22(local_a,pctDecay)) {
        lVar15 = CONCAT22(local_a,pctDecay);
      }
      if ((*(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 6) != '\x02') && (lVar15 < 10)) {
        lVar15 = 10;
      }
      local_1c = (int)((ulong)lVar15 >> 0x10);
      lDecay = (uint)lVar15;
      if (lVar15 < CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2),
                            ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags)) {
        puVar1 = &((THING *)lpth)->u_THING_0x0006;
        uVar3 = (puVar1->thp).wFlags;
        (puVar1->thp).wFlags = (puVar1->thp).wFlags - lDecay;
        piVar2 = (int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
        *piVar2 = (*piVar2 - local_1c) - (uint)(uVar3 < lDecay);
      }
      else {
        FreeLpth(lpth);
        lpth = (THING *)CONCAT22(uVar11,(THING *)lpth + -1);
        lpthMac = lpthMac + -1;
      }
    }
    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
  } while( true );
}



// ======================================================================
// Function: UnmarkMineFields
// Address: 10b8:7638
// Segment: MEMORY_TURN2
// ======================================================================


void UnmarkMineFields(void)

{
  THING *pTVar1;
  THING *lpth;
  
  pTVar1 = (THING *)lpThings + cThing;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < pTVar1) {
    if (lpth->idFull >> 0xd == 0) {
      *(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) = 0;
    }
    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
  }
  return;
}



// ======================================================================
// Function: SweepForMines
// Address: 10b8:76a4
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10b87af0) */
/* WARNING: Removing unreachable block (ram,0x10b87716) */
/* WARNING: Removing unreachable block (ram,0x10b878a0) */
/* WARNING: Removing unreachable block (ram,0x10b87c85) */
/* WARNING: Removing unreachable block (ram,0x10b878dc) */
/* WARNING: Removing unreachable block (ram,0x10b87cc1) */
/* WARNING: Removing unreachable block (ram,0x10b87918) */
/* WARNING: Removing unreachable block (ram,0x10b87cfd) */

void SweepForMines(void)

{
  u_THING_0x0006 *puVar1;
  int *piVar2;
  uint *puVar3;
  byte bVar4;
  FLEET *pFVar5;
  uint uVar6;
  int iVar7;
  long lVar8;
  short sVar9;
  int iVar10;
  int iVar11;
  int iVar12;
  uint uVar13;
  uint uVar14;
  uint uVar15;
  PLANET *pPVar16;
  int iVar17;
  undefined2 uVar18;
  undefined2 uVar19;
  long lVar20;
  ulong uVar21;
  ulong uVar22;
  long lVar23;
  ushort uVar24;
  short sVar25;
  ushort grbitPlr;
  uint cMineCur;
  int local_26;
  THING *lpth;
  FLEET *lpfl;
  short ifl;
  PLANET *lppl;
  THING *lpthMac;
  short iplr;
  
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar5 = ((FLEET **)rglpfl)[ifl];
    iVar17 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar17,pFVar5);
    if ((pFVar5 == (FLEET *)0x0) && (iVar17 == 0)) break;
    lVar20 = CMineSweepFromLpfl((FLEET *)CONCAT22(iVar17,pFVar5));
    if ((0 < lVar20) && ((pFVar5->wFlags_0x4 >> 10 & 1) == 0)) {
      uVar6 = lpfl->id;
      iVar7 = (&pFVar5->pt)->x;
      iVar11 = (pFVar5->pt).y;
      lpthMac = (THING *)lpThings + cThing;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      while ((THING *)lpth < lpthMac) {
        if (((lpth->idFull >> 0xd == 0) && ((lpth->idFull >> 9 & 0xf) != (uVar6 >> 9 & 0xf))) &&
           (sVar9 = FAttackPlayer((FLEET *)CONCAT22(iVar17,pFVar5),lpth->idFull >> 9 & 0xf),
           sVar9 != 0)) {
          uVar18 = (undefined2)((ulong)lpth >> 0x10);
          iVar12 = iVar7 - (&((THING *)lpth)->pt)->x;
          iVar10 = iVar11 - (((THING *)lpth)->pt).y;
          uVar21 = __aFulmul((long)iVar10,(long)iVar10);
          uVar22 = __aFulmul((long)iVar12,(long)iVar12);
          lVar8 = uVar22 + uVar21;
          uVar13 = (uint)lVar8;
          iVar10 = (int)((ulong)lVar8 >> 0x10);
          iVar12 = *(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
          if ((iVar10 <= iVar12) &&
             ((iVar10 < iVar12 || (uVar13 <= ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags)))) {
            lVar23 = lVar20;
            if (*(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 6) == '\x02') {
              lVar23 = __aFldiv(lVar20,3);
            }
            if (lVar23 < 2) {
              lVar23 = 2;
            }
            local_26 = (int)((ulong)lVar23 >> 0x10);
            cMineCur = (uint)lVar23;
            uVar14 = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags;
            if (CONCAT22((*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2) - local_26) -
                         (uint)(uVar14 < cMineCur),uVar14 - cMineCur) < lVar8 + -1) {
              uVar14 = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags;
              uVar15 = uVar14 - uVar13;
              lVar23 = CONCAT22(((*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2) - iVar10) -
                                (uint)(uVar14 < uVar13)) + (uint)(0xfffe < uVar15),uVar15 + 1);
            }
            if (CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2),
                         ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags) < lVar23) {
              lVar23 = CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2),
                                ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags);
            }
            sVar9 = (((THING *)lpth)->pt).y;
            uVar24 = (&((THING *)lpth)->pt)->x;
            bVar4 = *(byte *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
            uVar13 = (uint)bVar4;
            uVar14 = lpth->idFull >> 9;
            uVar15 = uVar14 & 0xf;
            uVar21 = __aFulshr((ulong)(CONCAT12(bVar4,uVar14) & 0xff000f),uVar24);
            cMineCur = (uint)lVar23;
            FSendPlrMsg(pFVar5->iPlayer,idmHasSweptMinesMineField,lpfl->id | 0x8000,lpfl->id,
                             cMineCur,(short)uVar21,uVar15,uVar13,uVar24,sVar9);
            sVar25 = 0;
            uVar24 = (((THING *)lpth)->pt).y;
            sVar9 = (&((THING *)lpth)->pt)->x;
            uVar13 = (uint)*(byte *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
            uVar21 = __aFulshr(CONCAT22(sVar9,uVar13),uVar24);
            FSendPlrMsg(lpth->idFull >> 9 & 0xf,idmSomeoneHasSweptMinesMineField,-6,
                             lpth->idFull,cMineCur,(short)uVar21,uVar13,sVar9,uVar24,sVar25);
            local_26 = (int)((ulong)lVar23 >> 0x10);
            puVar1 = &((THING *)lpth)->u_THING_0x0006;
            uVar13 = (puVar1->thp).wFlags;
            (puVar1->thp).wFlags = (puVar1->thp).wFlags - cMineCur;
            piVar2 = (int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
            *piVar2 = (*piVar2 - local_26) - (uint)(uVar13 < cMineCur);
            iVar12 = *(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
            if ((iVar12 < 1) &&
               ((iVar12 < 0 || (((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags == 0)))) {
              FreeLpth(lpth);
              lpth = (THING *)CONCAT22(uVar18,(THING *)lpth + -1);
              lpthMac = lpthMac + -1;
            }
            else {
              puVar3 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4);
              *puVar3 = *puVar3 | 1 << ((byte)pFVar5->iPlayer & 0x1f);
            }
          }
        }
        lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
      }
    }
  }
  pPVar16 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < pPVar16) {
    uVar18 = (undefined2)((ulong)lppl >> 0x10);
    if ((((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) && (((PLANET *)lppl)->iPlayer != -1)) &&
       (iVar17 = ((PLANET *)lppl)->iPlayer * 4,
       lVar20 = CMineSweepFromLphul
                          ((HUL *)CONCAT22(*(undefined2 *)(iVar17 + 0x14e),
                                           (HUL *)(*(int *)(iVar17 + 0x14c) +
                                                  (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) *
                                                  0x93))), 0 < lVar20)) {
      uVar6 = ((PLANET *)lppl)->iPlayer;
      iVar17 = ((POINT *)rgptPlan + lppl->id)->x;
      iVar7 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
      lpthMac = (THING *)lpThings + cThing;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      while ((THING *)lpth < lpthMac) {
        if (((lpth->idFull >> 0xd == 0) && ((lpth->idFull >> 9 & 0xf) != uVar6)) &&
           ((uVar6 != (lpth->idFull >> 9 & 0xf) &&
            (*(char *)(uVar6 * 0xc0 + 0x5a12 + (lpth->idFull >> 9 & 0xf)) != '\x01')))) {
          uVar19 = (undefined2)((ulong)lpth >> 0x10);
          iVar11 = iVar17 - (&((THING *)lpth)->pt)->x;
          iVar12 = iVar7 - (((THING *)lpth)->pt).y;
          uVar21 = __aFulmul((long)iVar12,(long)iVar12);
          uVar22 = __aFulmul((long)iVar11,(long)iVar11);
          lVar8 = uVar22 + uVar21;
          uVar13 = (uint)lVar8;
          iVar12 = (int)((ulong)lVar8 >> 0x10);
          iVar11 = *(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
          if ((iVar12 <= iVar11) &&
             ((iVar12 < iVar11 || (uVar13 <= ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags)))) {
            lVar23 = lVar20;
            if (*(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 6) == '\x02') {
              lVar23 = __aFldiv(lVar20,3);
            }
            if (lVar23 < 2) {
              lVar23 = 2;
            }
            local_26 = (int)((ulong)lVar23 >> 0x10);
            cMineCur = (uint)lVar23;
            uVar14 = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags;
            if (CONCAT22((*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2) - local_26) -
                         (uint)(uVar14 < cMineCur),uVar14 - cMineCur) < lVar8 + -1) {
              uVar14 = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags;
              uVar15 = uVar14 - uVar13;
              lVar23 = CONCAT22(((*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2) - iVar12) -
                                (uint)(uVar14 < uVar13)) + (uint)(0xfffe < uVar15),uVar15 + 1);
            }
            if (CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2),
                         ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags) < lVar23) {
              lVar23 = CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2),
                                ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags);
            }
            sVar9 = (((THING *)lpth)->pt).y;
            uVar24 = (&((THING *)lpth)->pt)->x;
            bVar4 = *(byte *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
            uVar13 = (uint)bVar4;
            uVar14 = lpth->idFull >> 9;
            uVar15 = uVar14 & 0xf;
            uVar21 = __aFulshr((ulong)(CONCAT12(bVar4,uVar14) & 0xff000f),uVar24);
            cMineCur = (uint)lVar23;
            FSendPlrMsg(uVar6,idmStarbaseHasSweptMinesMineField,lppl->id,lppl->id,cMineCur,
                             (short)uVar21,uVar15,uVar13,uVar24,sVar9);
            sVar25 = 0;
            uVar24 = (((THING *)lpth)->pt).y;
            sVar9 = (&((THING *)lpth)->pt)->x;
            uVar13 = (uint)*(byte *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
            uVar21 = __aFulshr(CONCAT22(sVar9,uVar13),uVar24);
            FSendPlrMsg(lpth->idFull >> 9 & 0xf,idmSomeoneHasSweptMinesMineField,-6,
                             lpth->idFull,cMineCur,(short)uVar21,uVar13,sVar9,uVar24,sVar25);
            local_26 = (int)((ulong)lVar23 >> 0x10);
            puVar1 = &((THING *)lpth)->u_THING_0x0006;
            uVar13 = (puVar1->thp).wFlags;
            (puVar1->thp).wFlags = (puVar1->thp).wFlags - cMineCur;
            piVar2 = (int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
            *piVar2 = (*piVar2 - local_26) - (uint)(uVar13 < cMineCur);
            iVar11 = *(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
            if ((iVar11 < 1) &&
               ((iVar11 < 0 || (((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags == 0)))) {
              FreeLpth(lpth);
              lpth = (THING *)CONCAT22(uVar19,(THING *)lpth + -1);
              lpthMac = lpthMac + -1;
            }
            else {
              puVar3 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4);
              *puVar3 = *puVar3 | 1 << ((byte)((PLANET *)lppl)->iPlayer & 0x1f);
            }
          }
        }
        lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
      }
    }
    lppl = (PLANET *)CONCAT22(uVar18,(PLANET *)lppl + 1);
  }
  return;
}



// ======================================================================
// Function: BreedColonistsInTransit
// Address: 10b8:7e4e
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Variable defined which should be unmapped: i */
/* WARNING: Variable defined which should be unmapped: lpfl */
/* WARNING: Removing unreachable block (ram,0x10b87f99) */
/* WARNING: Removing unreachable block (ram,0x10b87ffa) */
/* WARNING: Removing unreachable block (ram,0x10b8803c) */

void BreedColonistsInTransit(void)

{
  uint *puVar1;
  int *piVar2;
  uint p2;
  int iVar3;
  uint p4;
  short sVar4;
  FLEET *pFVar5;
  PLANET *pPVar6;
  ulong uVar7;
  FLEET *dChg;
  FLEET *pFVar8;
  PLANET *pPVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  FLEET *pFVar12;
  uint uVar13;
  ulong local_28;
  short i;
  FLEET *lpfl;
  short ifl;
  PLANET *lppl;
  FLEET *lColGain;
  int local_18;
  char grfBreeder [16];
  short fNoBreeders;
  
  fNoBreeders = 1;
  for (iVar3 = 0; iVar3 < game.cPlayer; iVar3 = iVar3 + 1) {
    sVar4 = GetRaceStat((PLAYER *)rgplr + iVar3,rsMajorAdv);
    grfBreeder[iVar3] = sVar4 == raDefend;
    if (sVar4 == raDefend) {
      fNoBreeders = 0;
    }
  }
  if (fNoBreeders == 0) {
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar5 = ((FLEET **)rglpfl)[ifl];
      iVar3 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      lpfl = (FLEET *)CONCAT22(iVar3,pFVar5);
      if ((pFVar5 == (FLEET *)0x0) && (iVar3 == 0)) {
        return;
      }
      if ((((pFVar5->wFlags_0x4 >> 10 & 1) == 0) && (grfBreeder[pFVar5->iPlayer] != '\0')) &&
         (((int)pFVar5->rgwtMin[3] != 0 || (*(int *)((int)pFVar5->rgwtMin + 0xe) != 0)))) {
        uVar11 = 0;
        uVar10 = 200;
        uVar7 = __aFulmul(CONCAT22(*(undefined2 *)((int)pFVar5->rgwtMin + 0xe),
                                           (int)pFVar5->rgwtMin[3]),
                                  (long)(int)*(char *)((int)&rgplr[0].pctIdealGrowth +
                                                      pFVar5->iPlayer * 0xc0));
        dChg = (FLEET *)__aFldiv(uVar7,CONCAT22(uVar11,uVar10));
        if ((long)dChg < 1) {
          sVar4 = Random(3);
          if (sVar4 != 0) goto LAB_10b8_7ec9;
          dChg = (FLEET *)0x1;
        }
        pFVar8 = (FLEET *)ChgCargo(grobjFleet,lpfl->id,3,(long)dChg,(void *)0x0);
        pFVar5 = (FLEET *)pFVar8;
        uVar13 = (uint)((ulong)pFVar8 >> 0x10);
        if (0 < (long)pFVar8) {
          lpfl = (FLEET *)CONCAT22(iVar3,pFVar5);
          uVar13 = lpfl->id | 0x8000;
          pFVar12 = (FLEET *)((int)(FLEET ***)&rglpfl + 1);
          FSendPlrMsg2(pFVar5->iPlayer,idmColonistsHaveMadeGoodUseTimeIncreasing,uVar13,
                            lpfl->id,(short)pFVar5);
          pFVar5 = pFVar12;
        }
        local_18 = (int)((ulong)dChg >> 0x10);
        lColGain = (FLEET *)dChg;
        if ((long)CONCAT22(uVar13,pFVar5) < (long)dChg) {
          uVar10 = (undefined2)((ulong)lpfl >> 0x10);
          if (((FLEET *)lpfl)->idPlanet != -1) {
            iVar3 = ((FLEET *)lpfl)->idPlanet;
            pPVar9 = LpplFromId(iVar3);
            uVar11 = (undefined2)((ulong)pPVar9 >> 0x10);
            pPVar6 = (PLANET *)pPVar9;
            if ((pPVar9 != (PLANET *)0x0) && (pPVar6->iPlayer == *(int *)(iVar3 + 2))) {
              p2 = (int)lColGain - (int)pFVar5;
              puVar1 = (uint *)(pPVar6->rgwtMin + 3);
              uVar13 = *puVar1;
              *puVar1 = *puVar1 + p2;
              piVar2 = (int *)((int)pPVar6->rgwtMin + 0xe);
              *piVar2 = *piVar2 + ((local_18 + 0x7fa3) - (uint)(lColGain < pFVar5)) +
                        (uint)CARRY2(uVar13,p2);
              p4 = uRam00000006;
              local_28 = (ulong)uRam00000006;
              uVar7 = __aFulshr(local_28,0);
              FSendPlrMsg(sRam00000002,idmBreedingActivitiesHaveOverflowedLivingSpaceColon,
                               uRam00000000 | 0x8000,uRam00000000,p2,(short)uVar7,p4,0,0,0);
            }
          }
        }
      }
LAB_10b8_7ec9:
    }
  }
  return;
}



// ======================================================================
// Function: UpdateResearchStatus
// Address: 10b8:80fe
// Segment: MEMORY_TURN2
// ======================================================================


/* WARNING: Variable defined which should be unmapped: idm */
/* WARNING: Removing unreachable block (ram,0x10b884bd) */
/* WARNING: Removing unreachable block (ram,0x10b88acf) */

void UpdateResearchStatus(short fUsePool)

{
  char *pcVar1;
  uint *puVar2;
  int iVar3;
  char cVar4;
  char cVar5;
  undefined2 uVar6;
  undefined2 uVar7;
  uint uVar8;
  byte bVar9;
  uint uVar10;
  MessageId iMsg;
  short sVar11;
  undefined2 *puVar12;
  char *pcVar13;
  uint *puVar14;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  PART *pPVar15;
  PART *pPVar16;
  ulong uVar17;
  PART *pPVar18;
  long lVar19;
  long lVar20;
  long lVar21;
  PART *in_stack_0000ffb0;
  short idm;
  uint l15pct;
  ushort in_stack_0000ffb6;
  short iTT;
  PART part;
  undefined4 lSpent;
  short cPlrAlive;
  short grbitCur;
  uint rglFieldSpent [12];
  short ibitCur;
  short i;
  short fChgNow;
  short fGeneral;
  short iItem;
  short iT;
  short iTechNext;
  short fUsePoolOrig;
  short iTechCur;
  short fRedoItAll;
  short mdAvail;
  
  lVar19 = CONCAT22(lSpent._2_2_,(uint)lSpent);
  lVar21 = CONCAT22(unaff_SI,unaff_DI);
  cPlrAlive = 0;
  fUsePoolOrig = fUsePool;
  if (fUsePool != 0) {
    for (i = 0; sVar11 = i, i < 6; i = i + 1) {
      rglFieldSpent[i * 2] = 0;
      rglFieldSpent[sVar11 * 2 + 1] = 0;
    }
  }
  i = 0;
  do {
    if (game.cPlayer <= i) {
      idPlayer = -1;
      fRedoItAll = 0;
      if ((fUsePoolOrig != 0) && (1 < cPlrAlive)) {
        for (i = 0; lSpent = lVar19, i < game.cPlayer; i = i + 1) {
          sVar11 = GetRaceStat((PLAYER *)rgplr + i,rsMajorAdv);
          lVar19 = lSpent;
          if (sVar11 == raStealth) {
            for (iT = 0; iT < 6; iT = iT + 1) {
              if ((-1 < (int)rglFieldSpent[iT * 2 + 1]) &&
                 ((0 < (int)rglFieldSpent[iT * 2 + 1] || (rglFieldSpent[iT * 2] != 0)))) {
                lVar20 = 2;
                lSpent = lVar19;
                lVar19 = __aFldiv(CONCAT22(rglFieldSpent[iT * 2 + 1],rglFieldSpent[iT * 2]),
                                          (long)cPlrAlive);
                lVar19 = __aFldiv(lVar19,lVar20);
                if (1 < lVar19) {
                  fRedoItAll = 1;
                  lSpent = lVar19;
                  FSendPlrMsg2(i,idmIntelligenceGatheringActivitiesCombinedSynergist,-2,iT,
                                    (short)lVar19);
                  lVar19 = lSpent;
                  if ((game.wCrap >> 1 & 1) != 0) {
                    lVar19 = __aFlshr(lVar21,(ushort)in_stack_0000ffb0);
                  }
                  lSpent._2_2_ = (int)((ulong)lVar19 >> 0x10);
                  lSpent._0_2_ = (uint)lVar19;
                  puVar14 = (uint *)(i * 0xc0 + 0x59c2 + iT * 4);
                  puVar2 = puVar14;
                  uVar10 = *puVar2;
                  *puVar2 = *puVar2 + (uint)lSpent;
                  puVar2 = puVar14 + 1;
                  *puVar2 = *puVar2 + lSpent._2_2_ + (uint)CARRY2(uVar10,(uint)lSpent);
                }
              }
            }
          }
        }
        if (fRedoItAll != 0) {
          UpdateResearchStatus(0);
        }
      }
      return;
    }
    fUsePool = fUsePoolOrig;
    lSpent = lVar19;
    fGeneral = GetRaceGrbit((PLAYER *)rgplr + i,ibitRaceGeneralizedResearch);
    iTechCur = (int)*(char *)((int)&rgplr[0].iTechCur + i * 0xc0) & 0xf;
    iTechNext = (int)(*(char *)((int)&rgplr[0].iTechCur + i * 0xc0) >> 4);
    idPlayer = i;
    lVar19 = lSpent;
    if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0) {
      cPlrAlive = cPlrAlive + 1;
    }
    do {
      fRedoItAll = 0;
      for (iT = 0; iT < 6; iT = iT + 1) {
        puVar12 = (undefined2 *)(i * 0xc0 + 0x59c2 + iT * 4);
        lSpent._0_2_ = *puVar12;
        lSpent._2_2_ = puVar12[1];
        fChgNow = 0;
        if ((game.wCrap >> 1 & 1) != 0) {
          lSpent = __aFlshl(lVar21,(ushort)in_stack_0000ffb0);
        }
        sVar11 = iT;
        lVar19 = lSpent;
        if (((iT == iTechCur) && (fUsePool != 0)) && (fGeneral < 2)) {
          if (fGeneral == 0) {
            uVar6 = *(undefined2 *)((int)&rgplr[0].lResLastYear + i * 0xc0);
            uVar7 = *(undefined2 *)((int)&rgplr[0].lResLastYear + 2 + i * 0xc0);
            uVar8 = *(uint *)((int)&rgplr[0].lResLastYear + i * 0xc0);
            iVar3 = *(int *)((int)&rgplr[0].lResLastYear + 2 + i * 0xc0);
            puVar2 = rglFieldSpent + iT * 2;
            uVar10 = *puVar2;
            *puVar2 = *puVar2 + uVar8;
            rglFieldSpent[sVar11 * 2 + 1] =
                 rglFieldSpent[sVar11 * 2 + 1] + iVar3 + (uint)CARRY2(uVar10,uVar8);
            lVar19 = lSpent + CONCAT22(uVar7,uVar6);
          }
          else {
            fRedoItAll = 1;
            fGeneral = 2;
            uVar10 = *(uint *)((int)&rgplr[0].lResLastYear + i * 0xc0);
            lVar19 = __aFldiv(CONCAT22(*(int *)((int)&rgplr[0].lResLastYear + 2 +
                                                       i * 0xc0) + (uint)(0xfffe < uVar10),
                                               uVar10 + 1),2);
            lSpent = lVar19 + lSpent;
            uVar10 = *(uint *)((int)&rgplr[0].lResLastYear + i * 0xc0);
            lVar19 = __aFldiv(CONCAT22(*(int *)((int)&rgplr[0].lResLastYear + 2 +
                                                       i * 0xc0) + (uint)(0xfffe < uVar10),
                                               uVar10 + 1),2);
            sVar11 = iT;
            puVar2 = rglFieldSpent + iT * 2;
            uVar10 = *puVar2;
            *puVar2 = *puVar2 + (uint)lVar19;
            rglFieldSpent[sVar11 * 2 + 1] =
                 rglFieldSpent[sVar11 * 2 + 1] + (int)((ulong)lVar19 >> 0x10) +
                 (uint)CARRY2(uVar10,(uint)lVar19);
            for (iTT = 0; lVar19 = lSpent, iTT < 6; iTT = iTT + 1) {
              if (iTT != iT) {
                lVar19 = 0x14;
                uVar17 = __aFulmul(CONCAT22(*(undefined2 *)
                                                     ((int)&rgplr[0].lResLastYear + 2 +
                                                     i * 0xc0),
                                                    *(undefined2 *)
                                                     ((int)&rgplr[0].lResLastYear +
                                                     i * 0xc0)),3);
                lVar19 = __aFldiv(uVar17 + 0x13,lVar19);
                in_stack_0000ffb6 = (ushort)((ulong)lVar19 >> 0x10);
                uVar10 = (uint)lVar19;
                pPVar18 = (PART *)CONCAT22(idm,in_stack_0000ffb0);
                if ((game.wCrap >> 1 & 1) == 0) {
                  puVar14 = (uint *)(i * 0xc0 + 0x59c2 + iTT * 4);
                  puVar2 = puVar14;
                  uVar8 = *puVar2;
                  *puVar2 = *puVar2 + uVar10;
                  puVar2 = puVar14 + 1;
                  *puVar2 = *puVar2 + in_stack_0000ffb6 + (uint)CARRY2(uVar8,uVar10);
                }
                else {
                  pPVar18 = (PART *)__aFldiv(lVar19,2);
                  puVar14 = (uint *)(i * 0xc0 + 0x59c2 + iTT * 4);
                  puVar2 = puVar14;
                  uVar8 = *puVar2;
                  *puVar2 = *puVar2 + (uint)pPVar18;
                  puVar2 = puVar14 + 1;
                  *puVar2 = *puVar2 + (int)((ulong)pPVar18 >> 0x10) +
                            (uint)CARRY2(uVar8,(uint)pPVar18);
                }
                in_stack_0000ffb0 = (PART *)pPVar18;
                _idm = CONCAT22(uVar10,(int)((ulong)pPVar18 >> 0x10));
                puVar2 = rglFieldSpent + iTT * 2;
                uVar8 = *puVar2;
                *puVar2 = *puVar2 + uVar10;
                rglFieldSpent[iTT * 2 + 1] =
                     rglFieldSpent[iTT * 2 + 1] + in_stack_0000ffb6 + (uint)CARRY2(uVar8,uVar10);
              }
            }
          }
        }
        do {
          if ((('\x19' < *(char *)(i * 0xc0 + 0x59bc + iT)) ||
              (((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 1 & 1) != 0 &&
               ('\t' < *(char *)(i * 0xc0 + 0x59bc + iT))))) ||
             (((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 2 & 1) != 0 &&
              ('\t' < *(char *)(i * 0xc0 + 0x59bc + iT))))) goto LAB_10b8_89f3;
          lSpent = lVar19;
          lVar19 = GetTechLevelCost(iT,*(char *)(i * 0xc0 + 0x59bc + iT) + 1,i);
          if ((lSpent < lVar19) ||
             (('\x19' < *(char *)(i * 0xc0 + 0x59bc + iT) &&
              (((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 1 & 1) != 0 ||
               ('\x19' < *(char *)(i * 0xc0 + 0x59bc + iT))))))) {
            lVar19 = lSpent;
            if ((game.wCrap >> 1 & 1) != 0) {
              in_stack_0000ffb0 = (PART *)0x10d8;
              lVar21 = CONCAT22(0x89c9,(int)lVar21);
              lVar19 = __aFlshr(_idm,in_stack_0000ffb6);
            }
            lSpent._2_2_ = (int)((ulong)lVar19 >> 0x10);
            lSpent._0_2_ = (uint)lVar19;
            puVar12 = (undefined2 *)(i * 0xc0 + 0x59c2 + iT * 4);
            *puVar12 = (uint)lSpent;
            puVar12[1] = lSpent._2_2_;
            goto LAB_10b8_89f3;
          }
          iTT = iTechCur;
          lSpent = lSpent - lVar19;
          pcVar13 = (char *)(i * 0xc0 + 0x59bc + iT);
          pcVar1 = pcVar13;
          *pcVar1 = *pcVar1 + '\x01';
          cVar4 = *pcVar13;
          in_stack_0000ffb6 = CONCAT11((char)(in_stack_0000ffb6 >> 8),cVar4);
          if ((cVar4 == '\x1a') && (iTechNext == 6)) {
            iTechNext = 7;
          }
          if ((iTechCur == iT) && (iTechNext != 6)) {
            if (iTechNext == 7) {
              iTT = 0;
              _idm = CONCAT22(1,idm);
              while ((int)l15pct < 6) {
                cVar5 = *(char *)(i * 0xc0 + 0x59bc + iTT);
                uVar10 = (uint)iTT >> 8;
                if (*(char *)(i * 0xc0 + 0x59bc + l15pct) < cVar5) {
                  iTT = l15pct;
                }
                _idm = CONCAT22(l15pct + 1,CONCAT11((char)uVar10,cVar5));
              }
            }
            else {
              iTT = iTechNext;
            }
            fChgNow = 1;
          }
          in_stack_0000ffb0 = (PART *)0x0;
          lVar21 = 0;
          if (fGeneral == 0) {
            iMsg = idmScientistsHaveCompletedResearchTechLevelWill;
          }
          else {
            iMsg = idmScientistsHaveCompletedResearchTechLevelPrimary;
          }
          pPVar15 = (PART *)0x1030;
          FSendPlrMsg(i,iMsg,-2,(int)cVar4,iT,iTT,0,0,0,0);
          ibitCur = 0;
          lVar19 = lSpent;
          for (grbitCur = 1; lSpent = lVar19, grbitCur != 0; grbitCur = grbitCur << 1) {
            if (grbitCur != 0) {
              iItem = 0;
              part.hs.grhst = grbitCur;
              while( true ) {
                part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | iItem & 0xffU;
                in_stack_0000ffb0 = &part;
                pPVar16 = (PART *)0x1008;
                lVar21 = CONCAT22(pPVar15,0x866e);
                mdAvail = FLookupPart(in_stack_0000ffb0);
                pPVar15 = pPVar16;
                lVar19 = lSpent;
                if (mdAvail == 0) break;
                if (mdAvail == 1) {
                  _idm = CONCAT22(CONCAT11((char)((uint)iT >> 8),
                                           (part.u_PART_0x0004.parmor._0_2_)->rgTech[iT]),idm);
                  if (*(char *)(i * 0xc0 + 0x59bc + iT) !=
                      (part.u_PART_0x0004.parmor._0_2_)->rgTech[iT]) goto LAB_10b8_87c2;
                  if (grbitCur == 0x400) {
                    _idm = -0x2ff30;
LAB_10b8_8798:
                    FSendPlrMsg(i,idm,(short)((ulong)_idm >> 0x10),iT,grbitCur,iItem,0,0,0,0);
                    pPVar15 = (PART *)0x1030;
                    goto LAB_10b8_87c2;
                  }
                  if (grbitCur == 0x4000) {
                    _idm = -0x2ff88;
                    goto LAB_10b8_8798;
                  }
                  if (grbitCur != 0x2000) {
LAB_10b8_873a:
                    if (((grbitCur == -0x8000) && (8 < iItem)) && (iItem < 0xe)) {
                      idm = 0x145;
                    }
                    else if (((grbitCur == -0x8000) && (-1 < iItem)) && (iItem < 9)) {
                      idm = 0x157;
                    }
                    else {
                      idm = 0x5f;
                    }
                    _idm = CONCAT22(ibitCur << 8 | 0xc000U | iItem,idm);
                    goto LAB_10b8_8798;
                  }
                  pPVar15 = (PART *)0x10e0;
                  sVar11 = GetRaceGrbit((PLAYER *)rgplr + i,ibitRaceTT);
                  if ((sVar11 == 0) || (((iItem != 8 && (iItem != 0xc)) && (iItem != 0x10))))
                  goto LAB_10b8_873a;
                  iItem = iItem + 1;
                }
                else {
LAB_10b8_87c2:
                  iItem = iItem + 1;
                }
              }
            }
            ibitCur = ibitCur + 1;
          }
        } while ((((fUsePool == 0) && (fChgNow == 0)) && (iTechNext != 7)) ||
                ((iTechNext == 6 || (iT != iTechCur))));
        if (iTechNext == 7) {
          iTechNext = 0;
          for (iVar3 = 1; iVar3 < 6; iVar3 = iVar3 + 1) {
            sVar11 = iVar3;
            if (*(char *)(i * 0xc0 + 0x59bc + iTechNext) <= *(char *)(i * 0xc0 + 0x59bc + iVar3)) {
              sVar11 = iTechNext;
            }
            iTechNext = sVar11;
          }
          uVar10 = CONCAT11((char)((uint)(idPlayer * 0xc0) >> 8),
                            *(undefined1 *)
                             ((int)&rgplr[0].iTechCur + idPlayer * 0xc0)) & 0xfff0;
          bVar9 = (byte)uVar10 | (byte)iTechNext;
          _idm = CONCAT22(iVar3,CONCAT11((char)(uVar10 >> 8),bVar9));
          *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) = bVar9;
          puVar12 = (undefined2 *)(i * 0xc0 + 0x59c2 + iT * 4);
          *puVar12 = 0;
          puVar12[1] = 0;
          iTechCur = iTechNext;
          iTechNext = 7;
        }
        else {
          uVar17 = (ulong)CONCAT12(*(undefined1 *)
                                    ((int)&rgplr[0].iTechCur + idPlayer * 0xc0),idm
                                  ) & 0xff0fffff;
          *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) =
               (byte)(uVar17 >> 0x10) | 0x60;
          uVar10 = CONCAT11((char)((uint)(idPlayer * 0xc0) >> 8),
                            *(undefined1 *)
                             ((int)&rgplr[0].iTechCur + idPlayer * 0xc0)) & 0xfff0;
          bVar9 = (byte)uVar10 | (byte)iTechNext;
          idm = (short)uVar17;
          _idm = CONCAT22(CONCAT11((char)(uVar10 >> 8),bVar9),idm);
          *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) = bVar9;
          puVar12 = (undefined2 *)(i * 0xc0 + 0x59c2 + iT * 4);
          *puVar12 = 0;
          puVar12[1] = 0;
          iTechCur = iTechNext;
          iTechNext = 6;
        }
        if ((game.wCrap >> 1 & 1) != 0) {
          lVar21 = CONCAT22(0x8968,(int)lVar21);
          lVar19 = __aFlshr(lVar21,in_stack_0000ffb6);
          in_stack_0000ffb0 = pPVar15;
        }
        lSpent._2_2_ = (int)((ulong)lVar19 >> 0x10);
        lSpent._0_2_ = (uint)lVar19;
        puVar14 = (uint *)(i * 0xc0 + 0x59c2 + iTechCur * 4);
        puVar2 = puVar14;
        uVar10 = *puVar2;
        *puVar2 = *puVar2 + (uint)lSpent;
        puVar2 = puVar14 + 1;
        *puVar2 = *puVar2 + lSpent._2_2_ + (uint)CARRY2(uVar10,(uint)lSpent);
        fUsePool = 0;
        fRedoItAll = 1;
LAB_10b8_89f3:
      }
    } while (fRedoItAll != 0);
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: IBestRemoteTerra
// Address: 10b8:8b70
// Segment: MEMORY_TURN2
// ======================================================================


short IBestRemoteTerra(PLANET *lppl,short iplr,short fHelp)

{
  PLAYER *pPVar1;
  undefined2 *puVar2;
  PLAYER *pPVar3;
  char cVar4;
  int iVar5;
  PLANET *pPVar6;
  PLAYER *pPVar7;
  undefined2 *puVar8;
  PLAYER *pPVar9;
  undefined2 uVar10;
  undefined2 unaff_SS;
  undefined2 plrSav [8];
  undefined1 local_b8 [176];
  short i;
  short iBest;
  
  uVar10 = (undefined2)((ulong)lppl >> 0x10);
  pPVar6 = (PLANET *)lppl;
  pPVar7 = (PLAYER *)rgplr + pPVar6->iPlayer;
  puVar8 = plrSav;
  for (iVar5 = 0x60; iVar5 != 0; iVar5 = iVar5 + -1) {
    puVar2 = puVar8;
    puVar8 = puVar8 + 1;
    pPVar1 = pPVar7;
    pPVar7 = (PLAYER *)&pPVar7->cPlanet;
    *puVar2 = *(undefined2 *)pPVar1;
  }
  pPVar7 = (PLAYER *)rgplr + iplr;
  pPVar9 = (PLAYER *)rgplr + pPVar6->iPlayer;
  for (iVar5 = 0x60; iVar5 != 0; iVar5 = iVar5 + -1) {
    pPVar3 = pPVar9;
    pPVar9 = (PLAYER *)&pPVar9->cPlanet;
    pPVar1 = pPVar7;
    pPVar7 = (PLAYER *)&pPVar7->cPlanet;
    cVar4 = pPVar1->cShDef;
    pPVar3->iPlayer = pPVar1->iPlayer;
    pPVar3->cShDef = cVar4;
  }
  for (i = 0; i < 3; i = i + 1) {
    *(undefined1 *)(pPVar6->iPlayer * 0xc0 + 0x59b2 + i) = local_b8[i];
    *(undefined1 *)(pPVar6->iPlayer * 0xc0 + 0x59b5 + i) = local_b8[i + 3];
    *(undefined1 *)(pPVar6->iPlayer * 0xc0 + 0x59b8 + i) = local_b8[i + 6];
  }
  iBest = IBestTerraform(lppl,fHelp);
  pPVar7 = (PLAYER *)rgplr + pPVar6->iPlayer;
  puVar8 = plrSav;
  for (iVar5 = 0x60; iVar5 != 0; iVar5 = iVar5 + -1) {
    pPVar1 = pPVar7;
    pPVar7 = (PLAYER *)&pPVar7->cPlanet;
    puVar2 = puVar8;
    puVar8 = puVar8 + 1;
    uVar10 = *puVar2;
    pPVar1->iPlayer = (char)uVar10;
    pPVar1->cShDef = (char)((uint)uVar10 >> 8);
  }
  return iBest;
}



