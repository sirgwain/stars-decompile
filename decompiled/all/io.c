// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: FReadShDef
// Address: 1070:0006
// Segment: MEMORY_IO
// ======================================================================


short FReadShDef(RTSHDEF *lprt,SHDEF *lpshdef,short iplrLoad)

{
  byte *pbVar1;
  HullDef *pHVar2;
  SHDEF *pSVar3;
  uint uVar4;
  int iVar5;
  RTSHDEF *pRVar6;
  HUL *pHVar7;
  HullDef *pHVar8;
  SHDEF *pSVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  undefined2 unaff_SS;
  bool bVar12;
  HULDEF *pHVar13;
  PART part;
  HUL *lphul;
  short c;
  ushort wt;
  int local_d0;
  HUL *lphulBase;
  short iFirst;
  short cch;
  short ishdef;
  byte *lpb;
  HullDef shdef [4];
  char local_b8 [32];
  u_RTSHDEF_0x0004 local_98;
  uint local_8e;
  u_RTSHDEF_0x0004 local_88;
  undefined1 local_86 [64];
  byte local_46;
  uint local_45;
  ushort local_43;
  undefined2 local_41;
  undefined2 local_3f;
  undefined2 local_3d;
  undefined2 local_3b;
  char szTemp [42];
  
  _memset(shdef,0,0x93);
  uVar10 = (undefined2)((ulong)lprt >> 0x10);
  pRVar6 = (RTSHDEF *)lprt;
  shdef[0] = (HullDef)pRVar6->ihuldef;
  local_45 = lprt->wFlags;
  local_46 = pRVar6->chs;
  local_8e = (uint)pRVar6->ibmp;
  if ((local_45 & 0xff) == 7) {
    local_88 = pRVar6->u_RTSHDEF_0x0004;
    local_43 = pRVar6->turn;
    local_41 = (undefined2)pRVar6->cBuilt;
    local_3f = *(undefined2 *)((int)&pRVar6->cBuilt + 2);
    local_3d = (undefined2)pRVar6->cExist;
    local_3b = *(undefined2 *)((int)&pRVar6->cExist + 2);
    lpb = (byte *)CONCAT22(uVar10,pRVar6 + 1);
    __fmemmove(local_86,(RTSHDEF *)CONCAT22(uVar10,pRVar6 + 1),(uint)pRVar6->chs << 2);
    lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + (uint)pRVar6->chs * 4);
  }
  else {
    local_98 = pRVar6->u_RTSHDEF_0x0004;
    lpb = (byte *)CONCAT22(uVar10,&pRVar6->chs);
  }
  pHVar13 = LphuldefFromId(shdef[0]);
  iFirst = (((HULDEF *)pHVar13)->hul).ibmp;
  if (((int)local_8e < iFirst) || ((int)(iFirst + 4U) <= (int)local_8e)) {
    local_8e = local_8e & 3 | iFirst;
  }
  cch = (short)*lpb;
  pbVar1 = (byte *)lpb + 1;
  lpb = pbVar1;
  if (cch == 0) {
    __fstrcpy(local_b8,(char *)pbVar1);
  }
  else {
    iFirst = 0x20;
    if (0x20 < (uint)cch) {
      return 0;
    }
    __fmemmove(szTemp,pbVar1,cch);
    FDecompressUserString(szTemp,cch,local_b8,&iFirst);
  }
  ishdef = local_45 >> 10 & 0x1f;
  if (0xf < (uint)ishdef) {
    ishdef = ishdef - 0x10;
  }
  if ((((local_45 & 0xff) == 7) || ((((SHDEF *)lpshdef)[ishdef].wFlags >> 9 & 1) != 0)) ||
     ((((SHDEF *)lpshdef)[ishdef].wFlags & 0xff) < 7)) {
    pSVar9 = (SHDEF *)lpshdef + ishdef;
    pHVar8 = shdef;
    for (iVar5 = 0x49; iVar5 != 0; iVar5 = iVar5 + -1) {
      pSVar3 = pSVar9;
      pSVar9 = (pSVar9->hul).rgTech;
      pHVar2 = pHVar8;
      pHVar8 = pHVar8 + 1;
      (pSVar3->hul).ihuldef = *pHVar2;
    }
    *&(pSVar9->hul).ihuldef = (char)*pHVar8;
  }
  else if ((shdef[0] != (((SHDEF *)lpshdef + ishdef)->hul).ihuldef) ||
          (local_8e != ((SHDEF *)lpshdef)[ishdef].hul.ibmp)) {
    pSVar9 = (SHDEF *)lpshdef + ishdef;
    pHVar8 = shdef;
    for (iVar5 = 0x49; iVar5 != 0; iVar5 = iVar5 + -1) {
      pSVar3 = pSVar9;
      pSVar9 = (pSVar9->hul).rgTech;
      pHVar2 = pHVar8;
      pHVar8 = pHVar8 + 1;
      (pSVar3->hul).ihuldef = *pHVar2;
    }
    *&(pSVar9->hul).ihuldef = (char)*pHVar8;
  }
  if (idPlayer != -1) {
    UpdateShdefCost((SHDEF *)CONCAT22(lpshdef._2_2_,(SHDEF *)lpshdef + ishdef));
  }
  if ((((SHDEF *)lpshdef)[ishdef].wFlags & 0xff) == 7) {
    lphul = (HUL *)CONCAT22(lpshdef._2_2_,(SHDEF *)lpshdef + ishdef);
    lphulBase = &LphuldefFromId(lphul->ihuldef)->hul;
    wt = (((HULDEF *)lphulBase)->hul).wtEmpty;
    local_d0 = 0;
    c = 0;
    while( true ) {
      uVar10 = (undefined2)((ulong)lphul >> 0x10);
      pHVar7 = (HUL *)lphul;
      if ((int)(uint)pHVar7->chs <= c) break;
      if (pHVar7->rghs[c].wFlags_0x2 >> 8 != 0) {
        part.hs.grhst = (pHVar7->rghs + c)->grhst;
        part.hs.wFlags_0x2 = pHVar7->rghs[c].wFlags_0x2;
        iFirst = FLookupPart(&part);
        if (idPlayer == -1) {
          iFirst = 0;
        }
        if ((((part.hs.grhst & (((HUL *)lphulBase)->rghs + c)->grhst) ==
              ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|
                hstMines|hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine))
            || ((1 < iFirst && (-1 < (int)local_45)))) ||
           (((HUL *)lphulBase)->rghs[c].wFlags_0x2 >> 8 < part.hs.wFlags_0x2 >> 8)) {
          ((HUL *)lphul)->rghs[c].wFlags_0x2 = ((HUL *)lphul)->rghs[c].wFlags_0x2 & 0xff;
        }
        uVar4 = ((ARMOR *)part.u_PART_0x0004.parmor)->cMass *
                (((HUL *)lphul)->rghs[c].wFlags_0x2 >> 8);
        bVar12 = CARRY2(wt,uVar4);
        wt = wt + uVar4;
        local_d0 = local_d0 + (uint)bVar12;
      }
      if (c == 0) {
        uVar10 = (undefined2)((ulong)lphul >> 0x10);
        pHVar7 = (HUL *)lphul;
        if (pHVar7->rghs[0].wFlags_0x2 >> 8 == 0) {
          uVar11 = (undefined2)((ulong)lphulBase >> 0x10);
          if (((HUL *)lphulBase)->rghs->grhst == hstEngine) {
            pHVar7->rghs->grhst = hstEngine;
            pHVar7->rghs[0].wFlags_0x2 = pHVar7->rghs[0].wFlags_0x2 & 0xff00 | 1;
            pHVar7->rghs[0].wFlags_0x2 =
                 pHVar7->rghs[0].wFlags_0x2 & 0xff | ((HUL *)lphulBase)->rghs[0].wFlags_0x2 & 0xff00
            ;
            part.hs.grhst = pHVar7->rghs->grhst;
            part.hs.wFlags_0x2 = pHVar7->rghs[0].wFlags_0x2;
            FLookupPart(&part);
            uVar4 = ((ARMOR *)part.u_PART_0x0004.parmor)->cMass *
                    (((HUL *)lphul)->rghs[0].wFlags_0x2 >> 8);
            bVar12 = CARRY2(wt,uVar4);
            wt = wt + uVar4;
            local_d0 = local_d0 + (uint)bVar12;
          }
        }
      }
      c = c + 1;
    }
    pHVar7->wtEmpty = wt;
  }
  return 1;
}



// ======================================================================
// Function: ReadRtPlr
// Address: 1070:05e2
// Segment: MEMORY_IO
// ======================================================================


void ReadRtPlr(PLAYER *pplr,byte *pbIn)

{
  ushort uVar1;
  short cOut;
  PLAYER *pplrRaw;
  short iOff;
  
  pplrRaw = pbIn;
  _memset(pplr,0,0xc0);
  if ((pplrRaw->wMdPlr & 7) == 7) {
    _memmove(pplr,pbIn,0x70);
    _memmove(pplr->rgmdRelation,pbIn + 0x71,(uint)pbIn[0x70]);
    iOff = pbIn[0x70] + 0x71;
  }
  else {
    _memmove(pplr,pbIn,8);
    iOff = 8;
  }
  if (pbIn[iOff] == 0) {
    _strcpy(pplr->szName,pbIn + iOff + 1);
    uVar1 = _strlen(pplr->szName);
    iOff = iOff + uVar1 + 2;
  }
  else {
    cOut = 0x20;
    FDecompressUserString((char *)(pbIn + iOff + 1),(uint)pbIn[iOff],pplr->szName,&cOut);
    iOff = iOff + pbIn[iOff] + 1;
  }
  if ((wVersFile >> 5 & 0x7f) < 0x37) {
    cOut = (short)PszPlayerName(0,*(byte *)(pplr->szName[0] + 0x175f) & 1,1,0,0,pplr);
    _strcpy(pplr->szNames,(char *)cOut);
  }
  else if (pbIn[iOff] == 0) {
    _strcpy(pplr->szNames,pbIn + iOff + 1);
  }
  else {
    cOut = 0x20;
    FDecompressUserString((char *)(pbIn + iOff + 1),(uint)pbIn[iOff],pplr->szNames,&cOut);
  }
  pplr->wFlags = pplr->wFlags & 0xfff7;
  return;
}



// ======================================================================
// Function: FLoadGame
// Address: 1070:0810
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10702da2) */
/* WARNING: Removing unreachable block (ram,0x10701634) */
/* WARNING: Removing unreachable block (ram,0x10702d82) */
/* WARNING: Removing unreachable block (ram,0x10702da7) */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short FLoadGame(char *pszFileName,char *pszExt)

{
  int *piVar1;
  uint *puVar2;
  char *pcVar3;
  ushort *puVar4;
  GAME *pGVar5;
  ushort *puVar6;
  SCOREX *pSVar7;
  PLPROD *pPVar8;
  PLANET *pPVar9;
  byte *pbVar10;
  FLEET **ppFVar11;
  byte *pbVar12;
  undefined2 uVar13;
  short sVar14;
  short *pfTwo;
  char *pcVar15;
  ushort uVar16;
  int iVar17;
  PLANET *pPVar18;
  FLEET *pFVar19;
  undefined2 unaff_SI;
  char *pcVar20;
  ushort *puVar21;
  FLEET **ppFVar22;
  ushort *puVar23;
  SCOREX *pSVar24;
  undefined2 unaff_DI;
  GAME *pGVar25;
  SCOREX *pSVar26;
  undefined2 uVar27;
  undefined2 unaff_SS;
  PLANET *pPVar28;
  PL *pPVar29;
  void *pvVar30;
  SCOREX *pSVar31;
  THING *pTVar32;
  BTLPLAN *pBVar33;
  ulong uVar34;
  ushort in_stack_0000fe86;
  FLEET *in_stack_0000fe8a;
  char *psz;
  char szSection [16];
  char szIniFile [16];
  char szT [224];
  uint local_68;
  ushort turnCur;
  short isx;
  ushort sx;
  ushort local_60;
  short fTwo;
  short iWarp;
  PROD *lpprod;
  short iLast;
  ushort turnCur__78;
  PLANET *pt;
  short iplr;
  short x;
  short grf;
  short dt;
  PLANET *lpplMac;
  short local_40;
  short j;
  short iPlayer;
  THING *lpthMac;
  short local_38;
  short cturn;
  short env [9];
  FLEET *lpfl;
  THING *lpth;
  short i;
  PLANET *lppl;
  short fSilentSav;
  short (*penvMemSav) [9];
  short fHaveHistoryData;
  short cPlanetAlloc;
  uint sp [2];
  short cPlanetHist;
  short iplrSav;
  
  grf = 0;
  cturn = 0;
  _strcpy((char *)szBase,pszFileName);
  gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfbff;
  penvMemSav = penvMem;
  penvMem = &env;
  sVar14 = __setjmp(env);
  if (sVar14 == 0) {
    sVar14 = FOpenFile(dtXY,-1,0x20);
    if (sVar14 != 0) {
      ReadRt();
      if (hdrCur.wFlags >> 10 == 7) {
        pcVar20 = (char *)rgbCur;
        pGVar25 = (GAME *)&game;
        for (iVar17 = 0x20; iVar17 != 0; iVar17 = iVar17 + -1) {
          pGVar5 = pGVar25;
          pGVar25 = (GAME *)((int)&pGVar25->lid + 2);
          pcVar3 = pcVar20;
          pcVar20 = pcVar20 + 2;
          *&pGVar5->lid = *pcVar3;
        }
        game.fDirty = 0;
        dGal = game.mdSize * 400 + 400;
        dGalInv = game.mdSize * 400 + 0x960;
        x = 1000;
        for (i = 0; i < game.cPlanMax; i = i + 1) {
          RgFromStream(sp,4);
          x = x + (sp[0] & 0x3ff);
          ((POINT *)rgptPlan + i)->x = x;
          uVar34 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000fe86);
          *(uint *)((int)&rgptPlan[0].y + i * 4) = (uint)uVar34 & 0xfff;
          uVar34 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000fe86);
          ((short *)rgidPlan)[i] = (uint)uVar34 & 0x3ff;
          if (((dGal + 1000 <= x) ||
              (dGal + 1000 <= *(int *)((int)&rgptPlan[0].y + i * 4))) ||
             (999 < ((short *)rgidPlan)[i])) goto IO_XYCorrupt;
        }
        ReadRt();
        if (hdrCur.wFlags >> 10 == 0) {
          StreamClose();
          if (((*pszExt == 'h') || (*pszExt == 'H')) && ((pszExt[1] == 's' || (pszExt[1] == 'S'))))
          {
            dt = 2;
            iPlayer = -1;
          }
          else {
            dt = 3;
            grf = grf | 0x3000;
            sVar14 = _atoi(pszExt + 1);
            iPlayer = sVar14 + -1;
          }
          ResetMessages();
          _memset((PLAYER *)rgplr,0,game.cPlayer * 0xc0);
          ResetHb(htShips);
          idPlayer = iPlayer;
          fSilentSav = fFileErrSilent;
          fFileErrSilent = 1;
          if (iPlayer == -1) {
IO_LNoHistFile:
            cPlanetHist = 0;
            FreeLp(lpPlanets,htPlanets);
            lpPlanets._0_2_ = (PLANET *)0x0;
            lpPlanets._2_2_ = 0;
            cThing = 0;
            FreeLp(lpThings,htThings);
            lpThings = (THING *)0x0;
          }
          else {
            sVar14 = FOpenFile(dtHist,iPlayer,0x20);
            if (sVar14 == 0) goto IO_LNoHistFile;
            ReadRt();
            vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
            lpThings = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
            if (hdrCur.wFlags >> 10 != 0x20) {
IO_CorruptHist:
              StreamClose();
              sVar14 = 0x10;
              pcVar20 = PszFormatIds(idsHistoryFileAppearsCorruptHistoricalDataWill,
                                          (short *)0x0);
              AlertSz(pcVar20,sVar14);
              goto IO_LNoHistFile;
            }
            cPlanetHist._0_1_ = rgbCur[0];
            cPlanetHist._1_1_ = rgbCur[1];
            cPlanetAlloc = rgbCur._0_2_ + rgbCur._2_2_;
            if (1000 < cPlanetAlloc) {
              cPlanetAlloc = 1000;
            }
            iVar17 = cPlanetAlloc;
            if (cPlanetAlloc < 1) {
              iVar17 = 1;
            }
            lpPlanets = LpAlloc(iVar17 * 0x38,htPlanets);
            ReadRt();
            i = 0;
            lppl = lpPlanets;
            while( true ) {
              if (cPlanetHist <= i) break;
              if (hdrCur.wFlags >> 10 != 0xe) goto IO_CorruptHist;
              sVar14 = FReadPlanet(iPlayer,lppl,1,0);
              if (sVar14 == 0) goto IO_CorruptHist;
              uVar27 = (undefined2)((ulong)lppl >> 0x10);
              pPVar18 = (PLANET *)lppl;
              if (pPVar18->iPlayer == iPlayer) {
                pPVar18->iPlayer = -1;
                pPVar18->wFlags_0x4 = pPVar18->wFlags_0x4 & 0xff00 | 3;
              }
              ReadRt();
              i = i + 1;
              lppl = (PLANET *)lppl + 1;
            }
            if (hdrCur.wFlags >> 10 == 0x21) {
              vlpbAiData =
                   (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
              lpThings = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
              if ((uint)cbbitfMsg < (hdrCur.wFlags & 0x3ff)) goto IO_CorruptHist;
              _memcpy((byte *)bitfMsgFiltered,(char *)rgbCur,
                              hdrCur.wFlags & 0x3ff);
              ReadRt();
            }
            while (hdrCur.wFlags >> 10 == 6) {
              i = (short)rgbCur[0];
              ReadRtPlr((PLAYER *)rgplr + i,(byte *)rgbCur);
              *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
              iplr = *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xf000;
              *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) = iplr;
              ReadRt();
            }
            i = 0;
            while (hdrCur.wFlags >> 10 == 0x1a) {
              for (; (*(char *)((int)&rgplr[0].cShDef + i * 0xc0) == '\0' &&
                     (i < game.cPlayer)); i = i + 1) {
              }
              if (i == game.cPlayer) break;
              if ((*(int *)(i * 4 + rglpshdef) == 0) && (*(int *)(i * 4 + 0x100) == 0)) {
                pvVar30 = LpAlloc(0x930,htShips);
                *(undefined2 *)(i * 4 + rglpshdef) = (void *)pvVar30;
                *(undefined2 *)(i * 4 + 0x100) = (int)((ulong)pvVar30 >> 0x10);
                for (j = 0; j < 0x10; j = j + 1) {
                  iplr = *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                  *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) = iplr;
                  *(undefined2 *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x8b) = 0;
                }
              }
              sVar14 = idPlayer;
              iplrSav = idPlayer;
              if (idPlayer == -1) {
                idPlayer = i;
              }
              else {
                idPlayer = -1;
              }
              sVar14 = FReadShDef(rgbCur,
                                  (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x100),
                                                    (SHDEF *)*(undefined2 *)(i * 4 + rglpshdef)),
                                  sVar14);
              vlpbAiData =
                   (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
              lpThings = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
              if (sVar14 == 0) goto IO_CorruptHist;
              idPlayer = iplrSav;
              pcVar3 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
              *pcVar3 = *pcVar3 + -1;
              ReadRt();
            }
            i = 0;
            while (hdrCur.wFlags >> 10 == 0x1a) {
              for (; (*(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) >> 0xc == 0 &&
                     (i < game.cPlayer)); i = i + 1) {
              }
              if (i == game.cPlayer) break;
              if ((*(int *)(i * 4 + rglpshdefSB) == 0) && (*(int *)(i * 4 + 0x14e) == 0)) {
                pvVar30 = LpAlloc(0x5be,htShips);
                *(undefined2 *)(i * 4 + rglpshdefSB) = (void *)pvVar30;
                *(undefined2 *)(i * 4 + 0x14e) = (int)((ulong)pvVar30 >> 0x10);
                for (j = 0; j < 10; j = j + 1) {
                  iplr = *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xfdff | 0x200
                  ;
                  *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) = iplr;
                  *(undefined2 *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x8b) = 0;
                }
              }
              sVar14 = idPlayer;
              iplrSav = idPlayer;
              if (idPlayer == -1) {
                idPlayer = i;
              }
              else {
                idPlayer = -1;
              }
              sVar14 = FReadShDef(rgbCur,
                                  (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x14e),
                                                    (SHDEF *)*(undefined2 *)(i * 4 + rglpshdefSB)),
                                  sVar14);
              vlpbAiData =
                   (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
              lpThings = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
              if (sVar14 == 0) goto IO_CorruptHist;
              idPlayer = iplrSav;
              iplr = *(int *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) - 0x1000U & 0xf000;
              puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
              *puVar2 = *puVar2 & 0xfff;
              puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
              *puVar2 = *puVar2 | iplr;
              ReadRt();
            }
            while( true ) {
              pPVar9 = (PLANET *)CONCAT22(iplr,pt);
              pPVar28 = (PLANET *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
              if (hdrCur.wFlags >> 10 != 0x2d) break;
              iplr = rgbCur._0_2_ & 0x1f;
              puVar21 = (ushort *)rgbCur;
              puVar23 = &sx;
              for (iVar17 = 0xc; iVar17 != 0; iVar17 = iVar17 + -1) {
                puVar6 = puVar23;
                puVar23 = puVar23 + 1;
                puVar4 = puVar21;
                puVar21 = puVar21 + 1;
                *puVar6 = *puVar4;
              }
              if ((((SCOREX **)rgsxPlr)[iplr * 2] == (SCOREX *)0x0) &&
                 (*(int *)(iplr * 4 + 0x156e) == 0)) {
                pSVar31 = LpAlloc(0x978,htMisc);
                ((SCOREX **)rgsxPlr)[iplr * 2] = (SCOREX *)pSVar31;
                *(undefined2 *)(iplr * 4 + 0x156e) = (int)((ulong)pSVar31 >> 0x10);
                ((short *)rgcsxPlr)[iplr] = 0;
              }
              if ((((SCOREX **)rgsxPlr)[iplr * 2] != (SCOREX *)0x0) ||
                 (*(int *)(iplr * 4 + 0x156e) != 0)) {
                if ((int)sx < 0) {
                  turnCur = local_60;
                }
                else {
                  turnCur = game.turn;
                }
                isx = 0;
                while ((isx < ((short *)rgcsxPlr)[iplr] &&
                       ((&((SCOREX **)rgsxPlr)[iplr * 2][isx].u_SCOREX_0x0002)->turn <
                        turnCur))) {
                  isx = isx + 1;
                }
                if (((isx < ((short *)rgcsxPlr)[iplr]) &&
                    (turnCur != (&((SCOREX **)rgsxPlr)[iplr * 2][isx].u_SCOREX_0x0002)->iRank
                    )) || (100 < isx)) {
                  if (((short *)rgcsxPlr)[iplr] < 0x65) {
                    __fmemmove((SCOREX *)
                                       CONCAT22(*(undefined2 *)(iplr * 4 + 0x156e),
                                                ((SCOREX **)rgsxPlr)[iplr * 2] + isx + 1),
                                       (SCOREX *)
                                       CONCAT22(*(undefined2 *)(iplr * 4 + 0x156e),
                                                ((SCOREX **)rgsxPlr)[iplr * 2] + isx),
                                       (((short *)rgcsxPlr)[iplr] - isx) * 0x18);
                    ((short *)rgcsxPlr)[iplr] = ((short *)rgcsxPlr)[iplr] + 1;
                  }
                  else if (0 < isx) {
                    if (1 < isx) {
                      __fmemmove((SCOREX *)
                                         CONCAT22(*(undefined2 *)(iplr * 4 + 0x156e),
                                                  ((SCOREX **)rgsxPlr)[iplr * 2]),
                                         (SCOREX *)
                                         CONCAT22(*(undefined2 *)(iplr * 4 + 0x156e),
                                                  ((SCOREX **)rgsxPlr)[iplr * 2] + 1),
                                         (isx + -1) * 0x18);
                    }
                    isx = isx + -1;
                  }
                }
                else if (isx == ((short *)rgcsxPlr)[iplr]) {
                  ((short *)rgcsxPlr)[iplr] = ((short *)rgcsxPlr)[iplr] + 1;
                }
                uVar27 = *(undefined2 *)(iplr * 4 + 0x156e);
                pSVar24 = ((SCOREX **)rgsxPlr)[iplr * 2] + isx;
                puVar23 = &sx;
                for (iVar17 = 0xc; iVar17 != 0; iVar17 = iVar17 + -1) {
                  pSVar31 = pSVar24;
                  pSVar24 = &pSVar24->u_SCOREX_0x0002;
                  puVar4 = puVar23;
                  puVar23 = puVar23 + 1;
                  pSVar31->wWord = *puVar4;
                }
                (&((SCOREX **)rgsxPlr)[iplr * 2][isx].u_SCOREX_0x0002)->turn = turnCur;
                local_68 = (((SCOREX **)rgsxPlr)[iplr * 2] + isx)->wWord & 0x7fff | 0x8000;
                (((SCOREX **)rgsxPlr)[iplr * 2] + isx)->wWord = local_68;
              }
              ReadRt();
            }
            if (hdrCur.wFlags >> 10 == 0x29) {
              if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 9 & 1) ==
                  0) {
                while( true ) {
                  pPVar9 = (PLANET *)CONCAT22(iplr,pt);
                  pPVar28 = (PLANET *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
                  if (hdrCur.wFlags >> 10 != 0x29) break;
                  ReadRt();
                }
              }
              else {
                vlpbAiData =
                     (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
                pPVar9 = (PLANET *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
                if (((byte *)vlpbAiData == (byte *)0x0) &&
                   (vlpbAiData = pPVar28, pPVar9 = pPVar28, vlpbAiData._2_2_ == 0)) {
                  vlpbAiData = LpAlloc(0x1fa0,htMisc);
                  pPVar9 = vlpbAiData;
                  if (vlpbAiData == (PLANET *)0x0) goto IO_CorruptHist;
                }
                while( true ) {
                  iplr = (short)((ulong)pPVar9 >> 0x10);
                  pt = (PLANET *)pPVar9;
                  pPVar28 = vlpbAiData;
                  if (hdrCur.wFlags >> 10 != 0x29) break;
                  __fmemmove(pPVar9,rgbCur,hdrCur.wFlags & 0x3ff);
                  pt = pt->rgpctMinLevel + ((hdrCur.wFlags & 0x3ff) - 6);
                  ReadRt();
                  pPVar9 = (PLANET *)CONCAT22(iplr,pt);
                }
              }
            }
            iplr = (short)((ulong)pPVar9 >> 0x10);
            pt = (PLANET *)pPVar9;
            if (hdrCur.wFlags >> 10 == 0x2b) {
              cThing._0_1_ = rgbCur[0];
              cThing._1_1_ = rgbCur[1];
              cThingAlloc = rgbCur._0_2_ + 10;
              if (0xfd2 < cThingAlloc) {
                cThingAlloc = 0xfd2;
              }
              vlpbAiData = pPVar28;
              lpThings = LpAlloc(cThingAlloc * 0x12,htThings);
              if (lpThings == (THING *)0x0) goto IO_CorruptHist;
              __fmemset(lpThings,0,cThingAlloc * 0x12);
              ReadRt();
              lpth = lpThings;
              for (i = 0; pPVar9 = (PLANET *)CONCAT22(iplr,pt), pPVar28 = vlpbAiData,
                  i < cThing; i = i + 1) {
                if (hdrCur.wFlags >> 10 != 0x2b) goto IO_CorruptHist;
                __fmemcpy(lpth,rgbCur,hdrCur.wFlags & 0x3ff);
                ReadRt();
                lpth = (THING *)lpth + 1;
              }
            }
            iplr = (short)((ulong)pPVar9 >> 0x10);
            pt = (PLANET *)pPVar9;
            vlpbAiData = pPVar28;
            StreamClose();
          }
          fFileErrSilent = fSilentSav;
          GetFileStatus(dt,iPlayer);
          sVar14 = FOpenFile(dt | grf,iPlayer,0x20);
          if (sVar14 != 0) {
            if (iPlayer == -1) {
              iplr = (uint)rgbCur._14_2_ >> 0xb & 1;
              gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffe | iplr;
            }
            do {
              cturn = cturn + 1;
              cPlanet = 0;
              cFleet = 0;
              ReadRt();
              while ((hdrCur.wFlags >> 10 == 0x1f ||
                     (hdrCur.wFlags >> 10 == 0x27))) {
                if (hdrCur.wFlags >> 10 != 0x27) {
                  if (lpbBattleLog == (byte *)0x0) {
                    lpbBattleCur = LpAlloc(0xffc8,htBattle);
                    lpbBattleLog = lpbBattleCur;
                  }
                  if (((byte *)lpbBattleCur < (byte *)0xffc9) &&
                     (-(int)(byte *)lpbBattleCur - 0x38U < (uint)rgbCur._6_2_)) {
                    pbVar10 = lpbBattleCur;
                    pbVar10[0] = 0xff;
                    pbVar10[1] = 0xff;
                    lpbBattleCur = LpAlloc(0xffc8,htBattle);
                  }
                }
                __fmemmove(lpbBattleCur,rgbCur,
                                   hdrCur.wFlags & 0x3ff);
                lpbBattleCur =
                     (byte *)CONCAT22(lpbBattleCur._2_2_,
                                      (byte *)lpbBattleCur +
                                      (hdrCur.wFlags & 0x3ff));
                ReadRt();
              }
              if ((((byte *)lpbBattleCur != (byte *)0x0) || (lpbBattleCur._2_2_ != 0))
                 && (pbVar10 = lpbBattleCur, pbVar10[0] = 0xff, pbVar10[1] = 0xff,
                    (wVersFile >> 5 & 0x7f) < 0x50)) {
                UpdateBattleRecords();
              }
              while (hdrCur.wFlags >> 10 == 6) {
                i = (short)rgbCur[0];
                ReadRtPlr((PLAYER *)rgplr + i,(byte *)rgbCur);
                cPlanet =
                     cPlanet + *(int *)((int)&rgplr[0].cPlanet + i * 0xc0);
                *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
                cFleet =
                     cFleet +
                     (*(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xfff);
                iplr = *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xf000;
                *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) = iplr;
                ReadRt();
              }
              if (dt == 2) {
                if (hdrCur.wFlags >> 10 == 0x24) {
                  lSaltCur._0_1_ = rgbCur[0];
                  lSaltCur._1_1_ = rgbCur[1];
                  lSaltCur._2_1_ = rgbCur[2];
                  lSaltCur._3_1_ = rgbCur[3];
                  ReadRt();
                }
                else {
                  lSaltCur._0_1_ = '\0';
                  lSaltCur._1_1_ = '\0';
                  lSaltCur._2_1_ = '\0';
                  lSaltCur._3_1_ = '\0';
                }
              }
              else {
                lSaltCur._0_2_ =
                     *(undefined2 *)(char *)((int)&rgplr[0].lSalt + iPlayer * 0xc0);
                lSaltCur._2_2_ =
                     *(undefined2 *)(char *)((int)&rgplr[0].lSalt + 2 + iPlayer * 0xc0);
              }
              sVar14 = FCheckPassword();
              if (sVar14 == 0) {
                if (((ini.wFlags >> 0xe & 1) != 0) || ((int)ini.wFlags < 0)) {
                  sVar14 = 0x10;
                  pcVar20 = PszFormatIds(idsPasswordHaveEnteredIncorrectPleaseTry,(short *)0x0)
                  ;
                  AlertSz(pcVar20,sVar14);
                }
                break;
              }
              ReadPlayerMessages();
              ResetHb(htFleets);
              ResetHb(htOrd);
              FreeLp(rglpfl,htMisc);
              rglpfl._0_2_ = (FLEET **)0x0;
              rglpfl._2_2_ = 0;
              pPVar28 = lpPlanets;
              if (lpPlanets == (PLANET *)0x0) {
                cPlanetAlloc = cPlanet;
                if (cPlanet < 1) {
                  cPlanetAlloc = 1;
                }
                pPVar28 = LpAlloc(cPlanetAlloc * 0x38,htPlanets);
                    /* WARNING: Ignoring partial resolution of indirect */
                lpPlanets._0_2_ = (PLANET *)pPVar28;
                    /* WARNING: Ignoring partial resolution of indirect */
                lpPlanets._2_2_ = (int)((ulong)pPVar28 >> 0x10);
                pPVar28 = lpPlanets;
              }
              lppl = pPVar28;
              j = 0;
              lpPlanets = lppl;
              for (i = 0; i < cPlanet; i = i + 1) {
                fHaveHistoryData = 0;
                if (cPlanetHist != 0) {
                  while ((j < cPlanetHist && (lppl->id < (int)(rgbCur._0_2_ << 5) >> 5)))
                  {
                    j = j + 1;
                    lppl = (PLANET *)lppl + 1;
                  }
                  if ((j < cPlanetHist) && ((int)(rgbCur._0_2_ << 5) >> 5 == lppl->id)) {
                    fHaveHistoryData = 1;
                  }
                  else {
                    if (cPlanetAlloc == cPlanetHist) {
                      cPlanetAlloc = cPlanetAlloc + 8;
                      pPVar28 = LpReAlloc(lpPlanets,cPlanetAlloc * 0x38,htPlanets);
                    /* WARNING: Ignoring partial resolution of indirect */
                      lpPlanets._0_2_ = (PLANET *)pPVar28;
                    /* WARNING: Ignoring partial resolution of indirect */
                      lpPlanets._2_2_ = (int)((ulong)pPVar28 >> 0x10);
                      lppl = (PLANET *)
                             CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets + j);
                    }
                    if (j < cPlanetHist) {
                      __fmemmove((PLANET *)lppl + 1,lppl,(cPlanetHist - j) * 0x38);
                    }
                    cPlanetHist = cPlanetHist + 1;
                  }
                }
                sVar14 = FReadPlanet(iPlayer,lppl,0,fHaveHistoryData);
                if (sVar14 == 0) goto IO_Corrupt_2;
                uVar27 = (undefined2)((ulong)lppl >> 0x10);
                if (((PLANET *)lppl)->iPlayer != -1) {
                  piVar1 = (int *)((int)&rgplr[0].cPlanet +
                                  ((PLANET *)lppl)->iPlayer * 0xc0);
                  *piVar1 = *piVar1 + 1;
                }
                ReadRt();
                if (hdrCur.wFlags >> 10 == 0x1c) {
                  uVar27 = (undefined2)((ulong)lppl >> 0x10);
                  pPVar18 = (PLANET *)lppl;
                  if (((*(int *)&pPVar18->lpplprod != 0) ||
                      (*(int *)((int)&pPVar18->lpplprod + 2) != 0)) &&
                     (iplr = (short)((PLPROD *)pPVar18->lpplprod)->iprodMax,
                     (uint)iplr <= (hdrCur.wFlags & 0x3ff) / 4)) {
                    FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pPVar18->lpplprod + 2),
                                                  *(PL **)&pPVar18->lpplprod));
                    uVar27 = (undefined2)((ulong)lppl >> 0x10);
                    *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
                    *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
                  }
                  uVar27 = (undefined2)((ulong)lppl >> 0x10);
                  if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) &&
                     (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
                    pPVar29 = LpplAlloc(4,(hdrCur.wFlags & 0x3ff) / 4 + 2,htOrd);
                    uVar27 = (undefined2)((ulong)lppl >> 0x10);
                    *(PL **)&((PLANET *)lppl)->lpplprod = (PL *)pPVar29;
                    *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) =
                         (int)((ulong)pPVar29 >> 0x10);
                  }
                  uVar27 = (undefined2)((ulong)lppl >> 0x10);
                  __fmemmove((void *)CONCAT22(*(undefined2 *)
                                                       ((int)&((PLANET *)lppl)->lpplprod + 2),
                                                      (void *)(*(int *)&((PLANET *)lppl)->lpplprod +
                                                              4)),rgbCur,
                                     hdrCur.wFlags & 0x3ff);
                  pPVar8 = ((PLANET *)lppl)->lpplprod;
                  ((PLPROD *)pPVar8)->iprodMac =
                       (byte)((ulong)(hdrCur.wFlags & 0x3ff) / 4);
                  ReadRt();
                }
                if (cPlanetHist == 0) {
                  lppl = (PLANET *)lppl + 1;
                }
              }
              if (cPlanetHist != 0) {
                cPlanet = cPlanetHist;
              }
              for (i = 0; i < game.cPlayer; i = i + 1) {
                if (i == iPlayer) {
                  *(undefined2 *)(i * 4 + rglpshdef) = 0x3f00;
                  *(undefined2 *)(i * 4 + 0x100) = 0x1120;
IO_FreeShdef:
                  for (j = 0; j < 0x10; j = j + 1) {
                    iplr = *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xfdff | 0x200
                    ;
                    *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) = iplr;
                    *(undefined2 *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x8b) = 0;
                  }
LAB_1070_1c2c:
                  iplrSav = idPlayer;
                  if (idPlayer == -1) {
                    idPlayer = i;
                  }
                  else if (i != idPlayer) {
                    idPlayer = -1;
                  }
                  for (j = 0; j < *(char *)((int)&rgplr[0].cShDef + i * 0xc0); j = j + 1)
                  {
                    if (hdrCur.wFlags >> 10 != 0x1a) {
                      idPlayer = iplrSav;
                      goto IO_Corrupt_2;
                    }
                    sVar14 = FReadShDef(rgbCur,
                                        (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x100),
                                                          (SHDEF *)*(undefined2 *)
                                                                    (i * 4 + rglpshdef)),iplrSav);
                    if (sVar14 == 0) goto IO_Corrupt_2;
                    ReadRt();
                  }
                  idPlayer = iplrSav;
                }
                else if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
                  if ((*(int *)(i * 4 + rglpshdef) == 0) && (*(int *)(i * 4 + 0x100) == 0)) {
                    pvVar30 = LpAlloc(0x930,htShips);
                    *(undefined2 *)(i * 4 + rglpshdef) = (void *)pvVar30;
                    *(undefined2 *)(i * 4 + 0x100) = (int)((ulong)pvVar30 >> 0x10);
                    goto IO_FreeShdef;
                  }
                  goto LAB_1070_1c2c;
                }
              }
              for (i = 0; i < game.cPlayer; i = i + 1) {
                *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
                if ((*(int *)(i * 4 + rglpshdef) != 0) || (*(int *)(i * 4 + 0x100) != 0)) {
                  for (j = 0; j < 0x10; j = j + 1) {
                    if ((*(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
                      if (((i == idPlayer) || (((uint)gd.grBits >> 1 & 1) != 0)) ||
                         ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0)) {
                        pcVar3 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
                        *pcVar3 = *pcVar3 + '\x01';
                      }
                      else {
                        iplr = *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xfdff |
                               0x200;
                        *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) = iplr;
                      }
                    }
                  }
                }
              }
              iVar17 = cFleet;
              if (cFleet < 1) {
                iVar17 = 1;
              }
              pcVar20 = (char *)0x1060;
              rglpfl = LpAlloc(iVar17 << 2,htMisc);
              for (i = 0; i < cFleet; i = i + 1) {
                lpfl = LpAlloc(0x7c,htFleets);
                uVar27 = rglpfl._2_2_;
                in_stack_0000fe8a = (FLEET *)lpfl;
                ppFVar22 = (FLEET **)rglpfl + i;
                *(FLEET **)ppFVar22 = in_stack_0000fe8a;
                *(undefined2 *)((int)ppFVar22 + 2) = (int)((ulong)lpfl >> 0x10);
                pcVar20 = (char *)0x1070;
                sVar14 = FReadFleet(lpfl);
                if (sVar14 == 0) goto IO_LError_2;
                uVar27 = (undefined2)((ulong)lpfl >> 0x10);
                pFVar19 = (FLEET *)lpfl;
                iplr = *(int *)((int)&rgplr[0].wFlags_0x4 + pFVar19->iPlayer * 0xc0) + 1U
                       & 0xfff;
                puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar19->iPlayer * 0xc0);
                *puVar2 = *puVar2 & 0xf000;
                puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar19->iPlayer * 0xc0);
                *puVar2 = *puVar2 | iplr;
              }
              for (i = 0; i < game.cPlayer; i = i + 1) {
                if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
                  if ((*(int *)(i * 4 + rglpshdefSB) == 0) && (*(int *)(i * 4 + 0x14e) == 0)) {
                    pcVar20 = (char *)0x1060;
                    pvVar30 = LpAlloc(0x5be,htShips);
                    *(undefined2 *)(i * 4 + rglpshdefSB) = (void *)pvVar30;
                    *(undefined2 *)(i * 4 + 0x14e) = (int)((ulong)pvVar30 >> 0x10);
                    for (j = 0; j < 10; j = j + 1) {
                      iplr = *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xfdff |
                             0x200;
                      *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) = iplr;
                      *(undefined2 *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x8b) = 0;
                    }
                  }
                  iplrSav = idPlayer;
                  if (idPlayer == -1) {
                    idPlayer = i;
                  }
                  else if (i != idPlayer) {
                    idPlayer = -1;
                  }
                  for (j = 0; j < (int)(*(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) >>
                                       0xc); j = j + 1) {
                    if (hdrCur.wFlags >> 10 != 0x1a) {
                      idPlayer = iplrSav;
                      goto IO_Corrupt_2;
                    }
                    sVar14 = FReadShDef(rgbCur,
                                        (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x14e),
                                                          (SHDEF *)*(undefined2 *)
                                                                    (i * 4 + rglpshdefSB)),iplrSav);
                    if (sVar14 == 0) goto IO_Corrupt_2;
                    pcVar20 = (char *)0x1070;
                    ReadRt();
                  }
                  idPlayer = iplrSav;
                }
              }
              pSVar31 = vlprgScoreX;
              for (i = 0; vlprgScoreX = pSVar31, i < game.cPlayer; i = i + 1) {
                iplr = *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xfff;
                *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) = iplr;
                if ((*(int *)(i * 4 + rglpshdefSB) != 0) ||
                   (pSVar31 = vlprgScoreX, *(int *)(i * 4 + 0x14e) != 0)) {
                  for (j = 0; pSVar31 = vlprgScoreX, j < 10; j = j + 1) {
                    if ((*(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) >> 9 & 1) == 0)
                    {
                      if (((i == idPlayer) || (((uint)gd.grBits >> 1 & 1) != 0)) ||
                         ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0)) {
                        iplr = *(int *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) + 0x1000U &
                               0xf000;
                        puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
                        *puVar2 = *puVar2 & 0xfff;
                        puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
                        *puVar2 = *puVar2 | iplr;
                      }
                      else {
                        iplr = *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xfdff |
                               0x200;
                        *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) = iplr;
                      }
                    }
                  }
                }
              }
              if (pSVar31 == (SCOREX *)0x0) {
                pSVar31 = LpAlloc(game.cPlayer * 0x18,htMisc);
                in_stack_0000fe8a = (FLEET *)0x0;
                pcVar20 = (char *)0x1118;
                vlprgScoreX = pSVar31;
                __fmemset(pSVar31,0,game.cPlayer * 0x18);
                pSVar31 = vlprgScoreX;
              }
              while( true ) {
                vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar31 >> 0x10);
                uVar27 = vlprgScoreX._2_2_;
                vlprgScoreX._0_2_ = (SCOREX *)pSVar31;
                vlprgScoreX = pSVar31;
                if (hdrCur.wFlags >> 10 != 0x2d) break;
                iplr = rgbCur._0_2_ & 0x1f;
                pSVar24 = (SCOREX *)vlprgScoreX + iplr;
                puVar23 = (ushort *)rgbCur;
                for (iVar17 = 0xc; iVar17 != 0; iVar17 = iVar17 + -1) {
                  pSVar31 = pSVar24;
                  pSVar24 = &pSVar24->u_SCOREX_0x0002;
                  puVar4 = puVar23;
                  puVar23 = puVar23 + 1;
                  pSVar31->wWord = *puVar4;
                }
                pSVar31 = vlprgScoreX;
                if ((((SCOREX **)rgsxPlr)[iplr * 2] == (SCOREX *)0x0) &&
                   (*(int *)(iplr * 4 + 0x156e) == 0)) {
                  pSVar31 = LpAlloc(0x978,htMisc);
                  ((SCOREX **)rgsxPlr)[iplr * 2] = (SCOREX *)pSVar31;
                  *(undefined2 *)(iplr * 4 + 0x156e) = (int)((ulong)pSVar31 >> 0x10);
                  ((short *)rgcsxPlr)[iplr] = 0;
                  pSVar31 = vlprgScoreX;
                }
                vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar31 >> 0x10);
                vlprgScoreX._0_2_ = (SCOREX *)pSVar31;
                if ((((SCOREX **)rgsxPlr)[iplr * 2] != (SCOREX *)0x0) ||
                   (*(int *)(iplr * 4 + 0x156e) != 0)) {
                  if ((int)((SCOREX *)vlprgScoreX + iplr)->wWord < 0) {
                    turnCur__78 = (&((SCOREX *)vlprgScoreX)[iplr].u_SCOREX_0x0002)->turn;
                  }
                  else {
                    turnCur__78 = game.turn;
                  }
                  pt = (PLANET *)0x0;
                  while (((int)pt < ((short *)rgcsxPlr)[iplr] &&
                         ((&((SCOREX **)rgsxPlr)[iplr * 2][(int)pt].u_SCOREX_0x0002)->turn <
                          turnCur__78))) {
                    pt = (PLANET *)((int)&pt->id + 1);
                  }
                  vlprgScoreX = pSVar31;
                  if ((((int)pt < ((short *)rgcsxPlr)[iplr]) &&
                      (turnCur__78 !=
                       (&((SCOREX **)rgsxPlr)[iplr * 2][(int)pt].u_SCOREX_0x0002)->iRank)) ||
                     (100 < (int)pt)) {
                    if (((short *)rgcsxPlr)[iplr] < 0x65) {
                      __fmemmove((SCOREX *)
                                         CONCAT22(*(undefined2 *)(iplr * 4 + 0x156e),
                                                  ((SCOREX **)rgsxPlr)[iplr * 2] +
                                                  (int)&pt->id + 1),
                                         (SCOREX *)
                                         CONCAT22(*(undefined2 *)(iplr * 4 + 0x156e),
                                                  ((SCOREX **)rgsxPlr)[iplr * 2] + (int)pt),
                                         (((short *)rgcsxPlr)[iplr] - (int)pt) * 0x18);
                      ((short *)rgcsxPlr)[iplr] = ((short *)rgcsxPlr)[iplr] + 1;
                      pSVar31 = vlprgScoreX;
                    }
                    else if (0 < (int)pt) {
                      if (1 < (int)pt) {
                        __fmemmove((SCOREX *)
                                           CONCAT22(*(undefined2 *)(iplr * 4 + 0x156e),
                                                    ((SCOREX **)rgsxPlr)[iplr * 2]),
                                           (SCOREX *)
                                           CONCAT22(*(undefined2 *)(iplr * 4 + 0x156e),
                                                    ((SCOREX **)rgsxPlr)[iplr * 2] + 1),
                                           ((int)&pt[-1].lpplprod + 3) * 0x18);
                        pSVar31 = vlprgScoreX;
                      }
                      pt = (PLANET *)((int)&pt[-1].lpplprod + 3);
                    }
                  }
                  else if (pt == (PLANET *)((short *)rgcsxPlr)[iplr]) {
                    ((short *)rgcsxPlr)[iplr] = ((short *)rgcsxPlr)[iplr] + 1;
                    pSVar31 = vlprgScoreX;
                  }
                  vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar31 >> 0x10);
                  uVar13 = vlprgScoreX._2_2_;
                  vlprgScoreX._0_2_ = (SCOREX *)pSVar31;
                  pSVar24 = (SCOREX *)vlprgScoreX + iplr;
                  uVar27 = *(undefined2 *)(iplr * 4 + 0x156e);
                  pSVar26 = ((SCOREX **)rgsxPlr)[iplr * 2] + (int)pt;
                  vlprgScoreX = pSVar31;
                  for (iVar17 = 0xc; iVar17 != 0; iVar17 = iVar17 + -1) {
                    pSVar7 = pSVar26;
                    pSVar26 = &pSVar26->u_SCOREX_0x0002;
                    pSVar31 = pSVar24;
                    pSVar24 = &pSVar24->u_SCOREX_0x0002;
                    pSVar7->wWord = pSVar31->wWord;
                  }
                  (&((SCOREX **)rgsxPlr)[iplr * 2][(int)pt].u_SCOREX_0x0002)->turn =
                       turnCur__78;
                  iLast = (((SCOREX **)rgsxPlr)[iplr * 2] + (int)pt)->wWord & 0x7fff | 0x8000
                  ;
                  (((SCOREX **)rgsxPlr)[iplr * 2] + (int)pt)->wWord = iLast;
                  pSVar31 = vlprgScoreX;
                }
                pcVar20 = (char *)0x1070;
                vlprgScoreX = pSVar31;
                ReadRt();
                pSVar31 = vlprgScoreX;
              }
              if (lpThings != (THING *)0x0) {
                pcVar20 = (char *)0x1060;
                FreeLp(lpThings,htThings);
                    /* WARNING: Ignoring partial resolution of indirect */
                lpThings._0_2_ = (THING *)0x0;
                    /* WARNING: Ignoring partial resolution of indirect */
                lpThings._2_2_ = 0;
                cThing = 0;
                pSVar31 = vlprgScoreX;
              }
              vlprgScoreX = pSVar31;
              if (hdrCur.wFlags >> 10 == 0x2b) {
                pt = (PLANET *)(uint)(0 < cThing);
                iplr._0_1_ = rgbCur[0];
                iplr._1_1_ = rgbCur[1];
                cThingAlloc = rgbCur._0_2_;
                if ((int)rgbCur._0_2_ < 10) {
                  cThingAlloc = 10;
                }
                if (lpThings == (THING *)0x0) {
                  pTVar32 = LpAlloc(cThingAlloc * 0x12,htThings);
                    /* WARNING: Ignoring partial resolution of indirect */
                  lpThings._0_2_ = (THING *)pTVar32;
                    /* WARNING: Ignoring partial resolution of indirect */
                  lpThings._2_2_ = (int)((ulong)pTVar32 >> 0x10);
                  if (lpThings == (THING *)0x0) break;
                  in_stack_0000fe8a = (FLEET *)0x0;
                  pcVar20 = (char *)0x1118;
                  __fmemset(lpThings,0,cThingAlloc * 0x12);
                  pSVar31 = vlprgScoreX;
                }
                pfTwo = (short *)((int)(short *)&viStore + 1);
                vlprgScoreX = pSVar31;
                ReadRt();
                lpth = lpThings;
                j = 0;
                for (i = 0; i < iplr; i = i + 1) {
                  fHaveHistoryData = 0;
                  if (pt == (PLANET *)0x0) {
LAB_1070_270b:
                    cThing = cThing + 1;
                  }
                  else {
                    while ((j < cThing && (lpth->idFull < (uint)rgbCur._0_2_))) {
                      j = j + 1;
                      lpth = (THING *)lpth + 1;
                    }
                    if ((cThing <= j) || (rgbCur._0_2_ != lpth->idFull)) {
                      if (cThingAlloc == cThing) {
                        cThingAlloc = cThingAlloc + 8;
                        pTVar32 = LpReAlloc(lpThings,cThingAlloc * 0x12,
                                                    htThings);
                    /* WARNING: Ignoring partial resolution of indirect */
                        lpThings._0_2_ = (THING *)pTVar32;
                    /* WARNING: Ignoring partial resolution of indirect */
                        lpThings._2_2_ = (int)((ulong)pTVar32 >> 0x10);
                        lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings + j)
                        ;
                      }
                      if (j < cThing) {
                        __fmemmove((THING *)lpth + 1,lpth,(cThing - j) * 0x12);
                        __fmemset(lpth,0,0x12);
                      }
                      goto LAB_1070_270b;
                    }
                    fHaveHistoryData = 1;
                  }
                  pcVar20 = (char *)rgbCur;
                  pfTwo = lpth._2_2_;
                  __fmemcpy(lpth,rgbCur,hdrCur.wFlags & 0x3ff);
                  uVar27 = (undefined2)((ulong)lpth >> 0x10);
                  ((THING *)lpth)->turn = game.turn;
                  lpth = (THING *)CONCAT22(uVar27,(THING *)lpth + 1);
                  j = j + 1;
                  in_stack_0000fe8a = (FLEET *)((int)&vrgrcSlot[0xf].top + 1);
                  ReadRt();
                }
              }
              else {
                cThing = 0;
                cThingAlloc = 10;
                pcVar20 = (char *)0xa;
                pfTwo = (short *)0xb4;
                pTVar32 = LpAlloc(0xb4,htThings);
                    /* WARNING: Ignoring partial resolution of indirect */
                lpThings._0_2_ = (THING *)pTVar32;
                    /* WARNING: Ignoring partial resolution of indirect */
                lpThings._2_2_ = (int)((ulong)pTVar32 >> 0x10);
              }
              if (hdrCur.wFlags >> 10 == 0x16) {
                in_stack_0000fe8a = (FLEET *)((int)(short *)rgidPlan + 0x27);
                ReadRt();
              }
              iplrSav = idPlayer;
              while (hdrCur.wFlags >> 10 == 0x1e) {
                idPlayer = rgbCur._0_2_ & 0xf;
                iplr = idPlayer;
                if ((((BTLPLAN **)rglpbtlplan)[idPlayer * 2] == (BTLPLAN *)0x0) &&
                   (*(int *)(idPlayer * 4 + 0x593a) == 0)) {
                  pBVar33 = LpAlloc(0x240,htShips);
                  ((BTLPLAN **)rglpbtlplan)[iplr * 2] = (BTLPLAN *)pBVar33;
                  *(undefined2 *)(iplr * 4 + 0x593a) = (int)((ulong)pBVar33 >> 0x10);
                }
                UnpackBattlePlan(rgbCur,
                                 (BTLPLAN *)
                                 CONCAT22(*(undefined2 *)(iplr * 4 + 0x593a),
                                          ((BTLPLAN **)rglpbtlplan)[iplr * 2] +
                                          ((byte *)rgcbtlplan)[iplr]),
                                 (uint)((byte *)rgcbtlplan)[iplr]);
                ((byte *)rgcbtlplan)[iplr] = ((byte *)rgcbtlplan)[iplr] + 1;
                ReadRt();
              }
              idPlayer = iplrSav;
              if (hdrCur.wFlags >> 10 != 0) {
IO_Corrupt_2:
                sVar14 = 0x10;
                pcVar20 = PszFormatIds(idsGameFileAppearsCorruptUnableLoadFile,(short *)0x0);
                AlertSz(pcVar20,sVar14);
                break;
              }
              pPVar28 = (PLANET *)__filelength(hf);
              iplr = (short)((ulong)pPVar28 >> 0x10);
              pt = (PLANET *)pPVar28;
              pPVar28 = (PLANET *)__tell(hf);
              if (pPVar28 == (PLANET *)CONCAT22(iplr,pt)) goto LAB_1070_2a56;
              ReadRt();
              if (hdrCur.wFlags >> 10 != 8) goto LAB_1070_2a35;
              game.turn._0_1_ = rgbCur[10];
              game.turn._1_1_ = rgbCur[0xb];
              game.wCrap =
                   game.wCrap & 0xf1ff | ((uint)rgbCur._14_2_ >> 0xd) << 9;
              i = 0;
              lppl = lpPlanets;
              while( true ) {
                lpPlanets._2_2_ = (short)((ulong)lppl >> 0x10);
                lpPlanets._0_2_ = (PLANET *)lppl;
                lpPlanets = lppl;
                if (game.cPlayer <= i) break;
                *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
                *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) =
                     *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xf000;
                *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
                *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) =
                     *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xfff;
                ((byte *)rgcbtlplan)[i] = 0;
                i = i + 1;
                lppl = lpPlanets;
              }
              pt = (PLANET *)lpPlanets;
              iplr = lpPlanets._2_2_;
              lpplMac = (PLANET *)lpPlanets + cPlanet;
              local_40 = iplr;
              while ((PLANET *)lppl < lpplMac) {
                uVar27 = (undefined2)((ulong)lppl >> 0x10);
                if (((PLANET *)lppl)->iPlayer == iPlayer) {
                  ((PLANET *)lppl)->iPlayer = -1;
                  ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xff00 | 3;
                  if ((*(int *)&((PLANET *)lppl)->lpplprod != 0) ||
                     (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) {
                    FreePl((PL *)CONCAT22(*(undefined2 *)
                                                   ((int)&((PLANET *)lppl)->lpplprod + 2),
                                                  *(PL **)&((PLANET *)lppl)->lpplprod));
                    uVar27 = (undefined2)((ulong)lppl >> 0x10);
                    *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
                    *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
                  }
                }
                lppl = (PLANET *)lppl + 1;
              }
              cPlanetHist = cPlanet;
            } while( true );
          }
          goto IO_LError_2;
        }
      }
IO_XYCorrupt:
      sVar14 = 0x10;
      pcVar20 = PszFormatIds(idsUniverseDefinitionFileSeemsMissingCorrupt,(short *)0x0);
      AlertSz(pcVar20,sVar14);
    }
  }
IO_LError_2:
  game.fDirty = 0;
  DestroyCurGame();
  StreamClose();
  if ((((ini.wFlags >> 0xe & 1) == 0) && (-1 < (int)ini.wFlags)) &&
     (hwndTitle == 0)) {
    pt = (PLANET *)GetSystemMetrics(0);
    iplr = GetSystemMetrics(1);
    hwndTitle =
         CreateWindow(szTitle,(LPCSTR)0x11200752,0x90000000,0,0,(short)pt,iplr,
                      hwndFrame,0,hInst,(void *)0x0);
    fFreeingTitle = 0;
    ShowWindow(hwndFrame,0);
  }
  sVar14 = 0;
  pbVar10 = vlpbAiData;
  pTVar32 = lpThings;
  pPVar28 = lpPlanets;
  ppFVar11 = rglpfl;
  pSVar31 = vlprgScoreX;
  pbVar12 = lpbBattleLog;
LAB_1070_3200:
  lpbBattleLog._2_2_ = (undefined2)((ulong)pbVar12 >> 0x10);
  lpbBattleLog._0_2_ = (byte *)pbVar12;
  vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar31 >> 0x10);
  vlprgScoreX._0_2_ = (SCOREX *)pSVar31;
  rglpfl._2_2_ = (undefined2)((ulong)ppFVar11 >> 0x10);
  rglpfl._0_2_ = (FLEET **)ppFVar11;
  lpPlanets._2_2_ = (short)((ulong)pPVar28 >> 0x10);
  lpPlanets._0_2_ = (PLANET *)pPVar28;
  lpThings._2_2_ = (short)((ulong)pTVar32 >> 0x10);
  lpThings._0_2_ = (THING *)pTVar32;
  vlpbAiData._2_2_ = (int)((ulong)pbVar10 >> 0x10);
  vlpbAiData._0_2_ = (byte *)pbVar10;
  return sVar14;
LAB_1070_2a35:
  sVar14 = 0x10;
  pcVar15 = PszFormatIds(idsWarningIgnoringUnexpectedDataAfterEof,(short *)0x0);
  AlertSz(pcVar15,sVar14);
LAB_1070_2a56:
  StreamClose();
  if ((((1 < cturn) && ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0)
       ) && ((ini.wFlags >> 0xc & 1) == 0)) &&
     (((ini.wFlags >> 0xb & 1) == 0 && ((ini.wFlags >> 0xd & 1) == 0)))) {
    sVar14 = cturn;
    pcVar15 = PszGetCompressedString(idsNoteDYearsDataRead);
    _wsprintf(szWork,pcVar15,sVar14);
    AlertSz((char *)szWork,0x40);
  }
  sVar14 = __strnicmp(pszExt,(char *)0x759,3);
  ppFVar11 = rglpfl;
  if (sVar14 != 0) {
    pPVar28 = lpPlanets;
    if ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0) {
      fTwo = (short)(THING *)lpThings;
      iWarp = lpThings._2_2_;
      lpth = lpThings;
      lpthMac = (THING *)lpThings + cThing;
      local_38 = iWarp;
      while( true ) {
        lpPlanets._2_2_ = (short)((ulong)pPVar28 >> 0x10);
        lpPlanets._0_2_ = (PLANET *)pPVar28;
        if (lpthMac <= (THING *)lpth) break;
        if ((lpth->idFull >> 0xd == 1) &&
           (uVar27 = (undefined2)((ulong)lpth >> 0x10),
           (((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) != 0)) {
          lpPlanets = pPVar28;
          lppl = LpplFromId(((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0x3ff);
          iVar17 = (int)((ulong)lppl >> 0x10);
          pPVar28 = lpPlanets;
          if ((((PLANET *)lppl != (PLANET *)0x0) || (iVar17 != 0)) &&
             (((PLANET *)lppl)->iPlayer == iPlayer)) {
            pfTwo = &fTwo;
            iWarp = IWarpMAFromLppl(lppl,pfTwo);
            pPVar28 = lpPlanets;
            if (iWarp + fTwo <
                (int)((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) + 4)) {
              pfTwo = (short *)lppl->id;
              FSendPlrMsg2XGen
                        (0,idmMassPacketAppearsCollisionCourseWhichCurrently,-6,lpth->idFull,
                         (short)pfTwo);
              pPVar28 = lpPlanets;
            }
          }
        }
        lpth = (THING *)lpth + 1;
      }
      if ((game.wCrap >> 3 & 1) == 0) {
        fTwo = (short)(PLANET *)lpPlanets;
        iWarp = lpPlanets._2_2_;
        lpplMac = (PLANET *)lpPlanets + cPlanet;
        local_40 = iWarp;
        lppl = pPVar28;
        while ((PLANET *)lppl < lpplMac) {
          uVar27 = (undefined2)((ulong)lppl >> 0x10);
          if ((((((PLANET *)lppl)->iPlayer == iPlayer) &&
               ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0)) &&
              ((*(int *)&((PLANET *)lppl)->lpplprod != 0 ||
               (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)))) &&
             (iVar17 = ((PLANET *)lppl)->iPlayer * 4,
             *(int *)(*(int *)(iVar17 + rglpshdefSB) +
                     (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93) != 0x20)) {
            iplr = 0;
            pt = (PLANET *)0x0;
            lpprod._0_2_ = *(PROD **)&((PLANET *)lppl)->lpplprod;
            lpprod._2_2_ = *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2);
            for (; lpprod._0_2_ = (PROD *)lpprod + 1, pPVar8 = ((PLANET *)lppl)->lpplprod,
                (int)pt < (int)(uint)((PLPROD *)pPVar8)->iprodMac; pt = (PLANET *)((int)&pt->id + 1)
                ) {
              lpPlanets = pPVar28;
              EstimateItemProdSched(lppl,(PLPROD *)0x0,(short)pt,&turnCur__78,&iLast);
              pPVar28 = lpPlanets;
              if (1 < iLast) {
                iplr = 0;
                break;
              }
              if (iLast == 1) {
                uVar34 = __aFulshr(CONCAT22(pcVar20,pfTwo),(ushort)in_stack_0000fe8a);
                if (((uint)uVar34 & 7) == 1) {
                  uVar34 = __aFulshr(CONCAT22(pcVar20,pfTwo),(ushort)in_stack_0000fe8a);
                  pPVar28 = lpPlanets;
                  if (((uint)uVar34 & 0x7f) < 7) goto LAB_1070_2cf9;
                }
                iplr = 1;
                pPVar28 = lpPlanets;
              }
LAB_1070_2cf9:
            }
            if (iplr != 0) {
              lpPlanets = pPVar28;
              FSendPlrMsg2XGen
                        (0,idmStarbaseScheduledCompleteRemainingProductionItem,lppl->id,lppl->id,0);
              pPVar28 = lpPlanets;
            }
          }
          lppl = (PLANET *)lppl + 1;
        }
        lpPlanets = pPVar28;
        i = CBattles();
        pPVar28 = lpPlanets;
        if (0 < i) {
          FSendPlrMsg2XGen(1,(1 < i) + idmHaveReceivedOneBattleRecordingYear,-7,i,0);
          pPVar28 = lpPlanets;
        }
      }
    }
    if ((gd.grBits._2_2_ >> 1 & 1) == 0) {
      lpPlanets = pPVar28;
      _wsprintf(szWork,(char *)0x1120075d,pszFileName,0x1120,pszExt + 1,0x1120);
      sVar14 = FLoadLogFile((char *)szWork);
      if (sVar14 != 0) {
        sVar14 = FRunLogFile();
        pPVar28 = lpPlanets;
        if (sVar14 != 0) goto LAB_1070_2eb1;
      }
      sVar14 = 0x10;
      pcVar20 = PszFormatIds(idsPlayerLogFileAppearsCorruptUnableLoad,(short *)0x0);
      AlertSz(pcVar20,sVar14);
      goto IO_LError_2;
    }
LAB_1070_2eb1:
    i = 0;
    lppl = pPVar28;
    while( true ) {
      lpPlanets._2_2_ = (short)((ulong)lppl >> 0x10);
      lpPlanets._0_2_ = (PLANET *)lppl;
      lpPlanets = lppl;
      if (game.cPlayer <= i) break;
      *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xf000;
      *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
      i = i + 1;
      lppl = lpPlanets;
    }
    pt = (PLANET *)lpPlanets;
    local_40 = lpPlanets._2_2_;
    lpplMac = (PLANET *)lpPlanets + cPlanet;
    while ((PLANET *)lppl < lpplMac) {
      uVar27 = (undefined2)((ulong)lppl >> 0x10);
      if (((PLANET *)lppl)->iPlayer == -1) {
        ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfdff;
      }
      else {
        piVar1 = (int *)((int)&rgplr[0].cPlanet + ((PLANET *)lppl)->iPlayer * 0xc0);
        *piVar1 = *piVar1 + 1;
      }
      lppl = (PLANET *)CONCAT22(uVar27,(PLANET *)lppl + 1);
    }
    j = 0;
    i = 0;
    iplr = local_40;
    ppFVar11 = rglpfl;
    while( true ) {
      rglpfl._2_2_ = (undefined2)((ulong)ppFVar11 >> 0x10);
      rglpfl._0_2_ = (FLEET **)ppFVar11;
      if (cFleet <= i) break;
                    /* WARNING: Load size is inaccurate */
      pFVar19 = ((FLEET **)rglpfl)[i];
      iVar17 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpfl = (FLEET *)CONCAT22(iVar17,pFVar19);
      if ((pFVar19 == (FLEET *)0x0) && (iVar17 == 0)) break;
      j = pFVar19->iPlayer;
      iplr = *(int *)((int)&rgplr[0].wFlags_0x4 + j * 0xc0) + 1U & 0xfff;
      puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + j * 0xc0);
      rglpfl = ppFVar11;
      *puVar2 = *puVar2 & 0xf000;
      puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + j * 0xc0);
      *puVar2 = *puVar2 | iplr;
      i = i + 1;
      ppFVar11 = rglpfl;
    }
  }
  idPlayer = iPlayer;
  pbVar10 = vlpbAiData;
  pTVar32 = lpThings;
  pPVar28 = lpPlanets;
  pSVar31 = vlprgScoreX;
  pbVar12 = lpbBattleLog;
  if (((iPlayer != -1) &&
      ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0)) &&
     (((char *)vrgszMRU != (char *)0x0 || (vrgszMRU._2_2_ != 0)))) {
    rglpfl = ppFVar11;
    _strcpy(szT,pszFileName);
    _strcat(szT,(char *)0x764);
    _strcat(szT,pszExt);
    sVar14 = __fstricmp(szT,(char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU))
    ;
    pbVar10 = vlpbAiData;
    pTVar32 = lpThings;
    pPVar28 = lpPlanets;
    pSVar31 = vlprgScoreX;
    ppFVar11 = rglpfl;
    pbVar12 = lpbBattleLog;
    if (sVar14 != 0) {
      for (i = 1; i < 8; i = i + 1) {
        sVar14 = __fstricmp(szT,(char *)CONCAT22(vrgszMRU._2_2_,
                                                         (char *)vrgszMRU + i * 0x100));
        if (sVar14 == 0) break;
      }
      for (; 0 < i; i = i + -1) {
        __fstrcpy((char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU + i * 0x100
                                          ),
                          (char *)CONCAT22(vrgszMRU._2_2_,
                                           (char *)vrgszMRU + (i + -1) * 0x100));
      }
      __fstrcpy((char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU),szT);
      CchGetString(idsStarsIni,szIniFile);
      CchGetString(idsFiles,szSection);
      CchGetString(idsFile1,&stack0xfe86);
      uVar16 = _strlen(&stack0xfe86);
      for (i = 0; pbVar10 = vlpbAiData, pTVar32 = lpThings, pPVar28 = lpPlanets
          , pSVar31 = vlprgScoreX, ppFVar11 = rglpfl, pbVar12 = lpbBattleLog,
          i < 9; i = i + 1) {
        szSection[uVar16 - 0x13] = (char)i + '1';
        __fstrcpy(szT,(char *)CONCAT22(vrgszMRU._2_2_,
                                               (char *)vrgszMRU + i * 0x100));
        WritePrivateProfileString(szSection,(LPCSTR)&stack0xfe86,szT,szIniFile);
      }
    }
  }
  sVar14 = 1;
  goto LAB_1070_3200;
}



// ======================================================================
// Function: FReadPlanet
// Address: 1070:3206
// Segment: MEMORY_IO
// ======================================================================


short FReadPlanet(short iPlayer,PLANET *lppl,short fHistory,short fPreInited)

{
  uint uVar1;
  undefined2 uVar2;
  bool bVar3;
  byte bVar4;
  uint uVar5;
  short sVar6;
  short sVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar8;
  ushort in_stack_0000ffea;
  short pct;
  short pctOpt;
  short idm;
  byte *pb;
  short i;
  byte bMask;
  short fRouting;
  short fFirstYear;
  
  lVar8 = CONCAT22(unaff_SI,unaff_DI);
  bVar3 = false;
  if (fPreInited == 0) {
    __fmemset(lppl,0,0x38);
  }
  if ((fHistory == 0) && (iPlayer != -1)) {
    if (fPreInited == 0) {
      bVar3 = true;
      ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xf7ff | 0x800;
    }
    else if ((((PLANET *)lppl)->wFlags_0x4 >> 0xb & 1) != 0) {
      if (((PLANET *)lppl)->turn == game.turn) {
        bVar3 = true;
      }
      else {
        ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xf7ff;
      }
    }
  }
  else {
    ((PLANET *)lppl)->wFlags_0x4 =
         ((PLANET *)lppl)->wFlags_0x4 & 0xf7ff | ((uint)rgbCur._2_2_ >> 0xf) << 0xb;
  }
  lppl->id = (int)(rgbCur._0_2_ << 5) >> 5;
  ((PLANET *)lppl)->iPlayer = (int)rgbCur._0_2_ >> 0xb;
  if ((((PLANET *)lppl)->wFlags_0x4 & 0xff) < (rgbCur._2_2_ & 0x7f)) {
    ((PLANET *)lppl)->wFlags_0x4 =
         ((PLANET *)lppl)->wFlags_0x4 & 0xff00 | rgbCur._2_2_ & 0x7f;
  }
  ((PLANET *)lppl)->wFlags_0x4 =
       ((PLANET *)lppl)->wFlags_0x4 & 0xfeff | ((uint)rgbCur._2_2_ >> 8 & 1) << 8;
  ((PLANET *)lppl)->wFlags_0x4 =
       ((PLANET *)lppl)->wFlags_0x4 & 0xfdff | ((uint)rgbCur._2_2_ >> 9 & 1) << 9;
  ((PLANET *)lppl)->wFlags_0x4 =
       ((PLANET *)lppl)->wFlags_0x4 & 0xfbff | ((uint)rgbCur._2_2_ >> 7 & 1) << 10;
  uVar5 = (uint)rgbCur._2_2_ >> 0xe;
  if (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) && (((PLANET *)lppl)->iPlayer == -1)) {
    ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfdff;
  }
  if (fHistory == 0) {
    ((PLANET *)lppl)->turn = game.turn;
  }
  pb = (char *)rgbCur + 4;
  if (2 < (rgbCur._2_2_ & 0x7f)) {
    bMask = rgbCur[4];
    pb = (char *)rgbCur + 5;
    for (i = 0; i < 3; i = i + 1) {
      if ((bMask & 3) == 0) {
        ((PLANET *)lppl)->rgpctMinLevel[i] = 0;
      }
      else {
        if ((bMask & 3) != 1) {
          return 0;
        }
        ((PLANET *)lppl)->rgpctMinLevel[i] = *pb;
        pb = pb + 1;
      }
      bMask = (byte)((int)(uint)bMask >> 2);
    }
    for (i = 0; i < 3; i = i + 1) {
      ((PLANET *)lppl)->rgMinConc[i] = *pb;
      pb = pb + 1;
    }
    for (i = 0; i < 3; i = i + 1) {
      if (100 < *pb) {
        return 0;
      }
      bVar4 = *pb;
      ((PLANET *)lppl)->rgEnvVarOrig[i] = bVar4;
      ((PLANET *)lppl)->rgEnvVar[i] = bVar4;
      pb = pb + 1;
    }
    if (((uint)rgbCur._2_2_ >> 10 & 1) != 0) {
      for (i = 0; i < 3; i = i + 1) {
        if (100 < *pb) {
          return 0;
        }
        ((PLANET *)lppl)->rgEnvVarOrig[i] = *pb;
        pb = pb + 1;
      }
    }
    if ((int)rgbCur._0_2_ >> 0xb != -1) {
      ((PLANET *)lppl)->uGuesses = *(ushort *)pb;
      pb = pb + 2;
    }
    if (3 < (((PLANET *)lppl)->wFlags_0x4 & 0xff)) {
      if (((uint)rgbCur._2_2_ >> 0xd & 1) != 0) {
        bMask = *pb;
        pb = pb + 1;
        for (i = 0; i < 4; i = i + 1) {
          bVar4 = bMask & 3;
          if ((bMask & 3) == 0) {
            *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = 0;
            *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
          }
          else if (bVar4 == 1) {
            *(uint *)(((PLANET *)lppl)->rgwtMin + i) = (uint)*pb;
            *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
            pb = pb + 1;
          }
          else if (bVar4 == 2) {
            *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = *(undefined2 *)pb;
            *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
            pb = pb + 2;
          }
          else if (bVar4 == 3) {
            uVar2 = *(undefined2 *)(pb + 2);
            *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = *(undefined2 *)pb;
            *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = uVar2;
            pb = pb + 4;
          }
          bMask = (byte)((int)(uint)bMask >> 2);
        }
      }
      if (hdrCur.wFlags >> 10 != 0xe) {
        if (((uint)rgbCur._2_2_ >> 0xb & 1) == 0) {
          lVar8 = __aFlshl(lVar8,in_stack_0000ffea);
          uVar1 = *(uint *)(((PLANET *)lppl)->rgbImp + 6);
          *(uint *)(((PLANET *)lppl)->rgbImp + 4) =
               *(uint *)(((PLANET *)lppl)->rgbImp + 4) | (uint)lVar8;
          *(uint *)(((PLANET *)lppl)->rgbImp + 6) = uVar1 & 0xffbf | (uint)((ulong)lVar8 >> 0x10);
          uVar1 = *(uint *)(((PLANET *)lppl)->rgbImp + 6);
          *(uint *)(((PLANET *)lppl)->rgbImp + 4) =
               *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff | 0xf000;
          *(uint *)(((PLANET *)lppl)->rgbImp + 6) = uVar1 & 0xfffe | 1;
          uVar2 = *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6);
          *(uint *)(((PLANET *)lppl)->rgbImp + 4) = *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xf000
          ;
          *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6) = uVar2;
        }
        else {
          __fmemmove((byte *)CONCAT22(lppl._2_2_,((PLANET *)lppl)->rgbImp),pb,8);
          pb = pb + 8;
        }
        if (((PLANET *)lppl)->iPlayer != -1) {
          if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) {
            uVar2 = *(undefined2 *)(pb + 2);
            *(undefined2 *)&((PLANET *)lppl)->lStarbase = *(undefined2 *)pb;
            *(undefined2 *)((int)&((PLANET *)lppl)->lStarbase + 2) = uVar2;
            *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) =
                 *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0xbfff;
            pb = pb + 4;
          }
          if ((uVar5 & 1) != 0) {
            ((PLANET *)lppl)->wRouting = *(ushort *)pb;
          }
        }
        return 1;
      }
    }
  }
  if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) {
    *(uint *)&((PLANET *)lppl)->lStarbase =
         *(uint *)&((PLANET *)lppl)->lStarbase & 0xfff0 | *pb & 0xf;
    pb = pb + 1;
  }
  if (fHistory == 0) {
    if (bVar3) {
      if (((PLANET *)lppl)->iPlayer == -1) {
        if ((((PLANET *)lppl)->wFlags_0x4 & 0xff) < 2) {
          FSendPlrMsg2XGen(0,idmHaveFoundNewPlanetDontKnowIf,lppl->id,lppl->id,0);
        }
        else {
          sVar6 = GetRaceStat((PLAYER *)rgplr + iPlayer,rsMajorAdv);
          if (sVar6 == raTerra) {
            sVar6 = PctPlanetOptValue(lppl,iPlayer);
            FSendPlrMsg2XGen(0,idmHaveInfoNewPlanetIfColonizeCan,lppl->id,lppl->id,sVar6);
          }
          else {
            sVar6 = PctPlanetDesirability(lppl,iPlayer);
            if (sVar6 < 1) {
              sVar7 = PctPlanetOptValue(lppl,iPlayer);
              if (sVar7 < 1) {
                pct = sVar6 * 10;
                idm = 0xab;
              }
              else {
                sVar6 = PctTrueMaxGrowth(iPlayer);
                pct = sVar6 * sVar7;
                idm = 0xae;
              }
            }
            else {
              sVar7 = PctTrueMaxGrowth(iPlayer);
              pct = sVar7 * sVar6;
              idm = 0xac;
            }
            sVar6 = lppl->id;
            sVar7 = _abs(pct);
            FSendPlrMsg2XGen(0,idm,lppl->id,sVar7,sVar6);
          }
        }
      }
      else {
        FSendPlrMsg2XGen
                  (0,idmHaveFoundPlanetOccupiedSomeoneElseCurrently,lppl->id,lppl->id,
                   ((PLANET *)lppl)->iPlayer | 0x30);
      }
    }
  }
  else {
    ((PLANET *)lppl)->turn = *(short *)pb;
  }
  return 1;
}



// ======================================================================
// Function: FReadFleet
// Address: 1070:3a4c
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Variable defined which should be unmapped: cOut */

short FReadFleet(FLEET *lpfl)

{
  byte *pbVar1;
  ushort *puVar2;
  short *psVar3;
  ORDER *pOVar4;
  short sVar5;
  uint uVar6;
  char *sz;
  ushort uVar7;
  int iVar8;
  short *psVar9;
  ORDER *pOVar10;
  ORDER *pOVar11;
  undefined2 uVar12;
  short sVar13;
  undefined2 unaff_SS;
  PL *pPVar14;
  void *pvVar15;
  short cOut;
  ushort *pus;
  short cch;
  byte *pb;
  short cish;
  short i;
  ORDER *lpord;
  short fByte;
  short cord;
  ushort us;
  
  cish = 0;
  __fmemset(lpfl,0,0x7c);
  __fmemmove(lpfl,rgbCur,0xc);
  us._0_1_ = rgbCur[0xc];
  us._1_1_ = rgbCur[0xd];
  pb = (char *)rgbCur + 0xe;
  if ((((FLEET *)lpfl)->wFlags_0x4 >> 0xb & 1) == 0) {
    pus = (char *)rgbCur + 0xe;
    i = 0;
    for (; us != 0; us = us >> 1) {
      if ((us & 1) != 0) {
        puVar2 = pus + 1;
        ((FLEET *)lpfl)->rgcsh[i] = *pus;
        pus = puVar2;
        if (((FLEET *)lpfl)->rgcsh[i] != 0) {
          cish = cish + 1;
        }
      }
      i = i + 1;
    }
    pb = pus;
  }
  else {
    i = 0;
    for (; us != 0; us = us >> 1) {
      if ((us & 1) != 0) {
        pbVar1 = pb + 1;
        ((FLEET *)lpfl)->rgcsh[i] = (uint)*pb;
        pb = pbVar1;
        if (((FLEET *)lpfl)->rgcsh[i] != 0) {
          cish = cish + 1;
        }
      }
      i = i + 1;
    }
  }
  if (cish == 0) {
    ((FLEET *)lpfl)->wFlags_0x4 = ((FLEET *)lpfl)->wFlags_0x4 & 0xfbff | 0x400;
  }
  if (3 < (((FLEET *)lpfl)->wFlags_0x4 & 0xff)) {
    us = *(ushort *)pb;
    pb = pb + 2;
    for (i = 0; i < 5; i = i + 1) {
      uVar6 = us & 3;
      if (uVar6 == 1) {
        *(uint *)(((FLEET *)lpfl)->rgwtMin + i) = (uint)*pb;
        *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = 0;
        pb = pb + 1;
      }
      else if (uVar6 == 2) {
        *(undefined2 *)(((FLEET *)lpfl)->rgwtMin + i) = *(undefined2 *)pb;
        *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = 0;
        pb = pb + 2;
      }
      else if (uVar6 == 3) {
        uVar12 = *(undefined2 *)(pb + 2);
        *(undefined2 *)(((FLEET *)lpfl)->rgwtMin + i) = *(undefined2 *)pb;
        *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = uVar12;
        pb = pb + 4;
      }
      us = us >> 2;
    }
  }
  if ((((FLEET *)lpfl)->wFlags_0x4 & 0xff) < 7) {
    uVar12 = *(undefined2 *)(pb + 2);
    *(undefined2 *)&((FLEET *)lpfl)->dirLong = *(undefined2 *)pb;
    *(undefined2 *)((int)&((FLEET *)lpfl)->dirLong + 2) = uVar12;
    uVar12 = *(undefined2 *)(pb + 6);
    *&((FLEET *)lpfl)->u_FLEET_0x002c = *(undefined2 *)(pb + 4);
    *(undefined2 *)((int)&((FLEET *)lpfl)->u_FLEET_0x002c + 2) = uVar12;
    ReadRt();
    return 1;
  }
  if (hdrCur.wFlags >> 10 == 0x10) {
    us = *(ushort *)pb;
    pus = pb + 2;
    i = 0;
    for (; us != 0; us = us >> 1) {
      if ((us & 1) != 0) {
        puVar2 = pus + 1;
        ((FLEET *)lpfl)->rgcsh[i + 0x10] = *pus;
        pus = puVar2;
        if (499 < (uint)((FLEET *)lpfl)->rgcsh[i + 0x10] >> 7) {
          ((FLEET *)lpfl)->rgcsh[i + 0x10] = ((FLEET *)lpfl)->rgcsh[i + 0x10] & 0x7fU | 0xf980;
        }
      }
      i = i + 1;
    }
    ((FLEET *)lpfl)->iplan = (byte)*pus;
    ((FLEET *)lpfl)->cord = (uint)*(byte *)((int)pus + 1);
    pPVar14 = LpplAlloc(0x12,((FLEET *)lpfl)->cord + 1,htOrd);
    *(PL **)&((FLEET *)lpfl)->lpplord = (PL *)pPVar14;
    *(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2) = (int)((ulong)pPVar14 >> 0x10);
    cOut = (((FLEET *)lpfl)->cord + 1) * 0x12;
    sVar13 = 0x1118;
    __fmemset((void *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2),
                                       (void *)(*(int *)&((FLEET *)lpfl)->lpplord + 4)),0,cOut);
    cord = ((FLEET *)lpfl)->cord;
    lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2),
                              (ORDER *)(*(int *)&((FLEET *)lpfl)->lpplord + 4));
    for (; cord != 0; cord = cord + -1) {
      cOut = 0x12;
      _memset((char *)rgbCur,0,0x12);
      cOut = 0x1118;
      sVar13 = 0x1070;
      ReadRt();
      if ((hdrCur.wFlags >> 10 != 0x13) && (hdrCur.wFlags >> 10 != 0x14))
      goto IO_Corrupt;
      psVar9 = (short *)rgbCur;
      uVar12 = (undefined2)((ulong)lpord >> 0x10);
      pOVar10 = (ORDER *)lpord;
      pOVar11 = pOVar10;
      for (iVar8 = 9; iVar8 != 0; iVar8 = iVar8 + -1) {
        pOVar4 = pOVar11;
        pOVar11 = &(pOVar11->pt).y;
        psVar3 = psVar9;
        psVar9 = psVar9 + 1;
        (pOVar4->pt).x = *psVar3;
      }
      pOVar10->wFlags_0x6 = pOVar10->wFlags_0x6 & 0xdfff;
      lpord = (ORDER *)CONCAT22(uVar12,pOVar10 + 1);
    }
    ((PLORD *)((FLEET *)lpfl)->lpplord)->iordMac = (byte)((FLEET *)lpfl)->cord;
    if (((FLEET *)lpfl)->idPlanet != -1) {
      if (game.cPlanMax < ((FLEET *)lpfl)->idPlanet) {
        ((FLEET *)lpfl)->idPlanet = -1;
      }
      if (((&((FLEET *)lpfl)->pt)->x != ((POINT *)rgptPlan + ((FLEET *)lpfl)->idPlanet)->x
          ) || ((((FLEET *)lpfl)->pt).y !=
                *(int *)((int)&rgptPlan[0].y + ((FLEET *)lpfl)->idPlanet * 4))) {
        if ((i != 0) || (game.turn != 0)) goto IO_Corrupt;
        sVar5 = *(short *)((int)&rgptPlan[0].y + ((FLEET *)lpfl)->idPlanet * 4);
        (&((FLEET *)lpfl)->pt)->x = ((POINT *)rgptPlan + ((FLEET *)lpfl)->idPlanet)->x;
        (((FLEET *)lpfl)->pt).y = sVar5;
      }
    }
    cOut = sVar13;
    ReadRt();
    if (hdrCur.wFlags >> 10 == 0x15) {
      if (rgbCur[0] == 0) {
        cOut = 1;
        uVar7 = _strlen((char *)rgbCur + 1);
        pvVar15 = LpAlloc(uVar7 + 1,cOut);
        *(void **)&((FLEET *)lpfl)->lpszName = (void *)pvVar15;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = (int)((ulong)pvVar15 >> 0x10);
        cOut = *(short *)((int)&((FLEET *)lpfl)->lpszName + 2);
                    /* WARNING: Load size is inaccurate */
        __fstrcpy((char *)CONCAT22(cOut,((FLEET *)lpfl)->lpszName),rgbCur + 1);
      }
      else {
        cOut = (short)&cOut;
        FDecompressUserString
                  (rgbCur + 1,(int)rgbCur[0],(char *)&stack0xffc6,(short *)cOut)
        ;
        cOut = 1;
        uVar7 = _strlen(&stack0xffc6);
        pvVar15 = LpAlloc(uVar7 + 1,cOut);
        *(void **)&((FLEET *)lpfl)->lpszName = (void *)pvVar15;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = (int)((ulong)pvVar15 >> 0x10);
        cOut = *(short *)((int)&((FLEET *)lpfl)->lpszName + 2);
                    /* WARNING: Load size is inaccurate */
        __fstrcpy((char *)CONCAT22(cOut,((FLEET *)lpfl)->lpszName),(char *)&stack0xffc6);
      }
      ReadRt();
    }
    else {
      *(undefined2 *)&((FLEET *)lpfl)->lpszName = 0;
      *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = 0;
    }
    sVar13 = 1;
  }
  else {
IO_Corrupt:
    cOut = 0x10;
    sz = PszFormatIds(idsGameFileAppearsCorruptUnableLoadFile,(short *)0x0);
    AlertSz(sz,cOut);
    sVar13 = 0;
  }
  return sVar13;
}



// ======================================================================
// Function: UnpackBattlePlan
// Address: 1070:40ce
// Segment: MEMORY_IO
// ======================================================================


void UnpackBattlePlan(byte *lpb,BTLPLAN *lpbtlplan,short iplan)

{
  byte *pbVar1;
  undefined2 unaff_SS;
  short cOut;
  short cch;
  char szName [34];
  char szTemp [36];
  
  pbVar1 = (byte *)lpb;
  __fmemmove(lpbtlplan,lpb,4);
  lpb = (byte *)lpb + 4;
  cch = (short)*lpb;
  if (cch == 0) {
    __fstrcpy((char *)CONCAT22(lpbtlplan._2_2_,((BTLPLAN *)lpbtlplan)->szName),
                      (char *)CONCAT22(lpb._2_2_,pbVar1 + 5));
  }
  else {
    cOut = 0x20;
    __fmemmove(szTemp,(byte *)CONCAT22(lpb._2_2_,pbVar1 + 5),0x20);
    FDecompressUserString(szTemp,cch,szName,&cOut);
    __fmemmove((byte *)CONCAT22(lpbtlplan._2_2_,((BTLPLAN *)lpbtlplan)->szName),szName,cOut)
    ;
  }
  lpbtlplan->wFlags = lpbtlplan->wFlags & 0xff0f | (iplan & 0xfU) << 4;
  return;
}



// ======================================================================
// Function: UpdateBattleRecords
// Address: 1070:41ac
// Segment: MEMORY_IO
// ======================================================================


void UpdateBattleRecords(void)

{
  byte bVar1;
  HB *pHVar2;
  int iVar3;
  BTLREC26 *pBVar4;
  BTLDATA *pBVar5;
  undefined2 uVar6;
  undefined2 uVar7;
  short itok;
  BTLREC26 *lpbr26;
  HB *lphb;
  short cKill;
  BTLREC *lpbr;
  BTLDATA *lpbd;
  
  lphb = (HB *)CONCAT22(iRam11200d62,pHRam11200d60);
  if ((pHRam11200d60 != (HB *)0x0) || (iRam11200d62 != 0)) {
    lpbd = (BTLDATA *)CONCAT22(iRam11200d62,&pHRam11200d60[1].cbBlock);
    while( true ) {
      while (lpbd->id == 0xffff) {
        uVar6 = (undefined2)((ulong)lphb >> 0x10);
                    /* WARNING: Load size is inaccurate */
        pHVar2 = ((HB *)lphb)->lphbNext;
        iVar3 = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
        lphb = (HB *)CONCAT22(iVar3,pHVar2);
        if ((pHVar2 == (HB *)0x0) && (iVar3 == 0)) {
          return;
        }
        if (pHVar2->ibTop < 0x11) {
          return;
        }
        lpbd = (BTLDATA *)CONCAT22(iVar3,&pHVar2[1].cbBlock);
      }
      uVar6 = (undefined2)((ulong)lpbd >> 0x10);
      pBVar5 = (BTLDATA *)lpbd;
      if (pBVar5->cbData == 0) break;
      pBVar4 = (BTLREC26 *)((int)pBVar5 + (uint)pBVar5->ctok * 0x1d + 0xe);
      lpbr = (BTLREC *)CONCAT22(uVar6,pBVar4);
      lpbr26 = (BTLREC26 *)CONCAT22(uVar6,pBVar4);
      pBVar5 = (BTLDATA *)((int)&pBVar5->id + pBVar5->cbData);
      lpbd = (BTLDATA *)CONCAT22(uVar6,pBVar5);
      while ((BTLREC *)lpbr < pBVar5) {
        uVar6 = (undefined2)((ulong)lpbr26 >> 0x10);
        bVar1 = ((BTLREC26 *)lpbr26)->itokAttack;
        uVar7 = (undefined2)((ulong)lpbr >> 0x10);
        ((BTLREC *)lpbr)->ctok = (uint)((BTLREC26 *)lpbr26)->ctok;
        ((BTLREC *)lpbr)->wFlags_0x4 = ((BTLREC *)lpbr)->wFlags_0x4 & 0xff | (uint)bVar1 << 8;
        pBVar4 = (BTLREC26 *)((int)(BTLREC *)lpbr + ((BTLREC *)lpbr)->ctok * 8 + 6);
        lpbr26 = (BTLREC26 *)CONCAT22(uVar7,pBVar4);
        lpbr = (BTLREC *)CONCAT22(uVar7,pBVar4);
      }
    }
  }
  return;
}



// ======================================================================
// Function: AskSaveDialog
// Address: 1070:432a
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short AskSaveDialog(HWND hwnd,ushort message,ushort wParam,long lParam)

{
  short sVar1;
  
  if (message != 2) {
    if (message == 0x110) {
      return 1;
    }
    if (message == 0x111) {
      if (((wParam == 0x429) || (wParam == 0x42b)) || (wParam == 0x42a)) {
        if (wParam == 0x42b) {
          sVar1 = 0;
        }
        else if (wParam == 0x42a) {
          sVar1 = -1;
        }
        else {
          sVar1 = 1;
        }
        EndDialog(hwnd,sVar1);
        return 1;
      }
      if (wParam == 0x76) {
        WinHelp(hwnd,_szHelpFile,1,0x442);
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: PromptSaveGame
// Address: 1070:43ee
// Segment: MEMORY_IO
// ======================================================================


void PromptSaveGame(void)

{
  undefined2 uVar1;
  short sVar2;
  FARPROC pvVar3;
  short fRet;
  
  pvVar3 = MakeProcInstance(AskSaveDialog,hInst);
  if ((game.wCrap >> 2 & 1) == 0) {
    uVar1 = 0x42c;
  }
  else {
    uVar1 = 0x7e9;
  }
  sVar2 = DialogBox(0,(LPCSTR)CONCAT22(uVar1,hwndFrame),(HWND)((ulong)pvVar3 >> 0x10),
                    (char)pvVar3);
  FreeProcInstance(pvVar3);
  if (sVar2 != 0) {
    gd.grBits._0_2_ = (uint)gd.grBits & 0xffef | (uint)(sVar2 == -1) << 4;
    FWriteLogFile((char *)szBase,idPlayer);
    FWriteHistFile(idPlayer);
  }
  return;
}



// ======================================================================
// Function: DestroyCurGame
// Address: 1070:44b0
// Segment: MEMORY_IO
// ======================================================================


void DestroyCurGame(void)

{
  short i;
  
  if (((uint)gd.grBits >> 8 & 1) != 0) {
    FFinishPlrMsgEntry(0);
  }
  if ((idPlayer != -1) && (game.fDirty != 0)) {
    PromptSaveGame();
  }
  ResetHb(htPlanets);
  lpPlanets._0_2_ = (PLANET *)0x0;
  lpPlanets._2_2_ = 0;
  cPlanet = 0;
  ResetHb(htFleets);
  rglpfl._0_2_ = (FLEET **)0x0;
  rglpfl._2_2_ = 0;
  cFleet = 0;
  ResetHb(htThings);
  lpThings._0_2_ = (THING *)0x0;
  lpThings._2_2_ = 0;
  cThing = 0;
  cThingAlloc = 0;
  vlprgScoreX._0_2_ = (SCOREX *)0x0;
  vlprgScoreX._2_2_ = 0;
  vrptFleet.fCached = 0;
  vrptPlanet.fCached = 0;
  vrptBattle.fCached = 0;
  vrptEFleet.fCached = 0;
  for (i = 0; i < 0x10; i = i + 1) {
    ((SCOREX **)rgsxPlr)[i * 2] = (SCOREX *)0x0;
    *(undefined2 *)(i * 4 + 0x156e) = 0;
  }
  lpbBattleT._0_2_ = (byte *)0x0;
  lpbBattleT._2_2_ = 0;
  lpbBattleLog._0_2_ = (byte *)0x0;
  lpbBattleLog._2_2_ = 0;
  lpbBattleCur._0_2_ = (byte *)0x0;
  lpbBattleCur._2_2_ = 0;
  gd.grBits._0_2_ = (uint)gd.grBits & 0xebff;
  gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfbff;
  ResetHb(htBattle);
  if (((int)uRam11200d60 != 0) || (uRam11200d60._2_2_ != 0)) {
    *(undefined2 *)((int)uRam11200d60 + 0x12) = 0xffff;
  }
  ResetHb(htMisc);
  ResetHb(htString);
  ResetHb(htShips);
  ResetHb(htOrd);
  ResetHb(htPlrMsg);
  for (i = 0; i < 0x10; i = i + 1) {
    *(undefined2 *)(i * 4 + rglpshdef) = 0;
    *(undefined2 *)(i * 4 + 0x100) = 0;
    *(undefined2 *)(i * 4 + rglpshdefSB) = 0;
    *(undefined2 *)(i * 4 + 0x14e) = 0;
    ((BTLPLAN **)rglpbtlplan)[i * 2] = (BTLPLAN *)0x0;
    *(undefined2 *)(i * 4 + 0x593a) = 0;
    ((byte *)rgcbtlplan)[i] = 0;
  }
  if (sel.grobj != grobjNone) {
    ini.wFlags =
         ini.wFlags & 0xfe1f |
         (sel.grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 5;
    ini.iObjSel = sel.id;
    ini.idPlayer = idPlayer;
    ini.lid._0_2_ = (undefined2)game.lid;
    ini.lid._2_2_ = game.lid._2_2_;
  }
  idPlayer = -1;
  imemLogCur = 0;
  imemLogPrev = -1;
  iMsgCur = 0;
  vlpbAiData._0_2_ = (byte *)0x0;
  vlpbAiData._2_2_ = 0;
  ResetMessages();
  lSaltCur._0_2_ = 0;
  lSaltCur._2_2_ = 0;
  ctickLast._0_2_ = 0;
  ctickLast._2_2_ = 0;
  game.lid._0_2_ = 0;
  game.lid._2_2_ = 0;
  game.cPlayer = 0;
  game.cPlanMax = 0;
  game.fDirty = 0;
  game.turn = 0;
  game.szName[0] = '\0';
  gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffe;
  gd.grBits._0_2_ = (uint)gd.grBits & 0xfeff;
  if (hwndBrowser != 0) {
    DestroyWindow(hwndBrowser);
  }
  if (hwndReportDlg != 0) {
    DestroyWindow(hwndReportDlg);
  }
  if (hwndPopup != 0) {
    DestroyWindow(hwndPopup);
    hwndPopup = 0;
  }
  hwndActive = 0;
  sel.scan.grobjFull = grobjNone;
  sel.scan.grobj = grobjNone;
  sel.scan.iwp = -1;
  sel.scan.ifl = -1;
  sel.scan.idpl = -1;
  fOrdersVis = 0;
  sel.grobjFull = grobjNone;
  sel.grobj = grobjNone;
  sel.id = -1;
  sel.pt.y = 0;
  sel.pt.x = 0;
  sel.pl.id = -1;
  sel.fl.id = -1;
  sel.fl.lpplord._0_2_ = (PLORD *)0x0;
  sel.fl.lpplord._2_2_ = 0;
  sel.pl.lpplprod._0_2_ = (PLPROD *)0x0;
  sel.pl.lpplprod._2_2_ = 0;
  dxPlanetProdLB = 0;
  dxOrderED = 0;
  dxFleetCompLB = 0;
  dxShipLB = 0;
  dxShipDD = 0;
  for (i = 0; i < 3; i = i + 1) {
    *(undefined2 *)(i * 2 + rgdxOrderDD) = 0;
  }
  return;
}



// ======================================================================
// Function: FBogusLong
// Address: 1070:484c
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10704887) */

short FBogusLong(ulong lSerial)

{
  int local_6;
  
  local_6 = 0;
  while (CONCAT22(*(undefined2 *)(local_6 * 4 + bogi_0x2),*(undefined2 *)(local_6 * 4 + bogi)) <
         (lSerial ^ 0xa5a5a5a5)) {
    local_6 = local_6 + 1;
  }
  return (uint)((lSerial ^ 0xa5a5a5a5) ==
               CONCAT22(*(undefined2 *)(local_6 * 4 + bogi_0x2),*(undefined2 *)(local_6 * 4 + bogi))
               );
}



// ======================================================================
// Function: FValidSerialLong
// Address: 1070:48c4
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10704975) */
/* WARNING: Removing unreachable block (ram,0x10704994) */

short FValidSerialLong(ulong lSerial)

{
  short sVar1;
  ulong uVar2;
  ulong uVar3;
  short i;
  
  sVar1 = FBogusLong(lSerial);
  if (sVar1 == 0) {
    uVar2 = lSerial;
    for (i = 0; i < 4; i = i + 1) {
      uVar2 = __aFuldiv(uVar2,0x24);
    }
    uVar3 = uVar2;
    for (i = 0; i < 4; i = i + 1) {
      uVar3 = __aFulmul(uVar3,0x24);
    }
    uVar3 = lSerial - uVar3;
    if ((((int)(uVar3 >> 0x10) == 0) && ((uint)uVar3 < 100)) || (1500000 < uVar3)) {
      sVar1 = 0;
    }
    else if (((uVar2 == 0x12) || (uVar2 == 0x16)) ||
            ((uVar2 == 2 || ((uVar2 == 4 || (uVar2 == 6)))))) {
      sVar1 = 1;
    }
    else {
      sVar1 = 0;
    }
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: FileError
// Address: 1070:4a10
// Segment: MEMORY_IO
// ======================================================================


void FileError(StringId ids)

{
  char *sz;
  short mbType;
  
  idsFileError = ids;
  if ((fFileErrSilent == 0) && (((uint)gd.grBits >> 1 & 1) == 0)) {
    mbType = 0x10;
    sz = PszFormatIds(ids,(short *)0x0);
    AlertSz(sz,mbType);
  }
  return;
}



// ======================================================================
// Function: GetFileStatus
// Address: 1070:4a60
// Segment: MEMORY_IO
// ======================================================================


void GetFileStatus(short dt,short iPlayer)

{
  short sVar1;
  
  SetSzWorkFromDt(dt,iPlayer);
  sVar1 = __access((char *)szWork,2);
  gd.grBits._2_2_ = gd.grBits._2_2_ & 0xffdf | (uint)(sVar1 != 0) << 5;
  return;
}



// ======================================================================
// Function: FOpenFile
// Address: 1070:4ac2
// Segment: MEMORY_IO
// ======================================================================


short FOpenFile(DtFileType dt,short iPlayer,short md)

{
  DtFileType dt_00;
  char *pcVar1;
  undefined2 *puVar2;
  short (*pasVar3) [9];
  short sVar4;
  StringId ids_00;
  short sVar5;
  int iVar6;
  char *pcVar7;
  undefined2 *puVar8;
  undefined2 unaff_SS;
  char *mbType;
  short (*penvMemSav) [9];
  short fSilentSav;
  short fRewind;
  short fCheckMulti;
  short ids;
  undefined2 rtbof [2];
  int local_10;
  int local_e;
  ushort local_c;
  ushort local_a;
  int local_8;
  uint local_6;
  
  sVar5 = fFileErrSilent;
  gd.grBits._2_2_ = gd.grBits._2_2_ & 0xff7f;
  dt_00 = dt & 0xff;
  SetSzWorkFromDt(dt_00,iPlayer);
  pasVar3 = penvMem;
  penvMem = &stack0xffd0;
  sVar4 = __setjmp(&stack0xffd0);
  if (sVar4 != 0) {
    fFileErrSilent = sVar5;
    FileError(idsCantOpenFile);
    StreamClose();
    penvMem = pasVar3;
    return 0;
  }
  fFileErrSilent = 1;
  StreamOpen((char *)szWork,md);
  fFileErrSilent = sVar5;
  ReadRt();
  if ((((hdrCur.wFlags >> 10 == 8) && ((uint)rgbCur._8_2_ >> 0xc == 2)) &&
      (0x30 < ((uint)rgbCur._8_2_ >> 5 & 0x7f))) &&
     (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x54)) {
    pcVar7 = (char *)rgbCur;
    puVar8 = rtbof;
    for (iVar6 = 8; iVar6 != 0; iVar6 = iVar6 + -1) {
      puVar2 = puVar8;
      puVar8 = puVar8 + 1;
      pcVar1 = pcVar7;
      pcVar7 = pcVar7 + 2;
      *puVar2 = *pcVar1;
    }
    if ((local_8 << 0xb) >> 0xb == iPlayer) {
      if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) goto LAB_1070_4ebd;
      if ((local_10 == (int)game.lid) && (local_e == game.lid._2_2_)) {
        if (dt_00 == dtHist) {
          if ((local_8 << 0xb) >> 0xb == iPlayer) goto LAB_1070_4ebd;
        }
        else {
          if (((dt & 0x2000) != dtXY) && ((local_6 >> 10 & 1) != 0)) {
            __lseek(hf,-4,2);
            ReadRt();
            if ((hdrCur.wFlags >> 10 != 0) && ((hdrCur.wFlags & 0x3ff) != 2))
            goto IO_LBadFile_2;
            local_a._0_1_ = rgbCur[0];
            local_a._1_1_ = rgbCur[1];
            game.wCrap = game.wCrap & 0xf1ff | (local_6 >> 0xd) << 9;
          }
          if ((game.turn == 0) && (local_a != 0)) {
            game.turn = local_a;
            game.wCrap = game.wCrap & 0xf1ff | (local_6 >> 0xd) << 9;
LAB_1070_4ebd:
            if ((dt & 0x1000) != dtXY) {
              __lseek(hf,0,0);
              ReadRt();
            }
            penvMem = pasVar3;
            wVersFile = local_c;
            gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffb | (local_6 >> 0xc & 1) << 2;
            return 1;
          }
          if (local_a == game.turn) {
            if (((dt_00 == dtHost) && (((uint)gd.grBits >> 3 & 1) == 0)) &&
               ((local_6 >> 9 & 1) != 0)) {
              mbType = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
              pcVar7 = PszFormatIds(idsHostFileMarkedUseAnotherInstanceStars,(short *)0x0);
              sVar5 = AlertSz(pcVar7,(short)mbType);
              if (sVar5 == 6) goto LAB_1070_4ebd;
            }
            else if ((((local_6 >> 8 & 1) == 0) && (((uint)gd.grBits >> 1 & 1) != 0)) &&
                    (((uint)gd.grBits >> 2 & 1) == 0)) {
              gd.grBits._2_2_ = gd.grBits._2_2_ & 0xff7f | 0x80;
            }
            else {
              if (((dt_00 != dtLog) || ((game.wCrap >> 3 & 1) != 0)) ||
                 (local_6 >> 0xd == (game.wCrap >> 9 & 7))) goto LAB_1070_4ebd;
              FileError(idsFileGame);
            }
          }
          else {
            FileError(idsFileDate);
          }
        }
      }
      else {
        FileError(idsFileGame);
      }
    }
    else {
      FileError(idsGameFileAppearsCorruptUnableLoadFile);
    }
  }
  else if (hdrCur.wFlags >> 10 == 8) {
    if (((uint)rgbCur._8_2_ >> 0xc < 3) &&
       (((uint)rgbCur._8_2_ >> 0xc != 2 ||
        (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x55)))) {
      ids_00 = idsSorryFileCreatedOlderVersionStarsIncompatible;
    }
    else {
      ids_00 = idsFileCreatedNewerVersionStarsMustUpgrade;
    }
    FileError(ids_00);
  }
  else {
    FileError(idsFileDoesBelongVersionStars);
  }
IO_LBadFile_2:
  StreamClose();
  penvMem = pasVar3;
  return 0;
}



// ======================================================================
// Function: FNewTurnAvail
// Address: 1070:4f22
// Segment: MEMORY_IO
// ======================================================================


short FNewTurnAvail(short idPlayer)

{
  ushort uVar1;
  uint uVar2;
  short sVar3;
  short fNew;
  ushort turnOld;
  ushort wGenOld;
  
  uVar1 = game.turn;
  uVar2 = game.wCrap >> 9;
  fFileErrSilent = 1;
  game.turn = 0;
  sVar3 = FOpenFile(0x2003,idPlayer,0x20);
  if (sVar3 == 0) {
    fNew = 0;
  }
  else {
    StreamClose();
    fNew = (short)(uVar1 < game.turn);
  }
  game.turn = uVar1;
  game.wCrap = game.wCrap & 0xf1ff | (uVar2 & 7) << 9;
  return fNew;
}



// ======================================================================
// Function: FCheckFile
// Address: 1070:4fb2
// Segment: MEMORY_IO
// ======================================================================


short FCheckFile(DtFileType dt,short iPlayer,ushort md)

{
  short sVar1;
  uint uVar2;
  short sVar3;
  short fErrSav;
  short f;
  ushort wGenOld;
  short fOpened;
  short fReturn;
  
  sVar1 = fFileErrSilent;
  uVar2 = game.wCrap >> 9;
  if (dt == dtHost) {
    f = (uint)gd.grBits >> 3 & 1;
    gd.grBits._0_2_ = (uint)gd.grBits & 0xfff7 | 8;
  }
  fFileErrSilent = 1;
  sVar3 = FOpenFile(dt,iPlayer,0x20);
  if (md == 1) {
    if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 9 & 1) != 0)) {
      fReturn = 1;
    }
    else {
      fReturn = 0;
    }
  }
  else if (md == 2) {
    if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 8 & 1) == 0)) {
      fReturn = 0;
    }
    else {
      fReturn = 1;
    }
  }
  else if (md == 4) {
    if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 10 & 1) == 0)) {
      fReturn = 0;
    }
    else {
      fReturn = 1;
    }
  }
  else if (md == 8) {
    if (sVar3 == 0) {
      fReturn = 0;
    }
    else {
      do {
        ReadRt();
        if (hdrCur.wFlags >> 10 == 6) break;
      } while (rgbCur[0] != iPlayer);
      fReturn = (uint)rgbCur._6_2_ >> 9 & 1;
    }
  }
  if (sVar3 != 0) {
    StreamClose();
  }
  if (dt == dtHost) {
    gd.grBits._0_2_ = (uint)gd.grBits & 0xfff7 | (f & 1U) << 3;
  }
  fFileErrSilent = sVar1;
  game.wCrap = game.wCrap & 0xf1ff | (uVar2 & 7) << 9;
  return fReturn;
}



// ======================================================================
// Function: ReadRt
// Address: 1070:5168
// Segment: MEMORY_IO
// ======================================================================


void ReadRt(void)

{
  RgFromStream(&hdrCur,2);
  if ((hdrCur.wFlags & 0x3ff) != 0) {
    RgFromStream(rgbCur,hdrCur.wFlags & 0x3ff);
  }
  if (hdrCur.wFlags >> 10 == 8) {
    SetFileXorStream
              (CONCAT22(rgbCur._6_2_,rgbCur._4_2_),
               (int)rgbCur._12_2_ >> 5,rgbCur._10_2_,
               (int)(rgbCur._12_2_ << 0xb) >> 0xb,(uint)rgbCur._14_2_ >> 0xc & 1
              );
  }
  else if (hdrCur.wFlags >> 10 != 0) {
    XorFileBuf((char *)rgbCur,hdrCur.wFlags & 0x3ff);
  }
  return;
}



// ======================================================================
// Function: FBadFileError
// Address: 1070:524e
// Segment: MEMORY_IO
// ======================================================================


short FBadFileError(StringId ids)

{
  short sVar1;
  
  if ((((ids == idsUniverseDefinitionFileSeemsMissingCorrupt) ||
       (ids == idsPlayerLogFileAppearsCorruptUnableLoad)) ||
      (ids == idsHistoryFileAppearsCorruptHistoricalDataWill)) ||
     (((ids == idsGameFileAppearsCorruptUnableLoadFile || (ids == idsErrorWritingFile)) ||
      ((ids == idsFileDate || (ids == idsFileGame)))))) {
    sVar1 = 1;
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: StreamOpen
// Address: 1070:52ae
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1070536a) */
/* WARNING: Removing unreachable block (ram,0x10705391) */

void StreamOpen(char *szFile,short mdOpen)

{
  undefined2 unaff_SS;
  DWORD DVar1;
  DWORD DVar2;
  short fNoErr;
  OFSTRUCT of;
  ulong dwTick;
  
  dwTick = 0;
  while( true ) {
    hf = OpenFile(szFile,&of,mdOpen & 0xbfff);
    if (hf != 0xffff) {
      return;
    }
    if ((((uint)gd.grBits >> 9 & 1) == 0) || (of.nErrCode == 2)) break;
    DVar1 = GetTickCount();
    if (dwTick == 0) {
      dwTick = DVar1 + 4000;
    }
    if (dwTick <= DVar1) break;
    do {
      DVar2 = GetTickCount();
    } while (DVar2 < DVar1 + 500);
  }
  if ((mdOpen & 0x4000U) == 0) {
    FileError(idsCantOpenFile);
  }
  _longjmp(penvMem,-1);
  return;
}



// ======================================================================
// Function: StreamClose
// Address: 1070:53cc
// Segment: MEMORY_IO
// ======================================================================


void StreamClose(void)

{
  if (hf != -1) {
    _lclose(hf);
    hf = -1;
  }
  return;
}



// ======================================================================
// Function: RgFromStream
// Address: 1070:53f4
// Segment: MEMORY_IO
// ======================================================================


void RgFromStream(void *rg,ushort cb)

{
  ushort uVar1;
  
  if (cb != 0) {
    if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
      uVar1 = _lread(cb,rg,hf);
      if (uVar1 != cb) {
        FileError(idsGameFileAppearsCorruptUnableLoadFile);
        _longjmp(penvMem,-1);
      }
    }
    else {
      __fmemcpy(rg,(byte *)CONCAT22(vlpMemStream._2_2_,(byte *)vlpMemStream),
                        cb);
      vlpMemStream._0_2_ = (byte *)vlpMemStream + cb;
    }
  }
  return;
}



// ======================================================================
// Function: WriteOrders
// Address: 1070:547e
// Segment: MEMORY_IO
// ======================================================================


void WriteOrders(FLEET *lpfl)

{
  FLEET *pFVar1;
  undefined2 uVar2;
  ORDER *lpord;
  short cord;
  
  uVar2 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar1 = (FLEET *)lpfl;
  if (pFVar1->cord != 0) {
    cord = pFVar1->cord;
    lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar1->lpplord + 2),
                              (ORDER *)(*(int *)&pFVar1->lpplord + 4));
    for (; cord != 0; cord = cord + -1) {
      uVar2 = (undefined2)((ulong)lpord >> 0x10);
      if ((((ORDER *)lpord)->wFlags_0x6 & 0xf) == 0) {
        WriteRt(0x14,8,lpord);
      }
      else {
        WriteRt(0x13,0x12,lpord);
      }
      lpord = (ORDER *)CONCAT22(uVar2,(ORDER *)lpord + 1);
    }
  }
  return;
}



// ======================================================================
// Function: WriteRtPlr
// Address: 1070:551c
// Segment: MEMORY_IO
// ======================================================================


void WriteRtPlr(PLAYER *pplr,byte *pbStore)

{
  ushort uVar1;
  short sVar2;
  short cOut;
  byte *pb;
  short i;
  byte rgb [266];
  
  if (pbStore == (byte *)0x0) {
    pbStore = rgb;
  }
  if ((pplr->wFlags & 1) != 0) {
    pplr->wMdPlr = pplr->wMdPlr & 0xfff8 | 7;
  }
  _memmove(pbStore,pplr,0xc0);
  if ((pplr->wMdPlr & 7) == 7) {
    for (i = 0xf; (-1 < i && (pplr->rgmdRelation[i] == '\0')); i = i + -1) {
    }
    i = i + 1;
    pb = pbStore + 0x71;
    pbStore[0x70] = (byte)i;
    _memmove(pb,pplr->rgmdRelation,i);
    pb = pb + i;
  }
  else {
    pb = pbStore + 8;
  }
  cOut = 0x1f;
  if ((pplr->szName[0] == '\0') ||
     (sVar2 = FCompressUserString(pplr->szName,(char *)(pb + 1),&cOut), sVar2 == 0)) {
    _strcpy(pb + 1,pplr->szName);
    *pb = 0;
    uVar1 = _strlen(pplr->szName);
    pb = pb + uVar1 + 2;
  }
  else {
    *pb = (byte)cOut;
    pb = pb + cOut + 1;
  }
  cOut = 0x1f;
  if ((pplr->szNames[0] == '\0') ||
     (sVar2 = FCompressUserString(pplr->szNames,(char *)(pb + 1),&cOut), sVar2 == 0)) {
    _strcpy(pb + 1,pplr->szNames);
    *pb = 0;
    uVar1 = _strlen(pplr->szNames);
    pb = pb + uVar1 + 2;
  }
  else {
    *pb = (byte)cOut;
    pb = pb + cOut + 1;
  }
  WriteRt(6,(int)pb - (int)pbStore,pbStore);
  return;
}



// ======================================================================
// Function: WriteRtShDef
// Address: 1070:574e
// Segment: MEMORY_IO
// ======================================================================


void WriteRtShDef(SHDEF *lpshdef,byte **ppbStore)

{
  short sVar1;
  ushort uVar2;
  SHDEF *pSVar3;
  undefined2 uVar4;
  undefined2 unaff_SS;
  HULDEF *pHVar5;
  short cOut;
  byte *pb;
  char szHulName [32];
  ushort rgb;
  undefined1 local_96;
  undefined1 local_95;
  ushort local_94;
  byte local_92;
  ushort local_91;
  undefined2 local_8f;
  undefined2 local_8d;
  undefined2 local_8b;
  undefined2 local_89;
  byte local_87 [133];
  
  local_96 = (undefined1)(lpshdef->hul).ihuldef;
  uVar4 = (undefined2)((ulong)lpshdef >> 0x10);
  pSVar3 = (SHDEF *)lpshdef;
  rgb = pSVar3->wFlags;
  local_92 = (pSVar3->hul).chs;
  local_95 = (undefined1)(pSVar3->hul).ibmp;
  if ((pSVar3->wFlags & 0xff) == 7) {
    local_94 = (pSVar3->hul).dp;
    local_91 = pSVar3->turn;
    local_8f = (undefined2)pSVar3->cBuilt;
    local_8d = *(undefined2 *)((int)&pSVar3->cBuilt + 2);
    local_8b = (undefined2)pSVar3->cExist;
    local_89 = *(undefined2 *)((int)&pSVar3->cExist + 2);
    pb = local_87;
    __fmemmove(pb,(HS *)CONCAT22(uVar4,(pSVar3->hul).rghs),(uint)local_92 << 2);
    pb = pb + (uint)local_92 * 4;
  }
  else {
    local_94 = (pSVar3->hul).wtEmpty;
    pb = &local_92;
  }
  if ((pSVar3->wFlags & 0xff) == 7) {
    __fstrcpy(szHulName,(char *)CONCAT22(uVar4,(pSVar3->hul).szClass));
  }
  else {
    pHVar5 = LphuldefFromId((lpshdef->hul).ihuldef);
    __fstrcpy(szHulName,
                      (char *)CONCAT22((int)((ulong)pHVar5 >> 0x10),
                                       (((HULDEF *)pHVar5)->hul).szClass));
  }
  cOut = 0x1f;
  if ((szHulName[0] == '\0') ||
     (sVar1 = FCompressUserString(szHulName,(char *)(pb + 1),&cOut), sVar1 == 0)) {
    _strcpy(pb + 1,szHulName);
    *pb = 0;
    uVar2 = _strlen(szHulName);
    pb = pb + uVar2 + 2;
  }
  else {
    *pb = (byte)cOut;
    pb = pb + cOut + 1;
  }
  if (ppbStore == (byte **)0x0) {
    WriteRt(0x1a,(int)pb - (int)&rgb,&rgb);
  }
  else {
    _memmove(*ppbStore,&rgb,(int)pb - (int)&rgb);
    *ppbStore = *ppbStore + ((int)pb - (int)&rgb);
  }
  return;
}



// ======================================================================
// Function: FWriteDataFile
// Address: 1070:5964
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10705d1f) */
/* WARNING: Removing unreachable block (ram,0x10705e4f) */

short FWriteDataFile(char *pszFileBase,short iPlayer,short fAppend)

{
  int *piVar1;
  byte *pbVar2;
  ORDER *pOVar3;
  PLANET *pPVar4;
  ORDER *pOVar5;
  short *psVar6;
  int iVar7;
  undefined2 uVar8;
  PLORD *pPVar9;
  POINT pt_00;
  POINT pt_01;
  THING *pTVar10;
  uint uVar11;
  short sVar12;
  char *pcVar13;
  DtFileType dt;
  byte bVar14;
  int iVar15;
  ORDER *pOVar16;
  FLEET *pFVar17;
  PLANET *pPVar18;
  short *psVar19;
  ORDER *pOVar20;
  undefined2 uVar21;
  undefined2 uVar22;
  undefined2 unaff_SS;
  ulong uVar23;
  PL *pPVar24;
  short pl [7];
  undefined4 local_7e;
  undefined4 l;
  undefined4 lBest;
  int dx;
  int local_70;
  short fFoundIdeal;
  FLEET *lpflBest;
  short iflT;
  BTLPLAN *lpbtlplan;
  int dy;
  int local_60;
  int pt;
  int local_5c;
  FLEET *lpflTarget;
  short mdTarget;
  SCAN scan;
  PLANET *lpplT;
  short fRet;
  THING *lpthMac;
  short local_3c;
  int lpshdef;
  undefined2 local_38;
  short iord;
  short env [9];
  FLEET *lpfl;
  THING *lpth;
  ORDER *lpord;
  short i;
  short (*penvMemSav) [9];
  short j;
  BTLPLAN *lpbtlplan__16;
  undefined2 local_e;
  short fNoAutoTrack;
  FLEET *lpflT;
  short iMax;
  
  fRet = 1;
  SetVisiblePlanFleet(iPlayer);
  bVar14 = (byte)iPlayer;
  if ((((uint)gd.grBits >> 1 & 1) != 0) && (iPlayer != -1)) {
    for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar17 = ((FLEET **)rglpfl)[i];
      iVar15 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpfl = (FLEET *)CONCAT22(iVar15,pFVar17);
      if ((pFVar17 == (FLEET *)0x0) && (iVar15 == 0)) break;
      if (((pFVar17->wFlags_0x4 >> 10 & 1) == 0) && (((uint)lpfl->id >> 9 & 0xf) == iPlayer)) {
        for (j = 0; (j < 0x10 && (pFVar17->rgcsh[j] == 0)); j = j + 1) {
        }
        if (j == 0x10) {
          pFVar17->wFlags_0x4 = pFVar17->wFlags_0x4 & 0xfbff | 0x400;
        }
        else {
          iVar7 = *(int *)&pFVar17->lpplord;
          uVar22 = *(undefined2 *)((int)&pFVar17->lpplord + 2);
          lpord = (ORDER *)CONCAT22(uVar22,(ORDER *)(iVar7 + 4));
          if ((*(uint *)(iVar7 + 10) >> 8 & 0xf) == 2) {
            pt_00.y = *(short *)(iVar7 + 6);
            pt_00.x = (lpord->pt).x;
            sVar12 = FFindNearestObject(pt_00,0x81,&scan);
            pOVar16 = (ORDER *)lpord;
            uVar22 = (undefined2)((ulong)lpord >> 0x10);
            if (sVar12 == 0) {
              pOVar16->wFlags_0x6 = pOVar16->wFlags_0x6 & 0xf0ff | 0x400;
              pOVar16->id = 0;
            }
            else {
              pOVar16->wFlags_0x6 = pOVar16->wFlags_0x6 & 0xf0ff | 0x100;
              pOVar16->id = scan.idpl;
            }
          }
          uVar22 = (undefined2)((ulong)lpord >> 0x10);
          pOVar16 = (ORDER *)lpord;
          pFVar17 = (FLEET *)lpfl;
          uVar21 = (undefined2)((ulong)lpfl >> 0x10);
          if ((((pOVar16->wFlags_0x6 & 0xf) == 0) && (1 < pFVar17->cord)) &&
             ((pOVar16[1].wFlags_0x6 & 0xf) == 7)) {
            pOVar16->wFlags_0x6 = pOVar16->wFlags_0x6 & 0xfff0 | 7;
            uVar8 = *(undefined2 *)((int)&pOVar16[1].u_ORDER_0x0008 + 2);
            *&pOVar16->u_ORDER_0x0008 = ((&pOVar16[1].u_ORDER_0x0008)->txp).rgia[0].wFlags;
            *(undefined2 *)((int)&pOVar16->u_ORDER_0x0008 + 2) = uVar8;
          }
          if (((pOVar16->wFlags_0x6 & 0xf) == 7) &&
             ((pFVar17->cord < 2 || ((pOVar16[1].wFlags_0x6 >> 8 & 0xf) != 2)))) {
            lpflBest = (FLEET *)0x0;
            lBest = 100000000;
            fFoundIdeal = 0;
            if ((pFVar17->idPlanet == -1) &&
               ((1 < pFVar17->cord && ((pFVar17->wFlags_0x4 >> 9 & 1) != 0)))) {
              pt = ((pOVar16 + 1)->pt).x;
              local_5c = pOVar16[1].pt.y;
            }
            else {
              pt = (&pFVar17->pt)->x;
              local_5c = (pFVar17->pt).y;
            }
            uVar22 = *(undefined2 *)(pFVar17->iPlayer * 4 + 0x593a);
            lpbtlplan = (BTLPLAN *)
                        CONCAT22(uVar22,((BTLPLAN **)rglpbtlplan)[pFVar17->iPlayer * 2] +
                                        pFVar17->iplan);
            mdTarget = ((BTLPLAN **)rglpbtlplan)[pFVar17->iPlayer * 2][pFVar17->iplan].
                       wFlags_0x2 & 0xf;
            for (iflT = 0; iflT < cFleet; iflT = iflT + 1) {
                    /* WARNING: Load size is inaccurate */
              pFVar17 = ((FLEET **)rglpfl)[iflT];
              iVar15 = *(int *)((int)((FLEET **)rglpfl + iflT) + 2);
              lpflTarget = (FLEET *)CONCAT22(iVar15,pFVar17);
              if ((pFVar17 == (FLEET *)0x0) && (iVar15 == 0)) break;
              if (((pFVar17->wFlags_0x4 >> 8 & 1) != 0) && (pFVar17->iPlayer != iPlayer)) {
                dx = (&pFVar17->pt)->x - pt;
                local_70 = dx >> 0xf;
                dy = (pFVar17->pt).y - local_5c;
                local_60 = dy >> 0xf;
                uVar23 = __aFulmul((long)dy,(long)dy);
                local_7e = uVar23;
                uVar23 = __aFulmul(CONCAT22(local_70,dx),CONCAT22(local_70,dx));
                l = uVar23 + local_7e;
                if (((fFoundIdeal == 0) && (-1 < (int)((FLEET *)lpflTarget)->wFlags_0x4)) ||
                   ((l < lBest &&
                    ((fFoundIdeal == 0 || (-1 < (int)((FLEET *)lpflTarget)->wFlags_0x4)))))) {
                  sVar12 = FMatchTarget(lpflTarget,mdTarget,0);
                  if (sVar12 != 0) {
                    sVar12 = FAttackPlayer(lpfl,((FLEET *)lpflTarget)->iPlayer);
                    if (sVar12 != 0) {
                      lpflBest = lpflTarget;
                      lBest = l;
                      if (-1 < (int)((FLEET *)lpflTarget)->wFlags_0x4) {
                        fFoundIdeal = 1;
                      }
                    }
                  }
                }
              }
            }
            if ((fFoundIdeal != 0) && (((uint)gd.grBits >> 0xb & 1) == 0)) {
              ((FLEET *)lpflBest)->wFlags_0x4 = ((FLEET *)lpflBest)->wFlags_0x4 & 0x7fff | 0x8000;
            }
            j = *(int *)((int)&((ORDER *)lpord)->u_ORDER_0x0008 + 2) * 0x32 + 0x32;
            if (j == 0x226) {
              j = 10000;
            }
            if ((((FLEET *)lpflBest != (FLEET *)0x0) || (lpflBest._2_2_ != 0)) && (lBest != 0)) {
              uVar23 = __aFulmul((long)j,(long)j);
              if (lBest <= (long)uVar23) {
                uVar22 = (undefined2)((ulong)lpfl >> 0x10);
                pFVar17 = (FLEET *)lpfl;
                if ((int)(uint)((PLORD *)pFVar17->lpplord)->iordMax <= pFVar17->cord + 1) {
                  pPVar24 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)
                                                                ((int)&pFVar17->lpplord + 2),
                                                               *(PL **)&pFVar17->lpplord),
                                                pFVar17->cord + 2);
                  uVar22 = (undefined2)((ulong)lpfl >> 0x10);
                  pFVar17 = (FLEET *)lpfl;
                  *(PL **)&pFVar17->lpplord = (PL *)pPVar24;
                  *(undefined2 *)((int)&pFVar17->lpplord + 2) = (int)((ulong)pPVar24 >> 0x10);
                  lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar17->lpplord + 2),
                                            (ORDER *)(*(int *)&pFVar17->lpplord + 4));
                }
                uVar22 = (undefined2)((ulong)lpfl >> 0x10);
                if (1 < ((FLEET *)lpfl)->cord) {
                  __fmemmove((ORDER *)lpord + 2,(ORDER *)lpord + 1,
                                     (((FLEET *)lpfl)->cord + -1) * 0x12);
                }
                if (((FLEET *)lpfl)->cord == 1) {
                  __fmemset((ORDER *)lpord + 1,0,0x12);
                  uVar21 = (undefined2)((ulong)lpord >> 0x10);
                  pOVar16 = (ORDER *)lpord;
                  pOVar16[1].wFlags_0x6 = pOVar16[1].wFlags_0x6 & 0xefff | 0x1000;
                  pOVar16[1].wFlags_0x6 = pOVar16[1].wFlags_0x6 & 0xfff0 | 7;
                  uVar22 = *(undefined2 *)((int)&pOVar16->u_ORDER_0x0008 + 2);
                  *&pOVar16[1].u_ORDER_0x0008 = ((&pOVar16->u_ORDER_0x0008)->txp).rgia[0].wFlags;
                  *(undefined2 *)((int)&pOVar16[1].u_ORDER_0x0008 + 2) = uVar22;
                  if (((&pOVar16[1].u_ORDER_0x0008)->tlm).cTime == 0) {
                    uVar11 = IFindIdealWarp(lpfl,0);
                    uVar22 = (undefined2)((ulong)lpord >> 0x10);
                    ((ORDER *)lpord)[1].wFlags_0x6 =
                         ((ORDER *)lpord)[1].wFlags_0x6 & 0xff0f | (uVar11 & 0xf) << 4;
                    local_7e._2_2_ = uVar11;
                  }
                  else {
                    local_7e._2_2_ = ((&pOVar16[1].u_ORDER_0x0008)->tlm).cTime;
                    pOVar16[1].wFlags_0x6 =
                         pOVar16[1].wFlags_0x6 & 0xff0f | (local_7e._2_2_ & 0xf) << 4;
                  }
                  if ((((FLEET *)lpfl)->wFlags_0x4 >> 9 & 1) != 0) {
                    pOVar20 = (ORDER *)lpord + 2;
                    pOVar16 = (ORDER *)lpord;
                    for (iVar15 = 9; iVar15 != 0; iVar15 = iVar15 + -1) {
                      pOVar5 = pOVar20;
                      pOVar20 = &(pOVar20->pt).y;
                      pOVar3 = pOVar16;
                      pOVar16 = &(pOVar16->pt).y;
                      (pOVar5->pt).x = (pOVar3->pt).x;
                    }
                    local_7e._2_2_ = IFindIdealWarp(lpfl,0);
                    uVar22 = (undefined2)((ulong)lpord >> 0x10);
                    ((ORDER *)lpord)[2].wFlags_0x6 =
                         ((ORDER *)lpord)[2].wFlags_0x6 & 0xff0f | (local_7e._2_2_ & 0xf) << 4;
                    uVar22 = (undefined2)((ulong)lpfl >> 0x10);
                    piVar1 = &((FLEET *)lpfl)->cord;
                    *piVar1 = *piVar1 + 1;
                    pPVar9 = ((FLEET *)lpfl)->lpplord;
                    pbVar2 = &((PLORD *)pPVar9)->iordMac;
                    *pbVar2 = *pbVar2 + 1;
                  }
                }
                else if (((&((ORDER *)lpord)[1].u_ORDER_0x0008)->tlm).cTime == 0) {
                  uVar11 = IFindIdealWarp(lpfl,0);
                  uVar22 = (undefined2)((ulong)lpord >> 0x10);
                  ((ORDER *)lpord)[1].wFlags_0x6 =
                       ((ORDER *)lpord)[1].wFlags_0x6 & 0xff0f | (uVar11 & 0xf) << 4;
                  local_7e._2_2_ = uVar11;
                }
                else {
                  local_7e._2_2_ = ((&((ORDER *)lpord)[1].u_ORDER_0x0008)->tlm).cTime;
                  ((ORDER *)lpord)[1].wFlags_0x6 =
                       ((ORDER *)lpord)[1].wFlags_0x6 & 0xff0f | (local_7e._2_2_ & 0xf) << 4;
                }
                uVar22 = (undefined2)((ulong)lpflBest >> 0x10);
                sVar12 = (((FLEET *)lpflBest)->pt).y;
                uVar21 = (undefined2)((ulong)lpord >> 0x10);
                pOVar16 = (ORDER *)lpord;
                ((pOVar16 + 1)->pt).x = (&((FLEET *)lpflBest)->pt)->x;
                pOVar16[1].pt.y = sVar12;
                pOVar16[1].id = lpflBest->id;
                pOVar16[1].wFlags_0x6 = pOVar16[1].wFlags_0x6 & 0xf0ff | 0x200;
                uVar22 = (undefined2)((ulong)lpfl >> 0x10);
                piVar1 = &((FLEET *)lpfl)->cord;
                *piVar1 = *piVar1 + 1;
                pPVar9 = ((FLEET *)lpfl)->lpplord;
                pbVar2 = &((PLORD *)pPVar9)->iordMac;
                *pbVar2 = *pbVar2 + 1;
                FSendPlrMsg(iPlayer,idmPatrollingHasTargetedIntercept,lpfl->id | 0x8000,
                                 lpfl->id,lpflBest->id,0,0,0,0,0);
              }
            }
          }
          if (((((ORDER *)lpord)->wFlags_0x6 & 0xf) != 1) && (1 < ((FLEET *)lpfl)->cord)) {
            for (iord = 1; iord < ((FLEET *)lpfl)->cord; iord = iord + 1) {
              if ((((ORDER *)lpord)[iord].wFlags_0x6 >> 8 & 0xf) == 8) {
                lpth = LpthFromId(((ORDER *)lpord)[iord].id);
                iVar15 = (int)((ulong)lpth >> 0x10);
                pTVar10 = (THING *)lpth;
                if ((((pTVar10 == (THING *)0x0) && (iVar15 == 0)) ||
                    ((lpth->idFull >> 0xd == 3 &&
                     ((*(uint *)((int)&pTVar10->u_THING_0x0006 + 4) >> 4 & 1) == 0)))) ||
                   (((lpth->idFull >> 0xd == 0 &&
                     ((1 << (bVar14 & 0x1f) & *(uint *)((int)&pTVar10->u_THING_0x0006 + 8)) == 0))
                    || ((lpth->idFull >> 0xd == 2 &&
                        ((((&pTVar10->u_THING_0x0006)->thp).wFlags >> 0xd & 1) == 0)))))) {
                  pFVar17 = (FLEET *)lpfl;
                  uVar22 = (undefined2)((ulong)lpfl >> 0x10);
                  if (((pTVar10 == (THING *)0x0) && (iVar15 == 0)) || (lpth->idFull >> 0xd != 2)) {
                    if (((pTVar10 == (THING *)0x0) && (iVar15 == 0)) || (lpth->idFull >> 0xd != 3))
                    {
                      if (((pTVar10 != (THING *)0x0) || (iVar15 != 0)) && (lpth->idFull >> 0xd == 0)
                         ) {
                        FSendPlrMsg2(pFVar17->iPlayer,idmMineFieldHeadingHasVanishedOrdersHave,
                                          lpfl->id | 0x8000,lpfl->id,0);
                      }
                    }
                    else {
                      FSendPlrMsg2(pFVar17->iPlayer,
                                        idmMysteryTraderHeadingHasVanishedOrdersHave,
                                        lpfl->id | 0x8000,lpfl->id,0);
                    }
                  }
                  else {
                    FSendPlrMsg2(pFVar17->iPlayer,
                                      idmWormholeHeadingHasVanishedOrdersHaveChanged,
                                      lpfl->id | 0x8000,lpfl->id,0);
                  }
                  mdTarget = ((ORDER *)lpord)[iord].wFlags_0x6 & 0xf0ff | 0x400;
                  ((ORDER *)lpord)[iord].wFlags_0x6 = mdTarget;
                  ((ORDER *)lpord)[iord].id = iord;
                }
              }
              else if ((((ORDER *)lpord)[iord].wFlags_0x6 >> 8 & 0xf) == 2) {
                fNoAutoTrack = ((ORDER *)lpord)[iord].wFlags_0x6 >> 0xd & 1;
                if (fNoAutoTrack != 0) {
                  mdTarget = ((ORDER *)lpord)[iord].wFlags_0x6 & 0xdfff;
                  ((ORDER *)lpord)[iord].wFlags_0x6 = mdTarget;
                }
                lpflT = LpflFromId(((ORDER *)lpord)[iord].id);
                iVar15 = (int)((ulong)lpflT >> 0x10);
                pFVar17 = (FLEET *)lpflT;
                if (((pFVar17 == (FLEET *)0x0) && (iVar15 == 0)) ||
                   ((pFVar17->wFlags_0x4 >> 10 & 1) != 0)) {
                  FSendPlrMsg(iPlayer,idmSWaypointAppearsHaveDestroyedHasDisappeared,
                                   lpfl->id | 0x8000,lpfl->id,((ORDER *)lpord)[iord].id,0,0,0,0,0);
                }
                else {
                  if ((pFVar17->wFlags_0x4 >> 8 & 1) != 0) goto LAB_1070_618a;
                  if ((pFVar17->idPlanet == -1) || (fNoAutoTrack != 0)) {
                    FSendPlrMsg(iPlayer,idmFleetTrackingAppearsHaveOutrunRangeScanners,
                                     lpfl->id | 0x8000,lpfl->id,0,0,0,0,0,0);
                  }
                  else {
                    FSendPlrMsg(iPlayer,idmFleetTrackingAppearsHaveDuckedBehindOrders,
                                     lpfl->id | 0x8000,lpfl->id,pFVar17->idPlanet,0,0,0,0,0);
                  }
                }
                mdTarget = ((ORDER *)lpord)[iord].wFlags_0x6 & 0xf0ff | 0x400;
                ((ORDER *)lpord)[iord].wFlags_0x6 = mdTarget;
                ((ORDER *)lpord)[iord].id = iord;
                pt_01.y = ((ORDER *)lpord)[iord].pt.y;
                pt_01.x = (((ORDER *)lpord + iord)->pt).x;
                sVar12 = FFindNearestObject(pt_01,0x81,&scan);
                if (sVar12 != 0) {
                  mdTarget = ((ORDER *)lpord)[iord].wFlags_0x6 & 0xf0ff | 0x100;
                  ((ORDER *)lpord)[iord].wFlags_0x6 = mdTarget;
                  ((ORDER *)lpord)[iord].id = scan.idpl;
                }
              }
LAB_1070_618a:
            }
          }
        }
      }
    }
  }
  MarkPlayersThatSentMsgs(iPlayer);
  MarkPlanetsPlayerLost(iPlayer);
  if (iPlayer == -1) {
    _wsprintf(szWork,(char *)0x112009fe,pszFileBase,0x1120);
  }
  else {
    _wsprintf(szWork,(char *)0x11200a05,pszFileBase,0x1120,iPlayer + 1);
  }
  penvMemSav = penvMem;
  penvMem = &env;
  sVar12 = __setjmp(env);
  if (sVar12 == 0) {
    if (fAppend == 0) {
LAB_1070_677e:
      if (iPlayer == -1) {
        dt = dtHost;
      }
      else {
        dt = dtTurn;
      }
      sVar12 = FCreateFile(dt,iPlayer,(char *)0x0);
      if (sVar12 == 0) goto IO_LFail_2;
    }
    else {
      sVar12 = FAppendFile(iPlayer);
      if (sVar12 == 0) goto LAB_1070_677e;
    }
    WriteBattles(iPlayer);
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) ||
         ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0)) {
        sVar12 = GetRaceStat((PLAYER *)rgplr + iPlayer,rsMajorAdv);
        if (sVar12 == raTerra) {
          mdTarget = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 7;
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) = mdTarget;
        }
        WriteRtPlr((PLAYER *)rgplr + i,(byte *)0x0);
      }
    }
    if ((iPlayer == -1) && (((int)lSaltCur != 0 || (lSaltCur._2_2_ != 0)))) {
      WriteRt(0x24,4,&lSaltCur);
    }
    WritePlayerMessages(iPlayer);
    lpplT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    for (i = 0; i < cPlanet; i = i + 1) {
      uVar22 = (undefined2)((ulong)lpplT >> 0x10);
      pPVar18 = (PLANET *)lpplT;
      if ((pPVar18->wFlags_0x4 >> 8 & 1) != 0) {
        if ((pPVar18->wFlags_0x4 & 0xff) == 7) {
          WritePlanet(lpplT,0xd,0);
          uVar22 = (undefined2)((ulong)lpplT >> 0x10);
          pPVar18 = (PLANET *)lpplT;
          if ((*(int *)&pPVar18->lpplprod != 0) || (*(int *)((int)&pPVar18->lpplprod + 2) != 0)) {
            WriteRt(0x1c,(uint)((PLPROD *)pPVar18->lpplprod)->iprodMac << 2,
                    (void *)CONCAT22(*(undefined2 *)((int)&pPVar18->lpplprod + 2),
                                     (void *)(*(int *)&pPVar18->lpplprod + 4)));
          }
        }
        else if ((pPVar18->wFlags_0x4 & 0xff) == 2) {
          psVar19 = pl;
          for (iVar15 = 0x1c; iVar15 != 0; iVar15 = iVar15 + -1) {
            psVar6 = psVar19;
            psVar19 = psVar19 + 1;
            pPVar4 = pPVar18;
            pPVar18 = &pPVar18->iPlayer;
            *psVar6 = pPVar4->id;
          }
          uVar22 = (undefined2)((ulong)lpplT >> 0x10);
          pPVar18 = (PLANET *)lpplT;
          pPVar18->wFlags_0x4 = pPVar18->wFlags_0x4 & 0xfdff;
          pPVar18->wFlags_0x4 = pPVar18->wFlags_0x4 & 0xff00 | 3;
          WritePlanet(lpplT,0xe,0);
          psVar19 = pl;
          pPVar18 = (PLANET *)lpplT;
          for (iVar15 = 0x1c; iVar15 != 0; iVar15 = iVar15 + -1) {
            pPVar4 = pPVar18;
            pPVar18 = &pPVar18->iPlayer;
            psVar6 = psVar19;
            psVar19 = psVar19 + 1;
            pPVar4->id = *psVar6;
          }
        }
        else {
          WritePlanet(lpplT,0xe,0);
        }
      }
      lpplT = (PLANET *)lpplT + 1;
    }
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
        lpshdef = *(int *)(i * 4 + rglpshdef);
        local_38 = *(undefined2 *)(i * 4 + 0x100);
        for (j = 0; j < 0x10; j = j + 1) {
          if (((*(uint *)(lpshdef + j * 0x93 + 0x7b) >> 9 & 1) == 0) &&
             ((*(uint *)(lpshdef + j * 0x93 + 0x7b) >> 8 & 1) != 0)) {
            WriteRtShDef((SHDEF *)CONCAT22(local_38,(SHDEF *)(lpshdef + j * 0x93)),(byte **)0x0);
          }
        }
      }
    }
    for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar17 = ((FLEET **)rglpfl)[i];
      iVar15 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpflT = (FLEET *)CONCAT22(iVar15,pFVar17);
      if ((pFVar17 == (FLEET *)0x0) && (iVar15 == 0)) break;
      if ((pFVar17->wFlags_0x4 >> 8 & 1) != 0) {
        WriteFleet((FLEET *)CONCAT22(iVar15,pFVar17));
      }
    }
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
        lpshdef = *(int *)(i * 4 + rglpshdefSB);
        local_38 = *(undefined2 *)(i * 4 + 0x14e);
        for (j = 0; j < 10; j = j + 1) {
          if (((*(uint *)(lpshdef + j * 0x93 + 0x7b) >> 9 & 1) == 0) &&
             ((*(uint *)(lpshdef + j * 0x93 + 0x7b) >> 8 & 1) != 0)) {
            WriteRtShDef((SHDEF *)CONCAT22(local_38,(SHDEF *)(lpshdef + j * 0x93)),(byte **)0x0);
          }
        }
      }
    }
    if ((iPlayer != -1) &&
       (((SCOREX *)vlprgScoreX != (SCOREX *)0x0 || (vlprgScoreX._2_2_ != 0)))) {
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if (((((gd.grBits._2_2_ & 1) != 0) || (i == iPlayer)) ||
            ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0)) ||
           (((game.wCrap >> 6 & 1) != 0 && (0x13 < game.turn)))) {
          WriteRt(0x2d,0x18,
                  (SCOREX *)CONCAT22(vlprgScoreX._2_2_,(SCOREX *)vlprgScoreX + i));
        }
      }
    }
    i = 0;
    mdTarget = lpThings._2_2_;
    lpflTarget = (FLEET *)CONCAT22((THING *)lpThings,(FLEET *)lpflTarget);
    lpthMac = (THING *)lpThings + cThing;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < lpthMac) {
      if ((((iPlayer == -1) ||
           ((((iPlayer == (lpth->idFull >> 9 & 0xf) && (lpth->idFull >> 0xd != 1)) &&
             ((lpth->idFull >> 0xd != 3 && (lpth->idFull >> 0xd != 2)))) ||
            ((lpth->idFull >> 0xd == 0 &&
             ((1 << (bVar14 & 0x1f) & *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8)) != 0))))
           )) || ((lpth->idFull >> 0xd == 1 &&
                  (((&((THING *)lpth)->u_THING_0x0006)->tht).ptDest.x < 0)))) ||
         (((lpth->idFull >> 0xd == 3 &&
           ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) >> 4 & 1) != 0)) ||
          ((lpth->idFull >> 0xd == 2 &&
           ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 0xd & 1) != 0)))))) {
        i = i + 1;
      }
      lpth = (THING *)lpth + 1;
    }
    local_3c = mdTarget;
    if (0 < i) {
      WriteRt(0x2b,2,&i);
      mdTarget = lpThings._2_2_;
      lpflTarget = (FLEET *)CONCAT22((THING *)lpThings,(FLEET *)lpflTarget);
      lpthMac = (THING *)lpThings + cThing;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      local_3c = mdTarget;
      while ((THING *)lpth < lpthMac) {
        if ((((iPlayer == -1) ||
             ((((iPlayer == (lpth->idFull >> 9 & 0xf) && (lpth->idFull >> 0xd != 1)) &&
               (lpth->idFull >> 0xd != 3)) && (lpth->idFull >> 0xd != 2)))) ||
            (((lpth->idFull >> 0xd == 0 &&
              ((1 << (bVar14 & 0x1f) & *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8)) != 0))
             || (((lpth->idFull >> 0xd == 1 &&
                  (((&((THING *)lpth)->u_THING_0x0006)->tht).ptDest.x < 0)) ||
                 ((lpth->idFull >> 0xd == 3 &&
                  ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) >> 4 & 1) != 0)))))))) ||
           ((lpth->idFull >> 0xd == 2 &&
            ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 0xd & 1) != 0)))) {
          WriteRt(0x2b,0x12,lpth);
        }
        lpth = (THING *)lpth + 1;
      }
    }
    if (iPlayer == -1) {
      i = 0;
      iMax = game.cPlayer;
    }
    else {
      i = iPlayer;
      iMax = iPlayer + 1;
    }
    for (; i < iMax; i = i + 1) {
      lpbtlplan__16 = ((BTLPLAN **)rglpbtlplan)[i * 2];
      local_e = *(undefined2 *)(i * 4 + 0x593a);
      for (j = 0; j < (int)(uint)((byte *)rgcbtlplan)[i]; j = j + 1) {
        WriteBattlePlan((BTLPLAN *)CONCAT22(local_e,lpbtlplan__16),0);
        lpbtlplan__16 = lpbtlplan__16 + 1;
      }
    }
    WriteRt(0,2,&game.turn);
    StreamClose();
  }
  else {
IO_LFail_2:
    idPlayer = iPlayer;
    if (fAppend == 0) {
      if (iPlayer == -1) {
        idPlayer = -1;
        sVar12 = 0x10;
        pcVar13 = PszFormatIds(idsUnableCreateHostFile,(short *)0x0);
        AlertSz(pcVar13,sVar12);
      }
      else {
        sVar12 = 0x10;
        pcVar13 = PszFormatIds(idsUnableCreateNewTurnFile,(short *)0x0);
        AlertSz(pcVar13,sVar12);
      }
    }
    else {
      sVar12 = 0x10;
      pcVar13 = PszFormatIds(idsUnableUpdateTurnFile,(short *)0x0);
      AlertSz(pcVar13,sVar12);
    }
    idPlayer = -1;
    fRet = 0;
  }
  SetVisiblePlanFleet(-1);
  return fRet;
}



// ======================================================================
// Function: FAppendFile
// Address: 1070:704e
// Segment: MEMORY_IO
// ======================================================================


short FAppendFile(short iPlayer)

{
  short sVar1;
  
  sVar1 = FMarkFile(0x2003,iPlayer,4,1);
  if (sVar1 != 0) {
    WriteBOF(iPlayer,3,1);
  }
  return (uint)(sVar1 != 0);
}



// ======================================================================
// Function: WriteBattles
// Address: 1070:709c
// Segment: MEMORY_IO
// ======================================================================


void WriteBattles(short iPlayer)

{
  char *pcVar1;
  uint *puVar2;
  HB *pHVar3;
  FLEET *pFVar4;
  byte *pbVar5;
  uint uVar6;
  BTLREC *pBVar7;
  undefined2 uVar8;
  HB *pHVar9;
  BTLDATA *pBVar10;
  int iVar11;
  int iVar12;
  undefined2 uVar13;
  FLEET *pFVar14;
  PLANET *lppl;
  short iplr;
  short cb;
  BTLDATA *lpbtldata;
  HB *lphb;
  BTLDATA *lpbBattle;
  int local_1c;
  BTLREC *lpbtlrec;
  ushort fPlayerCur;
  short cbT;
  FLEET *lpfl;
  short i;
  short cbRec;
  short ctok;
  
  if ((iPlayer != -1) &&
     (((byte *)lpbBattleLog != (byte *)lpbBattleCur ||
      (lpbBattleLog._2_2_ != lpbBattleCur._2_2_)))) {
    lphb = (HB *)CONCAT22(iRam11200d62,pHRam11200d60);
    lpbBattle = &pHRam11200d60[1].cbBlock;
    local_1c = iRam11200d62;
    while (((HB *)lphb != (HB *)0x0 || (lphb._2_2_ != 0))) {
      lpbtldata = (BTLDATA *)CONCAT22(local_1c,lpbBattle);
      while( true ) {
        uVar13 = (undefined2)((ulong)lphb >> 0x10);
        pHVar9 = (HB *)lphb;
        if ((0x10 < pHVar9->ibTop) && (lpbtldata->id != 0xffff)) break;
                    /* WARNING: Load size is inaccurate */
        pHVar3 = pHVar9->lphbNext;
        local_1c = *(int *)((int)&pHVar9->lphbNext + 2);
        lphb = (HB *)CONCAT22(local_1c,pHVar3);
        if ((pHVar3 == (HB *)0x0) && (local_1c == 0)) {
          return;
        }
        lpbBattle = &pHVar3[1].cbBlock;
        lpbtldata = (BTLDATA *)CONCAT22(local_1c,lpbBattle);
      }
      uVar13 = (undefined2)((ulong)lpbtldata >> 0x10);
      pBVar10 = (BTLDATA *)lpbtldata;
      if ((pBVar10->grfPlr & 1 << ((byte)iPlayer & 0x1f)) == 0) {
        lpbBattle = (BTLDATA *)((int)&lpbBattle->id + pBVar10->cbData);
      }
      else {
        for (i = 0; i < game.cPlayer; i = i + 1) {
          if (((i != iPlayer) &&
              ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) == 0)) &&
             ((1 << ((byte)i & 0x1f) & pBVar10->grfPlr) != 0)) {
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 3;
          }
        }
        for (i = 0; i < (int)(uint)pBVar10->ctok; i = i + 1) {
          if ((uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x10) != iPlayer) {
            if (*(char *)((int)pBVar10 + i * 0x1d + 0x11) == '\x01') {
              uVar6 = (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x10);
              LpplFromId(*(short *)((int)pBVar10 + i * 0x1d + 0xe));
              if ((*(uint *)(*(int *)(uVar6 * 4 + rglpshdefSB) +
                             (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) >> 8
                  & 1) == 0) {
                *(uint *)(*(int *)(uVar6 * 4 + rglpshdefSB) +
                          (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) =
                     *(uint *)(*(int *)(uVar6 * 4 + rglpshdefSB) +
                               (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) &
                     0xfeff | 0x100;
                iVar11 = *(int *)((int)&rgplr[0].wFlags_0x4 + uVar6 * 0xc0);
                puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + uVar6 * 0xc0);
                *puVar2 = *puVar2 & 0xfff;
                puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + uVar6 * 0xc0);
                *puVar2 = *puVar2 | iVar11 + 0x1000U & 0xf000;
              }
              *(uint *)(*(int *)(uVar6 * 4 + rglpshdefSB) +
                        (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) =
                   *(uint *)(*(int *)(uVar6 * 4 + rglpshdefSB) +
                             (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) &
                   0xff00 | 7;
            }
            else {
              pFVar14 = LpflFromId(*(short *)((int)pBVar10 + i * 0x1d + 0xe));
              uVar8 = (undefined2)((ulong)pFVar14 >> 0x10);
              pFVar4 = (FLEET *)pFVar14;
              if ((pFVar4->iPlayer != iPlayer) &&
                 ((*(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) >> 8 & 1) ==
                  0)) {
                *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) =
                     *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) & 0xfeff |
                     0x100;
                *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) =
                     *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) & 0xfff8 |
                     3;
              }
              iVar11 = pFVar4->iPlayer * 4;
              if ((*(uint *)(*(int *)(iVar11 + rglpshdef) +
                             (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) >> 8 & 1
                  ) == 0) {
                iVar11 = pFVar4->iPlayer * 4;
                iVar12 = pFVar4->iPlayer * 4;
                *(uint *)(*(int *)(iVar12 + rglpshdef) +
                          (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) =
                     *(uint *)(*(int *)(iVar11 + rglpshdef) +
                               (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) &
                     0xfeff | 0x100;
                pcVar1 = (char *)((int)&rgplr[0].cShDef + pFVar4->iPlayer * 0xc0);
                *pcVar1 = *pcVar1 + '\x01';
              }
              iVar11 = pFVar4->iPlayer * 4;
              iVar12 = pFVar4->iPlayer * 4;
              *(uint *)(*(int *)(iVar12 + rglpshdef) +
                        (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) =
                   *(uint *)(*(int *)(iVar11 + rglpshdef) +
                             (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) & 0xff00
                   | 7;
              if ((pFVar4->wFlags_0x4 >> 10 & 1) == 0) {
                if ((pFVar4->wFlags_0x4 >> 8 & 1) == 0) {
                  iVar11 = *(int *)((int)&rgplr[0].wFlags_0x4 + pFVar4->iPlayer * 0xc0);
                  puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar4->iPlayer * 0xc0);
                  *puVar2 = *puVar2 & 0xf000;
                  puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar4->iPlayer * 0xc0);
                  *puVar2 = *puVar2 | iVar11 + 1U & 0xfff;
                  pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xfeff | 0x100;
                  pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xff00;
                }
                if ((pFVar4->wFlags_0x4 & 0xff) < 3) {
                  pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xff00 | 3;
                }
              }
            }
          }
        }
        if (pBVar10->idPlanet != 0xffff) {
          lppl = LpplFromId(pBVar10->idPlanet);
          MarkPlanet(lppl,iPlayer,1);
        }
        if (pBVar10->cbData < 0x400) {
          WriteRt(0x1f,pBVar10->cbData,(BTLDATA *)CONCAT22(local_1c,lpbBattle));
          lpbBattle = (BTLDATA *)((int)&lpbBattle->id + pBVar10->cbData);
        }
        else {
          uVar6 = (uint)pBVar10->ctok * 0x1d + 0xe;
          pBVar7 = (BTLREC *)((int)lpbBattle + uVar6);
          lpbtlrec = (BTLREC *)CONCAT22(local_1c,pBVar7);
          if (uVar6 < 0x400) {
            WriteRt(0x1f,uVar6,(BTLDATA *)CONCAT22(local_1c,lpbBattle));
            lpbBattle = (BTLDATA *)((int)lpbBattle + uVar6);
          }
          else {
            if (pBVar10->ctok < 0x23) {
              ctok = (short)pBVar10->ctok;
            }
            else {
              ctok = 0x22;
            }
            if ((uint)pBVar10->ctok < (uint)ctok) {
              ctok = (short)pBVar10->ctok;
            }
            WriteRt(0x1f,ctok * 0x1d + 0xe,(BTLDATA *)CONCAT22(local_1c,lpbBattle));
            lpbBattle = (BTLDATA *)((int)lpbBattle + ctok * 0x1d + 0xe);
            ctok = (uint)pBVar10->ctok - ctok;
            while (0 < ctok) {
              if ((uint)ctok < 0x24) {
                WriteRt(0x27,ctok * 0x1d,(BTLDATA *)CONCAT22(local_1c,lpbBattle));
                lpbBattle = (BTLDATA *)((int)lpbBattle + ctok * 0x1d);
                ctok = 0;
              }
              else {
                WriteRt(0x27,0x3f7,(BTLDATA *)CONCAT22(local_1c,lpbBattle));
                lpbBattle = (BTLDATA *)((int)&lpbBattle[0x48].cbData + 1);
                ctok = ctok + -0x23;
              }
            }
          }
          cb = (pBVar10->cbData - 0xe) + (uint)pBVar10->ctok * -0x1d;
          if (cb < 0x400) {
            WriteRt(0x27,cb,(BTLREC *)CONCAT22(local_1c,pBVar7));
            lpbBattle = (BTLDATA *)((int)lpbBattle + cb);
          }
          else {
            while (cb != 0) {
              cbRec = ((BTLREC *)lpbtlrec)->ctok * 8 + 6;
              if (cbRec < 0x400) {
                cbT = 0;
                do {
                  cbT = cbT + cbRec;
                  pbVar5 = &((BTLREC *)lpbtlrec)->itok;
                  lpbtlrec = (BTLREC *)CONCAT22(lpbtlrec._2_2_,pbVar5 + cbRec);
                  cb = cb - cbRec;
                  if (cb == 0) break;
                  cbRec = (pbVar5 + cbRec)->ctok * 8 + 6;
                } while (cbT + cbRec < 0x400);
                WriteRt(0x27,cbT,(BTLDATA *)CONCAT22(local_1c,lpbBattle));
              }
              else {
                cb = cb - cbRec;
                while( true ) {
                  if (cbRec < 0x400) break;
                  WriteRt(0x27,0x3ff,lpbtlrec);
                  lpbtlrec = (BTLREC *)
                             CONCAT22(lpbtlrec._2_2_,
                                      (BTLREC *)((int)&((BTLREC *)lpbtlrec)[0xaa].ctok + 1));
                  cbRec = cbRec + -0x3ff;
                }
                if (cbRec != 0) {
                  WriteRt(0x27,cbRec,lpbtlrec);
                  lpbtlrec = (BTLREC *)CONCAT22(lpbtlrec._2_2_,&((BTLREC *)lpbtlrec)->itok + cbRec);
                }
              }
              lpbBattle = (BTLREC *)lpbtlrec;
              local_1c = lpbtlrec._2_2_;
            }
          }
        }
      }
    }
  }
  return;
}



// ======================================================================
// Function: WritePlanet
// Address: 1070:7a6a
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x107080e7) */
/* WARNING: Removing unreachable block (ram,0x1070809d) */
/* WARNING: Removing unreachable block (ram,0x10708074) */
/* WARNING: Removing unreachable block (ram,0x107080c6) */
/* WARNING: Removing unreachable block (ram,0x10708110) */
/* WARNING: Removing unreachable block (ram,0x1070804b) */

void WritePlanet(PLANET *lppl,short rt,short fHistory)

{
  int iVar1;
  undefined2 uVar2;
  byte *pbVar3;
  uint uVar4;
  uint uVar5;
  uint uVar6;
  PLANET *pPVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar8;
  undefined2 unaff_SS;
  ulong uVar9;
  ulong uVar10;
  byte *pb;
  short i;
  byte *pbBase;
  uint rgb;
  uint local_54;
  byte local_52;
  byte local_51 [75];
  byte bMask;
  
  uVar10 = CONCAT22(unaff_SI,unaff_DI);
  _memset(&rgb,0,0x50);
  uVar8 = (undefined2)((ulong)lppl >> 0x10);
  pPVar7 = (PLANET *)lppl;
  rgb = lppl->id & 0x7ffU | pPVar7->iPlayer << 0xb;
  uVar5 = local_54 & 0xff80;
  local_54 = uVar5 | pPVar7->wFlags_0x4 & 0x7f;
  if ((rt == 0xe) && (3 < (pPVar7->wFlags_0x4 & 0xff))) {
    if (fHistory == 0) {
      local_54 = 4;
    }
    else {
      local_54 = 3;
    }
    local_54 = uVar5 | local_54;
  }
  uVar4 = (uint)((pPVar7->wRouting & 0x3ff) != 0);
  uVar6 = local_54 & 0x3c7f | (pPVar7->wFlags_0x4 >> 8 & 1) << 8 |
          (pPVar7->wFlags_0x4 >> 9 & 1) << 9 | (pPVar7->wFlags_0x4 >> 10 & 1) << 7 |
          (pPVar7->wFlags_0x4 >> 0xb) << 0xf | uVar4 << 0xe;
  pb = &local_52;
  uVar5 = local_54 & 0x7f;
  local_54 = uVar6;
  if (1 < uVar5) {
    pb = local_51;
    bMask = 3;
    for (i = 0; i < 3; i = i + 1) {
      if (pPVar7->rgpctMinLevel[i] != 0) {
        local_52 = local_52 | bMask & 0x55;
        *pb = pPVar7->rgpctMinLevel[i];
        pb = pb + 1;
      }
      bMask = bMask << 2;
    }
    for (i = 0; i < 3; i = i + 1) {
      *pb = pPVar7->rgMinConc[i];
      pb = pb + 1;
    }
    for (i = 0; i < 3; i = i + 1) {
      *pb = pPVar7->rgEnvVar[i];
      uVar4 = (uint)pPVar7->rgEnvVar[i];
      if (uVar4 != (int)pPVar7->rgEnvVarOrig[i]) {
        local_54 = local_54 & 0xfbff | 0x400;
      }
      pb = pb + 1;
    }
    if ((local_54 >> 10 & 1) != 0) {
      for (i = 0; i < 3; i = i + 1) {
        *pb = pPVar7->rgEnvVarOrig[i];
        pb = pb + 1;
      }
    }
    if (pPVar7->iPlayer != -1) {
      *(ushort *)pb = pPVar7->uGuesses;
      pb = pb + 2;
    }
    pbVar3 = pb;
    if (3 < (local_54 & 0x7f)) {
      pb = pb + 1;
      bMask = 3;
      for (i = 0; i < 4; i = i + 1) {
        if ((i != 3) || (6 < (pPVar7->wFlags_0x4 & 0xff))) {
          iVar1 = *(int *)((int)(pPVar7->rgwtMin + i) + 2);
          if ((-1 < iVar1) && ((0 < iVar1 || ((int)pPVar7->rgwtMin[i] != 0)))) {
            uVar5 = *(uint *)((int)(pPVar7->rgwtMin + i) + 2);
            if (((int)uVar5 < 0) || (((int)uVar5 < 1 && (*(uint *)(pPVar7->rgwtMin + i) < 0x100))))
            {
              *pbVar3 = *pbVar3 | bMask & 0x55;
              *pb = (byte)(int)pPVar7->rgwtMin[i];
              pb = pb + 1;
            }
            else {
              iVar1 = *(int *)((int)pPVar7->rgwtMin + i * 4 + 2);
              if ((iVar1 < 0) || (iVar1 < 1)) {
                *pbVar3 = *pbVar3 | bMask & 0xaa;
                *(int *)pb = (int)pPVar7->rgwtMin[i];
                pb = pb + 2;
              }
              else {
                *pbVar3 = *pbVar3 | bMask;
                uVar2 = *(undefined2 *)((int)(pPVar7->rgwtMin + i) + 2);
                *(int *)pb = (int)pPVar7->rgwtMin[i];
                *(undefined2 *)(pb + 2) = uVar2;
                pb = pb + 4;
              }
            }
          }
        }
        bMask = bMask << 2;
      }
      if (*pbVar3 != 0) {
        local_54 = local_54 & 0xdfff | 0x2000;
        pbVar3 = pb;
      }
      pb = pbVar3;
      if (rt != 0xe) {
        uVar9 = __aFulshr(uVar10,uVar4);
        uVar5 = (uint)uVar9 & 1;
        local_54 = local_54 & 0xefff | uVar5 << 0xc;
        if ((((pPVar7->iPlayer != -1) &&
             (((*(uint *)pPVar7->rgbImp & 0xff) != 0 ||
              (uVar9 = __aFulshr(uVar10,uVar5), (uVar9 & 1) != 0)))) ||
            (uVar9 = __aFulshr(uVar10,uVar5), (uVar9 & 0xfff) != 0)) ||
           (((uVar9 = __aFulshr(uVar10,uVar5), (uVar9 & 0xfff) != 0 ||
             ((*(uint *)(pPVar7->rgbImp + 4) & 0xfff) != 0)) ||
            (uVar10 = __aFulshr(uVar10,uVar5), ((uint)uVar10 & 0x1f) != 0x1f)))) {
          local_54 = local_54 & 0xf7ff | 0x800;
          __fmemmove(pb,(byte *)CONCAT22(uVar8,pPVar7->rgbImp),8);
          pb = pb + 8;
        }
        if (pPVar7->iPlayer != -1) {
          if ((pPVar7->wFlags_0x4 >> 9 & 1) != 0) {
            uVar2 = *(undefined2 *)((int)&pPVar7->lStarbase + 2);
            *(int *)pb = (int)pPVar7->lStarbase;
            *(undefined2 *)(pb + 2) = uVar2;
            pb = pb + 4;
          }
          if ((pPVar7->wRouting & 0x3ff) != 0) {
            *(ushort *)pb = pPVar7->wRouting;
            pb = pb + 2;
          }
        }
        WriteRt(0xd,(int)pb - (int)&rgb,&rgb);
        return;
      }
    }
  }
  if ((pPVar7->wFlags_0x4 >> 9 & 1) != 0) {
    *pb = (byte)(int)pPVar7->lStarbase & 0xf;
    pb = pb + 1;
  }
  if (fHistory != 0) {
    *(short *)pb = pPVar7->turn;
    pb = pb + 2;
  }
  WriteRt(0xe,(int)pb - (int)&rgb,&rgb);
  return;
}



// ======================================================================
// Function: WriteFleet
// Address: 1070:81c6
// Segment: MEMORY_IO
// ======================================================================


void WriteFleet(FLEET *lpfl)

{
  undefined2 uVar1;
  long lVar2;
  byte *pbVar3;
  uint uVar4;
  int iVar5;
  undefined2 unaff_SS;
  ulong uVar6;
  undefined2 wt;
  undefined2 local_98;
  ushort grMask;
  short fByte;
  byte *pb;
  short i;
  ushort us;
  undefined1 rgb [4];
  uint local_88;
  ushort local_80;
  ushort local_7e [60];
  ushort *pus;
  
  __fmemmove(rgb,lpfl,0xc);
  fByte = 1;
  grMask = 1;
  us = 0;
  for (i = 0; i < 0x10; i = i + 1) {
    if ((0 < ((FLEET *)lpfl)->rgcsh[i]) && (us = us | grMask, 0xff < ((FLEET *)lpfl)->rgcsh[i])) {
      fByte = 0;
    }
    grMask = grMask << 1;
  }
  local_88 = local_88 & 0xf7ff | fByte << 0xb;
  local_80 = us;
  pb = local_7e;
  if (fByte == 0) {
    pus = pb;
    for (i = 0; i < 0x10; i = i + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
        *pus = ((FLEET *)lpfl)->rgcsh[i];
        pus = pus + 1;
      }
    }
    pb = pus;
  }
  else {
    for (i = 0; i < 0x10; i = i + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
        *pb = (byte)((FLEET *)lpfl)->rgcsh[i];
        pb = pb + 1;
      }
    }
  }
  pbVar3 = pb;
  if (3 < (((FLEET *)lpfl)->wFlags_0x4 & 0xff)) {
    grMask = 3;
    pus = pb;
    pb = pb + 2;
    us = 0;
    for (i = 0; i < 5; i = i + 1) {
      iVar5 = *(int *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
      if (((-1 < iVar5) && ((0 < iVar5 || ((int)((FLEET *)lpfl)->rgwtMin[i] != 0)))) &&
         (((((FLEET *)lpfl)->wFlags_0x4 & 0xff) == 7 || ((i != 4 && (i != 3)))))) {
        uVar4 = *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
        if (((int)uVar4 < 0) ||
           (((int)uVar4 < 1 && (*(uint *)(((FLEET *)lpfl)->rgwtMin + i) < 0x100)))) {
          us = us | grMask & 0x155;
          *pb = (byte)(int)((FLEET *)lpfl)->rgwtMin[i];
          pb = pb + 1;
        }
        else {
          iVar5 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + i * 4 + 2);
          if ((iVar5 < 0) || (iVar5 < 1)) {
            uVar4 = grMask & 0x2aa;
            *(int *)pb = (int)((FLEET *)lpfl)->rgwtMin[i];
            pb = pb + 2;
          }
          else {
            uVar4 = grMask & 0x3ff;
            uVar1 = *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
            *(int *)pb = (int)((FLEET *)lpfl)->rgwtMin[i];
            *(undefined2 *)(pb + 2) = uVar1;
            pb = pb + 4;
          }
          us = us | uVar4;
        }
      }
      grMask = grMask << 2;
    }
    *(ushort *)pbVar3 = us;
  }
  if ((((FLEET *)lpfl)->wFlags_0x4 & 0xff) < 7) {
    lVar2 = 0;
    uVar1 = *(undefined2 *)((int)&((FLEET *)lpfl)->dirLong + 2);
    *(int *)pb = (int)((FLEET *)lpfl)->dirLong;
    *(undefined2 *)(pb + 2) = uVar1;
    for (i = 0; i < 0x10; i = i + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
        iVar5 = ((FLEET *)lpfl)->iPlayer * 4;
        uVar6 = __aFulmul((long)((FLEET *)lpfl)->rgcsh[i],
                                  (ulong)*(uint *)(*(int *)(iVar5 + rglpshdef) + i * 0x93 + 0x28));
        lVar2 = uVar6 + lVar2;
      }
    }
    i = 0;
    while( true ) {
      local_98 = (undefined2)((ulong)lVar2 >> 0x10);
      wt = (undefined2)lVar2;
      if (3 < i) break;
      lVar2 = lVar2 + CONCAT22(*(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2),
                               (int)((FLEET *)lpfl)->rgwtMin[i]);
      i = i + 1;
    }
    *(undefined2 *)(pb + 4) = wt;
    *(undefined2 *)(pb + 6) = local_98;
    WriteRt(0x11,(short)(pb + (8 - (int)rgb)),rgb);
  }
  else {
    grMask = 1;
    us = 0;
    for (i = 0; i < 0x10; i = i + 1) {
      if (((FLEET *)lpfl)->rgcsh[i + 0x10] != 0) {
        us = us | grMask;
      }
      grMask = grMask << 1;
    }
    *(ushort *)pb = us;
    pus = pb + 2;
    for (i = 0; i < 0x10; i = i + 1) {
      if (((FLEET *)lpfl)->rgcsh[i + 0x10] != 0) {
        *pus = ((FLEET *)lpfl)->rgcsh[i + 0x10];
        pus = pus + 1;
      }
    }
    *(byte *)pus = ((FLEET *)lpfl)->iplan;
    *(undefined1 *)((int)pus + 1) = (char)((FLEET *)lpfl)->cord;
    WriteRt(0x10,(int)pus + (2 - (int)rgb),rgb);
    WriteOrders(lpfl);
    if ((*(int *)&((FLEET *)lpfl)->lpszName != 0) ||
       (*(int *)((int)&((FLEET *)lpfl)->lpszName + 2) != 0)) {
                    /* WARNING: Load size is inaccurate */
      WriteRtString((char *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2),
                                     ((FLEET *)lpfl)->lpszName));
    }
  }
  return;
}



// ======================================================================
// Function: WriteRtString
// Address: 1070:87b4
// Segment: MEMORY_IO
// ======================================================================


void WriteRtString(char *lpsz)

{
  short sVar1;
  ushort uVar2;
  undefined2 unaff_SS;
  short cOut;
  undefined1 rgb;
  char local_25 [35];
  
  if ((lpsz != (char *)0x0) && (*lpsz != '\0')) {
    cOut = 0x1f;
    sVar1 = FCompressUserString(lpsz,local_25,&cOut);
    if (sVar1 == 0) {
      __fstrcpy(local_25,lpsz);
      rgb = 0;
      uVar2 = __fstrlen(lpsz);
      cOut = uVar2 + 1;
    }
    else {
      rgb = (undefined1)cOut;
    }
    WriteRt(0x15,cOut + 1,&rgb);
  }
  return;
}



// ======================================================================
// Function: MarkFleet
// Address: 1070:885e
// Segment: MEMORY_IO
// ======================================================================


void MarkFleet(FLEET *lpfl,short det)

{
  uint *puVar1;
  int iVar2;
  undefined2 uVar3;
  FLEET *pFVar4;
  int iVar5;
  undefined2 uVar6;
  short i;
  
  uVar6 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar4 = (FLEET *)lpfl;
  if ((pFVar4->wFlags_0x4 >> 8 & 1) == 0) {
    iVar5 = pFVar4->iPlayer * 4;
    iVar2 = *(int *)(iVar5 + rglpshdef);
    uVar3 = *(undefined2 *)(iVar5 + 0x100);
    pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xfeff | 0x100;
    pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xff00;
    *(uint *)((int)&pFVar4->dirLong + 2) = *(uint *)((int)&pFVar4->dirLong + 2) & 0xffef | 0x10;
    iVar5 = *(int *)((int)&rgplr[0].wFlags_0x4 + pFVar4->iPlayer * 0xc0);
    puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar4->iPlayer * 0xc0);
    *puVar1 = *puVar1 & 0xf000;
    puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar4->iPlayer * 0xc0);
    *puVar1 = *puVar1 | iVar5 + 1U & 0xfff;
    for (i = 0; i < 0x10; i = i + 1) {
      if (pFVar4->rgcsh[i] != 0) {
        *(uint *)(iVar2 + i * 0x93 + 0x7b) = *(uint *)(iVar2 + i * 0x93 + 0x7b) & 0xfeff | 0x100;
      }
    }
  }
  if ((pFVar4->wFlags_0x4 & 0xff) < (uint)det) {
    pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xff00 | det & 0xffU;
  }
  return;
}



// ======================================================================
// Function: WriteBattlePlan
// Address: 1070:89b8
// Segment: MEMORY_IO
// ======================================================================


void WriteBattlePlan(BTLPLAN *lpbtlplan,short fLog)

{
  short sVar1;
  ushort uVar2;
  undefined2 unaff_SS;
  short cOut;
  char szPlanName [32];
  byte *pb;
  undefined1 rgb [2];
  byte local_26 [2];
  byte local_24 [34];
  
  __fmemmove(rgb,lpbtlplan,4);
  if ((lpbtlplan->wFlags >> 0xe & 1) == 0) {
    pb = local_24;
    __fstrcpy(szPlanName,(char *)CONCAT22(lpbtlplan._2_2_,((BTLPLAN *)lpbtlplan)->szName));
    cOut = 0x1f;
    if ((szPlanName[0] == '\0') ||
       (sVar1 = FCompressUserString(szPlanName,(char *)(pb + 1),&cOut), sVar1 == 0)) {
      _strcpy(pb + 1,szPlanName);
      *pb = 0;
      uVar2 = _strlen(szPlanName);
      pb = pb + uVar2 + 2;
    }
    else {
      *pb = (byte)cOut;
      pb = pb + cOut + 1;
    }
  }
  else {
    pb = local_26;
  }
  if (fLog == 0) {
    WriteRt(0x1e,(int)pb - (int)rgb,rgb);
  }
  else {
    WriteMemRt(0x1e,(int)pb - (int)rgb,rgb);
  }
  return;
}



// ======================================================================
// Function: MarkPlanet
// Address: 1070:8adc
// Segment: MEMORY_IO
// ======================================================================


void MarkPlanet(PLANET *lppl,short iPlr,ushort det)

{
  int *piVar1;
  uint *puVar2;
  undefined2 uVar3;
  int iVar4;
  PLANET *pPVar5;
  int iVar6;
  undefined2 uVar7;
  SHDEF *lpshdef;
  
  uVar7 = (undefined2)((ulong)lppl >> 0x10);
  pPVar5 = (PLANET *)lppl;
  if ((pPVar5->wFlags_0x4 >> 8 & 1) == 0) {
    pPVar5->wFlags_0x4 = pPVar5->wFlags_0x4 & 0xfeff | 0x100;
    pPVar5->wFlags_0x4 = pPVar5->wFlags_0x4 & 0xff00;
    piVar1 = (int *)((int)&rgplr[0].cPlanet + iPlr * 0xc0);
    *piVar1 = *piVar1 + 1;
  }
  if ((pPVar5->wFlags_0x4 & 0xff) < det) {
    pPVar5->wFlags_0x4 = pPVar5->wFlags_0x4 & 0xff00 | det & 0xff;
  }
  if ((pPVar5->iPlayer != -1) &&
     ((*(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) >> 8 & 1) == 0)) {
    *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) =
         *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) & 0xfeff | 0x100;
    *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) =
         *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) & 0xfff8 | 3;
  }
  if (((det != 2) && (pPVar5->iPlayer != -1)) && ((pPVar5->wFlags_0x4 >> 9 & 1) != 0)) {
    iVar6 = pPVar5->iPlayer * 4;
    uVar3 = *(undefined2 *)(iVar6 + 0x14e);
    iVar6 = *(int *)(iVar6 + rglpshdefSB) + (*(uint *)&pPVar5->lStarbase & 0xf) * 0x93;
    if ((*(uint *)(iVar6 + 0x7b) >> 8 & 1) == 0) {
      *(uint *)(iVar6 + 0x7b) = *(uint *)(iVar6 + 0x7b) & 0xfeff | 0x100;
      *(uint *)(iVar6 + 0x7b) = *(uint *)(iVar6 + 0x7b) & 0xff00;
      iVar4 = *(int *)((int)&rgplr[0].wFlags_0x4 + pPVar5->iPlayer * 0xc0);
      puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pPVar5->iPlayer * 0xc0);
      *puVar2 = *puVar2 & 0xfff;
      puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pPVar5->iPlayer * 0xc0);
      *puVar2 = *puVar2 | iVar4 + 0x1000U & 0xf000;
    }
    if ((*(uint *)(iVar6 + 0x7b) & 0xff) < 3) {
      *(uint *)(iVar6 + 0x7b) = *(uint *)(iVar6 + 0x7b) & 0xff00 | 3;
    }
  }
  return;
}



// ======================================================================
// Function: SetSzWorkFromDt
// Address: 1070:8cfe
// Segment: MEMORY_IO
// ======================================================================


void SetSzWorkFromDt(DtFileType dt,short iPlayer)

{
  char *pcVar1;
  char *pcVar2;
  short sVar3;
  undefined2 uVar4;
  char *pchDot;
  short c;
  char *pchSlash;
  
  pcVar1 = _strrchr((char *)szBase,0x2e);
  if ((pcVar1 != (char *)0x0) &&
     ((pcVar2 = _strrchr((char *)szBase,0x5c), pcVar2 == (char *)0x0 ||
      (pcVar2 < pcVar1)))) {
    *pcVar1 = '\0';
  }
  sVar3 = _wsprintf(szWork,(char *)0x11200a0c,(char *)szBase,0x1120);
  if (dt == dtXY) {
LAB_1070_8d76:
    _strcat((char *)szWork,(char *)0xa10);
  }
  else {
    if (dt != dtLog) {
      if (dt == dtHost) {
        _strcat((char *)szWork,(char *)0xa13);
        return;
      }
      if ((dt != dtTurn) && (dt != dtHist)) goto LAB_1070_8d76;
    }
    if (dt == dtLog) {
      uVar4 = 0x78;
    }
    else if (dt == dtHist) {
      uVar4 = 0x68;
    }
    else {
      uVar4 = 0x6d;
    }
    _wsprintf((char *)szWork + sVar3,(char *)0x11200a17,uVar4,iPlayer + 1);
  }
  return;
}



// ======================================================================
// Function: FCreateFile
// Address: 1070:8e16
// Segment: MEMORY_IO
// ======================================================================


short FCreateFile(DtFileType dt,short iPlayer,char *szForceName)

{
  short sVar1;
  char *psz;
  short env [9];
  short (*penvMemSav) [9];
  
  if (szForceName == (char *)0x0) {
    SetSzWorkFromDt(dt,iPlayer);
    psz = (char *)szWork;
  }
  else {
    psz = szForceName;
  }
  penvMemSav = penvMem;
  penvMem = &env;
  sVar1 = __setjmp(env);
  if (sVar1 != 0) {
    penvMem = penvMemSav;
  }
  else {
    StreamOpen(psz,0x1012);
    WriteBOF(iPlayer,dt,0);
    penvMem = penvMemSav;
  }
  return (uint)(sVar1 == 0);
}



// ======================================================================
// Function: WriteBOF
// Address: 1070:8ea4
// Segment: MEMORY_IO
// ======================================================================


void WriteBOF(short iPlayer,short dt,short fMulti)

{
  short sVar1;
  int iVar2;
  undefined2 unaff_SS;
  DWORD DVar3;
  char rtbof [4];
  undefined2 local_10;
  undefined2 local_e;
  undefined2 local_c;
  ushort local_a;
  uint local_8;
  uint local_6;
  
  _memset(rtbof,0,0x10);
  _strncpy(rtbof,(char *)0xa1c,4);
  local_10 = (undefined2)game.lid;
  local_e = game.lid._2_2_;
  local_c = 0x2a60;
  local_a = game.turn;
  local_6 = local_6 & 0xfff | (game.wCrap >> 9) << 0xd;
  local_8 = local_8 & 0xffe0 | iPlayer & 0x1fU;
  sVar1 = Random(2000);
  DVar3 = GetTickCount();
  local_8 = local_8 & 0x1f | ((int)DVar3 + sVar1) * 0x20;
  if ((dt == 2) && ((gd.grBits._2_2_ & 1) != 0)) {
    iVar2 = 1;
  }
  else {
    iVar2 = 0;
  }
  local_6 = local_6 & 0xf400 | dt & 0xffU | ((uint)gd.grBits >> 4 & 1) << 8 |
            ((uint)gd.grBits >> 3 & 1) << 9 | iVar2 << 0xb;
  WriteRt(8,0x10,rtbof);
  return;
}



// ======================================================================
// Function: FMarkFile
// Address: 1070:904a
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Variable defined which should be unmapped: fSilentSav */
/* WARNING: Variable defined which should be unmapped: fSuccess */

short FMarkFile(DtFileType dt,short iPlayer,short mdMark,short f)

{
  char *pcVar1;
  undefined2 *puVar2;
  short sVar3;
  short sVar4;
  int iVar5;
  char *pcVar6;
  undefined2 *puVar7;
  undefined2 unaff_SS;
  bool bVar8;
  undefined2 in_stack_0000ffcc;
  undefined2 in_stack_0000ffce;
  short fSilentSav;
  short fSuccess;
  short fChange;
  short env [9];
  short (*penvMemSav) [9];
  undefined2 rtbof [2];
  int local_12;
  int local_10;
  uint local_8;
  short ids;
  
  sVar3 = fFileErrSilent;
  fSuccess = 0;
  ids = 0;
  SetSzWorkFromDt(dt & 0xff,iPlayer);
  penvMemSav = penvMem;
  penvMem = &env;
  sVar4 = __setjmp(env);
  fFileErrSilent = sVar3;
  if (sVar4 != 0) {
    if (ids != 0) {
      FileError(ids);
    }
    StreamClose();
    penvMem = penvMemSav;
    return 0;
  }
  fFileErrSilent = 1;
  StreamOpen((char *)szWork,0x12);
  ids = 3;
  fFileErrSilent = sVar3;
  ReadRt();
  if (hdrCur.wFlags >> 10 == 8) {
    if (((uint)rgbCur._8_2_ >> 0xc < 2) ||
       (((uint)rgbCur._8_2_ >> 0xc == 2 &&
        (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x31)))) {
      FileError(idsSorryFileCreatedOlderVersionStarsIncompatible);
    }
    else if (((uint)rgbCur._8_2_ >> 0xc < 3) &&
            (((uint)rgbCur._8_2_ >> 0xc != 2 ||
             (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x54)))) {
      pcVar6 = (char *)rgbCur;
      puVar7 = rtbof;
      for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
        puVar2 = puVar7;
        puVar7 = puVar7 + 1;
        pcVar1 = pcVar6;
        pcVar6 = pcVar6 + 2;
        *puVar2 = *pcVar1;
      }
      if (((int)game.lid != 0) || (game.lid._2_2_ != 0)) {
        if ((local_12 == (int)game.lid) && (local_10 == game.lid._2_2_)) {
          bVar8 = false;
          if (mdMark == 1) {
            bVar8 = (local_8 >> 9 & 1) != f;
            if (bVar8) {
              local_8 = local_8 & 0xfdff | (f & 1U) << 9;
            }
          }
          else if (mdMark == 2) {
            bVar8 = (local_8 >> 8 & 1) != f;
            if (bVar8) {
              local_8 = local_8 & 0xfeff | (f & 1U) << 8;
            }
          }
          else if (mdMark == 4) {
            bVar8 = (local_8 >> 10 & 1) != f;
            if (bVar8) {
              local_8 = local_8 & 0xfbff | (f & 1U) << 10;
            }
          }
          else if (mdMark == 8) {
            do {
              do {
                GetFileSeeds(&stack0xffc8,&stack0xffcc);
                ReadRt();
              } while (hdrCur.wFlags >> 10 != 6);
            } while (rgbCur[0] != iPlayer);
            if (((uint)rgbCur._6_2_ >> 9 & 1) != f) {
              if (((uint)rgbCur._6_2_ >> 9 & 1) == 0) {
                rgbCur._6_2_ = rgbCur._6_2_ & 0x1dff | 0xe200;
              }
              else {
                if ((uint)rgbCur._6_2_ >> 0xd != 7) goto IO_LBadFile_3;
                rgbCur._6_2_ = rgbCur._6_2_ & 0xfdff;
              }
              rgbCur._12_2_ = ~rgbCur._12_2_;
              rgbCur._14_2_ = ~rgbCur._14_2_;
              __lseek(hf,(long)(int)-((hdrCur.wFlags & 0x3ff) + 2),1);
              SetFileSeeds
                        (CONCAT22(in_stack_0000ffce,in_stack_0000ffcc),
                         CONCAT22(in_stack_0000ffce,in_stack_0000ffcc));
              WriteRt(6,hdrCur.wFlags & 0x3ff,rgbCur);
              bVar8 = dt == dtTurn;
              local_8 = local_8 & 0xfeff;
            }
          }
          if (bVar8) {
            __lseek(hf,0,0);
            _fSilentSav = rtbof;
            WriteRt(8,0x10,_fSilentSav);
          }
          fSuccess = 1;
        }
        else {
          FileError(idsFileGame);
        }
      }
    }
    else {
      FileError(idsFileCreatedNewerVersionStarsMustUpgrade);
    }
  }
  else {
    FileError(idsFileDoesBelongVersionStars);
  }
IO_LBadFile_3:
  if (((dt & 0x2000) == dtXY) || (fSuccess == 0)) {
    StreamClose();
  }
  else {
    __lseek(hf,0,2);
  }
  penvMem = penvMemSav;
  return fSuccess;
}



// ======================================================================
// Function: WriteRt
// Address: 1070:947c
// Segment: MEMORY_IO
// ======================================================================


void WriteRt(short rt,short cb,void *rg)

{
  undefined2 unaff_SS;
  HDR hdr;
  
  __fmemmove(rgbCur,rg,cb);
  if (rt == 8) {
    SetFileXorStream
              (CONCAT22(rgbCur._6_2_,rgbCur._4_2_),
               (int)rgbCur._12_2_ >> 5,rgbCur._10_2_,
               (int)(rgbCur._12_2_ << 0xb) >> 0xb,(uint)rgbCur._14_2_ >> 0xc & 1
              );
  }
  else if (rt != 0) {
    XorFileBuf((char *)rgbCur,cb);
  }
  hdr.wFlags = cb & 0x3ffU | rt << 10;
  RgToStream(&hdr,2);
  RgToStream(rgbCur,cb);
  return;
}



// ======================================================================
// Function: RgToStream
// Address: 1070:9554
// Segment: MEMORY_IO
// ======================================================================


void RgToStream(void *rg,ushort cb)

{
  ushort uVar1;
  char *sz;
  short mbType;
  
  if ((cb != 0) && (uVar1 = _lwrite(cb,rg,hf), uVar1 != cb)) {
    mbType = 0x10;
    sz = PszFormatIds(idsErrorWritingFile,(short *)0x0);
    AlertSz(sz,mbType);
    _longjmp(penvMem,-1);
  }
  return;
}



// ======================================================================
// Function: SetVisiblePlanFleet
// Address: 1070:95bc
// Segment: MEMORY_IO
// ======================================================================


void SetVisiblePlanFleet(short iPlr)

{
  SetVisPFInit(iPlr);
  if (iPlr == -1) {
    rgplr[0].cPlanet = game.cPlanMax;
  }
  else {
    if (iPlr != -1) {
      UpdateProgressGauge(-0x39f);
    }
    SetVisPFFleets(iPlr);
    if (iPlr != -1) {
      UpdateProgressGauge(-0x39f);
    }
    SetVisPFPlanets(iPlr);
    if (iPlr != -1) {
      UpdateProgressGauge(-0x39f);
    }
    SetVisPFThings(iPlr);
    SetVisPFFinish(iPlr);
  }
  return;
}



// ======================================================================
// Function: SetVisPFInit
// Address: 1070:9654
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10709e11) */

void SetVisPFInit(short iPlr)

{
  char *pcVar1;
  uint *puVar2;
  int *piVar3;
  uint uVar4;
  FLEET *pFVar5;
  uint uVar6;
  PLORD *pPVar7;
  short sVar8;
  THING *pTVar9;
  int iVar10;
  int iVar11;
  undefined2 uVar12;
  long lVar13;
  short iSteal;
  ushort grbitPlr;
  short raMajor;
  short i;
  short ifl;
  THING *lpth;
  FLEET *lpfl;
  short j;
  PLANET *lppl;
  ushort detNew;
  PLANET *lpplMac;
  undefined2 local_6;
  
  raMajor = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
  if (iPlr == -1) {
    grbitPlr = 0;
  }
  else {
    grbitPlr = 1 << ((byte)iPlr & 0x1f);
  }
  for (i = 0; i < game.cPlayer; i = i + 1) {
    *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
  }
  for (i = 0; i < game.cPlayer; i = i + 1) {
    if (((iPlr == -1) || (iPlr == i)) ||
       ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0)) {
      *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
      *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 7;
    }
    else {
      *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff;
    }
    *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) =
         *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xf000;
    *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
    *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) =
         *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xfff;
    for (j = 0; j < 0x10; j = j + 1) {
      if (((iPlr == -1) || (iPlr == i)) &&
         ((*(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) >> 9 & 1) == 0)) {
        *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
        *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xff00 | 7;
        uVar12 = *(undefined2 *)(i * 4 + 0x100);
        iVar10 = *(int *)(i * 4 + rglpshdef) + j * 0x93;
        *(undefined2 *)(iVar10 + 0x83) = 0;
        *(undefined2 *)(iVar10 + 0x85) = 0;
        pcVar1 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
        *pcVar1 = *pcVar1 + '\x01';
      }
      else {
        *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xfeff;
      }
    }
    for (j = 0; j < 10; j = j + 1) {
      if (((iPlr == -1) || (iPlr == i)) &&
         ((*(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) >> 9 & 1) == 0)) {
        *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
        *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xff00 | 7;
        uVar12 = *(undefined2 *)(i * 4 + 0x14e);
        iVar10 = *(int *)(i * 4 + rglpshdefSB) + j * 0x93;
        *(undefined2 *)(iVar10 + 0x83) = 0;
        *(undefined2 *)(iVar10 + 0x85) = 0;
        iVar10 = *(int *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
        puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
        *puVar2 = *puVar2 & 0xfff;
        puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
        *puVar2 = *puVar2 | iVar10 + 0x1000U & 0xf000;
      }
      else {
        *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xfeff;
      }
    }
  }
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_6 = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < lpplMac) {
    if ((iPlr == -1) || (iPlr == ((PLANET *)lppl)->iPlayer)) {
      ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfeff | 0x100;
      ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xff00 | 7;
      if (iPlr != -1) {
        piVar3 = (int *)((int)&rgplr[0].cPlanet + iPlr * 0xc0);
        *piVar3 = *piVar3 + 1;
      }
      if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) {
        iVar10 = ((PLANET *)lppl)->iPlayer * 4;
        uVar12 = *(undefined2 *)(iVar10 + 0x14e);
        iVar10 = *(int *)(iVar10 + rglpshdefSB) +
                 (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93;
        puVar2 = (uint *)(iVar10 + 0x83);
        uVar4 = *puVar2;
        *puVar2 = *puVar2 + 1;
        piVar3 = (int *)(iVar10 + 0x85);
        *piVar3 = *piVar3 + (uint)(0xfffe < uVar4);
      }
    }
    else {
      ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfeff;
    }
    lppl = (PLANET *)lppl + 1;
  }
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar5 = ((FLEET **)rglpfl)[ifl];
    iVar10 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar10,pFVar5);
    if ((pFVar5 == (FLEET *)0x0) && (iVar10 == 0)) break;
    *(uint *)((int)&pFVar5->dirLong + 2) = *(uint *)((int)&pFVar5->dirLong + 2) & 0xffef;
    pFVar5->wFlags_0x4 = pFVar5->wFlags_0x4 & 0x7fff;
    if (((iPlr == -1) || (iPlr == pFVar5->iPlayer)) && ((pFVar5->wFlags_0x4 >> 10 & 1) == 0)) {
      pFVar5->wFlags_0x4 = pFVar5->wFlags_0x4 & 0xfeff | 0x100;
      pFVar5->wFlags_0x4 = pFVar5->wFlags_0x4 & 0xff00 | 7;
      iSteal = *(int *)((int)&rgplr[0].wFlags_0x4 + pFVar5->iPlayer * 0xc0) + 1U & 0xfff;
      puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar5->iPlayer * 0xc0);
      *puVar2 = *puVar2 & 0xf000;
      puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar5->iPlayer * 0xc0);
      *puVar2 = *puVar2 | iSteal;
      for (j = 0; j < 0x10; j = j + 1) {
        if (pFVar5->rgcsh[j] != 0) {
          uVar6 = pFVar5->rgcsh[j];
          iSteal = (int)uVar6 >> 0xf;
          iVar11 = pFVar5->iPlayer * 4;
          uVar12 = *(undefined2 *)(iVar11 + 0x100);
          iVar11 = *(int *)(iVar11 + rglpshdef) + j * 0x93;
          puVar2 = (uint *)(iVar11 + 0x83);
          uVar4 = *puVar2;
          *puVar2 = *puVar2 + uVar6;
          piVar3 = (int *)(iVar11 + 0x85);
          *piVar3 = *piVar3 + iSteal + (uint)CARRY2(uVar4,uVar6);
        }
      }
      if ((iPlr != -1) && (pFVar5->idPlanet != -1)) {
        lppl = (PLANET *)
               CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets + pFVar5->idPlanet);
        sVar8 = GetCachedFleetScannerRange
                          ((FLEET *)CONCAT22(iVar10,pFVar5),(short *)0x0,(short *)0x0,&iSteal);
        if (sVar8 < 0) {
          detNew = 1;
        }
        else {
          detNew = 3;
        }
        if (1 < iSteal) {
          detNew = 4;
        }
        uVar12 = (undefined2)((ulong)lpfl >> 0x10);
        if (((((((FLEET *)lpfl)->wFlags_0x4 >> 0xd & 1) != 0) && (((PLANET *)lppl)->iPlayer == -1))
            && (pPVar7 = ((FLEET *)lpfl)->lpplord,
               (*(uint *)&((PLORD *)pPVar7)[2].iordMax & 0xf) == 3)) &&
           (lVar13 = CMineFromLpfl(lpfl), 0 < lVar13)) {
          detNew = 4;
        }
        MarkPlanet(lppl,iPlr,detNew);
      }
    }
    else {
      pFVar5->wFlags_0x4 = pFVar5->wFlags_0x4 & 0xfeff;
    }
  }
  pTVar9 = (THING *)lpThings + cThing;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < pTVar9) {
    if (lpth->idFull >> 0xd == 1) {
      if ((iPlr == -1) || (raMajor == 6)) {
        ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags =
             ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0x7fff | 0x8000;
        if ((*(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1)
            == 0) {
          *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) &
               0xfeff | 0x100;
          *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) &
               0xfff8 | 3;
        }
      }
      else {
        ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags =
             ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0x7fff;
      }
    }
    else if (lpth->idFull >> 0xd == 2) {
      ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags =
           ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0xdfff | (uint)(iPlr == -1) << 0xd;
    }
    else if (lpth->idFull >> 0xd == 3) {
      *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) =
           *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) & 0xffef | 0x10;
    }
    else if (((lpth->idFull >> 0xd == 0) &&
             ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) & grbitPlr) != 0)) &&
            ((*(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1
             ) == 0)) {
      *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfeff |
           0x100;
      *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 |
           3;
    }
    lpth = (THING *)lpth + 1;
  }
  return;
}



// ======================================================================
// Function: SetVisPFFleets
// Address: 1070:a100
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1070a8f0) */
/* WARNING: Removing unreachable block (ram,0x1070a90b) */
/* WARNING: Removing unreachable block (ram,0x1070aae0) */
/* WARNING: Removing unreachable block (ram,0x1070a412) */
/* WARNING: Removing unreachable block (ram,0x1070a711) */
/* WARNING: Removing unreachable block (ram,0x1070a4d8) */
/* WARNING: Removing unreachable block (ram,0x1070ab87) */
/* WARNING: Removing unreachable block (ram,0x1070a43a) */
/* WARNING: Removing unreachable block (ram,0x1070a53c) */
/* WARNING: Removing unreachable block (ram,0x1070a92e) */
/* WARNING: Removing unreachable block (ram,0x1070a94e) */
/* WARNING: Removing unreachable block (ram,0x1070a887) */
/* WARNING: Removing unreachable block (ram,0x1070a8a2) */

void SetVisPFFleets(short iPlr)

{
  uint *puVar1;
  FLEET *pFVar2;
  uint uVar3;
  ushort uVar4;
  int iVar5;
  THING *pTVar6;
  PLANET *pPVar7;
  int iVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar9;
  ulong uVar10;
  ulong uVar11;
  long lVar12;
  long lVar13;
  undefined2 uVar14;
  undefined2 uVar15;
  undefined2 uVar16;
  long lVar17;
  short pctDetect;
  short iSteal;
  short iRadPlanet;
  undefined4 lRadPlanet2;
  ushort grbitPlr;
  short dx;
  short iRadius;
  THING *lpthMac;
  undefined2 local_2e;
  short ifl;
  undefined4 lRadius2;
  THING *lpth;
  FLEET *lpfl;
  short j;
  PLANET *lppl;
  undefined4 d2;
  FLEET *lpfl2;
  short dy;
  short pctCloak;
  int pt;
  int local_a;
  PLANET *lpplMac;
  undefined2 local_6;
  
  uVar10 = CONCAT22(lRadPlanet2._2_2_,(undefined2)lRadPlanet2);
  uVar11 = CONCAT22(lRadius2._2_2_,(undefined2)lRadius2);
  lVar17 = CONCAT22(unaff_SI,unaff_DI);
  if (iPlr == -1) {
    grbitPlr = 0;
  }
  else {
    grbitPlr = 1 << ((byte)iPlr & 0x1f);
  }
  ifl = 0;
  do {
    if (cFleet <= ifl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pFVar2 = ((FLEET **)rglpfl)[ifl];
    iVar8 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar8,pFVar2);
    if ((pFVar2 == (FLEET *)0x0) && (iVar8 == 0)) {
      return;
    }
    if ((pFVar2->wFlags_0x4 >> 10 & 1) == 0) {
      lRadius2 = uVar11;
      lRadPlanet2 = uVar10;
      if (pFVar2->iPlayer == iPlr) {
        if (((pFVar2->wFlags_0x4 >> 0xc & 1) != 0) && (pFVar2->idPlanet != -1)) {
          MarkPlanet((PLANET *)
                     CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets + pFVar2->idPlanet),
                     iPlr,3);
          uVar11 = lRadius2;
          uVar10 = lRadPlanet2;
        }
        lRadius2 = uVar11;
        lRadPlanet2 = uVar10;
        iRadius = GetCachedFleetScannerRange(lpfl,&iRadPlanet,&pctDetect,&iSteal);
        if (0x7fff < (uint)iRadius) {
          iRadius = 0;
        }
        uVar10 = __aFulmul((long)iRadius,(long)iRadius);
        lRadius2 = uVar10;
        uVar10 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
        uVar9 = (undefined2)((ulong)lpfl >> 0x10);
        pt = (&((FLEET *)lpfl)->pt)->x;
        local_a = (((FLEET *)lpfl)->pt).y;
        for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar2 = ((FLEET **)rglpfl)[j];
          iVar8 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
          lpfl2 = (FLEET *)CONCAT22(iVar8,pFVar2);
          if ((pFVar2 == (FLEET *)0x0) && (iVar8 == 0)) break;
          if ((pFVar2->wFlags_0x4 >> 10 & 1) == 0) {
            if (((((iSteal & 1U) != 0) && (pt == (&pFVar2->pt)->x)) && (local_a == (pFVar2->pt).y))
               && (((pFVar2->wFlags_0x4 >> 8 & 1) == 0 || ((pFVar2->wFlags_0x4 & 0xff) < 4)))) {
              lRadPlanet2 = uVar10;
              MarkFleet((FLEET *)CONCAT22(iVar8,pFVar2),4);
              uVar10 = lRadPlanet2;
            }
            uVar9 = (undefined2)((ulong)lpfl2 >> 0x10);
            if ((((FLEET *)lpfl2)->wFlags_0x4 >> 8 & 1) == 0) {
              lRadPlanet2 = uVar10;
              dx = _abs(pt - (&((FLEET *)lpfl2)->pt)->x);
              uVar10 = lRadPlanet2;
              if (dx <= iRadius) {
                dy = _abs(local_a - (((FLEET *)lpfl2)->pt).y);
                uVar10 = lRadPlanet2;
                if (dy <= iRadius) {
                  uVar10 = __aFulmul((long)dy,(long)dy);
                  uVar9 = (undefined2)uVar10;
                  uVar11 = __aFulmul((long)dx,(long)dx);
                  lVar13 = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar9);
                  uVar10 = lRadPlanet2;
                  if ((lVar13 <= (long)lRadius2) &&
                     ((((FLEET *)lpfl2)->idPlanet == -1 || (lVar13 <= (long)lRadPlanet2)))) {
                    pctCloak = PctCloakFromLpfl(lpfl2);
                    if (pctDetect != 100) {
                      pctCloak = (pctCloak * pctDetect) / 100;
                    }
                    if (pctCloak == 0) {
                      MarkFleet(lpfl2,3);
                      uVar10 = lRadPlanet2;
                    }
                    else {
                      uVar15 = 0;
                      uVar14 = 100;
                      iVar8 = 100 - pctCloak;
                      iVar5 = iVar8 >> 0xf;
                      uVar16 = 0;
                      uVar9 = 100;
                      uVar10 = __aFulmul(lRadius2,(long)(100 - pctCloak));
                      uVar10 = __aFldiv(uVar10,CONCAT22(uVar16,uVar9));
                      uVar10 = __aFulmul(uVar10,CONCAT22(iVar5,iVar8));
                      lVar12 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                      uVar10 = lRadPlanet2;
                      if (lVar13 <= lVar12) {
                        if (((FLEET *)lpfl2)->idPlanet != -1) {
                          uVar15 = 0;
                          uVar14 = 100;
                          iVar8 = 100 - pctCloak;
                          iVar5 = iVar8 >> 0xf;
                          uVar16 = 0;
                          uVar9 = 100;
                          uVar10 = __aFulmul(lRadPlanet2,(long)(100 - pctCloak));
                          uVar10 = __aFldiv(uVar10,CONCAT22(uVar16,uVar9));
                          uVar10 = __aFulmul(uVar10,CONCAT22(iVar5,iVar8));
                          lVar12 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                          uVar10 = lRadPlanet2;
                          if (lVar12 < lVar13) goto LAB_1070_a2b2;
                        }
                        MarkFleet(lpfl2,3);
                        uVar10 = lRadPlanet2;
                      }
                    }
                  }
                }
              }
            }
          }
LAB_1070_a2b2:
        }
        lpthMac = (THING *)lpThings + cThing;
        local_2e = lpThings._2_2_;
        lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
        while (lRadPlanet2 = uVar10, (THING *)lpth < lpthMac) {
          if ((((iPlr != -1) &&
               ((((lpth->idFull >> 0xd == 0 || (lpth->idFull >> 0xd == 1)) ||
                 (lpth->idFull >> 0xd == 3)) || (lpth->idFull >> 0xd == 2)))) &&
              ((((uVar9 = (undefined2)((ulong)lpth >> 0x10), lpth->idFull >> 0xd != 0 ||
                 ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) & grbitPlr) == 0)) &&
                ((lpth->idFull >> 0xd != 3 ||
                 ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) >> 4 & 1) == 0)))) &&
               ((lpth->idFull >> 0xd != 1 ||
                (-1 < ((&((THING *)lpth)->u_THING_0x0006)->tht).ptDest.x)))))) &&
             ((lpth->idFull >> 0xd != 2 ||
              ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 0xd & 1) == 0)))) {
            dx = _abs(pt - (&((THING *)lpth)->pt)->x);
            dy = _abs(local_a - (((THING *)lpth)->pt).y);
            uVar10 = __aFulmul((long)dy,(long)dy);
            uVar4 = (ushort)uVar10;
            uVar11 = __aFulmul((long)dx,(long)dx);
            lVar13 = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar4);
            uVar10 = lRadPlanet2;
            if ((lVar13 <= (long)lRadius2) || (lpth->idFull >> 0xd == 0)) {
              pTVar6 = (THING *)lpth;
              uVar9 = (undefined2)((ulong)lpth >> 0x10);
              if (lpth->idFull >> 0xd == 1) {
                ((&pTVar6->u_THING_0x0006)->thp).wFlags =
                     ((&pTVar6->u_THING_0x0006)->thp).wFlags & 0x7fff | 0x8000;
IO_LThIncPlr:
                uVar10 = lRadPlanet2;
                if ((*(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0)
                     >> 8 & 1) == 0) {
                  *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
                       *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0)
                       & 0xfeff | 0x100;
                  *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
                       *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0)
                       & 0xfff8 | 3;
                }
              }
              else if (lpth->idFull >> 0xd == 3) {
                *(uint *)((int)&pTVar6->u_THING_0x0006 + 4) =
                     *(uint *)((int)&pTVar6->u_THING_0x0006 + 4) & 0xffef | 0x10;
              }
              else {
                if (lpth->idFull >> 0xd != 2) {
                  if ((((*(uint *)((int)&pTVar6->u_THING_0x0006 + 4) & grbitPlr) == 0) ||
                      ((long)lRadius2 < lVar13)) && ((long)lRadPlanet2 < lVar13)) {
                    lVar12 = __aFlshr(lVar17,uVar4);
                    if ((lVar12 < lVar13) &&
                       (uVar9 = (undefined2)((ulong)lpth >> 0x10), uVar10 = lRadPlanet2,
                       CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2),
                                ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags) < lVar13))
                    goto LAB_1070_a96d;
                  }
                  uVar9 = (undefined2)((ulong)lpth >> 0x10);
                  puVar1 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4);
                  *puVar1 = *puVar1 | grbitPlr;
                  puVar1 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8);
                  *puVar1 = *puVar1 | grbitPlr;
                  goto IO_LThIncPlr;
                }
                if ((*(uint *)((int)&pTVar6->u_THING_0x0006 + 2) & grbitPlr) == 0) {
                  lVar12 = __aFlshr(lVar17,uVar4);
                  if ((lVar12 < lVar13) && (uVar10 = lRadPlanet2, (long)lRadPlanet2 < lVar13))
                  goto LAB_1070_a96d;
                }
                uVar9 = (undefined2)((ulong)lpth >> 0x10);
                pTVar6 = (THING *)lpth;
                puVar1 = (uint *)((int)&pTVar6->u_THING_0x0006 + 2);
                *puVar1 = *puVar1 | grbitPlr;
                ((&pTVar6->u_THING_0x0006)->thp).wFlags =
                     ((&pTVar6->u_THING_0x0006)->thp).wFlags & 0xdfff | 0x2000;
                uVar10 = lRadPlanet2;
              }
            }
          }
LAB_1070_a96d:
          lpth = (THING *)lpth + 1;
        }
        uVar11 = lRadius2;
        if ((iSteal & 2U) != 0) {
          uVar9 = (undefined2)((ulong)lpfl >> 0x10);
          if (((FLEET *)lpfl)->idPlanet != -1) {
            MarkPlanet((PLANET *)
                       CONCAT22(lpPlanets._2_2_,
                                (PLANET *)lpPlanets + ((FLEET *)lpfl)->idPlanet),iPlr,4);
            uVar10 = lRadPlanet2;
            uVar11 = lRadius2;
          }
        }
        if (0 < iRadPlanet) {
          iRadius = iRadPlanet;
          lRadPlanet2 = uVar10;
          lRadius2 = uVar11;
          uVar11 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
          uVar9 = (undefined2)((ulong)lpfl >> 0x10);
          pt = (&((FLEET *)lpfl)->pt)->x;
          local_a = (((FLEET *)lpfl)->pt).y;
          lpplMac = (PLANET *)lpPlanets + cPlanet;
          local_6 = lpPlanets._2_2_;
          lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
          while (uVar10 = lRadPlanet2, (PLANET *)lppl < lpplMac) {
            uVar9 = (undefined2)((ulong)lppl >> 0x10);
            if (((((PLANET *)lppl)->wFlags_0x4 >> 8 & 1) == 0) ||
               ((((PLANET *)lppl)->wFlags_0x4 & 0xff) < 3)) {
              lRadius2 = uVar11;
              dx = _abs(((POINT *)rgptPlan + lppl->id)->x - pt);
              uVar11 = lRadius2;
              if (dx <= iRadius) {
                dy = _abs(*(int *)((int)&rgptPlan[0].y + lppl->id * 4) - local_a);
                uVar11 = lRadius2;
                if (dy <= iRadius) {
                  uVar10 = __aFulmul((long)dy,(long)dy);
                  uVar9 = (undefined2)uVar10;
                  uVar11 = __aFulmul((long)dx,(long)dx);
                  d2 = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar9);
                  uVar11 = lRadius2;
                  if (d2 <= (long)lRadius2) {
                    uVar9 = (undefined2)((ulong)lppl >> 0x10);
                    pPVar7 = (PLANET *)lppl;
                    if (((pPVar7->wFlags_0x4 >> 9 & 1) != 0) && (pPVar7->iPlayer != -1)) {
                      iVar8 = pPVar7->iPlayer * 4;
                      uVar16 = *(undefined2 *)(iVar8 + 0x14e);
                      iVar8 = *(int *)(iVar8 + rglpshdefSB) +
                              (*(uint *)&pPVar7->lStarbase & 0xf) * 0x93;
                      uVar3 = *(uint *)(iVar8 + 0x87);
                      iVar8 = *(int *)(iVar8 + 0x89);
                      if ((iVar8 < 1) && ((iVar8 < 0 || (uVar3 < 10000)))) {
                        uVar16 = 0;
                        uVar9 = 10000;
                        uVar10 = __aFulmul(lRadius2,CONCAT22(iVar8,uVar3));
                        lVar13 = __aFldiv(uVar10,CONCAT22(uVar16,uVar9));
                        if (lVar13 < d2) {
                          MarkPlanet(lppl,iPlr,2);
                          uVar11 = lRadius2;
                          goto LAB_1070_abc2;
                        }
                      }
                    }
                    MarkPlanet(lppl,iPlr,3);
                    uVar11 = lRadius2;
                  }
                }
              }
            }
LAB_1070_abc2:
            lppl = (PLANET *)lppl + 1;
          }
        }
      }
      else if ((((pFVar2->wFlags_0x4 >> 8 & 1) == 0) && (pFVar2->idPlanet != -1)) &&
              (((PLANET *)lpPlanets)[pFVar2->idPlanet].iPlayer == iPlr)) {
        MarkFleet((FLEET *)CONCAT22(iVar8,pFVar2),3);
        uVar11 = lRadius2;
        uVar10 = lRadPlanet2;
      }
    }
    ifl = ifl + 1;
  } while( true );
}



// ======================================================================
// Function: SetVisPFPlanets
// Address: 1070:abde
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1070b8e2) */
/* WARNING: Removing unreachable block (ram,0x1070b66c) */
/* WARNING: Removing unreachable block (ram,0x1070b379) */
/* WARNING: Removing unreachable block (ram,0x1070b3ea) */
/* WARNING: Removing unreachable block (ram,0x1070b1fe) */
/* WARNING: Removing unreachable block (ram,0x1070b3c7) */
/* WARNING: Removing unreachable block (ram,0x1070b35e) */
/* WARNING: Removing unreachable block (ram,0x1070b6ef) */
/* WARNING: Removing unreachable block (ram,0x1070b989) */
/* WARNING: Removing unreachable block (ram,0x1070ae4e) */
/* WARNING: Removing unreachable block (ram,0x1070ae76) */
/* WARNING: Removing unreachable block (ram,0x1070aefc) */
/* WARNING: Removing unreachable block (ram,0x1070af60) */

void SetVisPFPlanets(short iPlr)

{
  uint *puVar1;
  FLEET *pFVar2;
  uint uVar3;
  short sVar4;
  int iVar5;
  ushort uVar6;
  int iVar7;
  THING *pTVar8;
  PLANET *pPVar9;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar10;
  ulong uVar11;
  long lVar12;
  long lVar13;
  undefined2 uVar14;
  undefined2 uVar15;
  short rgStargateRange [16];
  ushort grbitPlr;
  PLANET *lpplMac2;
  undefined2 local_42;
  undefined4 l;
  short dx;
  short fStargateView;
  short iRadius;
  THING *lpthMac;
  undefined2 local_34;
  short i;
  undefined4 lRadius2;
  THING *lpth;
  short j;
  PLANET *lppl;
  undefined4 d2;
  FLEET *lpfl2;
  short dy;
  PLANET *lppl2;
  short pctCloak;
  int pt;
  int local_10;
  PLANET *lpplMac;
  undefined2 local_c;
  short iRadPlanet;
  undefined4 lRadPlanet2;
  
  lVar13 = CONCAT22(unaff_SI,unaff_DI);
  if (iPlr == -1) {
    grbitPlr = 0;
  }
  else {
    grbitPlr = 1 << ((byte)iPlr & 0x1f);
  }
  fStargateView = 0;
  sVar4 = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
  if (sVar4 == raStargate) {
    for (i = 0; i < 10; i = i + 1) {
      rgStargateRange[i] = 0;
      if ((*(uint *)(*(int *)(iPlr * 4 + rglpshdefSB) + i * 0x93 + 0x7b) >> 9 & 1) == 0) {
        sVar4 = StargateRangeFromLppl((PLANET *)0x0,iPlr,i);
        rgStargateRange[i] = sVar4;
        if (0 < sVar4) {
          fStargateView = 1;
        }
      }
    }
  }
  if (iPlr != -1) {
    UpdateProgressGauge(-0x39f);
  }
  uVar10 = CONCAT22(lRadPlanet2._2_2_,(undefined2)lRadPlanet2);
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_c = lpPlanets._2_2_;
  do {
    lRadPlanet2 = uVar10;
    if (lpplMac <= (PLANET *)lppl) {
      if (iPlr != -1) {
        UpdateProgressGauge(-0x39f);
        uVar10 = lRadPlanet2;
      }
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      lpplMac = (PLANET *)lpPlanets + cPlanet;
      local_c = lpPlanets._2_2_;
      do {
        lRadPlanet2 = uVar10;
        if (lpplMac <= (PLANET *)lppl) {
          if (iPlr != -1) {
            UpdateProgressGauge(-0x39f);
            uVar10 = lRadPlanet2;
          }
          lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
          lpplMac = (PLANET *)lpPlanets + cPlanet;
          local_c = lpPlanets._2_2_;
          do {
            lRadPlanet2 = uVar10;
            if (lpplMac <= (PLANET *)lppl) {
              if (iPlr != -1) {
                UpdateProgressGauge(-0x39f);
                uVar10 = lRadPlanet2;
              }
              lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
              lpplMac = (PLANET *)lpPlanets + cPlanet;
              local_c = lpPlanets._2_2_;
              do {
                if (lpplMac <= (PLANET *)lppl) {
                  return;
                }
                if (((PLANET *)lppl)->iPlayer == iPlr) {
                  lRadPlanet2 = uVar10;
                  iRadius = GetPlanetScannerRange(lppl,&iRadPlanet);
                  uVar10 = __aFulmul((long)iRadius,(long)iRadius);
                  lRadius2 = uVar10;
                  uVar10 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
                  pt = ((POINT *)rgptPlan + lppl->id)->x;
                  local_10 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
                  if (0 < iRadPlanet) {
                    iRadius = iRadPlanet;
                    lpplMac2 = (PLANET *)lpPlanets + cPlanet;
                    local_42 = lpPlanets._2_2_;
                    lppl2 = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
                    lRadius2 = uVar10;
                    while ((PLANET *)lppl2 < lpplMac2) {
                      uVar14 = (undefined2)((ulong)lppl2 >> 0x10);
                      if (((((PLANET *)lppl2)->wFlags_0x4 >> 8 & 1) == 0) ||
                         ((((PLANET *)lppl2)->wFlags_0x4 & 0xff) < 3)) {
                        lRadPlanet2 = uVar10;
                        dx = _abs(((POINT *)rgptPlan + lppl2->id)->x - pt);
                        uVar10 = lRadPlanet2;
                        if (dx <= iRadius) {
                          dy = _abs(*(int *)((int)&rgptPlan[0].y + lppl2->id * 4)
                                            - local_10);
                          uVar10 = lRadPlanet2;
                          if (dy <= iRadius) {
                            uVar10 = __aFulmul((long)dy,(long)dy);
                            uVar14 = (undefined2)uVar10;
                            uVar11 = __aFulmul((long)dx,(long)dx);
                            d2 = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar14);
                            uVar10 = lRadPlanet2;
                            if (d2 <= (long)lRadius2) {
                              uVar14 = (undefined2)((ulong)lppl2 >> 0x10);
                              pPVar9 = (PLANET *)lppl2;
                              if (((pPVar9->wFlags_0x4 >> 9 & 1) != 0) && (pPVar9->iPlayer != -1)) {
                                iVar5 = pPVar9->iPlayer * 4;
                                uVar15 = *(undefined2 *)(iVar5 + 0x14e);
                                iVar5 = *(int *)(iVar5 + rglpshdefSB) +
                                        (*(uint *)&pPVar9->lStarbase & 0xf) * 0x93;
                                uVar3 = *(uint *)(iVar5 + 0x87);
                                iVar5 = *(int *)(iVar5 + 0x89);
                                if ((iVar5 < 1) && ((iVar5 < 0 || (uVar3 < 10000)))) {
                                  uVar15 = 0;
                                  uVar14 = 10000;
                                  uVar10 = __aFulmul(lRadius2,CONCAT22(iVar5,uVar3));
                                  lVar13 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                                  if (lVar13 < d2) {
                                    MarkPlanet(lppl2,iPlr,2);
                                    uVar10 = lRadPlanet2;
                                    goto LAB_1070_b9c4;
                                  }
                                }
                              }
                              MarkPlanet(lppl2,iPlr,3);
                              uVar10 = lRadPlanet2;
                            }
                          }
                        }
                      }
LAB_1070_b9c4:
                      lppl2 = (PLANET *)lppl2 + 1;
                    }
                  }
                }
                lppl = (PLANET *)lppl + 1;
              } while( true );
            }
            if (((PLANET *)lppl)->iPlayer == iPlr) {
              iRadius = GetPlanetScannerRange(lppl,&iRadPlanet);
              uVar10 = __aFulmul((long)iRadius,(long)iRadius);
              lRadius2 = uVar10;
              uVar10 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
              lRadPlanet2 = uVar10;
              pt = ((POINT *)rgptPlan + lppl->id)->x;
              local_10 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
              if (fStargateView != 0) {
                uVar14 = (undefined2)((ulong)lppl >> 0x10);
                pPVar9 = (PLANET *)lppl;
                if (((pPVar9->wFlags_0x4 >> 9 & 1) != 0) &&
                   (0 < rgStargateRange[*(uint *)&pPVar9->lStarbase & 0xf])) {
                  iRadius = rgStargateRange[*(uint *)&pPVar9->lStarbase & 0xf];
                  uVar10 = __aFulmul((long)iRadius,(long)iRadius);
                  lpplMac2 = (PLANET *)lpPlanets + cPlanet;
                  local_42 = lpPlanets._2_2_;
                  lppl2 = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
                  lRadius2 = uVar10;
                  uVar10 = lRadPlanet2;
                  while ((PLANET *)lppl2 < lpplMac2) {
                    uVar14 = (undefined2)((ulong)lppl2 >> 0x10);
                    if ((((((PLANET *)lppl2)->wFlags_0x4 >> 8 & 1) == 0) ||
                        ((((PLANET *)lppl2)->wFlags_0x4 & 0xff) < 3)) &&
                       ((((PLANET *)lppl2)->wFlags_0x4 >> 9 & 1) != 0)) {
                      lRadPlanet2 = uVar10;
                      sVar4 = StargateRangeFromLppl(lppl2,0,0);
                      uVar10 = lRadPlanet2;
                      if (sVar4 != 0) {
                        if (9999 < iRadius) goto IO_LMarkStargate;
                        dx = _abs(((POINT *)rgptPlan + lppl2->id)->x - pt);
                        uVar10 = lRadPlanet2;
                        if (dx <= iRadius) {
                          dy = _abs(*(int *)((int)&rgptPlan[0].y + lppl2->id * 4)
                                            - local_10);
                          uVar10 = lRadPlanet2;
                          if (dy <= iRadius) {
                            uVar10 = __aFulmul((long)dy,(long)dy);
                            uVar14 = (undefined2)uVar10;
                            uVar11 = __aFulmul((long)dx,(long)dx);
                            d2 = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar14);
                            uVar10 = lRadPlanet2;
                            if (d2 <= (long)lRadius2) {
                              uVar15 = (undefined2)((ulong)lppl2 >> 0x10);
                              iVar5 = ((PLANET *)lppl2)->iPlayer * 4;
                              uVar14 = *(undefined2 *)(iVar5 + 0x14e);
                              iVar5 = *(int *)(iVar5 + rglpshdefSB) +
                                      (*(uint *)&((PLANET *)lppl2)->lStarbase & 0xf) * 0x93;
                              uVar3 = *(uint *)(iVar5 + 0x87);
                              iVar5 = *(int *)(iVar5 + 0x89);
                              if ((iVar5 < 1) && ((iVar5 < 0 || (uVar3 < 10000)))) {
                                uVar15 = 0;
                                uVar14 = 10000;
                                uVar10 = __aFulmul(lRadius2,CONCAT22(iVar5,uVar3));
                                lVar13 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                                uVar10 = lRadPlanet2;
                                if (lVar13 < d2) goto LAB_1070_b70c;
                              }
IO_LMarkStargate:
                              MarkPlanet(lppl2,iPlr,3);
                              uVar10 = lRadPlanet2;
                            }
                          }
                        }
                      }
                    }
LAB_1070_b70c:
                    lppl2 = (PLANET *)lppl2 + 1;
                  }
                }
              }
            }
            lppl = (PLANET *)lppl + 1;
          } while( true );
        }
        if (((PLANET *)lppl)->iPlayer == iPlr) {
          iRadius = GetPlanetScannerRange(lppl,&iRadPlanet);
          uVar10 = __aFulmul((long)iRadius,(long)iRadius);
          lRadius2 = uVar10;
          uVar10 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
          pt = ((POINT *)rgptPlan + lppl->id)->x;
          local_10 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
          lpthMac = (THING *)lpThings + cThing;
          local_34 = lpThings._2_2_;
          lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
          while ((THING *)lpth < lpthMac) {
            if ((((iPlr != -1) &&
                 ((((lpth->idFull >> 0xd == 0 || (lpth->idFull >> 0xd == 1)) ||
                   ((lpth->idFull >> 0xd == 3 || (lpth->idFull >> 0xd == 2)))) &&
                  ((uVar14 = (undefined2)((ulong)lpth >> 0x10), lpth->idFull >> 0xd != 0 ||
                   ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) & grbitPlr) == 0)))))) &&
                ((lpth->idFull >> 0xd != 3 ||
                 ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) >> 4 & 1) == 0)))) &&
               (((lpth->idFull >> 0xd != 1 ||
                 (-1 < ((&((THING *)lpth)->u_THING_0x0006)->tht).ptDest.x)) &&
                ((lpth->idFull >> 0xd != 2 ||
                 ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 0xd & 1) == 0)))))) {
              lRadPlanet2 = uVar10;
              dx = _abs(pt - (&((THING *)lpth)->pt)->x);
              uVar10 = lRadPlanet2;
              if (dx <= iRadius) {
                dy = _abs(local_10 - (((THING *)lpth)->pt).y);
                uVar10 = lRadPlanet2;
                if (dy <= iRadius) {
                  uVar10 = __aFulmul((long)dy,(long)dy);
                  uVar6 = (ushort)uVar10;
                  uVar11 = __aFulmul((long)dx,(long)dx);
                  l = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar6);
                  uVar10 = lRadPlanet2;
                  if (l <= (long)lRadius2) {
                    pTVar8 = (THING *)lpth;
                    uVar14 = (undefined2)((ulong)lpth >> 0x10);
                    if (lpth->idFull >> 0xd == 1) {
                      ((&pTVar8->u_THING_0x0006)->thp).wFlags =
                           ((&pTVar8->u_THING_0x0006)->thp).wFlags & 0x7fff | 0x8000;
IO_LThIncPlr2:
                      uVar10 = lRadPlanet2;
                      if ((*(uint *)((int)&rgplr[0].wMdPlr +
                                    (lpth->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1) == 0) {
                        *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0
                                 ) = *(uint *)((int)&rgplr[0].wMdPlr +
                                              (lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfeff | 0x100;
                        *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0
                                 ) = *(uint *)((int)&rgplr[0].wMdPlr +
                                              (lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 | 3;
                      }
                    }
                    else if (lpth->idFull >> 0xd == 3) {
                      *(uint *)((int)&pTVar8->u_THING_0x0006 + 4) =
                           *(uint *)((int)&pTVar8->u_THING_0x0006 + 4) & 0xffef | 0x10;
                    }
                    else {
                      if (lpth->idFull >> 0xd != 2) {
                        if (((*(uint *)((int)&pTVar8->u_THING_0x0006 + 4) & grbitPlr) == 0) &&
                           ((long)lRadPlanet2 < l)) {
                          lVar12 = __aFlshr(lVar13,uVar6);
                          uVar10 = lRadPlanet2;
                          if (lVar12 < l) goto LAB_1070_b409;
                        }
                        uVar14 = (undefined2)((ulong)lpth >> 0x10);
                        puVar1 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4);
                        *puVar1 = *puVar1 | grbitPlr;
                        puVar1 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8);
                        *puVar1 = *puVar1 | grbitPlr;
                        goto IO_LThIncPlr2;
                      }
                      if ((*(uint *)((int)&pTVar8->u_THING_0x0006 + 2) & grbitPlr) == 0) {
                        lVar12 = __aFlshr(lVar13,uVar6);
                        if ((lVar12 < l) && (uVar10 = lRadPlanet2, (long)lRadPlanet2 < l))
                        goto LAB_1070_b409;
                      }
                      uVar14 = (undefined2)((ulong)lpth >> 0x10);
                      pTVar8 = (THING *)lpth;
                      puVar1 = (uint *)((int)&pTVar8->u_THING_0x0006 + 2);
                      *puVar1 = *puVar1 | grbitPlr;
                      ((&pTVar8->u_THING_0x0006)->thp).wFlags =
                           ((&pTVar8->u_THING_0x0006)->thp).wFlags & 0xdfff | 0x2000;
                      uVar10 = lRadPlanet2;
                    }
                  }
                }
              }
            }
LAB_1070_b409:
            lpth = (THING *)lpth + 1;
          }
        }
        lppl = (PLANET *)lppl + 1;
      } while( true );
    }
    if (((PLANET *)lppl)->iPlayer == iPlr) {
      iRadius = GetPlanetScannerRange(lppl,&iRadPlanet);
      uVar10 = __aFulmul((long)iRadius,(long)iRadius);
      lRadius2 = uVar10;
      uVar10 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
      pt = ((POINT *)rgptPlan + lppl->id)->x;
      local_10 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
      for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar2 = ((FLEET **)rglpfl)[j];
        iVar5 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
        lpfl2 = (FLEET *)CONCAT22(iVar5,pFVar2);
        if ((pFVar2 == (FLEET *)0x0) && (iVar5 == 0)) break;
        if (((pFVar2->wFlags_0x4 >> 8 & 1) == 0) && ((pFVar2->wFlags_0x4 >> 10 & 1) == 0)) {
          lRadPlanet2 = uVar10;
          dx = _abs(pt - (&pFVar2->pt)->x);
          uVar10 = lRadPlanet2;
          if (dx <= iRadius) {
            dy = _abs(local_10 - (((FLEET *)lpfl2)->pt).y);
            uVar10 = lRadPlanet2;
            if (dy <= iRadius) {
              uVar10 = __aFulmul((long)dy,(long)dy);
              uVar14 = (undefined2)uVar10;
              uVar11 = __aFulmul((long)dx,(long)dx);
              l = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar14);
              uVar10 = lRadPlanet2;
              if ((l <= (long)lRadius2) &&
                 ((((FLEET *)lpfl2)->idPlanet == -1 || (l <= (long)lRadPlanet2)))) {
                pctCloak = PctCloakFromLpfl(lpfl2);
                if (pctCloak == 0) {
                  MarkFleet(lpfl2,3);
                  uVar10 = lRadPlanet2;
                }
                else {
                  uVar15 = 0;
                  uVar14 = 100;
                  iVar5 = 100 - pctCloak;
                  iVar7 = iVar5 >> 0xf;
                  lVar12 = 100;
                  uVar10 = __aFulmul(lRadius2,(long)(100 - pctCloak));
                  uVar10 = __aFldiv(uVar10,lVar12);
                  uVar10 = __aFulmul(uVar10,CONCAT22(iVar7,iVar5));
                  lVar12 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                  uVar10 = lRadPlanet2;
                  if (l <= lVar12) {
                    if (((FLEET *)lpfl2)->idPlanet != -1) {
                      uVar15 = 0;
                      uVar14 = 100;
                      iVar5 = 100 - pctCloak;
                      iVar7 = iVar5 >> 0xf;
                      lVar12 = 100;
                      uVar10 = __aFulmul(lRadPlanet2,(long)(100 - pctCloak));
                      uVar10 = __aFldiv(uVar10,lVar12);
                      uVar10 = __aFulmul(uVar10,CONCAT22(iVar7,iVar5));
                      lVar12 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                      uVar10 = lRadPlanet2;
                      if (lVar12 < l) goto LAB_1070_ad5d;
                    }
                    MarkFleet(lpfl2,3);
                    uVar10 = lRadPlanet2;
                  }
                }
              }
            }
          }
        }
LAB_1070_ad5d:
      }
    }
    lppl = (PLANET *)lppl + 1;
  } while( true );
}



// ======================================================================
// Function: SetVisPFThings
// Address: 1070:b9ee
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1070c0f0) */
/* WARNING: Removing unreachable block (ram,0x1070bc7d) */
/* WARNING: Removing unreachable block (ram,0x1070c3b9) */
/* WARNING: Removing unreachable block (ram,0x1070bbf7) */
/* WARNING: Removing unreachable block (ram,0x1070be5c) */
/* WARNING: Removing unreachable block (ram,0x1070bfb4) */
/* WARNING: Removing unreachable block (ram,0x1070c197) */

void SetVisPFThings(short iPlr)

{
  uint *puVar1;
  int iVar2;
  int iVar3;
  FLEET *pFVar4;
  uint uVar5;
  short sVar6;
  int iVar7;
  int iVar8;
  uint uVar9;
  uint uVar10;
  short sVar11;
  THING *pTVar12;
  THING *pTVar13;
  PLANET *pPVar14;
  int iVar15;
  int iVar16;
  undefined2 uVar17;
  undefined2 uVar18;
  ulong uVar19;
  ulong uVar20;
  long lVar21;
  ulong uVar22;
  ulong uVar23;
  undefined2 uVar24;
  undefined2 uVar25;
  THING *lpth2;
  long l__44;
  ushort grbitPlr;
  short dx;
  short iRadius;
  THING *lpth;
  short j;
  FLEET *lpfl2;
  short dy;
  short pctCloak;
  
  if (iPlr == -1) {
    uVar5 = 0;
  }
  else {
    uVar5 = 1 << ((byte)iPlr & 0x1f);
  }
  sVar6 = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
  if (sVar6 == raMassAccel) {
    pTVar12 = (THING *)lpThings + cThing;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < pTVar12) {
      uVar18 = (undefined2)((ulong)lpth >> 0x10);
      if (((lpth->idFull >> 0xd == 1) && ((lpth->idFull >> 9 & 0xf) == iPlr)) &&
         ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) != 0)) {
        ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags =
             ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0x7fff | 0x8000;
        iVar7 = (((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) + 4;
        iVar7 = iVar7 * iVar7;
        uVar22 = __aFulmul((long)iVar7,(long)iVar7);
        iVar2 = (&((THING *)lpth)->pt)->x;
        iVar3 = (((THING *)lpth)->pt).y;
        for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar4 = ((FLEET **)rglpfl)[j];
          iVar16 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
          if ((pFVar4 == (FLEET *)0x0) && (iVar16 == 0)) break;
          if ((((pFVar4->wFlags_0x4 >> 8 & 1) == 0) &&
              (((pFVar4->wFlags_0x4 >> 10 & 1) == 0 &&
               (sVar6 = _abs(iVar2 - (&pFVar4->pt)->x), sVar6 <= iVar7)))) &&
             (sVar11 = _abs(iVar3 - (pFVar4->pt).y), sVar11 <= iVar7)) {
            uVar23 = __aFulmul((long)sVar11,(long)sVar11);
            uVar19 = __aFulmul((long)sVar6,(long)sVar6);
            if ((long)(uVar19 + uVar23) <= (long)uVar22) {
              sVar6 = PctCloakFromLpfl((FLEET *)CONCAT22(iVar16,pFVar4));
              if (sVar6 == 0) {
                MarkFleet((FLEET *)CONCAT22(iVar16,pFVar4),3);
              }
              else {
                uVar24 = 0;
                uVar17 = 100;
                iVar8 = 100 - sVar6;
                iVar15 = iVar8 >> 0xf;
                lVar21 = 100;
                uVar20 = __aFulmul(uVar22,(long)(100 - sVar6));
                uVar20 = __aFldiv(uVar20,lVar21);
                uVar20 = __aFulmul(uVar20,CONCAT22(iVar15,iVar8));
                lVar21 = __aFldiv(uVar20,CONCAT22(uVar24,uVar17));
                if ((long)(uVar19 + uVar23) <= lVar21) {
                  MarkFleet((FLEET *)CONCAT22(iVar16,pFVar4),3);
                }
              }
            }
          }
        }
        pTVar13 = (THING *)lpThings + cThing;
        lpth2 = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
        while ((THING *)lpth2 < pTVar13) {
          if (((iPlr != -1) &&
              ((((lpth2->idFull >> 0xd == 0 || (lpth2->idFull >> 0xd == 1)) ||
                (lpth2->idFull >> 0xd == 3)) || (lpth2->idFull >> 0xd == 2)))) &&
             ((((lpth2->idFull >> 0xd != 0 ||
                ((*(uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 8) & uVar5) == 0)) &&
               ((lpth2->idFull >> 0xd != 3 ||
                ((*(uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 4) >> 4 & 1) == 0)))) &&
              ((((lpth2->idFull >> 0xd != 1 ||
                 (-1 < ((&((THING *)lpth2)->u_THING_0x0006)->tht).ptDest.x)) &&
                ((lpth2->idFull >> 0xd != 2 ||
                 ((((&((THING *)lpth2)->u_THING_0x0006)->thp).wFlags >> 0xd & 1) == 0)))) &&
               ((sVar6 = _abs(iVar2 - (&((THING *)lpth2)->pt)->x), sVar6 <= iVar7 &&
                (sVar11 = _abs(iVar3 - (((THING *)lpth2)->pt).y), sVar11 <= iVar7)))))))) {
            uVar23 = __aFulmul((long)sVar11,(long)sVar11);
            uVar19 = __aFulmul((long)sVar6,(long)sVar6);
            if ((long)(uVar19 + uVar23) <= (long)uVar22) {
              if (lpth2->idFull >> 0xd == 1) {
                ((&((THING *)lpth2)->u_THING_0x0006)->thp).wFlags =
                     ((&((THING *)lpth2)->u_THING_0x0006)->thp).wFlags & 0x7fff | 0x8000;
IO_LThIncPlr3:
                if ((*(uint *)((int)&rgplr[0].wMdPlr + (lpth2->idFull >> 9 & 0xf) * 0xc0)
                     >> 8 & 1) == 0) {
                  *(uint *)((int)&rgplr[0].wMdPlr + (lpth2->idFull >> 9 & 0xf) * 0xc0) =
                       *(uint *)((int)&rgplr[0].wMdPlr + (lpth2->idFull >> 9 & 0xf) * 0xc0
                                ) & 0xfeff | 0x100;
                  *(uint *)((int)&rgplr[0].wMdPlr + (lpth2->idFull >> 9 & 0xf) * 0xc0) =
                       *(uint *)((int)&rgplr[0].wMdPlr + (lpth2->idFull >> 9 & 0xf) * 0xc0
                                ) & 0xfff8 | 3;
                }
              }
              else if (lpth2->idFull >> 0xd == 3) {
                *(uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 4) =
                     *(uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 4) & 0xffef | 0x10;
              }
              else {
                if (lpth2->idFull >> 0xd != 2) {
                  puVar1 = (uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 4);
                  *puVar1 = *puVar1 | uVar5;
                  puVar1 = (uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 8);
                  *puVar1 = *puVar1 | uVar5;
                  goto IO_LThIncPlr3;
                }
                if (((*(uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 2) & uVar5) != 0) ||
                   ((long)(uVar19 + uVar23) <= (long)uVar22)) {
                  puVar1 = (uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 2);
                  *puVar1 = *puVar1 | uVar5;
                  ((&((THING *)lpth2)->u_THING_0x0006)->thp).wFlags =
                       ((&((THING *)lpth2)->u_THING_0x0006)->thp).wFlags & 0xdfff | 0x2000;
                }
              }
            }
          }
          lpth2 = (THING *)lpth2 + 1;
        }
        pPVar14 = (PLANET *)lpPlanets + cPlanet;
        l__44 = CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
        while ((PLANET *)l__44 < pPVar14) {
          uVar17 = (undefined2)((ulong)l__44 >> 0x10);
          if (((((((PLANET *)l__44)->wFlags_0x4 >> 8 & 1) == 0) ||
               ((((PLANET *)l__44)->wFlags_0x4 & 0xff) < 3)) &&
              (sVar6 = _abs(((POINT *)rgptPlan + *(int *)l__44)->x - iVar2),
              sVar6 <= iVar7)) &&
             (sVar11 = _abs(*(int *)((int)&rgptPlan[0].y + *(int *)l__44 * 4) -
                                    iVar3), sVar11 <= iVar7)) {
            uVar23 = __aFulmul((long)sVar11,(long)sVar11);
            uVar19 = __aFulmul((long)sVar6,(long)sVar6);
            if ((long)(uVar19 + uVar23) <= (long)uVar22) {
              if (((((PLANET *)l__44)->wFlags_0x4 >> 9 & 1) != 0) &&
                 (((PLANET *)l__44)->iPlayer != -1)) {
                iVar16 = ((PLANET *)l__44)->iPlayer * 4;
                uVar24 = *(undefined2 *)(iVar16 + 0x14e);
                iVar16 = *(int *)(iVar16 + rglpshdefSB) +
                         (*(uint *)&((PLANET *)l__44)->lStarbase & 0xf) * 0x93;
                uVar9 = *(uint *)(iVar16 + 0x87);
                iVar16 = *(int *)(iVar16 + 0x89);
                if ((iVar16 < 1) && ((iVar16 < 0 || (uVar9 < 10000)))) {
                  uVar25 = 0;
                  uVar24 = 10000;
                  uVar20 = __aFulmul(uVar22,CONCAT22(iVar16,uVar9));
                  lVar21 = __aFldiv(uVar20,CONCAT22(uVar25,uVar24));
                  if (lVar21 < (long)(uVar19 + uVar23)) {
                    MarkPlanet((PLANET *)l__44,iPlr,2);
                    goto LAB_1070_c1d2;
                  }
                }
              }
              MarkPlanet((PLANET *)l__44,iPlr,3);
            }
          }
LAB_1070_c1d2:
          l__44 = CONCAT22(uVar17,(PLANET *)l__44 + 1);
        }
      }
      lpth = (THING *)CONCAT22(uVar18,(THING *)lpth + 1);
    }
  }
  else {
    sVar6 = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
    if (sVar6 == raMines) {
      pTVar12 = (THING *)lpThings + cThing;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      while ((THING *)lpth < pTVar12) {
        uVar18 = (undefined2)((ulong)lpth >> 0x10);
        if ((lpth->idFull >> 0xd == 0) && ((lpth->idFull >> 9 & 0xf) == iPlr)) {
          uVar5 = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags;
          iVar2 = *(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
          iVar3 = (&((THING *)lpth)->pt)->x;
          iVar7 = (((THING *)lpth)->pt).y;
          for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
            pFVar4 = ((FLEET **)rglpfl)[j];
            iVar16 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
            if ((pFVar4 == (FLEET *)0x0) && (iVar16 == 0)) break;
            if (((pFVar4->wFlags_0x4 >> 8 & 1) == 0) &&
               (((pFVar4->wFlags_0x4 >> 10 & 1) == 0 && (pFVar4->idPlanet == -1)))) {
              uVar9 = _abs(iVar3 - (&pFVar4->pt)->x);
              if (((int)uVar9 >> 0xf <= iVar2) && (((int)uVar9 >> 0xf < iVar2 || (uVar9 <= uVar5))))
              {
                uVar10 = _abs(iVar7 - (pFVar4->pt).y);
                if (((int)uVar10 >> 0xf <= iVar2) &&
                   (((int)uVar10 >> 0xf < iVar2 || (uVar10 <= uVar5)))) {
                  uVar22 = __aFulmul((long)(int)uVar10,(long)(int)uVar10);
                  uVar23 = __aFulmul((long)(int)uVar9,(long)(int)uVar9);
                  if (((long)(uVar23 + uVar22) <= CONCAT22(iVar2,uVar5)) &&
                     ((sVar6 = PctCloakFromLpfl((FLEET *)CONCAT22(iVar16,pFVar4)), sVar6 == 0
                      || (sVar11 = Random(100), sVar6 <= sVar11)))) {
                    MarkFleet((FLEET *)CONCAT22(iVar16,pFVar4),3);
                  }
                }
              }
            }
          }
        }
        lpth = (THING *)CONCAT22(uVar18,(THING *)lpth + 1);
      }
    }
  }
  return;
}



// ======================================================================
// Function: SetVisPFFinish
// Address: 1070:c41c
// Segment: MEMORY_IO
// ======================================================================


void SetVisPFFinish(short iPlr)

{
  char *pcVar1;
  uint *puVar2;
  int iVar3;
  short sVar4;
  uint uVar5;
  short i;
  short j;
  short detMajor;
  
  sVar4 = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
  if (sVar4 == raAttack) {
    uVar5 = 7;
  }
  else {
    uVar5 = 3;
  }
  i = 0;
  do {
    if (game.cPlayer <= i) {
      return;
    }
    if (i != iPlr) {
      *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
      for (j = 0; j < 0x10; j = j + 1) {
        if ((1 << ((byte)iPlr & 0x1f) & *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x8b)) ==
            0) {
          if ((*(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) >> 8 & 1) != 0) {
            *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) =
                 *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xff00 | uVar5;
            goto IO_LFinShdef;
          }
        }
        else {
          *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) =
               *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
          *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) =
               *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xff00 | 7;
IO_LFinShdef:
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 3;
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
          pcVar1 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
          *pcVar1 = *pcVar1 + '\x01';
        }
      }
      *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xfff;
      for (j = 0; j < 10; j = j + 1) {
        if ((1 << ((byte)iPlr & 0x1f) & *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x8b))
            == 0) {
          if ((*(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) >> 8 & 1) != 0) {
            *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) =
                 *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xff00 | uVar5;
            goto IO_LFinShdefSB;
          }
        }
        else {
          *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) =
               *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
          *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) =
               *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xff00 | 7;
IO_LFinShdefSB:
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 3;
          iVar3 = *(int *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
          puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
          *puVar2 = *puVar2 & 0xfff;
          puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
          *puVar2 = *puVar2 | iVar3 + 0x1000U & 0xf000;
        }
      }
    }
    i = i + 1;
  } while( true );
}



