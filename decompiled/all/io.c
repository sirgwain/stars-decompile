// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: FReadShDef
// Address: 1070:0006
// Segment: MEMORY_IO
// ======================================================================


short FReadShDef(RTSHDEF *lprt,SHDEF *lpshdef,short iplrLoad)

{
  byte *pbVar1;
  SHDEF *pSVar2;
  SHDEF *pSVar3;
  HULDEF *pHVar4;
  int iVar5;
  RTSHDEF *pRVar6;
  HS *pHVar7;
  SHDEF *pSVar8;
  SHDEF *pSVar9;
  undefined2 uVar10;
  undefined2 unaff_SS;
  HULDEF *pHVar11;
  PART part;
  HUL *lphul;
  short c;
  ulong wt;
  HUL *lphulBase;
  short fOkay;
  short cch;
  short ishdef;
  byte *lpb;
  SHDEF shdef;
  char szTemp [40];
  
  _memset(&shdef,0,0x93);
  uVar10 = (undefined2)((ulong)lprt >> 0x10);
  pRVar6 = (RTSHDEF *)lprt;
  shdef.hul.ihuldef = (HullDef)pRVar6->ihuldef;
  shdef.wFlags = lprt->wFlags;
  shdef.hul.chs = pRVar6->chs;
  shdef.hul.ibmp = (short)pRVar6->ibmp;
  if ((shdef.wFlags & 0xffU) == 7) {
    shdef.hul.dp = pRVar6->wtEmpty;
    shdef.turn = pRVar6->turn;
    shdef.cBuilt._0_2_ = (undefined2)pRVar6->cBuilt;
    shdef.cBuilt._2_2_ = *(undefined2 *)((int)&pRVar6->cBuilt + 2);
    shdef.cExist._0_2_ = (undefined2)pRVar6->cExist;
    shdef.cExist._2_2_ = *(undefined2 *)((int)&pRVar6->cExist + 2);
    lpb = (byte *)CONCAT22(uVar10,pRVar6 + 1);
    __fmemmove((HS *)CONCAT22(unaff_SS,shdef.hul.rghs),
                       (RTSHDEF *)CONCAT22(uVar10,pRVar6 + 1),(uint)pRVar6->chs << 2);
    lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + (uint)pRVar6->chs * 4);
  }
  else {
    shdef.hul.wtEmpty = pRVar6->wtEmpty;
    lpb = (byte *)CONCAT22(uVar10,&pRVar6->chs);
  }
  pHVar11 = LphuldefFromId(shdef.hul.ihuldef);
  fOkay = (((HULDEF *)pHVar11)->hul).ibmp;
  if ((shdef.hul.ibmp < fOkay) || ((int)(fOkay + 4U) <= shdef.hul.ibmp)) {
    shdef.hul.ibmp = shdef.hul.ibmp & 3U | fOkay;
  }
  cch = (short)*lpb;
  pbVar1 = (byte *)lpb + 1;
  lpb = (byte *)CONCAT22(lpb._2_2_,pbVar1);
  if (cch == 0) {
    __fstrcpy((char *)CONCAT22(unaff_SS,shdef.hul.szClass),
                      (char *)CONCAT22(lpb._2_2_,pbVar1));
  }
  else {
    fOkay = 0x20;
    if (0x20 < (uint)cch) {
      return 0;
    }
    __fmemmove((char *)CONCAT22(unaff_SS,szTemp),(byte *)CONCAT22(lpb._2_2_,pbVar1),cch);
    FDecompressUserString
              ((char *)CONCAT22(unaff_SS,szTemp),cch,(char *)CONCAT22(unaff_SS,shdef.hul.szClass),
               &fOkay);
  }
  ishdef = (uint)shdef.wFlags >> 10 & 0x1f;
  if (0xf < (uint)ishdef) {
    ishdef = ishdef - 0x10;
  }
  if ((((shdef.wFlags & 0xffU) == 7) || (((uint)((SHDEF *)lpshdef)[ishdef].wFlags >> 9 & 1) != 0))
     || ((((SHDEF *)lpshdef)[ishdef].wFlags & 0xffU) < 7)) {
    pSVar9 = (SHDEF *)lpshdef + ishdef;
    pSVar8 = &shdef;
    for (iVar5 = 0x49; iVar5 != 0; iVar5 = iVar5 + -1) {
      pSVar3 = pSVar9;
      pSVar9 = (SHDEF *)(pSVar9->hul).rgTech;
      pSVar2 = pSVar8;
      pSVar8 = (SHDEF *)(pSVar8->hul).rgTech;
      (pSVar3->hul).ihuldef = (pSVar2->hul).ihuldef;
    }
    *(char *)&(pSVar9->hul).ihuldef = (char)(pSVar8->hul).ihuldef;
  }
  else if ((shdef.hul.ihuldef != (((SHDEF *)lpshdef + ishdef)->hul).ihuldef) ||
          (shdef.hul.ibmp != ((SHDEF *)lpshdef)[ishdef].hul.ibmp)) {
    pSVar9 = (SHDEF *)lpshdef + ishdef;
    pSVar8 = &shdef;
    for (iVar5 = 0x49; iVar5 != 0; iVar5 = iVar5 + -1) {
      pSVar3 = pSVar9;
      pSVar9 = (SHDEF *)(pSVar9->hul).rgTech;
      pSVar2 = pSVar8;
      pSVar8 = (SHDEF *)(pSVar8->hul).rgTech;
      (pSVar3->hul).ihuldef = (pSVar2->hul).ihuldef;
    }
    *(char *)&(pSVar9->hul).ihuldef = (char)(pSVar8->hul).ihuldef;
  }
  if (idPlayer != -1) {
    UpdateShdefCost((SHDEF *)CONCAT22(lpshdef._2_2_,(SHDEF *)lpshdef + ishdef));
  }
  if ((((SHDEF *)lpshdef)[ishdef].wFlags & 0xffU) == 7) {
    pSVar8 = (SHDEF *)lpshdef + ishdef;
    lphul = (HUL *)CONCAT22(lpshdef._2_2_,pSVar8);
    pHVar11 = LphuldefFromId(lphul->ihuldef);
    uVar10 = (undefined2)((ulong)pHVar11 >> 0x10);
    pHVar4 = (HULDEF *)pHVar11;
    wt._0_2_ = (pHVar4->hul).wtEmpty;
    for (c = 0; c < (int)(uint)(pSVar8->hul).chs; c = c + 1) {
      if ((uint)(pSVar8->hul).rghs[c].wFlags >> 8 != 0) {
        pHVar7 = (pSVar8->hul).rghs + c;
        part.hs.grhst = pHVar7->grhst;
        part.hs.wFlags = pHVar7->wFlags;
        fOkay = FLookupPart(&part);
        if (idPlayer == -1) {
          fOkay = 0;
        }
        if ((((part.hs.grhst & ((pHVar4->hul).rghs + c)->grhst) ==
              ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|
                hstMines|hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine))
            || ((1 < fOkay && (-1 < shdef.wFlags)))) ||
           ((uint)(pHVar4->hul).rghs[c].wFlags >> 8 < (uint)part.hs.wFlags >> 8)) {
          (pSVar8->hul).rghs[c].wFlags = (pSVar8->hul).rghs[c].wFlags & 0xff;
        }
        wt._0_2_ = (int)wt + ((COMPART *)part.pcom)->cMass *
                             ((uint)(pSVar8->hul).rghs[c].wFlags >> 8);
      }
      if (((c == 0) && ((uint)(pSVar8->hul).rghs[0].wFlags >> 8 == 0)) &&
         (((pHVar4->hul).rghs)->grhst == hstEngine)) {
        ((pSVar8->hul).rghs)->grhst = hstEngine;
        (pSVar8->hul).rghs[0].wFlags = (pSVar8->hul).rghs[0].wFlags & 0xff00U | 1;
        (pSVar8->hul).rghs[0].wFlags =
             (pSVar8->hul).rghs[0].wFlags & 0xffU | (pHVar4->hul).rghs[0].wFlags & 0xff00U;
        part.hs.grhst = ((pSVar8->hul).rghs)->grhst;
        part.hs.wFlags = (pSVar8->hul).rghs[0].wFlags;
        FLookupPart(&part);
        wt._0_2_ = (int)wt + ((COMPART *)part.pcom)->cMass *
                             ((uint)(pSVar8->hul).rghs[0].wFlags >> 8);
      }
    }
    (pSVar8->hul).wtEmpty = (int)wt;
  }
  return 1;
}



// ======================================================================
// Function: ReadRtPlr
// Address: 1070:05e2
// Segment: MEMORY_IO
// ======================================================================


void ReadRtPlr(PLAYER *pplr,byte *pbIn)

{
  ushort uVar1;
  short cOut_2;
  PLAYER *pplrRaw;
  short iOff;
  
  pplrRaw = (PLAYER *)pbIn;
  _memset(pplr,0,0xc0);
  if ((pplrRaw->wMdPlr & 7U) == 7) {
    _memmove(pplr,pbIn,0x70);
    _memmove(pplr->rgmdRelation,pbIn + 0x71,(uint)pbIn[0x70]);
    iOff = pbIn[0x70] + 0x71;
  }
  else {
    _memmove(pplr,pbIn,8);
    iOff = 8;
  }
  if (pbIn[iOff] == 0) {
    _strcpy(pplr->szName,(char *)(pbIn + iOff + 1));
    uVar1 = _strlen(pplr->szName);
    iOff = iOff + uVar1 + 2;
  }
  else {
    cOut_2 = 0x20;
    FDecompressUserString
              ((char *)CONCAT22((undefined1 *)&DAT_1120_1120,pbIn + iOff + 1),(uint)pbIn[iOff],
               (char *)CONCAT22((undefined1 *)&DAT_1120_1120,pplr->szName),&cOut_2);
    iOff = iOff + pbIn[iOff] + 1;
  }
  if ((wVersFile >> 5 & 0x7f) < 0x37) {
    cOut_2 = (short)PszPlayerName(0,(byte)((undefined *)&DAT_1120_175f)[pplr->szName[0]] & 1,1
                                        ,0,0,pplr);
    _strcpy(pplr->szNames,(char *)cOut_2);
  }
  else if (pbIn[iOff] == 0) {
    _strcpy(pplr->szNames,(char *)(pbIn + iOff + 1));
  }
  else {
    cOut_2 = 0x20;
    FDecompressUserString
              ((char *)CONCAT22((undefined1 *)&DAT_1120_1120,pbIn + iOff + 1),(uint)pbIn[iOff],
               (char *)CONCAT22((undefined1 *)&DAT_1120_1120,pplr->szNames),&cOut_2);
  }
  pplr->wFlags = pplr->wFlags & 0xfff7;
  return;
}



// ======================================================================
// Function: FLoadGame
// Address: 1070:0810
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10702da2) */
/* WARNING: Removing unreachable block (ram,0x10701634) */
/* WARNING: Removing unreachable block (ram,0x10702d82) */
/* WARNING: Removing unreachable block (ram,0x10702da7) */
/* WARNING: Variable defined which should be unmapped: szEntry */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short FLoadGame(char *pszFileName,char *pszExt)

{
  int *piVar1;
  uint *puVar2;
  char *pcVar3;
  short *psVar4;
  GAME *pGVar5;
  char *pcVar6;
  SCOREX *pSVar7;
  byte bVar8;
  int iVar9;
  byte *pbVar10;
  byte *pbVar11;
  undefined4 uVar12;
  undefined4 uVar13;
  undefined4 uVar14;
  undefined4 uVar15;
  undefined4 uVar16;
  FLEET **ppFVar17;
  short sVar18;
  short sVar19;
  FLEET *pFVar20;
  short sVar21;
  ushort uVar22;
  int iVar23;
  PLANET *pPVar24;
  THING *pTVar25;
  PLANET *pPVar26;
  undefined2 uVar27;
  undefined2 unaff_SI;
  char *pcVar28;
  char *pcVar29;
  FLEET **ppFVar30;
  short *psVar31;
  SCOREX *pSVar32;
  undefined2 unaff_DI;
  GAME *pGVar33;
  SCOREX *pSVar34;
  undefined2 uVar35;
  undefined2 unaff_SS;
  PLANET *pPVar36;
  PL *pPVar37;
  FLEET *lpfl_00;
  void *pvVar38;
  SCOREX *pSVar39;
  THING *pTVar40;
  BTLPLAN *pBVar41;
  long lVar42;
  ulong uVar43;
  ulong uVar44;
  char szEntry [16];
  char *psz;
  char szSection [16];
  char szIniFile [16];
  char szT [256];
  int iStack_48;
  short grf;
  short dt;
  PLANET *lpplMac;
  short j;
  short iPlayer;
  THING *lpthMac;
  short cturn;
  short env [9];
  FLEET *lpfl;
  THING *lpth;
  short i;
  PLANET *lppl;
  short fSilentSav;
  short (*penvMemSav) [9];
  short fHaveHistoryData;
  short cPlanetAlloc;
  STARPACK sp;
  short cPlanetHist;
  short iplrSav;
  
  uVar44 = CONCAT22(unaff_SI,unaff_DI);
  grf = 0;
  cturn = 0;
  _strcpy((char *)szBase,pszFileName);
  gd._4_2_ = gd._4_2_ & 0xfbff;
  penvMem = env;
  sVar18 = __setjmp(env);
  uVar13._2_1_ = szT[0xfe];
  uVar13._3_1_ = szT[0xff];
  uVar13._0_1_ = szT[0xfc];
  uVar13._1_1_ = szT[0xfd];
  if (sVar18 == 0) {
    sVar18 = FOpenFile(dtXY,-1,0x20);
    uVar13._2_1_ = szT[0xfe];
    uVar13._3_1_ = szT[0xff];
    uVar13._0_1_ = szT[0xfc];
    uVar13._1_1_ = szT[0xfd];
    if (sVar18 != 0) {
      ReadRt();
      if ((uint)hdrCur.wFlags >> 10 == 7) {
        pcVar28 = (char *)rgbCur;
        pGVar33 = (GAME *)&game;
        for (iVar23 = 0x20; iVar23 != 0; iVar23 = iVar23 + -1) {
          pGVar5 = pGVar33;
          pGVar33 = (GAME *)((int)&pGVar33->lid + 2);
          pcVar3 = pcVar28;
          pcVar28 = pcVar28 + 2;
          *(undefined2 *)&pGVar5->lid = *(undefined2 *)pcVar3;
        }
        game.fDirty = 0;
        dGal = game.mdSize * 400 + 400;
        dGalInv = game.mdSize * 400 + 0x960;
        iStack_48 = 1000;
        for (i = 0; i < game.cPlanMax; i = i + 1) {
          RgFromStream((STARPACK *)CONCAT22(unaff_SS,&sp),4);
          iStack_48 = iStack_48 + ((uint)sp.dwFlags & 0x3ff);
          ((POINT *)rgptPlan + i)->x = iStack_48;
          uVar43 = __aFulshr(uVar44,szEntry._0_2_);
          *(uint *)((int)&rgptPlan[0].y + i * 4) = (uint)uVar43 & 0xfff;
          uVar43 = __aFulshr(uVar44,szEntry._0_2_);
          ((short *)rgidPlan)[i] = (uint)uVar43 & 0x3ff;
          if (((dGal + 1000 <= iStack_48) ||
              (dGal + 1000 <= *(int *)((int)&rgptPlan[0].y + i * 4))) ||
             (999 < ((short *)rgidPlan)[i])) goto IO_XYCorrupt;
        }
        ReadRt();
        if ((uint)hdrCur.wFlags >> 10 == 0) {
          StreamClose();
          if (((*pszExt == 'h') || (*pszExt == 'H')) && ((pszExt[1] == 's' || (pszExt[1] == 'S'))))
          {
            dt = 2;
            iPlayer = -1;
          }
          else {
            dt = 3;
            grf = 0x3000;
            sVar18 = _atoi(pszExt + 1);
            iPlayer = sVar18 + -1;
          }
          ResetMessages();
          _memset((PLAYER *)rgplr,0,game.cPlayer * 0xc0);
          ResetHb(htShips);
          sVar18 = fFileErrSilent;
          uVar14._2_1_ = szT[0xfe];
          uVar14._3_1_ = szT[0xff];
          uVar14._0_1_ = szT[0xfc];
          uVar14._1_1_ = szT[0xfd];
          idPlayer = iPlayer;
          fFileErrSilent = 1;
          if (iPlayer == -1) {
IO_LNoHistFile:
            cPlanetHist = 0;
            szT._252_4_ = uVar14;
            FreeLp(lpPlanets,htPlanets);
            lpPlanets._0_2_ = (PLANET *)0x0;
            lpPlanets._2_2_ = 0;
            cThing = 0;
            FreeLp(lpThings,htThings);
            lpThings = (THING *)0x0;
          }
          else {
            sVar19 = FOpenFile(dtHist,iPlayer,0x20);
            uVar14._2_1_ = szT[0xfe];
            uVar14._3_1_ = szT[0xff];
            uVar14._0_1_ = szT[0xfc];
            uVar14._1_1_ = szT[0xfd];
            if (sVar19 == 0) goto IO_LNoHistFile;
            ReadRt();
            uVar35 = rgbCur._0_2_;
            vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
            lpThings = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
            szT._252_4_ = (byte *)CONCAT22(szT._254_2_,szT._252_2_);
            if ((uint)hdrCur.wFlags >> 10 != 0x20) {
IO_CorruptHist:
              StreamClose();
              sVar19 = 0x10;
              pcVar28 = PszFormatIds(idsHistoryFileAppearsCorruptHistoricalDataWill,
                                          (short *)0x0);
              AlertSz(pcVar28,sVar19);
              uVar14 = szT._252_4_;
              goto IO_LNoHistFile;
            }
            cPlanetHist._0_1_ = rgbCur[0];
            cPlanetHist._1_1_ = rgbCur[1];
            cPlanetAlloc = rgbCur._0_2_ + rgbCur._2_2_;
            if (1000 < cPlanetAlloc) {
              cPlanetAlloc = 1000;
            }
            iVar23 = cPlanetAlloc;
            if (cPlanetAlloc < 1) {
              iVar23 = 1;
            }
            lpPlanets = LpAlloc(iVar23 * 0x38,htPlanets);
            ReadRt();
            i = 0;
            lppl = lpPlanets;
            while( true ) {
              if ((int)uVar35 <= i) break;
              if ((uint)hdrCur.wFlags >> 10 != 0xe) goto IO_CorruptHist;
              sVar19 = FReadPlanet(iPlayer,lppl,1,0);
              if (sVar19 == 0) goto IO_CorruptHist;
              if (((PLANET *)lppl)->iPlayer == iPlayer) {
                ((PLANET *)lppl)->iPlayer = -1;
                ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xff00U | 3;
              }
              ReadRt();
              i = i + 1;
              lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
            }
            if ((uint)hdrCur.wFlags >> 10 == 0x21) {
              vlpbAiData =
                   (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
              lpThings = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
              szT._252_4_ = (byte *)CONCAT22(szT._254_2_,szT._252_2_);
              if ((uint)cbbitfMsg < (hdrCur.wFlags & 0x3ffU)) goto IO_CorruptHist;
              _memcpy((byte *)bitfMsgFiltered,(char *)rgbCur,
                              hdrCur.wFlags & 0x3ff);
              ReadRt();
            }
            while ((uint)hdrCur.wFlags >> 10 == 6) {
              iVar23 = (int)rgbCur[0];
              ReadRtPlr((PLAYER *)rgplr + iVar23,(byte *)rgbCur);
              *(undefined2 *)((int)&rgplr[0].cPlanet + iVar23 * 0xc0) = 0;
              szT._254_2_ = *(uint *)((int)&rgplr[0].wFlags + iVar23 * 0xc0) & 0xf000;
              *(uint *)((int)&rgplr[0].wFlags + iVar23 * 0xc0) = szT._254_2_;
              ReadRt();
            }
            i = 0;
            while ((uint)hdrCur.wFlags >> 10 == 0x1a) {
              for (; (*(char *)((int)&rgplr[0].cShDef + i * 0xc0) == '\0' &&
                     (i < game.cPlayer)); i = i + 1) {
              }
              if (i == game.cPlayer) break;
              if ((*(int *)(i * 4 + 0xfe) == 0) && (*(int *)(i * 4 + 0x100) == 0)) {
                pvVar38 = LpAlloc(0x930,htShips);
                *(undefined2 *)(i * 4 + 0xfe) = (void *)pvVar38;
                *(undefined2 *)(i * 4 + 0x100) = (int)((ulong)pvVar38 >> 0x10);
                for (j = 0; j < 0x10; j = j + 1) {
                  szT._254_2_ = *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfdff | 0x200
                  ;
                  *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) = szT._254_2_;
                  *(undefined2 *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x8b) = 0;
                }
              }
              sVar19 = idPlayer;
              if (idPlayer == -1) {
                idPlayer = i;
              }
              else {
                idPlayer = -1;
              }
              sVar21 = FReadShDef((RTSHDEF *)rgbCur,
                                  (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x100),
                                                    (SHDEF *)*(undefined2 *)(i * 4 + 0xfe)),sVar19);
              vlpbAiData =
                   (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
              lpThings = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
              szT._252_4_ = (byte *)CONCAT22(szT._254_2_,szT._252_2_);
              if (sVar21 == 0) goto IO_CorruptHist;
              pcVar3 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
              idPlayer = sVar19;
              *pcVar3 = *pcVar3 + -1;
              ReadRt();
            }
            i = 0;
            while ((uint)hdrCur.wFlags >> 10 == 0x1a) {
              for (; (*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 0xc == 0 &&
                     (i < game.cPlayer)); i = i + 1) {
              }
              if (i == game.cPlayer) break;
              if ((*(int *)(i * 4 + 0x14c) == 0) && (*(int *)(i * 4 + 0x14e) == 0)) {
                pvVar38 = LpAlloc(0x5be,htShips);
                *(undefined2 *)(i * 4 + 0x14c) = (void *)pvVar38;
                *(undefined2 *)(i * 4 + 0x14e) = (int)((ulong)pvVar38 >> 0x10);
                for (j = 0; j < 10; j = j + 1) {
                  szT._254_2_ = *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfdff |
                                0x200;
                  *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) = szT._254_2_;
                  *(undefined2 *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x8b) = 0;
                }
              }
              sVar19 = idPlayer;
              if (idPlayer == -1) {
                idPlayer = i;
              }
              else {
                idPlayer = -1;
              }
              sVar21 = FReadShDef((RTSHDEF *)rgbCur,
                                  (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x14e),
                                                    (SHDEF *)*(undefined2 *)(i * 4 + 0x14c)),sVar19)
              ;
              vlpbAiData =
                   (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
              lpThings = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
              szT._252_4_ = (byte *)CONCAT22(szT._254_2_,szT._252_2_);
              if (sVar21 == 0) goto IO_CorruptHist;
              szT._254_2_ = *(int *)((int)&rgplr[0].wFlags + i * 0xc0) - 0x1000U & 0xf000;
              puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
              idPlayer = sVar19;
              *puVar2 = *puVar2 & 0xfff;
              puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
              *puVar2 = *puVar2 | szT._254_2_;
              ReadRt();
            }
            while( true ) {
              pbVar11 = (byte *)CONCAT22(szT._254_2_,szT._252_2_);
              pbVar10 = (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
              if ((uint)hdrCur.wFlags >> 10 != 0x2d) break;
              szT[0xfe] = (char)(rgbCur._0_2_ & 0x1f);
              szT[0xff] = (char)((rgbCur._0_2_ & 0x1f) >> 8);
              pcVar29 = (char *)rgbCur;
              pcVar28 = szT + 0xe6;
              for (iVar23 = 0xc; iVar23 != 0; iVar23 = iVar23 + -1) {
                pcVar6 = pcVar28;
                pcVar28 = pcVar28 + 2;
                pcVar3 = pcVar29;
                pcVar29 = pcVar29 + 2;
                *(undefined2 *)pcVar6 = *(undefined2 *)pcVar3;
              }
              if ((((SCOREX **)rgsxPlr)[szT._254_2_ * 2] == (SCOREX *)0x0) &&
                 (*(int *)((undefined *)&DAT_1120_156e + szT._254_2_ * 4) == 0)) {
                pSVar39 = LpAlloc(0x978,htMisc);
                ((SCOREX **)rgsxPlr)[szT._254_2_ * 2] = (SCOREX *)pSVar39;
                *(int *)((undefined *)&DAT_1120_156e + szT._254_2_ * 4) =
                     (int)((ulong)pSVar39 >> 0x10);
                ((short *)rgcsxPlr)[szT._254_2_] = 0;
              }
              if ((((SCOREX **)rgsxPlr)[szT._254_2_ * 2] != (SCOREX *)0x0) ||
                 (*(int *)((undefined *)&DAT_1120_156e + szT._254_2_ * 4) != 0)) {
                if ((int)szT._230_2_ < 0) {
                  szT[0xe2] = szT[0xe8];
                  szT[0xe3] = szT[0xe9];
                }
                else {
                  szT[0xe2] = (undefined1)game.turn;
                  szT[0xe3] = game.turn._1_1_;
                }
                szT[0xe4] = '\0';
                szT[0xe5] = '\0';
                while (((int)szT._228_2_ < ((short *)rgcsxPlr)[szT._254_2_] &&
                       ((uint)((SCOREX **)rgsxPlr)[szT._254_2_ * 2][szT._228_2_].iRank <
                        (uint)szT._226_2_))) {
                  szT._228_2_ = szT._228_2_ + 1;
                }
                if ((((int)szT._228_2_ < ((short *)rgcsxPlr)[szT._254_2_]) &&
                    (szT._226_2_ != ((SCOREX **)rgsxPlr)[szT._254_2_ * 2][szT._228_2_].iRank)
                    ) || (100 < (int)szT._228_2_)) {
                  if (((short *)rgcsxPlr)[szT._254_2_] < 0x65) {
                    __fmemmove((SCOREX *)
                                       CONCAT22(*(undefined2 *)
                                                 ((undefined *)&DAT_1120_156e + szT._254_2_ * 4),
                                                ((SCOREX **)rgsxPlr)[szT._254_2_ * 2] +
                                                szT._228_2_ + 1),
                                       (SCOREX *)
                                       CONCAT22(*(undefined2 *)
                                                 ((undefined *)&DAT_1120_156e + szT._254_2_ * 4),
                                                ((SCOREX **)rgsxPlr)[szT._254_2_ * 2] +
                                                szT._228_2_),
                                       (((short *)rgcsxPlr)[szT._254_2_] - szT._228_2_) *
                                       0x18);
                    ((short *)rgcsxPlr)[szT._254_2_] =
                         ((short *)rgcsxPlr)[szT._254_2_] + 1;
                  }
                  else if (0 < (int)szT._228_2_) {
                    if (1 < (int)szT._228_2_) {
                      __fmemmove((SCOREX *)
                                         CONCAT22(*(undefined2 *)
                                                   ((undefined *)&DAT_1120_156e + szT._254_2_ * 4),
                                                  ((SCOREX **)rgsxPlr)[szT._254_2_ * 2]),
                                         (SCOREX *)
                                         CONCAT22(*(undefined2 *)
                                                   ((undefined *)&DAT_1120_156e + szT._254_2_ * 4),
                                                  ((SCOREX **)rgsxPlr)[szT._254_2_ * 2] + 1),
                                         (szT._228_2_ + -1) * 0x18);
                    }
                    szT._228_2_ = szT._228_2_ + -1;
                  }
                }
                else if (szT._228_2_ == ((short *)rgcsxPlr)[szT._254_2_]) {
                  ((short *)rgcsxPlr)[szT._254_2_] =
                       ((short *)rgcsxPlr)[szT._254_2_] + 1;
                }
                uVar35 = *(undefined2 *)((undefined *)&DAT_1120_156e + szT._254_2_ * 4);
                pSVar32 = ((SCOREX **)rgsxPlr)[szT._254_2_ * 2] + szT._228_2_;
                psVar31 = (short *)(szT + 0xe6);
                for (iVar23 = 0xc; iVar23 != 0; iVar23 = iVar23 + -1) {
                  pSVar39 = pSVar32;
                  pSVar32 = (SCOREX *)&pSVar32->iRank;
                  psVar4 = psVar31;
                  psVar31 = psVar31 + 1;
                  pSVar39->wWord = *psVar4;
                }
                ((SCOREX **)rgsxPlr)[szT._254_2_ * 2][szT._228_2_].iRank = szT._226_2_;
                szT._224_2_ = (((SCOREX **)rgsxPlr)[szT._254_2_ * 2] + szT._228_2_)->wWord &
                              0x7fffU | 0x8000;
                (((SCOREX **)rgsxPlr)[szT._254_2_ * 2] + szT._228_2_)->wWord = szT._224_2_;
              }
              ReadRt();
            }
            if ((uint)hdrCur.wFlags >> 10 == 0x29) {
              if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 9 & 1) ==
                  0) {
                while( true ) {
                  pbVar11 = (byte *)CONCAT22(szT._254_2_,szT._252_2_);
                  pbVar10 = (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
                  if ((uint)hdrCur.wFlags >> 10 != 0x29) break;
                  ReadRt();
                }
              }
              else {
                vlpbAiData =
                     (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
                pbVar11 = (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
                if (((byte *)vlpbAiData == (byte *)0x0) &&
                   (vlpbAiData = pbVar10, pbVar11 = pbVar10, vlpbAiData._2_2_ == 0)) {
                  vlpbAiData = LpAlloc(0x1fa0,htMisc);
                  pbVar11 = vlpbAiData;
                  if (vlpbAiData == (byte *)0x0) goto IO_CorruptHist;
                }
                while (pbVar10 = vlpbAiData, (uint)hdrCur.wFlags >> 10 == 0x29) {
                  szT._252_4_ = pbVar11;
                  __fmemmove(pbVar11,rgbCur,hdrCur.wFlags & 0x3ff);
                  szT._252_2_ = szT._252_2_ + (hdrCur.wFlags & 0x3ffU);
                  ReadRt();
                  pbVar11 = (byte *)CONCAT22(szT._254_2_,szT._252_2_);
                }
              }
            }
            if ((uint)hdrCur.wFlags >> 10 == 0x2b) {
              cThing._0_1_ = rgbCur[0];
              cThing._1_1_ = rgbCur[1];
              cThingAlloc = rgbCur._0_2_ + 10;
              if (0xfd2 < cThingAlloc) {
                cThingAlloc = 0xfd2;
              }
              vlpbAiData = pbVar10;
              szT._252_4_ = pbVar11;
              lpThings = LpAlloc(cThingAlloc * 0x12,htThings);
              if (lpThings == (THING *)0x0) goto IO_CorruptHist;
              __fmemset(lpThings,0,cThingAlloc * 0x12);
              ReadRt();
              lpth = lpThings;
              pbVar11 = (byte *)szT._252_4_;
              for (i = 0; pbVar10 = vlpbAiData, i < cThing; i = i + 1) {
                szT._252_4_ = pbVar11;
                if ((uint)hdrCur.wFlags >> 10 != 0x2b) goto IO_CorruptHist;
                __fmemcpy(lpth,rgbCur,hdrCur.wFlags & 0x3ff);
                ReadRt();
                lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
                pbVar11 = (byte *)szT._252_4_;
              }
            }
            vlpbAiData = pbVar10;
            szT._252_4_ = pbVar11;
            StreamClose();
          }
          fFileErrSilent = sVar18;
          GetFileStatus(dt,iPlayer);
          sVar18 = FOpenFile(dt | grf,iPlayer,0x20);
          uVar13 = szT._252_4_;
          if (sVar18 != 0) {
            if (iPlayer == -1) {
              szT._252_4_ = CONCAT22((uint)rgbCur._14_2_ >> 0xb,szT._252_2_) & 0x1ffff;
              gd.wFlags =
                   gd.wFlags & 0xfffeU | (uint)rgbCur._14_2_ >> 0xb & 1;
            }
            do {
              cturn = cturn + 1;
              cPlanet = 0;
              cFleet = 0;
              ReadRt();
              while (((uint)hdrCur.wFlags >> 10 == 0x1f ||
                     ((uint)hdrCur.wFlags >> 10 == 0x27))) {
                if ((uint)hdrCur.wFlags >> 10 != 0x27) {
                  if (lpbBattleLog == (byte *)0x0) {
                    lpbBattleCur = LpAlloc(0xffc8,htBattle);
                    lpbBattleLog = lpbBattleCur;
                  }
                  if (((byte *)lpbBattleCur < (byte *)0xffc9) &&
                     (-(int)(byte *)lpbBattleCur - 0x38U < (uint)rgbCur._6_2_)) {
                    pbVar10 = lpbBattleCur;
                    pbVar10[0] = 0xff;
                    pbVar10[1] = 0xff;
                    lpbBattleCur = LpAlloc(0xffc8,htBattle);
                  }
                }
                __fmemmove(lpbBattleCur,rgbCur,
                                   hdrCur.wFlags & 0x3ff);
                lpbBattleCur =
                     (byte *)CONCAT22(lpbBattleCur._2_2_,
                                      (byte *)lpbBattleCur +
                                      (hdrCur.wFlags & 0x3ff));
                ReadRt();
              }
              if ((((byte *)lpbBattleCur != (byte *)0x0) || (lpbBattleCur._2_2_ != 0))
                 && (pbVar10 = lpbBattleCur, pbVar10[0] = 0xff, pbVar10[1] = 0xff,
                    (wVersFile >> 5 & 0x7f) < 0x50)) {
                UpdateBattleRecords();
              }
              while ((uint)hdrCur.wFlags >> 10 == 6) {
                iVar23 = (int)rgbCur[0];
                ReadRtPlr((PLAYER *)rgplr + iVar23,(byte *)rgbCur);
                cPlanet =
                     cPlanet + *(int *)((int)&rgplr[0].cPlanet + iVar23 * 0xc0);
                *(undefined2 *)((int)&rgplr[0].cPlanet + iVar23 * 0xc0) = 0;
                cFleet =
                     cFleet +
                     (*(uint *)((int)&rgplr[0].wFlags + iVar23 * 0xc0) & 0xfff);
                szT._254_2_ = *(uint *)((int)&rgplr[0].wFlags + iVar23 * 0xc0) & 0xf000;
                *(uint *)((int)&rgplr[0].wFlags + iVar23 * 0xc0) = szT._254_2_;
                ReadRt();
              }
              if (dt == 2) {
                if ((uint)hdrCur.wFlags >> 10 == 0x24) {
                  lSaltCur._0_1_ = rgbCur[0];
                  lSaltCur._1_1_ = rgbCur[1];
                  lSaltCur._2_1_ = rgbCur[2];
                  lSaltCur._3_1_ = rgbCur[3];
                  ReadRt();
                }
                else {
                  lSaltCur._0_1_ = '\0';
                  lSaltCur._1_1_ = '\0';
                  lSaltCur._2_1_ = '\0';
                  lSaltCur._3_1_ = '\0';
                }
              }
              else {
                lSaltCur._0_2_ =
                     *(undefined2 *)(char *)((int)&rgplr[0].lSalt + iPlayer * 0xc0);
                lSaltCur._2_2_ =
                     *(undefined2 *)(char *)((int)&rgplr[0].lSalt + 2 + iPlayer * 0xc0);
              }
              sVar18 = FCheckPassword();
              if (sVar18 == 0) {
                if ((((uint)ini.wFlags >> 0xe & 1) != 0) ||
                   (uVar13 = szT._252_4_, ini.wFlags < 0)) {
                  sVar18 = 0x10;
                  pcVar28 = PszFormatIds(idsPasswordHaveEnteredIncorrectPleaseTry,(short *)0x0)
                  ;
                  AlertSz(pcVar28,sVar18);
                  uVar13 = szT._252_4_;
                }
                break;
              }
              ReadPlayerMessages();
              ResetHb(htFleets);
              ResetHb(htOrd);
              FreeLp(rglpfl,htMisc);
              rglpfl._0_2_ = (FLEET **)0x0;
              rglpfl._2_2_ = 0;
              lppl = lpPlanets;
              if (lpPlanets == (PLANET *)0x0) {
                cPlanetAlloc = cPlanet;
                if (cPlanet < 1) {
                  cPlanetAlloc = 1;
                }
                pPVar36 = LpAlloc(cPlanetAlloc * 0x38,htPlanets);
                    /* WARNING: Ignoring partial resolution of indirect */
                lpPlanets._0_2_ = (PLANET *)pPVar36;
                    /* WARNING: Ignoring partial resolution of indirect */
                lpPlanets._2_2_ = (int)((ulong)pPVar36 >> 0x10);
                lppl = lpPlanets;
              }
              j = 0;
              lpPlanets = lppl;
              for (i = 0; i < cPlanet; i = i + 1) {
                fHaveHistoryData = 0;
                if (cPlanetHist != 0) {
                  while ((j < cPlanetHist && (lppl->id < (int)(rgbCur._0_2_ << 5) >> 5)))
                  {
                    j = j + 1;
                    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
                  }
                  if ((j < cPlanetHist) && ((int)(rgbCur._0_2_ << 5) >> 5 == lppl->id)) {
                    fHaveHistoryData = 1;
                  }
                  else {
                    if (cPlanetAlloc == cPlanetHist) {
                      cPlanetAlloc = cPlanetAlloc + 8;
                      pPVar36 = LpReAlloc(lpPlanets,cPlanetAlloc * 0x38,htPlanets);
                    /* WARNING: Ignoring partial resolution of indirect */
                      lpPlanets._0_2_ = (PLANET *)pPVar36;
                    /* WARNING: Ignoring partial resolution of indirect */
                      lpPlanets._2_2_ = (int)((ulong)pPVar36 >> 0x10);
                      lppl = (PLANET *)
                             CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets + j);
                    }
                    if (j < cPlanetHist) {
                      __fmemmove((PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1),lppl,
                                         (cPlanetHist - j) * 0x38);
                    }
                    cPlanetHist = cPlanetHist + 1;
                  }
                }
                sVar19 = FReadPlanet(iPlayer,lppl,0,fHaveHistoryData);
                sVar18 = idPlayer;
                uVar15 = szT._252_4_;
                if (sVar19 == 0) goto IO_Corrupt_2;
                if (((PLANET *)lppl)->iPlayer != -1) {
                  piVar1 = (int *)((int)&rgplr[0].cPlanet +
                                  ((PLANET *)lppl)->iPlayer * 0xc0);
                  *piVar1 = *piVar1 + 1;
                }
                ReadRt();
                if ((uint)hdrCur.wFlags >> 10 == 0x1c) {
                  if ((*(int *)&((PLANET *)lppl)->lpplprod != 0) ||
                     (uVar43 = szT._252_4_, *(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) {
                    bVar8 = ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMax;
                    szT._254_2_ = ZEXT12(bVar8);
                    uVar43 = (ulong)CONCAT12(bVar8,szT._252_2_);
                    if ((uint)szT._254_2_ <= (hdrCur.wFlags & 0x3ffU) / 4) {
                      FreePl((PL *)CONCAT22(*(undefined2 *)
                                                     ((int)&((PLANET *)lppl)->lpplprod + 2),
                                                    *(PL **)&((PLANET *)lppl)->lpplprod));
                      *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
                      *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
                      uVar43 = CONCAT22(szT._254_2_,szT._252_2_);
                    }
                  }
                  if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) &&
                     (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
                    szT._252_4_ = uVar43;
                    pPVar37 = LpplAlloc(4,(hdrCur.wFlags & 0x3ffU) / 4 + 2,htOrd);
                    *(PL **)&((PLANET *)lppl)->lpplprod = (PL *)pPVar37;
                    *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) =
                         (int)((ulong)pPVar37 >> 0x10);
                    uVar43 = szT._252_4_;
                  }
                  szT._252_4_ = uVar43;
                  __fmemmove((void *)CONCAT22(*(undefined2 *)
                                                       ((int)&((PLANET *)lppl)->lpplprod + 2),
                                                      (void *)(*(int *)&((PLANET *)lppl)->lpplprod +
                                                              4)),rgbCur,
                                     hdrCur.wFlags & 0x3ff);
                  ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac =
                       (byte)((ulong)(hdrCur.wFlags & 0x3ff) / 4);
                  ReadRt();
                }
                if (cPlanetHist == 0) {
                  lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
                }
              }
              if (cPlanetHist != 0) {
                cPlanet = cPlanetHist;
              }
              i = 0;
              while( true ) {
                if (game.cPlayer <= i) break;
                if (i == iPlayer) {
                  *(undefined2 *)(i * 4 + 0xfe) = 0x3f00;
                  *(undefined2 *)(i * 4 + 0x100) = (undefined1 *)&DAT_1120_1120;
IO_FreeShdef:
                  for (j = 0; uVar16._2_1_ = szT[0xfe], uVar16._3_1_ = szT[0xff],
                      uVar16._0_1_ = szT[0xfc], uVar16._1_1_ = szT[0xfd], j < 0x10; j = j + 1) {
                    szT._254_2_ = *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfdff |
                                  0x200;
                    *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) = szT._254_2_;
                    *(undefined2 *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x8b) = 0;
                  }
LAB_1070_1c2c:
                  sVar19 = idPlayer;
                  if (idPlayer == -1) {
                    idPlayer = i;
                  }
                  else if (i != idPlayer) {
                    idPlayer = -1;
                  }
                  szT._252_4_ = uVar16;
                  for (j = 0; j < *(char *)((int)&rgplr[0].cShDef + i * 0xc0); j = j + 1)
                  {
                    sVar18 = sVar19;
                    uVar15 = szT._252_4_;
                    if ((uint)hdrCur.wFlags >> 10 != 0x1a) goto IO_Corrupt_2;
                    sVar21 = FReadShDef((RTSHDEF *)rgbCur,
                                        (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x100),
                                                          (SHDEF *)*(undefined2 *)(i * 4 + 0xfe)),
                                        sVar19);
                    sVar18 = idPlayer;
                    uVar15 = szT._252_4_;
                    if (sVar21 == 0) goto IO_Corrupt_2;
                    ReadRt();
                  }
                }
                else {
                  sVar19 = idPlayer;
                  if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
                    uVar16 = szT._252_4_;
                    if ((*(int *)(i * 4 + 0xfe) == 0) && (*(int *)(i * 4 + 0x100) == 0)) {
                      pvVar38 = LpAlloc(0x930,htShips);
                      *(undefined2 *)(i * 4 + 0xfe) = (void *)pvVar38;
                      *(undefined2 *)(i * 4 + 0x100) = (int)((ulong)pvVar38 >> 0x10);
                      goto IO_FreeShdef;
                    }
                    goto LAB_1070_1c2c;
                  }
                }
                idPlayer = sVar19;
                i = i + 1;
              }
              for (i = 0; i < game.cPlayer; i = i + 1) {
                *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
                if ((*(int *)(i * 4 + 0xfe) != 0) || (*(int *)(i * 4 + 0x100) != 0)) {
                  for (j = 0; j < 0x10; j = j + 1) {
                    if ((*(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
                      if (((i == idPlayer) || (((uint)gd._0_2_ >> 1 & 1) != 0)) ||
                         ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0)) {
                        pcVar3 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
                        *pcVar3 = *pcVar3 + '\x01';
                      }
                      else {
                        szT._254_2_ = *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfdff |
                                      0x200;
                        *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) = szT._254_2_;
                      }
                    }
                  }
                }
              }
              iVar23 = cFleet;
              if (cFleet < 1) {
                iVar23 = 1;
              }
              rglpfl = LpAlloc(iVar23 << 2,htMisc);
              for (i = 0; i < cFleet; i = i + 1) {
                lpfl_00 = LpAlloc(0x7c,htFleets);
                uVar35 = rglpfl._2_2_;
                uVar27 = (undefined2)((ulong)lpfl_00 >> 0x10);
                pFVar20 = (FLEET *)lpfl_00;
                ppFVar30 = (FLEET **)rglpfl + i;
                *(FLEET **)ppFVar30 = pFVar20;
                *(undefined2 *)((int)ppFVar30 + 2) = uVar27;
                sVar18 = FReadFleet(lpfl_00);
                uVar13._2_1_ = szT[0xfe];
                uVar13._3_1_ = szT[0xff];
                uVar13._0_1_ = szT[0xfc];
                uVar13._1_1_ = szT[0xfd];
                if (sVar18 == 0) goto IO_LError_2;
                szT._254_2_ = *(int *)((int)&rgplr[0].wFlags + pFVar20->iPlayer * 0xc0) +
                              1U & 0xfff;
                puVar2 = (uint *)((int)&rgplr[0].wFlags + pFVar20->iPlayer * 0xc0);
                *puVar2 = *puVar2 & 0xf000;
                puVar2 = (uint *)((int)&rgplr[0].wFlags + pFVar20->iPlayer * 0xc0);
                *puVar2 = *puVar2 | szT._254_2_;
              }
              for (i = 0; i < game.cPlayer; i = i + 1) {
                sVar19 = idPlayer;
                if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
                  if ((*(int *)(i * 4 + 0x14c) == 0) && (*(int *)(i * 4 + 0x14e) == 0)) {
                    pvVar38 = LpAlloc(0x5be,htShips);
                    *(undefined2 *)(i * 4 + 0x14c) = (void *)pvVar38;
                    *(undefined2 *)(i * 4 + 0x14e) = (int)((ulong)pvVar38 >> 0x10);
                    for (j = 0; j < 10; j = j + 1) {
                      szT._254_2_ = *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfdff |
                                    0x200;
                      *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) = szT._254_2_;
                      *(undefined2 *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x8b) = 0;
                    }
                  }
                  sVar19 = idPlayer;
                  if (idPlayer == -1) {
                    idPlayer = i;
                  }
                  else if (i != idPlayer) {
                    idPlayer = -1;
                  }
                  for (j = 0; uVar15._2_1_ = szT[0xfe], uVar15._3_1_ = szT[0xff],
                      uVar15._0_1_ = szT[0xfc], uVar15._1_1_ = szT[0xfd],
                      j < (int)(*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 0xc);
                      j = j + 1) {
                    sVar18 = sVar19;
                    if ((uint)hdrCur.wFlags >> 10 != 0x1a) goto IO_Corrupt_2;
                    sVar21 = FReadShDef((RTSHDEF *)rgbCur,
                                        (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x14e),
                                                          (SHDEF *)*(undefined2 *)(i * 4 + 0x14c)),
                                        sVar19);
                    uVar15._2_1_ = szT[0xfe];
                    uVar15._3_1_ = szT[0xff];
                    uVar15._0_1_ = szT[0xfc];
                    uVar15._1_1_ = szT[0xfd];
                    sVar18 = idPlayer;
                    if (sVar21 == 0) goto IO_Corrupt_2;
                    ReadRt();
                  }
                }
                idPlayer = sVar19;
              }
              pSVar39 = vlprgScoreX;
              for (i = 0; vlprgScoreX = pSVar39, i < game.cPlayer; i = i + 1) {
                szT._254_2_ = *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xfff;
                *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) = szT._254_2_;
                if ((*(int *)(i * 4 + 0x14c) != 0) ||
                   (pSVar39 = vlprgScoreX, *(int *)(i * 4 + 0x14e) != 0)) {
                  for (j = 0; pSVar39 = vlprgScoreX, j < 10; j = j + 1) {
                    if ((*(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
                      if (((i == idPlayer) || (((uint)gd._0_2_ >> 1 & 1) != 0)) ||
                         ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0)) {
                        szT._254_2_ = *(int *)((int)&rgplr[0].wFlags + i * 0xc0) + 0x1000U
                                      & 0xf000;
                        puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
                        *puVar2 = *puVar2 & 0xfff;
                        puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
                        *puVar2 = *puVar2 | szT._254_2_;
                      }
                      else {
                        szT._254_2_ = *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfdff
                                      | 0x200;
                        *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) = szT._254_2_;
                      }
                    }
                  }
                }
              }
              if (pSVar39 == (SCOREX *)0x0) {
                pSVar39 = LpAlloc(game.cPlayer * 0x18,htMisc);
                vlprgScoreX = pSVar39;
                __fmemset(pSVar39,0,game.cPlayer * 0x18);
                pSVar39 = vlprgScoreX;
              }
              while( true ) {
                vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar39 >> 0x10);
                uVar35 = vlprgScoreX._2_2_;
                vlprgScoreX._0_2_ = (SCOREX *)pSVar39;
                vlprgScoreX = pSVar39;
                if ((uint)hdrCur.wFlags >> 10 != 0x2d) break;
                szT._254_2_ = rgbCur._0_2_ & 0x1f;
                pSVar32 = (SCOREX *)vlprgScoreX + szT._254_2_;
                psVar31 = (short *)rgbCur;
                for (iVar23 = 0xc; iVar23 != 0; iVar23 = iVar23 + -1) {
                  pSVar39 = pSVar32;
                  pSVar32 = (SCOREX *)&pSVar32->iRank;
                  psVar4 = psVar31;
                  psVar31 = psVar31 + 1;
                  pSVar39->wWord = *psVar4;
                }
                pSVar39 = vlprgScoreX;
                if ((((SCOREX **)rgsxPlr)[szT._254_2_ * 2] == (SCOREX *)0x0) &&
                   (*(int *)((undefined *)&DAT_1120_156e + szT._254_2_ * 4) == 0)) {
                  pSVar39 = LpAlloc(0x978,htMisc);
                  ((SCOREX **)rgsxPlr)[szT._254_2_ * 2] = (SCOREX *)pSVar39;
                  *(int *)((undefined *)&DAT_1120_156e + szT._254_2_ * 4) =
                       (int)((ulong)pSVar39 >> 0x10);
                  ((short *)rgcsxPlr)[szT._254_2_] = 0;
                  pSVar39 = vlprgScoreX;
                }
                vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar39 >> 0x10);
                vlprgScoreX._0_2_ = (SCOREX *)pSVar39;
                if ((((SCOREX **)rgsxPlr)[szT._254_2_ * 2] != (SCOREX *)0x0) ||
                   (*(int *)((undefined *)&DAT_1120_156e + szT._254_2_ * 4) != 0)) {
                  if (((SCOREX *)vlprgScoreX + szT._254_2_)->wWord < 0) {
                    szT._250_2_ = ((SCOREX *)vlprgScoreX)[szT._254_2_].iRank;
                  }
                  else {
                    szT._250_2_ = game.turn;
                  }
                  szT[0xfc] = '\0';
                  szT[0xfd] = '\0';
                  while (((int)szT._252_2_ < ((short *)rgcsxPlr)[szT._254_2_] &&
                         ((uint)((SCOREX **)rgsxPlr)[szT._254_2_ * 2][szT._252_2_].iRank <
                          (uint)szT._250_2_))) {
                    szT._252_2_ = szT._252_2_ + 1;
                  }
                  vlprgScoreX = pSVar39;
                  if ((((int)szT._252_2_ < ((short *)rgcsxPlr)[szT._254_2_]) &&
                      (szT._250_2_ !=
                       ((SCOREX **)rgsxPlr)[szT._254_2_ * 2][szT._252_2_].iRank)) ||
                     (100 < (int)szT._252_2_)) {
                    if (((short *)rgcsxPlr)[szT._254_2_] < 0x65) {
                      __fmemmove((SCOREX *)
                                         CONCAT22(*(undefined2 *)
                                                   ((undefined *)&DAT_1120_156e + szT._254_2_ * 4),
                                                  ((SCOREX **)rgsxPlr)[szT._254_2_ * 2] +
                                                  szT._252_2_ + 1),
                                         (SCOREX *)
                                         CONCAT22(*(undefined2 *)
                                                   ((undefined *)&DAT_1120_156e + szT._254_2_ * 4),
                                                  ((SCOREX **)rgsxPlr)[szT._254_2_ * 2] +
                                                  szT._252_2_),
                                         (((short *)rgcsxPlr)[szT._254_2_] - szT._252_2_)
                                         * 0x18);
                      ((short *)rgcsxPlr)[szT._254_2_] =
                           ((short *)rgcsxPlr)[szT._254_2_] + 1;
                      pSVar39 = vlprgScoreX;
                    }
                    else if (0 < (int)szT._252_2_) {
                      if (1 < (int)szT._252_2_) {
                        __fmemmove((SCOREX *)
                                           CONCAT22(*(undefined2 *)
                                                     ((undefined *)&DAT_1120_156e + szT._254_2_ * 4)
                                                    ,((SCOREX **)rgsxPlr)[szT._254_2_ * 2]),
                                           (SCOREX *)
                                           CONCAT22(*(undefined2 *)
                                                     ((undefined *)&DAT_1120_156e + szT._254_2_ * 4)
                                                    ,((SCOREX **)rgsxPlr)[szT._254_2_ * 2] +
                                                     1),(szT._252_2_ + -1) * 0x18);
                        pSVar39 = vlprgScoreX;
                      }
                      szT._252_2_ = szT._252_2_ + -1;
                    }
                  }
                  else if (szT._252_2_ == ((short *)rgcsxPlr)[szT._254_2_]) {
                    ((short *)rgcsxPlr)[szT._254_2_] =
                         ((short *)rgcsxPlr)[szT._254_2_] + 1;
                    pSVar39 = vlprgScoreX;
                  }
                  vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar39 >> 0x10);
                  uVar27 = vlprgScoreX._2_2_;
                  vlprgScoreX._0_2_ = (SCOREX *)pSVar39;
                  pSVar32 = (SCOREX *)vlprgScoreX + szT._254_2_;
                  uVar35 = *(undefined2 *)((undefined *)&DAT_1120_156e + szT._254_2_ * 4);
                  pSVar34 = ((SCOREX **)rgsxPlr)[szT._254_2_ * 2] + szT._252_2_;
                  vlprgScoreX = pSVar39;
                  for (iVar23 = 0xc; iVar23 != 0; iVar23 = iVar23 + -1) {
                    pSVar7 = pSVar34;
                    pSVar34 = (SCOREX *)&pSVar34->iRank;
                    pSVar39 = pSVar32;
                    pSVar32 = (SCOREX *)&pSVar32->iRank;
                    pSVar7->wWord = pSVar39->wWord;
                  }
                  ((SCOREX **)rgsxPlr)[szT._254_2_ * 2][szT._252_2_].iRank = szT._250_2_;
                  szT._248_2_ = (((SCOREX **)rgsxPlr)[szT._254_2_ * 2] + szT._252_2_)->wWord
                                & 0x7fffU | 0x8000;
                  (((SCOREX **)rgsxPlr)[szT._254_2_ * 2] + szT._252_2_)->wWord = szT._248_2_;
                  pSVar39 = vlprgScoreX;
                }
                vlprgScoreX = pSVar39;
                ReadRt();
                pSVar39 = vlprgScoreX;
              }
              if (lpThings != (THING *)0x0) {
                FreeLp(lpThings,htThings);
                    /* WARNING: Ignoring partial resolution of indirect */
                lpThings._0_2_ = (THING *)0x0;
                    /* WARNING: Ignoring partial resolution of indirect */
                lpThings._2_2_ = 0;
                cThing = 0;
                pSVar39 = vlprgScoreX;
              }
              vlprgScoreX = pSVar39;
              if ((uint)hdrCur.wFlags >> 10 == 0x2b) {
                szT._252_2_ = ZEXT12(0 < cThing);
                szT[0xfe] = rgbCur[0];
                szT[0xff] = rgbCur[1];
                cThingAlloc = rgbCur._0_2_;
                if ((int)rgbCur._0_2_ < 10) {
                  cThingAlloc = 10;
                }
                if (lpThings == (THING *)0x0) {
                  pTVar40 = LpAlloc(cThingAlloc * 0x12,htThings);
                  uVar13._2_1_ = szT[0xfe];
                  uVar13._3_1_ = szT[0xff];
                  uVar13._0_1_ = szT[0xfc];
                  uVar13._1_1_ = szT[0xfd];
                    /* WARNING: Ignoring partial resolution of indirect */
                  lpThings._0_2_ = (THING *)pTVar40;
                    /* WARNING: Ignoring partial resolution of indirect */
                  lpThings._2_2_ = (int)((ulong)pTVar40 >> 0x10);
                  if (lpThings == (THING *)0x0) break;
                  __fmemset(lpThings,0,cThingAlloc * 0x12);
                  pSVar39 = vlprgScoreX;
                }
                vlprgScoreX = pSVar39;
                ReadRt();
                lpth = lpThings;
                j = 0;
                for (i = 0; i < (int)szT._254_2_; i = i + 1) {
                  if (szT._252_2_ == 0) {
LAB_1070_270b:
                    cThing = cThing + 1;
                  }
                  else {
                    while ((j < cThing && ((uint)lpth->idFull < (uint)rgbCur._0_2_)
                           )) {
                      j = j + 1;
                      lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
                    }
                    if ((cThing <= j) || (rgbCur._0_2_ != lpth->idFull)) {
                      if (cThingAlloc == cThing) {
                        cThingAlloc = cThingAlloc + 8;
                        pTVar40 = LpReAlloc(lpThings,cThingAlloc * 0x12,
                                                    htThings);
                    /* WARNING: Ignoring partial resolution of indirect */
                        lpThings._0_2_ = (THING *)pTVar40;
                    /* WARNING: Ignoring partial resolution of indirect */
                        lpThings._2_2_ = (int)((ulong)pTVar40 >> 0x10);
                        lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings + j)
                        ;
                      }
                      if (j < cThing) {
                        __fmemmove((THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1),lpth,
                                           (cThing - j) * 0x12);
                        __fmemset(lpth,0,0x12);
                      }
                      goto LAB_1070_270b;
                    }
                  }
                  __fmemcpy(lpth,rgbCur,hdrCur.wFlags & 0x3ff);
                  ((THING *)lpth)->turn = game.turn;
                  lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
                  j = j + 1;
                  ReadRt();
                }
              }
              else {
                cThing = 0;
                cThingAlloc = 10;
                pTVar40 = LpAlloc(0xb4,htThings);
                    /* WARNING: Ignoring partial resolution of indirect */
                lpThings._0_2_ = (THING *)pTVar40;
                    /* WARNING: Ignoring partial resolution of indirect */
                lpThings._2_2_ = (int)((ulong)pTVar40 >> 0x10);
              }
              if ((uint)hdrCur.wFlags >> 10 == 0x16) {
                ReadRt();
              }
              while (sVar18 = idPlayer, uVar15._2_1_ = szT[0xfe], uVar15._3_1_ = szT[0xff],
                    uVar15._0_1_ = szT[0xfc], uVar15._1_1_ = szT[0xfd],
                    (uint)hdrCur.wFlags >> 10 == 0x1e) {
                idPlayer = rgbCur._0_2_ & 0xf;
                szT._254_2_ = idPlayer;
                if ((((BTLPLAN **)rglpbtlplan)[idPlayer * 2] == (BTLPLAN *)0x0) &&
                   (((undefined2 *)&DAT_1120_593a)[idPlayer * 2] == 0)) {
                  pBVar41 = LpAlloc(0x240,htShips);
                  ((BTLPLAN **)rglpbtlplan)[szT._254_2_ * 2] = (BTLPLAN *)pBVar41;
                  ((undefined2 *)&DAT_1120_593a)[szT._254_2_ * 2] = (int)((ulong)pBVar41 >> 0x10);
                }
                UnpackBattlePlan((byte *)rgbCur,
                                 (BTLPLAN *)
                                 CONCAT22(((undefined2 *)&DAT_1120_593a)[szT._254_2_ * 2],
                                          ((BTLPLAN **)rglpbtlplan)[szT._254_2_ * 2] +
                                          ((byte *)rgcbtlplan)[szT._254_2_]),
                                 (uint)((byte *)rgcbtlplan)[szT._254_2_]);
                ((byte *)rgcbtlplan)[szT._254_2_] =
                     ((byte *)rgcbtlplan)[szT._254_2_] + 1;
                ReadRt();
                idPlayer = sVar18;
              }
              if ((uint)hdrCur.wFlags >> 10 != 0) {
IO_Corrupt_2:
                idPlayer = sVar18;
                sVar18 = 0x10;
                szT._252_4_ = uVar15;
                pcVar28 = PszFormatIds(idsGameFileAppearsCorruptUnableLoadFile,(short *)0x0);
                AlertSz(pcVar28,sVar18);
                uVar13 = szT._252_4_;
                break;
              }
              szT._252_4_ = __filelength(hf);
              lVar42 = __tell(hf);
              if (lVar42 == szT._252_4_) goto LAB_1070_2a56;
              ReadRt();
              if ((uint)hdrCur.wFlags >> 10 != 8) goto LAB_1070_2a35;
              game.turn._0_1_ = rgbCur[10];
              game.turn._1_1_ = rgbCur[0xb];
              game.wCrap =
                   game.wCrap & 0xf1ffU | ((uint)rgbCur._14_2_ >> 0xd) << 9;
              i = 0;
              lppl = lpPlanets;
              while( true ) {
                lpPlanets._2_2_ = (undefined2)((ulong)lppl >> 0x10);
                lpPlanets._0_2_ = (PLANET *)lppl;
                lpPlanets = lppl;
                if (game.cPlayer <= i) break;
                *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
                *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
                     *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xf000;
                *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
                *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
                     *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xfff;
                ((byte *)rgcbtlplan)[i] = 0;
                i = i + 1;
                lppl = lpPlanets;
              }
              szT._252_2_ = (PLANET *)lpPlanets;
              szT[0xfe] = lpPlanets._2_1_;
              szT[0xff] = lpPlanets._3_1_;
              pPVar24 = (PLANET *)lpPlanets + cPlanet;
              while( true ) {
                if (pPVar24 <= (PLANET *)lppl) break;
                uVar35 = (undefined2)((ulong)lppl >> 0x10);
                if (((PLANET *)lppl)->iPlayer == iPlayer) {
                  ((PLANET *)lppl)->iPlayer = -1;
                  ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xff00U | 3;
                  if ((*(int *)&((PLANET *)lppl)->lpplprod != 0) ||
                     (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) {
                    FreePl((PL *)CONCAT22(*(undefined2 *)
                                                   ((int)&((PLANET *)lppl)->lpplprod + 2),
                                                  *(PL **)&((PLANET *)lppl)->lpplprod));
                    *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
                    *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
                  }
                }
                lppl = (PLANET *)CONCAT22(uVar35,(PLANET *)lppl + 1);
              }
              cPlanetHist = cPlanet;
            } while( true );
          }
          goto IO_LError_2;
        }
      }
IO_XYCorrupt:
      sVar18 = 0x10;
      pcVar28 = PszFormatIds(idsUniverseDefinitionFileSeemsMissingCorrupt,(short *)0x0);
      AlertSz(pcVar28,sVar18);
      uVar13._2_1_ = szT[0xfe];
      uVar13._3_1_ = szT[0xff];
      uVar13._0_1_ = szT[0xfc];
      uVar13._1_1_ = szT[0xfd];
    }
  }
IO_LError_2:
  game.fDirty = 0;
  szT._252_4_ = uVar13;
  DestroyCurGame();
  StreamClose();
  if (((((uint)ini.wFlags >> 0xe & 1) == 0) && (-1 < ini.wFlags)) &&
     (hwndTitle == 0)) {
    sVar18 = GetSystemMetrics(0);
    szT._252_2_ = sVar18;
    szT._254_2_ = GetSystemMetrics(1);
    hwndTitle =
         CreateWindow(szTitle,(LPCSTR)0x11200752,0x90000000,0,0,szT._252_2_,szT._254_2_,
                      hwndFrame,0,hInst,(void *)0x0);
    fFreeingTitle = 0;
    ShowWindow(hwndFrame,0);
  }
  sVar18 = 0;
  pbVar10 = vlpbAiData;
  pTVar40 = lpThings;
  pPVar36 = lpPlanets;
  ppFVar17 = rglpfl;
  pSVar39 = vlprgScoreX;
  pbVar11 = lpbBattleLog;
LAB_1070_3200:
  lpbBattleLog._2_2_ = (undefined2)((ulong)pbVar11 >> 0x10);
  lpbBattleLog._0_2_ = (byte *)pbVar11;
  vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar39 >> 0x10);
  vlprgScoreX._0_2_ = (SCOREX *)pSVar39;
  rglpfl._2_2_ = (undefined2)((ulong)ppFVar17 >> 0x10);
  rglpfl._0_2_ = (FLEET **)ppFVar17;
  lpPlanets._2_2_ = (undefined2)((ulong)pPVar36 >> 0x10);
  lpPlanets._0_2_ = (PLANET *)pPVar36;
  lpThings._2_2_ = (undefined2)((ulong)pTVar40 >> 0x10);
  lpThings._0_2_ = (THING *)pTVar40;
  vlpbAiData._2_2_ = (int)((ulong)pbVar10 >> 0x10);
  vlpbAiData._0_2_ = (byte *)pbVar10;
  return sVar18;
LAB_1070_2a35:
  sVar18 = 0x10;
  pcVar28 = PszFormatIds(idsWarningIgnoringUnexpectedDataAfterEof,(short *)0x0);
  AlertSz(pcVar28,sVar18);
LAB_1070_2a56:
  StreamClose();
  if ((((1 < cturn) && ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0)
       ) && (((uint)ini.wFlags >> 0xc & 1) == 0)) &&
     ((((uint)ini.wFlags >> 0xb & 1) == 0 &&
      (((uint)ini.wFlags >> 0xd & 1) == 0)))) {
    pcVar28 = PszGetCompressedString(idsNoteDYearsDataRead);
    _WSPRINTF((LPSTR)CONCAT22(cturn,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(pcVar28,(char *)&DAT_1120_1120),(char *)szWork);
    AlertSz((char *)szWork,0x40);
  }
  sVar18 = __strnicmp(pszExt,(char *)0x759,3);
  pTVar40 = lpThings;
  ppFVar17 = rglpfl;
  if (sVar18 != 0) {
    lppl = lpPlanets;
    if ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0) {
      szT._240_2_ = (THING *)lpThings;
      szT[0xf2] = lpThings._2_1_;
      szT[0xf3] = lpThings._3_1_;
      lpth = pTVar40;
      pTVar25 = (THING *)lpThings + cThing;
      while( true ) {
        lpPlanets._2_2_ = (undefined2)((ulong)lppl >> 0x10);
        lpPlanets._0_2_ = (PLANET *)lppl;
        lpPlanets = lppl;
        lpThings = pTVar40;
        if (pTVar25 <= (THING *)lpth) break;
        uVar35 = (undefined2)((ulong)lpth >> 0x10);
        if (((uint)lpth->idFull >> 0xd == 1) && ((*(uint *)((THING *)lpth)->rgb >> 10 & 0xf) != 0))
        {
          pPVar36 = LpplFromId(*(uint *)((THING *)lpth)->rgb & 0x3ff);
          iVar23 = (int)((ulong)pPVar36 >> 0x10);
          lppl = lpPlanets;
          pTVar40 = lpThings;
          if ((((PLANET *)pPVar36 != (PLANET *)0x0) || (iVar23 != 0)) &&
             (((PLANET *)pPVar36)->iPlayer == iPlayer)) {
            szT._242_2_ = IWarpMAFromLppl(pPVar36,(short *)(szT + 0xf0));
            pTVar40 = lpThings;
            lppl = lpPlanets;
            if ((int)(szT._242_2_ + szT._240_2_) <
                (int)((*(uint *)((THING *)lpth)->rgb >> 10 & 0xf) + 4)) {
              FSendPlrMsg2XGen
                        (0,idmMassPacketAppearsCollisionCourseWhichCurrently,-6,lpth->idFull,
                         pPVar36->id);
              pTVar40 = lpThings;
              lppl = lpPlanets;
            }
          }
        }
        lpth = (THING *)CONCAT22(uVar35,(THING *)lpth + 1);
      }
      lppl = lppl;
      if (((uint)game.wCrap >> 3 & 1) == 0) {
        szT._240_2_ = (PLANET *)lpPlanets;
        szT[0xf2] = lpPlanets._2_1_;
        szT[0xf3] = lpPlanets._3_1_;
        pPVar24 = (PLANET *)lpPlanets + cPlanet;
        while ((PLANET *)lppl < pPVar24) {
          uVar35 = (undefined2)((ulong)lppl >> 0x10);
          uVar12 = szT._252_4_;
          if ((((((PLANET *)lppl)->iPlayer == iPlayer) &&
               (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)) &&
              ((*(int *)&((PLANET *)lppl)->lpplprod != 0 ||
               (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)))) &&
             (iVar23 = ((PLANET *)lppl)->iPlayer * 4,
             *(int *)(*(int *)(iVar23 + 0x14c) +
                     (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) * 0x93) != 0x20)) {
            szT[0xfe] = '\0';
            szT[0xff] = '\0';
            szT[0xfc] = '\0';
            szT[0xfd] = '\0';
            szT._244_2_ = *(undefined2 *)&((PLANET *)lppl)->lpplprod;
            szT._246_2_ = *(undefined2 *)(char *)((int)&((PLANET *)lppl)->lpplprod + 2);
            for (; szT._244_2_ = szT._244_2_ + 4,
                (int)szT._252_2_ < (int)(uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac;
                szT._252_2_ = szT._252_2_ + 1) {
              lpThings = pTVar40;
              EstimateItemProdSched
                        (lppl,(PLPROD *)0x0,szT._252_2_,(short *)(szT + 0xfa),(short *)(szT + 0xf8))
              ;
              pTVar40 = lpThings;
              if (1 < (int)szT._248_2_) {
                szT[0xfe] = '\0';
                szT[0xff] = '\0';
                break;
              }
              if (szT._248_2_ == 1) {
                uVar43 = __aFulshr(uVar44,szEntry._0_2_);
                if (((uint)uVar43 & 7) == 1) {
                  uVar43 = __aFulshr(uVar44,szEntry._0_2_);
                  pTVar40 = lpThings;
                  if (((uint)uVar43 & 0x7f) < 7) goto LAB_1070_2cf9;
                }
                szT[0xfe] = '\x01';
                szT[0xff] = '\0';
                pTVar40 = lpThings;
              }
LAB_1070_2cf9:
            }
            uVar12._2_1_ = szT[0xfe];
            uVar12._3_1_ = szT[0xff];
            uVar12._0_1_ = szT[0xfc];
            uVar12._1_1_ = szT[0xfd];
            if (szT._254_2_ != 0) {
              lpThings = pTVar40;
              FSendPlrMsg2XGen
                        (0,idmStarbaseScheduledCompleteRemainingProductionItem,lppl->id,lppl->id,0);
              uVar12._2_1_ = szT[0xfe];
              uVar12._3_1_ = szT[0xff];
              uVar12._0_1_ = szT[0xfc];
              uVar12._1_1_ = szT[0xfd];
              pTVar40 = lpThings;
            }
          }
          szT._252_4_ = uVar12;
          lppl = (PLANET *)CONCAT22(uVar35,(PLANET *)lppl + 1);
        }
        lpThings = pTVar40;
        sVar18 = CBattles();
        lppl = lpPlanets;
        if (0 < sVar18) {
          FSendPlrMsg2XGen(1,(1 < sVar18) + idmHaveReceivedOneBattleRecordingYear,-7,sVar18,0);
          lppl = lpPlanets;
        }
      }
    }
    if (((uint)gd.wFlags >> 1 & 1) == 0) {
      lpPlanets = lppl;
      _WSPRINTF((LPSTR)CONCAT22(pszFileName,(char *)&DAT_1120_1120),(LPCSTR)0x75d1120,
                (char *)szWork);
      sVar18 = FLoadLogFile((char *)szWork);
      if (sVar18 != 0) {
        sVar18 = FRunLogFile();
        lppl = lpPlanets;
        if (sVar18 != 0) goto LAB_1070_2eb1;
      }
      sVar18 = 0x10;
      pcVar28 = PszFormatIds(idsPlayerLogFileAppearsCorruptUnableLoad,(short *)0x0);
      AlertSz(pcVar28,sVar18);
      uVar13 = szT._252_4_;
      goto IO_LError_2;
    }
LAB_1070_2eb1:
    i = 0;
    while( true ) {
      lpPlanets._2_2_ = (undefined2)((ulong)lppl >> 0x10);
      lpPlanets._0_2_ = (PLANET *)lppl;
      pPVar24 = (PLANET *)lpPlanets;
      lpPlanets = lppl;
      if (game.cPlayer <= i) break;
      *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xf000;
      *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
      i = i + 1;
      lppl = lpPlanets;
    }
    szT[0xfe] = lpPlanets._2_1_;
    szT[0xff] = lpPlanets._3_1_;
    pPVar26 = (PLANET *)lpPlanets + cPlanet;
    while ((PLANET *)lppl < pPVar26) {
      uVar35 = (undefined2)((ulong)lppl >> 0x10);
      if (((PLANET *)lppl)->iPlayer == -1) {
        ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xfdff;
      }
      else {
        piVar1 = (int *)((int)&rgplr[0].cPlanet + ((PLANET *)lppl)->iPlayer * 0xc0);
        *piVar1 = *piVar1 + 1;
      }
      lppl = (PLANET *)CONCAT22(uVar35,(PLANET *)lppl + 1);
    }
    i = 0;
    ppFVar17 = rglpfl;
    while( true ) {
      rglpfl._2_2_ = (undefined2)((ulong)ppFVar17 >> 0x10);
      rglpfl._0_2_ = (FLEET **)ppFVar17;
      szT._252_4_ = (PLANET *)CONCAT22(szT._254_2_,pPVar24);
      if (cFleet <= i) break;
      iVar23 = *(int *)((FLEET **)rglpfl + i);
      iVar9 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      if ((iVar23 == 0) && (szT._252_4_ = (PLANET *)CONCAT22(szT._254_2_,pPVar24), iVar9 == 0))
      break;
      iVar23 = *(int *)(iVar23 + 2);
      szT._254_2_ = *(int *)((int)&rgplr[0].wFlags + iVar23 * 0xc0) + 1U & 0xfff;
      puVar2 = (uint *)((int)&rgplr[0].wFlags + iVar23 * 0xc0);
      rglpfl = ppFVar17;
      *puVar2 = *puVar2 & 0xf000;
      puVar2 = (uint *)((int)&rgplr[0].wFlags + iVar23 * 0xc0);
      *puVar2 = *puVar2 | szT._254_2_;
      i = i + 1;
      ppFVar17 = rglpfl;
    }
  }
  idPlayer = iPlayer;
  pbVar10 = vlpbAiData;
  pTVar40 = lpThings;
  pPVar36 = lpPlanets;
  pSVar39 = vlprgScoreX;
  pbVar11 = lpbBattleLog;
  if (((iPlayer != -1) &&
      ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0)) &&
     (((char *)vrgszMRU != (char *)0x0 || (vrgszMRU._2_2_ != 0)))) {
    rglpfl = ppFVar17;
    _strcpy(szT,pszFileName);
    _strcat(szT,(char *)0x764);
    _strcat(szT,pszExt);
    sVar18 = __fstricmp((char *)CONCAT22(unaff_SS,szT),
                                (char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU));
    pbVar10 = vlpbAiData;
    pTVar40 = lpThings;
    pPVar36 = lpPlanets;
    pSVar39 = vlprgScoreX;
    ppFVar17 = rglpfl;
    pbVar11 = lpbBattleLog;
    if (sVar18 != 0) {
      for (i = 1; i < 8; i = i + 1) {
        sVar18 = __fstricmp((char *)CONCAT22(unaff_SS,szT),
                                    (char *)CONCAT22(vrgszMRU._2_2_,
                                                     (char *)vrgszMRU + i * 0x100));
        if (sVar18 == 0) break;
      }
      for (; 0 < i; i = i + -1) {
        __fstrcpy((char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU + i * 0x100
                                          ),
                          (char *)CONCAT22(vrgszMRU._2_2_,
                                           (char *)vrgszMRU + (i + -1) * 0x100));
      }
      __fstrcpy((char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU),
                        (char *)CONCAT22(unaff_SS,szT));
      CchGetString(idsStarsIni,szIniFile);
      CchGetString(idsFiles,szSection);
      CchGetString(idsFile1,szEntry);
      uVar22 = _strlen(szEntry);
      for (i = 0; pbVar10 = vlpbAiData, pTVar40 = lpThings, pPVar36 = lpPlanets
          , pSVar39 = vlprgScoreX, ppFVar17 = rglpfl, pbVar11 = lpbBattleLog,
          i < 9; i = i + 1) {
        szSection[uVar22 - 0x13] = (char)i + '1';
        __fstrcpy((char *)CONCAT22(unaff_SS,szT),
                          (char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU + i * 0x100
                                          ));
        WritePrivateProfileString
                  ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
                   (LPCSTR)CONCAT22(unaff_SS,szT),(LPCSTR)CONCAT22(unaff_SS,szIniFile));
      }
    }
  }
  sVar18 = 1;
  goto LAB_1070_3200;
}



// ======================================================================
// Function: FReadPlanet
// Address: 1070:3206
// Segment: MEMORY_IO
// ======================================================================


short FReadPlanet(short iPlayer,PLANET *lppl,short fHistory,short fPreInited)

{
  uint uVar1;
  undefined2 uVar2;
  bool bVar3;
  byte bVar4;
  uint uVar5;
  short sVar6;
  short sVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar8;
  ushort in_stack_0000ffea;
  short pct;
  short pctOpt;
  short idm;
  byte *pb;
  short i;
  byte bMask;
  short fRouting;
  short fFirstYear;
  
  lVar8 = CONCAT22(unaff_SI,unaff_DI);
  bVar3 = false;
  if (fPreInited == 0) {
    __fmemset(lppl,0,0x38);
  }
  if ((fHistory == 0) && (iPlayer != -1)) {
    if (fPreInited == 0) {
      bVar3 = true;
      ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xf7ffU | 0x800;
    }
    else if (((uint)((PLANET *)lppl)->wFlags >> 0xb & 1) != 0) {
      if (((PLANET *)lppl)->turn == game.turn) {
        bVar3 = true;
      }
      else {
        ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xf7ff;
      }
    }
  }
  else {
    ((PLANET *)lppl)->wFlags =
         ((PLANET *)lppl)->wFlags & 0xf7ffU | ((uint)rgbCur._2_2_ >> 0xf) << 0xb;
  }
  lppl->id = (int)(rgbCur._0_2_ << 5) >> 5;
  ((PLANET *)lppl)->iPlayer = (int)rgbCur._0_2_ >> 0xb;
  if ((((PLANET *)lppl)->wFlags & 0xffU) < (rgbCur._2_2_ & 0x7f)) {
    ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xff00U | rgbCur._2_2_ & 0x7f;
  }
  ((PLANET *)lppl)->wFlags =
       ((PLANET *)lppl)->wFlags & 0xfeffU | ((uint)rgbCur._2_2_ >> 8 & 1) << 8;
  ((PLANET *)lppl)->wFlags =
       ((PLANET *)lppl)->wFlags & 0xfdffU | ((uint)rgbCur._2_2_ >> 9 & 1) << 9;
  ((PLANET *)lppl)->wFlags =
       ((PLANET *)lppl)->wFlags & 0xfbffU | ((uint)rgbCur._2_2_ >> 7 & 1) << 10;
  uVar5 = (uint)rgbCur._2_2_ >> 0xe;
  if ((((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0) && (((PLANET *)lppl)->iPlayer == -1)) {
    ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xfdff;
  }
  if (fHistory == 0) {
    ((PLANET *)lppl)->turn = game.turn;
  }
  pb = (byte *)((char *)rgbCur + 4);
  if (2 < (rgbCur._2_2_ & 0x7f)) {
    bMask = rgbCur[4];
    pb = (byte *)((char *)rgbCur + 5);
    for (i = 0; i < 3; i = i + 1) {
      if ((bMask & 3) == 0) {
        ((PLANET *)lppl)->rgpctMinLevel[i] = 0;
      }
      else {
        if ((bMask & 3) != 1) {
          return 0;
        }
        ((PLANET *)lppl)->rgpctMinLevel[i] = *pb;
        pb = pb + 1;
      }
      bMask = (byte)((int)(uint)bMask >> 2);
    }
    for (i = 0; i < 3; i = i + 1) {
      ((PLANET *)lppl)->rgMinConc[i] = *pb;
      pb = pb + 1;
    }
    for (i = 0; i < 3; i = i + 1) {
      if (100 < *pb) {
        return 0;
      }
      bVar4 = *pb;
      ((PLANET *)lppl)->rgEnvVarOrig[i] = bVar4;
      ((PLANET *)lppl)->rgEnvVar[i] = bVar4;
      pb = pb + 1;
    }
    if (((uint)rgbCur._2_2_ >> 10 & 1) != 0) {
      for (i = 0; i < 3; i = i + 1) {
        if (100 < *pb) {
          return 0;
        }
        ((PLANET *)lppl)->rgEnvVarOrig[i] = *pb;
        pb = pb + 1;
      }
    }
    if ((int)rgbCur._0_2_ >> 0xb != -1) {
      ((PLANET *)lppl)->uGuesses = *(short *)pb;
      pb = pb + 2;
    }
    if (3 < (((PLANET *)lppl)->wFlags & 0xffU)) {
      if (((uint)rgbCur._2_2_ >> 0xd & 1) != 0) {
        bMask = *pb;
        pb = pb + 1;
        for (i = 0; i < 4; i = i + 1) {
          bVar4 = bMask & 3;
          if ((bMask & 3) == 0) {
            *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = 0;
            *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
          }
          else if (bVar4 == 1) {
            *(uint *)(((PLANET *)lppl)->rgwtMin + i) = (uint)*pb;
            *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
            pb = pb + 1;
          }
          else if (bVar4 == 2) {
            *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = *(undefined2 *)pb;
            *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
            pb = pb + 2;
          }
          else if (bVar4 == 3) {
            uVar2 = *(undefined2 *)(pb + 2);
            *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = *(undefined2 *)pb;
            *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = uVar2;
            pb = pb + 4;
          }
          bMask = (byte)((int)(uint)bMask >> 2);
        }
      }
      if ((uint)hdrCur.wFlags >> 10 != 0xe) {
        if (((uint)rgbCur._2_2_ >> 0xb & 1) == 0) {
          lVar8 = __aFlshl(lVar8,in_stack_0000ffea);
          uVar1 = *(uint *)((int)&((PLANET *)lppl)->dwFlags + 2);
          *(uint *)&((PLANET *)lppl)->dwFlags = *(uint *)&((PLANET *)lppl)->dwFlags | (uint)lVar8;
          *(uint *)((int)&((PLANET *)lppl)->dwFlags + 2) =
               uVar1 & 0xffbf | (uint)((ulong)lVar8 >> 0x10);
          uVar1 = *(uint *)((int)&((PLANET *)lppl)->dwFlags + 2);
          *(uint *)&((PLANET *)lppl)->dwFlags = *(uint *)&((PLANET *)lppl)->dwFlags & 0xfff | 0xf000
          ;
          *(uint *)((int)&((PLANET *)lppl)->dwFlags + 2) = uVar1 & 0xfffe | 1;
          uVar2 = *(undefined2 *)((int)&((PLANET *)lppl)->dwFlags + 2);
          *(uint *)&((PLANET *)lppl)->dwFlags = *(uint *)&((PLANET *)lppl)->dwFlags & 0xf000;
          *(undefined2 *)((int)&((PLANET *)lppl)->dwFlags + 2) = uVar2;
        }
        else {
          __fmemmove((long *)CONCAT22(lppl._2_2_,&((PLANET *)lppl)->dwFlags),
                             (byte *)CONCAT22((undefined1 *)&DAT_1120_1120,pb),8);
          pb = pb + 8;
        }
        if (((PLANET *)lppl)->iPlayer != -1) {
          if (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0) {
            sVar6 = *(short *)(pb + 2);
            *(undefined2 *)&((PLANET *)lppl)->field11_0x2c = *(undefined2 *)pb;
            ((PLANET *)lppl)->wFlags = sVar6;
            ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xbfff;
            pb = pb + 4;
          }
          if ((uVar5 & 1) != 0) {
            ((PLANET *)lppl)->wRouting = *(short *)pb;
          }
        }
        return 1;
      }
    }
  }
  if (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0) {
    *(uint *)&((PLANET *)lppl)->field11_0x2c =
         *(uint *)&((PLANET *)lppl)->field11_0x2c & 0xfff0 | *pb & 0xf;
    pb = pb + 1;
  }
  if (fHistory == 0) {
    if (bVar3) {
      if (((PLANET *)lppl)->iPlayer == -1) {
        if ((((PLANET *)lppl)->wFlags & 0xffU) < 2) {
          FSendPlrMsg2XGen(0,idmHaveFoundNewPlanetDontKnowIf,lppl->id,lppl->id,0);
        }
        else {
          sVar6 = GetRaceStat((PLAYER *)rgplr + iPlayer,rsMajorAdv);
          if (sVar6 == raTerra) {
            sVar6 = PctPlanetOptValue(lppl,iPlayer);
            FSendPlrMsg2XGen(0,idmHaveInfoNewPlanetIfColonizeCan,lppl->id,lppl->id,sVar6);
          }
          else {
            sVar6 = PctPlanetDesirability(lppl,iPlayer);
            if (sVar6 < 1) {
              sVar7 = PctPlanetOptValue(lppl,iPlayer);
              if (sVar7 < 1) {
                pct = sVar6 * 10;
                idm = 0xab;
              }
              else {
                sVar6 = PctTrueMaxGrowth(iPlayer);
                pct = sVar6 * sVar7;
                idm = 0xae;
              }
            }
            else {
              sVar7 = PctTrueMaxGrowth(iPlayer);
              pct = sVar7 * sVar6;
              idm = 0xac;
            }
            sVar6 = lppl->id;
            sVar7 = _abs(pct);
            FSendPlrMsg2XGen(0,idm,lppl->id,sVar7,sVar6);
          }
        }
      }
      else {
        FSendPlrMsg2XGen
                  (0,idmHaveFoundPlanetOccupiedSomeoneElseCurrently,lppl->id,lppl->id,
                   ((PLANET *)lppl)->iPlayer | 0x30);
      }
    }
  }
  else {
    ((PLANET *)lppl)->turn = *(short *)pb;
  }
  return 1;
}



// ======================================================================
// Function: FReadFleet
// Address: 1070:3a4c
// Segment: MEMORY_IO
// ======================================================================


short FReadFleet(FLEET *lpfl)

{
  byte *pbVar1;
  ushort *puVar2;
  short *psVar3;
  ORDER *pOVar4;
  uint uVar5;
  char *sz;
  ushort uVar6;
  short sVar7;
  int iVar8;
  short *psVar9;
  ORDER *pOVar10;
  ORDER *pOVar11;
  undefined2 uVar12;
  undefined2 unaff_SS;
  PL *pPVar13;
  void *pvVar14;
  HeapType HVar15;
  short cOut;
  char szT [33];
  ushort *pus;
  short cch;
  byte *pb;
  short cish;
  short i;
  ORDER *lpord;
  short fByte;
  short cord;
  ushort us;
  
  cish = 0;
  __fmemset(lpfl,0,0x7c);
  __fmemmove(lpfl,rgbCur,0xc);
  us._0_1_ = rgbCur[0xc];
  us._1_1_ = rgbCur[0xd];
  pb = (byte *)((char *)rgbCur + 0xe);
  if (((uint)((FLEET *)lpfl)->wFlags >> 0xb & 1) == 0) {
    pus = (ushort *)((char *)rgbCur + 0xe);
    i = 0;
    for (; us != 0; us = us >> 1) {
      if ((us & 1) != 0) {
        puVar2 = pus + 1;
        ((FLEET *)lpfl)->rgcsh[i] = *pus;
        pus = puVar2;
        if (((FLEET *)lpfl)->rgcsh[i] != 0) {
          cish = cish + 1;
        }
      }
      i = i + 1;
    }
    pb = (byte *)pus;
  }
  else {
    i = 0;
    for (; us != 0; us = us >> 1) {
      if ((us & 1) != 0) {
        pbVar1 = pb + 1;
        ((FLEET *)lpfl)->rgcsh[i] = (uint)*pb;
        pb = pbVar1;
        if (((FLEET *)lpfl)->rgcsh[i] != 0) {
          cish = cish + 1;
        }
      }
      i = i + 1;
    }
  }
  if (cish == 0) {
    ((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0xfbffU | 0x400;
  }
  if (3 < (((FLEET *)lpfl)->wFlags & 0xffU)) {
    us = *(ushort *)pb;
    pb = pb + 2;
    for (i = 0; i < 5; i = i + 1) {
      uVar5 = us & 3;
      if (uVar5 == 1) {
        *(uint *)(((FLEET *)lpfl)->rgwtMin + i) = (uint)*pb;
        *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = 0;
        pb = pb + 1;
      }
      else if (uVar5 == 2) {
        *(undefined2 *)(((FLEET *)lpfl)->rgwtMin + i) = *(undefined2 *)pb;
        *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = 0;
        pb = pb + 2;
      }
      else if (uVar5 == 3) {
        uVar12 = *(undefined2 *)(pb + 2);
        *(undefined2 *)(((FLEET *)lpfl)->rgwtMin + i) = *(undefined2 *)pb;
        *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = uVar12;
        pb = pb + 4;
      }
      us = us >> 2;
    }
  }
  if ((((FLEET *)lpfl)->wFlags & 0xffU) < 7) {
    sVar7 = *(short *)(pb + 2);
    *(undefined2 *)&((FLEET *)lpfl)->field17_0x74 = *(undefined2 *)pb;
    ((FLEET *)lpfl)->wFlags = sVar7;
    sVar7 = *(short *)(pb + 6);
    ((FLEET *)lpfl)->rgdv->dp = *(short *)(pb + 4);
    (((FLEET *)lpfl)->rgdv + 1)->dp = sVar7;
    ReadRt();
    return 1;
  }
  if ((uint)hdrCur.wFlags >> 10 == 0x10) {
    us = *(ushort *)pb;
    pus = (ushort *)(pb + 2);
    i = 0;
    for (; us != 0; us = us >> 1) {
      if ((us & 1) != 0) {
        puVar2 = pus + 1;
        (((FLEET *)lpfl)->rgdv + i)->dp = *pus;
        pus = puVar2;
        if (499 < (uint)(((FLEET *)lpfl)->rgdv + i)->dp >> 7) {
          (((FLEET *)lpfl)->rgdv + i)->dp = (((FLEET *)lpfl)->rgdv + i)->dp & 0x7fU | 0xf980;
        }
      }
      i = i + 1;
    }
    ((FLEET *)lpfl)->iplan = (byte)*pus;
    ((FLEET *)lpfl)->cord = (uint)*(byte *)((int)pus + 1);
    pPVar13 = LpplAlloc(0x12,((FLEET *)lpfl)->cord + 1,htOrd);
    *(PL **)&((FLEET *)lpfl)->lpplord = (PL *)pPVar13;
    *(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2) = (int)((ulong)pPVar13 >> 0x10);
    __fmemset((void *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2),
                                       (void *)(*(int *)&((FLEET *)lpfl)->lpplord + 4)),0,
                      (((FLEET *)lpfl)->cord + 1) * 0x12);
    cord = ((FLEET *)lpfl)->cord;
    lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2),
                              (ORDER *)(*(int *)&((FLEET *)lpfl)->lpplord + 4));
    for (; cord != 0; cord = cord + -1) {
      _memset((char *)rgbCur,0,0x12);
      ReadRt();
      if (((uint)hdrCur.wFlags >> 10 != 0x13) &&
         ((uint)hdrCur.wFlags >> 10 != 0x14)) goto IO_Corrupt;
      psVar9 = (short *)rgbCur;
      uVar12 = (undefined2)((ulong)lpord >> 0x10);
      pOVar10 = (ORDER *)lpord;
      pOVar11 = pOVar10;
      for (iVar8 = 9; iVar8 != 0; iVar8 = iVar8 + -1) {
        pOVar4 = pOVar11;
        pOVar11 = (ORDER *)&(pOVar11->pt).y;
        psVar3 = psVar9;
        psVar9 = psVar9 + 1;
        (pOVar4->pt).x = *psVar3;
      }
      pOVar10->wFlags = pOVar10->wFlags & 0xdfff;
      lpord = (ORDER *)CONCAT22(uVar12,pOVar10 + 1);
    }
    ((PLORD *)((FLEET *)lpfl)->lpplord)->iordMac = (byte)((FLEET *)lpfl)->cord;
    if (((FLEET *)lpfl)->idPlanet != -1) {
      if (game.cPlanMax < ((FLEET *)lpfl)->idPlanet) {
        ((FLEET *)lpfl)->idPlanet = -1;
      }
      if (((&((FLEET *)lpfl)->pt)->x != ((POINT *)rgptPlan + ((FLEET *)lpfl)->idPlanet)->x
          ) || ((((FLEET *)lpfl)->pt).y !=
                *(int *)((int)&rgptPlan[0].y + ((FLEET *)lpfl)->idPlanet * 4))) {
        if ((i != 0) || (game.turn != 0)) goto IO_Corrupt;
        sVar7 = *(short *)((int)&rgptPlan[0].y + ((FLEET *)lpfl)->idPlanet * 4);
        (&((FLEET *)lpfl)->pt)->x = ((POINT *)rgptPlan + ((FLEET *)lpfl)->idPlanet)->x;
        (((FLEET *)lpfl)->pt).y = sVar7;
      }
    }
    ReadRt();
    if ((uint)hdrCur.wFlags >> 10 == 0x15) {
      if (rgbCur[0] == 0) {
        HVar15 = htString;
        uVar6 = _strlen((char *)rgbCur + 1);
        pvVar14 = LpAlloc(uVar6 + 1,HVar15);
        *(void **)&((FLEET *)lpfl)->lpszName = (void *)pvVar14;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = (int)((ulong)pvVar14 >> 0x10);
                    /* WARNING: Load size is inaccurate */
        __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2),
                                           ((FLEET *)lpfl)->lpszName),rgbCur + 1);
      }
      else {
        cOut = 0x20;
        FDecompressUserString
                  (rgbCur + 1,(int)rgbCur[0],(char *)CONCAT22(unaff_SS,szT),
                   &cOut);
        HVar15 = htString;
        uVar6 = _strlen(szT);
        pvVar14 = LpAlloc(uVar6 + 1,HVar15);
        *(void **)&((FLEET *)lpfl)->lpszName = (void *)pvVar14;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = (int)((ulong)pvVar14 >> 0x10);
                    /* WARNING: Load size is inaccurate */
        __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2),
                                           ((FLEET *)lpfl)->lpszName),(char *)CONCAT22(unaff_SS,szT)
                         );
      }
      ReadRt();
    }
    else {
      *(undefined2 *)&((FLEET *)lpfl)->lpszName = 0;
      *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = 0;
    }
    sVar7 = 1;
  }
  else {
IO_Corrupt:
    sVar7 = 0x10;
    sz = PszFormatIds(idsGameFileAppearsCorruptUnableLoadFile,(short *)0x0);
    AlertSz(sz,sVar7);
    sVar7 = 0;
  }
  return sVar7;
}



// ======================================================================
// Function: UnpackBattlePlan
// Address: 1070:40ce
// Segment: MEMORY_IO
// ======================================================================


void UnpackBattlePlan(byte *lpb,BTLPLAN *lpbtlplan,short iplan)

{
  byte *pbVar1;
  undefined2 unaff_SS;
  short cOut;
  short cch;
  char szName [33];
  char szTemp [33];
  
  pbVar1 = (byte *)lpb;
  __fmemmove(lpbtlplan,lpb,4);
  lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 4);
  cch = (short)*lpb;
  if (cch == 0) {
    __fstrcpy((char *)CONCAT22(lpbtlplan._2_2_,((BTLPLAN *)lpbtlplan)->szName),
                      (char *)CONCAT22(lpb._2_2_,pbVar1 + 5));
  }
  else {
    cOut = 0x20;
    __fmemmove((char *)CONCAT22(unaff_SS,szTemp),(byte *)CONCAT22(lpb._2_2_,pbVar1 + 5),0x20
                      );
    FDecompressUserString
              ((char *)CONCAT22(unaff_SS,szTemp),cch,(char *)CONCAT22(unaff_SS,szName),&cOut);
    __fmemmove((byte *)CONCAT22(lpbtlplan._2_2_,((BTLPLAN *)lpbtlplan)->szName),
                       (char *)CONCAT22(unaff_SS,szName),cOut);
  }
  lpbtlplan->wFlags = lpbtlplan->wFlags & 0xff0fU | (iplan & 0xfU) << 4;
  return;
}



// ======================================================================
// Function: UpdateBattleRecords
// Address: 1070:41ac
// Segment: MEMORY_IO
// ======================================================================


void UpdateBattleRecords(void)

{
  byte bVar1;
  HB *pHVar2;
  int iVar3;
  BTLREC26 *pBVar4;
  BTLDATA *pBVar5;
  undefined2 uVar6;
  undefined2 uVar7;
  short itok;
  BTLREC26 *lpbr26;
  HB *lphb;
  short cKill;
  BTLREC *lpbr;
  BTLDATA *lpbd;
  
  lphb = (HB *)CONCAT22(DAT_1120_0d60._2_2_,(HB *)DAT_1120_0d60);
  if (((HB *)DAT_1120_0d60 != (HB *)0x0) || (DAT_1120_0d60._2_2_ != 0)) {
    lpbd = (BTLDATA *)CONCAT22(DAT_1120_0d60._2_2_,&((HB *)DAT_1120_0d60)[1].cbBlock);
    while( true ) {
      while (lpbd->id == -1) {
        uVar6 = (undefined2)((ulong)lphb >> 0x10);
                    /* WARNING: Load size is inaccurate */
        pHVar2 = ((HB *)lphb)->lphbNext;
        iVar3 = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
        lphb = (HB *)CONCAT22(iVar3,pHVar2);
        if ((pHVar2 == (HB *)0x0) && (iVar3 == 0)) {
          return;
        }
        if ((uint)pHVar2->ibTop < 0x11) {
          return;
        }
        lpbd = (BTLDATA *)CONCAT22(iVar3,&pHVar2[1].cbBlock);
      }
      uVar6 = (undefined2)((ulong)lpbd >> 0x10);
      pBVar5 = (BTLDATA *)lpbd;
      if (pBVar5->cbData == 0) break;
      pBVar4 = (BTLREC26 *)((int)pBVar5 + (uint)pBVar5->ctok * 0x1d + 0xe);
      lpbr = (BTLREC *)CONCAT22(uVar6,pBVar4);
      lpbr26 = (BTLREC26 *)CONCAT22(uVar6,pBVar4);
      pBVar5 = (BTLDATA *)((int)&pBVar5->id + pBVar5->cbData);
      lpbd = (BTLDATA *)CONCAT22(uVar6,pBVar5);
      while ((BTLREC *)lpbr < pBVar5) {
        uVar6 = (undefined2)((ulong)lpbr26 >> 0x10);
        bVar1 = ((BTLREC26 *)lpbr26)->itokAttack;
        uVar7 = (undefined2)((ulong)lpbr >> 0x10);
        ((BTLREC *)lpbr)->ctok = (uint)((BTLREC26 *)lpbr26)->ctok;
        ((BTLREC *)lpbr)->wFlags = ((BTLREC *)lpbr)->wFlags & 0xffU | (uint)bVar1 << 8;
        pBVar4 = (BTLREC26 *)((int)(BTLREC *)lpbr + ((BTLREC *)lpbr)->ctok * 8 + 6);
        lpbr26 = (BTLREC26 *)CONCAT22(uVar7,pBVar4);
        lpbr = (BTLREC *)CONCAT22(uVar7,pBVar4);
      }
    }
  }
  return;
}



// ======================================================================
// Function: AskSaveDialog
// Address: 1070:432a
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short AskSaveDialog(HWND hwnd,ushort message,ushort wParam,long lParam)

{
  short sVar1;
  
  if (message != 2) {
    if (message == 0x110) {
      return 1;
    }
    if (message == 0x111) {
      if (((wParam == 0x429) || (wParam == 0x42b)) || (wParam == 0x42a)) {
        if (wParam == 0x42b) {
          sVar1 = 0;
        }
        else if (wParam == 0x42a) {
          sVar1 = -1;
        }
        else {
          sVar1 = 1;
        }
        EndDialog(hwnd,sVar1);
        return 1;
      }
      if (wParam == 0x76) {
        WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x442);
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: PromptSaveGame
// Address: 1070:43ee
// Segment: MEMORY_IO
// ======================================================================


void PromptSaveGame(void)

{
  undefined2 uVar1;
  short sVar2;
  FARPROC pvVar3;
  short fRet;
  void *lpProc;
  
  pvVar3 = MakeProcInstance(AskSaveDialog,hInst);
  if (((uint)game.wCrap >> 2 & 1) == 0) {
    uVar1 = 0x42c;
  }
  else {
    uVar1 = 0x7e9;
  }
  sVar2 = DialogBox(0,(LPCSTR)CONCAT22(uVar1,hwndFrame),(HWND)((ulong)pvVar3 >> 0x10),
                    (void *)pvVar3);
  FreeProcInstance(pvVar3);
  if (sVar2 != 0) {
    gd._0_2_ = gd._0_2_ & 0xffef | (uint)(sVar2 == -1) << 4;
    FWriteLogFile((char *)szBase,idPlayer);
    FWriteHistFile(idPlayer);
  }
  return;
}



// ======================================================================
// Function: DestroyCurGame
// Address: 1070:44b0
// Segment: MEMORY_IO
// ======================================================================


void DestroyCurGame(void)

{
  short i;
  
  if (((uint)gd._0_2_ >> 8 & 1) != 0) {
    FFinishPlrMsgEntry(0);
  }
  if ((idPlayer != -1) && (game.fDirty != 0)) {
    PromptSaveGame();
  }
  ResetHb(htPlanets);
  lpPlanets._0_2_ = (PLANET *)0x0;
  lpPlanets._2_2_ = 0;
  cPlanet = 0;
  ResetHb(htFleets);
  rglpfl._0_2_ = (FLEET **)0x0;
  rglpfl._2_2_ = 0;
  cFleet = 0;
  ResetHb(htThings);
  lpThings._0_2_ = (THING *)0x0;
  lpThings._2_2_ = 0;
  cThing = 0;
  cThingAlloc = 0;
  vlprgScoreX._0_2_ = (SCOREX *)0x0;
  vlprgScoreX._2_2_ = 0;
  vrptFleet.fCached = 0;
  vrptPlanet.fCached = 0;
  vrptBattle.fCached = 0;
  vrptEFleet.fCached = 0;
  for (i = 0; i < 0x10; i = i + 1) {
    ((SCOREX **)rgsxPlr)[i * 2] = (SCOREX *)0x0;
    *(undefined2 *)((undefined *)&DAT_1120_156e + i * 4) = 0;
  }
  lpbBattleT._0_2_ = (byte *)0x0;
  lpbBattleT._2_2_ = 0;
  lpbBattleLog._0_2_ = (byte *)0x0;
  lpbBattleLog._2_2_ = 0;
  lpbBattleCur._0_2_ = (byte *)0x0;
  lpbBattleCur._2_2_ = 0;
  gd._0_2_ = gd._0_2_ & 0xebff;
  gd._4_2_ = gd._4_2_ & 0xfbff;
  ResetHb(htBattle);
  if (((int)DAT_1120_0d60 != 0) || (DAT_1120_0d60._2_2_ != 0)) {
    *(undefined2 *)((int)DAT_1120_0d60 + 0x12) = 0xffff;
  }
  ResetHb(htMisc);
  ResetHb(htString);
  ResetHb(htShips);
  ResetHb(htOrd);
  ResetHb(htPlrMsg);
  for (i = 0; i < 0x10; i = i + 1) {
    *(undefined2 *)(i * 4 + 0xfe) = 0;
    *(undefined2 *)(i * 4 + 0x100) = 0;
    *(undefined2 *)(i * 4 + 0x14c) = 0;
    *(undefined2 *)(i * 4 + 0x14e) = 0;
    ((BTLPLAN **)rglpbtlplan)[i * 2] = (BTLPLAN *)0x0;
    ((undefined2 *)&DAT_1120_593a)[i * 2] = 0;
    ((byte *)rgcbtlplan)[i] = 0;
  }
  if (sel.grobj != grobjNone) {
    ini.wFlags =
         ini.wFlags & 0xfe1fU |
         (sel.grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 5;
    ini.iObjSel = sel.id;
    ini.idPlayer = idPlayer;
    ini.lid._0_2_ = (undefined2)game.lid;
    ini.lid._2_2_ = game.lid._2_2_;
  }
  idPlayer = -1;
  imemLogCur = 0;
  imemLogPrev = -1;
  iMsgCur = 0;
  vlpbAiData._0_2_ = (byte *)0x0;
  vlpbAiData._2_2_ = 0;
  ResetMessages();
  lSaltCur._0_2_ = 0;
  lSaltCur._2_2_ = 0;
  ctickLast._0_2_ = 0;
  ctickLast._2_2_ = 0;
  game.lid._0_2_ = 0;
  game.lid._2_2_ = 0;
  game.cPlayer = 0;
  game.cPlanMax = 0;
  game.fDirty = 0;
  game.turn = 0;
  game.szName[0] = '\0';
  gd.wFlags = gd.wFlags & 0xfffe;
  gd._0_2_ = gd._0_2_ & 0xfeff;
  if (hwndBrowser != 0) {
    DestroyWindow(hwndBrowser);
  }
  if (hwndReportDlg != 0) {
    DestroyWindow(hwndReportDlg);
  }
  if (hwndPopup != 0) {
    DestroyWindow(hwndPopup);
    hwndPopup = 0;
  }
  hwndActive = 0;
  sel.scan.grobjFull = grobjNone;
  sel.scan.grobj = grobjNone;
  sel.scan.iwp = -1;
  sel.scan.ifl = -1;
  sel.scan.idpl = -1;
  fOrdersVis = 0;
  sel.grobjFull = grobjNone;
  sel.grobj = grobjNone;
  sel.id = -1;
  sel.pt.y = 0;
  sel.pt.x = 0;
  sel.pl.id = -1;
  sel.fl.id = -1;
  sel.fl.lpplord._0_2_ = (PLORD *)0x0;
  sel.fl.lpplord._2_2_ = 0;
  sel.pl.lpplprod._0_2_ = (PLPROD *)0x0;
  sel.pl.lpplprod._2_2_ = 0;
  dxPlanetProdLB = 0;
  dxOrderED = 0;
  dxFleetCompLB = 0;
  dxShipLB = 0;
  dxShipDD = 0;
  for (i = 0; i < 3; i = i + 1) {
    *(undefined2 *)(i * 2 + 0x85c) = 0;
  }
  return;
}



// ======================================================================
// Function: FBogusLong
// Address: 1070:484c
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10704887) */

short FBogusLong(ulong lSerial)

{
  short i;
  
  i = 0;
  while (CONCAT22(*(undefined2 *)(i * 4 + 0x768),*(undefined2 *)(i * 4 + 0x766)) <
         (lSerial ^ 0xa5a5a5a5)) {
    i = i + 1;
  }
  return (uint)((lSerial ^ 0xa5a5a5a5) ==
               CONCAT22(*(undefined2 *)(i * 4 + 0x768),*(undefined2 *)(i * 4 + 0x766)));
}



// ======================================================================
// Function: FValidSerialLong
// Address: 1070:48c4
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10704975) */
/* WARNING: Removing unreachable block (ram,0x10704994) */

short FValidSerialLong(ulong lSerial)

{
  short sVar1;
  ulong uVar2;
  ulong uVar3;
  ulong lSeries;
  short i;
  ulong lNumber;
  
  sVar1 = FBogusLong(lSerial);
  if (sVar1 == 0) {
    uVar2 = lSerial;
    for (i = 0; i < 4; i = i + 1) {
      uVar2 = __aFuldiv(uVar2,0x24);
    }
    uVar3 = uVar2;
    for (i = 0; i < 4; i = i + 1) {
      uVar3 = __aFulmul(uVar3,0x24);
    }
    uVar3 = lSerial - uVar3;
    if ((((int)(uVar3 >> 0x10) == 0) && ((uint)uVar3 < 100)) || (1500000 < uVar3)) {
      sVar1 = 0;
    }
    else if (((uVar2 == 0x12) || (uVar2 == 0x16)) ||
            ((uVar2 == 2 || ((uVar2 == 4 || (uVar2 == 6)))))) {
      sVar1 = 1;
    }
    else {
      sVar1 = 0;
    }
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: FileError
// Address: 1070:4a10
// Segment: MEMORY_IO
// ======================================================================


void FileError(StringId ids)

{
  char *sz;
  short mbType;
  
  idsFileError = ids;
  if ((fFileErrSilent == 0) && (((uint)gd._0_2_ >> 1 & 1) == 0)) {
    mbType = 0x10;
    sz = PszFormatIds(ids,(short *)0x0);
    AlertSz(sz,mbType);
  }
  return;
}



// ======================================================================
// Function: GetFileStatus
// Address: 1070:4a60
// Segment: MEMORY_IO
// ======================================================================


void GetFileStatus(short dt,short iPlayer)

{
  short sVar1;
  
  SetSzWorkFromDt(dt,iPlayer);
  sVar1 = __access((char *)szWork,2);
  gd.wFlags = gd.wFlags & 0xffdfU | (uint)(sVar1 != 0) << 5;
  return;
}



// ======================================================================
// Function: FOpenFile
// Address: 1070:4ac2
// Segment: MEMORY_IO
// ======================================================================


short FOpenFile(DtFileType dt,short iPlayer,short md)

{
  DtFileType dt_00;
  char *pcVar1;
  RTBOF *pRVar2;
  undefined2 uVar3;
  short sVar4;
  StringId ids_00;
  short sVar5;
  int iVar6;
  char *pcVar7;
  RTBOF *pRVar8;
  undefined2 unaff_SS;
  char *mbType;
  short env [9];
  short (*penvMemSav) [9];
  short fSilentSav;
  short fRewind;
  short fCheckMulti;
  short ids;
  RTBOF rtbof;
  
  sVar5 = fFileErrSilent;
  gd.wFlags = gd.wFlags & 0xff7f;
  dt_00 = dt & 0xff;
  SetSzWorkFromDt(dt_00,iPlayer);
  uVar3 = penvMem;
  penvMem = env;
  sVar4 = __setjmp(env);
  if (sVar4 != 0) {
    fFileErrSilent = sVar5;
    FileError(idsCantOpenFile);
    StreamClose();
    penvMem = (short *)uVar3;
    return 0;
  }
  fFileErrSilent = 1;
  StreamOpen((char *)szWork,md);
  fFileErrSilent = sVar5;
  ReadRt();
  if (((((uint)hdrCur.wFlags >> 10 == 8) && ((uint)rgbCur._8_2_ >> 0xc == 2)) &&
      (0x30 < ((uint)rgbCur._8_2_ >> 5 & 0x7f))) &&
     (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x54)) {
    pcVar7 = (char *)rgbCur;
    pRVar8 = &rtbof;
    for (iVar6 = 8; iVar6 != 0; iVar6 = iVar6 + -1) {
      pRVar2 = pRVar8;
      pRVar8 = (RTBOF *)(pRVar8->rgid + 2);
      pcVar1 = pcVar7;
      pcVar7 = pcVar7 + 2;
      *(undefined2 *)pRVar2->rgid = *(undefined2 *)pcVar1;
    }
    if ((rtbof.wFlags << 0xb) >> 0xb == iPlayer) {
      if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) goto LAB_1070_4ebd;
      if (((int)rtbof.lidGame == (int)game.lid) &&
         (rtbof.lidGame._2_2_ == game.lid._2_2_)) {
        if (dt_00 == dtHist) {
          if ((rtbof.wFlags << 0xb) >> 0xb == iPlayer) goto LAB_1070_4ebd;
        }
        else {
          if (((dt & 0x2000) != dtXY) && (((uint)rtbof.wFlags >> 10 & 1) != 0)) {
            __lseek(hf,-4,2);
            ReadRt();
            if (((uint)hdrCur.wFlags >> 10 != 0) &&
               ((hdrCur.wFlags & 0x3ffU) != 2)) goto IO_LBadFile_2;
            rtbof.turn._0_1_ = rgbCur[0];
            rtbof.turn._1_1_ = rgbCur[1];
            game.wCrap = game.wCrap & 0xf1ffU | ((uint)rtbof.wFlags >> 0xd) << 9;
          }
          if ((game.turn == 0) && (rtbof.turn != 0)) {
            game.turn = rtbof.turn;
            game.wCrap = game.wCrap & 0xf1ffU | ((uint)rtbof.wFlags >> 0xd) << 9;
LAB_1070_4ebd:
            if ((dt & 0x1000) != dtXY) {
              __lseek(hf,0,0);
              ReadRt();
            }
            penvMem = (short *)uVar3;
            wVersFile = rtbof.wVersion;
            gd.wFlags = gd.wFlags & 0xfffbU | ((uint)rtbof.wFlags >> 0xc & 1) << 2;
            return 1;
          }
          if (rtbof.turn == game.turn) {
            if (((dt_00 == dtHost) && (((uint)gd._0_2_ >> 3 & 1) == 0)) &&
               (((uint)rtbof.wFlags >> 9 & 1) != 0)) {
              mbType = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
              pcVar7 = PszFormatIds(idsHostFileMarkedUseAnotherInstanceStars,(short *)0x0);
              sVar5 = AlertSz(pcVar7,(short)mbType);
              if (sVar5 == 6) goto LAB_1070_4ebd;
            }
            else if (((((uint)rtbof.wFlags >> 8 & 1) == 0) &&
                     (((uint)gd._0_2_ >> 1 & 1) != 0)) &&
                    (((uint)gd._0_2_ >> 2 & 1) == 0)) {
              gd.wFlags = gd.wFlags & 0xff7fU | 0x80;
            }
            else {
              if (((dt_00 != dtLog) || (((uint)game.wCrap >> 3 & 1) != 0)) ||
                 ((uint)rtbof.wFlags >> 0xd == ((uint)game.wCrap >> 9 & 7)))
              goto LAB_1070_4ebd;
              FileError(idsFileGame);
            }
          }
          else {
            FileError(idsFileDate);
          }
        }
      }
      else {
        FileError(idsFileGame);
      }
    }
    else {
      FileError(idsGameFileAppearsCorruptUnableLoadFile);
    }
  }
  else if ((uint)hdrCur.wFlags >> 10 == 8) {
    if (((uint)rgbCur._8_2_ >> 0xc < 3) &&
       (((uint)rgbCur._8_2_ >> 0xc != 2 ||
        (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x55)))) {
      ids_00 = idsSorryFileCreatedOlderVersionStarsIncompatible;
    }
    else {
      ids_00 = idsFileCreatedNewerVersionStarsMustUpgrade;
    }
    FileError(ids_00);
  }
  else {
    FileError(idsFileDoesBelongVersionStars);
  }
IO_LBadFile_2:
  StreamClose();
  penvMem = (short *)uVar3;
  return 0;
}



// ======================================================================
// Function: FNewTurnAvail
// Address: 1070:4f22
// Segment: MEMORY_IO
// ======================================================================


short FNewTurnAvail(short idPlayer)

{
  short sVar1;
  uint uVar2;
  short sVar3;
  short fNew;
  ushort turnOld;
  ushort wGenOld;
  
  sVar1 = game.turn;
  uVar2 = (uint)game.wCrap >> 9;
  fFileErrSilent = 1;
  game.turn = 0;
  sVar3 = FOpenFile(0x2003,idPlayer,0x20);
  if (sVar3 == 0) {
    fNew = 0;
  }
  else {
    StreamClose();
    fNew = (short)((uint)sVar1 < (uint)game.turn);
  }
  game.turn = sVar1;
  game.wCrap = game.wCrap & 0xf1ffU | (uVar2 & 7) << 9;
  return fNew;
}



// ======================================================================
// Function: FCheckFile
// Address: 1070:4fb2
// Segment: MEMORY_IO
// ======================================================================


short FCheckFile(DtFileType dt,short iPlayer,ushort md)

{
  short sVar1;
  uint uVar2;
  short sVar3;
  short fErrSav;
  short f;
  ushort wGenOld;
  short fOpened;
  short fReturn;
  
  sVar1 = fFileErrSilent;
  uVar2 = (uint)game.wCrap >> 9;
  if (dt == dtHost) {
    f = (uint)gd._0_2_ >> 3 & 1;
    gd._0_2_ = gd._0_2_ & 0xfff7 | 8;
  }
  fFileErrSilent = 1;
  sVar3 = FOpenFile(dt,iPlayer,0x20);
  if (md == 1) {
    if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 9 & 1) != 0)) {
      fReturn = 1;
    }
    else {
      fReturn = 0;
    }
  }
  else if (md == 2) {
    if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 8 & 1) == 0)) {
      fReturn = 0;
    }
    else {
      fReturn = 1;
    }
  }
  else if (md == 4) {
    if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 10 & 1) == 0)) {
      fReturn = 0;
    }
    else {
      fReturn = 1;
    }
  }
  else if (md == 8) {
    if (sVar3 == 0) {
      fReturn = 0;
    }
    else {
      do {
        ReadRt();
        if ((uint)hdrCur.wFlags >> 10 == 6) break;
      } while (rgbCur[0] != iPlayer);
      fReturn = (uint)rgbCur._6_2_ >> 9 & 1;
    }
  }
  if (sVar3 != 0) {
    StreamClose();
  }
  if (dt == dtHost) {
    gd._0_2_ = gd._0_2_ & 0xfff7 | (f & 1U) << 3;
  }
  fFileErrSilent = sVar1;
  game.wCrap = game.wCrap & 0xf1ffU | (uVar2 & 7) << 9;
  return fReturn;
}



// ======================================================================
// Function: ReadRt
// Address: 1070:5168
// Segment: MEMORY_IO
// ======================================================================


void ReadRt(void)

{
  RgFromStream(&hdrCur,2);
  if ((hdrCur.wFlags & 0x3ffU) != 0) {
    RgFromStream(rgbCur,hdrCur.wFlags & 0x3ff);
  }
  if ((uint)hdrCur.wFlags >> 10 == 8) {
    SetFileXorStream
              (CONCAT22(rgbCur._6_2_,rgbCur._4_2_),
               (int)rgbCur._12_2_ >> 5,rgbCur._10_2_,
               (int)(rgbCur._12_2_ << 0xb) >> 0xb,(uint)rgbCur._14_2_ >> 0xc & 1
              );
  }
  else if ((uint)hdrCur.wFlags >> 10 != 0) {
    XorFileBuf((char *)rgbCur,hdrCur.wFlags & 0x3ff);
  }
  return;
}



// ======================================================================
// Function: FBadFileError
// Address: 1070:524e
// Segment: MEMORY_IO
// ======================================================================


short FBadFileError(StringId ids)

{
  short sVar1;
  
  if ((((ids == idsUniverseDefinitionFileSeemsMissingCorrupt) ||
       (ids == idsPlayerLogFileAppearsCorruptUnableLoad)) ||
      (ids == idsHistoryFileAppearsCorruptHistoricalDataWill)) ||
     (((ids == idsGameFileAppearsCorruptUnableLoadFile || (ids == idsErrorWritingFile)) ||
      ((ids == idsFileDate || (ids == idsFileGame)))))) {
    sVar1 = 1;
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: StreamOpen
// Address: 1070:52ae
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1070536a) */
/* WARNING: Removing unreachable block (ram,0x10705391) */

void StreamOpen(char *szFile,short mdOpen)

{
  ulong uVar1;
  undefined2 unaff_SS;
  DWORD DVar2;
  DWORD DVar3;
  ulong dwTickCur;
  short fNoErr;
  OFSTRUCT of;
  ulong dwTick;
  
  uVar1 = 0;
  while( true ) {
    hf = OpenFile((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,szFile),
                         (undefined2 *)CONCAT22(unaff_SS,&of),mdOpen & 0xbfff);
    if (hf != 0xffff) {
      return;
    }
    if ((((uint)gd._0_2_ >> 9 & 1) == 0) || (of.nErrCode == 2)) break;
    DVar2 = GetTickCount();
    if (uVar1 == 0) {
      uVar1 = DVar2 + 4000;
    }
    if (uVar1 <= DVar2) break;
    do {
      DVar3 = GetTickCount();
    } while (DVar3 < DVar2 + 500);
  }
  if ((mdOpen & 0x4000U) == 0) {
    FileError(idsCantOpenFile);
  }
  _longjmp(penvMem,-1);
  return;
}



// ======================================================================
// Function: StreamClose
// Address: 1070:53cc
// Segment: MEMORY_IO
// ======================================================================


void StreamClose(void)

{
  if (hf != -1) {
    _lclose(hf);
    hf = -1;
  }
  return;
}



// ======================================================================
// Function: RgFromStream
// Address: 1070:53f4
// Segment: MEMORY_IO
// ======================================================================


void RgFromStream(void *rg,ushort cb)

{
  ushort uVar1;
  
  if (cb != 0) {
    if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
      uVar1 = _lread(cb,rg,hf);
      if (uVar1 != cb) {
        FileError(idsGameFileAppearsCorruptUnableLoadFile);
        _longjmp(penvMem,-1);
      }
    }
    else {
      __fmemcpy(rg,(byte *)CONCAT22(vlpMemStream._2_2_,(byte *)vlpMemStream),
                        cb);
      vlpMemStream._0_2_ = (byte *)vlpMemStream + cb;
    }
  }
  return;
}



// ======================================================================
// Function: WriteOrders
// Address: 1070:547e
// Segment: MEMORY_IO
// ======================================================================


void WriteOrders(FLEET *lpfl)

{
  FLEET *pFVar1;
  undefined2 uVar2;
  ORDER *lpord;
  short cord;
  
  uVar2 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar1 = (FLEET *)lpfl;
  if (pFVar1->cord != 0) {
    cord = pFVar1->cord;
    lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar1->lpplord + 2),
                              (ORDER *)(*(int *)&pFVar1->lpplord + 4));
    for (; cord != 0; cord = cord + -1) {
      uVar2 = (undefined2)((ulong)lpord >> 0x10);
      if ((((ORDER *)lpord)->wFlags & 0xfU) == 0) {
        WriteRt(0x14,8,lpord);
      }
      else {
        WriteRt(0x13,0x12,lpord);
      }
      lpord = (ORDER *)CONCAT22(uVar2,(ORDER *)lpord + 1);
    }
  }
  return;
}



// ======================================================================
// Function: WriteRtPlr
// Address: 1070:551c
// Segment: MEMORY_IO
// ======================================================================


void WriteRtPlr(PLAYER *pplr,byte *pbStore)

{
  ushort uVar1;
  short sVar2;
  short cOut;
  byte *pb;
  short i;
  byte rgb [264];
  
  if (pbStore == (byte *)0x0) {
    pbStore = rgb;
  }
  if ((pplr->wFlags & 1U) != 0) {
    pplr->wMdPlr = pplr->wMdPlr & 0xfff8U | 7;
  }
  _memmove(pbStore,pplr,0xc0);
  if ((pplr->wMdPlr & 7U) == 7) {
    for (i = 0xf; (-1 < i && (pplr->rgmdRelation[i] == '\0')); i = i + -1) {
    }
    i = i + 1;
    pb = pbStore + 0x71;
    pbStore[0x70] = (byte)i;
    _memmove(pb,pplr->rgmdRelation,i);
    pb = pb + i;
  }
  else {
    pb = pbStore + 8;
  }
  cOut = 0x1f;
  if ((pplr->szName[0] == '\0') ||
     (sVar2 = FCompressUserString
                        ((char *)CONCAT22((undefined1 *)&DAT_1120_1120,pplr->szName),
                         (char *)CONCAT22((undefined1 *)&DAT_1120_1120,pb + 1),&cOut), sVar2 == 0))
  {
    _strcpy((char *)(pb + 1),pplr->szName);
    *pb = 0;
    uVar1 = _strlen(pplr->szName);
    pb = pb + uVar1 + 2;
  }
  else {
    *pb = (byte)cOut;
    pb = pb + cOut + 1;
  }
  cOut = 0x1f;
  if ((pplr->szNames[0] == '\0') ||
     (sVar2 = FCompressUserString
                        ((char *)CONCAT22((undefined1 *)&DAT_1120_1120,pplr->szNames),
                         (char *)CONCAT22((undefined1 *)&DAT_1120_1120,pb + 1),&cOut), sVar2 == 0))
  {
    _strcpy((char *)(pb + 1),pplr->szNames);
    *pb = 0;
    uVar1 = _strlen(pplr->szNames);
    pb = pb + uVar1 + 2;
  }
  else {
    *pb = (byte)cOut;
    pb = pb + cOut + 1;
  }
  WriteRt(6,(int)pb - (int)pbStore,(byte *)CONCAT22((undefined1 *)&DAT_1120_1120,pbStore));
  return;
}



// ======================================================================
// Function: WriteRtShDef
// Address: 1070:574e
// Segment: MEMORY_IO
// ======================================================================


void WriteRtShDef(SHDEF *lpshdef,byte **ppbStore)

{
  short sVar1;
  ushort uVar2;
  SHDEF *pSVar3;
  undefined2 uVar4;
  undefined2 unaff_SS;
  HULDEF *pHVar5;
  short cOut;
  byte *pb;
  char szHulName [32];
  byte rgb [147];
  
  rgb[2] = (byte)(lpshdef->hul).ihuldef;
  uVar4 = (undefined2)((ulong)lpshdef >> 0x10);
  pSVar3 = (SHDEF *)lpshdef;
  rgb._0_2_ = pSVar3->wFlags;
  rgb[6] = (pSVar3->hul).chs;
  rgb[3] = (byte)(pSVar3->hul).ibmp;
  if ((pSVar3->wFlags & 0xffU) == 7) {
    rgb._4_2_ = (pSVar3->hul).dp;
    rgb._7_2_ = pSVar3->turn;
    rgb._9_2_ = *(undefined2 *)&pSVar3->cBuilt;
    rgb._11_2_ = *(undefined2 *)(byte *)((int)&pSVar3->cBuilt + 2);
    rgb._13_2_ = *(undefined2 *)&pSVar3->cExist;
    rgb._15_2_ = *(undefined2 *)(byte *)((int)&pSVar3->cExist + 2);
    pb = rgb + 0x11;
    __fmemmove((byte *)CONCAT22((undefined1 *)&DAT_1120_1120,pb),
                       (HS *)CONCAT22(uVar4,(pSVar3->hul).rghs),(uint)rgb[6] << 2);
    pb = pb + (uint)rgb[6] * 4;
  }
  else {
    rgb._4_2_ = (pSVar3->hul).wtEmpty;
    pb = rgb + 6;
  }
  if ((pSVar3->wFlags & 0xffU) == 7) {
    __fstrcpy((char *)CONCAT22(unaff_SS,szHulName),
                      (char *)CONCAT22(uVar4,(pSVar3->hul).szClass));
  }
  else {
    pHVar5 = LphuldefFromId((lpshdef->hul).ihuldef);
    __fstrcpy((char *)CONCAT22(unaff_SS,szHulName),
                      (char *)CONCAT22((int)((ulong)pHVar5 >> 0x10),
                                       (((HULDEF *)pHVar5)->hul).szClass));
  }
  cOut = 0x1f;
  if ((szHulName[0] == '\0') ||
     (sVar1 = FCompressUserString
                        ((char *)CONCAT22(unaff_SS,szHulName),
                         (char *)CONCAT22((undefined1 *)&DAT_1120_1120,pb + 1),&cOut), sVar1 == 0))
  {
    _strcpy((char *)(pb + 1),szHulName);
    *pb = 0;
    uVar2 = _strlen(szHulName);
    pb = pb + uVar2 + 2;
  }
  else {
    *pb = (byte)cOut;
    pb = pb + cOut + 1;
  }
  if (ppbStore == (byte **)0x0) {
    WriteRt(0x1a,(int)pb - (int)rgb,(byte *)CONCAT22(unaff_SS,rgb));
  }
  else {
    _memmove(*ppbStore,rgb,(int)pb - (int)rgb);
    *ppbStore = *ppbStore + ((int)pb - (int)rgb);
  }
  return;
}



// ======================================================================
// Function: FWriteDataFile
// Address: 1070:5964
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10705d1f) */
/* WARNING: Removing unreachable block (ram,0x10705e4f) */

short FWriteDataFile(char *pszFileBase,short iPlayer,short fAppend)

{
  byte *pbVar1;
  char *pcVar2;
  ORDER *pOVar3;
  undefined2 *puVar4;
  ORDER *pOVar5;
  undefined2 *puVar6;
  int iVar7;
  undefined2 uVar8;
  FLEET *pFVar9;
  PLPROD PVar10;
  POINT pt_00;
  POINT pt_01;
  THING *pTVar11;
  uint uVar12;
  short sVar13;
  char *pcVar14;
  DtFileType dt;
  byte bVar15;
  int iVar16;
  PLPROD *pPVar17;
  ORDER *pOVar18;
  undefined2 *puVar19;
  ORDER *pOVar20;
  undefined2 *puVar21;
  undefined2 uVar22;
  undefined2 uVar23;
  undefined2 unaff_SS;
  ulong uVar24;
  PL *pPVar25;
  THING *pTVar26;
  undefined2 auStack_8c [7];
  undefined4 uStack_7e;
  long l;
  long lBest;
  long dx;
  short fFoundIdeal;
  FLEET *lpflBest;
  short iflT;
  BTLPLAN *lpbtlplan_2;
  long dy;
  POINT pt;
  FLEET *lpflTarget;
  PLANET pl;
  THING *lpth;
  ORDER *lpord;
  short i;
  short (*penvMemSav) [9];
  short j;
  BTLPLAN *lpbtlplan;
  short fNoAutoTrack;
  FLEET *lpflT;
  short iMax;
  
  pl.dwFlags._2_2_ = 1;
  SetVisiblePlanFleet(iPlayer);
  bVar15 = (byte)iPlayer;
  if ((((uint)gd._0_2_ >> 1 & 1) != 0) && (iPlayer != -1)) {
    for (i = 0; i < cFleet; i = i + 1) {
      pPVar17 = *(PLPROD **)((FLEET **)rglpfl + i);
      iVar16 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      pl.lpplprod = (PLPROD *)CONCAT22(iVar16,pPVar17);
      if ((pPVar17 == (PLPROD *)0x0) && (iVar16 == 0)) break;
      if ((((uint)(pPVar17 + 1)->wFlags >> 10 & 1) == 0) &&
         (((uint)(pl.lpplprod)->wFlags >> 9 & 0xf) == iPlayer)) {
        for (j = 0; (j < 0x10 && ((&pPVar17[3].wFlags)[j] == 0)); j = j + 1) {
        }
        if (j == 0x10) {
          (pPVar17 + 1)->wFlags = (pPVar17 + 1)->wFlags & 0xfbffU | 0x400;
        }
        else {
          iVar7 = (pPVar17 + 0x19)->wFlags;
          uVar23 = *(undefined2 *)&pPVar17[0x19].iprodMax;
          lpord = (ORDER *)CONCAT22(uVar23,(ORDER *)(iVar7 + 4));
          if ((*(uint *)(iVar7 + 10) >> 8 & 0xf) == 2) {
            pt_00.y = *(short *)(iVar7 + 6);
            pt_00.x = (lpord->pt).x;
            sVar13 = FFindNearestObject(pt_00,0x81,(SCAN *)&pl.iPlayer);
            if (sVar13 == 0) {
              *(uint *)(iVar7 + 10) = *(uint *)(iVar7 + 10) & 0xf0ff | 0x400;
              *(undefined2 *)(iVar7 + 8) = 0;
            }
            else {
              *(uint *)(iVar7 + 10) = *(uint *)(iVar7 + 10) & 0xf0ff | 0x100;
              *(undefined2 *)(byte *)(iVar7 + 8) = pl.rgMinConc._1_2_;
            }
          }
          pPVar17 = (PLPROD *)pl.lpplprod;
          uVar22 = (undefined2)((ulong)pl.lpplprod >> 0x10);
          if ((((*(uint *)(iVar7 + 10) & 0xf) == 0) && (1 < *(int *)&pPVar17[0x18].iprodMax)) &&
             ((*(uint *)(iVar7 + 0x1c) & 0xf) == 7)) {
            *(uint *)(iVar7 + 10) = *(uint *)(iVar7 + 10) & 0xfff0 | 7;
            uVar8 = *(undefined2 *)(iVar7 + 0x20);
            *(undefined2 *)(iVar7 + 0xc) = *(undefined2 *)(iVar7 + 0x1e);
            *(undefined2 *)(iVar7 + 0xe) = uVar8;
          }
          if (((*(uint *)(iVar7 + 10) & 0xf) == 7) &&
             ((*(int *)&pPVar17[0x18].iprodMax < 2 || ((*(uint *)(iVar7 + 0x1c) >> 8 & 0xf) != 2))))
          {
            lpflBest = (FLEET *)0x0;
            lBest = 100000000;
            fFoundIdeal = 0;
            if ((*(int *)&pPVar17[1].iprodMax == -1) &&
               ((1 < *(int *)&pPVar17[0x18].iprodMax &&
                (((uint)(pPVar17 + 1)->wFlags >> 9 & 1) != 0)))) {
              pt.x = *(short *)(iVar7 + 0x16);
              pt.y = *(short *)(iVar7 + 0x18);
            }
            else {
              pt.x = (pPVar17 + 2)->wFlags;
              pt.y = *(short *)&pPVar17[2].iprodMax;
            }
            lpbtlplan_2 = (BTLPLAN *)
                          CONCAT22(((undefined2 *)&DAT_1120_593a)[*(int *)&pPVar17->iprodMax * 2],
                                   ((BTLPLAN **)rglpbtlplan)
                                   [*(int *)&pPVar17->iprodMax * 2] + (byte)(pPVar17 + 0x18)->wFlags
                                  );
            pl.id = ((BTLPLAN **)rglpbtlplan)[*(int *)&pPVar17->iprodMax * 2]
                    [(byte)(pPVar17 + 0x18)->wFlags].wFlags & 0xf;
            for (iflT = 0; iflT < cFleet; iflT = iflT + 1) {
                    /* WARNING: Load size is inaccurate */
              pFVar9 = ((FLEET **)rglpfl)[iflT];
              iVar16 = *(int *)((int)((FLEET **)rglpfl + iflT) + 2);
              if ((pFVar9 == (FLEET *)0x0) && (iVar16 == 0)) break;
              if ((((uint)pFVar9->wFlags >> 8 & 1) != 0) && (pFVar9->iPlayer != iPlayer)) {
                dx._0_2_ = (&pFVar9->pt)->x - pt.x;
                dx._2_2_ = (int)dx >> 0xf;
                dy._0_2_ = (pFVar9->pt).y - pt.y;
                dy._2_2_ = (int)dy >> 0xf;
                uVar24 = __aFulmul((long)(int)dy,(long)(int)dy);
                uStack_7e = uVar24;
                uVar24 = __aFulmul(CONCAT22(dx._2_2_,(int)dx),CONCAT22(dx._2_2_,(int)dx));
                l = uVar24 + uStack_7e;
                if (((fFoundIdeal == 0) && (-1 < pFVar9->wFlags)) ||
                   ((l < lBest && ((fFoundIdeal == 0 || (-1 < pFVar9->wFlags)))))) {
                  sVar13 = FMatchTarget((FLEET *)CONCAT22(iVar16,pFVar9),pl.id,0);
                  if (sVar13 != 0) {
                    sVar13 = FAttackPlayer((FLEET *)pl.lpplprod,pFVar9->iPlayer);
                    if ((sVar13 != 0) &&
                       (lpflBest = (FLEET *)CONCAT22(iVar16,pFVar9), lBest = l, -1 < pFVar9->wFlags)
                       ) {
                      fFoundIdeal = 1;
                    }
                  }
                }
              }
            }
            if ((fFoundIdeal != 0) && (((uint)gd._0_2_ >> 0xb & 1) == 0)) {
              ((FLEET *)lpflBest)->wFlags = ((FLEET *)lpflBest)->wFlags & 0x7fffU | 0x8000;
            }
            j = *(int *)(iVar7 + 0xe) * 0x32 + 0x32;
            if (j == 0x226) {
              j = 10000;
            }
            if ((((FLEET *)lpflBest != (FLEET *)0x0) || (lpflBest._2_2_ != 0)) && (lBest != 0)) {
              uVar24 = __aFulmul((long)j,(long)j);
              if (lBest <= (long)uVar24) {
                uVar23 = (undefined2)((ulong)pl.lpplprod >> 0x10);
                pPVar17 = (PLPROD *)pl.lpplprod;
                if ((int)(uint)*(byte *)(pPVar17[0x19].wFlags + 2) <=
                    *(int *)&pPVar17[0x18].iprodMax + 1) {
                  pPVar25 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)
                                                                &pPVar17[0x19].iprodMax,
                                                               (PL *)(pPVar17 + 0x19)->wFlags),
                                                *(int *)&pPVar17[0x18].iprodMax + 2);
                  uVar23 = (undefined2)((ulong)pl.lpplprod >> 0x10);
                  pPVar17 = (PLPROD *)pl.lpplprod;
                  (pPVar17 + 0x19)->wFlags = (short)(PL *)pPVar25;
                  *(int *)&pPVar17[0x19].iprodMax = (int)((ulong)pPVar25 >> 0x10);
                  lpord = (ORDER *)CONCAT22(*(undefined2 *)&pPVar17[0x19].iprodMax,
                                            (ORDER *)((pPVar17 + 0x19)->wFlags + 4));
                }
                uVar23 = (undefined2)((ulong)pl.lpplprod >> 0x10);
                if (1 < *(int *)&((PLPROD *)pl.lpplprod)[0x18].iprodMax) {
                  __fmemmove((ORDER *)CONCAT22(lpord._2_2_,(ORDER *)lpord + 2),
                                     (ORDER *)CONCAT22(lpord._2_2_,(ORDER *)lpord + 1),
                                     (*(int *)&((PLPROD *)pl.lpplprod)[0x18].iprodMax + -1) * 0x12);
                }
                if (*(int *)&((PLPROD *)pl.lpplprod)[0x18].iprodMax == 1) {
                  __fmemset((ORDER *)CONCAT22(lpord._2_2_,(ORDER *)lpord + 1),0,0x12);
                  ((ORDER *)lpord)[1].wFlags = ((ORDER *)lpord)[1].wFlags & 0xefffU | 0x1000;
                  ((ORDER *)lpord)[1].wFlags = ((ORDER *)lpord)[1].wFlags & 0xfff0U | 7;
                  sVar13 = ((((ORDER *)lpord)->txp).rgia + 1)->wFlags;
                  (&((ORDER *)lpord)[1].txp)->rgia[0].wFlags =
                       (&((ORDER *)lpord)->txp)->rgia[0].wFlags;
                  (((ORDER *)lpord)[1].txp.rgia + 1)->wFlags = sVar13;
                  if ((&((ORDER *)lpord)[1].txp)->rgia[0].wFlags == 0) {
                    uVar12 = IFindIdealWarp((FLEET *)pl.lpplprod,0);
                    ((ORDER *)lpord)[1].wFlags =
                         ((ORDER *)lpord)[1].wFlags & 0xff0fU | (uVar12 & 0xf) << 4;
                    uStack_7e._2_2_ = uVar12;
                  }
                  else {
                    uStack_7e._2_2_ = (&((ORDER *)lpord)[1].txp)->rgia[0].wFlags;
                    ((ORDER *)lpord)[1].wFlags =
                         ((ORDER *)lpord)[1].wFlags & 0xff0fU | (uStack_7e._2_2_ & 0xf) << 4;
                  }
                  if (((uint)((PLPROD *)pl.lpplprod + 1)->wFlags >> 9 & 1) != 0) {
                    pOVar20 = (ORDER *)lpord + 2;
                    pOVar18 = (ORDER *)lpord;
                    for (iVar16 = 9; iVar16 != 0; iVar16 = iVar16 + -1) {
                      pOVar5 = pOVar20;
                      pOVar20 = (ORDER *)&(pOVar20->pt).y;
                      pOVar3 = pOVar18;
                      pOVar18 = (ORDER *)&(pOVar18->pt).y;
                      (pOVar5->pt).x = (pOVar3->pt).x;
                    }
                    uStack_7e._2_2_ = IFindIdealWarp((FLEET *)pl.lpplprod,0);
                    ((ORDER *)lpord)[2].wFlags =
                         ((ORDER *)lpord)[2].wFlags & 0xff0fU | (uStack_7e._2_2_ & 0xf) << 4;
                    uVar23 = (undefined2)((ulong)pl.lpplprod >> 0x10);
                    pbVar1 = &((PLPROD *)pl.lpplprod)[0x18].iprodMax;
                    *(int *)pbVar1 = *(int *)pbVar1 + 1;
                    PVar10 = ((PLPROD *)pl.lpplprod)[0x19];
                    pcVar2 = (char *)(PVar10.wFlags + 3);
                    *pcVar2 = *pcVar2 + '\x01';
                  }
                }
                else if ((&((ORDER *)lpord)[1].txp)->rgia[0].wFlags == 0) {
                  uVar12 = IFindIdealWarp((FLEET *)pl.lpplprod,0);
                  ((ORDER *)lpord)[1].wFlags =
                       ((ORDER *)lpord)[1].wFlags & 0xff0fU | (uVar12 & 0xf) << 4;
                  uStack_7e._2_2_ = uVar12;
                }
                else {
                  uStack_7e._2_2_ = (&((ORDER *)lpord)[1].txp)->rgia[0].wFlags;
                  ((ORDER *)lpord)[1].wFlags =
                       ((ORDER *)lpord)[1].wFlags & 0xff0fU | (uStack_7e._2_2_ & 0xf) << 4;
                }
                uVar23 = (undefined2)((ulong)lpflBest >> 0x10);
                sVar13 = (((FLEET *)lpflBest)->pt).y;
                (((ORDER *)lpord + 1)->pt).x = (&((FLEET *)lpflBest)->pt)->x;
                ((ORDER *)lpord)[1].pt.y = sVar13;
                ((ORDER *)lpord)[1].id = lpflBest->id;
                ((ORDER *)lpord)[1].wFlags = ((ORDER *)lpord)[1].wFlags & 0xf0ffU | 0x200;
                uVar23 = (undefined2)((ulong)pl.lpplprod >> 0x10);
                pbVar1 = &((PLPROD *)pl.lpplprod)[0x18].iprodMax;
                *(int *)pbVar1 = *(int *)pbVar1 + 1;
                PVar10 = ((PLPROD *)pl.lpplprod)[0x19];
                pcVar2 = (char *)(PVar10.wFlags + 3);
                *pcVar2 = *pcVar2 + '\x01';
                FSendPlrMsg(iPlayer,idmPatrollingHasTargetedIntercept,
                                 (pl.lpplprod)->wFlags | 0x8000,(pl.lpplprod)->wFlags,lpflBest->id,0
                                 ,0,0,0,0);
              }
            }
          }
          uVar23 = (undefined2)((ulong)lpord >> 0x10);
          pOVar18 = (ORDER *)lpord;
          if (((pOVar18->wFlags & 0xfU) != 1) &&
             (1 < *(int *)&((PLPROD *)pl.lpplprod)[0x18].iprodMax)) {
            for (pl.rgwtMin[1]._0_2_ = 1;
                (int)pl.rgwtMin[1] < *(int *)&((PLPROD *)pl.lpplprod)[0x18].iprodMax;
                pl.rgwtMin[1]._0_2_ = (int)pl.rgwtMin[1] + 1) {
              if (((uint)pOVar18[(int)pl.rgwtMin[1]].wFlags >> 8 & 0xf) == 8) {
                pTVar26 = LpthFromId(pOVar18[(int)pl.rgwtMin[1]].id);
                iVar16 = (int)((ulong)pTVar26 >> 0x10);
                pTVar11 = (THING *)pTVar26;
                if ((((pTVar11 == (THING *)0x0) && (iVar16 == 0)) ||
                    (((uint)pTVar26->idFull >> 0xd == 3 &&
                     ((*(uint *)(pTVar11->rgb + 4) >> 4 & 1) == 0)))) ||
                   ((((uint)pTVar26->idFull >> 0xd == 0 &&
                     ((1 << (bVar15 & 0x1f) & *(uint *)(pTVar11->rgb + 8)) == 0)) ||
                    (((uint)pTVar26->idFull >> 0xd == 2 && ((*(uint *)pTVar11->rgb >> 0xd & 1) == 0)
                     ))))) {
                  pPVar17 = (PLPROD *)pl.lpplprod;
                  uVar22 = (undefined2)((ulong)pl.lpplprod >> 0x10);
                  if (((pTVar11 == (THING *)0x0) && (iVar16 == 0)) ||
                     ((uint)pTVar26->idFull >> 0xd != 2)) {
                    if (((pTVar11 == (THING *)0x0) && (iVar16 == 0)) ||
                       ((uint)pTVar26->idFull >> 0xd != 3)) {
                      if (((pTVar11 != (THING *)0x0) || (iVar16 != 0)) &&
                         ((uint)pTVar26->idFull >> 0xd == 0)) {
                        FSendPlrMsg2(*(short *)&pPVar17->iprodMax,
                                          idmMineFieldHeadingHasVanishedOrdersHave,
                                          (pl.lpplprod)->wFlags | 0x8000,(pl.lpplprod)->wFlags,0);
                      }
                    }
                    else {
                      FSendPlrMsg2(*(short *)&pPVar17->iprodMax,
                                        idmMysteryTraderHeadingHasVanishedOrdersHave,
                                        (pl.lpplprod)->wFlags | 0x8000,(pl.lpplprod)->wFlags,0);
                    }
                  }
                  else {
                    FSendPlrMsg2(*(short *)&pPVar17->iprodMax,
                                      idmWormholeHeadingHasVanishedOrdersHaveChanged,
                                      (pl.lpplprod)->wFlags | 0x8000,(pl.lpplprod)->wFlags,0);
                  }
                  pl.id = pOVar18[(int)pl.rgwtMin[1]].wFlags & 0xf0ffU | 0x400;
                  pOVar18[(int)pl.rgwtMin[1]].wFlags = pl.id;
                  pOVar18[(int)pl.rgwtMin[1]].id = (int)pl.rgwtMin[1];
                }
              }
              else if (((uint)pOVar18[(int)pl.rgwtMin[1]].wFlags >> 8 & 0xf) == 2) {
                fNoAutoTrack = (uint)pOVar18[(int)pl.rgwtMin[1]].wFlags >> 0xd & 1;
                if (fNoAutoTrack != 0) {
                  pl.id = pOVar18[(int)pl.rgwtMin[1]].wFlags & 0xdfff;
                  pOVar18[(int)pl.rgwtMin[1]].wFlags = pl.id;
                }
                lpflT = LpflFromId(pOVar18[(int)pl.rgwtMin[1]].id);
                iVar16 = (int)((ulong)lpflT >> 0x10);
                pFVar9 = (FLEET *)lpflT;
                if (((pFVar9 == (FLEET *)0x0) && (iVar16 == 0)) ||
                   (((uint)pFVar9->wFlags >> 10 & 1) != 0)) {
                  FSendPlrMsg(iPlayer,idmSWaypointAppearsHaveDestroyedHasDisappeared,
                                   (pl.lpplprod)->wFlags | 0x8000,(pl.lpplprod)->wFlags,
                                   pOVar18[(int)pl.rgwtMin[1]].id,0,0,0,0,0);
                }
                else {
                  if (((uint)pFVar9->wFlags >> 8 & 1) != 0) goto LAB_1070_618a;
                  if ((pFVar9->idPlanet == -1) || (fNoAutoTrack != 0)) {
                    FSendPlrMsg(iPlayer,idmFleetTrackingAppearsHaveOutrunRangeScanners,
                                     (pl.lpplprod)->wFlags | 0x8000,(pl.lpplprod)->wFlags,0,0,0,0,0,
                                     0);
                  }
                  else {
                    FSendPlrMsg(iPlayer,idmFleetTrackingAppearsHaveDuckedBehindOrders,
                                     (pl.lpplprod)->wFlags | 0x8000,(pl.lpplprod)->wFlags,
                                     pFVar9->idPlanet,0,0,0,0,0);
                  }
                }
                pl.id = pOVar18[(int)pl.rgwtMin[1]].wFlags & 0xf0ffU | 0x400;
                pOVar18[(int)pl.rgwtMin[1]].wFlags = pl.id;
                pOVar18[(int)pl.rgwtMin[1]].id = (int)pl.rgwtMin[1];
                pt_01.y = pOVar18[(int)pl.rgwtMin[1]].pt.y;
                pt_01.x = ((pOVar18 + (int)pl.rgwtMin[1])->pt).x;
                sVar13 = FFindNearestObject(pt_01,0x81,(SCAN *)&pl.iPlayer);
                if (sVar13 != 0) {
                  pl.id = pOVar18[(int)pl.rgwtMin[1]].wFlags & 0xf0ffU | 0x100;
                  pOVar18[(int)pl.rgwtMin[1]].wFlags = pl.id;
                  pOVar18[(int)pl.rgwtMin[1]].id = pl.rgMinConc._1_2_;
                }
              }
LAB_1070_618a:
            }
          }
        }
      }
    }
  }
  MarkPlayersThatSentMsgs(iPlayer);
  MarkPlanetsPlayerLost(iPlayer);
  if (iPlayer == -1) {
    _WSPRINTF((LPSTR)CONCAT22(pszFileBase,(char *)&DAT_1120_1120),(LPCSTR)0x9fe1120,
              (char *)szWork);
  }
  else {
    _WSPRINTF((LPSTR)CONCAT22(pszFileBase,(char *)&DAT_1120_1120),(LPCSTR)0xa051120,
              (char *)szWork);
  }
  penvMemSav = penvMem;
  penvMem = (short (*) [9])((int)pl.rgwtMin + 6);
  sVar13 = __setjmp((void *)((int)pl.rgwtMin + 6));
  if (sVar13 == 0) {
    if (fAppend == 0) {
LAB_1070_677e:
      if (iPlayer == -1) {
        dt = dtHost;
      }
      else {
        dt = dtTurn;
      }
      sVar13 = FCreateFile(dt,iPlayer,(char *)0x0);
      if (sVar13 == 0) goto IO_LFail_2;
    }
    else {
      sVar13 = FAppendFile(iPlayer);
      if (sVar13 == 0) goto LAB_1070_677e;
    }
    WriteBattles(iPlayer);
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) ||
         ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0)) {
        sVar13 = GetRaceStat((PLAYER *)rgplr + iPlayer,rsMajorAdv);
        if (sVar13 == raTerra) {
          pl.id = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 7;
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) = pl.id;
        }
        WriteRtPlr((PLAYER *)rgplr + i,(byte *)0x0);
      }
    }
    if ((iPlayer == -1) && (((int)lSaltCur != 0 || (lSaltCur._2_2_ != 0)))) {
      WriteRt(0x24,4,&lSaltCur);
    }
    WritePlayerMessages(iPlayer);
    pl.dwFlags._0_2_ = lpPlanets._2_2_;
    pl.uGuesses = (short)(PLANET *)lpPlanets;
    for (i = 0; i < cPlanet; i = i + 1) {
      uVar23 = (undefined2)pl.dwFlags;
      puVar19 = pl.uGuesses;
      if (((uint)puVar19[2] >> 8 & 1) != 0) {
        if ((puVar19[2] & 0xff) == 7) {
          WritePlanet((PLANET *)pl._18_4_,0xd,0);
          uVar23 = (undefined2)pl.dwFlags;
          iVar16 = pl.uGuesses;
          if ((*(int *)(iVar16 + 0x34) != 0) || (*(int *)(iVar16 + 0x36) != 0)) {
            WriteRt(0x1c,(uint)*(byte *)((int)*(undefined4 *)(iVar16 + 0x34) + 3) << 2,
                    (void *)CONCAT22(*(undefined2 *)(iVar16 + 0x36),
                                     (void *)(*(int *)(iVar16 + 0x34) + 4)));
          }
        }
        else if ((puVar19[2] & 0xff) == 2) {
          puVar21 = auStack_8c;
          for (iVar16 = 0x1c; iVar16 != 0; iVar16 = iVar16 + -1) {
            puVar6 = puVar21;
            puVar21 = puVar21 + 1;
            puVar4 = puVar19;
            puVar19 = puVar19 + 1;
            *puVar6 = *puVar4;
          }
          uVar23 = (undefined2)pl.dwFlags;
          iVar16 = pl.uGuesses;
          *(uint *)(iVar16 + 4) = *(uint *)(iVar16 + 4) & 0xfdff;
          *(uint *)(iVar16 + 4) = *(uint *)(iVar16 + 4) & 0xff00 | 3;
          WritePlanet((PLANET *)pl._18_4_,0xe,0);
          puVar19 = auStack_8c;
          puVar21 = pl.uGuesses;
          for (iVar16 = 0x1c; iVar16 != 0; iVar16 = iVar16 + -1) {
            puVar6 = puVar21;
            puVar21 = puVar21 + 1;
            puVar4 = puVar19;
            puVar19 = puVar19 + 1;
            *puVar6 = *puVar4;
          }
        }
        else {
          WritePlanet((PLANET *)pl._18_4_,0xe,0);
        }
      }
      pl.uGuesses = pl.uGuesses + 0x38;
    }
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
        pl.rgwtMin[0]._0_2_ = *(int *)(i * 4 + 0xfe);
        pl.rgwtMin[0]._2_2_ = *(undefined2 *)(i * 4 + 0x100);
        for (j = 0; j < 0x10; j = j + 1) {
          if (((*(uint *)((int)pl.rgwtMin[0] + j * 0x93 + 0x7b) >> 9 & 1) == 0) &&
             ((*(uint *)((int)pl.rgwtMin[0] + j * 0x93 + 0x7b) >> 8 & 1) != 0)) {
            WriteRtShDef((SHDEF *)CONCAT22(pl.rgwtMin[0]._2_2_,
                                           (SHDEF *)((int)pl.rgwtMin[0] + j * 0x93)),(byte **)0x0);
          }
        }
      }
    }
    for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar9 = ((FLEET **)rglpfl)[i];
      iVar16 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpflT = (FLEET *)CONCAT22(iVar16,pFVar9);
      if ((pFVar9 == (FLEET *)0x0) && (iVar16 == 0)) break;
      if (((uint)pFVar9->wFlags >> 8 & 1) != 0) {
        WriteFleet((FLEET *)CONCAT22(iVar16,pFVar9));
      }
    }
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
        pl.rgwtMin[0]._0_2_ = *(int *)(i * 4 + 0x14c);
        pl.rgwtMin[0]._2_2_ = *(undefined2 *)(i * 4 + 0x14e);
        for (j = 0; j < 10; j = j + 1) {
          if (((*(uint *)((int)pl.rgwtMin[0] + j * 0x93 + 0x7b) >> 9 & 1) == 0) &&
             ((*(uint *)((int)pl.rgwtMin[0] + j * 0x93 + 0x7b) >> 8 & 1) != 0)) {
            WriteRtShDef((SHDEF *)CONCAT22(pl.rgwtMin[0]._2_2_,
                                           (SHDEF *)((int)pl.rgwtMin[0] + j * 0x93)),(byte **)0x0);
          }
        }
      }
    }
    if ((iPlayer != -1) &&
       (((SCOREX *)vlprgScoreX != (SCOREX *)0x0 || (vlprgScoreX._2_2_ != 0)))) {
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if (((((gd.wFlags & 1U) != 0) || (i == iPlayer)) ||
            ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0)) ||
           ((((uint)game.wCrap >> 6 & 1) != 0 && (0x13 < (uint)game.turn)))) {
          WriteRt(0x2d,0x18,
                  (SCOREX *)CONCAT22(vlprgScoreX._2_2_,(SCOREX *)vlprgScoreX + i));
        }
      }
    }
    i = 0;
    pl.id = lpThings._2_2_;
    pl.dwFlags._0_2_ = (THING *)lpThings + cThing;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < (THING *)pl.dwFlags) {
      if ((((iPlayer == -1) ||
           ((((iPlayer == ((uint)lpth->idFull >> 9 & 0xf) && ((uint)lpth->idFull >> 0xd != 1)) &&
             (((uint)lpth->idFull >> 0xd != 3 && ((uint)lpth->idFull >> 0xd != 2)))) ||
            (((uint)lpth->idFull >> 0xd == 0 &&
             ((1 << (bVar15 & 0x1f) & *(uint *)(((THING *)lpth)->rgb + 8)) != 0)))))) ||
          (((uint)lpth->idFull >> 0xd == 1 && (*(int *)((THING *)lpth)->rgb < 0)))) ||
         ((((uint)lpth->idFull >> 0xd == 3 && ((*(uint *)(((THING *)lpth)->rgb + 4) >> 4 & 1) != 0))
          || (((uint)lpth->idFull >> 0xd == 2 && ((*(uint *)((THING *)lpth)->rgb >> 0xd & 1) != 0)))
          ))) {
        i = i + 1;
      }
      lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
    }
    pl.dwFlags._2_2_ = pl.id;
    if (0 < i) {
      WriteRt(0x2b,2,(short *)CONCAT22(unaff_SS,&i));
      pl.id = lpThings._2_2_;
      pl.dwFlags._0_2_ = (THING *)lpThings + cThing;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      pl.dwFlags._2_2_ = pl.id;
      while ((THING *)lpth < (THING *)pl.dwFlags) {
        if ((((iPlayer == -1) ||
             ((((iPlayer == ((uint)lpth->idFull >> 9 & 0xf) && ((uint)lpth->idFull >> 0xd != 1)) &&
               ((uint)lpth->idFull >> 0xd != 3)) && ((uint)lpth->idFull >> 0xd != 2)))) ||
            ((((uint)lpth->idFull >> 0xd == 0 &&
              ((1 << (bVar15 & 0x1f) & *(uint *)(((THING *)lpth)->rgb + 8)) != 0)) ||
             ((((uint)lpth->idFull >> 0xd == 1 && (*(int *)((THING *)lpth)->rgb < 0)) ||
              (((uint)lpth->idFull >> 0xd == 3 &&
               ((*(uint *)(((THING *)lpth)->rgb + 4) >> 4 & 1) != 0)))))))) ||
           (((uint)lpth->idFull >> 0xd == 2 && ((*(uint *)((THING *)lpth)->rgb >> 0xd & 1) != 0))))
        {
          WriteRt(0x2b,0x12,lpth);
        }
        lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
      }
    }
    if (iPlayer == -1) {
      i = 0;
      iMax = game.cPlayer;
    }
    else {
      i = iPlayer;
      iMax = iPlayer + 1;
    }
    for (; i < iMax; i = i + 1) {
      lpbtlplan._0_2_ = ((BTLPLAN **)rglpbtlplan)[i * 2];
      lpbtlplan._2_2_ = ((undefined2 *)&DAT_1120_593a)[i * 2];
      for (j = 0; j < (int)(uint)((byte *)rgcbtlplan)[i]; j = j + 1) {
        WriteBattlePlan((BTLPLAN *)CONCAT22(lpbtlplan._2_2_,(BTLPLAN *)lpbtlplan),0);
        lpbtlplan._0_2_ = (BTLPLAN *)lpbtlplan + 1;
      }
    }
    WriteRt(0,2,&game.turn);
    StreamClose();
  }
  else {
IO_LFail_2:
    idPlayer = iPlayer;
    if (fAppend == 0) {
      if (iPlayer == -1) {
        idPlayer = -1;
        sVar13 = 0x10;
        pcVar14 = PszFormatIds(idsUnableCreateHostFile,(short *)0x0);
        AlertSz(pcVar14,sVar13);
      }
      else {
        sVar13 = 0x10;
        pcVar14 = PszFormatIds(idsUnableCreateNewTurnFile,(short *)0x0);
        AlertSz(pcVar14,sVar13);
      }
    }
    else {
      sVar13 = 0x10;
      pcVar14 = PszFormatIds(idsUnableUpdateTurnFile,(short *)0x0);
      AlertSz(pcVar14,sVar13);
    }
    idPlayer = -1;
    pl.dwFlags._2_2_ = 0;
  }
  SetVisiblePlanFleet(-1);
  return pl.dwFlags._2_2_;
}



// ======================================================================
// Function: FAppendFile
// Address: 1070:704e
// Segment: MEMORY_IO
// ======================================================================


short FAppendFile(short iPlayer)

{
  short sVar1;
  
  sVar1 = FMarkFile(0x2003,iPlayer,4,1);
  if (sVar1 != 0) {
    WriteBOF(iPlayer,3,1);
  }
  return (uint)(sVar1 != 0);
}



// ======================================================================
// Function: WriteBattles
// Address: 1070:709c
// Segment: MEMORY_IO
// ======================================================================


void WriteBattles(short iPlayer)

{
  char *pcVar1;
  uint *puVar2;
  HB *pHVar3;
  FLEET *pFVar4;
  byte *pbVar5;
  uint uVar6;
  BTLREC *pBVar7;
  undefined2 uVar8;
  HB *pHVar9;
  BTLDATA *pBVar10;
  int iVar11;
  int iVar12;
  undefined2 uVar13;
  FLEET *pFVar14;
  PLANET *lppl_00;
  short iplr;
  short cb;
  BTLDATA *lpbtldata;
  HB *lphb;
  byte *lpbBattle;
  BTLREC *lpbtlrec;
  ushort fPlayerCur;
  short cbT;
  FLEET *lpfl;
  short i;
  PLANET *lppl;
  short cbRec;
  short ctok;
  
  if ((iPlayer != -1) &&
     (((byte *)lpbBattleLog != (byte *)lpbBattleCur ||
      (lpbBattleLog._2_2_ != lpbBattleCur._2_2_)))) {
    lphb = (HB *)CONCAT22(DAT_1120_0d60._2_2_,(HB *)DAT_1120_0d60);
    lpbBattle._0_2_ = (byte *)&((HB *)DAT_1120_0d60)[1].cbBlock;
    lpbBattle._2_2_ = DAT_1120_0d60._2_2_;
    while (((HB *)lphb != (HB *)0x0 || (lphb._2_2_ != 0))) {
      lpbtldata = (BTLDATA *)CONCAT22(lpbBattle._2_2_,(byte *)lpbBattle);
      while( true ) {
        uVar13 = (undefined2)((ulong)lphb >> 0x10);
        pHVar9 = (HB *)lphb;
        if ((0x10 < (uint)pHVar9->ibTop) && (lpbtldata->id != -1)) break;
                    /* WARNING: Load size is inaccurate */
        pHVar3 = pHVar9->lphbNext;
        lpbBattle._2_2_ = *(int *)((int)&pHVar9->lphbNext + 2);
        lphb = (HB *)CONCAT22(lpbBattle._2_2_,pHVar3);
        if ((pHVar3 == (HB *)0x0) && (lpbBattle._2_2_ == 0)) {
          return;
        }
        lpbBattle._0_2_ = (byte *)&pHVar3[1].cbBlock;
        lpbtldata = (BTLDATA *)CONCAT22(lpbBattle._2_2_,(byte *)lpbBattle);
      }
      uVar13 = (undefined2)((ulong)lpbtldata >> 0x10);
      pBVar10 = (BTLDATA *)lpbtldata;
      if ((pBVar10->grfPlr & 1 << ((byte)iPlayer & 0x1f)) == 0) {
        lpbBattle._0_2_ = (byte *)lpbBattle + pBVar10->cbData;
      }
      else {
        for (i = 0; i < game.cPlayer; i = i + 1) {
          if (((i != iPlayer) &&
              ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) == 0)) &&
             ((1 << ((byte)i & 0x1f) & pBVar10->grfPlr) != 0)) {
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 3;
          }
        }
        for (i = 0; i < (int)(uint)pBVar10->ctok; i = i + 1) {
          if ((uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x10) != iPlayer) {
            if (*(char *)((int)pBVar10 + i * 0x1d + 0x11) == '\x01') {
              uVar6 = (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x10);
              LpplFromId(*(short *)((int)pBVar10 + i * 0x1d + 0xe));
              if ((*(uint *)(*(int *)(uVar6 * 4 + 0x14c) +
                             (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) >> 8
                  & 1) == 0) {
                *(uint *)(*(int *)(uVar6 * 4 + 0x14c) +
                          (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) =
                     *(uint *)(*(int *)(uVar6 * 4 + 0x14c) +
                               (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) &
                     0xfeff | 0x100;
                iVar11 = *(int *)((int)&rgplr[0].wFlags + uVar6 * 0xc0);
                puVar2 = (uint *)((int)&rgplr[0].wFlags + uVar6 * 0xc0);
                *puVar2 = *puVar2 & 0xfff;
                puVar2 = (uint *)((int)&rgplr[0].wFlags + uVar6 * 0xc0);
                *puVar2 = *puVar2 | iVar11 + 0x1000U & 0xf000;
              }
              *(uint *)(*(int *)(uVar6 * 4 + 0x14c) +
                        (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) =
                   *(uint *)(*(int *)(uVar6 * 4 + 0x14c) +
                             (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) &
                   0xff00 | 7;
            }
            else {
              pFVar14 = LpflFromId(*(short *)((int)pBVar10 + i * 0x1d + 0xe));
              uVar8 = (undefined2)((ulong)pFVar14 >> 0x10);
              pFVar4 = (FLEET *)pFVar14;
              if ((pFVar4->iPlayer != iPlayer) &&
                 ((*(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) >> 8 & 1) ==
                  0)) {
                *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) =
                     *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) & 0xfeff |
                     0x100;
                *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) =
                     *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) & 0xfff8 |
                     3;
              }
              iVar11 = pFVar4->iPlayer * 4;
              if ((*(uint *)(*(int *)(iVar11 + 0xfe) +
                             (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) >> 8 & 1
                  ) == 0) {
                iVar11 = pFVar4->iPlayer * 4;
                iVar12 = pFVar4->iPlayer * 4;
                *(uint *)(*(int *)(iVar12 + 0xfe) +
                          (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) =
                     *(uint *)(*(int *)(iVar11 + 0xfe) +
                               (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) &
                     0xfeff | 0x100;
                pcVar1 = (char *)((int)&rgplr[0].cShDef + pFVar4->iPlayer * 0xc0);
                *pcVar1 = *pcVar1 + '\x01';
              }
              iVar11 = pFVar4->iPlayer * 4;
              iVar12 = pFVar4->iPlayer * 4;
              *(uint *)(*(int *)(iVar12 + 0xfe) +
                        (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) =
                   *(uint *)(*(int *)(iVar11 + 0xfe) +
                             (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) & 0xff00
                   | 7;
              if (((uint)pFVar4->wFlags >> 10 & 1) == 0) {
                if (((uint)pFVar4->wFlags >> 8 & 1) == 0) {
                  iVar11 = *(int *)((int)&rgplr[0].wFlags + pFVar4->iPlayer * 0xc0);
                  puVar2 = (uint *)((int)&rgplr[0].wFlags + pFVar4->iPlayer * 0xc0);
                  *puVar2 = *puVar2 & 0xf000;
                  puVar2 = (uint *)((int)&rgplr[0].wFlags + pFVar4->iPlayer * 0xc0);
                  *puVar2 = *puVar2 | iVar11 + 1U & 0xfff;
                  pFVar4->wFlags = pFVar4->wFlags & 0xfeffU | 0x100;
                  pFVar4->wFlags = pFVar4->wFlags & 0xff00;
                }
                if ((pFVar4->wFlags & 0xffU) < 3) {
                  pFVar4->wFlags = pFVar4->wFlags & 0xff00U | 3;
                }
              }
            }
          }
        }
        if (pBVar10->idPlanet != -1) {
          lppl_00 = LpplFromId(pBVar10->idPlanet);
          MarkPlanet(lppl_00,iPlayer,1);
        }
        if ((uint)pBVar10->cbData < 0x400) {
          WriteRt(0x1f,pBVar10->cbData,(byte *)CONCAT22(lpbBattle._2_2_,(byte *)lpbBattle));
          lpbBattle._0_2_ = (byte *)lpbBattle + pBVar10->cbData;
        }
        else {
          uVar6 = (uint)pBVar10->ctok * 0x1d + 0xe;
          pBVar7 = (BTLREC *)((byte *)lpbBattle + uVar6);
          lpbtlrec = (BTLREC *)CONCAT22(lpbBattle._2_2_,pBVar7);
          if (uVar6 < 0x400) {
            WriteRt(0x1f,uVar6,(byte *)CONCAT22(lpbBattle._2_2_,(byte *)lpbBattle));
            lpbBattle._0_2_ = (byte *)lpbBattle + uVar6;
          }
          else {
            if (pBVar10->ctok < 0x23) {
              ctok = (short)pBVar10->ctok;
            }
            else {
              ctok = 0x22;
            }
            if ((uint)pBVar10->ctok < (uint)ctok) {
              ctok = (short)pBVar10->ctok;
            }
            WriteRt(0x1f,ctok * 0x1d + 0xe,(byte *)CONCAT22(lpbBattle._2_2_,(byte *)lpbBattle));
            lpbBattle._0_2_ = (byte *)lpbBattle + ctok * 0x1d + 0xe;
            ctok = (uint)pBVar10->ctok - ctok;
            while (0 < ctok) {
              if ((uint)ctok < 0x24) {
                WriteRt(0x27,ctok * 0x1d,(byte *)CONCAT22(lpbBattle._2_2_,(byte *)lpbBattle));
                lpbBattle._0_2_ = (byte *)lpbBattle + ctok * 0x1d;
                ctok = 0;
              }
              else {
                WriteRt(0x27,0x3f7,(byte *)CONCAT22(lpbBattle._2_2_,(byte *)lpbBattle));
                lpbBattle._0_2_ = (byte *)lpbBattle + 0x3f7;
                ctok = ctok + -0x23;
              }
            }
          }
          cb = pBVar10->cbData + -0xe + (uint)pBVar10->ctok * -0x1d;
          if (cb < 0x400) {
            WriteRt(0x27,cb,(BTLREC *)CONCAT22(lpbBattle._2_2_,pBVar7));
            lpbBattle._0_2_ = (byte *)lpbBattle + cb;
          }
          else {
            while (cb != 0) {
              cbRec = ((BTLREC *)lpbtlrec)->ctok * 8 + 6;
              if (cbRec < 0x400) {
                cbT = 0;
                do {
                  cbT = cbT + cbRec;
                  pbVar5 = &((BTLREC *)lpbtlrec)->itok;
                  lpbtlrec = (BTLREC *)CONCAT22(lpbtlrec._2_2_,(BTLREC *)(pbVar5 + cbRec));
                  cb = cb - cbRec;
                  if (cb == 0) break;
                  cbRec = ((BTLREC *)(pbVar5 + cbRec))->ctok * 8 + 6;
                } while (cbT + cbRec < 0x400);
                WriteRt(0x27,cbT,(byte *)CONCAT22(lpbBattle._2_2_,(byte *)lpbBattle));
              }
              else {
                cb = cb - cbRec;
                while( true ) {
                  if (cbRec < 0x400) break;
                  WriteRt(0x27,0x3ff,lpbtlrec);
                  lpbtlrec = (BTLREC *)
                             CONCAT22(lpbtlrec._2_2_,
                                      (BTLREC *)((int)&((BTLREC *)lpbtlrec)[0xaa].ctok + 1));
                  cbRec = cbRec + -0x3ff;
                }
                if (cbRec != 0) {
                  WriteRt(0x27,cbRec,lpbtlrec);
                  lpbtlrec = (BTLREC *)
                             CONCAT22(lpbtlrec._2_2_,(BTLREC *)(&((BTLREC *)lpbtlrec)->itok + cbRec)
                                     );
                }
              }
              lpbBattle._0_2_ = &((BTLREC *)lpbtlrec)->itok;
              lpbBattle._2_2_ = lpbtlrec._2_2_;
            }
          }
        }
      }
    }
  }
  return;
}



// ======================================================================
// Function: WritePlanet
// Address: 1070:7a6a
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x107080e7) */
/* WARNING: Removing unreachable block (ram,0x1070809d) */
/* WARNING: Removing unreachable block (ram,0x10708074) */
/* WARNING: Removing unreachable block (ram,0x107080c6) */
/* WARNING: Removing unreachable block (ram,0x10708110) */
/* WARNING: Removing unreachable block (ram,0x1070804b) */

void WritePlanet(PLANET *lppl,short rt,short fHistory)

{
  int iVar1;
  undefined2 uVar2;
  short sVar3;
  byte *pbVar4;
  uint uVar5;
  uint uVar6;
  uint uVar7;
  PLANET *pPVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar9;
  undefined2 unaff_SS;
  ulong uVar10;
  ulong uVar11;
  byte *pb;
  short i;
  byte *pbBase;
  byte rgb [80];
  byte bMask;
  
  uVar11 = CONCAT22(unaff_SI,unaff_DI);
  _memset(rgb,0,0x50);
  uVar9 = (undefined2)((ulong)lppl >> 0x10);
  pPVar8 = (PLANET *)lppl;
  rgb._0_2_ = lppl->id & 0x7ffU | pPVar8->iPlayer << 0xb;
  uVar6 = rgb._2_2_ & 0xff80;
  rgb._2_2_ = uVar6 | pPVar8->wFlags & 0x7fU;
  if ((rt == 0xe) && (3 < (pPVar8->wFlags & 0xffU))) {
    if (fHistory == 0) {
      uVar5 = 4;
    }
    else {
      uVar5 = 3;
    }
    rgb._2_2_ = uVar6 | uVar5;
  }
  uVar5 = (uint)((pPVar8->wRouting & 0x3ffU) != 0);
  uVar7 = rgb._2_2_ & 0x3c7f | ((uint)pPVar8->wFlags >> 8 & 1) << 8 |
          ((uint)pPVar8->wFlags >> 9 & 1) << 9 | ((uint)pPVar8->wFlags >> 10 & 1) << 7 |
          ((uint)pPVar8->wFlags >> 0xb) << 0xf | uVar5 << 0xe;
  pb = rgb + 4;
  uVar6 = rgb._2_2_ & 0x7f;
  rgb._2_2_ = uVar7;
  if (1 < uVar6) {
    pb = rgb + 5;
    bMask = 3;
    for (i = 0; i < 3; i = i + 1) {
      if (pPVar8->rgpctMinLevel[i] != 0) {
        rgb[4] = rgb[4] | bMask & 0x55;
        *pb = pPVar8->rgpctMinLevel[i];
        pb = pb + 1;
      }
      bMask = bMask << 2;
    }
    for (i = 0; i < 3; i = i + 1) {
      *pb = pPVar8->rgMinConc[i];
      pb = pb + 1;
    }
    for (i = 0; i < 3; i = i + 1) {
      *pb = pPVar8->rgEnvVar[i];
      uVar5 = (uint)pPVar8->rgEnvVar[i];
      if (uVar5 != (int)pPVar8->rgEnvVarOrig[i]) {
        rgb._2_2_ = rgb._2_2_ & 0xfbff | 0x400;
      }
      pb = pb + 1;
    }
    if (((uint)rgb._2_2_ >> 10 & 1) != 0) {
      for (i = 0; i < 3; i = i + 1) {
        *pb = pPVar8->rgEnvVarOrig[i];
        pb = pb + 1;
      }
    }
    if (pPVar8->iPlayer != -1) {
      *(short *)pb = pPVar8->uGuesses;
      pb = pb + 2;
    }
    pbVar4 = pb;
    if (3 < (rgb._2_2_ & 0x7f)) {
      pb = pb + 1;
      bMask = 3;
      for (i = 0; i < 4; i = i + 1) {
        if ((i != 3) || (6 < (pPVar8->wFlags & 0xffU))) {
          iVar1 = *(int *)((int)(pPVar8->rgwtMin + i) + 2);
          if ((-1 < iVar1) && ((0 < iVar1 || ((int)pPVar8->rgwtMin[i] != 0)))) {
            uVar6 = *(uint *)((int)(pPVar8->rgwtMin + i) + 2);
            if (((int)uVar6 < 0) || (((int)uVar6 < 1 && (*(uint *)(pPVar8->rgwtMin + i) < 0x100))))
            {
              *pbVar4 = *pbVar4 | bMask & 0x55;
              *pb = (byte)(int)pPVar8->rgwtMin[i];
              pb = pb + 1;
            }
            else {
              iVar1 = *(int *)((int)pPVar8->rgwtMin + i * 4 + 2);
              if ((iVar1 < 0) || (iVar1 < 1)) {
                *pbVar4 = *pbVar4 | bMask & 0xaa;
                *(int *)pb = (int)pPVar8->rgwtMin[i];
                pb = pb + 2;
              }
              else {
                *pbVar4 = *pbVar4 | bMask;
                uVar2 = *(undefined2 *)((int)(pPVar8->rgwtMin + i) + 2);
                *(int *)pb = (int)pPVar8->rgwtMin[i];
                *(undefined2 *)(pb + 2) = uVar2;
                pb = pb + 4;
              }
            }
          }
        }
        bMask = bMask << 2;
      }
      if (*pbVar4 != 0) {
        rgb._2_2_ = rgb._2_2_ & 0xdfff | 0x2000;
        pbVar4 = pb;
      }
      pb = pbVar4;
      if (rt != 0xe) {
        uVar10 = __aFulshr(uVar11,uVar5);
        uVar6 = (uint)uVar10 & 1;
        rgb._2_2_ = rgb._2_2_ & 0xefff | uVar6 << 0xc;
        if ((((pPVar8->iPlayer != -1) &&
             (((*(uint *)&pPVar8->dwFlags & 0xff) != 0 ||
              (uVar10 = __aFulshr(uVar11,uVar6), (uVar10 & 1) != 0)))) ||
            (uVar10 = __aFulshr(uVar11,uVar6), (uVar10 & 0xfff) != 0)) ||
           (((uVar10 = __aFulshr(uVar11,uVar6), (uVar10 & 0xfff) != 0 ||
             ((*(uint *)&pPVar8->dwFlags & 0xfff) != 0)) ||
            (uVar11 = __aFulshr(uVar11,uVar6), ((uint)uVar11 & 0x1f) != 0x1f)))) {
          rgb._2_2_ = rgb._2_2_ & 0xf7ff | 0x800;
          __fmemmove((byte *)CONCAT22((undefined1 *)&DAT_1120_1120,pb),
                             (long *)CONCAT22(uVar9,&pPVar8->dwFlags),8);
          pb = pb + 8;
        }
        if (pPVar8->iPlayer != -1) {
          if (((uint)pPVar8->wFlags >> 9 & 1) != 0) {
            sVar3 = pPVar8->wFlags;
            *(undefined2 *)pb = *(undefined2 *)&pPVar8->field11_0x2c;
            *(short *)(pb + 2) = sVar3;
            pb = pb + 4;
          }
          if ((pPVar8->wRouting & 0x3ffU) != 0) {
            *(short *)pb = pPVar8->wRouting;
            pb = pb + 2;
          }
        }
        WriteRt(0xd,(int)pb - (int)rgb,(byte *)CONCAT22(unaff_SS,rgb));
        return;
      }
    }
  }
  if (((uint)pPVar8->wFlags >> 9 & 1) != 0) {
    *pb = (byte)*(undefined2 *)&pPVar8->field11_0x2c & 0xf;
    pb = pb + 1;
  }
  if (fHistory != 0) {
    *(short *)pb = pPVar8->turn;
    pb = pb + 2;
  }
  WriteRt(0xe,(int)pb - (int)rgb,(byte *)CONCAT22(unaff_SS,rgb));
  return;
}



// ======================================================================
// Function: WriteFleet
// Address: 1070:81c6
// Segment: MEMORY_IO
// ======================================================================


void WriteFleet(FLEET *lpfl)

{
  undefined2 uVar1;
  short sVar2;
  long lVar3;
  byte *pbVar4;
  uint uVar5;
  int iVar6;
  undefined2 unaff_SS;
  ulong uVar7;
  long wt;
  ushort grMask;
  short fByte;
  byte *pb;
  short i;
  ushort us;
  byte rgb [134];
  ushort *pus;
  
  __fmemmove((byte *)CONCAT22(unaff_SS,rgb),lpfl,0xc);
  fByte = 1;
  grMask = 1;
  us = 0;
  for (i = 0; i < 0x10; i = i + 1) {
    if ((0 < ((FLEET *)lpfl)->rgcsh[i]) && (us = us | grMask, 0xff < ((FLEET *)lpfl)->rgcsh[i])) {
      fByte = 0;
    }
    grMask = grMask << 1;
  }
  rgb._4_2_ = rgb._4_2_ & 0xf7ff | fByte << 0xb;
  rgb[0xc] = (undefined1)us;
  rgb[0xd] = us._1_1_;
  pb = rgb + 0xe;
  if (fByte == 0) {
    pus = (ushort *)pb;
    for (i = 0; i < 0x10; i = i + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
        *pus = ((FLEET *)lpfl)->rgcsh[i];
        pus = pus + 1;
      }
    }
    pb = (byte *)pus;
  }
  else {
    for (i = 0; i < 0x10; i = i + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
        *pb = (byte)((FLEET *)lpfl)->rgcsh[i];
        pb = pb + 1;
      }
    }
  }
  pbVar4 = pb;
  if (3 < (((FLEET *)lpfl)->wFlags & 0xffU)) {
    grMask = 3;
    pb = pb + 2;
    us = 0;
    for (i = 0; i < 5; i = i + 1) {
      iVar6 = *(int *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
      if (((-1 < iVar6) && ((0 < iVar6 || ((int)((FLEET *)lpfl)->rgwtMin[i] != 0)))) &&
         (((((FLEET *)lpfl)->wFlags & 0xffU) == 7 || ((i != 4 && (i != 3)))))) {
        uVar5 = *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
        if (((int)uVar5 < 0) ||
           (((int)uVar5 < 1 && (*(uint *)(((FLEET *)lpfl)->rgwtMin + i) < 0x100)))) {
          us = us | grMask & 0x155;
          *pb = (byte)(int)((FLEET *)lpfl)->rgwtMin[i];
          pb = pb + 1;
        }
        else {
          iVar6 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + i * 4 + 2);
          if ((iVar6 < 0) || (iVar6 < 1)) {
            uVar5 = grMask & 0x2aa;
            *(int *)pb = (int)((FLEET *)lpfl)->rgwtMin[i];
            pb = pb + 2;
          }
          else {
            uVar5 = grMask & 0x3ff;
            uVar1 = *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
            *(int *)pb = (int)((FLEET *)lpfl)->rgwtMin[i];
            *(undefined2 *)(pb + 2) = uVar1;
            pb = pb + 4;
          }
          us = us | uVar5;
        }
      }
      grMask = grMask << 2;
    }
    *(ushort *)pbVar4 = us;
  }
  if ((((FLEET *)lpfl)->wFlags & 0xffU) < 7) {
    lVar3 = 0;
    sVar2 = ((FLEET *)lpfl)->wFlags;
    *(undefined2 *)pb = *(undefined2 *)&((FLEET *)lpfl)->field17_0x74;
    *(short *)(pb + 2) = sVar2;
    for (i = 0; i < 0x10; i = i + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
        iVar6 = ((FLEET *)lpfl)->iPlayer * 4;
        uVar7 = __aFulmul((long)((FLEET *)lpfl)->rgcsh[i],
                                  (ulong)*(uint *)(*(int *)(iVar6 + 0xfe) + i * 0x93 + 0x28));
        lVar3 = uVar7 + lVar3;
      }
    }
    i = 0;
    while( true ) {
      wt._2_2_ = (undefined2)((ulong)lVar3 >> 0x10);
      wt._0_2_ = (undefined2)lVar3;
      if (3 < i) break;
      lVar3 = lVar3 + CONCAT22(*(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2),
                               (int)((FLEET *)lpfl)->rgwtMin[i]);
      i = i + 1;
    }
    *(undefined2 *)(pb + 4) = (undefined2)wt;
    *(undefined2 *)(pb + 6) = wt._2_2_;
    WriteRt(0x11,(short)(pb + (8 - (int)rgb)),(byte *)CONCAT22(unaff_SS,rgb));
  }
  else {
    grMask = 1;
    us = 0;
    for (i = 0; i < 0x10; i = i + 1) {
      if ((((FLEET *)lpfl)->rgdv + i)->dp != 0) {
        us = us | grMask;
      }
      grMask = grMask << 1;
    }
    *(ushort *)pb = us;
    pus = (ushort *)(pb + 2);
    for (i = 0; i < 0x10; i = i + 1) {
      if ((((FLEET *)lpfl)->rgdv + i)->dp != 0) {
        *pus = (((FLEET *)lpfl)->rgdv + i)->dp;
        pus = pus + 1;
      }
    }
    *(byte *)pus = ((FLEET *)lpfl)->iplan;
    *(undefined1 *)((int)pus + 1) = (char)((FLEET *)lpfl)->cord;
    WriteRt(0x10,(int)pus + (2 - (int)rgb),(byte *)CONCAT22(unaff_SS,rgb));
    WriteOrders(lpfl);
    if ((*(int *)&((FLEET *)lpfl)->lpszName != 0) ||
       (*(int *)((int)&((FLEET *)lpfl)->lpszName + 2) != 0)) {
                    /* WARNING: Load size is inaccurate */
      WriteRtString((char *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2),
                                     ((FLEET *)lpfl)->lpszName));
    }
  }
  return;
}



// ======================================================================
// Function: WriteRtString
// Address: 1070:87b4
// Segment: MEMORY_IO
// ======================================================================


void WriteRtString(char *lpsz)

{
  short sVar1;
  ushort uVar2;
  undefined2 unaff_SS;
  short cOut;
  byte rgb [33];
  
  if ((lpsz != (char *)0x0) && (*lpsz != '\0')) {
    cOut = 0x1f;
    sVar1 = FCompressUserString(lpsz,(char *)CONCAT22(unaff_SS,rgb + 1),&cOut);
    if (sVar1 == 0) {
      __fstrcpy((char *)CONCAT22(unaff_SS,rgb + 1),lpsz);
      rgb[0] = 0;
      uVar2 = __fstrlen(lpsz);
      cOut = uVar2 + 1;
    }
    else {
      rgb[0] = (byte)cOut;
    }
    WriteRt(0x15,cOut + 1,(byte *)CONCAT22(unaff_SS,rgb));
  }
  return;
}



// ======================================================================
// Function: MarkFleet
// Address: 1070:885e
// Segment: MEMORY_IO
// ======================================================================


void MarkFleet(FLEET *lpfl,short det)

{
  uint *puVar1;
  int iVar2;
  undefined2 uVar3;
  FLEET *pFVar4;
  int iVar5;
  undefined2 uVar6;
  SHDEF *lpshdef;
  short i;
  
  uVar6 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar4 = (FLEET *)lpfl;
  if (((uint)pFVar4->wFlags >> 8 & 1) == 0) {
    iVar5 = pFVar4->iPlayer * 4;
    iVar2 = *(int *)(iVar5 + 0xfe);
    uVar3 = *(undefined2 *)(iVar5 + 0x100);
    pFVar4->wFlags = pFVar4->wFlags & 0xfeffU | 0x100;
    pFVar4->wFlags = pFVar4->wFlags & 0xff00;
    pFVar4->wFlags = pFVar4->wFlags & 0xffefU | 0x10;
    iVar5 = *(int *)((int)&rgplr[0].wFlags + pFVar4->iPlayer * 0xc0);
    puVar1 = (uint *)((int)&rgplr[0].wFlags + pFVar4->iPlayer * 0xc0);
    *puVar1 = *puVar1 & 0xf000;
    puVar1 = (uint *)((int)&rgplr[0].wFlags + pFVar4->iPlayer * 0xc0);
    *puVar1 = *puVar1 | iVar5 + 1U & 0xfff;
    for (i = 0; i < 0x10; i = i + 1) {
      if (pFVar4->rgcsh[i] != 0) {
        *(uint *)(iVar2 + i * 0x93 + 0x7b) = *(uint *)(iVar2 + i * 0x93 + 0x7b) & 0xfeff | 0x100;
      }
    }
  }
  if ((pFVar4->wFlags & 0xffU) < (uint)det) {
    pFVar4->wFlags = pFVar4->wFlags & 0xff00U | det & 0xffU;
  }
  return;
}



// ======================================================================
// Function: WriteBattlePlan
// Address: 1070:89b8
// Segment: MEMORY_IO
// ======================================================================


void WriteBattlePlan(BTLPLAN *lpbtlplan,short fLog)

{
  short sVar1;
  ushort uVar2;
  undefined2 unaff_SS;
  short cOut;
  char szPlanName [32];
  byte *pb;
  byte rgb [36];
  
  __fmemmove((byte *)CONCAT22(unaff_SS,rgb),lpbtlplan,4);
  if (((uint)lpbtlplan->wFlags >> 0xe & 1) == 0) {
    __fstrcpy((char *)CONCAT22(unaff_SS,szPlanName),
                      (char *)CONCAT22(lpbtlplan._2_2_,((BTLPLAN *)lpbtlplan)->szName));
    cOut = 0x1f;
    if ((szPlanName[0] == '\0') ||
       (sVar1 = FCompressUserString
                          ((char *)CONCAT22(unaff_SS,szPlanName),
                           (char *)CONCAT22((undefined1 *)&DAT_1120_1120,rgb + 5),&cOut), sVar1 == 0
       )) {
      _strcpy((char *)(rgb + 5),szPlanName);
      rgb[4] = 0;
      uVar2 = _strlen(szPlanName);
      pb = rgb + uVar2 + 6;
    }
    else {
      rgb[4] = (byte)cOut;
      pb = rgb + cOut + 5;
    }
  }
  else {
    pb = rgb + 2;
  }
  if (fLog == 0) {
    WriteRt(0x1e,(int)pb - (int)rgb,(byte *)CONCAT22(unaff_SS,rgb));
  }
  else {
    WriteMemRt(0x1e,(int)pb - (int)rgb,rgb);
  }
  return;
}



// ======================================================================
// Function: MarkPlanet
// Address: 1070:8adc
// Segment: MEMORY_IO
// ======================================================================


void MarkPlanet(PLANET *lppl,short iPlr,ushort det)

{
  int *piVar1;
  uint *puVar2;
  undefined2 uVar3;
  int iVar4;
  PLANET *pPVar5;
  int iVar6;
  undefined2 uVar7;
  SHDEF *lpshdef;
  
  uVar7 = (undefined2)((ulong)lppl >> 0x10);
  pPVar5 = (PLANET *)lppl;
  if (((uint)pPVar5->wFlags >> 8 & 1) == 0) {
    pPVar5->wFlags = pPVar5->wFlags & 0xfeffU | 0x100;
    pPVar5->wFlags = pPVar5->wFlags & 0xff00;
    piVar1 = (int *)((int)&rgplr[0].cPlanet + iPlr * 0xc0);
    *piVar1 = *piVar1 + 1;
  }
  if ((pPVar5->wFlags & 0xffU) < det) {
    pPVar5->wFlags = pPVar5->wFlags & 0xff00U | det & 0xff;
  }
  if ((pPVar5->iPlayer != -1) &&
     ((*(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) >> 8 & 1) == 0)) {
    *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) =
         *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) & 0xfeff | 0x100;
    *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) =
         *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) & 0xfff8 | 3;
  }
  if (((det != 2) && (pPVar5->iPlayer != -1)) && (((uint)pPVar5->wFlags >> 9 & 1) != 0)) {
    iVar6 = pPVar5->iPlayer * 4;
    uVar3 = *(undefined2 *)(iVar6 + 0x14e);
    iVar6 = *(int *)(iVar6 + 0x14c) + (*(uint *)&pPVar5->field11_0x2c & 0xf) * 0x93;
    if ((*(uint *)(iVar6 + 0x7b) >> 8 & 1) == 0) {
      *(uint *)(iVar6 + 0x7b) = *(uint *)(iVar6 + 0x7b) & 0xfeff | 0x100;
      *(uint *)(iVar6 + 0x7b) = *(uint *)(iVar6 + 0x7b) & 0xff00;
      iVar4 = *(int *)((int)&rgplr[0].wFlags + pPVar5->iPlayer * 0xc0);
      puVar2 = (uint *)((int)&rgplr[0].wFlags + pPVar5->iPlayer * 0xc0);
      *puVar2 = *puVar2 & 0xfff;
      puVar2 = (uint *)((int)&rgplr[0].wFlags + pPVar5->iPlayer * 0xc0);
      *puVar2 = *puVar2 | iVar4 + 0x1000U & 0xf000;
    }
    if ((*(uint *)(iVar6 + 0x7b) & 0xff) < 3) {
      *(uint *)(iVar6 + 0x7b) = *(uint *)(iVar6 + 0x7b) & 0xff00 | 3;
    }
  }
  return;
}



// ======================================================================
// Function: SetSzWorkFromDt
// Address: 1070:8cfe
// Segment: MEMORY_IO
// ======================================================================


void SetSzWorkFromDt(DtFileType dt,short iPlayer)

{
  char *pcVar1;
  char *pcVar2;
  int iVar3;
  undefined2 uVar4;
  char *pchDot;
  short c;
  char *pchSlash;
  
  pcVar1 = _strrchr((char *)szBase,0x2e);
  if ((pcVar1 != (char *)0x0) &&
     ((pcVar2 = _strrchr((char *)szBase,0x5c), pcVar2 == (char *)0x0 ||
      (pcVar2 < pcVar1)))) {
    *pcVar1 = '\0';
  }
  iVar3 = _WSPRINTF((LPSTR)0x56a21120,(LPCSTR)0xa0c1120,(char *)szWork);
  if (dt == dtXY) {
LAB_1070_8d76:
    _strcat((char *)szWork,(char *)0xa10);
  }
  else {
    if (dt != dtLog) {
      if (dt == dtHost) {
        _strcat((char *)szWork,(char *)0xa13);
        return;
      }
      if ((dt != dtTurn) && (dt != dtHist)) goto LAB_1070_8d76;
    }
    if (dt == dtLog) {
      uVar4 = 0x78;
    }
    else if (dt == dtHist) {
      uVar4 = 0x68;
    }
    else {
      uVar4 = 0x6d;
    }
    _WSPRINTF((LPSTR)CONCAT22(uVar4,(char *)&DAT_1120_1120),(LPCSTR)0xa171120,
              (char *)szWork + iVar3);
  }
  return;
}



// ======================================================================
// Function: FCreateFile
// Address: 1070:8e16
// Segment: MEMORY_IO
// ======================================================================


short FCreateFile(DtFileType dt,short iPlayer,char *szForceName)

{
  undefined2 uVar1;
  short sVar2;
  char *psz;
  short env [9];
  short (*penvMemSav) [9];
  
  if (szForceName == (char *)0x0) {
    SetSzWorkFromDt(dt,iPlayer);
    psz = (char *)szWork;
  }
  else {
    psz = szForceName;
  }
  uVar1 = penvMem;
  penvMem = env;
  sVar2 = __setjmp(env);
  if (sVar2 == 0) {
    StreamOpen(psz,0x1012);
    WriteBOF(iPlayer,dt,0);
  }
  penvMem = (short *)uVar1;
  return (uint)(sVar2 == 0);
}



// ======================================================================
// Function: WriteBOF
// Address: 1070:8ea4
// Segment: MEMORY_IO
// ======================================================================


void WriteBOF(short iPlayer,short dt,short fMulti)

{
  short sVar1;
  int iVar2;
  undefined2 unaff_SS;
  DWORD DVar3;
  RTBOF rtbof;
  
  _memset(&rtbof,0,0x10);
  _strncpy(rtbof.rgid,(char *)0xa1c,4);
  rtbof.lidGame._0_2_ = (undefined2)game.lid;
  rtbof.lidGame._2_2_ = game.lid._2_2_;
  rtbof.wVersion = 0x2a60;
  rtbof.turn = game.turn;
  rtbof.wFlags = rtbof.wFlags & 0xfffU | ((uint)game.wCrap >> 9) << 0xd;
  rtbof.wFlags = rtbof.wFlags & 0xffe0U | iPlayer & 0x1fU;
  sVar1 = Random(2000);
  DVar3 = GetTickCount();
  rtbof.wFlags = rtbof.wFlags & 0x1fU | ((int)DVar3 + sVar1) * 0x20;
  if ((dt == 2) && ((gd.wFlags & 1U) != 0)) {
    iVar2 = 1;
  }
  else {
    iVar2 = 0;
  }
  rtbof.wFlags = rtbof.wFlags & 0xf400U | dt & 0xffU | ((uint)gd._0_2_ >> 4 & 1) << 8 |
                 ((uint)gd._0_2_ >> 3 & 1) << 9 | iVar2 << 0xb;
  WriteRt(8,0x10,(RTBOF *)CONCAT22(unaff_SS,&rtbof));
  return;
}



// ======================================================================
// Function: FMarkFile
// Address: 1070:904a
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x107090a4) */

short FMarkFile(DtFileType dt,short iPlayer,short mdMark,short f)

{
  char *pcVar1;
  RTBOF *pRVar2;
  undefined2 uVar3;
  short sVar4;
  int iVar5;
  char *pcVar6;
  RTBOF *pRVar7;
  undefined2 unaff_SS;
  bool bVar8;
  long lSeedSav1;
  long lSeedSav2;
  short fSilentSav;
  short fSuccess;
  short fChange;
  short env [9];
  short (*penvMemSav) [9];
  RTBOF rtbof;
  short ids;
  
  fSilentSav = fFileErrSilent;
  fSuccess = 0;
  SetSzWorkFromDt(dt & 0xff,iPlayer);
  uVar3 = penvMem;
  penvMem = env;
  sVar4 = __setjmp(env);
  if (sVar4 != 0) {
    fFileErrSilent = fSilentSav;
    StreamClose();
    penvMem = (short *)uVar3;
    return 0;
  }
  fFileErrSilent = 1;
  StreamOpen((char *)szWork,0x12);
  fFileErrSilent = fSilentSav;
  ReadRt();
  if ((uint)hdrCur.wFlags >> 10 == 8) {
    if (((uint)rgbCur._8_2_ >> 0xc < 2) ||
       (((uint)rgbCur._8_2_ >> 0xc == 2 &&
        (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x31)))) {
      FileError(idsSorryFileCreatedOlderVersionStarsIncompatible);
    }
    else if (((uint)rgbCur._8_2_ >> 0xc < 3) &&
            (((uint)rgbCur._8_2_ >> 0xc != 2 ||
             (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x54)))) {
      pcVar6 = (char *)rgbCur;
      pRVar7 = &rtbof;
      for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
        pRVar2 = pRVar7;
        pRVar7 = (RTBOF *)(pRVar7->rgid + 2);
        pcVar1 = pcVar6;
        pcVar6 = pcVar6 + 2;
        *(undefined2 *)pRVar2->rgid = *(undefined2 *)pcVar1;
      }
      if (((int)game.lid != 0) || (game.lid._2_2_ != 0)) {
        if (((int)rtbof.lidGame == (int)game.lid) &&
           (rtbof.lidGame._2_2_ == game.lid._2_2_)) {
          fChange = 0;
          if (mdMark == 1) {
            bVar8 = ((uint)rtbof.wFlags >> 9 & 1) != f;
            if (bVar8) {
              lSeedSav2._2_2_ = f;
              rtbof.wFlags = rtbof.wFlags & 0xfdffU | (f & 1U) << 9;
            }
            fChange = (short)bVar8;
          }
          else if (mdMark == 2) {
            bVar8 = ((uint)rtbof.wFlags >> 8 & 1) != f;
            if (bVar8) {
              lSeedSav2._2_2_ = f;
              rtbof.wFlags = rtbof.wFlags & 0xfeffU | (f & 1U) << 8;
            }
            fChange = (short)bVar8;
          }
          else if (mdMark == 4) {
            bVar8 = ((uint)rtbof.wFlags >> 10 & 1) != f;
            if (bVar8) {
              lSeedSav2._2_2_ = f;
              rtbof.wFlags = rtbof.wFlags & 0xfbffU | (f & 1U) << 10;
            }
            fChange = (short)bVar8;
          }
          else if (mdMark == 8) {
            do {
              do {
                GetFileSeeds(&lSeedSav1,&lSeedSav2);
                ReadRt();
              } while ((uint)hdrCur.wFlags >> 10 != 6);
            } while (rgbCur[0] != iPlayer);
            if (((uint)rgbCur._6_2_ >> 9 & 1) != f) {
              if (((uint)rgbCur._6_2_ >> 9 & 1) == 0) {
                rgbCur._6_2_ = rgbCur._6_2_ & 0x1dff | 0xe200;
              }
              else {
                if ((uint)rgbCur._6_2_ >> 0xd != 7) goto IO_LBadFile_3;
                rgbCur._6_2_ = rgbCur._6_2_ & 0xfdff;
              }
              rgbCur._12_2_ = ~rgbCur._12_2_;
              rgbCur._14_2_ = ~rgbCur._14_2_;
              __lseek(hf,(long)(int)-((hdrCur.wFlags & 0x3ffU) + 2),1);
              SetFileSeeds
                        (CONCAT22(lSeedSav1._2_2_,(undefined2)lSeedSav1),
                         CONCAT22(lSeedSav2._2_2_,(undefined2)lSeedSav2));
              WriteRt(6,hdrCur.wFlags & 0x3ff,rgbCur);
              fChange = (short)(dt == dtTurn);
              rtbof.wFlags = rtbof.wFlags & 0xfeff;
            }
          }
          if (fChange != 0) {
            __lseek(hf,0,0);
            WriteRt(8,0x10,(RTBOF *)CONCAT22(unaff_SS,&rtbof));
          }
          fSuccess = 1;
        }
        else {
          FileError(idsFileGame);
        }
      }
    }
    else {
      FileError(idsFileCreatedNewerVersionStarsMustUpgrade);
    }
  }
  else {
    FileError(idsFileDoesBelongVersionStars);
  }
IO_LBadFile_3:
  if (((dt & 0x2000) == dtXY) || (fSuccess == 0)) {
    StreamClose();
  }
  else {
    __lseek(hf,0,2);
  }
  penvMem = (short *)uVar3;
  return fSuccess;
}



// ======================================================================
// Function: WriteRt
// Address: 1070:947c
// Segment: MEMORY_IO
// ======================================================================


void WriteRt(short rt,short cb,void *rg)

{
  undefined2 unaff_SS;
  HDR hdr;
  
  __fmemmove(rgbCur,rg,cb);
  if (rt == 8) {
    SetFileXorStream
              (CONCAT22(rgbCur._6_2_,rgbCur._4_2_),
               (int)rgbCur._12_2_ >> 5,rgbCur._10_2_,
               (int)(rgbCur._12_2_ << 0xb) >> 0xb,(uint)rgbCur._14_2_ >> 0xc & 1
              );
  }
  else if (rt != 0) {
    XorFileBuf((char *)rgbCur,cb);
  }
  hdr.wFlags = cb & 0x3ffU | rt << 10;
  RgToStream((HDR *)CONCAT22(unaff_SS,&hdr),2);
  RgToStream(rgbCur,cb);
  return;
}



// ======================================================================
// Function: RgToStream
// Address: 1070:9554
// Segment: MEMORY_IO
// ======================================================================


void RgToStream(void *rg,ushort cb)

{
  ushort uVar1;
  char *sz;
  short mbType;
  
  if ((cb != 0) && (uVar1 = _lwrite(cb,rg,hf), uVar1 != cb)) {
    mbType = 0x10;
    sz = PszFormatIds(idsErrorWritingFile,(short *)0x0);
    AlertSz(sz,mbType);
    _longjmp(penvMem,-1);
  }
  return;
}



// ======================================================================
// Function: SetVisiblePlanFleet
// Address: 1070:95bc
// Segment: MEMORY_IO
// ======================================================================


void SetVisiblePlanFleet(short iPlr)

{
  SetVisPFInit(iPlr);
  if (iPlr == -1) {
    rgplr[0].cPlanet = game.cPlanMax;
  }
  else {
    if (iPlr != -1) {
      UpdateProgressGauge(-0x39f);
    }
    SetVisPFFleets(iPlr);
    if (iPlr != -1) {
      UpdateProgressGauge(-0x39f);
    }
    SetVisPFPlanets(iPlr);
    if (iPlr != -1) {
      UpdateProgressGauge(-0x39f);
    }
    SetVisPFThings(iPlr);
    SetVisPFFinish(iPlr);
  }
  return;
}



// ======================================================================
// Function: SetVisPFInit
// Address: 1070:9654
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10709e11) */

void SetVisPFInit(short iPlr)

{
  char *pcVar1;
  uint *puVar2;
  int *piVar3;
  uint uVar4;
  FLEET *pFVar5;
  uint uVar6;
  PLORD *pPVar7;
  short sVar8;
  THING *pTVar9;
  int iVar10;
  int iVar11;
  undefined2 uVar12;
  long lVar13;
  short iSteal;
  ushort grbitPlr;
  short raMajor;
  THING *lpthMac;
  short i;
  short ifl;
  THING *lpth;
  FLEET *lpfl;
  short j;
  PLANET *lppl;
  ushort detNew;
  PLANET *lpplMac;
  
  raMajor = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
  if (iPlr == -1) {
    grbitPlr = 0;
  }
  else {
    grbitPlr = 1 << ((byte)iPlr & 0x1f);
  }
  for (i = 0; i < game.cPlayer; i = i + 1) {
    *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
  }
  for (i = 0; i < game.cPlayer; i = i + 1) {
    if (((iPlr == -1) || (iPlr == i)) ||
       ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0)) {
      *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
      *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 7;
    }
    else {
      *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff;
    }
    *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
         *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xf000;
    *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
    *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
         *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xfff;
    for (j = 0; j < 0x10; j = j + 1) {
      if (((iPlr == -1) || (iPlr == i)) &&
         ((*(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) >> 9 & 1) == 0)) {
        *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
        *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xff00 | 7;
        uVar12 = *(undefined2 *)(i * 4 + 0x100);
        iVar10 = *(int *)(i * 4 + 0xfe) + j * 0x93;
        *(undefined2 *)(iVar10 + 0x83) = 0;
        *(undefined2 *)(iVar10 + 0x85) = 0;
        pcVar1 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
        *pcVar1 = *pcVar1 + '\x01';
      }
      else {
        *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfeff;
      }
    }
    for (j = 0; j < 10; j = j + 1) {
      if (((iPlr == -1) || (iPlr == i)) &&
         ((*(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) >> 9 & 1) == 0)) {
        *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
        *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xff00 | 7;
        uVar12 = *(undefined2 *)(i * 4 + 0x14e);
        iVar10 = *(int *)(i * 4 + 0x14c) + j * 0x93;
        *(undefined2 *)(iVar10 + 0x83) = 0;
        *(undefined2 *)(iVar10 + 0x85) = 0;
        iVar10 = *(int *)((int)&rgplr[0].wFlags + i * 0xc0);
        puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
        *puVar2 = *puVar2 & 0xfff;
        puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
        *puVar2 = *puVar2 | iVar10 + 0x1000U & 0xf000;
      }
      else {
        *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfeff;
      }
    }
  }
  lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
  lpplMac._2_2_ = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < (PLANET *)lpplMac) {
    if ((iPlr == -1) || (iPlr == ((PLANET *)lppl)->iPlayer)) {
      ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xfeffU | 0x100;
      ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xff00U | 7;
      if (iPlr != -1) {
        piVar3 = (int *)((int)&rgplr[0].cPlanet + iPlr * 0xc0);
        *piVar3 = *piVar3 + 1;
      }
      if (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0) {
        iVar10 = ((PLANET *)lppl)->iPlayer * 4;
        uVar12 = *(undefined2 *)(iVar10 + 0x14e);
        iVar10 = *(int *)(iVar10 + 0x14c) + (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) * 0x93;
        puVar2 = (uint *)(iVar10 + 0x83);
        uVar4 = *puVar2;
        *puVar2 = *puVar2 + 1;
        piVar3 = (int *)(iVar10 + 0x85);
        *piVar3 = *piVar3 + (uint)(0xfffe < uVar4);
      }
    }
    else {
      ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xfeff;
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar5 = ((FLEET **)rglpfl)[ifl];
    iVar10 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar10,pFVar5);
    if ((pFVar5 == (FLEET *)0x0) && (iVar10 == 0)) break;
    pFVar5->wFlags = pFVar5->wFlags & 0xffef;
    pFVar5->wFlags = pFVar5->wFlags & 0x7fff;
    if (((iPlr == -1) || (iPlr == pFVar5->iPlayer)) && (((uint)pFVar5->wFlags >> 10 & 1) == 0)) {
      pFVar5->wFlags = pFVar5->wFlags & 0xfeffU | 0x100;
      pFVar5->wFlags = pFVar5->wFlags & 0xff00U | 7;
      iSteal = *(int *)((int)&rgplr[0].wFlags + pFVar5->iPlayer * 0xc0) + 1U & 0xfff;
      puVar2 = (uint *)((int)&rgplr[0].wFlags + pFVar5->iPlayer * 0xc0);
      *puVar2 = *puVar2 & 0xf000;
      puVar2 = (uint *)((int)&rgplr[0].wFlags + pFVar5->iPlayer * 0xc0);
      *puVar2 = *puVar2 | iSteal;
      for (j = 0; j < 0x10; j = j + 1) {
        if (pFVar5->rgcsh[j] != 0) {
          uVar6 = pFVar5->rgcsh[j];
          iSteal = (int)uVar6 >> 0xf;
          iVar11 = pFVar5->iPlayer * 4;
          uVar12 = *(undefined2 *)(iVar11 + 0x100);
          iVar11 = *(int *)(iVar11 + 0xfe) + j * 0x93;
          puVar2 = (uint *)(iVar11 + 0x83);
          uVar4 = *puVar2;
          *puVar2 = *puVar2 + uVar6;
          piVar3 = (int *)(iVar11 + 0x85);
          *piVar3 = *piVar3 + iSteal + (uint)CARRY2(uVar4,uVar6);
        }
      }
      if ((iPlr != -1) && (pFVar5->idPlanet != -1)) {
        lppl = (PLANET *)
               CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets + pFVar5->idPlanet);
        sVar8 = GetCachedFleetScannerRange
                          ((FLEET *)CONCAT22(iVar10,pFVar5),(short *)0x0,(short *)0x0,&iSteal);
        if (sVar8 < 0) {
          detNew = 1;
        }
        else {
          detNew = 3;
        }
        if (1 < iSteal) {
          detNew = 4;
        }
        uVar12 = (undefined2)((ulong)lpfl >> 0x10);
        if ((((((uint)((FLEET *)lpfl)->wFlags >> 0xd & 1) != 0) && (((PLANET *)lppl)->iPlayer == -1)
             ) && (pPVar7 = ((FLEET *)lpfl)->lpplord,
                  (*(uint *)&((PLORD *)pPVar7)[2].iordMax & 0xf) == 3)) &&
           (lVar13 = CMineFromLpfl(lpfl), 0 < lVar13)) {
          detNew = 4;
        }
        MarkPlanet(lppl,iPlr,detNew);
      }
    }
    else {
      pFVar5->wFlags = pFVar5->wFlags & 0xfeff;
    }
  }
  pTVar9 = (THING *)lpThings + cThing;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < pTVar9) {
    if ((uint)lpth->idFull >> 0xd == 1) {
      if ((iPlr == -1) || (raMajor == 6)) {
        *(uint *)((THING *)lpth)->rgb = *(uint *)((THING *)lpth)->rgb & 0x7fff | 0x8000;
        if ((*(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) >>
             8 & 1) == 0) {
          *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) &
               0xfeff | 0x100;
          *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) &
               0xfff8 | 3;
        }
      }
      else {
        *(uint *)((THING *)lpth)->rgb = *(uint *)((THING *)lpth)->rgb & 0x7fff;
      }
    }
    else if ((uint)lpth->idFull >> 0xd == 2) {
      *(uint *)((THING *)lpth)->rgb =
           *(uint *)((THING *)lpth)->rgb & 0xdfff | (uint)(iPlr == -1) << 0xd;
    }
    else if ((uint)lpth->idFull >> 0xd == 3) {
      *(uint *)(((THING *)lpth)->rgb + 4) = *(uint *)(((THING *)lpth)->rgb + 4) & 0xffef | 0x10;
    }
    else if ((((uint)lpth->idFull >> 0xd == 0) &&
             ((*(uint *)(((THING *)lpth)->rgb + 8) & grbitPlr) != 0)) &&
            ((*(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) >>
              8 & 1) == 0)) {
      *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) &
           0xfeff | 0x100;
      *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) &
           0xfff8 | 3;
    }
    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
  }
  return;
}



// ======================================================================
// Function: SetVisPFFleets
// Address: 1070:a100
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lVis2 */
/* WARNING: Removing unreachable block (ram,0x1070a8f0) */
/* WARNING: Removing unreachable block (ram,0x1070a90b) */
/* WARNING: Removing unreachable block (ram,0x1070aae0) */
/* WARNING: Removing unreachable block (ram,0x1070a412) */
/* WARNING: Removing unreachable block (ram,0x1070a711) */
/* WARNING: Removing unreachable block (ram,0x1070a4d8) */
/* WARNING: Removing unreachable block (ram,0x1070ab87) */
/* WARNING: Removing unreachable block (ram,0x1070a43a) */
/* WARNING: Removing unreachable block (ram,0x1070a53c) */
/* WARNING: Removing unreachable block (ram,0x1070a92e) */
/* WARNING: Removing unreachable block (ram,0x1070a94e) */
/* WARNING: Removing unreachable block (ram,0x1070a887) */
/* WARNING: Removing unreachable block (ram,0x1070a8a2) */

void SetVisPFFleets(short iPlr)

{
  uint *puVar1;
  FLEET *pFVar2;
  uint uVar3;
  PLANET *pPVar4;
  int iVar5;
  THING *pTVar6;
  PLANET *pPVar7;
  int iVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar9;
  ulong uVar10;
  ulong uVar11;
  long lVar12;
  long lVar13;
  undefined2 uVar14;
  undefined2 uVar15;
  undefined2 uVar16;
  long lVar17;
  long lVis2;
  long l;
  short pctDetect;
  short iSteal;
  short iRadPlanet;
  long lRadPlanet2;
  ushort grbitPlr;
  short dx;
  short iRadius;
  THING *lpthMac;
  short ifl;
  long lRadius2;
  THING *lpth;
  FLEET *lpfl;
  short j;
  PLANET *lppl;
  long d2;
  FLEET *lpfl2;
  short dy;
  short pctCloak;
  POINT pt;
  PLANET *lpplMac;
  
  uVar10 = CONCAT22(lRadPlanet2._2_2_,(undefined2)lRadPlanet2);
  uVar11 = CONCAT22(lRadius2._2_2_,(undefined2)lRadius2);
  lVar17 = CONCAT22(unaff_SI,unaff_DI);
  if (iPlr == -1) {
    grbitPlr = 0;
  }
  else {
    grbitPlr = 1 << ((byte)iPlr & 0x1f);
  }
  ifl = 0;
  do {
    if (cFleet <= ifl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pFVar2 = ((FLEET **)rglpfl)[ifl];
    iVar8 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar8,pFVar2);
    if ((pFVar2 == (FLEET *)0x0) && (iVar8 == 0)) {
      return;
    }
    if (((uint)pFVar2->wFlags >> 10 & 1) == 0) {
      lRadius2 = uVar11;
      lRadPlanet2 = uVar10;
      if (pFVar2->iPlayer == iPlr) {
        if ((((uint)pFVar2->wFlags >> 0xc & 1) != 0) && (pFVar2->idPlanet != -1)) {
          MarkPlanet((PLANET *)
                     CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets + pFVar2->idPlanet),
                     iPlr,3);
          uVar11 = lRadius2;
          uVar10 = lRadPlanet2;
        }
        lRadius2 = uVar11;
        lRadPlanet2 = uVar10;
        iRadius = GetCachedFleetScannerRange(lpfl,&iRadPlanet,&pctDetect,&iSteal);
        if (0x7fff < (uint)iRadius) {
          iRadius = 0;
        }
        uVar10 = __aFulmul((long)iRadius,(long)iRadius);
        lRadius2 = uVar10;
        uVar10 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
        uVar9 = (undefined2)((ulong)lpfl >> 0x10);
        pt.x = (&((FLEET *)lpfl)->pt)->x;
        pt.y = (((FLEET *)lpfl)->pt).y;
        for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar2 = ((FLEET **)rglpfl)[j];
          iVar8 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
          lpfl2 = (FLEET *)CONCAT22(iVar8,pFVar2);
          if ((pFVar2 == (FLEET *)0x0) && (iVar8 == 0)) break;
          if (((uint)pFVar2->wFlags >> 10 & 1) == 0) {
            if (((((iSteal & 1U) != 0) && (pt.x == (&pFVar2->pt)->x)) && (pt.y == (pFVar2->pt).y))
               && ((((uint)pFVar2->wFlags >> 8 & 1) == 0 || ((pFVar2->wFlags & 0xffU) < 4)))) {
              lRadPlanet2 = uVar10;
              MarkFleet((FLEET *)CONCAT22(iVar8,pFVar2),4);
              uVar10 = lRadPlanet2;
            }
            uVar9 = (undefined2)((ulong)lpfl2 >> 0x10);
            if (((uint)((FLEET *)lpfl2)->wFlags >> 8 & 1) == 0) {
              lRadPlanet2 = uVar10;
              dx = _abs(pt.x - (&((FLEET *)lpfl2)->pt)->x);
              uVar10 = lRadPlanet2;
              if (dx <= iRadius) {
                dy = _abs(pt.y - (((FLEET *)lpfl2)->pt).y);
                uVar10 = lRadPlanet2;
                if (dy <= iRadius) {
                  uVar10 = __aFulmul((long)dy,(long)dy);
                  uVar11 = __aFulmul((long)dx,(long)dx);
                  lVar13 = uVar11 + uVar10;
                  uVar10 = lRadPlanet2;
                  if ((lVar13 <= lRadius2) &&
                     ((((FLEET *)lpfl2)->idPlanet == -1 || (lVar13 <= lRadPlanet2)))) {
                    pctCloak = PctCloakFromLpfl(lpfl2);
                    if (pctDetect != 100) {
                      pctCloak = (pctCloak * pctDetect) / 100;
                    }
                    if (pctCloak == 0) {
                      MarkFleet(lpfl2,3);
                      uVar10 = lRadPlanet2;
                    }
                    else {
                      uVar15 = 0;
                      uVar14 = 100;
                      iVar8 = 100 - pctCloak;
                      iVar5 = iVar8 >> 0xf;
                      uVar16 = 0;
                      uVar9 = 100;
                      uVar10 = __aFulmul(lRadius2,(long)(100 - pctCloak));
                      uVar10 = __aFldiv(uVar10,CONCAT22(uVar16,uVar9));
                      uVar10 = __aFulmul(uVar10,CONCAT22(iVar5,iVar8));
                      lVar12 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                      uVar10 = lRadPlanet2;
                      if (lVar13 <= lVar12) {
                        if (((FLEET *)lpfl2)->idPlanet != -1) {
                          uVar15 = 0;
                          uVar14 = 100;
                          iVar8 = 100 - pctCloak;
                          iVar5 = iVar8 >> 0xf;
                          uVar16 = 0;
                          uVar9 = 100;
                          uVar10 = __aFulmul(lRadPlanet2,(long)(100 - pctCloak));
                          uVar10 = __aFldiv(uVar10,CONCAT22(uVar16,uVar9));
                          uVar10 = __aFulmul(uVar10,CONCAT22(iVar5,iVar8));
                          lVar12 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                          uVar10 = lRadPlanet2;
                          if (lVar12 < lVar13) goto LAB_1070_a2b2;
                        }
                        MarkFleet(lpfl2,3);
                        uVar10 = lRadPlanet2;
                      }
                    }
                  }
                }
              }
            }
          }
LAB_1070_a2b2:
        }
        lpthMac._0_2_ = (THING *)lpThings + cThing;
        lpthMac._2_2_ = lpThings._2_2_;
        lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
        while (lRadPlanet2 = uVar10, (THING *)lpth < (THING *)lpthMac) {
          if ((((iPlr != -1) &&
               (((((uint)lpth->idFull >> 0xd == 0 || ((uint)lpth->idFull >> 0xd == 1)) ||
                 ((uint)lpth->idFull >> 0xd == 3)) || ((uint)lpth->idFull >> 0xd == 2)))) &&
              ((((uVar9 = (undefined2)((ulong)lpth >> 0x10), (uint)lpth->idFull >> 0xd != 0 ||
                 ((*(uint *)(((THING *)lpth)->rgb + 8) & grbitPlr) == 0)) &&
                (((uint)lpth->idFull >> 0xd != 3 ||
                 ((*(uint *)(((THING *)lpth)->rgb + 4) >> 4 & 1) == 0)))) &&
               (((uint)lpth->idFull >> 0xd != 1 || (-1 < *(int *)((THING *)lpth)->rgb)))))) &&
             (((uint)lpth->idFull >> 0xd != 2 || ((*(uint *)((THING *)lpth)->rgb >> 0xd & 1) == 0)))
             ) {
            dx = _abs(pt.x - (&((THING *)lpth)->pt)->x);
            dy = _abs(pt.y - (((THING *)lpth)->pt).y);
            uVar10 = __aFulmul((long)dy,(long)dy);
            uVar11 = __aFulmul((long)dx,(long)dx);
            lVis2._0_2_ = (ushort)uVar10;
            lVar13 = uVar11 + uVar10;
            uVar10 = lRadPlanet2;
            if ((lVar13 <= lRadius2) || ((uint)lpth->idFull >> 0xd == 0)) {
              pTVar6 = (THING *)lpth;
              uVar9 = (undefined2)((ulong)lpth >> 0x10);
              if ((uint)lpth->idFull >> 0xd == 1) {
                *(uint *)pTVar6->rgb = *(uint *)pTVar6->rgb & 0x7fff | 0x8000;
IO_LThIncPlr:
                uVar10 = lRadPlanet2;
                if ((*(uint *)((int)&rgplr[0].wMdPlr +
                              ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1) == 0) {
                  *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0
                           ) = *(uint *)((int)&rgplr[0].wMdPlr +
                                        ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfeff | 0x100;
                  *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0
                           ) = *(uint *)((int)&rgplr[0].wMdPlr +
                                        ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 | 3;
                }
              }
              else if ((uint)lpth->idFull >> 0xd == 3) {
                *(uint *)(pTVar6->rgb + 4) = *(uint *)(pTVar6->rgb + 4) & 0xffef | 0x10;
              }
              else {
                if ((uint)lpth->idFull >> 0xd != 2) {
                  if ((((*(uint *)(pTVar6->rgb + 4) & grbitPlr) == 0) || (lRadius2 < lVar13)) &&
                     (lRadPlanet2 < lVar13)) {
                    lVar12 = __aFlshr(lVar17,(ushort)lVis2);
                    if ((lVar12 < lVar13) &&
                       (uVar9 = (undefined2)((ulong)lpth >> 0x10), uVar10 = lRadPlanet2,
                       CONCAT22(*(undefined2 *)(((THING *)lpth)->rgb + 2),
                                *(undefined2 *)((THING *)lpth)->rgb) < lVar13)) goto LAB_1070_a96d;
                  }
                  uVar9 = (undefined2)((ulong)lpth >> 0x10);
                  puVar1 = (uint *)(((THING *)lpth)->rgb + 4);
                  *puVar1 = *puVar1 | grbitPlr;
                  puVar1 = (uint *)(((THING *)lpth)->rgb + 8);
                  *puVar1 = *puVar1 | grbitPlr;
                  goto IO_LThIncPlr;
                }
                if ((*(uint *)(pTVar6->rgb + 2) & grbitPlr) == 0) {
                  lVar12 = __aFlshr(lVar17,(ushort)lVis2);
                  if ((lVar12 < lVar13) && (uVar10 = lRadPlanet2, lRadPlanet2 < lVar13))
                  goto LAB_1070_a96d;
                }
                uVar9 = (undefined2)((ulong)lpth >> 0x10);
                pTVar6 = (THING *)lpth;
                *(uint *)(pTVar6->rgb + 2) = *(uint *)(pTVar6->rgb + 2) | grbitPlr;
                *(uint *)pTVar6->rgb = *(uint *)pTVar6->rgb & 0xdfff | 0x2000;
                uVar10 = lRadPlanet2;
              }
            }
          }
LAB_1070_a96d:
          lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
        }
        uVar11 = lRadius2;
        if ((iSteal & 2U) != 0) {
          uVar9 = (undefined2)((ulong)lpfl >> 0x10);
          if (((FLEET *)lpfl)->idPlanet != -1) {
            MarkPlanet((PLANET *)
                       CONCAT22(lpPlanets._2_2_,
                                (PLANET *)lpPlanets + ((FLEET *)lpfl)->idPlanet),iPlr,4);
            uVar10 = lRadPlanet2;
            uVar11 = lRadius2;
          }
        }
        if (0 < iRadPlanet) {
          iRadius = iRadPlanet;
          lRadPlanet2 = uVar10;
          lRadius2 = uVar11;
          uVar11 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
          uVar9 = (undefined2)((ulong)lpfl >> 0x10);
          pt.x = (&((FLEET *)lpfl)->pt)->x;
          pt.y = (((FLEET *)lpfl)->pt).y;
          pPVar4 = (PLANET *)lpPlanets + cPlanet;
          lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
          while (uVar10 = lRadPlanet2, (PLANET *)lppl < pPVar4) {
            uVar9 = (undefined2)((ulong)lppl >> 0x10);
            if ((((uint)((PLANET *)lppl)->wFlags >> 8 & 1) == 0) ||
               ((((PLANET *)lppl)->wFlags & 0xffU) < 3)) {
              lRadius2 = uVar11;
              dx = _abs(((POINT *)rgptPlan + lppl->id)->x - pt.x);
              uVar11 = lRadius2;
              if (dx <= iRadius) {
                dy = _abs(*(int *)((int)&rgptPlan[0].y + lppl->id * 4) - pt.y);
                uVar11 = lRadius2;
                if (dy <= iRadius) {
                  uVar10 = __aFulmul((long)dy,(long)dy);
                  uVar11 = __aFulmul((long)dx,(long)dx);
                  d2 = uVar11 + uVar10;
                  uVar11 = lRadius2;
                  if (d2 <= lRadius2) {
                    uVar9 = (undefined2)((ulong)lppl >> 0x10);
                    pPVar7 = (PLANET *)lppl;
                    if ((((uint)pPVar7->wFlags >> 9 & 1) != 0) && (pPVar7->iPlayer != -1)) {
                      iVar8 = pPVar7->iPlayer * 4;
                      uVar16 = *(undefined2 *)(iVar8 + 0x14e);
                      iVar8 = *(int *)(iVar8 + 0x14c) +
                              (*(uint *)&pPVar7->field11_0x2c & 0xf) * 0x93;
                      uVar3 = *(uint *)(iVar8 + 0x87);
                      iVar8 = *(int *)(iVar8 + 0x89);
                      if ((iVar8 < 1) && ((iVar8 < 0 || (uVar3 < 10000)))) {
                        uVar16 = 0;
                        uVar9 = 10000;
                        uVar10 = __aFulmul(lRadius2,CONCAT22(iVar8,uVar3));
                        lVar13 = __aFldiv(uVar10,CONCAT22(uVar16,uVar9));
                        if (lVar13 < d2) {
                          MarkPlanet(lppl,iPlr,2);
                          uVar11 = lRadius2;
                          goto LAB_1070_abc2;
                        }
                      }
                    }
                    MarkPlanet(lppl,iPlr,3);
                    uVar11 = lRadius2;
                  }
                }
              }
            }
LAB_1070_abc2:
            lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
          }
        }
      }
      else if (((((uint)pFVar2->wFlags >> 8 & 1) == 0) && (pFVar2->idPlanet != -1)) &&
              (((PLANET *)lpPlanets)[pFVar2->idPlanet].iPlayer == iPlr)) {
        MarkFleet((FLEET *)CONCAT22(iVar8,pFVar2),3);
        uVar11 = lRadius2;
        uVar10 = lRadPlanet2;
      }
    }
    ifl = ifl + 1;
  } while( true );
}



// ======================================================================
// Function: SetVisPFPlanets
// Address: 1070:abde
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lVis2_2 */
/* WARNING: Removing unreachable block (ram,0x1070b8e2) */
/* WARNING: Removing unreachable block (ram,0x1070b66c) */
/* WARNING: Removing unreachable block (ram,0x1070b35e) */
/* WARNING: Removing unreachable block (ram,0x1070b3c7) */
/* WARNING: Removing unreachable block (ram,0x1070b1fe) */
/* WARNING: Removing unreachable block (ram,0x1070b3ea) */
/* WARNING: Removing unreachable block (ram,0x1070b379) */
/* WARNING: Removing unreachable block (ram,0x1070b6ef) */
/* WARNING: Removing unreachable block (ram,0x1070b989) */
/* WARNING: Removing unreachable block (ram,0x1070ae4e) */
/* WARNING: Removing unreachable block (ram,0x1070ae76) */
/* WARNING: Removing unreachable block (ram,0x1070aefc) */
/* WARNING: Removing unreachable block (ram,0x1070af60) */

void SetVisPFPlanets(short iPlr)

{
  int iVar1;
  int iVar2;
  FLEET *pFVar3;
  long lVar4;
  bool bVar5;
  uint uVar6;
  short sVar7;
  short sVar8;
  short sVar9;
  int iVar10;
  PLANET *pPVar11;
  THING *pTVar12;
  PLANET *pPVar13;
  int iVar14;
  int iVar15;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar16;
  ulong uVar17;
  ulong uVar18;
  ulong uVar19;
  long lVar20;
  ulong uVar21;
  long lVar22;
  undefined2 uVar23;
  undefined2 uVar24;
  undefined2 uVar25;
  long lVis2_2;
  short rgStargateRange [16];
  ushort grbitPlr;
  PLANET *lpplMac2;
  long l;
  short dx;
  short fStargateView;
  short iRadius;
  THING *lpthMac;
  short i;
  long lRadius2;
  THING *lpth;
  short j;
  PLANET *lppl;
  long d2;
  FLEET *lpfl2;
  short dy;
  PLANET *lppl2;
  short pctCloak;
  POINT pt;
  PLANET *lpplMac;
  short iRadPlanet;
  long lRadPlanet2;
  
  lVar22 = CONCAT22(unaff_SI,unaff_DI);
  if (iPlr == -1) {
    uVar6 = 0;
  }
  else {
    uVar6 = 1 << ((byte)iPlr & 0x1f);
  }
  bVar5 = false;
  sVar7 = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
  if (sVar7 == raStargate) {
    for (i = 0; i < 10; i = i + 1) {
      rgStargateRange[i] = 0;
      if ((*(uint *)(*(int *)(iPlr * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) {
        sVar7 = StargateRangeFromLppl((PLANET *)0x0,iPlr,i);
        rgStargateRange[i] = sVar7;
        if (0 < sVar7) {
          bVar5 = true;
        }
      }
    }
  }
  if (iPlr != -1) {
    UpdateProgressGauge(-0x39f);
  }
  uVar18 = CONCAT22(lRadPlanet2._2_2_,(undefined2)lRadPlanet2);
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  pPVar11 = (PLANET *)lpPlanets + cPlanet;
  do {
    lRadPlanet2 = uVar18;
    if (pPVar11 <= (PLANET *)lppl) {
      if (iPlr != -1) {
        UpdateProgressGauge(-0x39f);
        uVar18 = lRadPlanet2;
      }
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      pPVar11 = (PLANET *)lpPlanets + cPlanet;
      do {
        lRadPlanet2 = uVar18;
        if (pPVar11 <= (PLANET *)lppl) {
          if (iPlr != -1) {
            UpdateProgressGauge(-0x39f);
            uVar18 = lRadPlanet2;
          }
          lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
          pPVar11 = (PLANET *)lpPlanets + cPlanet;
          do {
            lRadPlanet2 = uVar18;
            if (pPVar11 <= (PLANET *)lppl) {
              if (iPlr != -1) {
                UpdateProgressGauge(-0x39f);
                uVar18 = lRadPlanet2;
              }
              lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
              pPVar11 = (PLANET *)lpPlanets + cPlanet;
              do {
                if (pPVar11 <= (PLANET *)lppl) {
                  return;
                }
                uVar16 = (undefined2)((ulong)lppl >> 0x10);
                if (((PLANET *)lppl)->iPlayer == iPlr) {
                  lRadPlanet2 = uVar18;
                  sVar7 = GetPlanetScannerRange(lppl,&iRadPlanet);
                  __aFulmul((long)sVar7,(long)sVar7);
                  uVar17 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
                  sVar7 = iRadPlanet;
                  iVar1 = ((POINT *)rgptPlan + lppl->id)->x;
                  iVar2 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
                  uVar18 = uVar17;
                  if (0 < iRadPlanet) {
                    pPVar13 = (PLANET *)lpPlanets + cPlanet;
                    lppl2 = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
                    lRadPlanet2 = uVar17;
                    while (uVar18 = lRadPlanet2, (PLANET *)lppl2 < pPVar13) {
                      uVar23 = (undefined2)((ulong)lppl2 >> 0x10);
                      if ((((uint)((PLANET *)lppl2)->wFlags >> 8 & 1) == 0) ||
                         ((((PLANET *)lppl2)->wFlags & 0xffU) < 3)) {
                        sVar8 = _abs(((POINT *)rgptPlan + lppl2->id)->x - iVar1);
                        if (sVar8 <= sVar7) {
                          sVar9 = _abs(*(int *)((int)&rgptPlan[0].y +
                                                       lppl2->id * 4) - iVar2);
                          if (sVar9 <= sVar7) {
                            uVar18 = __aFulmul((long)sVar9,(long)sVar9);
                            uVar19 = __aFulmul((long)sVar8,(long)sVar8);
                            if ((long)(uVar19 + uVar18) <= (long)uVar17) {
                              if ((((uint)((PLANET *)lppl2)->wFlags >> 9 & 1) != 0) &&
                                 (((PLANET *)lppl2)->iPlayer != -1)) {
                                iVar15 = ((PLANET *)lppl2)->iPlayer * 4;
                                uVar24 = *(undefined2 *)(iVar15 + 0x14e);
                                iVar15 = *(int *)(iVar15 + 0x14c) +
                                         (*(uint *)&((PLANET *)lppl2)->field11_0x2c & 0xf) * 0x93;
                                uVar6 = *(uint *)(iVar15 + 0x87);
                                iVar15 = *(int *)(iVar15 + 0x89);
                                if ((iVar15 < 1) && ((iVar15 < 0 || (uVar6 < 10000)))) {
                                  uVar25 = 0;
                                  uVar24 = 10000;
                                  uVar21 = __aFulmul(uVar17,CONCAT22(iVar15,uVar6));
                                  lVar22 = __aFldiv(uVar21,CONCAT22(uVar25,uVar24));
                                  if (lVar22 < (long)(uVar19 + uVar18)) {
                                    MarkPlanet(lppl2,iPlr,2);
                                    goto LAB_1070_b9c4;
                                  }
                                }
                              }
                              MarkPlanet(lppl2,iPlr,3);
                            }
                          }
                        }
                      }
LAB_1070_b9c4:
                      lppl2 = (PLANET *)CONCAT22(uVar23,(PLANET *)lppl2 + 1);
                    }
                  }
                }
                lppl = (PLANET *)CONCAT22(uVar16,(PLANET *)lppl + 1);
              } while( true );
            }
            uVar16 = (undefined2)((ulong)lppl >> 0x10);
            if (((PLANET *)lppl)->iPlayer == iPlr) {
              sVar7 = GetPlanetScannerRange(lppl,&iRadPlanet);
              __aFulmul((long)sVar7,(long)sVar7);
              uVar18 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
              lRadPlanet2 = uVar18;
              iVar1 = ((POINT *)rgptPlan + lppl->id)->x;
              iVar2 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
              if (((bVar5) && (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)) &&
                 (0 < rgStargateRange[*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf])) {
                iVar15 = rgStargateRange[*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf];
                uVar17 = __aFulmul((long)iVar15,(long)iVar15);
                pPVar13 = (PLANET *)lpPlanets + cPlanet;
                lppl2 = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
                uVar18 = lRadPlanet2;
                while ((PLANET *)lppl2 < pPVar13) {
                  uVar23 = (undefined2)((ulong)lppl2 >> 0x10);
                  if (((((uint)((PLANET *)lppl2)->wFlags >> 8 & 1) == 0) ||
                      ((((PLANET *)lppl2)->wFlags & 0xffU) < 3)) &&
                     (((uint)((PLANET *)lppl2)->wFlags >> 9 & 1) != 0)) {
                    lRadPlanet2 = uVar18;
                    sVar7 = StargateRangeFromLppl(lppl2,0,0);
                    uVar18 = lRadPlanet2;
                    if (sVar7 != 0) {
                      if (9999 < iVar15) goto IO_LMarkStargate;
                      sVar7 = _abs(((POINT *)rgptPlan + lppl2->id)->x - iVar1);
                      uVar18 = lRadPlanet2;
                      if (sVar7 <= iVar15) {
                        sVar8 = _abs(*(int *)((int)&rgptPlan[0].y + lppl2->id * 4)
                                             - iVar2);
                        uVar18 = lRadPlanet2;
                        if (sVar8 <= iVar15) {
                          uVar19 = __aFulmul((long)sVar8,(long)sVar8);
                          uVar21 = __aFulmul((long)sVar7,(long)sVar7);
                          uVar18 = lRadPlanet2;
                          if ((long)(uVar21 + uVar19) <= (long)uVar17) {
                            iVar10 = ((PLANET *)lppl2)->iPlayer * 4;
                            uVar24 = *(undefined2 *)(iVar10 + 0x14e);
                            iVar10 = *(int *)(iVar10 + 0x14c) +
                                     (*(uint *)&((PLANET *)lppl2)->field11_0x2c & 0xf) * 0x93;
                            uVar6 = *(uint *)(iVar10 + 0x87);
                            iVar10 = *(int *)(iVar10 + 0x89);
                            if ((iVar10 < 1) && ((iVar10 < 0 || (uVar6 < 10000)))) {
                              uVar25 = 0;
                              uVar24 = 10000;
                              uVar18 = __aFulmul(uVar17,CONCAT22(iVar10,uVar6));
                              lVar22 = __aFldiv(uVar18,CONCAT22(uVar25,uVar24));
                              uVar18 = lRadPlanet2;
                              if (lVar22 < (long)(uVar21 + uVar19)) goto LAB_1070_b70c;
                            }
IO_LMarkStargate:
                            MarkPlanet(lppl2,iPlr,3);
                            uVar18 = lRadPlanet2;
                          }
                        }
                      }
                    }
                  }
LAB_1070_b70c:
                  lppl2 = (PLANET *)CONCAT22(uVar23,(PLANET *)lppl2 + 1);
                }
              }
            }
            lppl = (PLANET *)CONCAT22(uVar16,(PLANET *)lppl + 1);
          } while( true );
        }
        uVar16 = (undefined2)((ulong)lppl >> 0x10);
        if (((PLANET *)lppl)->iPlayer == iPlr) {
          sVar7 = GetPlanetScannerRange(lppl,&iRadPlanet);
          uVar17 = __aFulmul((long)sVar7,(long)sVar7);
          uVar18 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
          iVar1 = ((POINT *)rgptPlan + lppl->id)->x;
          iVar2 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
          pTVar12 = (THING *)lpThings + cThing;
          lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
          while ((THING *)lpth < pTVar12) {
            uVar23 = (undefined2)((ulong)lpth >> 0x10);
            if (((((iPlr != -1) &&
                  (((((uint)lpth->idFull >> 0xd == 0 || ((uint)lpth->idFull >> 0xd == 1)) ||
                    ((uint)lpth->idFull >> 0xd == 3)) || ((uint)lpth->idFull >> 0xd == 2)))) &&
                 (((uint)lpth->idFull >> 0xd != 0 ||
                  ((*(uint *)(((THING *)lpth)->rgb + 8) & uVar6) == 0)))) &&
                (((uint)lpth->idFull >> 0xd != 3 ||
                 ((*(uint *)(((THING *)lpth)->rgb + 4) >> 4 & 1) == 0)))) &&
               ((((uint)lpth->idFull >> 0xd != 1 || (-1 < *(int *)((THING *)lpth)->rgb)) &&
                (((uint)lpth->idFull >> 0xd != 2 ||
                 ((*(uint *)((THING *)lpth)->rgb >> 0xd & 1) == 0)))))) {
              lRadPlanet2 = uVar18;
              sVar8 = _abs(iVar1 - (&((THING *)lpth)->pt)->x);
              uVar18 = lRadPlanet2;
              if (sVar8 <= sVar7) {
                sVar9 = _abs(iVar2 - (((THING *)lpth)->pt).y);
                uVar18 = lRadPlanet2;
                if (sVar9 <= sVar7) {
                  uVar18 = __aFulmul((long)sVar9,(long)sVar9);
                  uVar19 = __aFulmul((long)sVar8,(long)sVar8);
                  lVis2_2._0_2_ = (ushort)uVar18;
                  lVar4 = uVar19 + uVar18;
                  uVar18 = lRadPlanet2;
                  if (lVar4 <= (long)uVar17) {
                    if ((uint)lpth->idFull >> 0xd == 1) {
                      *(uint *)((THING *)lpth)->rgb =
                           *(uint *)((THING *)lpth)->rgb & 0x7fff | 0x8000;
IO_LThIncPlr2:
                      uVar18 = lRadPlanet2;
                      if ((*(uint *)((int)&rgplr[0].wMdPlr +
                                    ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1) == 0) {
                        *(uint *)((int)&rgplr[0].wMdPlr +
                                 ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) =
                             *(uint *)((int)&rgplr[0].wMdPlr +
                                      ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfeff | 0x100;
                        *(uint *)((int)&rgplr[0].wMdPlr +
                                 ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) =
                             *(uint *)((int)&rgplr[0].wMdPlr +
                                      ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 | 3;
                      }
                    }
                    else if ((uint)lpth->idFull >> 0xd == 3) {
                      *(uint *)(((THING *)lpth)->rgb + 4) =
                           *(uint *)(((THING *)lpth)->rgb + 4) & 0xffef | 0x10;
                    }
                    else {
                      if ((uint)lpth->idFull >> 0xd != 2) {
                        if (((*(uint *)(((THING *)lpth)->rgb + 4) & uVar6) == 0) &&
                           (lRadPlanet2 < lVar4)) {
                          lVar20 = __aFlshr(lVar22,(ushort)lVis2_2);
                          uVar18 = lRadPlanet2;
                          if (lVar20 < lVar4) goto LAB_1070_b409;
                        }
                        *(uint *)(((THING *)lpth)->rgb + 4) =
                             *(uint *)(((THING *)lpth)->rgb + 4) | uVar6;
                        *(uint *)(((THING *)lpth)->rgb + 8) =
                             *(uint *)(((THING *)lpth)->rgb + 8) | uVar6;
                        goto IO_LThIncPlr2;
                      }
                      if ((*(uint *)(((THING *)lpth)->rgb + 2) & uVar6) == 0) {
                        lVar20 = __aFlshr(lVar22,(ushort)lVis2_2);
                        if ((lVar20 < lVar4) && (uVar18 = lRadPlanet2, lRadPlanet2 < lVar4))
                        goto LAB_1070_b409;
                      }
                      *(uint *)(((THING *)lpth)->rgb + 2) =
                           *(uint *)(((THING *)lpth)->rgb + 2) | uVar6;
                      *(uint *)((THING *)lpth)->rgb =
                           *(uint *)((THING *)lpth)->rgb & 0xdfff | 0x2000;
                      uVar18 = lRadPlanet2;
                    }
                  }
                }
              }
            }
LAB_1070_b409:
            lpth = (THING *)CONCAT22(uVar23,(THING *)lpth + 1);
          }
        }
        lppl = (PLANET *)CONCAT22(uVar16,(PLANET *)lppl + 1);
      } while( true );
    }
    uVar16 = (undefined2)((ulong)lppl >> 0x10);
    if (((PLANET *)lppl)->iPlayer == iPlr) {
      sVar7 = GetPlanetScannerRange(lppl,&iRadPlanet);
      uVar17 = __aFulmul((long)sVar7,(long)sVar7);
      uVar18 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
      iVar1 = ((POINT *)rgptPlan + lppl->id)->x;
      iVar2 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
      for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar3 = ((FLEET **)rglpfl)[j];
        iVar15 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
        if ((pFVar3 == (FLEET *)0x0) && (iVar15 == 0)) break;
        if ((((uint)pFVar3->wFlags >> 8 & 1) == 0) && (((uint)pFVar3->wFlags >> 10 & 1) == 0)) {
          lRadPlanet2 = uVar18;
          sVar8 = _abs(iVar1 - (&pFVar3->pt)->x);
          uVar18 = lRadPlanet2;
          if (sVar8 <= sVar7) {
            sVar9 = _abs(iVar2 - (pFVar3->pt).y);
            uVar18 = lRadPlanet2;
            if (sVar9 <= sVar7) {
              uVar18 = __aFulmul((long)sVar9,(long)sVar9);
              uVar19 = __aFulmul((long)sVar8,(long)sVar8);
              lVar4 = uVar19 + uVar18;
              uVar18 = lRadPlanet2;
              if ((lVar4 <= (long)uVar17) && ((pFVar3->idPlanet == -1 || (lVar4 <= lRadPlanet2)))) {
                sVar8 = PctCloakFromLpfl((FLEET *)CONCAT22(iVar15,pFVar3));
                if (sVar8 == 0) {
                  MarkFleet((FLEET *)CONCAT22(iVar15,pFVar3),3);
                  uVar18 = lRadPlanet2;
                }
                else {
                  uVar24 = 0;
                  uVar23 = 100;
                  iVar10 = 100 - sVar8;
                  iVar14 = iVar10 >> 0xf;
                  lVar20 = 100;
                  uVar18 = __aFulmul(uVar17,(long)(100 - sVar8));
                  uVar18 = __aFldiv(uVar18,lVar20);
                  uVar18 = __aFulmul(uVar18,CONCAT22(iVar14,iVar10));
                  lVar20 = __aFldiv(uVar18,CONCAT22(uVar24,uVar23));
                  uVar18 = lRadPlanet2;
                  if (lVar4 <= lVar20) {
                    if (pFVar3->idPlanet != -1) {
                      uVar24 = 0;
                      uVar23 = 100;
                      iVar10 = 100 - sVar8;
                      iVar14 = iVar10 >> 0xf;
                      lVar20 = 100;
                      uVar18 = __aFulmul(lRadPlanet2,(long)(100 - sVar8));
                      uVar18 = __aFldiv(uVar18,lVar20);
                      uVar18 = __aFulmul(uVar18,CONCAT22(iVar14,iVar10));
                      lVar20 = __aFldiv(uVar18,CONCAT22(uVar24,uVar23));
                      uVar18 = lRadPlanet2;
                      if (lVar20 < lVar4) goto LAB_1070_ad5d;
                    }
                    MarkFleet((FLEET *)CONCAT22(iVar15,pFVar3),3);
                    uVar18 = lRadPlanet2;
                  }
                }
              }
            }
          }
        }
LAB_1070_ad5d:
      }
    }
    lppl = (PLANET *)CONCAT22(uVar16,(PLANET *)lppl + 1);
  } while( true );
}



// ======================================================================
// Function: SetVisPFThings
// Address: 1070:b9ee
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1070c0f0) */
/* WARNING: Removing unreachable block (ram,0x1070bc7d) */
/* WARNING: Removing unreachable block (ram,0x1070c3b9) */
/* WARNING: Removing unreachable block (ram,0x1070bbf7) */
/* WARNING: Removing unreachable block (ram,0x1070be5c) */
/* WARNING: Removing unreachable block (ram,0x1070bfb4) */
/* WARNING: Removing unreachable block (ram,0x1070c197) */

void SetVisPFThings(short iPlr)

{
  int iVar1;
  int iVar2;
  FLEET *pFVar3;
  uint uVar4;
  short sVar5;
  int iVar6;
  int iVar7;
  uint uVar8;
  uint uVar9;
  short sVar10;
  THING *pTVar11;
  THING *pTVar12;
  PLANET *pPVar13;
  int iVar14;
  int iVar15;
  undefined2 uVar16;
  undefined2 uVar17;
  ulong uVar18;
  ulong uVar19;
  long lVar20;
  ulong uVar21;
  ulong uVar22;
  undefined2 uVar23;
  undefined2 uVar24;
  long lVis2;
  PLANET *lpplMac2;
  long l;
  THING *lpth2;
  THING *lpthMac2;
  long l_2;
  ushort grbitPlr;
  short dx;
  short iRadius;
  THING *lpthMac;
  long lRadius2;
  THING *lpth;
  short j;
  long d2;
  FLEET *lpfl2;
  short dy;
  short pctCloak;
  POINT pt;
  
  if (iPlr == -1) {
    uVar4 = 0;
  }
  else {
    uVar4 = 1 << ((byte)iPlr & 0x1f);
  }
  sVar5 = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
  if (sVar5 == raMassAccel) {
    pTVar11 = (THING *)lpThings + cThing;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < pTVar11) {
      uVar17 = (undefined2)((ulong)lpth >> 0x10);
      if ((((uint)lpth->idFull >> 0xd == 1) && (((uint)lpth->idFull >> 9 & 0xf) == iPlr)) &&
         ((*(uint *)((THING *)lpth)->rgb >> 10 & 0xf) != 0)) {
        *(uint *)((THING *)lpth)->rgb = *(uint *)((THING *)lpth)->rgb & 0x7fff | 0x8000;
        iVar6 = (*(uint *)((THING *)lpth)->rgb >> 10 & 0xf) + 4;
        iVar6 = iVar6 * iVar6;
        uVar21 = __aFulmul((long)iVar6,(long)iVar6);
        iVar1 = (&((THING *)lpth)->pt)->x;
        iVar2 = (((THING *)lpth)->pt).y;
        for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar3 = ((FLEET **)rglpfl)[j];
          iVar15 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
          if ((pFVar3 == (FLEET *)0x0) && (iVar15 == 0)) break;
          if (((((uint)pFVar3->wFlags >> 8 & 1) == 0) &&
              ((((uint)pFVar3->wFlags >> 10 & 1) == 0 &&
               (sVar5 = _abs(iVar1 - (&pFVar3->pt)->x), sVar5 <= iVar6)))) &&
             (sVar10 = _abs(iVar2 - (pFVar3->pt).y), sVar10 <= iVar6)) {
            uVar22 = __aFulmul((long)sVar10,(long)sVar10);
            uVar18 = __aFulmul((long)sVar5,(long)sVar5);
            if ((long)(uVar18 + uVar22) <= (long)uVar21) {
              sVar5 = PctCloakFromLpfl((FLEET *)CONCAT22(iVar15,pFVar3));
              if (sVar5 == 0) {
                MarkFleet((FLEET *)CONCAT22(iVar15,pFVar3),3);
              }
              else {
                uVar23 = 0;
                uVar16 = 100;
                iVar7 = 100 - sVar5;
                iVar14 = iVar7 >> 0xf;
                lVar20 = 100;
                uVar19 = __aFulmul(uVar21,(long)(100 - sVar5));
                uVar19 = __aFldiv(uVar19,lVar20);
                uVar19 = __aFulmul(uVar19,CONCAT22(iVar14,iVar7));
                lVar20 = __aFldiv(uVar19,CONCAT22(uVar23,uVar16));
                if ((long)(uVar18 + uVar22) <= lVar20) {
                  MarkFleet((FLEET *)CONCAT22(iVar15,pFVar3),3);
                }
              }
            }
          }
        }
        pTVar12 = (THING *)lpThings + cThing;
        lpth2 = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
        while ((THING *)lpth2 < pTVar12) {
          if (((iPlr != -1) &&
              (((((uint)lpth2->idFull >> 0xd == 0 || ((uint)lpth2->idFull >> 0xd == 1)) ||
                ((uint)lpth2->idFull >> 0xd == 3)) || ((uint)lpth2->idFull >> 0xd == 2)))) &&
             (((((uint)lpth2->idFull >> 0xd != 0 ||
                ((*(uint *)(((THING *)lpth2)->rgb + 8) & uVar4) == 0)) &&
               (((uint)lpth2->idFull >> 0xd != 3 ||
                ((*(uint *)(((THING *)lpth2)->rgb + 4) >> 4 & 1) == 0)))) &&
              (((((uint)lpth2->idFull >> 0xd != 1 || (-1 < *(int *)((THING *)lpth2)->rgb)) &&
                (((uint)lpth2->idFull >> 0xd != 2 ||
                 ((*(uint *)((THING *)lpth2)->rgb >> 0xd & 1) == 0)))) &&
               ((sVar5 = _abs(iVar1 - (&((THING *)lpth2)->pt)->x), sVar5 <= iVar6 &&
                (sVar10 = _abs(iVar2 - (((THING *)lpth2)->pt).y), sVar10 <= iVar6)))))))) {
            uVar22 = __aFulmul((long)sVar10,(long)sVar10);
            uVar18 = __aFulmul((long)sVar5,(long)sVar5);
            if ((long)(uVar18 + uVar22) <= (long)uVar21) {
              if ((uint)lpth2->idFull >> 0xd == 1) {
                *(uint *)((THING *)lpth2)->rgb = *(uint *)((THING *)lpth2)->rgb & 0x7fff | 0x8000;
IO_LThIncPlr3:
                if ((*(uint *)((int)&rgplr[0].wMdPlr +
                              ((uint)lpth2->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1) == 0) {
                  *(uint *)((int)&rgplr[0].wMdPlr +
                           ((uint)lpth2->idFull >> 9 & 0xf) * 0xc0) =
                       *(uint *)((int)&rgplr[0].wMdPlr +
                                ((uint)lpth2->idFull >> 9 & 0xf) * 0xc0) & 0xfeff | 0x100;
                  *(uint *)((int)&rgplr[0].wMdPlr +
                           ((uint)lpth2->idFull >> 9 & 0xf) * 0xc0) =
                       *(uint *)((int)&rgplr[0].wMdPlr +
                                ((uint)lpth2->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 | 3;
                }
              }
              else if ((uint)lpth2->idFull >> 0xd == 3) {
                *(uint *)(((THING *)lpth2)->rgb + 4) =
                     *(uint *)(((THING *)lpth2)->rgb + 4) & 0xffef | 0x10;
              }
              else {
                if ((uint)lpth2->idFull >> 0xd != 2) {
                  *(uint *)(((THING *)lpth2)->rgb + 4) =
                       *(uint *)(((THING *)lpth2)->rgb + 4) | uVar4;
                  *(uint *)(((THING *)lpth2)->rgb + 8) =
                       *(uint *)(((THING *)lpth2)->rgb + 8) | uVar4;
                  goto IO_LThIncPlr3;
                }
                if (((*(uint *)(((THING *)lpth2)->rgb + 2) & uVar4) != 0) ||
                   ((long)(uVar18 + uVar22) <= (long)uVar21)) {
                  *(uint *)(((THING *)lpth2)->rgb + 2) =
                       *(uint *)(((THING *)lpth2)->rgb + 2) | uVar4;
                  *(uint *)((THING *)lpth2)->rgb = *(uint *)((THING *)lpth2)->rgb & 0xdfff | 0x2000;
                }
              }
            }
          }
          lpth2 = (THING *)CONCAT22(lpth2._2_2_,(THING *)lpth2 + 1);
        }
        pPVar13 = (PLANET *)lpPlanets + cPlanet;
        l_2 = CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
        while ((PLANET *)l_2 < pPVar13) {
          uVar16 = (undefined2)((ulong)l_2 >> 0x10);
          if ((((((uint)((PLANET *)l_2)->wFlags >> 8 & 1) == 0) ||
               ((((PLANET *)l_2)->wFlags & 0xffU) < 3)) &&
              (sVar5 = _abs(((POINT *)rgptPlan + *(int *)l_2)->x - iVar1),
              sVar5 <= iVar6)) &&
             (sVar10 = _abs(*(int *)((int)&rgptPlan[0].y + *(int *)l_2 * 4) -
                                    iVar2), sVar10 <= iVar6)) {
            uVar22 = __aFulmul((long)sVar10,(long)sVar10);
            uVar18 = __aFulmul((long)sVar5,(long)sVar5);
            if ((long)(uVar18 + uVar22) <= (long)uVar21) {
              if ((((uint)((PLANET *)l_2)->wFlags >> 9 & 1) != 0) &&
                 (((PLANET *)l_2)->iPlayer != -1)) {
                iVar15 = ((PLANET *)l_2)->iPlayer * 4;
                uVar23 = *(undefined2 *)(iVar15 + 0x14e);
                iVar15 = *(int *)(iVar15 + 0x14c) +
                         (*(uint *)&((PLANET *)l_2)->field11_0x2c & 0xf) * 0x93;
                uVar8 = *(uint *)(iVar15 + 0x87);
                iVar15 = *(int *)(iVar15 + 0x89);
                if ((iVar15 < 1) && ((iVar15 < 0 || (uVar8 < 10000)))) {
                  uVar24 = 0;
                  uVar23 = 10000;
                  uVar19 = __aFulmul(uVar21,CONCAT22(iVar15,uVar8));
                  lVar20 = __aFldiv(uVar19,CONCAT22(uVar24,uVar23));
                  if (lVar20 < (long)(uVar18 + uVar22)) {
                    MarkPlanet((PLANET *)l_2,iPlr,2);
                    goto LAB_1070_c1d2;
                  }
                }
              }
              MarkPlanet((PLANET *)l_2,iPlr,3);
            }
          }
LAB_1070_c1d2:
          l_2 = CONCAT22(uVar16,(PLANET *)l_2 + 1);
        }
      }
      lpth = (THING *)CONCAT22(uVar17,(THING *)lpth + 1);
    }
  }
  else {
    sVar5 = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
    if (sVar5 == raMines) {
      pTVar11 = (THING *)lpThings + cThing;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      while ((THING *)lpth < pTVar11) {
        uVar17 = (undefined2)((ulong)lpth >> 0x10);
        if (((uint)lpth->idFull >> 0xd == 0) && (((uint)lpth->idFull >> 9 & 0xf) == iPlr)) {
          uVar4 = *(uint *)((THING *)lpth)->rgb;
          iVar1 = *(int *)(((THING *)lpth)->rgb + 2);
          iVar2 = (&((THING *)lpth)->pt)->x;
          iVar6 = (((THING *)lpth)->pt).y;
          for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
            pFVar3 = ((FLEET **)rglpfl)[j];
            iVar15 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
            if ((pFVar3 == (FLEET *)0x0) && (iVar15 == 0)) break;
            if ((((uint)pFVar3->wFlags >> 8 & 1) == 0) &&
               ((((uint)pFVar3->wFlags >> 10 & 1) == 0 && (pFVar3->idPlanet == -1)))) {
              uVar8 = _abs(iVar2 - (&pFVar3->pt)->x);
              if (((int)uVar8 >> 0xf <= iVar1) && (((int)uVar8 >> 0xf < iVar1 || (uVar8 <= uVar4))))
              {
                uVar9 = _abs(iVar6 - (pFVar3->pt).y);
                if (((int)uVar9 >> 0xf <= iVar1) &&
                   (((int)uVar9 >> 0xf < iVar1 || (uVar9 <= uVar4)))) {
                  uVar21 = __aFulmul((long)(int)uVar9,(long)(int)uVar9);
                  uVar22 = __aFulmul((long)(int)uVar8,(long)(int)uVar8);
                  if (((long)(uVar22 + uVar21) <= CONCAT22(iVar1,uVar4)) &&
                     ((sVar5 = PctCloakFromLpfl((FLEET *)CONCAT22(iVar15,pFVar3)), sVar5 == 0
                      || (sVar10 = Random(100), sVar5 <= sVar10)))) {
                    MarkFleet((FLEET *)CONCAT22(iVar15,pFVar3),3);
                  }
                }
              }
            }
          }
        }
        lpth = (THING *)CONCAT22(uVar17,(THING *)lpth + 1);
      }
    }
  }
  return;
}



// ======================================================================
// Function: SetVisPFFinish
// Address: 1070:c41c
// Segment: MEMORY_IO
// ======================================================================


void SetVisPFFinish(short iPlr)

{
  char *pcVar1;
  uint *puVar2;
  int iVar3;
  short sVar4;
  uint uVar5;
  short i;
  short j;
  short detMajor;
  
  sVar4 = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
  if (sVar4 == raAttack) {
    uVar5 = 7;
  }
  else {
    uVar5 = 3;
  }
  i = 0;
  do {
    if (game.cPlayer <= i) {
      return;
    }
    if (i != iPlr) {
      *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
      for (j = 0; j < 0x10; j = j + 1) {
        if ((1 << ((byte)iPlr & 0x1f) & *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x8b)) == 0) {
          if ((*(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) >> 8 & 1) != 0) {
            *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) =
                 *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xff00 | uVar5;
            goto IO_LFinShdef;
          }
        }
        else {
          *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) =
               *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
          *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) =
               *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xff00 | 7;
IO_LFinShdef:
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 3;
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
          pcVar1 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
          *pcVar1 = *pcVar1 + '\x01';
        }
      }
      *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xfff;
      for (j = 0; j < 10; j = j + 1) {
        if ((1 << ((byte)iPlr & 0x1f) & *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x8b)) == 0)
        {
          if ((*(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) >> 8 & 1) != 0) {
            *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) =
                 *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xff00 | uVar5;
            goto IO_LFinShdefSB;
          }
        }
        else {
          *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) =
               *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
          *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) =
               *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xff00 | 7;
IO_LFinShdefSB:
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 3;
          iVar3 = *(int *)((int)&rgplr[0].wFlags + i * 0xc0);
          puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
          *puVar2 = *puVar2 & 0xfff;
          puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
          *puVar2 = *puVar2 | iVar3 + 0x1000U & 0xf000;
        }
      }
    }
    i = i + 1;
  } while( true );
}



