// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
//

// ======================================================================
// Function: FReadShDef
// Address: 1070:0006
// Segment: MEMORY_IO
// ======================================================================

short FReadShDef(RTSHDEF *lprt, SHDEF *lpshdef, short iplrLoad)

{
    byte      *pbVar1;
    SHDEF     *pSVar2;
    SHDEF     *pSVar3;
    HULDEF    *pHVar4;
    int        iVar5;
    RTSHDEF   *pRVar6;
    HS        *pHVar7;
    SHDEF     *pSVar8;
    SHDEF     *pSVar9;
    undefined2 uVar10;
    undefined2 unaff_SS;
    HULDEF    *pHVar11;
    PART       part;
    HUL       *lphul;
    short      c;
    ulong      wt;
    HUL       *lphulBase;
    uint       local_ca;
    short      cch;
    short      ishdef;
    byte      *lpb;
    SHDEF      shdef;
    char       szTemp[40];

    _memset(&shdef, 0, 0x93);
    uVar10 = (undefined2)((ulong)lprt >> 0x10);
    pRVar6 = (RTSHDEF *)lprt;
    shdef.hul.ihuldef = (HullDef)pRVar6->ihuldef;
    shdef.wFlags = lprt->wFlags;
    shdef.hul.chs = pRVar6->chs;
    shdef.hul.ibmp = (short)pRVar6->ibmp;
    if ((shdef.wFlags & 0xff) == 7) {
        shdef.hul.dp = (&pRVar6->u_RTSHDEF_0x0004)->dp;
        shdef.turn = pRVar6->turn;
        shdef.cBuilt._0_2_ = (undefined2)pRVar6->cBuilt;
        shdef.cBuilt._2_2_ = *(undefined2 *)((int)&pRVar6->cBuilt + 2);
        shdef.cExist._0_2_ = (undefined2)pRVar6->cExist;
        shdef.cExist._2_2_ = *(undefined2 *)((int)&pRVar6->cExist + 2);
        lpb = (byte *)CONCAT22(uVar10, pRVar6 + 1);
        __fmemmove(shdef.hul.rghs, (RTSHDEF *)CONCAT22(uVar10, pRVar6 + 1), (uint)pRVar6->chs << 2);
        lpb = (byte *)CONCAT22(lpb._2_2_, (byte *)lpb + (uint)pRVar6->chs * 4);
    } else {
        shdef.hul.wtEmpty = (&pRVar6->u_RTSHDEF_0x0004)->dp;
        lpb = (byte *)CONCAT22(uVar10, &pRVar6->chs);
    }
    pHVar11 = LphuldefFromId(shdef.hul.ihuldef);
    local_ca = (((HULDEF *)pHVar11)->hul).ibmp;
    if ((shdef.hul.ibmp < (int)local_ca) || ((int)(local_ca + 4) <= shdef.hul.ibmp)) {
        shdef.hul.ibmp = shdef.hul.ibmp & 3U | local_ca;
    }
    cch = (short)*lpb;
    pbVar1 = (byte *)lpb + 1;
    lpb = pbVar1;
    if (cch == 0) {
        __fstrcpy(shdef.hul.szClass, (char *)pbVar1);
    } else {
        local_ca = 0x20;
        if (0x20 < (uint)cch) {
            return 0;
        }
        __fmemmove(szTemp, pbVar1, cch);
        FDecompressUserString(szTemp, cch, shdef.hul.szClass, &local_ca);
    }
    ishdef = shdef.wFlags >> 10 & 0x1f;
    if (0xf < (uint)ishdef) {
        ishdef = ishdef - 0x10;
    }
    if ((((shdef.wFlags & 0xff) == 7) || ((((SHDEF *)lpshdef)[ishdef].wFlags >> 9 & 1) != 0)) || ((((SHDEF *)lpshdef)[ishdef].wFlags & 0xff) < 7)) {
        pSVar9 = (SHDEF *)lpshdef + ishdef;
        pSVar8 = &shdef;
        for (iVar5 = 0x49; iVar5 != 0; iVar5 = iVar5 + -1) {
            pSVar3 = pSVar9;
            pSVar9 = (pSVar9->hul).rgTech;
            pSVar2 = pSVar8;
            pSVar8 = (pSVar8->hul).rgTech;
            (pSVar3->hul).ihuldef = (pSVar2->hul).ihuldef;
        }
        *&(pSVar9->hul).ihuldef = (char)(pSVar8->hul).ihuldef;
    } else if ((shdef.hul.ihuldef != (((SHDEF *)lpshdef + ishdef)->hul).ihuldef) || (shdef.hul.ibmp != ((SHDEF *)lpshdef)[ishdef].hul.ibmp)) {
        pSVar9 = (SHDEF *)lpshdef + ishdef;
        pSVar8 = &shdef;
        for (iVar5 = 0x49; iVar5 != 0; iVar5 = iVar5 + -1) {
            pSVar3 = pSVar9;
            pSVar9 = (pSVar9->hul).rgTech;
            pSVar2 = pSVar8;
            pSVar8 = (pSVar8->hul).rgTech;
            (pSVar3->hul).ihuldef = (pSVar2->hul).ihuldef;
        }
        *&(pSVar9->hul).ihuldef = (char)(pSVar8->hul).ihuldef;
    }
    if (idPlayer != -1) {
        UpdateShdefCost((SHDEF *)CONCAT22(lpshdef._2_2_, (SHDEF *)lpshdef + ishdef));
    }
    if ((((SHDEF *)lpshdef)[ishdef].wFlags & 0xff) == 7) {
        pSVar8 = (SHDEF *)lpshdef + ishdef;
        lphul = (HUL *)CONCAT22(lpshdef._2_2_, pSVar8);
        pHVar11 = LphuldefFromId(lphul->ihuldef);
        uVar10 = (undefined2)((ulong)pHVar11 >> 0x10);
        pHVar4 = (HULDEF *)pHVar11;
        wt._0_2_ = (pHVar4->hul).wtEmpty;
        for (c = 0; c < (int)(uint)(pSVar8->hul).chs; c = c + 1) {
            if ((pSVar8->hul).rghs[c].wFlags_0x2 >> 8 != 0) {
                pHVar7 = (pSVar8->hul).rghs + c;
                part.hs.grhst = pHVar7->grhst;
                part.hs.wFlags_0x2 = pHVar7->wFlags_0x2;
                local_ca = FLookupPart(&part);
                if (idPlayer == -1) {
                    local_ca = 0;
                }
                if ((((part.hs.grhst & ((pHVar4->hul).rghs + c)->grhst) ==
                      ~(hstPlanetary | hstHull | hstTerra | hstSpecialM | hstSpecialE | hstSBHull | hstSpecialSB | hstMines | hstMining | hstBomb | hstTorp |
                        hstBeam | hstArmor | hstShield | hstScanner | hstEngine)) ||
                     ((1 < (int)local_ca && (-1 < (int)shdef.wFlags)))) ||
                    ((pHVar4->hul).rghs[c].wFlags_0x2 >> 8 < part.hs.wFlags_0x2 >> 8)) {
                    (pSVar8->hul).rghs[c].wFlags_0x2 = (pSVar8->hul).rghs[c].wFlags_0x2 & 0xff;
                }
                wt._0_2_ = (ushort)wt + ((ARMOR *)part.u_PART_0x0004.parmor)->cMass * ((pSVar8->hul).rghs[c].wFlags_0x2 >> 8);
            }
            if (((c == 0) && ((pSVar8->hul).rghs[0].wFlags_0x2 >> 8 == 0)) && (((pHVar4->hul).rghs)->grhst == hstEngine)) {
                ((pSVar8->hul).rghs)->grhst = hstEngine;
                (pSVar8->hul).rghs[0].wFlags_0x2 = (pSVar8->hul).rghs[0].wFlags_0x2 & 0xff00 | 1;
                (pSVar8->hul).rghs[0].wFlags_0x2 = (pSVar8->hul).rghs[0].wFlags_0x2 & 0xff | (pHVar4->hul).rghs[0].wFlags_0x2 & 0xff00;
                part.hs.grhst = ((pSVar8->hul).rghs)->grhst;
                part.hs.wFlags_0x2 = (pSVar8->hul).rghs[0].wFlags_0x2;
                FLookupPart(&part);
                wt._0_2_ = (ushort)wt + ((ARMOR *)part.u_PART_0x0004.parmor)->cMass * ((pSVar8->hul).rghs[0].wFlags_0x2 >> 8);
            }
        }
        (pSVar8->hul).wtEmpty = (ushort)wt;
    }
    return 1;
}

// ======================================================================
// Function: ReadRtPlr
// Address: 1070:05e2
// Segment: MEMORY_IO
// ======================================================================

void ReadRtPlr(PLAYER *pplr, byte *pbIn)

{
    ushort  uVar1;
    char   *local_a;
    PLAYER *pplrRaw;
    short   iOff;

    pplrRaw = pbIn;
    _memset(pplr, 0, 0xc0);
    if ((pplrRaw->wMdPlr & 7) == 7) {
        _memmove(pplr, pbIn, 0x70);
        _memmove(pplr->rgmdRelation, pbIn + 0x71, (uint)pbIn[0x70]);
        iOff = pbIn[0x70] + 0x71;
    } else {
        _memmove(pplr, pbIn, 8);
        iOff = 8;
    }
    if (pbIn[iOff] == 0) {
        _strcpy(pplr->szName, pbIn + iOff + 1);
        uVar1 = _strlen(pplr->szName);
        iOff = iOff + uVar1 + 2;
    } else {
        local_a = hbrLightGray;
        FDecompressUserString((char *)(pbIn + iOff + 1), (uint)pbIn[iOff], pplr->szName, &local_a);
        iOff = iOff + pbIn[iOff] + 1;
    }
    if ((wVersFile >> 5 & 0x7f) < 0x37) {
        local_a = PszPlayerName(0, *(byte *)(pplr->szName[0] + 0x175f) & 1, 1, 0, 0, pplr);
        _strcpy(pplr->szNames, local_a);
    } else if (pbIn[iOff] == 0) {
        _strcpy(pplr->szNames, pbIn + iOff + 1);
    } else {
        local_a = hbrLightGray;
        FDecompressUserString((char *)(pbIn + iOff + 1), (uint)pbIn[iOff], pplr->szNames, &local_a);
    }
    pplr->wFlags = pplr->wFlags & 0xfff7;
    return;
}

// ======================================================================
// Function: FLoadGame
// Address: 1070:0810
// Segment: MEMORY_IO
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10702da2) */
/* WARNING: Removing unreachable block (ram,0x10701634) */
/* WARNING: Removing unreachable block (ram,0x10702d82) */
/* WARNING: Removing unreachable block (ram,0x10702da7) */
/* WARNING: Variable defined which should be unmapped: szEntry */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short FLoadGame(char *pszFileName, char *pszExt)

{
    int       *piVar1;
    uint      *puVar2;
    char      *pcVar3;
    ushort    *puVar4;
    GAME      *pGVar5;
    int       *piVar6;
    byte       bVar7;
    int        iVar8;
    PLANET    *pPVar9;
    byte      *pbVar10;
    FLEET    **ppFVar11;
    byte      *pbVar12;
    PLANET    *pPVar13;
    short      sVar14;
    short      sVar15;
    FLEET     *pFVar16;
    short      sVar17;
    ushort     uVar18;
    int        iVar19;
    undefined2 uVar20;
    undefined2 unaff_SI;
    char      *pcVar21;
    int       *piVar22;
    int       *piVar23;
    FLEET    **ppFVar24;
    ushort    *puVar25;
    SCOREX    *pSVar26;
    undefined2 unaff_DI;
    GAME      *pGVar27;
    undefined2 uVar28;
    undefined2 unaff_SS;
    PLANET    *pPVar29;
    PL        *pPVar30;
    FLEET     *lpfl_00;
    SCOREX    *pSVar31;
    THING     *pTVar32;
    void      *pvVar33;
    ulong      uVar34;
    ulong      uVar35;
    char       szEntry[16];
    char      *psz;
    char       szSection[16];
    char       szIniFile[16];
    char       local_148[224];
    uint       local_68;
    uint       local_66;
    int        local_64;
    int        local_62;
    uint       local_60;
    PLANET    *local_58;
    uint       local_56;
    int        local_54;
    undefined2 uStack_52;
    uint       local_50;
    uint       local_4e;
    undefined4 local_4c;
    short      x;
    short      grf;
    short      dt;
    PLANET    *lpplMac;
    short      j;
    short      iPlayer;
    THING     *lpthMac;
    short      cturn;
    short      env[9];
    FLEET     *lpfl;
    THING     *lpth;
    short      i;
    PLANET    *lppl;
    short      fSilentSav;
    short (*penvMemSav)[9];
    short    fHaveHistoryData;
    short    cPlanetAlloc;
    STARPACK sp;
    short    cPlanetHist;
    short    iplrSav;

    uVar35 = CONCAT22(unaff_SI, unaff_DI);
    grf = 0;
    cturn = 0;
    _strcpy((char *)szBase, pszFileName);
    gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfbff;
    penvMem = &env;
    sVar14 = __setjmp(env);
    if (sVar14 == 0) {
        sVar14 = FOpenFile(dtXY, -1, 0x20);
        if (sVar14 != 0) {
            ReadRt();
            if (hdrCur.wFlags >> 10 == 7) {
                pcVar21 = (char *)rgbCur;
                pGVar27 = (GAME *)&game;
                for (iVar19 = 0x20; iVar19 != 0; iVar19 = iVar19 + -1) {
                    pGVar5 = pGVar27;
                    pGVar27 = (GAME *)((int)&pGVar27->lid + 2);
                    pcVar3 = pcVar21;
                    pcVar21 = pcVar21 + 2;
                    *&pGVar5->lid = *pcVar3;
                }
                game.fDirty = 0;
                dGal = game.mdSize * 400 + 400;
                dGalInv = game.mdSize * 400 + 0x960;
                x = 1000;
                for (i = 0; i < game.cPlanMax; i = i + 1) {
                    RgFromStream(&sp, 4);
                    x = x + ((uint)sp.dwFlags & 0x3ff);
                    ((POINT *)rgptPlan + i)->x = x;
                    uVar34 = __aFulshr(uVar35, szEntry._0_2_);
                    *(uint *)((int)&rgptPlan[0].y + i * 4) = (uint)uVar34 & 0xfff;
                    uVar34 = __aFulshr(uVar35, szEntry._0_2_);
                    ((short *)rgidPlan)[i] = (uint)uVar34 & 0x3ff;
                    if (((dGal + 1000 <= x) || (dGal + 1000 <= *(int *)((int)&rgptPlan[0].y + i * 4))) || (999 < ((short *)rgidPlan)[i]))
                        goto IO_XYCorrupt;
                }
                ReadRt();
                if (hdrCur.wFlags >> 10 == 0) {
                    StreamClose();
                    if (((*pszExt == 'h') || (*pszExt == 'H')) && ((pszExt[1] == 's' || (pszExt[1] == 'S')))) {
                        dt = 2;
                        iPlayer = -1;
                    } else {
                        dt = 3;
                        grf = grf | 0x3000;
                        sVar14 = _atoi(pszExt + 1);
                        iPlayer = sVar14 + -1;
                    }
                    ResetMessages();
                    _memset((PLAYER *)rgplr, 0, game.cPlayer * 0xc0);
                    ResetHb(htShips);
                    sVar14 = fFileErrSilent;
                    idPlayer = iPlayer;
                    fFileErrSilent = 1;
                    if (iPlayer == -1) {
                    IO_LNoHistFile:
                        cPlanetHist = 0;
                        FreeLp(lpPlanets, htPlanets);
                        lpPlanets._0_2_ = (PLANET *)0x0;
                        lpPlanets._2_2_ = 0;
                        cThing = 0;
                        FreeLp(lpThings, htThings);
                        lpThings = (THING *)0x0;
                    } else {
                        sVar15 = FOpenFile(dtHist, iPlayer, 0x20);
                        if (sVar15 == 0)
                            goto IO_LNoHistFile;
                        ReadRt();
                        uVar28 = rgbCur._0_2_;
                        vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData);
                        lpThings = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
                        local_4c = (PLANET *)CONCAT22(local_4c._2_2_, (PLANET *)local_4c);
                        if (hdrCur.wFlags >> 10 != 0x20) {
                        IO_CorruptHist:
                            StreamClose();
                            sVar15 = 0x10;
                            pcVar21 = PszFormatIds(idsHistoryFileAppearsCorruptHistoricalDataWill, (short *)0x0);
                            AlertSz(pcVar21, sVar15);
                            goto IO_LNoHistFile;
                        }
                        cPlanetHist._0_1_ = rgbCur[0];
                        cPlanetHist._1_1_ = rgbCur[1];
                        cPlanetAlloc = rgbCur._0_2_ + rgbCur._2_2_;
                        if (1000 < cPlanetAlloc) {
                            cPlanetAlloc = 1000;
                        }
                        iVar19 = cPlanetAlloc;
                        if (cPlanetAlloc < 1) {
                            iVar19 = 1;
                        }
                        lpPlanets = LpAlloc(iVar19 * 0x38, htPlanets);
                        ReadRt();
                        i = 0;
                        lppl = lpPlanets;
                        while (true) {
                            if ((int)uVar28 <= i)
                                break;
                            if (hdrCur.wFlags >> 10 != 0xe)
                                goto IO_CorruptHist;
                            sVar15 = FReadPlanet(iPlayer, lppl, 1, 0);
                            if (sVar15 == 0)
                                goto IO_CorruptHist;
                            if (((PLANET *)lppl)->iPlayer == iPlayer) {
                                ((PLANET *)lppl)->iPlayer = -1;
                                ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xff00 | 3;
                            }
                            ReadRt();
                            i = i + 1;
                            lppl = (PLANET *)lppl + 1;
                        }
                        if (hdrCur.wFlags >> 10 == 0x21) {
                            vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData);
                            lpThings = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
                            local_4c = (PLANET *)CONCAT22(local_4c._2_2_, (PLANET *)local_4c);
                            if ((uint)cbbitfMsg < (hdrCur.wFlags & 0x3ff))
                                goto IO_CorruptHist;
                            _memcpy((byte *)bitfMsgFiltered, (char *)rgbCur, hdrCur.wFlags & 0x3ff);
                            ReadRt();
                        }
                        while (hdrCur.wFlags >> 10 == 6) {
                            iVar19 = (int)rgbCur[0];
                            ReadRtPlr((PLAYER *)rgplr + iVar19, (byte *)rgbCur);
                            *(undefined2 *)((int)&rgplr[0].cPlanet + iVar19 * 0xc0) = 0;
                            local_4c._2_2_ = *(uint *)((int)&rgplr[0].wFlags_0x4 + iVar19 * 0xc0) & 0xf000;
                            *(uint *)((int)&rgplr[0].wFlags_0x4 + iVar19 * 0xc0) = local_4c._2_2_;
                            ReadRt();
                        }
                        i = 0;
                        while (hdrCur.wFlags >> 10 == 0x1a) {
                            for (; (*(char *)((int)&rgplr[0].cShDef + i * 0xc0) == '\0' && (i < game.cPlayer)); i = i + 1) {
                            }
                            if (i == game.cPlayer)
                                break;
                            if ((*(int *)(i * 4 + rglpshdef) == 0) && (*(int *)(i * 4 + rglpshdef_0x2) == 0)) {
                                pvVar33 = LpAlloc(0x930, htShips);
                                *(undefined2 *)(i * 4 + rglpshdef) = (void *)pvVar33;
                                *(undefined2 *)(i * 4 + rglpshdef_0x2) = (int)((ulong)pvVar33 >> 0x10);
                                for (j = 0; j < 0x10; j = j + 1) {
                                    local_4c._2_2_ = *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                                    *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) = local_4c._2_2_;
                                    *(undefined2 *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x8b) = 0;
                                }
                            }
                            sVar15 = idPlayer;
                            if (idPlayer == -1) {
                                idPlayer = i;
                            } else {
                                idPlayer = -1;
                            }
                            sVar17 = FReadShDef(rgbCur, (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + rglpshdef_0x2), (SHDEF *)*(undefined2 *)(i * 4 + rglpshdef)),
                                                sVar15);
                            vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData);
                            lpThings = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
                            local_4c = (PLANET *)CONCAT22(local_4c._2_2_, (PLANET *)local_4c);
                            if (sVar17 == 0)
                                goto IO_CorruptHist;
                            pcVar3 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
                            idPlayer = sVar15;
                            *pcVar3 = *pcVar3 + -1;
                            ReadRt();
                        }
                        i = 0;
                        while (hdrCur.wFlags >> 10 == 0x1a) {
                            for (; (*(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) >> 0xc == 0 && (i < game.cPlayer)); i = i + 1) {
                            }
                            if (i == game.cPlayer)
                                break;
                            if ((*(int *)(i * 4 + rglpshdefSB) == 0) && (*(int *)(i * 4 + rglpshdefSB_0x2) == 0)) {
                                pvVar33 = LpAlloc(0x5be, htShips);
                                *(undefined2 *)(i * 4 + rglpshdefSB) = (void *)pvVar33;
                                *(undefined2 *)(i * 4 + rglpshdefSB_0x2) = (int)((ulong)pvVar33 >> 0x10);
                                for (j = 0; j < 10; j = j + 1) {
                                    local_4c._2_2_ = *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                                    *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) = local_4c._2_2_;
                                    *(undefined2 *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x8b) = 0;
                                }
                            }
                            sVar15 = idPlayer;
                            if (idPlayer == -1) {
                                idPlayer = i;
                            } else {
                                idPlayer = -1;
                            }
                            sVar17 = FReadShDef(
                                rgbCur, (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + rglpshdefSB_0x2), (SHDEF *)*(undefined2 *)(i * 4 + rglpshdefSB)), sVar15);
                            vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData);
                            lpThings = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
                            local_4c = (PLANET *)CONCAT22(local_4c._2_2_, (PLANET *)local_4c);
                            if (sVar17 == 0)
                                goto IO_CorruptHist;
                            local_4c._2_2_ = *(int *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) - 0x1000U & 0xf000;
                            puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
                            idPlayer = sVar15;
                            *puVar2 = *puVar2 & 0xfff;
                            puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
                            *puVar2 = *puVar2 | local_4c._2_2_;
                            ReadRt();
                        }
                        while (true) {
                            pPVar9 = (PLANET *)CONCAT22(local_4c._2_2_, (PLANET *)local_4c);
                            pPVar29 = (PLANET *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData);
                            if (hdrCur.wFlags >> 10 != 0x2d)
                                break;
                            local_4c._2_2_ = rgbCur._0_2_ & 0x1f;
                            piVar22 = (int *)rgbCur;
                            piVar23 = &local_62;
                            for (iVar19 = 0xc; iVar19 != 0; iVar19 = iVar19 + -1) {
                                piVar6 = piVar23;
                                piVar23 = piVar23 + 1;
                                piVar1 = piVar22;
                                piVar22 = piVar22 + 1;
                                *piVar6 = *piVar1;
                            }
                            if ((*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) == 0) && (*(int *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2) == 0)) {
                                pvVar33 = LpAlloc(0x978, htMisc);
                                *(void **)((SCOREX **)rgsxPlr + local_4c._2_2_) = (void *)pvVar33;
                                *(undefined2 *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2) = (int)((ulong)pvVar33 >> 0x10);
                                ((short *)rgcsxPlr)[local_4c._2_2_] = 0;
                            }
                            if ((*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) != 0) || (*(int *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2) != 0)) {
                                if (local_62 < 0) {
                                    local_66 = local_60;
                                } else {
                                    local_66 = game.turn;
                                }
                                local_64 = 0;
                                while ((local_64 < ((short *)rgcsxPlr)[local_4c._2_2_] &&
                                        (*(uint *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + local_64 * 0x18 + 2) < local_66))) {
                                    local_64 = local_64 + 1;
                                }
                                if (((local_64 < ((short *)rgcsxPlr)[local_4c._2_2_]) &&
                                     (local_66 != *(uint *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + local_64 * 0x18 + 2))) ||
                                    (100 < local_64)) {
                                    if (((short *)rgcsxPlr)[local_4c._2_2_] < 0x65) {
                                        __fmemmove((void *)CONCAT22(*(undefined2 *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2),
                                                                    (void *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + (local_64 + 1) * 0x18)),
                                                   (void *)CONCAT22(*(undefined2 *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2),
                                                                    (void *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + local_64 * 0x18)),
                                                   (((short *)rgcsxPlr)[local_4c._2_2_] - local_64) * 0x18);
                                        ((short *)rgcsxPlr)[local_4c._2_2_] = ((short *)rgcsxPlr)[local_4c._2_2_] + 1;
                                    } else if (0 < local_64) {
                                        if (1 < local_64) {
                                            /* WARNING: Load size is inaccurate */
                                            __fmemmove((void *)CONCAT22(*(undefined2 *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2),
                                                                        ((SCOREX **)rgsxPlr)[local_4c._2_2_]),
                                                       (void *)CONCAT22(*(undefined2 *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2),
                                                                        (void *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + 0x18)),
                                                       (local_64 + -1) * 0x18);
                                        }
                                        local_64 = local_64 + -1;
                                    }
                                } else if (local_64 == ((short *)rgcsxPlr)[local_4c._2_2_]) {
                                    ((short *)rgcsxPlr)[local_4c._2_2_] = ((short *)rgcsxPlr)[local_4c._2_2_] + 1;
                                }
                                uVar28 = *(undefined2 *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2);
                                piVar22 = (int *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + local_64 * 0x18);
                                piVar23 = &local_62;
                                for (iVar19 = 0xc; iVar19 != 0; iVar19 = iVar19 + -1) {
                                    piVar6 = piVar22;
                                    piVar22 = piVar22 + 1;
                                    piVar1 = piVar23;
                                    piVar23 = piVar23 + 1;
                                    *piVar6 = *piVar1;
                                }
                                *(uint *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + local_64 * 0x18 + 2) = local_66;
                                local_68 = *(uint *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + local_64 * 0x18) & 0x7fff | 0x8000;
                                *(uint *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + local_64 * 0x18) = local_68;
                            }
                            ReadRt();
                        }
                        if (hdrCur.wFlags >> 10 == 0x29) {
                            if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 9 & 1) == 0) {
                                while (true) {
                                    pPVar9 = (PLANET *)CONCAT22(local_4c._2_2_, (PLANET *)local_4c);
                                    pPVar29 = (PLANET *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData);
                                    if (hdrCur.wFlags >> 10 != 0x29)
                                        break;
                                    ReadRt();
                                }
                            } else {
                                vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData);
                                pPVar9 = (PLANET *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData);
                                if (((byte *)vlpbAiData == (byte *)0x0) && (vlpbAiData = pPVar29, pPVar9 = pPVar29, vlpbAiData._2_2_ == 0)) {
                                    vlpbAiData = LpAlloc(0x1fa0, htMisc);
                                    pPVar9 = vlpbAiData;
                                    if (vlpbAiData == (PLANET *)0x0)
                                        goto IO_CorruptHist;
                                }
                                while (pPVar29 = vlpbAiData, hdrCur.wFlags >> 10 == 0x29) {
                                    local_4c = pPVar9;
                                    __fmemmove(pPVar9, rgbCur, hdrCur.wFlags & 0x3ff);
                                    local_4c._0_2_ = ((PLANET *)local_4c)->rgpctMinLevel + ((hdrCur.wFlags & 0x3ff) - 6);
                                    ReadRt();
                                    pPVar9 = (PLANET *)CONCAT22(local_4c._2_2_, (PLANET *)local_4c);
                                }
                            }
                        }
                        if (hdrCur.wFlags >> 10 == 0x2b) {
                            cThing._0_1_ = rgbCur[0];
                            cThing._1_1_ = rgbCur[1];
                            cThingAlloc = rgbCur._0_2_ + 10;
                            if (0xfd2 < cThingAlloc) {
                                cThingAlloc = 0xfd2;
                            }
                            vlpbAiData = pPVar29;
                            local_4c = pPVar9;
                            lpThings = LpAlloc(cThingAlloc * 0x12, htThings);
                            if (lpThings == (THING *)0x0)
                                goto IO_CorruptHist;
                            __fmemset(lpThings, 0, cThingAlloc * 0x12);
                            ReadRt();
                            lpth = lpThings;
                            pPVar9 = local_4c;
                            for (i = 0; pPVar29 = vlpbAiData, i < cThing; i = i + 1) {
                                local_4c = pPVar9;
                                if (hdrCur.wFlags >> 10 != 0x2b)
                                    goto IO_CorruptHist;
                                __fmemcpy(lpth, rgbCur, hdrCur.wFlags & 0x3ff);
                                ReadRt();
                                lpth = (THING *)lpth + 1;
                                pPVar9 = local_4c;
                            }
                        }
                        vlpbAiData = pPVar29;
                        local_4c = pPVar9;
                        StreamClose();
                    }
                    fFileErrSilent = sVar14;
                    GetFileStatus(dt, iPlayer);
                    sVar14 = FOpenFile(dt | grf, iPlayer, 0x20);
                    if (sVar14 != 0) {
                        if (iPlayer == -1) {
                            local_4c = (PLANET *)(CONCAT22((uint)rgbCur._14_2_ >> 0xb, (PLANET *)local_4c) & 0x1ffff);
                            gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffe | (uint)rgbCur._14_2_ >> 0xb & 1;
                        }
                        do {
                            cturn = cturn + 1;
                            cPlanet = 0;
                            cFleet = 0;
                            ReadRt();
                            while ((hdrCur.wFlags >> 10 == 0x1f || (hdrCur.wFlags >> 10 == 0x27))) {
                                if (hdrCur.wFlags >> 10 != 0x27) {
                                    if (lpbBattleLog == (byte *)0x0) {
                                        lpbBattleCur = LpAlloc(0xffc8, htBattle);
                                        lpbBattleLog = lpbBattleCur;
                                    }
                                    if (((byte *)lpbBattleCur < (byte *)0xffc9) && (-(int)(byte *)lpbBattleCur - 0x38U < (uint)rgbCur._6_2_)) {
                                        pbVar10 = lpbBattleCur;
                                        pbVar10[0] = 0xff;
                                        pbVar10[1] = 0xff;
                                        lpbBattleCur = LpAlloc(0xffc8, htBattle);
                                    }
                                }
                                __fmemmove(lpbBattleCur, rgbCur, hdrCur.wFlags & 0x3ff);
                                lpbBattleCur = (byte *)CONCAT22(lpbBattleCur._2_2_, (byte *)lpbBattleCur + (hdrCur.wFlags & 0x3ff));
                                ReadRt();
                            }
                            if ((((byte *)lpbBattleCur != (byte *)0x0) || (lpbBattleCur._2_2_ != 0)) &&
                                (pbVar10 = lpbBattleCur, pbVar10[0] = 0xff, pbVar10[1] = 0xff, (wVersFile >> 5 & 0x7f) < 0x50)) {
                                UpdateBattleRecords();
                            }
                            while (hdrCur.wFlags >> 10 == 6) {
                                iVar19 = (int)rgbCur[0];
                                ReadRtPlr((PLAYER *)rgplr + iVar19, (byte *)rgbCur);
                                cPlanet = cPlanet + *(int *)((int)&rgplr[0].cPlanet + iVar19 * 0xc0);
                                *(undefined2 *)((int)&rgplr[0].cPlanet + iVar19 * 0xc0) = 0;
                                cFleet = cFleet + (*(uint *)((int)&rgplr[0].wFlags_0x4 + iVar19 * 0xc0) & 0xfff);
                                local_4c._2_2_ = *(uint *)((int)&rgplr[0].wFlags_0x4 + iVar19 * 0xc0) & 0xf000;
                                *(uint *)((int)&rgplr[0].wFlags_0x4 + iVar19 * 0xc0) = local_4c._2_2_;
                                ReadRt();
                            }
                            if (dt == 2) {
                                if (hdrCur.wFlags >> 10 == 0x24) {
                                    lSaltCur._0_1_ = rgbCur[0];
                                    lSaltCur._1_1_ = rgbCur[1];
                                    lSaltCur._2_1_ = rgbCur[2];
                                    lSaltCur._3_1_ = rgbCur[3];
                                    ReadRt();
                                } else {
                                    lSaltCur._0_1_ = '\0';
                                    lSaltCur._1_1_ = '\0';
                                    lSaltCur._2_1_ = '\0';
                                    lSaltCur._3_1_ = '\0';
                                }
                            } else {
                                lSaltCur._0_2_ = *(undefined2 *)(char *)((int)&rgplr[0].lSalt + iPlayer * 0xc0);
                                lSaltCur._2_2_ = *(undefined2 *)(char *)((int)&rgplr[0].lSalt + 2 + iPlayer * 0xc0);
                            }
                            sVar14 = FCheckPassword();
                            if (sVar14 == 0) {
                                if (((ini.wFlags >> 0xe & 1) != 0) || ((int)ini.wFlags < 0)) {
                                    sVar14 = 0x10;
                                    pcVar21 = PszFormatIds(idsPasswordHaveEnteredIncorrectPleaseTry, (short *)0x0);
                                    AlertSz(pcVar21, sVar14);
                                }
                                break;
                            }
                            ReadPlayerMessages();
                            ResetHb(htFleets);
                            ResetHb(htOrd);
                            FreeLp(rglpfl, htMisc);
                            rglpfl._0_2_ = (FLEET **)0x0;
                            rglpfl._2_2_ = 0;
                            lppl = lpPlanets;
                            if (lpPlanets == (PLANET *)0x0) {
                                cPlanetAlloc = cPlanet;
                                if (cPlanet < 1) {
                                    cPlanetAlloc = 1;
                                }
                                pPVar29 = LpAlloc(cPlanetAlloc * 0x38, htPlanets);
                                /* WARNING: Ignoring partial resolution of indirect */
                                lpPlanets._0_2_ = (PLANET *)pPVar29;
                                /* WARNING: Ignoring partial resolution of indirect */
                                lpPlanets._2_2_ = (int)((ulong)pPVar29 >> 0x10);
                                lppl = lpPlanets;
                            }
                            j = 0;
                            lpPlanets = lppl;
                            for (i = 0; i < cPlanet; i = i + 1) {
                                fHaveHistoryData = 0;
                                if (cPlanetHist != 0) {
                                    while ((j < cPlanetHist && (lppl->id < (int)(rgbCur._0_2_ << 5) >> 5))) {
                                        j = j + 1;
                                        lppl = (PLANET *)lppl + 1;
                                    }
                                    if ((j < cPlanetHist) && ((int)(rgbCur._0_2_ << 5) >> 5 == lppl->id)) {
                                        fHaveHistoryData = 1;
                                    } else {
                                        if (cPlanetAlloc == cPlanetHist) {
                                            cPlanetAlloc = cPlanetAlloc + 8;
                                            pPVar29 = LpReAlloc(lpPlanets, cPlanetAlloc * 0x38, htPlanets);
                                            /* WARNING: Ignoring partial resolution of indirect */
                                            lpPlanets._0_2_ = (PLANET *)pPVar29;
                                            /* WARNING: Ignoring partial resolution of indirect */
                                            lpPlanets._2_2_ = (int)((ulong)pPVar29 >> 0x10);
                                            lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets + j);
                                        }
                                        if (j < cPlanetHist) {
                                            __fmemmove((PLANET *)lppl + 1, lppl, (cPlanetHist - j) * 0x38);
                                        }
                                        cPlanetHist = cPlanetHist + 1;
                                    }
                                }
                                sVar15 = FReadPlanet(iPlayer, lppl, 0, fHaveHistoryData);
                                sVar14 = idPlayer;
                                if (sVar15 == 0)
                                    goto IO_Corrupt_2;
                                if (((PLANET *)lppl)->iPlayer != -1) {
                                    piVar1 = (int *)((int)&rgplr[0].cPlanet + ((PLANET *)lppl)->iPlayer * 0xc0);
                                    *piVar1 = *piVar1 + 1;
                                }
                                ReadRt();
                                if (hdrCur.wFlags >> 10 == 0x1c) {
                                    if ((*(int *)&((PLANET *)lppl)->lpplprod != 0) ||
                                        (pPVar29 = local_4c, *(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) {
                                        bVar7 = ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMax;
                                        local_4c._2_2_ = (uint)bVar7;
                                        pPVar29 = (PLANET *)(ulong)CONCAT12(bVar7, (PLANET *)local_4c);
                                        if (local_4c._2_2_ <= (hdrCur.wFlags & 0x3ff) / 4) {
                                            FreePl((PL *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2), *(PL **)&((PLANET *)lppl)->lpplprod));
                                            *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
                                            *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
                                            pPVar29 = (PLANET *)CONCAT22(local_4c._2_2_, (PLANET *)local_4c);
                                        }
                                    }
                                    if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) && (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
                                        local_4c = pPVar29;
                                        pPVar30 = LpplAlloc(4, (hdrCur.wFlags & 0x3ff) / 4 + 2, htOrd);
                                        *(PL **)&((PLANET *)lppl)->lpplprod = (PL *)pPVar30;
                                        *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = (int)((ulong)pPVar30 >> 0x10);
                                        pPVar29 = local_4c;
                                    }
                                    local_4c = pPVar29;
                                    __fmemmove((void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                                                (void *)(*(int *)&((PLANET *)lppl)->lpplprod + 4)),
                                               rgbCur, hdrCur.wFlags & 0x3ff);
                                    ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac = (byte)((ulong)(hdrCur.wFlags & 0x3ff) / 4);
                                    ReadRt();
                                }
                                if (cPlanetHist == 0) {
                                    lppl = (PLANET *)lppl + 1;
                                }
                            }
                            if (cPlanetHist != 0) {
                                cPlanet = cPlanetHist;
                            }
                            i = 0;
                            pPVar29 = local_4c;
                            while (true) {
                                local_4c._2_2_ = (uint)((ulong)pPVar29 >> 0x10);
                                local_4c._0_2_ = (PLANET *)pPVar29;
                                if (game.cPlayer <= i)
                                    break;
                                if (i == iPlayer) {
                                    *(undefined2 *)(i * 4 + rglpshdef) = 0x3f00;
                                    *(undefined2 *)(i * 4 + rglpshdef_0x2) = 0x1120;
                                IO_FreeShdef:
                                    local_4c._2_2_ = (uint)((ulong)pPVar29 >> 0x10);
                                    local_4c._0_2_ = (PLANET *)pPVar29;
                                    for (j = 0; pPVar29 = (PLANET *)CONCAT22(local_4c._2_2_, (PLANET *)local_4c), j < 0x10; j = j + 1) {
                                        local_4c._2_2_ = *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                                        *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) = local_4c._2_2_;
                                        *(undefined2 *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x8b) = 0;
                                    }
                                LAB_1070_1c2c:
                                    sVar15 = idPlayer;
                                    if (idPlayer == -1) {
                                        idPlayer = i;
                                    } else if (i != idPlayer) {
                                        idPlayer = -1;
                                    }
                                    local_4c = pPVar29;
                                    for (j = 0; pPVar29 = local_4c, j < *(char *)((int)&rgplr[0].cShDef + i * 0xc0); j = j + 1) {
                                        sVar14 = sVar15;
                                        if (hdrCur.wFlags >> 10 != 0x1a)
                                            goto IO_Corrupt_2;
                                        sVar17 = FReadShDef(
                                            rgbCur, (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + rglpshdef_0x2), (SHDEF *)*(undefined2 *)(i * 4 + rglpshdef)),
                                            sVar15);
                                        sVar14 = idPlayer;
                                        if (sVar17 == 0)
                                            goto IO_Corrupt_2;
                                        ReadRt();
                                    }
                                } else {
                                    sVar15 = idPlayer;
                                    if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
                                        if ((*(int *)(i * 4 + rglpshdef) == 0) && (*(int *)(i * 4 + rglpshdef_0x2) == 0)) {
                                            local_4c = pPVar29;
                                            pvVar33 = LpAlloc(0x930, htShips);
                                            *(undefined2 *)(i * 4 + rglpshdef) = (void *)pvVar33;
                                            *(undefined2 *)(i * 4 + rglpshdef_0x2) = (int)((ulong)pvVar33 >> 0x10);
                                            pPVar29 = local_4c;
                                            goto IO_FreeShdef;
                                        }
                                        goto LAB_1070_1c2c;
                                    }
                                }
                                idPlayer = sVar15;
                                i = i + 1;
                            }
                            for (i = 0; i < game.cPlayer; i = i + 1) {
                                *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
                                if ((*(int *)(i * 4 + rglpshdef) != 0) || (*(int *)(i * 4 + rglpshdef_0x2) != 0)) {
                                    for (j = 0; j < 0x10; j = j + 1) {
                                        if ((*(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
                                            if (((i == idPlayer) || (((uint)gd.grBits >> 1 & 1) != 0)) ||
                                                ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0)) {
                                                pcVar3 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
                                                *pcVar3 = *pcVar3 + '\x01';
                                            } else {
                                                local_4c._2_2_ = *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                                                *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) = local_4c._2_2_;
                                            }
                                        }
                                    }
                                }
                            }
                            iVar19 = cFleet;
                            if (cFleet < 1) {
                                iVar19 = 1;
                            }
                            rglpfl = LpAlloc(iVar19 << 2, htMisc);
                            for (i = 0; i < cFleet; i = i + 1) {
                                lpfl_00 = LpAlloc(0x7c, htFleets);
                                uVar28 = rglpfl._2_2_;
                                uVar20 = (undefined2)((ulong)lpfl_00 >> 0x10);
                                pFVar16 = (FLEET *)lpfl_00;
                                ppFVar24 = (FLEET **)rglpfl + i;
                                *(FLEET **)ppFVar24 = pFVar16;
                                *(undefined2 *)((int)ppFVar24 + 2) = uVar20;
                                sVar14 = FReadFleet(lpfl_00);
                                if (sVar14 == 0)
                                    goto IO_LError_2;
                                local_4c._2_2_ = *(int *)((int)&rgplr[0].wFlags_0x4 + pFVar16->iPlayer * 0xc0) + 1U & 0xfff;
                                puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar16->iPlayer * 0xc0);
                                *puVar2 = *puVar2 & 0xf000;
                                puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar16->iPlayer * 0xc0);
                                *puVar2 = *puVar2 | local_4c._2_2_;
                            }
                            for (i = 0; i < game.cPlayer; i = i + 1) {
                                sVar15 = idPlayer;
                                if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
                                    if ((*(int *)(i * 4 + rglpshdefSB) == 0) && (*(int *)(i * 4 + rglpshdefSB_0x2) == 0)) {
                                        pvVar33 = LpAlloc(0x5be, htShips);
                                        *(undefined2 *)(i * 4 + rglpshdefSB) = (void *)pvVar33;
                                        *(undefined2 *)(i * 4 + rglpshdefSB_0x2) = (int)((ulong)pvVar33 >> 0x10);
                                        for (j = 0; j < 10; j = j + 1) {
                                            local_4c._2_2_ = *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                                            *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) = local_4c._2_2_;
                                            *(undefined2 *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x8b) = 0;
                                        }
                                    }
                                    sVar15 = idPlayer;
                                    if (idPlayer == -1) {
                                        idPlayer = i;
                                    } else if (i != idPlayer) {
                                        idPlayer = -1;
                                    }
                                    for (j = 0; j < (int)(*(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) >> 0xc); j = j + 1) {
                                        sVar14 = sVar15;
                                        if (hdrCur.wFlags >> 10 != 0x1a)
                                            goto IO_Corrupt_2;
                                        sVar17 = FReadShDef(
                                            rgbCur, (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + rglpshdefSB_0x2), (SHDEF *)*(undefined2 *)(i * 4 + rglpshdefSB)),
                                            sVar15);
                                        sVar14 = idPlayer;
                                        if (sVar17 == 0)
                                            goto IO_Corrupt_2;
                                        ReadRt();
                                    }
                                }
                                idPlayer = sVar15;
                            }
                            pSVar31 = vlprgScoreX;
                            for (i = 0; vlprgScoreX = pSVar31, i < game.cPlayer; i = i + 1) {
                                local_4c._2_2_ = *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xfff;
                                *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) = local_4c._2_2_;
                                if ((*(int *)(i * 4 + rglpshdefSB) != 0) || (pSVar31 = vlprgScoreX, *(int *)(i * 4 + rglpshdefSB_0x2) != 0)) {
                                    for (j = 0; pSVar31 = vlprgScoreX, j < 10; j = j + 1) {
                                        if ((*(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
                                            if (((i == idPlayer) || (((uint)gd.grBits >> 1 & 1) != 0)) ||
                                                ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0)) {
                                                local_4c._2_2_ = *(int *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) + 0x1000U & 0xf000;
                                                puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
                                                *puVar2 = *puVar2 & 0xfff;
                                                puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
                                                *puVar2 = *puVar2 | local_4c._2_2_;
                                            } else {
                                                local_4c._2_2_ = *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                                                *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) = local_4c._2_2_;
                                            }
                                        }
                                    }
                                }
                            }
                            if (pSVar31 == (SCOREX *)0x0) {
                                pSVar31 = LpAlloc(game.cPlayer * 0x18, htMisc);
                                vlprgScoreX = pSVar31;
                                __fmemset(pSVar31, 0, game.cPlayer * 0x18);
                                pSVar31 = vlprgScoreX;
                            }
                            while (true) {
                                vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar31 >> 0x10);
                                uVar28 = vlprgScoreX._2_2_;
                                vlprgScoreX._0_2_ = (SCOREX *)pSVar31;
                                vlprgScoreX = pSVar31;
                                if (hdrCur.wFlags >> 10 != 0x2d)
                                    break;
                                local_4c._2_2_ = rgbCur._0_2_ & 0x1f;
                                pSVar26 = (SCOREX *)vlprgScoreX + local_4c._2_2_;
                                puVar25 = (ushort *)rgbCur;
                                for (iVar19 = 0xc; iVar19 != 0; iVar19 = iVar19 + -1) {
                                    pSVar31 = pSVar26;
                                    pSVar26 = &pSVar26->u_SCOREX_0x0002;
                                    puVar4 = puVar25;
                                    puVar25 = puVar25 + 1;
                                    pSVar31->wWord = *puVar4;
                                }
                                pSVar31 = vlprgScoreX;
                                if ((*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) == 0) && (*(int *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2) == 0)) {
                                    pvVar33 = LpAlloc(0x978, htMisc);
                                    *(void **)((SCOREX **)rgsxPlr + local_4c._2_2_) = (void *)pvVar33;
                                    *(undefined2 *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2) = (int)((ulong)pvVar33 >> 0x10);
                                    ((short *)rgcsxPlr)[local_4c._2_2_] = 0;
                                    pSVar31 = vlprgScoreX;
                                }
                                vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar31 >> 0x10);
                                vlprgScoreX._0_2_ = (SCOREX *)pSVar31;
                                if ((*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) != 0) || (*(int *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2) != 0)) {
                                    if ((int)((SCOREX *)vlprgScoreX + local_4c._2_2_)->wWord < 0) {
                                        local_4e = (&((SCOREX *)vlprgScoreX)[local_4c._2_2_].u_SCOREX_0x0002)->turn;
                                    } else {
                                        local_4e = game.turn;
                                    }
                                    local_4c._0_2_ = (PLANET *)0x0;
                                    while (((int)(PLANET *)local_4c < ((short *)rgcsxPlr)[local_4c._2_2_] &&
                                            (*(uint *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + (int)(PLANET *)local_4c * 0x18 + 2) < local_4e))) {
                                        local_4c._0_2_ = (PLANET *)((int)&((PLANET *)local_4c)->id + 1);
                                    }
                                    vlprgScoreX = pSVar31;
                                    if ((((int)(PLANET *)local_4c < ((short *)rgcsxPlr)[local_4c._2_2_]) &&
                                         (local_4e != *(uint *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + (int)(PLANET *)local_4c * 0x18 + 2))) ||
                                        (100 < (int)(PLANET *)local_4c)) {
                                        if (((short *)rgcsxPlr)[local_4c._2_2_] < 0x65) {
                                            __fmemmove(
                                                (void *)CONCAT22(
                                                    *(undefined2 *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2),
                                                    (void *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + ((int)&((PLANET *)local_4c)->id + 1) * 0x18)),
                                                (void *)CONCAT22(*(undefined2 *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2),
                                                                 (void *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + (int)(PLANET *)local_4c * 0x18)),
                                                (((short *)rgcsxPlr)[local_4c._2_2_] - (int)(PLANET *)local_4c) * 0x18);
                                            ((short *)rgcsxPlr)[local_4c._2_2_] = ((short *)rgcsxPlr)[local_4c._2_2_] + 1;
                                            pSVar31 = vlprgScoreX;
                                        } else if (0 < (int)(PLANET *)local_4c) {
                                            if (1 < (int)(PLANET *)local_4c) {
                                                /* WARNING: Load size is inaccurate */
                                                __fmemmove((void *)CONCAT22(*(undefined2 *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2),
                                                                            ((SCOREX **)rgsxPlr)[local_4c._2_2_]),
                                                           (void *)CONCAT22(*(undefined2 *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2),
                                                                            (void *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + 0x18)),
                                                           ((int)&((PLANET *)local_4c)[-1].lpplprod + 3) * 0x18);
                                                pSVar31 = vlprgScoreX;
                                            }
                                            local_4c._0_2_ = (PLANET *)((int)&((PLANET *)local_4c)[-1].lpplprod + 3);
                                        }
                                    } else if ((PLANET *)local_4c == (PLANET *)((short *)rgcsxPlr)[local_4c._2_2_]) {
                                        ((short *)rgcsxPlr)[local_4c._2_2_] = ((short *)rgcsxPlr)[local_4c._2_2_] + 1;
                                        pSVar31 = vlprgScoreX;
                                    }
                                    vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar31 >> 0x10);
                                    uVar20 = vlprgScoreX._2_2_;
                                    vlprgScoreX._0_2_ = (SCOREX *)pSVar31;
                                    pSVar26 = (SCOREX *)vlprgScoreX + local_4c._2_2_;
                                    uVar28 = *(undefined2 *)((int)(SCOREX **)rgsxPlr + local_4c._2_2_ * 4 + 2);
                                    puVar25 = (ushort *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + (int)(PLANET *)local_4c * 0x18);
                                    vlprgScoreX = pSVar31;
                                    for (iVar19 = 0xc; iVar19 != 0; iVar19 = iVar19 + -1) {
                                        puVar4 = puVar25;
                                        puVar25 = puVar25 + 1;
                                        pSVar31 = pSVar26;
                                        pSVar26 = &pSVar26->u_SCOREX_0x0002;
                                        *puVar4 = pSVar31->wWord;
                                    }
                                    *(uint *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + (int)(PLANET *)local_4c * 0x18 + 2) = local_4e;
                                    local_50 = *(uint *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + (int)(PLANET *)local_4c * 0x18) & 0x7fff | 0x8000;
                                    *(uint *)(*(int *)((SCOREX **)rgsxPlr + local_4c._2_2_) + (int)(PLANET *)local_4c * 0x18) = local_50;
                                    pSVar31 = vlprgScoreX;
                                }
                                vlprgScoreX = pSVar31;
                                ReadRt();
                                pSVar31 = vlprgScoreX;
                            }
                            if (lpThings != (THING *)0x0) {
                                FreeLp(lpThings, htThings);
                                /* WARNING: Ignoring partial resolution of indirect */
                                lpThings._0_2_ = (THING *)0x0;
                                /* WARNING: Ignoring partial resolution of indirect */
                                lpThings._2_2_ = 0;
                                cThing = 0;
                                pSVar31 = vlprgScoreX;
                            }
                            vlprgScoreX = pSVar31;
                            if (hdrCur.wFlags >> 10 == 0x2b) {
                                local_4c._0_2_ = (PLANET *)(uint)(0 < cThing);
                                local_4c._2_1_ = rgbCur[0];
                                local_4c._3_1_ = rgbCur[1];
                                cThingAlloc = rgbCur._0_2_;
                                if ((int)rgbCur._0_2_ < 10) {
                                    cThingAlloc = 10;
                                }
                                if (lpThings == (THING *)0x0) {
                                    pTVar32 = LpAlloc(cThingAlloc * 0x12, htThings);
                                    /* WARNING: Ignoring partial resolution of indirect */
                                    lpThings._0_2_ = (THING *)pTVar32;
                                    /* WARNING: Ignoring partial resolution of indirect */
                                    lpThings._2_2_ = (int)((ulong)pTVar32 >> 0x10);
                                    if (lpThings == (THING *)0x0)
                                        break;
                                    __fmemset(lpThings, 0, cThingAlloc * 0x12);
                                    pSVar31 = vlprgScoreX;
                                }
                                vlprgScoreX = pSVar31;
                                ReadRt();
                                lpth = lpThings;
                                j = 0;
                                for (i = 0; i < (int)local_4c._2_2_; i = i + 1) {
                                    if ((PLANET *)local_4c == (PLANET *)0x0) {
                                    LAB_1070_270b:
                                        cThing = cThing + 1;
                                    } else {
                                        while ((j < cThing && (lpth->idFull < (uint)rgbCur._0_2_))) {
                                            j = j + 1;
                                            lpth = (THING *)lpth + 1;
                                        }
                                        if ((cThing <= j) || (rgbCur._0_2_ != lpth->idFull)) {
                                            if (cThingAlloc == cThing) {
                                                cThingAlloc = cThingAlloc + 8;
                                                pTVar32 = LpReAlloc(lpThings, cThingAlloc * 0x12, htThings);
                                                /* WARNING: Ignoring partial resolution of indirect */
                                                lpThings._0_2_ = (THING *)pTVar32;
                                                /* WARNING: Ignoring partial resolution of indirect */
                                                lpThings._2_2_ = (int)((ulong)pTVar32 >> 0x10);
                                                lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings + j);
                                            }
                                            if (j < cThing) {
                                                __fmemmove((THING *)lpth + 1, lpth, (cThing - j) * 0x12);
                                                __fmemset(lpth, 0, 0x12);
                                            }
                                            goto LAB_1070_270b;
                                        }
                                    }
                                    __fmemcpy(lpth, rgbCur, hdrCur.wFlags & 0x3ff);
                                    ((THING *)lpth)->turn = game.turn;
                                    lpth = (THING *)lpth + 1;
                                    j = j + 1;
                                    ReadRt();
                                }
                            } else {
                                cThing = 0;
                                cThingAlloc = 10;
                                pTVar32 = LpAlloc(0xb4, htThings);
                                /* WARNING: Ignoring partial resolution of indirect */
                                lpThings._0_2_ = (THING *)pTVar32;
                                /* WARNING: Ignoring partial resolution of indirect */
                                lpThings._2_2_ = (int)((ulong)pTVar32 >> 0x10);
                            }
                            if (hdrCur.wFlags >> 10 == 0x16) {
                                ReadRt();
                            }
                            while (sVar14 = idPlayer, hdrCur.wFlags >> 10 == 0x1e) {
                                idPlayer = rgbCur._0_2_ & 0xf;
                                local_4c._2_2_ = idPlayer;
                                if ((*(int *)((BTLPLAN **)rglpbtlplan + idPlayer) == 0) && (*(int *)((int)(BTLPLAN **)rglpbtlplan + idPlayer * 4 + 2) == 0)) {
                                    pvVar33 = LpAlloc(0x240, htShips);
                                    *(void **)((BTLPLAN **)rglpbtlplan + local_4c._2_2_) = (void *)pvVar33;
                                    *(undefined2 *)((int)(BTLPLAN **)rglpbtlplan + local_4c._2_2_ * 4 + 2) = (int)((ulong)pvVar33 >> 0x10);
                                }
                                UnpackBattlePlan(rgbCur,
                                                 (BTLPLAN *)CONCAT22(*(undefined2 *)((int)(BTLPLAN **)rglpbtlplan + local_4c._2_2_ * 4 + 2),
                                                                     (BTLPLAN *)(*(int *)((BTLPLAN **)rglpbtlplan + local_4c._2_2_) +
                                                                                 (uint)((byte *)rgcbtlplan)[local_4c._2_2_] * 0x24)),
                                                 (uint)((byte *)rgcbtlplan)[local_4c._2_2_]);
                                ((byte *)rgcbtlplan)[local_4c._2_2_] = ((byte *)rgcbtlplan)[local_4c._2_2_] + 1;
                                ReadRt();
                                idPlayer = sVar14;
                            }
                            if (hdrCur.wFlags >> 10 != 0) {
                            IO_Corrupt_2:
                                idPlayer = sVar14;
                                sVar14 = 0x10;
                                pcVar21 = PszFormatIds(idsGameFileAppearsCorruptUnableLoadFile, (short *)0x0);
                                AlertSz(pcVar21, sVar14);
                                break;
                            }
                            local_4c = (PLANET *)__filelength(hf);
                            pPVar29 = (PLANET *)__tell(hf);
                            if (pPVar29 == local_4c)
                                goto LAB_1070_2a56;
                            ReadRt();
                            if (hdrCur.wFlags >> 10 != 8)
                                goto LAB_1070_2a35;
                            game.turn._0_1_ = rgbCur[10];
                            game.turn._1_1_ = rgbCur[0xb];
                            game.wCrap = game.wCrap & 0xf1ff | ((uint)rgbCur._14_2_ >> 0xd) << 9;
                            i = 0;
                            lppl = lpPlanets;
                            while (true) {
                                lpPlanets._2_2_ = (uint)((ulong)lppl >> 0x10);
                                lpPlanets._0_2_ = (PLANET *)lppl;
                                lpPlanets = lppl;
                                if (game.cPlayer <= i)
                                    break;
                                *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
                                *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) = *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xf000;
                                *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
                                *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) = *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xfff;
                                ((byte *)rgcbtlplan)[i] = 0;
                                i = i + 1;
                                lppl = lpPlanets;
                            }
                            local_4c._0_2_ = (PLANET *)lpPlanets;
                            local_4c._2_2_ = lpPlanets._2_2_;
                            lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
                            lpplMac._2_2_ = local_4c._2_2_;
                            while (true) {
                                if ((PLANET *)lpplMac <= (PLANET *)lppl)
                                    break;
                                uVar28 = (undefined2)((ulong)lppl >> 0x10);
                                if (((PLANET *)lppl)->iPlayer == iPlayer) {
                                    ((PLANET *)lppl)->iPlayer = -1;
                                    ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xff00 | 3;
                                    if ((*(int *)&((PLANET *)lppl)->lpplprod != 0) || (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) {
                                        FreePl((PL *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2), *(PL **)&((PLANET *)lppl)->lpplprod));
                                        *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
                                        *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
                                    }
                                }
                                lppl = (PLANET *)CONCAT22(uVar28, (PLANET *)lppl + 1);
                            }
                            cPlanetHist = cPlanet;
                        } while (true);
                    }
                    goto IO_LError_2;
                }
            }
        IO_XYCorrupt:
            sVar14 = 0x10;
            pcVar21 = PszFormatIds(idsUniverseDefinitionFileSeemsMissingCorrupt, (short *)0x0);
            AlertSz(pcVar21, sVar14);
        }
    }
IO_LError_2:
    game.fDirty = 0;
    DestroyCurGame();
    StreamClose();
    if ((((ini.wFlags >> 0xe & 1) == 0) && (-1 < (int)ini.wFlags)) && (hwndTitle == 0)) {
        sVar14 = GetSystemMetrics(0);
        local_4c._0_2_ = (PLANET *)sVar14;
        local_4c._2_2_ = GetSystemMetrics(1);
        hwndTitle = CreateWindow(szTitle, s_Stars_1120_0752, 0x90000000, 0, 0, (short)(PLANET *)local_4c, local_4c._2_2_, hwndFrame, 0, hInst, (void *)0x0);
        fFreeingTitle = 0;
        ShowWindow(hwndFrame, 0);
    }
    sVar14 = 0;
    pbVar10 = vlpbAiData;
    pTVar32 = lpThings;
    pPVar29 = lpPlanets;
    ppFVar11 = rglpfl;
    pSVar31 = vlprgScoreX;
    pbVar12 = lpbBattleLog;
LAB_1070_3200:
    lpbBattleLog._2_2_ = (undefined2)((ulong)pbVar12 >> 0x10);
    lpbBattleLog._0_2_ = (byte *)pbVar12;
    vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar31 >> 0x10);
    vlprgScoreX._0_2_ = (SCOREX *)pSVar31;
    rglpfl._2_2_ = (undefined2)((ulong)ppFVar11 >> 0x10);
    rglpfl._0_2_ = (FLEET **)ppFVar11;
    lpPlanets._2_2_ = (uint)((ulong)pPVar29 >> 0x10);
    lpPlanets._0_2_ = (PLANET *)pPVar29;
    lpThings._2_2_ = (uint)((ulong)pTVar32 >> 0x10);
    lpThings._0_2_ = (THING *)pTVar32;
    vlpbAiData._2_2_ = (int)((ulong)pbVar10 >> 0x10);
    vlpbAiData._0_2_ = (byte *)pbVar10;
    return sVar14;
LAB_1070_2a35:
    sVar14 = 0x10;
    pcVar21 = PszFormatIds(idsWarningIgnoringUnexpectedDataAfterEof, (short *)0x0);
    AlertSz(pcVar21, sVar14);
LAB_1070_2a56:
    StreamClose();
    if ((((1 < cturn) && ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0)) && ((ini.wFlags >> 0xc & 1) == 0)) &&
        (((ini.wFlags >> 0xb & 1) == 0 && ((ini.wFlags >> 0xd & 1) == 0)))) {
        sVar14 = cturn;
        pcVar21 = PszGetCompressedString(idsNoteDYearsDataRead);
        _wsprintf(szWork, pcVar21, sVar14);
        AlertSz((char *)szWork, 0x40);
    }
    sVar14 = __strnicmp(pszExt, (char *)0x759, 3);
    ppFVar11 = rglpfl;
    if (sVar14 != 0) {
        lppl = lpPlanets;
        if ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0) {
            local_58 = (THING *)lpThings;
            local_56 = lpThings._2_2_;
            lpth = lpThings;
            lpthMac._0_2_ = (THING *)lpThings + cThing;
            lpthMac._2_2_ = local_56;
            while (true) {
                lpPlanets._2_2_ = (uint)((ulong)lppl >> 0x10);
                lpPlanets._0_2_ = (PLANET *)lppl;
                lpPlanets = lppl;
                if ((THING *)lpthMac <= (THING *)lpth)
                    break;
                uVar28 = (undefined2)((ulong)lpth >> 0x10);
                if ((lpth->idFull >> 0xd == 1) && ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) != 0)) {
                    pPVar29 = LpplFromId(((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0x3ff);
                    iVar19 = (int)((ulong)pPVar29 >> 0x10);
                    lppl = lpPlanets;
                    if ((((PLANET *)pPVar29 != (PLANET *)0x0) || (iVar19 != 0)) && (((PLANET *)pPVar29)->iPlayer == iPlayer)) {
                        local_56 = IWarpMAFromLppl(pPVar29, &local_58);
                        lppl = lpPlanets;
                        if ((int)(local_58->rgpctMinLevel + (local_56 - 6)) < (int)((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) + 4)) {
                            FSendPlrMsg2XGen(0, idmMassPacketAppearsCollisionCourseWhichCurrently, -6, lpth->idFull, pPVar29->id);
                            lppl = lpPlanets;
                        }
                    }
                }
                lpth = (THING *)CONCAT22(uVar28, (THING *)lpth + 1);
            }
            lppl = lppl;
            if ((game.wCrap >> 3 & 1) == 0) {
                local_58 = (PLANET *)lpPlanets;
                local_56 = lpPlanets._2_2_;
                lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
                lpplMac._2_2_ = local_56;
                while ((PLANET *)lppl < (PLANET *)lpplMac) {
                    uVar28 = (undefined2)((ulong)lppl >> 0x10);
                    if ((((((PLANET *)lppl)->iPlayer == iPlayer) && ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0)) &&
                         ((*(int *)&((PLANET *)lppl)->lpplprod != 0 || (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)))) &&
                        (iVar19 = ((PLANET *)lppl)->iPlayer * 4,
                         *(int *)(*(int *)(iVar19 + rglpshdefSB) + (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93) != 0x20)) {
                        local_4c._2_2_ = 0;
                        local_4c._0_2_ = (PLANET *)0x0;
                        local_54 = *(int *)&((PLANET *)lppl)->lpplprod;
                        uStack_52 = *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2);
                        for (; local_54 = local_54 + 4, (int)(PLANET *)local_4c < (int)(uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac;
                             local_4c._0_2_ = (PLANET *)((int)&((PLANET *)local_4c)->id + 1)) {
                            EstimateItemProdSched(lppl, (PLPROD *)0x0, (short)(PLANET *)local_4c, &local_4e, &local_50);
                            if (1 < (int)local_50) {
                                local_4c._2_2_ = 0;
                                break;
                            }
                            if (local_50 == 1) {
                                uVar34 = __aFulshr(uVar35, szEntry._0_2_);
                                if (((uint)uVar34 & 7) == 1) {
                                    uVar34 = __aFulshr(uVar35, szEntry._0_2_);
                                    if (((uint)uVar34 & 0x7f) < 7)
                                        goto LAB_1070_2cf9;
                                }
                                local_4c._2_2_ = 1;
                            }
                        LAB_1070_2cf9:
                        }
                        if (local_4c._2_2_ != 0) {
                            FSendPlrMsg2XGen(0, idmStarbaseScheduledCompleteRemainingProductionItem, lppl->id, lppl->id, 0);
                        }
                    }
                    lppl = (PLANET *)CONCAT22(uVar28, (PLANET *)lppl + 1);
                }
                sVar14 = CBattles();
                lppl = lpPlanets;
                if (0 < sVar14) {
                    FSendPlrMsg2XGen(1, (1 < sVar14) + idmHaveReceivedOneBattleRecordingYear, -7, sVar14, 0);
                    lppl = lpPlanets;
                }
            }
        }
        if ((gd.grBits._2_2_ >> 1 & 1) == 0) {
            lpPlanets = lppl;
            _wsprintf(szWork, s_s_x_s_1120_075d, pszFileName, 0x1120, pszExt + 1, 0x1120);
            sVar14 = FLoadLogFile((char *)szWork);
            if (sVar14 != 0) {
                sVar14 = FRunLogFile();
                lppl = lpPlanets;
                if (sVar14 != 0)
                    goto LAB_1070_2eb1;
            }
            sVar14 = 0x10;
            pcVar21 = PszFormatIds(idsPlayerLogFileAppearsCorruptUnableLoad, (short *)0x0);
            AlertSz(pcVar21, sVar14);
            goto IO_LError_2;
        }
    LAB_1070_2eb1:
        i = 0;
        while (true) {
            lpPlanets._2_2_ = (uint)((ulong)lppl >> 0x10);
            lpPlanets._0_2_ = (PLANET *)lppl;
            pPVar13 = (PLANET *)lpPlanets;
            lpPlanets = lppl;
            if (game.cPlayer <= i)
                break;
            *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) = *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xf000;
            *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
            i = i + 1;
            lppl = lpPlanets;
        }
        lpplMac._2_2_ = lpPlanets._2_2_;
        lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
        while ((PLANET *)lppl < (PLANET *)lpplMac) {
            uVar28 = (undefined2)((ulong)lppl >> 0x10);
            if (((PLANET *)lppl)->iPlayer == -1) {
                ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfdff;
            } else {
                piVar1 = (int *)((int)&rgplr[0].cPlanet + ((PLANET *)lppl)->iPlayer * 0xc0);
                *piVar1 = *piVar1 + 1;
            }
            lppl = (PLANET *)CONCAT22(uVar28, (PLANET *)lppl + 1);
        }
        j = 0;
        i = 0;
        local_4c._2_2_ = lpplMac._2_2_;
        ppFVar11 = rglpfl;
        while (true) {
            rglpfl._2_2_ = (undefined2)((ulong)ppFVar11 >> 0x10);
            rglpfl._0_2_ = (FLEET **)ppFVar11;
            local_4c = (PLANET *)CONCAT22(local_4c._2_2_, pPVar13);
            if (cFleet <= i)
                break;
            iVar19 = *(int *)((FLEET **)rglpfl + i);
            iVar8 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
            if ((iVar19 == 0) && (local_4c = (PLANET *)CONCAT22(local_4c._2_2_, pPVar13), iVar8 == 0))
                break;
            j = *(int *)(iVar19 + 2);
            local_4c._2_2_ = *(int *)((int)&rgplr[0].wFlags_0x4 + j * 0xc0) + 1U & 0xfff;
            puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + j * 0xc0);
            rglpfl = ppFVar11;
            *puVar2 = *puVar2 & 0xf000;
            puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + j * 0xc0);
            *puVar2 = *puVar2 | local_4c._2_2_;
            i = i + 1;
            ppFVar11 = rglpfl;
        }
    }
    idPlayer = iPlayer;
    pbVar10 = vlpbAiData;
    pTVar32 = lpThings;
    pPVar29 = lpPlanets;
    pSVar31 = vlprgScoreX;
    pbVar12 = lpbBattleLog;
    if (((iPlayer != -1) && ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0)) &&
        (((char *)vrgszMRU != (char *)0x0 || (vrgszMRU._2_2_ != 0)))) {
        rglpfl = ppFVar11;
        _strcpy(local_148, pszFileName);
        _strcat(local_148, (char *)0x764);
        _strcat(local_148, pszExt);
        sVar14 = __fstricmp(local_148, (char *)CONCAT22(vrgszMRU._2_2_, (char *)vrgszMRU));
        pbVar10 = vlpbAiData;
        pTVar32 = lpThings;
        pPVar29 = lpPlanets;
        pSVar31 = vlprgScoreX;
        ppFVar11 = rglpfl;
        pbVar12 = lpbBattleLog;
        if (sVar14 != 0) {
            for (i = 1; i < 8; i = i + 1) {
                sVar14 = __fstricmp(local_148, (char *)CONCAT22(vrgszMRU._2_2_, (char *)vrgszMRU + i * 0x100));
                if (sVar14 == 0)
                    break;
            }
            for (; 0 < i; i = i + -1) {
                __fstrcpy((char *)CONCAT22(vrgszMRU._2_2_, (char *)vrgszMRU + i * 0x100),
                          (char *)CONCAT22(vrgszMRU._2_2_, (char *)vrgszMRU + (i + -1) * 0x100));
            }
            __fstrcpy((char *)CONCAT22(vrgszMRU._2_2_, (char *)vrgszMRU), local_148);
            CchGetString(idsStarsIni, szIniFile);
            CchGetString(idsFiles, szSection);
            CchGetString(idsFile1, szEntry);
            uVar18 = _strlen(szEntry);
            for (i = 0; pbVar10 = vlpbAiData, pTVar32 = lpThings, pPVar29 = lpPlanets, pSVar31 = vlprgScoreX, ppFVar11 = rglpfl, pbVar12 = lpbBattleLog, i < 9;
                 i = i + 1) {
                szSection[uVar18 - 0x13] = (char)i + '1';
                __fstrcpy(local_148, (char *)CONCAT22(vrgszMRU._2_2_, (char *)vrgszMRU + i * 0x100));
                WritePrivateProfileString(szSection, szEntry, local_148, szIniFile);
            }
        }
    }
    sVar14 = 1;
    goto LAB_1070_3200;
}

// ======================================================================
// Function: FReadPlanet
// Address: 1070:3206
// Segment: MEMORY_IO
// ======================================================================

short FReadPlanet(short iPlayer, PLANET *lppl, short fHistory, short fPreInited)

{
    uint       uVar1;
    undefined2 uVar2;
    bool       bVar3;
    byte       bVar4;
    uint       uVar5;
    short      sVar6;
    short      sVar7;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    long       lVar8;
    ushort     in_stack_0000ffea;
    short      pct;
    short      pctOpt;
    short      idm;
    byte      *pb;
    short      i;
    byte       bMask;
    short      fRouting;
    short      fFirstYear;

    lVar8 = CONCAT22(unaff_SI, unaff_DI);
    bVar3 = false;
    if (fPreInited == 0) {
        __fmemset(lppl, 0, 0x38);
    }
    if ((fHistory == 0) && (iPlayer != -1)) {
        if (fPreInited == 0) {
            bVar3 = true;
            ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xf7ff | 0x800;
        } else if ((((PLANET *)lppl)->wFlags_0x4 >> 0xb & 1) != 0) {
            if (((PLANET *)lppl)->turn == game.turn) {
                bVar3 = true;
            } else {
                ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xf7ff;
            }
        }
    } else {
        ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xf7ff | ((uint)rgbCur._2_2_ >> 0xf) << 0xb;
    }
    lppl->id = (int)(rgbCur._0_2_ << 5) >> 5;
    ((PLANET *)lppl)->iPlayer = (int)rgbCur._0_2_ >> 0xb;
    if ((((PLANET *)lppl)->wFlags_0x4 & 0xff) < (rgbCur._2_2_ & 0x7f)) {
        ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xff00 | rgbCur._2_2_ & 0x7f;
    }
    ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfeff | ((uint)rgbCur._2_2_ >> 8 & 1) << 8;
    ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfdff | ((uint)rgbCur._2_2_ >> 9 & 1) << 9;
    ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfbff | ((uint)rgbCur._2_2_ >> 7 & 1) << 10;
    uVar5 = (uint)rgbCur._2_2_ >> 0xe;
    if (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) && (((PLANET *)lppl)->iPlayer == -1)) {
        ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfdff;
    }
    if (fHistory == 0) {
        ((PLANET *)lppl)->turn = game.turn;
    }
    pb = (char *)rgbCur + 4;
    if (2 < (rgbCur._2_2_ & 0x7f)) {
        bMask = rgbCur[4];
        pb = (char *)rgbCur + 5;
        for (i = 0; i < 3; i = i + 1) {
            if ((bMask & 3) == 0) {
                ((PLANET *)lppl)->rgpctMinLevel[i] = 0;
            } else {
                if ((bMask & 3) != 1) {
                    return 0;
                }
                ((PLANET *)lppl)->rgpctMinLevel[i] = *pb;
                pb = pb + 1;
            }
            bMask = (byte)((int)(uint)bMask >> 2);
        }
        for (i = 0; i < 3; i = i + 1) {
            ((PLANET *)lppl)->rgMinConc[i] = *pb;
            pb = pb + 1;
        }
        for (i = 0; i < 3; i = i + 1) {
            if (100 < *pb) {
                return 0;
            }
            bVar4 = *pb;
            ((PLANET *)lppl)->rgEnvVarOrig[i] = bVar4;
            ((PLANET *)lppl)->rgEnvVar[i] = bVar4;
            pb = pb + 1;
        }
        if (((uint)rgbCur._2_2_ >> 10 & 1) != 0) {
            for (i = 0; i < 3; i = i + 1) {
                if (100 < *pb) {
                    return 0;
                }
                ((PLANET *)lppl)->rgEnvVarOrig[i] = *pb;
                pb = pb + 1;
            }
        }
        if ((int)rgbCur._0_2_ >> 0xb != -1) {
            ((PLANET *)lppl)->uGuesses = *(ushort *)pb;
            pb = pb + 2;
        }
        if (3 < (((PLANET *)lppl)->wFlags_0x4 & 0xff)) {
            if (((uint)rgbCur._2_2_ >> 0xd & 1) != 0) {
                bMask = *pb;
                pb = pb + 1;
                for (i = 0; i < 4; i = i + 1) {
                    bVar4 = bMask & 3;
                    if ((bMask & 3) == 0) {
                        *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = 0;
                        *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
                    } else if (bVar4 == 1) {
                        *(uint *)(((PLANET *)lppl)->rgwtMin + i) = (uint)*pb;
                        *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
                        pb = pb + 1;
                    } else if (bVar4 == 2) {
                        *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = *(undefined2 *)pb;
                        *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
                        pb = pb + 2;
                    } else if (bVar4 == 3) {
                        uVar2 = *(undefined2 *)(pb + 2);
                        *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = *(undefined2 *)pb;
                        *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = uVar2;
                        pb = pb + 4;
                    }
                    bMask = (byte)((int)(uint)bMask >> 2);
                }
            }
            if (hdrCur.wFlags >> 10 != 0xe) {
                if (((uint)rgbCur._2_2_ >> 0xb & 1) == 0) {
                    lVar8 = __aFlshl(lVar8, in_stack_0000ffea);
                    uVar1 = *(uint *)(((PLANET *)lppl)->rgbImp + 6);
                    *(uint *)(((PLANET *)lppl)->rgbImp + 4) = *(uint *)(((PLANET *)lppl)->rgbImp + 4) | (uint)lVar8;
                    *(uint *)(((PLANET *)lppl)->rgbImp + 6) = uVar1 & 0xffbf | (uint)((ulong)lVar8 >> 0x10);
                    uVar1 = *(uint *)(((PLANET *)lppl)->rgbImp + 6);
                    *(uint *)(((PLANET *)lppl)->rgbImp + 4) = *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff | 0xf000;
                    *(uint *)(((PLANET *)lppl)->rgbImp + 6) = uVar1 & 0xfffe | 1;
                    uVar2 = *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6);
                    *(uint *)(((PLANET *)lppl)->rgbImp + 4) = *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xf000;
                    *(undefined2 *)(((PLANET *)lppl)->rgbImp + 6) = uVar2;
                } else {
                    __fmemmove((byte *)CONCAT22(lppl._2_2_, ((PLANET *)lppl)->rgbImp), pb, 8);
                    pb = pb + 8;
                }
                if (((PLANET *)lppl)->iPlayer != -1) {
                    if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) {
                        uVar2 = *(undefined2 *)(pb + 2);
                        *(undefined2 *)&((PLANET *)lppl)->lStarbase = *(undefined2 *)pb;
                        *(undefined2 *)((int)&((PLANET *)lppl)->lStarbase + 2) = uVar2;
                        *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) = *(uint *)((int)&((PLANET *)lppl)->lStarbase + 2) & 0xbfff;
                        pb = pb + 4;
                    }
                    if ((uVar5 & 1) != 0) {
                        ((PLANET *)lppl)->wRouting = *(ushort *)pb;
                    }
                }
                return 1;
            }
        }
    }
    if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) {
        *(uint *)&((PLANET *)lppl)->lStarbase = *(uint *)&((PLANET *)lppl)->lStarbase & 0xfff0 | *pb & 0xf;
        pb = pb + 1;
    }
    if (fHistory == 0) {
        if (bVar3) {
            if (((PLANET *)lppl)->iPlayer == -1) {
                if ((((PLANET *)lppl)->wFlags_0x4 & 0xff) < 2) {
                    FSendPlrMsg2XGen(0, idmHaveFoundNewPlanetDontKnowIf, lppl->id, lppl->id, 0);
                } else {
                    sVar6 = GetRaceStat((PLAYER *)rgplr + iPlayer, rsMajorAdv);
                    if (sVar6 == raTerra) {
                        sVar6 = PctPlanetOptValue(lppl, iPlayer);
                        FSendPlrMsg2XGen(0, idmHaveInfoNewPlanetIfColonizeCan, lppl->id, lppl->id, sVar6);
                    } else {
                        sVar6 = PctPlanetDesirability(lppl, iPlayer);
                        if (sVar6 < 1) {
                            sVar7 = PctPlanetOptValue(lppl, iPlayer);
                            if (sVar7 < 1) {
                                pct = sVar6 * 10;
                                idm = 0xab;
                            } else {
                                sVar6 = PctTrueMaxGrowth(iPlayer);
                                pct = sVar6 * sVar7;
                                idm = 0xae;
                            }
                        } else {
                            sVar7 = PctTrueMaxGrowth(iPlayer);
                            pct = sVar7 * sVar6;
                            idm = 0xac;
                        }
                        sVar6 = lppl->id;
                        sVar7 = _abs(pct);
                        FSendPlrMsg2XGen(0, idm, lppl->id, sVar7, sVar6);
                    }
                }
            } else {
                FSendPlrMsg2XGen(0, idmHaveFoundPlanetOccupiedSomeoneElseCurrently, lppl->id, lppl->id, ((PLANET *)lppl)->iPlayer | 0x30);
            }
        }
    } else {
        ((PLANET *)lppl)->turn = *(short *)pb;
    }
    return 1;
}

// ======================================================================
// Function: FReadFleet
// Address: 1070:3a4c
// Segment: MEMORY_IO
// ======================================================================

short FReadFleet(FLEET *lpfl)

{
    byte      *pbVar1;
    ushort    *puVar2;
    short     *psVar3;
    ORDER     *pOVar4;
    uint       uVar5;
    char      *sz;
    ushort     uVar6;
    short      sVar7;
    int        iVar8;
    short     *psVar9;
    ORDER     *pOVar10;
    ORDER     *pOVar11;
    undefined2 uVar12;
    undefined2 unaff_SS;
    PL        *pPVar13;
    void      *pvVar14;
    HeapType   HVar15;
    short      cOut;
    char       szT[33];
    ushort    *pus;
    short      cch;
    byte      *pb;
    short      cish;
    short      i;
    ORDER     *lpord;
    short      fByte;
    short      cord;
    ushort     us;

    cish = 0;
    __fmemset(lpfl, 0, 0x7c);
    __fmemmove(lpfl, rgbCur, 0xc);
    us._0_1_ = rgbCur[0xc];
    us._1_1_ = rgbCur[0xd];
    pb = (char *)rgbCur + 0xe;
    if ((((FLEET *)lpfl)->wFlags_0x4 >> 0xb & 1) == 0) {
        pus = (char *)rgbCur + 0xe;
        i = 0;
        for (; us != 0; us = us >> 1) {
            if ((us & 1) != 0) {
                puVar2 = pus + 1;
                ((FLEET *)lpfl)->rgcsh[i] = *pus;
                pus = puVar2;
                if (((FLEET *)lpfl)->rgcsh[i] != 0) {
                    cish = cish + 1;
                }
            }
            i = i + 1;
        }
        pb = pus;
    } else {
        i = 0;
        for (; us != 0; us = us >> 1) {
            if ((us & 1) != 0) {
                pbVar1 = pb + 1;
                ((FLEET *)lpfl)->rgcsh[i] = (uint)*pb;
                pb = pbVar1;
                if (((FLEET *)lpfl)->rgcsh[i] != 0) {
                    cish = cish + 1;
                }
            }
            i = i + 1;
        }
    }
    if (cish == 0) {
        ((FLEET *)lpfl)->wFlags_0x4 = ((FLEET *)lpfl)->wFlags_0x4 & 0xfbff | 0x400;
    }
    if (3 < (((FLEET *)lpfl)->wFlags_0x4 & 0xff)) {
        us = *(ushort *)pb;
        pb = pb + 2;
        for (i = 0; i < 5; i = i + 1) {
            uVar5 = us & 3;
            if (uVar5 == 1) {
                *(uint *)(((FLEET *)lpfl)->rgwtMin + i) = (uint)*pb;
                *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = 0;
                pb = pb + 1;
            } else if (uVar5 == 2) {
                *(undefined2 *)(((FLEET *)lpfl)->rgwtMin + i) = *(undefined2 *)pb;
                *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = 0;
                pb = pb + 2;
            } else if (uVar5 == 3) {
                uVar12 = *(undefined2 *)(pb + 2);
                *(undefined2 *)(((FLEET *)lpfl)->rgwtMin + i) = *(undefined2 *)pb;
                *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = uVar12;
                pb = pb + 4;
            }
            us = us >> 2;
        }
    }
    if ((((FLEET *)lpfl)->wFlags_0x4 & 0xff) < 7) {
        uVar12 = *(undefined2 *)(pb + 2);
        *(undefined2 *)&((FLEET *)lpfl)->dirLong = *(undefined2 *)pb;
        *(undefined2 *)((int)&((FLEET *)lpfl)->dirLong + 2) = uVar12;
        uVar12 = *(undefined2 *)(pb + 6);
        *&((FLEET *)lpfl)->u_FLEET_0x002c = *(undefined2 *)(pb + 4);
        *(undefined2 *)((int)&((FLEET *)lpfl)->u_FLEET_0x002c + 2) = uVar12;
        ReadRt();
        return 1;
    }
    if (hdrCur.wFlags >> 10 == 0x10) {
        us = *(ushort *)pb;
        pus = pb + 2;
        i = 0;
        for (; us != 0; us = us >> 1) {
            if ((us & 1) != 0) {
                puVar2 = pus + 1;
                ((FLEET *)lpfl)->rgcsh[i + 0x10] = *pus;
                pus = puVar2;
                if (499 < (uint)((FLEET *)lpfl)->rgcsh[i + 0x10] >> 7) {
                    ((FLEET *)lpfl)->rgcsh[i + 0x10] = ((FLEET *)lpfl)->rgcsh[i + 0x10] & 0x7fU | 0xf980;
                }
            }
            i = i + 1;
        }
        ((FLEET *)lpfl)->iplan = (byte)*pus;
        ((FLEET *)lpfl)->cord = (uint) * (byte *)((int)pus + 1);
        pPVar13 = LpplAlloc(0x12, ((FLEET *)lpfl)->cord + 1, htOrd);
        *(PL **)&((FLEET *)lpfl)->lpplord = (PL *)pPVar13;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2) = (int)((ulong)pPVar13 >> 0x10);
        __fmemset((void *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2), (void *)(*(int *)&((FLEET *)lpfl)->lpplord + 4)), 0,
                  (((FLEET *)lpfl)->cord + 1) * 0x12);
        cord = ((FLEET *)lpfl)->cord;
        lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2), (ORDER *)(*(int *)&((FLEET *)lpfl)->lpplord + 4));
        for (; cord != 0; cord = cord + -1) {
            _memset((char *)rgbCur, 0, 0x12);
            ReadRt();
            if ((hdrCur.wFlags >> 10 != 0x13) && (hdrCur.wFlags >> 10 != 0x14))
                goto IO_Corrupt;
            psVar9 = (short *)rgbCur;
            uVar12 = (undefined2)((ulong)lpord >> 0x10);
            pOVar10 = (ORDER *)lpord;
            pOVar11 = pOVar10;
            for (iVar8 = 9; iVar8 != 0; iVar8 = iVar8 + -1) {
                pOVar4 = pOVar11;
                pOVar11 = &(pOVar11->pt).y;
                psVar3 = psVar9;
                psVar9 = psVar9 + 1;
                (pOVar4->pt).x = *psVar3;
            }
            pOVar10->wFlags_0x6 = pOVar10->wFlags_0x6 & 0xdfff;
            lpord = (ORDER *)CONCAT22(uVar12, pOVar10 + 1);
        }
        ((PLORD *)((FLEET *)lpfl)->lpplord)->iordMac = (byte)((FLEET *)lpfl)->cord;
        if (((FLEET *)lpfl)->idPlanet != -1) {
            if (game.cPlanMax < ((FLEET *)lpfl)->idPlanet) {
                ((FLEET *)lpfl)->idPlanet = -1;
            }
            if (((&((FLEET *)lpfl)->pt)->x != ((POINT *)rgptPlan + ((FLEET *)lpfl)->idPlanet)->x) ||
                ((((FLEET *)lpfl)->pt).y != *(int *)((int)&rgptPlan[0].y + ((FLEET *)lpfl)->idPlanet * 4))) {
                if ((i != 0) || (game.turn != 0))
                    goto IO_Corrupt;
                sVar7 = *(short *)((int)&rgptPlan[0].y + ((FLEET *)lpfl)->idPlanet * 4);
                (&((FLEET *)lpfl)->pt)->x = ((POINT *)rgptPlan + ((FLEET *)lpfl)->idPlanet)->x;
                (((FLEET *)lpfl)->pt).y = sVar7;
            }
        }
        ReadRt();
        if (hdrCur.wFlags >> 10 == 0x15) {
            if (rgbCur[0] == 0) {
                HVar15 = htString;
                uVar6 = _strlen((char *)rgbCur + 1);
                pvVar14 = LpAlloc(uVar6 + 1, HVar15);
                *(void **)&((FLEET *)lpfl)->lpszName = (void *)pvVar14;
                *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = (int)((ulong)pvVar14 >> 0x10);
                /* WARNING: Load size is inaccurate */
                __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2), ((FLEET *)lpfl)->lpszName), rgbCur + 1);
            } else {
                cOut = 0x20;
                FDecompressUserString(rgbCur + 1, (int)rgbCur[0], szT, &cOut);
                HVar15 = htString;
                uVar6 = _strlen(szT);
                pvVar14 = LpAlloc(uVar6 + 1, HVar15);
                *(void **)&((FLEET *)lpfl)->lpszName = (void *)pvVar14;
                *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = (int)((ulong)pvVar14 >> 0x10);
                /* WARNING: Load size is inaccurate */
                __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2), ((FLEET *)lpfl)->lpszName), szT);
            }
            ReadRt();
        } else {
            *(undefined2 *)&((FLEET *)lpfl)->lpszName = 0;
            *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = 0;
        }
        sVar7 = 1;
    } else {
    IO_Corrupt:
        sVar7 = 0x10;
        sz = PszFormatIds(idsGameFileAppearsCorruptUnableLoadFile, (short *)0x0);
        AlertSz(sz, sVar7);
        sVar7 = 0;
    }
    return sVar7;
}

// ======================================================================
// Function: UnpackBattlePlan
// Address: 1070:40ce
// Segment: MEMORY_IO
// ======================================================================

void UnpackBattlePlan(byte *lpb, BTLPLAN *lpbtlplan, short iplan)

{
    byte      *pbVar1;
    undefined2 unaff_SS;
    short      cOut;
    short      cch;
    char       szName[33];
    char       szTemp[33];

    pbVar1 = (byte *)lpb;
    __fmemmove(lpbtlplan, lpb, 4);
    lpb = (byte *)lpb + 4;
    cch = (short)*lpb;
    if (cch == 0) {
        __fstrcpy((char *)CONCAT22(lpbtlplan._2_2_, ((BTLPLAN *)lpbtlplan)->szName), (char *)CONCAT22(lpb._2_2_, pbVar1 + 5));
    } else {
        cOut = 0x20;
        __fmemmove(szTemp, (byte *)CONCAT22(lpb._2_2_, pbVar1 + 5), 0x20);
        FDecompressUserString(szTemp, cch, szName, &cOut);
        __fmemmove((byte *)CONCAT22(lpbtlplan._2_2_, ((BTLPLAN *)lpbtlplan)->szName), szName, cOut);
    }
    lpbtlplan->wFlags = lpbtlplan->wFlags & 0xff0f | (iplan & 0xfU) << 4;
    return;
}

// ======================================================================
// Function: UpdateBattleRecords
// Address: 1070:41ac
// Segment: MEMORY_IO
// ======================================================================

void UpdateBattleRecords(void)

{
    byte       bVar1;
    HB        *pHVar2;
    int        iVar3;
    BTLREC26  *pBVar4;
    BTLDATA   *pBVar5;
    undefined2 uVar6;
    undefined2 uVar7;
    short      itok;
    BTLREC26  *lpbr26;
    HB        *lphb;
    short      cKill;
    BTLREC    *lpbr;
    BTLDATA   *lpbd;

    lphb = (HB *)CONCAT22(rglphb[0xb]._2_2_, (HB *)rglphb[0xb]);
    if (((HB *)rglphb[0xb] != (HB *)0x0) || (rglphb[0xb]._2_2_ != 0)) {
        lpbd = (BTLDATA *)CONCAT22(rglphb[0xb]._2_2_, &((HB *)rglphb[0xb])[1].cbBlock);
        while (true) {
            while (lpbd->id == 0xffff) {
                uVar6 = (undefined2)((ulong)lphb >> 0x10);
                /* WARNING: Load size is inaccurate */
                pHVar2 = ((HB *)lphb)->lphbNext;
                iVar3 = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
                lphb = (HB *)CONCAT22(iVar3, pHVar2);
                if ((pHVar2 == (HB *)0x0) && (iVar3 == 0)) {
                    return;
                }
                if (pHVar2->ibTop < 0x11) {
                    return;
                }
                lpbd = (BTLDATA *)CONCAT22(iVar3, &pHVar2[1].cbBlock);
            }
            uVar6 = (undefined2)((ulong)lpbd >> 0x10);
            pBVar5 = (BTLDATA *)lpbd;
            if (pBVar5->cbData == 0)
                break;
            pBVar4 = (BTLREC26 *)((int)pBVar5 + (uint)pBVar5->ctok * 0x1d + 0xe);
            lpbr = (BTLREC *)CONCAT22(uVar6, pBVar4);
            lpbr26 = (BTLREC26 *)CONCAT22(uVar6, pBVar4);
            pBVar5 = (BTLDATA *)((int)&pBVar5->id + pBVar5->cbData);
            lpbd = (BTLDATA *)CONCAT22(uVar6, pBVar5);
            while ((BTLREC *)lpbr < pBVar5) {
                uVar6 = (undefined2)((ulong)lpbr26 >> 0x10);
                bVar1 = ((BTLREC26 *)lpbr26)->itokAttack;
                uVar7 = (undefined2)((ulong)lpbr >> 0x10);
                ((BTLREC *)lpbr)->ctok = (uint)((BTLREC26 *)lpbr26)->ctok;
                ((BTLREC *)lpbr)->wFlags_0x4 = ((BTLREC *)lpbr)->wFlags_0x4 & 0xff | (uint)bVar1 << 8;
                pBVar4 = (BTLREC26 *)((int)(BTLREC *)lpbr + ((BTLREC *)lpbr)->ctok * 8 + 6);
                lpbr26 = (BTLREC26 *)CONCAT22(uVar7, pBVar4);
                lpbr = (BTLREC *)CONCAT22(uVar7, pBVar4);
            }
        }
    }
    return;
}

// ======================================================================
// Function: AskSaveDialog
// Address: 1070:432a
// Segment: MEMORY_IO
// ======================================================================

short AskSaveDialog(HWND hwnd, ushort message, ushort wParam, long lParam)

{
    short sVar1;

    if (message != 2) {
        if (message == 0x110) {
            return 1;
        }
        if (message == 0x111) {
            if (((wParam == 0x429) || (wParam == 0x42b)) || (wParam == 0x42a)) {
                if (wParam == 0x42b) {
                    sVar1 = 0;
                } else if (wParam == 0x42a) {
                    sVar1 = -1;
                } else {
                    sVar1 = 1;
                }
                EndDialog(hwnd, sVar1);
                return 1;
            }
            if (wParam == 0x76) {
                WinHelp(hwnd, szHelpFile, 1, 0x442);
                return 1;
            }
        }
    }
    return 0;
}

// ======================================================================
// Function: PromptSaveGame
// Address: 1070:43ee
// Segment: MEMORY_IO
// ======================================================================

void PromptSaveGame(void)

{
    DialogId   lpTemplate;
    short      sVar1;
    FARPROC    lpDlgProc;
    short      fRet;
    fn_lpProc *lpProc;

    lpDlgProc = MakeProcInstance(AskSaveDialog, hInst);
    if ((game.wCrap >> 2 & 1) == 0) {
        lpTemplate = 0x42c;
    } else {
        lpTemplate = IDD_SAVE_TURN;
    }
    sVar1 = DialogBox(0, lpTemplate, hwndFrame, lpDlgProc);
    FreeProcInstance(lpDlgProc);
    if (sVar1 != 0) {
        gd.grBits._0_2_ = (uint)gd.grBits & 0xffef | (uint)(sVar1 == -1) << 4;
        FWriteLogFile((char *)szBase, idPlayer);
        FWriteHistFile(idPlayer);
    }
    return;
}

// ======================================================================
// Function: DestroyCurGame
// Address: 1070:44b0
// Segment: MEMORY_IO
// ======================================================================

void DestroyCurGame(void)

{
    short i;

    if (((uint)gd.grBits >> 8 & 1) != 0) {
        FFinishPlrMsgEntry(0);
    }
    if ((idPlayer != -1) && (game.fDirty != 0)) {
        PromptSaveGame();
    }
    ResetHb(htPlanets);
    lpPlanets._0_2_ = (PLANET *)0x0;
    lpPlanets._2_2_ = 0;
    cPlanet = 0;
    ResetHb(htFleets);
    rglpfl._0_2_ = (FLEET **)0x0;
    rglpfl._2_2_ = 0;
    cFleet = 0;
    ResetHb(htThings);
    lpThings._0_2_ = (THING *)0x0;
    lpThings._2_2_ = 0;
    cThing = 0;
    cThingAlloc = 0;
    vlprgScoreX._0_2_ = (SCOREX *)0x0;
    vlprgScoreX._2_2_ = 0;
    vrptFleet.fCached = 0;
    vrptPlanet.fCached = 0;
    vrptBattle.fCached = 0;
    vrptEFleet.fCached = 0;
    for (i = 0; i < 0x10; i = i + 1) {
        *(undefined2 *)((SCOREX **)rgsxPlr + i) = 0;
        *(undefined2 *)((int)(SCOREX **)rgsxPlr + i * 4 + 2) = 0;
    }
    lpbBattleT._0_2_ = (byte *)0x0;
    lpbBattleT._2_2_ = 0;
    lpbBattleLog._0_2_ = (byte *)0x0;
    lpbBattleLog._2_2_ = 0;
    lpbBattleCur._0_2_ = (byte *)0x0;
    lpbBattleCur._2_2_ = 0;
    gd.grBits._0_2_ = (uint)gd.grBits & 0xebff;
    gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfbff;
    ResetHb(htBattle);
    if (((HB *)rglphb[0xb] != (HB *)0x0) || (rglphb[0xb]._2_2_ != 0)) {
        ((HB *)rglphb[0xb])[1].cbBlock = 0xffff;
    }
    ResetHb(htMisc);
    ResetHb(htString);
    ResetHb(htShips);
    ResetHb(htOrd);
    ResetHb(htPlrMsg);
    for (i = 0; i < 0x10; i = i + 1) {
        *(undefined2 *)(i * 4 + rglpshdef) = 0;
        *(undefined2 *)(i * 4 + rglpshdef_0x2) = 0;
        *(undefined2 *)(i * 4 + rglpshdefSB) = 0;
        *(undefined2 *)(i * 4 + rglpshdefSB_0x2) = 0;
        *(undefined2 *)((BTLPLAN **)rglpbtlplan + i) = 0;
        *(undefined2 *)((int)(BTLPLAN **)rglpbtlplan + i * 4 + 2) = 0;
        ((byte *)rgcbtlplan)[i] = 0;
    }
    if (sel.grobj != grobjNone) {
        ini.wFlags = ini.wFlags & 0xfe1f | (sel.grobj & (grobjThing | grobjOther | grobjFleet | grobjPlanet)) << 5;
        ini.iObjSel = sel.id;
        ini.idPlayer = idPlayer;
        ini.lid._0_2_ = (undefined2)game.lid;
        ini.lid._2_2_ = game.lid._2_2_;
    }
    idPlayer = -1;
    imemLogCur = 0;
    imemLogPrev = -1;
    iMsgCur = 0;
    vlpbAiData._0_2_ = (byte *)0x0;
    vlpbAiData._2_2_ = 0;
    ResetMessages();
    lSaltCur._0_2_ = 0;
    lSaltCur._2_2_ = 0;
    ctickLast._0_2_ = 0;
    ctickLast._2_2_ = 0;
    game.lid._0_2_ = 0;
    game.lid._2_2_ = 0;
    game.cPlayer = 0;
    game.cPlanMax = 0;
    game.fDirty = 0;
    game.turn = 0;
    game.szName[0] = '\0';
    gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffe;
    gd.grBits._0_2_ = (uint)gd.grBits & 0xfeff;
    if (hwndBrowser != 0) {
        DestroyWindow(hwndBrowser);
    }
    if (hwndReportDlg != 0) {
        DestroyWindow(hwndReportDlg);
    }
    if (hwndPopup != 0) {
        DestroyWindow(hwndPopup);
        hwndPopup = 0;
    }
    hwndActive = 0;
    sel.scan.grobjFull = grobjNone;
    sel.scan.grobj = grobjNone;
    sel.scan.iwp = -1;
    sel.scan.ifl = -1;
    sel.scan.idpl = -1;
    fOrdersVis = 0;
    sel.grobjFull = grobjNone;
    sel.grobj = grobjNone;
    sel.id = -1;
    sel.pt.y = 0;
    sel.pt.x = 0;
    sel.pl.id = -1;
    sel.fl.id = -1;
    sel.fl.lpplord._0_2_ = (PLORD *)0x0;
    sel.fl.lpplord._2_2_ = 0;
    sel.pl.lpplprod._0_2_ = (PLPROD *)0x0;
    sel.pl.lpplprod._2_2_ = 0;
    dxPlanetProdLB = 0;
    dxOrderED = 0;
    dxFleetCompLB = 0;
    dxShipLB = 0;
    dxShipDD = 0;
    for (i = 0; i < 3; i = i + 1) {
        *(undefined2 *)(i * 2 + rgdxOrderDD) = 0;
    }
    return;
}

// ======================================================================
// Function: FBogusLong
// Address: 1070:484c
// Segment: MEMORY_IO
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10704887) */

short FBogusLong(ulong lSerial)

{
    int local_6;

    local_6 = 0;
    while (CONCAT22(*(undefined2 *)(local_6 * 4 + bogi_0x2), *(undefined2 *)(local_6 * 4 + bogi)) < (lSerial ^ 0xa5a5a5a5)) {
        local_6 = local_6 + 1;
    }
    return (uint)((lSerial ^ 0xa5a5a5a5) == CONCAT22(*(undefined2 *)(local_6 * 4 + bogi_0x2), *(undefined2 *)(local_6 * 4 + bogi)));
}

// ======================================================================
// Function: FValidSerialLong
// Address: 1070:48c4
// Segment: MEMORY_IO
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10704975) */
/* WARNING: Removing unreachable block (ram,0x10704994) */

short FValidSerialLong(ulong lSerial)

{
    short sVar1;
    ulong uVar2;
    ulong uVar3;
    ulong lSeries;
    short i;
    ulong lNumber;

    sVar1 = FBogusLong(lSerial);
    if (sVar1 == 0) {
        uVar2 = lSerial;
        for (i = 0; i < 4; i = i + 1) {
            uVar2 = __aFuldiv(uVar2, 0x24);
        }
        uVar3 = uVar2;
        for (i = 0; i < 4; i = i + 1) {
            uVar3 = __aFulmul(uVar3, 0x24);
        }
        uVar3 = lSerial - uVar3;
        if ((((int)(uVar3 >> 0x10) == 0) && ((uint)uVar3 < 100)) || (1500000 < uVar3)) {
            sVar1 = 0;
        } else if (((uVar2 == 0x12) || (uVar2 == 0x16)) || ((uVar2 == 2 || ((uVar2 == 4 || (uVar2 == 6)))))) {
            sVar1 = 1;
        } else {
            sVar1 = 0;
        }
    } else {
        sVar1 = 0;
    }
    return sVar1;
}

// ======================================================================
// Function: FileError
// Address: 1070:4a10
// Segment: MEMORY_IO
// ======================================================================

void FileError(StringId ids)

{
    char *sz;
    short mbType;

    idsFileError = ids;
    if ((fFileErrSilent == 0) && (((uint)gd.grBits >> 1 & 1) == 0)) {
        mbType = 0x10;
        sz = PszFormatIds(ids, (short *)0x0);
        AlertSz(sz, mbType);
    }
    return;
}

// ======================================================================
// Function: GetFileStatus
// Address: 1070:4a60
// Segment: MEMORY_IO
// ======================================================================

void GetFileStatus(short dt, short iPlayer)

{
    short sVar1;

    SetSzWorkFromDt(dt, iPlayer);
    sVar1 = __access((char *)szWork, 2);
    gd.grBits._2_2_ = gd.grBits._2_2_ & 0xffdf | (uint)(sVar1 != 0) << 5;
    return;
}

// ======================================================================
// Function: FOpenFile
// Address: 1070:4ac2
// Segment: MEMORY_IO
// ======================================================================

short FOpenFile(DtFileType dt, short iPlayer, short md)

{
    DtFileType dt_00;
    char      *pcVar1;
    RTBOF     *pRVar2;
    short (*pasVar3)[9];
    short       sVar4;
    StringId    ids_00;
    short       sVar5;
    int         iVar6;
    short      *psVar7;
    undefined1 *puVar8;
    char       *pcVar9;
    RTBOF      *pRVar10;
    undefined2  uVar11;
    undefined2  unaff_SS;
    short       env[9];
    short (*penvMemSav)[9];
    short fSilentSav;
    short fRewind;
    short fCheckMulti;
    short ids;
    RTBOF rtbof;

    sVar5 = fFileErrSilent;
    gd.grBits._2_2_ = gd.grBits._2_2_ & 0xff7f;
    dt_00 = dt & 0xff;
    SetSzWorkFromDt(dt_00, iPlayer);
    pasVar3 = penvMem;
    penvMem = &env;
    sVar4 = __setjmp(env);
    if (sVar4 != 0) {
        fFileErrSilent = sVar5;
        FileError(idsCantOpenFile);
        StreamClose();
        penvMem = pasVar3;
        return 0;
    }
    fFileErrSilent = 1;
    StreamOpen((char *)szWork, md);
    uVar11 = 0x1070;
    fFileErrSilent = sVar5;
    ReadRt();
    psVar7 = &stack0xffca;
    if ((((hdrCur.wFlags >> 10 == 8) && ((uint)rgbCur._8_2_ >> 0xc == 2)) && (0x30 < ((uint)rgbCur._8_2_ >> 5 & 0x7f))) &&
        (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x54)) {
        pcVar9 = (char *)rgbCur;
        pRVar10 = &rtbof;
        for (iVar6 = 8; iVar6 != 0; iVar6 = iVar6 + -1) {
            pRVar2 = pRVar10;
            pRVar10 = pRVar10->rgid + 2;
            pcVar1 = pcVar9;
            pcVar9 = pcVar9 + 2;
            *pRVar2->rgid = *pcVar1;
        }
        if ((int)(rtbof.wFlags_0xc << 0xb) >> 0xb == iPlayer) {
            if (((int)game.lid == 0) && (puVar8 = &stack0xffca, game.lid._2_2_ == 0))
                goto LAB_1070_4ebd;
            if (((int)rtbof.lidGame == (int)game.lid) && (rtbof.lidGame._2_2_ == game.lid._2_2_)) {
                if (dt_00 == dtHist) {
                    puVar8 = &stack0xffca;
                    if ((int)(rtbof.wFlags_0xc << 0xb) >> 0xb == iPlayer)
                        goto LAB_1070_4ebd;
                } else {
                    psVar7 = &stack0xffca;
                    if (((dt & 0x2000) != dtXY) && (psVar7 = &stack0xffca, (rtbof.wFlags_0xe >> 10 & 1) != 0)) {
                        __lseek(hf, -4, 2);
                        env[0] = 0x1118;
                        uVar11 = 0x1070;
                        ReadRt();
                        psVar7 = env + 1;
                        if ((hdrCur.wFlags >> 10 != 0) && ((hdrCur.wFlags & 0x3ff) != 2))
                            goto IO_LBadFile_2;
                        rtbof.turn._0_1_ = rgbCur[0];
                        rtbof.turn._1_1_ = rgbCur[1];
                        game.wCrap = game.wCrap & 0xf1ff | (rtbof.wFlags_0xe >> 0xd) << 9;
                        psVar7 = env + 1;
                    }
                    uVar11 = 0x1070;
                    puVar8 = psVar7;
                    if ((game.turn == 0) && (rtbof.turn != 0)) {
                        game.turn = rtbof.turn;
                        game.wCrap = game.wCrap & 0xf1ff | (rtbof.wFlags_0xe >> 0xd) << 9;
                    LAB_1070_4ebd:
                        if ((dt & 0x1000) != dtXY) {
                            *(undefined2 *)(puVar8 + -2) = 0;
                            *(undefined2 *)(puVar8 + -4) = 0;
                            *(undefined2 *)(puVar8 + -6) = 0;
                            *(short *)(puVar8 + -8) = hf;
                            *(undefined2 *)(puVar8 + -10) = uVar11;
                            *(char **)(puVar8 + -0xc) = (char *)rgbCur + 0x343;
                            __lseek(*(short *)(puVar8 + -8), *(long *)(puVar8 + -6), *(short *)(puVar8 + -2));
                            *(undefined2 *)(puVar8 + 6) = 0x1118;
                            *(char **)(puVar8 + 4) = (char *)rgbCur + 0x34b;
                            ReadRt();
                        }
                        penvMem = pasVar3;
                        wVersFile = rtbof.wVersion;
                        gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffb | (rtbof.wFlags_0xe >> 0xc & 1) << 2;
                        return 1;
                    }
                    if (rtbof.turn == game.turn) {
                        if (((dt_00 == dtHost) && (((uint)gd.grBits >> 3 & 1) == 0)) && ((rtbof.wFlags_0xe >> 9 & 1) != 0)) {
                            *(undefined2 *)((int)psVar7 + -2) = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
                            *(undefined2 *)((int)psVar7 + -4) = 0;
                            *(undefined2 *)((int)psVar7 + -6) = 0;
                            *(undefined2 *)((int)psVar7 + -8) = 0x15;
                            *(undefined2 *)((int)psVar7 + -10) = 0x1070;
                            *(undefined2 *)((int)psVar7 + -0xc) = (char *)rgbCur + 0x25f;
                            pcVar9 = PszFormatIds(*(StringId *)((int)psVar7 + -8), (short *)*(undefined4 *)((int)psVar7 + -6));
                            *(undefined2 *)((int)psVar7 + -4) = pcVar9;
                            *(undefined2 *)((int)psVar7 + -6) = 0x1030;
                            uVar11 = 0x1040;
                            *(undefined2 *)((int)psVar7 + -8) = (char *)rgbCur + 0x268;
                            sVar5 = AlertSz((char *)*(undefined2 *)((int)psVar7 + -4), *(short *)((int)psVar7 + -2));
                            if (sVar5 == 6)
                                goto LAB_1070_4ebd;
                        } else if ((((rtbof.wFlags_0xe >> 8 & 1) == 0) && (((uint)gd.grBits >> 1 & 1) != 0)) && (((uint)gd.grBits >> 2 & 1) == 0)) {
                            gd.grBits._2_2_ = gd.grBits._2_2_ & 0xff7f | 0x80;
                        } else {
                            if (((dt_00 != dtLog) || ((game.wCrap >> 3 & 1) != 0)) || (rtbof.wFlags_0xe >> 0xd == (game.wCrap >> 9 & 7)))
                                goto LAB_1070_4ebd;
                            *(undefined2 *)((int)psVar7 + -2) = 0x1d;
                            *(undefined2 *)((int)psVar7 + -4) = 0x1070;
                            uVar11 = 0x1070;
                            *(undefined2 *)((int)psVar7 + -6) = (char *)rgbCur + 0x304;
                            FileError(*(StringId *)((int)psVar7 + -2));
                        }
                    } else {
                        *(undefined2 *)((int)psVar7 + -2) = 0x1c;
                        *(undefined2 *)((int)psVar7 + -4) = 0x1070;
                        uVar11 = 0x1070;
                        *(undefined2 *)((int)psVar7 + -6) = (char *)rgbCur + 0x211;
                        FileError(*(StringId *)((int)psVar7 + -2));
                    }
                }
            } else {
                uVar11 = 0x1070;
                FileError(idsFileGame);
                psVar7 = &stack0xffca;
            }
        } else {
            uVar11 = 0x1070;
            FileError(idsGameFileAppearsCorruptUnableLoadFile);
            psVar7 = &stack0xffca;
        }
    } else if (hdrCur.wFlags >> 10 == 8) {
        if (((uint)rgbCur._8_2_ >> 0xc < 3) && (((uint)rgbCur._8_2_ >> 0xc != 2 || (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x55)))) {
            ids_00 = idsSorryFileCreatedOlderVersionStarsIncompatible;
        } else {
            ids_00 = idsFileCreatedNewerVersionStarsMustUpgrade;
        }
        uVar11 = 0x1070;
        FileError(ids_00);
        psVar7 = &stack0xffca;
    } else {
        uVar11 = 0x1070;
        FileError(idsFileDoesBelongVersionStars);
        psVar7 = &stack0xffca;
    }
IO_LBadFile_2:
    *(undefined2 *)((int)psVar7 + -2) = uVar11;
    *(undefined2 *)((int)psVar7 + -4) = (char *)rgbCur + 0xa3;
    StreamClose();
    penvMem = pasVar3;
    return 0;
}

// ======================================================================
// Function: FNewTurnAvail
// Address: 1070:4f22
// Segment: MEMORY_IO
// ======================================================================

short FNewTurnAvail(short idPlayer)

{
    ushort uVar1;
    uint   uVar2;
    short  sVar3;
    short  fNew;
    ushort turnOld;
    ushort wGenOld;

    uVar1 = game.turn;
    uVar2 = game.wCrap >> 9;
    fFileErrSilent = 1;
    game.turn = 0;
    sVar3 = FOpenFile(0x2003, idPlayer, 0x20);
    if (sVar3 == 0) {
        fNew = 0;
    } else {
        StreamClose();
        fNew = (short)(uVar1 < game.turn);
    }
    game.turn = uVar1;
    game.wCrap = game.wCrap & 0xf1ff | (uVar2 & 7) << 9;
    return fNew;
}

// ======================================================================
// Function: FCheckFile
// Address: 1070:4fb2
// Segment: MEMORY_IO
// ======================================================================

short FCheckFile(DtFileType dt, short iPlayer, ushort md)

{
    short  sVar1;
    uint   uVar2;
    short  sVar3;
    short  fErrSav;
    short  f;
    ushort wGenOld;
    short  fOpened;
    short  fReturn;

    sVar1 = fFileErrSilent;
    uVar2 = game.wCrap >> 9;
    if (dt == dtHost) {
        f = (uint)gd.grBits >> 3 & 1;
        gd.grBits._0_2_ = (uint)gd.grBits & 0xfff7 | 8;
    }
    fFileErrSilent = 1;
    sVar3 = FOpenFile(dt, iPlayer, 0x20);
    if (md == 1) {
        if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 9 & 1) != 0)) {
            fReturn = 1;
        } else {
            fReturn = 0;
        }
    } else if (md == 2) {
        if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 8 & 1) == 0)) {
            fReturn = 0;
        } else {
            fReturn = 1;
        }
    } else if (md == 4) {
        if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 10 & 1) == 0)) {
            fReturn = 0;
        } else {
            fReturn = 1;
        }
    } else if (md == 8) {
        if (sVar3 == 0) {
            fReturn = 0;
        } else {
            do {
                ReadRt();
                if (hdrCur.wFlags >> 10 == 6)
                    break;
            } while (rgbCur[0] != iPlayer);
            fReturn = (uint)rgbCur._6_2_ >> 9 & 1;
        }
    }
    if (sVar3 != 0) {
        StreamClose();
    }
    if (dt == dtHost) {
        gd.grBits._0_2_ = (uint)gd.grBits & 0xfff7 | (f & 1U) << 3;
    }
    fFileErrSilent = sVar1;
    game.wCrap = game.wCrap & 0xf1ff | (uVar2 & 7) << 9;
    return fReturn;
}

// ======================================================================
// Function: ReadRt
// Address: 1070:5168
// Segment: MEMORY_IO
// ======================================================================

void ReadRt(void)

{
    RgFromStream(&hdrCur, 2);
    if ((hdrCur.wFlags & 0x3ff) != 0) {
        RgFromStream(rgbCur, hdrCur.wFlags & 0x3ff);
    }
    if (hdrCur.wFlags >> 10 == 8) {
        SetFileXorStream(CONCAT22(rgbCur._6_2_, rgbCur._4_2_), (int)rgbCur._12_2_ >> 5, rgbCur._10_2_, (int)(rgbCur._12_2_ << 0xb) >> 0xb,
                         (uint)rgbCur._14_2_ >> 0xc & 1);
    } else if (hdrCur.wFlags >> 10 != 0) {
        XorFileBuf((char *)rgbCur, hdrCur.wFlags & 0x3ff);
    }
    return;
}

// ======================================================================
// Function: FBadFileError
// Address: 1070:524e
// Segment: MEMORY_IO
// ======================================================================

short FBadFileError(StringId ids)

{
    short sVar1;

    if ((((ids == idsUniverseDefinitionFileSeemsMissingCorrupt) || (ids == idsPlayerLogFileAppearsCorruptUnableLoad)) ||
         (ids == idsHistoryFileAppearsCorruptHistoricalDataWill)) ||
        (((ids == idsGameFileAppearsCorruptUnableLoadFile || (ids == idsErrorWritingFile)) || ((ids == idsFileDate || (ids == idsFileGame)))))) {
        sVar1 = 1;
    } else {
        sVar1 = 0;
    }
    return sVar1;
}

// ======================================================================
// Function: StreamOpen
// Address: 1070:52ae
// Segment: MEMORY_IO
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x1070536a) */
/* WARNING: Removing unreachable block (ram,0x10705391) */

void StreamOpen(char *szFile, short mdOpen)

{
    ulong      uVar1;
    undefined2 unaff_SS;
    DWORD      DVar2;
    DWORD      DVar3;
    ulong      dwTickCur;
    short      fNoErr;
    OFSTRUCT   of;
    ulong      dwTick;

    uVar1 = 0;
    while (true) {
        hf = OpenFile(szFile, &of, mdOpen & 0xbfff);
        if (hf != 0xffff) {
            return;
        }
        if ((((uint)gd.grBits >> 9 & 1) == 0) || (of.nErrCode == 2))
            break;
        DVar2 = GetTickCount();
        if (uVar1 == 0) {
            uVar1 = DVar2 + 4000;
        }
        if (uVar1 <= DVar2)
            break;
        do {
            DVar3 = GetTickCount();
        } while (DVar3 < DVar2 + 500);
    }
    if ((mdOpen & 0x4000U) == 0) {
        FileError(idsCantOpenFile);
    }
    _longjmp(penvMem, -1);
    return;
}

// ======================================================================
// Function: StreamClose
// Address: 1070:53cc
// Segment: MEMORY_IO
// ======================================================================

void StreamClose(void)

{
    if (hf != -1) {
        _lclose(hf);
        hf = -1;
    }
    return;
}

// ======================================================================
// Function: RgFromStream
// Address: 1070:53f4
// Segment: MEMORY_IO
// ======================================================================

void RgFromStream(void *rg, ushort cb)

{
    UINT UVar1;

    if (cb != 0) {
        if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
            UVar1 = _lread(hf, rg, cb);
            if (UVar1 != cb) {
                FileError(idsGameFileAppearsCorruptUnableLoadFile);
                _longjmp(penvMem, -1);
            }
        } else {
            __fmemcpy(rg, (byte *)CONCAT22(vlpMemStream._2_2_, (byte *)vlpMemStream), cb);
            vlpMemStream._0_2_ = (byte *)vlpMemStream + cb;
        }
    }
    return;
}

// ======================================================================
// Function: WriteOrders
// Address: 1070:547e
// Segment: MEMORY_IO
// ======================================================================

void WriteOrders(FLEET *lpfl)

{
    FLEET     *pFVar1;
    undefined2 uVar2;
    ORDER     *lpord;
    short      cord;

    uVar2 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar1 = (FLEET *)lpfl;
    if (pFVar1->cord != 0) {
        cord = pFVar1->cord;
        lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar1->lpplord + 2), (ORDER *)(*(int *)&pFVar1->lpplord + 4));
        for (; cord != 0; cord = cord + -1) {
            uVar2 = (undefined2)((ulong)lpord >> 0x10);
            if ((((ORDER *)lpord)->wFlags_0x6 & 0xf) == 0) {
                WriteRt(0x14, 8, lpord);
            } else {
                WriteRt(0x13, 0x12, lpord);
            }
            lpord = (ORDER *)CONCAT22(uVar2, (ORDER *)lpord + 1);
        }
    }
    return;
}

// ======================================================================
// Function: WriteRtPlr
// Address: 1070:551c
// Segment: MEMORY_IO
// ======================================================================

void WriteRtPlr(PLAYER *pplr, byte *pbStore)

{
    ushort uVar1;
    short  sVar2;
    short  cOut;
    byte  *pb;
    short  i;
    byte   rgb[264];

    if (pbStore == (byte *)0x0) {
        pbStore = rgb;
    }
    if ((pplr->wFlags & 1) != 0) {
        pplr->wMdPlr = pplr->wMdPlr & 0xfff8 | 7;
    }
    _memmove(pbStore, pplr, 0xc0);
    if ((pplr->wMdPlr & 7) == 7) {
        for (i = 0xf; (-1 < i && (pplr->rgmdRelation[i] == '\0')); i = i + -1) {
        }
        i = i + 1;
        pb = pbStore + 0x71;
        pbStore[0x70] = (byte)i;
        _memmove(pb, pplr->rgmdRelation, i);
        pb = pb + i;
    } else {
        pb = pbStore + 8;
    }
    cOut = 0x1f;
    if ((pplr->szName[0] == '\0') || (sVar2 = FCompressUserString(pplr->szName, (char *)(pb + 1), &cOut), sVar2 == 0)) {
        _strcpy(pb + 1, pplr->szName);
        *pb = 0;
        uVar1 = _strlen(pplr->szName);
        pb = pb + uVar1 + 2;
    } else {
        *pb = (byte)cOut;
        pb = pb + cOut + 1;
    }
    cOut = 0x1f;
    if ((pplr->szNames[0] == '\0') || (sVar2 = FCompressUserString(pplr->szNames, (char *)(pb + 1), &cOut), sVar2 == 0)) {
        _strcpy(pb + 1, pplr->szNames);
        *pb = 0;
        uVar1 = _strlen(pplr->szNames);
        pb = pb + uVar1 + 2;
    } else {
        *pb = (byte)cOut;
        pb = pb + cOut + 1;
    }
    WriteRt(6, (int)pb - (int)pbStore, pbStore);
    return;
}

// ======================================================================
// Function: WriteRtShDef
// Address: 1070:574e
// Segment: MEMORY_IO
// ======================================================================

void WriteRtShDef(SHDEF *lpshdef, byte **ppbStore)

{
    short      sVar1;
    ushort     uVar2;
    SHDEF     *pSVar3;
    undefined2 uVar4;
    undefined2 unaff_SS;
    HULDEF    *pHVar5;
    short      cOut;
    byte      *pb;
    char       szHulName[32];
    byte       rgb[147];

    rgb[2] = (byte)(lpshdef->hul).ihuldef;
    uVar4 = (undefined2)((ulong)lpshdef >> 0x10);
    pSVar3 = (SHDEF *)lpshdef;
    rgb._0_2_ = pSVar3->wFlags;
    rgb[6] = (pSVar3->hul).chs;
    rgb[3] = (byte)(pSVar3->hul).ibmp;
    if ((pSVar3->wFlags & 0xff) == 7) {
        rgb._4_2_ = (pSVar3->hul).dp;
        rgb._7_2_ = pSVar3->turn;
        rgb._9_2_ = *(undefined2 *)&pSVar3->cBuilt;
        rgb._11_2_ = *(undefined2 *)(byte *)((int)&pSVar3->cBuilt + 2);
        rgb._13_2_ = *(undefined2 *)&pSVar3->cExist;
        rgb._15_2_ = *(undefined2 *)(byte *)((int)&pSVar3->cExist + 2);
        pb = rgb + 0x11;
        __fmemmove(pb, (HS *)CONCAT22(uVar4, (pSVar3->hul).rghs), (uint)rgb[6] << 2);
        pb = pb + (uint)rgb[6] * 4;
    } else {
        rgb._4_2_ = (pSVar3->hul).wtEmpty;
        pb = rgb + 6;
    }
    if ((pSVar3->wFlags & 0xff) == 7) {
        __fstrcpy(szHulName, (char *)CONCAT22(uVar4, (pSVar3->hul).szClass));
    } else {
        pHVar5 = LphuldefFromId((lpshdef->hul).ihuldef);
        __fstrcpy(szHulName, (char *)CONCAT22((int)((ulong)pHVar5 >> 0x10), (((HULDEF *)pHVar5)->hul).szClass));
    }
    cOut = 0x1f;
    if ((szHulName[0] == '\0') || (sVar1 = FCompressUserString(szHulName, (char *)(pb + 1), &cOut), sVar1 == 0)) {
        _strcpy(pb + 1, szHulName);
        *pb = 0;
        uVar2 = _strlen(szHulName);
        pb = pb + uVar2 + 2;
    } else {
        *pb = (byte)cOut;
        pb = pb + cOut + 1;
    }
    if (ppbStore == (byte **)0x0) {
        WriteRt(0x1a, (int)pb - (int)rgb, rgb);
    } else {
        _memmove(*ppbStore, rgb, (int)pb - (int)rgb);
        *ppbStore = *ppbStore + ((int)pb - (int)rgb);
    }
    return;
}

// ======================================================================
// Function: FWriteDataFile
// Address: 1070:5964
// Segment: MEMORY_IO
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10705d1f) */
/* WARNING: Removing unreachable block (ram,0x10705e4f) */

short FWriteDataFile(char *pszFileBase, short iPlayer, short fAppend)

{
    byte      *pbVar1;
    ORDER     *pOVar2;
    PLANET    *pPVar3;
    ORDER     *pOVar4;
    short     *psVar5;
    undefined2 uVar6;
    FLEET     *pFVar7;
    FLEET     *pFVar8;
    POINT      pt;
    POINT      pt_00;
    uint       uVar9;
    short      sVar10;
    char      *pcVar11;
    DtFileType dt;
    byte       bVar12;
    int        iVar13;
    int        iVar14;
    int        iVar15;
    THING     *pTVar16;
    ORDER     *pOVar17;
    PLANET    *pPVar18;
    PLANET    *pPVar19;
    short     *psVar20;
    ORDER     *pOVar21;
    undefined2 uVar22;
    undefined2 unaff_SS;
    ulong      uVar23;
    PL        *pPVar24;
    THING     *pTVar25;
    short      local_8c[7];
    undefined4 local_7e;
    undefined4 local_7a;
    undefined4 local_76;
    int        local_72;
    int        local_70;
    int        local_6e;
    undefined4 local_6c;
    int        local_68;
    int        local_66;
    undefined2 uStack_64;
    int        local_62;
    int        local_60;
    int        local_5e;
    int        local_5c;
    undefined4 local_5a;
    uint       local_56;
    SCAN       scan;
    PLANET    *lpplT;
    short      fRet;
    THING     *lpthMac;
    SHDEF     *lpshdef;
    short      iord;
    short      env[9];
    FLEET     *lpfl;
    THING     *lpth;
    ORDER     *lpord;
    short      i;
    short (*penvMemSav)[9];
    short    j;
    BTLPLAN *lpbtlplan;
    short    fNoAutoTrack;
    FLEET   *lpflT;
    short    iMax;

    fRet = 1;
    SetVisiblePlanFleet(iPlayer);
    bVar12 = (byte)iPlayer;
    if ((((uint)gd.grBits >> 1 & 1) != 0) && (iPlayer != -1)) {
        for (i = 0; i < cFleet; i = i + 1) {
            /* WARNING: Load size is inaccurate */
            pFVar8 = ((FLEET **)rglpfl)[i];
            iVar15 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
            lpfl = (FLEET *)CONCAT22(iVar15, pFVar8);
            if ((pFVar8 == (FLEET *)0x0) && (iVar15 == 0))
                break;
            if (((pFVar8->wFlags_0x4 >> 10 & 1) == 0) && (((uint)lpfl->id >> 9 & 0xf) == iPlayer)) {
                for (j = 0; (j < 0x10 && (pFVar8->rgcsh[j] == 0)); j = j + 1) {
                }
                if (j == 0x10) {
                    pFVar8->wFlags_0x4 = pFVar8->wFlags_0x4 & 0xfbff | 0x400;
                } else {
                    iVar14 = *(int *)&pFVar8->lpplord;
                    uVar22 = *(undefined2 *)((int)&pFVar8->lpplord + 2);
                    lpord = (ORDER *)CONCAT22(uVar22, (ORDER *)(iVar14 + 4));
                    if ((*(uint *)(iVar14 + 10) >> 8 & 0xf) == 2) {
                        pt.y = *(short *)(iVar14 + 6);
                        pt.x = (lpord->pt).x;
                        sVar10 = FFindNearestObject(pt, 0x81, &scan);
                        if (sVar10 == 0) {
                            *(uint *)(iVar14 + 10) = *(uint *)(iVar14 + 10) & 0xf0ff | 0x400;
                            *(undefined2 *)(iVar14 + 8) = 0;
                        } else {
                            *(uint *)(iVar14 + 10) = *(uint *)(iVar14 + 10) & 0xf0ff | 0x100;
                            *(short *)(iVar14 + 8) = scan.idpl;
                        }
                    }
                    if ((((*(uint *)(iVar14 + 10) & 0xf) == 0) && (1 < pFVar8->cord)) && ((*(uint *)(iVar14 + 0x1c) & 0xf) == 7)) {
                        *(uint *)(iVar14 + 10) = *(uint *)(iVar14 + 10) & 0xfff0 | 7;
                        uVar6 = *(undefined2 *)(iVar14 + hbrLightGray);
                        *(undefined2 *)(iVar14 + 0xc) = *(undefined2 *)(iVar14 + 0x1e);
                        *(undefined2 *)(iVar14 + 0xe) = uVar6;
                    }
                    if (((*(uint *)(iVar14 + 10) & 0xf) == 7) && ((pFVar8->cord < 2 || ((*(uint *)(iVar14 + 0x1c) >> 8 & 0xf) != 2)))) {
                        local_6c = (FLEET *)0x0;
                        local_76 = 100000000;
                        local_6e = 0;
                        if ((pFVar8->idPlanet == -1) && ((1 < pFVar8->cord && ((pFVar8->wFlags_0x4 >> 9 & 1) != 0)))) {
                            local_5e = *(short *)(iVar14 + 0x16);
                            local_5c = *(short *)(iVar14 + 0x18);
                        } else {
                            local_5e = (&pFVar8->pt)->x;
                            local_5c = (pFVar8->pt).y;
                        }
                        uVar6 = *(undefined2 *)((int)(BTLPLAN **)rglpbtlplan + pFVar8->iPlayer * 4 + 2);
                        iVar13 = *(int *)((BTLPLAN **)rglpbtlplan + pFVar8->iPlayer) + (uint)pFVar8->iplan * 0x24;
                        _local_66 = CONCAT22(uVar6, iVar13);
                        local_56 = *(uint *)(iVar13 + 2) & 0xf;
                        for (local_68 = 0; local_68 < cFleet; local_68 = local_68 + 1) {
                            /* WARNING: Load size is inaccurate */
                            pFVar7 = ((FLEET **)rglpfl)[local_68];
                            iVar13 = *(int *)((int)((FLEET **)rglpfl + local_68) + 2);
                            local_5a = (FLEET *)CONCAT22(iVar13, pFVar7);
                            if ((pFVar7 == (FLEET *)0x0) && (iVar13 == 0))
                                break;
                            if (((pFVar7->wFlags_0x4 >> 8 & 1) != 0) && (pFVar7->iPlayer != iPlayer)) {
                                local_72 = (&pFVar7->pt)->x - local_5e;
                                local_70 = local_72 >> 0xf;
                                local_62 = (pFVar7->pt).y - local_5c;
                                local_60 = local_62 >> 0xf;
                                uVar23 = __aFulmul((long)local_62, (long)local_62);
                                local_7e = uVar23;
                                uVar23 = __aFulmul(CONCAT22(local_70, local_72), CONCAT22(local_70, local_72));
                                local_7a = uVar23 + local_7e;
                                if (((local_6e == 0) && (-1 < (int)((FLEET *)local_5a)->wFlags_0x4)) ||
                                    ((local_7a < local_76 && ((local_6e == 0 || (-1 < (int)((FLEET *)local_5a)->wFlags_0x4)))))) {
                                    sVar10 = FMatchTarget(local_5a, local_56, 0);
                                    if (sVar10 != 0) {
                                        sVar10 = FAttackPlayer((FLEET *)CONCAT22(iVar15, pFVar8), ((FLEET *)local_5a)->iPlayer);
                                        if (sVar10 != 0) {
                                            local_6c = local_5a;
                                            local_76 = local_7a;
                                            if (-1 < (int)((FLEET *)local_5a)->wFlags_0x4) {
                                                local_6e = 1;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        if ((local_6e != 0) && (((uint)gd.grBits >> 0xb & 1) == 0)) {
                            ((FLEET *)local_6c)->wFlags_0x4 = ((FLEET *)local_6c)->wFlags_0x4 & 0x7fff | 0x8000;
                        }
                        j = *(int *)(iVar14 + 0xe) * 0x32 + 0x32;
                        if (j == 0x226) {
                            j = 10000;
                        }
                        if ((((FLEET *)local_6c != (FLEET *)0x0) || (local_6c._2_2_ != 0)) && (local_76 != 0)) {
                            uVar23 = __aFulmul((long)j, (long)j);
                            if (local_76 <= (long)uVar23) {
                                if ((int)(uint)((PLORD *)pFVar8->lpplord)->iordMax <= pFVar8->cord + 1) {
                                    pPVar24 =
                                        LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&pFVar8->lpplord + 2), *(PL **)&pFVar8->lpplord), pFVar8->cord + 2);
                                    *(PL **)&pFVar8->lpplord = (PL *)pPVar24;
                                    *(undefined2 *)((int)&pFVar8->lpplord + 2) = (int)((ulong)pPVar24 >> 0x10);
                                    lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar8->lpplord + 2), (ORDER *)(*(int *)&pFVar8->lpplord + 4));
                                }
                                if (1 < pFVar8->cord) {
                                    __fmemmove((ORDER *)lpord + 2, (ORDER *)lpord + 1, (pFVar8->cord + -1) * 0x12);
                                }
                                if (pFVar8->cord == 1) {
                                    __fmemset((ORDER *)lpord + 1, 0, 0x12);
                                    ((ORDER *)lpord)[1].wFlags_0x6 = ((ORDER *)lpord)[1].wFlags_0x6 & 0xefff | 0x1000;
                                    ((ORDER *)lpord)[1].wFlags_0x6 = ((ORDER *)lpord)[1].wFlags_0x6 & 0xfff0 | 7;
                                    uVar22 = *(undefined2 *)((int)&((ORDER *)lpord)->u_ORDER_0x0008 + 2);
                                    *&((ORDER *)lpord)[1].u_ORDER_0x0008 = ((&((ORDER *)lpord)->u_ORDER_0x0008)->txp).rgia[0].wFlags;
                                    *(undefined2 *)((int)&((ORDER *)lpord)[1].u_ORDER_0x0008 + 2) = uVar22;
                                    if (((&((ORDER *)lpord)[1].u_ORDER_0x0008)->tlm).cTime == 0) {
                                        uVar9 = IFindIdealWarp((FLEET *)CONCAT22(iVar15, pFVar8), 0);
                                        ((ORDER *)lpord)[1].wFlags_0x6 = ((ORDER *)lpord)[1].wFlags_0x6 & 0xff0f | (uVar9 & 0xf) << 4;
                                        local_7e._2_2_ = uVar9;
                                    } else {
                                        local_7e._2_2_ = ((&((ORDER *)lpord)[1].u_ORDER_0x0008)->tlm).cTime;
                                        ((ORDER *)lpord)[1].wFlags_0x6 = ((ORDER *)lpord)[1].wFlags_0x6 & 0xff0f | (local_7e._2_2_ & 0xf) << 4;
                                    }
                                    if ((pFVar8->wFlags_0x4 >> 9 & 1) != 0) {
                                        pOVar21 = (ORDER *)lpord + 2;
                                        pOVar17 = (ORDER *)lpord;
                                        for (iVar14 = 9; iVar14 != 0; iVar14 = iVar14 + -1) {
                                            pOVar4 = pOVar21;
                                            pOVar21 = &(pOVar21->pt).y;
                                            pOVar2 = pOVar17;
                                            pOVar17 = &(pOVar17->pt).y;
                                            (pOVar4->pt).x = (pOVar2->pt).x;
                                        }
                                        local_7e._2_2_ = IFindIdealWarp((FLEET *)CONCAT22(iVar15, pFVar8), 0);
                                        ((ORDER *)lpord)[2].wFlags_0x6 = ((ORDER *)lpord)[2].wFlags_0x6 & 0xff0f | (local_7e._2_2_ & 0xf) << 4;
                                        pFVar8->cord = pFVar8->cord + 1;
                                        pbVar1 = &((PLORD *)pFVar8->lpplord)->iordMac;
                                        *pbVar1 = *pbVar1 + 1;
                                    }
                                } else if (((&((ORDER *)lpord)[1].u_ORDER_0x0008)->tlm).cTime == 0) {
                                    uVar9 = IFindIdealWarp((FLEET *)CONCAT22(iVar15, pFVar8), 0);
                                    ((ORDER *)lpord)[1].wFlags_0x6 = ((ORDER *)lpord)[1].wFlags_0x6 & 0xff0f | (uVar9 & 0xf) << 4;
                                    local_7e._2_2_ = uVar9;
                                } else {
                                    local_7e._2_2_ = ((&((ORDER *)lpord)[1].u_ORDER_0x0008)->tlm).cTime;
                                    ((ORDER *)lpord)[1].wFlags_0x6 = ((ORDER *)lpord)[1].wFlags_0x6 & 0xff0f | (local_7e._2_2_ & 0xf) << 4;
                                }
                                uVar22 = (undefined2)((ulong)local_6c >> 0x10);
                                sVar10 = (((FLEET *)local_6c)->pt).y;
                                (((ORDER *)lpord + 1)->pt).x = (&((FLEET *)local_6c)->pt)->x;
                                ((ORDER *)lpord)[1].pt.y = sVar10;
                                ((ORDER *)lpord)[1].id = local_6c->id;
                                ((ORDER *)lpord)[1].wFlags_0x6 = ((ORDER *)lpord)[1].wFlags_0x6 & 0xf0ff | 0x200;
                                pFVar8->cord = pFVar8->cord + 1;
                                pbVar1 = &((PLORD *)pFVar8->lpplord)->iordMac;
                                *pbVar1 = *pbVar1 + 1;
                                FSendPlrMsg(iPlayer, idmPatrollingHasTargetedIntercept, lpfl->id | 0x8000, lpfl->id, local_6c->id, 0, 0, 0, 0, 0);
                            }
                        }
                    }
                    uVar22 = (undefined2)((ulong)lpord >> 0x10);
                    pOVar17 = (ORDER *)lpord;
                    if (((pOVar17->wFlags_0x6 & 0xf) != 1) && (1 < pFVar8->cord)) {
                        for (iord = 1; iord < pFVar8->cord; iord = iord + 1) {
                            if ((pOVar17[iord].wFlags_0x6 >> 8 & 0xf) == 8) {
                                pTVar25 = LpthFromId(pOVar17[iord].id);
                                iVar14 = (int)((ulong)pTVar25 >> 0x10);
                                pTVar16 = (THING *)pTVar25;
                                if ((((pTVar16 == (THING *)0x0) && (iVar14 == 0)) ||
                                     ((pTVar25->idFull >> 0xd == 3 && ((*(uint *)((int)&pTVar16->u_THING_0x0006 + 4) >> 4 & 1) == 0)))) ||
                                    (((pTVar25->idFull >> 0xd == 0 && ((1 << (bVar12 & 0x1f) & *(uint *)((int)&pTVar16->u_THING_0x0006 + 8)) == 0)) ||
                                      ((pTVar25->idFull >> 0xd == 2 && ((((&pTVar16->u_THING_0x0006)->thp).wFlags >> 0xd & 1) == 0)))))) {
                                    if (((pTVar16 == (THING *)0x0) && (iVar14 == 0)) || (pTVar25->idFull >> 0xd != 2)) {
                                        if (((pTVar16 == (THING *)0x0) && (iVar14 == 0)) || (pTVar25->idFull >> 0xd != 3)) {
                                            if (((pTVar16 != (THING *)0x0) || (iVar14 != 0)) && (pTVar25->idFull >> 0xd == 0)) {
                                                FSendPlrMsg2(pFVar8->iPlayer, idmMineFieldHeadingHasVanishedOrdersHave, lpfl->id | 0x8000, lpfl->id, 0);
                                            }
                                        } else {
                                            FSendPlrMsg2(pFVar8->iPlayer, idmMysteryTraderHeadingHasVanishedOrdersHave, lpfl->id | 0x8000, lpfl->id, 0);
                                        }
                                    } else {
                                        FSendPlrMsg2(pFVar8->iPlayer, idmWormholeHeadingHasVanishedOrdersHaveChanged, lpfl->id | 0x8000, lpfl->id, 0);
                                    }
                                    local_56 = pOVar17[iord].wFlags_0x6 & 0xf0ff | 0x400;
                                    pOVar17[iord].wFlags_0x6 = local_56;
                                    pOVar17[iord].id = iord;
                                }
                            } else if ((pOVar17[iord].wFlags_0x6 >> 8 & 0xf) == 2) {
                                fNoAutoTrack = pOVar17[iord].wFlags_0x6 >> 0xd & 1;
                                if (fNoAutoTrack != 0) {
                                    local_56 = pOVar17[iord].wFlags_0x6 & 0xdfff;
                                    pOVar17[iord].wFlags_0x6 = local_56;
                                }
                                lpflT = LpflFromId(pOVar17[iord].id);
                                iVar14 = (int)((ulong)lpflT >> 0x10);
                                pFVar7 = (FLEET *)lpflT;
                                if (((pFVar7 == (FLEET *)0x0) && (iVar14 == 0)) || ((pFVar7->wFlags_0x4 >> 10 & 1) != 0)) {
                                    FSendPlrMsg(iPlayer, idmSWaypointAppearsHaveDestroyedHasDisappeared, lpfl->id | 0x8000, lpfl->id, pOVar17[iord].id, 0, 0, 0,
                                                0, 0);
                                } else {
                                    if ((pFVar7->wFlags_0x4 >> 8 & 1) != 0)
                                        goto LAB_1070_618a;
                                    if ((pFVar7->idPlanet == -1) || (fNoAutoTrack != 0)) {
                                        FSendPlrMsg(iPlayer, idmFleetTrackingAppearsHaveOutrunRangeScanners, lpfl->id | 0x8000, lpfl->id, 0, 0, 0, 0, 0, 0);
                                    } else {
                                        FSendPlrMsg(iPlayer, idmFleetTrackingAppearsHaveDuckedBehindOrders, lpfl->id | 0x8000, lpfl->id, pFVar7->idPlanet, 0, 0,
                                                    0, 0, 0);
                                    }
                                }
                                local_56 = pOVar17[iord].wFlags_0x6 & 0xf0ff | 0x400;
                                pOVar17[iord].wFlags_0x6 = local_56;
                                pOVar17[iord].id = iord;
                                pt_00.y = pOVar17[iord].pt.y;
                                pt_00.x = ((pOVar17 + iord)->pt).x;
                                sVar10 = FFindNearestObject(pt_00, 0x81, &scan);
                                if (sVar10 != 0) {
                                    local_56 = pOVar17[iord].wFlags_0x6 & 0xf0ff | 0x100;
                                    pOVar17[iord].wFlags_0x6 = local_56;
                                    pOVar17[iord].id = scan.idpl;
                                }
                            }
                        LAB_1070_618a:
                        }
                    }
                }
            }
        }
    }
    MarkPlayersThatSentMsgs(iPlayer);
    MarkPlanetsPlayerLost(iPlayer);
    if (iPlayer == -1) {
        _wsprintf(szWork, s_s_hst_1120_09fe, pszFileBase, 0x1120);
    } else {
        _wsprintf(szWork, s_s_m_d_1120_0a05, pszFileBase, 0x1120, iPlayer + 1);
    }
    penvMemSav = penvMem;
    penvMem = &env;
    sVar10 = __setjmp(env);
    if (sVar10 == 0) {
        if (fAppend == 0) {
        LAB_1070_677e:
            if (iPlayer == -1) {
                dt = dtHost;
            } else {
                dt = dtTurn;
            }
            sVar10 = FCreateFile(dt, iPlayer, (char *)0x0);
            if (sVar10 == 0)
                goto IO_LFail_2;
        } else {
            sVar10 = FAppendFile(iPlayer);
            if (sVar10 == 0)
                goto LAB_1070_677e;
        }
        WriteBattles(iPlayer);
        for (i = 0; i < game.cPlayer; i = i + 1) {
            if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) || ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0)) {
                sVar10 = GetRaceStat((PLAYER *)rgplr + iPlayer, rsMajorAdv);
                if (sVar10 == raTerra) {
                    local_56 = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 7;
                    *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) = local_56;
                }
                WriteRtPlr((PLAYER *)rgplr + i, (byte *)0x0);
            }
        }
        if ((iPlayer == -1) && (((int)lSaltCur != 0 || (lSaltCur._2_2_ != 0)))) {
            WriteRt(0x24, 4, &lSaltCur);
        }
        WritePlayerMessages(iPlayer);
        lpplT = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
        for (i = 0; i < cPlanet; i = i + 1) {
            uVar22 = (undefined2)((ulong)lpplT >> 0x10);
            pPVar18 = (PLANET *)lpplT;
            if ((pPVar18->wFlags_0x4 >> 8 & 1) != 0) {
                if ((pPVar18->wFlags_0x4 & 0xff) == 7) {
                    WritePlanet(lpplT, 0xd, 0);
                    if ((*(int *)&pPVar18->lpplprod != 0) || (*(int *)((int)&pPVar18->lpplprod + 2) != 0)) {
                        WriteRt(0x1c, (uint)((PLPROD *)pPVar18->lpplprod)->iprodMac << 2,
                                (void *)CONCAT22(*(undefined2 *)((int)&pPVar18->lpplprod + 2), (void *)(*(int *)&pPVar18->lpplprod + 4)));
                    }
                } else if ((pPVar18->wFlags_0x4 & 0xff) == 2) {
                    psVar20 = local_8c;
                    pPVar19 = pPVar18;
                    for (iVar15 = 0x1c; iVar15 != 0; iVar15 = iVar15 + -1) {
                        psVar5 = psVar20;
                        psVar20 = psVar20 + 1;
                        pPVar3 = pPVar19;
                        pPVar19 = &pPVar19->iPlayer;
                        *psVar5 = pPVar3->id;
                    }
                    pPVar18->wFlags_0x4 = pPVar18->wFlags_0x4 & 0xfdff;
                    pPVar18->wFlags_0x4 = pPVar18->wFlags_0x4 & 0xff00 | 3;
                    WritePlanet(lpplT, 0xe, 0);
                    psVar20 = local_8c;
                    pPVar19 = pPVar18;
                    for (iVar15 = 0x1c; iVar15 != 0; iVar15 = iVar15 + -1) {
                        pPVar3 = pPVar19;
                        pPVar19 = &pPVar19->iPlayer;
                        psVar5 = psVar20;
                        psVar20 = psVar20 + 1;
                        pPVar3->id = *psVar5;
                    }
                } else {
                    WritePlanet(lpplT, 0xe, 0);
                }
            }
            lpplT = (PLANET *)CONCAT22(uVar22, pPVar18 + 1);
        }
        for (i = 0; i < game.cPlayer; i = i + 1) {
            if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
                iVar15 = *(int *)(i * 4 + rglpshdef);
                uVar22 = *(undefined2 *)(i * 4 + rglpshdef_0x2);
                for (j = 0; j < 0x10; j = j + 1) {
                    if (((*(uint *)(iVar15 + j * 0x93 + 0x7b) >> 9 & 1) == 0) && ((*(uint *)(iVar15 + j * 0x93 + 0x7b) >> 8 & 1) != 0)) {
                        WriteRtShDef((SHDEF *)CONCAT22(uVar22, (SHDEF *)(iVar15 + j * 0x93)), (byte **)0x0);
                    }
                }
            }
        }
        for (i = 0; i < cFleet; i = i + 1) {
            /* WARNING: Load size is inaccurate */
            pFVar8 = ((FLEET **)rglpfl)[i];
            iVar15 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
            lpflT = (FLEET *)CONCAT22(iVar15, pFVar8);
            if ((pFVar8 == (FLEET *)0x0) && (iVar15 == 0))
                break;
            if ((pFVar8->wFlags_0x4 >> 8 & 1) != 0) {
                WriteFleet((FLEET *)CONCAT22(iVar15, pFVar8));
            }
        }
        for (i = 0; i < game.cPlayer; i = i + 1) {
            if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
                iVar15 = *(int *)(i * 4 + rglpshdefSB);
                uVar22 = *(undefined2 *)(i * 4 + rglpshdefSB_0x2);
                for (j = 0; j < 10; j = j + 1) {
                    if (((*(uint *)(iVar15 + j * 0x93 + 0x7b) >> 9 & 1) == 0) && ((*(uint *)(iVar15 + j * 0x93 + 0x7b) >> 8 & 1) != 0)) {
                        WriteRtShDef((SHDEF *)CONCAT22(uVar22, (SHDEF *)(iVar15 + j * 0x93)), (byte **)0x0);
                    }
                }
            }
        }
        if ((iPlayer != -1) && (((SCOREX *)vlprgScoreX != (SCOREX *)0x0 || (vlprgScoreX._2_2_ != 0)))) {
            for (i = 0; i < game.cPlayer; i = i + 1) {
                if (((((gd.grBits._2_2_ & 1) != 0) || (i == iPlayer)) || ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0)) ||
                    (((game.wCrap >> 6 & 1) != 0 && (0x13 < game.turn)))) {
                    WriteRt(0x2d, 0x18, (SCOREX *)CONCAT22(vlprgScoreX._2_2_, (SCOREX *)vlprgScoreX + i));
                }
            }
        }
        i = 0;
        local_56 = lpThings._2_2_;
        local_5a = (FLEET *)CONCAT22((THING *)lpThings, (FLEET *)local_5a);
        lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
        while ((THING *)lpth < (THING *)lpThings + cThing) {
            if ((((iPlayer == -1) ||
                  ((((iPlayer == (lpth->idFull >> 9 & 0xf) && (lpth->idFull >> 0xd != 1)) && ((lpth->idFull >> 0xd != 3 && (lpth->idFull >> 0xd != 2)))) ||
                    ((lpth->idFull >> 0xd == 0 && ((1 << (bVar12 & 0x1f) & *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8)) != 0)))))) ||
                 ((lpth->idFull >> 0xd == 1 && (((&((THING *)lpth)->u_THING_0x0006)->tht).ptDest.x < 0)))) ||
                (((lpth->idFull >> 0xd == 3 && ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) >> 4 & 1) != 0)) ||
                  ((lpth->idFull >> 0xd == 2 && ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 0xd & 1) != 0)))))) {
                i = i + 1;
            }
            lpth = (THING *)lpth + 1;
        }
        if (0 < i) {
            WriteRt(0x2b, 2, &i);
            local_56 = lpThings._2_2_;
            local_5a = (FLEET *)CONCAT22((THING *)lpThings, (FLEET *)local_5a);
            pTVar16 = (THING *)lpThings + cThing;
            lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
            while ((THING *)lpth < pTVar16) {
                if ((((iPlayer == -1) ||
                      ((((iPlayer == (lpth->idFull >> 9 & 0xf) && (lpth->idFull >> 0xd != 1)) && (lpth->idFull >> 0xd != 3)) && (lpth->idFull >> 0xd != 2)))) ||
                     (((lpth->idFull >> 0xd == 0 && ((1 << (bVar12 & 0x1f) & *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8)) != 0)) ||
                       (((lpth->idFull >> 0xd == 1 && (((&((THING *)lpth)->u_THING_0x0006)->tht).ptDest.x < 0)) ||
                         ((lpth->idFull >> 0xd == 3 && ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) >> 4 & 1) != 0)))))))) ||
                    ((lpth->idFull >> 0xd == 2 && ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 0xd & 1) != 0)))) {
                    WriteRt(0x2b, 0x12, lpth);
                }
                lpth = (THING *)lpth + 1;
            }
        }
        if (iPlayer == -1) {
            i = 0;
            iMax = game.cPlayer;
        } else {
            i = iPlayer;
            iMax = iPlayer + 1;
        }
        for (; i < iMax; i = i + 1) {
            /* WARNING: Load size is inaccurate */
            lpbtlplan._0_2_ = ((BTLPLAN **)rglpbtlplan)[i];
            lpbtlplan._2_2_ = *(undefined2 *)((int)(BTLPLAN **)rglpbtlplan + i * 4 + 2);
            for (j = 0; j < (int)(uint)((byte *)rgcbtlplan)[i]; j = j + 1) {
                WriteBattlePlan((BTLPLAN *)CONCAT22(lpbtlplan._2_2_, (BTLPLAN *)lpbtlplan), 0);
                lpbtlplan._0_2_ = (BTLPLAN *)lpbtlplan + 1;
            }
        }
        WriteRt(0, 2, &game.turn);
        StreamClose();
    } else {
    IO_LFail_2:
        idPlayer = iPlayer;
        if (fAppend == 0) {
            if (iPlayer == -1) {
                idPlayer = -1;
                sVar10 = 0x10;
                pcVar11 = PszFormatIds(idsUnableCreateHostFile, (short *)0x0);
                AlertSz(pcVar11, sVar10);
            } else {
                sVar10 = 0x10;
                pcVar11 = PszFormatIds(idsUnableCreateNewTurnFile, (short *)0x0);
                AlertSz(pcVar11, sVar10);
            }
        } else {
            sVar10 = 0x10;
            pcVar11 = PszFormatIds(idsUnableUpdateTurnFile, (short *)0x0);
            AlertSz(pcVar11, sVar10);
        }
        idPlayer = -1;
        fRet = 0;
    }
    SetVisiblePlanFleet(-1);
    return fRet;
}

// ======================================================================
// Function: FAppendFile
// Address: 1070:704e
// Segment: MEMORY_IO
// ======================================================================

short FAppendFile(short iPlayer)

{
    short sVar1;

    sVar1 = FMarkFile(0x2003, iPlayer, 4, 1);
    if (sVar1 != 0) {
        WriteBOF(iPlayer, 3, 1);
    }
    return (uint)(sVar1 != 0);
}

// ======================================================================
// Function: WriteBattles
// Address: 1070:709c
// Segment: MEMORY_IO
// ======================================================================

void WriteBattles(short iPlayer)

{
    char      *pcVar1;
    uint      *puVar2;
    HB        *pHVar3;
    FLEET     *pFVar4;
    byte      *pbVar5;
    uint       uVar6;
    BTLREC    *pBVar7;
    undefined2 uVar8;
    HB        *pHVar9;
    BTLDATA   *pBVar10;
    int        iVar11;
    int        iVar12;
    undefined2 uVar13;
    FLEET     *pFVar14;
    PLANET    *lppl_00;
    short      iplr;
    short      cb;
    BTLDATA   *lpbtldata;
    HB        *lphb;
    byte      *lpbBattle;
    BTLREC    *lpbtlrec;
    ushort     fPlayerCur;
    short      cbT;
    FLEET     *lpfl;
    short      i;
    PLANET    *lppl;
    short      cbRec;
    short      ctok;

    if ((iPlayer != -1) && (((byte *)lpbBattleLog != (byte *)lpbBattleCur || (lpbBattleLog._2_2_ != lpbBattleCur._2_2_)))) {
        lphb = (HB *)CONCAT22(rglphb[0xb]._2_2_, (HB *)rglphb[0xb]);
        lpbBattle._0_2_ = &((HB *)rglphb[0xb])[1].cbBlock;
        lpbBattle._2_2_ = rglphb[0xb]._2_2_;
        while (((HB *)lphb != (HB *)0x0 || (lphb._2_2_ != 0))) {
            lpbtldata = (BTLDATA *)CONCAT22(lpbBattle._2_2_, (byte *)lpbBattle);
            while (true) {
                uVar13 = (undefined2)((ulong)lphb >> 0x10);
                pHVar9 = (HB *)lphb;
                if ((0x10 < pHVar9->ibTop) && (lpbtldata->id != 0xffff))
                    break;
                /* WARNING: Load size is inaccurate */
                pHVar3 = pHVar9->lphbNext;
                lpbBattle._2_2_ = *(int *)((int)&pHVar9->lphbNext + 2);
                lphb = (HB *)CONCAT22(lpbBattle._2_2_, pHVar3);
                if ((pHVar3 == (HB *)0x0) && (lpbBattle._2_2_ == 0)) {
                    return;
                }
                lpbBattle._0_2_ = &pHVar3[1].cbBlock;
                lpbtldata = (BTLDATA *)CONCAT22(lpbBattle._2_2_, (byte *)lpbBattle);
            }
            uVar13 = (undefined2)((ulong)lpbtldata >> 0x10);
            pBVar10 = (BTLDATA *)lpbtldata;
            if ((pBVar10->grfPlr & 1 << ((byte)iPlayer & 0x1f)) == 0) {
                lpbBattle._0_2_ = (byte *)lpbBattle + pBVar10->cbData;
            } else {
                for (i = 0; i < game.cPlayer; i = i + 1) {
                    if (((i != iPlayer) && ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) == 0)) && ((1 << ((byte)i & 0x1f) & pBVar10->grfPlr) != 0)) {
                        *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
                        *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 3;
                    }
                }
                for (i = 0; i < (int)(uint)pBVar10->ctok; i = i + 1) {
                    if ((uint) * (byte *)((int)pBVar10 + i * 0x1d + 0x10) != iPlayer) {
                        if (*(char *)((int)pBVar10 + i * 0x1d + 0x11) == '\x01') {
                            uVar6 = (uint) * (byte *)((int)pBVar10 + i * 0x1d + 0x10);
                            LpplFromId(*(short *)((int)pBVar10 + i * 0x1d + 0xe));
                            if ((*(uint *)(*(int *)(uVar6 * 4 + rglpshdefSB) + (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) >> 8 & 1) ==
                                0) {
                                *(uint *)(*(int *)(uVar6 * 4 + rglpshdefSB) + (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) =
                                    *(uint *)(*(int *)(uVar6 * 4 + rglpshdefSB) + (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) & 0xfeff |
                                    0x100;
                                iVar11 = *(int *)((int)&rgplr[0].wFlags_0x4 + uVar6 * 0xc0);
                                puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + uVar6 * 0xc0);
                                *puVar2 = *puVar2 & 0xfff;
                                puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + uVar6 * 0xc0);
                                *puVar2 = *puVar2 | iVar11 + 0x1000U & 0xf000;
                            }
                            *(uint *)(*(int *)(uVar6 * 4 + rglpshdefSB) + (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) =
                                *(uint *)(*(int *)(uVar6 * 4 + rglpshdefSB) + (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) & 0xff00 | 7;
                        } else {
                            pFVar14 = LpflFromId(*(short *)((int)pBVar10 + i * 0x1d + 0xe));
                            uVar8 = (undefined2)((ulong)pFVar14 >> 0x10);
                            pFVar4 = (FLEET *)pFVar14;
                            if ((pFVar4->iPlayer != iPlayer) && ((*(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) >> 8 & 1) == 0)) {
                                *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) =
                                    *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) & 0xfeff | 0x100;
                                *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) =
                                    *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) & 0xfff8 | 3;
                            }
                            iVar11 = pFVar4->iPlayer * 4;
                            if ((*(uint *)(*(int *)(iVar11 + rglpshdef) + (uint) * (byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) >> 8 & 1) == 0) {
                                iVar11 = pFVar4->iPlayer * 4;
                                iVar12 = pFVar4->iPlayer * 4;
                                *(uint *)(*(int *)(iVar12 + rglpshdef) + (uint) * (byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) =
                                    *(uint *)(*(int *)(iVar11 + rglpshdef) + (uint) * (byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) & 0xfeff | 0x100;
                                pcVar1 = (char *)((int)&rgplr[0].cShDef + pFVar4->iPlayer * 0xc0);
                                *pcVar1 = *pcVar1 + '\x01';
                            }
                            iVar11 = pFVar4->iPlayer * 4;
                            iVar12 = pFVar4->iPlayer * 4;
                            *(uint *)(*(int *)(iVar12 + rglpshdef) + (uint) * (byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) =
                                *(uint *)(*(int *)(iVar11 + rglpshdef) + (uint) * (byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) & 0xff00 | 7;
                            if ((pFVar4->wFlags_0x4 >> 10 & 1) == 0) {
                                if ((pFVar4->wFlags_0x4 >> 8 & 1) == 0) {
                                    iVar11 = *(int *)((int)&rgplr[0].wFlags_0x4 + pFVar4->iPlayer * 0xc0);
                                    puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar4->iPlayer * 0xc0);
                                    *puVar2 = *puVar2 & 0xf000;
                                    puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar4->iPlayer * 0xc0);
                                    *puVar2 = *puVar2 | iVar11 + 1U & 0xfff;
                                    pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xfeff | 0x100;
                                    pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xff00;
                                }
                                if ((pFVar4->wFlags_0x4 & 0xff) < 3) {
                                    pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xff00 | 3;
                                }
                            }
                        }
                    }
                }
                if (pBVar10->idPlanet != 0xffff) {
                    lppl_00 = LpplFromId(pBVar10->idPlanet);
                    MarkPlanet(lppl_00, iPlayer, 1);
                }
                if (pBVar10->cbData < 0x400) {
                    WriteRt(0x1f, pBVar10->cbData, (byte *)CONCAT22(lpbBattle._2_2_, (byte *)lpbBattle));
                    lpbBattle._0_2_ = (byte *)lpbBattle + pBVar10->cbData;
                } else {
                    uVar6 = (uint)pBVar10->ctok * 0x1d + 0xe;
                    pBVar7 = (byte *)lpbBattle + uVar6;
                    lpbtlrec = (BTLREC *)CONCAT22(lpbBattle._2_2_, pBVar7);
                    if (uVar6 < 0x400) {
                        WriteRt(0x1f, uVar6, (byte *)CONCAT22(lpbBattle._2_2_, (byte *)lpbBattle));
                        lpbBattle._0_2_ = (byte *)lpbBattle + uVar6;
                    } else {
                        if (pBVar10->ctok < 0x23) {
                            ctok = (short)pBVar10->ctok;
                        } else {
                            ctok = 0x22;
                        }
                        if ((uint)pBVar10->ctok < (uint)ctok) {
                            ctok = (short)pBVar10->ctok;
                        }
                        WriteRt(0x1f, ctok * 0x1d + 0xe, (byte *)CONCAT22(lpbBattle._2_2_, (byte *)lpbBattle));
                        lpbBattle._0_2_ = (byte *)lpbBattle + ctok * 0x1d + 0xe;
                        ctok = (uint)pBVar10->ctok - ctok;
                        while (0 < ctok) {
                            if ((uint)ctok < 0x24) {
                                WriteRt(0x27, ctok * 0x1d, (byte *)CONCAT22(lpbBattle._2_2_, (byte *)lpbBattle));
                                lpbBattle._0_2_ = (byte *)lpbBattle + ctok * 0x1d;
                                ctok = 0;
                            } else {
                                WriteRt(0x27, 0x3f7, (byte *)CONCAT22(lpbBattle._2_2_, (byte *)lpbBattle));
                                lpbBattle._0_2_ = (byte *)lpbBattle + 0x3f7;
                                ctok = ctok + -0x23;
                            }
                        }
                    }
                    cb = (pBVar10->cbData - 0xe) + (uint)pBVar10->ctok * -0x1d;
                    if (cb < 0x400) {
                        WriteRt(0x27, cb, (BTLREC *)CONCAT22(lpbBattle._2_2_, pBVar7));
                        lpbBattle._0_2_ = (byte *)lpbBattle + cb;
                    } else {
                        while (cb != 0) {
                            cbRec = ((BTLREC *)lpbtlrec)->ctok * 8 + 6;
                            if (cbRec < 0x400) {
                                cbT = 0;
                                do {
                                    cbT = cbT + cbRec;
                                    pbVar5 = &((BTLREC *)lpbtlrec)->itok;
                                    lpbtlrec = (BTLREC *)CONCAT22(lpbtlrec._2_2_, pbVar5 + cbRec);
                                    cb = cb - cbRec;
                                    if (cb == 0)
                                        break;
                                    cbRec = (pbVar5 + cbRec)->ctok * 8 + 6;
                                } while (cbT + cbRec < 0x400);
                                WriteRt(0x27, cbT, (byte *)CONCAT22(lpbBattle._2_2_, (byte *)lpbBattle));
                            } else {
                                cb = cb - cbRec;
                                while (true) {
                                    if (cbRec < 0x400)
                                        break;
                                    WriteRt(0x27, 0x3ff, lpbtlrec);
                                    lpbtlrec = (BTLREC *)CONCAT22(lpbtlrec._2_2_, (BTLREC *)((int)&((BTLREC *)lpbtlrec)[0xaa].ctok + 1));
                                    cbRec = cbRec + -0x3ff;
                                }
                                if (cbRec != 0) {
                                    WriteRt(0x27, cbRec, lpbtlrec);
                                    lpbtlrec = (BTLREC *)CONCAT22(lpbtlrec._2_2_, &((BTLREC *)lpbtlrec)->itok + cbRec);
                                }
                            }
                            lpbBattle._0_2_ = &((BTLREC *)lpbtlrec)->itok;
                            lpbBattle._2_2_ = lpbtlrec._2_2_;
                        }
                    }
                }
            }
        }
    }
    return;
}

// ======================================================================
// Function: WritePlanet
// Address: 1070:7a6a
// Segment: MEMORY_IO
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x107080e7) */
/* WARNING: Removing unreachable block (ram,0x1070809d) */
/* WARNING: Removing unreachable block (ram,0x10708074) */
/* WARNING: Removing unreachable block (ram,0x107080c6) */
/* WARNING: Removing unreachable block (ram,0x10708110) */
/* WARNING: Removing unreachable block (ram,0x1070804b) */

void WritePlanet(PLANET *lppl, short rt, short fHistory)

{
    int        iVar1;
    undefined2 uVar2;
    byte      *pbVar3;
    uint       uVar4;
    uint       uVar5;
    uint       uVar6;
    PLANET    *pPVar7;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar8;
    undefined2 unaff_SS;
    ulong      uVar9;
    ulong      uVar10;
    byte      *pb;
    short      i;
    byte      *pbBase;
    byte       rgb[80];
    byte       bMask;

    uVar10 = CONCAT22(unaff_SI, unaff_DI);
    _memset(rgb, 0, 0x50);
    uVar8 = (undefined2)((ulong)lppl >> 0x10);
    pPVar7 = (PLANET *)lppl;
    rgb._0_2_ = lppl->id & 0x7ffU | pPVar7->iPlayer << 0xb;
    uVar5 = rgb._2_2_ & 0xff80;
    rgb._2_2_ = uVar5 | pPVar7->wFlags_0x4 & 0x7f;
    if ((rt == 0xe) && (3 < (pPVar7->wFlags_0x4 & 0xff))) {
        if (fHistory == 0) {
            uVar4 = 4;
        } else {
            uVar4 = 3;
        }
        rgb._2_2_ = uVar5 | uVar4;
    }
    uVar4 = (uint)((pPVar7->wRouting & 0x3ff) != 0);
    uVar6 = rgb._2_2_ & 0x3c7f | (pPVar7->wFlags_0x4 >> 8 & 1) << 8 | (pPVar7->wFlags_0x4 >> 9 & 1) << 9 | (pPVar7->wFlags_0x4 >> 10 & 1) << 7 |
            (pPVar7->wFlags_0x4 >> 0xb) << 0xf | uVar4 << 0xe;
    pb = rgb + 4;
    uVar5 = rgb._2_2_ & 0x7f;
    rgb._2_2_ = uVar6;
    if (1 < uVar5) {
        pb = rgb + 5;
        bMask = 3;
        for (i = 0; i < 3; i = i + 1) {
            if (pPVar7->rgpctMinLevel[i] != 0) {
                rgb[4] = rgb[4] | bMask & 0x55;
                *pb = pPVar7->rgpctMinLevel[i];
                pb = pb + 1;
            }
            bMask = bMask << 2;
        }
        for (i = 0; i < 3; i = i + 1) {
            *pb = pPVar7->rgMinConc[i];
            pb = pb + 1;
        }
        for (i = 0; i < 3; i = i + 1) {
            *pb = pPVar7->rgEnvVar[i];
            uVar4 = (uint)pPVar7->rgEnvVar[i];
            if (uVar4 != (int)pPVar7->rgEnvVarOrig[i]) {
                rgb._2_2_ = rgb._2_2_ & 0xfbff | 0x400;
            }
            pb = pb + 1;
        }
        if (((uint)rgb._2_2_ >> 10 & 1) != 0) {
            for (i = 0; i < 3; i = i + 1) {
                *pb = pPVar7->rgEnvVarOrig[i];
                pb = pb + 1;
            }
        }
        if (pPVar7->iPlayer != -1) {
            *(ushort *)pb = pPVar7->uGuesses;
            pb = pb + 2;
        }
        pbVar3 = pb;
        if (3 < (rgb._2_2_ & 0x7f)) {
            pb = pb + 1;
            bMask = 3;
            for (i = 0; i < 4; i = i + 1) {
                if ((i != 3) || (6 < (pPVar7->wFlags_0x4 & 0xff))) {
                    iVar1 = *(int *)((int)(pPVar7->rgwtMin + i) + 2);
                    if ((-1 < iVar1) && ((0 < iVar1 || ((int)pPVar7->rgwtMin[i] != 0)))) {
                        uVar5 = *(uint *)((int)(pPVar7->rgwtMin + i) + 2);
                        if (((int)uVar5 < 0) || (((int)uVar5 < 1 && (*(uint *)(pPVar7->rgwtMin + i) < 0x100)))) {
                            *pbVar3 = *pbVar3 | bMask & 0x55;
                            *pb = (byte)(int)pPVar7->rgwtMin[i];
                            pb = pb + 1;
                        } else {
                            iVar1 = *(int *)((int)pPVar7->rgwtMin + i * 4 + 2);
                            if ((iVar1 < 0) || (iVar1 < 1)) {
                                *pbVar3 = *pbVar3 | bMask & 0xaa;
                                *(int *)pb = (int)pPVar7->rgwtMin[i];
                                pb = pb + 2;
                            } else {
                                *pbVar3 = *pbVar3 | bMask;
                                uVar2 = *(undefined2 *)((int)(pPVar7->rgwtMin + i) + 2);
                                *(int *)pb = (int)pPVar7->rgwtMin[i];
                                *(undefined2 *)(pb + 2) = uVar2;
                                pb = pb + 4;
                            }
                        }
                    }
                }
                bMask = bMask << 2;
            }
            if (*pbVar3 != 0) {
                rgb._2_2_ = rgb._2_2_ & 0xdfff | 0x2000;
                pbVar3 = pb;
            }
            pb = pbVar3;
            if (rt != 0xe) {
                uVar9 = __aFulshr(uVar10, uVar4);
                uVar5 = (uint)uVar9 & 1;
                rgb._2_2_ = rgb._2_2_ & 0xefff | uVar5 << 0xc;
                if ((((pPVar7->iPlayer != -1) && (((*(uint *)pPVar7->rgbImp & 0xff) != 0 || (uVar9 = __aFulshr(uVar10, uVar5), (uVar9 & 1) != 0)))) ||
                     (uVar9 = __aFulshr(uVar10, uVar5), (uVar9 & 0xfff) != 0)) ||
                    (((uVar9 = __aFulshr(uVar10, uVar5), (uVar9 & 0xfff) != 0 || ((*(uint *)(pPVar7->rgbImp + 4) & 0xfff) != 0)) ||
                      (uVar10 = __aFulshr(uVar10, uVar5), ((uint)uVar10 & 0x1f) != 0x1f)))) {
                    rgb._2_2_ = rgb._2_2_ & 0xf7ff | 0x800;
                    __fmemmove(pb, (byte *)CONCAT22(uVar8, pPVar7->rgbImp), 8);
                    pb = pb + 8;
                }
                if (pPVar7->iPlayer != -1) {
                    if ((pPVar7->wFlags_0x4 >> 9 & 1) != 0) {
                        uVar2 = *(undefined2 *)((int)&pPVar7->lStarbase + 2);
                        *(int *)pb = (int)pPVar7->lStarbase;
                        *(undefined2 *)(pb + 2) = uVar2;
                        pb = pb + 4;
                    }
                    if ((pPVar7->wRouting & 0x3ff) != 0) {
                        *(ushort *)pb = pPVar7->wRouting;
                        pb = pb + 2;
                    }
                }
                WriteRt(0xd, (int)pb - (int)rgb, rgb);
                return;
            }
        }
    }
    if ((pPVar7->wFlags_0x4 >> 9 & 1) != 0) {
        *pb = (byte)(int)pPVar7->lStarbase & 0xf;
        pb = pb + 1;
    }
    if (fHistory != 0) {
        *(short *)pb = pPVar7->turn;
        pb = pb + 2;
    }
    WriteRt(0xe, (int)pb - (int)rgb, rgb);
    return;
}

// ======================================================================
// Function: WriteFleet
// Address: 1070:81c6
// Segment: MEMORY_IO
// ======================================================================

void WriteFleet(FLEET *lpfl)

{
    undefined2 uVar1;
    long       lVar2;
    byte      *pbVar3;
    uint       uVar4;
    int        iVar5;
    undefined2 unaff_SS;
    ulong      uVar6;
    long       wt;
    ushort     grMask;
    short      fByte;
    byte      *pb;
    short      i;
    ushort     us;
    byte       rgb[134];
    ushort    *pus;

    __fmemmove(rgb, lpfl, 0xc);
    fByte = 1;
    grMask = 1;
    us = 0;
    for (i = 0; i < 0x10; i = i + 1) {
        if ((0 < ((FLEET *)lpfl)->rgcsh[i]) && (us = us | grMask, 0xff < ((FLEET *)lpfl)->rgcsh[i])) {
            fByte = 0;
        }
        grMask = grMask << 1;
    }
    rgb._4_2_ = rgb._4_2_ & 0xf7ff | fByte << 0xb;
    rgb[0xc] = (undefined1)us;
    rgb[0xd] = us._1_1_;
    pb = rgb + 0xe;
    if (fByte == 0) {
        pus = pb;
        for (i = 0; i < 0x10; i = i + 1) {
            if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
                *pus = ((FLEET *)lpfl)->rgcsh[i];
                pus = pus + 1;
            }
        }
        pb = pus;
    } else {
        for (i = 0; i < 0x10; i = i + 1) {
            if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
                *pb = (byte)((FLEET *)lpfl)->rgcsh[i];
                pb = pb + 1;
            }
        }
    }
    pbVar3 = pb;
    if (3 < (((FLEET *)lpfl)->wFlags_0x4 & 0xff)) {
        grMask = 3;
        pb = pb + 2;
        us = 0;
        for (i = 0; i < 5; i = i + 1) {
            iVar5 = *(int *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
            if (((-1 < iVar5) && ((0 < iVar5 || ((int)((FLEET *)lpfl)->rgwtMin[i] != 0)))) &&
                (((((FLEET *)lpfl)->wFlags_0x4 & 0xff) == 7 || ((i != 4 && (i != 3)))))) {
                uVar4 = *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
                if (((int)uVar4 < 0) || (((int)uVar4 < 1 && (*(uint *)(((FLEET *)lpfl)->rgwtMin + i) < 0x100)))) {
                    us = us | grMask & 0x155;
                    *pb = (byte)(int)((FLEET *)lpfl)->rgwtMin[i];
                    pb = pb + 1;
                } else {
                    iVar5 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + i * 4 + 2);
                    if ((iVar5 < 0) || (iVar5 < 1)) {
                        uVar4 = grMask & 0x2aa;
                        *(int *)pb = (int)((FLEET *)lpfl)->rgwtMin[i];
                        pb = pb + 2;
                    } else {
                        uVar4 = grMask & 0x3ff;
                        uVar1 = *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
                        *(int *)pb = (int)((FLEET *)lpfl)->rgwtMin[i];
                        *(undefined2 *)(pb + 2) = uVar1;
                        pb = pb + 4;
                    }
                    us = us | uVar4;
                }
            }
            grMask = grMask << 2;
        }
        *(ushort *)pbVar3 = us;
    }
    if ((((FLEET *)lpfl)->wFlags_0x4 & 0xff) < 7) {
        lVar2 = 0;
        uVar1 = *(undefined2 *)((int)&((FLEET *)lpfl)->dirLong + 2);
        *(int *)pb = (int)((FLEET *)lpfl)->dirLong;
        *(undefined2 *)(pb + 2) = uVar1;
        for (i = 0; i < 0x10; i = i + 1) {
            if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
                iVar5 = ((FLEET *)lpfl)->iPlayer * 4;
                uVar6 = __aFulmul((long)((FLEET *)lpfl)->rgcsh[i], (ulong) * (uint *)(*(int *)(iVar5 + rglpshdef) + i * 0x93 + 0x28));
                lVar2 = uVar6 + lVar2;
            }
        }
        i = 0;
        while (true) {
            wt._2_2_ = (undefined2)((ulong)lVar2 >> 0x10);
            wt._0_2_ = (undefined2)lVar2;
            if (3 < i)
                break;
            lVar2 = lVar2 + CONCAT22(*(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2), (int)((FLEET *)lpfl)->rgwtMin[i]);
            i = i + 1;
        }
        *(undefined2 *)(pb + 4) = (undefined2)wt;
        *(undefined2 *)(pb + 6) = wt._2_2_;
        WriteRt(0x11, (short)(pb + (8 - (int)rgb)), rgb);
    } else {
        grMask = 1;
        us = 0;
        for (i = 0; i < 0x10; i = i + 1) {
            if (((FLEET *)lpfl)->rgcsh[i + 0x10] != 0) {
                us = us | grMask;
            }
            grMask = grMask << 1;
        }
        *(ushort *)pb = us;
        pus = pb + 2;
        for (i = 0; i < 0x10; i = i + 1) {
            if (((FLEET *)lpfl)->rgcsh[i + 0x10] != 0) {
                *pus = ((FLEET *)lpfl)->rgcsh[i + 0x10];
                pus = pus + 1;
            }
        }
        *(byte *)pus = ((FLEET *)lpfl)->iplan;
        *(undefined1 *)((int)pus + 1) = (char)((FLEET *)lpfl)->cord;
        WriteRt(0x10, (int)pus + (2 - (int)rgb), rgb);
        WriteOrders(lpfl);
        if ((*(int *)&((FLEET *)lpfl)->lpszName != 0) || (*(int *)((int)&((FLEET *)lpfl)->lpszName + 2) != 0)) {
            /* WARNING: Load size is inaccurate */
            WriteRtString((char *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2), ((FLEET *)lpfl)->lpszName));
        }
    }
    return;
}

// ======================================================================
// Function: WriteRtString
// Address: 1070:87b4
// Segment: MEMORY_IO
// ======================================================================

void WriteRtString(char *lpsz)

{
    short      sVar1;
    ushort     uVar2;
    undefined2 unaff_SS;
    short      cOut;
    byte       rgb[33];

    if ((lpsz != (char *)0x0) && (*lpsz != '\0')) {
        cOut = 0x1f;
        sVar1 = FCompressUserString(lpsz, (char *)(rgb + 1), &cOut);
        if (sVar1 == 0) {
            __fstrcpy((char *)(rgb + 1), lpsz);
            rgb[0] = 0;
            uVar2 = __fstrlen(lpsz);
            cOut = uVar2 + 1;
        } else {
            rgb[0] = (byte)cOut;
        }
        WriteRt(0x15, cOut + 1, rgb);
    }
    return;
}

// ======================================================================
// Function: MarkFleet
// Address: 1070:885e
// Segment: MEMORY_IO
// ======================================================================

void MarkFleet(FLEET *lpfl, short det)

{
    uint      *puVar1;
    int        iVar2;
    undefined2 uVar3;
    FLEET     *pFVar4;
    int        iVar5;
    undefined2 uVar6;
    SHDEF     *lpshdef;
    short      i;

    uVar6 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar4 = (FLEET *)lpfl;
    if ((pFVar4->wFlags_0x4 >> 8 & 1) == 0) {
        iVar5 = pFVar4->iPlayer * 4;
        iVar2 = *(int *)(iVar5 + rglpshdef);
        uVar3 = *(undefined2 *)(iVar5 + rglpshdef_0x2);
        pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xfeff | 0x100;
        pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xff00;
        *(uint *)((int)&pFVar4->dirLong + 2) = *(uint *)((int)&pFVar4->dirLong + 2) & 0xffef | 0x10;
        iVar5 = *(int *)((int)&rgplr[0].wFlags_0x4 + pFVar4->iPlayer * 0xc0);
        puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar4->iPlayer * 0xc0);
        *puVar1 = *puVar1 & 0xf000;
        puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar4->iPlayer * 0xc0);
        *puVar1 = *puVar1 | iVar5 + 1U & 0xfff;
        for (i = 0; i < 0x10; i = i + 1) {
            if (pFVar4->rgcsh[i] != 0) {
                *(uint *)(iVar2 + i * 0x93 + 0x7b) = *(uint *)(iVar2 + i * 0x93 + 0x7b) & 0xfeff | 0x100;
            }
        }
    }
    if ((pFVar4->wFlags_0x4 & 0xff) < (uint)det) {
        pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xff00 | det & 0xffU;
    }
    return;
}

// ======================================================================
// Function: WriteBattlePlan
// Address: 1070:89b8
// Segment: MEMORY_IO
// ======================================================================

void WriteBattlePlan(BTLPLAN *lpbtlplan, short fLog)

{
    short      sVar1;
    ushort     uVar2;
    undefined2 unaff_SS;
    short      cOut;
    char       szPlanName[32];
    byte      *pb;
    byte       rgb[36];

    __fmemmove(rgb, lpbtlplan, 4);
    if ((lpbtlplan->wFlags >> 0xe & 1) == 0) {
        __fstrcpy(szPlanName, (char *)CONCAT22(lpbtlplan._2_2_, ((BTLPLAN *)lpbtlplan)->szName));
        cOut = 0x1f;
        if ((szPlanName[0] == '\0') || (sVar1 = FCompressUserString(szPlanName, (char *)(rgb + 5), &cOut), sVar1 == 0)) {
            _strcpy(rgb + 5, szPlanName);
            rgb[4] = 0;
            uVar2 = _strlen(szPlanName);
            pb = rgb + uVar2 + 6;
        } else {
            rgb[4] = (byte)cOut;
            pb = rgb + cOut + 5;
        }
    } else {
        pb = rgb + 2;
    }
    if (fLog == 0) {
        WriteRt(0x1e, (int)pb - (int)rgb, rgb);
    } else {
        WriteMemRt(0x1e, (int)pb - (int)rgb, rgb);
    }
    return;
}

// ======================================================================
// Function: MarkPlanet
// Address: 1070:8adc
// Segment: MEMORY_IO
// ======================================================================

void MarkPlanet(PLANET *lppl, short iPlr, ushort det)

{
    int       *piVar1;
    uint      *puVar2;
    undefined2 uVar3;
    int        iVar4;
    PLANET    *pPVar5;
    int        iVar6;
    undefined2 uVar7;
    SHDEF     *lpshdef;

    uVar7 = (undefined2)((ulong)lppl >> 0x10);
    pPVar5 = (PLANET *)lppl;
    if ((pPVar5->wFlags_0x4 >> 8 & 1) == 0) {
        pPVar5->wFlags_0x4 = pPVar5->wFlags_0x4 & 0xfeff | 0x100;
        pPVar5->wFlags_0x4 = pPVar5->wFlags_0x4 & 0xff00;
        piVar1 = (int *)((int)&rgplr[0].cPlanet + iPlr * 0xc0);
        *piVar1 = *piVar1 + 1;
    }
    if ((pPVar5->wFlags_0x4 & 0xff) < det) {
        pPVar5->wFlags_0x4 = pPVar5->wFlags_0x4 & 0xff00 | det & 0xff;
    }
    if ((pPVar5->iPlayer != -1) && ((*(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) >> 8 & 1) == 0)) {
        *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) & 0xfeff | 0x100;
        *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) & 0xfff8 | 3;
    }
    if (((det != 2) && (pPVar5->iPlayer != -1)) && ((pPVar5->wFlags_0x4 >> 9 & 1) != 0)) {
        iVar6 = pPVar5->iPlayer * 4;
        uVar3 = *(undefined2 *)(iVar6 + rglpshdefSB_0x2);
        iVar6 = *(int *)(iVar6 + rglpshdefSB) + (*(uint *)&pPVar5->lStarbase & 0xf) * 0x93;
        if ((*(uint *)(iVar6 + 0x7b) >> 8 & 1) == 0) {
            *(uint *)(iVar6 + 0x7b) = *(uint *)(iVar6 + 0x7b) & 0xfeff | 0x100;
            *(uint *)(iVar6 + 0x7b) = *(uint *)(iVar6 + 0x7b) & 0xff00;
            iVar4 = *(int *)((int)&rgplr[0].wFlags_0x4 + pPVar5->iPlayer * 0xc0);
            puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pPVar5->iPlayer * 0xc0);
            *puVar2 = *puVar2 & 0xfff;
            puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pPVar5->iPlayer * 0xc0);
            *puVar2 = *puVar2 | iVar4 + 0x1000U & 0xf000;
        }
        if ((*(uint *)(iVar6 + 0x7b) & 0xff) < 3) {
            *(uint *)(iVar6 + 0x7b) = *(uint *)(iVar6 + 0x7b) & 0xff00 | 3;
        }
    }
    return;
}

// ======================================================================
// Function: SetSzWorkFromDt
// Address: 1070:8cfe
// Segment: MEMORY_IO
// ======================================================================

void SetSzWorkFromDt(DtFileType dt, short iPlayer)

{
    char      *pcVar1;
    char      *pcVar2;
    short      sVar3;
    undefined2 uVar4;
    char      *pchDot;
    short      c;
    char      *pchSlash;

    pcVar1 = _strrchr((char *)szBase, 0x2e);
    if ((pcVar1 != (char *)0x0) && ((pcVar2 = _strrchr((char *)szBase, 0x5c), pcVar2 == (char *)0x0 || (pcVar2 < pcVar1)))) {
        *pcVar1 = '\0';
    }
    sVar3 = _wsprintf(szWork, s_s_1120_0a0c, (char *)szBase, 0x1120);
    if (dt == dtXY) {
    LAB_1070_8d76:
        _strcat((char *)szWork, (char *)0xa10);
    } else {
        if (dt != dtLog) {
            if (dt == dtHost) {
                _strcat((char *)szWork, (char *)0xa13);
                return;
            }
            if ((dt != dtTurn) && (dt != dtHist))
                goto LAB_1070_8d76;
        }
        if (dt == dtLog) {
            uVar4 = 0x78;
        } else if (dt == dtHist) {
            uVar4 = 0x68;
        } else {
            uVar4 = 0x6d;
        }
        _wsprintf((char *)szWork + sVar3, s_c_d_1120_0a17, uVar4, iPlayer + 1);
    }
    return;
}

// ======================================================================
// Function: FCreateFile
// Address: 1070:8e16
// Segment: MEMORY_IO
// ======================================================================

short FCreateFile(DtFileType dt, short iPlayer, char *szForceName)

{
    short (*pasVar1)[9];
    short sVar2;
    char *psz;
    short env[9];
    short (*penvMemSav)[9];

    if (szForceName == (char *)0x0) {
        SetSzWorkFromDt(dt, iPlayer);
        psz = (char *)szWork;
    } else {
        psz = szForceName;
    }
    pasVar1 = penvMem;
    penvMem = &env;
    sVar2 = __setjmp(env);
    if (sVar2 == 0) {
        StreamOpen(psz, 0x1012);
        WriteBOF(iPlayer, dt, 0);
    }
    penvMem = pasVar1;
    return (uint)(sVar2 == 0);
}

// ======================================================================
// Function: WriteBOF
// Address: 1070:8ea4
// Segment: MEMORY_IO
// ======================================================================

void WriteBOF(short iPlayer, short dt, short fMulti)

{
    short      sVar1;
    int        iVar2;
    undefined2 unaff_SS;
    DWORD      DVar3;
    RTBOF      rtbof;

    _memset(&rtbof, 0, 0x10);
    _strncpy(rtbof.rgid, (char *)0xa1c, 4);
    rtbof.lidGame._0_2_ = (undefined2)game.lid;
    rtbof.lidGame._2_2_ = game.lid._2_2_;
    rtbof.wVersion = 0x2a60;
    rtbof.turn = game.turn;
    rtbof.wFlags_0xe = rtbof.wFlags_0xe & 0xfff | (game.wCrap >> 9) << 0xd;
    rtbof.wFlags_0xc = rtbof.wFlags_0xc & 0xffe0 | iPlayer & 0x1fU;
    sVar1 = Random(2000);
    DVar3 = GetTickCount();
    rtbof.wFlags_0xc = rtbof.wFlags_0xc & 0x1f | ((int)DVar3 + sVar1) * 0x20;
    if ((dt == 2) && ((gd.grBits._2_2_ & 1) != 0)) {
        iVar2 = 1;
    } else {
        iVar2 = 0;
    }
    rtbof.wFlags_0xe = rtbof.wFlags_0xe & 0xf400 | dt & 0xffU | ((uint)gd.grBits >> 4 & 1) << 8 | ((uint)gd.grBits >> 3 & 1) << 9 | iVar2 << 0xb;
    WriteRt(8, 0x10, &rtbof);
    return;
}

// ======================================================================
// Function: FMarkFile
// Address: 1070:904a
// Segment: MEMORY_IO
// ======================================================================

/* WARNING: Variable defined which should be unmapped: lSeedSav1 */
/* WARNING: Removing unreachable block (ram,0x107090a4) */

short FMarkFile(DtFileType dt, short iPlayer, short mdMark, short f)

{
    char  *pcVar1;
    RTBOF *pRVar2;
    short (*pasVar3)[9];
    short       sVar4;
    int         iVar5;
    long       *plVar6;
    undefined1 *puVar7;
    char       *pcVar8;
    RTBOF      *pRVar9;
    undefined2  unaff_SS;
    bool        bVar10;
    long        lSeedSav1;
    long        lSeedSav2;
    short       fSilentSav;
    short       fSuccess;
    short       fChange;
    short       env[9];
    short (*penvMemSav)[9];
    RTBOF rtbof;
    short ids;

    fSilentSav = fFileErrSilent;
    fSuccess = 0;
    SetSzWorkFromDt(dt & 0xff, iPlayer);
    pasVar3 = penvMem;
    penvMem = &env;
    sVar4 = __setjmp(env);
    if (sVar4 != 0) {
        fFileErrSilent = fSilentSav;
        StreamClose();
        penvMem = pasVar3;
        return 0;
    }
    fFileErrSilent = 1;
    StreamOpen((char *)szWork, 0x12);
    fFileErrSilent = fSilentSav;
    ReadRt();
    if (hdrCur.wFlags >> 10 == 8) {
        if (((uint)rgbCur._8_2_ >> 0xc < 2) || (((uint)rgbCur._8_2_ >> 0xc == 2 && (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x31)))) {
            FileError(idsSorryFileCreatedOlderVersionStarsIncompatible);
            puVar7 = &stack0xffc4;
        } else if (((uint)rgbCur._8_2_ >> 0xc < 3) && (((uint)rgbCur._8_2_ >> 0xc != 2 || (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x54)))) {
            pcVar8 = (char *)rgbCur;
            pRVar9 = &rtbof;
            for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
                pRVar2 = pRVar9;
                pRVar9 = pRVar9->rgid + 2;
                pcVar1 = pcVar8;
                pcVar8 = pcVar8 + 2;
                *pRVar2->rgid = *pcVar1;
            }
            if (((int)game.lid != 0) || (puVar7 = &stack0xffc4, game.lid._2_2_ != 0)) {
                if (((int)rtbof.lidGame == (int)game.lid) && (rtbof.lidGame._2_2_ == game.lid._2_2_)) {
                    fChange = 0;
                    if (mdMark == 1) {
                        bVar10 = (rtbof.wFlags_0xe >> 9 & 1) != f;
                        if (bVar10) {
                            lSeedSav2._2_2_ = f;
                            rtbof.wFlags_0xe = rtbof.wFlags_0xe & 0xfdff | (f & 1U) << 9;
                            fChange = 1;
                        }
                        fChange = (short)bVar10;
                        plVar6 = &stack0xffc4;
                    } else if (mdMark == 2) {
                        bVar10 = (rtbof.wFlags_0xe >> 8 & 1) != f;
                        if (bVar10) {
                            lSeedSav2._2_2_ = f;
                            rtbof.wFlags_0xe = rtbof.wFlags_0xe & 0xfeff | (f & 1U) << 8;
                            fChange = 1;
                        }
                        fChange = (short)bVar10;
                        plVar6 = &stack0xffc4;
                    } else if (mdMark == 4) {
                        bVar10 = (rtbof.wFlags_0xe >> 10 & 1) != f;
                        if (bVar10) {
                            lSeedSav2._2_2_ = f;
                            rtbof.wFlags_0xe = rtbof.wFlags_0xe & 0xfbff | (f & 1U) << 10;
                            fChange = 1;
                        }
                        fChange = (short)bVar10;
                        plVar6 = &stack0xffc4;
                    } else {
                        plVar6 = &stack0xffc4;
                        if (mdMark == 8) {
                            do {
                                do {
                                    GetFileSeeds(&lSeedSav1, &lSeedSav2);
                                    ReadRt();
                                } while (hdrCur.wFlags >> 10 != 6);
                            } while (rgbCur[0] != iPlayer);
                            plVar6 = &stack0xffc4;
                            if (((uint)rgbCur._6_2_ >> 9 & 1) != f) {
                                if (((uint)rgbCur._6_2_ >> 9 & 1) == 0) {
                                    rgbCur._6_2_ = rgbCur._6_2_ & 0x1dff | 0xe200;
                                } else {
                                    puVar7 = &stack0xffc4;
                                    if ((uint)rgbCur._6_2_ >> 0xd != 7)
                                        goto IO_LBadFile_3;
                                    rgbCur._6_2_ = rgbCur._6_2_ & 0xfdff;
                                }
                                rgbCur._12_2_ = ~rgbCur._12_2_;
                                rgbCur._14_2_ = ~rgbCur._14_2_;
                                __lseek(hf, (long)(int)-((hdrCur.wFlags & 0x3ff) + 2), 1);
                                lSeedSav1 = CONCAT22(lSeedSav2._2_2_, (undefined2)lSeedSav2);
                                SetFileSeeds(CONCAT22(lSeedSav2._2_2_, (undefined2)lSeedSav2), lSeedSav1);
                                lSeedSav1 = (long)rgbCur;
                                WriteRt(6, hdrCur.wFlags & 0x3ff, rgbCur);
                                fChange = (uint)(dt == dtTurn);
                                rtbof.wFlags_0xe = rtbof.wFlags_0xe & 0xfeff;
                                plVar6 = &lSeedSav2;
                            }
                        }
                    }
                    if (fChange != 0) {
                        *(short *)((int)plVar6 + -2) = 0;
                        *(short *)((int)plVar6 + -4) = 0;
                        *(short *)((int)plVar6 + -6) = 0;
                        *(short *)((int)plVar6 + -8) = hf;
                        *(short *)((int)plVar6 + -10) = 0x1070;
                        *(short *)((int)plVar6 + -0xc) = 0x9413;
                        __lseek(*(short *)((int)plVar6 + -8), *(long *)((int)plVar6 + -6), *(short *)((int)plVar6 + -2));
                        *(short *)((int)plVar6 + 6) = unaff_SS;
                        *(int *)((int)plVar6 + 4) = (int)&rtbof;
                        *(short *)((int)plVar6 + 2) = 0x10;
                        *(undefined2 *)plVar6 = 8;
                        *(short *)((int)plVar6 + -2) = 0x1118;
                        *(short *)((int)plVar6 + -4) = 0x942a;
                        WriteRt(*(short *)plVar6, *(short *)((int)plVar6 + 2), *(void **)(short *)((int)plVar6 + 4));
                        plVar6 = (long *)((int)plVar6 + 8);
                    }
                    fSuccess = 1;
                    puVar7 = plVar6;
                } else {
                    FileError(idsFileGame);
                    puVar7 = &stack0xffc4;
                }
            }
        } else {
            FileError(idsFileCreatedNewerVersionStarsMustUpgrade);
            puVar7 = &stack0xffc4;
        }
    } else {
        FileError(idsFileDoesBelongVersionStars);
        puVar7 = &stack0xffc4;
    }
IO_LBadFile_3:
    if (((dt & 0x2000) == dtXY) || (fSuccess == 0)) {
        *(undefined2 *)(puVar7 + -2) = 0x1070;
        *(undefined2 *)(puVar7 + -4) = 0x9469;
        StreamClose();
    } else {
        *(undefined2 *)(puVar7 + -2) = 2;
        *(undefined2 *)(puVar7 + -4) = 0;
        *(undefined2 *)(puVar7 + -6) = 0;
        *(short *)(puVar7 + -8) = hf;
        *(undefined2 *)(puVar7 + -10) = 0x1070;
        *(undefined2 *)(puVar7 + -0xc) = 0x945e;
        __lseek(*(short *)(puVar7 + -8), *(long *)(puVar7 + -6), *(short *)(puVar7 + -2));
    }
    penvMem = pasVar3;
    return fSuccess;
}

// ======================================================================
// Function: WriteRt
// Address: 1070:947c
// Segment: MEMORY_IO
// ======================================================================

void WriteRt(short rt, short cb, void *rg)

{
    undefined2 unaff_SS;
    HDR        hdr;

    __fmemmove(rgbCur, rg, cb);
    if (rt == 8) {
        SetFileXorStream(CONCAT22(rgbCur._6_2_, rgbCur._4_2_), (int)rgbCur._12_2_ >> 5, rgbCur._10_2_, (int)(rgbCur._12_2_ << 0xb) >> 0xb,
                         (uint)rgbCur._14_2_ >> 0xc & 1);
    } else if (rt != 0) {
        XorFileBuf((char *)rgbCur, cb);
    }
    hdr.wFlags = cb & 0x3ffU | rt << 10;
    RgToStream(&hdr, 2);
    RgToStream(rgbCur, cb);
    return;
}

// ======================================================================
// Function: RgToStream
// Address: 1070:9554
// Segment: MEMORY_IO
// ======================================================================

void RgToStream(void *rg, ushort cb)

{
    UINT  UVar1;
    char *sz;
    short mbType;

    if ((cb != 0) && (UVar1 = _lwrite(hf, rg, cb), UVar1 != cb)) {
        mbType = 0x10;
        sz = PszFormatIds(idsErrorWritingFile, (short *)0x0);
        AlertSz(sz, mbType);
        _longjmp(penvMem, -1);
    }
    return;
}

// ======================================================================
// Function: SetVisiblePlanFleet
// Address: 1070:95bc
// Segment: MEMORY_IO
// ======================================================================

void SetVisiblePlanFleet(short iPlr)

{
    SetVisPFInit(iPlr);
    if (iPlr == -1) {
        rgplr[0].cPlanet = game.cPlanMax;
    } else {
        if (iPlr != -1) {
            UpdateProgressGauge(-0x39f);
        }
        SetVisPFFleets(iPlr);
        if (iPlr != -1) {
            UpdateProgressGauge(-0x39f);
        }
        SetVisPFPlanets(iPlr);
        if (iPlr != -1) {
            UpdateProgressGauge(-0x39f);
        }
        SetVisPFThings(iPlr);
        SetVisPFFinish(iPlr);
    }
    return;
}

// ======================================================================
// Function: SetVisPFInit
// Address: 1070:9654
// Segment: MEMORY_IO
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10709e11) */

void SetVisPFInit(short iPlr)

{
    char      *pcVar1;
    uint      *puVar2;
    int       *piVar3;
    uint       uVar4;
    FLEET     *pFVar5;
    uint       uVar6;
    PLORD     *pPVar7;
    short      sVar8;
    THING     *pTVar9;
    int        iVar10;
    int        iVar11;
    undefined2 uVar12;
    long       lVar13;
    short      iSteal;
    ushort     grbitPlr;
    short      raMajor;
    THING     *lpthMac;
    short      i;
    short      ifl;
    THING     *lpth;
    FLEET     *lpfl;
    short      j;
    PLANET    *lppl;
    ushort     detNew;
    PLANET    *lpplMac;

    raMajor = GetRaceStat((PLAYER *)rgplr + iPlr, rsMajorAdv);
    if (iPlr == -1) {
        grbitPlr = 0;
    } else {
        grbitPlr = 1 << ((byte)iPlr & 0x1f);
    }
    for (i = 0; i < game.cPlayer; i = i + 1) {
        *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
    }
    for (i = 0; i < game.cPlayer; i = i + 1) {
        if (((iPlr == -1) || (iPlr == i)) || ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0)) {
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 7;
        } else {
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff;
        }
        *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) = *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xf000;
        *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
        *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) = *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xfff;
        for (j = 0; j < 0x10; j = j + 1) {
            if (((iPlr == -1) || (iPlr == i)) && ((*(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) >> 9 & 1) == 0)) {
                *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) = *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
                *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) = *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xff00 | 7;
                uVar12 = *(undefined2 *)(i * 4 + rglpshdef_0x2);
                iVar10 = *(int *)(i * 4 + rglpshdef) + j * 0x93;
                *(undefined2 *)(iVar10 + 0x83) = 0;
                *(undefined2 *)(iVar10 + 0x85) = 0;
                pcVar1 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
                *pcVar1 = *pcVar1 + '\x01';
            } else {
                *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) = *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xfeff;
            }
        }
        for (j = 0; j < 10; j = j + 1) {
            if (((iPlr == -1) || (iPlr == i)) && ((*(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) >> 9 & 1) == 0)) {
                *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) = *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
                *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) = *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xff00 | 7;
                uVar12 = *(undefined2 *)(i * 4 + rglpshdefSB_0x2);
                iVar10 = *(int *)(i * 4 + rglpshdefSB) + j * 0x93;
                *(undefined2 *)(iVar10 + 0x83) = 0;
                *(undefined2 *)(iVar10 + 0x85) = 0;
                iVar10 = *(int *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
                puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
                *puVar2 = *puVar2 & 0xfff;
                puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
                *puVar2 = *puVar2 | iVar10 + 0x1000U & 0xf000;
            } else {
                *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) = *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xfeff;
            }
        }
    }
    lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
    lpplMac._2_2_ = lpPlanets._2_2_;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
    while ((PLANET *)lppl < (PLANET *)lpplMac) {
        if ((iPlr == -1) || (iPlr == ((PLANET *)lppl)->iPlayer)) {
            ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfeff | 0x100;
            ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xff00 | 7;
            if (iPlr != -1) {
                piVar3 = (int *)((int)&rgplr[0].cPlanet + iPlr * 0xc0);
                *piVar3 = *piVar3 + 1;
            }
            if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) {
                iVar10 = ((PLANET *)lppl)->iPlayer * 4;
                uVar12 = *(undefined2 *)(iVar10 + rglpshdefSB_0x2);
                iVar10 = *(int *)(iVar10 + rglpshdefSB) + (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93;
                puVar2 = (uint *)(iVar10 + 0x83);
                uVar4 = *puVar2;
                *puVar2 = *puVar2 + 1;
                piVar3 = (int *)(iVar10 + 0x85);
                *piVar3 = *piVar3 + (uint)(0xfffe < uVar4);
            }
        } else {
            ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfeff;
        }
        lppl = (PLANET *)lppl + 1;
    }
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
        /* WARNING: Load size is inaccurate */
        pFVar5 = ((FLEET **)rglpfl)[ifl];
        iVar10 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar10, pFVar5);
        if ((pFVar5 == (FLEET *)0x0) && (iVar10 == 0))
            break;
        *(uint *)((int)&pFVar5->dirLong + 2) = *(uint *)((int)&pFVar5->dirLong + 2) & 0xffef;
        pFVar5->wFlags_0x4 = pFVar5->wFlags_0x4 & 0x7fff;
        if (((iPlr == -1) || (iPlr == pFVar5->iPlayer)) && ((pFVar5->wFlags_0x4 >> 10 & 1) == 0)) {
            pFVar5->wFlags_0x4 = pFVar5->wFlags_0x4 & 0xfeff | 0x100;
            pFVar5->wFlags_0x4 = pFVar5->wFlags_0x4 & 0xff00 | 7;
            iSteal = *(int *)((int)&rgplr[0].wFlags_0x4 + pFVar5->iPlayer * 0xc0) + 1U & 0xfff;
            puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar5->iPlayer * 0xc0);
            *puVar2 = *puVar2 & 0xf000;
            puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + pFVar5->iPlayer * 0xc0);
            *puVar2 = *puVar2 | iSteal;
            for (j = 0; j < 0x10; j = j + 1) {
                if (pFVar5->rgcsh[j] != 0) {
                    uVar6 = pFVar5->rgcsh[j];
                    iSteal = (int)uVar6 >> 0xf;
                    iVar11 = pFVar5->iPlayer * 4;
                    uVar12 = *(undefined2 *)(iVar11 + rglpshdef_0x2);
                    iVar11 = *(int *)(iVar11 + rglpshdef) + j * 0x93;
                    puVar2 = (uint *)(iVar11 + 0x83);
                    uVar4 = *puVar2;
                    *puVar2 = *puVar2 + uVar6;
                    piVar3 = (int *)(iVar11 + 0x85);
                    *piVar3 = *piVar3 + iSteal + (uint)CARRY2(uVar4, uVar6);
                }
            }
            if ((iPlr != -1) && (pFVar5->idPlanet != -1)) {
                lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets + pFVar5->idPlanet);
                sVar8 = GetCachedFleetScannerRange((FLEET *)CONCAT22(iVar10, pFVar5), (short *)0x0, (short *)0x0, &iSteal);
                if (sVar8 < 0) {
                    detNew = 1;
                } else {
                    detNew = 3;
                }
                if (1 < iSteal) {
                    detNew = 4;
                }
                uVar12 = (undefined2)((ulong)lpfl >> 0x10);
                if (((((((FLEET *)lpfl)->wFlags_0x4 >> 0xd & 1) != 0) && (((PLANET *)lppl)->iPlayer == -1)) &&
                     (pPVar7 = ((FLEET *)lpfl)->lpplord, (*(uint *)&((PLORD *)pPVar7)[2].iordMax & 0xf) == 3)) &&
                    (lVar13 = CMineFromLpfl(lpfl), 0 < lVar13)) {
                    detNew = 4;
                }
                MarkPlanet(lppl, iPlr, detNew);
            }
        } else {
            pFVar5->wFlags_0x4 = pFVar5->wFlags_0x4 & 0xfeff;
        }
    }
    pTVar9 = (THING *)lpThings + cThing;
    lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
    while ((THING *)lpth < pTVar9) {
        if (lpth->idFull >> 0xd == 1) {
            if ((iPlr == -1) || (raMajor == 6)) {
                ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0x7fff | 0x8000;
                if ((*(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1) == 0) {
                    *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
                        *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfeff | 0x100;
                    *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
                        *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 | 3;
                }
            } else {
                ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0x7fff;
            }
        } else if (lpth->idFull >> 0xd == 2) {
            ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0xdfff | (uint)(iPlr == -1) << 0xd;
        } else if (lpth->idFull >> 0xd == 3) {
            *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) = *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) & 0xffef | 0x10;
        } else if (((lpth->idFull >> 0xd == 0) && ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) & grbitPlr) != 0)) &&
                   ((*(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1) == 0)) {
            *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
                *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfeff | 0x100;
            *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
                *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 | 3;
        }
        lpth = (THING *)lpth + 1;
    }
    return;
}

// ======================================================================
// Function: SetVisPFFleets
// Address: 1070:a100
// Segment: MEMORY_IO
// ======================================================================

/* WARNING: Variable defined which should be unmapped: lVis2 */
/* WARNING: Removing unreachable block (ram,0x1070a8f0) */
/* WARNING: Removing unreachable block (ram,0x1070a90b) */
/* WARNING: Removing unreachable block (ram,0x1070aae0) */
/* WARNING: Removing unreachable block (ram,0x1070a412) */
/* WARNING: Removing unreachable block (ram,0x1070a711) */
/* WARNING: Removing unreachable block (ram,0x1070a4d8) */
/* WARNING: Removing unreachable block (ram,0x1070ab87) */
/* WARNING: Removing unreachable block (ram,0x1070a43a) */
/* WARNING: Removing unreachable block (ram,0x1070a53c) */
/* WARNING: Removing unreachable block (ram,0x1070a92e) */
/* WARNING: Removing unreachable block (ram,0x1070a94e) */
/* WARNING: Removing unreachable block (ram,0x1070a887) */
/* WARNING: Removing unreachable block (ram,0x1070a8a2) */

void SetVisPFFleets(short iPlr)

{
    uint      *puVar1;
    FLEET     *pFVar2;
    uint       uVar3;
    PLANET    *pPVar4;
    int        iVar5;
    THING     *pTVar6;
    PLANET    *pPVar7;
    int        iVar8;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar9;
    ulong      uVar10;
    ulong      uVar11;
    long       lVar12;
    long       lVar13;
    undefined2 uVar14;
    undefined2 uVar15;
    undefined2 uVar16;
    long       lVar17;
    long       lVis2;
    long       l;
    short      pctDetect;
    short      iSteal;
    short      iRadPlanet;
    long       lRadPlanet2;
    ushort     grbitPlr;
    short      dx;
    short      iRadius;
    THING     *lpthMac;
    short      ifl;
    long       lRadius2;
    THING     *lpth;
    FLEET     *lpfl;
    short      j;
    PLANET    *lppl;
    long       d2;
    FLEET     *lpfl2;
    short      dy;
    short      pctCloak;
    POINT      pt;
    PLANET    *lpplMac;

    uVar10 = CONCAT22(lRadPlanet2._2_2_, (undefined2)lRadPlanet2);
    uVar11 = CONCAT22(lRadius2._2_2_, (undefined2)lRadius2);
    lVar17 = CONCAT22(unaff_SI, unaff_DI);
    if (iPlr == -1) {
        grbitPlr = 0;
    } else {
        grbitPlr = 1 << ((byte)iPlr & 0x1f);
    }
    ifl = 0;
    do {
        if (cFleet <= ifl) {
            return;
        }
        /* WARNING: Load size is inaccurate */
        pFVar2 = ((FLEET **)rglpfl)[ifl];
        iVar8 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar8, pFVar2);
        if ((pFVar2 == (FLEET *)0x0) && (iVar8 == 0)) {
            return;
        }
        if ((pFVar2->wFlags_0x4 >> 10 & 1) == 0) {
            lRadius2 = uVar11;
            lRadPlanet2 = uVar10;
            if (pFVar2->iPlayer == iPlr) {
                if (((pFVar2->wFlags_0x4 >> 0xc & 1) != 0) && (pFVar2->idPlanet != -1)) {
                    MarkPlanet((PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets + pFVar2->idPlanet), iPlr, 3);
                    uVar11 = lRadius2;
                    uVar10 = lRadPlanet2;
                }
                lRadius2 = uVar11;
                lRadPlanet2 = uVar10;
                iRadius = GetCachedFleetScannerRange(lpfl, &iRadPlanet, &pctDetect, &iSteal);
                if (0x7fff < (uint)iRadius) {
                    iRadius = 0;
                }
                uVar10 = __aFulmul((long)iRadius, (long)iRadius);
                lRadius2 = uVar10;
                uVar10 = __aFulmul((long)iRadPlanet, (long)iRadPlanet);
                uVar9 = (undefined2)((ulong)lpfl >> 0x10);
                pt.x = (&((FLEET *)lpfl)->pt)->x;
                pt.y = (((FLEET *)lpfl)->pt).y;
                for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
                    pFVar2 = ((FLEET **)rglpfl)[j];
                    iVar8 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
                    lpfl2 = (FLEET *)CONCAT22(iVar8, pFVar2);
                    if ((pFVar2 == (FLEET *)0x0) && (iVar8 == 0))
                        break;
                    if ((pFVar2->wFlags_0x4 >> 10 & 1) == 0) {
                        if (((((iSteal & 1U) != 0) && (pt.x == (&pFVar2->pt)->x)) && (pt.y == (pFVar2->pt).y)) &&
                            (((pFVar2->wFlags_0x4 >> 8 & 1) == 0 || ((pFVar2->wFlags_0x4 & 0xff) < 4)))) {
                            lRadPlanet2 = uVar10;
                            MarkFleet((FLEET *)CONCAT22(iVar8, pFVar2), 4);
                            uVar10 = lRadPlanet2;
                        }
                        uVar9 = (undefined2)((ulong)lpfl2 >> 0x10);
                        if ((((FLEET *)lpfl2)->wFlags_0x4 >> 8 & 1) == 0) {
                            lRadPlanet2 = uVar10;
                            dx = _abs(pt.x - (&((FLEET *)lpfl2)->pt)->x);
                            uVar10 = lRadPlanet2;
                            if (dx <= iRadius) {
                                dy = _abs(pt.y - (((FLEET *)lpfl2)->pt).y);
                                uVar10 = lRadPlanet2;
                                if (dy <= iRadius) {
                                    uVar10 = __aFulmul((long)dy, (long)dy);
                                    uVar11 = __aFulmul((long)dx, (long)dx);
                                    lVar13 = uVar11 + uVar10;
                                    uVar10 = lRadPlanet2;
                                    if ((lVar13 <= lRadius2) && ((((FLEET *)lpfl2)->idPlanet == -1 || (lVar13 <= lRadPlanet2)))) {
                                        pctCloak = PctCloakFromLpfl(lpfl2);
                                        if (pctDetect != 100) {
                                            pctCloak = (pctCloak * pctDetect) / 100;
                                        }
                                        if (pctCloak == 0) {
                                            MarkFleet(lpfl2, 3);
                                            uVar10 = lRadPlanet2;
                                        } else {
                                            uVar15 = 0;
                                            uVar14 = 100;
                                            iVar8 = 100 - pctCloak;
                                            iVar5 = iVar8 >> 0xf;
                                            uVar16 = 0;
                                            uVar9 = 100;
                                            uVar10 = __aFulmul(lRadius2, (long)(100 - pctCloak));
                                            uVar10 = __aFldiv(uVar10, CONCAT22(uVar16, uVar9));
                                            uVar10 = __aFulmul(uVar10, CONCAT22(iVar5, iVar8));
                                            lVar12 = __aFldiv(uVar10, CONCAT22(uVar15, uVar14));
                                            uVar10 = lRadPlanet2;
                                            if (lVar13 <= lVar12) {
                                                if (((FLEET *)lpfl2)->idPlanet != -1) {
                                                    uVar15 = 0;
                                                    uVar14 = 100;
                                                    iVar8 = 100 - pctCloak;
                                                    iVar5 = iVar8 >> 0xf;
                                                    uVar16 = 0;
                                                    uVar9 = 100;
                                                    uVar10 = __aFulmul(lRadPlanet2, (long)(100 - pctCloak));
                                                    uVar10 = __aFldiv(uVar10, CONCAT22(uVar16, uVar9));
                                                    uVar10 = __aFulmul(uVar10, CONCAT22(iVar5, iVar8));
                                                    lVar12 = __aFldiv(uVar10, CONCAT22(uVar15, uVar14));
                                                    uVar10 = lRadPlanet2;
                                                    if (lVar12 < lVar13)
                                                        goto LAB_1070_a2b2;
                                                }
                                                MarkFleet(lpfl2, 3);
                                                uVar10 = lRadPlanet2;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                LAB_1070_a2b2:
                }
                lpthMac._0_2_ = (THING *)lpThings + cThing;
                lpthMac._2_2_ = lpThings._2_2_;
                lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
                while (lRadPlanet2 = uVar10, (THING *)lpth < (THING *)lpthMac) {
                    if ((((iPlr != -1) &&
                          ((((lpth->idFull >> 0xd == 0 || (lpth->idFull >> 0xd == 1)) || (lpth->idFull >> 0xd == 3)) || (lpth->idFull >> 0xd == 2)))) &&
                         ((((uVar9 = (undefined2)((ulong)lpth >> 0x10),
                             lpth->idFull >> 0xd != 0 || ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) & grbitPlr) == 0)) &&
                            ((lpth->idFull >> 0xd != 3 || ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) >> 4 & 1) == 0)))) &&
                           ((lpth->idFull >> 0xd != 1 || (-1 < ((&((THING *)lpth)->u_THING_0x0006)->tht).ptDest.x)))))) &&
                        ((lpth->idFull >> 0xd != 2 || ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 0xd & 1) == 0)))) {
                        dx = _abs(pt.x - (&((THING *)lpth)->pt)->x);
                        dy = _abs(pt.y - (((THING *)lpth)->pt).y);
                        uVar10 = __aFulmul((long)dy, (long)dy);
                        uVar11 = __aFulmul((long)dx, (long)dx);
                        lVis2._0_2_ = (ushort)uVar10;
                        lVar13 = uVar11 + uVar10;
                        uVar10 = lRadPlanet2;
                        if ((lVar13 <= lRadius2) || (lpth->idFull >> 0xd == 0)) {
                            pTVar6 = (THING *)lpth;
                            uVar9 = (undefined2)((ulong)lpth >> 0x10);
                            if (lpth->idFull >> 0xd == 1) {
                                ((&pTVar6->u_THING_0x0006)->thp).wFlags = ((&pTVar6->u_THING_0x0006)->thp).wFlags & 0x7fff | 0x8000;
                            IO_LThIncPlr:
                                uVar10 = lRadPlanet2;
                                if ((*(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1) == 0) {
                                    *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
                                        *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfeff | 0x100;
                                    *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
                                        *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 | 3;
                                }
                            } else if (lpth->idFull >> 0xd == 3) {
                                *(uint *)((int)&pTVar6->u_THING_0x0006 + 4) = *(uint *)((int)&pTVar6->u_THING_0x0006 + 4) & 0xffef | 0x10;
                            } else {
                                if (lpth->idFull >> 0xd != 2) {
                                    if ((((*(uint *)((int)&pTVar6->u_THING_0x0006 + 4) & grbitPlr) == 0) || (lRadius2 < lVar13)) && (lRadPlanet2 < lVar13)) {
                                        lVar12 = __aFlshr(lVar17, (ushort)lVis2);
                                        if ((lVar12 < lVar13) && (uVar9 = (undefined2)((ulong)lpth >> 0x10), uVar10 = lRadPlanet2,
                                                                  CONCAT22(*(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2),
                                                                           ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags) < lVar13))
                                            goto LAB_1070_a96d;
                                    }
                                    uVar9 = (undefined2)((ulong)lpth >> 0x10);
                                    puVar1 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4);
                                    *puVar1 = *puVar1 | grbitPlr;
                                    puVar1 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8);
                                    *puVar1 = *puVar1 | grbitPlr;
                                    goto IO_LThIncPlr;
                                }
                                if ((*(uint *)((int)&pTVar6->u_THING_0x0006 + 2) & grbitPlr) == 0) {
                                    lVar12 = __aFlshr(lVar17, (ushort)lVis2);
                                    if ((lVar12 < lVar13) && (uVar10 = lRadPlanet2, lRadPlanet2 < lVar13))
                                        goto LAB_1070_a96d;
                                }
                                uVar9 = (undefined2)((ulong)lpth >> 0x10);
                                pTVar6 = (THING *)lpth;
                                puVar1 = (uint *)((int)&pTVar6->u_THING_0x0006 + 2);
                                *puVar1 = *puVar1 | grbitPlr;
                                ((&pTVar6->u_THING_0x0006)->thp).wFlags = ((&pTVar6->u_THING_0x0006)->thp).wFlags & 0xdfff | 0x2000;
                                uVar10 = lRadPlanet2;
                            }
                        }
                    }
                LAB_1070_a96d:
                    lpth = (THING *)lpth + 1;
                }
                uVar11 = lRadius2;
                if ((iSteal & 2U) != 0) {
                    uVar9 = (undefined2)((ulong)lpfl >> 0x10);
                    if (((FLEET *)lpfl)->idPlanet != -1) {
                        MarkPlanet((PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets + ((FLEET *)lpfl)->idPlanet), iPlr, 4);
                        uVar10 = lRadPlanet2;
                        uVar11 = lRadius2;
                    }
                }
                if (0 < iRadPlanet) {
                    iRadius = iRadPlanet;
                    lRadPlanet2 = uVar10;
                    lRadius2 = uVar11;
                    uVar11 = __aFulmul((long)iRadPlanet, (long)iRadPlanet);
                    uVar9 = (undefined2)((ulong)lpfl >> 0x10);
                    pt.x = (&((FLEET *)lpfl)->pt)->x;
                    pt.y = (((FLEET *)lpfl)->pt).y;
                    pPVar4 = (PLANET *)lpPlanets + cPlanet;
                    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
                    while (uVar10 = lRadPlanet2, (PLANET *)lppl < pPVar4) {
                        uVar9 = (undefined2)((ulong)lppl >> 0x10);
                        if (((((PLANET *)lppl)->wFlags_0x4 >> 8 & 1) == 0) || ((((PLANET *)lppl)->wFlags_0x4 & 0xff) < 3)) {
                            lRadius2 = uVar11;
                            dx = _abs(((POINT *)rgptPlan + lppl->id)->x - pt.x);
                            uVar11 = lRadius2;
                            if (dx <= iRadius) {
                                dy = _abs(*(int *)((int)&rgptPlan[0].y + lppl->id * 4) - pt.y);
                                uVar11 = lRadius2;
                                if (dy <= iRadius) {
                                    uVar10 = __aFulmul((long)dy, (long)dy);
                                    uVar11 = __aFulmul((long)dx, (long)dx);
                                    d2 = uVar11 + uVar10;
                                    uVar11 = lRadius2;
                                    if (d2 <= lRadius2) {
                                        uVar9 = (undefined2)((ulong)lppl >> 0x10);
                                        pPVar7 = (PLANET *)lppl;
                                        if (((pPVar7->wFlags_0x4 >> 9 & 1) != 0) && (pPVar7->iPlayer != -1)) {
                                            iVar8 = pPVar7->iPlayer * 4;
                                            uVar16 = *(undefined2 *)(iVar8 + rglpshdefSB_0x2);
                                            iVar8 = *(int *)(iVar8 + rglpshdefSB) + (*(uint *)&pPVar7->lStarbase & 0xf) * 0x93;
                                            uVar3 = *(uint *)(iVar8 + 0x87);
                                            iVar8 = *(int *)(iVar8 + 0x89);
                                            if ((iVar8 < 1) && ((iVar8 < 0 || (uVar3 < 10000)))) {
                                                uVar16 = 0;
                                                uVar9 = 10000;
                                                uVar10 = __aFulmul(lRadius2, CONCAT22(iVar8, uVar3));
                                                lVar13 = __aFldiv(uVar10, CONCAT22(uVar16, uVar9));
                                                if (lVar13 < d2) {
                                                    MarkPlanet(lppl, iPlr, 2);
                                                    uVar11 = lRadius2;
                                                    goto LAB_1070_abc2;
                                                }
                                            }
                                        }
                                        MarkPlanet(lppl, iPlr, 3);
                                        uVar11 = lRadius2;
                                    }
                                }
                            }
                        }
                    LAB_1070_abc2:
                        lppl = (PLANET *)lppl + 1;
                    }
                }
            } else if ((((pFVar2->wFlags_0x4 >> 8 & 1) == 0) && (pFVar2->idPlanet != -1)) && (((PLANET *)lpPlanets)[pFVar2->idPlanet].iPlayer == iPlr)) {
                MarkFleet((FLEET *)CONCAT22(iVar8, pFVar2), 3);
                uVar11 = lRadius2;
                uVar10 = lRadPlanet2;
            }
        }
        ifl = ifl + 1;
    } while (true);
}

// ======================================================================
// Function: SetVisPFPlanets
// Address: 1070:abde
// Segment: MEMORY_IO
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x1070b8e2) */
/* WARNING: Removing unreachable block (ram,0x1070b66c) */
/* WARNING: Removing unreachable block (ram,0x1070b35e) */
/* WARNING: Removing unreachable block (ram,0x1070b3c7) */
/* WARNING: Removing unreachable block (ram,0x1070b1fe) */
/* WARNING: Removing unreachable block (ram,0x1070b3ea) */
/* WARNING: Removing unreachable block (ram,0x1070b379) */
/* WARNING: Removing unreachable block (ram,0x1070b6ef) */
/* WARNING: Removing unreachable block (ram,0x1070b989) */
/* WARNING: Removing unreachable block (ram,0x1070ae4e) */
/* WARNING: Removing unreachable block (ram,0x1070ae76) */
/* WARNING: Removing unreachable block (ram,0x1070aefc) */
/* WARNING: Removing unreachable block (ram,0x1070af60) */

void SetVisPFPlanets(short iPlr)

{
    uint      *puVar1;
    int        iVar2;
    int        iVar3;
    FLEET     *pFVar4;
    bool       bVar5;
    uint       uVar6;
    short      sVar7;
    short      sVar8;
    short      sVar9;
    int        iVar10;
    ushort     uVar11;
    PLANET    *pPVar12;
    THING     *pTVar13;
    PLANET    *pPVar14;
    int        iVar15;
    int        iVar16;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar17;
    ulong      uVar18;
    ulong      uVar19;
    ulong      uVar20;
    long       lVar21;
    long       lVar22;
    undefined2 uVar23;
    undefined2 uVar24;
    undefined2 uVar25;
    long       lVar26;
    short      rgStargateRange[16];
    ushort     grbitPlr;
    PLANET    *lpplMac2;
    long       l;
    short      dx;
    short      fStargateView;
    short      iRadius;
    THING     *lpthMac;
    short      i;
    long       lRadius2;
    THING     *lpth;
    short      j;
    PLANET    *lppl;
    long       d2;
    FLEET     *lpfl2;
    short      dy;
    PLANET    *lppl2;
    short      pctCloak;
    POINT      pt;
    PLANET    *lpplMac;
    short      iRadPlanet;
    long       lRadPlanet2;

    lVar26 = CONCAT22(unaff_SI, unaff_DI);
    if (iPlr == -1) {
        uVar6 = 0;
    } else {
        uVar6 = 1 << ((byte)iPlr & 0x1f);
    }
    bVar5 = false;
    sVar7 = GetRaceStat((PLAYER *)rgplr + iPlr, rsMajorAdv);
    if (sVar7 == raStargate) {
        for (i = 0; i < 10; i = i + 1) {
            rgStargateRange[i] = 0;
            if ((*(uint *)(*(int *)(iPlr * 4 + rglpshdefSB) + i * 0x93 + 0x7b) >> 9 & 1) == 0) {
                sVar7 = StargateRangeFromLppl((PLANET *)0x0, iPlr, i);
                rgStargateRange[i] = sVar7;
                if (0 < sVar7) {
                    bVar5 = true;
                }
            }
        }
    }
    if (iPlr != -1) {
        UpdateProgressGauge(-0x39f);
    }
    uVar19 = CONCAT22(lRadPlanet2._2_2_, (undefined2)lRadPlanet2);
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
    pPVar12 = (PLANET *)lpPlanets + cPlanet;
    do {
        lRadPlanet2 = uVar19;
        if (pPVar12 <= (PLANET *)lppl) {
            if (iPlr != -1) {
                UpdateProgressGauge(-0x39f);
                uVar19 = lRadPlanet2;
            }
            lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
            pPVar12 = (PLANET *)lpPlanets + cPlanet;
            do {
                lRadPlanet2 = uVar19;
                if (pPVar12 <= (PLANET *)lppl) {
                    if (iPlr != -1) {
                        UpdateProgressGauge(-0x39f);
                        uVar19 = lRadPlanet2;
                    }
                    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
                    pPVar12 = (PLANET *)lpPlanets + cPlanet;
                    do {
                        lRadPlanet2 = uVar19;
                        if (pPVar12 <= (PLANET *)lppl) {
                            if (iPlr != -1) {
                                UpdateProgressGauge(-0x39f);
                                uVar19 = lRadPlanet2;
                            }
                            lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
                            pPVar12 = (PLANET *)lpPlanets + cPlanet;
                            do {
                                if (pPVar12 <= (PLANET *)lppl) {
                                    return;
                                }
                                uVar17 = (undefined2)((ulong)lppl >> 0x10);
                                if (((PLANET *)lppl)->iPlayer == iPlr) {
                                    lRadPlanet2 = uVar19;
                                    sVar7 = GetPlanetScannerRange(lppl, &iRadPlanet);
                                    __aFulmul((long)sVar7, (long)sVar7);
                                    uVar18 = __aFulmul((long)iRadPlanet, (long)iRadPlanet);
                                    sVar7 = iRadPlanet;
                                    iVar2 = ((POINT *)rgptPlan + lppl->id)->x;
                                    iVar3 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
                                    uVar19 = uVar18;
                                    if (0 < iRadPlanet) {
                                        pPVar14 = (PLANET *)lpPlanets + cPlanet;
                                        lppl2 = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
                                        lRadPlanet2 = uVar18;
                                        while (uVar19 = lRadPlanet2, (PLANET *)lppl2 < pPVar14) {
                                            uVar23 = (undefined2)((ulong)lppl2 >> 0x10);
                                            if (((((PLANET *)lppl2)->wFlags_0x4 >> 8 & 1) == 0) || ((((PLANET *)lppl2)->wFlags_0x4 & 0xff) < 3)) {
                                                sVar8 = _abs(((POINT *)rgptPlan + lppl2->id)->x - iVar2);
                                                if (sVar8 <= sVar7) {
                                                    sVar9 = _abs(*(int *)((int)&rgptPlan[0].y + lppl2->id * 4) - iVar3);
                                                    if (sVar9 <= sVar7) {
                                                        uVar19 = __aFulmul((long)sVar9, (long)sVar9);
                                                        uVar24 = (undefined2)uVar19;
                                                        uVar20 = __aFulmul((long)sVar8, (long)sVar8);
                                                        lVar26 = uVar20 + CONCAT22((int)(uVar19 >> 0x10), uVar24);
                                                        if (lVar26 <= (long)uVar18) {
                                                            if (((((PLANET *)lppl2)->wFlags_0x4 >> 9 & 1) != 0) && (((PLANET *)lppl2)->iPlayer != -1)) {
                                                                iVar16 = ((PLANET *)lppl2)->iPlayer * 4;
                                                                uVar24 = *(undefined2 *)(iVar16 + rglpshdefSB_0x2);
                                                                iVar16 = *(int *)(iVar16 + rglpshdefSB) + (*(uint *)&((PLANET *)lppl2)->lStarbase & 0xf) * 0x93;
                                                                uVar6 = *(uint *)(iVar16 + 0x87);
                                                                iVar16 = *(int *)(iVar16 + 0x89);
                                                                if ((iVar16 < 1) && ((iVar16 < 0 || (uVar6 < 10000)))) {
                                                                    uVar25 = 0;
                                                                    uVar24 = 10000;
                                                                    uVar19 = __aFulmul(uVar18, CONCAT22(iVar16, uVar6));
                                                                    lVar22 = __aFldiv(uVar19, CONCAT22(uVar25, uVar24));
                                                                    if (lVar22 < lVar26) {
                                                                        MarkPlanet(lppl2, iPlr, 2);
                                                                        goto LAB_1070_b9c4;
                                                                    }
                                                                }
                                                            }
                                                            MarkPlanet(lppl2, iPlr, 3);
                                                        }
                                                    }
                                                }
                                            }
                                        LAB_1070_b9c4:
                                            lppl2 = (PLANET *)CONCAT22(uVar23, (PLANET *)lppl2 + 1);
                                        }
                                    }
                                }
                                lppl = (PLANET *)CONCAT22(uVar17, (PLANET *)lppl + 1);
                            } while (true);
                        }
                        uVar17 = (undefined2)((ulong)lppl >> 0x10);
                        if (((PLANET *)lppl)->iPlayer == iPlr) {
                            sVar7 = GetPlanetScannerRange(lppl, &iRadPlanet);
                            __aFulmul((long)sVar7, (long)sVar7);
                            uVar19 = __aFulmul((long)iRadPlanet, (long)iRadPlanet);
                            lRadPlanet2 = uVar19;
                            iVar2 = ((POINT *)rgptPlan + lppl->id)->x;
                            iVar3 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
                            if (((bVar5) && ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0)) &&
                                (0 < rgStargateRange[*(uint *)&((PLANET *)lppl)->lStarbase & 0xf])) {
                                iVar16 = rgStargateRange[*(uint *)&((PLANET *)lppl)->lStarbase & 0xf];
                                uVar18 = __aFulmul((long)iVar16, (long)iVar16);
                                pPVar14 = (PLANET *)lpPlanets + cPlanet;
                                lppl2 = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
                                uVar19 = lRadPlanet2;
                                while ((PLANET *)lppl2 < pPVar14) {
                                    uVar23 = (undefined2)((ulong)lppl2 >> 0x10);
                                    if ((((((PLANET *)lppl2)->wFlags_0x4 >> 8 & 1) == 0) || ((((PLANET *)lppl2)->wFlags_0x4 & 0xff) < 3)) &&
                                        ((((PLANET *)lppl2)->wFlags_0x4 >> 9 & 1) != 0)) {
                                        lRadPlanet2 = uVar19;
                                        sVar7 = StargateRangeFromLppl(lppl2, 0, 0);
                                        uVar19 = lRadPlanet2;
                                        if (sVar7 != 0) {
                                            if (9999 < iVar16)
                                                goto IO_LMarkStargate;
                                            sVar7 = _abs(((POINT *)rgptPlan + lppl2->id)->x - iVar2);
                                            uVar19 = lRadPlanet2;
                                            if (sVar7 <= iVar16) {
                                                sVar8 = _abs(*(int *)((int)&rgptPlan[0].y + lppl2->id * 4) - iVar3);
                                                uVar19 = lRadPlanet2;
                                                if (sVar8 <= iVar16) {
                                                    uVar19 = __aFulmul((long)sVar8, (long)sVar8);
                                                    uVar24 = (undefined2)uVar19;
                                                    uVar20 = __aFulmul((long)sVar7, (long)sVar7);
                                                    lVar26 = uVar20 + CONCAT22((int)(uVar19 >> 0x10), uVar24);
                                                    uVar19 = lRadPlanet2;
                                                    if (lVar26 <= (long)uVar18) {
                                                        iVar10 = ((PLANET *)lppl2)->iPlayer * 4;
                                                        uVar24 = *(undefined2 *)(iVar10 + rglpshdefSB_0x2);
                                                        iVar10 = *(int *)(iVar10 + rglpshdefSB) + (*(uint *)&((PLANET *)lppl2)->lStarbase & 0xf) * 0x93;
                                                        uVar6 = *(uint *)(iVar10 + 0x87);
                                                        iVar10 = *(int *)(iVar10 + 0x89);
                                                        if ((iVar10 < 1) && ((iVar10 < 0 || (uVar6 < 10000)))) {
                                                            uVar25 = 0;
                                                            uVar24 = 10000;
                                                            uVar19 = __aFulmul(uVar18, CONCAT22(iVar10, uVar6));
                                                            lVar22 = __aFldiv(uVar19, CONCAT22(uVar25, uVar24));
                                                            uVar19 = lRadPlanet2;
                                                            if (lVar22 < lVar26)
                                                                goto LAB_1070_b70c;
                                                        }
                                                    IO_LMarkStargate:
                                                        MarkPlanet(lppl2, iPlr, 3);
                                                        uVar19 = lRadPlanet2;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                LAB_1070_b70c:
                                    lppl2 = (PLANET *)CONCAT22(uVar23, (PLANET *)lppl2 + 1);
                                }
                            }
                        }
                        lppl = (PLANET *)CONCAT22(uVar17, (PLANET *)lppl + 1);
                    } while (true);
                }
                uVar17 = (undefined2)((ulong)lppl >> 0x10);
                if (((PLANET *)lppl)->iPlayer == iPlr) {
                    sVar7 = GetPlanetScannerRange(lppl, &iRadPlanet);
                    uVar18 = __aFulmul((long)sVar7, (long)sVar7);
                    uVar19 = __aFulmul((long)iRadPlanet, (long)iRadPlanet);
                    iVar2 = ((POINT *)rgptPlan + lppl->id)->x;
                    iVar3 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
                    pTVar13 = (THING *)lpThings + cThing;
                    lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
                    while ((THING *)lpth < pTVar13) {
                        uVar23 = (undefined2)((ulong)lpth >> 0x10);
                        if (((((iPlr != -1) &&
                               ((((lpth->idFull >> 0xd == 0 || (lpth->idFull >> 0xd == 1)) || (lpth->idFull >> 0xd == 3)) || (lpth->idFull >> 0xd == 2)))) &&
                              ((lpth->idFull >> 0xd != 0 || ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) & uVar6) == 0)))) &&
                             ((lpth->idFull >> 0xd != 3 || ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) >> 4 & 1) == 0)))) &&
                            (((lpth->idFull >> 0xd != 1 || (-1 < ((&((THING *)lpth)->u_THING_0x0006)->tht).ptDest.x)) &&
                              ((lpth->idFull >> 0xd != 2 || ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 0xd & 1) == 0)))))) {
                            lRadPlanet2 = uVar19;
                            sVar8 = _abs(iVar2 - (&((THING *)lpth)->pt)->x);
                            uVar19 = lRadPlanet2;
                            if (sVar8 <= sVar7) {
                                sVar9 = _abs(iVar3 - (((THING *)lpth)->pt).y);
                                uVar19 = lRadPlanet2;
                                if (sVar9 <= sVar7) {
                                    uVar19 = __aFulmul((long)sVar9, (long)sVar9);
                                    uVar11 = (ushort)uVar19;
                                    uVar20 = __aFulmul((long)sVar8, (long)sVar8);
                                    lVar22 = uVar20 + CONCAT22((int)(uVar19 >> 0x10), uVar11);
                                    uVar19 = lRadPlanet2;
                                    if (lVar22 <= (long)uVar18) {
                                        if (lpth->idFull >> 0xd == 1) {
                                            ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags =
                                                ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0x7fff | 0x8000;
                                        IO_LThIncPlr2:
                                            uVar19 = lRadPlanet2;
                                            if ((*(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1) == 0) {
                                                *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
                                                    *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfeff | 0x100;
                                                *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) =
                                                    *(uint *)((int)&rgplr[0].wMdPlr + (lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 | 3;
                                            }
                                        } else if (lpth->idFull >> 0xd == 3) {
                                            *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) =
                                                *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) & 0xffef | 0x10;
                                        } else {
                                            if (lpth->idFull >> 0xd != 2) {
                                                if (((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) & uVar6) == 0) && (lRadPlanet2 < lVar22)) {
                                                    lVar21 = __aFlshr(lVar26, uVar11);
                                                    uVar19 = lRadPlanet2;
                                                    if (lVar21 < lVar22)
                                                        goto LAB_1070_b409;
                                                }
                                                puVar1 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4);
                                                *puVar1 = *puVar1 | uVar6;
                                                puVar1 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8);
                                                *puVar1 = *puVar1 | uVar6;
                                                goto IO_LThIncPlr2;
                                            }
                                            if ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 2) & uVar6) == 0) {
                                                lVar21 = __aFlshr(lVar26, uVar11);
                                                if ((lVar21 < lVar22) && (uVar19 = lRadPlanet2, lRadPlanet2 < lVar22))
                                                    goto LAB_1070_b409;
                                            }
                                            puVar1 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
                                            *puVar1 = *puVar1 | uVar6;
                                            ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags =
                                                ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0xdfff | 0x2000;
                                            uVar19 = lRadPlanet2;
                                        }
                                    }
                                }
                            }
                        }
                    LAB_1070_b409:
                        lpth = (THING *)CONCAT22(uVar23, (THING *)lpth + 1);
                    }
                }
                lppl = (PLANET *)CONCAT22(uVar17, (PLANET *)lppl + 1);
            } while (true);
        }
        uVar17 = (undefined2)((ulong)lppl >> 0x10);
        if (((PLANET *)lppl)->iPlayer == iPlr) {
            sVar7 = GetPlanetScannerRange(lppl, &iRadPlanet);
            uVar18 = __aFulmul((long)sVar7, (long)sVar7);
            uVar19 = __aFulmul((long)iRadPlanet, (long)iRadPlanet);
            iVar2 = ((POINT *)rgptPlan + lppl->id)->x;
            iVar3 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
            for (j = 0; j < cFleet; j = j + 1) {
                /* WARNING: Load size is inaccurate */
                pFVar4 = ((FLEET **)rglpfl)[j];
                iVar16 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
                if ((pFVar4 == (FLEET *)0x0) && (iVar16 == 0))
                    break;
                if (((pFVar4->wFlags_0x4 >> 8 & 1) == 0) && ((pFVar4->wFlags_0x4 >> 10 & 1) == 0)) {
                    lRadPlanet2 = uVar19;
                    sVar8 = _abs(iVar2 - (&pFVar4->pt)->x);
                    uVar19 = lRadPlanet2;
                    if (sVar8 <= sVar7) {
                        sVar9 = _abs(iVar3 - (pFVar4->pt).y);
                        uVar19 = lRadPlanet2;
                        if (sVar9 <= sVar7) {
                            uVar19 = __aFulmul((long)sVar9, (long)sVar9);
                            uVar23 = (undefined2)uVar19;
                            uVar20 = __aFulmul((long)sVar8, (long)sVar8);
                            lVar22 = uVar20 + CONCAT22((int)(uVar19 >> 0x10), uVar23);
                            uVar19 = lRadPlanet2;
                            if ((lVar22 <= (long)uVar18) && ((pFVar4->idPlanet == -1 || (lVar22 <= lRadPlanet2)))) {
                                sVar8 = PctCloakFromLpfl((FLEET *)CONCAT22(iVar16, pFVar4));
                                if (sVar8 == 0) {
                                    MarkFleet((FLEET *)CONCAT22(iVar16, pFVar4), 3);
                                    uVar19 = lRadPlanet2;
                                } else {
                                    uVar24 = 0;
                                    uVar23 = 100;
                                    iVar10 = 100 - sVar8;
                                    iVar15 = iVar10 >> 0xf;
                                    lVar21 = 100;
                                    uVar19 = __aFulmul(uVar18, (long)(100 - sVar8));
                                    uVar19 = __aFldiv(uVar19, lVar21);
                                    uVar19 = __aFulmul(uVar19, CONCAT22(iVar15, iVar10));
                                    lVar21 = __aFldiv(uVar19, CONCAT22(uVar24, uVar23));
                                    uVar19 = lRadPlanet2;
                                    if (lVar22 <= lVar21) {
                                        if (pFVar4->idPlanet != -1) {
                                            uVar24 = 0;
                                            uVar23 = 100;
                                            iVar10 = 100 - sVar8;
                                            iVar15 = iVar10 >> 0xf;
                                            lVar21 = 100;
                                            uVar19 = __aFulmul(lRadPlanet2, (long)(100 - sVar8));
                                            uVar19 = __aFldiv(uVar19, lVar21);
                                            uVar19 = __aFulmul(uVar19, CONCAT22(iVar15, iVar10));
                                            lVar21 = __aFldiv(uVar19, CONCAT22(uVar24, uVar23));
                                            uVar19 = lRadPlanet2;
                                            if (lVar21 < lVar22)
                                                goto LAB_1070_ad5d;
                                        }
                                        MarkFleet((FLEET *)CONCAT22(iVar16, pFVar4), 3);
                                        uVar19 = lRadPlanet2;
                                    }
                                }
                            }
                        }
                    }
                }
            LAB_1070_ad5d:
            }
        }
        lppl = (PLANET *)CONCAT22(uVar17, (PLANET *)lppl + 1);
    } while (true);
}

// ======================================================================
// Function: SetVisPFThings
// Address: 1070:b9ee
// Segment: MEMORY_IO
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x1070c0f0) */
/* WARNING: Removing unreachable block (ram,0x1070bc7d) */
/* WARNING: Removing unreachable block (ram,0x1070c3b9) */
/* WARNING: Removing unreachable block (ram,0x1070bbf7) */
/* WARNING: Removing unreachable block (ram,0x1070be5c) */
/* WARNING: Removing unreachable block (ram,0x1070bfb4) */
/* WARNING: Removing unreachable block (ram,0x1070c197) */

void SetVisPFThings(short iPlr)

{
    uint      *puVar1;
    int        iVar2;
    int        iVar3;
    FLEET     *pFVar4;
    uint       uVar5;
    short      sVar6;
    int        iVar7;
    int        iVar8;
    uint       uVar9;
    uint       uVar10;
    short      sVar11;
    THING     *pTVar12;
    THING     *pTVar13;
    PLANET    *pPVar14;
    int        iVar15;
    int        iVar16;
    undefined2 uVar17;
    undefined2 uVar18;
    ulong      uVar19;
    ulong      uVar20;
    long       lVar21;
    ulong      uVar22;
    ulong      uVar23;
    undefined2 uVar24;
    undefined2 uVar25;
    long       lVis2;
    PLANET    *lpplMac2;
    long       l;
    THING     *lpth2;
    THING     *lpthMac2;
    undefined4 local_2c;
    ushort     grbitPlr;
    short      dx;
    short      iRadius;
    THING     *lpthMac;
    long       lRadius2;
    THING     *lpth;
    short      j;
    long       d2;
    FLEET     *lpfl2;
    short      dy;
    short      pctCloak;
    POINT      pt;

    if (iPlr == -1) {
        uVar5 = 0;
    } else {
        uVar5 = 1 << ((byte)iPlr & 0x1f);
    }
    sVar6 = GetRaceStat((PLAYER *)rgplr + iPlr, rsMajorAdv);
    if (sVar6 == raMassAccel) {
        pTVar12 = (THING *)lpThings + cThing;
        lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
        while ((THING *)lpth < pTVar12) {
            uVar18 = (undefined2)((ulong)lpth >> 0x10);
            if (((lpth->idFull >> 0xd == 1) && ((lpth->idFull >> 9 & 0xf) == iPlr)) && ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) != 0)) {
                ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0x7fff | 0x8000;
                iVar7 = (((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) + 4;
                iVar7 = iVar7 * iVar7;
                uVar22 = __aFulmul((long)iVar7, (long)iVar7);
                iVar2 = (&((THING *)lpth)->pt)->x;
                iVar3 = (((THING *)lpth)->pt).y;
                for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
                    pFVar4 = ((FLEET **)rglpfl)[j];
                    iVar16 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
                    if ((pFVar4 == (FLEET *)0x0) && (iVar16 == 0))
                        break;
                    if ((((pFVar4->wFlags_0x4 >> 8 & 1) == 0) &&
                         (((pFVar4->wFlags_0x4 >> 10 & 1) == 0 && (sVar6 = _abs(iVar2 - (&pFVar4->pt)->x), sVar6 <= iVar7)))) &&
                        (sVar11 = _abs(iVar3 - (pFVar4->pt).y), sVar11 <= iVar7)) {
                        uVar23 = __aFulmul((long)sVar11, (long)sVar11);
                        uVar19 = __aFulmul((long)sVar6, (long)sVar6);
                        if ((long)(uVar19 + uVar23) <= (long)uVar22) {
                            sVar6 = PctCloakFromLpfl((FLEET *)CONCAT22(iVar16, pFVar4));
                            if (sVar6 == 0) {
                                MarkFleet((FLEET *)CONCAT22(iVar16, pFVar4), 3);
                            } else {
                                uVar24 = 0;
                                uVar17 = 100;
                                iVar8 = 100 - sVar6;
                                iVar15 = iVar8 >> 0xf;
                                lVar21 = 100;
                                uVar20 = __aFulmul(uVar22, (long)(100 - sVar6));
                                uVar20 = __aFldiv(uVar20, lVar21);
                                uVar20 = __aFulmul(uVar20, CONCAT22(iVar15, iVar8));
                                lVar21 = __aFldiv(uVar20, CONCAT22(uVar24, uVar17));
                                if ((long)(uVar19 + uVar23) <= lVar21) {
                                    MarkFleet((FLEET *)CONCAT22(iVar16, pFVar4), 3);
                                }
                            }
                        }
                    }
                }
                pTVar13 = (THING *)lpThings + cThing;
                lpth2 = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
                while ((THING *)lpth2 < pTVar13) {
                    if (((iPlr != -1) &&
                         ((((lpth2->idFull >> 0xd == 0 || (lpth2->idFull >> 0xd == 1)) || (lpth2->idFull >> 0xd == 3)) || (lpth2->idFull >> 0xd == 2)))) &&
                        ((((lpth2->idFull >> 0xd != 0 || ((*(uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 8) & uVar5) == 0)) &&
                           ((lpth2->idFull >> 0xd != 3 || ((*(uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 4) >> 4 & 1) == 0)))) &&
                          ((((lpth2->idFull >> 0xd != 1 || (-1 < ((&((THING *)lpth2)->u_THING_0x0006)->tht).ptDest.x)) &&
                             ((lpth2->idFull >> 0xd != 2 || ((((&((THING *)lpth2)->u_THING_0x0006)->thp).wFlags >> 0xd & 1) == 0)))) &&
                            ((sVar6 = _abs(iVar2 - (&((THING *)lpth2)->pt)->x),
                              sVar6 <= iVar7 && (sVar11 = _abs(iVar3 - (((THING *)lpth2)->pt).y), sVar11 <= iVar7)))))))) {
                        uVar23 = __aFulmul((long)sVar11, (long)sVar11);
                        uVar19 = __aFulmul((long)sVar6, (long)sVar6);
                        if ((long)(uVar19 + uVar23) <= (long)uVar22) {
                            if (lpth2->idFull >> 0xd == 1) {
                                ((&((THING *)lpth2)->u_THING_0x0006)->thp).wFlags = ((&((THING *)lpth2)->u_THING_0x0006)->thp).wFlags & 0x7fff | 0x8000;
                            IO_LThIncPlr3:
                                if ((*(uint *)((int)&rgplr[0].wMdPlr + (lpth2->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1) == 0) {
                                    *(uint *)((int)&rgplr[0].wMdPlr + (lpth2->idFull >> 9 & 0xf) * 0xc0) =
                                        *(uint *)((int)&rgplr[0].wMdPlr + (lpth2->idFull >> 9 & 0xf) * 0xc0) & 0xfeff | 0x100;
                                    *(uint *)((int)&rgplr[0].wMdPlr + (lpth2->idFull >> 9 & 0xf) * 0xc0) =
                                        *(uint *)((int)&rgplr[0].wMdPlr + (lpth2->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 | 3;
                                }
                            } else if (lpth2->idFull >> 0xd == 3) {
                                *(uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 4) = *(uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 4) & 0xffef | 0x10;
                            } else {
                                if (lpth2->idFull >> 0xd != 2) {
                                    puVar1 = (uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 4);
                                    *puVar1 = *puVar1 | uVar5;
                                    puVar1 = (uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 8);
                                    *puVar1 = *puVar1 | uVar5;
                                    goto IO_LThIncPlr3;
                                }
                                if (((*(uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 2) & uVar5) != 0) || ((long)(uVar19 + uVar23) <= (long)uVar22)) {
                                    puVar1 = (uint *)((int)&((THING *)lpth2)->u_THING_0x0006 + 2);
                                    *puVar1 = *puVar1 | uVar5;
                                    ((&((THING *)lpth2)->u_THING_0x0006)->thp).wFlags = ((&((THING *)lpth2)->u_THING_0x0006)->thp).wFlags & 0xdfff | 0x2000;
                                }
                            }
                        }
                    }
                    lpth2 = (THING *)lpth2 + 1;
                }
                pPVar14 = (PLANET *)lpPlanets + cPlanet;
                local_2c = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
                while ((PLANET *)local_2c < pPVar14) {
                    uVar17 = (undefined2)((ulong)local_2c >> 0x10);
                    if (((((((PLANET *)local_2c)->wFlags_0x4 >> 8 & 1) == 0) || ((((PLANET *)local_2c)->wFlags_0x4 & 0xff) < 3)) &&
                         (sVar6 = _abs(((POINT *)rgptPlan + local_2c->id)->x - iVar2), sVar6 <= iVar7)) &&
                        (sVar11 = _abs(*(int *)((int)&rgptPlan[0].y + local_2c->id * 4) - iVar3), sVar11 <= iVar7)) {
                        uVar23 = __aFulmul((long)sVar11, (long)sVar11);
                        uVar19 = __aFulmul((long)sVar6, (long)sVar6);
                        if ((long)(uVar19 + uVar23) <= (long)uVar22) {
                            if (((((PLANET *)local_2c)->wFlags_0x4 >> 9 & 1) != 0) && (((PLANET *)local_2c)->iPlayer != -1)) {
                                iVar16 = ((PLANET *)local_2c)->iPlayer * 4;
                                uVar24 = *(undefined2 *)(iVar16 + rglpshdefSB_0x2);
                                iVar16 = *(int *)(iVar16 + rglpshdefSB) + (*(uint *)&((PLANET *)local_2c)->lStarbase & 0xf) * 0x93;
                                uVar9 = *(uint *)(iVar16 + 0x87);
                                iVar16 = *(int *)(iVar16 + 0x89);
                                if ((iVar16 < 1) && ((iVar16 < 0 || (uVar9 < 10000)))) {
                                    uVar25 = 0;
                                    uVar24 = 10000;
                                    uVar20 = __aFulmul(uVar22, CONCAT22(iVar16, uVar9));
                                    lVar21 = __aFldiv(uVar20, CONCAT22(uVar25, uVar24));
                                    if (lVar21 < (long)(uVar19 + uVar23)) {
                                        MarkPlanet(local_2c, iPlr, 2);
                                        goto LAB_1070_c1d2;
                                    }
                                }
                            }
                            MarkPlanet(local_2c, iPlr, 3);
                        }
                    }
                LAB_1070_c1d2:
                    local_2c = (PLANET *)CONCAT22(uVar17, (PLANET *)local_2c + 1);
                }
            }
            lpth = (THING *)CONCAT22(uVar18, (THING *)lpth + 1);
        }
    } else {
        sVar6 = GetRaceStat((PLAYER *)rgplr + iPlr, rsMajorAdv);
        if (sVar6 == raMines) {
            pTVar12 = (THING *)lpThings + cThing;
            lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
            while ((THING *)lpth < pTVar12) {
                uVar18 = (undefined2)((ulong)lpth >> 0x10);
                if ((lpth->idFull >> 0xd == 0) && ((lpth->idFull >> 9 & 0xf) == iPlr)) {
                    uVar5 = ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags;
                    iVar2 = *(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 2);
                    iVar3 = (&((THING *)lpth)->pt)->x;
                    iVar7 = (((THING *)lpth)->pt).y;
                    for (j = 0; j < cFleet; j = j + 1) {
                        /* WARNING: Load size is inaccurate */
                        pFVar4 = ((FLEET **)rglpfl)[j];
                        iVar16 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
                        if ((pFVar4 == (FLEET *)0x0) && (iVar16 == 0))
                            break;
                        if (((pFVar4->wFlags_0x4 >> 8 & 1) == 0) && (((pFVar4->wFlags_0x4 >> 10 & 1) == 0 && (pFVar4->idPlanet == -1)))) {
                            uVar9 = _abs(iVar3 - (&pFVar4->pt)->x);
                            if (((int)uVar9 >> 0xf <= iVar2) && (((int)uVar9 >> 0xf < iVar2 || (uVar9 <= uVar5)))) {
                                uVar10 = _abs(iVar7 - (pFVar4->pt).y);
                                if (((int)uVar10 >> 0xf <= iVar2) && (((int)uVar10 >> 0xf < iVar2 || (uVar10 <= uVar5)))) {
                                    uVar22 = __aFulmul((long)(int)uVar10, (long)(int)uVar10);
                                    uVar23 = __aFulmul((long)(int)uVar9, (long)(int)uVar9);
                                    if (((long)(uVar23 + uVar22) <= CONCAT22(iVar2, uVar5)) && ((sVar6 = PctCloakFromLpfl((FLEET *)CONCAT22(iVar16, pFVar4)),
                                                                                                 sVar6 == 0 || (sVar11 = Random(100), sVar6 <= sVar11)))) {
                                        MarkFleet((FLEET *)CONCAT22(iVar16, pFVar4), 3);
                                    }
                                }
                            }
                        }
                    }
                }
                lpth = (THING *)CONCAT22(uVar18, (THING *)lpth + 1);
            }
        }
    }
    return;
}

// ======================================================================
// Function: SetVisPFFinish
// Address: 1070:c41c
// Segment: MEMORY_IO
// ======================================================================

void SetVisPFFinish(short iPlr)

{
    char *pcVar1;
    uint *puVar2;
    int   iVar3;
    short sVar4;
    uint  uVar5;
    short i;
    short j;
    short detMajor;

    sVar4 = GetRaceStat((PLAYER *)rgplr + iPlr, rsMajorAdv);
    if (sVar4 == raAttack) {
        uVar5 = 7;
    } else {
        uVar5 = 3;
    }
    i = 0;
    do {
        if (game.cPlayer <= i) {
            return;
        }
        if (i != iPlr) {
            *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
            for (j = 0; j < 0x10; j = j + 1) {
                if ((1 << ((byte)iPlr & 0x1f) & *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x8b)) == 0) {
                    if ((*(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) >> 8 & 1) != 0) {
                        *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) = *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xff00 | uVar5;
                        goto IO_LFinShdef;
                    }
                } else {
                    *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) = *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
                    *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) = *(uint *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7b) & 0xff00 | 7;
                IO_LFinShdef:
                    *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 3;
                    *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
                    pcVar1 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
                    *pcVar1 = *pcVar1 + '\x01';
                }
            }
            *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) = *(uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) & 0xfff;
            for (j = 0; j < 10; j = j + 1) {
                if ((1 << ((byte)iPlr & 0x1f) & *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x8b)) == 0) {
                    if ((*(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) >> 8 & 1) != 0) {
                        *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) =
                            *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xff00 | uVar5;
                        goto IO_LFinShdefSB;
                    }
                } else {
                    *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) = *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
                    *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) = *(uint *)(*(int *)(i * 4 + rglpshdefSB) + j * 0x93 + 0x7b) & 0xff00 | 7;
                IO_LFinShdefSB:
                    *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
                    *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 3;
                    iVar3 = *(int *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
                    puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
                    *puVar2 = *puVar2 & 0xfff;
                    puVar2 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
                    *puVar2 = *puVar2 | iVar3 + 0x1000U & 0xf000;
                }
            }
        }
        i = i + 1;
    } while (true);
}
