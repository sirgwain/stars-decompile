// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: FReadShDef
// Address: 1070:0006
// Segment: MEMORY_IO
// ======================================================================


short FReadShDef(RTSHDEF *lprt,SHDEF *lpshdef,short iplrLoad)

{
  byte *pbVar1;
  HullDef *pHVar2;
  SHDEF *pSVar3;
  uint uVar4;
  int iVar5;
  RTSHDEF *pRVar6;
  HUL *pHVar7;
  HullDef *pHVar8;
  SHDEF *pSVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  undefined2 unaff_SS;
  bool bVar12;
  HULDEF *pHVar13;
  PART part;
  HUL *lphul;
  short c;
  uint wt;
  int local_d0;
  HUL *lphulBase;
  short iFirst;
  short cch;
  short ishdef;
  byte *lpb;
  HullDef shdef [4];
  char local_b8 [32];
  short local_98;
  uint local_8e;
  short local_88;
  undefined1 local_86 [64];
  byte local_46;
  uint local_45;
  short local_43;
  undefined2 local_41;
  undefined2 local_3f;
  undefined2 local_3d;
  undefined2 local_3b;
  char szTemp [42];
  
  _memset(shdef,0,0x93);
  uVar10 = (undefined2)((ulong)lprt >> 0x10);
  pRVar6 = (RTSHDEF *)lprt;
  shdef[0] = (HullDef)pRVar6->ihuldef;
  local_45 = lprt->wFlags;
  local_46 = pRVar6->chs;
  local_8e = (uint)pRVar6->ibmp;
  if ((local_45 & 0xff) == 7) {
    local_88 = pRVar6->wtEmpty;
    local_43 = pRVar6->turn;
    local_41 = (undefined2)pRVar6->cBuilt;
    local_3f = *(undefined2 *)((int)&pRVar6->cBuilt + 2);
    local_3d = (undefined2)pRVar6->cExist;
    local_3b = *(undefined2 *)((int)&pRVar6->cExist + 2);
    lpb = (byte *)CONCAT22(uVar10,pRVar6 + 1);
    __fmemmove((undefined1 *)local_86,(RTSHDEF *)CONCAT22(uVar10,pRVar6 + 1),
                       (uint)pRVar6->chs << 2);
    lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + (uint)pRVar6->chs * 4);
  }
  else {
    local_98 = pRVar6->wtEmpty;
    lpb = (byte *)CONCAT22(uVar10,&pRVar6->chs);
  }
  pHVar13 = LphuldefFromId(shdef[0]);
  iFirst = (((HULDEF *)pHVar13)->hul).ibmp;
  if (((int)local_8e < iFirst) || ((int)(iFirst + 4U) <= (int)local_8e)) {
    local_8e = local_8e & 3 | iFirst;
  }
  cch = (short)*lpb;
  pbVar1 = (byte *)lpb + 1;
  lpb = (byte *)CONCAT22(lpb._2_2_,pbVar1);
  if (cch == 0) {
    __fstrcpy((char *)local_b8,(char *)CONCAT22(lpb._2_2_,pbVar1));
  }
  else {
    iFirst = 0x20;
    if (0x20 < (uint)cch) {
      return 0;
    }
    __fmemmove((char *)szTemp,(byte *)CONCAT22(lpb._2_2_,pbVar1),cch);
    FDecompressUserString((char *)szTemp,cch,(char *)local_b8,&iFirst);
  }
  ishdef = local_45 >> 10 & 0x1f;
  if (0xf < (uint)ishdef) {
    ishdef = ishdef - 0x10;
  }
  if ((((local_45 & 0xff) == 7) || (((uint)((SHDEF *)lpshdef)[ishdef].wFlags >> 9 & 1) != 0)) ||
     ((((SHDEF *)lpshdef)[ishdef].wFlags & 0xffU) < 7)) {
    pSVar9 = (SHDEF *)lpshdef + ishdef;
    pHVar8 = shdef;
    for (iVar5 = 0x49; iVar5 != 0; iVar5 = iVar5 + -1) {
      pSVar3 = pSVar9;
      pSVar9 = (SHDEF *)(pSVar9->hul).rgTech;
      pHVar2 = pHVar8;
      pHVar8 = pHVar8 + 1;
      (pSVar3->hul).ihuldef = *pHVar2;
    }
    *(char *)&(pSVar9->hul).ihuldef = (char)*pHVar8;
  }
  else if ((shdef[0] != (((SHDEF *)lpshdef + ishdef)->hul).ihuldef) ||
          (local_8e != ((SHDEF *)lpshdef)[ishdef].hul.ibmp)) {
    pSVar9 = (SHDEF *)lpshdef + ishdef;
    pHVar8 = shdef;
    for (iVar5 = 0x49; iVar5 != 0; iVar5 = iVar5 + -1) {
      pSVar3 = pSVar9;
      pSVar9 = (SHDEF *)(pSVar9->hul).rgTech;
      pHVar2 = pHVar8;
      pHVar8 = pHVar8 + 1;
      (pSVar3->hul).ihuldef = *pHVar2;
    }
    *(char *)&(pSVar9->hul).ihuldef = (char)*pHVar8;
  }
  if (idPlayer != -1) {
    UpdateShdefCost((SHDEF *)CONCAT22(lpshdef._2_2_,(SHDEF *)lpshdef + ishdef));
  }
  if ((((SHDEF *)lpshdef)[ishdef].wFlags & 0xffU) == 7) {
    lphul = (HUL *)CONCAT22(lpshdef._2_2_,(SHDEF *)lpshdef + ishdef);
    lphulBase = &LphuldefFromId(lphul->ihuldef)->hul;
    wt = (((HULDEF *)lphulBase)->hul).wtEmpty;
    local_d0 = 0;
    c = 0;
    while( true ) {
      uVar10 = (undefined2)((ulong)lphul >> 0x10);
      pHVar7 = (HUL *)lphul;
      if ((int)(uint)pHVar7->chs <= c) break;
      if ((uint)pHVar7->rghs[c].wFlags >> 8 != 0) {
        part.hs.grhst = (pHVar7->rghs + c)->grhst;
        part.hs.wFlags = pHVar7->rghs[c].wFlags;
        iFirst = FLookupPart(&part);
        if (idPlayer == -1) {
          iFirst = 0;
        }
        if ((((part.hs.grhst & (((HUL *)lphulBase)->rghs + c)->grhst) ==
              ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|
                hstMines|hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine))
            || ((1 < iFirst && (-1 < (int)local_45)))) ||
           ((uint)((HUL *)lphulBase)->rghs[c].wFlags >> 8 < (uint)part.hs.wFlags >> 8)) {
          ((HUL *)lphul)->rghs[c].wFlags = ((HUL *)lphul)->rghs[c].wFlags & 0xff;
        }
        uVar4 = ((COMPART *)part.pcom)->cMass * ((uint)((HUL *)lphul)->rghs[c].wFlags >> 8);
        bVar12 = CARRY2(wt,uVar4);
        wt = wt + uVar4;
        local_d0 = local_d0 + (uint)bVar12;
      }
      if (c == 0) {
        uVar10 = (undefined2)((ulong)lphul >> 0x10);
        pHVar7 = (HUL *)lphul;
        if ((uint)pHVar7->rghs[0].wFlags >> 8 == 0) {
          uVar11 = (undefined2)((ulong)lphulBase >> 0x10);
          if (((HUL *)lphulBase)->rghs->grhst == hstEngine) {
            pHVar7->rghs->grhst = hstEngine;
            pHVar7->rghs[0].wFlags = pHVar7->rghs[0].wFlags & 0xff00U | 1;
            pHVar7->rghs[0].wFlags =
                 pHVar7->rghs[0].wFlags & 0xffU | ((HUL *)lphulBase)->rghs[0].wFlags & 0xff00U;
            part.hs.grhst = pHVar7->rghs->grhst;
            part.hs.wFlags = pHVar7->rghs[0].wFlags;
            FLookupPart(&part);
            uVar4 = ((COMPART *)part.pcom)->cMass * ((uint)((HUL *)lphul)->rghs[0].wFlags >> 8);
            bVar12 = CARRY2(wt,uVar4);
            wt = wt + uVar4;
            local_d0 = local_d0 + (uint)bVar12;
          }
        }
      }
      c = c + 1;
    }
    pHVar7->wtEmpty = wt;
  }
  return 1;
}



// ======================================================================
// Function: ReadRtPlr
// Address: 1070:05e2
// Segment: MEMORY_IO
// ======================================================================


void ReadRtPlr(PLAYER *pplr,byte *pbIn)

{
  ushort uVar1;
  short cOut;
  byte *pplrRaw;
  short iOff;
  
  pplrRaw = pbIn;
  _memset(pplr,0,0xc0);
  if ((*(uint *)(pplrRaw + 6) & 7) == 7) {
    _memmove(pplr,pbIn,0x70);
    _memmove(pplr->rgmdRelation,pbIn + 0x71,(uint)pbIn[0x70]);
    iOff = pbIn[0x70] + 0x71;
  }
  else {
    _memmove(pplr,pbIn,8);
    iOff = 8;
  }
  if (pbIn[iOff] == 0) {
    _strcpy(pplr->szName,(char *)(pbIn + iOff + 1));
    uVar1 = _strlen(pplr->szName);
    iOff = iOff + uVar1 + 2;
  }
  else {
    cOut = 0x20;
    FDecompressUserString
              ((char *)(pbIn + iOff + 1),(uint)pbIn[iOff],(char *)pplr->szName,&cOut);
    iOff = iOff + pbIn[iOff] + 1;
  }
  if ((wVersFile >> 5 & 0x7f) < 0x37) {
    cOut = (short)PszPlayerName(0,(byte)((undefined *)&DAT_1120_175f)[pplr->szName[0]] & 1,1,0
                                      ,0,pplr);
    _strcpy(pplr->szNames,(char *)cOut);
  }
  else if (pbIn[iOff] == 0) {
    _strcpy(pplr->szNames,(char *)(pbIn + iOff + 1));
  }
  else {
    cOut = 0x20;
    FDecompressUserString
              ((char *)(pbIn + iOff + 1),(uint)pbIn[iOff],(char *)pplr->szNames,&cOut);
  }
  pplr->wFlags = pplr->wFlags & 0xfff7;
  return;
}



// ======================================================================
// Function: FLoadGame
// Address: 1070:0810
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10702da2) */
/* WARNING: Removing unreachable block (ram,0x10701634) */
/* WARNING: Removing unreachable block (ram,0x10702d82) */
/* WARNING: Removing unreachable block (ram,0x10702da7) */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short FLoadGame(char *pszFileName,char *pszExt)

{
  int *piVar1;
  uint *puVar2;
  char *pcVar3;
  short *psVar4;
  GAME *pGVar5;
  int *piVar6;
  SCOREX *pSVar7;
  PLPROD *pPVar8;
  PLANET *pPVar9;
  byte *pbVar10;
  FLEET **ppFVar11;
  byte *pbVar12;
  undefined2 uVar13;
  short sVar14;
  ushort uVar15;
  int iVar16;
  PLANET *pPVar17;
  FLEET *pFVar18;
  undefined2 unaff_SI;
  char *pcVar19;
  int *piVar20;
  FLEET **ppFVar21;
  short *psVar22;
  SCOREX *pSVar23;
  undefined2 unaff_DI;
  GAME *pGVar24;
  int *piVar25;
  SCOREX *pSVar26;
  undefined2 uVar27;
  undefined2 unaff_SS;
  PLANET *pPVar28;
  PL *pPVar29;
  void *pvVar30;
  SCOREX *pSVar31;
  THING *pTVar32;
  BTLPLAN *pBVar33;
  ulong uVar34;
  ushort in_stack_0000fe86;
  ulong in_stack_0000fe8e;
  ushort in_stack_0000fe92;
  char szIniFile [16];
  char szT [224];
  uint local_68;
  ushort turnCur;
  short isx;
  int sx;
  ushort local_60;
  short fTwo;
  short iWarp;
  PROD *lpprod;
  short iLast;
  ushort turnCur__78;
  PLANET *pt;
  short iplr;
  short x;
  short grf;
  short dt;
  PLANET *lpplMac;
  short local_40;
  short j;
  short iPlayer;
  THING *lpthMac;
  short local_38;
  short cturn;
  undefined1 env [18];
  FLEET *lpfl;
  THING *lpth;
  short i;
  PLANET *lppl;
  short fSilentSav;
  undefined1 *penvMemSav;
  short fHaveHistoryData;
  short cPlanetAlloc;
  uint sp [2];
  short cPlanetHist;
  short iplrSav;
  
  grf = 0;
  cturn = 0;
  _strcpy((char *)szBase,pszFileName);
  gd._4_2_ = gd._4_2_ & 0xfbff;
  penvMemSav = penvMem;
  penvMem = env;
  sVar14 = __setjmp(env);
  if (sVar14 == 0) {
    sVar14 = FOpenFile(dtXY,-1,0x20);
    if (sVar14 != 0) {
      ReadRt();
      if ((uint)hdrCur.wFlags >> 10 == 7) {
        pcVar19 = (char *)rgbCur;
        pGVar24 = (GAME *)&game;
        for (iVar16 = 0x20; iVar16 != 0; iVar16 = iVar16 + -1) {
          pGVar5 = pGVar24;
          pGVar24 = (GAME *)((int)&pGVar24->lid + 2);
          pcVar3 = pcVar19;
          pcVar19 = pcVar19 + 2;
          *(undefined2 *)&pGVar5->lid = *(undefined2 *)pcVar3;
        }
        game.fDirty = 0;
        dGal = game.mdSize * 400 + 400;
        dGalInv = game.mdSize * 400 + 0x960;
        x = 1000;
        for (i = 0; i < game.cPlanMax; i = i + 1) {
          RgFromStream((uint *)sp,4);
          x = x + (sp[0] & 0x3ff);
          ((POINT *)rgptPlan + i)->x = x;
          uVar34 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000fe86);
          *(uint *)((int)&rgptPlan[0].y + i * 4) = (uint)uVar34 & 0xfff;
          uVar34 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000fe86);
          ((short *)rgidPlan)[i] = (uint)uVar34 & 0x3ff;
          if (((dGal + 1000 <= x) ||
              (dGal + 1000 <= *(int *)((int)&rgptPlan[0].y + i * 4))) ||
             (999 < ((short *)rgidPlan)[i])) goto IO_XYCorrupt;
        }
        ReadRt();
        if ((uint)hdrCur.wFlags >> 10 == 0) {
          StreamClose();
          if (((*pszExt == 'h') || (*pszExt == 'H')) && ((pszExt[1] == 's' || (pszExt[1] == 'S'))))
          {
            dt = 2;
            iPlayer = -1;
          }
          else {
            dt = 3;
            grf = grf | 0x3000;
            sVar14 = _atoi(pszExt + 1);
            iPlayer = sVar14 + -1;
          }
          ResetMessages();
          _memset((PLAYER *)rgplr,0,game.cPlayer * 0xc0);
          ResetHb(htShips);
          idPlayer = iPlayer;
          fSilentSav = fFileErrSilent;
          fFileErrSilent = 1;
          if (iPlayer == -1) {
IO_LNoHistFile:
            cPlanetHist = 0;
            FreeLp(lpPlanets,htPlanets);
            lpPlanets._0_2_ = (PLANET *)0x0;
            lpPlanets._2_2_ = 0;
            cThing = 0;
            FreeLp(lpThings,htThings);
            lpThings = (THING *)0x0;
          }
          else {
            sVar14 = FOpenFile(dtHist,iPlayer,0x20);
            if (sVar14 == 0) goto IO_LNoHistFile;
            ReadRt();
            vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
            lpThings = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
            if ((uint)hdrCur.wFlags >> 10 != 0x20) {
IO_CorruptHist:
              StreamClose();
              sVar14 = 0x10;
              pcVar19 = PszFormatIds(idsHistoryFileAppearsCorruptHistoricalDataWill,
                                          (short *)0x0);
              AlertSz(pcVar19,sVar14);
              goto IO_LNoHistFile;
            }
            cPlanetHist._0_1_ = rgbCur[0];
            cPlanetHist._1_1_ = rgbCur[1];
            cPlanetAlloc = rgbCur._0_2_ + rgbCur._2_2_;
            if (1000 < cPlanetAlloc) {
              cPlanetAlloc = 1000;
            }
            iVar16 = cPlanetAlloc;
            if (cPlanetAlloc < 1) {
              iVar16 = 1;
            }
            lpPlanets = LpAlloc(iVar16 * 0x38,htPlanets);
            ReadRt();
            i = 0;
            lppl = lpPlanets;
            while( true ) {
              if (cPlanetHist <= i) break;
              if ((uint)hdrCur.wFlags >> 10 != 0xe) goto IO_CorruptHist;
              sVar14 = FReadPlanet(iPlayer,lppl,1,0);
              if (sVar14 == 0) goto IO_CorruptHist;
              uVar27 = (undefined2)((ulong)lppl >> 0x10);
              pPVar17 = (PLANET *)lppl;
              if (pPVar17->iPlayer == iPlayer) {
                pPVar17->iPlayer = -1;
                pPVar17->wFlags = pPVar17->wFlags & 0xff00U | 3;
              }
              ReadRt();
              i = i + 1;
              lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
            }
            if ((uint)hdrCur.wFlags >> 10 == 0x21) {
              vlpbAiData =
                   (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
              lpThings = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
              if ((uint)cbbitfMsg < (hdrCur.wFlags & 0x3ffU)) goto IO_CorruptHist;
              _memcpy((byte *)bitfMsgFiltered,(char *)rgbCur,
                              hdrCur.wFlags & 0x3ff);
              ReadRt();
            }
            while ((uint)hdrCur.wFlags >> 10 == 6) {
              i = (short)rgbCur[0];
              ReadRtPlr((PLAYER *)rgplr + i,(byte *)rgbCur);
              *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
              iplr = *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xf000;
              *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) = iplr;
              ReadRt();
            }
            i = 0;
            while ((uint)hdrCur.wFlags >> 10 == 0x1a) {
              for (; (*(char *)((int)&rgplr[0].cShDef + i * 0xc0) == '\0' &&
                     (i < game.cPlayer)); i = i + 1) {
              }
              if (i == game.cPlayer) break;
              if ((*(int *)(i * 4 + 0xfe) == 0) && (*(int *)(i * 4 + 0x100) == 0)) {
                pvVar30 = LpAlloc(0x930,htShips);
                *(undefined2 *)(i * 4 + 0xfe) = (void *)pvVar30;
                *(undefined2 *)(i * 4 + 0x100) = (int)((ulong)pvVar30 >> 0x10);
                for (j = 0; j < 0x10; j = j + 1) {
                  iplr = *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                  *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) = iplr;
                  *(undefined2 *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x8b) = 0;
                }
              }
              sVar14 = idPlayer;
              iplrSav = idPlayer;
              if (idPlayer == -1) {
                idPlayer = i;
              }
              else {
                idPlayer = -1;
              }
              sVar14 = FReadShDef((RTSHDEF *)rgbCur,
                                  (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x100),
                                                    (SHDEF *)*(undefined2 *)(i * 4 + 0xfe)),sVar14);
              vlpbAiData =
                   (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
              lpThings = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
              if (sVar14 == 0) goto IO_CorruptHist;
              idPlayer = iplrSav;
              pcVar3 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
              *pcVar3 = *pcVar3 + -1;
              ReadRt();
            }
            i = 0;
            while ((uint)hdrCur.wFlags >> 10 == 0x1a) {
              for (; (*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 0xc == 0 &&
                     (i < game.cPlayer)); i = i + 1) {
              }
              if (i == game.cPlayer) break;
              if ((*(int *)(i * 4 + 0x14c) == 0) && (*(int *)(i * 4 + 0x14e) == 0)) {
                pvVar30 = LpAlloc(0x5be,htShips);
                *(undefined2 *)(i * 4 + 0x14c) = (void *)pvVar30;
                *(undefined2 *)(i * 4 + 0x14e) = (int)((ulong)pvVar30 >> 0x10);
                for (j = 0; j < 10; j = j + 1) {
                  iplr = *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                  *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) = iplr;
                  *(undefined2 *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x8b) = 0;
                }
              }
              sVar14 = idPlayer;
              iplrSav = idPlayer;
              if (idPlayer == -1) {
                idPlayer = i;
              }
              else {
                idPlayer = -1;
              }
              sVar14 = FReadShDef((RTSHDEF *)rgbCur,
                                  (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x14e),
                                                    (SHDEF *)*(undefined2 *)(i * 4 + 0x14c)),sVar14)
              ;
              vlpbAiData =
                   (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
              lpThings = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
              if (sVar14 == 0) goto IO_CorruptHist;
              idPlayer = iplrSav;
              iplr = *(int *)((int)&rgplr[0].wFlags + i * 0xc0) - 0x1000U & 0xf000;
              puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
              *puVar2 = *puVar2 & 0xfff;
              puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
              *puVar2 = *puVar2 | iplr;
              ReadRt();
            }
            while( true ) {
              pPVar9 = (PLANET *)CONCAT22(iplr,pt);
              pPVar28 = (PLANET *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
              if ((uint)hdrCur.wFlags >> 10 != 0x2d) break;
              iplr = rgbCur._0_2_ & 0x1f;
              piVar20 = (int *)rgbCur;
              piVar25 = &sx;
              for (iVar16 = 0xc; iVar16 != 0; iVar16 = iVar16 + -1) {
                piVar6 = piVar25;
                piVar25 = piVar25 + 1;
                piVar1 = piVar20;
                piVar20 = piVar20 + 1;
                *piVar6 = *piVar1;
              }
              if ((((SCOREX **)rgsxPlr)[iplr * 2] == (SCOREX *)0x0) &&
                 (*(int *)((undefined *)&DAT_1120_156e + iplr * 4) == 0)) {
                pSVar31 = LpAlloc(0x978,htMisc);
                ((SCOREX **)rgsxPlr)[iplr * 2] = (SCOREX *)pSVar31;
                *(int *)((undefined *)&DAT_1120_156e + iplr * 4) = (int)((ulong)pSVar31 >> 0x10);
                ((short *)rgcsxPlr)[iplr] = 0;
              }
              if ((((SCOREX **)rgsxPlr)[iplr * 2] != (SCOREX *)0x0) ||
                 (*(int *)((undefined *)&DAT_1120_156e + iplr * 4) != 0)) {
                if (sx < 0) {
                  turnCur = local_60;
                }
                else {
                  turnCur = game.turn;
                }
                isx = 0;
                while ((isx < ((short *)rgcsxPlr)[iplr] &&
                       ((uint)((SCOREX **)rgsxPlr)[iplr * 2][isx].iRank < turnCur))) {
                  isx = isx + 1;
                }
                if (((isx < ((short *)rgcsxPlr)[iplr]) &&
                    (turnCur != ((SCOREX **)rgsxPlr)[iplr * 2][isx].iRank)) || (100 < isx)) {
                  if (((short *)rgcsxPlr)[iplr] < 0x65) {
                    __fmemmove((SCOREX *)
                                       CONCAT22(*(undefined2 *)
                                                 ((undefined *)&DAT_1120_156e + iplr * 4),
                                                ((SCOREX **)rgsxPlr)[iplr * 2] + isx + 1),
                                       (SCOREX *)
                                       CONCAT22(*(undefined2 *)
                                                 ((undefined *)&DAT_1120_156e + iplr * 4),
                                                ((SCOREX **)rgsxPlr)[iplr * 2] + isx),
                                       (((short *)rgcsxPlr)[iplr] - isx) * 0x18);
                    ((short *)rgcsxPlr)[iplr] = ((short *)rgcsxPlr)[iplr] + 1;
                  }
                  else if (0 < isx) {
                    if (1 < isx) {
                      __fmemmove((SCOREX *)
                                         CONCAT22(*(undefined2 *)
                                                   ((undefined *)&DAT_1120_156e + iplr * 4),
                                                  ((SCOREX **)rgsxPlr)[iplr * 2]),
                                         (SCOREX *)
                                         CONCAT22(*(undefined2 *)
                                                   ((undefined *)&DAT_1120_156e + iplr * 4),
                                                  ((SCOREX **)rgsxPlr)[iplr * 2] + 1),
                                         (isx + -1) * 0x18);
                    }
                    isx = isx + -1;
                  }
                }
                else if (isx == ((short *)rgcsxPlr)[iplr]) {
                  ((short *)rgcsxPlr)[iplr] = ((short *)rgcsxPlr)[iplr] + 1;
                }
                uVar27 = *(undefined2 *)((undefined *)&DAT_1120_156e + iplr * 4);
                pSVar23 = ((SCOREX **)rgsxPlr)[iplr * 2] + isx;
                psVar22 = &sx;
                for (iVar16 = 0xc; iVar16 != 0; iVar16 = iVar16 + -1) {
                  pSVar31 = pSVar23;
                  pSVar23 = (SCOREX *)&pSVar23->iRank;
                  psVar4 = psVar22;
                  psVar22 = psVar22 + 1;
                  pSVar31->wWord = *psVar4;
                }
                ((SCOREX **)rgsxPlr)[iplr * 2][isx].iRank = turnCur;
                local_68 = (((SCOREX **)rgsxPlr)[iplr * 2] + isx)->wWord & 0x7fffU | 0x8000;
                (((SCOREX **)rgsxPlr)[iplr * 2] + isx)->wWord = local_68;
              }
              ReadRt();
            }
            if ((uint)hdrCur.wFlags >> 10 == 0x29) {
              if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 9 & 1) ==
                  0) {
                while( true ) {
                  pPVar9 = (PLANET *)CONCAT22(iplr,pt);
                  pPVar28 = (PLANET *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
                  if ((uint)hdrCur.wFlags >> 10 != 0x29) break;
                  ReadRt();
                }
              }
              else {
                vlpbAiData =
                     (byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
                pPVar9 = (PLANET *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
                if (((byte *)vlpbAiData == (byte *)0x0) &&
                   (vlpbAiData = (byte *)pPVar28, pPVar9 = pPVar28,
                   vlpbAiData._2_2_ == 0)) {
                  vlpbAiData = LpAlloc(0x1fa0,htMisc);
                  pPVar9 = (PLANET *)vlpbAiData;
                  if ((PLANET *)vlpbAiData == (PLANET *)0x0) goto IO_CorruptHist;
                }
                while( true ) {
                  iplr = (short)((ulong)pPVar9 >> 0x10);
                  pt = (PLANET *)pPVar9;
                  pPVar28 = (PLANET *)vlpbAiData;
                  if ((uint)hdrCur.wFlags >> 10 != 0x29) break;
                  __fmemmove(pPVar9,rgbCur,hdrCur.wFlags & 0x3ff);
                  pt = (PLANET *)(pt->rgpctMinLevel + ((hdrCur.wFlags & 0x3ffU) - 6));
                  ReadRt();
                  pPVar9 = (PLANET *)CONCAT22(iplr,pt);
                }
              }
            }
            iplr = (short)((ulong)pPVar9 >> 0x10);
            pt = (PLANET *)pPVar9;
            if ((uint)hdrCur.wFlags >> 10 == 0x2b) {
              cThing._0_1_ = rgbCur[0];
              cThing._1_1_ = rgbCur[1];
              cThingAlloc = rgbCur._0_2_ + 10;
              if (0xfd2 < cThingAlloc) {
                cThingAlloc = 0xfd2;
              }
              vlpbAiData = (byte *)pPVar28;
              lpThings = LpAlloc(cThingAlloc * 0x12,htThings);
              if (lpThings == (THING *)0x0) goto IO_CorruptHist;
              __fmemset(lpThings,0,cThingAlloc * 0x12);
              ReadRt();
              lpth = lpThings;
              for (i = 0; pPVar9 = (PLANET *)CONCAT22(iplr,pt),
                  pPVar28 = (PLANET *)vlpbAiData, i < cThing; i = i + 1) {
                if ((uint)hdrCur.wFlags >> 10 != 0x2b) goto IO_CorruptHist;
                __fmemcpy(lpth,rgbCur,hdrCur.wFlags & 0x3ff);
                ReadRt();
                lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
              }
            }
            iplr = (short)((ulong)pPVar9 >> 0x10);
            pt = (PLANET *)pPVar9;
            vlpbAiData = (byte *)pPVar28;
            StreamClose();
          }
          fFileErrSilent = fSilentSav;
          GetFileStatus(dt,iPlayer);
          sVar14 = FOpenFile(dt | grf,iPlayer,0x20);
          if (sVar14 != 0) {
            if (iPlayer == -1) {
              iplr = (uint)rgbCur._14_2_ >> 0xb & 1;
              gd.wFlags = gd.wFlags & 0xfffeU | iplr;
            }
            do {
              cturn = cturn + 1;
              cPlanet = 0;
              cFleet = 0;
              ReadRt();
              while (((uint)hdrCur.wFlags >> 10 == 0x1f ||
                     ((uint)hdrCur.wFlags >> 10 == 0x27))) {
                if ((uint)hdrCur.wFlags >> 10 != 0x27) {
                  if (lpbBattleLog == (byte *)0x0) {
                    lpbBattleCur = LpAlloc(0xffc8,htBattle);
                    lpbBattleLog = lpbBattleCur;
                  }
                  if (((byte *)lpbBattleCur < (byte *)0xffc9) &&
                     (-(int)(byte *)lpbBattleCur - 0x38U < (uint)rgbCur._6_2_)) {
                    pbVar10 = lpbBattleCur;
                    pbVar10[0] = 0xff;
                    pbVar10[1] = 0xff;
                    lpbBattleCur = LpAlloc(0xffc8,htBattle);
                  }
                }
                __fmemmove(lpbBattleCur,rgbCur,
                                   hdrCur.wFlags & 0x3ff);
                lpbBattleCur =
                     (byte *)CONCAT22(lpbBattleCur._2_2_,
                                      (byte *)lpbBattleCur +
                                      (hdrCur.wFlags & 0x3ff));
                ReadRt();
              }
              if ((((byte *)lpbBattleCur != (byte *)0x0) || (lpbBattleCur._2_2_ != 0))
                 && (pbVar10 = lpbBattleCur, pbVar10[0] = 0xff, pbVar10[1] = 0xff,
                    (wVersFile >> 5 & 0x7f) < 0x50)) {
                UpdateBattleRecords();
              }
              while ((uint)hdrCur.wFlags >> 10 == 6) {
                i = (short)rgbCur[0];
                ReadRtPlr((PLAYER *)rgplr + i,(byte *)rgbCur);
                cPlanet =
                     cPlanet + *(int *)((int)&rgplr[0].cPlanet + i * 0xc0);
                *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
                cFleet =
                     cFleet +
                     (*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xfff);
                iplr = *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xf000;
                *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) = iplr;
                ReadRt();
              }
              if (dt == 2) {
                if ((uint)hdrCur.wFlags >> 10 == 0x24) {
                  lSaltCur._0_1_ = rgbCur[0];
                  lSaltCur._1_1_ = rgbCur[1];
                  lSaltCur._2_1_ = rgbCur[2];
                  lSaltCur._3_1_ = rgbCur[3];
                  ReadRt();
                }
                else {
                  lSaltCur._0_1_ = '\0';
                  lSaltCur._1_1_ = '\0';
                  lSaltCur._2_1_ = '\0';
                  lSaltCur._3_1_ = '\0';
                }
              }
              else {
                lSaltCur._0_2_ =
                     *(undefined2 *)(char *)((int)&rgplr[0].lSalt + iPlayer * 0xc0);
                lSaltCur._2_2_ =
                     *(undefined2 *)(char *)((int)&rgplr[0].lSalt + 2 + iPlayer * 0xc0);
              }
              sVar14 = FCheckPassword();
              if (sVar14 == 0) {
                if ((((uint)ini.wFlags >> 0xe & 1) != 0) || (ini.wFlags < 0)) {
                  sVar14 = 0x10;
                  pcVar19 = PszFormatIds(idsPasswordHaveEnteredIncorrectPleaseTry,(short *)0x0)
                  ;
                  AlertSz(pcVar19,sVar14);
                }
                break;
              }
              ReadPlayerMessages();
              ResetHb(htFleets);
              ResetHb(htOrd);
              FreeLp(rglpfl,htMisc);
              rglpfl._0_2_ = (FLEET **)0x0;
              rglpfl._2_2_ = 0;
              pPVar28 = lpPlanets;
              if (lpPlanets == (PLANET *)0x0) {
                cPlanetAlloc = cPlanet;
                if (cPlanet < 1) {
                  cPlanetAlloc = 1;
                }
                pPVar28 = LpAlloc(cPlanetAlloc * 0x38,htPlanets);
                    /* WARNING: Ignoring partial resolution of indirect */
                lpPlanets._0_2_ = (PLANET *)pPVar28;
                    /* WARNING: Ignoring partial resolution of indirect */
                lpPlanets._2_2_ = (int)((ulong)pPVar28 >> 0x10);
                pPVar28 = lpPlanets;
              }
              lppl = pPVar28;
              j = 0;
              lpPlanets = lppl;
              for (i = 0; i < cPlanet; i = i + 1) {
                fHaveHistoryData = 0;
                if (cPlanetHist != 0) {
                  while ((j < cPlanetHist && (lppl->id < (int)(rgbCur._0_2_ << 5) >> 5)))
                  {
                    j = j + 1;
                    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
                  }
                  if ((j < cPlanetHist) && ((int)(rgbCur._0_2_ << 5) >> 5 == lppl->id)) {
                    fHaveHistoryData = 1;
                  }
                  else {
                    if (cPlanetAlloc == cPlanetHist) {
                      cPlanetAlloc = cPlanetAlloc + 8;
                      pPVar28 = LpReAlloc(lpPlanets,cPlanetAlloc * 0x38,htPlanets);
                    /* WARNING: Ignoring partial resolution of indirect */
                      lpPlanets._0_2_ = (PLANET *)pPVar28;
                    /* WARNING: Ignoring partial resolution of indirect */
                      lpPlanets._2_2_ = (int)((ulong)pPVar28 >> 0x10);
                      lppl = (PLANET *)
                             CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets + j);
                    }
                    if (j < cPlanetHist) {
                      __fmemmove((PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1),lppl,
                                         (cPlanetHist - j) * 0x38);
                    }
                    cPlanetHist = cPlanetHist + 1;
                  }
                }
                sVar14 = FReadPlanet(iPlayer,lppl,0,fHaveHistoryData);
                if (sVar14 == 0) goto IO_Corrupt_2;
                uVar27 = (undefined2)((ulong)lppl >> 0x10);
                if (((PLANET *)lppl)->iPlayer != -1) {
                  piVar1 = (int *)((int)&rgplr[0].cPlanet +
                                  ((PLANET *)lppl)->iPlayer * 0xc0);
                  *piVar1 = *piVar1 + 1;
                }
                ReadRt();
                if ((uint)hdrCur.wFlags >> 10 == 0x1c) {
                  uVar27 = (undefined2)((ulong)lppl >> 0x10);
                  pPVar17 = (PLANET *)lppl;
                  if (((*(int *)&pPVar17->lpplprod != 0) ||
                      (*(int *)((int)&pPVar17->lpplprod + 2) != 0)) &&
                     (iplr = (short)((PLPROD *)pPVar17->lpplprod)->iprodMax,
                     (uint)iplr <= (hdrCur.wFlags & 0x3ffU) / 4)) {
                    FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pPVar17->lpplprod + 2),
                                                  *(PL **)&pPVar17->lpplprod));
                    uVar27 = (undefined2)((ulong)lppl >> 0x10);
                    *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
                    *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
                  }
                  uVar27 = (undefined2)((ulong)lppl >> 0x10);
                  if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) &&
                     (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
                    pPVar29 = LpplAlloc(4,(hdrCur.wFlags & 0x3ffU) / 4 + 2,htOrd);
                    uVar27 = (undefined2)((ulong)lppl >> 0x10);
                    *(PL **)&((PLANET *)lppl)->lpplprod = (PL *)pPVar29;
                    *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) =
                         (int)((ulong)pPVar29 >> 0x10);
                  }
                  uVar27 = (undefined2)((ulong)lppl >> 0x10);
                  __fmemmove((void *)CONCAT22(*(undefined2 *)
                                                       ((int)&((PLANET *)lppl)->lpplprod + 2),
                                                      (void *)(*(int *)&((PLANET *)lppl)->lpplprod +
                                                              4)),rgbCur,
                                     hdrCur.wFlags & 0x3ff);
                  pPVar8 = ((PLANET *)lppl)->lpplprod;
                  ((PLPROD *)pPVar8)->iprodMac =
                       (byte)((ulong)(hdrCur.wFlags & 0x3ff) / 4);
                  ReadRt();
                }
                if (cPlanetHist == 0) {
                  lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
                }
              }
              if (cPlanetHist != 0) {
                cPlanet = cPlanetHist;
              }
              for (i = 0; i < game.cPlayer; i = i + 1) {
                if (i == iPlayer) {
                  *(undefined2 *)(i * 4 + 0xfe) = 0x3f00;
                  *(undefined2 *)(i * 4 + 0x100) = 0x1120;
IO_FreeShdef:
                  for (j = 0; j < 0x10; j = j + 1) {
                    iplr = *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                    *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) = iplr;
                    *(undefined2 *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x8b) = 0;
                  }
LAB_1070_1c2c:
                  iplrSav = idPlayer;
                  if (idPlayer == -1) {
                    idPlayer = i;
                  }
                  else if (i != idPlayer) {
                    idPlayer = -1;
                  }
                  for (j = 0; j < *(char *)((int)&rgplr[0].cShDef + i * 0xc0); j = j + 1)
                  {
                    if ((uint)hdrCur.wFlags >> 10 != 0x1a) {
                      idPlayer = iplrSav;
                      goto IO_Corrupt_2;
                    }
                    sVar14 = FReadShDef((RTSHDEF *)rgbCur,
                                        (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x100),
                                                          (SHDEF *)*(undefined2 *)(i * 4 + 0xfe)),
                                        iplrSav);
                    if (sVar14 == 0) goto IO_Corrupt_2;
                    ReadRt();
                  }
                  idPlayer = iplrSav;
                }
                else if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
                  if ((*(int *)(i * 4 + 0xfe) == 0) && (*(int *)(i * 4 + 0x100) == 0)) {
                    pvVar30 = LpAlloc(0x930,htShips);
                    *(undefined2 *)(i * 4 + 0xfe) = (void *)pvVar30;
                    *(undefined2 *)(i * 4 + 0x100) = (int)((ulong)pvVar30 >> 0x10);
                    goto IO_FreeShdef;
                  }
                  goto LAB_1070_1c2c;
                }
              }
              for (i = 0; i < game.cPlayer; i = i + 1) {
                *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
                if ((*(int *)(i * 4 + 0xfe) != 0) || (*(int *)(i * 4 + 0x100) != 0)) {
                  for (j = 0; j < 0x10; j = j + 1) {
                    if ((*(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
                      if (((i == idPlayer) || (((uint)gd._0_2_ >> 1 & 1) != 0)) ||
                         ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0)) {
                        pcVar3 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
                        *pcVar3 = *pcVar3 + '\x01';
                      }
                      else {
                        iplr = *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                        *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) = iplr;
                      }
                    }
                  }
                }
              }
              iVar16 = cFleet;
              if (cFleet < 1) {
                iVar16 = 1;
              }
              rglpfl = LpAlloc(iVar16 << 2,htMisc);
              for (i = 0; i < cFleet; i = i + 1) {
                lpfl = LpAlloc(0x7c,htFleets);
                uVar27 = rglpfl._2_2_;
                ppFVar21 = (FLEET **)rglpfl + i;
                *(FLEET **)ppFVar21 = (FLEET *)lpfl;
                *(undefined2 *)((int)ppFVar21 + 2) = (int)((ulong)lpfl >> 0x10);
                sVar14 = FReadFleet(lpfl);
                if (sVar14 == 0) goto IO_LError_2;
                uVar27 = (undefined2)((ulong)lpfl >> 0x10);
                pFVar18 = (FLEET *)lpfl;
                iplr = *(int *)((int)&rgplr[0].wFlags + pFVar18->iPlayer * 0xc0) + 1U &
                       0xfff;
                puVar2 = (uint *)((int)&rgplr[0].wFlags + pFVar18->iPlayer * 0xc0);
                *puVar2 = *puVar2 & 0xf000;
                puVar2 = (uint *)((int)&rgplr[0].wFlags + pFVar18->iPlayer * 0xc0);
                *puVar2 = *puVar2 | iplr;
              }
              for (i = 0; i < game.cPlayer; i = i + 1) {
                if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
                  if ((*(int *)(i * 4 + 0x14c) == 0) && (*(int *)(i * 4 + 0x14e) == 0)) {
                    pvVar30 = LpAlloc(0x5be,htShips);
                    *(undefined2 *)(i * 4 + 0x14c) = (void *)pvVar30;
                    *(undefined2 *)(i * 4 + 0x14e) = (int)((ulong)pvVar30 >> 0x10);
                    for (j = 0; j < 10; j = j + 1) {
                      iplr = *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                      *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) = iplr;
                      *(undefined2 *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x8b) = 0;
                    }
                  }
                  iplrSav = idPlayer;
                  if (idPlayer == -1) {
                    idPlayer = i;
                  }
                  else if (i != idPlayer) {
                    idPlayer = -1;
                  }
                  for (j = 0; j < (int)(*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 0xc
                                       ); j = j + 1) {
                    if ((uint)hdrCur.wFlags >> 10 != 0x1a) {
                      idPlayer = iplrSav;
                      goto IO_Corrupt_2;
                    }
                    sVar14 = FReadShDef((RTSHDEF *)rgbCur,
                                        (SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x14e),
                                                          (SHDEF *)*(undefined2 *)(i * 4 + 0x14c)),
                                        iplrSav);
                    if (sVar14 == 0) goto IO_Corrupt_2;
                    ReadRt();
                  }
                  idPlayer = iplrSav;
                }
              }
              pSVar31 = vlprgScoreX;
              for (i = 0; vlprgScoreX = pSVar31, i < game.cPlayer; i = i + 1) {
                iplr = *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xfff;
                *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) = iplr;
                if ((*(int *)(i * 4 + 0x14c) != 0) ||
                   (pSVar31 = vlprgScoreX, *(int *)(i * 4 + 0x14e) != 0)) {
                  for (j = 0; pSVar31 = vlprgScoreX, j < 10; j = j + 1) {
                    if ((*(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
                      if (((i == idPlayer) || (((uint)gd._0_2_ >> 1 & 1) != 0)) ||
                         ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0)) {
                        iplr = *(int *)((int)&rgplr[0].wFlags + i * 0xc0) + 0x1000U &
                               0xf000;
                        puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
                        *puVar2 = *puVar2 & 0xfff;
                        puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
                        *puVar2 = *puVar2 | iplr;
                      }
                      else {
                        iplr = *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfdff | 0x200
                        ;
                        *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) = iplr;
                      }
                    }
                  }
                }
              }
              if (pSVar31 == (SCOREX *)0x0) {
                pSVar31 = LpAlloc(game.cPlayer * 0x18,htMisc);
                vlprgScoreX = pSVar31;
                __fmemset(pSVar31,0,game.cPlayer * 0x18);
                pSVar31 = vlprgScoreX;
              }
              while( true ) {
                vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar31 >> 0x10);
                uVar27 = vlprgScoreX._2_2_;
                vlprgScoreX._0_2_ = (SCOREX *)pSVar31;
                vlprgScoreX = pSVar31;
                if ((uint)hdrCur.wFlags >> 10 != 0x2d) break;
                iplr = rgbCur._0_2_ & 0x1f;
                pSVar23 = (SCOREX *)vlprgScoreX + iplr;
                psVar22 = (short *)rgbCur;
                for (iVar16 = 0xc; iVar16 != 0; iVar16 = iVar16 + -1) {
                  pSVar31 = pSVar23;
                  pSVar23 = (SCOREX *)&pSVar23->iRank;
                  psVar4 = psVar22;
                  psVar22 = psVar22 + 1;
                  pSVar31->wWord = *psVar4;
                }
                pSVar31 = vlprgScoreX;
                if ((((SCOREX **)rgsxPlr)[iplr * 2] == (SCOREX *)0x0) &&
                   (*(int *)((undefined *)&DAT_1120_156e + iplr * 4) == 0)) {
                  pSVar31 = LpAlloc(0x978,htMisc);
                  ((SCOREX **)rgsxPlr)[iplr * 2] = (SCOREX *)pSVar31;
                  *(int *)((undefined *)&DAT_1120_156e + iplr * 4) = (int)((ulong)pSVar31 >> 0x10);
                  ((short *)rgcsxPlr)[iplr] = 0;
                  pSVar31 = vlprgScoreX;
                }
                vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar31 >> 0x10);
                vlprgScoreX._0_2_ = (SCOREX *)pSVar31;
                if ((((SCOREX **)rgsxPlr)[iplr * 2] != (SCOREX *)0x0) ||
                   (*(int *)((undefined *)&DAT_1120_156e + iplr * 4) != 0)) {
                  if (((SCOREX *)vlprgScoreX + iplr)->wWord < 0) {
                    turnCur__78 = ((SCOREX *)vlprgScoreX)[iplr].iRank;
                  }
                  else {
                    turnCur__78 = game.turn;
                  }
                  pt = (PLANET *)0x0;
                  while (((int)pt < ((short *)rgcsxPlr)[iplr] &&
                         ((uint)((SCOREX **)rgsxPlr)[iplr * 2][(int)pt].iRank < turnCur__78))
                        ) {
                    pt = (PLANET *)((int)&pt->id + 1);
                  }
                  vlprgScoreX = pSVar31;
                  if ((((int)pt < ((short *)rgcsxPlr)[iplr]) &&
                      (turnCur__78 != ((SCOREX **)rgsxPlr)[iplr * 2][(int)pt].iRank)) ||
                     (100 < (int)pt)) {
                    if (((short *)rgcsxPlr)[iplr] < 0x65) {
                      __fmemmove((SCOREX *)
                                         CONCAT22(*(undefined2 *)
                                                   ((undefined *)&DAT_1120_156e + iplr * 4),
                                                  ((SCOREX **)rgsxPlr)[iplr * 2] +
                                                  (int)((int)&pt->id + 1)),
                                         (SCOREX *)
                                         CONCAT22(*(undefined2 *)
                                                   ((undefined *)&DAT_1120_156e + iplr * 4),
                                                  ((SCOREX **)rgsxPlr)[iplr * 2] + (int)pt),
                                         (((short *)rgcsxPlr)[iplr] - (int)pt) * 0x18);
                      ((short *)rgcsxPlr)[iplr] = ((short *)rgcsxPlr)[iplr] + 1;
                      pSVar31 = vlprgScoreX;
                    }
                    else if (0 < (int)pt) {
                      if (1 < (int)pt) {
                        __fmemmove((SCOREX *)
                                           CONCAT22(*(undefined2 *)
                                                     ((undefined *)&DAT_1120_156e + iplr * 4),
                                                    ((SCOREX **)rgsxPlr)[iplr * 2]),
                                           (SCOREX *)
                                           CONCAT22(*(undefined2 *)
                                                     ((undefined *)&DAT_1120_156e + iplr * 4),
                                                    ((SCOREX **)rgsxPlr)[iplr * 2] + 1),
                                           (int)((int)&pt[-1].lpplprod + 3) * 0x18);
                        pSVar31 = vlprgScoreX;
                      }
                      pt = (PLANET *)((int)&pt[-1].lpplprod + 3);
                    }
                  }
                  else if (pt == (PLANET *)((short *)rgcsxPlr)[iplr]) {
                    ((short *)rgcsxPlr)[iplr] = ((short *)rgcsxPlr)[iplr] + 1;
                    pSVar31 = vlprgScoreX;
                  }
                  vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar31 >> 0x10);
                  uVar13 = vlprgScoreX._2_2_;
                  vlprgScoreX._0_2_ = (SCOREX *)pSVar31;
                  pSVar23 = (SCOREX *)vlprgScoreX + iplr;
                  uVar27 = *(undefined2 *)((undefined *)&DAT_1120_156e + iplr * 4);
                  pSVar26 = ((SCOREX **)rgsxPlr)[iplr * 2] + (int)pt;
                  vlprgScoreX = pSVar31;
                  for (iVar16 = 0xc; iVar16 != 0; iVar16 = iVar16 + -1) {
                    pSVar7 = pSVar26;
                    pSVar26 = (SCOREX *)&pSVar26->iRank;
                    pSVar31 = pSVar23;
                    pSVar23 = (SCOREX *)&pSVar23->iRank;
                    pSVar7->wWord = pSVar31->wWord;
                  }
                  ((SCOREX **)rgsxPlr)[iplr * 2][(int)pt].iRank = turnCur__78;
                  iLast = (((SCOREX **)rgsxPlr)[iplr * 2] + (int)pt)->wWord & 0x7fffU |
                          0x8000;
                  (((SCOREX **)rgsxPlr)[iplr * 2] + (int)pt)->wWord = iLast;
                  pSVar31 = vlprgScoreX;
                }
                vlprgScoreX = pSVar31;
                ReadRt();
                pSVar31 = vlprgScoreX;
              }
              if (lpThings != (THING *)0x0) {
                FreeLp(lpThings,htThings);
                    /* WARNING: Ignoring partial resolution of indirect */
                lpThings._0_2_ = (THING *)0x0;
                    /* WARNING: Ignoring partial resolution of indirect */
                lpThings._2_2_ = 0;
                cThing = 0;
                pSVar31 = vlprgScoreX;
              }
              vlprgScoreX = pSVar31;
              if ((uint)hdrCur.wFlags >> 10 == 0x2b) {
                pt = (PLANET *)(uint)(0 < cThing);
                iplr._0_1_ = rgbCur[0];
                iplr._1_1_ = rgbCur[1];
                cThingAlloc = rgbCur._0_2_;
                if ((int)rgbCur._0_2_ < 10) {
                  cThingAlloc = 10;
                }
                if (lpThings == (THING *)0x0) {
                  pTVar32 = LpAlloc(cThingAlloc * 0x12,htThings);
                    /* WARNING: Ignoring partial resolution of indirect */
                  lpThings._0_2_ = (THING *)pTVar32;
                    /* WARNING: Ignoring partial resolution of indirect */
                  lpThings._2_2_ = (int)((ulong)pTVar32 >> 0x10);
                  if (lpThings == (THING *)0x0) break;
                  __fmemset(lpThings,0,cThingAlloc * 0x12);
                  pSVar31 = vlprgScoreX;
                }
                vlprgScoreX = pSVar31;
                ReadRt();
                lpth = lpThings;
                j = 0;
                for (i = 0; i < iplr; i = i + 1) {
                  fHaveHistoryData = 0;
                  if (pt == (PLANET *)0x0) {
LAB_1070_270b:
                    cThing = cThing + 1;
                  }
                  else {
                    while ((j < cThing && ((uint)lpth->idFull < (uint)rgbCur._0_2_)
                           )) {
                      j = j + 1;
                      lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
                    }
                    if ((cThing <= j) || (rgbCur._0_2_ != lpth->idFull)) {
                      if (cThingAlloc == cThing) {
                        cThingAlloc = cThingAlloc + 8;
                        pTVar32 = LpReAlloc(lpThings,cThingAlloc * 0x12,
                                                    htThings);
                    /* WARNING: Ignoring partial resolution of indirect */
                        lpThings._0_2_ = (THING *)pTVar32;
                    /* WARNING: Ignoring partial resolution of indirect */
                        lpThings._2_2_ = (int)((ulong)pTVar32 >> 0x10);
                        lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings + j)
                        ;
                      }
                      if (j < cThing) {
                        __fmemmove((THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1),lpth,
                                           (cThing - j) * 0x12);
                        __fmemset(lpth,0,0x12);
                      }
                      goto LAB_1070_270b;
                    }
                    fHaveHistoryData = 1;
                  }
                  __fmemcpy(lpth,rgbCur,hdrCur.wFlags & 0x3ff);
                  uVar27 = (undefined2)((ulong)lpth >> 0x10);
                  ((THING *)lpth)->turn = game.turn;
                  lpth = (THING *)CONCAT22(uVar27,(THING *)lpth + 1);
                  j = j + 1;
                  ReadRt();
                }
              }
              else {
                cThing = 0;
                cThingAlloc = 10;
                pTVar32 = LpAlloc(0xb4,htThings);
                    /* WARNING: Ignoring partial resolution of indirect */
                lpThings._0_2_ = (THING *)pTVar32;
                    /* WARNING: Ignoring partial resolution of indirect */
                lpThings._2_2_ = (int)((ulong)pTVar32 >> 0x10);
              }
              if ((uint)hdrCur.wFlags >> 10 == 0x16) {
                ReadRt();
              }
              iplrSav = idPlayer;
              while ((uint)hdrCur.wFlags >> 10 == 0x1e) {
                idPlayer = rgbCur._0_2_ & 0xf;
                iplr = idPlayer;
                if ((((BTLPLAN **)rglpbtlplan)[idPlayer * 2] == (BTLPLAN *)0x0) &&
                   (((undefined2 *)&DAT_1120_593a)[idPlayer * 2] == 0)) {
                  pBVar33 = LpAlloc(0x240,htShips);
                  ((BTLPLAN **)rglpbtlplan)[iplr * 2] = (BTLPLAN *)pBVar33;
                  ((undefined2 *)&DAT_1120_593a)[iplr * 2] = (int)((ulong)pBVar33 >> 0x10);
                }
                UnpackBattlePlan((byte *)rgbCur,
                                 (BTLPLAN *)
                                 CONCAT22(((undefined2 *)&DAT_1120_593a)[iplr * 2],
                                          ((BTLPLAN **)rglpbtlplan)[iplr * 2] +
                                          ((byte *)rgcbtlplan)[iplr]),
                                 (uint)((byte *)rgcbtlplan)[iplr]);
                ((byte *)rgcbtlplan)[iplr] = ((byte *)rgcbtlplan)[iplr] + 1;
                ReadRt();
              }
              idPlayer = iplrSav;
              if ((uint)hdrCur.wFlags >> 10 != 0) {
IO_Corrupt_2:
                sVar14 = 0x10;
                pcVar19 = PszFormatIds(idsGameFileAppearsCorruptUnableLoadFile,(short *)0x0);
                AlertSz(pcVar19,sVar14);
                break;
              }
              pPVar28 = (PLANET *)__filelength(hf);
              iplr = (short)((ulong)pPVar28 >> 0x10);
              pt = (PLANET *)pPVar28;
              pPVar28 = (PLANET *)__tell(hf);
              if (pPVar28 == (PLANET *)CONCAT22(iplr,pt)) goto LAB_1070_2a56;
              ReadRt();
              if ((uint)hdrCur.wFlags >> 10 != 8) goto LAB_1070_2a35;
              game.turn._0_1_ = rgbCur[10];
              game.turn._1_1_ = rgbCur[0xb];
              game.wCrap =
                   game.wCrap & 0xf1ffU | ((uint)rgbCur._14_2_ >> 0xd) << 9;
              i = 0;
              lppl = lpPlanets;
              while( true ) {
                lpPlanets._2_2_ = (short)((ulong)lppl >> 0x10);
                lpPlanets._0_2_ = (PLANET *)lppl;
                lpPlanets = lppl;
                if (game.cPlayer <= i) break;
                *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
                *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
                     *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xf000;
                *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
                *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
                     *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xfff;
                ((byte *)rgcbtlplan)[i] = 0;
                i = i + 1;
                lppl = lpPlanets;
              }
              pt = (PLANET *)lpPlanets;
              iplr = lpPlanets._2_2_;
              lpplMac = (PLANET *)lpPlanets + cPlanet;
              local_40 = iplr;
              while ((PLANET *)lppl < lpplMac) {
                uVar27 = (undefined2)((ulong)lppl >> 0x10);
                if (((PLANET *)lppl)->iPlayer == iPlayer) {
                  ((PLANET *)lppl)->iPlayer = -1;
                  ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xff00U | 3;
                  if ((*(int *)&((PLANET *)lppl)->lpplprod != 0) ||
                     (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) {
                    FreePl((PL *)CONCAT22(*(undefined2 *)
                                                   ((int)&((PLANET *)lppl)->lpplprod + 2),
                                                  *(PL **)&((PLANET *)lppl)->lpplprod));
                    uVar27 = (undefined2)((ulong)lppl >> 0x10);
                    *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
                    *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
                  }
                }
                lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
              }
              cPlanetHist = cPlanet;
            } while( true );
          }
          goto IO_LError_2;
        }
      }
IO_XYCorrupt:
      sVar14 = 0x10;
      pcVar19 = PszFormatIds(idsUniverseDefinitionFileSeemsMissingCorrupt,(short *)0x0);
      AlertSz(pcVar19,sVar14);
    }
  }
IO_LError_2:
  game.fDirty = 0;
  DestroyCurGame();
  StreamClose();
  if (((((uint)ini.wFlags >> 0xe & 1) == 0) && (-1 < ini.wFlags)) &&
     (hwndTitle == 0)) {
    pt = (PLANET *)GetSystemMetrics(0);
    iplr = GetSystemMetrics(1);
    hwndTitle =
         CreateWindow(szTitle,(LPCSTR)0x11200752,0x90000000,0,0,(short)pt,iplr,
                      hwndFrame,0,hInst,(void *)0x0);
    fFreeingTitle = 0;
    ShowWindow(hwndFrame,0);
  }
  sVar14 = 0;
  pbVar10 = vlpbAiData;
  pTVar32 = lpThings;
  pPVar28 = lpPlanets;
  ppFVar11 = rglpfl;
  pSVar31 = vlprgScoreX;
  pbVar12 = lpbBattleLog;
LAB_1070_3200:
  lpbBattleLog._2_2_ = (undefined2)((ulong)pbVar12 >> 0x10);
  lpbBattleLog._0_2_ = (byte *)pbVar12;
  vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar31 >> 0x10);
  vlprgScoreX._0_2_ = (SCOREX *)pSVar31;
  rglpfl._2_2_ = (undefined2)((ulong)ppFVar11 >> 0x10);
  rglpfl._0_2_ = (FLEET **)ppFVar11;
  lpPlanets._2_2_ = (short)((ulong)pPVar28 >> 0x10);
  lpPlanets._0_2_ = (PLANET *)pPVar28;
  lpThings._2_2_ = (short)((ulong)pTVar32 >> 0x10);
  lpThings._0_2_ = (THING *)pTVar32;
  vlpbAiData._2_2_ = (int)((ulong)pbVar10 >> 0x10);
  vlpbAiData._0_2_ = (byte *)pbVar10;
  return sVar14;
LAB_1070_2a35:
  sVar14 = 0x10;
  pcVar19 = PszFormatIds(idsWarningIgnoringUnexpectedDataAfterEof,(short *)0x0);
  AlertSz(pcVar19,sVar14);
LAB_1070_2a56:
  StreamClose();
  if ((((1 < cturn) && ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0)
       ) && (((uint)ini.wFlags >> 0xc & 1) == 0)) &&
     ((((uint)ini.wFlags >> 0xb & 1) == 0 &&
      (((uint)ini.wFlags >> 0xd & 1) == 0)))) {
    sVar14 = cturn;
    pcVar19 = PszGetCompressedString(idsNoteDYearsDataRead);
    wsprintf(szWork,(char *)pcVar19,sVar14);
    AlertSz((char *)szWork,0x40);
  }
  sVar14 = __strnicmp(pszExt,(char *)0x759,3);
  ppFVar11 = rglpfl;
  if (sVar14 != 0) {
    pPVar28 = lpPlanets;
    if ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0) {
      fTwo = (short)(THING *)lpThings;
      iWarp = lpThings._2_2_;
      lpth = lpThings;
      lpthMac = (THING *)lpThings + cThing;
      local_38 = iWarp;
      while( true ) {
        lpPlanets._2_2_ = (short)((ulong)pPVar28 >> 0x10);
        lpPlanets._0_2_ = (PLANET *)pPVar28;
        if (lpthMac <= (THING *)lpth) break;
        if (((uint)lpth->idFull >> 0xd == 1) &&
           (uVar27 = (undefined2)((ulong)lpth >> 0x10),
           (*(uint *)((THING *)lpth)->rgb >> 10 & 0xf) != 0)) {
          lpPlanets = pPVar28;
          lppl = LpplFromId(*(uint *)((THING *)lpth)->rgb & 0x3ff);
          iVar16 = (int)((ulong)lppl >> 0x10);
          pPVar28 = lpPlanets;
          if ((((PLANET *)lppl != (PLANET *)0x0) || (iVar16 != 0)) &&
             (((PLANET *)lppl)->iPlayer == iPlayer)) {
            iWarp = IWarpMAFromLppl(lppl,&fTwo);
            pPVar28 = lpPlanets;
            if (iWarp + fTwo < (int)((*(uint *)((THING *)lpth)->rgb >> 10 & 0xf) + 4)) {
              FSendPlrMsg2XGen
                        (0,idmMassPacketAppearsCollisionCourseWhichCurrently,-6,lpth->idFull,
                         lppl->id);
              pPVar28 = lpPlanets;
            }
          }
        }
        lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
      }
      if (((uint)game.wCrap >> 3 & 1) == 0) {
        fTwo = (short)(PLANET *)lpPlanets;
        iWarp = lpPlanets._2_2_;
        lpplMac = (PLANET *)lpPlanets + cPlanet;
        local_40 = iWarp;
        lppl = pPVar28;
        while ((PLANET *)lppl < lpplMac) {
          uVar27 = (undefined2)((ulong)lppl >> 0x10);
          if ((((((PLANET *)lppl)->iPlayer == iPlayer) &&
               (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)) &&
              ((*(int *)&((PLANET *)lppl)->lpplprod != 0 ||
               (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)))) &&
             (iVar16 = ((PLANET *)lppl)->iPlayer * 4,
             *(int *)(*(int *)(iVar16 + 0x14c) +
                     (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) * 0x93) != 0x20)) {
            iplr = 0;
            pt = (PLANET *)0x0;
            lpprod._0_2_ = *(PROD **)&((PLANET *)lppl)->lpplprod;
            lpprod._2_2_ = *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2);
            for (; lpprod._0_2_ = (PROD *)lpprod + 1, pPVar8 = ((PLANET *)lppl)->lpplprod,
                (int)pt < (int)(uint)((PLPROD *)pPVar8)->iprodMac; pt = (PLANET *)((int)&pt->id + 1)
                ) {
              lpPlanets = pPVar28;
              EstimateItemProdSched
                        (lppl,(PLPROD *)0x0,(short)pt,(short *)&turnCur__78,&iLast);
              pPVar28 = lpPlanets;
              if (1 < iLast) {
                iplr = 0;
                break;
              }
              if (iLast == 1) {
                uVar34 = __aFulshr(in_stack_0000fe8e,in_stack_0000fe92);
                if (((uint)uVar34 & 7) == 1) {
                  uVar34 = __aFulshr(in_stack_0000fe8e,in_stack_0000fe92);
                  pPVar28 = lpPlanets;
                  if (((uint)uVar34 & 0x7f) < 7) goto LAB_1070_2cf9;
                }
                iplr = 1;
                pPVar28 = lpPlanets;
              }
LAB_1070_2cf9:
            }
            if (iplr != 0) {
              lpPlanets = pPVar28;
              FSendPlrMsg2XGen
                        (0,idmStarbaseScheduledCompleteRemainingProductionItem,lppl->id,lppl->id,0);
              pPVar28 = lpPlanets;
            }
          }
          lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
        }
        lpPlanets = pPVar28;
        i = CBattles();
        pPVar28 = lpPlanets;
        if (0 < i) {
          FSendPlrMsg2XGen(1,(1 < i) + idmHaveReceivedOneBattleRecordingYear,-7,i,0);
          pPVar28 = lpPlanets;
        }
      }
    }
    if (((uint)gd.wFlags >> 1 & 1) == 0) {
      lpPlanets = pPVar28;
      wsprintf(szWork,(char *)0x1120075d);
      sVar14 = FLoadLogFile((char *)szWork);
      if (sVar14 != 0) {
        sVar14 = FRunLogFile();
        pPVar28 = lpPlanets;
        if (sVar14 != 0) goto LAB_1070_2eb1;
      }
      sVar14 = 0x10;
      pcVar19 = PszFormatIds(idsPlayerLogFileAppearsCorruptUnableLoad,(short *)0x0);
      AlertSz(pcVar19,sVar14);
      goto IO_LError_2;
    }
LAB_1070_2eb1:
    i = 0;
    lppl = pPVar28;
    while( true ) {
      lpPlanets._2_2_ = (short)((ulong)lppl >> 0x10);
      lpPlanets._0_2_ = (PLANET *)lppl;
      lpPlanets = lppl;
      if (game.cPlayer <= i) break;
      *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xf000;
      *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
      i = i + 1;
      lppl = lpPlanets;
    }
    pt = (PLANET *)lpPlanets;
    local_40 = lpPlanets._2_2_;
    lpplMac = (PLANET *)lpPlanets + cPlanet;
    while ((PLANET *)lppl < lpplMac) {
      uVar27 = (undefined2)((ulong)lppl >> 0x10);
      if (((PLANET *)lppl)->iPlayer == -1) {
        ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xfdff;
      }
      else {
        piVar1 = (int *)((int)&rgplr[0].cPlanet + ((PLANET *)lppl)->iPlayer * 0xc0);
        *piVar1 = *piVar1 + 1;
      }
      lppl = (PLANET *)CONCAT22(uVar27,(PLANET *)lppl + 1);
    }
    j = 0;
    i = 0;
    iplr = local_40;
    ppFVar11 = rglpfl;
    while( true ) {
      rglpfl._2_2_ = (undefined2)((ulong)ppFVar11 >> 0x10);
      rglpfl._0_2_ = (FLEET **)ppFVar11;
      if (cFleet <= i) break;
                    /* WARNING: Load size is inaccurate */
      pFVar18 = ((FLEET **)rglpfl)[i];
      iVar16 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpfl = (FLEET *)CONCAT22(iVar16,pFVar18);
      if ((pFVar18 == (FLEET *)0x0) && (iVar16 == 0)) break;
      j = pFVar18->iPlayer;
      iplr = *(int *)((int)&rgplr[0].wFlags + j * 0xc0) + 1U & 0xfff;
      puVar2 = (uint *)((int)&rgplr[0].wFlags + j * 0xc0);
      rglpfl = ppFVar11;
      *puVar2 = *puVar2 & 0xf000;
      puVar2 = (uint *)((int)&rgplr[0].wFlags + j * 0xc0);
      *puVar2 = *puVar2 | iplr;
      i = i + 1;
      ppFVar11 = rglpfl;
    }
  }
  idPlayer = iPlayer;
  pbVar10 = vlpbAiData;
  pTVar32 = lpThings;
  pPVar28 = lpPlanets;
  pSVar31 = vlprgScoreX;
  pbVar12 = lpbBattleLog;
  if (((iPlayer != -1) &&
      ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0)) &&
     (((char *)vrgszMRU != (char *)0x0 || (vrgszMRU._2_2_ != 0)))) {
    rglpfl = ppFVar11;
    _strcpy(szT,pszFileName);
    _strcat(szT,(char *)0x764);
    _strcat(szT,pszExt);
    sVar14 = __fstricmp((char *)szT,
                                (char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU));
    pbVar10 = vlpbAiData;
    pTVar32 = lpThings;
    pPVar28 = lpPlanets;
    pSVar31 = vlprgScoreX;
    ppFVar11 = rglpfl;
    pbVar12 = lpbBattleLog;
    if (sVar14 != 0) {
      for (i = 1; i < 8; i = i + 1) {
        sVar14 = __fstricmp((char *)szT,
                                    (char *)CONCAT22(vrgszMRU._2_2_,
                                                     (char *)vrgszMRU + i * 0x100));
        if (sVar14 == 0) break;
      }
      for (; 0 < i; i = i + -1) {
        __fstrcpy((char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU + i * 0x100
                                          ),
                          (char *)CONCAT22(vrgszMRU._2_2_,
                                           (char *)vrgszMRU + (i + -1) * 0x100));
      }
      __fstrcpy((char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU),(char *)szT)
      ;
      CchGetString(idsStarsIni,szIniFile);
      CchGetString(idsFiles,&stack0xfe98);
      CchGetString(idsFile1,&stack0xfe86);
      uVar15 = _strlen(&stack0xfe86);
      pcVar19 = &stack0xfe85 + uVar15;
      for (i = 0; pbVar10 = vlpbAiData, pTVar32 = lpThings, pPVar28 = lpPlanets
          , pSVar31 = vlprgScoreX, ppFVar11 = rglpfl, pbVar12 = lpbBattleLog,
          i < 9; i = i + 1) {
        *pcVar19 = (char)i + '1';
        __fstrcpy((char *)szT,
                          (char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU + i * 0x100
                                          ));
        WritePrivateProfileString
                  ((LPCSTR)&stack0xfe98,(LPCSTR)&stack0xfe86,(LPCSTR)szT,(LPCSTR)szIniFile);
      }
    }
  }
  sVar14 = 1;
  goto LAB_1070_3200;
}



// ======================================================================
// Function: FReadPlanet
// Address: 1070:3206
// Segment: MEMORY_IO
// ======================================================================


short FReadPlanet(short iPlayer,PLANET *lppl,short fHistory,short fPreInited)

{
  uint uVar1;
  undefined2 uVar2;
  bool bVar3;
  byte bVar4;
  uint uVar5;
  short sVar6;
  short sVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar8;
  ushort in_stack_0000ffea;
  short pct;
  short pctOpt;
  short idm;
  byte *pb;
  short i;
  byte bMask;
  short fRouting;
  short fFirstYear;
  
  lVar8 = CONCAT22(unaff_SI,unaff_DI);
  bVar3 = false;
  if (fPreInited == 0) {
    __fmemset(lppl,0,0x38);
  }
  if ((fHistory == 0) && (iPlayer != -1)) {
    if (fPreInited == 0) {
      bVar3 = true;
      ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xf7ffU | 0x800;
    }
    else if (((uint)((PLANET *)lppl)->wFlags >> 0xb & 1) != 0) {
      if (((PLANET *)lppl)->turn == game.turn) {
        bVar3 = true;
      }
      else {
        ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xf7ff;
      }
    }
  }
  else {
    ((PLANET *)lppl)->wFlags =
         ((PLANET *)lppl)->wFlags & 0xf7ffU | ((uint)rgbCur._2_2_ >> 0xf) << 0xb;
  }
  lppl->id = (int)(rgbCur._0_2_ << 5) >> 5;
  ((PLANET *)lppl)->iPlayer = (int)rgbCur._0_2_ >> 0xb;
  if ((((PLANET *)lppl)->wFlags & 0xffU) < (rgbCur._2_2_ & 0x7f)) {
    ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xff00U | rgbCur._2_2_ & 0x7f;
  }
  ((PLANET *)lppl)->wFlags =
       ((PLANET *)lppl)->wFlags & 0xfeffU | ((uint)rgbCur._2_2_ >> 8 & 1) << 8;
  ((PLANET *)lppl)->wFlags =
       ((PLANET *)lppl)->wFlags & 0xfdffU | ((uint)rgbCur._2_2_ >> 9 & 1) << 9;
  ((PLANET *)lppl)->wFlags =
       ((PLANET *)lppl)->wFlags & 0xfbffU | ((uint)rgbCur._2_2_ >> 7 & 1) << 10;
  uVar5 = (uint)rgbCur._2_2_ >> 0xe;
  if ((((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0) && (((PLANET *)lppl)->iPlayer == -1)) {
    ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xfdff;
  }
  if (fHistory == 0) {
    ((PLANET *)lppl)->turn = game.turn;
  }
  pb = (byte *)((char *)rgbCur + 4);
  if (2 < (rgbCur._2_2_ & 0x7f)) {
    bMask = rgbCur[4];
    pb = (byte *)((char *)rgbCur + 5);
    for (i = 0; i < 3; i = i + 1) {
      if ((bMask & 3) == 0) {
        ((PLANET *)lppl)->rgpctMinLevel[i] = 0;
      }
      else {
        if ((bMask & 3) != 1) {
          return 0;
        }
        ((PLANET *)lppl)->rgpctMinLevel[i] = *pb;
        pb = pb + 1;
      }
      bMask = (byte)((int)(uint)bMask >> 2);
    }
    for (i = 0; i < 3; i = i + 1) {
      ((PLANET *)lppl)->rgMinConc[i] = *pb;
      pb = pb + 1;
    }
    for (i = 0; i < 3; i = i + 1) {
      if (100 < *pb) {
        return 0;
      }
      bVar4 = *pb;
      ((PLANET *)lppl)->rgEnvVarOrig[i] = bVar4;
      ((PLANET *)lppl)->rgEnvVar[i] = bVar4;
      pb = pb + 1;
    }
    if (((uint)rgbCur._2_2_ >> 10 & 1) != 0) {
      for (i = 0; i < 3; i = i + 1) {
        if (100 < *pb) {
          return 0;
        }
        ((PLANET *)lppl)->rgEnvVarOrig[i] = *pb;
        pb = pb + 1;
      }
    }
    if ((int)rgbCur._0_2_ >> 0xb != -1) {
      ((PLANET *)lppl)->uGuesses = *(short *)pb;
      pb = pb + 2;
    }
    if (3 < (((PLANET *)lppl)->wFlags & 0xffU)) {
      if (((uint)rgbCur._2_2_ >> 0xd & 1) != 0) {
        bMask = *pb;
        pb = pb + 1;
        for (i = 0; i < 4; i = i + 1) {
          bVar4 = bMask & 3;
          if ((bMask & 3) == 0) {
            *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = 0;
            *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
          }
          else if (bVar4 == 1) {
            *(uint *)(((PLANET *)lppl)->rgwtMin + i) = (uint)*pb;
            *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
            pb = pb + 1;
          }
          else if (bVar4 == 2) {
            *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = *(undefined2 *)pb;
            *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = 0;
            pb = pb + 2;
          }
          else if (bVar4 == 3) {
            uVar2 = *(undefined2 *)(pb + 2);
            *(undefined2 *)(((PLANET *)lppl)->rgwtMin + i) = *(undefined2 *)pb;
            *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) = uVar2;
            pb = pb + 4;
          }
          bMask = (byte)((int)(uint)bMask >> 2);
        }
      }
      if ((uint)hdrCur.wFlags >> 10 != 0xe) {
        if (((uint)rgbCur._2_2_ >> 0xb & 1) == 0) {
          lVar8 = __aFlshl(lVar8,in_stack_0000ffea);
          uVar1 = *(uint *)((int)&((PLANET *)lppl)->dwFlags + 2);
          *(uint *)&((PLANET *)lppl)->dwFlags = *(uint *)&((PLANET *)lppl)->dwFlags | (uint)lVar8;
          *(uint *)((int)&((PLANET *)lppl)->dwFlags + 2) =
               uVar1 & 0xffbf | (uint)((ulong)lVar8 >> 0x10);
          uVar1 = *(uint *)((int)&((PLANET *)lppl)->dwFlags + 2);
          *(uint *)&((PLANET *)lppl)->dwFlags = *(uint *)&((PLANET *)lppl)->dwFlags & 0xfff | 0xf000
          ;
          *(uint *)((int)&((PLANET *)lppl)->dwFlags + 2) = uVar1 & 0xfffe | 1;
          uVar2 = *(undefined2 *)((int)&((PLANET *)lppl)->dwFlags + 2);
          *(uint *)&((PLANET *)lppl)->dwFlags = *(uint *)&((PLANET *)lppl)->dwFlags & 0xf000;
          *(undefined2 *)((int)&((PLANET *)lppl)->dwFlags + 2) = uVar2;
        }
        else {
          __fmemmove((long *)CONCAT22(lppl._2_2_,&((PLANET *)lppl)->dwFlags),(byte *)pb,8);
          pb = pb + 8;
        }
        if (((PLANET *)lppl)->iPlayer != -1) {
          if (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0) {
            sVar6 = *(short *)(pb + 2);
            *(undefined2 *)&((PLANET *)lppl)->field11_0x2c = *(undefined2 *)pb;
            ((PLANET *)lppl)->wFlags = sVar6;
            ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xbfff;
            pb = pb + 4;
          }
          if ((uVar5 & 1) != 0) {
            ((PLANET *)lppl)->wRouting = *(short *)pb;
          }
        }
        return 1;
      }
    }
  }
  if (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0) {
    *(uint *)&((PLANET *)lppl)->field11_0x2c =
         *(uint *)&((PLANET *)lppl)->field11_0x2c & 0xfff0 | *pb & 0xf;
    pb = pb + 1;
  }
  if (fHistory == 0) {
    if (bVar3) {
      if (((PLANET *)lppl)->iPlayer == -1) {
        if ((((PLANET *)lppl)->wFlags & 0xffU) < 2) {
          FSendPlrMsg2XGen(0,idmHaveFoundNewPlanetDontKnowIf,lppl->id,lppl->id,0);
        }
        else {
          sVar6 = GetRaceStat((PLAYER *)rgplr + iPlayer,rsMajorAdv);
          if (sVar6 == raTerra) {
            sVar6 = PctPlanetOptValue(lppl,iPlayer);
            FSendPlrMsg2XGen(0,idmHaveInfoNewPlanetIfColonizeCan,lppl->id,lppl->id,sVar6);
          }
          else {
            sVar6 = PctPlanetDesirability(lppl,iPlayer);
            if (sVar6 < 1) {
              sVar7 = PctPlanetOptValue(lppl,iPlayer);
              if (sVar7 < 1) {
                pct = sVar6 * 10;
                idm = 0xab;
              }
              else {
                sVar6 = PctTrueMaxGrowth(iPlayer);
                pct = sVar6 * sVar7;
                idm = 0xae;
              }
            }
            else {
              sVar7 = PctTrueMaxGrowth(iPlayer);
              pct = sVar7 * sVar6;
              idm = 0xac;
            }
            sVar6 = lppl->id;
            sVar7 = _abs(pct);
            FSendPlrMsg2XGen(0,idm,lppl->id,sVar7,sVar6);
          }
        }
      }
      else {
        FSendPlrMsg2XGen
                  (0,idmHaveFoundPlanetOccupiedSomeoneElseCurrently,lppl->id,lppl->id,
                   ((PLANET *)lppl)->iPlayer | 0x30);
      }
    }
  }
  else {
    ((PLANET *)lppl)->turn = *(short *)pb;
  }
  return 1;
}



// ======================================================================
// Function: FReadFleet
// Address: 1070:3a4c
// Segment: MEMORY_IO
// ======================================================================


short FReadFleet(FLEET *lpfl)

{
  ushort *puVar1;
  short *psVar2;
  ORDER *pOVar3;
  uint uVar4;
  char *sz;
  ushort uVar5;
  short sVar6;
  int iVar7;
  short *psVar8;
  ORDER *pOVar9;
  ORDER *pOVar10;
  undefined2 uVar11;
  undefined2 unaff_SS;
  PL *pPVar12;
  void *pvVar13;
  HeapType HVar14;
  short cOut;
  char szT [34];
  ushort *pus;
  short cch;
  ushort *pb;
  short cish;
  short i;
  ORDER *lpord;
  short fByte;
  short cord;
  ushort us;
  
  cish = 0;
  __fmemset(lpfl,0,0x7c);
  __fmemmove(lpfl,rgbCur,0xc);
  fByte = (uint)((FLEET *)lpfl)->wFlags >> 0xb & 1;
  us._0_1_ = rgbCur[0xc];
  us._1_1_ = rgbCur[0xd];
  pb = (ushort *)((char *)rgbCur + 0xe);
  if (fByte == 0) {
    pus = (ushort *)((char *)rgbCur + 0xe);
    i = 0;
    for (; us != 0; us = us >> 1) {
      if ((us & 1) != 0) {
        puVar1 = pus + 1;
        ((FLEET *)lpfl)->rgcsh[i] = *pus;
        pus = puVar1;
        if (((FLEET *)lpfl)->rgcsh[i] != 0) {
          cish = cish + 1;
        }
      }
      i = i + 1;
    }
    pb = pus;
  }
  else {
    i = 0;
    for (; us != 0; us = us >> 1) {
      if ((us & 1) != 0) {
        puVar1 = (ushort *)((int)pb + 1);
        ((FLEET *)lpfl)->rgcsh[i] = (uint)(byte)*pb;
        pb = puVar1;
        if (((FLEET *)lpfl)->rgcsh[i] != 0) {
          cish = cish + 1;
        }
      }
      i = i + 1;
    }
  }
  if (cish == 0) {
    ((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0xfbffU | 0x400;
  }
  if (3 < (((FLEET *)lpfl)->wFlags & 0xffU)) {
    us = *pb;
    pb = pb + 1;
    for (i = 0; i < 5; i = i + 1) {
      uVar4 = us & 3;
      if (uVar4 == 1) {
        *(uint *)(((FLEET *)lpfl)->rgwtMin + i) = (uint)(byte)*pb;
        *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = 0;
        pb = (ushort *)((int)pb + 1);
      }
      else if (uVar4 == 2) {
        *(ushort *)(((FLEET *)lpfl)->rgwtMin + i) = *pb;
        *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = 0;
        pb = pb + 1;
      }
      else if (uVar4 == 3) {
        uVar5 = pb[1];
        *(ushort *)(((FLEET *)lpfl)->rgwtMin + i) = *pb;
        *(ushort *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = uVar5;
        pb = pb + 2;
      }
      us = us >> 2;
    }
  }
  if ((((FLEET *)lpfl)->wFlags & 0xffU) < 7) {
    uVar5 = pb[1];
    *(ushort *)&((FLEET *)lpfl)->field17_0x74 = *pb;
    ((FLEET *)lpfl)->wFlags = uVar5;
    uVar5 = pb[3];
    ((FLEET *)lpfl)->rgdv->dp = pb[2];
    (((FLEET *)lpfl)->rgdv + 1)->dp = uVar5;
    pb = pb + 4;
    ReadRt();
    return 1;
  }
  if ((uint)hdrCur.wFlags >> 10 == 0x10) {
    us = *pb;
    pus = pb + 1;
    i = 0;
    for (; us != 0; us = us >> 1) {
      if ((us & 1) != 0) {
        puVar1 = pus + 1;
        (((FLEET *)lpfl)->rgdv + i)->dp = *pus;
        pus = puVar1;
        if (499 < (uint)(((FLEET *)lpfl)->rgdv + i)->dp >> 7) {
          (((FLEET *)lpfl)->rgdv + i)->dp = (((FLEET *)lpfl)->rgdv + i)->dp & 0x7fU | 0xf980;
        }
      }
      i = i + 1;
    }
    ((FLEET *)lpfl)->iplan = (byte)*pus;
    pb = pus + 1;
    ((FLEET *)lpfl)->cord = (uint)*(byte *)((int)pus + 1);
    pPVar12 = LpplAlloc(0x12,((FLEET *)lpfl)->cord + 1,htOrd);
    *(PL **)&((FLEET *)lpfl)->lpplord = (PL *)pPVar12;
    *(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2) = (int)((ulong)pPVar12 >> 0x10);
    __fmemset((void *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2),
                                       (void *)(*(int *)&((FLEET *)lpfl)->lpplord + 4)),0,
                      (((FLEET *)lpfl)->cord + 1) * 0x12);
    cord = ((FLEET *)lpfl)->cord;
    lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2),
                              (ORDER *)(*(int *)&((FLEET *)lpfl)->lpplord + 4));
    for (; cord != 0; cord = cord + -1) {
      _memset((char *)rgbCur,0,0x12);
      ReadRt();
      if (((uint)hdrCur.wFlags >> 10 != 0x13) &&
         ((uint)hdrCur.wFlags >> 10 != 0x14)) goto IO_Corrupt;
      psVar8 = (short *)rgbCur;
      uVar11 = (undefined2)((ulong)lpord >> 0x10);
      pOVar9 = (ORDER *)lpord;
      pOVar10 = pOVar9;
      for (iVar7 = 9; iVar7 != 0; iVar7 = iVar7 + -1) {
        pOVar3 = pOVar10;
        pOVar10 = (ORDER *)&(pOVar10->pt).y;
        psVar2 = psVar8;
        psVar8 = psVar8 + 1;
        (pOVar3->pt).x = *psVar2;
      }
      pOVar9->wFlags = pOVar9->wFlags & 0xdfff;
      lpord = (ORDER *)CONCAT22(uVar11,pOVar9 + 1);
    }
    ((PLORD *)((FLEET *)lpfl)->lpplord)->iordMac = (byte)((FLEET *)lpfl)->cord;
    if (((FLEET *)lpfl)->idPlanet != -1) {
      if (game.cPlanMax < ((FLEET *)lpfl)->idPlanet) {
        ((FLEET *)lpfl)->idPlanet = -1;
      }
      if (((&((FLEET *)lpfl)->pt)->x != ((POINT *)rgptPlan + ((FLEET *)lpfl)->idPlanet)->x
          ) || ((((FLEET *)lpfl)->pt).y !=
                *(int *)((int)&rgptPlan[0].y + ((FLEET *)lpfl)->idPlanet * 4))) {
        if ((i != 0) || (game.turn != 0)) goto IO_Corrupt;
        sVar6 = *(short *)((int)&rgptPlan[0].y + ((FLEET *)lpfl)->idPlanet * 4);
        (&((FLEET *)lpfl)->pt)->x = ((POINT *)rgptPlan + ((FLEET *)lpfl)->idPlanet)->x;
        (((FLEET *)lpfl)->pt).y = sVar6;
      }
    }
    ReadRt();
    if ((uint)hdrCur.wFlags >> 10 == 0x15) {
      cch = (short)rgbCur[0];
      if (cch == 0) {
        HVar14 = htString;
        uVar5 = _strlen((char *)rgbCur + 1);
        pvVar13 = LpAlloc(uVar5 + 1,HVar14);
        *(void **)&((FLEET *)lpfl)->lpszName = (void *)pvVar13;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = (int)((ulong)pvVar13 >> 0x10);
                    /* WARNING: Load size is inaccurate */
        __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2),
                                           ((FLEET *)lpfl)->lpszName),rgbCur + 1);
      }
      else {
        cOut = 0x20;
        FDecompressUserString(rgbCur + 1,cch,(char *)szT,&cOut);
        HVar14 = htString;
        uVar5 = _strlen(szT);
        pvVar13 = LpAlloc(uVar5 + 1,HVar14);
        *(void **)&((FLEET *)lpfl)->lpszName = (void *)pvVar13;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = (int)((ulong)pvVar13 >> 0x10);
                    /* WARNING: Load size is inaccurate */
        __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2),
                                           ((FLEET *)lpfl)->lpszName),(char *)szT);
      }
      ReadRt();
    }
    else {
      *(undefined2 *)&((FLEET *)lpfl)->lpszName = 0;
      *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = 0;
    }
    sVar6 = 1;
  }
  else {
IO_Corrupt:
    sVar6 = 0x10;
    sz = PszFormatIds(idsGameFileAppearsCorruptUnableLoadFile,(short *)0x0);
    AlertSz(sz,sVar6);
    sVar6 = 0;
  }
  return sVar6;
}



// ======================================================================
// Function: UnpackBattlePlan
// Address: 1070:40ce
// Segment: MEMORY_IO
// ======================================================================


void UnpackBattlePlan(byte *lpb,BTLPLAN *lpbtlplan,short iplan)

{
  byte *pbVar1;
  undefined2 unaff_SS;
  short cOut;
  short cch;
  char szName [34];
  char szTemp [36];
  
  pbVar1 = (byte *)lpb;
  __fmemmove(lpbtlplan,lpb,4);
  lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 4);
  cch = (short)*lpb;
  if (cch == 0) {
    __fstrcpy((char *)CONCAT22(lpbtlplan._2_2_,((BTLPLAN *)lpbtlplan)->szName),
                      (char *)CONCAT22(lpb._2_2_,pbVar1 + 5));
  }
  else {
    cOut = 0x20;
    __fmemmove((char *)szTemp,(byte *)CONCAT22(lpb._2_2_,pbVar1 + 5),0x20);
    FDecompressUserString((char *)szTemp,cch,(char *)szName,&cOut);
    __fmemmove((byte *)CONCAT22(lpbtlplan._2_2_,((BTLPLAN *)lpbtlplan)->szName),
                       (char *)szName,cOut);
  }
  lpbtlplan->wFlags = lpbtlplan->wFlags & 0xff0fU | (iplan & 0xfU) << 4;
  return;
}



// ======================================================================
// Function: UpdateBattleRecords
// Address: 1070:41ac
// Segment: MEMORY_IO
// ======================================================================


void UpdateBattleRecords(void)

{
  byte bVar1;
  HB *pHVar2;
  int iVar3;
  BTLREC26 *pBVar4;
  BTLDATA *pBVar5;
  undefined2 uVar6;
  undefined2 uVar7;
  short itok;
  BTLREC26 *lpbr26;
  HB *lphb;
  short cKill;
  BTLREC *lpbr;
  BTLDATA *lpbd;
  
  lphb = (HB *)CONCAT22(DAT_1120_0d60._2_2_,(HB *)DAT_1120_0d60);
  if (((HB *)DAT_1120_0d60 != (HB *)0x0) || (DAT_1120_0d60._2_2_ != 0)) {
    lpbd = (BTLDATA *)CONCAT22(DAT_1120_0d60._2_2_,&((HB *)DAT_1120_0d60)[1].cbBlock);
    while( true ) {
      while (lpbd->id == -1) {
        uVar6 = (undefined2)((ulong)lphb >> 0x10);
                    /* WARNING: Load size is inaccurate */
        pHVar2 = ((HB *)lphb)->lphbNext;
        iVar3 = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
        lphb = (HB *)CONCAT22(iVar3,pHVar2);
        if ((pHVar2 == (HB *)0x0) && (iVar3 == 0)) {
          return;
        }
        if ((uint)pHVar2->ibTop < 0x11) {
          return;
        }
        lpbd = (BTLDATA *)CONCAT22(iVar3,&pHVar2[1].cbBlock);
      }
      uVar6 = (undefined2)((ulong)lpbd >> 0x10);
      pBVar5 = (BTLDATA *)lpbd;
      if (pBVar5->cbData == 0) break;
      pBVar4 = (BTLREC26 *)((int)pBVar5 + (uint)pBVar5->ctok * 0x1d + 0xe);
      lpbr = (BTLREC *)CONCAT22(uVar6,pBVar4);
      lpbr26 = (BTLREC26 *)CONCAT22(uVar6,pBVar4);
      pBVar5 = (BTLDATA *)((int)&pBVar5->id + pBVar5->cbData);
      lpbd = (BTLDATA *)CONCAT22(uVar6,pBVar5);
      while ((BTLREC *)lpbr < pBVar5) {
        uVar6 = (undefined2)((ulong)lpbr26 >> 0x10);
        bVar1 = ((BTLREC26 *)lpbr26)->itokAttack;
        uVar7 = (undefined2)((ulong)lpbr >> 0x10);
        ((BTLREC *)lpbr)->ctok = (uint)((BTLREC26 *)lpbr26)->ctok;
        ((BTLREC *)lpbr)->wFlags = ((BTLREC *)lpbr)->wFlags & 0xffU | (uint)bVar1 << 8;
        pBVar4 = (BTLREC26 *)((int)(BTLREC *)lpbr + ((BTLREC *)lpbr)->ctok * 8 + 6);
        lpbr26 = (BTLREC26 *)CONCAT22(uVar7,pBVar4);
        lpbr = (BTLREC *)CONCAT22(uVar7,pBVar4);
      }
    }
  }
  return;
}



// ======================================================================
// Function: AskSaveDialog
// Address: 1070:432a
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short AskSaveDialog(HWND hwnd,ushort message,ushort wParam,long lParam)

{
  short sVar1;
  
  if (message != 2) {
    if (message == 0x110) {
      return 1;
    }
    if (message == 0x111) {
      if (((wParam == 0x429) || (wParam == 0x42b)) || (wParam == 0x42a)) {
        if (wParam == 0x42b) {
          sVar1 = 0;
        }
        else if (wParam == 0x42a) {
          sVar1 = -1;
        }
        else {
          sVar1 = 1;
        }
        EndDialog(hwnd,sVar1);
        return 1;
      }
      if (wParam == 0x76) {
        WinHelp(hwnd,(LPCSTR)_szHelpFile,1,0x442);
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: PromptSaveGame
// Address: 1070:43ee
// Segment: MEMORY_IO
// ======================================================================


void PromptSaveGame(void)

{
  undefined2 uVar1;
  short sVar2;
  FARPROC pvVar3;
  short fRet;
  
  pvVar3 = MakeProcInstance(AskSaveDialog,hInst);
  if (((uint)game.wCrap >> 2 & 1) == 0) {
    uVar1 = 0x42c;
  }
  else {
    uVar1 = 0x7e9;
  }
  sVar2 = DialogBox(0,(LPCSTR)CONCAT22(uVar1,hwndFrame),(HWND)((ulong)pvVar3 >> 0x10),
                    (void *)pvVar3);
  FreeProcInstance(pvVar3);
  if (sVar2 != 0) {
    gd._0_2_ = gd._0_2_ & 0xffef | (uint)(sVar2 == -1) << 4;
    FWriteLogFile((char *)szBase,idPlayer);
    FWriteHistFile(idPlayer);
  }
  return;
}



// ======================================================================
// Function: DestroyCurGame
// Address: 1070:44b0
// Segment: MEMORY_IO
// ======================================================================


void DestroyCurGame(void)

{
  short i;
  
  if (((uint)gd._0_2_ >> 8 & 1) != 0) {
    FFinishPlrMsgEntry(0);
  }
  if ((idPlayer != -1) && (game.fDirty != 0)) {
    PromptSaveGame();
  }
  ResetHb(htPlanets);
  lpPlanets._0_2_ = (PLANET *)0x0;
  lpPlanets._2_2_ = 0;
  cPlanet = 0;
  ResetHb(htFleets);
  rglpfl._0_2_ = (FLEET **)0x0;
  rglpfl._2_2_ = 0;
  cFleet = 0;
  ResetHb(htThings);
  lpThings._0_2_ = (THING *)0x0;
  lpThings._2_2_ = 0;
  cThing = 0;
  cThingAlloc = 0;
  vlprgScoreX._0_2_ = (SCOREX *)0x0;
  vlprgScoreX._2_2_ = 0;
  vrptFleet.fCached = 0;
  vrptPlanet.fCached = 0;
  vrptBattle.fCached = 0;
  vrptEFleet.fCached = 0;
  for (i = 0; i < 0x10; i = i + 1) {
    ((SCOREX **)rgsxPlr)[i * 2] = (SCOREX *)0x0;
    *(undefined2 *)((undefined *)&DAT_1120_156e + i * 4) = 0;
  }
  lpbBattleT._0_2_ = (byte *)0x0;
  lpbBattleT._2_2_ = 0;
  lpbBattleLog._0_2_ = (byte *)0x0;
  lpbBattleLog._2_2_ = 0;
  lpbBattleCur._0_2_ = (byte *)0x0;
  lpbBattleCur._2_2_ = 0;
  gd._0_2_ = gd._0_2_ & 0xebff;
  gd._4_2_ = gd._4_2_ & 0xfbff;
  ResetHb(htBattle);
  if (((int)DAT_1120_0d60 != 0) || (DAT_1120_0d60._2_2_ != 0)) {
    *(undefined2 *)((int)DAT_1120_0d60 + 0x12) = 0xffff;
  }
  ResetHb(htMisc);
  ResetHb(htString);
  ResetHb(htShips);
  ResetHb(htOrd);
  ResetHb(htPlrMsg);
  for (i = 0; i < 0x10; i = i + 1) {
    *(undefined2 *)(i * 4 + 0xfe) = 0;
    *(undefined2 *)(i * 4 + 0x100) = 0;
    *(undefined2 *)(i * 4 + 0x14c) = 0;
    *(undefined2 *)(i * 4 + 0x14e) = 0;
    ((BTLPLAN **)rglpbtlplan)[i * 2] = (BTLPLAN *)0x0;
    ((undefined2 *)&DAT_1120_593a)[i * 2] = 0;
    ((byte *)rgcbtlplan)[i] = 0;
  }
  if (sel.grobj != grobjNone) {
    ini.wFlags =
         ini.wFlags & 0xfe1fU |
         (sel.grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 5;
    ini.iObjSel = sel.id;
    ini.idPlayer = idPlayer;
    ini.lid._0_2_ = (undefined2)game.lid;
    ini.lid._2_2_ = game.lid._2_2_;
  }
  idPlayer = -1;
  imemLogCur = 0;
  imemLogPrev = -1;
  iMsgCur = 0;
  vlpbAiData._0_2_ = (byte *)0x0;
  vlpbAiData._2_2_ = 0;
  ResetMessages();
  lSaltCur._0_2_ = 0;
  lSaltCur._2_2_ = 0;
  ctickLast._0_2_ = 0;
  ctickLast._2_2_ = 0;
  game.lid._0_2_ = 0;
  game.lid._2_2_ = 0;
  game.cPlayer = 0;
  game.cPlanMax = 0;
  game.fDirty = 0;
  game.turn = 0;
  game.szName[0] = '\0';
  gd.wFlags = gd.wFlags & 0xfffe;
  gd._0_2_ = gd._0_2_ & 0xfeff;
  if (hwndBrowser != 0) {
    DestroyWindow(hwndBrowser);
  }
  if (hwndReportDlg != 0) {
    DestroyWindow(hwndReportDlg);
  }
  if (hwndPopup != 0) {
    DestroyWindow(hwndPopup);
    hwndPopup = 0;
  }
  hwndActive = 0;
  sel.scan.grobjFull = grobjNone;
  sel.scan.grobj = grobjNone;
  sel.scan.iwp = -1;
  sel.scan.ifl = -1;
  sel.scan.idpl = -1;
  fOrdersVis = 0;
  sel.grobjFull = grobjNone;
  sel.grobj = grobjNone;
  sel.id = -1;
  sel.pt.y = 0;
  sel.pt.x = 0;
  sel.pl.id = -1;
  sel.fl.id = -1;
  sel.fl.lpplord._0_2_ = (PLORD *)0x0;
  sel.fl.lpplord._2_2_ = 0;
  sel.pl.lpplprod._0_2_ = (PLPROD *)0x0;
  sel.pl.lpplprod._2_2_ = 0;
  dxPlanetProdLB = 0;
  dxOrderED = 0;
  dxFleetCompLB = 0;
  dxShipLB = 0;
  dxShipDD = 0;
  for (i = 0; i < 3; i = i + 1) {
    *(undefined2 *)(i * 2 + 0x85c) = 0;
  }
  return;
}



// ======================================================================
// Function: FBogusLong
// Address: 1070:484c
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10704887) */

short FBogusLong(ulong lSerial)

{
  short i;
  
  i = 0;
  while (CONCAT22(*(undefined2 *)(i * 4 + 0x768),*(undefined2 *)(i * 4 + 0x766)) <
         (lSerial ^ 0xa5a5a5a5)) {
    i = i + 1;
  }
  return (uint)((lSerial ^ 0xa5a5a5a5) ==
               CONCAT22(*(undefined2 *)(i * 4 + 0x768),*(undefined2 *)(i * 4 + 0x766)));
}



// ======================================================================
// Function: FValidSerialLong
// Address: 1070:48c4
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10704975) */
/* WARNING: Removing unreachable block (ram,0x10704994) */

short FValidSerialLong(ulong lSerial)

{
  short sVar1;
  ulong uVar2;
  ulong uVar3;
  short i;
  
  sVar1 = FBogusLong(lSerial);
  if (sVar1 == 0) {
    uVar2 = lSerial;
    for (i = 0; i < 4; i = i + 1) {
      uVar2 = __aFuldiv(uVar2,0x24);
    }
    uVar3 = uVar2;
    for (i = 0; i < 4; i = i + 1) {
      uVar3 = __aFulmul(uVar3,0x24);
    }
    uVar3 = lSerial - uVar3;
    if ((((int)(uVar3 >> 0x10) == 0) && ((uint)uVar3 < 100)) || (1500000 < uVar3)) {
      sVar1 = 0;
    }
    else if (((uVar2 == 0x12) || (uVar2 == 0x16)) ||
            ((uVar2 == 2 || ((uVar2 == 4 || (uVar2 == 6)))))) {
      sVar1 = 1;
    }
    else {
      sVar1 = 0;
    }
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: FileError
// Address: 1070:4a10
// Segment: MEMORY_IO
// ======================================================================


void FileError(StringId ids)

{
  char *sz;
  short mbType;
  
  idsFileError = ids;
  if ((fFileErrSilent == 0) && (((uint)gd._0_2_ >> 1 & 1) == 0)) {
    mbType = 0x10;
    sz = PszFormatIds(ids,(short *)0x0);
    AlertSz(sz,mbType);
  }
  return;
}



// ======================================================================
// Function: GetFileStatus
// Address: 1070:4a60
// Segment: MEMORY_IO
// ======================================================================


void GetFileStatus(short dt,short iPlayer)

{
  short sVar1;
  
  SetSzWorkFromDt(dt,iPlayer);
  sVar1 = __access((char *)szWork,2);
  gd.wFlags = gd.wFlags & 0xffdfU | (uint)(sVar1 != 0) << 5;
  return;
}



// ======================================================================
// Function: FOpenFile
// Address: 1070:4ac2
// Segment: MEMORY_IO
// ======================================================================


short FOpenFile(DtFileType dt,short iPlayer,short md)

{
  DtFileType dt_00;
  char *pcVar1;
  undefined2 *puVar2;
  short sVar3;
  StringId ids_00;
  int iVar4;
  char *pcVar5;
  undefined2 *puVar6;
  undefined2 unaff_SS;
  char *mbType;
  undefined1 env [18];
  undefined2 penvMemSav;
  short fSilentSav;
  short fRewind;
  short fCheckMulti;
  short ids;
  undefined2 rtbof [2];
  int local_10;
  int local_e;
  ushort local_c;
  int local_a;
  int local_8;
  uint local_6;
  
  fSilentSav = fFileErrSilent;
  ids = 4;
  gd.wFlags = gd.wFlags & 0xff7f;
  fCheckMulti = dt & 0x2000;
  fRewind = dt & 0x1000;
  dt_00 = dt & 0xff;
  SetSzWorkFromDt(dt_00,iPlayer);
  penvMemSav = penvMem;
  penvMem = env;
  sVar3 = __setjmp(env);
  if (sVar3 != 0) {
    fFileErrSilent = fSilentSav;
    FileError(ids);
    StreamClose();
    penvMem = (undefined1 *)penvMemSav;
    return 0;
  }
  fFileErrSilent = 1;
  StreamOpen((char *)szWork,md);
  fFileErrSilent = fSilentSav;
  ids = 3;
  ReadRt();
  if (((((uint)hdrCur.wFlags >> 10 == 8) && ((uint)rgbCur._8_2_ >> 0xc == 2)) &&
      (0x30 < ((uint)rgbCur._8_2_ >> 5 & 0x7f))) &&
     (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x54)) {
    pcVar5 = (char *)rgbCur;
    puVar6 = rtbof;
    for (iVar4 = 8; iVar4 != 0; iVar4 = iVar4 + -1) {
      puVar2 = puVar6;
      puVar6 = puVar6 + 1;
      pcVar1 = pcVar5;
      pcVar5 = pcVar5 + 2;
      *puVar2 = *(undefined2 *)pcVar1;
    }
    if ((local_8 << 0xb) >> 0xb == iPlayer) {
      if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) goto LAB_1070_4ebd;
      if ((local_10 == (int)game.lid) && (local_e == game.lid._2_2_)) {
        if (dt_00 == dtHist) {
          if ((local_8 << 0xb) >> 0xb == iPlayer) goto LAB_1070_4ebd;
        }
        else {
          if ((fCheckMulti != 0) && ((local_6 >> 10 & 1) != 0)) {
            __lseek(hf,-4,2);
            ReadRt();
            if (((uint)hdrCur.wFlags >> 10 != 0) &&
               ((hdrCur.wFlags & 0x3ffU) != 2)) goto IO_LBadFile_2;
            local_a._0_1_ = rgbCur[0];
            local_a._1_1_ = rgbCur[1];
            game.wCrap = game.wCrap & 0xf1ffU | (local_6 >> 0xd) << 9;
          }
          if ((game.turn == 0) && (local_a != 0)) {
            game.turn = local_a;
            game.wCrap = game.wCrap & 0xf1ffU | (local_6 >> 0xd) << 9;
LAB_1070_4ebd:
            if (fRewind != 0) {
              __lseek(hf,0,0);
              ReadRt();
            }
            penvMem = (undefined1 *)penvMemSav;
            wVersFile = local_c;
            gd.wFlags = gd.wFlags & 0xfffbU | (local_6 >> 0xc & 1) << 2;
            return 1;
          }
          if (local_a == game.turn) {
            if (((dt_00 == dtHost) && (((uint)gd._0_2_ >> 3 & 1) == 0)) &&
               ((local_6 >> 9 & 1) != 0)) {
              mbType = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
              pcVar5 = PszFormatIds(idsHostFileMarkedUseAnotherInstanceStars,(short *)0x0);
              sVar3 = AlertSz(pcVar5,(short)mbType);
              if (sVar3 == 6) goto LAB_1070_4ebd;
            }
            else if ((((local_6 >> 8 & 1) == 0) && (((uint)gd._0_2_ >> 1 & 1) != 0)) &&
                    (((uint)gd._0_2_ >> 2 & 1) == 0)) {
              gd.wFlags = gd.wFlags & 0xff7fU | 0x80;
            }
            else {
              if (((dt_00 != dtLog) || (((uint)game.wCrap >> 3 & 1) != 0)) ||
                 (local_6 >> 0xd == ((uint)game.wCrap >> 9 & 7))) goto LAB_1070_4ebd;
              FileError(idsFileGame);
            }
          }
          else {
            FileError(idsFileDate);
          }
        }
      }
      else {
        FileError(idsFileGame);
      }
    }
    else {
      FileError(idsGameFileAppearsCorruptUnableLoadFile);
    }
  }
  else if ((uint)hdrCur.wFlags >> 10 == 8) {
    if (((uint)rgbCur._8_2_ >> 0xc < 3) &&
       (((uint)rgbCur._8_2_ >> 0xc != 2 ||
        (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x55)))) {
      ids_00 = idsSorryFileCreatedOlderVersionStarsIncompatible;
    }
    else {
      ids_00 = idsFileCreatedNewerVersionStarsMustUpgrade;
    }
    FileError(ids_00);
  }
  else {
    FileError(idsFileDoesBelongVersionStars);
  }
IO_LBadFile_2:
  StreamClose();
  penvMem = (undefined1 *)penvMemSav;
  return 0;
}



// ======================================================================
// Function: FNewTurnAvail
// Address: 1070:4f22
// Segment: MEMORY_IO
// ======================================================================


short FNewTurnAvail(short idPlayer)

{
  short sVar1;
  uint uVar2;
  short sVar3;
  short fNew;
  ushort turnOld;
  ushort wGenOld;
  
  sVar1 = game.turn;
  uVar2 = (uint)game.wCrap >> 9;
  fFileErrSilent = 1;
  game.turn = 0;
  sVar3 = FOpenFile(0x2003,idPlayer,0x20);
  if (sVar3 == 0) {
    fNew = 0;
  }
  else {
    StreamClose();
    fNew = (short)((uint)sVar1 < (uint)game.turn);
  }
  game.turn = sVar1;
  game.wCrap = game.wCrap & 0xf1ffU | (uVar2 & 7) << 9;
  return fNew;
}



// ======================================================================
// Function: FCheckFile
// Address: 1070:4fb2
// Segment: MEMORY_IO
// ======================================================================


short FCheckFile(DtFileType dt,short iPlayer,ushort md)

{
  short sVar1;
  uint uVar2;
  short sVar3;
  short fErrSav;
  short f;
  ushort wGenOld;
  short fOpened;
  short fReturn;
  
  sVar1 = fFileErrSilent;
  uVar2 = (uint)game.wCrap >> 9;
  if (dt == dtHost) {
    f = (uint)gd._0_2_ >> 3 & 1;
    gd._0_2_ = gd._0_2_ & 0xfff7 | 8;
  }
  fFileErrSilent = 1;
  sVar3 = FOpenFile(dt,iPlayer,0x20);
  if (md == 1) {
    if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 9 & 1) != 0)) {
      fReturn = 1;
    }
    else {
      fReturn = 0;
    }
  }
  else if (md == 2) {
    if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 8 & 1) == 0)) {
      fReturn = 0;
    }
    else {
      fReturn = 1;
    }
  }
  else if (md == 4) {
    if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 10 & 1) == 0)) {
      fReturn = 0;
    }
    else {
      fReturn = 1;
    }
  }
  else if (md == 8) {
    if (sVar3 == 0) {
      fReturn = 0;
    }
    else {
      do {
        ReadRt();
        if ((uint)hdrCur.wFlags >> 10 == 6) break;
      } while (rgbCur[0] != iPlayer);
      fReturn = (uint)rgbCur._6_2_ >> 9 & 1;
    }
  }
  if (sVar3 != 0) {
    StreamClose();
  }
  if (dt == dtHost) {
    gd._0_2_ = gd._0_2_ & 0xfff7 | (f & 1U) << 3;
  }
  fFileErrSilent = sVar1;
  game.wCrap = game.wCrap & 0xf1ffU | (uVar2 & 7) << 9;
  return fReturn;
}



// ======================================================================
// Function: ReadRt
// Address: 1070:5168
// Segment: MEMORY_IO
// ======================================================================


void ReadRt(void)

{
  RgFromStream(&hdrCur,2);
  if ((hdrCur.wFlags & 0x3ffU) != 0) {
    RgFromStream(rgbCur,hdrCur.wFlags & 0x3ff);
  }
  if ((uint)hdrCur.wFlags >> 10 == 8) {
    SetFileXorStream
              (CONCAT22(rgbCur._6_2_,rgbCur._4_2_),
               (int)rgbCur._12_2_ >> 5,rgbCur._10_2_,
               (int)(rgbCur._12_2_ << 0xb) >> 0xb,(uint)rgbCur._14_2_ >> 0xc & 1
              );
  }
  else if ((uint)hdrCur.wFlags >> 10 != 0) {
    XorFileBuf((char *)rgbCur,hdrCur.wFlags & 0x3ff);
  }
  return;
}



// ======================================================================
// Function: FBadFileError
// Address: 1070:524e
// Segment: MEMORY_IO
// ======================================================================


short FBadFileError(StringId ids)

{
  short sVar1;
  
  if ((((ids == idsUniverseDefinitionFileSeemsMissingCorrupt) ||
       (ids == idsPlayerLogFileAppearsCorruptUnableLoad)) ||
      (ids == idsHistoryFileAppearsCorruptHistoricalDataWill)) ||
     (((ids == idsGameFileAppearsCorruptUnableLoadFile || (ids == idsErrorWritingFile)) ||
      ((ids == idsFileDate || (ids == idsFileGame)))))) {
    sVar1 = 1;
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: StreamOpen
// Address: 1070:52ae
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1070536a) */
/* WARNING: Removing unreachable block (ram,0x10705391) */

void StreamOpen(char *szFile,short mdOpen)

{
  undefined2 unaff_SS;
  DWORD DVar1;
  DWORD DVar2;
  short fNoErr;
  undefined2 of;
  int local_8e;
  ulong dwTick;
  
  dwTick = 0;
  while( true ) {
    hf = OpenFile((LPCSTR)szFile,(undefined2 *)&of,mdOpen & 0xbfff);
    if (hf != 0xffff) {
      return;
    }
    if ((((uint)gd._0_2_ >> 9 & 1) == 0) || (local_8e == 2)) break;
    DVar1 = GetTickCount();
    if (dwTick == 0) {
      dwTick = DVar1 + 4000;
    }
    if (dwTick <= DVar1) break;
    do {
      DVar2 = GetTickCount();
    } while (DVar2 < DVar1 + 500);
  }
  if ((mdOpen & 0x4000U) == 0) {
    FileError(idsCantOpenFile);
  }
  _longjmp(penvMem,-1);
  return;
}



// ======================================================================
// Function: StreamClose
// Address: 1070:53cc
// Segment: MEMORY_IO
// ======================================================================


void StreamClose(void)

{
  if (hf != -1) {
    _lclose(hf);
    hf = -1;
  }
  return;
}



// ======================================================================
// Function: RgFromStream
// Address: 1070:53f4
// Segment: MEMORY_IO
// ======================================================================


void RgFromStream(void *rg,ushort cb)

{
  ushort uVar1;
  
  if (cb != 0) {
    if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
      uVar1 = _lread(cb,rg,hf);
      if (uVar1 != cb) {
        FileError(idsGameFileAppearsCorruptUnableLoadFile);
        _longjmp(penvMem,-1);
      }
    }
    else {
      __fmemcpy(rg,(byte *)CONCAT22(vlpMemStream._2_2_,(byte *)vlpMemStream),
                        cb);
      vlpMemStream._0_2_ = (byte *)vlpMemStream + cb;
    }
  }
  return;
}



// ======================================================================
// Function: WriteOrders
// Address: 1070:547e
// Segment: MEMORY_IO
// ======================================================================


void WriteOrders(FLEET *lpfl)

{
  FLEET *pFVar1;
  undefined2 uVar2;
  ORDER *lpord;
  short cord;
  
  uVar2 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar1 = (FLEET *)lpfl;
  if (pFVar1->cord != 0) {
    cord = pFVar1->cord;
    lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar1->lpplord + 2),
                              (ORDER *)(*(int *)&pFVar1->lpplord + 4));
    for (; cord != 0; cord = cord + -1) {
      uVar2 = (undefined2)((ulong)lpord >> 0x10);
      if ((((ORDER *)lpord)->wFlags & 0xfU) == 0) {
        WriteRt(0x14,8,lpord);
      }
      else {
        WriteRt(0x13,0x12,lpord);
      }
      lpord = (ORDER *)CONCAT22(uVar2,(ORDER *)lpord + 1);
    }
  }
  return;
}



// ======================================================================
// Function: WriteRtPlr
// Address: 1070:551c
// Segment: MEMORY_IO
// ======================================================================


void WriteRtPlr(PLAYER *pplr,byte *pbStore)

{
  ushort uVar1;
  short sVar2;
  short cOut;
  byte *pb;
  short i;
  byte rgb [266];
  
  if (pbStore == (byte *)0x0) {
    pbStore = rgb;
  }
  if ((pplr->wFlags & 1U) != 0) {
    pplr->wMdPlr = pplr->wMdPlr & 0xfff8U | 7;
  }
  _memmove(pbStore,pplr,0xc0);
  if ((pplr->wMdPlr & 7U) == 7) {
    for (i = 0xf; (-1 < i && (pplr->rgmdRelation[i] == '\0')); i = i + -1) {
    }
    i = i + 1;
    pb = pbStore + 0x71;
    pbStore[0x70] = (byte)i;
    _memmove(pb,pplr->rgmdRelation,i);
    pb = pb + i;
  }
  else {
    pb = pbStore + 8;
  }
  cOut = 0x1f;
  if ((pplr->szName[0] == '\0') ||
     (sVar2 = FCompressUserString((char *)pplr->szName,(char *)(pb + 1),&cOut), sVar2 == 0)
     ) {
    _strcpy((char *)(pb + 1),pplr->szName);
    *pb = 0;
    uVar1 = _strlen(pplr->szName);
    pb = pb + uVar1 + 2;
  }
  else {
    *pb = (byte)cOut;
    pb = pb + cOut + 1;
  }
  cOut = 0x1f;
  if ((pplr->szNames[0] == '\0') ||
     (sVar2 = FCompressUserString((char *)pplr->szNames,(char *)(pb + 1),&cOut), sVar2 == 0
     )) {
    _strcpy((char *)(pb + 1),pplr->szNames);
    *pb = 0;
    uVar1 = _strlen(pplr->szNames);
    pb = pb + uVar1 + 2;
  }
  else {
    *pb = (byte)cOut;
    pb = pb + cOut + 1;
  }
  WriteRt(6,(int)pb - (int)pbStore,(byte *)pbStore);
  return;
}



// ======================================================================
// Function: WriteRtShDef
// Address: 1070:574e
// Segment: MEMORY_IO
// ======================================================================


void WriteRtShDef(SHDEF *lpshdef,byte **ppbStore)

{
  short sVar1;
  ushort uVar2;
  SHDEF *pSVar3;
  undefined2 uVar4;
  undefined2 unaff_SS;
  HULDEF *pHVar5;
  short cOut;
  byte *pb;
  char szHulName [32];
  short rgb;
  undefined1 local_96;
  undefined1 local_95;
  short local_94;
  byte local_92;
  short local_91;
  undefined2 local_8f;
  undefined2 local_8d;
  undefined2 local_8b;
  undefined2 local_89;
  undefined1 local_87 [133];
  
  local_96 = (undefined1)(lpshdef->hul).ihuldef;
  uVar4 = (undefined2)((ulong)lpshdef >> 0x10);
  pSVar3 = (SHDEF *)lpshdef;
  rgb = pSVar3->wFlags;
  local_92 = (pSVar3->hul).chs;
  local_95 = (undefined1)(pSVar3->hul).ibmp;
  if ((pSVar3->wFlags & 0xffU) == 7) {
    local_94 = (pSVar3->hul).dp;
    local_91 = pSVar3->turn;
    local_8f = (undefined2)pSVar3->cBuilt;
    local_8d = *(undefined2 *)((int)&pSVar3->cBuilt + 2);
    local_8b = (undefined2)pSVar3->cExist;
    local_89 = *(undefined2 *)((int)&pSVar3->cExist + 2);
    pb = local_87;
    __fmemmove((undefined1 *)pb,(HS *)CONCAT22(uVar4,(pSVar3->hul).rghs),(uint)local_92 << 2
                      );
    pb = pb + (uint)local_92 * 4;
  }
  else {
    local_94 = (pSVar3->hul).wtEmpty;
    pb = &local_92;
  }
  if ((pSVar3->wFlags & 0xffU) == 7) {
    __fstrcpy((char *)szHulName,(char *)CONCAT22(uVar4,(pSVar3->hul).szClass));
  }
  else {
    pHVar5 = LphuldefFromId((lpshdef->hul).ihuldef);
    __fstrcpy((char *)szHulName,
                      (char *)CONCAT22((int)((ulong)pHVar5 >> 0x10),
                                       (((HULDEF *)pHVar5)->hul).szClass));
  }
  cOut = 0x1f;
  if ((szHulName[0] == '\0') ||
     (sVar1 = FCompressUserString((char *)szHulName,(char *)(pb + 1),&cOut), sVar1 == 0)) {
    _strcpy((char *)(pb + 1),szHulName);
    *pb = 0;
    uVar2 = _strlen(szHulName);
    pb = pb + uVar2 + 2;
  }
  else {
    *pb = (byte)cOut;
    pb = pb + cOut + 1;
  }
  if (ppbStore == (byte **)0x0) {
    WriteRt(0x1a,(int)pb - (int)&rgb,(short *)&rgb);
  }
  else {
    _memmove(*ppbStore,&rgb,(int)pb - (int)&rgb);
    *ppbStore = *ppbStore + ((int)pb - (int)&rgb);
  }
  return;
}



// ======================================================================
// Function: FWriteDataFile
// Address: 1070:5964
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10705d1f) */
/* WARNING: Removing unreachable block (ram,0x10705e4f) */

short FWriteDataFile(char *pszFileBase,short iPlayer,short fAppend)

{
  int *piVar1;
  byte *pbVar2;
  ORDER *pOVar3;
  PLANET *pPVar4;
  ORDER *pOVar5;
  short *psVar6;
  int iVar7;
  PLORD *pPVar8;
  long lVar9;
  POINT pt;
  POINT pt_00;
  THING *pTVar10;
  long lVar11;
  bool bVar12;
  int iVar13;
  int iVar14;
  uint uVar15;
  short sVar16;
  char *pcVar17;
  DtFileType dt;
  byte bVar18;
  int iVar19;
  int iVar20;
  ORDER *pOVar21;
  FLEET *pFVar22;
  PLANET *pPVar23;
  int *piVar24;
  short *psVar25;
  ORDER *pOVar26;
  undefined2 uVar27;
  undefined2 uVar28;
  undefined2 unaff_SS;
  undefined2 uVar29;
  ulong uVar30;
  ulong uVar31;
  PL *pPVar32;
  short fFoundIdeal;
  FLEET *lpflBest;
  short iflT;
  BTLPLAN *lpbtlplan;
  FLEET *lpflTarget;
  short mdTarget;
  SCAN scan;
  PLANET *lpplT;
  short fRet;
  THING *lpthMac;
  undefined2 local_3c;
  int lpshdef;
  undefined2 local_38;
  short iord;
  undefined1 env [18];
  FLEET *lpfl;
  THING *lpth;
  ORDER *lpord;
  short i;
  undefined2 penvMemSav;
  short j;
  BTLPLAN *lpbtlplan__16;
  undefined2 local_e;
  short fNoAutoTrack;
  FLEET *lpflT;
  short iMax;
  
  uVar29 = 0x1120;
  fRet = 1;
  SetVisiblePlanFleet(iPlayer);
  bVar18 = (byte)iPlayer;
  if ((((uint)gd._0_2_ >> 1 & 1) != 0) && (iPlayer != -1)) {
    for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar22 = ((FLEET **)rglpfl)[i];
      iVar19 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpfl = (FLEET *)CONCAT22(iVar19,pFVar22);
      if ((pFVar22 == (FLEET *)0x0) && (iVar19 == 0)) break;
      if ((((uint)pFVar22->wFlags >> 10 & 1) == 0) && (((uint)lpfl->id >> 9 & 0xf) == iPlayer)) {
        for (j = 0; (j < 0x10 && (pFVar22->rgcsh[j] == 0)); j = j + 1) {
        }
        if (j == 0x10) {
          pFVar22->wFlags = pFVar22->wFlags & 0xfbffU | 0x400;
        }
        else {
          iVar20 = *(int *)&pFVar22->lpplord;
          uVar28 = *(undefined2 *)((int)&pFVar22->lpplord + 2);
          lpord = (ORDER *)CONCAT22(uVar28,(ORDER *)(iVar20 + 4));
          if ((*(uint *)(iVar20 + 10) >> 8 & 0xf) == 2) {
            pt.y = *(short *)(iVar20 + 6);
            pt.x = (lpord->pt).x;
            sVar16 = FFindNearestObject(pt,0x81,&scan);
            pOVar21 = (ORDER *)lpord;
            uVar28 = (undefined2)((ulong)lpord >> 0x10);
            if (sVar16 == 0) {
              pOVar21->wFlags = pOVar21->wFlags & 0xf0ffU | 0x400;
              pOVar21->id = 0;
            }
            else {
              pOVar21->wFlags = pOVar21->wFlags & 0xf0ffU | 0x100;
              pOVar21->id = scan.idpl;
            }
          }
          uVar28 = (undefined2)((ulong)lpord >> 0x10);
          pOVar21 = (ORDER *)lpord;
          pFVar22 = (FLEET *)lpfl;
          uVar27 = (undefined2)((ulong)lpfl >> 0x10);
          if ((((pOVar21->wFlags & 0xfU) == 0) && (1 < pFVar22->cord)) &&
             ((pOVar21[1].wFlags & 0xfU) == 7)) {
            pOVar21->wFlags = pOVar21->wFlags & 0xfff0U | 7;
            sVar16 = (pOVar21[1].txp.rgia + 1)->wFlags;
            (&pOVar21->txp)->rgia[0].wFlags = (&pOVar21[1].txp)->rgia[0].wFlags;
            ((pOVar21->txp).rgia + 1)->wFlags = sVar16;
          }
          if (((pOVar21->wFlags & 0xfU) == 7) &&
             ((pFVar22->cord < 2 || (((uint)pOVar21[1].wFlags >> 8 & 0xf) != 2)))) {
            lpflBest = (FLEET *)0x0;
            lVar11 = 100000000;
            bVar12 = false;
            if ((pFVar22->idPlanet == -1) &&
               ((1 < pFVar22->cord && (((uint)pFVar22->wFlags >> 9 & 1) != 0)))) {
              iVar19 = ((pOVar21 + 1)->pt).x;
              iVar20 = pOVar21[1].pt.y;
            }
            else {
              iVar19 = (&pFVar22->pt)->x;
              iVar20 = (pFVar22->pt).y;
            }
            uVar15 = ((BTLPLAN **)rglpbtlplan)[pFVar22->iPlayer * 2][pFVar22->iplan].
                     wFlags;
            for (iflT = 0; iflT < cFleet; iflT = iflT + 1) {
                    /* WARNING: Load size is inaccurate */
              pFVar22 = ((FLEET **)rglpfl)[iflT];
              iVar7 = *(int *)((int)((FLEET **)rglpfl + iflT) + 2);
              if ((pFVar22 == (FLEET *)0x0) && (iVar7 == 0)) break;
              if ((((uint)pFVar22->wFlags >> 8 & 1) != 0) && (pFVar22->iPlayer != iPlayer)) {
                iVar13 = (&pFVar22->pt)->x - iVar19;
                iVar14 = (pFVar22->pt).y - iVar20;
                uVar31 = __aFulmul((long)iVar14,(long)iVar14);
                uVar30 = __aFulmul((long)iVar13,(long)iVar13);
                lVar9 = uVar30 + uVar31;
                if ((((!bVar12) && (-1 < pFVar22->wFlags)) ||
                    ((lVar9 < lVar11 && ((!bVar12 || (-1 < pFVar22->wFlags)))))) &&
                   ((sVar16 = FMatchTarget((FLEET *)CONCAT22(iVar7,pFVar22),uVar15 & 0xf,0),
                    sVar16 != 0 &&
                    ((sVar16 = FAttackPlayer(lpfl,pFVar22->iPlayer), sVar16 != 0 &&
                     (lpflBest = (FLEET *)CONCAT22(iVar7,pFVar22), lVar11 = lVar9,
                     -1 < pFVar22->wFlags)))))) {
                  bVar12 = true;
                }
              }
            }
            if ((bVar12) && (((uint)gd._0_2_ >> 0xb & 1) == 0)) {
              ((FLEET *)lpflBest)->wFlags = ((FLEET *)lpflBest)->wFlags & 0x7fffU | 0x8000;
            }
            j = ((((ORDER *)lpord)->txp).rgia + 1)->wFlags * 0x32 + 0x32;
            if (j == 0x226) {
              j = 10000;
            }
            if (((((FLEET *)lpflBest != (FLEET *)0x0) || (lpflBest._2_2_ != 0)) && (lVar11 != 0)) &&
               (uVar31 = __aFulmul((long)j,(long)j), lVar11 <= (long)uVar31)) {
              uVar28 = (undefined2)((ulong)lpfl >> 0x10);
              pFVar22 = (FLEET *)lpfl;
              if ((int)(uint)((PLORD *)pFVar22->lpplord)->iordMax <= pFVar22->cord + 1) {
                pPVar32 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)
                                                              ((int)&pFVar22->lpplord + 2),
                                                             *(PL **)&pFVar22->lpplord),
                                              pFVar22->cord + 2);
                uVar28 = (undefined2)((ulong)lpfl >> 0x10);
                pFVar22 = (FLEET *)lpfl;
                *(PL **)&pFVar22->lpplord = (PL *)pPVar32;
                *(undefined2 *)((int)&pFVar22->lpplord + 2) = (int)((ulong)pPVar32 >> 0x10);
                lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar22->lpplord + 2),
                                          (ORDER *)(*(int *)&pFVar22->lpplord + 4));
              }
              uVar28 = (undefined2)((ulong)lpfl >> 0x10);
              if (1 < ((FLEET *)lpfl)->cord) {
                __fmemmove((ORDER *)CONCAT22(lpord._2_2_,(ORDER *)lpord + 2),
                                   (ORDER *)CONCAT22(lpord._2_2_,(ORDER *)lpord + 1),
                                   (((FLEET *)lpfl)->cord + -1) * 0x12);
              }
              if (((FLEET *)lpfl)->cord == 1) {
                __fmemset((ORDER *)CONCAT22(lpord._2_2_,(ORDER *)lpord + 1),0,0x12);
                uVar28 = (undefined2)((ulong)lpord >> 0x10);
                pOVar21 = (ORDER *)lpord;
                pOVar21[1].wFlags = pOVar21[1].wFlags & 0xefffU | 0x1000;
                pOVar21[1].wFlags = pOVar21[1].wFlags & 0xfff0U | 7;
                sVar16 = ((pOVar21->txp).rgia + 1)->wFlags;
                (&pOVar21[1].txp)->rgia[0].wFlags = (&pOVar21->txp)->rgia[0].wFlags;
                (pOVar21[1].txp.rgia + 1)->wFlags = sVar16;
                if ((&pOVar21[1].txp)->rgia[0].wFlags == 0) {
                  uVar15 = IFindIdealWarp(lpfl,0);
                  uVar28 = (undefined2)((ulong)lpord >> 0x10);
                  ((ORDER *)lpord)[1].wFlags =
                       ((ORDER *)lpord)[1].wFlags & 0xff0fU | (uVar15 & 0xf) << 4;
                }
                else {
                  pOVar21[1].wFlags =
                       pOVar21[1].wFlags & 0xff0fU | ((&pOVar21[1].txp)->rgia[0].wFlags & 0xfU) << 4
                  ;
                }
                if (((uint)((FLEET *)lpfl)->wFlags >> 9 & 1) != 0) {
                  pOVar26 = (ORDER *)lpord + 2;
                  pOVar21 = (ORDER *)lpord;
                  for (iVar19 = 9; iVar19 != 0; iVar19 = iVar19 + -1) {
                    pOVar5 = pOVar26;
                    pOVar26 = (ORDER *)&(pOVar26->pt).y;
                    pOVar3 = pOVar21;
                    pOVar21 = (ORDER *)&(pOVar21->pt).y;
                    (pOVar5->pt).x = (pOVar3->pt).x;
                  }
                  uVar15 = IFindIdealWarp(lpfl,0);
                  uVar28 = (undefined2)((ulong)lpord >> 0x10);
                  ((ORDER *)lpord)[2].wFlags =
                       ((ORDER *)lpord)[2].wFlags & 0xff0fU | (uVar15 & 0xf) << 4;
                  uVar28 = (undefined2)((ulong)lpfl >> 0x10);
                  piVar1 = &((FLEET *)lpfl)->cord;
                  *piVar1 = *piVar1 + 1;
                  pPVar8 = ((FLEET *)lpfl)->lpplord;
                  pbVar2 = &((PLORD *)pPVar8)->iordMac;
                  *pbVar2 = *pbVar2 + 1;
                }
              }
              else if ((&((ORDER *)lpord)[1].txp)->rgia[0].wFlags == 0) {
                uVar15 = IFindIdealWarp(lpfl,0);
                uVar28 = (undefined2)((ulong)lpord >> 0x10);
                ((ORDER *)lpord)[1].wFlags =
                     ((ORDER *)lpord)[1].wFlags & 0xff0fU | (uVar15 & 0xf) << 4;
              }
              else {
                ((ORDER *)lpord)[1].wFlags =
                     ((ORDER *)lpord)[1].wFlags & 0xff0fU |
                     ((&((ORDER *)lpord)[1].txp)->rgia[0].wFlags & 0xfU) << 4;
              }
              sVar16 = (((FLEET *)lpflBest)->pt).y;
              uVar28 = (undefined2)((ulong)lpord >> 0x10);
              pOVar21 = (ORDER *)lpord;
              ((pOVar21 + 1)->pt).x = (&((FLEET *)lpflBest)->pt)->x;
              pOVar21[1].pt.y = sVar16;
              pOVar21[1].id = lpflBest->id;
              pOVar21[1].wFlags = pOVar21[1].wFlags & 0xf0ffU | 0x200;
              uVar28 = (undefined2)((ulong)lpfl >> 0x10);
              piVar1 = &((FLEET *)lpfl)->cord;
              *piVar1 = *piVar1 + 1;
              pPVar8 = ((FLEET *)lpfl)->lpplord;
              pbVar2 = &((PLORD *)pPVar8)->iordMac;
              *pbVar2 = *pbVar2 + 1;
              FSendPlrMsg(iPlayer,idmPatrollingHasTargetedIntercept,lpfl->id | 0x8000,lpfl->id,
                               lpflBest->id,0,0,0,0,0);
            }
          }
          if (((((ORDER *)lpord)->wFlags & 0xfU) != 1) && (1 < ((FLEET *)lpfl)->cord)) {
            for (iord = 1; iord < ((FLEET *)lpfl)->cord; iord = iord + 1) {
              if (((uint)((ORDER *)lpord)[iord].wFlags >> 8 & 0xf) == 8) {
                lpth = LpthFromId(((ORDER *)lpord)[iord].id);
                iVar19 = (int)((ulong)lpth >> 0x10);
                pTVar10 = (THING *)lpth;
                if ((((pTVar10 == (THING *)0x0) && (iVar19 == 0)) ||
                    (((uint)lpth->idFull >> 0xd == 3 &&
                     ((*(uint *)(pTVar10->rgb + 4) >> 4 & 1) == 0)))) ||
                   ((((uint)lpth->idFull >> 0xd == 0 &&
                     ((1 << (bVar18 & 0x1f) & *(uint *)(pTVar10->rgb + 8)) == 0)) ||
                    (((uint)lpth->idFull >> 0xd == 2 && ((*(uint *)pTVar10->rgb >> 0xd & 1) == 0))))
                   )) {
                  pFVar22 = (FLEET *)lpfl;
                  uVar28 = (undefined2)((ulong)lpfl >> 0x10);
                  if (((pTVar10 == (THING *)0x0) && (iVar19 == 0)) ||
                     ((uint)lpth->idFull >> 0xd != 2)) {
                    if (((pTVar10 == (THING *)0x0) && (iVar19 == 0)) ||
                       ((uint)lpth->idFull >> 0xd != 3)) {
                      if (((pTVar10 != (THING *)0x0) || (iVar19 != 0)) &&
                         ((uint)lpth->idFull >> 0xd == 0)) {
                        FSendPlrMsg2(pFVar22->iPlayer,idmMineFieldHeadingHasVanishedOrdersHave,
                                          lpfl->id | 0x8000,lpfl->id,0);
                      }
                    }
                    else {
                      FSendPlrMsg2(pFVar22->iPlayer,
                                        idmMysteryTraderHeadingHasVanishedOrdersHave,
                                        lpfl->id | 0x8000,lpfl->id,0);
                    }
                  }
                  else {
                    FSendPlrMsg2(pFVar22->iPlayer,
                                      idmWormholeHeadingHasVanishedOrdersHaveChanged,
                                      lpfl->id | 0x8000,lpfl->id,0);
                  }
                  ((ORDER *)lpord)[iord].wFlags = ((ORDER *)lpord)[iord].wFlags & 0xf0ffU | 0x400;
                  ((ORDER *)lpord)[iord].id = iord;
                }
              }
              else if (((uint)((ORDER *)lpord)[iord].wFlags >> 8 & 0xf) == 2) {
                fNoAutoTrack = (uint)((ORDER *)lpord)[iord].wFlags >> 0xd & 1;
                if (fNoAutoTrack != 0) {
                  ((ORDER *)lpord)[iord].wFlags = ((ORDER *)lpord)[iord].wFlags & 0xdfff;
                }
                lpflT = LpflFromId(((ORDER *)lpord)[iord].id);
                iVar19 = (int)((ulong)lpflT >> 0x10);
                pFVar22 = (FLEET *)lpflT;
                if (((pFVar22 == (FLEET *)0x0) && (iVar19 == 0)) ||
                   (((uint)pFVar22->wFlags >> 10 & 1) != 0)) {
                  FSendPlrMsg(iPlayer,idmSWaypointAppearsHaveDestroyedHasDisappeared,
                                   lpfl->id | 0x8000,lpfl->id,((ORDER *)lpord)[iord].id,0,0,0,0,0);
                }
                else {
                  if (((uint)pFVar22->wFlags >> 8 & 1) != 0) goto LAB_1070_618a;
                  if ((pFVar22->idPlanet == -1) || (fNoAutoTrack != 0)) {
                    FSendPlrMsg(iPlayer,idmFleetTrackingAppearsHaveOutrunRangeScanners,
                                     lpfl->id | 0x8000,lpfl->id,0,0,0,0,0,0);
                  }
                  else {
                    FSendPlrMsg(iPlayer,idmFleetTrackingAppearsHaveDuckedBehindOrders,
                                     lpfl->id | 0x8000,lpfl->id,pFVar22->idPlanet,0,0,0,0,0);
                  }
                }
                ((ORDER *)lpord)[iord].wFlags = ((ORDER *)lpord)[iord].wFlags & 0xf0ffU | 0x400;
                ((ORDER *)lpord)[iord].id = iord;
                pt_00.y = ((ORDER *)lpord)[iord].pt.y;
                pt_00.x = (((ORDER *)lpord + iord)->pt).x;
                sVar16 = FFindNearestObject(pt_00,0x81,&scan);
                if (sVar16 != 0) {
                  ((ORDER *)lpord)[iord].wFlags = ((ORDER *)lpord)[iord].wFlags & 0xf0ffU | 0x100;
                  ((ORDER *)lpord)[iord].id = scan.idpl;
                }
              }
LAB_1070_618a:
            }
          }
        }
      }
    }
  }
  MarkPlayersThatSentMsgs(iPlayer);
  MarkPlanetsPlayerLost(iPlayer);
  if (iPlayer == -1) {
    wsprintf(szWork,(char *)0x112009fe,pszFileBase,0x1120);
  }
  else {
    wsprintf(szWork,(char *)0x11200a05,pszFileBase,0x1120,iPlayer + 1);
  }
  penvMemSav = penvMem;
  penvMem = env;
  sVar16 = __setjmp(env);
  if (sVar16 == 0) {
    if ((fAppend == 0) || (sVar16 = FAppendFile(iPlayer), sVar16 == 0)) {
      if (iPlayer == -1) {
        dt = dtHost;
      }
      else {
        dt = dtTurn;
      }
      sVar16 = FCreateFile(dt,iPlayer,(char *)0x0);
      if (sVar16 == 0) goto IO_LFail_2;
    }
    WriteBattles(iPlayer);
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) ||
         ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0)) {
        sVar16 = GetRaceStat((PLAYER *)rgplr + iPlayer,rsMajorAdv);
        if (sVar16 == raTerra) {
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 7;
        }
        WriteRtPlr((PLAYER *)rgplr + i,(byte *)0x0);
      }
    }
    if ((iPlayer == -1) && (((int)lSaltCur != 0 || (lSaltCur._2_2_ != 0)))) {
      WriteRt(0x24,4,&lSaltCur);
    }
    WritePlayerMessages(iPlayer);
    lpplT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    for (i = 0; i < *(int *)&cPlanet; i = i + 1) {
      uVar28 = (undefined2)((ulong)lpplT >> 0x10);
      pPVar23 = (PLANET *)lpplT;
      if (((uint)pPVar23->wFlags >> 8 & 1) != 0) {
        if ((pPVar23->wFlags & 0xffU) == 7) {
          WritePlanet(lpplT,0xd,0);
          uVar28 = (undefined2)((ulong)lpplT >> 0x10);
          pPVar23 = (PLANET *)lpplT;
          if ((*(int *)&pPVar23->lpplprod != 0) || (*(int *)((int)&pPVar23->lpplprod + 2) != 0)) {
            WriteRt(0x1c,(uint)((PLPROD *)pPVar23->lpplprod)->iprodMac << 2,
                    (void *)CONCAT22(*(undefined2 *)((int)&pPVar23->lpplprod + 2),
                                     (void *)(*(int *)&pPVar23->lpplprod + 4)));
          }
        }
        else if ((pPVar23->wFlags & 0xffU) == 2) {
          psVar25 = (short *)&stack0xff74;
          for (iVar19 = 0x1c; iVar19 != 0; iVar19 = iVar19 + -1) {
            psVar6 = psVar25;
            psVar25 = psVar25 + 1;
            pPVar4 = pPVar23;
            pPVar23 = (PLANET *)&pPVar23->iPlayer;
            *psVar6 = pPVar4->id;
          }
          uVar28 = (undefined2)((ulong)lpplT >> 0x10);
          pPVar23 = (PLANET *)lpplT;
          pPVar23->wFlags = pPVar23->wFlags & 0xfdff;
          pPVar23->wFlags = pPVar23->wFlags & 0xff00U | 3;
          WritePlanet(lpplT,0xe,0);
          psVar25 = (short *)&stack0xff74;
          pPVar23 = (PLANET *)lpplT;
          for (iVar19 = 0x1c; iVar19 != 0; iVar19 = iVar19 + -1) {
            pPVar4 = pPVar23;
            pPVar23 = (PLANET *)&pPVar23->iPlayer;
            psVar6 = psVar25;
            psVar25 = psVar25 + 1;
            pPVar4->id = *psVar6;
          }
        }
        else {
          WritePlanet(lpplT,0xe,0);
        }
      }
      lpplT = (PLANET *)CONCAT22(lpplT._2_2_,(PLANET *)lpplT + 1);
    }
    for (i = 0; i < *(int *)&game.cPlayer; i = i + 1) {
      if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
        lpshdef = *(int *)(i * 4 + 0xfe);
        local_38 = *(undefined2 *)(i * 4 + 0x100);
        for (j = 0; j < 0x10; j = j + 1) {
          if (((*(uint *)(lpshdef + j * 0x93 + 0x7b) >> 9 & 1) == 0) &&
             ((*(uint *)(lpshdef + j * 0x93 + 0x7b) >> 8 & 1) != 0)) {
            WriteRtShDef((SHDEF *)CONCAT22(local_38,(SHDEF *)(lpshdef + j * 0x93)),(byte **)0x0);
          }
        }
      }
    }
    for (i = 0; i < *(int *)&cFleet; i = i + 1) {
      uVar28 = *(undefined2 *)((int)(FLEET ***)&rglpfl + 2);
      piVar24 = (int *)(*(int *)(FLEET ***)&rglpfl + i * 4);
      pFVar22 = (FLEET *)*piVar24;
      iVar19 = piVar24[1];
      lpflT = (FLEET *)CONCAT22(iVar19,pFVar22);
      if ((pFVar22 == (FLEET *)0x0) && (iVar19 == 0)) break;
      if (((uint)pFVar22->wFlags >> 8 & 1) != 0) {
        WriteFleet((FLEET *)CONCAT22(iVar19,pFVar22));
      }
    }
    for (i = 0; i < *(int *)&game.cPlayer; i = i + 1) {
      if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
        lpshdef = *(int *)(i * 4 + 0x14c);
        local_38 = *(undefined2 *)(i * 4 + 0x14e);
        for (j = 0; j < 10; j = j + 1) {
          if (((*(uint *)(lpshdef + j * 0x93 + 0x7b) >> 9 & 1) == 0) &&
             ((*(uint *)(lpshdef + j * 0x93 + 0x7b) >> 8 & 1) != 0)) {
            WriteRtShDef((SHDEF *)CONCAT22(local_38,(SHDEF *)(lpshdef + j * 0x93)),(byte **)0x0);
          }
        }
      }
    }
    if ((iPlayer != -1) &&
       ((*(int *)(SCOREX **)&vlprgScoreX != 0 ||
        (*(int *)((int)(SCOREX **)&vlprgScoreX + 2) != 0)))) {
      for (i = 0; i < *(int *)&game.cPlayer; i = i + 1) {
        if (((((*(uint *)&gd.wFlags & 1) != 0) || (i == iPlayer)) ||
            ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0)) ||
           (((*(uint *)&game.wCrap >> 6 & 1) != 0 && (0x13 < *(uint *)&game.turn)))) {
          WriteRt(0x2d,0x18,
                  (void *)CONCAT22(*(undefined2 *)((int)(SCOREX **)&vlprgScoreX + 2),
                                   (void *)(*(int *)(SCOREX **)&vlprgScoreX + i * 0x18)));
        }
      }
    }
    i = 0;
                    /* WARNING: Load size is inaccurate */
    local_3c = *(undefined2 *)((int)(THING **)&lpThings + 2);
    lpth = (THING *)CONCAT22(local_3c,*(THING **)&lpThings);
    lpthMac = *(THING **)&lpThings + *(int *)&cThing;
    while ((THING *)lpth < lpthMac) {
      if ((((iPlayer == -1) ||
           ((((iPlayer == ((uint)lpth->idFull >> 9 & 0xf) && ((uint)lpth->idFull >> 0xd != 1)) &&
             (((uint)lpth->idFull >> 0xd != 3 && ((uint)lpth->idFull >> 0xd != 2)))) ||
            (((uint)lpth->idFull >> 0xd == 0 &&
             ((1 << (bVar18 & 0x1f) & *(uint *)(((THING *)lpth)->rgb + 8)) != 0)))))) ||
          (((uint)lpth->idFull >> 0xd == 1 && (*(int *)((THING *)lpth)->rgb < 0)))) ||
         ((((uint)lpth->idFull >> 0xd == 3 && ((*(uint *)(((THING *)lpth)->rgb + 4) >> 4 & 1) != 0))
          || (((uint)lpth->idFull >> 0xd == 2 && ((*(uint *)((THING *)lpth)->rgb >> 0xd & 1) != 0)))
          ))) {
        i = i + 1;
      }
      lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
    }
    if (0 < i) {
      WriteRt(0x2b,2,(short *)&i);
                    /* WARNING: Load size is inaccurate */
      local_3c = *(undefined2 *)((int)(THING **)&lpThings + 2);
      lpth = (THING *)CONCAT22(local_3c,*(THING **)&lpThings);
      lpthMac = *(THING **)&lpThings + *(int *)&cThing;
      while ((THING *)lpth < lpthMac) {
        if ((((iPlayer == -1) ||
             ((((iPlayer == ((uint)lpth->idFull >> 9 & 0xf) && ((uint)lpth->idFull >> 0xd != 1)) &&
               ((uint)lpth->idFull >> 0xd != 3)) && ((uint)lpth->idFull >> 0xd != 2)))) ||
            ((((uint)lpth->idFull >> 0xd == 0 &&
              ((1 << (bVar18 & 0x1f) & *(uint *)(((THING *)lpth)->rgb + 8)) != 0)) ||
             ((((uint)lpth->idFull >> 0xd == 1 && (*(int *)((THING *)lpth)->rgb < 0)) ||
              (((uint)lpth->idFull >> 0xd == 3 &&
               ((*(uint *)(((THING *)lpth)->rgb + 4) >> 4 & 1) != 0)))))))) ||
           (((uint)lpth->idFull >> 0xd == 2 && ((*(uint *)((THING *)lpth)->rgb >> 0xd & 1) != 0))))
        {
          WriteRt(0x2b,0x12,lpth);
        }
        lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
      }
    }
    if (iPlayer == -1) {
      i = 0;
      iMax = *(short *)&game.cPlayer;
    }
    else {
      i = iPlayer;
      iMax = iPlayer + 1;
    }
    for (; i < iMax; i = i + 1) {
      lpbtlplan__16 = ((BTLPLAN **)rglpbtlplan)[i * 2];
      local_e = ((undefined2 *)&DAT_1120_593a)[i * 2];
      for (j = 0; j < (int)(uint)((byte *)rgcbtlplan)[i]; j = j + 1) {
        WriteBattlePlan((BTLPLAN *)CONCAT22(local_e,lpbtlplan__16),0);
        lpbtlplan__16 = lpbtlplan__16 + 1;
      }
    }
    WriteRt(0,2,(void *)CONCAT22(uVar29,(void *)&game.turn));
    StreamClose();
  }
  else {
IO_LFail_2:
    idPlayer = iPlayer;
    if (fAppend == 0) {
      if (iPlayer == -1) {
        idPlayer = -1;
        sVar16 = 0x10;
        pcVar17 = PszFormatIds(idsUnableCreateHostFile,(short *)0x0);
        AlertSz(pcVar17,sVar16);
      }
      else {
        sVar16 = 0x10;
        pcVar17 = PszFormatIds(idsUnableCreateNewTurnFile,(short *)0x0);
        AlertSz(pcVar17,sVar16);
      }
    }
    else {
      sVar16 = 0x10;
      pcVar17 = PszFormatIds(idsUnableUpdateTurnFile,(short *)0x0);
      AlertSz(pcVar17,sVar16);
    }
    idPlayer = -1;
    fRet = 0;
  }
  SetVisiblePlanFleet(-1);
  return fRet;
}



// ======================================================================
// Function: FAppendFile
// Address: 1070:704e
// Segment: MEMORY_IO
// ======================================================================


short FAppendFile(short iPlayer)

{
  short sVar1;
  
  sVar1 = FMarkFile(0x2003,iPlayer,4,1);
  if (sVar1 != 0) {
    WriteBOF(iPlayer,3,1);
  }
  return (uint)(sVar1 != 0);
}



// ======================================================================
// Function: WriteBattles
// Address: 1070:709c
// Segment: MEMORY_IO
// ======================================================================


void WriteBattles(short iPlayer)

{
  char *pcVar1;
  uint *puVar2;
  HB *pHVar3;
  FLEET *pFVar4;
  byte *pbVar5;
  uint uVar6;
  BTLREC *pBVar7;
  undefined2 uVar8;
  HB *pHVar9;
  BTLDATA *pBVar10;
  int iVar11;
  int iVar12;
  undefined2 uVar13;
  FLEET *pFVar14;
  PLANET *lppl;
  short iplr;
  short cb;
  BTLDATA *lpbtldata;
  HB *lphb;
  BTLDATA *lpbBattle;
  int local_1c;
  BTLREC *lpbtlrec;
  ushort fPlayerCur;
  short cbT;
  FLEET *lpfl;
  short i;
  short cbRec;
  short ctok;
  
  if ((iPlayer != -1) &&
     (((byte *)lpbBattleLog != (byte *)lpbBattleCur ||
      (lpbBattleLog._2_2_ != lpbBattleCur._2_2_)))) {
    lphb = (HB *)CONCAT22(DAT_1120_0d60._2_2_,(HB *)DAT_1120_0d60);
    lpbBattle = (BTLDATA *)&((HB *)DAT_1120_0d60)[1].cbBlock;
    local_1c = DAT_1120_0d60._2_2_;
    while (((HB *)lphb != (HB *)0x0 || (lphb._2_2_ != 0))) {
      lpbtldata = (BTLDATA *)CONCAT22(local_1c,lpbBattle);
      while( true ) {
        uVar13 = (undefined2)((ulong)lphb >> 0x10);
        pHVar9 = (HB *)lphb;
        if ((0x10 < (uint)pHVar9->ibTop) && (lpbtldata->id != -1)) break;
                    /* WARNING: Load size is inaccurate */
        pHVar3 = pHVar9->lphbNext;
        local_1c = *(int *)((int)&pHVar9->lphbNext + 2);
        lphb = (HB *)CONCAT22(local_1c,pHVar3);
        if ((pHVar3 == (HB *)0x0) && (local_1c == 0)) {
          return;
        }
        lpbBattle = (BTLDATA *)&pHVar3[1].cbBlock;
        lpbtldata = (BTLDATA *)CONCAT22(local_1c,lpbBattle);
      }
      uVar13 = (undefined2)((ulong)lpbtldata >> 0x10);
      pBVar10 = (BTLDATA *)lpbtldata;
      if ((pBVar10->grfPlr & 1 << ((byte)iPlayer & 0x1f)) == 0) {
        lpbBattle = (BTLDATA *)((int)&lpbBattle->id + pBVar10->cbData);
      }
      else {
        for (i = 0; i < game.cPlayer; i = i + 1) {
          if (((i != iPlayer) &&
              ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) == 0)) &&
             ((1 << ((byte)i & 0x1f) & pBVar10->grfPlr) != 0)) {
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 3;
          }
        }
        for (i = 0; i < (int)(uint)pBVar10->ctok; i = i + 1) {
          if ((uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x10) != iPlayer) {
            if (*(char *)((int)pBVar10 + i * 0x1d + 0x11) == '\x01') {
              uVar6 = (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x10);
              LpplFromId(*(short *)((int)pBVar10 + i * 0x1d + 0xe));
              if ((*(uint *)(*(int *)(uVar6 * 4 + 0x14c) +
                             (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) >> 8
                  & 1) == 0) {
                *(uint *)(*(int *)(uVar6 * 4 + 0x14c) +
                          (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) =
                     *(uint *)(*(int *)(uVar6 * 4 + 0x14c) +
                               (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) &
                     0xfeff | 0x100;
                iVar11 = *(int *)((int)&rgplr[0].wFlags + uVar6 * 0xc0);
                puVar2 = (uint *)((int)&rgplr[0].wFlags + uVar6 * 0xc0);
                *puVar2 = *puVar2 & 0xfff;
                puVar2 = (uint *)((int)&rgplr[0].wFlags + uVar6 * 0xc0);
                *puVar2 = *puVar2 | iVar11 + 0x1000U & 0xf000;
              }
              *(uint *)(*(int *)(uVar6 * 4 + 0x14c) +
                        (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) =
                   *(uint *)(*(int *)(uVar6 * 4 + 0x14c) +
                             (*(byte *)((int)pBVar10 + i * 0x1d + 0x12) - 0x10) * 0x93 + 0x7b) &
                   0xff00 | 7;
            }
            else {
              pFVar14 = LpflFromId(*(short *)((int)pBVar10 + i * 0x1d + 0xe));
              uVar8 = (undefined2)((ulong)pFVar14 >> 0x10);
              pFVar4 = (FLEET *)pFVar14;
              if ((pFVar4->iPlayer != iPlayer) &&
                 ((*(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) >> 8 & 1) ==
                  0)) {
                *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) =
                     *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) & 0xfeff |
                     0x100;
                *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) =
                     *(uint *)((int)&rgplr[0].wMdPlr + pFVar4->iPlayer * 0xc0) & 0xfff8 |
                     3;
              }
              iVar11 = pFVar4->iPlayer * 4;
              if ((*(uint *)(*(int *)(iVar11 + 0xfe) +
                             (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) >> 8 & 1
                  ) == 0) {
                iVar11 = pFVar4->iPlayer * 4;
                iVar12 = pFVar4->iPlayer * 4;
                *(uint *)(*(int *)(iVar12 + 0xfe) +
                          (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) =
                     *(uint *)(*(int *)(iVar11 + 0xfe) +
                               (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) &
                     0xfeff | 0x100;
                pcVar1 = (char *)((int)&rgplr[0].cShDef + pFVar4->iPlayer * 0xc0);
                *pcVar1 = *pcVar1 + '\x01';
              }
              iVar11 = pFVar4->iPlayer * 4;
              iVar12 = pFVar4->iPlayer * 4;
              *(uint *)(*(int *)(iVar12 + 0xfe) +
                        (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) =
                   *(uint *)(*(int *)(iVar11 + 0xfe) +
                             (uint)*(byte *)((int)pBVar10 + i * 0x1d + 0x12) * 0x93 + 0x7b) & 0xff00
                   | 7;
              if (((uint)pFVar4->wFlags >> 10 & 1) == 0) {
                if (((uint)pFVar4->wFlags >> 8 & 1) == 0) {
                  iVar11 = *(int *)((int)&rgplr[0].wFlags + pFVar4->iPlayer * 0xc0);
                  puVar2 = (uint *)((int)&rgplr[0].wFlags + pFVar4->iPlayer * 0xc0);
                  *puVar2 = *puVar2 & 0xf000;
                  puVar2 = (uint *)((int)&rgplr[0].wFlags + pFVar4->iPlayer * 0xc0);
                  *puVar2 = *puVar2 | iVar11 + 1U & 0xfff;
                  pFVar4->wFlags = pFVar4->wFlags & 0xfeffU | 0x100;
                  pFVar4->wFlags = pFVar4->wFlags & 0xff00;
                }
                if ((pFVar4->wFlags & 0xffU) < 3) {
                  pFVar4->wFlags = pFVar4->wFlags & 0xff00U | 3;
                }
              }
            }
          }
        }
        if (pBVar10->idPlanet != -1) {
          lppl = LpplFromId(pBVar10->idPlanet);
          MarkPlanet(lppl,iPlayer,1);
        }
        if ((uint)pBVar10->cbData < 0x400) {
          WriteRt(0x1f,pBVar10->cbData,(BTLDATA *)CONCAT22(local_1c,lpbBattle));
          lpbBattle = (BTLDATA *)((int)&lpbBattle->id + pBVar10->cbData);
        }
        else {
          uVar6 = (uint)pBVar10->ctok * 0x1d + 0xe;
          pBVar7 = (BTLREC *)((int)lpbBattle + uVar6);
          lpbtlrec = (BTLREC *)CONCAT22(local_1c,pBVar7);
          if (uVar6 < 0x400) {
            WriteRt(0x1f,uVar6,(BTLDATA *)CONCAT22(local_1c,lpbBattle));
            lpbBattle = (BTLDATA *)((int)lpbBattle + uVar6);
          }
          else {
            if (pBVar10->ctok < 0x23) {
              ctok = (short)pBVar10->ctok;
            }
            else {
              ctok = 0x22;
            }
            if ((uint)pBVar10->ctok < (uint)ctok) {
              ctok = (short)pBVar10->ctok;
            }
            WriteRt(0x1f,ctok * 0x1d + 0xe,(BTLDATA *)CONCAT22(local_1c,lpbBattle));
            lpbBattle = (BTLDATA *)((int)lpbBattle + ctok * 0x1d + 0xe);
            ctok = (uint)pBVar10->ctok - ctok;
            while (0 < ctok) {
              if ((uint)ctok < 0x24) {
                WriteRt(0x27,ctok * 0x1d,(BTLDATA *)CONCAT22(local_1c,lpbBattle));
                lpbBattle = (BTLDATA *)((int)lpbBattle + ctok * 0x1d);
                ctok = 0;
              }
              else {
                WriteRt(0x27,0x3f7,(BTLDATA *)CONCAT22(local_1c,lpbBattle));
                lpbBattle = (BTLDATA *)((int)&lpbBattle[0x48].cbData + 1);
                ctok = ctok + -0x23;
              }
            }
          }
          cb = pBVar10->cbData + -0xe + (uint)pBVar10->ctok * -0x1d;
          if (cb < 0x400) {
            WriteRt(0x27,cb,(BTLREC *)CONCAT22(local_1c,pBVar7));
            lpbBattle = (BTLDATA *)((int)lpbBattle + cb);
          }
          else {
            while (cb != 0) {
              cbRec = ((BTLREC *)lpbtlrec)->ctok * 8 + 6;
              if (cbRec < 0x400) {
                cbT = 0;
                do {
                  cbT = cbT + cbRec;
                  pbVar5 = &((BTLREC *)lpbtlrec)->itok;
                  lpbtlrec = (BTLREC *)CONCAT22(lpbtlrec._2_2_,(BTLREC *)(pbVar5 + cbRec));
                  cb = cb - cbRec;
                  if (cb == 0) break;
                  cbRec = ((BTLREC *)(pbVar5 + cbRec))->ctok * 8 + 6;
                } while (cbT + cbRec < 0x400);
                WriteRt(0x27,cbT,(BTLDATA *)CONCAT22(local_1c,lpbBattle));
              }
              else {
                cb = cb - cbRec;
                while( true ) {
                  if (cbRec < 0x400) break;
                  WriteRt(0x27,0x3ff,lpbtlrec);
                  lpbtlrec = (BTLREC *)
                             CONCAT22(lpbtlrec._2_2_,
                                      (BTLREC *)((int)&((BTLREC *)lpbtlrec)[0xaa].ctok + 1));
                  cbRec = cbRec + -0x3ff;
                }
                if (cbRec != 0) {
                  WriteRt(0x27,cbRec,lpbtlrec);
                  lpbtlrec = (BTLREC *)
                             CONCAT22(lpbtlrec._2_2_,(BTLREC *)(&((BTLREC *)lpbtlrec)->itok + cbRec)
                                     );
                }
              }
              lpbBattle = (BTLDATA *)(BTLREC *)lpbtlrec;
              local_1c = lpbtlrec._2_2_;
            }
          }
        }
      }
    }
  }
  return;
}



// ======================================================================
// Function: WritePlanet
// Address: 1070:7a6a
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x107080e7) */
/* WARNING: Removing unreachable block (ram,0x1070809d) */
/* WARNING: Removing unreachable block (ram,0x10708074) */
/* WARNING: Removing unreachable block (ram,0x107080c6) */
/* WARNING: Removing unreachable block (ram,0x10708110) */
/* WARNING: Removing unreachable block (ram,0x1070804b) */

void WritePlanet(PLANET *lppl,short rt,short fHistory)

{
  int iVar1;
  undefined2 uVar2;
  short sVar3;
  byte *pbVar4;
  uint uVar5;
  uint uVar6;
  uint uVar7;
  PLANET *pPVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar9;
  undefined2 unaff_SS;
  ulong uVar10;
  ulong uVar11;
  byte *pb;
  short i;
  uint rgb;
  uint local_54;
  byte local_52;
  byte local_51 [75];
  byte bMask;
  
  uVar11 = CONCAT22(unaff_SI,unaff_DI);
  _memset(&rgb,0,0x50);
  uVar9 = (undefined2)((ulong)lppl >> 0x10);
  pPVar8 = (PLANET *)lppl;
  rgb = lppl->id & 0x7ffU | pPVar8->iPlayer << 0xb;
  uVar6 = local_54 & 0xff80;
  local_54 = uVar6 | pPVar8->wFlags & 0x7fU;
  if ((rt == 0xe) && (3 < (pPVar8->wFlags & 0xffU))) {
    if (fHistory == 0) {
      local_54 = 4;
    }
    else {
      local_54 = 3;
    }
    local_54 = uVar6 | local_54;
  }
  uVar5 = (uint)((pPVar8->wRouting & 0x3ffU) != 0);
  uVar7 = local_54 & 0x3c7f | ((uint)pPVar8->wFlags >> 8 & 1) << 8 |
          ((uint)pPVar8->wFlags >> 9 & 1) << 9 | ((uint)pPVar8->wFlags >> 10 & 1) << 7 |
          ((uint)pPVar8->wFlags >> 0xb) << 0xf | uVar5 << 0xe;
  pb = &local_52;
  uVar6 = local_54 & 0x7f;
  local_54 = uVar7;
  if (1 < uVar6) {
    pb = local_51;
    bMask = 3;
    for (i = 0; i < 3; i = i + 1) {
      if (pPVar8->rgpctMinLevel[i] != 0) {
        local_52 = local_52 | bMask & 0x55;
        *pb = pPVar8->rgpctMinLevel[i];
        pb = pb + 1;
      }
      bMask = bMask << 2;
    }
    for (i = 0; i < 3; i = i + 1) {
      *pb = pPVar8->rgMinConc[i];
      pb = pb + 1;
    }
    for (i = 0; i < 3; i = i + 1) {
      *pb = pPVar8->rgEnvVar[i];
      uVar5 = (uint)pPVar8->rgEnvVar[i];
      if (uVar5 != (int)pPVar8->rgEnvVarOrig[i]) {
        local_54 = local_54 & 0xfbff | 0x400;
      }
      pb = pb + 1;
    }
    if ((local_54 >> 10 & 1) != 0) {
      for (i = 0; i < 3; i = i + 1) {
        *pb = pPVar8->rgEnvVarOrig[i];
        pb = pb + 1;
      }
    }
    if (pPVar8->iPlayer != -1) {
      *(short *)pb = pPVar8->uGuesses;
      pb = pb + 2;
    }
    pbVar4 = pb;
    if (3 < (local_54 & 0x7f)) {
      pb = pb + 1;
      bMask = 3;
      for (i = 0; i < 4; i = i + 1) {
        if ((i != 3) || (6 < (pPVar8->wFlags & 0xffU))) {
          iVar1 = *(int *)((int)(pPVar8->rgwtMin + i) + 2);
          if ((-1 < iVar1) && ((0 < iVar1 || ((int)pPVar8->rgwtMin[i] != 0)))) {
            uVar6 = *(uint *)((int)(pPVar8->rgwtMin + i) + 2);
            if (((int)uVar6 < 0) || (((int)uVar6 < 1 && (*(uint *)(pPVar8->rgwtMin + i) < 0x100))))
            {
              *pbVar4 = *pbVar4 | bMask & 0x55;
              *pb = (byte)(int)pPVar8->rgwtMin[i];
              pb = pb + 1;
            }
            else {
              iVar1 = *(int *)((int)pPVar8->rgwtMin + i * 4 + 2);
              if ((iVar1 < 0) || (iVar1 < 1)) {
                *pbVar4 = *pbVar4 | bMask & 0xaa;
                *(int *)pb = (int)pPVar8->rgwtMin[i];
                pb = pb + 2;
              }
              else {
                *pbVar4 = *pbVar4 | bMask;
                uVar2 = *(undefined2 *)((int)(pPVar8->rgwtMin + i) + 2);
                *(int *)pb = (int)pPVar8->rgwtMin[i];
                *(undefined2 *)(pb + 2) = uVar2;
                pb = pb + 4;
              }
            }
          }
        }
        bMask = bMask << 2;
      }
      if (*pbVar4 != 0) {
        local_54 = local_54 & 0xdfff | 0x2000;
        pbVar4 = pb;
      }
      pb = pbVar4;
      if (rt != 0xe) {
        uVar10 = __aFulshr(uVar11,uVar5);
        uVar6 = (uint)uVar10 & 1;
        local_54 = local_54 & 0xefff | uVar6 << 0xc;
        if ((((pPVar8->iPlayer != -1) &&
             (((*(uint *)&pPVar8->dwFlags & 0xff) != 0 ||
              (uVar10 = __aFulshr(uVar11,uVar6), (uVar10 & 1) != 0)))) ||
            (uVar10 = __aFulshr(uVar11,uVar6), (uVar10 & 0xfff) != 0)) ||
           (((uVar10 = __aFulshr(uVar11,uVar6), (uVar10 & 0xfff) != 0 ||
             ((*(uint *)&pPVar8->dwFlags & 0xfff) != 0)) ||
            (uVar11 = __aFulshr(uVar11,uVar6), ((uint)uVar11 & 0x1f) != 0x1f)))) {
          local_54 = local_54 & 0xf7ff | 0x800;
          __fmemmove((byte *)pb,(long *)CONCAT22(uVar9,&pPVar8->dwFlags),8);
          pb = pb + 8;
        }
        if (pPVar8->iPlayer != -1) {
          if (((uint)pPVar8->wFlags >> 9 & 1) != 0) {
            sVar3 = pPVar8->wFlags;
            *(undefined2 *)pb = *(undefined2 *)&pPVar8->field11_0x2c;
            *(short *)(pb + 2) = sVar3;
            pb = pb + 4;
          }
          if ((pPVar8->wRouting & 0x3ffU) != 0) {
            *(short *)pb = pPVar8->wRouting;
            pb = pb + 2;
          }
        }
        WriteRt(0xd,(int)pb - (int)&rgb,(uint *)&rgb);
        return;
      }
    }
  }
  if (((uint)pPVar8->wFlags >> 9 & 1) != 0) {
    *pb = (byte)*(undefined2 *)&pPVar8->field11_0x2c & 0xf;
    pb = pb + 1;
  }
  if (fHistory != 0) {
    *(short *)pb = pPVar8->turn;
    pb = pb + 2;
  }
  WriteRt(0xe,(int)pb - (int)&rgb,(uint *)&rgb);
  return;
}



// ======================================================================
// Function: WriteFleet
// Address: 1070:81c6
// Segment: MEMORY_IO
// ======================================================================


void WriteFleet(FLEET *lpfl)

{
  ushort uVar1;
  long lVar2;
  ushort *puVar3;
  uint uVar4;
  int iVar5;
  undefined2 unaff_SS;
  ulong uVar6;
  ushort wt;
  ushort local_98;
  ushort grMask;
  short fByte;
  ushort *pb;
  short i;
  ushort us;
  undefined1 rgb [4];
  uint local_88;
  ushort local_80;
  ushort local_7e [60];
  ushort *pus;
  
  __fmemmove((undefined1 *)rgb,lpfl,0xc);
  fByte = 1;
  grMask = 1;
  us = 0;
  for (i = 0; i < 0x10; i = i + 1) {
    if ((0 < ((FLEET *)lpfl)->rgcsh[i]) && (us = us | grMask, 0xff < ((FLEET *)lpfl)->rgcsh[i])) {
      fByte = 0;
    }
    grMask = grMask << 1;
  }
  local_88 = local_88 & 0xf7ff | fByte << 0xb;
  local_80 = us;
  pb = local_7e;
  if (fByte == 0) {
    pus = pb;
    for (i = 0; i < 0x10; i = i + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
        *pus = ((FLEET *)lpfl)->rgcsh[i];
        pus = pus + 1;
      }
    }
    pb = pus;
  }
  else {
    for (i = 0; i < 0x10; i = i + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
        *(char *)pb = (char)((FLEET *)lpfl)->rgcsh[i];
        pb = (ushort *)((int)pb + 1);
      }
    }
  }
  puVar3 = pb;
  if (3 < (((FLEET *)lpfl)->wFlags & 0xffU)) {
    grMask = 3;
    pus = pb;
    pb = pb + 1;
    us = 0;
    for (i = 0; i < 5; i = i + 1) {
      iVar5 = *(int *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
      if (((-1 < iVar5) && ((0 < iVar5 || ((int)((FLEET *)lpfl)->rgwtMin[i] != 0)))) &&
         (((((FLEET *)lpfl)->wFlags & 0xffU) == 7 || ((i != 4 && (i != 3)))))) {
        uVar4 = *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
        if (((int)uVar4 < 0) ||
           (((int)uVar4 < 1 && (*(uint *)(((FLEET *)lpfl)->rgwtMin + i) < 0x100)))) {
          us = us | grMask & 0x155;
          *(char *)pb = (char)(int)((FLEET *)lpfl)->rgwtMin[i];
          pb = (ushort *)((int)pb + 1);
        }
        else {
          iVar5 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + i * 4 + 2);
          if ((iVar5 < 0) || (iVar5 < 1)) {
            uVar4 = grMask & 0x2aa;
            *pb = *(ushort *)(((FLEET *)lpfl)->rgwtMin + i);
            pb = pb + 1;
          }
          else {
            uVar4 = grMask & 0x3ff;
            uVar1 = *(ushort *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
            *pb = *(ushort *)(((FLEET *)lpfl)->rgwtMin + i);
            pb[1] = uVar1;
            pb = pb + 2;
          }
          us = us | uVar4;
        }
      }
      grMask = grMask << 2;
    }
    *puVar3 = us;
  }
  if ((((FLEET *)lpfl)->wFlags & 0xffU) < 7) {
    lVar2 = 0;
    uVar1 = ((FLEET *)lpfl)->wFlags;
    *pb = *(ushort *)&((FLEET *)lpfl)->field17_0x74;
    pb[1] = uVar1;
    for (i = 0; i < 0x10; i = i + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
        iVar5 = ((FLEET *)lpfl)->iPlayer * 4;
        uVar6 = __aFulmul((long)((FLEET *)lpfl)->rgcsh[i],
                                  (ulong)*(uint *)(*(int *)(iVar5 + 0xfe) + i * 0x93 + 0x28));
        lVar2 = uVar6 + lVar2;
      }
    }
    i = 0;
    while( true ) {
      local_98 = (ushort)((ulong)lVar2 >> 0x10);
      wt = (ushort)lVar2;
      if (3 < i) break;
      lVar2 = lVar2 + CONCAT22(*(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2),
                               (int)((FLEET *)lpfl)->rgwtMin[i]);
      i = i + 1;
    }
    pb[2] = wt;
    pb[3] = local_98;
    WriteRt(0x11,(int)pb + (8 - (int)rgb),(undefined1 *)rgb);
  }
  else {
    grMask = 1;
    us = 0;
    for (i = 0; i < 0x10; i = i + 1) {
      if ((((FLEET *)lpfl)->rgdv + i)->dp != 0) {
        us = us | grMask;
      }
      grMask = grMask << 1;
    }
    *pb = us;
    pus = pb + 1;
    for (i = 0; i < 0x10; i = i + 1) {
      if ((((FLEET *)lpfl)->rgdv + i)->dp != 0) {
        *pus = (((FLEET *)lpfl)->rgdv + i)->dp;
        pus = pus + 1;
      }
    }
    *(byte *)pus = ((FLEET *)lpfl)->iplan;
    *(undefined1 *)((int)pus + 1) = (char)((FLEET *)lpfl)->cord;
    WriteRt(0x10,(short)((int)pus + (2 - (int)rgb)),(undefined1 *)rgb);
    WriteOrders(lpfl);
    if ((*(int *)&((FLEET *)lpfl)->lpszName != 0) ||
       (*(int *)((int)&((FLEET *)lpfl)->lpszName + 2) != 0)) {
                    /* WARNING: Load size is inaccurate */
      WriteRtString((char *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2),
                                     ((FLEET *)lpfl)->lpszName));
    }
  }
  return;
}



// ======================================================================
// Function: WriteRtString
// Address: 1070:87b4
// Segment: MEMORY_IO
// ======================================================================


void WriteRtString(char *lpsz)

{
  short sVar1;
  ushort uVar2;
  undefined2 unaff_SS;
  short cOut;
  undefined1 rgb;
  char local_25 [35];
  
  if ((lpsz != (char *)0x0) && (*lpsz != '\0')) {
    cOut = 0x1f;
    sVar1 = FCompressUserString(lpsz,(char *)local_25,&cOut);
    if (sVar1 == 0) {
      __fstrcpy((char *)local_25,lpsz);
      rgb = 0;
      uVar2 = __fstrlen(lpsz);
      cOut = uVar2 + 1;
    }
    else {
      rgb = (undefined1)cOut;
    }
    WriteRt(0x15,cOut + 1,(undefined1 *)&rgb);
  }
  return;
}



// ======================================================================
// Function: MarkFleet
// Address: 1070:885e
// Segment: MEMORY_IO
// ======================================================================


void MarkFleet(FLEET *lpfl,short det)

{
  uint *puVar1;
  int iVar2;
  undefined2 uVar3;
  FLEET *pFVar4;
  int iVar5;
  undefined2 uVar6;
  short i;
  
  uVar6 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar4 = (FLEET *)lpfl;
  if (((uint)pFVar4->wFlags >> 8 & 1) == 0) {
    iVar5 = pFVar4->iPlayer * 4;
    iVar2 = *(int *)(iVar5 + 0xfe);
    uVar3 = *(undefined2 *)(iVar5 + 0x100);
    pFVar4->wFlags = pFVar4->wFlags & 0xfeffU | 0x100;
    pFVar4->wFlags = pFVar4->wFlags & 0xff00;
    pFVar4->wFlags = pFVar4->wFlags & 0xffefU | 0x10;
    iVar5 = *(int *)((int)&rgplr[0].wFlags + pFVar4->iPlayer * 0xc0);
    puVar1 = (uint *)((int)&rgplr[0].wFlags + pFVar4->iPlayer * 0xc0);
    *puVar1 = *puVar1 & 0xf000;
    puVar1 = (uint *)((int)&rgplr[0].wFlags + pFVar4->iPlayer * 0xc0);
    *puVar1 = *puVar1 | iVar5 + 1U & 0xfff;
    for (i = 0; i < 0x10; i = i + 1) {
      if (pFVar4->rgcsh[i] != 0) {
        *(uint *)(iVar2 + i * 0x93 + 0x7b) = *(uint *)(iVar2 + i * 0x93 + 0x7b) & 0xfeff | 0x100;
      }
    }
  }
  if ((pFVar4->wFlags & 0xffU) < (uint)det) {
    pFVar4->wFlags = pFVar4->wFlags & 0xff00U | det & 0xffU;
  }
  return;
}



// ======================================================================
// Function: WriteBattlePlan
// Address: 1070:89b8
// Segment: MEMORY_IO
// ======================================================================


void WriteBattlePlan(BTLPLAN *lpbtlplan,short fLog)

{
  short sVar1;
  ushort uVar2;
  undefined2 unaff_SS;
  short cOut;
  char szPlanName [32];
  undefined1 *pb;
  undefined1 rgb [2];
  undefined1 local_26 [2];
  undefined1 local_24 [34];
  
  __fmemmove((undefined1 *)rgb,lpbtlplan,4);
  if (((uint)lpbtlplan->wFlags >> 0xe & 1) == 0) {
    pb = local_24;
    __fstrcpy((char *)szPlanName,
                      (char *)CONCAT22(lpbtlplan._2_2_,((BTLPLAN *)lpbtlplan)->szName));
    cOut = 0x1f;
    if ((szPlanName[0] == '\0') ||
       (sVar1 = FCompressUserString((char *)szPlanName,(char *)(pb + 1),&cOut), sVar1 == 0)
       ) {
      _strcpy(pb + 1,szPlanName);
      *pb = 0;
      uVar2 = _strlen(szPlanName);
      pb = pb + uVar2 + 2;
    }
    else {
      *pb = (char)cOut;
      pb = pb + cOut + 1;
    }
  }
  else {
    pb = local_26;
  }
  if (fLog == 0) {
    WriteRt(0x1e,(int)pb - (int)rgb,(undefined1 *)rgb);
  }
  else {
    WriteMemRt(0x1e,(int)pb - (int)rgb,rgb);
  }
  return;
}



// ======================================================================
// Function: MarkPlanet
// Address: 1070:8adc
// Segment: MEMORY_IO
// ======================================================================


void MarkPlanet(PLANET *lppl,short iPlr,ushort det)

{
  int *piVar1;
  uint *puVar2;
  undefined2 uVar3;
  int iVar4;
  PLANET *pPVar5;
  int iVar6;
  undefined2 uVar7;
  SHDEF *lpshdef;
  
  uVar7 = (undefined2)((ulong)lppl >> 0x10);
  pPVar5 = (PLANET *)lppl;
  if (((uint)pPVar5->wFlags >> 8 & 1) == 0) {
    pPVar5->wFlags = pPVar5->wFlags & 0xfeffU | 0x100;
    pPVar5->wFlags = pPVar5->wFlags & 0xff00;
    piVar1 = (int *)((int)&rgplr[0].cPlanet + iPlr * 0xc0);
    *piVar1 = *piVar1 + 1;
  }
  if ((pPVar5->wFlags & 0xffU) < det) {
    pPVar5->wFlags = pPVar5->wFlags & 0xff00U | det & 0xff;
  }
  if ((pPVar5->iPlayer != -1) &&
     ((*(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) >> 8 & 1) == 0)) {
    *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) =
         *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) & 0xfeff | 0x100;
    *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) =
         *(uint *)((int)&rgplr[0].wMdPlr + pPVar5->iPlayer * 0xc0) & 0xfff8 | 3;
  }
  if (((det != 2) && (pPVar5->iPlayer != -1)) && (((uint)pPVar5->wFlags >> 9 & 1) != 0)) {
    iVar6 = pPVar5->iPlayer * 4;
    uVar3 = *(undefined2 *)(iVar6 + 0x14e);
    iVar6 = *(int *)(iVar6 + 0x14c) + (*(uint *)&pPVar5->field11_0x2c & 0xf) * 0x93;
    if ((*(uint *)(iVar6 + 0x7b) >> 8 & 1) == 0) {
      *(uint *)(iVar6 + 0x7b) = *(uint *)(iVar6 + 0x7b) & 0xfeff | 0x100;
      *(uint *)(iVar6 + 0x7b) = *(uint *)(iVar6 + 0x7b) & 0xff00;
      iVar4 = *(int *)((int)&rgplr[0].wFlags + pPVar5->iPlayer * 0xc0);
      puVar2 = (uint *)((int)&rgplr[0].wFlags + pPVar5->iPlayer * 0xc0);
      *puVar2 = *puVar2 & 0xfff;
      puVar2 = (uint *)((int)&rgplr[0].wFlags + pPVar5->iPlayer * 0xc0);
      *puVar2 = *puVar2 | iVar4 + 0x1000U & 0xf000;
    }
    if ((*(uint *)(iVar6 + 0x7b) & 0xff) < 3) {
      *(uint *)(iVar6 + 0x7b) = *(uint *)(iVar6 + 0x7b) & 0xff00 | 3;
    }
  }
  return;
}



// ======================================================================
// Function: SetSzWorkFromDt
// Address: 1070:8cfe
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Variable defined which should be unmapped: c */

void SetSzWorkFromDt(DtFileType dt,short iPlayer)

{
  char *pcVar1;
  char *pcVar2;
  undefined2 uVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined4 uVar4;
  short c;
  
  uVar4 = CONCAT22(unaff_SI,unaff_DI);
  pcVar1 = _strrchr((char *)szBase,0x2e);
  if ((pcVar1 != (char *)0x0) &&
     ((pcVar2 = _strrchr((char *)szBase,0x5c), pcVar2 == (char *)0x0 ||
      (pcVar2 < pcVar1)))) {
    *pcVar1 = '\0';
  }
  wsprintf(szWork,(char *)0x11200a0c,(char *)szBase,0x1120,uVar4);
  if (dt == dtXY) {
LAB_1070_8d76:
    _strcat((char *)szWork,(char *)0xa10);
  }
  else {
    if (dt != dtLog) {
      if (dt == dtHost) {
        _strcat((char *)szWork,(char *)0xa13);
        return;
      }
      if ((dt != dtTurn) && (dt != dtHist)) goto LAB_1070_8d76;
    }
    if (dt == dtLog) {
      uVar3 = 0x78;
    }
    else if (dt == dtHist) {
      uVar3 = 0x68;
    }
    else {
      uVar3 = 0x6d;
    }
    wsprintf((char *)0x112068c4,(char *)0x11200a17,uVar3,iPlayer + 1);
  }
  return;
}



// ======================================================================
// Function: FCreateFile
// Address: 1070:8e16
// Segment: MEMORY_IO
// ======================================================================


short FCreateFile(DtFileType dt,short iPlayer,char *szForceName)

{
  short sVar1;
  char *psz;
  undefined1 env [18];
  undefined2 penvMemSav;
  
  if (szForceName == (char *)0x0) {
    SetSzWorkFromDt(dt,iPlayer);
    psz = (char *)szWork;
  }
  else {
    psz = szForceName;
  }
  penvMemSav = penvMem;
  penvMem = env;
  sVar1 = __setjmp(env);
  if (sVar1 != 0) {
    penvMem = (undefined1 *)penvMemSav;
  }
  else {
    StreamOpen(psz,0x1012);
    WriteBOF(iPlayer,dt,0);
    penvMem = (undefined1 *)penvMemSav;
  }
  return (uint)(sVar1 == 0);
}



// ======================================================================
// Function: WriteBOF
// Address: 1070:8ea4
// Segment: MEMORY_IO
// ======================================================================


void WriteBOF(short iPlayer,short dt,short fMulti)

{
  short sVar1;
  int iVar2;
  undefined2 unaff_SS;
  DWORD DVar3;
  char rtbof [4];
  undefined2 local_10;
  undefined2 local_e;
  undefined2 local_c;
  short local_a;
  uint local_8;
  uint local_6;
  
  _memset(rtbof,0,0x10);
  _strncpy(rtbof,(char *)0xa1c,4);
  local_10 = (undefined2)game.lid;
  local_e = game.lid._2_2_;
  local_c = 0x2a60;
  local_a = game.turn;
  local_6 = local_6 & 0xfff | ((uint)game.wCrap >> 9) << 0xd;
  local_8 = local_8 & 0xffe0 | iPlayer & 0x1fU;
  sVar1 = Random(2000);
  DVar3 = GetTickCount();
  local_8 = local_8 & 0x1f | ((int)DVar3 + sVar1) * 0x20;
  if ((dt == 2) && ((gd.wFlags & 1U) != 0)) {
    iVar2 = 1;
  }
  else {
    iVar2 = 0;
  }
  local_6 = local_6 & 0xf400 | dt & 0xffU | ((uint)gd._0_2_ >> 4 & 1) << 8 |
            ((uint)gd._0_2_ >> 3 & 1) << 9 | iVar2 << 0xb;
  WriteRt(8,0x10,(char *)rtbof);
  return;
}



// ======================================================================
// Function: FMarkFile
// Address: 1070:904a
// Segment: MEMORY_IO
// ======================================================================


short FMarkFile(DtFileType dt,short iPlayer,short mdMark,short f)

{
  char *pcVar1;
  undefined2 *puVar2;
  short sVar3;
  int iVar4;
  char *pcVar5;
  undefined2 *puVar6;
  undefined2 unaff_SS;
  bool bVar7;
  undefined2 lSeedSav1;
  undefined2 local_36;
  undefined2 lSeedSav2;
  short local_32;
  short fSilentSav;
  short fSuccess;
  short fChange;
  undefined1 env [18];
  undefined2 penvMemSav;
  undefined2 rtbof [2];
  int local_12;
  int local_10;
  uint local_8;
  short ids;
  
  fSilentSav = fFileErrSilent;
  fSuccess = 0;
  ids = 0;
  SetSzWorkFromDt(dt & 0xff,iPlayer);
  penvMemSav = penvMem;
  penvMem = env;
  sVar3 = __setjmp(env);
  if (sVar3 != 0) {
    fFileErrSilent = fSilentSav;
    if (ids != 0) {
      FileError(ids);
    }
    StreamClose();
    penvMem = (undefined1 *)penvMemSav;
    return 0;
  }
  fFileErrSilent = 1;
  StreamOpen((char *)szWork,0x12);
  fFileErrSilent = fSilentSav;
  ids = 3;
  ReadRt();
  if ((uint)hdrCur.wFlags >> 10 == 8) {
    if (((uint)rgbCur._8_2_ >> 0xc < 2) ||
       (((uint)rgbCur._8_2_ >> 0xc == 2 &&
        (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x31)))) {
      FileError(idsSorryFileCreatedOlderVersionStarsIncompatible);
    }
    else if (((uint)rgbCur._8_2_ >> 0xc < 3) &&
            (((uint)rgbCur._8_2_ >> 0xc != 2 ||
             (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x54)))) {
      pcVar5 = (char *)rgbCur;
      puVar6 = rtbof;
      for (iVar4 = 8; iVar4 != 0; iVar4 = iVar4 + -1) {
        puVar2 = puVar6;
        puVar6 = puVar6 + 1;
        pcVar1 = pcVar5;
        pcVar5 = pcVar5 + 2;
        *puVar2 = *(undefined2 *)pcVar1;
      }
      if (((int)game.lid != 0) || (game.lid._2_2_ != 0)) {
        if ((local_12 == (int)game.lid) && (local_10 == game.lid._2_2_)) {
          fChange = 0;
          if (mdMark == 1) {
            bVar7 = (local_8 >> 9 & 1) != f;
            if (bVar7) {
              local_32 = f;
              local_8 = local_8 & 0xfdff | (f & 1U) << 9;
            }
            fChange = (short)bVar7;
          }
          else if (mdMark == 2) {
            bVar7 = (local_8 >> 8 & 1) != f;
            if (bVar7) {
              local_32 = f;
              local_8 = local_8 & 0xfeff | (f & 1U) << 8;
            }
            fChange = (short)bVar7;
          }
          else if (mdMark == 4) {
            bVar7 = (local_8 >> 10 & 1) != f;
            if (bVar7) {
              local_32 = f;
              local_8 = local_8 & 0xfbff | (f & 1U) << 10;
            }
            fChange = (short)bVar7;
          }
          else if (mdMark == 8) {
            do {
              do {
                GetFileSeeds((long *)&lSeedSav1,(long *)&lSeedSav2);
                ReadRt();
              } while ((uint)hdrCur.wFlags >> 10 != 6);
            } while (rgbCur[0] != iPlayer);
            if (((uint)rgbCur._6_2_ >> 9 & 1) != f) {
              if (((uint)rgbCur._6_2_ >> 9 & 1) == 0) {
                rgbCur._6_2_ = rgbCur._6_2_ & 0x1dff | 0xe200;
              }
              else {
                if ((uint)rgbCur._6_2_ >> 0xd != 7) goto IO_LBadFile_3;
                rgbCur._6_2_ = rgbCur._6_2_ & 0xfdff;
              }
              rgbCur._12_2_ = ~rgbCur._12_2_;
              rgbCur._14_2_ = ~rgbCur._14_2_;
              __lseek(hf,(long)(int)-((hdrCur.wFlags & 0x3ffU) + 2),1);
              SetFileSeeds(CONCAT22(local_36,lSeedSav1),CONCAT22(local_32,lSeedSav2));
              WriteRt(6,hdrCur.wFlags & 0x3ff,rgbCur);
              fChange = (short)(dt == dtTurn);
              local_8 = local_8 & 0xfeff;
            }
          }
          if (fChange != 0) {
            __lseek(hf,0,0);
            WriteRt(8,0x10,(undefined2 *)rtbof);
          }
          fSuccess = 1;
        }
        else {
          FileError(idsFileGame);
        }
      }
    }
    else {
      FileError(idsFileCreatedNewerVersionStarsMustUpgrade);
    }
  }
  else {
    FileError(idsFileDoesBelongVersionStars);
  }
IO_LBadFile_3:
  if (((dt & 0x2000) == dtXY) || (fSuccess == 0)) {
    StreamClose();
  }
  else {
    __lseek(hf,0,2);
  }
  penvMem = (undefined1 *)penvMemSav;
  return fSuccess;
}



// ======================================================================
// Function: WriteRt
// Address: 1070:947c
// Segment: MEMORY_IO
// ======================================================================


void WriteRt(short rt,short cb,void *rg)

{
  undefined2 unaff_SS;
  HDR hdr;
  
  __fmemmove(rgbCur,rg,cb);
  if (rt == 8) {
    SetFileXorStream
              (CONCAT22(rgbCur._6_2_,rgbCur._4_2_),
               (int)rgbCur._12_2_ >> 5,rgbCur._10_2_,
               (int)(rgbCur._12_2_ << 0xb) >> 0xb,(uint)rgbCur._14_2_ >> 0xc & 1
              );
  }
  else if (rt != 0) {
    XorFileBuf((char *)rgbCur,cb);
  }
  hdr.wFlags = cb & 0x3ffU | rt << 10;
  RgToStream((HDR *)&hdr,2);
  RgToStream(rgbCur,cb);
  return;
}



// ======================================================================
// Function: RgToStream
// Address: 1070:9554
// Segment: MEMORY_IO
// ======================================================================


void RgToStream(void *rg,ushort cb)

{
  ushort uVar1;
  char *sz;
  short mbType;
  
  if ((cb != 0) && (uVar1 = _lwrite(cb,rg,hf), uVar1 != cb)) {
    mbType = 0x10;
    sz = PszFormatIds(idsErrorWritingFile,(short *)0x0);
    AlertSz(sz,mbType);
    _longjmp(penvMem,-1);
  }
  return;
}



// ======================================================================
// Function: SetVisiblePlanFleet
// Address: 1070:95bc
// Segment: MEMORY_IO
// ======================================================================


void SetVisiblePlanFleet(short iPlr)

{
  SetVisPFInit(iPlr);
  if (iPlr == -1) {
    rgplr[0].cPlanet = game.cPlanMax;
  }
  else {
    if (iPlr != -1) {
      UpdateProgressGauge(-0x39f);
    }
    SetVisPFFleets(iPlr);
    if (iPlr != -1) {
      UpdateProgressGauge(-0x39f);
    }
    SetVisPFPlanets(iPlr);
    if (iPlr != -1) {
      UpdateProgressGauge(-0x39f);
    }
    SetVisPFThings(iPlr);
    SetVisPFFinish(iPlr);
  }
  return;
}



// ======================================================================
// Function: SetVisPFInit
// Address: 1070:9654
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10709e11) */

void SetVisPFInit(short iPlr)

{
  char *pcVar1;
  uint *puVar2;
  int *piVar3;
  uint uVar4;
  FLEET *pFVar5;
  uint uVar6;
  PLORD *pPVar7;
  short sVar8;
  THING *pTVar9;
  int iVar10;
  int iVar11;
  undefined2 uVar12;
  long lVar13;
  short iSteal;
  ushort grbitPlr;
  short raMajor;
  short i;
  short ifl;
  THING *lpth;
  FLEET *lpfl;
  short j;
  PLANET *lppl;
  ushort detNew;
  PLANET *lpplMac;
  undefined2 local_6;
  
  raMajor = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
  if (iPlr == -1) {
    grbitPlr = 0;
  }
  else {
    grbitPlr = 1 << ((byte)iPlr & 0x1f);
  }
  for (i = 0; i < game.cPlayer; i = i + 1) {
    *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
  }
  for (i = 0; i < game.cPlayer; i = i + 1) {
    if (((iPlr == -1) || (iPlr == i)) ||
       ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0)) {
      *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
      *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 7;
    }
    else {
      *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff;
    }
    *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
         *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xf000;
    *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
    *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
         *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xfff;
    for (j = 0; j < 0x10; j = j + 1) {
      if (((iPlr == -1) || (iPlr == i)) &&
         ((*(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) >> 9 & 1) == 0)) {
        *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
        *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xff00 | 7;
        uVar12 = *(undefined2 *)(i * 4 + 0x100);
        iVar10 = *(int *)(i * 4 + 0xfe) + j * 0x93;
        *(undefined2 *)(iVar10 + 0x83) = 0;
        *(undefined2 *)(iVar10 + 0x85) = 0;
        pcVar1 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
        *pcVar1 = *pcVar1 + '\x01';
      }
      else {
        *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfeff;
      }
    }
    for (j = 0; j < 10; j = j + 1) {
      if (((iPlr == -1) || (iPlr == i)) &&
         ((*(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) >> 9 & 1) == 0)) {
        *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
        *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xff00 | 7;
        uVar12 = *(undefined2 *)(i * 4 + 0x14e);
        iVar10 = *(int *)(i * 4 + 0x14c) + j * 0x93;
        *(undefined2 *)(iVar10 + 0x83) = 0;
        *(undefined2 *)(iVar10 + 0x85) = 0;
        iVar10 = *(int *)((int)&rgplr[0].wFlags + i * 0xc0);
        puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
        *puVar2 = *puVar2 & 0xfff;
        puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
        *puVar2 = *puVar2 | iVar10 + 0x1000U & 0xf000;
      }
      else {
        *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) =
             *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfeff;
      }
    }
  }
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_6 = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < lpplMac) {
    if ((iPlr == -1) || (iPlr == ((PLANET *)lppl)->iPlayer)) {
      ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xfeffU | 0x100;
      ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xff00U | 7;
      if (iPlr != -1) {
        piVar3 = (int *)((int)&rgplr[0].cPlanet + iPlr * 0xc0);
        *piVar3 = *piVar3 + 1;
      }
      if (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0) {
        iVar10 = ((PLANET *)lppl)->iPlayer * 4;
        uVar12 = *(undefined2 *)(iVar10 + 0x14e);
        iVar10 = *(int *)(iVar10 + 0x14c) + (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) * 0x93;
        puVar2 = (uint *)(iVar10 + 0x83);
        uVar4 = *puVar2;
        *puVar2 = *puVar2 + 1;
        piVar3 = (int *)(iVar10 + 0x85);
        *piVar3 = *piVar3 + (uint)(0xfffe < uVar4);
      }
    }
    else {
      ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xfeff;
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar5 = ((FLEET **)rglpfl)[ifl];
    iVar10 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar10,pFVar5);
    if ((pFVar5 == (FLEET *)0x0) && (iVar10 == 0)) break;
    pFVar5->wFlags = pFVar5->wFlags & 0xffef;
    pFVar5->wFlags = pFVar5->wFlags & 0x7fff;
    if (((iPlr == -1) || (iPlr == pFVar5->iPlayer)) && (((uint)pFVar5->wFlags >> 10 & 1) == 0)) {
      pFVar5->wFlags = pFVar5->wFlags & 0xfeffU | 0x100;
      pFVar5->wFlags = pFVar5->wFlags & 0xff00U | 7;
      iSteal = *(int *)((int)&rgplr[0].wFlags + pFVar5->iPlayer * 0xc0) + 1U & 0xfff;
      puVar2 = (uint *)((int)&rgplr[0].wFlags + pFVar5->iPlayer * 0xc0);
      *puVar2 = *puVar2 & 0xf000;
      puVar2 = (uint *)((int)&rgplr[0].wFlags + pFVar5->iPlayer * 0xc0);
      *puVar2 = *puVar2 | iSteal;
      for (j = 0; j < 0x10; j = j + 1) {
        if (pFVar5->rgcsh[j] != 0) {
          uVar6 = pFVar5->rgcsh[j];
          iSteal = (int)uVar6 >> 0xf;
          iVar11 = pFVar5->iPlayer * 4;
          uVar12 = *(undefined2 *)(iVar11 + 0x100);
          iVar11 = *(int *)(iVar11 + 0xfe) + j * 0x93;
          puVar2 = (uint *)(iVar11 + 0x83);
          uVar4 = *puVar2;
          *puVar2 = *puVar2 + uVar6;
          piVar3 = (int *)(iVar11 + 0x85);
          *piVar3 = *piVar3 + iSteal + (uint)CARRY2(uVar4,uVar6);
        }
      }
      if ((iPlr != -1) && (pFVar5->idPlanet != -1)) {
        lppl = (PLANET *)
               CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets + pFVar5->idPlanet);
        sVar8 = GetCachedFleetScannerRange
                          ((FLEET *)CONCAT22(iVar10,pFVar5),(short *)0x0,(short *)0x0,&iSteal);
        if (sVar8 < 0) {
          detNew = 1;
        }
        else {
          detNew = 3;
        }
        if (1 < iSteal) {
          detNew = 4;
        }
        uVar12 = (undefined2)((ulong)lpfl >> 0x10);
        if ((((((uint)((FLEET *)lpfl)->wFlags >> 0xd & 1) != 0) && (((PLANET *)lppl)->iPlayer == -1)
             ) && (pPVar7 = ((FLEET *)lpfl)->lpplord,
                  (*(uint *)&((PLORD *)pPVar7)[2].iordMax & 0xf) == 3)) &&
           (lVar13 = CMineFromLpfl(lpfl), 0 < lVar13)) {
          detNew = 4;
        }
        MarkPlanet(lppl,iPlr,detNew);
      }
    }
    else {
      pFVar5->wFlags = pFVar5->wFlags & 0xfeff;
    }
  }
  pTVar9 = (THING *)lpThings + cThing;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < pTVar9) {
    if ((uint)lpth->idFull >> 0xd == 1) {
      if ((iPlr == -1) || (raMajor == 6)) {
        *(uint *)((THING *)lpth)->rgb = *(uint *)((THING *)lpth)->rgb & 0x7fff | 0x8000;
        if ((*(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) >>
             8 & 1) == 0) {
          *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) &
               0xfeff | 0x100;
          *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) &
               0xfff8 | 3;
        }
      }
      else {
        *(uint *)((THING *)lpth)->rgb = *(uint *)((THING *)lpth)->rgb & 0x7fff;
      }
    }
    else if ((uint)lpth->idFull >> 0xd == 2) {
      *(uint *)((THING *)lpth)->rgb =
           *(uint *)((THING *)lpth)->rgb & 0xdfff | (uint)(iPlr == -1) << 0xd;
    }
    else if ((uint)lpth->idFull >> 0xd == 3) {
      *(uint *)(((THING *)lpth)->rgb + 4) = *(uint *)(((THING *)lpth)->rgb + 4) & 0xffef | 0x10;
    }
    else if ((((uint)lpth->idFull >> 0xd == 0) &&
             ((*(uint *)(((THING *)lpth)->rgb + 8) & grbitPlr) != 0)) &&
            ((*(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) >>
              8 & 1) == 0)) {
      *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) &
           0xfeff | 0x100;
      *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) =
           *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) &
           0xfff8 | 3;
    }
    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
  }
  return;
}



// ======================================================================
// Function: SetVisPFFleets
// Address: 1070:a100
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1070a8f0) */
/* WARNING: Removing unreachable block (ram,0x1070a90b) */
/* WARNING: Removing unreachable block (ram,0x1070aae0) */
/* WARNING: Removing unreachable block (ram,0x1070a412) */
/* WARNING: Removing unreachable block (ram,0x1070a711) */
/* WARNING: Removing unreachable block (ram,0x1070a4d8) */
/* WARNING: Removing unreachable block (ram,0x1070ab87) */
/* WARNING: Removing unreachable block (ram,0x1070a43a) */
/* WARNING: Removing unreachable block (ram,0x1070a53c) */
/* WARNING: Removing unreachable block (ram,0x1070a92e) */
/* WARNING: Removing unreachable block (ram,0x1070a94e) */
/* WARNING: Removing unreachable block (ram,0x1070a887) */
/* WARNING: Removing unreachable block (ram,0x1070a8a2) */

void SetVisPFFleets(short iPlr)

{
  uint *puVar1;
  FLEET *pFVar2;
  uint uVar3;
  ushort uVar4;
  int iVar5;
  THING *pTVar6;
  PLANET *pPVar7;
  int iVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar9;
  ulong uVar10;
  ulong uVar11;
  long lVar12;
  long lVar13;
  undefined2 uVar14;
  undefined2 uVar15;
  undefined2 uVar16;
  long lVar17;
  short pctDetect;
  short iSteal;
  short iRadPlanet;
  undefined4 lRadPlanet2;
  ushort grbitPlr;
  short dx;
  short iRadius;
  THING *lpthMac;
  undefined2 local_2e;
  short ifl;
  undefined4 lRadius2;
  THING *lpth;
  FLEET *lpfl;
  short j;
  PLANET *lppl;
  undefined4 d2;
  FLEET *lpfl2;
  short dy;
  short pctCloak;
  int pt;
  int local_a;
  PLANET *lpplMac;
  undefined2 local_6;
  
  uVar10 = CONCAT22(lRadPlanet2._2_2_,(undefined2)lRadPlanet2);
  uVar11 = CONCAT22(lRadius2._2_2_,(undefined2)lRadius2);
  lVar17 = CONCAT22(unaff_SI,unaff_DI);
  if (iPlr == -1) {
    grbitPlr = 0;
  }
  else {
    grbitPlr = 1 << ((byte)iPlr & 0x1f);
  }
  ifl = 0;
  do {
    if (cFleet <= ifl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pFVar2 = ((FLEET **)rglpfl)[ifl];
    iVar8 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar8,pFVar2);
    if ((pFVar2 == (FLEET *)0x0) && (iVar8 == 0)) {
      return;
    }
    if (((uint)pFVar2->wFlags >> 10 & 1) == 0) {
      lRadius2 = uVar11;
      lRadPlanet2 = uVar10;
      if (pFVar2->iPlayer == iPlr) {
        if ((((uint)pFVar2->wFlags >> 0xc & 1) != 0) && (pFVar2->idPlanet != -1)) {
          MarkPlanet((PLANET *)
                     CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets + pFVar2->idPlanet),
                     iPlr,3);
          uVar11 = lRadius2;
          uVar10 = lRadPlanet2;
        }
        lRadius2 = uVar11;
        lRadPlanet2 = uVar10;
        iRadius = GetCachedFleetScannerRange(lpfl,&iRadPlanet,&pctDetect,&iSteal);
        if (0x7fff < (uint)iRadius) {
          iRadius = 0;
        }
        uVar10 = __aFulmul((long)iRadius,(long)iRadius);
        lRadius2 = uVar10;
        uVar10 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
        uVar9 = (undefined2)((ulong)lpfl >> 0x10);
        pt = (&((FLEET *)lpfl)->pt)->x;
        local_a = (((FLEET *)lpfl)->pt).y;
        for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar2 = ((FLEET **)rglpfl)[j];
          iVar8 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
          lpfl2 = (FLEET *)CONCAT22(iVar8,pFVar2);
          if ((pFVar2 == (FLEET *)0x0) && (iVar8 == 0)) break;
          if (((uint)pFVar2->wFlags >> 10 & 1) == 0) {
            if (((((iSteal & 1U) != 0) && (pt == (&pFVar2->pt)->x)) && (local_a == (pFVar2->pt).y))
               && ((((uint)pFVar2->wFlags >> 8 & 1) == 0 || ((pFVar2->wFlags & 0xffU) < 4)))) {
              lRadPlanet2 = uVar10;
              MarkFleet((FLEET *)CONCAT22(iVar8,pFVar2),4);
              uVar10 = lRadPlanet2;
            }
            uVar9 = (undefined2)((ulong)lpfl2 >> 0x10);
            if (((uint)((FLEET *)lpfl2)->wFlags >> 8 & 1) == 0) {
              lRadPlanet2 = uVar10;
              dx = _abs(pt - (&((FLEET *)lpfl2)->pt)->x);
              uVar10 = lRadPlanet2;
              if (dx <= iRadius) {
                dy = _abs(local_a - (((FLEET *)lpfl2)->pt).y);
                uVar10 = lRadPlanet2;
                if (dy <= iRadius) {
                  uVar10 = __aFulmul((long)dy,(long)dy);
                  uVar9 = (undefined2)uVar10;
                  uVar11 = __aFulmul((long)dx,(long)dx);
                  lVar13 = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar9);
                  uVar10 = lRadPlanet2;
                  if ((lVar13 <= (long)lRadius2) &&
                     ((((FLEET *)lpfl2)->idPlanet == -1 || (lVar13 <= (long)lRadPlanet2)))) {
                    pctCloak = PctCloakFromLpfl(lpfl2);
                    if (pctDetect != 100) {
                      pctCloak = (pctCloak * pctDetect) / 100;
                    }
                    if (pctCloak == 0) {
                      MarkFleet(lpfl2,3);
                      uVar10 = lRadPlanet2;
                    }
                    else {
                      uVar15 = 0;
                      uVar14 = 100;
                      iVar8 = 100 - pctCloak;
                      iVar5 = iVar8 >> 0xf;
                      uVar16 = 0;
                      uVar9 = 100;
                      uVar10 = __aFulmul(lRadius2,(long)(100 - pctCloak));
                      uVar10 = __aFldiv(uVar10,CONCAT22(uVar16,uVar9));
                      uVar10 = __aFulmul(uVar10,CONCAT22(iVar5,iVar8));
                      lVar12 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                      uVar10 = lRadPlanet2;
                      if (lVar13 <= lVar12) {
                        if (((FLEET *)lpfl2)->idPlanet != -1) {
                          uVar15 = 0;
                          uVar14 = 100;
                          iVar8 = 100 - pctCloak;
                          iVar5 = iVar8 >> 0xf;
                          uVar16 = 0;
                          uVar9 = 100;
                          uVar10 = __aFulmul(lRadPlanet2,(long)(100 - pctCloak));
                          uVar10 = __aFldiv(uVar10,CONCAT22(uVar16,uVar9));
                          uVar10 = __aFulmul(uVar10,CONCAT22(iVar5,iVar8));
                          lVar12 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                          uVar10 = lRadPlanet2;
                          if (lVar12 < lVar13) goto LAB_1070_a2b2;
                        }
                        MarkFleet(lpfl2,3);
                        uVar10 = lRadPlanet2;
                      }
                    }
                  }
                }
              }
            }
          }
LAB_1070_a2b2:
        }
        lpthMac = (THING *)lpThings + cThing;
        local_2e = lpThings._2_2_;
        lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
        while (lRadPlanet2 = uVar10, (THING *)lpth < lpthMac) {
          if ((((iPlr != -1) &&
               (((((uint)lpth->idFull >> 0xd == 0 || ((uint)lpth->idFull >> 0xd == 1)) ||
                 ((uint)lpth->idFull >> 0xd == 3)) || ((uint)lpth->idFull >> 0xd == 2)))) &&
              ((((uVar9 = (undefined2)((ulong)lpth >> 0x10), (uint)lpth->idFull >> 0xd != 0 ||
                 ((*(uint *)(((THING *)lpth)->rgb + 8) & grbitPlr) == 0)) &&
                (((uint)lpth->idFull >> 0xd != 3 ||
                 ((*(uint *)(((THING *)lpth)->rgb + 4) >> 4 & 1) == 0)))) &&
               (((uint)lpth->idFull >> 0xd != 1 || (-1 < *(int *)((THING *)lpth)->rgb)))))) &&
             (((uint)lpth->idFull >> 0xd != 2 || ((*(uint *)((THING *)lpth)->rgb >> 0xd & 1) == 0)))
             ) {
            dx = _abs(pt - (&((THING *)lpth)->pt)->x);
            dy = _abs(local_a - (((THING *)lpth)->pt).y);
            uVar10 = __aFulmul((long)dy,(long)dy);
            uVar4 = (ushort)uVar10;
            uVar11 = __aFulmul((long)dx,(long)dx);
            lVar13 = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar4);
            uVar10 = lRadPlanet2;
            if ((lVar13 <= (long)lRadius2) || ((uint)lpth->idFull >> 0xd == 0)) {
              pTVar6 = (THING *)lpth;
              uVar9 = (undefined2)((ulong)lpth >> 0x10);
              if ((uint)lpth->idFull >> 0xd == 1) {
                *(uint *)pTVar6->rgb = *(uint *)pTVar6->rgb & 0x7fff | 0x8000;
IO_LThIncPlr:
                uVar10 = lRadPlanet2;
                if ((*(uint *)((int)&rgplr[0].wMdPlr +
                              ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1) == 0) {
                  *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0
                           ) = *(uint *)((int)&rgplr[0].wMdPlr +
                                        ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfeff | 0x100;
                  *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpth->idFull >> 9 & 0xf) * 0xc0
                           ) = *(uint *)((int)&rgplr[0].wMdPlr +
                                        ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 | 3;
                }
              }
              else if ((uint)lpth->idFull >> 0xd == 3) {
                *(uint *)(pTVar6->rgb + 4) = *(uint *)(pTVar6->rgb + 4) & 0xffef | 0x10;
              }
              else {
                if ((uint)lpth->idFull >> 0xd != 2) {
                  if ((((*(uint *)(pTVar6->rgb + 4) & grbitPlr) == 0) || ((long)lRadius2 < lVar13))
                     && ((long)lRadPlanet2 < lVar13)) {
                    lVar12 = __aFlshr(lVar17,uVar4);
                    if ((lVar12 < lVar13) &&
                       (uVar9 = (undefined2)((ulong)lpth >> 0x10), uVar10 = lRadPlanet2,
                       CONCAT22(*(undefined2 *)(((THING *)lpth)->rgb + 2),
                                *(undefined2 *)((THING *)lpth)->rgb) < lVar13)) goto LAB_1070_a96d;
                  }
                  uVar9 = (undefined2)((ulong)lpth >> 0x10);
                  puVar1 = (uint *)(((THING *)lpth)->rgb + 4);
                  *puVar1 = *puVar1 | grbitPlr;
                  puVar1 = (uint *)(((THING *)lpth)->rgb + 8);
                  *puVar1 = *puVar1 | grbitPlr;
                  goto IO_LThIncPlr;
                }
                if ((*(uint *)(pTVar6->rgb + 2) & grbitPlr) == 0) {
                  lVar12 = __aFlshr(lVar17,uVar4);
                  if ((lVar12 < lVar13) && (uVar10 = lRadPlanet2, (long)lRadPlanet2 < lVar13))
                  goto LAB_1070_a96d;
                }
                uVar9 = (undefined2)((ulong)lpth >> 0x10);
                pTVar6 = (THING *)lpth;
                *(uint *)(pTVar6->rgb + 2) = *(uint *)(pTVar6->rgb + 2) | grbitPlr;
                *(uint *)pTVar6->rgb = *(uint *)pTVar6->rgb & 0xdfff | 0x2000;
                uVar10 = lRadPlanet2;
              }
            }
          }
LAB_1070_a96d:
          lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
        }
        uVar11 = lRadius2;
        if ((iSteal & 2U) != 0) {
          uVar9 = (undefined2)((ulong)lpfl >> 0x10);
          if (((FLEET *)lpfl)->idPlanet != -1) {
            MarkPlanet((PLANET *)
                       CONCAT22(lpPlanets._2_2_,
                                (PLANET *)lpPlanets + ((FLEET *)lpfl)->idPlanet),iPlr,4);
            uVar10 = lRadPlanet2;
            uVar11 = lRadius2;
          }
        }
        if (0 < iRadPlanet) {
          iRadius = iRadPlanet;
          lRadPlanet2 = uVar10;
          lRadius2 = uVar11;
          uVar11 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
          uVar9 = (undefined2)((ulong)lpfl >> 0x10);
          pt = (&((FLEET *)lpfl)->pt)->x;
          local_a = (((FLEET *)lpfl)->pt).y;
          lpplMac = (PLANET *)lpPlanets + cPlanet;
          local_6 = lpPlanets._2_2_;
          lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
          while (uVar10 = lRadPlanet2, (PLANET *)lppl < lpplMac) {
            uVar9 = (undefined2)((ulong)lppl >> 0x10);
            if ((((uint)((PLANET *)lppl)->wFlags >> 8 & 1) == 0) ||
               ((((PLANET *)lppl)->wFlags & 0xffU) < 3)) {
              lRadius2 = uVar11;
              dx = _abs(((POINT *)rgptPlan + lppl->id)->x - pt);
              uVar11 = lRadius2;
              if (dx <= iRadius) {
                dy = _abs(*(int *)((int)&rgptPlan[0].y + lppl->id * 4) - local_a);
                uVar11 = lRadius2;
                if (dy <= iRadius) {
                  uVar10 = __aFulmul((long)dy,(long)dy);
                  uVar9 = (undefined2)uVar10;
                  uVar11 = __aFulmul((long)dx,(long)dx);
                  d2 = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar9);
                  uVar11 = lRadius2;
                  if (d2 <= (long)lRadius2) {
                    uVar9 = (undefined2)((ulong)lppl >> 0x10);
                    pPVar7 = (PLANET *)lppl;
                    if ((((uint)pPVar7->wFlags >> 9 & 1) != 0) && (pPVar7->iPlayer != -1)) {
                      iVar8 = pPVar7->iPlayer * 4;
                      uVar16 = *(undefined2 *)(iVar8 + 0x14e);
                      iVar8 = *(int *)(iVar8 + 0x14c) +
                              (*(uint *)&pPVar7->field11_0x2c & 0xf) * 0x93;
                      uVar3 = *(uint *)(iVar8 + 0x87);
                      iVar8 = *(int *)(iVar8 + 0x89);
                      if ((iVar8 < 1) && ((iVar8 < 0 || (uVar3 < 10000)))) {
                        uVar16 = 0;
                        uVar9 = 10000;
                        uVar10 = __aFulmul(lRadius2,CONCAT22(iVar8,uVar3));
                        lVar13 = __aFldiv(uVar10,CONCAT22(uVar16,uVar9));
                        if (lVar13 < d2) {
                          MarkPlanet(lppl,iPlr,2);
                          uVar11 = lRadius2;
                          goto LAB_1070_abc2;
                        }
                      }
                    }
                    MarkPlanet(lppl,iPlr,3);
                    uVar11 = lRadius2;
                  }
                }
              }
            }
LAB_1070_abc2:
            lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
          }
        }
      }
      else if (((((uint)pFVar2->wFlags >> 8 & 1) == 0) && (pFVar2->idPlanet != -1)) &&
              (((PLANET *)lpPlanets)[pFVar2->idPlanet].iPlayer == iPlr)) {
        MarkFleet((FLEET *)CONCAT22(iVar8,pFVar2),3);
        uVar11 = lRadius2;
        uVar10 = lRadPlanet2;
      }
    }
    ifl = ifl + 1;
  } while( true );
}



// ======================================================================
// Function: SetVisPFPlanets
// Address: 1070:abde
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1070b8e2) */
/* WARNING: Removing unreachable block (ram,0x1070b66c) */
/* WARNING: Removing unreachable block (ram,0x1070b379) */
/* WARNING: Removing unreachable block (ram,0x1070b3ea) */
/* WARNING: Removing unreachable block (ram,0x1070b1fe) */
/* WARNING: Removing unreachable block (ram,0x1070b3c7) */
/* WARNING: Removing unreachable block (ram,0x1070b35e) */
/* WARNING: Removing unreachable block (ram,0x1070b6ef) */
/* WARNING: Removing unreachable block (ram,0x1070b989) */
/* WARNING: Removing unreachable block (ram,0x1070ae4e) */
/* WARNING: Removing unreachable block (ram,0x1070ae76) */
/* WARNING: Removing unreachable block (ram,0x1070aefc) */
/* WARNING: Removing unreachable block (ram,0x1070af60) */

void SetVisPFPlanets(short iPlr)

{
  uint *puVar1;
  FLEET *pFVar2;
  uint uVar3;
  short sVar4;
  int iVar5;
  ushort uVar6;
  int iVar7;
  THING *pTVar8;
  PLANET *pPVar9;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar10;
  ulong uVar11;
  long lVar12;
  long lVar13;
  undefined2 uVar14;
  undefined2 uVar15;
  short rgStargateRange [16];
  ushort grbitPlr;
  PLANET *lpplMac2;
  undefined2 local_42;
  undefined4 l;
  short dx;
  short fStargateView;
  short iRadius;
  THING *lpthMac;
  undefined2 local_34;
  short i;
  undefined4 lRadius2;
  THING *lpth;
  short j;
  PLANET *lppl;
  undefined4 d2;
  FLEET *lpfl2;
  short dy;
  PLANET *lppl2;
  short pctCloak;
  int pt;
  int local_10;
  PLANET *lpplMac;
  undefined2 local_c;
  short iRadPlanet;
  undefined4 lRadPlanet2;
  
  lVar13 = CONCAT22(unaff_SI,unaff_DI);
  if (iPlr == -1) {
    grbitPlr = 0;
  }
  else {
    grbitPlr = 1 << ((byte)iPlr & 0x1f);
  }
  fStargateView = 0;
  sVar4 = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
  if (sVar4 == raStargate) {
    for (i = 0; i < 10; i = i + 1) {
      rgStargateRange[i] = 0;
      if ((*(uint *)(*(int *)(iPlr * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) {
        sVar4 = StargateRangeFromLppl((PLANET *)0x0,iPlr,i);
        rgStargateRange[i] = sVar4;
        if (0 < sVar4) {
          fStargateView = 1;
        }
      }
    }
  }
  if (iPlr != -1) {
    UpdateProgressGauge(-0x39f);
  }
  uVar10 = CONCAT22(lRadPlanet2._2_2_,(undefined2)lRadPlanet2);
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_c = lpPlanets._2_2_;
  do {
    lRadPlanet2 = uVar10;
    if (lpplMac <= (PLANET *)lppl) {
      if (iPlr != -1) {
        UpdateProgressGauge(-0x39f);
        uVar10 = lRadPlanet2;
      }
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      lpplMac = (PLANET *)lpPlanets + cPlanet;
      local_c = lpPlanets._2_2_;
      do {
        lRadPlanet2 = uVar10;
        if (lpplMac <= (PLANET *)lppl) {
          if (iPlr != -1) {
            UpdateProgressGauge(-0x39f);
            uVar10 = lRadPlanet2;
          }
          lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
          lpplMac = (PLANET *)lpPlanets + cPlanet;
          local_c = lpPlanets._2_2_;
          do {
            lRadPlanet2 = uVar10;
            if (lpplMac <= (PLANET *)lppl) {
              if (iPlr != -1) {
                UpdateProgressGauge(-0x39f);
                uVar10 = lRadPlanet2;
              }
              lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
              lpplMac = (PLANET *)lpPlanets + cPlanet;
              local_c = lpPlanets._2_2_;
              do {
                if (lpplMac <= (PLANET *)lppl) {
                  return;
                }
                if (((PLANET *)lppl)->iPlayer == iPlr) {
                  lRadPlanet2 = uVar10;
                  iRadius = GetPlanetScannerRange(lppl,&iRadPlanet);
                  uVar10 = __aFulmul((long)iRadius,(long)iRadius);
                  lRadius2 = uVar10;
                  uVar10 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
                  pt = ((POINT *)rgptPlan + lppl->id)->x;
                  local_10 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
                  if (0 < iRadPlanet) {
                    iRadius = iRadPlanet;
                    lpplMac2 = (PLANET *)lpPlanets + cPlanet;
                    local_42 = lpPlanets._2_2_;
                    lppl2 = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
                    lRadius2 = uVar10;
                    while ((PLANET *)lppl2 < lpplMac2) {
                      uVar14 = (undefined2)((ulong)lppl2 >> 0x10);
                      if ((((uint)((PLANET *)lppl2)->wFlags >> 8 & 1) == 0) ||
                         ((((PLANET *)lppl2)->wFlags & 0xffU) < 3)) {
                        lRadPlanet2 = uVar10;
                        dx = _abs(((POINT *)rgptPlan + lppl2->id)->x - pt);
                        uVar10 = lRadPlanet2;
                        if (dx <= iRadius) {
                          dy = _abs(*(int *)((int)&rgptPlan[0].y + lppl2->id * 4)
                                            - local_10);
                          uVar10 = lRadPlanet2;
                          if (dy <= iRadius) {
                            uVar10 = __aFulmul((long)dy,(long)dy);
                            uVar14 = (undefined2)uVar10;
                            uVar11 = __aFulmul((long)dx,(long)dx);
                            d2 = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar14);
                            uVar10 = lRadPlanet2;
                            if (d2 <= (long)lRadius2) {
                              uVar14 = (undefined2)((ulong)lppl2 >> 0x10);
                              pPVar9 = (PLANET *)lppl2;
                              if ((((uint)pPVar9->wFlags >> 9 & 1) != 0) && (pPVar9->iPlayer != -1))
                              {
                                iVar5 = pPVar9->iPlayer * 4;
                                uVar15 = *(undefined2 *)(iVar5 + 0x14e);
                                iVar5 = *(int *)(iVar5 + 0x14c) +
                                        (*(uint *)&pPVar9->field11_0x2c & 0xf) * 0x93;
                                uVar3 = *(uint *)(iVar5 + 0x87);
                                iVar5 = *(int *)(iVar5 + 0x89);
                                if ((iVar5 < 1) && ((iVar5 < 0 || (uVar3 < 10000)))) {
                                  uVar15 = 0;
                                  uVar14 = 10000;
                                  uVar10 = __aFulmul(lRadius2,CONCAT22(iVar5,uVar3));
                                  lVar13 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                                  if (lVar13 < d2) {
                                    MarkPlanet(lppl2,iPlr,2);
                                    uVar10 = lRadPlanet2;
                                    goto LAB_1070_b9c4;
                                  }
                                }
                              }
                              MarkPlanet(lppl2,iPlr,3);
                              uVar10 = lRadPlanet2;
                            }
                          }
                        }
                      }
LAB_1070_b9c4:
                      lppl2 = (PLANET *)CONCAT22(lppl2._2_2_,(PLANET *)lppl2 + 1);
                    }
                  }
                }
                lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
              } while( true );
            }
            if (((PLANET *)lppl)->iPlayer == iPlr) {
              iRadius = GetPlanetScannerRange(lppl,&iRadPlanet);
              uVar10 = __aFulmul((long)iRadius,(long)iRadius);
              lRadius2 = uVar10;
              uVar10 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
              lRadPlanet2 = uVar10;
              pt = ((POINT *)rgptPlan + lppl->id)->x;
              local_10 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
              if (fStargateView != 0) {
                uVar14 = (undefined2)((ulong)lppl >> 0x10);
                pPVar9 = (PLANET *)lppl;
                if ((((uint)pPVar9->wFlags >> 9 & 1) != 0) &&
                   (0 < rgStargateRange[*(uint *)&pPVar9->field11_0x2c & 0xf])) {
                  iRadius = rgStargateRange[*(uint *)&pPVar9->field11_0x2c & 0xf];
                  uVar10 = __aFulmul((long)iRadius,(long)iRadius);
                  lpplMac2 = (PLANET *)lpPlanets + cPlanet;
                  local_42 = lpPlanets._2_2_;
                  lppl2 = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
                  lRadius2 = uVar10;
                  uVar10 = lRadPlanet2;
                  while ((PLANET *)lppl2 < lpplMac2) {
                    uVar14 = (undefined2)((ulong)lppl2 >> 0x10);
                    if (((((uint)((PLANET *)lppl2)->wFlags >> 8 & 1) == 0) ||
                        ((((PLANET *)lppl2)->wFlags & 0xffU) < 3)) &&
                       (((uint)((PLANET *)lppl2)->wFlags >> 9 & 1) != 0)) {
                      lRadPlanet2 = uVar10;
                      sVar4 = StargateRangeFromLppl(lppl2,0,0);
                      uVar10 = lRadPlanet2;
                      if (sVar4 != 0) {
                        if (9999 < iRadius) goto IO_LMarkStargate;
                        dx = _abs(((POINT *)rgptPlan + lppl2->id)->x - pt);
                        uVar10 = lRadPlanet2;
                        if (dx <= iRadius) {
                          dy = _abs(*(int *)((int)&rgptPlan[0].y + lppl2->id * 4)
                                            - local_10);
                          uVar10 = lRadPlanet2;
                          if (dy <= iRadius) {
                            uVar10 = __aFulmul((long)dy,(long)dy);
                            uVar14 = (undefined2)uVar10;
                            uVar11 = __aFulmul((long)dx,(long)dx);
                            d2 = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar14);
                            uVar10 = lRadPlanet2;
                            if (d2 <= (long)lRadius2) {
                              uVar15 = (undefined2)((ulong)lppl2 >> 0x10);
                              iVar5 = ((PLANET *)lppl2)->iPlayer * 4;
                              uVar14 = *(undefined2 *)(iVar5 + 0x14e);
                              iVar5 = *(int *)(iVar5 + 0x14c) +
                                      (*(uint *)&((PLANET *)lppl2)->field11_0x2c & 0xf) * 0x93;
                              uVar3 = *(uint *)(iVar5 + 0x87);
                              iVar5 = *(int *)(iVar5 + 0x89);
                              if ((iVar5 < 1) && ((iVar5 < 0 || (uVar3 < 10000)))) {
                                uVar15 = 0;
                                uVar14 = 10000;
                                uVar10 = __aFulmul(lRadius2,CONCAT22(iVar5,uVar3));
                                lVar13 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                                uVar10 = lRadPlanet2;
                                if (lVar13 < d2) goto LAB_1070_b70c;
                              }
IO_LMarkStargate:
                              MarkPlanet(lppl2,iPlr,3);
                              uVar10 = lRadPlanet2;
                            }
                          }
                        }
                      }
                    }
LAB_1070_b70c:
                    lppl2 = (PLANET *)CONCAT22(lppl2._2_2_,(PLANET *)lppl2 + 1);
                  }
                }
              }
            }
            lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
          } while( true );
        }
        if (((PLANET *)lppl)->iPlayer == iPlr) {
          iRadius = GetPlanetScannerRange(lppl,&iRadPlanet);
          uVar10 = __aFulmul((long)iRadius,(long)iRadius);
          lRadius2 = uVar10;
          uVar10 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
          pt = ((POINT *)rgptPlan + lppl->id)->x;
          local_10 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
          lpthMac = (THING *)lpThings + cThing;
          local_34 = lpThings._2_2_;
          lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
          while ((THING *)lpth < lpthMac) {
            if ((((iPlr != -1) &&
                 (((((uint)lpth->idFull >> 0xd == 0 || ((uint)lpth->idFull >> 0xd == 1)) ||
                   (((uint)lpth->idFull >> 0xd == 3 || ((uint)lpth->idFull >> 0xd == 2)))) &&
                  ((uVar14 = (undefined2)((ulong)lpth >> 0x10), (uint)lpth->idFull >> 0xd != 0 ||
                   ((*(uint *)(((THING *)lpth)->rgb + 8) & grbitPlr) == 0)))))) &&
                (((uint)lpth->idFull >> 0xd != 3 ||
                 ((*(uint *)(((THING *)lpth)->rgb + 4) >> 4 & 1) == 0)))) &&
               ((((uint)lpth->idFull >> 0xd != 1 || (-1 < *(int *)((THING *)lpth)->rgb)) &&
                (((uint)lpth->idFull >> 0xd != 2 ||
                 ((*(uint *)((THING *)lpth)->rgb >> 0xd & 1) == 0)))))) {
              lRadPlanet2 = uVar10;
              dx = _abs(pt - (&((THING *)lpth)->pt)->x);
              uVar10 = lRadPlanet2;
              if (dx <= iRadius) {
                dy = _abs(local_10 - (((THING *)lpth)->pt).y);
                uVar10 = lRadPlanet2;
                if (dy <= iRadius) {
                  uVar10 = __aFulmul((long)dy,(long)dy);
                  uVar6 = (ushort)uVar10;
                  uVar11 = __aFulmul((long)dx,(long)dx);
                  l = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar6);
                  uVar10 = lRadPlanet2;
                  if (l <= (long)lRadius2) {
                    pTVar8 = (THING *)lpth;
                    uVar14 = (undefined2)((ulong)lpth >> 0x10);
                    if ((uint)lpth->idFull >> 0xd == 1) {
                      *(uint *)pTVar8->rgb = *(uint *)pTVar8->rgb & 0x7fff | 0x8000;
IO_LThIncPlr2:
                      uVar10 = lRadPlanet2;
                      if ((*(uint *)((int)&rgplr[0].wMdPlr +
                                    ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1) == 0) {
                        *(uint *)((int)&rgplr[0].wMdPlr +
                                 ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) =
                             *(uint *)((int)&rgplr[0].wMdPlr +
                                      ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfeff | 0x100;
                        *(uint *)((int)&rgplr[0].wMdPlr +
                                 ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) =
                             *(uint *)((int)&rgplr[0].wMdPlr +
                                      ((uint)lpth->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 | 3;
                      }
                    }
                    else if ((uint)lpth->idFull >> 0xd == 3) {
                      *(uint *)(pTVar8->rgb + 4) = *(uint *)(pTVar8->rgb + 4) & 0xffef | 0x10;
                    }
                    else {
                      if ((uint)lpth->idFull >> 0xd != 2) {
                        if (((*(uint *)(pTVar8->rgb + 4) & grbitPlr) == 0) &&
                           ((long)lRadPlanet2 < l)) {
                          lVar12 = __aFlshr(lVar13,uVar6);
                          uVar10 = lRadPlanet2;
                          if (lVar12 < l) goto LAB_1070_b409;
                        }
                        uVar14 = (undefined2)((ulong)lpth >> 0x10);
                        puVar1 = (uint *)(((THING *)lpth)->rgb + 4);
                        *puVar1 = *puVar1 | grbitPlr;
                        puVar1 = (uint *)(((THING *)lpth)->rgb + 8);
                        *puVar1 = *puVar1 | grbitPlr;
                        goto IO_LThIncPlr2;
                      }
                      if ((*(uint *)(pTVar8->rgb + 2) & grbitPlr) == 0) {
                        lVar12 = __aFlshr(lVar13,uVar6);
                        if ((lVar12 < l) && (uVar10 = lRadPlanet2, (long)lRadPlanet2 < l))
                        goto LAB_1070_b409;
                      }
                      uVar14 = (undefined2)((ulong)lpth >> 0x10);
                      pTVar8 = (THING *)lpth;
                      *(uint *)(pTVar8->rgb + 2) = *(uint *)(pTVar8->rgb + 2) | grbitPlr;
                      *(uint *)pTVar8->rgb = *(uint *)pTVar8->rgb & 0xdfff | 0x2000;
                      uVar10 = lRadPlanet2;
                    }
                  }
                }
              }
            }
LAB_1070_b409:
            lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
          }
        }
        lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
      } while( true );
    }
    if (((PLANET *)lppl)->iPlayer == iPlr) {
      iRadius = GetPlanetScannerRange(lppl,&iRadPlanet);
      uVar10 = __aFulmul((long)iRadius,(long)iRadius);
      lRadius2 = uVar10;
      uVar10 = __aFulmul((long)iRadPlanet,(long)iRadPlanet);
      pt = ((POINT *)rgptPlan + lppl->id)->x;
      local_10 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
      for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar2 = ((FLEET **)rglpfl)[j];
        iVar5 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
        lpfl2 = (FLEET *)CONCAT22(iVar5,pFVar2);
        if ((pFVar2 == (FLEET *)0x0) && (iVar5 == 0)) break;
        if ((((uint)pFVar2->wFlags >> 8 & 1) == 0) && (((uint)pFVar2->wFlags >> 10 & 1) == 0)) {
          lRadPlanet2 = uVar10;
          dx = _abs(pt - (&pFVar2->pt)->x);
          uVar10 = lRadPlanet2;
          if (dx <= iRadius) {
            dy = _abs(local_10 - (((FLEET *)lpfl2)->pt).y);
            uVar10 = lRadPlanet2;
            if (dy <= iRadius) {
              uVar10 = __aFulmul((long)dy,(long)dy);
              uVar14 = (undefined2)uVar10;
              uVar11 = __aFulmul((long)dx,(long)dx);
              l = uVar11 + CONCAT22((int)(uVar10 >> 0x10),uVar14);
              uVar10 = lRadPlanet2;
              if ((l <= (long)lRadius2) &&
                 ((((FLEET *)lpfl2)->idPlanet == -1 || (l <= (long)lRadPlanet2)))) {
                pctCloak = PctCloakFromLpfl(lpfl2);
                if (pctCloak == 0) {
                  MarkFleet(lpfl2,3);
                  uVar10 = lRadPlanet2;
                }
                else {
                  uVar15 = 0;
                  uVar14 = 100;
                  iVar5 = 100 - pctCloak;
                  iVar7 = iVar5 >> 0xf;
                  lVar12 = 100;
                  uVar10 = __aFulmul(lRadius2,(long)(100 - pctCloak));
                  uVar10 = __aFldiv(uVar10,lVar12);
                  uVar10 = __aFulmul(uVar10,CONCAT22(iVar7,iVar5));
                  lVar12 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                  uVar10 = lRadPlanet2;
                  if (l <= lVar12) {
                    if (((FLEET *)lpfl2)->idPlanet != -1) {
                      uVar15 = 0;
                      uVar14 = 100;
                      iVar5 = 100 - pctCloak;
                      iVar7 = iVar5 >> 0xf;
                      lVar12 = 100;
                      uVar10 = __aFulmul(lRadPlanet2,(long)(100 - pctCloak));
                      uVar10 = __aFldiv(uVar10,lVar12);
                      uVar10 = __aFulmul(uVar10,CONCAT22(iVar7,iVar5));
                      lVar12 = __aFldiv(uVar10,CONCAT22(uVar15,uVar14));
                      uVar10 = lRadPlanet2;
                      if (lVar12 < l) goto LAB_1070_ad5d;
                    }
                    MarkFleet(lpfl2,3);
                    uVar10 = lRadPlanet2;
                  }
                }
              }
            }
          }
        }
LAB_1070_ad5d:
      }
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  } while( true );
}



// ======================================================================
// Function: SetVisPFThings
// Address: 1070:b9ee
// Segment: MEMORY_IO
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1070c0f0) */
/* WARNING: Removing unreachable block (ram,0x1070bc7d) */
/* WARNING: Removing unreachable block (ram,0x1070c3b9) */
/* WARNING: Removing unreachable block (ram,0x1070bbf7) */
/* WARNING: Removing unreachable block (ram,0x1070be5c) */
/* WARNING: Removing unreachable block (ram,0x1070bfb4) */
/* WARNING: Removing unreachable block (ram,0x1070c197) */

void SetVisPFThings(short iPlr)

{
  int iVar1;
  int iVar2;
  FLEET *pFVar3;
  uint uVar4;
  short sVar5;
  int iVar6;
  int iVar7;
  uint uVar8;
  uint uVar9;
  short sVar10;
  THING *pTVar11;
  THING *pTVar12;
  PLANET *pPVar13;
  int iVar14;
  int iVar15;
  undefined2 uVar16;
  undefined2 uVar17;
  ulong uVar18;
  ulong uVar19;
  long lVar20;
  ulong uVar21;
  ulong uVar22;
  undefined2 uVar23;
  undefined2 uVar24;
  THING *lpth2;
  long l__44;
  ushort grbitPlr;
  short dx;
  short iRadius;
  THING *lpth;
  short j;
  FLEET *lpfl2;
  short dy;
  short pctCloak;
  
  if (iPlr == -1) {
    uVar4 = 0;
  }
  else {
    uVar4 = 1 << ((byte)iPlr & 0x1f);
  }
  sVar5 = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
  if (sVar5 == raMassAccel) {
    pTVar11 = (THING *)lpThings + cThing;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < pTVar11) {
      uVar17 = (undefined2)((ulong)lpth >> 0x10);
      if ((((uint)lpth->idFull >> 0xd == 1) && (((uint)lpth->idFull >> 9 & 0xf) == iPlr)) &&
         ((*(uint *)((THING *)lpth)->rgb >> 10 & 0xf) != 0)) {
        *(uint *)((THING *)lpth)->rgb = *(uint *)((THING *)lpth)->rgb & 0x7fff | 0x8000;
        iVar6 = (*(uint *)((THING *)lpth)->rgb >> 10 & 0xf) + 4;
        iVar6 = iVar6 * iVar6;
        uVar21 = __aFulmul((long)iVar6,(long)iVar6);
        iVar1 = (&((THING *)lpth)->pt)->x;
        iVar2 = (((THING *)lpth)->pt).y;
        for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar3 = ((FLEET **)rglpfl)[j];
          iVar15 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
          if ((pFVar3 == (FLEET *)0x0) && (iVar15 == 0)) break;
          if (((((uint)pFVar3->wFlags >> 8 & 1) == 0) &&
              ((((uint)pFVar3->wFlags >> 10 & 1) == 0 &&
               (sVar5 = _abs(iVar1 - (&pFVar3->pt)->x), sVar5 <= iVar6)))) &&
             (sVar10 = _abs(iVar2 - (pFVar3->pt).y), sVar10 <= iVar6)) {
            uVar22 = __aFulmul((long)sVar10,(long)sVar10);
            uVar18 = __aFulmul((long)sVar5,(long)sVar5);
            if ((long)(uVar18 + uVar22) <= (long)uVar21) {
              sVar5 = PctCloakFromLpfl((FLEET *)CONCAT22(iVar15,pFVar3));
              if (sVar5 == 0) {
                MarkFleet((FLEET *)CONCAT22(iVar15,pFVar3),3);
              }
              else {
                uVar23 = 0;
                uVar16 = 100;
                iVar7 = 100 - sVar5;
                iVar14 = iVar7 >> 0xf;
                lVar20 = 100;
                uVar19 = __aFulmul(uVar21,(long)(100 - sVar5));
                uVar19 = __aFldiv(uVar19,lVar20);
                uVar19 = __aFulmul(uVar19,CONCAT22(iVar14,iVar7));
                lVar20 = __aFldiv(uVar19,CONCAT22(uVar23,uVar16));
                if ((long)(uVar18 + uVar22) <= lVar20) {
                  MarkFleet((FLEET *)CONCAT22(iVar15,pFVar3),3);
                }
              }
            }
          }
        }
        pTVar12 = (THING *)lpThings + cThing;
        lpth2 = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
        while ((THING *)lpth2 < pTVar12) {
          if (((iPlr != -1) &&
              (((((uint)lpth2->idFull >> 0xd == 0 || ((uint)lpth2->idFull >> 0xd == 1)) ||
                ((uint)lpth2->idFull >> 0xd == 3)) || ((uint)lpth2->idFull >> 0xd == 2)))) &&
             (((((uint)lpth2->idFull >> 0xd != 0 ||
                ((*(uint *)(((THING *)lpth2)->rgb + 8) & uVar4) == 0)) &&
               (((uint)lpth2->idFull >> 0xd != 3 ||
                ((*(uint *)(((THING *)lpth2)->rgb + 4) >> 4 & 1) == 0)))) &&
              (((((uint)lpth2->idFull >> 0xd != 1 || (-1 < *(int *)((THING *)lpth2)->rgb)) &&
                (((uint)lpth2->idFull >> 0xd != 2 ||
                 ((*(uint *)((THING *)lpth2)->rgb >> 0xd & 1) == 0)))) &&
               ((sVar5 = _abs(iVar1 - (&((THING *)lpth2)->pt)->x), sVar5 <= iVar6 &&
                (sVar10 = _abs(iVar2 - (((THING *)lpth2)->pt).y), sVar10 <= iVar6)))))))) {
            uVar22 = __aFulmul((long)sVar10,(long)sVar10);
            uVar18 = __aFulmul((long)sVar5,(long)sVar5);
            if ((long)(uVar18 + uVar22) <= (long)uVar21) {
              if ((uint)lpth2->idFull >> 0xd == 1) {
                *(uint *)((THING *)lpth2)->rgb = *(uint *)((THING *)lpth2)->rgb & 0x7fff | 0x8000;
IO_LThIncPlr3:
                if ((*(uint *)((int)&rgplr[0].wMdPlr +
                              ((uint)lpth2->idFull >> 9 & 0xf) * 0xc0) >> 8 & 1) == 0) {
                  *(uint *)((int)&rgplr[0].wMdPlr +
                           ((uint)lpth2->idFull >> 9 & 0xf) * 0xc0) =
                       *(uint *)((int)&rgplr[0].wMdPlr +
                                ((uint)lpth2->idFull >> 9 & 0xf) * 0xc0) & 0xfeff | 0x100;
                  *(uint *)((int)&rgplr[0].wMdPlr +
                           ((uint)lpth2->idFull >> 9 & 0xf) * 0xc0) =
                       *(uint *)((int)&rgplr[0].wMdPlr +
                                ((uint)lpth2->idFull >> 9 & 0xf) * 0xc0) & 0xfff8 | 3;
                }
              }
              else if ((uint)lpth2->idFull >> 0xd == 3) {
                *(uint *)(((THING *)lpth2)->rgb + 4) =
                     *(uint *)(((THING *)lpth2)->rgb + 4) & 0xffef | 0x10;
              }
              else {
                if ((uint)lpth2->idFull >> 0xd != 2) {
                  *(uint *)(((THING *)lpth2)->rgb + 4) =
                       *(uint *)(((THING *)lpth2)->rgb + 4) | uVar4;
                  *(uint *)(((THING *)lpth2)->rgb + 8) =
                       *(uint *)(((THING *)lpth2)->rgb + 8) | uVar4;
                  goto IO_LThIncPlr3;
                }
                if (((*(uint *)(((THING *)lpth2)->rgb + 2) & uVar4) != 0) ||
                   ((long)(uVar18 + uVar22) <= (long)uVar21)) {
                  *(uint *)(((THING *)lpth2)->rgb + 2) =
                       *(uint *)(((THING *)lpth2)->rgb + 2) | uVar4;
                  *(uint *)((THING *)lpth2)->rgb = *(uint *)((THING *)lpth2)->rgb & 0xdfff | 0x2000;
                }
              }
            }
          }
          lpth2 = (THING *)CONCAT22(lpth2._2_2_,(THING *)lpth2 + 1);
        }
        pPVar13 = (PLANET *)lpPlanets + cPlanet;
        l__44 = CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
        while ((PLANET *)l__44 < pPVar13) {
          uVar16 = (undefined2)((ulong)l__44 >> 0x10);
          if ((((((uint)((PLANET *)l__44)->wFlags >> 8 & 1) == 0) ||
               ((((PLANET *)l__44)->wFlags & 0xffU) < 3)) &&
              (sVar5 = _abs(((POINT *)rgptPlan + *(int *)l__44)->x - iVar1),
              sVar5 <= iVar6)) &&
             (sVar10 = _abs(*(int *)((int)&rgptPlan[0].y + *(int *)l__44 * 4) -
                                    iVar2), sVar10 <= iVar6)) {
            uVar22 = __aFulmul((long)sVar10,(long)sVar10);
            uVar18 = __aFulmul((long)sVar5,(long)sVar5);
            if ((long)(uVar18 + uVar22) <= (long)uVar21) {
              if ((((uint)((PLANET *)l__44)->wFlags >> 9 & 1) != 0) &&
                 (((PLANET *)l__44)->iPlayer != -1)) {
                iVar15 = ((PLANET *)l__44)->iPlayer * 4;
                uVar23 = *(undefined2 *)(iVar15 + 0x14e);
                iVar15 = *(int *)(iVar15 + 0x14c) +
                         (*(uint *)&((PLANET *)l__44)->field11_0x2c & 0xf) * 0x93;
                uVar8 = *(uint *)(iVar15 + 0x87);
                iVar15 = *(int *)(iVar15 + 0x89);
                if ((iVar15 < 1) && ((iVar15 < 0 || (uVar8 < 10000)))) {
                  uVar24 = 0;
                  uVar23 = 10000;
                  uVar19 = __aFulmul(uVar21,CONCAT22(iVar15,uVar8));
                  lVar20 = __aFldiv(uVar19,CONCAT22(uVar24,uVar23));
                  if (lVar20 < (long)(uVar18 + uVar22)) {
                    MarkPlanet((PLANET *)l__44,iPlr,2);
                    goto LAB_1070_c1d2;
                  }
                }
              }
              MarkPlanet((PLANET *)l__44,iPlr,3);
            }
          }
LAB_1070_c1d2:
          l__44 = CONCAT22(uVar16,(PLANET *)l__44 + 1);
        }
      }
      lpth = (THING *)CONCAT22(uVar17,(THING *)lpth + 1);
    }
  }
  else {
    sVar5 = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
    if (sVar5 == raMines) {
      pTVar11 = (THING *)lpThings + cThing;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      while ((THING *)lpth < pTVar11) {
        uVar17 = (undefined2)((ulong)lpth >> 0x10);
        if (((uint)lpth->idFull >> 0xd == 0) && (((uint)lpth->idFull >> 9 & 0xf) == iPlr)) {
          uVar4 = *(uint *)((THING *)lpth)->rgb;
          iVar1 = *(int *)(((THING *)lpth)->rgb + 2);
          iVar2 = (&((THING *)lpth)->pt)->x;
          iVar6 = (((THING *)lpth)->pt).y;
          for (j = 0; j < cFleet; j = j + 1) {
                    /* WARNING: Load size is inaccurate */
            pFVar3 = ((FLEET **)rglpfl)[j];
            iVar15 = *(int *)((int)((FLEET **)rglpfl + j) + 2);
            if ((pFVar3 == (FLEET *)0x0) && (iVar15 == 0)) break;
            if ((((uint)pFVar3->wFlags >> 8 & 1) == 0) &&
               ((((uint)pFVar3->wFlags >> 10 & 1) == 0 && (pFVar3->idPlanet == -1)))) {
              uVar8 = _abs(iVar2 - (&pFVar3->pt)->x);
              if (((int)uVar8 >> 0xf <= iVar1) && (((int)uVar8 >> 0xf < iVar1 || (uVar8 <= uVar4))))
              {
                uVar9 = _abs(iVar6 - (pFVar3->pt).y);
                if (((int)uVar9 >> 0xf <= iVar1) &&
                   (((int)uVar9 >> 0xf < iVar1 || (uVar9 <= uVar4)))) {
                  uVar21 = __aFulmul((long)(int)uVar9,(long)(int)uVar9);
                  uVar22 = __aFulmul((long)(int)uVar8,(long)(int)uVar8);
                  if (((long)(uVar22 + uVar21) <= CONCAT22(iVar1,uVar4)) &&
                     ((sVar5 = PctCloakFromLpfl((FLEET *)CONCAT22(iVar15,pFVar3)), sVar5 == 0
                      || (sVar10 = Random(100), sVar5 <= sVar10)))) {
                    MarkFleet((FLEET *)CONCAT22(iVar15,pFVar3),3);
                  }
                }
              }
            }
          }
        }
        lpth = (THING *)CONCAT22(uVar17,(THING *)lpth + 1);
      }
    }
  }
  return;
}



// ======================================================================
// Function: SetVisPFFinish
// Address: 1070:c41c
// Segment: MEMORY_IO
// ======================================================================


void SetVisPFFinish(short iPlr)

{
  char *pcVar1;
  uint *puVar2;
  int iVar3;
  short sVar4;
  uint uVar5;
  short i;
  short j;
  short detMajor;
  
  sVar4 = GetRaceStat((PLAYER *)rgplr + iPlr,rsMajorAdv);
  if (sVar4 == raAttack) {
    uVar5 = 7;
  }
  else {
    uVar5 = 3;
  }
  i = 0;
  do {
    if (game.cPlayer <= i) {
      return;
    }
    if (i != iPlr) {
      *(undefined1 *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
      for (j = 0; j < 0x10; j = j + 1) {
        if ((1 << ((byte)iPlr & 0x1f) & *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x8b)) == 0) {
          if ((*(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) >> 8 & 1) != 0) {
            *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) =
                 *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xff00 | uVar5;
            goto IO_LFinShdef;
          }
        }
        else {
          *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) =
               *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
          *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) =
               *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xff00 | 7;
IO_LFinShdef:
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 3;
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
          pcVar1 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
          *pcVar1 = *pcVar1 + '\x01';
        }
      }
      *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
           *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xfff;
      for (j = 0; j < 10; j = j + 1) {
        if ((1 << ((byte)iPlr & 0x1f) & *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x8b)) == 0)
        {
          if ((*(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) >> 8 & 1) != 0) {
            *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) =
                 *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xff00 | uVar5;
            goto IO_LFinShdefSB;
          }
        }
        else {
          *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) =
               *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfeff | 0x100;
          *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) =
               *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xff00 | 7;
IO_LFinShdefSB:
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfeff | 0x100;
          *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfff8 | 3;
          iVar3 = *(int *)((int)&rgplr[0].wFlags + i * 0xc0);
          puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
          *puVar2 = *puVar2 & 0xfff;
          puVar2 = (uint *)((int)&rgplr[0].wFlags + i * 0xc0);
          *puVar2 = *puVar2 | iVar3 + 0x1000U & 0xf000;
        }
      }
    }
    i = i + 1;
  } while( true );
}



