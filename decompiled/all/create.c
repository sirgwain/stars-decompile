// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: InitBattlePlan
// Address: 1078:00c0
// Segment: MEMORY_CREATE
// ======================================================================


void InitBattlePlan(BTLPLAN *lpbtlplan,short iplan,short iplr)

{
  ushort *puVar1;
  BTLPLAN *pBVar2;
  int iVar3;
  ushort *puVar4;
  BTLPLAN *pBVar5;
  BTLPLAN *pBVar6;
  undefined2 uVar7;
  
  puVar4 = (ushort *)(iplan * hbrRed + 0xc);
  uVar7 = (undefined2)((ulong)lpbtlplan >> 0x10);
  pBVar5 = (BTLPLAN *)lpbtlplan;
  pBVar6 = pBVar5;
  for (iVar3 = 0x12; iVar3 != 0; iVar3 = iVar3 + -1) {
    pBVar2 = pBVar6;
    pBVar6 = &pBVar6->wFlags_0x2;
    puVar1 = puVar4;
    puVar4 = puVar4 + 1;
    pBVar2->wFlags = *puVar1;
  }
  lpbtlplan->wFlags = lpbtlplan->wFlags & 0xfff0 | iplr & 0xfU;
  if (((game.wCrap >> 2 & 1) != 0) && (iplan == 0)) {
    pBVar5->wFlags_0x2 = pBVar5->wFlags_0x2 & 0xe0ff | 0x300;
  }
  return;
}



// ======================================================================
// Function: GenerateWorld
// Address: 1078:0136
// Segment: MEMORY_CREATE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1078131a) */
/* WARNING: Removing unreachable block (ram,0x10781506) */
/* WARNING: Removing unreachable block (ram,0x107810ea) */
/* WARNING: Removing unreachable block (ram,0x107805e8) */
/* WARNING: Removing unreachable block (ram,0x1078054f) */
/* WARNING: Removing unreachable block (ram,0x1078050e) */
/* WARNING: Removing unreachable block (ram,0x10780569) */
/* WARNING: Removing unreachable block (ram,0x10780663) */
/* WARNING: Removing unreachable block (ram,0x107812fa) */
/* WARNING: Removing unreachable block (ram,0x107834f8) */
/* WARNING: Removing unreachable block (ram,0x1078133c) */
/* WARNING: Removing unreachable block (ram,0x10783517) */
/* WARNING: Removing unreachable block (ram,0x107814e6) */
/* WARNING: Removing unreachable block (ram,0x10783577) */
/* WARNING: Removing unreachable block (ram,0x10781528) */

short GenerateWorld(short fBatchMode)

{
  uint *puVar1;
  char *pcVar2;
  int *piVar3;
  undefined2 *puVar4;
  undefined2 uVar5;
  THING *pTVar6;
  void *pvVar7;
  POINT *pPVar8;
  THING *pTVar9;
  undefined1 uVar10;
  char cVar11;
  ushort uVar12;
  short sVar13;
  uint uVar14;
  int iVar15;
  uint uVar16;
  uint uVar17;
  short sVar18;
  char *pcVar19;
  POINT *pPVar20;
  long *plVar21;
  int iVar22;
  int *piVar23;
  uint *puVar24;
  undefined2 *puVar25;
  undefined2 *puVar26;
  PLANET *pPVar27;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 *puVar28;
  undefined2 unaff_SS;
  undefined2 unaff_DS;
  bool bVar29;
  ulong uVar30;
  long lVar31;
  void *pvVar32;
  ulong uVar33;
  long lVar34;
  undefined2 *puVar35;
  SHDEF *pSVar36;
  ulong uVar37;
  DWORD DVar38;
  undefined2 uVar39;
  undefined2 uVar40;
  long lVar41;
  uint in_stack_0000fec6;
  short l;
  undefined4 local_134;
  undefined4 local_130;
  short local_12c;
  uint local_12a;
  PLANET *local_128;
  undefined4 local_126;
  undefined1 local_122 [8];
  undefined4 local_11a;
  short iT;
  undefined4 uStack_114;
  long lBest;
  POINT *pptT;
  short cKillMax;
  short dx;
  short cPlanMax;
  short j;
  long lDistMin2;
  short dMax;
  byte *pb;
  short iNewLine;
  short rgi [16];
  long lDistIdeal2;
  long lDistMax2;
  SHDEF *lpshdef;
  short ktLeft;
  short dMin;
  POINT *pptMax;
  short iplrSingle;
  short xOld;
  short env [9];
  short i;
  short iMin;
  PLANET *lppl;
  short iLow;
  short dGalMinSq;
  short dy;
  STARPACK starpack;
  short iMax;
  short fFound;
  POINT pt;
  short k;
  short raMajor;
  POINT *ppt;
  short (*penvMemSav) [9];
  char grUsed [128];
  short cKill;
  short iBest;
  long *pl;
  
  lVar41 = CONCAT22(unaff_SI,unaff_DI);
  iMin = 0;
  cKill = 0;
  *(short *)&dGal = *(int *)&game.mdSize * 400 + 400;
  *(short *)&dGalInv = *(int *)&dGal + 2000;
  uVar40 = 0;
  uVar39 = 5000;
  uVar30 = __aFulmul((long)*(int *)&dGal,(long)*(int *)&dGal);
  lVar31 = __aFldiv(uVar30,CONCAT22(uVar40,uVar39));
  cPlanMax = (int)lVar31 + ((int)lVar31 / 4) * (*(int *)&game.mdDensity + -1);
  if (2 < *(int *)&game.mdDensity) {
    cPlanMax = cPlanMax + cPlanMax / 4;
  }
  if (0x3e6 < cPlanMax) {
    cPlanMax = 999;
  }
  dGalMinSq = *(int *)&dGalMinDist * *(int *)&dGalMinDist;
  if (cPlanMax / 7 + cPlanMax < 999) {
    uVar12 = cPlanMax / 7 + cPlanMax;
  }
  else {
    uVar12 = 999;
  }
  dx = 0x3f2;
  dy = *(int *)&dGal + -0x13;
  for (i = 0; i < (int)uVar12; i = i + 1) {
    sVar13 = Random(dy);
    ((POINT *)rgptPlan + i)->x = sVar13 + dx;
    sVar13 = Random(dy);
    *(int *)((int)&rgptPlan[0].y + i * 4) = sVar13 + dx;
  }
  _qsort((POINT *)rgptPlan,uVar12,4,
                 (void *)((int)(double *)&DOUBLE_0_0001__1120_1d6e + 6));
  pPVar20 = (POINT *)rgptPlan + uVar12;
  for (ppt = (POINT *)rgptPlan; ppt < pPVar20; ppt = ppt + 1) {
    if (-1 < ppt->y) {
      iNewLine = ppt->x + *(int *)&dGalMinDist;
      pPVar8 = ppt;
      while ((pptT = pPVar8 + 1, pptT < pPVar20 && (pptT->x <= iNewLine))) {
        dy = _abs(ppt->y - pPVar8[1].y);
        pPVar8 = pptT;
        if (dy <= *(int *)&dGalMinDist) {
          dx = ppt->x - pptT->x;
          local_11a = (THING *)CONCAT22(dy * dy,(THING *)local_11a);
          if (dx * dx + dy * dy <= dGalMinSq) {
            pptT->y = -100;
            cKill = cKill + 1;
          }
        }
      }
    }
  }
  cKillMax = uVar12 - cPlanMax;
  while( true ) {
    if (cKillMax <= cKill) break;
    i = Random(uVar12);
    if (-1 < *(int *)((int)&rgptPlan[0].y + i * 4)) {
      *(undefined2 *)((int)&rgptPlan[0].y + i * 4) = 0xff9c;
      cKill = cKill + 1;
    }
  }
  pptT = (POINT *)rgptPlan;
  for (ppt = (POINT *)rgptPlan; ppt < pPVar20; ppt = ppt + 1) {
    if (-1 < ppt->y) {
      sVar13 = ppt->y;
      pptT->x = ppt->x;
      pptT->y = sVar13;
      pptT = pptT + 1;
    }
  }
  cPlanMax = uVar12 - cKill;
  if ((*(uint *)&game.wCrap >> 8 & 1) != 0) {
    for (i = 0; i < cPlanMax; i = i + 1) {
      lBest._0_2_ = 0x9680;
      lBest._2_2_ = 0x98;
      iBest = 0;
      j = Random(cPlanMax);
      pt.x = ((POINT *)rgptPlan + j)->x;
      pt.y = *(int *)((int)&rgptPlan[0].y + j * 4);
      for (k = 0; k < cPlanMax; k = k + 1) {
        if (k != j) {
          dx = pt.x - ((POINT *)rgptPlan + k)->x;
          dy = pt.y - *(int *)((int)&rgptPlan[0].y + k * 4);
          local_11a = (THING *)__aFulmul((long)dy,(long)dy);
          uVar30 = __aFulmul((long)dx,(long)dx);
          uStack_114 = (long)&local_11a->idFull + uVar30;
          if ((long)uStack_114 < lBest) {
            iBest = k;
            lBest = uStack_114;
          }
        }
      }
      if (0x90 < lBest) {
        if (lBest < 0x641) {
          if (lBest < 0x272) {
            if (lBest < 0x145) {
              ((POINT *)rgptPlan + j)->x =
                   (((POINT *)rgptPlan + j)->x * 4 +
                   ((POINT *)rgptPlan + iBest)->x) / 5;
              *(int *)((int)&rgptPlan[0].y + j * 4) =
                   (*(int *)((int)&rgptPlan[0].y + j * 4) * 4 +
                   *(int *)((int)&rgptPlan[0].y + iBest * 4)) / 5;
            }
            else {
              ((POINT *)rgptPlan + j)->x =
                   (((POINT *)rgptPlan + j)->x * 2 +
                   ((POINT *)rgptPlan + iBest)->x) / 3;
              *(int *)((int)&rgptPlan[0].y + j * 4) =
                   (*(int *)((int)&rgptPlan[0].y + j * 4) * 2 +
                   *(int *)((int)&rgptPlan[0].y + iBest * 4)) / 3;
            }
          }
          else {
            ((POINT *)rgptPlan + j)->x =
                 (((POINT *)rgptPlan + j)->x + ((POINT *)rgptPlan + iBest)->x) /
                 2;
            *(int *)((int)&rgptPlan[0].y + j * 4) =
                 (*(int *)((int)&rgptPlan[0].y + j * 4) +
                 *(int *)((int)&rgptPlan[0].y + iBest * 4)) / 2;
          }
        }
        else {
          ((POINT *)rgptPlan + j)->x =
               (((POINT *)rgptPlan + iBest)->x * 2 + ((POINT *)rgptPlan + j)->x)
               / 3;
          *(int *)((int)&rgptPlan[0].y + j * 4) =
               (*(int *)((int)&rgptPlan[0].y + iBest * 4) * 2 +
               *(int *)((int)&rgptPlan[0].y + j * 4)) / 3;
        }
      }
    }
    _qsort((POINT *)rgptPlan,cPlanMax,4,
                   (void *)((int)(double *)&DOUBLE_0_0001__1120_1d6e + 6));
  }
  _memset(grUsed,0,0x80);
  for (i = 0; i < cPlanMax; i = i + 1) {
    dx = Random(999);
    while (((int)grUsed[dx >> 3] & *(uint *)((dx & 7U) * 2 + bitTbl)) != 0) {
      dx = dx + 1;
      if ((int)((*(uint *)&game.wCrap >> 3 & 1) + 999) <= dx) {
        dx = 0;
      }
    }
    grUsed[dx >> 3] = grUsed[dx >> 3] | (byte)*(undefined2 *)((dx & 7U) * 2 + bitTbl);
    ((short *)rgidPlan)[i] = dx;
  }
  *(short *)&cPlanet = cPlanMax;
  *(short (**) [9])&penvMem = &env;
  sVar13 = __setjmp(env);
  if (sVar13 != 0) {
    DestroyCurGame();
    return 0;
  }
  pvVar32 = LpAlloc(cPlanMax * 0x38,htPlanets);
  *(void **)(PLANET **)&lpPlanets = (void *)pvVar32;
  *(undefined2 *)((int)(PLANET **)&lpPlanets + 2) = (int)((ulong)pvVar32 >> 0x10);
                    /* WARNING: Load size is inaccurate */
  __fmemset((void *)CONCAT22(*(undefined2 *)((int)(PLANET **)&lpPlanets + 2),
                                     *(PLANET **)&lpPlanets),0,cPlanMax * 0x38);
  i = 0;
                    /* WARNING: Load size is inaccurate */
  lppl = (PLANET *)
         CONCAT22(*(undefined2 *)((int)(PLANET **)&lpPlanets + 2),
                  *(PLANET **)&lpPlanets);
  for (; i < cPlanMax; i = i + 1) {
    lppl->id = i;
    uVar39 = (undefined2)((ulong)lppl >> 0x10);
    pPVar27 = (PLANET *)lppl;
    pPVar27->iPlayer = -1;
    pPVar27->wFlags_0x4 = pPVar27->wFlags_0x4 & 0xff00 | 7;
    uVar17 = *(uint *)(pPVar27->rgbImp + 6);
    *(uint *)(pPVar27->rgbImp + 4) = *(uint *)(pPVar27->rgbImp + 4) & 0xfff | 0xf000;
    *(uint *)(pPVar27->rgbImp + 6) = uVar17 & 0xfffe | 1;
    if ((*(uint *)&game.wCrap >> 7 & 1) == 0) {
      sVar13 = Random(3);
      local_11a = (THING *)(ulong)(sVar13 == 0);
      lVar31 = __aFlshl(lVar41,in_stack_0000fec6);
      uVar39 = (undefined2)((ulong)lppl >> 0x10);
      pPVar27 = (PLANET *)lppl;
      uVar17 = *(uint *)(pPVar27->rgbImp + 4) | (uint)lVar31;
      local_122._6_2_ = *(uint *)(pPVar27->rgbImp + 6) & 0xffbf | (uint)((ulong)lVar31 >> 0x10);
      local_122._4_2_ = uVar17;
      *(uint *)(pPVar27->rgbImp + 4) = uVar17;
      *(undefined2 *)(pPVar27->rgbImp + 6) = local_122._6_2_;
    }
    sVar13 = Random(0x5a);
    ((PLANET *)lppl)->rgEnvVar[0] = (char)sVar13 + '\x01';
    sVar13 = Random(10);
    uVar39 = (undefined2)((ulong)lppl >> 0x10);
    pPVar27 = (PLANET *)lppl;
    pPVar27->rgEnvVar[0] = pPVar27->rgEnvVar[0] + (char)sVar13;
    pPVar27->rgEnvVarOrig[0] = pPVar27->rgEnvVar[0];
    sVar13 = Random(0x5a);
    ((PLANET *)lppl)->rgEnvVar[1] = (char)sVar13 + '\x01';
    sVar13 = Random(10);
    uVar39 = (undefined2)((ulong)lppl >> 0x10);
    pPVar27 = (PLANET *)lppl;
    pPVar27->rgEnvVar[1] = pPVar27->rgEnvVar[1] + (char)sVar13;
    pPVar27->rgEnvVarOrig[1] = pPVar27->rgEnvVar[1];
    sVar13 = Random(99);
    cVar11 = (char)sVar13 + '\x01';
    uVar39 = (undefined2)((ulong)lppl >> 0x10);
    pPVar27 = (PLANET *)lppl;
    pPVar27->rgEnvVarOrig[2] = cVar11;
    pPVar27->rgEnvVar[2] = cVar11;
    if ((*(uint *)&game.wCrap >> 3 & 1) != 0) {
      if (i == 5) {
        for (j = 0; j < 3; j = j + 1) {
          pPVar27->rgEnvVar[j] = pPVar27->rgEnvVar[j] + -5;
          pPVar27->rgEnvVarOrig[j] = pPVar27->rgEnvVar[j];
        }
      }
      else if (i == 0xb) {
        pPVar27->rgEnvVar[0] = pPVar27->rgEnvVar[0] + '\x14';
        pPVar27->rgEnvVarOrig[0] = pPVar27->rgEnvVar[0];
      }
    }
    for (j = 0; j < 3; j = j + 1) {
      if ((*(uint *)&game.wCrap & 1) == 0) {
        *(undefined2 *)(((PLANET *)lppl)->rgwtMin + j) = 0;
        *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + j) + 2) = 0;
        sVar13 = Random(0x2d);
        local_11a = (THING *)CONCAT22(sVar13,(THING *)local_11a);
        sVar13 = Random(0x2d);
        ((PLANET *)lppl)->rgMinConc[j] = (char)sVar13 + (char)((ulong)local_11a >> 0x10) + 0x1f;
        if ('Y' < ((PLANET *)lppl)->rgEnvVar[2]) {
          sVar13 = Random(99 - (uint)((PLANET *)lppl)->rgMinConc[j]);
          ((PLANET *)lppl)->rgMinConc[j] = ((PLANET *)lppl)->rgMinConc[j] + (char)(sVar13 / 2);
        }
      }
      else {
        ((PLANET *)lppl)->rgMinConc[j] = 100;
      }
      ((PLANET *)lppl)->rgpctMinLevel[j] = 0;
      *(undefined2 *)(((PLANET *)lppl)->rgwtMin + j) = 0;
      *(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + j) + 2) = 0;
      if (((*(uint *)&game.wCrap >> 5 & 1) != 0) && (((PLANET *)lppl)->rgMinConc[j] < 0x28))
      {
        ((PLANET *)lppl)->rgMinConc[j] = ((PLANET *)lppl)->rgMinConc[j] + 5;
      }
    }
    if ((*(uint *)&game.wCrap & 1) == 0) {
      iT = Random(0x1b);
    }
    else {
      iT = 100;
    }
    if (iT < 0x12) {
      if (iT < 9) {
        for (iT = iT + 1; iT < 0x10; iT = iT << 1) {
          sVar13 = Random(0x1e);
          local_11a = (THING *)CONCAT22(sVar13,(THING *)local_11a);
          j = Random(3);
          ((PLANET *)lppl)->rgMinConc[j] = (char)((ulong)local_11a >> 0x10) + 1;
        }
      }
      else {
        sVar13 = Random(0x1e);
        local_11a = (THING *)CONCAT22(sVar13,(THING *)local_11a);
        j = Random(3);
        ((PLANET *)lppl)->rgMinConc[j] = (char)((ulong)local_11a >> 0x10) + 1;
      }
    }
    lppl = (PLANET *)lppl + 1;
  }
  for (j = 0; j < 3; j = j + 1) {
    sVar13 = Random((uint)*(byte *)(*(int *)(PLANET **)&lpPlanets + 9 + j) * 10);
    uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
    piVar23 = (int *)(*(int *)(PLANET **)&lpPlanets + 0x1c + j * 4);
    *piVar23 = sVar13 + 10;
    piVar23[1] = sVar13 + 10 >> 0xf;
    uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
    puVar24 = (uint *)(*(int *)(PLANET **)&lpPlanets + 0x1c + j * 4);
    uVar17 = puVar24[1];
    if (((int)uVar17 < 1) && (((int)uVar17 < 0 || (*puVar24 < 200)))) {
      sVar13 = Random(0x96);
      uVar14 = sVar13 + 0x9b;
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      puVar24 = (uint *)(*(int *)(PLANET **)&lpPlanets + 0x1c + j * 4);
      puVar1 = puVar24;
      uVar17 = *puVar1;
      *puVar1 = *puVar1 + uVar14;
      puVar1 = puVar24 + 1;
      *puVar1 = *puVar1 + ((int)uVar14 >> 0xf) + (uint)CARRY2(uVar17,uVar14);
    }
    if ((*(uint *)&game.wCrap >> 5 & 1) != 0) {
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      puVar25 = (undefined2 *)(*(int *)(PLANET **)&lpPlanets + 0x1c + j * 4);
      lVar31 = __aFldiv(CONCAT22(puVar25[1],*puVar25),4);
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      puVar24 = (uint *)(*(int *)(PLANET **)&lpPlanets + 0x1c + j * 4);
      puVar1 = puVar24;
      uVar17 = *puVar1;
      *puVar1 = *puVar1 + (uint)lVar31;
      puVar1 = puVar24 + 1;
      *puVar1 = *puVar1 + (int)((ulong)lVar31 >> 0x10) + (uint)CARRY2(uVar17,(uint)lVar31);
    }
  }
  uVar30 = __aFulmul((long)*(int *)&dGal,6);
  iVar15 = *(int *)&game.cPlayer;
  iVar22 = iVar15 >> 0xf;
  uStack_114 = uVar30;
  uVar30 = __aFulmul((long)*(int *)&dGal,(long)*(int *)&dGal);
  lVar31 = __aFldiv(uVar30,CONCAT22(iVar22,iVar15));
  uVar30 = lVar31 - uStack_114;
  if (((long)uVar30 < 0x10000) && ((long)uVar30 < 0)) {
    uVar30 = 0;
  }
  else {
    uVar40 = 0;
    uVar39 = 10;
    uVar30 = __aFulmul(uVar30,9);
    uVar30 = __aFldiv(uVar30,CONCAT22(uVar40,uVar39));
  }
  uVar40 = 0;
  uVar39 = 3;
  uVar30 = __aFulmul(uVar30,(long)*(int *)&game.mdStartDist);
  lVar31 = __aFldiv(uVar30,CONCAT22(uVar40,uVar39));
  uVar30 = lVar31 + uStack_114;
  uVar40 = 0;
  uVar39 = 10;
  uVar33 = __aFulmul(uVar30,9);
  lDistMin2 = __aFldiv(uVar33,CONCAT22(uVar40,uVar39));
  uVar40 = 0;
  uVar39 = 6;
  uVar33 = __aFulmul(uVar30,7);
  lVar31 = __aFldiv(uVar33,CONCAT22(uVar40,uVar39));
CREATE_RetryAll:
  lBest = 100000000;
  iVar15 = *(int *)&dGal / 4 + 1000;
  dMax = (*(int *)&dGal * 3) / 4 + 1000;
  for (i = 0; i < 0x32; i = i + 1) {
    rgi[0] = Random(cPlanMax);
    pt.x = ((POINT *)rgptPlan + rgi[0])->x;
    pt.y = *(int *)((int)&rgptPlan[0].y + rgi[0] * 4);
    if (pt.x < iVar15) {
      dx = iVar15 - pt.x;
    }
    else if (dMax < pt.x) {
      dx = pt.x - dMax;
    }
    else {
      dx = 0;
    }
    if (pt.y < iVar15) {
      dy = iVar15 - pt.y;
    }
    else if (dMax < pt.y) {
      dy = pt.y - dMax;
    }
    else {
      dy = 0;
    }
    if ((dx == 0) && (dy == 0)) break;
    local_11a = (THING *)__aFulmul((long)dy,(long)dy);
    uVar33 = __aFulmul((long)dx,(long)dx);
    uStack_114 = (long)&local_11a->idFull + uVar33;
    if ((long)uStack_114 < lBest) {
      iBest = rgi[0];
      lBest = uStack_114;
    }
  }
  if (i == 0x32) {
    rgi[0] = iBest;
  }
  if (*(int *)&game.cPlayer < 5) {
    if (*(int *)&game.cPlayer < 3) {
      sVar13 = MulDiv(*(short *)&dGal,3,0x14);
      dMin = sVar13 + 1000;
      sVar13 = MulDiv(*(short *)&dGal,0x11,0x14);
      dMax = sVar13 + 1000;
    }
    else {
      dMin = *(int *)&dGal / 10 + 1000;
      sVar13 = MulDiv(*(short *)&dGal,9,10);
      dMax = sVar13 + 1000;
    }
  }
  else {
    dMin = *(int *)&dGal / 0x14 + 1000;
    sVar13 = MulDiv(*(short *)&dGal,0x13,0x14);
    dMax = sVar13 + 1000;
  }
  for (i = 1; i < *(int *)&game.cPlayer; i = i + 1) {
    for (j = 0; j < 0x32; j = j + 1) {
      sVar13 = Random(cPlanMax);
      rgi[i] = sVar13;
      pt.x = ((POINT *)rgptPlan + rgi[i])->x;
      pt.y = *(int *)((int)&rgptPlan[0].y + rgi[i] * 4);
      if ((((dMin <= pt.x) && (dMin <= pt.y)) && (pt.x <= dMax)) && (pt.y <= dMax)) {
        bVar29 = false;
        for (k = 0; k < i; k = k + 1) {
          dx = pt.x - ((POINT *)rgptPlan + rgi[k])->x;
          dy = pt.y - *(int *)((int)&rgptPlan[0].y + rgi[k] * 4);
          local_11a = (THING *)__aFulmul((long)dy,(long)dy);
          uVar33 = __aFulmul((long)dx,(long)dx);
          uStack_114 = (long)&local_11a->idFull + uVar33;
          if (((long)uStack_114 < 1) || ((long)uStack_114 < lDistMin2)) break;
          if ((long)uStack_114 <= lVar31) {
            bVar29 = true;
          }
        }
        if ((k == i) && (bVar29)) break;
      }
    }
    if (j == 0x32) {
      iBest = rgi[i];
      do {
        do {
          piVar23 = rgi + i;
          piVar3 = piVar23;
          *piVar3 = *piVar3 + 1;
          if ((*piVar23 == iBest) || ((cPlanMax <= rgi[i] && (rgi[i] = 0, iBest == 0))))
          goto LAB_1078_1566;
          pt.x = ((POINT *)rgptPlan + rgi[i])->x;
          pt.y = *(int *)((int)&rgptPlan[0].y + rgi[i] * 4);
        } while ((pt.x < dMin) || (((pt.y < dMin || (dMax < pt.x)) || (dMax < pt.y))));
        bVar29 = false;
        for (k = 0; k < i; k = k + 1) {
          dx = pt.x - ((POINT *)rgptPlan + rgi[k])->x;
          dy = pt.y - *(int *)((int)&rgptPlan[0].y + rgi[k] * 4);
          local_11a = (THING *)__aFulmul((long)dy,(long)dy);
          uVar33 = __aFulmul((long)dx,(long)dx);
          uStack_114 = (long)&local_11a->idFull + uVar33;
          if (((long)uStack_114 < 1) || ((long)uStack_114 < lDistMin2)) break;
          if ((long)uStack_114 <= lVar31) {
            bVar29 = true;
          }
        }
      } while ((k != i) || (!bVar29));
LAB_1078_1566:
      if (iBest == rgi[i]) goto LAB_1078_157c;
    }
  }
  for (i = 0; i < *(int *)&game.cPlayer; i = i + 1) {
    sVar13 = Random(*(int *)&game.cPlayer - i);
    j = sVar13 + i;
    sVar13 = rgi[j];
    rgi[j] = rgi[i];
    rgi[i] = sVar13;
    sVar13 = GetRaceGrbit((PLAYER *)rgplr + i,ibitRaceAIPlayer);
    if (sVar13 != 0) {
      CreateRandomRace((PLAYER *)rgplr + i);
    }
    local_11a = (THING *)(CONCAT22(*(undefined2 *)((int)&rgplr[0].wFlags + i * 0xc0),
                                   (THING *)local_11a) & 0xfffeffff);
    *(undefined2 *)((int)&rgplr[0].wFlags + i * 0xc0) = local_11a._2_2_;
    local_11a = (THING *)(CONCAT22(*(undefined2 *)((int)&rgplr[0].wFlags + i * 0xc0),
                                   (THING *)local_11a) & 0xfff7ffff);
    *(undefined2 *)((int)&rgplr[0].wFlags + i * 0xc0) = local_11a._2_2_;
    *(undefined2 *)((int)&rgplr[0].grbitTrader + i * 0xc0) = 0;
    for (j = 0; j < 6; j = j + 1) {
      *(undefined1 *)(i * 0xc0 + 0x59bc + j) = 0;
      puVar25 = (undefined2 *)(i * 0xc0 + 0x59c2 + j * 4);
      *puVar25 = 0;
      puVar25[1] = 0;
    }
    sVar13 = GetRaceStat((PLAYER *)rgplr + i,rsMajorAdv);
    switch(sVar13) {
    case 1:
      *(undefined1 *)((int)rgplr[0].rgTech + 4 + i * 0xc0) = 5;
      break;
    case 2:
      *(undefined1 *)((int)rgplr[0].rgTech + 1 + i * 0xc0) = 6;
      *(undefined1 *)((int)rgplr[0].rgTech + 2 + i * 0xc0) = 1;
      *(undefined1 *)((int)rgplr[0].rgTech + i * 0xc0) = 1;
      break;
    case 3:
      *(undefined1 *)((int)rgplr[0].rgTech + 5 + i * 0xc0) = 6;
      *(undefined1 *)((int)rgplr[0].rgTech + 3 + i * 0xc0) = 2;
      *(undefined1 *)((int)rgplr[0].rgTech + i * 0xc0) = 1;
      *(undefined1 *)((int)rgplr[0].rgTech + 1 + i * 0xc0) = 1;
      *(undefined1 *)((int)rgplr[0].rgTech + 2 + i * 0xc0) = 1;
      break;
    case 5:
      *(undefined1 *)((int)rgplr[0].rgTech + 2 + i * 0xc0) = 2;
      *(undefined1 *)((int)rgplr[0].rgTech + 5 + i * 0xc0) = 2;
      break;
    case 6:
      *(undefined1 *)((int)rgplr[0].rgTech + i * 0xc0) = 4;
      break;
    case 7:
      *(undefined1 *)((int)rgplr[0].rgTech + 2 + i * 0xc0) = 5;
      *(undefined1 *)((int)rgplr[0].rgTech + 3 + i * 0xc0) = 5;
      break;
    case 8:
      *(undefined1 *)((int)rgplr[0].rgTech + i * 0xc0) = 1;
      break;
    case 9:
      for (j = 0; j < 6; j = j + 1) {
        *(undefined1 *)(i * 0xc0 + 0x59bc + j) = 3;
      }
    }
    sVar13 = GetRaceGrbit((PLAYER *)rgplr + i,ibitRaceTech3);
    if (sVar13 != 0) {
      sVar13 = GetRaceStat((PLAYER *)rgplr + i,rsMajorAdv);
      local_11a = (THING *)CONCAT22((sVar13 == 9) + 3,(THING *)local_11a);
      for (j = 0; j < 6; j = j + 1) {
        if ((int)*(char *)(i * 0xc0 + 0x59bc + j) < (int)local_11a._2_2_) {
          sVar13 = GetRaceStat((PLAYER *)rgplr + i,j + rsTechBonus1);
          pTVar9 = local_11a;
          if (sVar13 == 0) {
            local_11a = (THING *)CONCAT22(local_11a._2_2_,local_11a._2_2_);
            *(undefined1 *)(i * 0xc0 + 0x59bc + j) = (char)((ulong)pTVar9 >> 0x10);
          }
        }
      }
    }
    sVar13 = GetRaceGrbit((PLAYER *)rgplr + i,ibitRaceCheapEngines);
    if (sVar13 != 0) {
      pcVar2 = (char *)((int)rgplr[0].rgTech + 2 + i * 0xc0);
      *pcVar2 = *pcVar2 + '\x01';
    }
    sVar13 = GetRaceGrbit((PLAYER *)rgplr + i,ibitRaceIFE);
    if ((sVar13 != 0) && ((*(uint *)&game.wCrap >> 3 & 1) == 0)) {
      pcVar2 = (char *)((int)rgplr[0].rgTech + 2 + i * 0xc0);
      *pcVar2 = *pcVar2 + '\x01';
    }
    for (j = 0; j < 4; j = j + 1) {
      FSendPlrMsg(i,j + idmTipCanHideUnimportantMessagesClickingCheckmark,-1,0,0,0,0,0,0,0);
    }
  }
  for (i = 0; i < *(int *)&game.cPlayer; i = i + 1) {
    iMin = rgi[i];
    *(short *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 2) = i;
    *(uint *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 4) =
         *(uint *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 4) & 0xfdff | 0x200;
    *(uint *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0x2c) =
         *(uint *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0x2c) & 0xfff0;
    uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
    iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
    local_11a = (THING *)(CONCAT22(*(undefined2 *)(iVar15 + 0x1a),*(undefined2 *)(iVar15 + 0x18)) &
                         0xffbfffff);
    uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
    iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
    *(undefined2 *)(iVar15 + 0x18) = (THING *)local_11a;
    *(undefined2 *)(iVar15 + 0x1a) = local_11a._2_2_;
    uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
    iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
    uVar30 = CONCAT22(*(undefined2 *)(iVar15 + 0x16),*(undefined2 *)(iVar15 + 0x14)) & 0xfffff;
    local_11a._2_2_ = (THING *)((uint)(uVar30 >> 0x10) | 0xa0);
    uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
    iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
    local_11a._0_2_ = (THING *)uVar30;
    *(undefined2 *)(iVar15 + 0x14) = (THING *)local_11a;
    *(uint *)(iVar15 + 0x16) = (uint)local_11a._2_2_;
    uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
    iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
    uVar30 = CONCAT22(*(undefined2 *)(iVar15 + 0x16),*(undefined2 *)(iVar15 + 0x14)) & 0xfff000ff;
    local_11a._0_2_ = (THING *)((uint)uVar30 | 0xa00);
    uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
    iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
    local_11a._2_2_ = (THING *)(uVar30 >> 0x10);
    *(uint *)(iVar15 + 0x14) = (uint)(THING *)local_11a;
    *(undefined2 *)(iVar15 + 0x16) = local_11a._2_2_;
    uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
    iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
    uVar17 = *(uint *)(iVar15 + 0x18);
    uVar39 = *(undefined2 *)(iVar15 + 0x1a);
    uVar40 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
    iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
    *(uint *)(iVar15 + 0x18) = uVar17 & 0xf000 | 10;
    *(undefined2 *)(iVar15 + 0x1a) = uVar39;
    local_11a = (THING *)(CONCAT22(*(undefined2 *)
                                    (*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 4),uVar17)
                          & 0xfbfff000 | 0x400000a);
    *(undefined2 *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 4) = local_11a._2_2_;
    sVar13 = GetRaceGrbit((PLAYER *)rgplr + i,ibitRaceLowStartingPop);
    if (sVar13 == 0) {
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      *(undefined2 *)(iVar15 + hbrBlue) = 0xfa;
      *(undefined2 *)(iVar15 + lpfnTutorDlgProc) = 0;
    }
    else {
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      *(undefined2 *)(iVar15 + hbrBlue) = 0xaf;
      *(undefined2 *)(iVar15 + lpfnTutorDlgProc) = 0;
    }
    local_122._6_2_ =
         *(uint *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0x12) & 0xf000 |
         *(uint *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0x28) / 4 & 0xfff;
    *(uint *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0x12) = local_122._6_2_;
    for (j = 0; j < 3; j = j + 1) {
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      puVar25 = (undefined2 *)(*(int *)(PLANET **)&lpPlanets + 0x1c + j * 4);
      uVar40 = puVar25[1];
      uVar5 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      puVar26 = (undefined2 *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0x1c + j * 4);
      *puVar26 = *puVar25;
      puVar26[1] = uVar40;
      if (((uint)((GDATA *)&gd)->grBits >> 0xb & 1) == 0) {
        if (*(byte *)(*(int *)(PLANET **)&lpPlanets + 9 + j) < 0x1e) {
          uVar10 = 0x1e;
        }
        else {
          uVar10 = *(undefined1 *)(*(int *)(PLANET **)&lpPlanets + 9 + j);
        }
        *(undefined1 *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 9 + j) = uVar10;
      }
      else {
        if (*(byte *)(*(int *)(PLANET **)&lpPlanets + 9 + j) < 0x19) {
          uVar10 = 0x19;
        }
        else {
          uVar10 = *(undefined1 *)(*(int *)(PLANET **)&lpPlanets + 9 + j);
        }
        *(undefined1 *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 9 + j) = uVar10;
      }
    }
    uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
    iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
    local_11a = (THING *)(CONCAT22(*(undefined2 *)(iVar15 + 0x1a),*(undefined2 *)(iVar15 + 0x18)) &
                         0xfffe0fff);
    uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
    iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
    *(undefined2 *)(iVar15 + 0x18) = (THING *)local_11a;
    *(undefined2 *)(iVar15 + 0x1a) = local_11a._2_2_;
    FSendPlrMsg(i,idmHomePlanetPeopleReadyLeaveNestExplore,iMin,iMin,0,0,0,0,0,0);
    sVar13 = CAdvantagePoints((PLAYER *)rgplr + i);
    if (sVar13 < 0x33) {
      iT = CAdvantagePoints((PLAYER *)rgplr + i);
    }
    else {
      iT = 0x32;
    }
    if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) != 0) &&
       (iT = 0x32, 2 < (*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 10 & 7))) {
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      local_11a = (THING *)__aFldiv(CONCAT22(*(undefined2 *)(iVar15 + lpfnTutorDlgProc),
                                                     *(undefined2 *)(iVar15 + hbrBlue)),10);
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      puVar1 = (uint *)(iVar15 + hbrBlue);
      uVar17 = *puVar1;
      *puVar1 = *puVar1 + (uint)local_11a;
      piVar3 = (int *)(iVar15 + lpfnTutorDlgProc);
      *piVar3 = *piVar3 + (int)((ulong)local_11a >> 0x10) + (uint)CARRY2(uVar17,(uint)local_11a);
    }
    if ((*(uint *)&game.wCrap >> 5 & 1) != 0) {
      sVar13 = PctTrueMaxGrowth(i);
      iVar15 = sVar13 * 2 + 10;
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar22 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      local_11a._2_2_ = (THING *)iVar15;
      join_0x00000008_0x00000000_ =
           __aFulmul(CONCAT22(*(undefined2 *)(iVar22 + lpfnTutorDlgProc),
                                      *(undefined2 *)(iVar22 + hbrBlue)),(long)iVar15);
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      *(undefined2 *)(iVar15 + hbrBlue) = (int)join_0x00000008_0x00000000_;
      *(undefined2 *)(iVar15 + lpfnTutorDlgProc) = (int)(join_0x00000008_0x00000000_ >> 0x10);
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      lVar31 = __aFldiv(CONCAT22(*(undefined2 *)(iVar15 + lpfnTutorDlgProc),
                                         *(undefined2 *)(iVar15 + hbrBlue)),10);
      local_122._6_2_ = (undefined2)lVar31;
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      *(uint *)(iVar15 + hbrBlue) = local_122._6_2_;
      *(undefined2 *)(iVar15 + lpfnTutorDlgProc) = (int)((ulong)lVar31 >> 0x10);
      uVar17 = (*(uint *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0x12) & 0x3ff) << 2;
      local_11a = (THING *)CONCAT22(local_11a._2_2_,uVar17);
      puVar1 = (uint *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0x12);
      *puVar1 = *puVar1 & 0xf000;
      puVar1 = (uint *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0x12);
      *puVar1 = *puVar1 | uVar17;
    }
    j = GetRaceStat((PLAYER *)rgplr + i,rsUseLeftover);
    if (j == 0) {
LAB_1078_2167:
      iVar15 = iT * 10;
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar22 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      plVar21 = (long *)(iVar22 + 0x1c);
      pl = (long *)CONCAT22(uVar39,plVar21);
      if ((*(int *)(iVar22 + hbrGray) < *(int *)(iVar22 + 0x1e)) ||
         ((*(int *)(iVar22 + hbrGray) <= *(int *)(iVar22 + 0x1e) &&
          (*(uint *)(iVar22 + hbrLightGray) <= (uint)*pl)))) {
        if ((*(int *)(iVar22 + hbrGreen) < *(int *)(iVar22 + hbrGray)) ||
           ((*(int *)(iVar22 + hbrGreen) <= *(int *)(iVar22 + hbrGray) &&
            (*(uint *)(iVar22 + hbrRed) <= *(uint *)(iVar22 + hbrLightGray))))) {
          iLow = 2;
        }
        else {
          iLow = 1;
        }
      }
      else if ((*(int *)(iVar22 + hbrGreen) < *(int *)(iVar22 + 0x1e)) ||
              ((*(int *)(iVar22 + hbrGreen) <= *(int *)(iVar22 + 0x1e) &&
               (*(uint *)(iVar22 + hbrRed) <= (uint)*pl)))) {
        iLow = 2;
      }
      else {
        iLow = 0;
      }
      local_11a = (THING *)(CONCAT22(iVar15,(THING *)local_11a) & 0x3ffff);
      uVar14 = iVar15 >> 2;
      uVar16 = uVar14 + (int)local_11a._2_2_;
      puVar1 = (uint *)(plVar21 + iLow);
      uVar17 = *puVar1;
      *puVar1 = *puVar1 + uVar16;
      puVar1 = (uint *)((int)(plVar21 + iLow) + 2);
      *puVar1 = *puVar1 + ((int)uVar16 >> 0xf) + (uint)CARRY2(uVar17,uVar16);
      for (j = 0; j < 3; j = j + 1) {
        puVar1 = (uint *)(plVar21 + j);
        uVar17 = *puVar1;
        *puVar1 = *puVar1 + uVar14;
        puVar1 = (uint *)((int)(plVar21 + j) + 2);
        *puVar1 = *puVar1 + (iVar15 >> 0xf) + (uint)CARRY2(uVar17,uVar14);
      }
      if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) != 0) &&
         (1 < (*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 10 & 7))) {
CREATE_LConcentrations:
        if ((iT < 1) || (2 < iT)) {
          ktLeft = iT / 2;
        }
        else {
          ktLeft = 1;
        }
        pb._2_2_ = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
        pb._0_2_ = (byte *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 9);
        iLow = 0;
        for (j = 0; j < 3; j = j + 1) {
          local_11a = (THING *)(ulong)CONCAT12(((byte *)pb)[j],(THING *)local_11a);
          if (((byte *)pb)[j] < ((byte *)pb)[iLow]) {
            iLow = j;
          }
        }
        ((byte *)pb)[iLow] = ((byte *)pb)[iLow] + (char)ktLeft;
        for (j = 0; j < 3; j = j + 1) {
          ((byte *)pb)[j] = ((byte *)pb)[j] + (char)((ktLeft + 1) / 2);
        }
      }
    }
    else {
      if (j == 1) goto CREATE_LConcentrations;
      if (j == 2) {
        lVar31 = __aFlshl(lVar41,in_stack_0000fec6);
        local_122._6_2_ = (undefined2)((ulong)lVar31 >> 0x10);
        uVar17 = (uint)lVar31;
        local_122._4_2_ = uVar17;
        uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
        iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
        puVar1 = (uint *)(iVar15 + 0x14);
        local_11a = (THING *)(CONCAT22(local_122._6_2_ + *(int *)(iVar15 + 0x16) +
                                       (uint)CARRY2(uVar17,*puVar1),uVar17 + *puVar1) & 0xfff00);
        uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
        iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
        puVar1 = (uint *)(iVar15 + 0x14);
        *puVar1 = *puVar1 & 0xff;
        puVar1 = (uint *)(iVar15 + 0x16);
        *puVar1 = *puVar1 & 0xfff0;
        uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
        iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
        puVar1 = (uint *)(iVar15 + 0x14);
        *puVar1 = *puVar1 | (uint)(THING *)local_11a;
        puVar1 = (uint *)(iVar15 + 0x16);
        *puVar1 = *puVar1 | (uint)local_11a._2_2_;
      }
      else if (j == 3) {
        lVar31 = __aFlshl(lVar41,in_stack_0000fec6);
        local_122._6_2_ = (undefined2)((ulong)lVar31 >> 0x10);
        local_122._4_2_ = (uint)lVar31;
        uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
        iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
        uVar17 = local_122._6_2_ + *(int *)(iVar15 + 0x16) +
                 (uint)CARRY2((uint)lVar31,*(uint *)(iVar15 + 0x14)) & 0xfff0;
        local_11a = (THING *)((ulong)uVar17 << 0x10);
        uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
        iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
        puVar35 = (undefined2 *)(iVar15 + 0x14);
        *puVar35 = *puVar35;
        puVar1 = (uint *)(iVar15 + 0x16);
        *puVar1 = *puVar1 & 0xf;
        uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
        iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
        puVar35 = (undefined2 *)(iVar15 + 0x14);
        *puVar35 = *puVar35;
        puVar1 = (uint *)(iVar15 + 0x16);
        *puVar1 = *puVar1 | uVar17;
      }
      else {
        if (j != 4) goto LAB_1078_2167;
        lVar31 = __aFlshl(lVar41,in_stack_0000fec6);
        local_122._6_2_ = (undefined2)((ulong)lVar31 >> 0x10);
        local_122._4_2_ = (int)lVar31;
        uVar17 = (int)lVar31 + *(int *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0x18) &
                 0xfff;
        local_11a = (THING *)(ulong)uVar17;
        uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
        iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
        puVar1 = (uint *)(iVar15 + 0x18);
        *puVar1 = *puVar1 & 0xf000;
        puVar35 = (undefined2 *)(iVar15 + 0x1a);
        *puVar35 = *puVar35;
        uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
        iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
        puVar1 = (uint *)(iVar15 + 0x18);
        *puVar1 = *puVar1 | uVar17;
        puVar35 = (undefined2 *)(iVar15 + 0x1a);
        *puVar35 = *puVar35;
      }
    }
    sVar13 = GetRaceStat((PLAYER *)rgplr + i,rsMajorAdv);
    if (sVar13 == 8) {
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      local_11a = (THING *)(CONCAT22(*(undefined2 *)(iVar15 + 0x16),*(undefined2 *)(iVar15 + 0x14))
                           & 0xfff000ff);
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      *(undefined2 *)(iVar15 + 0x14) = (THING *)local_11a;
      *(undefined2 *)(iVar15 + 0x16) = local_11a._2_2_;
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      local_11a = (THING *)(CONCAT22(*(undefined2 *)(iVar15 + 0x16),*(undefined2 *)(iVar15 + 0x14))
                           & 0xfffff);
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      *(undefined2 *)(iVar15 + 0x14) = (THING *)local_11a;
      *(undefined2 *)(iVar15 + 0x16) = local_11a._2_2_;
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      uVar17 = *(uint *)(iVar15 + 0x18);
      uVar39 = *(undefined2 *)(iVar15 + 0x1a);
      local_11a = (THING *)(CONCAT22(uVar39,uVar17) & 0xfffff000);
      uVar40 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + iMin * 0x38;
      *(uint *)(iVar15 + 0x18) = uVar17 & 0xf000;
      *(undefined2 *)(iVar15 + 0x1a) = uVar39;
    }
    local_11a = (THING *)CONCAT22(i,(THING *)local_11a);
    ((PLAYER *)rgplr + i)->iPlayer = (char)i;
    *(short *)((int)&rgplr[0].idPlanetHome + i * 0xc0) = iMin;
    if (*(char *)((int)rgplr[0].rgEnvVarMax + i * 0xc0) == -1) {
      sVar13 = Random(99);
      iT = sVar13 + 1;
    }
    else {
      iT = (int)*(char *)((int)rgplr[0].rgEnvVarMin + i * 0xc0) +
           ((int)*(char *)((int)rgplr[0].rgEnvVarMax + i * 0xc0) -
           (int)*(char *)((int)rgplr[0].rgEnvVarMin + i * 0xc0)) / 2;
    }
    *(undefined1 *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0xf) = (char)iT;
    local_11a = (THING *)CONCAT22(iT,iT);
    *(undefined1 *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0xc) = (char)iT;
    if (*(char *)((int)rgplr[0].rgEnvVarMax + 1 + i * 0xc0) == -1) {
      sVar13 = Random(99);
      iT = sVar13 + 1;
    }
    else {
      iT = (int)*(char *)((int)rgplr[0].rgEnvVarMin + 1 + i * 0xc0) +
           ((int)*(char *)((int)rgplr[0].rgEnvVarMax + 1 + i * 0xc0) -
           (int)*(char *)((int)rgplr[0].rgEnvVarMin + 1 + i * 0xc0)) / 2;
    }
    *(undefined1 *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0x10) = (char)iT;
    local_11a = (THING *)CONCAT22(iT,iT);
    *(undefined1 *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0xd) = (char)iT;
    if (*(char *)((int)rgplr[0].rgEnvVarMax + 2 + i * 0xc0) == -1) {
      sVar13 = Random(99);
      iT = sVar13 + 1;
    }
    else {
      iT = (int)*(char *)((int)rgplr[0].rgEnvVarMin + 2 + i * 0xc0) +
           ((int)*(char *)((int)rgplr[0].rgEnvVarMax + 2 + i * 0xc0) -
           (int)*(char *)((int)rgplr[0].rgEnvVarMin + 2 + i * 0xc0)) / 2;
    }
    *(undefined1 *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0x11) = (char)iT;
    *(undefined1 *)(*(int *)(PLANET **)&lpPlanets + iMin * 0x38 + 0xe) = (char)iT;
    if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) {
      *(undefined1 *)((int)&rgplr[0].pctResearch + i * 0xc0) = 0xf;
    }
    local_11a = (THING *)(CONCAT22((int)*(char *)((int)&rgplr[0].iTechCur + i * 0xc0),iT)
                         & 0xfff0ffff);
    *(undefined1 *)((int)&rgplr[0].iTechCur + i * 0xc0) = (char)((ulong)local_11a >> 0x10)
    ;
    uVar30 = CONCAT22((int)*(char *)((int)&rgplr[0].iTechCur + i * 0xc0),
                      (THING *)local_11a) & 0xff0fffff;
    *(byte *)((int)&rgplr[0].iTechCur + i * 0xc0) = (byte)(uVar30 >> 0x10) | 0x60;
    *(undefined2 *)((int)&rgplr[0].lResLastYear + i * 0xc0) = 0;
    *(undefined2 *)((int)&rgplr[0].lResLastYear + 2 + i * 0xc0) = 0;
    *(undefined2 *)((int)&rgplr[0].wScore + i * 0xc0) = 0;
    for (j = 0; j < *(int *)&game.cPlayer; j = j + 1) {
      *(undefined1 *)(i * 0xc0 + 0x5a12 + j) = 0;
    }
    local_11a._0_2_ = (THING *)uVar30;
    local_11a = (THING *)(CONCAT22(*(undefined2 *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0),
                                   (THING *)local_11a) & 0xfffffff | 0x10000000);
    *(undefined2 *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) = local_11a._2_2_;
    puVar35 = LpAlloc(0x5be,htShips);
    uVar39 = (undefined2)((ulong)puVar35 >> 0x10);
    puVar25 = (undefined2 *)puVar35;
    uVar12 = 0x24c;
    pSVar36 = LpshdefSBT();
    __fmemmove(puVar35,pSVar36,uVar12);
    __fmemset((undefined2 *)CONCAT22(uVar39,puVar25 + 0x126),0,0x372);
    *(undefined2 *)((int)puVar25 + 0x7f) = 1;
    *(undefined2 *)((int)puVar25 + 0x81) = 0;
    *(undefined2 *)((int)puVar25 + 0x83) = 1;
    *(undefined2 *)((int)puVar25 + 0x85) = 0;
    *(undefined2 *)(i * 4 + rglpshdefSB) = puVar25;
    *(undefined2 *)(i * 4 + rglpshdefSB_0x2) = uVar39;
    for (j = 1; j < 10; j = j + 1) {
      local_11a = (THING *)(CONCAT22(*(undefined2 *)((int)puVar25 + j * 0x93 + 0x7b),
                                     (THING *)local_11a) & 0xfdffffff | 0x2000000);
      *(undefined2 *)((int)puVar25 + j * 0x93 + 0x7b) = local_11a._2_2_;
    }
    sVar13 = GetRaceStat((PLAYER *)rgplr + i,rsMajorAdv);
    if (sVar13 == 6) {
      puVar25[0x1e] = puVar25[0x1e] & 0xff00 | 7;
      puVar25[0x1e] = puVar25[0x1e] & 0xff | 0x100;
      if (0 < *(int *)&game.mdSize) {
        puVar25[0x87] = puVar25[0x87] & 0xfdff;
        local_11a = (THING *)(CONCAT22(*(int *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) +
                                       0x1000,(THING *)local_11a) & 0xf000ffff);
        puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
        *puVar1 = *puVar1 & 0xfff;
        puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
        *puVar1 = *puVar1 | (uint)local_11a._2_2_;
        puVar25[0x8b] = 1;
        puVar25[0x8c] = 0;
        puVar25[0x89] = 1;
        puVar25[0x8a] = 0;
      }
    }
    else {
      sVar13 = GetRaceStat((PLAYER *)rgplr + i,rsMajorAdv);
      if ((sVar13 == 7) && ((*(uint *)&game.wCrap >> 3 & 1) == 0)) {
        puVar25[0x1e] = puVar25[0x1e] & 0xff00;
        puVar25[0x1e] = puVar25[0x1e] & 0xff | 0x100;
        if (0 < *(int *)&game.mdSize) {
          puVar26 = puVar25 + 0x93;
          puVar28 = (undefined2 *)((int)puVar25 + 0x93);
          for (iVar15 = 0x49; iVar15 != 0; iVar15 = iVar15 + -1) {
            puVar4 = puVar28;
            puVar28 = puVar28 + 1;
            puVar35 = puVar26;
            puVar26 = puVar26 + 1;
            *puVar4 = *puVar35;
          }
          *(undefined1 *)puVar28 = *(undefined1 *)puVar26;
          puVar25[0x87] = puVar25[0x87] & 0x83ff | 0x4400;
          puVar25[0x87] = puVar25[0x87] & 0xfdff;
          local_11a = (THING *)(CONCAT22(*(int *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0) +
                                         0x1000,(THING *)local_11a) & 0xf000ffff);
          puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
          *puVar1 = *puVar1 & 0xfff;
          puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
          *puVar1 = *puVar1 | (uint)local_11a._2_2_;
          puVar25[0x8b] = 1;
          puVar25[0x8c] = 0;
          puVar25[0x89] = 1;
          puVar25[0x8a] = 0;
        }
      }
      else {
        sVar13 = GetRaceStat((PLAYER *)rgplr + i,rsMajorAdv);
        if (sVar13 == 8) {
          uVar40 = *(undefined2 *)((int)&rgplr[0].idPlanetHome + i * 0xc0);
          puVar28 = (undefined2 *)((int)puVar25 + 0x93);
          puVar26 = puVar25;
          for (iVar15 = 0x49; iVar15 != 0; iVar15 = iVar15 + -1) {
            puVar4 = puVar28;
            puVar28 = puVar28 + 1;
            puVar35 = puVar26;
            puVar26 = puVar26 + 1;
            *puVar4 = *puVar35;
          }
          *(undefined1 *)puVar28 = *(undefined1 *)puVar26;
          puVar25[0x87] = puVar25[0x87] & 0x83ff | 0x4400;
          puVar26 = (undefined2 *)((int)puVar25 + 0x1b9);
          puVar28 = puVar25;
          for (iVar15 = 0x49; iVar15 != 0; iVar15 = iVar15 + -1) {
            puVar4 = puVar28;
            puVar28 = puVar28 + 1;
            puVar35 = puVar26;
            puVar26 = puVar26 + 1;
            *puVar4 = *puVar35;
          }
          *(undefined1 *)puVar28 = *(undefined1 *)puVar26;
          *(uint *)((int)puVar25 + 0x7b) = *(uint *)((int)puVar25 + 0x7b) & 0x83ff | 0x4000;
          *(uint *)((int)puVar25 + 0x7b) = *(uint *)((int)puVar25 + 0x7b) & 0xfdff;
          local_11a = (THING *)(CONCAT22(uVar40,*(int *)((int)&rgplr[0].wFlags_0x4 +
                                                        i * 0xc0) + 0x1000) & 0xfffff000);
          puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
          *puVar1 = *puVar1 & 0xfff;
          puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + i * 0xc0);
          *puVar1 = *puVar1 | (uint)(THING *)local_11a;
          *(undefined2 *)((int)puVar25 + 0x83) = 0;
          *(undefined2 *)((int)puVar25 + 0x85) = 0;
          *(undefined2 *)((int)puVar25 + 0x7f) = 0;
          *(undefined2 *)((int)puVar25 + 0x81) = 0;
          uVar30 = CONCAT22(local_11a._2_2_,
                            *(undefined2 *)
                             (*(int *)(PLANET **)&lpPlanets + (int)local_11a._2_2_ * 0x38 +
                             0x2c)) & 0xfffffff0;
          local_11a = (THING *)(uVar30 | 1);
          pTVar9 = local_11a;
          local_11a._2_2_ = (THING *)(uVar30 >> 0x10);
          local_11a._0_2_ = (THING *)pTVar9;
          *(undefined2 *)(*(int *)(PLANET **)&lpPlanets + (int)local_11a._2_2_ * 0x38 + 0x2c)
               = (THING *)local_11a;
          local_11a = pTVar9;
        }
      }
    }
  }
  *(short *)&cFleet = 0;
  pvVar32 = LpAlloc(4,htMisc);
  *(void **)(FLEET ***)&rglpfl = (void *)pvVar32;
  *(undefined2 *)((int)(FLEET ***)&rglpfl + 2) = (int)((ulong)pvVar32 >> 0x10);
  i = 0;
  do {
    if (*(int *)&game.cPlayer <= i) {
      *(short *)&idPlayer = -1;
      if (((PLANET *)*(PLANET **)&lpPlanets)->iPlayer == -1) {
        for (j = 0; j < 3; j = j + 1) {
          uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
          puVar25 = (undefined2 *)(*(int *)(PLANET **)&lpPlanets + 0x1c + j * 4);
          *puVar25 = 0;
          puVar25[1] = 0;
        }
      }
      for (i = 0; i < *(int *)&game.cPlayer; i = i + 1) {
        ((byte *)rgcbtlplan)[i] = 5;
        pvVar32 = LpAlloc(0x240,htShips);
        *(void **)((BTLPLAN **)rglpbtlplan + i) = (void *)pvVar32;
        *(undefined2 *)((int)(BTLPLAN **)rglpbtlplan + i * 4 + 2) =
             (int)((ulong)pvVar32 >> 0x10);
        for (j = 0; j < 5; j = j + 1) {
          InitBattlePlan((BTLPLAN *)
                         CONCAT22(*(undefined2 *)
                                   ((int)(BTLPLAN **)rglpbtlplan + i * 4 + 2),
                                  (BTLPLAN *)
                                  (*(int *)((BTLPLAN **)rglpbtlplan + i) + j * 0x24)),j,i)
          ;
        }
      }
      *(short *)&game.cPlanMax = cPlanMax;
      if ((*(uint *)&game.wCrap >> 7 & 1) == 0) {
        sVar13 = Random((uint)*(byte *)(*(int *)&game.mdSize + 6));
        local_11a = (THING *)CONCAT22(sVar13,(THING *)local_11a);
        iBest = (uint)*(byte *)*(undefined2 *)&game.mdSize + sVar13;
      }
      else {
        iBest = 0;
      }
      if (0 < iBest) {
        for (i = 0; i < iBest; i = i + 1) {
          for (j = 0; j < 2; j = j + 1) {
            local_11a = LpthNew(0,ithWormhole);
            local_122._0_2_ = Random(3);
            uVar39 = (undefined2)((ulong)local_11a >> 0x10);
            ((&((THING *)local_11a)->u_THING_0x0006)->thp).wFlags =
                 ((&((THING *)local_11a)->u_THING_0x0006)->thp).wFlags &
                 (hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|
                  hstMines|hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield) |
                 local_122._0_2_ & (hstScanner|hstEngine);
            if (j == 1) {
              local_122._2_4_ = LpthFromId(local_122._6_2_);
              *(ushort *)((int)&((THING *)local_11a)->u_THING_0x0006 + 6) =
                   ((THING *)local_122._2_4_)->idFull;
              *(ushort *)((int)&((THING *)local_122._2_4_)->u_THING_0x0006 + 6) = local_11a->idFull;
            }
            else {
              local_122._6_2_ = local_11a->idFull;
            }
            k = 0;
            iMax = 0x10;
            while (iVar15 = k + 1, k < 100) {
              sVar13 = Random(*(short *)&dGal);
              (&((THING *)local_11a)->pt)->x = sVar13 + 1000;
              sVar13 = Random(*(short *)&dGal);
              (((THING *)local_11a)->pt).y = sVar13 + 1000;
              iLow = IValidateWormholePos(local_11a);
              if (iLow == 0) break;
              k = iVar15;
              if (iLow < iMax) {
                uVar39 = (undefined2)((ulong)local_11a >> 0x10);
                pt.x = (&((THING *)local_11a)->pt)->x;
                pt.y = (((THING *)local_11a)->pt).y;
                iMax = iLow;
              }
            }
            if (iLow != 0) {
              uVar39 = (undefined2)((ulong)local_11a >> 0x10);
              (&((THING *)local_11a)->pt)->x = pt.x;
              (((THING *)local_11a)->pt).y = pt.y;
            }
          }
        }
      }
      for (i = 0; i < *(int *)&game.cPlayer; i = i + 1) {
        if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 4 & 1) != 0) {
          FSendPlrMsg2(i,idmRaceDefinitionHasTamperedStatisticsHaveAltered,-1,0,0);
          for (j = 0; j < *(int *)&game.cPlayer; j = j + 1) {
            if ((i != j) && ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0))
            {
              FSendPlrMsg2(j,idmHackedRaceDiscoveredRaceStatisticsHaveAltered,-1,i,0);
            }
          }
        }
      }
      iplrSingle = -1;
      for (i = 0; i < *(int *)&game.cPlayer; i = i + 1) {
        if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) ||
           (*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 0xd == 7)) {
          if (iplrSingle != -1) break;
          iplrSingle = i;
        }
        else {
          *(undefined2 *)((int)&rgplr[0].lSalt + i * 0xc0) = 0xabee;
          *(undefined2 *)((int)&rgplr[0].lSalt + 2 + i * 0xc0) = 0x94d;
        }
      }
      if ((i == *(int *)&game.cPlayer) && (iplrSingle != -1)) {
        iVar15 = 1;
      }
      else {
        iVar15 = 0;
      }
      local_11a = (THING *)CONCAT22(iVar15,(THING *)local_11a);
      *(uint *)&game.wCrap = *(uint *)&game.wCrap & 0xfffb | iVar15 << 2;
      if ((*(uint *)&game.wCrap >> 2 & 1) != 0) {
        for (i = 0; i < *(int *)&game.cPlayer; i = i + 1) {
          for (j = 0; j < *(int *)&game.cPlayer; j = j + 1) {
            if (i != j) {
              *(undefined1 *)(i * 0xc0 + 0x5a12 + j) = 2;
            }
          }
        }
      }
      if ((*(uint *)&game.wCrap >> 3 & 1) == 0) {
        DVar38 = GetTickCount();
        *&((GAME *)&game)->lid = (int)DVar38;
        *(undefined2 *)((int)&game.lid + 2) = (int)(DVar38 >> 0x10);
      }
      _wsprintf((char *)szWork,(char *)0xa24,(char *)szBase,unaff_DS);
      sVar13 = FCreateFile(dtXY,-1,(char *)0x0);
      if (sVar13 != 0) {
        WriteRt(7,0x40,(GAME *)&game);
        xOld = 1000;
        for (i = 0; i < cPlanMax; i = i + 1) {
          local_11a = (THING *)(long)*(int *)((int)&rgptPlan[0].y + i * 4);
          lVar31 = __aFlshl(lVar41,in_stack_0000fec6);
          starpack.dwFlags._0_2_ = (uint)starpack.dwFlags & 0x3ff | (uint)lVar31;
          starpack.dwFlags._2_2_ = starpack.dwFlags._2_2_ & 0xffc0 | (uint)((ulong)lVar31 >> 0x10);
          local_11a = (THING *)(long)((short *)rgidPlan)[i];
          lVar31 = __aFlshl(lVar41,in_stack_0000fec6);
          starpack.dwFlags._0_2_ = (uint)starpack.dwFlags | (uint)lVar31;
          starpack.dwFlags._2_2_ = starpack.dwFlags._2_2_ & 0x3f | (uint)((ulong)lVar31 >> 0x10);
          dx = ((POINT *)rgptPlan + i)->x - xOld;
          lVar31 = __aFlshl(lVar41,in_stack_0000fec6);
          starpack.dwFlags._0_2_ = (uint)starpack.dwFlags & 0xfc00 | (uint)lVar31;
          starpack.dwFlags._2_2_ = starpack.dwFlags._2_2_ | (uint)((ulong)lVar31 >> 0x10);
          RgToStream(&starpack,4);
          xOld = ((POINT *)rgptPlan + i)->x;
        }
        i = *(short *)&game.cPlayer;
        WriteRt(0,2,&i);
        StreamClose();
        for (i = -1; i < *(int *)&game.cPlayer; i = i + 1) {
          FWriteDataFile((char *)szBase,i,0);
        }
        if (fBatchMode == 0) {
          if ((*(uint *)&game.wCrap >> 2 & 1) == 0) {
            *(short *)&idPlayer = -1;
            *(short *)&imemLogCur = 0;
            CreateChildWindows();
          }
          else {
            DestroyCurGame();
            _wsprintf((char *)&local_11a,*(char **)&MPCTD,iplrSingle + 1);
            sVar13 = FLoadGame((char *)szBase,&local_11a);
            if (sVar13 == 0) {
              sVar13 = 0x10;
              pcVar19 = PszFormatIds(idsUnableOpenNewTurnFile,(short *)0x0);
              AlertSz(pcVar19,sVar13);
              return 0;
            }
            *(short *)&idPlayer = iplrSingle;
            CreateChildWindows();
            SendMessage(*(HWND *)&hwndFrame,0x111,0xfa1,0);
          }
          return 1;
        }
        return 1;
      }
      sVar13 = 0x10;
      pcVar19 = PszFormatIds(idsUnableCreateUniverseDefinitionFile,(short *)0x0);
      AlertSz(pcVar19,sVar13);
      DestroyCurGame();
      return 0;
    }
    *(short *)&idPlayer = i;
    pvVar32 = LpAlloc(0x930,htShips);
    uVar39 = (undefined2)((ulong)pvVar32 >> 0x10);
    pvVar7 = (void *)pvVar32;
    __fmemset(pvVar32,0,0x930);
    for (j = 0; j < 0x10; j = j + 1) {
      local_126 = (HullSlotType *)
                  (CONCAT22(*(undefined2 *)((int)pvVar7 + j * 0x93 + 0x7b),(HullSlotType *)local_126
                           ) & 0xfdffffff | 0x2000000);
      *(undefined2 *)((int)pvVar7 + j * 0x93 + 0x7b) = local_126._2_2_;
    }
    *(int *)(i * 4 + rglpshdef) = (int)pvVar7;
    *(undefined2 *)(i * 4 + rglpshdef_0x2) = uVar39;
    local_11a = (THING *)CONCAT22(local_11a._2_2_,
                                  (THING *)*(undefined2 *)
                                            ((int)&rgplr[0].idPlanetHome + i * 0xc0));
    sVar13 = GetRaceStat((PLAYER *)rgplr + i,rsMajorAdv);
    if (sVar13 == 6) {
      CreateStartupShip(i,(short)(THING *)local_11a,4,1);
      local_126 = (HullSlotType *)
                  (CONCAT22(*(undefined2 *)
                             (*(int *)(PLANET **)&lpPlanets + (int)(THING *)local_11a * 0x38
                             + 0x2e),(HullSlotType *)local_126) & 0xc3ffffff | 0x4000000);
      *(undefined2 *)(*(int *)(PLANET **)&lpPlanets + (int)(THING *)local_11a * 0x38 + 0x2e)
           = local_126._2_2_;
    }
    else if (sVar13 == 2) {
      CreateStartupShip(i,(short)(THING *)local_11a,3,1);
      if ('\x02' < *(char *)((int)rgplr[0].rgTech + 3 + i * 0xc0)) {
        CreateStartupShip(i,(short)(THING *)local_11a,7,1);
        CreateStartupShip(i,(short)(THING *)local_11a,0xd,1);
      }
    }
    else if (sVar13 == 9) {
      CreateStartupShip(i,(short)(THING *)local_11a,3,1);
      CreateStartupShip(i,(short)(THING *)local_11a,4,1);
    }
    else if (sVar13 == 1) {
      if (*(char *)((int)rgplr[0].rgTech + i * 0xc0) < '\x02') {
        sVar18 = 2;
      }
      else {
        sVar18 = 5;
      }
      CreateStartupShip(i,(short)(THING *)local_11a,sVar18,1);
      if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) {
        CreateStartupShip(i,(short)(THING *)local_11a,1,1);
      }
    }
    else {
      CreateStartupShip(i,(short)(THING *)local_11a,2,1);
    }
    if (sVar13 == 0) {
      sVar18 = CreateStartupShip(i,(short)(THING *)local_11a,0xc,1);
      local_11a = (THING *)CONCAT22(sVar18,(THING *)local_11a);
      for (j = 1; j < 3; j = j + 1) {
        CreateStartupShip(i,(short)(THING *)local_11a,(short)local_11a._2_2_,0);
      }
    }
    else if (sVar13 == 7) {
      CreateStartupShip(i,(short)(THING *)local_11a,0xb,1);
    }
    else if (sVar13 == 8) {
      CreateStartupShip(i,(short)(THING *)local_11a,10,1);
    }
    else {
      sVar18 = CreateStartupShip(i,(short)(THING *)local_11a,9,1);
      local_11a = (THING *)CONCAT22(sVar18,(THING *)local_11a);
    }
    if (sVar13 == 5) {
      CreateStartupShip(i,(short)(THING *)local_11a,0x10,1);
      CreateStartupShip(i,(short)(THING *)local_11a,0x12,1);
    }
    else if (sVar13 == 3) {
      CreateStartupShip(i,(short)(THING *)local_11a,0x11,1);
    }
    else if (sVar13 == 7) {
      CreateStartupShip(i,(short)(THING *)local_11a,7,1);
      CreateStartupShip(i,(short)(THING *)local_11a,8,1);
      if (0 < *(int *)&game.mdSize) goto CREATE_LGive2ndPlanet;
    }
    else if ((sVar13 == 6) && (0 < *(int *)&game.mdSize)) {
CREATE_LGive2ndPlanet:
      local_130 = (PLANET *)0x0;
      local_128 = (PLANET *)0x0;
      local_12c = ((POINT *)rgptPlan + (int)(THING *)local_11a)->x;
      local_12a = *(uint *)((int)&rgptPlan[0].y + (int)(THING *)local_11a * 4);
      local_126 = (HullSlotType *)0x0;
      uVar40 = 0;
      uVar39 = 100;
      uVar30 = __aFulmul((long)*(int *)&dGal,0xf);
      uVar30 = __aFldiv(uVar30,CONCAT22(uVar40,uVar39));
      lDistMin2 = uVar30;
      uVar30 = __aFulmul(uVar30,uVar30);
      uVar40 = 0;
      uVar39 = 100;
      lDistMin2 = uVar30;
      uVar30 = __aFulmul((long)*(int *)&dGal,0x17);
      uVar30 = __aFldiv(uVar30,CONCAT22(uVar40,uVar39));
      uVar30 = __aFulmul(uVar30,uVar30);
      uVar40 = 0;
      uVar39 = 100;
      uVar33 = __aFulmul((long)*(int *)&dGal,0x14);
      uVar33 = __aFldiv(uVar33,CONCAT22(uVar40,uVar39));
      __aFulmul(uVar33,uVar33);
      lBest = 10000000;
      pPVar20 = (POINT *)rgptPlan + cPlanMax;
      ppt = (POINT *)rgptPlan;
                    /* WARNING: Load size is inaccurate */
      lppl = (PLANET *)
             CONCAT22(*(undefined2 *)((int)(PLANET **)&lpPlanets + 2),
                      *(PLANET **)&lpPlanets);
      for (; ppt < pPVar20; ppt = ppt + 1) {
        if (((PLANET *)lppl)->iPlayer == -1) {
          dx = ppt->x - local_12c;
          dy = ppt->y - local_12a;
          uVar33 = __aFulmul((long)dy,(long)dy);
          uVar37 = __aFulmul((long)dx,(long)dx);
          local_134 = uVar37 + uVar33;
          if ((local_134 < lDistMin2) || ((long)uVar30 < local_134)) {
            if (((PLANET *)local_130 == (PLANET *)0x0) &&
               ((local_130._2_2_ == 0 && (local_134 < lBest)))) {
              local_128 = (PLANET *)lppl;
              local_126 = (HullSlotType *)CONCAT22(local_126._2_2_,lppl._2_2_);
              lBest = local_134;
            }
          }
          else {
            iVar15 = local_126._2_2_ + 1;
            local_126 = (HullSlotType *)CONCAT22(iVar15,(HullSlotType *)local_126);
            sVar13 = Random(iVar15);
            if (sVar13 == 0) {
              local_130 = lppl;
            }
          }
        }
        lppl = (PLANET *)lppl + 1;
      }
      if (((PLANET *)local_130 == (PLANET *)0x0) && (local_130._2_2_ == 0)) {
        local_130 = (PLANET *)CONCAT22((HullSlotType *)local_126,local_128);
      }
      uVar39 = (undefined2)((ulong)local_130 >> 0x10);
      *(uint *)((int)&((PLANET *)local_130)->lStarbase + 2) =
           *(uint *)((int)&((PLANET *)local_130)->lStarbase + 2) & 0xc3ff | 0x400;
      local_126 = (HullSlotType *)((ulong)local_126 & 0xffff);
      while( true ) {
        sVar13 = PctPlanetDesirability(local_130,i);
        if (9 < sVar13) break;
        iVar15 = local_126._2_2_;
        local_126 = (HullSlotType *)CONCAT22(local_126._2_2_ + 1,(HullSlotType *)local_126);
        if (99 < iVar15) break;
        for (j = 0; j < 3; j = j + 1) {
          sVar13 = Random(0x61);
          cVar11 = (char)sVar13 + '\x02';
          ((PLANET *)local_130)->rgEnvVarOrig[j] = cVar11;
          ((PLANET *)local_130)->rgEnvVar[j] = cVar11;
        }
      }
      if (99 < local_126._2_2_) {
        for (j = 0; j < 3; j = j + 1) {
          ((PLANET *)local_130)->rgEnvVar[j] =
               *(char *)(*(int *)(PLANET **)&lpPlanets + (int)(THING *)local_11a * 0x38 + 0xc
                        + j);
          ((PLANET *)local_130)->rgEnvVarOrig[j] =
               *(char *)(*(int *)(PLANET **)&lpPlanets + (int)(THING *)local_11a * 0x38 + 0xf
                        + j);
        }
      }
      ((PLANET *)local_130)->iPlayer = i;
      ((PLANET *)local_130)->wFlags_0x4 = ((PLANET *)local_130)->wFlags_0x4 & 0xfdff | 0x200;
      *(uint *)&((PLANET *)local_130)->lStarbase =
           *(uint *)&((PLANET *)local_130)->lStarbase & 0xfff0 | 1;
      uVar17 = *(uint *)(((PLANET *)local_130)->rgbImp + 6);
      *(undefined2 *)(((PLANET *)local_130)->rgbImp + 4) =
           *(undefined2 *)(((PLANET *)local_130)->rgbImp + 4);
      *(uint *)(((PLANET *)local_130)->rgbImp + 6) = uVar17 & 0xffbf;
      uVar17 = *(uint *)(((PLANET *)local_130)->rgbImp + 2);
      *(undefined2 *)((PLANET *)local_130)->rgbImp = *(undefined2 *)((PLANET *)local_130)->rgbImp;
      *(uint *)(((PLANET *)local_130)->rgbImp + 2) = uVar17 & 0xf | 0x40;
      uVar17 = *(uint *)(((PLANET *)local_130)->rgbImp + 2);
      *(uint *)((PLANET *)local_130)->rgbImp = *(uint *)((PLANET *)local_130)->rgbImp & 0xff | 0xa00
      ;
      *(uint *)(((PLANET *)local_130)->rgbImp + 2) = uVar17 & 0xfff0;
      uVar40 = 0;
      uVar39 = 5;
      lVar31 = __aFlshl(5,(ushort)lVar41);
      lVar31 = __aFldiv(lVar31,CONCAT22(uVar40,uVar39));
      uVar39 = (undefined2)((ulong)local_130 >> 0x10);
      pPVar27 = (PLANET *)local_130;
      *(int *)(pPVar27->rgwtMin + 3) = (int)lVar31;
      *(undefined2 *)((int)pPVar27->rgwtMin + 0xe) = (int)((ulong)lVar31 >> 0x10);
      pPVar27->uGuesses = pPVar27->uGuesses & 0xf000 | *(uint *)(pPVar27->rgwtMin + 3) / 4 & 0xfff;
      for (j = 0; j < 3; j = j + 1) {
        sVar13 = Random(200);
        *(short *)(((PLANET *)local_130)->rgwtMin + j) = sVar13 + 100;
        *(int *)((int)(((PLANET *)local_130)->rgwtMin + j) + 2) = sVar13 + 100 >> 0xf;
      }
      uVar39 = (undefined2)((ulong)local_130 >> 0x10);
      pPVar27 = (PLANET *)local_130;
      uVar17 = *(uint *)(pPVar27->rgbImp + 6);
      *(uint *)(pPVar27->rgbImp + 4) = *(uint *)(pPVar27->rgbImp + 4) & 0xfff;
      *(uint *)(pPVar27->rgbImp + 6) = uVar17 & 0xfffe;
      uVar40 = 0;
      uVar39 = 5;
      lVar31 = __aFlshl(5,(ushort)lVar41);
      lVar31 = __aFldiv(lVar31,CONCAT22(uVar40,uVar39));
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + (int)(THING *)local_11a * 0x38;
      *(undefined2 *)(iVar15 + hbrBlue) = (int)lVar31;
      *(undefined2 *)(iVar15 + lpfnTutorDlgProc) = (int)((ulong)lVar31 >> 0x10);
      in_stack_0000fec6 =
           *(uint *)(*(int *)(PLANET **)&lpPlanets + (int)(THING *)local_11a * 0x38 + 0x12) &
           0xf000 | *(uint *)(*(int *)(PLANET **)&lpPlanets + (int)(THING *)local_11a * 0x38
                             + 0x28) / 4 & 0xfff;
      *(uint *)(*(int *)(PLANET **)&lpPlanets + (int)(THING *)local_11a * 0x38 + 0x12) =
           in_stack_0000fec6;
      CreateStartupShip(i,local_130->id,0,0);
    }
    else if (sVar13 == 9) {
      if (*(char *)((int)rgplr[0].rgTech + 3 + i * 0xc0) < '\x04') {
        sVar13 = 6;
      }
      else {
        sVar13 = 8;
      }
      CreateStartupShip(i,(short)(THING *)local_11a,sVar13,1);
      CreateStartupShip(i,(short)(THING *)local_11a,7,1);
      CreateStartupShip(i,(short)(THING *)local_11a,0xe,1);
    }
    sVar13 = GetRaceGrbit((PLAYER *)rgplr + i,ibitRaceOBRM);
    if (sVar13 == 0) {
      sVar13 = GetRaceGrbit((PLAYER *)rgplr + i,ibitRaceARM);
      if (sVar13 != 0) {
        sVar13 = CreateStartupShip(i,(short)(THING *)local_11a,0xf,1);
        local_11a = (THING *)CONCAT22(sVar13,(THING *)local_11a);
        CreateStartupShip(i,(short)(THING *)local_11a,sVar13,0);
      }
    }
    for (j = 0; j < *(char *)((int)&rgplr[0].cShDef + i * 0xc0); j = j + 1) {
      local_128 = (PLANET *)(uint)*(byte *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x7a);
      local_126 = (HullSlotType *)
                  CONCAT22(*(undefined2 *)(i * 4 + rglpshdef_0x2),
                           (HullSlotType *)(*(int *)(i * 4 + rglpshdef) + j * 0x93 + 0x3a));
      for (k = 0; k < (int)local_128; k = k + 1) {
        local_12a = 0;
        local_122._0_2_ = *local_126;
        pTVar6 = (THING *)((HullSlotType *)local_126)[1];
        local_122._2_2_ = pTVar6;
        if (local_122._0_2_ == hstEngine) {
          if (((uint)pTVar6 & 0xff) == 1) {
            if (((*(char *)((int)rgplr[0].rgEnvVar + 2 + i * 0xc0) == -1) ||
                (*(int *)(*(int *)(i * 4 + rglpshdef) + j * 0x93) != 0xf)) ||
               ('T' < *(char *)((int)rgplr[0].rgEnvVar + 2 + i * 0xc0))) {
              local_12a = 1;
                    /* WARNING: Ignoring partial resolution of indirect */
              local_134._0_2_ = 10;
            }
            iVar15 = local_12a * 2;
            local_12a = local_12a + 1;
            *(undefined2 *)((int)&local_134 + iVar15) = 5;
            iVar15 = local_12a * 2;
            local_12a = local_12a + 1;
            *(undefined2 *)((int)&local_134 + iVar15) = 4;
            iVar15 = local_12a * 2;
            local_12a = local_12a + 1;
            *(undefined2 *)((int)&local_134 + iVar15) = 2;
            uVar17 = local_12a;
            local_12a = local_12a + 1;
            *(undefined2 *)((int)&local_134 + uVar17 * 2) = 3;
          }
        }
        else if (local_122._0_2_ == hstScanner) {
          if ((((uint)pTVar6 & 0xff) == 0) || (((uint)pTVar6 & 0xff) == 1)) {
                    /* WARNING: Ignoring partial resolution of indirect */
            local_134._0_2_ = 4;
                    /* WARNING: Ignoring partial resolution of indirect */
            local_134._2_2_ = 2;
            local_12a = 3;
                    /* WARNING: Ignoring partial resolution of indirect */
            local_130._0_2_ = (PLANET *)0x1;
          }
        }
        else if (local_122._0_2_ == hstShield) {
          if ((((uint)pTVar6 & 0xff) == 0) || (((uint)pTVar6 & 0xff) == 1)) {
                    /* WARNING: Ignoring partial resolution of indirect */
            local_134._0_2_ = 2;
            local_12a = 2;
                    /* WARNING: Ignoring partial resolution of indirect */
            local_134._2_2_ = 1;
          }
        }
        else if (local_122._0_2_ == hstArmor) {
          if ((((uint)pTVar6 & 0xff) == 0) || (((uint)pTVar6 & 0xff) == 1)) {
                    /* WARNING: Ignoring partial resolution of indirect */
            local_134._0_2_ = 2;
            local_12a = 2;
                    /* WARNING: Ignoring partial resolution of indirect */
            local_134._2_2_ = 1;
          }
        }
        else if (local_122._0_2_ == hstBeam) {
          if ((((uint)pTVar6 & 0xff) == 0) || (((uint)pTVar6 & 0xff) == 1)) {
                    /* WARNING: Ignoring partial resolution of indirect */
            local_134._0_2_ = 3;
            local_12a = 2;
                    /* WARNING: Ignoring partial resolution of indirect */
            local_134._2_2_ = 1;
          }
        }
        else if (local_122._0_2_ == hstTorp) {
          bVar29 = ((uint)pTVar6 & 0xff) == 0;
          if (bVar29) {
            local_12a = 1;
                    /* WARNING: Ignoring partial resolution of indirect */
            local_134._0_2_ = 1;
          }
          local_12a = (uint)bVar29;
        }
        else if (local_122._0_2_ == hstBomb) {
          bVar29 = ((uint)pTVar6 & 0xff) == 0;
          if (bVar29) {
            local_12a = 1;
                    /* WARNING: Ignoring partial resolution of indirect */
            local_134._0_2_ = 1;
          }
          local_12a = (uint)bVar29;
        }
        else if ((local_122._0_2_ == hstMining) &&
                ((((uint)pTVar6 & 0xff) == 0 || (((uint)pTVar6 & 0xff) == 1)))) {
                    /* WARNING: Ignoring partial resolution of indirect */
          local_134._0_2_ = 2;
          local_12a = 2;
                    /* WARNING: Ignoring partial resolution of indirect */
          local_134._2_2_ = 0;
        }
        for (l = 0; l < (int)local_12a; l = l + 1) {
          local_122._2_2_ =
               (THING *)(local_122._2_2_ & 0xff00 | *(uint *)((int)&local_134 + l * 2) & 0xff);
          sVar13 = FLookupPart(local_122);
          if (sVar13 == 1) {
            uVar39 = (undefined2)((ulong)local_126 >> 0x10);
            ((HullSlotType *)local_126)[1] =
                 ((HullSlotType *)local_126)[1] &
                 (hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|
                 hstMines) |
                 *(HullSlotType *)((int)&local_134 + l * 2) &
                 (hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine);
            break;
          }
        }
        local_126 = (HullSlotType *)local_126 + 2;
      }
    }
    sVar13 = GetRaceStat((PLAYER *)rgplr + i,rsMajorAdv);
    if (sVar13 == 8) {
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + (int)(THING *)local_11a * 0x38;
      uVar30 = CONCAT22(*(undefined2 *)(iVar15 + 0x1a),*(undefined2 *)(iVar15 + 0x18)) & 0xfffe0fff;
      local_126._0_2_ = (HullSlotType *)((uint)uVar30 | 0xf000);
      uVar17 = (uint)(HullSlotType *)local_126;
      local_126 = (HullSlotType *)(uVar30 | 0x1f000);
      uVar39 = *(undefined2 *)((int)(PLANET **)&lpPlanets + 2);
      iVar15 = *(int *)(PLANET **)&lpPlanets + (int)(THING *)local_11a * 0x38;
      *(uint *)(iVar15 + 0x18) = uVar17;
      *(undefined2 *)(iVar15 + 0x1a) = local_126._2_2_;
    }
    i = i + 1;
  } while( true );
LAB_1078_157c:
  lVar34 = __aFldiv(uVar30,0x23);
  lDistMin2 = lDistMin2 - lVar34;
  lVar34 = __aFldiv(uVar30,0x23);
  lVar31 = lVar31 + lVar34;
  goto CREATE_RetryAll;
}



// ======================================================================
// Function: CreateStartupShip
// Address: 1078:4690
// Segment: MEMORY_CREATE
// ======================================================================


short CreateStartupShip(short iplr,short idPlanet,short ishdef,short fAddShdef)

{
  char *pcVar1;
  uint *puVar2;
  int *piVar3;
  HullDef *pHVar4;
  char cVar5;
  FLEET *pFVar6;
  uint uVar7;
  undefined2 uVar8;
  undefined2 uVar9;
  int iVar10;
  SHDEF *pSVar11;
  HullDef *pHVar12;
  SHDEF *pSVar13;
  FLEET *lpfl_00;
  long lVar14;
  FLEET *lpfl;
  short ishMac;
  
  if (fAddShdef != 0) {
    cVar5 = *(char *)((int)&rgplr[0].cShDef + iplr * 0xc0);
    pcVar1 = (char *)((int)&rgplr[0].cShDef + iplr * 0xc0);
    *pcVar1 = *pcVar1 + '\x01';
    uVar7 = (uint)cVar5;
    pSVar13 = LpshdefT();
    uVar8 = (undefined2)((ulong)pSVar13 >> 0x10);
    pSVar11 = (SHDEF *)pSVar13 + ishdef;
    uVar9 = *(undefined2 *)(iplr * 4 + rglpshdef_0x2);
    pHVar12 = (HullDef *)(*(int *)(iplr * 4 + rglpshdef) + uVar7 * 0x93);
    for (iVar10 = 0x49; iVar10 != 0; iVar10 = iVar10 + -1) {
      pHVar4 = pHVar12;
      pHVar12 = pHVar12 + 1;
      pSVar13 = pSVar11;
      pSVar11 = (pSVar11->hul).rgTech;
      *pHVar4 = (pSVar13->hul).ihuldef;
    }
    *(char *)pHVar12 = (char)(pSVar11->hul).ihuldef;
    *(uint *)(*(int *)(iplr * 4 + rglpshdef) + uVar7 * 0x93 + 0x7b) =
         *(uint *)(*(int *)(iplr * 4 + rglpshdef) + uVar7 * 0x93 + 0x7b) & 0x83ff |
         (uVar7 & 0x1f) << 10;
    ishdef = uVar7;
  }
  uVar9 = *(undefined2 *)(iplr * 4 + rglpshdef_0x2);
  iVar10 = *(int *)(iplr * 4 + rglpshdef) + ishdef * 0x93;
  puVar2 = (uint *)(iVar10 + 0x83);
  uVar7 = *puVar2;
  *puVar2 = *puVar2 + 1;
  piVar3 = (int *)(iVar10 + 0x85);
  *piVar3 = *piVar3 + (uint)(0xfffe < uVar7);
  uVar9 = *(undefined2 *)(iplr * 4 + rglpshdef_0x2);
  iVar10 = *(int *)(iplr * 4 + rglpshdef) + ishdef * 0x93;
  puVar2 = (uint *)(iVar10 + 0x7f);
  uVar7 = *puVar2;
  *puVar2 = *puVar2 + 1;
  piVar3 = (int *)(iVar10 + 0x81);
  *piVar3 = *piVar3 + (uint)(0xfffe < uVar7);
  lpfl_00 = LpflNew(iplr,idPlanet);
  uVar9 = (undefined2)((ulong)lpfl_00 >> 0x10);
  pFVar6 = (FLEET *)lpfl_00;
  pFVar6->rgcsh[ishdef] = 1;
  lVar14 = LGetFleetStat(lpfl_00,grStatFuel);
  *(int *)(pFVar6->rgwtMin + 4) = (int)lVar14;
  *(undefined2 *)((int)pFVar6->rgwtMin + 0x12) = (int)((ulong)lVar14 >> 0x10);
  pFVar6->iplan = 0;
  return ishdef;
}



// ======================================================================
// Function: GenNewGameFromFile
// Address: 1078:4812
// Segment: MEMORY_CREATE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10785712) */
/* WARNING: Removing unreachable block (ram,0x10785512) */
/* WARNING: Removing unreachable block (ram,0x10785311) */
/* WARNING: Removing unreachable block (ram,0x107851bf) */
/* WARNING: Removing unreachable block (ram,0x10785412) */
/* WARNING: Removing unreachable block (ram,0x10785612) */
/* WARNING: Removing unreachable block (ram,0x10785812) */
/* WARNING: Removing unreachable block (ram,0x10785085) */
/* WARNING: Removing unreachable block (ram,0x10784ba6) */
/* WARNING: Removing unreachable block (ram,0x10784a69) */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short GenNewGameFromFile(char *pszFile)

{
  undefined2 *puVar1;
  PLAYER *pPVar2;
  PLAYER *pPVar3;
  char cVar4;
  uint uVar5;
  uint uVar6;
  short sVar7;
  ushort uVar8;
  char *pcVar9;
  short sVar10;
  int iVar11;
  undefined2 uVar12;
  PLAYER *pPVar13;
  undefined2 *puVar14;
  PLAYER *pPVar15;
  long lVar16;
  char *pcVar17;
  PLAYER *pPVar18;
  short lvlAi;
  int local_7a;
  short cb;
  char *lpbDef;
  char *lpb;
  short j;
  short env [9];
  char *lpbStart;
  short fSuccess;
  short i;
  short c;
  short cNum;
  short rgplrbmp [16];
  short cPlr;
  long rgl [10];
  
  fSuccess = 0;
  _strcpy((char *)szWork,pszFile);
  penvMem = &env;
  sVar7 = __setjmp(env);
  if (sVar7 != 0) goto CREATE_LError_3;
  if ((int)ini.wFlags < 0) {
    _strcpy((char *)szBase,pszFile);
    pcVar9 = _strrchr((char *)szBase,0x2e);
    *pcVar9 = '\0';
    TurnLog(idsGeneratingYearD);
  }
  _memset((GAME *)&game,0,0x40);
  StreamOpen(pszFile,0x20);
  lVar16 = __filelength(hf);
  uVar8 = (ushort)lVar16;
  if (15999 < (int)uVar8) {
    FileError(idsUniverseCreationFileAppearsInvalid);
    goto CREATE_LError_3;
  }
  pcVar17 = LpAlloc(uVar8 + 1,htPerm);
  uVar12 = (undefined2)((ulong)pcVar17 >> 0x10);
  lpbDefMac._0_2_ = (char *)pcVar17 + uVar8;
  lpbDefMac._2_2_ = uVar12;
  RgFromStream(pcVar17,uVar8);
  StreamClose();
  ((char *)pcVar17)[uVar8] = '\0';
  lpb = pcVar17;
  pcVar17 = PszGetLine(&lpb);
  if ((*pcVar17 == '\0') || (uVar8 = __fstrlen(pcVar17), 0x1f < uVar8)) {
    sVar7 = 0x10;
    pcVar9 = PszFormatIds(idsIllegalGameTitle,(short *)0x0);
    AlertSz(pcVar9,sVar7);
    goto CREATE_LError_3;
  }
  __fstrcpy(game.szName,pcVar17);
  if ((char *)lpb < (char *)lpbDefMac) {
    pcVar17 = PszGetLine(&lpb);
    sVar7 = CParseNumbers(pcVar17,rgl,4);
    if (sVar7 == -1) {
CREATE_LUniDefError:
      sVar7 = 0x10;
      pcVar9 = PszFormatIds(idsLine2HasBadUniverseDefinitionParameter,(short *)0x0);
      AlertSz(pcVar9,sVar7);
      goto CREATE_LError_3;
    }
    for (i = 0; i < sVar7; i = i + 1) {
      if (i < 3) {
        if (*(int *)((int)rgl + i * 4 + 2) < 0) goto CREATE_LUniDefError;
        iVar11 = *(int *)((int)rgl + i * 4 + 2);
        if (((0 < iVar11) || ((-1 < iVar11 && (4 < *(uint *)(rgl + i))))) ||
           (((int)rgl[i] == 4 && ((*(int *)((int)rgl + i * 4 + 2) == 0 && (i != 0))))))
        goto CREATE_LUniDefError;
      }
    }
    if (0 < sVar7) {
      game.mdSize = (uint)rgl[0];
    }
    if (1 < sVar7) {
      game.mdDensity = (short)(char *)rgl[1];
    }
    if (2 < sVar7) {
      game.mdStartDist = (uint)rgl[2];
    }
    if (3 < sVar7) {
      Randomize(CONCAT22(rgl[3]._2_2_,(uint)rgl[3]));
    }
    if ((char *)lpb < (char *)lpbDefMac) {
      pcVar17 = PszGetLine(&lpb);
      sVar7 = CParseNumbers(pcVar17,rgl,7);
      if (sVar7 == -1) {
CREATE_LUniDefError3:
        sVar7 = 0x10;
        pcVar9 = PszFormatIds(idsLine3HasBadUniverseDefinitionParameter,(short *)0x0);
        AlertSz(pcVar9,sVar7);
        goto CREATE_LError_3;
      }
      for (i = 0; i < sVar7; i = i + 1) {
        if (*(int *)((int)rgl + i * 4 + 2) < 0) goto CREATE_LUniDefError3;
        iVar11 = *(int *)((int)rgl + i * 4 + 2);
        if ((-1 < iVar11) && ((0 < iVar11 || (1 < *(uint *)(rgl + i))))) goto CREATE_LUniDefError3;
      }
      if (0 < sVar7) {
        game.wCrap = game.wCrap & 0xfffe | (uint)rgl[0] & 1;
      }
      if (1 < sVar7) {
        game.wCrap = game.wCrap & 0xfffd | ((uint)(char *)rgl[1] & 1) << 1;
      }
      if (2 < sVar7) {
        game.wCrap = game.wCrap & 0xffdf | ((uint)rgl[2] & 1) << 5;
      }
      if (3 < sVar7) {
        game.wCrap = game.wCrap & 0xff7f | ((uint)rgl[3] & 1) << 7;
      }
      if (4 < sVar7) {
        game.wCrap = game.wCrap & 0xffef | ((uint)rgl[4] & 1) << 4;
      }
      if (5 < sVar7) {
        game.wCrap = game.wCrap & 0xffbf | ((uint)rgl[5] & 1) << 6;
      }
      if (6 < sVar7) {
        game.wCrap = game.wCrap & 0xfeff | ((uint)rgl[6] & 1) << 8;
      }
      pcVar17 = PszGetLine(&lpb);
      sVar7 = CParseNumbers(pcVar17,rgl,1);
      uVar5 = (uint)rgl[0];
      if ((((sVar7 < 1) || (rgl[0]._2_2_ < 0)) || ((rgl[0]._2_2_ < 1 && ((uint)rgl[0] == 0)))) ||
         ((-1 < rgl[0]._2_2_ && ((0 < rgl[0]._2_2_ || (0x10 < (uint)rgl[0])))))) {
        sVar7 = 0x10;
        pcVar9 = PszFormatIds(idsLine4HasImproperNumberPlayerFiles,(short *)0x0);
        AlertSz(pcVar9,sVar7);
        goto CREATE_LError_3;
      }
      if ((char *)lpb < (char *)lpbDefMac) {
        game.cPlayer = (uint)rgl[0];
        for (i = 0; i < (int)uVar5; i = i + 1) {
          pcVar17 = PszGetLine(&lpb);
          if ((char *)lpbDefMac <= (char *)lpb) goto CREATE_LUniDefShort;
          lpbStart._0_2_ = (char *)pcVar17;
          lpbStart._2_2_ = (undefined2)((ulong)pcVar17 >> 0x10);
          if ((i < 1) || (*pcVar17 != '#')) {
            __fstrcpy(szWork,pcVar17);
            sVar7 = FWasRaceFile((char *)szWork,0);
            if (sVar7 == 0) goto CREATE_LCantGetRace;
            pPVar15 = (PLAYER *)rgplr + i;
            pPVar13 = (PLAYER *)&vplr;
            for (iVar11 = 0x60; iVar11 != 0; iVar11 = iVar11 + -1) {
              pPVar3 = pPVar15;
              pPVar15 = &pPVar15->cPlanet;
              pPVar18 = pPVar13;
              pPVar13 = &pPVar13->cPlanet;
              cVar4 = pPVar18->cShDef;
              pPVar3->iPlayer = pPVar18->iPlayer;
              pPVar3->cShDef = cVar4;
            }
          }
          else {
            sVar7 = CParseNumbers
                              ((char *)CONCAT22(lpbStart._2_2_,(char *)lpbStart + 1),rgl,2);
            uVar6 = (uint)rgl[0];
            if ((((sVar7 < 2) || ((int)(uint)rgl[0] < 0)) || (6 < (int)(uint)rgl[0])) ||
               (((int)(char *)rgl[1] < 0 || (4 < (int)(char *)rgl[1])))) {
              __fstrcpy(szWork,pcVar17);
CREATE_LCantGetRace:
              iVar11 = i + 5;
              pcVar9 = PszGetCompressedString(idsLineDUnableLoadRaceFileS);
              _wsprintf(szWork,pcVar9,iVar11,(char *)lpbStart,lpbStart._2_2_);
              AlertSz((char *)szWork,0x10);
              goto CREATE_LError_3;
            }
            if ((char *)rgl[1] == (char *)0x0) {
              lvlAi = Random(4);
            }
            else {
              lvlAi = (short)((char *)rgl[1] + -1);
            }
            if (uVar6 == 0) {
              local_7a = Random(6);
            }
            else {
              local_7a = uVar6 - 1;
            }
            pPVar18 = LpplrComp(local_7a,lvlAi);
            pPVar13 = (PLAYER *)pPVar18;
            pPVar15 = (PLAYER *)rgplr + i;
            for (iVar11 = 0x60; iVar11 != 0; iVar11 = iVar11 + -1) {
              pPVar2 = pPVar15;
              pPVar15 = &pPVar15->cPlanet;
              pPVar3 = pPVar13;
              pPVar13 = &pPVar13->cPlanet;
              cVar4 = pPVar3->cShDef;
              pPVar2->iPlayer = pPVar3->iPlayer;
              pPVar2->cShDef = cVar4;
            }
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfdff | 0x200;
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0x1fff | local_7a << 0xd;
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xe3ff | (lvlAi & 7U) << 10
            ;
          }
        }
        pcVar17 = PszGetLine(&lpb);
        sVar7 = CParseNumbers(pcVar17,rgl,2);
        if ((char *)lpb < (char *)lpbDefMac) {
          i = 0;
          if (((0 < sVar7) && (-1 < rgl[0]._2_2_)) &&
             ((rgl[0]._2_2_ < 0 || ((rgl[0]._2_2_ < 1 && ((uint)rgl[0] < 2)))))) {
            if (((uint)rgl[0] == 1) && (rgl[0]._2_2_ == 0)) {
              if ((((sVar7 < 2) || (rgl[1]._2_2_ < 0)) ||
                  ((rgl[1]._2_2_ < 1 && ((char *)rgl[1] < hbrButtonHilite)))) ||
                 ((-1 < rgl[1]._2_2_ &&
                  ((0 < rgl[1]._2_2_ ||
                   ((char *)((int)(ulong *)rgcrPlrHistory + 0x36) < (char *)rgl[1]))))))
              goto CREATE_LBadDefVc;
              SetVCCheck((GAME *)&game,0,1);
              SetVCVal((GAME *)&game,0,(int)((char *)rgl[1] + -0x14) / 5);
            }
            pcVar17 = PszGetLine(&lpb);
            sVar7 = CParseNumbers(pcVar17,rgl,3);
            if ((char *)lpbDefMac <= (char *)lpb) goto CREATE_LUniDefShort;
            i = 1;
            if (((0 < sVar7) && (-1 < rgl[0]._2_2_)) &&
               ((rgl[0]._2_2_ < 0 || ((rgl[0]._2_2_ < 1 && ((uint)rgl[0] < 2)))))) {
              if (((uint)rgl[0] == 1) && (rgl[0]._2_2_ == 0)) {
                if (((sVar7 < 3) || (rgl[1]._2_2_ < 0)) ||
                   ((((rgl[1]._2_2_ < 1 && ((char *)rgl[1] < (char *)0x8)) || (0 < rgl[1]._2_2_)) ||
                    ((((-1 < rgl[1]._2_2_ && (hbrWindowText < (char *)rgl[1])) ||
                      (rgl[2]._2_2_ < 0)) ||
                     (((rgl[2]._2_2_ < 1 && ((uint)rgl[2] < 2)) ||
                      ((-1 < rgl[2]._2_2_ && ((0 < rgl[2]._2_2_ || (6 < (uint)rgl[2]))))))))))))
                goto CREATE_LBadDefVc;
                SetVCCheck((GAME *)&game,1,1);
                SetVCCheck((GAME *)&game,2,1);
                SetVCVal((GAME *)&game,1,(short)((char *)rgl[1] + -8));
                SetVCVal((GAME *)&game,2,(uint)rgl[2] - 2);
              }
              pcVar17 = PszGetLine(&lpb);
              sVar7 = CParseNumbers(pcVar17,rgl,2);
              if ((char *)lpbDefMac <= (char *)lpb) goto CREATE_LUniDefShort;
              i = 2;
              if (((0 < sVar7) && (-1 < rgl[0]._2_2_)) &&
                 ((rgl[0]._2_2_ < 0 || ((rgl[0]._2_2_ < 1 && ((uint)rgl[0] < 2)))))) {
                if (((uint)rgl[0] == 1) && (rgl[0]._2_2_ == 0)) {
                  if ((((sVar7 < 2) || (rgl[1]._2_2_ < 0)) ||
                      ((rgl[1]._2_2_ < 1 && ((char *)rgl[1] < (char *)0x3e8)))) ||
                     ((-1 < rgl[1]._2_2_ &&
                      ((0 < rgl[1]._2_2_ || ((char *)rgbCur + 0x289 <= (char *)rgl[1])))))
                     ) goto CREATE_LBadDefVc;
                  SetVCCheck((GAME *)&game,3,1);
                  SetVCVal((GAME *)&game,3,(int)((char *)rgl[1] + -1000) / 1000);
                }
                pcVar17 = PszGetLine(&lpb);
                sVar7 = CParseNumbers(pcVar17,rgl,2);
                if ((char *)lpbDefMac <= (char *)lpb) goto CREATE_LUniDefShort;
                i = 3;
                if (((0 < sVar7) && (-1 < rgl[0]._2_2_)) &&
                   ((rgl[0]._2_2_ < 0 || ((rgl[0]._2_2_ < 1 && ((uint)rgl[0] < 2)))))) {
                  if (((uint)rgl[0] == 1) && (rgl[0]._2_2_ == 0)) {
                    if ((((sVar7 < 2) || (rgl[1]._2_2_ < 0)) ||
                        ((rgl[1]._2_2_ < 1 && ((char *)rgl[1] < hbrButtonHilite)))) ||
                       ((-1 < rgl[1]._2_2_ &&
                        ((0 < rgl[1]._2_2_ ||
                         ((char *)((int)(SHDEF **)rglpshdef + 0x2e) < (char *)rgl[1]))))))
                    goto CREATE_LBadDefVc;
                    SetVCCheck((GAME *)&game,4,1);
                    SetVCVal((GAME *)&game,4,(int)((char *)rgl[1] + -0x14) / 10);
                  }
                  pcVar17 = PszGetLine(&lpb);
                  sVar7 = CParseNumbers(pcVar17,rgl,2);
                  if ((char *)lpbDefMac <= (char *)lpb) goto CREATE_LUniDefShort;
                  i = 4;
                  if (((0 < sVar7) && (-1 < rgl[0]._2_2_)) &&
                     ((rgl[0]._2_2_ < 0 || ((rgl[0]._2_2_ < 1 && ((uint)rgl[0] < 2)))))) {
                    if (((uint)rgl[0] == 1) && (rgl[0]._2_2_ == 0)) {
                      if ((((sVar7 < 2) || (rgl[1]._2_2_ < 0)) ||
                          ((rgl[1]._2_2_ < 1 && ((char *)rgl[1] < (char *)0xa)))) ||
                         ((-1 < rgl[1]._2_2_ &&
                          ((0 < rgl[1]._2_2_ || ((char *)szMine + 8 < (char *)rgl[1]))))))
                      goto CREATE_LBadDefVc;
                      SetVCCheck((GAME *)&game,5,1);
                      SetVCVal((GAME *)&game,5,(int)((char *)rgl[1] + -10) / 10);
                    }
                    pcVar17 = PszGetLine(&lpb);
                    sVar7 = CParseNumbers(pcVar17,rgl,2);
                    if ((char *)lpbDefMac <= (char *)lpb) goto CREATE_LUniDefShort;
                    i = 5;
                    if (((0 < sVar7) && (-1 < rgl[0]._2_2_)) &&
                       ((rgl[0]._2_2_ < 0 || ((rgl[0]._2_2_ < 1 && ((uint)rgl[0] < 2)))))) {
                      if (((uint)rgl[0] == 1) && (rgl[0]._2_2_ == 0)) {
                        if ((((sVar7 < 2) || (rgl[1]._2_2_ < 0)) ||
                            ((rgl[1]._2_2_ < 1 && ((char *)rgl[1] < (char *)0xa)))) ||
                           ((-1 < rgl[1]._2_2_ &&
                            ((0 < rgl[1]._2_2_ ||
                             ((char *)((int)(SHDEF **)rglpshdef + 0x2e) < (char *)rgl[1])))))
                           ) goto CREATE_LBadDefVc;
                        SetVCCheck((GAME *)&game,6,1);
                        SetVCVal((GAME *)&game,6,(int)((char *)rgl[1] + -10) / 10);
                      }
                      pcVar17 = PszGetLine(&lpb);
                      sVar7 = CParseNumbers(pcVar17,rgl,2);
                      if ((char *)lpbDefMac <= (char *)lpb) goto CREATE_LUniDefShort;
                      i = 6;
                      if (((0 < sVar7) && (-1 < rgl[0]._2_2_)) &&
                         ((rgl[0]._2_2_ < 0 || ((rgl[0]._2_2_ < 1 && ((uint)rgl[0] < 2)))))) {
                        if (((uint)rgl[0] == 1) && (rgl[0]._2_2_ == 0)) {
                          if ((((sVar7 < 2) || (rgl[1]._2_2_ < 0)) ||
                              ((rgl[1]._2_2_ < 1 && ((char *)rgl[1] < hbrDesktop)))) ||
                             ((-1 < rgl[1]._2_2_ &&
                              ((0 < rgl[1]._2_2_ ||
                               ((char *)s_Stars______s_____s_____s_1120_0373 + 0x11 < (char *)rgl[1]
                               )))))) goto CREATE_LBadDefVc;
                          SetVCCheck((GAME *)&game,7,1);
                          SetVCVal((GAME *)&game,7,(int)((char *)rgl[1] + -0x1e) / 10);
                        }
                        pcVar17 = PszGetLine(&lpb);
                        sVar7 = CParseNumbers(pcVar17,rgl,2);
                        if ((char *)lpbDefMac <= (char *)lpb) goto CREATE_LUniDefShort;
                        i = 7;
                        if (((0 < sVar7) && (-1 < rgl[0]._2_2_)) &&
                           ((rgl[0]._2_2_ < 0 || ((rgl[0]._2_2_ < 1 && ((uint)rgl[0] < 8)))))) {
                          if ((-1 < rgl[0]._2_2_) && ((0 < rgl[0]._2_2_ || ((uint)rgl[0] != 0)))) {
                            if ((((sVar7 < 2) || (rgl[1]._2_2_ < 0)) ||
                                ((rgl[1]._2_2_ < 1 && ((char *)rgl[1] < hbrDesktop)))) ||
                               ((-1 < rgl[1]._2_2_ &&
                                ((0 < rgl[1]._2_2_ || ((char *)szMine + 8 < (char *)rgl[1])))
                                ))) goto CREATE_LBadDefVc;
                            SetVCVal((GAME *)&game,8,(uint)rgl[0]);
                            SetVCVal((GAME *)&game,9,(int)((char *)rgl[1] + -0x1e) / 10);
                          }
                          pcVar17 = PszGetLine(&lpb);
                          uVar12 = (undefined2)((ulong)pcVar17 >> 0x10);
                          pcVar9 = (char *)pcVar17;
                          uVar8 = __fstrlen(pcVar17);
                          lpb = (char *)CONCAT22(uVar12,pcVar9 + (uVar8 - 1));
                          if ((((2 < (int)(pcVar9 + (uVar8 - 1)) - (int)pcVar9) && (*lpb == 'y')) &&
                              (pcVar9[uVar8 - 2] == 'x')) && (pcVar9[uVar8 - 3] == '.')) {
                            pcVar9[uVar8 - 3] = '\0';
                          }
                          __fstrcpy(szBase,pcVar17);
                          if ((char *)lpb + 4 < (char *)lpbDefMac) {
                            lpbDefUni._0_2_ = (char *)lpb;
                            lpbDefUni._2_2_ = lpb._2_2_;
                          }
                          for (i = 0; i < game.cPlayer; i = i + 1) {
                            if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) ==
                                 0) && (sVar7 = CAdvantagePoints
                                                          ((PLAYER *)rgplr + i), sVar7 < 0
                                       )) {
                              pPVar13 = (PLAYER *)rgplr + i;
                              puVar14 = (undefined2 *)&vrgplrDef;
                              for (iVar11 = 0x60; iVar11 != 0; iVar11 = iVar11 + -1) {
                                pPVar18 = pPVar13;
                                pPVar13 = &pPVar13->cPlanet;
                                puVar1 = puVar14;
                                puVar14 = puVar14 + 1;
                                uVar12 = *puVar1;
                                pPVar18->iPlayer = (char)uVar12;
                                pPVar18->cShDef = (char)((uint)uVar12 >> 8);
                              }
                              *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
                                   *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xffef |
                                   0x10;
                            }
                            if (*(char *)((int)rgplr[0].szName + i * 0xc0) == '\0') {
                              pcVar9 = (char *)((int)rgplr[0].szName + i * 0xc0);
                              sVar7 = Random(0x18);
                              CchGetString(sVar7 + idsBerserker,pcVar9);
                              _wsprintf((char *)((int)rgplr[0].szNames + i * 0xc0),
                                        (char *)0x11200a2e,i * 0xc0 + 0x5a22,0x1120);
                            }
                          }
                          for (i = 1; i < game.cPlayer; i = i + 1) {
                            j = 0;
                            while ((j < i && (sVar7 = _strcmp((char *)((int)rgplr
                                                                                    [0].szName +
                                                                              i * 0xc0),
                                                                      (char *)((int)rgplr
                                                                                    [0].szName +
                                                                              j * 0xc0)), sVar7 != 0
                                             ))) {
                              j = j + 1;
                            }
                            if (j < i) {
                              c = Random(0x18);
LAB_1078_5b09:
                              for (j = 0; j < game.cPlayer; j = j + 1) {
                                pcVar9 = PszGetCompressedString(c + idsBerserker);
                                sVar7 = _strcmp((char *)((int)rgplr[0].szName +
                                                                j * 0xc0),pcVar9);
                                if (sVar7 == 0) break;
                              }
                              if (j != game.cPlayer) {
                                c = c + 1;
                                if (0x17 < c) {
                                  c = 0;
                                }
                                goto LAB_1078_5b09;
                              }
                              CchGetString
                                        (c + idsBerserker,
                                         (char *)((int)rgplr[0].szName + i * 0xc0));
                              _strcpy((char *)((int)rgplr[0].szNames + i * 0xc0),
                                              (char *)((int)rgplr[0].szName + i * 0xc0));
                              _strcat((char *)((int)rgplr[0].szNames + i * 0xc0),
                                              (char *)0xa32);
                            }
                          }
                          for (i = 0; i < game.cPlayer; i = i + 1) {
                            rgplrbmp[i] = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 3
                                          & 0x1f;
                            if ((rgplrbmp[i] < 0) || (0x1f < rgplrbmp[i])) {
                              rgplrbmp[i] = -1;
                            }
                          }
                          for (i = 1; i < game.cPlayer; i = i + 1) {
                            if (rgplrbmp[i] != -1) {
                              for (j = 0; (j < i && (rgplrbmp[j] != rgplrbmp[i])); j = j + 1) {
                              }
                              if (j < i) {
                                sVar10 = Random(2);
                                sVar7 = i;
                                if (sVar10 == 0) {
                                  sVar7 = j;
                                }
                                rgplrbmp[sVar7] = -1;
                              }
                            }
                          }
                          for (i = 0; i < game.cPlayer; i = i + 1) {
                            if (rgplrbmp[i] == -1) {
                              sVar7 = Random(0x20);
                              rgplrbmp[i] = sVar7;
                              while( true ) {
                                for (j = 0; (j < game.cPlayer &&
                                            ((j == i || (rgplrbmp[i] != rgplrbmp[j])))); j = j + 1)
                                {
                                }
                                if (j == game.cPlayer) break;
                                rgplrbmp[i] = rgplrbmp[i] + 1;
                                if (0x1f < rgplrbmp[i]) {
                                  rgplrbmp[i] = 0;
                                }
                              }
                            }
                          }
                          for (i = 0; i < game.cPlayer; i = i + 1) {
                            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xff07 |
                                 (rgplrbmp[i] & 0x1fU) << 3;
                          }
                          GenerateWorld(1);
                          fSuccess = 1;
                          goto CREATE_LError_3;
                        }
                      }
                    }
                  }
                }
              }
            }
          }
CREATE_LBadDefVc:
          iVar11 = i + uVar5 + 5;
          pcVar9 = PszGetCompressedString(idsLineDHasImproperVictoryConditionDefinition);
          _wsprintf(szWork,pcVar9,iVar11);
          AlertSz((char *)szWork,0x10);
          goto CREATE_LError_3;
        }
      }
    }
  }
CREATE_LUniDefShort:
  sVar7 = 0x10;
  pcVar9 = PszFormatIds(idsUniverseDefinitionFileAppearsTooShort,(short *)0x0);
  AlertSz(pcVar9,sVar7);
CREATE_LError_3:
  penvMem = (short (*) [9])0x0;
  StreamClose();
  lpbDefUni._0_2_ = (char *)0x0;
  lpbDefUni._2_2_ = 0;
  TurnLog(fSuccess + idsFailed);
  return fSuccess;
}



// ======================================================================
// Function: CreateTutorWorld
// Address: 1078:5e5e
// Segment: MEMORY_CREATE
// ======================================================================


void CreateTutorWorld(void)

{
  undefined2 *puVar1;
  PLAYER *pPVar2;
  undefined2 uVar3;
  PLAYER *pPVar4;
  char cVar5;
  char *pcVar6;
  int iVar7;
  undefined2 *puVar8;
  PLAYER *pPVar9;
  PLAYER *pPVar10;
  PLAYER *pPVar11;
  char *pcVar12;
  undefined4 uVar13;
  short i;
  
  _memset((GAME *)&game,0,0x40);
  game.cPlayer = 2;
  game.mdDensity = 0;
  game.mdSize = 0;
  game.mdStartDist = 1;
  game.wCrap = game.wCrap & 0xff17 | 0xe8;
  game.lid._0_2_ = 0xef49;
  game.lid._2_2_ = 0x8c;
  game.rgvc[7] = 0x80;
  game.rgvc[8] = 0x81;
  CchGetString(idsTutorialGame,(char *)game.szName);
  puVar8 = (undefined2 *)&vrgplrDef;
  pPVar9 = (PLAYER *)rgplr;
  for (iVar7 = 0x60; iVar7 != 0; iVar7 = iVar7 + -1) {
    pPVar11 = pPVar9;
    pPVar9 = &pPVar9->cPlanet;
    puVar1 = puVar8;
    puVar8 = puVar8 + 1;
    uVar3 = *puVar1;
    pPVar11->iPlayer = (char)uVar3;
    pPVar11->cShDef = (char)((uint)uVar3 >> 8);
  }
  CchGetString(idsHumanoid,(char *)rgplr[0].szName);
  _wsprintf(rgplr[0].szNames,(char *)0x11200a34,0x5a22);
  pPVar11 = LpplrComp(1,0);
  pPVar9 = (PLAYER *)pPVar11;
  pPVar10 = (PLAYER *)(rgplr + 1);
  for (iVar7 = 0x60; iVar7 != 0; iVar7 = iVar7 + -1) {
    pPVar4 = pPVar10;
    pPVar10 = &pPVar10->cPlanet;
    pPVar2 = pPVar9;
    pPVar9 = &pPVar9->cPlanet;
    cVar5 = pPVar2->cShDef;
    pPVar4->iPlayer = pPVar2->iPlayer;
    pPVar4->cShDef = cVar5;
  }
  rgplr[1].wMdPlr = rgplr[1].wMdPlr & 0x1ff | 0x2200;
  CchGetString(idsBerserker,(char *)rgplr[1].szName);
  Randomize(0x499602d2);
  for (i = 1; i < 3; i = i + 1) {
    uVar13 = CONCAT22(i,0x1120);
    pcVar12 = (char *)szBase;
    pcVar6 = PszGetCompressedString(idsSHD);
    _wsprintf(szWork,pcVar6,pcVar12,uVar13);
    _remove((char *)szWork);
    uVar13 = CONCAT22(i,0x1120);
    pcVar12 = (char *)szBase;
    pcVar6 = PszGetCompressedString(idsSXD);
    _wsprintf(szWork,pcVar6,pcVar12,uVar13);
    _remove((char *)szWork);
  }
  GenerateWorld(0);
  return;
}



// ======================================================================
// Function: NewGameWizard
// Address: 1078:6022
// Segment: MEMORY_CREATE
// ======================================================================


/* WARNING: Restarted to delay deadcode elimination for space: ram */

void NewGameWizard(HWND hwnd,short fReadOnly)

{
  GAME *pGVar1;
  undefined2 *puVar2;
  undefined2 uVar3;
  GAME *pGVar4;
  PLAYER *pPVar5;
  PLAYER *pPVar6;
  bool bVar7;
  char cVar8;
  byte bVar9;
  uint uVar10;
  short sVar11;
  ushort uVar12;
  PLAYER *pPVar13;
  char *pcVar14;
  short sVar15;
  int iVar16;
  GAME *pGVar17;
  GAME *pGVar18;
  undefined2 *puVar19;
  PLAYER *pPVar20;
  undefined2 unaff_SS;
  FARPROC pvVar21;
  PLAYER *pPVar22;
  GAME gameT;
  short lvlAi;
  PLAYER rgplrLocal [16];
  RECT rgrcStack [20];
  short j;
  char szFileLocal [208];
  short fEasy;
  short idAi;
  char szFile [256];
  short c;
  short i;
  short rgplrbmp [16];
  short fIdleSav;
  fn_lpProc *lpProc;
  short mdRet;
  short iStepMaxSoFar;
  
  iStepMaxSoFar = 0;
  bVar7 = false;
  vrgrcRCW = rgrcStack;
  iPanelActive = -1;
  fRCWReadOnly = fReadOnly;
  uVar10 = (uint)gd.grBits >> 7 & 1;
  gd.grBits._0_2_ = (uint)gd.grBits & 0xff7f | 0x80;
  vrgplrNew = rgplrLocal;
  vrgszFileNew = szFileLocal;
  vcplrNew = 0;
  _memset((byte *)vrgplrTypeNew,0,0x10);
  if (fReadOnly != 0) {
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) == 0) {
        ((byte *)vrgplrTypeNew)[i] = 0x19;
      }
      else {
        ((byte *)vrgplrTypeNew)[i] = (byte)(i << 2) | 2;
        pPVar13 = (PLAYER *)rgplr + i;
        pPVar20 = vrgplrNew + i;
        for (iVar16 = 0x60; iVar16 != 0; iVar16 = iVar16 + -1) {
          pPVar5 = pPVar20;
          pPVar20 = &pPVar20->cPlanet;
          pPVar22 = pPVar13;
          pPVar13 = &pPVar13->cPlanet;
          cVar8 = pPVar22->cShDef;
          pPVar5->iPlayer = pPVar22->iPlayer;
          pPVar5->cShDef = cVar8;
        }
        vrgszFileNew[i * 0xd] = '\0';
      }
    }
CREATE_Step1_2:
    do {
      pvVar21 = MakeProcInstance(NewGameDlg,hInst);
      sVar11 = DialogBox(0,(LPCSTR)CONCAT22(0x186,hwnd),(HWND)((ulong)pvVar21 >> 0x10),(char)pvVar21
                        );
      FreeProcInstance(pvVar21);
      if (sVar11 == 0) goto CREATE_Cancel;
      InitNewGamePlr(iStepMaxSoFar,lvlAi);
      if (sVar11 != 3) {
        do {
          pvVar21 = MakeProcInstance(NewGameDlg2,hInst);
          sVar11 = DialogBox(0,(LPCSTR)CONCAT22(0x187,hwnd),(HWND)((ulong)pvVar21 >> 0x10),
                             (char)pvVar21);
          FreeProcInstance(pvVar21);
          if (sVar11 == 0) goto CREATE_Cancel;
          if (iStepMaxSoFar == 0) {
            iStepMaxSoFar = 1;
          }
          InitNewGamePlr(iStepMaxSoFar,lvlAi);
          if (sVar11 == 1) goto CREATE_Step1_2;
          if (sVar11 == 3) break;
          pvVar21 = MakeProcInstance(NewGameDlg3,hInst);
          sVar11 = DialogBox(0,(LPCSTR)CONCAT22(0x188,hwnd),(HWND)((ulong)pvVar21 >> 0x10),
                             (char)pvVar21);
          FreeProcInstance(pvVar21);
          if (sVar11 == 0) goto CREATE_Cancel;
          if ((uint)iStepMaxSoFar < 2) {
            iStepMaxSoFar = 2;
          }
        } while (sVar11 == 1);
      }
CREATE_Finish_2:
      if (fRCWReadOnly != 0) goto CREATE_Cancel;
      CchGetString(idsGameXy,szFile);
      sVar11 = FGetNewGameName(szFile);
      if (sVar11 != 0) {
        pGVar17 = (GAME *)&game;
        pGVar18 = &gameT;
        for (iVar16 = 0x20; iVar16 != 0; iVar16 = iVar16 + -1) {
          pGVar4 = pGVar18;
          pGVar18 = (GAME *)((int)&pGVar18->lid + 2);
          pGVar1 = pGVar17;
          pGVar17 = (GAME *)((int)&pGVar17->lid + 2);
          *&pGVar4->lid = (int)pGVar1->lid;
        }
        gameT.turn = 0;
        DestroyCurGame();
        pGVar18 = &gameT;
        pGVar17 = (GAME *)&game;
        for (iVar16 = 0x20; iVar16 != 0; iVar16 = iVar16 + -1) {
          pGVar4 = pGVar17;
          pGVar17 = (GAME *)((int)&pGVar17->lid + 2);
          pGVar1 = pGVar18;
          pGVar18 = (GAME *)((int)&pGVar18->lid + 2);
          *&pGVar4->lid = (int)pGVar1->lid;
        }
        _strcpy((char *)szBase,szFile);
        uVar12 = _strlen((char *)szBase);
        *(undefined1 *)((int)rghbrMinSum[3] + 1 + uVar12) = 0;
        for (i = 0; (i < 0x10 && (((byte *)vrgplrTypeNew)[i] != 0)); i = i + 1) {
          bVar9 = ((byte *)vrgplrTypeNew)[i] & 3;
          if (bVar9 == 1) {
            if ((uint)((int)(uint)((byte *)vrgplrTypeNew)[i] >> 2) < 7) {
              c = (int)(uint)((byte *)vrgplrTypeNew)[i] >> 2;
              puVar19 = (undefined2 *)(c * 0xc0 + vrgplrDef);
              pPVar13 = (PLAYER *)rgplr + i;
              for (iVar16 = 0x60; iVar16 != 0; iVar16 = iVar16 + -1) {
                pPVar22 = pPVar13;
                pPVar13 = &pPVar13->cPlanet;
                puVar2 = puVar19;
                puVar19 = puVar19 + 1;
                uVar3 = *puVar2;
                pPVar22->iPlayer = (char)uVar3;
                pPVar22->cShDef = (char)((uint)uVar3 >> 8);
              }
            }
            else {
              c = Random(7);
              puVar19 = (undefined2 *)(c * 0xc0 + vrgplrDef);
              pPVar13 = (PLAYER *)rgplr + i;
              for (iVar16 = 0x60; iVar16 != 0; iVar16 = iVar16 + -1) {
                pPVar22 = pPVar13;
                pPVar13 = &pPVar13->cPlanet;
                puVar2 = puVar19;
                puVar19 = puVar19 + 1;
                uVar3 = *puVar2;
                pPVar22->iPlayer = (char)uVar3;
                pPVar22->cShDef = (char)((uint)uVar3 >> 8);
              }
              *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                   *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfdff | 0x200;
              *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                   *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xe3ff;
              *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                   *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0x1fff | 0xe000;
              *(undefined2 *)((int)&rgplr[0].lSalt + i * 0xc0) = 0xffff;
              *(undefined2 *)((int)&rgplr[0].lSalt + 2 + i * 0xc0) = 0xffff;
            }
            CchGetString
                      (c + idsHumanoid,(char *)((int)rgplr[0].szName + i * 0xc0));
            _wsprintf((char *)((int)rgplr[0].szNames + i * 0xc0),(char *)0x11200ab8,
                      i * 0xc0 + 0x5a22);
          }
          else if (bVar9 == 2) {
            pPVar13 = rgplrLocal + ((int)(uint)((byte *)vrgplrTypeNew)[i] >> 2);
            pPVar20 = (PLAYER *)rgplr + i;
            for (iVar16 = 0x60; iVar16 != 0; iVar16 = iVar16 + -1) {
              pPVar5 = pPVar20;
              pPVar20 = &pPVar20->cPlanet;
              pPVar22 = pPVar13;
              pPVar13 = &pPVar13->cPlanet;
              cVar8 = pPVar22->cShDef;
              pPVar5->iPlayer = pPVar22->iPlayer;
              pPVar5->cShDef = cVar8;
            }
          }
          else if (bVar9 == 3) {
            idAi = (int)(uint)((byte *)vrgplrTypeNew)[i] >> 2 & 7;
            lvlAi = (int)(uint)((byte *)vrgplrTypeNew)[i] >> 5;
            if (3 < (uint)lvlAi) {
              lvlAi = Random(4);
            }
            if (5 < (uint)idAi) {
              idAi = Random(6);
            }
            pPVar22 = LpplrComp(idAi,lvlAi);
            pPVar13 = (PLAYER *)pPVar22;
            pPVar20 = (PLAYER *)rgplr + i;
            for (iVar16 = 0x60; iVar16 != 0; iVar16 = iVar16 + -1) {
              pPVar6 = pPVar20;
              pPVar20 = &pPVar20->cPlanet;
              pPVar5 = pPVar13;
              pPVar13 = &pPVar13->cPlanet;
              cVar8 = pPVar5->cShDef;
              pPVar6->iPlayer = pPVar5->iPlayer;
              pPVar6->cShDef = cVar8;
            }
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xfdff | 0x200;
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xe3ff | (lvlAi & 7U) << 10
            ;
            *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0x1fff | idAi << 0xd;
          }
        }
        game.cPlayer = i;
        for (i = 0; i < game.cPlayer; i = i + 1) {
          if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) &&
             (sVar11 = CAdvantagePoints((PLAYER *)rgplr + i), sVar11 < 0)) {
            pPVar13 = (PLAYER *)rgplr + i;
            puVar19 = (undefined2 *)&vrgplrDef;
            for (iVar16 = 0x60; iVar16 != 0; iVar16 = iVar16 + -1) {
              pPVar22 = pPVar13;
              pPVar13 = &pPVar13->cPlanet;
              puVar2 = puVar19;
              puVar19 = puVar19 + 1;
              uVar3 = *puVar2;
              pPVar22->iPlayer = (char)uVar3;
              pPVar22->cShDef = (char)((uint)uVar3 >> 8);
            }
            *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) =
                 *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 0xffef | 0x10;
          }
          if (*(char *)((int)rgplr[0].szName + i * 0xc0) == '\0') {
            pcVar14 = (char *)((int)rgplr[0].szName + i * 0xc0);
            sVar11 = Random(0x18);
            CchGetString(sVar11 + idsBerserker,pcVar14);
          }
          if (*(char *)((int)rgplr[0].szNames + i * 0xc0) == '\0') {
            _wsprintf((char *)((int)rgplr[0].szNames + i * 0xc0),(char *)0x11200abc,
                      i * 0xc0 + 0x5a22);
          }
        }
        i = 1;
        do {
          if (game.cPlayer <= i) {
            for (i = 0; i < game.cPlayer; i = i + 1) {
              rgplrbmp[i] = *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 3 & 0x1f;
              if (((rgplrbmp[i] < 0) || (0x1f < rgplrbmp[i])) ||
                 ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) != 0)) {
                rgplrbmp[i] = -1;
              }
            }
            for (i = 1; i < game.cPlayer; i = i + 1) {
              if (rgplrbmp[i] != -1) {
                for (j = 0; (j < i && (rgplrbmp[j] != rgplrbmp[i])); j = j + 1) {
                }
                if (j < i) {
                  sVar15 = Random(2);
                  sVar11 = i;
                  if (sVar15 == 0) {
                    sVar11 = j;
                  }
                  rgplrbmp[sVar11] = -1;
                }
              }
            }
            for (i = 0; i < game.cPlayer; i = i + 1) {
              if (rgplrbmp[i] == -1) {
                sVar11 = Random(0x20);
                rgplrbmp[i] = sVar11;
                while( true ) {
                  for (j = 0; (j < game.cPlayer && ((j == i || (rgplrbmp[i] != rgplrbmp[j])))
                              ); j = j + 1) {
                  }
                  if (j == game.cPlayer) break;
                  rgplrbmp[i] = rgplrbmp[i] + 1;
                  if (0x1f < rgplrbmp[i]) {
                    rgplrbmp[i] = 0;
                  }
                }
              }
            }
            for (i = 0; i < game.cPlayer; i = i + 1) {
              *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) =
                   *(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 0xff07 |
                   (rgplrbmp[i] & 0x1fU) << 3;
            }
            if (fFreeingTitle == 0) {
              fFreeingTitle = 1;
              DestroyWindow(hwndTitle);
              hwndTitle = 0;
              ShowWindow(hwndFrame,5);
            }
            GenerateWorld(0);
            if (idPlayer == -1) {
              BringUpHostDlg();
            }
            gd.grBits._0_2_ = (uint)gd.grBits & 0xff7f | uVar10 << 7;
            return;
          }
          j = 0;
          while ((j < i && (sVar11 = _strcmp((char *)((int)rgplr[0].szName +
                                                             i * 0xc0),
                                                     (char *)((int)rgplr[0].szName +
                                                             j * 0xc0)), sVar11 != 0))) {
            j = j + 1;
          }
          if (j < i) {
            c = Random(0x18);
LAB_1078_6a97:
            for (j = 0; j < game.cPlayer; j = j + 1) {
              pcVar14 = PszGetCompressedString(c + idsBerserker);
              sVar11 = _strcmp((char *)((int)rgplr[0].szName + j * 0xc0),pcVar14);
              if (sVar11 == 0) break;
            }
            if (j != game.cPlayer) {
              c = c + 1;
              if (0x17 < c) {
                c = 0;
              }
              goto LAB_1078_6a97;
            }
            CchGetString
                      (c + idsBerserker,(char *)((int)rgplr[0].szName + i * 0xc0));
            _strcpy((char *)((int)rgplr[0].szNames + i * 0xc0),
                            (char *)((int)rgplr[0].szName + i * 0xc0));
            _strcat((char *)((int)rgplr[0].szNames + i * 0xc0),(char *)0xac0);
          }
          i = i + 1;
        } while( true );
      }
      if (bVar7) goto CREATE_Cancel;
    } while( true );
  }
  pGVar17 = (GAME *)&game;
  pGVar18 = &gameT;
  for (iVar16 = 0x20; iVar16 != 0; iVar16 = iVar16 + -1) {
    pGVar4 = pGVar18;
    pGVar18 = (GAME *)((int)&pGVar18->lid + 2);
    pGVar1 = pGVar17;
    pGVar17 = (GAME *)((int)&pGVar17->lid + 2);
    *&pGVar4->lid = (int)pGVar1->lid;
  }
  _memset((GAME *)&game,0,0x40);
  game.cPlanMax = gameT.cPlanMax;
  game.cPlayer = gameT.cPlayer;
  vrgplrTypeNew[0] = 1;
  vrgplrTypeNew[1] = 0x23;
  vrgplrTypeNew[2] = 0x27;
  vrgplrTypeNew[3] = 0x8b;
  pvVar21 = MakeProcInstance(SimpleNewGameDlg,hInst);
  sVar11 = DialogBox(0,(LPCSTR)CONCAT22(0xd1,hwnd),(HWND)((ulong)pvVar21 >> 0x10),(char)pvVar21);
  FreeProcInstance(pvVar21);
  game.rgvc[0] = 0x88;
  game.rgvc[1] = 0x8e;
  game.rgvc[2] = 0x82;
  game.rgvc[3] = 10;
  game.rgvc[4] = 0x88;
  game.rgvc[5] = 9;
  game.rgvc[6] = 9;
  game.rgvc[7] = 7;
  game.rgvc[8] = 1;
  if (sVar11 == 2) {
CREATE_Cancel:
    if (fRCWReadOnly == 0) {
      pGVar18 = &gameT;
      pGVar17 = (GAME *)&game;
      for (iVar16 = 0x20; iVar16 != 0; iVar16 = iVar16 + -1) {
        pGVar4 = pGVar17;
        pGVar17 = (GAME *)((int)&pGVar17->lid + 2);
        pGVar1 = pGVar18;
        pGVar18 = (GAME *)((int)&pGVar18->lid + 2);
        *&pGVar4->lid = (int)pGVar1->lid;
      }
    }
    gd.grBits._0_2_ = (uint)gd.grBits & 0xff7f | uVar10 << 7;
  }
  else {
    if (sVar11 != 0xd4) {
      if ((sVar11 == 0x430) || (sVar11 == 0xd3)) {
        _memset((byte *)vrgplrTypeNew,0,0x10);
        if (game.turn < 7) {
          vrgplrTypeNew[0] = (byte)((game.turn & 0xff) << 2) | 1;
        }
        else {
          vrgplrTypeNew[0] = 2;
          *vrgszFileNew = '\0';
          vcplrNew = 1;
        }
        sVar15 = game.mdDensity;
        lvlAi = game.mdDensity;
        InitNewGamePlr(0,game.mdDensity);
        game.mdDensity = 1;
        if (sVar15 < 2) {
          game.mdStartDist = 1;
        }
        else {
          game.mdStartDist = 2;
        }
        game.wCrap = game.wCrap & 0xff0c | (uint)(sVar15 == 3) << 4;
        CchGetString(sVar15 * 5 + 0x1cb + game.mdSize,(char *)game.szName);
        if (sVar11 == 0x430) {
          bVar7 = true;
          goto CREATE_Finish_2;
        }
      }
      goto CREATE_Step1_2;
    }
    pGVar18 = &gameT;
    pGVar17 = (GAME *)&game;
    for (iVar16 = 0x20; iVar16 != 0; iVar16 = iVar16 + -1) {
      pGVar4 = pGVar17;
      pGVar17 = (GAME *)((int)&pGVar17->lid + 2);
      pGVar1 = pGVar18;
      pGVar18 = (GAME *)((int)&pGVar18->lid + 2);
      *&pGVar4->lid = (int)pGVar1->lid;
    }
    StartTutor(0);
    gd.grBits._0_2_ = (uint)gd.grBits & 0xff7f | uVar10 << 7;
  }
  return;
}



// ======================================================================
// Function: InitNewGamePlr
// Address: 1078:6e44
// Segment: MEMORY_CREATE
// ======================================================================


void InitNewGamePlr(short iStepMaxSoFar,short lvlAi)

{
  byte bVar1;
  short sVar2;
  byte ch;
  short c;
  short i;
  
  if (((iStepMaxSoFar < 2) && (fRCWReadOnly == 0)) &&
     (SetVCVal((GAME *)&game,9,game.mdSize << 1), iStepMaxSoFar < 1)) {
    if (game.mdSize == 0) {
      if ((lvlAi == 3) && (sVar2 = Random(3), sVar2 == 0)) {
        game.cPlayer = 3;
      }
      else {
        game.cPlayer = 2;
      }
    }
    else if (game.mdSize == 1) {
      if ((lvlAi == 3) && (sVar2 = Random(4), sVar2 == 0)) {
        game.cPlayer = 5;
      }
      else if ((lvlAi < 2) || (sVar2 = Random(6 - lvlAi), sVar2 != 0)) {
        game.cPlayer = 3;
      }
      else {
        game.cPlayer = 4;
      }
    }
    else if (game.mdSize == 2) {
      if ((lvlAi == 3) && (sVar2 = Random(10), sVar2 == 0)) {
        game.cPlayer = 9;
      }
      else if ((lvlAi == 3) && (sVar2 = Random(10), sVar2 == 0)) {
        game.cPlayer = 5;
      }
      else if ((lvlAi < 2) || (sVar2 = Random(7 - lvlAi), sVar2 != 0)) {
        if ((lvlAi < 2) || (sVar2 = Random(7 - lvlAi), sVar2 != 0)) {
          game.cPlayer = 7;
        }
        else {
          game.cPlayer = 6;
        }
      }
      else {
        game.cPlayer = 8;
      }
    }
    else if (game.mdSize == 3) {
      if ((lvlAi == 3) && (sVar2 = Random(10), sVar2 == 0)) {
        sVar2 = Random(2);
        game.cPlayer = sVar2 + 0xe;
      }
      else if ((lvlAi == 3) && (sVar2 = Random(10), sVar2 == 0)) {
        sVar2 = Random(2);
        game.cPlayer = 10 - sVar2;
      }
      else if ((lvlAi < 2) || (sVar2 = Random(7 - lvlAi), sVar2 != 0)) {
        if ((lvlAi < 2) || (sVar2 = Random(7 - lvlAi), sVar2 != 0)) {
          game.cPlayer = 0xc;
        }
        else {
          game.cPlayer = 0xb;
        }
      }
      else {
        game.cPlayer = 0xd;
      }
    }
    else if (game.mdSize == 4) {
      if ((lvlAi == 3) && (sVar2 = Random(10), sVar2 == 0)) {
        sVar2 = Random(3);
        game.cPlayer = 0xd - sVar2;
      }
      else if ((lvlAi < 2) || (sVar2 = Random(9 - lvlAi), sVar2 != 0)) {
        if ((lvlAi < 2) || (sVar2 = Random(7 - lvlAi), sVar2 != 0)) {
          game.cPlayer = 0x10;
        }
        else {
          game.cPlayer = 0xf;
        }
      }
      else {
        game.cPlayer = 0xe;
      }
    }
    i = 1;
    if (lvlAi == 0) {
      for (; i < game.cPlayer; i = i + 1) {
        if (i < (game.cPlayer + 1) / 3 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0xb;
        }
        else if (i < ((game.cPlayer + 1) * 2) / 3 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0xf;
        }
        else if (i < ((game.cPlayer + 1) * 5) / 6 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 7;
        }
        else {
          ((byte *)vrgplrTypeNew)[i] = 0x1b;
        }
      }
    }
    else if (lvlAi == 1) {
      for (; i < game.cPlayer; i = i + 1) {
        if (i < ((game.cPlayer + 5) * 2) / 7 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0x27;
        }
        else if (i < ((game.cPlayer + -1) * 3 + 6) / 7 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0x23;
        }
        else if (i < ((game.cPlayer + -1) * 4 + 6) / 7 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0x2b;
        }
        else if (i < ((game.cPlayer + -1) * 5 + 6) / 7 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0x2f;
        }
        else if (i < ((game.cPlayer + -1) * 6 + 6) / 7 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0x33;
        }
        else {
          ((byte *)vrgplrTypeNew)[i] = 0x9b;
        }
      }
    }
    else if (lvlAi == 2) {
      for (; i < game.cPlayer; i = i + 1) {
        if (i < ((game.cPlayer + 5) * 2) / 7 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0x53;
        }
        else if (i < ((game.cPlayer + -1) * 3 + 6) / 7 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0x47;
        }
        else if (i < ((game.cPlayer + -1) * 4 + 6) / 7 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0x43;
        }
        else if (i < ((game.cPlayer + -1) * 5 + 6) / 7 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0x57;
        }
        else if (i < ((game.cPlayer + -1) * 6 + 6) / 7 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0x5b;
        }
        else {
          ((byte *)vrgplrTypeNew)[i] = 0x9b;
        }
      }
    }
    else if (lvlAi == 3) {
      for (; i < game.cPlayer; i = i + 1) {
        if (i < (game.cPlayer + 1) / 3 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 99;
        }
        else if (i < ((game.cPlayer + -1) * 6 + 0xb) / 0xc + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0x77;
        }
        else if (i < ((game.cPlayer + -1) * 5 + 5) / 6 + 1) {
          ((byte *)vrgplrTypeNew)[i] = 0x73;
        }
        else {
          ((byte *)vrgplrTypeNew)[i] = 0x7b;
        }
      }
    }
    for (i = 1; i < game.cPlayer + -1; i = i + 1) {
      sVar2 = Random((game.cPlayer - i) + -1);
      bVar1 = ((byte *)vrgplrTypeNew)[i];
      ((byte *)vrgplrTypeNew)[i] = ((byte *)vrgplrTypeNew + 1)[sVar2 + i];
      ((byte *)vrgplrTypeNew + 1)[sVar2 + i] = bVar1;
    }
  }
  return;
}



// ======================================================================
// Function: InitNewGame3
// Address: 1078:74f8
// Segment: MEMORY_CREATE
// ======================================================================


void InitNewGame3(void)

{
  return;
}



// ======================================================================
// Function: FGetNewGameName
// Address: 1078:7508
// Segment: MEMORY_CREATE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: ofn */

short FGetNewGameName(char *szFileSuggest)

{
  int iVar1;
  short sVar2;
  OFN ofn;
  char szFilter [256];
  char szFile [256];
  char szFileTitle [256];
  ushort i;
  char szXY [3];
  
  if (szFileSuggest == (char *)0x0) {
    szFile[0] = '\0';
  }
  else {
    _strcpy(szFile,szFileSuggest);
  }
  CchGetString(idsStarsGameFilesXy,szFilter);
  for (i = 0; szFilter[i] != '\0'; i = i + 1) {
    if (szFilter[i] == '|') {
      szFilter[i] = '\0';
    }
  }
  _memset(&ofn,0,0x48);
  szXY[0] = 'x';
  szXY[1] = 'y';
  szXY[2] = '\0';
  ofn.lStructSize._0_2_ = 0x48;
  ofn.lStructSize._2_2_ = 0;
  ofn.hwndOwner = hwndFrame;
  ofn.lpstrFilter._0_2_ = szFilter;
  ofn.nFilterIndex._0_2_ = 1;
  ofn.nFilterIndex._2_2_ = 0;
  ofn.lpstrFile._0_2_ = szFile;
  ofn.nMaxFile._0_2_ = 0x100;
  ofn.nMaxFile._2_2_ = 0;
  ofn.lpstrFileTitle._0_2_ = szFileTitle;
  ofn.nMaxFileTitle._0_2_ = 0x100;
  ofn.nMaxFileTitle._2_2_ = 0;
  ofn.lpstrInitialDir._0_2_ = (char *)szDirName;
  ofn.lpstrInitialDir._2_2_ = 0x1120;
  ofn.lpstrTitle._0_2_ = (char *)s_Choose_New_Game_Name_1120_0ac2;
  ofn.lpstrTitle._2_2_ = 0x1120;
  ofn.lpstrDefExt._0_2_ = szXY;
  ofn.Flags._0_2_ = 0x8806;
  ofn.Flags._2_2_ = 0;
  iVar1 = GetSaveFileName(&ofn);
  if (iVar1 == 0) {
    sVar2 = 0;
  }
  else {
    if (ofn.nFileExtension == 0) {
      _strcat(szFile,szXY);
    }
    else {
      _strcpy(szFile + ofn.nFileExtension,szXY);
    }
    _strcpy(szFileSuggest,szFile);
    sVar2 = 1;
  }
  return sVar2;
}



// ======================================================================
// Function: SimpleNewGameDlg
// Address: 1078:76aa
// Segment: MEMORY_CREATE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: ps */
/* WARNING: Removing unreachable block (ram,0x10787db7) */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short SimpleNewGameDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  undefined2 *puVar1;
  PLAYER *pPVar2;
  undefined2 uVar3;
  PLAYER *pPVar4;
  char cVar5;
  char *pcVar6;
  HWND HVar7;
  short sVar8;
  int iVar9;
  undefined2 unaff_SI;
  undefined2 *puVar10;
  PLAYER *pPVar11;
  undefined2 unaff_DI;
  PLAYER *pPVar12;
  undefined2 unaff_SS;
  ulong uVar13;
  LRESULT LVar14;
  WPARAM WVar15;
  UINT UVar16;
  PAINTSTRUCT ps;
  short c;
  short dy;
  RECT local_18;
  HWND local_10;
  RECT rc;
  short i;
  
  uVar13 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    local_10 = BeginPaint(hwnd,&ps);
    HVar7 = GetDlgItem(hwnd,200);
    GetWindowRect(HVar7,&local_18);
    ScreenToClient(hwnd,(POINT *)&local_18);
    HVar7 = GetDlgItem(hwnd,0xcb);
    GetWindowRect(HVar7,&rc);
    ScreenToClient(hwnd,(POINT *)&rc.right);
    local_18.right = rc.right;
    local_18.bottom = rc.bottom;
    ExpandRc(&local_18,dyArial8,dyArial8 >> 1);
    _Draw3dFrame();
    SelectObject(local_10,rghfontArial8[1]);
    SetBkColor(local_10,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    sVar8 = CchGetString(idsDifficultyLevel,(char *)szWork);
    TextOut(local_10,local_18.left + 8,local_18.top - (dyArial8 >> 1),szWork,
            sVar8);
    HVar7 = GetDlgItem(hwnd,1000);
    GetWindowRect(HVar7,&local_18);
    ScreenToClient(hwnd,(POINT *)&local_18);
    HVar7 = GetDlgItem(hwnd,0x3ec);
    GetWindowRect(HVar7,&rc);
    ScreenToClient(hwnd,(POINT *)&rc.right);
    local_18.right = rc.right;
    local_18.bottom = rc.bottom;
    ExpandRc(&local_18,dyArial8,dyArial8 >> 1);
    _Draw3dFrame();
    SelectObject(local_10,rghfontArial8[1]);
    sVar8 = CchGetString(idsUniverseSize,(char *)szWork);
    TextOut(local_10,local_18.left + 8,local_18.top - (dyArial8 >> 1),szWork,
            sVar8);
    local_18.top = local_18.bottom + 8;
    HVar7 = GetDlgItem(hwnd,0x81a);
    GetWindowRect(HVar7,&local_18);
    MapWindowPoints(0,hwnd,(POINT *)&local_18,2);
    ExpandRc(&local_18,dyArial8,dyArial8 >> 1);
    local_18.bottom = local_18.bottom + dyArial8 * 2;
    _Draw3dFrame();
    SelectObject(local_10,rghfontArial8[1]);
    sVar8 = CchGetString(idsPlayerRace,(char *)szWork);
    TextOut(local_10,local_18.left + 8,local_18.top - (dyArial8 >> 1),szWork,
            sVar8);
    local_18.top = dyArial8 * 3 + local_18.bottom;
    local_18.bottom = 1000;
    ExpandRc(&local_18,-dyArial8,0);
    sVar8 = CchGetString
                      (idsButtonAllowsConfigureMultiPlayerGamesCustom,(char *)szWork);
    sVar8 = DRAWTEXT(local_10,szWork,sVar8,&local_18,0x810);
    HVar7 = GetDlgItem(hwnd,0xd3);
    SetWindowPos(HVar7,0,local_18.left,local_18.top + sVar8 + dyArial8 / 2,0,0,5);
    local_18.bottom = local_18.top + sVar8 + dyArial8 * 2;
    ExpandRc(&local_18,dyArial8,dyArial8 >> 1);
    _Draw3dFrame();
    sVar8 = CchGetString(idsAdvancedGame,(char *)szWork);
    TextOut(local_10,local_18.left + 8,local_18.top - (dyArial8 >> 1),szWork,
            sVar8);
    EndPaint(hwnd,&ps);
    sVar8 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    sVar8 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      for (i = 200; i < 0xcc; i = i + 1) {
        local_10 = (HWND)lParam;
        HVar7 = GetDlgItem(hwnd,i);
        if (local_10 == HVar7) {
          i = -1;
          break;
        }
      }
      if (i != -1) {
        for (i = 1000; i < 0x3ed; i = i + 1) {
          local_10 = (HWND)lParam;
          HVar7 = GetDlgItem(hwnd,i);
          if (local_10 == HVar7) {
            i = -1;
            break;
          }
        }
      }
      if ((i == -1) || (uVar13 = __aFulshr(uVar13,ps.hdc), (int)uVar13 == 6)) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        CheckRadioButton(hwnd,200,0xcb,0xc9);
        CheckRadioButton(hwnd,1000,0x3ec,0x3e9);
        local_10 = GetDlgItem(hwnd,0x81a);
        SendMessage(local_10,0x40b,0,0);
        for (i = 0; i < 7; i = i + 1) {
          UVar16 = 0x403;
          WVar15 = 0;
          HVar7 = local_10;
          pcVar6 = PszGetCompressedString(i + idsHumanoid);
          SendMessage(HVar7,UVar16,WVar15,(LPARAM)pcVar6);
        }
        SendMessage(local_10,0x40e,0,0);
        StickyDlgPos(hwnd,(POINT *)&ptStickyNewDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        if (((wParam == 0x430) || (wParam == 2)) || (wParam == 0xd3)) {
          i = 200;
          while ((i < 0xcc && (UVar16 = IsDlgButtonChecked(hwnd,i), UVar16 == 0))) {
            i = i + 1;
          }
          game.mdDensity = i + -200;
          i = 1000;
          while ((i < 0x3ed && (UVar16 = IsDlgButtonChecked(hwnd,i), UVar16 == 0))) {
            i = i + 1;
          }
          game.mdSize = i + -1000;
          HVar7 = GetDlgItem(hwnd,0x81a);
          LVar14 = SendMessage(HVar7,0x407,0,0);
          game.turn = (ushort)LVar14;
          StickyDlgPos(hwnd,(POINT *)&ptStickyNewDlg,0);
          EndDialog(hwnd,wParam);
          return 1;
        }
        if (wParam == 0xd4) {
          StickyDlgPos(hwnd,(POINT *)&ptStickyNewDlg,0);
          EndDialog(hwnd,0xd4);
          return 1;
        }
        if (wParam == 0xd2) {
          local_10 = GetDlgItem(hwnd,0x81a);
          LVar14 = SendMessage(local_10,0x407,0,0);
          game.turn = (ushort)LVar14;
          if (game.turn < 7) {
            puVar10 = (undefined2 *)(game.turn * 0xc0 + vrgplrDef);
            pPVar11 = (PLAYER *)&vplr;
            for (iVar9 = 0x60; iVar9 != 0; iVar9 = iVar9 + -1) {
              pPVar2 = pPVar11;
              pPVar11 = &pPVar11->cPlanet;
              puVar1 = puVar10;
              puVar10 = puVar10 + 1;
              uVar3 = *puVar1;
              pPVar2->iPlayer = (char)uVar3;
              pPVar2->cShDef = (char)((uint)uVar3 >> 8);
            }
            CchGetString(game.turn + idsHumanoid,(char *)vplr.szName);
            _wsprintf(vplr.szNames,(char *)0x11200adc,0x501a,0x1120);
          }
          else {
            pPVar12 = (PLAYER *)&vplr;
            pPVar11 = vrgplrNew;
            for (iVar9 = 0x60; iVar9 != 0; iVar9 = iVar9 + -1) {
              pPVar4 = pPVar12;
              pPVar12 = &pPVar12->cPlanet;
              pPVar2 = pPVar11;
              pPVar11 = &pPVar11->cPlanet;
              cVar5 = pPVar2->cShDef;
              pPVar4->iPlayer = pPVar2->iPlayer;
              pPVar4->cShDef = cVar5;
            }
          }
          local_18.bottom = (short)vrgrcRCW;
          sVar8 = RaceCreationWizard(hwnd,0,1);
          if (sVar8 != 0) {
            LVar14 = SendMessage(local_10,0x406,0,0);
            if (7 < LVar14) {
              SendMessage(local_10,0x404,7,0);
            }
            SendMessage(local_10,0x403,0,0x1120501a);
            SendMessage(local_10,0x40e,7,0);
            pPVar11 = (PLAYER *)&vplr;
            pPVar12 = vrgplrNew;
            for (iVar9 = 0x60; iVar9 != 0; iVar9 = iVar9 + -1) {
              pPVar4 = pPVar12;
              pPVar12 = &pPVar12->cPlanet;
              pPVar2 = pPVar11;
              pPVar11 = &pPVar11->cPlanet;
              cVar5 = pPVar2->cShDef;
              pPVar4->iPlayer = pPVar2->iPlayer;
              pPVar4->cShDef = cVar5;
            }
          }
          vrgrcRCW = (RECT *)local_18.bottom;
          SetFocus(hwnd);
        }
        else if (wParam == 0x76) {
          WinHelp(hwnd,_szHelpFile,1,0x3ea);
          return 1;
        }
      }
    }
    sVar8 = 0;
  }
  return sVar8;
}



// ======================================================================
// Function: NewGameDlg
// Address: 1078:7e92
// Segment: MEMORY_CREATE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: ps */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short NewGameDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  HDC HVar1;
  HWND HVar2;
  short sVar3;
  UINT UVar4;
  undefined1 *puVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar6;
  undefined2 unaff_SS;
  ulong uVar7;
  PAINTSTRUCT ps;
  short c;
  RECT rcGBox;
  int local_10;
  RECT rc;
  short i;
  
  uVar6 = 0x1078;
  puVar5 = &stack0xffc2;
  uVar7 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    HVar1 = BeginPaint(hwnd,&ps);
    HVar2 = GetDlgItem(hwnd,1000);
    GetWindowRect(HVar2,&rcGBox);
    ScreenToClient(hwnd,(POINT *)&rcGBox);
    HVar2 = GetDlgItem(hwnd,0x3ec);
    GetWindowRect(HVar2,&rc);
    ScreenToClient(hwnd,(POINT *)&rc.right);
    rcGBox.right = rc.right;
    rcGBox.bottom = rc.bottom;
    ExpandRc(&rcGBox,dyArial8,dyArial8 >> 1);
    _Draw3dFrame();
    SelectObject(HVar1,rghfontArial8[1]);
    SetBkColor(HVar1,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    sVar3 = CchGetString(idsUniverseSize,(char *)szWork);
    TextOut(HVar1,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,sVar3);
    HVar2 = GetDlgItem(hwnd,0x3ed);
    GetWindowRect(HVar2,&rcGBox);
    ScreenToClient(hwnd,(POINT *)&rcGBox);
    HVar2 = GetDlgItem(hwnd,0x3f0);
    GetWindowRect(HVar2,&rc);
    ScreenToClient(hwnd,(POINT *)&rc.right);
    rcGBox.right = rc.right;
    rcGBox.bottom = rc.bottom;
    ExpandRc(&rcGBox,dyArial8,dyArial8 >> 1);
    _Draw3dFrame();
    SelectObject(HVar1,rghfontArial8[1]);
    SetBkColor(HVar1,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    sVar3 = CchGetString(idsDensity,(char *)szWork);
    TextOut(HVar1,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,sVar3);
    HVar2 = GetDlgItem(hwnd,0x3f1);
    GetWindowRect(HVar2,&rcGBox);
    ScreenToClient(hwnd,(POINT *)&rcGBox);
    HVar2 = GetDlgItem(hwnd,0x3f4);
    GetWindowRect(HVar2,&rc);
    ScreenToClient(hwnd,(POINT *)&rc.right);
    rcGBox.right = rc.right;
    rcGBox.bottom = rc.bottom;
    ExpandRc(&rcGBox,dyArial8,dyArial8 >> 1);
    _Draw3dFrame();
    SelectObject(HVar1,rghfontArial8[1]);
    SetBkColor(HVar1,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    sVar3 = CchGetString(idsPlayerPositions,(char *)szWork);
    TextOut(HVar1,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,sVar3);
    EndPaint(hwnd,&ps);
    sVar3 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    sVar3 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      i = 1000;
      while ((i < 0x3fe && (HVar2 = GetDlgItem(hwnd,i), (HWND)lParam != HVar2))) {
        i = i + 1;
      }
      if (((i < 0x3fe) || (uVar7 = __aFulshr(uVar7,ps.hdc), (int)uVar7 == 6)) ||
         (HVar2 = GetDlgItem(hwnd,0x41a), (HWND)lParam == HVar2)) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        SetNGWTitle(hwnd,1);
        CheckRadioButton(hwnd,1000,0x3ec,game.mdSize + 1000);
        CheckRadioButton(hwnd,0x3ed,0x3f0,game.mdDensity + 0x3ed);
        CheckRadioButton(hwnd,0x3f1,0x3f4,game.mdStartDist + 0x3f1);
        HVar2 = GetDlgItem(hwnd,0x406);
        SetWindowText(HVar2,game.szName);
        SendDlgItemMessage(hwnd,0x406,0x415,0x1f,0);
        HVar2 = GetDlgItem(hwnd,0x3f8);
        uVar7 = CONCAT22(0x401,game.wCrap) & 0xffff0001;
        SendMessage(HVar2,(UINT)(uVar7 >> 0x10),(WPARAM)uVar7,0);
        HVar2 = GetDlgItem(hwnd,0x3f9);
        uVar7 = CONCAT22(0x401,game.wCrap >> 1) & 0xffff0001;
        SendMessage(HVar2,(UINT)(uVar7 >> 0x10),(WPARAM)uVar7,0);
        HVar2 = GetDlgItem(hwnd,0x3fa);
        uVar7 = CONCAT22(0x401,game.wCrap >> 5) & 0xffff0001;
        SendMessage(HVar2,(UINT)(uVar7 >> 0x10),(WPARAM)uVar7,0);
        HVar2 = GetDlgItem(hwnd,0x3fb);
        uVar7 = CONCAT22(0x401,game.wCrap >> 7) & 0xffff0001;
        SendMessage(HVar2,(UINT)(uVar7 >> 0x10),(WPARAM)uVar7,0);
        HVar2 = GetDlgItem(hwnd,0x3fc);
        uVar7 = CONCAT22(0x401,game.wCrap >> 4) & 0xffff0001;
        SendMessage(HVar2,(UINT)(uVar7 >> 0x10),(WPARAM)uVar7,0);
        HVar2 = GetDlgItem(hwnd,0x3fd);
        uVar7 = CONCAT22(0x401,game.wCrap >> 6) & 0xffff0001;
        SendMessage(HVar2,(UINT)(uVar7 >> 0x10),(WPARAM)uVar7,0);
        HVar2 = GetDlgItem(hwnd,0x41a);
        uVar7 = CONCAT22(0x401,game.wCrap >> 8) & 0xffff0001;
        SendMessage(HVar2,(UINT)(uVar7 >> 0x10),(WPARAM)uVar7,0);
        if (fRCWReadOnly != 0) {
          for (i = 1000; i < 0x3ed; i = i + 1) {
            HVar2 = GetDlgItem(hwnd,i);
            EnableWindow(HVar2,0);
          }
          for (i = 0x3ed; i < 0x3f1; i = i + 1) {
            HVar2 = GetDlgItem(hwnd,i);
            EnableWindow(HVar2,0);
          }
          for (i = 0x3f1; i < 0x3f5; i = i + 1) {
            HVar2 = GetDlgItem(hwnd,i);
            EnableWindow(HVar2,0);
          }
          HVar2 = GetDlgItem(hwnd,0x3f8);
          EnableWindow(HVar2,0);
          HVar2 = GetDlgItem(hwnd,0x3f9);
          EnableWindow(HVar2,0);
          HVar2 = GetDlgItem(hwnd,0x3fa);
          EnableWindow(HVar2,0);
          HVar2 = GetDlgItem(hwnd,0x3fb);
          EnableWindow(HVar2,0);
          HVar2 = GetDlgItem(hwnd,0x41a);
          EnableWindow(HVar2,0);
          HVar2 = GetDlgItem(hwnd,0x3fc);
          EnableWindow(HVar2,0);
          HVar2 = GetDlgItem(hwnd,0x406);
          EnableWindow(HVar2,0);
          HVar2 = GetDlgItem(hwnd,0x3fd);
          EnableWindow(HVar2,0);
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyNewDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        if (wParam == 0x76) {
          WinHelp(hwnd,_szHelpFile,1,0x3f4);
          return 1;
        }
        local_10 = 0;
        while ((local_10 < 4 &&
               (wParam != *(ushort *)((ushort_0_ *)&rgidRaceBtn + local_10 * 2)))) {
          local_10 = local_10 + 1;
        }
        if (local_10 < 4) {
          if (local_10 != 0) {
            i = 1000;
            while ((i < 0x3ed && (UVar4 = IsDlgButtonChecked(hwnd,i), UVar4 == 0))) {
              i = i + 1;
            }
            game.mdSize = i + -1000;
            i = 0x3ed;
            while ((i < 0x3f1 && (UVar4 = IsDlgButtonChecked(hwnd,i), UVar4 == 0))) {
              i = i + 1;
            }
            game.mdDensity = i + -0x3ed;
            i = 0x3f1;
            while ((i < 0x3f5 && (UVar4 = IsDlgButtonChecked(hwnd,i), UVar4 == 0))) {
              i = i + 1;
            }
            game.mdStartDist = i + -0x3f1;
            rcGBox.bottom = IsDlgButtonChecked(hwnd,0x3f8);
            game.wCrap = game.wCrap & 0xfffe | rcGBox.bottom & 1U;
            rcGBox.bottom = IsDlgButtonChecked(hwnd,0x3f9);
            game.wCrap = game.wCrap & 0xfffd | (rcGBox.bottom & 1U) << 1;
            rcGBox.bottom = IsDlgButtonChecked(hwnd,0x3fa);
            game.wCrap = game.wCrap & 0xffdf | (rcGBox.bottom & 1U) << 5;
            rcGBox.bottom = IsDlgButtonChecked(hwnd,0x3fb);
            game.wCrap = game.wCrap & 0xff7f | (rcGBox.bottom & 1U) << 7;
            rcGBox.bottom = IsDlgButtonChecked(hwnd,0x3fc);
            game.wCrap = game.wCrap & 0xffef | (rcGBox.bottom & 1U) << 4;
            rcGBox.bottom = IsDlgButtonChecked(hwnd,0x3fd);
            game.wCrap = game.wCrap & 0xffbf | (rcGBox.bottom & 1U) << 6;
            rcGBox.bottom = IsDlgButtonChecked(hwnd,0x41a);
            game.wCrap = game.wCrap & 0xfeff | (rcGBox.bottom & 1U) << 8;
            HVar2 = GetDlgItem(hwnd,0x406);
            uVar6 = 0x14f8;
            sVar3 = GetWindowText(HVar2,game.szName,0x20);
            puVar5 = &stack0xffba;
            if (sVar3 == 0) {
              uVar6 = 0x1118;
              _strcpy((char *)game.szName,(char *)szBase);
              puVar5 = &stack0xffba;
            }
          }
          *(undefined2 *)(puVar5 + -2) = 0;
          *(undefined2 *)(puVar5 + -4) = 0xad8;
          *(HWND *)(puVar5 + -6) = hwnd;
          *(undefined2 *)(puVar5 + -8) = uVar6;
          *(undefined2 *)(puVar5 + -10) = 0x877e;
          StickyDlgPos
                    (*(HWND *)(puVar5 + -6),*(POINT **)(puVar5 + -4),*(short *)(puVar5 + -2));
          *(HWND *)(puVar5 + -2) = hwnd;
          *(int *)(puVar5 + -4) = local_10;
          *(undefined2 *)(puVar5 + -6) = 0x1040;
          *(undefined2 *)(puVar5 + -8) = 0x878c;
          EndDialog(*(HWND *)(puVar5 + -2),*(short *)(puVar5 + -4));
          return 1;
        }
      }
    }
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: NewGameDlg2
// Address: 1078:87d2
// Segment: MEMORY_CREATE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short NewGameDlg2(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  undefined2 *puVar1;
  PLAYER *pPVar2;
  PLAYER *pPVar3;
  byte bVar4;
  char cVar5;
  HWND HVar6;
  UINT UVar7;
  HMENU HVar8;
  uint uVar9;
  BOOL BVar10;
  char *pcVar11;
  int iVar12;
  int iVar13;
  undefined1 *puVar14;
  undefined2 unaff_SI;
  PLAYER *pPVar15;
  undefined2 *puVar16;
  undefined2 unaff_DI;
  PLAYER *pPVar17;
  undefined2 uVar18;
  undefined2 unaff_SS;
  ulong uVar19;
  UINT UVar20;
  HMENU HVar21;
  HMENU HVar22;
  short sVar23;
  ushort in_stack_0000ffac;
  RECT *pRVar24;
  short iCurVal;
  short iDiamond;
  MSG msg;
  HMENU hmenuPopup;
  HMENU local_3a [5];
  undefined1 local_30 [24];
  int local_18;
  undefined8 local_16;
  RECT rc;
  short i;
  
  uVar19 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    local_16._6_2_ = BeginPaint(hwnd,local_30);
    DrawNewGame2(hwnd,local_16._6_2_,-1);
    EndPaint(hwnd,local_30);
    return 1;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    for (i = 0x191; i < 0x1c1; i = i + 1) {
      local_16._6_2_ = (HWND)lParam;
      HVar6 = GetDlgItem(hwnd,i);
      if (local_16._6_2_ == HVar6) break;
    }
    if ((0x1c0 < i) && (uVar19 = __aFulshr(uVar19,in_stack_0000ffac), (int)uVar19 != 6)) {
      return 0;
    }
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    return hbrButtonFace;
  }
  if (message == WM_SETCURSOR) {
    if (fRCWReadOnly != 0) {
      return 0;
    }
    GetCursorPos((POINT *)((int)&local_16 + 4));
    ScreenToClient(hwnd,(POINT *)((int)&local_16 + 4));
    if (local_16._4_2_ < xNewGameDiamond) {
      return 0;
    }
    if (xNewGameDiamond + dyArial8 + 1 <= local_16._4_2_) {
      return 0;
    }
    if ((int)local_16._6_2_ < 6) {
      return 0;
    }
    local_16._2_2_ = (int)(local_16._6_2_ - 6) / (dyArial8 + 4);
    if (0xf < (int)local_16._2_2_) {
      return 0;
    }
    if (dyArial8 + 1 <= (int)(local_16._6_2_ - 6) % (dyArial8 + 4)) {
      return 0;
    }
    setcursor(hcurHand);
    return 1;
  }
  if (message == WM_INITDIALOG) {
    SetNGWTitle(hwnd,2);
    local_30._22_2_ = (dyArial8 + 4) * 0x10 + 8;
    HVar6 = GetDlgItem(hwnd,_rgidRaceBtn);
    GetWindowRect(HVar6,&rc);
    local_18 = rc.bottom - rc.top;
    GetWindowRect(hwnd,&local_16);
    local_30._20_2_ = local_16._6_2_ - local_16._2_2_;
    if ((int)local_30._20_2_ < local_30._22_2_ + local_18 + 6) {
      for (i = 0; i < 5; i = i + 1) {
        local_30._18_2_ = GetDlgItem(hwnd,*(short *)((ushort_0_ *)&rgidRaceBtn + i * 2));
        GetWindowRect(local_30._18_2_,&rc);
        MapWindowPoints(0,hwnd,(POINT *)&rc,2);
        OffsetRect(&rc,0,local_30._22_2_ - rc.top);
        SetWindowPos(local_30._18_2_,0,rc.left,rc.top,0,0,5);
      }
      local_30._22_2_ = rc.bottom + 6;
      GetClientRect(hwnd,&rc);
      if ((int)local_30._20_2_ < (int)local_30._22_2_) {
        SetWindowPos(hwnd,0,0,0,local_16._4_2_ - (int)local_16,
                     ((local_30._22_2_ + local_16._6_2_) - local_16._2_2_) - rc.bottom,6);
      }
    }
    StickyDlgPos(hwnd,(POINT *)&ptStickyNewDlg,1);
    return 1;
  }
  if (message == WM_COMMAND) {
    if (wParam == 0x76) {
      WinHelp(hwnd,_szHelpFile,1,0x3fc);
      return 1;
    }
    i = 0;
    while ((i < 4 && (wParam != *(ushort *)((ushort_0_ *)&rgidRaceBtn + i * 2)))) {
      i = i + 1;
    }
    if (3 < i) {
      return 0;
    }
    if (((i != 0) && (vrgplrTypeNew[0] == 0)) && (fRCWReadOnly == 0)) {
      sVar23 = 0x10;
      pcVar11 = PszFormatIds(idsMustHaveLeastOnePlayerGame,(short *)0x0);
      AlertSz(pcVar11,sVar23);
      return 0;
    }
    StickyDlgPos(hwnd,(POINT *)&ptStickyNewDlg,0);
    EndDialog(hwnd,i);
    return 1;
  }
  if ((message != WM_LBUTTONDOWN) && (message != WM_RBUTTONDOWN)) {
    return 0;
  }
  if (fRCWReadOnly != 0) {
    return 0;
  }
  local_16._2_2_ = (HWND)lParam;
  uVar19 = __aFulshr(uVar19,in_stack_0000ffac);
  local_16._4_2_ = (int)uVar19;
  if ((int)local_16._2_2_ < xNewGameDiamond) {
    return 0;
  }
  if (xNewGameDiamond + dyArial8 + 1 <= (int)local_16._2_2_) {
    return 0;
  }
  if (local_16._4_2_ < 6) {
    return 0;
  }
  iDiamond = (local_16._4_2_ + -6) / (dyArial8 + 4);
  if (0xf < iDiamond) {
    return 0;
  }
  if (dyArial8 + 1 <= (local_16._4_2_ + -6) % (dyArial8 + 4)) {
    return 0;
  }
  bVar4 = ((byte *)vrgplrTypeNew)[iDiamond];
  iCurVal = (short)bVar4;
  ClientToScreen(hwnd,(POINT *)((int)&local_16 + 2));
  local_3a[0] = CreatePopupMenu();
  for (local_16._0_2_ = 0; (int)local_16 < 6; local_16._0_2_ = (int)local_16 + 1) {
    if (iCurVal == (int)local_16 * 4 + 1U) {
      local_30._18_2_ = 8;
    }
    else {
      local_30._18_2_ = 0;
    }
    local_30._22_2_ = PszGetCompressedString((int)local_16 + idsHumanoid);
    AppendMenu(local_3a[0],local_30._18_2_,(int)local_16 + 0x3aa8,(LPCSTR)local_30._22_2_);
  }
  UVar7 = (int)local_16 + 0x3aa8;
  UVar20 = local_30._18_2_;
  HVar8 = local_3a[0];
  pcVar11 = PszGetCompressedString(idsRandom);
  AppendMenu(HVar8,UVar20,UVar7,pcVar11);
  UVar7 = (int)local_16 + 0x3aa9;
  UVar20 = local_30._18_2_;
  HVar8 = local_3a[0];
  pcVar11 = PszGetCompressedString(idsExpansionPlayer);
  AppendMenu(HVar8,UVar20,UVar7,pcVar11);
  HVar8 = CreatePopupMenu();
  UVar7 = 0;
  UVar20 = 15000;
  local_3a[1] = HVar8;
  pcVar11 = PszGetCompressedString(idsNew);
  AppendMenu(HVar8,UVar7,UVar20,pcVar11);
  UVar7 = 0;
  UVar20 = 0x3a99;
  HVar8 = local_3a[1];
  pcVar11 = PszGetCompressedString(idsOpen);
  AppendMenu(HVar8,UVar7,UVar20,pcVar11);
  for (local_16._0_2_ = 0; (int)local_16 < vcplrNew; local_16._0_2_ = (int)local_16 + 1) {
    if (iCurVal == (int)local_16 * 4 + 2U) {
      local_30._18_2_ = 8;
    }
    else {
      local_30._18_2_ = 0;
    }
    local_30._22_2_ = PszPlayerName(0,1,1,1,0,vrgplrNew + (int)local_16);
    AppendMenu(local_3a[1],local_30._18_2_,(int)local_16 + 0x3ab8,(LPCSTR)local_30._22_2_);
  }
  local_3a[2] = CreatePopupMenu();
  for (local_16._0_2_ = 0; (int)local_16 < 7; local_16._0_2_ = (int)local_16 + 1) {
    HVar8 = CreatePopupMenu();
    local_3a[(int)local_16 + 5] = HVar8;
    for (local_18 = 0; local_18 < 5; local_18 = local_18 + 1) {
      if (iCurVal == local_18 * 0x20 + (int)local_16 * 4 + 5U) {
        local_30._18_2_ = 8;
      }
      else {
        local_30._18_2_ = 0;
      }
      AppendMenu(local_3a[(int)local_16 + 5],local_30._18_2_,(int)local_16 + 0x3ac8 + local_18 * 8,
                 (char *)*(undefined2 *)(local_18 * 2 + vrgszComputerLevel));
    }
    if ((iCurVal & 0x1fU) == (int)local_16 * 4 + 5U) {
      local_30._18_2_ = 8;
    }
    else {
      local_30._18_2_ = 0;
    }
    AppendMenu(local_3a[2],local_30._18_2_ | 0x10,local_3a[(int)local_16 + 5],
               (char *)*(undefined2 *)((int)local_16 * 2 + vrgszComputerPlayers));
  }
  HVar8 = CreatePopupMenu();
  iPopMenuSel = -1;
  if ((iCurVal & 3U) == 1) {
    local_30._18_2_ = 8;
  }
  else {
    local_30._18_2_ = 0;
  }
  uVar9 = local_30._18_2_ | 0x10;
  HVar21 = local_3a[0];
  HVar22 = HVar8;
  pcVar11 = PszGetCompressedString(idsPredefinedRace);
  AppendMenu(HVar22,uVar9,HVar21,pcVar11);
  if ((iCurVal & 3U) == 2) {
    local_30._18_2_ = 8;
  }
  else {
    local_30._18_2_ = 0;
  }
  uVar9 = local_30._18_2_ | 0x10;
  HVar21 = local_3a[1];
  HVar22 = HVar8;
  pcVar11 = PszGetCompressedString(idsCustomRace);
  AppendMenu(HVar22,uVar9,HVar21,pcVar11);
  if (((iCurVal & 3U) == 1) || ((iCurVal & 3U) == 2)) {
    UVar7 = 0;
    UVar20 = 0x3a9a;
    HVar21 = HVar8;
    pcVar11 = PszGetCompressedString(idsEditRace);
    AppendMenu(HVar21,UVar7,UVar20,pcVar11);
  }
  AppendMenu(HVar8,0x800,0,(LPCSTR)0x0);
  if ((iCurVal & 3U) == 3) {
    local_30._18_2_ = 8;
  }
  else {
    local_30._18_2_ = 0;
  }
  uVar9 = local_30._18_2_ | 0x10;
  HVar21 = local_3a[2];
  HVar22 = HVar8;
  pcVar11 = PszGetCompressedString(idsComputerPlayer);
  AppendMenu(HVar22,uVar9,HVar21,pcVar11);
  AppendMenu(HVar8,0x800,0,(LPCSTR)0x0);
  if ((bVar4 & 3) == 0) {
    UVar20 = 8;
  }
  else {
    UVar20 = 0;
  }
  UVar7 = 0x3a9b;
  HVar21 = HVar8;
  local_30._18_2_ = UVar20;
  pcVar11 = PszGetCompressedString(idsPlayer);
  AppendMenu(HVar21,UVar20,UVar7,pcVar11);
  if (message == WM_LBUTTONDOWN) {
    local_30._20_2_ = 0;
  }
  else {
    local_30._20_2_ = 2;
  }
  TrackPopupMenu(HVar8,local_30._20_2_ | 4,local_16._2_2_,local_16._4_2_,0,hwnd,(RECT *)0x0);
  DestroyMenu(HVar8);
  for (local_16._0_2_ = 0; (int)local_16 < 6; local_16._0_2_ = (int)local_16 + 1) {
    DestroyMenu(local_3a[(int)local_16]);
  }
  uVar18 = 0x14f8;
  BVar10 = PeekMessage(&msg,hwnd,0x111,0x111,2);
  puVar14 = &stack0xffaa;
  if (((BVar10 != 0) && (14999 < msg.wParam)) && (msg.wParam < 0x3afc)) {
    iPopMenuSel = msg.wParam + 0xc568;
  }
  local_16._6_2_ = 0xffff;
  if (iPopMenuSel != -1) {
    if (iPopMenuSel == 0) {
      puVar16 = (undefined2 *)&vrgplrDef;
      pPVar15 = (PLAYER *)&vplr;
      for (iVar12 = 0x60; iVar12 != 0; iVar12 = iVar12 + -1) {
        pPVar2 = pPVar15;
        pPVar15 = &pPVar15->cPlanet;
        puVar1 = puVar16;
        puVar16 = puVar16 + 1;
        uVar18 = *puVar1;
        pPVar2->iPlayer = (char)uVar18;
        pPVar2->cShDef = (char)((uint)uVar18 >> 8);
      }
      CchGetString(idsHumanoid,(char *)vplr.szName);
      _wsprintf(vplr.szNames,(char *)0x11200ae0,0x501a,0x1120);
      uVar18 = 0x10e0;
      sVar23 = RaceCreationWizard(hwnd,0,0);
      if (sVar23 == 0) goto LAB_1078_9035;
CREATE_PlaceNew:
      if (vcplrNew < 0x10) {
        local_16._6_2_ = vcplrNew;
        vcplrNew = vcplrNew + 1;
      }
      else {
        for (local_16._6_2_ = 0xf; -1 < (int)local_16._6_2_; local_16._6_2_ = local_16._6_2_ - 1) {
          local_16._0_2_ = 0;
          while (((int)local_16 < 0x10 &&
                 (((((byte *)vrgplrTypeNew)[(int)local_16] & 3) != 2 ||
                  (((int)(uint)((byte *)vrgplrTypeNew)[(int)local_16] >> 2 & 0xfU) !=
                   local_16._6_2_))))) {
            local_16._0_2_ = (int)local_16 + 1;
          }
          if ((int)local_16 == 0x10) break;
        }
      }
      pPVar17 = vrgplrNew + local_16._6_2_;
      pPVar15 = (PLAYER *)&vplr;
      for (iVar12 = 0x60; iVar12 != 0; iVar12 = iVar12 + -1) {
        pPVar3 = pPVar17;
        pPVar17 = &pPVar17->cPlanet;
        pPVar2 = pPVar15;
        pPVar15 = &pPVar15->cPlanet;
        cVar5 = pPVar2->cShDef;
        pPVar3->iPlayer = pPVar2->iPlayer;
        pPVar3->cShDef = cVar5;
      }
      uVar18 = 0x1118;
      _strcpy(vrgszFileNew + local_16._6_2_ * 0xd,(char *)&szRaceFile);
      local_16._6_2_ = local_16._6_2_ << 2 | 2;
    }
    else {
LAB_1078_9035:
      if (iPopMenuSel == 1) {
        uVar18 = 0x1020;
        sVar23 = FOpenGame(hwnd,1);
        if (0 < sVar23) goto CREATE_PlaceNew;
      }
      else if (iPopMenuSel == 2) {
        iVar12 = iCurVal >> 2;
        if ((iCurVal & 3U) == 1) {
          puVar16 = (undefined2 *)(iVar12 * 0xc0 + vrgplrDef);
          pPVar15 = (PLAYER *)&vplr;
          for (iVar13 = 0x60; iVar13 != 0; iVar13 = iVar13 + -1) {
            pPVar2 = pPVar15;
            pPVar15 = &pPVar15->cPlanet;
            puVar1 = puVar16;
            puVar16 = puVar16 + 1;
            uVar18 = *puVar1;
            pPVar2->iPlayer = (char)uVar18;
            pPVar2->cShDef = (char)((uint)uVar18 >> 8);
          }
          CchGetString(iVar12 + idsHumanoid,(char *)vplr.szName);
          _wsprintf(vplr.szNames,(char *)0x11200ae4,0x501a,0x1120);
        }
        else {
          pPVar15 = vrgplrNew + iVar12;
          pPVar17 = (PLAYER *)&vplr;
          for (iVar13 = 0x60; iVar13 != 0; iVar13 = iVar13 + -1) {
            pPVar3 = pPVar17;
            pPVar17 = &pPVar17->cPlanet;
            pPVar2 = pPVar15;
            pPVar15 = &pPVar15->cPlanet;
            cVar5 = pPVar2->cShDef;
            pPVar3->iPlayer = pPVar2->iPlayer;
            pPVar3->cShDef = cVar5;
          }
          _strcpy((char *)&szRaceFile,vrgszFileNew + iVar12 * 0xd);
        }
        lSaltCur._0_2_ = (int)vplr.lSalt;
        lSaltCur._2_2_ = vplr.lSalt._2_2_;
        lSaltLast._0_2_ = 0;
        lSaltLast._2_2_ = 0;
        uVar18 = 0x1040;
        sVar23 = FCheckPassword();
        if (sVar23 == 0) goto CREATE_FinishClick;
        if (((int)vplr.lSalt == 0) && (vplr.lSalt._2_2_ == 0)) {
          szRacePass = 0;
        }
        else {
          _strcpy((char *)&szRacePass,(char *)szPassLast);
        }
        uVar18 = 0x10e0;
        sVar23 = RaceCreationWizard(hwnd,0,0);
        if (sVar23 != 0) {
          if (((iCurVal & 3U) == 1) ||
             (pRVar24 = vrgrcRCW,
             sVar23 = _strcmp((char *)&szRaceFile,
                                      vrgszFileNew + iVar12 * 0xd), sVar23 != 0))
          goto CREATE_PlaceNew;
          pPVar17 = vrgplrNew + iVar12;
          pPVar15 = (PLAYER *)&vplr;
          for (iVar13 = 0x60; iVar13 != 0; iVar13 = iVar13 + -1) {
            pPVar3 = pPVar17;
            pPVar17 = &pPVar17->cPlanet;
            pPVar2 = pPVar15;
            pPVar15 = &pPVar15->cPlanet;
            cVar5 = pPVar2->cShDef;
            pPVar3->iPlayer = pPVar2->iPlayer;
            pPVar3->cShDef = cVar5;
          }
          uVar18 = 0x1118;
          _strcpy(vrgszFileNew + iVar12 * 0xd,(char *)&szRaceFile);
          vrgrcRCW = pRVar24;
          local_16._6_2_ = iCurVal;
          iCurVal = -1;
        }
      }
      else if (iPopMenuSel == 3) {
        local_16._6_2_ = 0;
      }
      else if ((iPopMenuSel < 0x10) || (0x1f < iPopMenuSel)) {
        if ((iPopMenuSel < 0x20) || (0x2f < iPopMenuSel)) {
          if (0x2f < iPopMenuSel) {
            local_16._6_2_ = (iPopMenuSel + -0x30) * 4 | 3;
          }
        }
        else {
          local_16._6_2_ = (iPopMenuSel + -0x20) * 4 | 2;
        }
      }
      else {
        local_16._6_2_ = (iPopMenuSel + -0x10) * 4 | 1;
      }
    }
  }
  puVar14 = &stack0xffaa;
  if ((local_16._6_2_ != 0xffff) && (puVar14 = &stack0xffaa, local_16._6_2_ != iCurVal)) {
    ((byte *)vrgplrTypeNew)[iDiamond] = (byte)local_16._6_2_;
    if (local_16._6_2_ == 0) {
      while (iDiamond + 1 < 0x10) {
        ((byte *)vrgplrTypeNew + 1)[iDiamond] = 0;
        iDiamond = iDiamond + 1;
      }
    }
    else if (0 < iDiamond) {
      while ((-1 < iDiamond + -1 &&
             (*(char *)((int)(short **)&vrgiflMerge + iDiamond + 1) == '\0'))) {
        *(byte *)((int)(short **)&vrgiflMerge + iDiamond + 1) = (byte)local_16._6_2_;
        iDiamond = iDiamond + -1;
      }
    }
    uVar18 = 0x14f8;
    InvalidateRect(hwnd,(RECT *)0x0,1);
    puVar14 = &stack0xffac;
  }
CREATE_FinishClick:
  *(HWND *)(puVar14 + -2) = hwnd;
  *(undefined2 *)(puVar14 + -4) = uVar18;
  *(undefined2 *)(puVar14 + -6) = 0x93fe;
  SetFocus(*(HWND *)(puVar14 + -2));
  return 0;
}



// ======================================================================
// Function: DrawNewGame2
// Address: 1078:9556
// Segment: MEMORY_CREATE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x107897f8) */
/* WARNING: Removing unreachable block (ram,0x10789791) */
/* WARNING: Removing unreachable block (ram,0x10789894) */

void DrawNewGame2(HWND hwnd,HDC hdc,short iDraw)

{
  byte bVar1;
  short sVar2;
  char *pcVar3;
  int iVar4;
  short sVar5;
  uint uVar6;
  uint uVar7;
  ushort uVar8;
  char *pcVar9;
  undefined2 unaff_SS;
  bool bVar10;
  DWORD DVar11;
  char *pcVar12;
  undefined2 uVar13;
  undefined2 uVar14;
  HDC HVar15;
  undefined2 uVar16;
  undefined2 uVar17;
  char local_34 [18];
  StringId local_22;
  RECT rc;
  RECT rcDiamond;
  short cch;
  short bkMode;
  short iPlr;
  short i;
  short yCur;
  short fCreatedDC;
  
  bVar10 = hdc == 0;
  if (bVar10) {
    hdc = GetDC(hwnd);
  }
  GetClientRect(hwnd,&rc);
  sVar2 = SetBkMode(hdc,1);
  SelectObject(hdc,rghfontArial8[1]);
  HVar15 = hdc;
  pcVar3 = PszGetCompressedString(idsPlayer16);
  DVar11 = GetTextExtent(HVar15,pcVar3,0xb);
  xNewGameDiamond = (int)DVar11 + 0xc;
  yCur = 6;
  SetRect(&rcDiamond,xNewGameDiamond,6,xNewGameDiamond + dyArial8 + 1,
          dyArial8 + 7);
  for (i = 0; (i < 0x10 && ((fRCWReadOnly == 0 || (i < game.cPlayer)))); i = i + 1)
  {
    iVar4 = i + 1;
    pcVar3 = PszGetCompressedString(idsPlayerD);
    sVar5 = _wsprintf(szWork,pcVar3,iVar4);
    ((char *)szWork)[sVar5] = ':';
    ((char *)szWork + 1)[sVar5] = '\0';
    RightTextOut
              (hdc,xNewGameDiamond + -6,yCur,(char *)szWork,sVar5 + 1,0);
    DrawDiamond(hdc,&rcDiamond,hbrBBlue);
    uVar6 = (int)(uint)((byte *)vrgplrTypeNew)[i] >> 2;
    uVar7 = uVar6 & 0xf;
    if (fRCWReadOnly == 0) {
      bVar1 = ((byte *)vrgplrTypeNew)[i] & 3;
      if ((((byte *)vrgplrTypeNew)[i] & 3) == 0) {
        CchGetString(idsPlayer2,(char *)szWork);
      }
      else if (bVar1 == 1) {
        if (uVar7 < 6) {
          CchGetString(idsS,local_34);
          pcVar3 = PszGetCompressedString(uVar7 + idsHumanoid);
          _wsprintf(szWork,local_34,pcVar3,0x1120);
        }
        else {
          if (uVar7 == 6) {
            local_22 = idsRandom;
          }
          else {
            local_22 = idsExpansionPlayer;
          }
          CchGetString(local_22,(char *)szWork);
        }
      }
      else if (bVar1 == 2) {
        if (((gd.grBits2._2_2_ >> 6 & 1) == 0) ||
           (vrgszFileNew[uVar7 * 0xd] == '\0')) {
          if (vrgszFileNew[uVar7 * 0xd] == '\0') {
            pcVar9 = vrgplrNew[uVar7].szNames;
            uVar13 = 0x1120;
            pcVar3 = PszGetCompressedString(idsS);
            _wsprintf(szWork,pcVar3,pcVar9,uVar13);
          }
          else {
            pcVar9 = vrgszFileNew + uVar7 * 0xd;
            uVar16 = 0x1120;
            pcVar12 = vrgplrNew[uVar7].szNames;
            uVar13 = 0x1120;
            pcVar3 = PszGetCompressedString(idsSS2);
            _wsprintf(szWork,pcVar3,pcVar12,uVar13,pcVar9,uVar16);
          }
        }
        else {
          _wsprintf(szWork,(char *)0x11200aee,vrgszFileNew + uVar7 * 0xd,0x1120)
          ;
        }
      }
      else if (bVar1 == 3) {
        uVar13 = *(undefined2 *)(((int)(uint)((byte *)vrgplrTypeNew)[i] >> 5) * 2 + 0xaae)
        ;
        uVar17 = 0x1120;
        uVar16 = *(undefined2 *)((uVar6 & 7) * 2 + vrgszComputerPlayers);
        uVar14 = 0x1120;
        pcVar3 = PszGetCompressedString(idsSSComputerPlayer);
        _wsprintf(szWork,pcVar3,uVar16,uVar14,uVar13,uVar17);
      }
    }
    else if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) == 0) {
      CchGetString(idsUnknownPlayer,(char *)szWork);
    }
    else {
      PszPlayerName(i,1,1,1,0,(PLAYER *)0x0);
      if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) != 0) {
        pcVar3 = PszGetCompressedString(idsDeceased);
        uVar13 = 0x1120;
        pcVar9 = (char *)0xae8;
        uVar8 = _strlen((char *)szWork);
        _wsprintf((char *)szWork + uVar8,(char *)CONCAT22(uVar13,pcVar9),pcVar3);
        SetTextColor(hdc,0x7f);
      }
    }
    iVar4 = rcDiamond.right + 6;
    uVar13 = 0x1120;
    pcVar3 = (char *)szWork;
    sVar5 = yCur;
    HVar15 = hdc;
    uVar8 = _strlen((char *)szWork);
    TextOut(HVar15,iVar4,sVar5,(LPCSTR)CONCAT22(uVar13,pcVar3),uVar8);
    SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
    OffsetRect(&rcDiamond,0,dyArial8 + 4);
    yCur = yCur + dyArial8 + 4;
  }
  SetBkMode(hdc,sVar2);
  if (bVar10) {
    ReleaseDC(hwnd,hdc);
  }
  return;
}



// ======================================================================
// Function: NewGameDlg3
// Address: 1078:99f4
// Segment: MEMORY_CREATE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short NewGameDlg3(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  POINT pt;
  POINT pt_00;
  WPARAM WVar1;
  HWND HVar2;
  short sVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar4;
  LRESULT LVar5;
  UINT UVar6;
  ushort in_stack_0000ffd0;
  POINT local_12;
  RECT rc;
  short i;
  
  uVar4 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    local_12.y = BeginPaint(hwnd,&stack0xffd0);
    DrawNewGame3(hwnd,local_12.y,-1);
    EndPaint(hwnd,&stack0xffd0);
    sVar3 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    sVar3 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      for (i = 0x123; i < 0x12a; i = i + 1) {
        local_12.y = (HWND)lParam;
        HVar2 = GetDlgItem(hwnd,i);
        if (local_12.y == HVar2) break;
      }
      if ((i < 0x12a) || (uVar4 = __aFulshr(uVar4,in_stack_0000ffd0), (int)uVar4 == 6)) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else if (message == WM_SETCURSOR) {
      GetCursorPos(&local_12);
      ScreenToClient(hwnd,&local_12);
      pt.y = local_12.y;
      pt.x = local_12.x;
      sVar3 = IrcRaceDlgHitTest(pt);
      if (-1 < sVar3) {
        setcursor(hcurHand);
        return 1;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        SetNGWTitle(hwnd,3);
        for (i = 0; i < 7; i = i + 1) {
          HVar2 = GetDlgItem(hwnd,i + 0x123);
          UVar6 = 0x401;
          WVar1 = GetVCCheck((GAME *)&game,(uint)(1 < i) + i);
          SendMessage(HVar2,UVar6,WVar1,0);
          if (fRCWReadOnly != 0) {
            HVar2 = GetDlgItem(hwnd,i + 0x123);
            EnableWindow(HVar2,0);
          }
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyNewDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        if (wParam == 0x76) {
          WinHelp(hwnd,_szHelpFile,1,0x3fd);
          return 1;
        }
        i = 0;
        while ((i < 4 && (wParam != *(ushort *)((ushort_0_ *)&rgidRaceBtn + i * 2)))) {
          i = i + 1;
        }
        if (i < 4) {
          StickyDlgPos(hwnd,(POINT *)&ptStickyNewDlg,0);
          EndDialog(hwnd,i);
          return 1;
        }
        if ((0x122 < wParam) && (wParam < 0x12a)) {
          HVar2 = GetDlgItem(hwnd,wParam);
          LVar5 = SendMessage(HVar2,0x400,0,0);
          SetVCCheck((GAME *)&game,(wParam - 0x123) + (uint)(1 < wParam - 0x123),(short)LVar5
                    );
          DrawNewGame3(hwnd,0,8);
        }
      }
      else if ((message == WM_LBUTTONDOWN) || (message == WM_LBUTTONDBLCLK)) {
        local_12.x = (HWND)lParam;
        uVar4 = __aFulshr(uVar4,in_stack_0000ffd0);
        local_12.y = (short)uVar4;
        pt_00.y = local_12.y;
        pt_00.x = local_12.x;
        sVar3 = FTrackNewGameDlg3(hwnd,pt_00,wParam);
        return sVar3;
      }
    }
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: DrawNewGame3
// Address: 1078:9d5e
// Segment: MEMORY_CREATE
// ======================================================================


void DrawNewGame3(HWND hwnd,HDC hdc,short iDraw)

{
  uint uVar1;
  short sVar2;
  HWND HVar3;
  short sVar4;
  int iVar5;
  RECT *pRVar6;
  RECT *pRVar7;
  undefined2 unaff_SS;
  bool bVar8;
  COLORREF CVar9;
  DWORD DVar10;
  DWORD DVar11;
  RECT rc;
  short cch;
  short xLeft;
  short dxDig;
  short bkMode;
  COLORREF crBkSav;
  short j;
  RECT rcCBox;
  short dxItem;
  short i;
  short fCreatedDC;
  short ids;
  short irc;
  short vcCur;
  short bt;
  short yTop;
  
  if (fRCWReadOnly == 0) {
    uVar1 = 0;
  }
  else {
    uVar1 = 4;
  }
  bVar8 = hdc == 0;
  if (bVar8) {
    hdc = GetDC(hwnd);
  }
  GetClientRect(hwnd,&rc);
  sVar2 = SetBkMode(hdc,2);
  CVar9 = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  SelectObject(hdc,rghfontArial8[1]);
  DVar10 = GetTextExtent(hdc,(LPCSTR)0x11200af2,1);
  ids = 0x3aa;
  irc = 0;
  vcCur = 0;
  i = 0;
  do {
    if (8 < i) {
      crcRCW = irc;
      SetBkColor(hdc,CVar9);
      SetBkMode(hdc,sVar2);
      if (bVar8) {
        ReleaseDC(hwnd,hdc);
      }
      return;
    }
    if (i < 7) {
      HVar3 = GetDlgItem(hwnd,i + 0x123);
      GetWindowRect(HVar3,&rcCBox);
      MapWindowPoints(0,hwnd,(POINT *)&rcCBox,2);
      xLeft = rcCBox.right + 2;
      yTop = ((rcCBox.bottom - rcCBox.top) / 2 + rcCBox.top) - (dyArial8 >> 1);
    }
    else if (i == 7) {
      xLeft = rcCBox.left;
      yTop = rcCBox.bottom + 6;
    }
    else {
      xLeft = rcCBox.left;
      yTop = rcCBox.bottom + 6 + (dyArial8 * 3) / 2;
    }
    sVar4 = CchGetString(ids,(char *)szWork);
    if (iDraw == -1) {
      TextOut(hdc,xLeft,yTop,szWork,sVar4);
    }
    DVar11 = GetTextExtent(hdc,szWork,sVar4);
    xLeft = xLeft + (int)DVar11;
    iVar5 = ids;
    for (j = 0; ids = iVar5 + 1, j < 2; j = j + 1) {
      sVar4 = _abs((int)((char (*) [2])rgNG3Width)[i][j]);
      dxItem = sVar4 * (int)DVar10;
      if (dxItem == 0) {
        ids = iVar5 + 2;
        break;
      }
      sVar4 = GetVCVal((GAME *)&game,vcCur,0);
      _wsprintf(szWork,PCTD,sVar4);
      if (((char (*) [2])rgNG3Width)[i][j] < '\0') {
        dxItem = dxItem + ((int)DVar10 * 3) / 2;
        _strcat((char *)szWork,(char *)0xaf4);
      }
      if (((iDraw == -1) || (iDraw == vcCur)) || (vcCur == 8)) {
        RightTextOut(hdc,xLeft + dxItem,yTop,(char *)szWork,0,dxItem);
      }
      vcCur = vcCur + 1;
      (vrgrcRCW + irc)->left = xLeft + dxItem + 4;
      vrgrcRCW[irc].top = yTop + -3;
      vrgrcRCW[irc].right = (vrgrcRCW + irc)->left + 0xf;
      vrgrcRCW[irc].bottom = (dyArial8 >> 1) + vrgrcRCW[irc].top + 3;
      pRVar6 = vrgrcRCW + irc;
      pRVar7 = vrgrcRCW + irc + 1;
      pRVar7->left = pRVar6->left;
      pRVar7->top = pRVar6->top;
      pRVar7->right = pRVar6->right;
      pRVar7->bottom = pRVar6->bottom;
      OffsetRect(vrgrcRCW + irc + 1,0,
                 (vrgrcRCW[irc].bottom - vrgrcRCW[irc].top) + -1);
      if (iDraw == -1) {
        DrawBtn(hdc,vrgrcRCW + irc,uVar1 | 0xa0,0,(char *)0x0);
        DrawBtn(hdc,vrgrcRCW + irc + 1,uVar1 | 0xa1,0,(char *)0x0);
      }
      iVar5 = vrgrcRCW[irc].right + 4;
      sVar4 = CchGetString(ids,(char *)szWork);
      if (iDraw == -1) {
        TextOut(hdc,iVar5,yTop,szWork,sVar4);
      }
      DVar11 = GetTextExtent(hdc,szWork,sVar4);
      xLeft = iVar5 + (int)DVar11;
      irc = irc + 2;
      iVar5 = ids;
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FTrackNewGameDlg3
// Address: 1078:a210
// Segment: MEMORY_CREATE
// ======================================================================


short FTrackNewGameDlg3(HWND hwnd,POINT pt,short kbd)

{
  uint uVar1;
  int vc;
  short sVar2;
  short sVar3;
  short iStat;
  short iMod;
  short dShift;
  short i;
  BTNT btnt;
  short irc;
  short bt;
  
  uVar1 = IrcRaceDlgHitTest(pt);
  if ((int)uVar1 < 0) {
    sVar2 = 0;
  }
  else {
    vc = (int)uVar1 >> 1;
    if ((uVar1 & 1) == 0) {
      dShift = 1;
      bt = 0xa0;
    }
    else {
      dShift = -1;
      bt = 0xa1;
    }
    InitBtnTrack(&btnt,hwnd,0,vrgrcRCW + uVar1,bt,0x50,0,0,(char *)0x0);
    if ((kbd & 0xcU) != 0) {
      dShift = dShift * 5;
    }
    while (sVar2 = FTrackBtn(&btnt), sVar2 != 0) {
      sVar2 = GetVCVal((GAME *)&game,vc,1);
      sVar3 = SetVCVal((GAME *)&game,vc,sVar2 + dShift);
      if (sVar3 != sVar2) {
        DrawNewGame3(hwnd,btnt.hdc,vc);
      }
    }
    sVar2 = 1;
  }
  return sVar2;
}



// ======================================================================
// Function: SetNGWTitle
// Address: 1078:a320
// Segment: MEMORY_CREATE
// ======================================================================


void SetNGWTitle(HWND hwnd,short iStep)

{
  undefined2 unaff_SS;
  char szBuf [50];
  short cch;
  
  CchGetString(fRCWReadOnly + idsAdvancedNewGameWizardStepD3,szBuf);
  _wsprintf(szWork,szBuf,iStep);
  SetWindowText(hwnd,szWork);
  return;
}



// ======================================================================
// Function: LpplrComp
// Address: 1078:b570
// Segment: MEMORY_CREATE
// ======================================================================


PLAYER * LpplrComp(short idAi,short lvlAi)

{
  return ((PLAYER (*) [4])vrgplrComp)[idAi] + lvlAi;
}



// ======================================================================
// Function: SetVCCheck
// Address: 1078:b5bc
// Segment: MEMORY_CREATE
// ======================================================================


void SetVCCheck(GAME *pgame,short vc,short fChecked)

{
  byte bVar1;
  
  if (fChecked == 0) {
    bVar1 = 0;
  }
  else {
    bVar1 = 0x80;
  }
  pgame->rgvc[vc] = pgame->rgvc[vc] & 0x7f | bVar1;
  return;
}



// ======================================================================
// Function: GetVCCheck
// Address: 1078:b60c
// Segment: MEMORY_CREATE
// ======================================================================


short GetVCCheck(GAME *pgame,short vc)

{
  return (uint)((pgame->rgvc[vc] & 0x80) != 0);
}



// ======================================================================
// Function: SetVCVal
// Address: 1078:b644
// Segment: MEMORY_CREATE
// ======================================================================


short SetVCVal(GAME *pgame,short vc,short val)

{
  short sVar1;
  short cur;
  
  if (val < 0) {
    val = 0;
  }
  else if (((short *)vrgvcMax)[vc] < val) {
    val = ((short *)vrgvcMax)[vc];
  }
  pgame->rgvc[vc] = pgame->rgvc[vc] & 0x80 | (byte)val;
  if ((vc == 8) && (sVar1 = GetVCVal(pgame,8,0), sVar1 != val)) {
    pgame->rgvc[8] = pgame->rgvc[8] & 0x80 | (byte)sVar1;
    val = sVar1;
  }
  return val;
}



// ======================================================================
// Function: GetVCVal
// Address: 1078:b710
// Segment: MEMORY_CREATE
// ======================================================================


short GetVCVal(GAME *pgame,short vc,short fRaw)

{
  uint uVar1;
  short val;
  short i;
  short c;
  
  uVar1 = pgame->rgvc[vc] & 0x7f;
  if (fRaw == 0) {
    switch(vc) {
    case 0:
      uVar1 = uVar1 * 5 + 0x14;
      break;
    case 1:
      uVar1 = uVar1 + 8;
      break;
    case 2:
      uVar1 = uVar1 + 2;
      break;
    case 3:
      uVar1 = uVar1 * 1000 + 1000;
      break;
    case 4:
      uVar1 = uVar1 * 10 + 0x14;
      break;
    case 5:
    case 6:
      uVar1 = uVar1 * 10 + 10;
      break;
    case 7:
      uVar1 = uVar1 * 10 + 0x1e;
      break;
    default:
      c = 0;
      for (i = 0; i < 8; i = i + 1) {
        if ((i != 2) && ((*(byte *)(i + 0x84) & 0x80) != 0)) {
          c = c + 1;
        }
      }
      if (c < (int)uVar1) {
        uVar1 = c;
      }
      break;
    case 9:
      uVar1 = uVar1 * 10 + 0x1e;
    }
  }
  return uVar1;
}



