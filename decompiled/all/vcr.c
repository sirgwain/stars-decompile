// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: BattleVCR
// Address: 10e8:0000
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lphb */

void BattleVCR(short iBattle)

{
  HB *pHVar1;
  short sVar2;
  char *sz;
  HB *lphb;
  short env [9];
  short (*penvMemSav) [9];
  undefined4 lpProc;
  
                    /* Segment:    30
                       Offset:     000cf8c0
                       Length:     49be
                       Min Alloc:  49be
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  lpProc._0_2_ = (void *)0x0;
  lpProc._2_2_ = 0;
  penvMemSav = penvMem;
  viStepVCRCur = -1;
  if ((uint)gd.grBits >> 0xe < 2) {
    dxyVCRBoard = 0x161;
    dxyVCRSquare = 0x20;
  }
  else {
    dxyVCRBoard = 0x2a1;
    dxyVCRSquare = 0x40;
  }
  lphb._0_2_ = pHRam11200d60;
  lphb._2_2_ = iRam11200d62;
  vlpbdVCR = (BTLDATA *)CONCAT22(iRam11200d62,&pHRam11200d60[1].cbBlock);
  while( true ) {
    while( true ) {
      if (vlpbdVCR->id == iBattle) {
        vlpbdVCRNext._0_2_ =
             (BTLDATA *)
             ((int)&((BTLDATA *)vlpbdVCR)->id + ((BTLDATA *)vlpbdVCR)->cbData);
        vlpbdVCRNext._2_2_ = vlpbdVCR._2_2_;
        penvMem = &env;
        gd.grBits._0_2_ = (uint)gd.grBits & 0xdfff;
        sVar2 = __setjmp(env);
        if (sVar2 == 0) {
          vrgtok =
               LpAlloc((uint)((BTLDATA *)vlpbdVCR)->ctok * 0x1d,htMisc);
          vrgdpVCR = LpAlloc((uint)((BTLDATA *)vlpbdVCR)->ctok << 2,htMisc)
          ;
          sVar2 = SetVCRBoard(30000);
          vcStepVCR = sVar2 + -1;
          vcRound = viRound;
          SetVCRBoard(-1);
          if (((uint)gd.grBits >> 0xb & 1) != 0) {
            AdvanceTutor();
          }
          lpProc = MakeProcInstance(VCRDlg,hInst);
          DialogBox(0,(LPCSTR)CONCAT22(0xa0,hwndFrame),(HWND)((ulong)lpProc >> 0x10),
                    (char)lpProc);
        }
        else {
          penvMem = penvMemSav;
          sVar2 = 0x10;
          sz = PszFormatIds(idsMemory,(short *)0x0);
          AlertSz(sz,sVar2);
        }
        if (lpProc != (FARPROC)0x0) {
          FreeProcInstance(lpProc);
        }
        if (vrgtok != (TOK *)0x0) {
          FreeLp(vrgtok,htMisc);
        }
        if (vrgdpVCR != (long *)0x0) {
          FreeLp(vrgdpVCR,htMisc);
        }
        vrgtok._2_2_ = 0;
        vrgtok._0_2_ = (TOK *)0x0;
        vrgdpVCR._2_2_ = 0;
        vrgdpVCR._0_2_ = (long *)0x0;
        return;
      }
      if (vlpbdVCR->id == 0xffff) break;
      vlpbdVCR =
           (BTLDATA *)
           CONCAT22(vlpbdVCR._2_2_,
                    (BTLDATA *)
                    ((int)&((BTLDATA *)vlpbdVCR)->id +
                    ((BTLDATA *)vlpbdVCR)->cbData));
    }
                    /* WARNING: Load size is inaccurate */
    pHVar1 = ((HB *)lphb)->lphbNext;
    lphb._2_2_ = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
    if ((pHVar1 == (HB *)0x0) && (lphb._2_2_ == 0)) break;
    vlpbdVCR = (BTLDATA *)CONCAT22(lphb._2_2_,&pHVar1[1].cbBlock);
    lphb._0_2_ = pHVar1;
  }
  gd.grBits._0_2_ = (uint)gd.grBits & 0xdfff;
  viStepVCRCur = -1;
  return;
}



// ======================================================================
// Function: CBattles
// Address: 10e8:028c
// Segment: MEMORY_VCR
// ======================================================================


short CBattles(void)

{
  HB *pHVar1;
  int iVar2;
  BTLDATA *pBVar3;
  undefined2 uVar4;
  short cBattles;
  HB *lphb;
  BTLDATA *lpbd;
  
  cBattles = 0;
  lphb = (HB *)CONCAT22(iRam11200d62,pHRam11200d60);
  if ((pHRam11200d60 == (HB *)0x0) && (iRam11200d62 == 0)) {
    cBattles = 0;
  }
  else {
    lpbd = (BTLDATA *)CONCAT22(iRam11200d62,&pHRam11200d60[1].cbBlock);
    while( true ) {
      while (lpbd->id != 0xffff) {
        uVar4 = (undefined2)((ulong)lpbd >> 0x10);
        pBVar3 = (BTLDATA *)lpbd;
        if (pBVar3->cbData == 0) {
          return cBattles;
        }
        cBattles = cBattles + 1;
        lpbd = (BTLDATA *)CONCAT22(uVar4,(BTLDATA *)((int)&pBVar3->id + pBVar3->cbData));
      }
      uVar4 = (undefined2)((ulong)lphb >> 0x10);
                    /* WARNING: Load size is inaccurate */
      pHVar1 = ((HB *)lphb)->lphbNext;
      iVar2 = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
      lphb = (HB *)CONCAT22(iVar2,pHVar1);
      if (((pHVar1 == (HB *)0x0) && (iVar2 == 0)) || (pHVar1->ibTop < 0x11)) break;
      lpbd = (BTLDATA *)CONCAT22(iVar2,&pHVar1[1].cbBlock);
    }
  }
  return cBattles;
}



// ======================================================================
// Function: BtlDataGet
// Address: 10e8:0362
// Segment: MEMORY_VCR
// ======================================================================


BTLDATA * BtlDataGet(short i)

{
  HB *pHVar1;
  int iVar2;
  BTLDATA *pBVar3;
  undefined2 uVar4;
  HB *lphb;
  BTLDATA *lpbd;
  
  lphb = (HB *)CONCAT22(iRam11200d62,pHRam11200d60);
  if ((pHRam11200d60 == (HB *)0x0) && (iRam11200d62 == 0)) {
    pBVar3 = (BTLDATA *)0x0;
    uVar4 = 0;
  }
  else {
    lpbd = (BTLDATA *)CONCAT22(iRam11200d62,&pHRam11200d60[1].cbBlock);
    while( true ) {
      while (lpbd->id != 0xffff) {
        uVar4 = (undefined2)((ulong)lpbd >> 0x10);
        pBVar3 = (BTLDATA *)lpbd;
        if (pBVar3->cbData == 0) {
          pBVar3 = (BTLDATA *)0x0;
          uVar4 = 0;
          goto LAB_10e8_0449;
        }
        if (i < 1) goto LAB_10e8_0449;
        i = i + -1;
        lpbd = (BTLDATA *)CONCAT22(uVar4,(BTLDATA *)((int)&pBVar3->id + pBVar3->cbData));
      }
      uVar4 = (undefined2)((ulong)lphb >> 0x10);
                    /* WARNING: Load size is inaccurate */
      pHVar1 = ((HB *)lphb)->lphbNext;
      iVar2 = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
      lphb = (HB *)CONCAT22(iVar2,pHVar1);
      if (((pHVar1 == (HB *)0x0) && (iVar2 == 0)) || (pHVar1->ibTop < 0x11)) break;
      lpbd = (BTLDATA *)CONCAT22(iVar2,&pHVar1[1].cbBlock);
    }
    pBVar3 = (BTLDATA *)0x0;
    uVar4 = 0;
  }
LAB_10e8_0449:
  return (BTLDATA *)CONCAT22(uVar4,pBVar3);
}



// ======================================================================
// Function: CBattleUnits
// Address: 10e8:0450
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Type propagation algorithm not settling */

long CBattleUnits(BTLDATA *lpbd,ushort grbitBU)

{
  byte bVar1;
  int iVar2;
  uint uVar3;
  BTLDATA *pBVar4;
  int iVar5;
  undefined2 uVar6;
  bool bVar7;
  HULDEF *pHVar8;
  short imd;
  short i;
  uint lUnits;
  int local_c;
  short ctok;
  TOK *lptok;
  
  uVar6 = (undefined2)((ulong)lpbd >> 0x10);
  pBVar4 = (BTLDATA *)lpbd;
  bVar1 = pBVar4->ctok;
  lUnits = 0;
  local_c = 0;
  i = 0;
  do {
    if ((int)(uint)bVar1 <= i) {
      return CONCAT22(local_c,lUnits);
    }
    iVar2 = i * 0x1d;
    if ((uint)*(byte *)((int)pBVar4 + iVar2 + 0x10) == idPlayer) {
      uVar3 = grbitBU & 1;
    }
    else {
      uVar3 = grbitBU & 2;
    }
    if ((uVar3 != 0) && (((grbitBU & 4) != 0 || (*(byte *)((int)pBVar4 + iVar2 + 0x12) < 0x10)))) {
      if (((grbitBU & 0xf8) != 0xf8) && (*(byte *)((int)pBVar4 + iVar2 + 0x12) < 0x10)) {
        iVar5 = (uint)*(byte *)((int)pBVar4 + iVar2 + 0x10) * 4;
        pHVar8 = LphuldefFromId
                           (*(HullDef *)
                             (*(int *)(iVar5 + rglpshdef) +
                             (uint)*(byte *)((int)pBVar4 + iVar2 + 0x12) * 0x93));
        uVar3 = ((HULDEF *)pHVar8)->wFlags_0x7b >> 10 & 0xf;
        if ((uVar3 < 2) || (5 < uVar3)) {
          uVar3 = grbitBU & 8;
        }
        else if (uVar3 == 2) {
          uVar3 = grbitBU & 0x10;
        }
        else if (uVar3 == 3) {
          uVar3 = grbitBU & 0x20;
        }
        else if (uVar3 == 5) {
          uVar3 = grbitBU & 0x40;
        }
        else {
          if (uVar3 != 4) goto LAB_10e8_0600;
          uVar3 = grbitBU & 0x80;
        }
        if (uVar3 == 0) goto LAB_10e8_0610;
      }
LAB_10e8_0600:
      uVar3 = *(uint *)((int)pBVar4 + iVar2 + 0x21);
      bVar7 = CARRY2(lUnits,uVar3);
      lUnits = lUnits + uVar3;
      local_c = local_c + (uint)bVar7;
    }
LAB_10e8_0610:
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: CBattleKills
// Address: 10e8:062e
// Segment: MEMORY_VCR
// ======================================================================


long CBattleKills(BTLDATA *lpbd,short fOurDead)

{
  uint uVar1;
  undefined2 uVar2;
  bool bVar3;
  short cKill;
  BTLREC *lpbr;
  short i;
  uint cKilled;
  int local_6;
  
  lpbr = (BTLREC *)
         CONCAT22(lpbd._2_2_,
                  (BTLREC *)((int)(BTLDATA *)lpbd + (uint)((BTLDATA *)lpbd)->ctok * 0x1d + 0xe));
  cKilled = 0;
  local_6 = 0;
  while ((BTLREC *)lpbr < (BTLREC *)((int)&((BTLDATA *)lpbd)->id + ((BTLDATA *)lpbd)->cbData)) {
    uVar2 = (undefined2)((ulong)lpbr >> 0x10);
    for (i = 0; i < ((BTLREC *)lpbr)->ctok; i = i + 1) {
      if (*(int *)((int)(BTLREC *)lpbr + i * 8 + 8) != 0) {
        if ((uint)*(byte *)((int)(BTLDATA *)lpbd +
                           (uint)*(byte *)((int)(BTLREC *)lpbr + i * 8 + 6) * 0x1d + 0x10) ==
            idPlayer) {
          if (fOurDead != 0) {
            uVar1 = *(uint *)((int)(BTLREC *)lpbr + i * 8 + 8);
            bVar3 = CARRY2(cKilled,uVar1);
            cKilled = cKilled + uVar1;
            local_6 = local_6 + (uint)bVar3;
          }
        }
        else if (fOurDead == 0) {
          uVar1 = *(uint *)((int)(BTLREC *)lpbr + i * 8 + 8);
          bVar3 = CARRY2(cKilled,uVar1);
          cKilled = cKilled + uVar1;
          local_6 = local_6 + (uint)bVar3;
        }
      }
    }
    lpbr = (BTLREC *)
           CONCAT22(uVar2,(BTLREC *)((int)(BTLREC *)lpbr + ((BTLREC *)lpbr)->ctok * 8 + 6));
  }
  return CONCAT22(local_6,cKilled);
}



// ======================================================================
// Function: LdpFromItokDv
// Address: 10e8:07a8
// Segment: MEMORY_VCR
// ======================================================================


long LdpFromItokDv(short itok,DV *lpdv)

{
  uint uVar1;
  SHDEF *pSVar2;
  ulong uVar3;
  ulong uVar4;
  long lVar5;
  ulong uVar6;
  long lVar7;
  short csh;
  ushort dpShdef;
  DV dv;
  
  if (((DV *)lpdv == (DV *)0x0) && (lpdv._2_2_ == 0)) {
    dv.dp = 0;
  }
  else {
    dv = (DV)lpdv->dp;
  }
  pSVar2 = LpshdefFromTok
                     ((TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok + itok));
  uVar1 = (((SHDEF *)pSVar2)->hul).dp;
  uVar3 = __aFulmul((ulong)uVar1,(ulong)((TOK *)vrgtok)[itok].csh);
  if (dv.dp != 0) {
    lVar5 = 100;
    uVar4 = __aFulmul((ulong)((TOK *)vrgtok)[itok].csh,(ulong)dv.dp & 0xffff007f);
    lVar5 = __aFldiv(uVar4,lVar5);
    csh = (short)lVar5;
    if (csh < 1) {
      csh = 1;
    }
    lVar7 = 0x32;
    uVar6 = (ulong)csh;
    lVar5 = 10;
    uVar4 = __aFulmul((ulong)uVar1,(ulong)(dv.dp >> 7));
    uVar4 = __aFldiv(uVar4,lVar5);
    uVar4 = __aFulmul(uVar4,uVar6);
    lVar5 = __aFldiv(uVar4,lVar7);
    uVar3 = uVar3 - lVar5;
  }
  return uVar3;
}



// ======================================================================
// Function: SetVCRBoard
// Address: 10e8:08d8
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Variable defined which should be unmapped: itok */
/* WARNING: Removing unreachable block (ram,0x10e80bd4) */

short SetVCRBoard(short iStep)

{
  ushort *puVar1;
  TOK *pTVar2;
  uint itok_00;
  int iVar3;
  BTLDATA *pBVar4;
  BTLREC *pBVar5;
  TOK *pTVar6;
  ushort *puVar7;
  long *plVar8;
  undefined2 uVar9;
  undefined2 uVar10;
  long lVar11;
  ulong uVar12;
  ulong uVar13;
  short itok;
  short i;
  TOK *ptok;
  
  if ((iStep != viStepVCRCur) || (viStepVCRCur == -1)) {
    if ((iStep < viStepVCRCur) || (viStepVCRCur == -1)) {
      i = 0;
      while( true ) {
        uVar9 = (undefined2)((ulong)vlpbdVCR >> 0x10);
        pBVar4 = (BTLDATA *)vlpbdVCR;
        uVar10 = vrgtok._2_2_;
        if ((int)(uint)pBVar4->ctok <= i) break;
        puVar7 = (ushort *)((int)pBVar4 + i * 0x1d + 0xe);
        pTVar6 = (TOK *)vrgtok + i;
        for (iVar3 = 0xe; iVar3 != 0; iVar3 = iVar3 + -1) {
          pTVar2 = pTVar6;
          pTVar6 = &pTVar6->iplr;
          puVar1 = puVar7;
          puVar7 = puVar7 + 1;
          pTVar2->id = *puVar1;
        }
        *&pTVar6->id = (char)*puVar7;
        lVar11 = LdpFromItokDv(i,(DV *)CONCAT22(vrgtok._2_2_,
                                                &((TOK *)vrgtok)[i].dv));
        uVar10 = vrgdpVCR._2_2_;
        plVar8 = (long *)vrgdpVCR + i;
        *(int *)plVar8 = (int)lVar11;
        *(undefined2 *)((int)plVar8 + 2) = (int)((ulong)lVar11 >> 0x10);
        i = i + 1;
      }
      viStepVCRCur = -1;
      viRound = 0;
      viVCRFocus = 0;
      vbrcVCRFocus = ((TOK *)vrgtok)->brc;
      vlpbrVCR =
           (BTLREC *)CONCAT22(uVar9,(BTLREC *)((int)pBVar4 + (uint)pBVar4->ctok * 0x1d + 0xe));
    }
    while ((viStepVCRCur < iStep &&
           ((BTLREC *)vlpbrVCR < (BTLDATA *)vlpbdVCRNext))) {
      if (-1 < viStepVCRCur) {
        i = 0;
        while( true ) {
          uVar9 = (undefined2)((ulong)vlpbrVCR >> 0x10);
          pBVar5 = (BTLREC *)vlpbrVCR;
          pTVar6 = (TOK *)vrgtok;
          uVar10 = vrgtok._2_2_;
          if (pBVar5->ctok <= i) break;
          itok_00 = (uint)*(byte *)((int)pBVar5 + i * 8 + 6);
          ((TOK *)vrgtok)[itok_00].csh =
               ((TOK *)vrgtok)[itok_00].csh - *(int *)((int)pBVar5 + i * 8 + 8);
          (&pTVar6[itok_00].dv)->dp = *(ushort *)((int)(BTLREC *)vlpbrVCR + i * 8 + 0xc);
          lVar11 = LdpFromItokDv(itok_00,(DV *)CONCAT22(vlpbrVCR._2_2_,
                                                        (DV *)((int)(BTLREC *)vlpbrVCR +
                                                              i * 8 + 0xc)));
          uVar9 = vrgdpVCR._2_2_;
          plVar8 = (long *)vrgdpVCR + itok_00;
          *(int *)plVar8 = (int)lVar11;
          *(undefined2 *)((int)plVar8 + 2) = (int)((ulong)lVar11 >> 0x10);
          if (pTVar6[itok_00].dpShield != 0) {
            if (*(int *)((int)(BTLREC *)vlpbrVCR + i * 8 + 10) != 0) {
              uVar12 = __aFulmul((ulong)pTVar6[itok_00].dpShield,(ulong)pTVar6[itok_00].csh)
              ;
              lVar11 = __aFlshl(uVar12,itok_00);
              if (lVar11 < (long)uVar12) {
                uVar13 = (ulong)pTVar6[itok_00].csh;
                lVar11 = __aFlshl(uVar13,(ushort)uVar12);
                lVar11 = __aFldiv(lVar11,uVar13);
                pTVar6[itok_00].dpShield = pTVar6[itok_00].dpShield - (int)lVar11;
              }
              else {
                pTVar6[itok_00].dpShield = 0;
              }
            }
          }
          i = i + 1;
        }
        pBVar5 = (BTLREC *)((int)pBVar5 + pBVar5->ctok * 8 + 6);
        vlpbrVCR = (BTLREC *)CONCAT22(uVar9,pBVar5);
        if ((uint)viRound < (pBVar5->wFlags_0x4 & 0xf)) {
          viRound = pBVar5->wFlags_0x4 & 0xf;
          ptok = vrgtok;
          for (i = 0; i < (int)(uint)((BTLDATA *)vlpbdVCR)->ctok; i = i + 1) {
            uVar10 = (undefined2)((ulong)ptok >> 0x10);
            pTVar6 = (TOK *)ptok;
            if ((pTVar6->wFlags >> 3 & 1) != 0) {
              RegenShield(ptok);
            }
            pTVar6->wFlags = pTVar6->wFlags & 0xffef;
            ptok = (TOK *)CONCAT22(uVar10,pTVar6 + 1);
          }
        }
      }
      if ((BTLREC *)vlpbrVCR < (BTLDATA *)vlpbdVCRNext) {
        ((TOK *)vrgtok)[vlpbrVCR->itok].brc =
             ((BTLREC *)vlpbrVCR)->brcDest;
        vbrcVCRFocus = ((TOK *)vrgtok)[vlpbrVCR->itok].brc;
        viVCRFocus = (short)vlpbrVCR->itok;
        ((TOK *)vrgtok)[vlpbrVCR->itok].wFlags =
             ((TOK *)vrgtok)[vlpbrVCR->itok].wFlags & 0xfc1f |
             (((BTLREC *)vlpbrVCR)->wFlags_0x4 >> 4 & 0xf) << 5;
        if ((((TOK *)vrgtok)[vlpbrVCR->itok].wFlags >> 5 & 0x1f) == 4) {
          ((TOK *)vrgtok)[vlpbrVCR->itok].wFlags_0x17 =
               ((TOK *)vrgtok)[vlpbrVCR->itok].wFlags_0x17 & 0xf0ff;
        }
      }
      viStepVCRCur = viStepVCRCur + 1;
    }
    EnableVCRButtons();
    iStep = viStepVCRCur;
  }
  return iStep;
}



// ======================================================================
// Function: VCRDlg
// Address: 10e8:0e90
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short VCRDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  POINT PVar1;
  POINT PVar2;
  POINT PVar3;
  HWND HVar4;
  BOOL BVar5;
  int iVar6;
  char *pcVar7;
  short sVar8;
  UINT UVar9;
  byte brc;
  ushort unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar10;
  undefined2 unaff_SS;
  ulong uVar11;
  undefined1 uVar12;
  undefined1 uVar13;
  ushort in_stack_0000ffc0;
  undefined1 btnt [24];
  COLORREF crBkSav;
  short iCur;
  short iDir;
  short dx;
  undefined1 rcWindow [2];
  short bkMode;
  uint pt;
  uint pt__22;
  short dyFrame;
  RECT rc;
  short ibtn;
  short i;
  HDC hdc;
  
  if (message == WM_DESTROY) {
    hwndVCRDlg = 0;
    return 0;
  }
  uVar12 = (undefined1)unaff_SS;
  uVar13 = (undefined1)((uint)unaff_SS >> 8);
  if (message == WM_PAINT) {
    hdc = BeginPaint(hwnd,btnt + 0xc);
    DrawVCR(hdc,-1,-1);
    EndPaint(hwnd,(PAINTSTRUCT *)CONCAT13(uVar13,CONCAT12(uVar12,btnt + 0xc)));
    return 1;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    return 1;
  }
  if (message == WM_SETCURSOR) {
    GetCursorPos((POINT *)CONCAT13(uVar13,CONCAT12(uVar12,&stack0xffea)));
    ScreenToClient(hwnd,&stack0xffea);
    if ((((8 < (int)pt__22) && ((int)pt__22 < (dxyVCRSquare + 3) * 10 + 8)) &&
        (7 < dyFrame)) && (dyFrame < (dxyVCRSquare + 3) * 10 + 8)) {
      setcursor(hcurHand);
      return 1;
    }
    return 0;
  }
  if (message == WM_INITDIALOG) {
    hwndVCRDlg = hwnd;
    GetWindowRect(hwnd,rcWindow);
    GetClientRect(hwnd,&rc);
    dyFrame = (pt__22 - bkMode) - rc.bottom;
    HVar4 = GetDlgItem(hwnd,0xa1);
    GetWindowRect(HVar4,&rc);
    SetWindowPos(hwnd,0,0,0,dxyVCRBoard + 0xfa,
                 dyFrame + 0x18 + dxyVCRBoard + (rc.bottom - rc.top),6);
    for (i = 0; i < 7; i = i + 1) {
      if (i < 5) {
        ibtn = i + 0xa1;
      }
      else if (i == 5) {
        ibtn = 1;
      }
      else if (i == 6) {
        ibtn = 0x76;
      }
      HVar4 = GetDlgItem(hwnd,ibtn);
      GetWindowRect(HVar4,&rc);
      MapWindowPoints(0,hwnd,(POINT *)&rc,2);
      if (dxyVCRSquare < 0x40) {
        dx = 0;
      }
      else {
        iDir = ((rc.right - rc.left) + 8) * i;
        iCur = ((rc.right - rc.left) * 7) / 2;
        dx = ((dxyVCRBoard / 2 - iCur) + -0x10 + iDir) - rc.left;
      }
      OffsetRect((RECT *)CONCAT13(uVar13,CONCAT12(uVar12,&rc)),dx,
                 (dxyVCRBoard + 0x10) - rc.top);
      HVar4 = GetDlgItem(hwnd,ibtn);
      SetWindowPos(HVar4,0,rc.left,rc.top,0,0,5);
    }
    EnableVCRButtons();
    StickyDlgPos(hwnd,(POINT *)&ptStickyVCRDlg,1);
    fAnimate = 1;
    return 1;
  }
  if (message == WM_COMMAND) {
    if ((wParam < 0xa1) || (0xa5 < wParam)) {
      if ((wParam != 1) && (wParam != 2)) {
        if (wParam != 0x76) {
          return 0;
        }
        WinHelp(hwnd,_szHelpFile,1,0x43a);
        return 1;
      }
      if (((uint)gd.grBits >> 0xd & 1) != 0) {
        gd.grBits._0_2_ = (uint)gd.grBits & 0xdfff;
        KillTimer(hwnd,0xa6c);
      }
      if (((uint)gd.grBits >> 0xb & 1) != 0) {
        tutor.wFlags = tutor.wFlags & 0xfbffU | 0x400;
      }
      StickyDlgPos(hwnd,(POINT *)&ptStickyVCRDlg,0);
      EndDialog(hwnd,i);
      return 1;
    }
    i = wParam - 0xa1;
    if (((uint)gd.grBits >> 0xd & 1) != 0) {
VCR_KillTime:
      KillTimer(hwnd,0xa6c);
      gd.grBits._0_2_ = (uint)gd.grBits & 0xdfff;
      if (i == 2) {
        return 0;
      }
    }
    sVar8 = GetAsyncKeyState(0x11);
    if (sVar8 < 0) {
      pt__22 = 100;
    }
    else {
      sVar8 = GetAsyncKeyState(0x10);
      if (sVar8 < 0) {
        pt__22 = 10;
      }
      else {
        pt__22 = 1;
      }
    }
    fAnimate = 0;
    if (i == 0) {
      dyFrame = -1;
      goto LAB_10e8_1807;
    }
    if (i == 1) {
      dyFrame = viStepVCRCur - pt__22;
      if (dyFrame < -1) {
        dyFrame = -1;
      }
      goto LAB_10e8_1807;
    }
    if (i == 2) {
      UVar9 = SetTimer(0xa6c,viSpeedVCR * -0x78 + 0x23a,0,0);
      pt = (uint)(UVar9 != 0);
      gd.grBits._0_2_ = (uint)gd.grBits & 0xdfff | pt << 0xd;
    }
    else if (i != 3) {
      if (i == 4) {
        dyFrame = vcStepVCR;
      }
      goto LAB_10e8_1807;
    }
  }
  else {
    if (message != WM_TIMER) {
      if ((message != WM_LBUTTONDOWN) && (message != WM_RBUTTONDOWN)) {
        return 0;
      }
      pt = (short)lParam;
      uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc0);
      pt__22 = (uint)uVar11;
      PVar1.y = pt__22;
      PVar1.x = pt;
      BVar5 = PtInRect(rgrcBuildSpin,PVar1);
      if ((BVar5 != 0) ||
         (PVar2.y = pt__22, PVar2.x = pt, BVar5 = PtInRect(rgrcBuildSpin + 1,PVar2),
         BVar5 != 0)) {
        PVar3.y = pt__22;
        PVar3.x = pt;
        BVar5 = PtInRect(rgrcBuildSpin,PVar3);
        if (BVar5 == 0) {
          iDir = 1;
          rcWindow = (undefined1  [2])0x23;
          dx = 0x592e;
        }
        else {
          iDir = -1;
          rcWindow = (undefined1  [2])0x22;
          dx = (short)rgrcBuildSpin;
        }
        iCur = viSpeedVCR;
        if (viSpeedVCR < 5) {
          if (viSpeedVCR < 0) {
            iCur = 0;
          }
        }
        else {
          iCur = 4;
        }
        hdc = GetDC(hwnd);
        bkMode = SetBkMode(hdc,2);
        crBkSav = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,
                                          (undefined2)crButtonFace));
        SelectObject(hdc,rghfontArial8[1]);
        InitBtnTrack(btnt,hwnd,0,(RECT *)dx,(short)rcWindow,0x50,0,0,(char *)0x0);
        while( true ) {
          sVar8 = FTrackBtn(btnt);
          if (sVar8 == 0) break;
          if (((iDir == -1) && (0 < iCur)) || ((iDir == 1 && (iCur < 4)))) {
            iCur = iCur + iDir;
            iVar6 = iCur + 1;
            pcVar7 = PszGetCompressedString(idsPlaybackSpeedD);
            rcWindow = (undefined1  [2])_wsprintf(szWork,pcVar7,(char)iVar6);
            TextOut(hdc,ptSpeedVCR.x,ptSpeedVCR.y,szWork,
                    (short)rcWindow);
          }
        }
        viSpeedVCR = iCur;
        SelectObject(hdc,rghfontArial8[0]);
        SetBkColor(hdc,crBkSav);
        ReleaseDC(hwnd,hdc);
        if (((uint)gd.grBits >> 0xd & 1) != 0) {
          KillTimer(hwnd,0xa6c);
          UVar9 = SetTimer(0xa6c,viSpeedVCR * -0x78 + 0x23a,0,0);
          gd.grBits._0_2_ = (uint)gd.grBits & 0xdfff | (uint)(UVar9 != 0) << 0xd;
        }
        return 1;
      }
      pt = (int)(pt + -8) / (dxyVCRSquare + 3);
      pt__22 = (int)(pt__22 + -8) / (dxyVCRSquare + 3);
      if ((((9 < (int)pt) && (1 < (int)pt__22)) && ((int)pt__22 < 10)) &&
         (-1 < viVCRFocus)) {
        GlobalPD.grPopup = 0xb;
        if (*&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 == '\x01') {
          bkMode = (*(byte *)((int)&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 + 1
                             ) - 0x10) * 0x93;
          iVar6 = (uint)((TOK *)vrgtok)[viVCRFocus].iplr * 4;
          GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = *(ushort *)(iVar6 + 0x14e);
          GlobalPD.u_POPUPDATA_0x0002.lpfl._0_2_ =
               (FLEET *)(*(int *)(iVar6 + rglpshdefSB) + bkMode);
        }
        else {
          bkMode = (uint)*(byte *)((int)&((TOK *)vrgtok)[viVCRFocus].
                                         u_TOK_0x0003 + 1) * 0x93;
          iVar6 = (uint)((TOK *)vrgtok)[viVCRFocus].iplr * 4;
          GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = *(ushort *)(iVar6 + 0x100);
          GlobalPD.u_POPUPDATA_0x0002.lpfl._0_2_ =
               (FLEET *)(*(int *)(iVar6 + rglpshdef) + bkMode);
        }
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = 1;
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = 1;
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate =
             (short)((uint)((TOK *)vrgtok)[viVCRFocus].iplr != idPlayer);
        uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc0);
        Popup(hwnd,(short)lParam,(short)uVar11);
        return 0;
      }
      if ((int)pt < 0) {
        return 0;
      }
      if ((int)pt__22 < 0) {
        return 0;
      }
      if (9 < (int)pt) {
        return 0;
      }
      if (9 < (int)pt__22) {
        return 0;
      }
      brc = (byte)((pt__22 & 0xf) << 4) | (byte)pt & 0xf;
      dyFrame = CONCAT11(dyFrame._1_1_,brc);
      if (message == WM_RBUTTONDOWN) {
        uVar11 = __aFulshr(CONCAT22(unaff_DI,(uint)brc),unaff_SI);
        bkMode = PopupVCRMenu(hwnd,(short)lParam,(short)uVar11,brc);
        if (bkMode < 0) {
          return 0;
        }
        vbrcVCRFocus = (byte)dyFrame;
        viVCRFocus = bkMode;
      }
      else {
        uVar10 = (undefined2)((ulong)vlpbdVCR >> 0x10);
        if ((brc != vbrcVCRFocus) || (viVCRFocus == -1)) {
          viVCRFocus = ((BTLDATA *)vlpbdVCR)->ctok - 1;
          vbrcVCRFocus = brc;
        }
        i = viVCRFocus;
        do {
          i = i + 1;
          if (i == (uint)((BTLDATA *)vlpbdVCR)->ctok) {
            i = 0;
          }
          bkMode = (short)((TOK *)vrgtok)[i].brc;
          if ((bkMode == (uint)brc) && (((TOK *)vrgtok)[i].csh != 0)) {
            viVCRFocus = i;
            goto VCR_GoodSel;
          }
        } while (i != viVCRFocus);
        viVCRFocus = -1;
      }
VCR_GoodSel:
      DrawVCR(0,-2,-1);
      return 0;
    }
    if (((uint)gd.grBits >> 0xd & 1) == 0) {
      return 0;
    }
    if (viStepVCRCur == vcStepVCR) {
      i = 2;
      goto VCR_KillTime;
    }
  }
  if (i == 3) {
    dyFrame = viStepVCRCur + pt__22;
  }
  else {
    dyFrame = viStepVCRCur + 1;
  }
  if (vcStepVCR < dyFrame) {
    dyFrame = vcStepVCR;
  }
  fAnimate = (short)(viSpeedVCR < 4);
LAB_10e8_1807:
  SetVCRBoard(dyFrame);
  DrawVCR(0,-2,-1);
  return 0;
}



// ======================================================================
// Function: GetVCRStats
// Address: 10e8:193e
// Segment: MEMORY_VCR
// ======================================================================


void GetVCRStats(short itok,long *pdpArmor,DV *pdv,long *pdpShields,short *pcsh)

{
  undefined2 uVar1;
  undefined2 uVar2;
  uint uVar3;
  int iVar4;
  BTLREC *pBVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar6;
  long lVar7;
  SHDEF *pSVar8;
  ulong uVar9;
  ulong uVar10;
  long lVar11;
  ulong uVar12;
  ulong uVar13;
  long lVar14;
  ushort in_stack_0000ffe8;
  ushort dpShdef;
  short cshKill;
  short i;
  undefined2 dpArmor;
  undefined2 local_e;
  undefined2 dpShields;
  undefined2 local_a;
  DV dv;
  short cshT;
  
  lVar14 = CONCAT22(unaff_SI,unaff_DI);
  uVar12 = 0;
  cshKill = 0;
  dv.dp = 0xffff;
  uVar1 = (undefined2)((long *)vrgdpVCR)[itok];
  uVar2 = *(undefined2 *)((int)((long *)vrgdpVCR + itok) + 2);
  lVar11 = CONCAT22(uVar2,uVar1);
  i = 0;
  while( true ) {
    uVar6 = (undefined2)((ulong)vlpbrVCR >> 0x10);
    pBVar5 = (BTLREC *)vlpbrVCR;
    if (pBVar5->ctok <= i) break;
    if ((uint)*(byte *)((int)pBVar5 + i * 8 + 6) == itok) {
      cshKill = cshKill + *(int *)((int)pBVar5 + i * 8 + 8);
      lVar7 = __aFlshl(lVar14,in_stack_0000ffe8);
      uVar12 = lVar7 + uVar12;
      dv.dp = *(ushort *)((int)(BTLREC *)vlpbrVCR + i * 8 + 0xc);
    }
    i = i + 1;
  }
  if (dv.dp == 0xffff) {
    dv.dp = (&((TOK *)vrgtok)[itok].dv)->dp;
    if (499 < dv.dp >> 7) {
      dv.dp = dv.dp & 0x7f | 0xf980;
      lVar11 = CONCAT22(uVar2,uVar1);
    }
  }
  else {
    pSVar8 = LpshdefFromTok
                       ((TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok + itok));
    uVar3 = (((SHDEF *)pSVar8)->hul).dp;
    iVar4 = ((TOK *)vrgtok)[itok].csh - cshKill;
    uVar9 = __aFulmul((ulong)uVar3,(long)iVar4);
    lVar11 = 100;
    uVar10 = __aFulmul((long)iVar4,(ulong)dv.dp & 0xffff007f);
    lVar11 = __aFldiv(uVar10,lVar11);
    cshT = (short)lVar11;
    if (cshT < 1) {
      cshT = 1;
    }
    lVar14 = 0x32;
    uVar13 = (ulong)cshT;
    lVar11 = 10;
    uVar10 = __aFulmul((ulong)uVar3,(ulong)(dv.dp >> 7));
    uVar10 = __aFldiv(uVar10,lVar11);
    uVar10 = __aFulmul(uVar10,uVar13);
    lVar11 = __aFldiv(uVar10,lVar14);
    lVar11 = uVar9 - lVar11;
  }
  cshT = ((TOK *)vrgtok)[itok].csh - cshKill;
  if (cshT < 1) {
    cshT = 0;
    lVar11 = 0;
    uVar12 = __aFulmul((ulong)((TOK *)vrgtok)[itok].dpShield,
                               (ulong)((TOK *)vrgtok)[itok].csh);
  }
  local_e = (undefined2)((ulong)lVar11 >> 0x10);
  dpArmor = (undefined2)lVar11;
  local_a = (undefined2)(uVar12 >> 0x10);
  dpShields = (undefined2)uVar12;
  if (pdv != (DV *)0x0) {
    pdv->dp = dv.dp;
  }
  if (pcsh != (short *)0x0) {
    *pcsh = cshT;
  }
  if (pdpArmor != (long *)0x0) {
    *(undefined2 *)pdpArmor = dpArmor;
    *(undefined2 *)((int)pdpArmor + 2) = local_e;
  }
  if (pdpShields != (long *)0x0) {
    *(undefined2 *)pdpShields = dpShields;
    *(undefined2 *)((int)pdpShields + 2) = local_a;
  }
  return;
}



// ======================================================================
// Function: DrawVCR
// Address: 10e8:1c62
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10e82ebd) */

void DrawVCR(HDC hdc,short iStart,short iEnd)

{
  int iVar1;
  int iVar2;
  int iVar3;
  char *pcVar4;
  uint uVar5;
  ushort uVar6;
  char *pcVar7;
  uint uVar8;
  StringId ids;
  short sVar9;
  BTLREC *pBVar10;
  int iVar11;
  undefined2 unaff_SS;
  bool bVar12;
  DWORD DVar13;
  ulong uVar14;
  long lVar15;
  short sVar16;
  HDC HVar17;
  undefined2 uVar18;
  undefined2 uVar19;
  short cshNew;
  short xT;
  uint dpT;
  uint dpShT;
  DV dv;
  short cshT;
  short x;
  RECT rc;
  short fJam;
  char szT [96];
  short j;
  short dx;
  char *psz;
  short csh;
  short ibmp;
  int lpshdef;
  undefined2 local_126;
  byte brcT;
  short i;
  short c;
  char rgfSeen [256];
  short y;
  uint dpArmor;
  int local_1a;
  short fCreatedDC;
  uint dpT__22;
  int local_14;
  short itokT;
  uint dpShields;
  int local_e;
  HBRUSH hbrSav;
  short bkMode;
  short ibmpRace;
  short ctok;
  
  fCreatedDC = (short)(hdc == 0);
  if (fCreatedDC != 0) {
    hdc = GetDC(hwndVCRDlg);
  }
  hbrSav = SelectObject(hdc,hbrButtonFace);
  bkMode = SetBkMode(hdc,1);
  _memset(rgfSeen,0,0x100);
  GetClientRect(hwndVCRDlg,&rc);
  if (iStart == -2) {
    PatBlt(hdc,dxyVCRBoard + 10,0,(rc.right - dxyVCRBoard) + -10,
           dxyVCRBoard + 8,0xf00021);
    iStart = -1;
  }
  SelectObject(hdc,hbrButtonShadow);
  if (iStart == -1) {
    PatBlt(hdc,8,8,dxyVCRBoard,2,0xf00021);
    PatBlt(hdc,8,8,2,dxyVCRBoard,0xf00021);
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,9,dxyVCRBoard + 6,dxyVCRBoard + -1,1,0xf00021);
    PatBlt(hdc,8,dxyVCRBoard + 7,dxyVCRBoard,1,0xf00021);
    PatBlt(hdc,dxyVCRBoard + 6,9,1,dxyVCRBoard + -3,0xf00021);
    PatBlt(hdc,dxyVCRBoard + 7,8,1,dxyVCRBoard + -2,0xf00021);
    SelectObject(hdc,hbrButtonShadow);
    for (i = 1; i < 10; i = i + 1) {
      PatBlt(hdc,(dxyVCRSquare + 3) * i + 9,10,1,dxyVCRBoard + -4,0xf00021);
      PatBlt(hdc,10,(dxyVCRSquare + 3) * i + 9,dxyVCRBoard + -4,1,0xf00021);
    }
    x = dxyVCRBoard + 0xe;
    y = 8;
    SelectObject(hdc,rghfontArial8[1]);
    iVar11 = vcRound + 1;
    iVar1 = viRound + 1;
    iVar2 = vcStepVCR + 2;
    iVar3 = viStepVCRCur + 2;
    pcVar4 = PszGetCompressedString(idsPhaseDDRoundDD);
    c = _wsprintf(szWork,pcVar4,iVar3,iVar2,iVar1,iVar11);
    TextOut(hdc,x,y,szWork,c);
    y = y + dyArial8 + 4;
    iVar11 = viSpeedVCR + 1;
    pcVar4 = PszGetCompressedString(idsPlaybackSpeedD);
    c = _wsprintf(szWork,pcVar4,iVar11);
    DVar13 = GetTextExtent(hdc,szWork,c);
    dx = (short)DVar13;
    TextOut(hdc,x,y,szWork,c);
    ptSpeedVCR.x = x;
    ptSpeedVCR.y = y;
    SetRect(rgrcBuildSpin,x + dx,y,x + dx + 0xe,y + 0xe);
    rgrcBuildSpin[1].left = rgrcBuildSpin[0].left;
    rgrcBuildSpin[1].top = rgrcBuildSpin[0].top;
    rgrcBuildSpin[1].right = rgrcBuildSpin[0].right;
    rgrcBuildSpin[1].bottom = rgrcBuildSpin[0].bottom;
    OffsetRect(rgrcBuildSpin + 1,0xe,0);
    for (i = 0; i < 2; i = i + 1) {
      if (i == 0) {
        uVar5 = 2;
      }
      else {
        uVar5 = 3;
      }
      DrawBtn(hdc,(RECT *)rgrcBuildSpin + i,uVar5 | 0x20,0,(char *)0x0);
    }
    if (-1 < viStepVCRCur) {
      y = y + dyArial8 + 4;
      psz = PszPlayerName((uint)((TOK *)vrgtok)[vlpbrVCR->itok].iplr,1,1,1
                                ,0,(PLAYER *)0x0);
      uVar18 = 0x1120;
      pcVar4 = (char *)szWork;
      sVar16 = y;
      sVar9 = x;
      HVar17 = hdc;
      uVar6 = _strlen(psz);
      TextOut(HVar17,sVar9,sVar16,(LPCSTR)CONCAT22(uVar18,pcVar4),uVar6);
      y = y + dyArial8;
      if ((uint)vlpbrVCR->itok == viVCRFocus) {
        SetTextColor(hdc,0x7f0000);
      }
      if (*&((TOK *)vrgtok)[vlpbrVCR->itok].u_TOK_0x0003 == '\x01') {
        cshT = (*(byte *)((int)&((TOK *)vrgtok)[vlpbrVCR->itok].u_TOK_0x0003 + 1
                         ) - 0x10) * 0x93;
        iVar11 = (uint)((TOK *)vrgtok)[vlpbrVCR->itok].iplr * 4;
        local_126 = *(undefined2 *)(iVar11 + 0x14e);
        lpshdef = *(int *)(iVar11 + rglpshdefSB) + cshT;
      }
      else {
        cshT = (uint)*(byte *)((int)&((TOK *)vrgtok)[vlpbrVCR->itok].
                                     u_TOK_0x0003 + 1) * 0x93;
        iVar11 = (uint)((TOK *)vrgtok)[vlpbrVCR->itok].iplr * 4;
        local_126 = *(undefined2 *)(iVar11 + 0x100);
        lpshdef = *(int *)(iVar11 + rglpshdef) + cshT;
      }
      uVar6 = ((TOK *)vrgtok)[vlpbrVCR->itok].csh;
      csh = uVar6;
      if ((int)uVar6 < 2) {
        __fstrcpy(szWork,(char *)CONCAT22(local_126,(char *)(lpshdef + 8)));
        c = _strlen((char *)szWork);
      }
      else {
        iVar11 = lpshdef + 8;
        uVar18 = local_126;
        pcVar4 = PszGetCompressedString(idsSD);
        c = _wsprintf(szWork,pcVar4,iVar11,uVar18,uVar6);
      }
      TextOut(hdc,x,y,szWork,c);
      y = y + dyArial8;
      SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      fJam = 0;
      uVar18 = (undefined2)((ulong)vlpbrVCR >> 0x10);
      if (0 < ((BTLREC *)vlpbrVCR)->ctok) {
        pcVar4 = PszPlayerName((uint)((TOK *)vrgtok)
                                           [((BTLREC *)vlpbrVCR)->wFlags_0x4 >> 8].iplr,0,
                                     1,1,0,(PLAYER *)0x0);
        uVar18 = 0x1120;
        psz = pcVar4;
        pcVar7 = PszGetCompressedString(idsAttacksS);
        c = _wsprintf(szT,pcVar7,pcVar4,uVar18);
        TextOut(hdc,x,y,szT,c);
        y = y + dyArial8;
        iVar11._0_1_ = ((BTLREC *)vlpbrVCR + 2)->itok;
        iVar11._1_1_ = ((BTLREC *)vlpbrVCR + 2)->brcDest;
        if (iVar11 != 0) {
          SetTextColor(hdc,0x7f);
        }
        uVar18 = (undefined2)((ulong)vlpbrVCR >> 0x10);
        pBVar10 = (BTLREC *)vlpbrVCR;
        if (*&((TOK *)vrgtok)[pBVar10->wFlags_0x4 >> 8].u_TOK_0x0003 == '\x01') {
          dv.dp = (*(byte *)((int)&((TOK *)vrgtok)[pBVar10->wFlags_0x4 >> 8].u_TOK_0x0003
                            + 1) - 0x10) * 0x93;
          cshT = pBVar10->wFlags_0x4;
          iVar11 = (uint)((TOK *)vrgtok)[(uint)cshT >> 8].iplr * 4;
          local_126 = *(undefined2 *)(iVar11 + 0x14e);
          lpshdef = *(int *)(iVar11 + rglpshdefSB) + dv.dp;
        }
        else {
          dv.dp = (uint)*(byte *)((int)&((TOK *)vrgtok)[pBVar10->wFlags_0x4 >> 8].
                                        u_TOK_0x0003 + 1) * 0x93;
          cshT = pBVar10->wFlags_0x4;
          iVar11 = (uint)((TOK *)vrgtok)[(uint)cshT >> 8].iplr * 4;
          local_126 = *(undefined2 *)(iVar11 + 0x100);
          lpshdef = *(int *)(iVar11 + rglpshdef) + dv.dp;
        }
        uVar6 = ((TOK *)vrgtok)[pBVar10->wFlags_0x4 >> 8].csh;
        csh = uVar6;
        if ((int)uVar6 < 2) {
          __fstrcpy(szWork,(char *)CONCAT22(local_126,(char *)(lpshdef + 8)));
          c = _strlen((char *)szWork);
        }
        else {
          iVar11 = lpshdef + 8;
          uVar18 = local_126;
          pcVar4 = PszGetCompressedString(idsSD);
          c = _wsprintf(szWork,pcVar4,iVar11,uVar18,uVar6);
        }
        TextOut(hdc,x,y,szWork,c);
        y = y + dyArial8;
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        uVar18 = (undefined2)((ulong)vlpbrVCR >> 0x10);
        brcT = ((TOK *)vrgtok)[((BTLREC *)vlpbrVCR)->wFlags_0x4 >> 8].brc;
        dpArmor = 0;
        local_1a = 0;
        dpShields = 0;
        local_e = 0;
        j = 0;
        for (i = ((BTLREC *)vlpbrVCR)->ctok; 0 < i; i = i + -1) {
          itokT = (short)*(byte *)((int)(BTLREC *)vlpbrVCR + (i + -1) * 8 + 6);
          if ((itokT == ((BTLREC *)vlpbrVCR)->wFlags_0x4 >> 8) && (fJam == 0)) {
            fJam = *(byte *)((int)(BTLREC *)vlpbrVCR + (i + -1) * 8 + 7) & 0xc0;
          }
          j = j + *(int *)((int)(BTLREC *)vlpbrVCR + (i + -1) * 8 + 8);
          if (rgfSeen[itokT] == '\0') {
            rgfSeen[itokT] = '\x01';
            GetVCRStats(itokT,&dpT__22,(DV *)0x0,&dpShT,&cshT);
            uVar5 = *(uint *)((long *)vrgdpVCR + itokT);
            uVar8 = uVar5 - dpT__22;
            bVar12 = CARRY2(dpArmor,uVar8);
            dpArmor = dpArmor + uVar8;
            local_1a = local_1a +
                       ((*(uint *)((int)((long *)vrgdpVCR + itokT) + 2) - local_14) -
                       (uint)(uVar5 < dpT__22)) + (uint)bVar12;
            bVar12 = CARRY2(dpShields,dpShT);
            dpShields = dpShields + dpShT;
            local_e = local_e + dv.dp + (uint)bVar12;
          }
        }
        iVar11 = (int)(uint)brcT >> 4;
        uVar5 = brcT & 0xf;
        pcVar4 = PszGetCompressedString(idsDDDoing);
        c = _wsprintf(szWork,pcVar4,uVar5,iVar11);
        TextOut(hdc,x,y,szWork,c);
        y = y + dyArial8;
        if ((dpShields != 0) || (local_e != 0)) {
          CchGetString(idsAnd,szT);
          if ((local_1a < 0) || ((local_1a < 1 && (dpArmor == 0)))) {
            if (j < 1) {
              pcVar4 = (char *)0x1422;
              uVar18 = 0x1120;
            }
            else {
              pcVar4 = (char *)0x1420;
              uVar18 = 0x1120;
            }
          }
          else {
            pcVar4 = szT;
            uVar18 = unaff_SS;
          }
          uVar5 = dpShields;
          iVar11 = local_e;
          pcVar7 = PszGetCompressedString(idsLdDamageShieldsS);
          c = _wsprintf(szWork,pcVar7,uVar5,iVar11,pcVar4,uVar18);
          TextOut(hdc,x,y,szWork,c);
          y = y + dyArial8;
        }
        if ((dpArmor != 0) || (local_1a != 0)) {
          if (j < 1) {
            uVar18 = 0x2e;
          }
          else {
            uVar18 = 0x2c;
          }
          uVar5 = dpArmor;
          iVar11 = local_1a;
          pcVar4 = PszGetCompressedString(idsLdDamageArmorC);
          c = _wsprintf(szWork,pcVar4,uVar5,iVar11,uVar18);
          TextOut(hdc,x,y,szWork,c);
          y = y + dyArial8;
        }
        if (((((fJam & 0x40U) != 0) && (dpShields == 0)) && (local_e == 0)) &&
           ((dpArmor == 0 && (local_1a == 0)))) {
          pcVar4 = PszGetCompressedString(idsDamage3);
          uVar18 = 0x1120;
          sVar16 = y;
          sVar9 = x;
          HVar17 = hdc;
          psz = pcVar4;
          uVar6 = _strlen(pcVar4);
          TextOut(HVar17,sVar9,sVar16,(LPCSTR)CONCAT22(uVar18,pcVar4),uVar6);
          y = y + dyArial8;
        }
        if (0 < j) {
          sVar16 = j;
          pcVar4 = PszGetCompressedString(idsDestroyingDShip);
          c = _wsprintf(szWork,pcVar4,sVar16);
          if (j == 1) {
            _strcpy((char *)szWork + c,(char *)0x1424);
            c = c + 1;
          }
          else {
            _strcpy((char *)szWork + c,(char *)0x1426);
            c = c + 2;
          }
          TextOut(hdc,x,y,szWork,c);
          y = y + dyArial8;
        }
      }
      if (fJam != 0) {
        SetTextColor(hdc,0x7f);
        if ((((fJam & 0x40U) == 0) || (dpArmor != 0)) || (local_1a != 0)) {
          ids = idsTorpedoesDeflected;
        }
        else {
          ids = idsTorpedoesDeflected2;
        }
        c = CchGetString(ids,(char *)szWork);
        TextOut(hdc,x,y,szWork,c);
        y = y + dyArial8;
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      }
    }
    if (vbrcVCRFocus != 0xff) {
      y = 200;
      iVar11 = (int)(uint)vbrcVCRFocus >> 4;
      uVar5 = vbrcVCRFocus & 0xf;
      pcVar4 = PszGetCompressedString(idsSelectionDD);
      c = _wsprintf(szWork,pcVar4,uVar5,iVar11);
      TextOut(hdc,x,y,szWork,c);
      y = y + dyArial8;
      if (-1 < viVCRFocus) {
        csh = 0;
        psz = PszPlayerName((uint)((TOK *)vrgtok)[viVCRFocus].iplr,1,1,1,0
                                  ,(PLAYER *)0x0);
        c = _strlen(psz);
        TextOut(hdc,x,y,szWork,c);
        y = y + dyArial8;
        if (*&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 == '\x01') {
          iVar11 = (uint)((TOK *)vrgtok)[viVCRFocus].iplr * 4;
          local_126 = *(undefined2 *)(iVar11 + 0x14e);
          lpshdef = *(int *)(iVar11 + rglpshdefSB) +
                    (*(byte *)((int)&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 +
                              1) - 0x10) * 0x93;
        }
        else {
          iVar11 = (uint)((TOK *)vrgtok)[viVCRFocus].iplr * 4;
          local_126 = *(undefined2 *)(iVar11 + 0x100);
          lpshdef = *(int *)(iVar11 + rglpshdef) +
                    (uint)*(byte *)((int)&((TOK *)vrgtok)[viVCRFocus].
                                          u_TOK_0x0003 + 1) * 0x93;
        }
        csh = ((TOK *)vrgtok)[viVCRFocus].csh;
        GetVCRStats(viVCRFocus,&dpT,&dv,&dpShields,&cshT);
        sVar16 = cshT;
        cshT = csh - cshT;
        if ((csh < 2) && (cshT == 0)) {
          __fstrcpy(szWork,(char *)CONCAT22(local_126,(char *)(lpshdef + 8)));
          c = _strlen((char *)szWork);
        }
        else {
          iVar11 = lpshdef + 8;
          uVar18 = local_126;
          sVar9 = csh;
          pcVar4 = PszGetCompressedString(idsSD);
          c = _wsprintf(szWork,pcVar4,iVar11,uVar18,sVar9);
        }
        if (cshT != 0) {
          sVar9 = _wsprintf((char *)szWork + c,(char *)0x11201429,cshT);
          c = c + sVar9;
        }
        SetTextColor(hdc,0x7f0000);
        TextOut(hdc,x,y,szWork,c);
        y = y + dyArial8;
        iVar11 = (rc.right - (dxyVCRBoard + 0xe)) / 2 + x;
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        if (sVar16 < 1) {
          c = CchGetString(idsDead3,(char *)szWork);
          TextOut(hdc,x,y,szWork,c);
          y = y + dyArial8 * 5;
        }
        else {
          if (*&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 == '\x01') {
            i = 0;
          }
          else {
            i = (((TOK *)vrgtok)[viVCRFocus].wFlags_0x19 >> 8 & 0xf) + 1;
          }
          if (((TOK *)vrgtok)[viVCRFocus].initMin == 0xff) {
            uVar5 = 0;
          }
          else {
            uVar5 = (uint)((TOK *)vrgtok)[viVCRFocus].initMin;
          }
          pcVar4 = PszGetCompressedString(idsInitiativeD);
          c = _wsprintf(szWork,pcVar4,uVar5);
          TextOut(hdc,x,y,szWork,c);
          iVar1 = i * 3 + 0xca0;
          uVar18 = 0x1120;
          pcVar4 = PszGetCompressedString(idsMovementS);
          c = _wsprintf(szWork,pcVar4,iVar1,uVar18);
          TextOut(hdc,iVar11,y,szWork,c);
          y = y + dyArial8;
          uVar5 = dpT;
          uVar8 = dpShT;
          pcVar4 = PszGetCompressedString(idsArmorLd);
          c = _wsprintf(szWork,pcVar4,uVar5,uVar8);
          TextOut(hdc,x,y,szWork,c);
          if (dv.dp == 0) {
            c = CchGetString(idsDamageNone,(char *)szWork);
          }
          else {
            csh = csh - cshT;
            uVar19 = 0;
            uVar18 = 100;
            uVar14 = __aFulmul((ulong)(dv.dp & 0x7f),(long)csh);
            lVar15 = __aFldiv(uVar14,CONCAT22(uVar19,uVar18));
            csh = (short)lVar15;
            if (csh < 1) {
              csh = 1;
            }
            dpT = dv.dp / 0x280;
            if (dpT == 0) {
              dpT = 1;
            }
            dpShT = 0;
            SetTextColor(hdc,0x7f);
            if (*&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 == '\x01') {
              uVar5 = dpT;
              pcVar4 = PszGetCompressedString(idsDamageD);
              c = _wsprintf(szWork,pcVar4,uVar5);
            }
            else {
              iVar1 = csh >> 0xf;
              sVar9 = csh;
              uVar5 = dpT;
              pcVar4 = PszGetCompressedString(idsDamageLdD);
              c = _wsprintf(szWork,pcVar4,sVar9,iVar1,uVar5);
            }
          }
          TextOut(hdc,iVar11,y,szWork,c);
          SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText)
                      );
          y = y + dyArial8;
          uVar14 = __aFulmul((ulong)((TOK *)vrgtok)[viVCRFocus].dpShield
                                     ,(long)sVar16);
          iVar11 = ((int)(uVar14 >> 0x10) - local_e) - (uint)((uint)uVar14 < dpShields);
          if ((iVar11 < 1) && ((iVar11 < 0 || ((uint)uVar14 == dpShields)))) {
            c = CchGetString(idsShieldsNone,(char *)szWork);
          }
          else {
            uVar14 = __aFulmul((ulong)((TOK *)vrgtok)[viVCRFocus].
                                              dpShield,(long)sVar16);
            lVar15 = uVar14 - CONCAT22(local_e,dpShields);
            pcVar4 = PszGetCompressedString(idsShieldsLd);
            c = _wsprintf(szWork,pcVar4,(int)lVar15,(int)((ulong)lVar15 >> 0x10));
          }
          TextOut(hdc,x,y,szWork,c);
          y = y + dyArial8;
          if (((TOK *)vrgtok)[viVCRFocus].pctJam != 0) {
            uVar5 = (uint)((TOK *)vrgtok)[viVCRFocus].pctJam;
            pcVar4 = PszGetCompressedString(idsJammingD);
            c = _wsprintf(szWork,pcVar4,uVar5);
            TextOut(hdc,x,y,szWork,c);
            y = y + dyArial8;
          }
          if (*&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 != '\x01') {
            if (vbrcVCRFocus == 0xff) {
              i = 0x19e;
            }
            else {
              i = (((TOK *)vrgtok)[viVCRFocus].wFlags_0x17 >> 8 & 0xf) + 0x198;
            }
            if (i == 0x198) {
              CchGetString(idsTacticSDMoves,szT);
              uVar5 = ((TOK *)vrgtok)[viVCRFocus].wFlags >> 5 & 0x1f;
              pcVar4 = PszGetCompressedString(i);
              c = _wsprintf(szWork,szT,pcVar4,0x1120,uVar5);
            }
            else {
              CchGetString(idsTacticS,szT);
              pcVar4 = PszGetCompressedString(i);
              c = _wsprintf(szWork,szT,pcVar4,0x1120);
            }
            TextOut(hdc,x,y,szWork,c);
            y = y + dyArial8;
          }
          if (i != 0x19e) {
            CchGetString(idsPrimayTargetS,szT);
            i = (((TOK *)vrgtok)[viVCRFocus].wFlags_0x17 & 0xf) +
                idsNoneDisengage;
            pcVar4 = PszGetCompressedString(i);
            c = _wsprintf(szWork,szT,pcVar4,0x1120);
            TextOut(hdc,x,y,szWork,c);
            y = y + dyArial8;
            CchGetString(idsSecondaryTargetS,szT);
            i = (((TOK *)vrgtok)[viVCRFocus].wFlags_0x17 >> 4 & 0xf) +
                idsNoneDisengage;
            pcVar4 = PszGetCompressedString(i);
            c = _wsprintf(szWork,szT,pcVar4,0x1120);
            TextOut(hdc,x,y,szWork,c);
            y = y + dyArial8;
          }
        }
        SetRect(&rc,x,y + 4,x + dyArial8 + 4,y + dyArial8 + 8);
        DrawBtn(hdc,&rc,8,0,(char *)0x1430);
      }
    }
    iStart = 0;
    iEnd = 99;
  }
  for (i = iStart; i <= iEnd; i = i + 1) {
    x = i % 10;
    y = i / 10;
    PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * y + 10,
           dxyVCRSquare + 2,1,0x42);
    PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * y + 10,1,
           dxyVCRSquare + 2,0x42);
    PatBlt(hdc,(dxyVCRSquare + 3) * x + dxyVCRSquare + 0xb,
           (dxyVCRSquare + 3) * y + 10,1,dxyVCRSquare + 2,0x42);
    PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,
           (dxyVCRSquare + 3) * y + dxyVCRSquare + 0xb,
           dxyVCRSquare + 2,1,0x42);
    ctok = 0;
    ibmp = -1;
    dpT__22 = 0;
    local_14 = 0;
    for (j = 0; j < (int)(uint)((BTLDATA *)vlpbdVCR)->ctok; j = j + 1) {
      cshT = (short)((TOK *)vrgtok)[j].brc;
      if ((cshT == ((y & 0xfU) << 4 | x & 0xfU)) && (((TOK *)vrgtok)[j].csh != 0)) {
        ctok = ctok + 1;
        bVar12 = CARRY2(dpT__22,((TOK *)vrgtok)[j].csh);
        dpT__22 = dpT__22 + ((TOK *)vrgtok)[j].csh;
        local_14 = local_14 + (uint)bVar12;
        if ((ibmp == -1) || (j == viVCRFocus)) {
          if (*&((TOK *)vrgtok)[j].u_TOK_0x0003 == '\x01') {
            cshT = (*(byte *)((int)&((TOK *)vrgtok)[j].u_TOK_0x0003 + 1) - 0x10) * 0x93;
            iVar11 = (uint)((TOK *)vrgtok)[j].iplr * 4;
            ibmp = *(short *)(*(int *)(iVar11 + rglpshdefSB) + cshT + 0x32);
          }
          else {
            cshT = (uint)*(byte *)((int)&((TOK *)vrgtok)[j].u_TOK_0x0003 + 1) * 0x93;
            iVar11 = (uint)((TOK *)vrgtok)[j].iplr * 4;
            ibmp = *(short *)(*(int *)(iVar11 + rglpshdef) + cshT + 0x32);
          }
          ibmpRace = *(uint *)((int)&rgplr[0].wMdPlr +
                              (uint)((TOK *)vrgtok)[j].iplr * 0xc0) >> 3 & 0x1f;
        }
      }
    }
    if ((local_14 < 1) && ((local_14 < 0 || (dpT__22 < 0x7fff)))) {
      csh = dpT__22;
    }
    else {
      csh = 0x7fff;
    }
    if (ctok < 1) {
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * y + 10,
             dxyVCRSquare + 2,dxyVCRSquare + 2,0x42);
    }
    else {
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * y + 10,
             dxyVCRSquare + 2,1,0x42);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * y + 10,1,
             dxyVCRSquare + 2,0x42);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + dxyVCRSquare + 0xb,
             (dxyVCRSquare + 3) * y + 10,1,dxyVCRSquare + 2,0x42);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,
             (dxyVCRSquare + 3) * y + dxyVCRSquare + 0xb,
             dxyVCRSquare + 2,1,0x42);
      DrawFleetBitmap
                ((FLEET *)0x0,hdc,(dxyVCRSquare + 3) * x + 0xb,
                 (dxyVCRSquare + 3) * y + 0xb,0,ibmp,ctok,
                 (uint)(dxyVCRSquare < 0x40),ibmpRace,csh);
    }
    cshT = (short)vbrcVCRFocus;
    if (((cshT == ((y & 0xfU) << 4 | x & 0xfU)) && (viVCRFocus == -1)) ||
       ((-1 < viVCRFocus &&
        ((cshT = (short)((TOK *)vrgtok)[viVCRFocus].brc,
         cshT == ((y & 0xfU) << 4 | x & 0xfU) &&
         (((TOK *)vrgtok)[viVCRFocus].csh != 0)))))) {
      cshT = SelectObject(hdc,hbrBlue);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * y + 10,
             dxyVCRSquare + 1,2,0xf00021);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * y + 10,2,
             dxyVCRSquare + 1,0xf00021);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,
             (dxyVCRSquare + 3) * y + 10 + dxyVCRSquare,
             dxyVCRSquare + 1,2,0xf00021);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10 + dxyVCRSquare,
             (dxyVCRSquare + 3) * y + 10,2,dxyVCRSquare + 1,0xf00021);
      SelectObject(hdc,cshT);
    }
  }
  if (0 < ((BTLREC *)vlpbrVCR)->ctok) {
    AnimateAttack(hdc);
  }
  SetBkMode(hdc,bkMode);
  SelectObject(hdc,hbrSav);
  if (fCreatedDC != 0) {
    ReleaseDC(hwndVCRDlg,hdc);
  }
  return;
}



// ======================================================================
// Function: Delay
// Address: 10e8:3a3e
// Segment: MEMORY_VCR
// ======================================================================


void Delay(short ctick)

{
  uint uVar1;
  undefined2 ti;
  undefined2 local_16;
  uint local_14;
  uint local_12;
  uint dwTickCur;
  uint local_a;
  uint dwTickLast;
  uint local_6;
  
  ti = 0xc;
  local_16 = 0;
  TimerCount(0x10e8,&ti);
  dwTickLast = local_14;
  local_6 = local_12;
  while( true ) {
    TimerCount(0x14f8,&ti);
    dwTickCur = local_14;
    local_a = local_12;
    if (local_12 < local_6) {
      return;
    }
    if ((local_12 <= local_6) && (local_14 < dwTickLast)) break;
    uVar1 = (ctick >> 0xf) + local_6 + (uint)CARRY2(ctick,dwTickLast);
    if ((uVar1 <= local_12) && ((uVar1 < local_12 || (ctick + dwTickLast <= local_14)))) {
      return;
    }
  }
  return;
}



// ======================================================================
// Function: AnimateAttack
// Address: 10e8:3ac2
// Segment: MEMORY_VCR
// ======================================================================


void AnimateAttack(HDC hdc)

{
  uint uVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  int iVar5;
  int iVar6;
  int iVar7;
  int iVar8;
  HPEN HVar9;
  HDC HVar10;
  HBITMAP HVar11;
  HGDIOBJ HVar12;
  short sVar13;
  short sVar14;
  TOK *pTVar15;
  int iVar16;
  int iVar17;
  BTLREC *pBVar18;
  undefined2 uVar19;
  ulong uVar20;
  long lVar21;
  HBITMAP hbmpScreen;
  HBITMAP hbmpSav;
  HDC hdcMem;
  short x;
  int ptBeam2;
  int local_62;
  short fKill;
  short dx;
  short iFrame;
  undefined2 ti;
  undefined2 local_54;
  uint local_52;
  uint local_50;
  int ptLeft;
  int local_48;
  int ptTorp;
  int local_44;
  int ptSrc;
  int local_40;
  ushort grfWeapon;
  short iHit;
  int ptDest;
  int local_38;
  int ptRight;
  int local_34;
  short y;
  int ptRay1;
  int local_2e;
  short dy;
  int ptBase;
  int local_28;
  uint dwTickCur;
  uint local_24;
  short dxFrame;
  uint dwTickLast;
  uint local_1e;
  int ptTop;
  int local_1a;
  int ptRay2;
  int local_16;
  short dyFrame;
  short cFrame;
  int ptBeam1;
  int local_e;
  TOK *ptokAttack;
  TOK *ptokSrc;
  
  if (-1 < viStepVCRCur) {
    pTVar15 = (TOK *)vrgtok + vlpbrVCR->itok;
    ptokSrc = (TOK *)CONCAT22(vrgtok._2_2_,pTVar15);
    uVar1 = pTVar15->brc & 0xf;
    iVar2 = (int)(uint)pTVar15->brc >> 4;
    ptSrc = (dxyVCRSquare + 3) * uVar1 + dxyVCRSquare / 2 + 0xb;
    local_40 = (dxyVCRSquare + 3) * iVar2 + dxyVCRSquare / 2 + 0xb;
    iVar3 = (dxyVCRSquare + 3) * uVar1 + dxyVCRSquare / 2 + 0xb;
    local_48 = (dxyVCRSquare + 3) * iVar2 + dxyVCRSquare / 2 + 0xb;
    iVar2 = dxyVCRSquare / 3 + local_48;
    local_1a = local_48 - dxyVCRSquare / 3;
    ptLeft = iVar3 - dxyVCRSquare / 3;
    ptRight = dxyVCRSquare / 3 + iVar3;
    iHit = 0;
    local_34 = local_48;
    ptTop = iVar3;
    do {
      grfWeapon = (ushort)*(byte *)((int)(BTLREC *)vlpbrVCR + iHit * 8 + 7);
      iFrame = iHit;
      while ((iFrame = iFrame + 1, iFrame < ((BTLREC *)vlpbrVCR)->ctok &&
             (*(char *)((int)(BTLREC *)vlpbrVCR + iFrame * 8 + 6) ==
              *(char *)((int)(BTLREC *)vlpbrVCR + iHit * 8 + 6)))) {
        grfWeapon = grfWeapon | *(byte *)((int)(BTLREC *)vlpbrVCR + iFrame * 8 + 7);
      }
      pTVar15 = (TOK *)vrgtok +
                *(byte *)((int)(BTLREC *)vlpbrVCR + iHit * 8 + 6);
      ptokAttack = (TOK *)CONCAT22(vrgtok._2_2_,pTVar15);
      uVar1 = pTVar15->brc & 0xf;
      y = (int)(uint)pTVar15->brc >> 4;
      uVar19 = (undefined2)((ulong)ptokSrc >> 0x10);
      iVar4 = (((TOK *)ptokSrc)->brc & 0xf) - uVar1;
      dy = ((int)(uint)((TOK *)ptokSrc)->brc >> 4) - y;
      ptDest = (dxyVCRSquare + 3) * uVar1 + dxyVCRSquare / 2 + 0xb;
      local_38 = (dxyVCRSquare + 3) * y + dxyVCRSquare / 2 + 0xb;
      iVar5 = (dxyVCRSquare + 3) * uVar1 + dxyVCRSquare / 2 + 0xb;
      iVar6 = (dxyVCRSquare + 3) * y + dxyVCRSquare / 2 + 0xb;
      iVar7 = dxyVCRSquare / 3 + iVar6;
      iVar16 = iVar6 - dxyVCRSquare / 3;
      iVar17 = iVar5 - dxyVCRSquare / 3;
      iVar8 = dxyVCRSquare / 3 + iVar5;
      iHit = iFrame;
      if ((iVar4 != 0) || (dy != 0)) {
        if ((iVar4 == 0) ||
           ((sVar13 = _abs(iVar4), sVar13 == 1 && (sVar13 = _abs(dy), 2 < sVar13))))
        {
          ptBeam1 = ptRight;
          local_e = local_34;
          ptBeam2 = ptLeft;
          local_62 = local_48;
          ptTorp = ptTop;
          local_44 = local_1a;
          ptRay1 = iVar8;
          local_2e = iVar6;
          ptRay2 = iVar17;
          local_16 = iVar6;
          if (dy < 1) {
            ptTorp = iVar3;
            local_44 = iVar2;
            ptRay1 = iVar17;
            ptRay2 = iVar8;
          }
        }
        else if ((dy == 0) ||
                ((sVar13 = _abs(dy), sVar13 == 1 &&
                 (sVar13 = _abs(iVar4), 2 < sVar13)))) {
          ptBeam1 = ptTop;
          local_e = local_1a;
          ptBeam2 = iVar3;
          local_62 = iVar2;
          ptTorp = ptLeft;
          local_44 = local_48;
          ptRay1 = iVar5;
          local_2e = iVar16;
          ptRay2 = iVar5;
          local_16 = iVar7;
          if (iVar4 < 1) {
            ptTorp = ptRight;
            local_44 = local_34;
            local_2e = iVar7;
            local_16 = iVar16;
          }
        }
        else {
          ptBeam1 = iVar3;
          local_e = iVar2;
          if (iVar4 < 1) {
            ptRay1 = iVar17;
            local_2e = iVar6;
            ptRay2 = iVar5;
            local_16 = iVar16;
            if (0 < dy) {
              ptBeam1 = ptTop;
              local_e = local_1a;
              ptRay1 = iVar5;
              local_2e = iVar7;
              ptRay2 = iVar17;
              local_16 = iVar6;
            }
            ptBeam2 = ptRight;
            local_62 = local_34;
            ptTorp = ptRight;
            local_44 = local_e;
          }
          else {
            ptRay1 = iVar5;
            local_2e = iVar16;
            ptRay2 = iVar8;
            local_16 = iVar6;
            if (0 < dy) {
              ptBeam1 = ptTop;
              local_e = local_1a;
              ptRay1 = iVar8;
              local_2e = iVar6;
              ptRay2 = iVar5;
              local_16 = iVar7;
            }
            ptBeam2 = ptLeft;
            local_62 = local_48;
            ptTorp = ptLeft;
            local_44 = local_e;
          }
        }
        if ((grfWeapon & 3) != 0) {
          HVar9 = hpenStarbase;
          if ((grfWeapon & 2) == 0) {
            HVar9 = hpenEnemy;
          }
          SelectObject(hdc,HVar9);
          MoveTo(hdc,ptBeam1,local_e);
          LineTo(hdc,ptDest,local_38);
          MoveTo(hdc,ptBeam2,local_62);
          LineTo(hdc,ptDest,local_38);
          DrawIcon(hdc,ptDest + -0x10,local_38 + -0x10,rghiconVCR[0]);
        }
        if ((grfWeapon & 4) != 0) {
          if (fAnimate == 0) {
LAB_10e8_43b4:
            if ((grfWeapon & 0x40) == 0) {
              DrawIcon(hdc,ptDest + -0x10,local_38 + -0x10,rghiconVCR[1]);
            }
          }
          else {
            HVar10 = CreateCompatibleDC(hdc);
            if (HVar10 != 0) {
              HVar11 = CreateCompatibleBitmap(hdc,0x20,0x20);
              if (HVar11 != 0) {
                HVar12 = SelectObject(HVar10,HVar11);
                sVar13 = _abs(iVar4);
                sVar14 = _abs(dy);
                if (sVar14 < sVar13) {
                  iVar4 = _abs(iVar4);
                }
                else {
                  iVar4 = _abs(dy);
                }
                if ((grfWeapon & 4) == 0) {
                  iVar5 = 4;
                }
                else {
                  iVar5 = 8;
                }
                cFrame = iVar4 * iVar5;
                ptBase = ptTorp;
                local_28 = local_44;
                dxFrame = ptTorp - ptDest;
                dyFrame = local_44 - local_38;
                ti = 0xc;
                local_54 = 0;
                TimerCount(0x1118,&ti);
                dwTickLast = local_52;
                local_1e = local_50;
                for (iFrame = 0; iFrame < cFrame; iFrame = iFrame + 1) {
                  BitBlt(HVar10,0,0,0x20,0x20,hdc,ptTorp + -0x10,local_44 + -0x10,0xcc0020);
                  DrawIcon(hdc,ptTorp + -0x10,local_44 + -0x10,
                           ((ushort *)rghiconVCR)[(iFrame & 3U) + 3]);
                  do {
                    TimerCount(0x14f8,&ti);
                    dwTickCur = local_52;
                    local_24 = local_50;
                    if ((local_50 < local_1e) || ((local_50 <= local_1e && (local_52 < dwTickLast)))
                       ) break;
                    uVar1 = ((local_1e + (0xffdc < dwTickLast)) - (viSpeedVCR * 10 >> 0xf)) -
                            (uint)(dwTickLast + 0x23 < (uint)(viSpeedVCR * 10));
                  } while ((local_50 < uVar1) ||
                          ((local_50 <= uVar1 &&
                           (local_52 < dwTickLast + 0x23 + viSpeedVCR * -10))));
                  dwTickLast = local_52;
                  local_1e = local_50;
                  BitBlt(hdc,ptTorp + -0x10,local_44 + -0x10,0x20,0x20,HVar10,0,0,0xcc0020);
                  lVar21 = (long)cFrame;
                  uVar20 = __aFulmul((long)dxFrame,(long)iFrame);
                  lVar21 = __aFldiv(uVar20,lVar21);
                  ptTorp = ptBase - (int)lVar21;
                  lVar21 = (long)cFrame;
                  uVar20 = __aFulmul((long)dyFrame,(long)iFrame);
                  lVar21 = __aFldiv(uVar20,lVar21);
                  local_44 = local_28 - (int)lVar21;
                }
                SelectObject(HVar10,HVar12);
                DeleteObject(HVar11);
                DeleteDC(HVar10);
                goto LAB_10e8_43b4;
              }
              DeleteDC(HVar10);
            }
          }
        }
      }
    } while (iHit < ((BTLREC *)vlpbrVCR)->ctok);
    iFrame = 0;
    while( true ) {
      uVar19 = (undefined2)((ulong)vlpbrVCR >> 0x10);
      pBVar18 = (BTLREC *)vlpbrVCR;
      if (pBVar18->ctok <= iFrame) break;
      pTVar15 = (TOK *)vrgtok + *(byte *)((int)pBVar18 + iFrame * 8 + 6);
      ptokAttack = (TOK *)CONCAT22(vrgtok._2_2_,pTVar15);
      iVar2 = (pTVar15->brc & 0xf) * (dxyVCRSquare + 3) + dxyVCRSquare / 2;
      ptDest = iVar2 + 0xb;
      iVar3 = ((int)(uint)pTVar15->brc >> 4) * (dxyVCRSquare + 3) +
              dxyVCRSquare / 2;
      local_38 = iVar3 + 0xb;
      if (*(int *)((int)pBVar18 + iFrame * 8 + 8) == 0) {
        iVar4 = 0;
      }
      else {
        iVar4 = 2;
      }
      DrawIcon(hdc,iVar2 + -5,iVar3 + -5,((ushort *)rghiconVCR)[iVar4]);
      iFrame = iFrame + 1;
    }
    fAnimate = 0;
  }
  return;
}



// ======================================================================
// Function: PopupVCRMenu
// Address: 10e8:4518
// Segment: MEMORY_VCR
// ======================================================================


short PopupVCRMenu(HWND hwnd,short x,short y,byte brc)

{
  ushort uVar1;
  short sVar2;
  int iVar3;
  BTLREC *pBVar4;
  undefined2 uVar5;
  short cKilled;
  short cch;
  char *psz;
  short j;
  short iSel;
  short iChecked;
  short rgid [40];
  int lpshdef;
  undefined2 local_65c;
  char rgch [1535];
  char local_5b;
  short c;
  short i;
  char *rgsz [40];
  short fAttack;
  
  c = 0;
  iChecked = -1;
  psz = rgch;
  fAttack = (short)(brc == ((TOK *)vrgtok)
                           [((BTLREC *)vlpbrVCR)->wFlags_0x4 >> 8].brc);
  for (i = 0; i < (int)(uint)((BTLDATA *)vlpbdVCR)->ctok; i = i + 1) {
    if ((((TOK *)vrgtok)[i].brc == brc) && (((TOK *)vrgtok)[i].csh != 0)) {
      PszPlayerName((uint)((TOK *)vrgtok)[i].iplr,0,0,0,0,(PLAYER *)0x0);
      uVar1 = _strlen((char *)szWork);
      if (*&((TOK *)vrgtok)[i].u_TOK_0x0003 == '\x01') {
        iVar3 = (uint)((TOK *)vrgtok)[i].iplr * 4;
        local_65c = *(undefined2 *)(iVar3 + 0x14e);
        lpshdef = *(int *)(iVar3 + rglpshdefSB) +
                  (*(byte *)((int)&((TOK *)vrgtok)[i].u_TOK_0x0003 + 1) - 0x10) * 0x93;
      }
      else {
        iVar3 = (uint)((TOK *)vrgtok)[i].iplr * 4;
        local_65c = *(undefined2 *)(iVar3 + 0x100);
        lpshdef = *(int *)(iVar3 + rglpshdef) +
                  (uint)*(byte *)((int)&((TOK *)vrgtok)[i].u_TOK_0x0003 + 1) * 0x93;
      }
      sVar2 = _wsprintf((char *)szWork + uVar1,(char *)0x11201432,lpshdef + 8,local_65c,
                        ((TOK *)vrgtok)[i].csh);
      cch = uVar1 + sVar2;
      if (fAttack != 0) {
        uVar5 = (undefined2)((ulong)vlpbrVCR >> 0x10);
        pBVar4 = (BTLREC *)vlpbrVCR;
        if ((0 < pBVar4->ctok) && (-1 < viStepVCRCur)) {
          cKilled = 0;
          for (j = 0; j < pBVar4->ctok; j = j + 1) {
            if ((uint)*(byte *)((int)pBVar4 + j * 8 + 6) == i) {
              cKilled = cKilled + *(int *)((int)pBVar4 + j * 8 + 8);
            }
          }
          if (0 < cKilled) {
            sVar2 = _wsprintf((char *)szWork + cch,(char *)0x1120143b,cKilled);
            cch = cch + sVar2;
          }
        }
      }
      if ((&local_5b <= psz + cch + 1) || (0x27 < c)) break;
      rgsz[c] = psz;
      rgid[c] = i;
      _strcpy(psz,(char *)szWork);
      psz = psz + cch + 1;
      if (i == viVCRFocus) {
        iChecked = c;
      }
      c = c + 1;
    }
  }
  if (c == 0) {
    sVar2 = -1;
  }
  else {
    sVar2 = PopupMenu(hwnd,x,y,c,(long *)0x0,rgsz,iChecked,1);
    if (sVar2 == -1) {
      sVar2 = -1;
    }
    else {
      sVar2 = rgid[sVar2];
    }
  }
  return sVar2;
}



// ======================================================================
// Function: EnableVCRButtons
// Address: 10e8:48f6
// Segment: MEMORY_VCR
// ======================================================================


void EnableVCRButtons(void)

{
  HWND HVar1;
  short i;
  
  for (i = 0xa1; i < 0xa3; i = i + 1) {
    HVar1 = GetDlgItem(hwndVCRDlg,i);
    EnableWindow(HVar1,(uint)((uint)viStepVCRCur < 0x8000));
  }
  for (i = 0xa3; i < 0xa6; i = i + 1) {
    HVar1 = GetDlgItem(hwndVCRDlg,i);
    EnableWindow(HVar1,(uint)(viStepVCRCur < vcStepVCR));
  }
  if (viStepVCRCur == -1) {
    HVar1 = GetDlgItem(hwndVCRDlg,0xa3);
    SetFocus(HVar1);
  }
  else if (viStepVCRCur == vcStepVCR) {
    HVar1 = GetDlgItem(hwndVCRDlg,1);
    SetFocus(HVar1);
  }
  return;
}



