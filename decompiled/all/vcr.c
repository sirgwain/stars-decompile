// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: BattleVCR
// Address: 10e8:0000
// Segment: MEMORY_VCR
// ======================================================================


void BattleVCR(short iBattle)

{
  HB *pHVar1;
  int iVar2;
  short *psVar3;
  uint uVar4;
  short sVar5;
  char *sz;
  undefined2 uVar6;
  FARPROC pvVar7;
  HB *lphb;
  short env [9];
  short (*penvMemSav) [9];
  void *lpProc;
  
                    /* Segment:    30
                       Offset:     000cf8c0
                       Length:     49be
                       Min Alloc:  49be
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  psVar3 = penvMem;
  pvVar7 = (FARPROC)0x0;
  viStepVCRCur = -1;
  uVar4 = gd._0_2_ & 0xdfff;
  if ((uint)gd._0_2_ >> 0xe < 2) {
    dxyVCRBoard = 0x161;
    dxyVCRSquare = 0x20;
  }
  else {
    dxyVCRBoard = 0x2a1;
    dxyVCRSquare = 0x40;
  }
  lphb = (HB *)CONCAT22(DAT_1120_0d60._2_2_,(HB *)DAT_1120_0d60);
  vlpbdVCR = (BTLDATA *)CONCAT22(DAT_1120_0d60._2_2_,&((HB *)DAT_1120_0d60)[1].cbBlock);
  while( true ) {
    while( true ) {
      if (vlpbdVCR->id == iBattle) {
        vlpbdVCRNext._0_2_ =
             (BTLDATA *)
             ((int)&((BTLDATA *)vlpbdVCR)->id + ((BTLDATA *)vlpbdVCR)->cbData);
        vlpbdVCRNext._2_2_ = vlpbdVCR._2_2_;
        penvMem = env;
        gd._0_2_ = uVar4;
        sVar5 = __setjmp(env);
        if (sVar5 == 0) {
          vrgtok =
               LpAlloc((uint)((BTLDATA *)vlpbdVCR)->ctok * 0x1d,htMisc);
          vrgdpVCR = LpAlloc((uint)((BTLDATA *)vlpbdVCR)->ctok << 2,htMisc)
          ;
          sVar5 = SetVCRBoard(30000);
          vcStepVCR = sVar5 + -1;
          vcRound = viRound;
          SetVCRBoard(-1);
          if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
            AdvanceTutor();
          }
          pvVar7 = MakeProcInstance(VCRDlg,hInst);
          DialogBox(0,(LPCSTR)CONCAT22(0xa0,hwndFrame),(HWND)((ulong)pvVar7 >> 0x10),
                    (void *)pvVar7);
        }
        else {
          sVar5 = 0x10;
          penvMem = psVar3;
          sz = PszFormatIds(idsMemory,(short *)0x0);
          AlertSz(sz,sVar5);
        }
        if (pvVar7 != (FARPROC)0x0) {
          FreeProcInstance(pvVar7);
        }
        if (vrgtok != (TOK *)0x0) {
          FreeLp(vrgtok,htMisc);
        }
        if (vrgdpVCR != (long *)0x0) {
          FreeLp(vrgdpVCR,htMisc);
        }
        vrgtok._2_2_ = 0;
        vrgtok._0_2_ = (TOK *)0x0;
        vrgdpVCR._2_2_ = 0;
        vrgdpVCR._0_2_ = (long *)0x0;
        return;
      }
      if (vlpbdVCR->id == -1) break;
      vlpbdVCR =
           (BTLDATA *)
           CONCAT22(vlpbdVCR._2_2_,
                    (BTLDATA *)
                    ((int)&((BTLDATA *)vlpbdVCR)->id +
                    ((BTLDATA *)vlpbdVCR)->cbData));
    }
    uVar6 = (undefined2)((ulong)lphb >> 0x10);
                    /* WARNING: Load size is inaccurate */
    pHVar1 = ((HB *)lphb)->lphbNext;
    iVar2 = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
    lphb = (HB *)CONCAT22(iVar2,pHVar1);
    if ((pHVar1 == (HB *)0x0) && (iVar2 == 0)) break;
    vlpbdVCR = (BTLDATA *)CONCAT22(iVar2,&pHVar1[1].cbBlock);
  }
  gd.field0_0x0 = (char)uVar4;
  gd.field1_0x1 = (char)(uVar4 >> 8);
  viStepVCRCur = -1;
  return;
}



// ======================================================================
// Function: CBattles
// Address: 10e8:028c
// Segment: MEMORY_VCR
// ======================================================================


short CBattles(void)

{
  HB *pHVar1;
  int iVar2;
  BTLDATA *pBVar3;
  undefined2 uVar4;
  short cBattles;
  HB *lphb;
  BTLDATA *lpbd;
  
  cBattles = 0;
  lphb = (HB *)CONCAT22(DAT_1120_0d60._2_2_,(HB *)DAT_1120_0d60);
  if (((HB *)DAT_1120_0d60 == (HB *)0x0) && (DAT_1120_0d60._2_2_ == 0)) {
    cBattles = 0;
  }
  else {
    lpbd = (BTLDATA *)CONCAT22(DAT_1120_0d60._2_2_,&((HB *)DAT_1120_0d60)[1].cbBlock);
    while( true ) {
      while (lpbd->id != -1) {
        uVar4 = (undefined2)((ulong)lpbd >> 0x10);
        pBVar3 = (BTLDATA *)lpbd;
        if (pBVar3->cbData == 0) {
          return cBattles;
        }
        cBattles = cBattles + 1;
        lpbd = (BTLDATA *)CONCAT22(uVar4,(BTLDATA *)((int)&pBVar3->id + pBVar3->cbData));
      }
      uVar4 = (undefined2)((ulong)lphb >> 0x10);
                    /* WARNING: Load size is inaccurate */
      pHVar1 = ((HB *)lphb)->lphbNext;
      iVar2 = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
      lphb = (HB *)CONCAT22(iVar2,pHVar1);
      if (((pHVar1 == (HB *)0x0) && (iVar2 == 0)) || ((uint)pHVar1->ibTop < 0x11)) break;
      lpbd = (BTLDATA *)CONCAT22(iVar2,&pHVar1[1].cbBlock);
    }
  }
  return cBattles;
}



// ======================================================================
// Function: BtlDataGet
// Address: 10e8:0362
// Segment: MEMORY_VCR
// ======================================================================


BTLDATA * BtlDataGet(short i)

{
  HB *pHVar1;
  int iVar2;
  BTLDATA *pBVar3;
  undefined2 uVar4;
  HB *lphb;
  BTLDATA *lpbd;
  
  lphb = (HB *)CONCAT22(DAT_1120_0d60._2_2_,(HB *)DAT_1120_0d60);
  if (((HB *)DAT_1120_0d60 == (HB *)0x0) && (DAT_1120_0d60._2_2_ == 0)) {
    pBVar3 = (BTLDATA *)0x0;
    uVar4 = 0;
  }
  else {
    lpbd = (BTLDATA *)CONCAT22(DAT_1120_0d60._2_2_,&((HB *)DAT_1120_0d60)[1].cbBlock);
    while( true ) {
      while (lpbd->id != -1) {
        uVar4 = (undefined2)((ulong)lpbd >> 0x10);
        pBVar3 = (BTLDATA *)lpbd;
        if (pBVar3->cbData == 0) {
          pBVar3 = (BTLDATA *)0x0;
          uVar4 = 0;
          goto LAB_10e8_0449;
        }
        if (i < 1) goto LAB_10e8_0449;
        i = i + -1;
        lpbd = (BTLDATA *)CONCAT22(uVar4,(BTLDATA *)((int)&pBVar3->id + pBVar3->cbData));
      }
      uVar4 = (undefined2)((ulong)lphb >> 0x10);
                    /* WARNING: Load size is inaccurate */
      pHVar1 = ((HB *)lphb)->lphbNext;
      iVar2 = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
      lphb = (HB *)CONCAT22(iVar2,pHVar1);
      if (((pHVar1 == (HB *)0x0) && (iVar2 == 0)) || ((uint)pHVar1->ibTop < 0x11)) break;
      lpbd = (BTLDATA *)CONCAT22(iVar2,&pHVar1[1].cbBlock);
    }
    pBVar3 = (BTLDATA *)0x0;
    uVar4 = 0;
  }
LAB_10e8_0449:
  return (BTLDATA *)CONCAT22(uVar4,pBVar3);
}



// ======================================================================
// Function: CBattleUnits
// Address: 10e8:0450
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Type propagation algorithm not settling */

long CBattleUnits(BTLDATA *lpbd,ushort grbitBU)

{
  byte bVar1;
  int iVar2;
  uint uVar3;
  BTLDATA *pBVar4;
  int iVar5;
  undefined2 uVar6;
  bool bVar7;
  HULDEF *pHVar8;
  short imd;
  short i;
  long lUnits;
  short ctok;
  TOK *lptok;
  
  uVar6 = (undefined2)((ulong)lpbd >> 0x10);
  pBVar4 = (BTLDATA *)lpbd;
  bVar1 = pBVar4->ctok;
  lUnits._0_2_ = 0;
  lUnits._2_2_ = 0;
  i = 0;
  do {
    if ((int)(uint)bVar1 <= i) {
      return CONCAT22(lUnits._2_2_,(uint)lUnits);
    }
    iVar2 = i * 0x1d;
    if ((uint)*(byte *)((int)pBVar4 + iVar2 + 0x10) == idPlayer) {
      uVar3 = grbitBU & 1;
    }
    else {
      uVar3 = grbitBU & 2;
    }
    if ((uVar3 != 0) && (((grbitBU & 4) != 0 || (*(byte *)((int)pBVar4 + iVar2 + 0x12) < 0x10)))) {
      if (((grbitBU & 0xf8) != 0xf8) && (*(byte *)((int)pBVar4 + iVar2 + 0x12) < 0x10)) {
        iVar5 = (uint)*(byte *)((int)pBVar4 + iVar2 + 0x10) * 4;
        pHVar8 = LphuldefFromId
                           (*(HullDef *)
                             (*(int *)(iVar5 + 0xfe) +
                             (uint)*(byte *)((int)pBVar4 + iVar2 + 0x12) * 0x93));
        uVar3 = (uint)((HULDEF *)pHVar8)->wFlags >> 10 & 0xf;
        if ((uVar3 < 2) || (5 < uVar3)) {
          uVar3 = grbitBU & 8;
        }
        else if (uVar3 == 2) {
          uVar3 = grbitBU & 0x10;
        }
        else if (uVar3 == 3) {
          uVar3 = grbitBU & 0x20;
        }
        else if (uVar3 == 5) {
          uVar3 = grbitBU & 0x40;
        }
        else {
          if (uVar3 != 4) goto LAB_10e8_0600;
          uVar3 = grbitBU & 0x80;
        }
        if (uVar3 == 0) goto LAB_10e8_0610;
      }
LAB_10e8_0600:
      uVar3 = *(uint *)((int)pBVar4 + iVar2 + 0x21);
      bVar7 = CARRY2((uint)lUnits,uVar3);
      lUnits._0_2_ = (uint)lUnits + uVar3;
      lUnits._2_2_ = lUnits._2_2_ + (uint)bVar7;
    }
LAB_10e8_0610:
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: CBattleKills
// Address: 10e8:062e
// Segment: MEMORY_VCR
// ======================================================================


long CBattleKills(BTLDATA *lpbd,short fOurDead)

{
  uint uVar1;
  undefined2 uVar2;
  bool bVar3;
  short cKill;
  BTLREC *lpbr;
  short i;
  BTLDATA *lpbdNext;
  long cKilled;
  
  lpbr = (BTLREC *)
         CONCAT22(lpbd._2_2_,
                  (BTLREC *)((int)(BTLDATA *)lpbd + (uint)((BTLDATA *)lpbd)->ctok * 0x1d + 0xe));
  cKilled._0_2_ = 0;
  cKilled._2_2_ = 0;
  while ((BTLREC *)lpbr < (BTLREC *)((int)&((BTLDATA *)lpbd)->id + ((BTLDATA *)lpbd)->cbData)) {
    uVar2 = (undefined2)((ulong)lpbr >> 0x10);
    for (i = 0; i < ((BTLREC *)lpbr)->ctok; i = i + 1) {
      if (*(int *)((int)(BTLREC *)lpbr + i * 8 + 8) != 0) {
        if ((uint)*(byte *)((int)(BTLDATA *)lpbd +
                           (uint)*(byte *)((int)(BTLREC *)lpbr + i * 8 + 6) * 0x1d + 0x10) ==
            idPlayer) {
          if (fOurDead != 0) {
            uVar1 = *(uint *)((int)(BTLREC *)lpbr + i * 8 + 8);
            bVar3 = CARRY2((uint)cKilled,uVar1);
            cKilled._0_2_ = (uint)cKilled + uVar1;
            cKilled._2_2_ = cKilled._2_2_ + (uint)bVar3;
          }
        }
        else if (fOurDead == 0) {
          uVar1 = *(uint *)((int)(BTLREC *)lpbr + i * 8 + 8);
          bVar3 = CARRY2((uint)cKilled,uVar1);
          cKilled._0_2_ = (uint)cKilled + uVar1;
          cKilled._2_2_ = cKilled._2_2_ + (uint)bVar3;
        }
      }
    }
    lpbr = (BTLREC *)
           CONCAT22(uVar2,(BTLREC *)((int)(BTLREC *)lpbr + ((BTLREC *)lpbr)->ctok * 8 + 6));
  }
  return CONCAT22(cKilled._2_2_,(uint)cKilled);
}



// ======================================================================
// Function: LdpFromItokDv
// Address: 10e8:07a8
// Segment: MEMORY_VCR
// ======================================================================


long LdpFromItokDv(short itok,DV *lpdv)

{
  uint uVar1;
  SHDEF *pSVar2;
  ulong uVar3;
  ulong uVar4;
  long lVar5;
  ulong b;
  long den;
  long dp;
  short csh;
  ushort dpShdef;
  DV dv;
  
  if (((DV *)lpdv == (DV *)0x0) && (lpdv._2_2_ == 0)) {
    dv.dp = 0;
  }
  else {
    dv = (DV)lpdv->dp;
  }
  pSVar2 = LpshdefFromTok
                     ((TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok + itok));
  uVar1 = (((SHDEF *)pSVar2)->hul).dp;
  uVar3 = __aFulmul((ulong)uVar1,(ulong)(uint)((TOK *)vrgtok)[itok].csh);
  if (dv.dp != 0) {
    lVar5 = 100;
    uVar4 = __aFulmul((ulong)(uint)((TOK *)vrgtok)[itok].csh,
                              (ulong)(uint)dv.dp & 0xffff007f);
    lVar5 = __aFldiv(uVar4,lVar5);
    csh = (short)lVar5;
    if (csh < 1) {
      csh = 1;
    }
    den = 0x32;
    b = (ulong)csh;
    lVar5 = 10;
    uVar4 = __aFulmul((ulong)uVar1,(ulong)((uint)dv.dp >> 7));
    uVar4 = __aFldiv(uVar4,lVar5);
    uVar4 = __aFulmul(uVar4,b);
    lVar5 = __aFldiv(uVar4,den);
    uVar3 = uVar3 - lVar5;
  }
  return uVar3;
}



// ======================================================================
// Function: SetVCRBoard
// Address: 10e8:08d8
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10e80bd4) */

short SetVCRBoard(short iStep)

{
  short *psVar1;
  TOK *pTVar2;
  uint itok_00;
  int iVar3;
  BTLDATA *pBVar4;
  BTLREC *pBVar5;
  TOK *pTVar6;
  undefined2 unaff_SI;
  short *psVar7;
  long *plVar8;
  undefined2 unaff_DI;
  undefined2 uVar9;
  undefined2 uVar10;
  long lVar11;
  ulong uVar12;
  long lVar13;
  uint in_stack_0000ffee;
  short itok;
  short i;
  TOK *ptok;
  
  lVar13 = CONCAT22(unaff_SI,unaff_DI);
  if ((iStep != viStepVCRCur) || (viStepVCRCur == -1)) {
    if ((iStep < viStepVCRCur) || (viStepVCRCur == -1)) {
      i = 0;
      while( true ) {
        uVar9 = (undefined2)((ulong)vlpbdVCR >> 0x10);
        pBVar4 = (BTLDATA *)vlpbdVCR;
        uVar10 = vrgtok._2_2_;
        if ((int)(uint)pBVar4->ctok <= i) break;
        psVar7 = (short *)((int)pBVar4 + i * 0x1d + 0xe);
        pTVar6 = (TOK *)vrgtok + i;
        for (iVar3 = 0xe; iVar3 != 0; iVar3 = iVar3 + -1) {
          pTVar2 = pTVar6;
          pTVar6 = (TOK *)&pTVar6->iplr;
          psVar1 = psVar7;
          psVar7 = psVar7 + 1;
          pTVar2->id = *psVar1;
        }
        *(char *)&pTVar6->id = (char)*psVar7;
        lVar11 = LdpFromItokDv(i,(DV *)CONCAT22(vrgtok._2_2_,
                                                &((TOK *)vrgtok)[i].dv));
        uVar10 = vrgdpVCR._2_2_;
        plVar8 = (long *)vrgdpVCR + i;
        *(int *)plVar8 = (int)lVar11;
        *(undefined2 *)((int)plVar8 + 2) = (int)((ulong)lVar11 >> 0x10);
        i = i + 1;
      }
      viStepVCRCur = -1;
      viRound = 0;
      viVCRFocus = 0;
      vbrcVCRFocus = ((TOK *)vrgtok)->brc;
      vlpbrVCR =
           (BTLREC *)CONCAT22(uVar9,(BTLREC *)((int)pBVar4 + (uint)pBVar4->ctok * 0x1d + 0xe));
    }
    while ((viStepVCRCur < iStep &&
           ((BTLREC *)vlpbrVCR < (BTLDATA *)vlpbdVCRNext))) {
      if (-1 < viStepVCRCur) {
        i = 0;
        while( true ) {
          uVar9 = (undefined2)((ulong)vlpbrVCR >> 0x10);
          pBVar5 = (BTLREC *)vlpbrVCR;
          pTVar6 = (TOK *)vrgtok;
          uVar10 = vrgtok._2_2_;
          if (pBVar5->ctok <= i) break;
          itok_00 = (uint)*(byte *)((int)pBVar5 + i * 8 + 6);
          ((TOK *)vrgtok)[itok_00].csh =
               ((TOK *)vrgtok)[itok_00].csh - *(int *)((int)pBVar5 + i * 8 + 8);
          (&pTVar6[itok_00].dv)->dp = *(short *)((int)(BTLREC *)vlpbrVCR + i * 8 + 0xc);
          lVar11 = LdpFromItokDv(itok_00,(DV *)CONCAT22(vlpbrVCR._2_2_,
                                                        (DV *)((int)(BTLREC *)vlpbrVCR +
                                                              i * 8 + 0xc)));
          uVar9 = vrgdpVCR._2_2_;
          plVar8 = (long *)vrgdpVCR + itok_00;
          *(int *)plVar8 = (int)lVar11;
          *(undefined2 *)((int)plVar8 + 2) = (int)((ulong)lVar11 >> 0x10);
          if (pTVar6[itok_00].dpShield != 0) {
            if (*(int *)((int)(BTLREC *)vlpbrVCR + i * 8 + 10) != 0) {
              uVar12 = __aFulmul((ulong)(uint)pTVar6[itok_00].dpShield,
                                         (ulong)(uint)pTVar6[itok_00].csh);
              lVar11 = __aFlshl(lVar13,in_stack_0000ffee);
              if (lVar11 < (long)uVar12) {
                uVar12 = (ulong)(uint)pTVar6[itok_00].csh;
                lVar11 = __aFlshl(uVar12,(ushort)lVar13);
                lVar11 = __aFldiv(lVar11,uVar12);
                pTVar6[itok_00].dpShield = pTVar6[itok_00].dpShield - (int)lVar11;
              }
              else {
                pTVar6[itok_00].dpShield = 0;
              }
            }
          }
          i = i + 1;
        }
        pBVar5 = (BTLREC *)((int)pBVar5 + pBVar5->ctok * 8 + 6);
        vlpbrVCR = (BTLREC *)CONCAT22(uVar9,pBVar5);
        if ((uint)viRound < (pBVar5->wFlags & 0xfU)) {
          viRound = pBVar5->wFlags & 0xf;
          ptok = vrgtok;
          for (i = 0; i < (int)(uint)((BTLDATA *)vlpbdVCR)->ctok; i = i + 1) {
            uVar10 = (undefined2)((ulong)ptok >> 0x10);
            pTVar6 = (TOK *)ptok;
            if (((uint)pTVar6->wFlags >> 3 & 1) != 0) {
              RegenShield(ptok);
            }
            pTVar6->wFlags = pTVar6->wFlags & 0xffef;
            ptok = (TOK *)CONCAT22(uVar10,pTVar6 + 1);
          }
        }
      }
      if ((BTLREC *)vlpbrVCR < (BTLDATA *)vlpbdVCRNext) {
        ((TOK *)vrgtok)[vlpbrVCR->itok].brc =
             ((BTLREC *)vlpbrVCR)->brcDest;
        vbrcVCRFocus = ((TOK *)vrgtok)[vlpbrVCR->itok].brc;
        viVCRFocus = (short)vlpbrVCR->itok;
        in_stack_0000ffee =
             ((TOK *)vrgtok)[vlpbrVCR->itok].wFlags & 0xfc1fU |
             ((uint)((BTLREC *)vlpbrVCR)->wFlags >> 4 & 0xf) << 5;
        ((TOK *)vrgtok)[vlpbrVCR->itok].wFlags = in_stack_0000ffee;
        if (((uint)((TOK *)vrgtok)[vlpbrVCR->itok].wFlags >> 5 & 0x1f) == 4) {
          ((TOK *)vrgtok)[vlpbrVCR->itok].wFlags =
               ((TOK *)vrgtok)[vlpbrVCR->itok].wFlags & 0xf0ff;
        }
      }
      viStepVCRCur = viStepVCRCur + 1;
    }
    EnableVCRButtons();
    iStep = viStepVCRCur;
  }
  return iStep;
}



// ======================================================================
// Function: VCRDlg
// Address: 10e8:0e90
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short VCRDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  HWND HVar1;
  BOOL BVar2;
  int iVar3;
  char *pcVar4;
  HDC HVar5;
  short sVar6;
  UINT UVar7;
  byte brc;
  ushort unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar8;
  undefined2 unaff_SS;
  undefined2 *puVar9;
  ulong uVar10;
  undefined1 uVar11;
  undefined1 uVar12;
  ushort in_stack_0000ffc0;
  short iStep;
  COLORREF CStack_26;
  int iStack_22;
  int iStack_20;
  RECT *pRStack_1e;
  short sStack_1c;
  uint uStack_1a;
  uint uStack_18;
  undefined2 *puStack_16;
  short sStack_14;
  RECT rc;
  short ibtn;
  short i;
  HDC hdc;
  
  if (message == WM_DESTROY) {
    hwndVCRDlg = 0;
    return 0;
  }
  uVar11 = (undefined1)unaff_SS;
  uVar12 = (undefined1)((uint)unaff_SS >> 8);
  if (message == WM_PAINT) {
    HVar5 = BeginPaint(hwnd,(short *)CONCAT22(unaff_SS,&iStep));
    DrawVCR(HVar5,-1,-1);
    EndPaint(hwnd,(undefined2 *)CONCAT13(uVar12,CONCAT12(uVar11,&iStep)));
    return 1;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    return 1;
  }
  if (message == WM_SETCURSOR) {
    GetCursorPos((undefined2 *)CONCAT13(uVar12,CONCAT12(uVar11,&puStack_16)));
    ScreenToClient(hwnd,(undefined2 **)CONCAT22(unaff_SS,&puStack_16));
    if ((((8 < (int)puStack_16) && ((int)puStack_16 < (dxyVCRSquare + 3) * 10 + 8)) &&
        (7 < sStack_14)) && (sStack_14 < (dxyVCRSquare + 3) * 10 + 8)) {
      setcursor(hcurHand);
      return 1;
    }
    return 0;
  }
  if (message == WM_INITDIALOG) {
    hwndVCRDlg = hwnd;
    GetWindowRect(hwnd,(short *)CONCAT22(unaff_SS,&sStack_1c));
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    sStack_14 = (int)puStack_16 + (-rc.bottom - uStack_1a);
    HVar1 = GetDlgItem(hwnd,0xa1);
    GetWindowRect(HVar1,(undefined2 *)CONCAT22(unaff_SS,&rc));
    SetWindowPos(hwnd,0,0,0,dxyVCRBoard + 0xfa,
                 sStack_14 + 0x18 + dxyVCRBoard + (rc.bottom - rc.top),6);
    for (i = 0; i < 7; i = i + 1) {
      if (i < 5) {
        ibtn = i + 0xa1;
      }
      else if (i == 5) {
        ibtn = 1;
      }
      else if (i == 6) {
        ibtn = 0x76;
      }
      HVar1 = GetDlgItem(hwnd,ibtn);
      GetWindowRect(HVar1,(undefined2 *)CONCAT22(unaff_SS,&rc));
      MapWindowPoints(0,hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc),2);
      if (dxyVCRSquare < 0x40) {
        pRStack_1e = (RECT *)0x0;
      }
      else {
        iStack_20 = ((rc.right - rc.left) + 8) * i;
        iStack_22 = ((rc.right - rc.left) * 7) / 2;
        pRStack_1e = (RECT *)(((dxyVCRBoard / 2 - iStack_22) + -0x10 + iStack_20) -
                             rc.left);
      }
      OffsetRect((undefined2 *)CONCAT13(uVar12,CONCAT12(uVar11,&rc)),(short)pRStack_1e,
                 (dxyVCRBoard + 0x10) - rc.top);
      HVar1 = GetDlgItem(hwnd,ibtn);
      SetWindowPos(HVar1,0,rc.left,rc.top,0,0,5);
    }
    EnableVCRButtons();
    StickyDlgPos(hwnd,(POINT *)&ptStickyVCRDlg,1);
    fAnimate = 1;
    return 1;
  }
  if (message == WM_COMMAND) {
    if ((wParam < 0xa1) || (0xa5 < wParam)) {
      if ((wParam != 1) && (wParam != 2)) {
        if (wParam != 0x76) {
          return 0;
        }
        WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x43a);
        return 1;
      }
      if (((uint)gd._0_2_ >> 0xd & 1) != 0) {
        gd._0_2_ = gd._0_2_ & 0xdfff;
        KillTimer(hwnd,0xa6c);
      }
      if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
        tutor.wFlags = tutor.wFlags & 0xfbffU | 0x400;
      }
      StickyDlgPos(hwnd,(POINT *)&ptStickyVCRDlg,0);
      EndDialog(hwnd,i);
      return 1;
    }
    i = wParam - 0xa1;
    if (((uint)gd._0_2_ >> 0xd & 1) != 0) {
VCR_KillTime:
      KillTimer(hwnd,0xa6c);
      gd._0_2_ = gd._0_2_ & 0xdfff;
      if (i == 2) {
        gd.field0_0x0 = (char)gd._0_2_;
        gd.field1_0x1 = (char)((uint)gd._0_2_ >> 8);
        return 0;
      }
    }
    sVar6 = GetAsyncKeyState(0x11);
    if (sVar6 < 0) {
      puStack_16 = (undefined2 *)0x64;
    }
    else {
      sVar6 = GetAsyncKeyState(0x10);
      if (sVar6 < 0) {
        puStack_16 = (undefined2 *)0xa;
      }
      else {
        puStack_16 = (undefined2 *)0x1;
      }
    }
    fAnimate = 0;
    if (i == 0) {
      sStack_14 = -1;
      goto LAB_10e8_1807;
    }
    if (i == 1) {
      sStack_14 = viStepVCRCur - (int)puStack_16;
      if (sStack_14 < -1) {
        sStack_14 = -1;
      }
      goto LAB_10e8_1807;
    }
    if (i == 2) {
      UVar7 = SetTimer(0xa6c,viSpeedVCR * -0x78 + 0x23a,0,0);
      uStack_18 = (uint)(UVar7 != 0);
      gd._0_2_ = gd._0_2_ & 0xdfff | uStack_18 << 0xd;
    }
    else if (i != 3) {
      if (i == 4) {
        sStack_14 = vcStepVCR;
      }
      goto LAB_10e8_1807;
    }
  }
  else {
    if (message != WM_TIMER) {
      if ((message != WM_LBUTTONDOWN) && (message != WM_RBUTTONDOWN)) {
        return 0;
      }
      uStack_18 = (short)lParam;
      puVar9 = (undefined2 *)__aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc0);
      puStack_16 = (undefined2 *)puVar9;
      BVar2 = PtInRect((undefined2 *)CONCAT22((RECT *)rgrcBuildSpin,puStack_16),uStack_18)
      ;
      if ((BVar2 != 0) ||
         (BVar2 = PtInRect((undefined2 *)CONCAT22(0x592e,puStack_16),uStack_18), BVar2 != 0)) {
        BVar2 = PtInRect((undefined2 *)CONCAT22((RECT *)rgrcBuildSpin,puStack_16),
                         uStack_18);
        if (BVar2 == 0) {
          iStack_20 = 1;
          sStack_1c = 0x23;
          pRStack_1e = (RECT *)(rgrcBuildSpin + 1);
        }
        else {
          iStack_20 = -1;
          sStack_1c = 0x22;
          pRStack_1e = (RECT *)rgrcBuildSpin;
        }
        iStack_22 = viSpeedVCR;
        if (viSpeedVCR < 5) {
          if (viSpeedVCR < 0) {
            iStack_22 = 0;
          }
        }
        else {
          iStack_22 = 4;
        }
        HVar5 = GetDC(hwnd);
        uStack_1a = SetBkMode(HVar5,2);
        CStack_26 = SetBkColor(HVar5,CONCAT22(crButtonFace._2_2_,
                                              (undefined2)crButtonFace));
        SelectObject(HVar5,rghfontArial8[1]);
        InitBtnTrack((BTNT *)&stack0xffc2,hwnd,0,pRStack_1e,sStack_1c,0x50,0,0,(char *)0x0)
        ;
        while( true ) {
          sVar6 = FTrackBtn((BTNT *)&stack0xffc2);
          if (sVar6 == 0) break;
          if (((iStack_20 == -1) && (0 < iStack_22)) || ((iStack_20 == 1 && (iStack_22 < 4)))) {
            iStack_22 = iStack_22 + iStack_20;
            iVar3 = iStack_22 + 1;
            pcVar4 = PszGetCompressedString(idsPlaybackSpeedD);
            sStack_1c = _WSPRINTF((LPSTR)CONCAT13((char)((uint)iVar3 >> 8),
                                                  CONCAT12((char)iVar3,(undefined1 *)&DAT_1120_1120)
                                                 ),(LPCSTR)CONCAT22(pcVar4,(char *)&DAT_1120_1120),
                                  (char *)szWork);
            TextOut(HVar5,ptSpeedVCR.x,ptSpeedVCR.y,szWork,sStack_1c);
          }
        }
        viSpeedVCR = iStack_22;
        SelectObject(HVar5,rghfontArial8[0]);
        SetBkColor(HVar5,CStack_26);
        ReleaseDC(hwnd,HVar5);
        if (((uint)gd._0_2_ >> 0xd & 1) != 0) {
          KillTimer(hwnd,0xa6c);
          UVar7 = SetTimer(0xa6c,viSpeedVCR * -0x78 + 0x23a,0,0);
          gd._0_2_ = gd._0_2_ & 0xdfff | (uint)(UVar7 != 0) << 0xd;
        }
        return 1;
      }
      uStack_18 = (int)(uStack_18 + -8) / (dxyVCRSquare + 3);
      puStack_16 = (undefined2 *)((int)(puStack_16 + -4) / (dxyVCRSquare + 3));
      if ((((9 < (int)uStack_18) && (1 < (int)puStack_16)) && ((int)puStack_16 < 10)) &&
         (-1 < viVCRFocus)) {
        GlobalPD.grPopup = 0xb;
        if (((TOK *)vrgtok)[viVCRFocus].field2_0x3 == '\x01') {
          uStack_1a = (((TOK *)vrgtok)[viVCRFocus].ishdef - 0x10) * 0x93;
          iVar3 = (uint)((TOK *)vrgtok)[viVCRFocus].iplr * 4;
          GlobalPD.psz = (char *)*(undefined2 *)(iVar3 + 0x14e);
          GlobalPD._2_2_ = *(int *)(iVar3 + 0x14c) + uStack_1a;
        }
        else {
          uStack_1a = (uint)((TOK *)vrgtok)[viVCRFocus].ishdef * 0x93;
          iVar3 = (uint)((TOK *)vrgtok)[viVCRFocus].iplr * 4;
          GlobalPD.psz = (char *)*(undefined2 *)(iVar3 + 0x100);
          GlobalPD._2_2_ = *(int *)(iVar3 + 0xfe) + uStack_1a;
        }
        GlobalPD.iPlanVal = 1;
        GlobalPD.iPlanMax = 1;
        GlobalPD.iPlanMin =
             (short)((uint)((TOK *)vrgtok)[viVCRFocus].iplr != idPlayer);
        uVar10 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc0);
        Popup(hwnd,(short)lParam,(short)uVar10);
        return 0;
      }
      if ((int)uStack_18 < 0) {
        return 0;
      }
      if ((int)puStack_16 < 0) {
        return 0;
      }
      if (9 < (int)uStack_18) {
        return 0;
      }
      if (9 < (int)puStack_16) {
        return 0;
      }
      brc = (byte)(((uint)puStack_16 & 0xf) << 4) | (byte)uStack_18 & 0xf;
      sStack_14 = CONCAT11(sStack_14._1_1_,brc);
      if (message == WM_RBUTTONDOWN) {
        uVar10 = __aFulshr(CONCAT22(unaff_DI,(uint)brc),unaff_SI);
        uStack_1a = PopupVCRMenu(hwnd,(short)lParam,(short)uVar10,brc);
        if ((int)uStack_1a < 0) {
          return 0;
        }
        vbrcVCRFocus = (byte)sStack_14;
        viVCRFocus = uStack_1a;
      }
      else {
        uVar8 = (undefined2)((ulong)vlpbdVCR >> 0x10);
        if ((brc != vbrcVCRFocus) || (viVCRFocus == -1)) {
          viVCRFocus = ((BTLDATA *)vlpbdVCR)->ctok - 1;
          vbrcVCRFocus = brc;
        }
        i = viVCRFocus;
        do {
          i = i + 1;
          if (i == (uint)((BTLDATA *)vlpbdVCR)->ctok) {
            i = 0;
          }
          uStack_1a = (uint)((TOK *)vrgtok)[i].brc;
          if ((uStack_1a == brc) && (((TOK *)vrgtok)[i].csh != 0)) {
            viVCRFocus = i;
            goto VCR_GoodSel;
          }
        } while (i != viVCRFocus);
        viVCRFocus = -1;
      }
VCR_GoodSel:
      DrawVCR(0,-2,-1);
      return 0;
    }
    if (((uint)gd._0_2_ >> 0xd & 1) == 0) {
      return 0;
    }
    if (viStepVCRCur == vcStepVCR) {
      i = 2;
      goto VCR_KillTime;
    }
  }
  if (i == 3) {
    sStack_14 = viStepVCRCur + (int)puStack_16;
  }
  else {
    sStack_14 = viStepVCRCur + 1;
  }
  if (vcStepVCR < sStack_14) {
    sStack_14 = vcStepVCR;
  }
  fAnimate = (short)(viSpeedVCR < 4);
LAB_10e8_1807:
  SetVCRBoard(sStack_14);
  DrawVCR(0,-2,-1);
  return 0;
}



// ======================================================================
// Function: GetVCRStats
// Address: 10e8:193e
// Segment: MEMORY_VCR
// ======================================================================


void GetVCRStats(short itok,long *pdpArmor,DV *pdv,long *pdpShields,short *pcsh)

{
  undefined2 uVar1;
  undefined2 uVar2;
  uint uVar3;
  int iVar4;
  BTLREC *pBVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar6;
  long lVar7;
  SHDEF *pSVar8;
  ulong uVar9;
  ulong uVar10;
  long lVar11;
  ulong uVar12;
  ulong b;
  long lVar13;
  ushort in_stack_0000ffe8;
  ushort dpShdef;
  short cshKill;
  short i;
  long dpArmor;
  long dpShields;
  DV dv;
  short cshT;
  
  lVar13 = CONCAT22(unaff_SI,unaff_DI);
  uVar12 = 0;
  cshKill = 0;
  dv.dp = -1;
  uVar1 = (undefined2)((long *)vrgdpVCR)[itok];
  uVar2 = *(undefined2 *)((int)((long *)vrgdpVCR + itok) + 2);
  lVar11 = CONCAT22(uVar2,uVar1);
  i = 0;
  while( true ) {
    uVar6 = (undefined2)((ulong)vlpbrVCR >> 0x10);
    pBVar5 = (BTLREC *)vlpbrVCR;
    if (pBVar5->ctok <= i) break;
    if ((uint)*(byte *)((int)pBVar5 + i * 8 + 6) == itok) {
      cshKill = cshKill + *(int *)((int)pBVar5 + i * 8 + 8);
      lVar7 = __aFlshl(lVar13,in_stack_0000ffe8);
      uVar12 = lVar7 + uVar12;
      dv.dp = *(short *)((int)(BTLREC *)vlpbrVCR + i * 8 + 0xc);
    }
    i = i + 1;
  }
  if (dv.dp == -1) {
    dv.dp = (&((TOK *)vrgtok)[itok].dv)->dp;
    if (499 < (uint)dv.dp >> 7) {
      dv.dp = dv.dp & 0x7fU | 0xf980;
      lVar11 = CONCAT22(uVar2,uVar1);
    }
  }
  else {
    pSVar8 = LpshdefFromTok
                       ((TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok + itok));
    uVar3 = (((SHDEF *)pSVar8)->hul).dp;
    iVar4 = ((TOK *)vrgtok)[itok].csh - cshKill;
    uVar9 = __aFulmul((ulong)uVar3,(long)iVar4);
    lVar11 = 100;
    uVar10 = __aFulmul((long)iVar4,(ulong)(uint)dv.dp & 0xffff007f);
    lVar11 = __aFldiv(uVar10,lVar11);
    cshT = (short)lVar11;
    if (cshT < 1) {
      cshT = 1;
    }
    lVar13 = 0x32;
    b = (ulong)cshT;
    lVar11 = 10;
    uVar10 = __aFulmul((ulong)uVar3,(ulong)((uint)dv.dp >> 7));
    uVar10 = __aFldiv(uVar10,lVar11);
    uVar10 = __aFulmul(uVar10,b);
    lVar11 = __aFldiv(uVar10,lVar13);
    lVar11 = uVar9 - lVar11;
  }
  cshT = ((TOK *)vrgtok)[itok].csh - cshKill;
  if (cshT < 1) {
    cshT = 0;
    lVar11 = 0;
    uVar12 = __aFulmul((ulong)(uint)((TOK *)vrgtok)[itok].dpShield,
                               (ulong)(uint)((TOK *)vrgtok)[itok].csh);
  }
  dpArmor._2_2_ = (undefined2)((ulong)lVar11 >> 0x10);
  dpArmor._0_2_ = (undefined2)lVar11;
  dpShields._2_2_ = (undefined2)(uVar12 >> 0x10);
  dpShields._0_2_ = (undefined2)uVar12;
  if (pdv != (DV *)0x0) {
    pdv->dp = dv.dp;
  }
  if (pcsh != (short *)0x0) {
    *pcsh = cshT;
  }
  if (pdpArmor != (long *)0x0) {
    *(undefined2 *)pdpArmor = (undefined2)dpArmor;
    *(undefined2 *)((int)pdpArmor + 2) = dpArmor._2_2_;
  }
  if (pdpShields != (long *)0x0) {
    *(undefined2 *)pdpShields = (undefined2)dpShields;
    *(undefined2 *)((int)pdpShields + 2) = dpShields._2_2_;
  }
  return;
}



// ======================================================================
// Function: DrawVCR
// Address: 10e8:1c62
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10e82ebd) */

void DrawVCR(HDC hdc,short iStart,short iEnd)

{
  byte bVar1;
  HBRUSH HVar2;
  char *pcVar3;
  short sVar4;
  int iVar5;
  short sVar6;
  uint uVar7;
  StringId ids;
  ushort uVar8;
  int iVar9;
  uint uVar10;
  int iVar11;
  BTLREC *pBVar12;
  int iVar13;
  char *unaff_SS;
  bool bVar14;
  bool bVar15;
  DWORD DVar16;
  ulong uVar17;
  long lVar18;
  char *pcVar19;
  undefined1 *puVar20;
  undefined2 uVar21;
  HDC HVar22;
  undefined2 uVar23;
  short cshNew;
  short xT;
  uint uStack_1a6;
  DV dv;
  DV DStack_1a2;
  HBRUSH hbrSav_2;
  short x;
  RECT rc;
  short fJam;
  char szT [96];
  short j;
  short dx;
  char *psz;
  short csh;
  short ibmp;
  SHDEF *lpshdef;
  byte brcT;
  short i;
  short c;
  byte rgfSeen [256];
  short y;
  long dpArmor;
  short fCreatedDC;
  long dpT;
  short itokT;
  long dpShields;
  HBRUSH hbrSav;
  short bkMode;
  short ibmpRace;
  short ctok;
  
  bVar15 = hdc == 0;
  if (bVar15) {
    hdc = GetDC(hwndVCRDlg);
  }
  hbrSav = SelectObject(hdc,hbrButtonFace);
  bkMode = SetBkMode(hdc,1);
  _memset(rgfSeen,0,0x100);
  GetClientRect(hwndVCRDlg,(undefined2 *)CONCAT22(unaff_SS,&rc));
  if (iStart == -2) {
    PatBlt(hdc,dxyVCRBoard + 10,0,(rc.right - dxyVCRBoard) + -10,
           dxyVCRBoard + 8,0xf00021);
    iStart = -1;
  }
  SelectObject(hdc,hbrButtonShadow);
  if (iStart == -1) {
    PatBlt(hdc,8,8,dxyVCRBoard,2,0xf00021);
    PatBlt(hdc,8,8,2,dxyVCRBoard,0xf00021);
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,9,dxyVCRBoard + 6,dxyVCRBoard + -1,1,0xf00021);
    PatBlt(hdc,8,dxyVCRBoard + 7,dxyVCRBoard,1,0xf00021);
    PatBlt(hdc,dxyVCRBoard + 6,9,1,dxyVCRBoard + -3,0xf00021);
    PatBlt(hdc,dxyVCRBoard + 7,8,1,dxyVCRBoard + -2,0xf00021);
    SelectObject(hdc,hbrButtonShadow);
    for (i = 1; i < 10; i = i + 1) {
      PatBlt(hdc,(dxyVCRSquare + 3) * i + 9,10,1,dxyVCRBoard + -4,0xf00021);
      PatBlt(hdc,10,(dxyVCRSquare + 3) * i + 9,dxyVCRBoard + -4,1,0xf00021);
    }
    x = dxyVCRBoard + 0xe;
    SelectObject(hdc,rghfontArial8[1]);
    iVar13 = viStepVCRCur + 2;
    pcVar3 = PszGetCompressedString(idsPhaseDDRoundDD);
    sVar4 = _WSPRINTF((LPSTR)CONCAT22(iVar13,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
    TextOut(hdc,x,8,szWork,sVar4);
    sVar4 = dyArial8;
    iVar13 = dyArial8 + 0xc;
    iVar5 = viSpeedVCR + 1;
    pcVar3 = PszGetCompressedString(idsPlaybackSpeedD);
    sVar6 = _WSPRINTF((LPSTR)CONCAT22(iVar5,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
    DVar16 = GetTextExtent(hdc,szWork,sVar6);
    TextOut(hdc,x,iVar13,szWork,sVar6);
    ptSpeedVCR.x = x;
    ptSpeedVCR.y = iVar13;
    SetRect(&rgrcBuildSpin[0].left,x + (int)DVar16,iVar13,x + (int)DVar16 + 0xe,
            sVar4 + 0x1a);
    rgrcBuildSpin[1].left = rgrcBuildSpin[0].left;
    rgrcBuildSpin[1].top = rgrcBuildSpin[0].top;
    rgrcBuildSpin[1].right = rgrcBuildSpin[0].right;
    rgrcBuildSpin[1].bottom = rgrcBuildSpin[0].bottom;
    OffsetRect(&rgrcBuildSpin[1].left,0xe,0);
    for (i = 0; i < 2; i = i + 1) {
      if (i == 0) {
        uVar10 = 2;
      }
      else {
        uVar10 = 3;
      }
      DrawBtn(hdc,(RECT *)rgrcBuildSpin + i,uVar10 | 0x20,0,(char *)0x0);
    }
    if (-1 < viStepVCRCur) {
      iVar13 = iVar13 + dyArial8 + 4;
      pcVar3 = PszPlayerName((uint)((TOK *)vrgtok)[vlpbrVCR->itok].iplr,1,
                                   1,1,0,(PLAYER *)0x0);
      puVar20 = (undefined1 *)&DAT_1120_1120;
      pcVar19 = (char *)szWork;
      iVar5 = iVar13;
      sVar4 = x;
      HVar22 = hdc;
      uVar8 = _strlen(pcVar3);
      TextOut(HVar22,sVar4,iVar5,(LPCSTR)CONCAT22(puVar20,pcVar19),uVar8);
      iVar13 = iVar13 + dyArial8;
      if ((uint)vlpbrVCR->itok == viVCRFocus) {
        SetTextColor(hdc,0x7f0000);
      }
      if (((TOK *)vrgtok)[vlpbrVCR->itok].field2_0x3 == '\x01') {
        hbrSav_2 = (((TOK *)vrgtok)[vlpbrVCR->itok].ishdef - 0x10) * 0x93;
        iVar5 = (uint)((TOK *)vrgtok)[vlpbrVCR->itok].iplr * 4;
        lpshdef._2_2_ = *(undefined2 *)(iVar5 + 0x14e);
        lpshdef._0_2_ = (SHDEF *)(*(int *)(iVar5 + 0x14c) + hbrSav_2);
      }
      else {
        hbrSav_2 = (uint)((TOK *)vrgtok)[vlpbrVCR->itok].ishdef * 0x93;
        iVar5 = (uint)((TOK *)vrgtok)[vlpbrVCR->itok].iplr * 4;
        lpshdef._2_2_ = *(undefined2 *)(iVar5 + 0x100);
        lpshdef._0_2_ = (SHDEF *)(*(int *)(iVar5 + 0xfe) + hbrSav_2);
      }
      if (((TOK *)vrgtok)[vlpbrVCR->itok].csh < 2) {
        __fstrcpy(szWork,
                          (char *)CONCAT22(lpshdef._2_2_,(((SHDEF *)lpshdef)->hul).szClass));
        c = _strlen((char *)szWork);
      }
      else {
        pcVar19 = (((SHDEF *)lpshdef)->hul).szClass;
        pcVar3 = PszGetCompressedString(idsSD);
        c = _WSPRINTF((LPSTR)CONCAT22(pcVar19,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
      }
      TextOut(hdc,x,iVar13,szWork,c);
      y = iVar13 + dyArial8;
      SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      fJam = 0;
      uVar21 = (undefined2)((ulong)vlpbrVCR >> 0x10);
      if (0 < ((BTLREC *)vlpbrVCR)->ctok) {
        pcVar3 = PszPlayerName((uint)((TOK *)vrgtok)
                                           [(uint)((BTLREC *)vlpbrVCR)->wFlags >> 8].iplr,
                                     0,1,1,0,(PLAYER *)0x0);
        pcVar19 = PszGetCompressedString(idsAttacksS);
        sVar4 = _WSPRINTF((LPSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),
                          (LPCSTR)CONCAT22(pcVar19,unaff_SS),szT);
        TextOut(hdc,x,y,(LPCSTR)CONCAT22(unaff_SS,szT),sVar4);
        iVar13 = y + dyArial8;
        iVar5._0_1_ = ((BTLREC *)vlpbrVCR + 2)->itok;
        iVar5._1_1_ = ((BTLREC *)vlpbrVCR + 2)->brcDest;
        if (iVar5 != 0) {
          SetTextColor(hdc,0x7f);
        }
        uVar21 = (undefined2)((ulong)vlpbrVCR >> 0x10);
        pBVar12 = (BTLREC *)vlpbrVCR;
        if (((TOK *)vrgtok)[(uint)pBVar12->wFlags >> 8].field2_0x3 == '\x01') {
          DStack_1a2.dp =
               (((TOK *)vrgtok)[(uint)pBVar12->wFlags >> 8].ishdef - 0x10) * 0x93;
          hbrSav_2 = pBVar12->wFlags;
          iVar5 = (uint)((TOK *)vrgtok)[hbrSav_2 >> 8].iplr * 4;
          lpshdef._2_2_ = *(undefined2 *)(iVar5 + 0x14e);
          lpshdef._0_2_ = (SHDEF *)(*(int *)(iVar5 + 0x14c) + DStack_1a2.dp);
        }
        else {
          DStack_1a2.dp = (uint)((TOK *)vrgtok)[(uint)pBVar12->wFlags >> 8].ishdef * 0x93;
          hbrSav_2 = pBVar12->wFlags;
          iVar5 = (uint)((TOK *)vrgtok)[hbrSav_2 >> 8].iplr * 4;
          lpshdef._2_2_ = *(undefined2 *)(iVar5 + 0x100);
          lpshdef._0_2_ = (SHDEF *)(*(int *)(iVar5 + 0xfe) + DStack_1a2.dp);
        }
        if (((TOK *)vrgtok)[(uint)pBVar12->wFlags >> 8].csh < 2) {
          __fstrcpy(szWork,
                            (char *)CONCAT22(lpshdef._2_2_,(((SHDEF *)lpshdef)->hul).szClass));
          c = _strlen((char *)szWork);
        }
        else {
          pcVar19 = (((SHDEF *)lpshdef)->hul).szClass;
          pcVar3 = PszGetCompressedString(idsSD);
          c = _WSPRINTF((LPSTR)CONCAT22(pcVar19,(char *)&DAT_1120_1120),
                        (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
        }
        TextOut(hdc,x,iVar13,szWork,c);
        iVar13 = iVar13 + dyArial8;
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        uVar21 = (undefined2)((ulong)vlpbrVCR >> 0x10);
        bVar1 = ((TOK *)vrgtok)[(uint)((BTLREC *)vlpbrVCR)->wFlags >> 8].brc;
        dpArmor._0_2_ = 0;
        dpArmor._2_2_ = 0;
        dpShields._0_2_ = 0;
        dpShields._2_2_ = 0;
        j = 0;
        for (i = ((BTLREC *)vlpbrVCR)->ctok; 0 < i; i = i + -1) {
          itokT = (short)*(byte *)((int)(BTLREC *)vlpbrVCR + (i + -1) * 8 + 6);
          if ((itokT == (uint)((BTLREC *)vlpbrVCR)->wFlags >> 8) && (fJam == 0)) {
            fJam = *(byte *)((int)(BTLREC *)vlpbrVCR + (i + -1) * 8 + 7) & 0xc0;
          }
          j = j + *(int *)((int)(BTLREC *)vlpbrVCR + (i + -1) * 8 + 8);
          if (rgfSeen[itokT] == 0) {
            rgfSeen[itokT] = 1;
            GetVCRStats(itokT,&dpT,(DV *)0x0,(long *)&dv,(short *)&hbrSav_2);
            uVar10 = *(uint *)((long *)vrgdpVCR + itokT);
            uVar7 = uVar10 - (uint)dpT;
            bVar14 = CARRY2((uint)dpArmor,uVar7);
            dpArmor._0_2_ = (uint)dpArmor + uVar7;
            dpArmor._2_2_ =
                 dpArmor._2_2_ +
                 ((*(uint *)((int)((long *)vrgdpVCR + itokT) + 2) - dpT._2_2_) -
                 (uint)(uVar10 < (uint)dpT)) + (uint)bVar14;
            bVar14 = CARRY2((uint)dpShields,dv.dp);
            dpShields._0_2_ = (uint)dpShields + dv.dp;
            dpShields._2_2_ = dpShields._2_2_ + DStack_1a2.dp + (uint)bVar14;
          }
        }
        uVar10 = bVar1 & 0xf;
        pcVar3 = PszGetCompressedString(idsDDDoing);
        sVar4 = _WSPRINTF((LPSTR)CONCAT22(uVar10,(char *)&DAT_1120_1120),
                          (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
        TextOut(hdc,x,iVar13,szWork,sVar4);
        y = iVar13 + dyArial8;
        if (((uint)dpShields != 0) || (dpShields._2_2_ != 0)) {
          CchGetString(idsAnd,szT);
          uVar10 = (uint)dpShields;
          pcVar3 = PszGetCompressedString(idsLdDamageShieldsS);
          sVar4 = _WSPRINTF((LPSTR)CONCAT22(uVar10,(char *)&DAT_1120_1120),
                            (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork
                           );
          TextOut(hdc,x,y,szWork,sVar4);
          y = y + dyArial8;
        }
        if (((uint)dpArmor != 0) || (dpArmor._2_2_ != 0)) {
          uVar10 = (uint)dpArmor;
          pcVar3 = PszGetCompressedString(idsLdDamageArmorC);
          sVar4 = _WSPRINTF((LPSTR)CONCAT22(uVar10,(char *)&DAT_1120_1120),
                            (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork
                           );
          TextOut(hdc,x,y,szWork,sVar4);
          y = y + dyArial8;
        }
        if (((((fJam & 0x40U) != 0) && ((uint)dpShields == 0)) && (dpShields._2_2_ == 0)) &&
           (((uint)dpArmor == 0 && (dpArmor._2_2_ == 0)))) {
          pcVar3 = PszGetCompressedString(idsDamage3);
          puVar20 = (undefined1 *)&DAT_1120_1120;
          sVar4 = y;
          sVar6 = x;
          HVar22 = hdc;
          uVar8 = _strlen(pcVar3);
          TextOut(HVar22,sVar6,sVar4,(LPCSTR)CONCAT22(puVar20,pcVar3),uVar8);
          y = y + dyArial8;
        }
        if (0 < j) {
          sVar4 = j;
          pcVar3 = PszGetCompressedString(idsDestroyingDShip);
          iVar13 = _WSPRINTF((LPSTR)CONCAT22(sVar4,(char *)&DAT_1120_1120),
                             (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),
                             (char *)szWork);
          if (j == 1) {
            _strcpy((char *)szWork + iVar13,(char *)&DAT_1120_1424);
            c = iVar13 + 1;
          }
          else {
            _strcpy((char *)szWork + iVar13,(char *)&DAT_1120_1426);
            c = iVar13 + 2;
          }
          TextOut(hdc,x,y,szWork,c);
          y = y + dyArial8;
        }
      }
      if (fJam != 0) {
        SetTextColor(hdc,0x7f);
        if ((((fJam & 0x40U) == 0) || ((uint)dpArmor != 0)) || (dpArmor._2_2_ != 0)) {
          ids = idsTorpedoesDeflected;
        }
        else {
          ids = idsTorpedoesDeflected2;
        }
        sVar4 = CchGetString(ids,(char *)szWork);
        TextOut(hdc,x,y,szWork,sVar4);
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      }
    }
    if (vbrcVCRFocus != 0xff) {
      uVar10 = vbrcVCRFocus & 0xf;
      pcVar3 = PszGetCompressedString(idsSelectionDD);
      sVar4 = _WSPRINTF((LPSTR)CONCAT22(uVar10,(char *)&DAT_1120_1120),
                        (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
      TextOut(hdc,x,200,szWork,sVar4);
      iVar13 = dyArial8 + 200;
      if (-1 < viVCRFocus) {
        pcVar3 = PszPlayerName((uint)((TOK *)vrgtok)[viVCRFocus].iplr,1,1,
                                     1,0,(PLAYER *)0x0);
        uVar8 = _strlen(pcVar3);
        TextOut(hdc,x,iVar13,szWork,uVar8);
        iVar13 = iVar13 + dyArial8;
        if (((TOK *)vrgtok)[viVCRFocus].field2_0x3 == '\x01') {
          iVar5 = (uint)((TOK *)vrgtok)[viVCRFocus].iplr * 4;
          lpshdef._2_2_ = *(undefined2 *)(iVar5 + 0x14e);
          lpshdef._0_2_ =
               (SHDEF *)(*(int *)(iVar5 + 0x14c) +
                        (((TOK *)vrgtok)[viVCRFocus].ishdef - 0x10) * 0x93);
        }
        else {
          iVar5 = (uint)((TOK *)vrgtok)[viVCRFocus].iplr * 4;
          lpshdef._2_2_ = *(undefined2 *)(iVar5 + 0x100);
          lpshdef._0_2_ =
               (SHDEF *)(*(int *)(iVar5 + 0xfe) +
                        (uint)((TOK *)vrgtok)[viVCRFocus].ishdef * 0x93);
        }
        iVar5 = ((TOK *)vrgtok)[viVCRFocus].csh;
        GetVCRStats(viVCRFocus,(long *)&uStack_1a6,&DStack_1a2,&dpShields,
                    (short *)&hbrSav_2);
        HVar2 = hbrSav_2;
        hbrSav_2 = iVar5 - hbrSav_2;
        if ((iVar5 < 2) && (hbrSav_2 == 0)) {
          __fstrcpy(szWork,
                            (char *)CONCAT22(lpshdef._2_2_,(((SHDEF *)lpshdef)->hul).szClass));
          c = _strlen((char *)szWork);
        }
        else {
          pcVar19 = (((SHDEF *)lpshdef)->hul).szClass;
          pcVar3 = PszGetCompressedString(idsSD);
          c = _WSPRINTF((LPSTR)CONCAT22(pcVar19,(char *)&DAT_1120_1120),
                        (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
        }
        if (hbrSav_2 != 0) {
          iVar9 = _WSPRINTF((LPSTR)CONCAT22(hbrSav_2,(char *)&DAT_1120_1120),(LPCSTR)0x14291120,
                            (char *)szWork + c);
          c = c + iVar9;
        }
        SetTextColor(hdc,0x7f0000);
        TextOut(hdc,x,iVar13,szWork,c);
        iVar13 = iVar13 + dyArial8;
        iVar9 = (rc.right - (dxyVCRBoard + 0xe)) / 2 + x;
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        if ((int)HVar2 < 1) {
          sVar4 = CchGetString(idsDead3,(char *)szWork);
          TextOut(hdc,x,iVar13,szWork,sVar4);
          y = iVar13 + dyArial8 * 5;
        }
        else {
          if (((TOK *)vrgtok)[viVCRFocus].field2_0x3 == '\x01') {
            i = 0;
          }
          else {
            i = ((uint)((TOK *)vrgtok)[viVCRFocus].wFlags >> 8 & 0xf) + 1;
          }
          if (((TOK *)vrgtok)[viVCRFocus].initMin == 0xff) {
            uVar10 = 0;
          }
          else {
            uVar10 = (uint)((TOK *)vrgtok)[viVCRFocus].initMin;
          }
          pcVar3 = PszGetCompressedString(idsInitiativeD);
          sVar4 = _WSPRINTF((LPSTR)CONCAT22(uVar10,(char *)&DAT_1120_1120),
                            (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork
                           );
          TextOut(hdc,x,iVar13,szWork,sVar4);
          iVar11 = i * 3 + 0xca0;
          pcVar3 = PszGetCompressedString(idsMovementS);
          sVar4 = _WSPRINTF((LPSTR)CONCAT22(iVar11,(char *)&DAT_1120_1120),
                            (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork
                           );
          TextOut(hdc,iVar9,iVar13,szWork,sVar4);
          iVar13 = iVar13 + dyArial8;
          uVar10 = uStack_1a6;
          pcVar3 = PszGetCompressedString(idsArmorLd);
          sVar4 = _WSPRINTF((LPSTR)CONCAT22(uVar10,(char *)&DAT_1120_1120),
                            (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork
                           );
          TextOut(hdc,x,iVar13,szWork,sVar4);
          if (DStack_1a2.dp == 0) {
            c = CchGetString(idsDamageNone,(char *)szWork);
          }
          else {
            uVar23 = 0;
            uVar21 = 100;
            uVar17 = __aFulmul((ulong)(DStack_1a2.dp & 0x7f),(long)(int)(iVar5 - hbrSav_2));
            lVar18 = __aFldiv(uVar17,CONCAT22(uVar23,uVar21));
            csh = (short)lVar18;
            if (csh < 1) {
              csh = 1;
            }
            uStack_1a6 = (uint)DStack_1a2.dp / 0x280;
            if (uStack_1a6 == 0) {
              uStack_1a6 = 1;
            }
            dv.dp = 0;
            SetTextColor(hdc,0x7f);
            if (((TOK *)vrgtok)[viVCRFocus].field2_0x3 == '\x01') {
              uVar10 = uStack_1a6;
              pcVar3 = PszGetCompressedString(idsDamageD);
              c = _WSPRINTF((LPSTR)CONCAT22(uVar10,(char *)&DAT_1120_1120),
                            (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork
                           );
            }
            else {
              pcVar3 = PszGetCompressedString(idsDamageLdD);
              c = _WSPRINTF((LPSTR)CONCAT22(csh,(char *)&DAT_1120_1120),
                            (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork
                           );
            }
          }
          TextOut(hdc,iVar9,iVar13,szWork,c);
          SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText)
                      );
          iVar13 = iVar13 + dyArial8;
          uVar17 = __aFulmul((ulong)(uint)((TOK *)vrgtok)[viVCRFocus].
                                                  dpShield,(long)(int)HVar2);
          iVar5 = ((int)(uVar17 >> 0x10) - dpShields._2_2_) - (uint)((uint)uVar17 < (uint)dpShields)
          ;
          if ((iVar5 < 1) && ((iVar5 < 0 || ((uint)uVar17 == (uint)dpShields)))) {
            c = CchGetString(idsShieldsNone,(char *)szWork);
          }
          else {
            uVar17 = __aFulmul((ulong)(uint)((TOK *)vrgtok)[viVCRFocus].
                                                    dpShield,(long)(int)HVar2);
            lVar18 = uVar17 - CONCAT22(dpShields._2_2_,(uint)dpShields);
            pcVar3 = PszGetCompressedString(idsShieldsLd);
            c = _WSPRINTF((LPSTR)CONCAT22((int)lVar18,(char *)&DAT_1120_1120),
                          (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
          }
          TextOut(hdc,x,iVar13,szWork,c);
          y = iVar13 + dyArial8;
          if (((TOK *)vrgtok)[viVCRFocus].pctJam != 0) {
            uVar10 = (uint)((TOK *)vrgtok)[viVCRFocus].pctJam;
            pcVar3 = PszGetCompressedString(idsJammingD);
            sVar4 = _WSPRINTF((LPSTR)CONCAT22(uVar10,(char *)&DAT_1120_1120),
                              (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),
                              (char *)szWork);
            TextOut(hdc,x,y,szWork,sVar4);
            y = y + dyArial8;
          }
          if (((TOK *)vrgtok)[viVCRFocus].field2_0x3 != '\x01') {
            if (vbrcVCRFocus == 0xff) {
              i = 0x19e;
            }
            else {
              i = ((uint)((TOK *)vrgtok)[viVCRFocus].wFlags >> 8 & 0xf) + 0x198;
            }
            if (i == 0x198) {
              CchGetString(idsTacticSDMoves,szT);
              pcVar3 = PszGetCompressedString(idsDisengage);
              c = _WSPRINTF((LPSTR)CONCAT22(pcVar3,unaff_SS),
                            (LPCSTR)CONCAT22(szT,(char *)&DAT_1120_1120),(char *)szWork);
            }
            else {
              CchGetString(idsTacticS,szT);
              pcVar3 = PszGetCompressedString(i);
              c = _WSPRINTF((LPSTR)CONCAT22(pcVar3,unaff_SS),
                            (LPCSTR)CONCAT22(szT,(char *)&DAT_1120_1120),(char *)szWork);
            }
            TextOut(hdc,x,y,szWork,c);
            y = y + dyArial8;
          }
          if (i != 0x19e) {
            CchGetString(idsPrimayTargetS,szT);
            pcVar3 = PszGetCompressedString
                               ((((TOK *)vrgtok)[viVCRFocus].wFlags & 0xfU) +
                                idsNoneDisengage);
            sVar4 = _WSPRINTF((LPSTR)CONCAT22(pcVar3,unaff_SS),
                              (LPCSTR)CONCAT22(szT,(char *)&DAT_1120_1120),(char *)szWork)
            ;
            TextOut(hdc,x,y,szWork,sVar4);
            iVar13 = y + dyArial8;
            CchGetString(idsSecondaryTargetS,szT);
            pcVar3 = PszGetCompressedString
                               (((uint)((TOK *)vrgtok)[viVCRFocus].wFlags >> 4 &
                                0xf) + idsNoneDisengage);
            sVar4 = _WSPRINTF((LPSTR)CONCAT22(pcVar3,unaff_SS),
                              (LPCSTR)CONCAT22(szT,(char *)&DAT_1120_1120),(char *)szWork)
            ;
            TextOut(hdc,x,iVar13,szWork,sVar4);
            y = iVar13 + dyArial8;
          }
        }
        SetRect((undefined2 *)CONCAT22(unaff_SS,&rc),x,y + 4,x + dyArial8 + 4,
                y + dyArial8 + 8);
        DrawBtn(hdc,&rc,8,0,(char *)&DAT_1120_1430);
      }
    }
    iStart = 0;
    iEnd = 99;
  }
  for (i = iStart; i <= iEnd; i = i + 1) {
    x = i % 10;
    uVar10 = i / 10;
    PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,
           dxyVCRSquare + 2,1,0x42);
    PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,1,
           dxyVCRSquare + 2,0x42);
    PatBlt(hdc,(dxyVCRSquare + 3) * x + dxyVCRSquare + 0xb,
           (dxyVCRSquare + 3) * uVar10 + 10,1,dxyVCRSquare + 2,0x42);
    PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,
           (dxyVCRSquare + 3) * uVar10 + dxyVCRSquare + 0xb,
           dxyVCRSquare + 2,1,0x42);
    ctok = 0;
    ibmp = -1;
    dpT._0_2_ = 0;
    dpT._2_2_ = 0;
    for (j = 0; j < (int)(uint)((BTLDATA *)vlpbdVCR)->ctok; j = j + 1) {
      hbrSav_2 = (HBRUSH)((TOK *)vrgtok)[j].brc;
      if ((hbrSav_2 == ((uVar10 & 0xf) << 4 | x & 0xfU)) && (((TOK *)vrgtok)[j].csh != 0))
      {
        ctok = ctok + 1;
        bVar14 = CARRY2((uint)dpT,((TOK *)vrgtok)[j].csh);
        dpT._0_2_ = (uint)dpT + ((TOK *)vrgtok)[j].csh;
        dpT._2_2_ = dpT._2_2_ + (uint)bVar14;
        if ((ibmp == -1) || (j == viVCRFocus)) {
          if (((TOK *)vrgtok)[j].field2_0x3 == '\x01') {
            hbrSav_2 = (((TOK *)vrgtok)[j].ishdef - 0x10) * 0x93;
            iVar13 = (uint)((TOK *)vrgtok)[j].iplr * 4;
            ibmp = *(short *)(*(int *)(iVar13 + 0x14c) + hbrSav_2 + 0x32);
          }
          else {
            hbrSav_2 = (uint)((TOK *)vrgtok)[j].ishdef * 0x93;
            iVar13 = (uint)((TOK *)vrgtok)[j].iplr * 4;
            ibmp = *(short *)(*(int *)(iVar13 + 0xfe) + hbrSav_2 + 0x32);
          }
          ibmpRace = *(uint *)((int)&rgplr[0].wMdPlr +
                              (uint)((TOK *)vrgtok)[j].iplr * 0xc0) >> 3 & 0x1f;
        }
      }
    }
    if ((dpT._2_2_ < 1) && ((dpT._2_2_ < 0 || ((uint)dpT < 0x7fff)))) {
      csh = (uint)dpT;
    }
    else {
      csh = 0x7fff;
    }
    if (ctok < 1) {
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,
             dxyVCRSquare + 2,dxyVCRSquare + 2,0x42);
    }
    else {
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,
             dxyVCRSquare + 2,1,0x42);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,1,
             dxyVCRSquare + 2,0x42);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + dxyVCRSquare + 0xb,
             (dxyVCRSquare + 3) * uVar10 + 10,1,dxyVCRSquare + 2,0x42);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,
             (dxyVCRSquare + 3) * uVar10 + dxyVCRSquare + 0xb,
             dxyVCRSquare + 2,1,0x42);
      DrawFleetBitmap
                ((FLEET *)0x0,hdc,(dxyVCRSquare + 3) * x + 0xb,
                 (dxyVCRSquare + 3) * uVar10 + 0xb,0,ibmp,ctok,
                 (uint)(dxyVCRSquare < 0x40),ibmpRace,csh);
    }
    hbrSav_2 = (HBRUSH)vbrcVCRFocus;
    if (((hbrSav_2 == ((uVar10 & 0xf) << 4 | x & 0xfU)) && (viVCRFocus == -1)) ||
       ((-1 < viVCRFocus &&
        ((hbrSav_2 = (HBRUSH)((TOK *)vrgtok)[viVCRFocus].brc,
         hbrSav_2 == ((uVar10 & 0xf) << 4 | x & 0xfU) &&
         (((TOK *)vrgtok)[viVCRFocus].csh != 0)))))) {
      hbrSav_2 = SelectObject(hdc,hbrBlue);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,
             dxyVCRSquare + 1,2,0xf00021);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,2,
             dxyVCRSquare + 1,0xf00021);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,
             (dxyVCRSquare + 3) * uVar10 + 10 + dxyVCRSquare,
             dxyVCRSquare + 1,2,0xf00021);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10 + dxyVCRSquare,
             (dxyVCRSquare + 3) * uVar10 + 10,2,dxyVCRSquare + 1,0xf00021);
      SelectObject(hdc,hbrSav_2);
    }
  }
  if (0 < ((BTLREC *)vlpbrVCR)->ctok) {
    AnimateAttack(hdc);
  }
  SetBkMode(hdc,bkMode);
  SelectObject(hdc,hbrSav);
  if (bVar15) {
    ReleaseDC(hwndVCRDlg,hdc);
  }
  return;
}



// ======================================================================
// Function: Delay
// Address: 10e8:3a3e
// Segment: MEMORY_VCR
// ======================================================================


void Delay(short ctick)

{
  uint uVar1;
  uint uVar2;
  uint uVar3;
  TIMERINFO ti;
  ulong dwTickCur;
  ulong dwTickLast;
  
  ti.dwSize._0_2_ = 0xc;
  ti.dwSize._2_2_ = 0;
  TimerCount((undefined *)&DAT_1120_10e8,&ti);
  uVar2 = ti.dwmsSinceStart._2_2_;
  uVar1 = (uint)ti.dwmsSinceStart;
  while( true ) {
    TimerCount(0x14f8,&ti);
    if (ti.dwmsSinceStart._2_2_ < uVar2) {
      return;
    }
    if ((ti.dwmsSinceStart._2_2_ <= uVar2) && ((uint)ti.dwmsSinceStart < uVar1)) break;
    uVar3 = (ctick >> 0xf) + uVar2 + (uint)CARRY2(ctick,uVar1);
    if ((uVar3 <= ti.dwmsSinceStart._2_2_) &&
       ((uVar3 < ti.dwmsSinceStart._2_2_ || (ctick + uVar1 <= (uint)ti.dwmsSinceStart)))) {
      return;
    }
  }
  return;
}



// ======================================================================
// Function: AnimateAttack
// Address: 10e8:3ac2
// Segment: MEMORY_VCR
// ======================================================================


void AnimateAttack(HDC hdc)

{
  byte bVar1;
  byte bVar2;
  TOK *pTVar3;
  short sVar4;
  short sVar5;
  int iVar6;
  int iVar7;
  int iVar8;
  int iVar9;
  uint uVar10;
  int iVar11;
  int iVar12;
  int iVar13;
  int iVar14;
  int iVar15;
  int iVar16;
  short sVar17;
  HPEN HVar18;
  HDC HVar19;
  HBITMAP HVar20;
  HGDIOBJ HVar21;
  short sVar22;
  short sVar23;
  int iVar24;
  int iVar25;
  BTLREC *pBVar26;
  undefined2 uVar27;
  ulong uVar28;
  long lVar29;
  HBITMAP hbmpScreen;
  HBITMAP hbmpSav;
  HDC hdcMem;
  short x;
  POINT ptDestLeft;
  POINT ptDestRight;
  POINT ptDestTop;
  POINT ptBottom;
  POINT ptBeam2;
  POINT ptDestBottom;
  short fKill;
  short dx;
  short iFrame;
  TIMERINFO ti;
  POINT ptLeft;
  POINT ptTorp;
  POINT ptSrc;
  ushort grfWeapon;
  short iHit;
  POINT ptDest;
  POINT ptRight;
  short y;
  POINT ptRay1;
  short dy;
  POINT ptBase;
  ulong dwTickCur;
  short dxFrame;
  ulong dwTickLast;
  POINT ptTop;
  POINT ptRay2;
  short dyFrame;
  short cFrame;
  POINT ptBeam1;
  TOK *ptokAttack;
  TOK *ptokSrc;
  
  uVar27 = vrgtok._2_2_;
  pTVar3 = (TOK *)vrgtok;
  if (-1 < viStepVCRCur) {
    bVar1 = vlpbrVCR->itok;
    iVar6 = (dxyVCRSquare + 3) * (((TOK *)vrgtok)[bVar1].brc & 0xf) +
            dxyVCRSquare / 2 + 0xb;
    iVar7 = (dxyVCRSquare + 3) * ((int)(uint)((TOK *)vrgtok)[bVar1].brc >> 4) +
            dxyVCRSquare / 2 + 0xb;
    iVar8 = dxyVCRSquare / 3 + iVar7;
    iVar24 = iVar7 - dxyVCRSquare / 3;
    iVar25 = iVar6 - dxyVCRSquare / 3;
    iVar9 = dxyVCRSquare / 3 + iVar6;
    iHit = 0;
    do {
      grfWeapon = (ushort)*(byte *)((int)(BTLREC *)vlpbrVCR + iHit * 8 + 7);
      iFrame = iHit;
      while ((iFrame = iFrame + 1, sVar4 = iFrame, iFrame < ((BTLREC *)vlpbrVCR)->ctok &&
             (*(char *)((int)(BTLREC *)vlpbrVCR + iFrame * 8 + 6) ==
              *(char *)((int)(BTLREC *)vlpbrVCR + iHit * 8 + 6)))) {
        grfWeapon = grfWeapon | *(byte *)((int)(BTLREC *)vlpbrVCR + iFrame * 8 + 7);
      }
      bVar2 = *(byte *)((int)(BTLREC *)vlpbrVCR + iHit * 8 + 6);
      uVar10 = ((TOK *)vrgtok)[bVar2].brc & 0xf;
      iVar11 = (int)(uint)((TOK *)vrgtok)[bVar2].brc >> 4;
      iVar12 = (pTVar3[bVar1].brc & 0xf) - uVar10;
      iVar13 = ((int)(uint)pTVar3[bVar1].brc >> 4) - iVar11;
      iVar14 = (dxyVCRSquare + 3) * uVar10 + dxyVCRSquare / 2;
      iVar15 = iVar14 + 0xb;
      iVar11 = (dxyVCRSquare + 3) * iVar11 + dxyVCRSquare / 2;
      iVar16 = iVar11 + 0xb;
      iHit = iFrame;
      if ((iVar12 != 0) || (iVar13 != 0)) {
        ptBeam2.x = iVar25;
        ptBeam2.y = iVar7;
        if ((iVar12 == 0) ||
           ((sVar17 = _abs(iVar12), sVar17 == 1 &&
            (sVar17 = _abs(iVar13), 2 < sVar17)))) {
          ptTorp.x = iVar6;
          ptTorp.y = iVar24;
          ptBeam1.x = iVar9;
          ptBeam1.y = iVar7;
          if (iVar13 < 1) {
            ptTorp.y = iVar8;
          }
        }
        else {
          ptTorp.x = iVar25;
          ptBeam1.x = iVar6;
          ptBeam1.y = iVar24;
          if ((iVar13 == 0) ||
             ((sVar17 = _abs(iVar13), sVar17 == 1 &&
              (sVar17 = _abs(iVar12), 2 < sVar17)))) {
            ptBeam2.x = iVar6;
            ptBeam2.y = iVar8;
            ptTorp.y = iVar7;
            if (iVar12 < 1) {
              ptTorp.x = iVar9;
            }
          }
          else if (iVar12 < 1) {
            if (iVar13 < 1) {
              ptBeam1.y = iVar8;
            }
            ptTorp.y = ptBeam1.y;
            ptBeam2.x = iVar9;
            ptTorp.x = iVar9;
          }
          else {
            if (iVar13 < 1) {
              ptBeam1.y = iVar8;
            }
            ptTorp.y = ptBeam1.y;
          }
        }
        sVar5 = ptTorp.y;
        sVar17 = ptTorp.x;
        if ((grfWeapon & 3) != 0) {
          HVar18 = hpenStarbase;
          if ((grfWeapon & 2) == 0) {
            HVar18 = hpenEnemy;
          }
          SelectObject(hdc,HVar18);
          MoveTo(hdc,ptBeam1.x,ptBeam1.y);
          LineTo(hdc,iVar15,iVar16);
          MoveTo(hdc,ptBeam2.x,ptBeam2.y);
          LineTo(hdc,iVar15,iVar16);
          DrawIcon(hdc,iVar14 + -5,iVar11 + -5,rghiconVCR[0]);
        }
        if ((grfWeapon & 4) != 0) {
          if (fAnimate == 0) {
LAB_10e8_43b4:
            if ((grfWeapon & 0x40) == 0) {
              DrawIcon(hdc,iVar14 + -5,iVar11 + -5,rghiconVCR[1]);
            }
          }
          else {
            HVar19 = CreateCompatibleDC(hdc);
            if (HVar19 != 0) {
              HVar20 = CreateCompatibleBitmap(hdc,0x20,0x20);
              if (HVar20 != 0) {
                HVar21 = SelectObject(HVar19,HVar20);
                sVar22 = _abs(iVar12);
                sVar23 = _abs(iVar13);
                if (sVar23 < sVar22) {
                  iVar12 = _abs(iVar12);
                }
                else {
                  iVar12 = _abs(iVar13);
                }
                if ((grfWeapon & 4) == 0) {
                  iVar13 = 4;
                }
                else {
                  iVar13 = 8;
                }
                iVar12 = iVar12 * iVar13;
                iVar15 = ptTorp.x - iVar15;
                iVar16 = ptTorp.y - iVar16;
                ti.dwSize._0_2_ = 0xc;
                ti.dwSize._2_2_ = 0;
                TimerCount(0x1118,&ti);
                dwTickLast._0_2_ = (uint)ti.dwmsSinceStart;
                dwTickLast._2_2_ = ti.dwmsSinceStart._2_2_;
                for (iFrame = 0; iFrame < iVar12; iFrame = iFrame + 1) {
                  BitBlt(HVar19,0,0,0x20,0x20,hdc,ptTorp.x + -0x10,ptTorp.y + -0x10,0xcc0020);
                  DrawIcon(hdc,ptTorp.x + -0x10,ptTorp.y + -0x10,
                           ((ushort *)rghiconVCR)[(iFrame & 3U) + 3]);
                  do {
                    TimerCount(0x14f8,&ti);
                    if ((ti.dwmsSinceStart._2_2_ < dwTickLast._2_2_) ||
                       ((ti.dwmsSinceStart._2_2_ <= dwTickLast._2_2_ &&
                        ((uint)ti.dwmsSinceStart < (uint)dwTickLast)))) break;
                    uVar10 = ((dwTickLast._2_2_ + (0xffdc < (uint)dwTickLast)) -
                             (viSpeedVCR * 10 >> 0xf)) -
                             (uint)((uint)dwTickLast + 0x23 < (uint)(viSpeedVCR * 10));
                  } while ((ti.dwmsSinceStart._2_2_ < uVar10) ||
                          ((ti.dwmsSinceStart._2_2_ <= uVar10 &&
                           ((uint)ti.dwmsSinceStart <
                            (uint)dwTickLast + 0x23 + viSpeedVCR * -10))));
                  dwTickLast._0_2_ = (uint)ti.dwmsSinceStart;
                  dwTickLast._2_2_ = ti.dwmsSinceStart._2_2_;
                  BitBlt(hdc,ptTorp.x + -0x10,ptTorp.y + -0x10,0x20,0x20,HVar19,0,0,0xcc0020);
                  lVar29 = (long)iVar12;
                  uVar28 = __aFulmul((long)iVar15,(long)iFrame);
                  lVar29 = __aFldiv(uVar28,lVar29);
                  ptTorp.x = sVar17 - (int)lVar29;
                  lVar29 = (long)iVar12;
                  uVar28 = __aFulmul((long)iVar16,(long)iFrame);
                  lVar29 = __aFldiv(uVar28,lVar29);
                  ptTorp.y = sVar5 - (int)lVar29;
                }
                SelectObject(HVar19,HVar21);
                DeleteObject(HVar20);
                DeleteDC(HVar19);
                goto LAB_10e8_43b4;
              }
              DeleteDC(HVar19);
            }
          }
        }
      }
    } while (sVar4 < ((BTLREC *)vlpbrVCR)->ctok);
    iFrame = 0;
    while( true ) {
      uVar27 = (undefined2)((ulong)vlpbrVCR >> 0x10);
      pBVar26 = (BTLREC *)vlpbrVCR;
      if (pBVar26->ctok <= iFrame) break;
      bVar1 = *(byte *)((int)pBVar26 + iFrame * 8 + 6);
      if (*(int *)((int)pBVar26 + iFrame * 8 + 8) == 0) {
        iVar6 = 0;
      }
      else {
        iVar6 = 2;
      }
      DrawIcon(hdc,(((TOK *)vrgtok)[bVar1].brc & 0xf) * (dxyVCRSquare + 3) +
                   dxyVCRSquare / 2 + -5,
               ((int)(uint)((TOK *)vrgtok)[bVar1].brc >> 4) * (dxyVCRSquare + 3)
               + dxyVCRSquare / 2 + -5,((ushort *)rghiconVCR)[iVar6]);
      iFrame = iFrame + 1;
    }
    fAnimate = 0;
  }
  return;
}



// ======================================================================
// Function: PopupVCRMenu
// Address: 10e8:4518
// Segment: MEMORY_VCR
// ======================================================================


short PopupVCRMenu(HWND hwnd,short x,short y,byte brc)

{
  byte bVar1;
  ushort uVar2;
  int iVar3;
  short sVar4;
  BTLREC *pBVar5;
  undefined2 uVar6;
  short cKilled;
  short cch;
  char *psz;
  short j;
  short iSel;
  short iChecked;
  short rgid [40];
  SHDEF *lpshdef;
  char rgch [1536];
  short c;
  short i;
  char *rgsz [1];
  short fAttack;
  
  c = 0;
  iChecked = -1;
  psz = rgch;
  bVar1 = ((TOK *)vrgtok)[(uint)((BTLREC *)vlpbrVCR)->wFlags >> 8].brc;
  for (i = 0; i < (int)(uint)((BTLDATA *)vlpbdVCR)->ctok; i = i + 1) {
    if ((((TOK *)vrgtok)[i].brc == brc) && (((TOK *)vrgtok)[i].csh != 0)) {
      PszPlayerName((uint)((TOK *)vrgtok)[i].iplr,0,0,0,0,(PLAYER *)0x0);
      uVar2 = _strlen((char *)szWork);
      if (((TOK *)vrgtok)[i].field2_0x3 == '\x01') {
        lpshdef._0_2_ =
             (SHDEF *)(*(int *)((uint)((TOK *)vrgtok)[i].iplr * 4 + 0x14c) +
                      (((TOK *)vrgtok)[i].ishdef - 0x10) * 0x93);
      }
      else {
        lpshdef._0_2_ =
             (SHDEF *)(*(int *)((uint)((TOK *)vrgtok)[i].iplr * 4 + 0xfe) +
                      (uint)((TOK *)vrgtok)[i].ishdef * 0x93);
      }
      iVar3 = _WSPRINTF((LPSTR)CONCAT22((((SHDEF *)lpshdef)->hul).szClass,(char *)&DAT_1120_1120),
                        (LPCSTR)0x14321120,(char *)szWork + uVar2);
      cch = uVar2 + iVar3;
      if (brc == bVar1) {
        uVar6 = (undefined2)((ulong)vlpbrVCR >> 0x10);
        pBVar5 = (BTLREC *)vlpbrVCR;
        if ((0 < pBVar5->ctok) && (-1 < viStepVCRCur)) {
          cKilled = 0;
          for (j = 0; j < pBVar5->ctok; j = j + 1) {
            if ((uint)*(byte *)((int)pBVar5 + j * 8 + 6) == i) {
              cKilled = cKilled + *(int *)((int)pBVar5 + j * 8 + 8);
            }
          }
          if (0 < cKilled) {
            iVar3 = _WSPRINTF((LPSTR)CONCAT22(cKilled,(char *)&DAT_1120_1120),(LPCSTR)0x143b1120,
                              (char *)szWork + cch);
            cch = cch + iVar3;
          }
        }
      }
      if ((rgch + 0x5ff <= psz + cch + 1) || (0x27 < c)) break;
      rgsz[c] = psz;
      rgid[c] = i;
      _strcpy(psz,(char *)szWork);
      psz = psz + cch + 1;
      if (i == viVCRFocus) {
        iChecked = c;
      }
      c = c + 1;
    }
  }
  if (c == 0) {
    sVar4 = -1;
  }
  else {
    sVar4 = PopupMenu(hwnd,x,y,c,(long *)0x0,rgsz,iChecked,1);
    if (sVar4 == -1) {
      sVar4 = -1;
    }
    else {
      sVar4 = rgid[sVar4];
    }
  }
  return sVar4;
}



// ======================================================================
// Function: EnableVCRButtons
// Address: 10e8:48f6
// Segment: MEMORY_VCR
// ======================================================================


void EnableVCRButtons(void)

{
  HWND HVar1;
  short i;
  
  for (i = 0xa1; i < 0xa3; i = i + 1) {
    HVar1 = GetDlgItem(hwndVCRDlg,i);
    EnableWindow(HVar1,(uint)((uint)viStepVCRCur < 0x8000));
  }
  for (i = 0xa3; i < 0xa6; i = i + 1) {
    HVar1 = GetDlgItem(hwndVCRDlg,i);
    EnableWindow(HVar1,(uint)(viStepVCRCur < vcStepVCR));
  }
  if (viStepVCRCur == -1) {
    HVar1 = GetDlgItem(hwndVCRDlg,0xa3);
    SetFocus(HVar1);
  }
  else if (viStepVCRCur == vcStepVCR) {
    HVar1 = GetDlgItem(hwndVCRDlg,1);
    SetFocus(HVar1);
  }
  return;
}



