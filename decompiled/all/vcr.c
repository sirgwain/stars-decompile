// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: BattleVCR
// Address: 10e8:0000
// Segment: MEMORY_VCR
// ======================================================================


void BattleVCR(short iBattle)

{
  HB *pHVar1;
  int iVar2;
  short (*pasVar3) [9];
  short sVar4;
  char *sz;
  undefined2 uVar5;
  FARPROC lpDlgProc;
  HB *lphb;
  short env [9];
  short (*penvMemSav) [9];
  fn_lpProc *lpProc;
  
                    /* Segment:    30
                       Offset:     000cf8c0
                       Length:     49be
                       Min Alloc:  49be
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  pasVar3 = penvMem;
  lpDlgProc = (FARPROC)0x0;
  viStepVCRCur = -1;
  if ((uint)gd.grBits >> 0xe < 2) {
    dxyVCRBoard = 0x161;
    dxyVCRSquare = 0x20;
  }
  else {
    dxyVCRBoard = 0x2a1;
    dxyVCRSquare = 0x40;
  }
  lphb = (HB *)CONCAT22(rglphb[0xb]._2_2_,(HB *)rglphb[0xb]);
  vlpbdVCR =
       (BTLDATA *)CONCAT22(rglphb[0xb]._2_2_,&((HB *)rglphb[0xb])[1].cbBlock);
  while( true ) {
    while( true ) {
      if (vlpbdVCR->id == iBattle) {
        vlpbdVCRNext._0_2_ =
             (BTLDATA *)
             ((int)&((BTLDATA *)vlpbdVCR)->id + ((BTLDATA *)vlpbdVCR)->cbData);
        vlpbdVCRNext._2_2_ = vlpbdVCR._2_2_;
        penvMem = &env;
        gd.grBits._0_2_ = (uint)gd.grBits & 0xdfff;
        sVar4 = __setjmp(env);
        if (sVar4 == 0) {
          vrgtok =
               LpAlloc((uint)((BTLDATA *)vlpbdVCR)->ctok * 0x1d,htMisc);
          vrgdpVCR = LpAlloc((uint)((BTLDATA *)vlpbdVCR)->ctok << 2,htMisc)
          ;
          sVar4 = SetVCRBoard(30000);
          vcStepVCR = sVar4 + -1;
          vcRound = viRound;
          SetVCRBoard(-1);
          if (((uint)gd.grBits >> 0xb & 1) != 0) {
            AdvanceTutor();
          }
          lpDlgProc = MakeProcInstance(VCRDlg,hInst);
          DialogBox(0,IDD_DLG160_160,hwndFrame,lpDlgProc);
        }
        else {
          sVar4 = 0x10;
          penvMem = pasVar3;
          sz = PszFormatIds(idsMemory,(short *)0x0);
          AlertSz(sz,sVar4);
        }
        if (lpDlgProc != (FARPROC)0x0) {
          FreeProcInstance(lpDlgProc);
        }
        if (vrgtok != (TOK *)0x0) {
          FreeLp(vrgtok,htMisc);
        }
        if (vrgdpVCR != (long *)0x0) {
          FreeLp(vrgdpVCR,htMisc);
        }
        vrgtok._2_2_ = 0;
        vrgtok._0_2_ = (TOK *)0x0;
        vrgdpVCR._2_2_ = 0;
        vrgdpVCR._0_2_ = (long *)0x0;
        return;
      }
      if (vlpbdVCR->id == 0xffff) break;
      vlpbdVCR =
           (BTLDATA *)
           CONCAT22(vlpbdVCR._2_2_,
                    (BTLDATA *)
                    ((int)&((BTLDATA *)vlpbdVCR)->id +
                    ((BTLDATA *)vlpbdVCR)->cbData));
    }
    uVar5 = (undefined2)((ulong)lphb >> 0x10);
                    /* WARNING: Load size is inaccurate */
    pHVar1 = ((HB *)lphb)->lphbNext;
    iVar2 = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
    lphb = (HB *)CONCAT22(iVar2,pHVar1);
    if ((pHVar1 == (HB *)0x0) && (iVar2 == 0)) break;
    vlpbdVCR = (BTLDATA *)CONCAT22(iVar2,&pHVar1[1].cbBlock);
  }
  gd.grBits._0_2_ = (uint)gd.grBits & 0xdfff;
  viStepVCRCur = -1;
  return;
}



// ======================================================================
// Function: CBattles
// Address: 10e8:028c
// Segment: MEMORY_VCR
// ======================================================================


short CBattles(void)

{
  HB *pHVar1;
  int iVar2;
  BTLDATA *pBVar3;
  undefined2 uVar4;
  short cBattles;
  HB *lphb;
  BTLDATA *lpbd;
  
  cBattles = 0;
  lphb = (HB *)CONCAT22(rglphb[0xb]._2_2_,(HB *)rglphb[0xb]);
  if (((HB *)rglphb[0xb] == (HB *)0x0) && (rglphb[0xb]._2_2_ == 0)) {
    cBattles = 0;
  }
  else {
    lpbd = (BTLDATA *)CONCAT22(rglphb[0xb]._2_2_,&((HB *)rglphb[0xb])[1].cbBlock);
    while( true ) {
      while (lpbd->id != 0xffff) {
        uVar4 = (undefined2)((ulong)lpbd >> 0x10);
        pBVar3 = (BTLDATA *)lpbd;
        if (pBVar3->cbData == 0) {
          return cBattles;
        }
        cBattles = cBattles + 1;
        lpbd = (BTLDATA *)CONCAT22(uVar4,(BTLDATA *)((int)&pBVar3->id + pBVar3->cbData));
      }
      uVar4 = (undefined2)((ulong)lphb >> 0x10);
                    /* WARNING: Load size is inaccurate */
      pHVar1 = ((HB *)lphb)->lphbNext;
      iVar2 = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
      lphb = (HB *)CONCAT22(iVar2,pHVar1);
      if (((pHVar1 == (HB *)0x0) && (iVar2 == 0)) || (pHVar1->ibTop < 0x11)) break;
      lpbd = (BTLDATA *)CONCAT22(iVar2,&pHVar1[1].cbBlock);
    }
  }
  return cBattles;
}



// ======================================================================
// Function: BtlDataGet
// Address: 10e8:0362
// Segment: MEMORY_VCR
// ======================================================================


BTLDATA * BtlDataGet(short i)

{
  HB *pHVar1;
  int iVar2;
  BTLDATA *pBVar3;
  undefined2 uVar4;
  HB *lphb;
  BTLDATA *lpbd;
  
  lphb = (HB *)CONCAT22(rglphb[0xb]._2_2_,(HB *)rglphb[0xb]);
  if (((HB *)rglphb[0xb] == (HB *)0x0) && (rglphb[0xb]._2_2_ == 0)) {
    pBVar3 = (BTLDATA *)0x0;
    uVar4 = 0;
  }
  else {
    lpbd = (BTLDATA *)CONCAT22(rglphb[0xb]._2_2_,&((HB *)rglphb[0xb])[1].cbBlock);
    while( true ) {
      while (lpbd->id != 0xffff) {
        uVar4 = (undefined2)((ulong)lpbd >> 0x10);
        pBVar3 = (BTLDATA *)lpbd;
        if (pBVar3->cbData == 0) {
          pBVar3 = (BTLDATA *)0x0;
          uVar4 = 0;
          goto LAB_10e8_0449;
        }
        if (i < 1) goto LAB_10e8_0449;
        i = i + -1;
        lpbd = (BTLDATA *)CONCAT22(uVar4,(BTLDATA *)((int)&pBVar3->id + pBVar3->cbData));
      }
      uVar4 = (undefined2)((ulong)lphb >> 0x10);
                    /* WARNING: Load size is inaccurate */
      pHVar1 = ((HB *)lphb)->lphbNext;
      iVar2 = *(int *)((int)&((HB *)lphb)->lphbNext + 2);
      lphb = (HB *)CONCAT22(iVar2,pHVar1);
      if (((pHVar1 == (HB *)0x0) && (iVar2 == 0)) || (pHVar1->ibTop < 0x11)) break;
      lpbd = (BTLDATA *)CONCAT22(iVar2,&pHVar1[1].cbBlock);
    }
    pBVar3 = (BTLDATA *)0x0;
    uVar4 = 0;
  }
LAB_10e8_0449:
  return (BTLDATA *)CONCAT22(uVar4,pBVar3);
}



// ======================================================================
// Function: CBattleUnits
// Address: 10e8:0450
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Type propagation algorithm not settling */

long CBattleUnits(BTLDATA *lpbd,ushort grbitBU)

{
  byte bVar1;
  int iVar2;
  uint uVar3;
  BTLDATA *pBVar4;
  int iVar5;
  undefined2 uVar6;
  bool bVar7;
  HULDEF *pHVar8;
  short imd;
  short i;
  long lUnits;
  short ctok;
  TOK *lptok;
  
  uVar6 = (undefined2)((ulong)lpbd >> 0x10);
  pBVar4 = (BTLDATA *)lpbd;
  bVar1 = pBVar4->ctok;
  lUnits._0_2_ = 0;
  lUnits._2_2_ = 0;
  i = 0;
  do {
    if ((int)(uint)bVar1 <= i) {
      return CONCAT22(lUnits._2_2_,(uint)lUnits);
    }
    iVar2 = i * 0x1d;
    if ((uint)*(byte *)((int)pBVar4 + iVar2 + 0x10) == idPlayer) {
      uVar3 = grbitBU & 1;
    }
    else {
      uVar3 = grbitBU & 2;
    }
    if ((uVar3 != 0) && (((grbitBU & 4) != 0 || (*(byte *)((int)pBVar4 + iVar2 + 0x12) < 0x10)))) {
      if (((grbitBU & 0xf8) != 0xf8) && (*(byte *)((int)pBVar4 + iVar2 + 0x12) < 0x10)) {
        iVar5 = (uint)*(byte *)((int)pBVar4 + iVar2 + 0x10) * 4;
        pHVar8 = LphuldefFromId
                           (*(HullDef *)
                             (*(int *)(iVar5 + rglpshdef) +
                             (uint)*(byte *)((int)pBVar4 + iVar2 + 0x12) * 0x93));
        uVar3 = ((HULDEF *)pHVar8)->wFlags_0x7b >> 10 & 0xf;
        if ((uVar3 < 2) || (5 < uVar3)) {
          uVar3 = grbitBU & 8;
        }
        else if (uVar3 == 2) {
          uVar3 = grbitBU & 0x10;
        }
        else if (uVar3 == 3) {
          uVar3 = grbitBU & 0x20;
        }
        else if (uVar3 == 5) {
          uVar3 = grbitBU & 0x40;
        }
        else {
          if (uVar3 != 4) goto LAB_10e8_0600;
          uVar3 = grbitBU & 0x80;
        }
        if (uVar3 == 0) goto LAB_10e8_0610;
      }
LAB_10e8_0600:
      uVar3 = *(uint *)((int)pBVar4 + iVar2 + 0x21);
      bVar7 = CARRY2((uint)lUnits,uVar3);
      lUnits._0_2_ = (uint)lUnits + uVar3;
      lUnits._2_2_ = lUnits._2_2_ + (uint)bVar7;
    }
LAB_10e8_0610:
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: CBattleKills
// Address: 10e8:062e
// Segment: MEMORY_VCR
// ======================================================================


long CBattleKills(BTLDATA *lpbd,short fOurDead)

{
  uint uVar1;
  undefined2 uVar2;
  bool bVar3;
  short cKill;
  BTLREC *lpbr;
  short i;
  BTLDATA *lpbdNext;
  long cKilled;
  
  lpbr = (BTLREC *)
         CONCAT22(lpbd._2_2_,
                  (BTLREC *)((int)(BTLDATA *)lpbd + (uint)((BTLDATA *)lpbd)->ctok * 0x1d + 0xe));
  cKilled._0_2_ = 0;
  cKilled._2_2_ = 0;
  while ((BTLREC *)lpbr < (BTLREC *)((int)&((BTLDATA *)lpbd)->id + ((BTLDATA *)lpbd)->cbData)) {
    uVar2 = (undefined2)((ulong)lpbr >> 0x10);
    for (i = 0; i < ((BTLREC *)lpbr)->ctok; i = i + 1) {
      if (*(int *)((int)(BTLREC *)lpbr + i * 8 + 8) != 0) {
        if ((uint)*(byte *)((int)(BTLDATA *)lpbd +
                           (uint)*(byte *)((int)(BTLREC *)lpbr + i * 8 + 6) * 0x1d + 0x10) ==
            idPlayer) {
          if (fOurDead != 0) {
            uVar1 = *(uint *)((int)(BTLREC *)lpbr + i * 8 + 8);
            bVar3 = CARRY2((uint)cKilled,uVar1);
            cKilled._0_2_ = (uint)cKilled + uVar1;
            cKilled._2_2_ = cKilled._2_2_ + (uint)bVar3;
          }
        }
        else if (fOurDead == 0) {
          uVar1 = *(uint *)((int)(BTLREC *)lpbr + i * 8 + 8);
          bVar3 = CARRY2((uint)cKilled,uVar1);
          cKilled._0_2_ = (uint)cKilled + uVar1;
          cKilled._2_2_ = cKilled._2_2_ + (uint)bVar3;
        }
      }
    }
    lpbr = (BTLREC *)
           CONCAT22(uVar2,(BTLREC *)((int)(BTLREC *)lpbr + ((BTLREC *)lpbr)->ctok * 8 + 6));
  }
  return CONCAT22(cKilled._2_2_,(uint)cKilled);
}



// ======================================================================
// Function: LdpFromItokDv
// Address: 10e8:07a8
// Segment: MEMORY_VCR
// ======================================================================


long LdpFromItokDv(short itok,DV *lpdv)

{
  uint uVar1;
  SHDEF *pSVar2;
  ulong uVar3;
  ulong uVar4;
  long lVar5;
  ulong uVar6;
  long lVar7;
  long dp;
  short csh;
  ushort dpShdef;
  DV dv;
  
  if (((DV *)lpdv == (DV *)0x0) && (lpdv._2_2_ == 0)) {
    dv.dp = 0;
  }
  else {
    dv = (DV)lpdv->dp;
  }
  pSVar2 = LpshdefFromTok
                     ((TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok + itok));
  uVar1 = (((SHDEF *)pSVar2)->hul).dp;
  uVar3 = __aFulmul((ulong)uVar1,(ulong)((TOK *)vrgtok)[itok].csh);
  if (dv.dp != 0) {
    lVar5 = 100;
    uVar4 = __aFulmul((ulong)((TOK *)vrgtok)[itok].csh,(ulong)dv.dp & 0xffff007f);
    lVar5 = __aFldiv(uVar4,lVar5);
    csh = (short)lVar5;
    if (csh < 1) {
      csh = 1;
    }
    lVar7 = 0x32;
    uVar6 = (ulong)csh;
    lVar5 = 10;
    uVar4 = __aFulmul((ulong)uVar1,(ulong)(dv.dp >> 7));
    uVar4 = __aFldiv(uVar4,lVar5);
    uVar4 = __aFulmul(uVar4,uVar6);
    lVar5 = __aFldiv(uVar4,lVar7);
    uVar3 = uVar3 - lVar5;
  }
  return uVar3;
}



// ======================================================================
// Function: SetVCRBoard
// Address: 10e8:08d8
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10e80bd4) */

short SetVCRBoard(short iStep)

{
  ushort *puVar1;
  TOK *pTVar2;
  uint itok_00;
  int iVar3;
  BTLDATA *pBVar4;
  BTLREC *pBVar5;
  TOK *pTVar6;
  undefined2 unaff_SI;
  ushort *puVar7;
  long *plVar8;
  undefined2 unaff_DI;
  undefined2 uVar9;
  undefined2 uVar10;
  long lVar11;
  ulong uVar12;
  long lVar13;
  uint in_stack_0000ffee;
  short itok;
  short i;
  TOK *ptok;
  
  lVar13 = CONCAT22(unaff_SI,unaff_DI);
  if ((iStep != viStepVCRCur) || (viStepVCRCur == -1)) {
    if ((iStep < viStepVCRCur) || (viStepVCRCur == -1)) {
      i = 0;
      while( true ) {
        uVar9 = (undefined2)((ulong)vlpbdVCR >> 0x10);
        pBVar4 = (BTLDATA *)vlpbdVCR;
        uVar10 = vrgtok._2_2_;
        if ((int)(uint)pBVar4->ctok <= i) break;
        puVar7 = (ushort *)((int)pBVar4 + i * 0x1d + 0xe);
        pTVar6 = (TOK *)vrgtok + i;
        for (iVar3 = 0xe; iVar3 != 0; iVar3 = iVar3 + -1) {
          pTVar2 = pTVar6;
          pTVar6 = &pTVar6->iplr;
          puVar1 = puVar7;
          puVar7 = puVar7 + 1;
          pTVar2->id = *puVar1;
        }
        *&pTVar6->id = (char)*puVar7;
        lVar11 = LdpFromItokDv(i,(DV *)CONCAT22(vrgtok._2_2_,
                                                &((TOK *)vrgtok)[i].dv));
        uVar10 = vrgdpVCR._2_2_;
        plVar8 = (long *)vrgdpVCR + i;
        *(int *)plVar8 = (int)lVar11;
        *(undefined2 *)((int)plVar8 + 2) = (int)((ulong)lVar11 >> 0x10);
        i = i + 1;
      }
      viStepVCRCur = -1;
      viRound = 0;
      viVCRFocus = 0;
      vbrcVCRFocus = ((TOK *)vrgtok)->brc;
      vlpbrVCR =
           (BTLREC *)CONCAT22(uVar9,(BTLREC *)((int)pBVar4 + (uint)pBVar4->ctok * 0x1d + 0xe));
    }
    while ((viStepVCRCur < iStep &&
           ((BTLREC *)vlpbrVCR < (BTLDATA *)vlpbdVCRNext))) {
      if (-1 < viStepVCRCur) {
        i = 0;
        while( true ) {
          uVar9 = (undefined2)((ulong)vlpbrVCR >> 0x10);
          pBVar5 = (BTLREC *)vlpbrVCR;
          pTVar6 = (TOK *)vrgtok;
          uVar10 = vrgtok._2_2_;
          if (pBVar5->ctok <= i) break;
          itok_00 = (uint)*(byte *)((int)pBVar5 + i * 8 + 6);
          ((TOK *)vrgtok)[itok_00].csh =
               ((TOK *)vrgtok)[itok_00].csh - *(int *)((int)pBVar5 + i * 8 + 8);
          (&pTVar6[itok_00].dv)->dp = *(ushort *)((int)(BTLREC *)vlpbrVCR + i * 8 + 0xc);
          lVar11 = LdpFromItokDv(itok_00,(DV *)CONCAT22(vlpbrVCR._2_2_,
                                                        (DV *)((int)(BTLREC *)vlpbrVCR +
                                                              i * 8 + 0xc)));
          uVar9 = vrgdpVCR._2_2_;
          plVar8 = (long *)vrgdpVCR + itok_00;
          *(int *)plVar8 = (int)lVar11;
          *(undefined2 *)((int)plVar8 + 2) = (int)((ulong)lVar11 >> 0x10);
          if (pTVar6[itok_00].dpShield != 0) {
            if (*(int *)((int)(BTLREC *)vlpbrVCR + i * 8 + 10) != 0) {
              uVar12 = __aFulmul((ulong)pTVar6[itok_00].dpShield,(ulong)pTVar6[itok_00].csh)
              ;
              lVar11 = __aFlshl(lVar13,in_stack_0000ffee);
              if (lVar11 < (long)uVar12) {
                uVar12 = (ulong)pTVar6[itok_00].csh;
                lVar11 = __aFlshl(uVar12,(ushort)lVar13);
                lVar11 = __aFldiv(lVar11,uVar12);
                pTVar6[itok_00].dpShield = pTVar6[itok_00].dpShield - (int)lVar11;
              }
              else {
                pTVar6[itok_00].dpShield = 0;
              }
            }
          }
          i = i + 1;
        }
        pBVar5 = (BTLREC *)((int)pBVar5 + pBVar5->ctok * 8 + 6);
        vlpbrVCR = (BTLREC *)CONCAT22(uVar9,pBVar5);
        if ((uint)viRound < (pBVar5->wFlags_0x4 & 0xf)) {
          viRound = pBVar5->wFlags_0x4 & 0xf;
          ptok = vrgtok;
          for (i = 0; i < (int)(uint)((BTLDATA *)vlpbdVCR)->ctok; i = i + 1) {
            uVar10 = (undefined2)((ulong)ptok >> 0x10);
            pTVar6 = (TOK *)ptok;
            if ((pTVar6->wFlags >> 3 & 1) != 0) {
              RegenShield(ptok);
            }
            pTVar6->wFlags = pTVar6->wFlags & 0xffef;
            ptok = (TOK *)CONCAT22(uVar10,pTVar6 + 1);
          }
        }
      }
      if ((BTLREC *)vlpbrVCR < (BTLDATA *)vlpbdVCRNext) {
        ((TOK *)vrgtok)[vlpbrVCR->itok].brc =
             ((BTLREC *)vlpbrVCR)->brcDest;
        vbrcVCRFocus = ((TOK *)vrgtok)[vlpbrVCR->itok].brc;
        viVCRFocus = (short)vlpbrVCR->itok;
        in_stack_0000ffee =
             ((TOK *)vrgtok)[vlpbrVCR->itok].wFlags & 0xfc1f |
             (((BTLREC *)vlpbrVCR)->wFlags_0x4 >> 4 & 0xf) << 5;
        ((TOK *)vrgtok)[vlpbrVCR->itok].wFlags = in_stack_0000ffee;
        if ((((TOK *)vrgtok)[vlpbrVCR->itok].wFlags >> 5 & 0x1f) == 4) {
          ((TOK *)vrgtok)[vlpbrVCR->itok].wFlags_0x17 =
               ((TOK *)vrgtok)[vlpbrVCR->itok].wFlags_0x17 & 0xf0ff;
        }
      }
      viStepVCRCur = viStepVCRCur + 1;
    }
    EnableVCRButtons();
    iStep = viStepVCRCur;
  }
  return iStep;
}



// ======================================================================
// Function: VCRDlg
// Address: 10e8:0e90
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short VCRDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  POINT PVar1;
  POINT PVar2;
  POINT PVar3;
  HWND HVar4;
  BOOL BVar5;
  char *pcVar6;
  HDC HVar7;
  short sVar8;
  UINT UVar9;
  byte brc;
  int iVar10;
  undefined1 *puVar11;
  ushort unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar12;
  undefined2 unaff_SS;
  ulong uVar13;
  undefined1 uVar14;
  undefined1 uVar15;
  ushort in_stack_0000ffc0;
  undefined1 local_3e [24];
  COLORREF local_26;
  int local_22;
  int local_20;
  RECT *local_1e;
  undefined1 local_1c [8];
  short local_14;
  RECT rc;
  short ibtn;
  short i;
  HDC hdc;
  
  uVar12 = 0x10e8;
  puVar11 = &stack0xffbc;
  if (message == WM_DESTROY) {
    hwndVCRDlg = 0;
    return 0;
  }
  uVar14 = (undefined1)unaff_SS;
  uVar15 = (undefined1)((uint)unaff_SS >> 8);
  if (message == WM_PAINT) {
    HVar7 = BeginPaint(hwnd,local_3e + 0xc);
    DrawVCR(HVar7,-1,-1);
    EndPaint(hwnd,(PAINTSTRUCT *)CONCAT13(uVar15,CONCAT12(uVar14,local_3e + 0xc)));
    return 1;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    return 1;
  }
  if (message == WM_SETCURSOR) {
    GetCursorPos((POINT *)CONCAT13(uVar15,CONCAT12(uVar14,local_1c + 6)));
    ScreenToClient(hwnd,local_1c + 6);
    if ((((8 < (int)local_1c._6_2_) && ((int)local_1c._6_2_ < (dxyVCRSquare + 3) * 10 + 8)
         ) && (7 < local_14)) && (local_14 < (dxyVCRSquare + 3) * 10 + 8)) {
      setcursor(hcurHand);
      return 1;
    }
    return 0;
  }
  if (message == WM_INITDIALOG) {
    hwndVCRDlg = hwnd;
    GetWindowRect(hwnd,local_1c);
    GetClientRect(hwnd,&rc);
    local_14 = (local_1c._6_2_ - local_1c._2_2_) - rc.bottom;
    HVar4 = GetDlgItem(hwnd,IDC_U16_0x00A1);
    GetWindowRect(HVar4,&rc);
    SetWindowPos(hwnd,0,0,0,dxyVCRBoard + 0xfa,
                 local_14 + 0x18 + dxyVCRBoard + (rc.bottom - rc.top),6);
    for (i = 0; i < 7; i = i + 1) {
      if (i < 5) {
        ibtn = i + 0xa1;
      }
      else if (i == 5) {
        ibtn = 1;
      }
      else if (i == 6) {
        ibtn = 0x76;
      }
      HVar4 = GetDlgItem(hwnd,ibtn);
      GetWindowRect(HVar4,&rc);
      MapWindowPoints(0,hwnd,(POINT *)&rc,2);
      if (dxyVCRSquare < 0x40) {
        local_1e = (RECT *)0x0;
      }
      else {
        local_20 = ((rc.right - rc.left) + 8) * i;
        local_22 = ((rc.right - rc.left) * 7) / 2;
        local_1e = (RECT *)(((dxyVCRBoard / 2 - local_22) + -0x10 + local_20) - rc.left);
      }
      OffsetRect((RECT *)CONCAT13(uVar15,CONCAT12(uVar14,&rc)),(short)local_1e,
                 (dxyVCRBoard + 0x10) - rc.top);
      HVar4 = GetDlgItem(hwnd,ibtn);
      SetWindowPos(HVar4,0,rc.left,rc.top,0,0,5);
    }
    EnableVCRButtons();
    StickyDlgPos(hwnd,(POINT *)&ptStickyVCRDlg,1);
    fAnimate = 1;
    return 1;
  }
  if (message == WM_COMMAND) {
    if ((wParam < 0xa1) || (0xa5 < wParam)) {
      if ((wParam != 1) && (wParam != 2)) {
        if (wParam != 0x76) {
          return 0;
        }
        WinHelp(hwnd,_szHelpFile,1,0x43a);
        return 1;
      }
      if (((uint)gd.grBits >> 0xd & 1) != 0) {
        gd.grBits._0_2_ = (uint)gd.grBits & 0xdfff;
        KillTimer(hwnd,0xa6c);
      }
      if (((uint)gd.grBits >> 0xb & 1) != 0) {
        tutor.wFlags = tutor.wFlags & 0xfbffU | 0x400;
      }
      StickyDlgPos(hwnd,(POINT *)&ptStickyVCRDlg,0);
      EndDialog(hwnd,i);
      return 1;
    }
    i = wParam - 0xa1;
    if (((uint)gd.grBits >> 0xd & 1) != 0) {
VCR_KillTime:
      KillTimer(hwnd,0xa6c);
      gd.grBits._0_2_ = (uint)gd.grBits & 0xdfff;
      if (i == 2) {
        return 0;
      }
    }
    sVar8 = GetAsyncKeyState(0x11);
    puVar11 = &stack0xffba;
    if (sVar8 < 0) {
      local_1c._6_2_ = 100;
    }
    else {
      sVar8 = GetAsyncKeyState(0x10);
      puVar11 = &stack0xffb8;
      if (sVar8 < 0) {
        local_1c._6_2_ = 10;
      }
      else {
        local_1c._6_2_ = 1;
        puVar11 = &stack0xffb8;
      }
    }
    uVar12 = 0x14f8;
    fAnimate = 0;
    if (i == 0) {
      local_14 = -1;
      goto LAB_10e8_1807;
    }
    if (i == 1) {
      local_14 = viStepVCRCur - local_1c._6_2_;
      if (viStepVCRCur - local_1c._6_2_ < -1) {
        local_14 = -1;
      }
      goto LAB_10e8_1807;
    }
    if (i == 2) {
      *(HWND *)(puVar11 + -2) = hwnd;
      *(undefined2 *)(puVar11 + -4) = 0xa6c;
      *(short *)(puVar11 + -6) = viSpeedVCR * -0x78 + 0x23a;
      *(undefined2 *)(puVar11 + -8) = 0;
      *(undefined2 *)(puVar11 + -10) = 0;
      *(undefined2 *)(puVar11 + -0xc) = 0x14f8;
      uVar12 = 0x14f8;
      *(undefined2 *)(puVar11 + -0xe) = 0x1759;
      UVar9 = SetTimer(*(HWND *)(puVar11 + -4),*(UINT *)(puVar11 + -6),*(UINT *)(puVar11 + -8),
                       *(undefined2 *)(puVar11 + -10));
      local_1c._4_2_ = (uint)(UVar9 != 0);
      gd.grBits._0_2_ = (uint)gd.grBits & 0xdfff | (uint)(UVar9 != 0) << 0xd;
    }
    else if (i != 3) {
      if (i == 4) {
        local_14 = vcStepVCR;
      }
      goto LAB_10e8_1807;
    }
  }
  else {
    if (message != WM_TIMER) {
      if ((message != WM_LBUTTONDOWN) && (message != WM_RBUTTONDOWN)) {
        return 0;
      }
      local_1c._4_2_ = (short)lParam;
      uVar13 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc0);
      local_1c._6_2_ = (undefined2)uVar13;
      PVar1.y = local_1c._6_2_;
      PVar1.x = local_1c._4_2_;
      BVar5 = PtInRect(rgrcBuildSpin,PVar1);
      if ((BVar5 != 0) ||
         (PVar2.y = local_1c._6_2_, PVar2.x = local_1c._4_2_,
         BVar5 = PtInRect(rgrcBuildSpin + 1,PVar2), BVar5 != 0)) {
        PVar3.y = local_1c._6_2_;
        PVar3.x = local_1c._4_2_;
        BVar5 = PtInRect(rgrcBuildSpin,PVar3);
        if (BVar5 == 0) {
          local_20 = 1;
          local_1c._0_2_ = 0x23;
          local_1e = (RECT *)(rgrcBuildSpin + 1);
        }
        else {
          local_20 = -1;
          local_1c._0_2_ = 0x22;
          local_1e = (RECT *)rgrcBuildSpin;
        }
        local_22 = viSpeedVCR;
        if (viSpeedVCR < 5) {
          if (viSpeedVCR < 0) {
            local_22 = 0;
          }
        }
        else {
          local_22 = 4;
        }
        HVar7 = GetDC(hwnd);
        local_1c._2_2_ = SetBkMode(HVar7,2);
        local_26 = SetBkColor(HVar7,CONCAT22(crButtonFace._2_2_,
                                             (undefined2)crButtonFace));
        SelectObject(HVar7,rghfontArial8[1]);
        InitBtnTrack(local_3e,hwnd,0,local_1e,local_1c._0_2_,0x50,0,0,(char *)0x0);
        while( true ) {
          sVar8 = FTrackBtn(local_3e);
          if (sVar8 == 0) break;
          if (((local_20 == -1) && (0 < local_22)) || ((local_20 == 1 && (local_22 < 4)))) {
            local_22 = local_22 + local_20;
            pcVar6 = PszGetCompressedString(idsPlaybackSpeedD);
            local_1c._0_2_ = _wsprintf(szWork,pcVar6);
            TextOut(HVar7,ptSpeedVCR.x,ptSpeedVCR.y,szWork,
                    local_1c._0_2_);
          }
        }
        viSpeedVCR = local_22;
        SelectObject(HVar7,rghfontArial8[0]);
        SetBkColor(HVar7,local_26);
        ReleaseDC(hwnd,HVar7);
        if (((uint)gd.grBits >> 0xd & 1) != 0) {
          KillTimer(hwnd,0xa6c);
          UVar9 = SetTimer(0xa6c,viSpeedVCR * -0x78 + 0x23a,0,0);
          gd.grBits._0_2_ = (uint)gd.grBits & 0xdfff | (uint)(UVar9 != 0) << 0xd;
        }
        return 1;
      }
      local_1c._4_2_ = (local_1c._4_2_ + -8) / (dxyVCRSquare + 3);
      local_1c._6_2_ = (local_1c._6_2_ + -8) / (dxyVCRSquare + 3);
      if ((((9 < (int)local_1c._4_2_) && (1 < (int)local_1c._6_2_)) && ((int)local_1c._6_2_ < 10))
         && (-1 < viVCRFocus)) {
        GlobalPD.grPopup = 0xb;
        if (*&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 == '\x01') {
          local_1c._2_2_ =
               (*(byte *)((int)&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 + 1) -
               0x10) * 0x93;
          iVar10 = (uint)((TOK *)vrgtok)[viVCRFocus].iplr * 4;
          GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 =
               *(ushort *)(iVar10 + rglpshdefSB_0x2);
          GlobalPD.u_POPUPDATA_0x0002.lpfl._0_2_ =
               (FLEET *)(*(int *)(iVar10 + rglpshdefSB) + local_1c._2_2_);
        }
        else {
          local_1c._2_2_ =
               (uint)*(byte *)((int)&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 +
                              1) * 0x93;
          iVar10 = (uint)((TOK *)vrgtok)[viVCRFocus].iplr * 4;
          GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 =
               *(ushort *)(iVar10 + rglpshdef_0x2);
          GlobalPD.u_POPUPDATA_0x0002.lpfl._0_2_ =
               (FLEET *)(*(int *)(iVar10 + rglpshdef) + local_1c._2_2_);
        }
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = 1;
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = 1;
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate =
             (short)((uint)((TOK *)vrgtok)[viVCRFocus].iplr != idPlayer);
        uVar13 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc0);
        Popup(hwnd,(short)lParam,(short)uVar13);
        return 0;
      }
      if ((int)local_1c._4_2_ < 0) {
        return 0;
      }
      if ((int)local_1c._6_2_ < 0) {
        return 0;
      }
      if (9 < (int)local_1c._4_2_) {
        return 0;
      }
      if (9 < (int)local_1c._6_2_) {
        return 0;
      }
      brc = (byte)((local_1c._6_2_ & 0xf) << 4) | (byte)local_1c._4_2_ & 0xf;
      local_14 = CONCAT11(local_14._1_1_,brc);
      if (message == WM_RBUTTONDOWN) {
        uVar13 = __aFulshr(CONCAT22(unaff_DI,(uint)brc),unaff_SI);
        local_1c._2_2_ = PopupVCRMenu(hwnd,(short)lParam,(short)uVar13,brc);
        if ((int)local_1c._2_2_ < 0) {
          return 0;
        }
        vbrcVCRFocus = (byte)local_14;
        viVCRFocus = local_1c._2_2_;
      }
      else {
        uVar12 = (undefined2)((ulong)vlpbdVCR >> 0x10);
        if ((brc != vbrcVCRFocus) || (viVCRFocus == -1)) {
          viVCRFocus = ((BTLDATA *)vlpbdVCR)->ctok - 1;
          vbrcVCRFocus = brc;
        }
        i = viVCRFocus;
        do {
          i = i + 1;
          if (i == (uint)((BTLDATA *)vlpbdVCR)->ctok) {
            i = 0;
          }
          local_1c._2_2_ = ZEXT12(((TOK *)vrgtok)[i].brc);
          if ((local_1c._2_2_ == (uint)brc) && (((TOK *)vrgtok)[i].csh != 0)) {
            viVCRFocus = i;
            goto VCR_GoodSel;
          }
        } while (i != viVCRFocus);
        viVCRFocus = -1;
      }
VCR_GoodSel:
      DrawVCR(0,-2,-1);
      return 0;
    }
    if (((uint)gd.grBits >> 0xd & 1) == 0) {
      return 0;
    }
    if (viStepVCRCur == vcStepVCR) {
      i = 2;
      goto VCR_KillTime;
    }
  }
  if (i == 3) {
    local_14 = viStepVCRCur + local_1c._6_2_;
  }
  else {
    local_14 = viStepVCRCur + 1;
  }
  if (vcStepVCR < local_14) {
    local_14 = vcStepVCR;
  }
  fAnimate = (short)(viSpeedVCR < 4);
LAB_10e8_1807:
  *(short *)(puVar11 + -2) = local_14;
  *(undefined2 *)(puVar11 + -4) = uVar12;
  *(undefined2 *)(puVar11 + -6) = 0x180f;
  SetVCRBoard(*(short *)(puVar11 + -2));
  *(undefined2 *)(puVar11 + -2) = 0xffff;
  *(undefined2 *)(puVar11 + -4) = 0xfffe;
  *(undefined2 *)(puVar11 + -6) = 0;
  *(undefined2 *)(puVar11 + -8) = 0x10e8;
  *(undefined2 *)(puVar11 + -10) = 0x1823;
  DrawVCR(*(HDC *)(puVar11 + -6),*(short *)(puVar11 + -4),*(short *)(puVar11 + -2));
  return 0;
}



// ======================================================================
// Function: GetVCRStats
// Address: 10e8:193e
// Segment: MEMORY_VCR
// ======================================================================


void GetVCRStats(short itok,long *pdpArmor,DV *pdv,long *pdpShields,short *pcsh)

{
  undefined2 uVar1;
  undefined2 uVar2;
  uint uVar3;
  int iVar4;
  BTLREC *pBVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar6;
  long lVar7;
  SHDEF *pSVar8;
  ulong uVar9;
  ulong uVar10;
  long lVar11;
  ulong uVar12;
  ulong uVar13;
  long lVar14;
  ushort in_stack_0000ffe8;
  ushort dpShdef;
  short cshKill;
  short i;
  long dpArmor;
  long dpShields;
  DV dv;
  short cshT;
  
  lVar14 = CONCAT22(unaff_SI,unaff_DI);
  uVar12 = 0;
  cshKill = 0;
  dv.dp = 0xffff;
  uVar1 = (undefined2)((long *)vrgdpVCR)[itok];
  uVar2 = *(undefined2 *)((int)((long *)vrgdpVCR + itok) + 2);
  lVar11 = CONCAT22(uVar2,uVar1);
  i = 0;
  while( true ) {
    uVar6 = (undefined2)((ulong)vlpbrVCR >> 0x10);
    pBVar5 = (BTLREC *)vlpbrVCR;
    if (pBVar5->ctok <= i) break;
    if ((uint)*(byte *)((int)pBVar5 + i * 8 + 6) == itok) {
      cshKill = cshKill + *(int *)((int)pBVar5 + i * 8 + 8);
      lVar7 = __aFlshl(lVar14,in_stack_0000ffe8);
      uVar12 = lVar7 + uVar12;
      dv.dp = *(ushort *)((int)(BTLREC *)vlpbrVCR + i * 8 + 0xc);
    }
    i = i + 1;
  }
  if (dv.dp == 0xffff) {
    dv.dp = (&((TOK *)vrgtok)[itok].dv)->dp;
    if (499 < dv.dp >> 7) {
      dv.dp = dv.dp & 0x7f | 0xf980;
      lVar11 = CONCAT22(uVar2,uVar1);
    }
  }
  else {
    pSVar8 = LpshdefFromTok
                       ((TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok + itok));
    uVar3 = (((SHDEF *)pSVar8)->hul).dp;
    iVar4 = ((TOK *)vrgtok)[itok].csh - cshKill;
    uVar9 = __aFulmul((ulong)uVar3,(long)iVar4);
    lVar11 = 100;
    uVar10 = __aFulmul((long)iVar4,(ulong)dv.dp & 0xffff007f);
    lVar11 = __aFldiv(uVar10,lVar11);
    cshT = (short)lVar11;
    if (cshT < 1) {
      cshT = 1;
    }
    lVar14 = 0x32;
    uVar13 = (ulong)cshT;
    lVar11 = 10;
    uVar10 = __aFulmul((ulong)uVar3,(ulong)(dv.dp >> 7));
    uVar10 = __aFldiv(uVar10,lVar11);
    uVar10 = __aFulmul(uVar10,uVar13);
    lVar11 = __aFldiv(uVar10,lVar14);
    lVar11 = uVar9 - lVar11;
  }
  cshT = ((TOK *)vrgtok)[itok].csh - cshKill;
  if (cshT < 1) {
    cshT = 0;
    lVar11 = 0;
    uVar12 = __aFulmul((ulong)((TOK *)vrgtok)[itok].dpShield,
                               (ulong)((TOK *)vrgtok)[itok].csh);
  }
  dpArmor._2_2_ = (undefined2)((ulong)lVar11 >> 0x10);
  dpArmor._0_2_ = (undefined2)lVar11;
  dpShields._2_2_ = (undefined2)(uVar12 >> 0x10);
  dpShields._0_2_ = (undefined2)uVar12;
  if (pdv != (DV *)0x0) {
    pdv->dp = dv.dp;
  }
  if (pcsh != (short *)0x0) {
    *pcsh = cshT;
  }
  if (pdpArmor != (long *)0x0) {
    *(undefined2 *)pdpArmor = (undefined2)dpArmor;
    *(undefined2 *)((int)pdpArmor + 2) = dpArmor._2_2_;
  }
  if (pdpShields != (long *)0x0) {
    *(undefined2 *)pdpShields = (undefined2)dpShields;
    *(undefined2 *)((int)pdpShields + 2) = dpShields._2_2_;
  }
  return;
}



// ======================================================================
// Function: DrawVCR
// Address: 10e8:1c62
// Segment: MEMORY_VCR
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10e82ebd) */

void DrawVCR(HDC hdc,short iStart,short iEnd)

{
  byte bVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  char *pcVar5;
  short sVar6;
  short sVar7;
  StringId ids;
  ushort uVar8;
  uint uVar9;
  uint uVar10;
  BTLREC *pBVar11;
  int iVar12;
  undefined2 unaff_SS;
  bool bVar13;
  bool bVar14;
  DWORD DVar15;
  ulong uVar16;
  long lVar17;
  char *pcVar18;
  HDC HVar19;
  ushort uVar20;
  undefined2 uVar21;
  uint uVar22;
  undefined2 uVar23;
  short cshNew;
  short xT;
  uint local_1a6;
  uint local_1a4;
  DV local_1a2;
  uint local_1a0;
  short x;
  RECT rc;
  short fJam;
  char szT [96];
  short j;
  short dx;
  char *psz;
  short csh;
  short ibmp;
  SHDEF *lpshdef;
  byte brcT;
  short i;
  short c;
  byte rgfSeen [256];
  short y;
  long dpArmor;
  short fCreatedDC;
  long dpT;
  short itokT;
  long dpShields;
  HBRUSH hbrSav;
  short bkMode;
  short ibmpRace;
  short ctok;
  
  bVar14 = hdc == 0;
  if (bVar14) {
    hdc = GetDC(hwndVCRDlg);
  }
  hbrSav = SelectObject(hdc,hbrButtonFace);
  bkMode = SetBkMode(hdc,1);
  _memset(rgfSeen,0,0x100);
  GetClientRect(hwndVCRDlg,&rc);
  if (iStart == -2) {
    PatBlt(hdc,dxyVCRBoard + 10,0,(rc.right - dxyVCRBoard) + -10,
           dxyVCRBoard + 8,0xf00021);
    iStart = -1;
  }
  SelectObject(hdc,hbrButtonShadow);
  if (iStart == -1) {
    PatBlt(hdc,8,8,dxyVCRBoard,2,0xf00021);
    PatBlt(hdc,8,8,2,dxyVCRBoard,0xf00021);
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,9,dxyVCRBoard + 6,dxyVCRBoard + -1,1,0xf00021);
    PatBlt(hdc,8,dxyVCRBoard + 7,dxyVCRBoard,1,0xf00021);
    PatBlt(hdc,dxyVCRBoard + 6,9,1,dxyVCRBoard + -3,0xf00021);
    PatBlt(hdc,dxyVCRBoard + 7,8,1,dxyVCRBoard + -2,0xf00021);
    SelectObject(hdc,hbrButtonShadow);
    for (i = 1; i < 10; i = i + 1) {
      PatBlt(hdc,(dxyVCRSquare + 3) * i + 9,10,1,dxyVCRBoard + -4,0xf00021);
      PatBlt(hdc,10,(dxyVCRSquare + 3) * i + 9,dxyVCRBoard + -4,1,0xf00021);
    }
    x = dxyVCRBoard + 0xe;
    SelectObject(hdc,rghfontArial8[1]);
    iVar12 = vcRound + 1;
    iVar2 = viRound + 1;
    iVar3 = vcStepVCR + 2;
    iVar4 = viStepVCRCur + 2;
    pcVar5 = PszGetCompressedString(idsPhaseDDRoundDD);
    sVar6 = _wsprintf(szWork,pcVar5,iVar4,iVar3,iVar2,iVar12);
    TextOut(hdc,x,8,szWork,sVar6);
    sVar6 = dyArial8;
    iVar12 = dyArial8 + 0xc;
    iVar2 = viSpeedVCR + 1;
    pcVar5 = PszGetCompressedString(idsPlaybackSpeedD);
    sVar7 = _wsprintf(szWork,pcVar5,iVar2);
    DVar15 = GetTextExtent(hdc,szWork,sVar7);
    TextOut(hdc,x,iVar12,szWork,sVar7);
    ptSpeedVCR.x = x;
    ptSpeedVCR.y = iVar12;
    SetRect(rgrcBuildSpin,x + (int)DVar15,iVar12,x + (int)DVar15 + 0xe,sVar6 + 0x1a);
    rgrcBuildSpin[1].left = rgrcBuildSpin[0].left;
    rgrcBuildSpin[1].top = rgrcBuildSpin[0].top;
    rgrcBuildSpin[1].right = rgrcBuildSpin[0].right;
    rgrcBuildSpin[1].bottom = rgrcBuildSpin[0].bottom;
    OffsetRect(rgrcBuildSpin + 1,0xe,0);
    for (i = 0; i < 2; i = i + 1) {
      if (i == 0) {
        uVar10 = 2;
      }
      else {
        uVar10 = 3;
      }
      DrawBtn(hdc,(RECT *)rgrcBuildSpin + i,uVar10 | 0x20,0,(char *)0x0);
    }
    if (-1 < viStepVCRCur) {
      iVar12 = iVar12 + dyArial8 + 4;
      pcVar5 = PszPlayerName((uint)((TOK *)vrgtok)[vlpbrVCR->itok].iplr,1,
                                   1,1,0,(PLAYER *)0x0);
      uVar21 = 0x1120;
      pcVar18 = (char *)szWork;
      iVar2 = iVar12;
      sVar6 = x;
      HVar19 = hdc;
      uVar8 = _strlen(pcVar5);
      TextOut(HVar19,sVar6,iVar2,(LPCSTR)CONCAT22(uVar21,pcVar18),uVar8);
      iVar12 = iVar12 + dyArial8;
      if ((uint)vlpbrVCR->itok == viVCRFocus) {
        SetTextColor(hdc,0x7f0000);
      }
      if (*&((TOK *)vrgtok)[vlpbrVCR->itok].u_TOK_0x0003 == '\x01') {
        local_1a0 = (*(byte *)((int)&((TOK *)vrgtok)[vlpbrVCR->itok].
                                     u_TOK_0x0003 + 1) - 0x10) * 0x93;
        iVar2 = (uint)((TOK *)vrgtok)[vlpbrVCR->itok].iplr * 4;
        lpshdef._2_2_ = *(undefined2 *)(iVar2 + rglpshdefSB_0x2);
        lpshdef._0_2_ = (SHDEF *)(*(int *)(iVar2 + rglpshdefSB) + local_1a0);
      }
      else {
        local_1a0 = (uint)*(byte *)((int)&((TOK *)vrgtok)[vlpbrVCR->itok].
                                          u_TOK_0x0003 + 1) * 0x93;
        iVar2 = (uint)((TOK *)vrgtok)[vlpbrVCR->itok].iplr * 4;
        lpshdef._2_2_ = *(undefined2 *)(iVar2 + rglpshdef_0x2);
        lpshdef._0_2_ = (SHDEF *)(*(int *)(iVar2 + rglpshdef) + local_1a0);
      }
      uVar8 = ((TOK *)vrgtok)[vlpbrVCR->itok].csh;
      if ((int)uVar8 < 2) {
        __fstrcpy(szWork,
                          (char *)CONCAT22(lpshdef._2_2_,(((SHDEF *)lpshdef)->hul).szClass));
        c = _strlen((char *)szWork);
      }
      else {
        pcVar18 = (((SHDEF *)lpshdef)->hul).szClass;
        pcVar5 = PszGetCompressedString(idsSD);
        c = _wsprintf(szWork,pcVar5,pcVar18,lpshdef._2_2_,uVar8);
      }
      TextOut(hdc,x,iVar12,szWork,c);
      y = iVar12 + dyArial8;
      SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      fJam = 0;
      uVar21 = (undefined2)((ulong)vlpbrVCR >> 0x10);
      if (0 < ((BTLREC *)vlpbrVCR)->ctok) {
        pcVar5 = PszPlayerName((uint)((TOK *)vrgtok)
                                           [((BTLREC *)vlpbrVCR)->wFlags_0x4 >> 8].iplr,0,
                                     1,1,0,(PLAYER *)0x0);
        uVar21 = 0x1120;
        pcVar18 = PszGetCompressedString(idsAttacksS);
        sVar6 = _wsprintf(szT,pcVar18,pcVar5,uVar21);
        TextOut(hdc,x,y,szT,sVar6);
        iVar12 = y + dyArial8;
        iVar2._0_1_ = ((BTLREC *)vlpbrVCR + 2)->itok;
        iVar2._1_1_ = ((BTLREC *)vlpbrVCR + 2)->brcDest;
        if (iVar2 != 0) {
          SetTextColor(hdc,0x7f);
        }
        uVar21 = (undefined2)((ulong)vlpbrVCR >> 0x10);
        pBVar11 = (BTLREC *)vlpbrVCR;
        if (*&((TOK *)vrgtok)[pBVar11->wFlags_0x4 >> 8].u_TOK_0x0003 == '\x01') {
          local_1a2.dp = (*(byte *)((int)&((TOK *)vrgtok)[pBVar11->wFlags_0x4 >> 8].
                                          u_TOK_0x0003 + 1) - 0x10) * 0x93;
          local_1a0 = pBVar11->wFlags_0x4;
          iVar2 = (uint)((TOK *)vrgtok)[local_1a0 >> 8].iplr * 4;
          lpshdef._2_2_ = *(undefined2 *)(iVar2 + rglpshdefSB_0x2);
          lpshdef._0_2_ = (SHDEF *)(*(int *)(iVar2 + rglpshdefSB) + local_1a2.dp);
        }
        else {
          local_1a2.dp = (uint)*(byte *)((int)&((TOK *)vrgtok)[pBVar11->wFlags_0x4 >> 8].
                                               u_TOK_0x0003 + 1) * 0x93;
          local_1a0 = pBVar11->wFlags_0x4;
          iVar2 = (uint)((TOK *)vrgtok)[local_1a0 >> 8].iplr * 4;
          lpshdef._2_2_ = *(undefined2 *)(iVar2 + rglpshdef_0x2);
          lpshdef._0_2_ = (SHDEF *)(*(int *)(iVar2 + rglpshdef) + local_1a2.dp);
        }
        uVar8 = ((TOK *)vrgtok)[pBVar11->wFlags_0x4 >> 8].csh;
        if ((int)uVar8 < 2) {
          __fstrcpy(szWork,
                            (char *)CONCAT22(lpshdef._2_2_,(((SHDEF *)lpshdef)->hul).szClass));
          c = _strlen((char *)szWork);
        }
        else {
          pcVar18 = (((SHDEF *)lpshdef)->hul).szClass;
          pcVar5 = PszGetCompressedString(idsSD);
          c = _wsprintf(szWork,pcVar5,pcVar18,lpshdef._2_2_,uVar8);
        }
        TextOut(hdc,x,iVar12,szWork,c);
        iVar12 = iVar12 + dyArial8;
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        uVar21 = (undefined2)((ulong)vlpbrVCR >> 0x10);
        bVar1 = ((TOK *)vrgtok)[((BTLREC *)vlpbrVCR)->wFlags_0x4 >> 8].brc;
        dpArmor._0_2_ = 0;
        dpArmor._2_2_ = 0;
        dpShields._0_2_ = 0;
        dpShields._2_2_ = 0;
        j = 0;
        for (i = ((BTLREC *)vlpbrVCR)->ctok; 0 < i; i = i + -1) {
          itokT = (short)*(byte *)((int)(BTLREC *)vlpbrVCR + (i + -1) * 8 + 6);
          if ((itokT == ((BTLREC *)vlpbrVCR)->wFlags_0x4 >> 8) && (fJam == 0)) {
            fJam = *(byte *)((int)(BTLREC *)vlpbrVCR + (i + -1) * 8 + 7) & 0xc0;
          }
          j = j + *(int *)((int)(BTLREC *)vlpbrVCR + (i + -1) * 8 + 8);
          if (rgfSeen[itokT] == 0) {
            rgfSeen[itokT] = 1;
            GetVCRStats(itokT,&dpT,(DV *)0x0,&local_1a4,&local_1a0);
            uVar10 = *(uint *)((long *)vrgdpVCR + itokT);
            uVar9 = uVar10 - (uint)dpT;
            bVar13 = CARRY2((uint)dpArmor,uVar9);
            dpArmor._0_2_ = (uint)dpArmor + uVar9;
            dpArmor._2_2_ =
                 dpArmor._2_2_ +
                 ((*(uint *)((int)((long *)vrgdpVCR + itokT) + 2) - dpT._2_2_) -
                 (uint)(uVar10 < (uint)dpT)) + (uint)bVar13;
            bVar13 = CARRY2((uint)dpShields,local_1a4);
            dpShields._0_2_ = (uint)dpShields + local_1a4;
            dpShields._2_2_ = dpShields._2_2_ + local_1a2.dp + (uint)bVar13;
          }
        }
        iVar2 = (int)(uint)bVar1 >> 4;
        uVar10 = bVar1 & 0xf;
        pcVar5 = PszGetCompressedString(idsDDDoing);
        sVar6 = _wsprintf(szWork,pcVar5,uVar10,iVar2);
        TextOut(hdc,x,iVar12,szWork,sVar6);
        y = iVar12 + dyArial8;
        if (((uint)dpShields != 0) || (dpShields._2_2_ != 0)) {
          CchGetString(idsAnd,szT);
          if ((dpArmor._2_2_ < 0) || ((dpArmor._2_2_ < 1 && ((uint)dpArmor == 0)))) {
            if (j < 1) {
              pcVar5 = (char *)0x1422;
              uVar21 = 0x1120;
            }
            else {
              pcVar5 = (char *)0x1420;
              uVar21 = 0x1120;
            }
          }
          else {
            pcVar5 = szT;
            uVar21 = unaff_SS;
          }
          uVar10 = (uint)dpShields;
          iVar12 = dpShields._2_2_;
          pcVar18 = PszGetCompressedString(idsLdDamageShieldsS);
          sVar6 = _wsprintf(szWork,pcVar18,uVar10,iVar12,pcVar5,uVar21);
          TextOut(hdc,x,y,szWork,sVar6);
          y = y + dyArial8;
        }
        if (((uint)dpArmor != 0) || (dpArmor._2_2_ != 0)) {
          if (j < 1) {
            uVar21 = 0x2e;
          }
          else {
            uVar21 = 0x2c;
          }
          uVar10 = (uint)dpArmor;
          iVar12 = dpArmor._2_2_;
          pcVar5 = PszGetCompressedString(idsLdDamageArmorC);
          sVar6 = _wsprintf(szWork,pcVar5,uVar10,iVar12,uVar21);
          TextOut(hdc,x,y,szWork,sVar6);
          y = y + dyArial8;
        }
        if (((((fJam & 0x40U) != 0) && ((uint)dpShields == 0)) && (dpShields._2_2_ == 0)) &&
           (((uint)dpArmor == 0 && (dpArmor._2_2_ == 0)))) {
          pcVar5 = PszGetCompressedString(idsDamage3);
          uVar21 = 0x1120;
          sVar6 = y;
          sVar7 = x;
          HVar19 = hdc;
          uVar8 = _strlen(pcVar5);
          TextOut(HVar19,sVar7,sVar6,(LPCSTR)CONCAT22(uVar21,pcVar5),uVar8);
          y = y + dyArial8;
        }
        if (0 < j) {
          sVar6 = j;
          pcVar5 = PszGetCompressedString(idsDestroyingDShip);
          sVar6 = _wsprintf(szWork,pcVar5,sVar6);
          if (j == 1) {
            _strcpy((char *)szWork + sVar6,(char *)0x1424);
            c = sVar6 + 1;
          }
          else {
            _strcpy((char *)szWork + sVar6,(char *)0x1426);
            c = sVar6 + 2;
          }
          TextOut(hdc,x,y,szWork,c);
          y = y + dyArial8;
        }
      }
      if (fJam != 0) {
        SetTextColor(hdc,0x7f);
        if ((((fJam & 0x40U) == 0) || ((uint)dpArmor != 0)) || (dpArmor._2_2_ != 0)) {
          ids = idsTorpedoesDeflected;
        }
        else {
          ids = idsTorpedoesDeflected2;
        }
        sVar6 = CchGetString(ids,(char *)szWork);
        TextOut(hdc,x,y,szWork,sVar6);
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      }
    }
    if (vbrcVCRFocus != 0xff) {
      iVar12 = (int)(uint)vbrcVCRFocus >> 4;
      uVar10 = vbrcVCRFocus & 0xf;
      pcVar5 = PszGetCompressedString(idsSelectionDD);
      sVar6 = _wsprintf(szWork,pcVar5,uVar10,iVar12);
      TextOut(hdc,x,200,szWork,sVar6);
      iVar12 = dyArial8 + 200;
      if (-1 < viVCRFocus) {
        pcVar5 = PszPlayerName((uint)((TOK *)vrgtok)[viVCRFocus].iplr,1,1,
                                     1,0,(PLAYER *)0x0);
        uVar8 = _strlen(pcVar5);
        TextOut(hdc,x,iVar12,szWork,uVar8);
        iVar12 = iVar12 + dyArial8;
        if (*&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 == '\x01') {
          iVar2 = (uint)((TOK *)vrgtok)[viVCRFocus].iplr * 4;
          lpshdef._2_2_ = *(undefined2 *)(iVar2 + rglpshdefSB_0x2);
          lpshdef._0_2_ =
               (SHDEF *)(*(int *)(iVar2 + rglpshdefSB) +
                        (*(byte *)((int)&((TOK *)vrgtok)[viVCRFocus].
                                         u_TOK_0x0003 + 1) - 0x10) * 0x93);
        }
        else {
          iVar2 = (uint)((TOK *)vrgtok)[viVCRFocus].iplr * 4;
          lpshdef._2_2_ = *(undefined2 *)(iVar2 + rglpshdef_0x2);
          lpshdef._0_2_ =
               (SHDEF *)(*(int *)(iVar2 + rglpshdef) +
                        (uint)*(byte *)((int)&((TOK *)vrgtok)[viVCRFocus].
                                              u_TOK_0x0003 + 1) * 0x93);
        }
        uVar8 = ((TOK *)vrgtok)[viVCRFocus].csh;
        GetVCRStats(viVCRFocus,&local_1a6,&local_1a2,&dpShields,&local_1a0);
        uVar10 = local_1a0;
        local_1a0 = uVar8 - local_1a0;
        if (((int)uVar8 < 2) && (local_1a0 == 0)) {
          __fstrcpy(szWork,
                            (char *)CONCAT22(lpshdef._2_2_,(((SHDEF *)lpshdef)->hul).szClass));
          c = _strlen((char *)szWork);
        }
        else {
          pcVar18 = (((SHDEF *)lpshdef)->hul).szClass;
          uVar20 = uVar8;
          pcVar5 = PszGetCompressedString(idsSD);
          c = _wsprintf(szWork,pcVar5,pcVar18,lpshdef._2_2_,uVar20);
        }
        if (local_1a0 != 0) {
          sVar6 = _wsprintf((char *)szWork + c,s_d_1120_1429,local_1a0);
          c = c + sVar6;
        }
        SetTextColor(hdc,0x7f0000);
        TextOut(hdc,x,iVar12,szWork,c);
        iVar12 = iVar12 + dyArial8;
        iVar2 = (rc.right - (dxyVCRBoard + 0xe)) / 2 + x;
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        if ((int)uVar10 < 1) {
          sVar6 = CchGetString(idsDead3,(char *)szWork);
          TextOut(hdc,x,iVar12,szWork,sVar6);
          y = iVar12 + dyArial8 * 5;
        }
        else {
          if (*&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 == '\x01') {
            i = 0;
          }
          else {
            i = (((TOK *)vrgtok)[viVCRFocus].wFlags_0x19 >> 8 & 0xf) + 1;
          }
          if (((TOK *)vrgtok)[viVCRFocus].initMin == 0xff) {
            uVar9 = 0;
          }
          else {
            uVar9 = (uint)((TOK *)vrgtok)[viVCRFocus].initMin;
          }
          pcVar5 = PszGetCompressedString(idsInitiativeD);
          sVar6 = _wsprintf(szWork,pcVar5,uVar9);
          TextOut(hdc,x,iVar12,szWork,sVar6);
          iVar3 = i * 3 + 0xca0;
          uVar21 = 0x1120;
          pcVar5 = PszGetCompressedString(idsMovementS);
          sVar6 = _wsprintf(szWork,pcVar5,iVar3,uVar21);
          TextOut(hdc,iVar2,iVar12,szWork,sVar6);
          iVar12 = iVar12 + dyArial8;
          uVar9 = local_1a6;
          uVar22 = local_1a4;
          pcVar5 = PszGetCompressedString(idsArmorLd);
          sVar6 = _wsprintf(szWork,pcVar5,uVar9,uVar22);
          TextOut(hdc,x,iVar12,szWork,sVar6);
          if (local_1a2.dp == 0) {
            c = CchGetString(idsDamageNone,(char *)szWork);
          }
          else {
            uVar23 = 0;
            uVar21 = 100;
            uVar16 = __aFulmul((ulong)(local_1a2.dp & 0x7f),(long)(int)(uVar8 - local_1a0));
            lVar17 = __aFldiv(uVar16,CONCAT22(uVar23,uVar21));
            csh = (short)lVar17;
            if (csh < 1) {
              csh = 1;
            }
            local_1a6 = local_1a2.dp / 0x280;
            if (local_1a6 == 0) {
              local_1a6 = 1;
            }
            local_1a4 = 0;
            SetTextColor(hdc,0x7f);
            if (*&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 == '\x01') {
              uVar9 = local_1a6;
              pcVar5 = PszGetCompressedString(idsDamageD);
              c = _wsprintf(szWork,pcVar5,uVar9);
            }
            else {
              iVar3 = csh >> 0xf;
              uVar9 = local_1a6;
              pcVar5 = PszGetCompressedString(idsDamageLdD);
              c = _wsprintf(szWork,pcVar5,csh,iVar3,uVar9);
            }
          }
          TextOut(hdc,iVar2,iVar12,szWork,c);
          SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText)
                      );
          iVar12 = iVar12 + dyArial8;
          uVar16 = __aFulmul((ulong)((TOK *)vrgtok)[viVCRFocus].dpShield
                                     ,(long)(int)uVar10);
          iVar2 = ((int)(uVar16 >> 0x10) - dpShields._2_2_) - (uint)((uint)uVar16 < (uint)dpShields)
          ;
          if ((iVar2 < 1) && ((iVar2 < 0 || ((uint)uVar16 == (uint)dpShields)))) {
            c = CchGetString(idsShieldsNone,(char *)szWork);
          }
          else {
            uVar16 = __aFulmul((ulong)((TOK *)vrgtok)[viVCRFocus].
                                              dpShield,(long)(int)uVar10);
            lVar17 = uVar16 - CONCAT22(dpShields._2_2_,(uint)dpShields);
            pcVar5 = PszGetCompressedString(idsShieldsLd);
            c = _wsprintf(szWork,pcVar5,(int)lVar17,(int)((ulong)lVar17 >> 0x10));
          }
          TextOut(hdc,x,iVar12,szWork,c);
          y = iVar12 + dyArial8;
          if (((TOK *)vrgtok)[viVCRFocus].pctJam != 0) {
            uVar10 = (uint)((TOK *)vrgtok)[viVCRFocus].pctJam;
            pcVar5 = PszGetCompressedString(idsJammingD);
            sVar6 = _wsprintf(szWork,pcVar5,uVar10);
            TextOut(hdc,x,y,szWork,sVar6);
            y = y + dyArial8;
          }
          if (*&((TOK *)vrgtok)[viVCRFocus].u_TOK_0x0003 != '\x01') {
            if (vbrcVCRFocus == 0xff) {
              i = 0x19e;
            }
            else {
              i = (((TOK *)vrgtok)[viVCRFocus].wFlags_0x17 >> 8 & 0xf) + 0x198;
            }
            if (i == 0x198) {
              CchGetString(idsTacticSDMoves,szT);
              uVar10 = ((TOK *)vrgtok)[viVCRFocus].wFlags >> 5 & 0x1f;
              pcVar5 = PszGetCompressedString(idsDisengage);
              c = _wsprintf(szWork,szT,pcVar5,0x1120,uVar10);
            }
            else {
              CchGetString(idsTacticS,szT);
              pcVar5 = PszGetCompressedString(i);
              c = _wsprintf(szWork,szT,pcVar5,0x1120);
            }
            TextOut(hdc,x,y,szWork,c);
            y = y + dyArial8;
          }
          if (i != 0x19e) {
            CchGetString(idsPrimayTargetS,szT);
            pcVar5 = PszGetCompressedString
                               ((((TOK *)vrgtok)[viVCRFocus].wFlags_0x17 & 0xf)
                                + idsNoneDisengage);
            sVar6 = _wsprintf(szWork,szT,pcVar5,0x1120);
            TextOut(hdc,x,y,szWork,sVar6);
            iVar12 = y + dyArial8;
            CchGetString(idsSecondaryTargetS,szT);
            pcVar5 = PszGetCompressedString
                               ((((TOK *)vrgtok)[viVCRFocus].wFlags_0x17 >> 4 &
                                0xf) + idsNoneDisengage);
            sVar6 = _wsprintf(szWork,szT,pcVar5,0x1120);
            TextOut(hdc,x,iVar12,szWork,sVar6);
            y = iVar12 + dyArial8;
          }
        }
        SetRect(&rc,x,y + 4,x + dyArial8 + 4,y + dyArial8 + 8);
        DrawBtn(hdc,&rc,8,0,(char *)0x1430);
      }
    }
    iStart = 0;
    iEnd = 99;
  }
  for (i = iStart; i <= iEnd; i = i + 1) {
    x = i % 10;
    uVar10 = i / 10;
    PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,
           dxyVCRSquare + 2,1,0x42);
    PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,1,
           dxyVCRSquare + 2,0x42);
    PatBlt(hdc,(dxyVCRSquare + 3) * x + dxyVCRSquare + 0xb,
           (dxyVCRSquare + 3) * uVar10 + 10,1,dxyVCRSquare + 2,0x42);
    PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,
           (dxyVCRSquare + 3) * uVar10 + dxyVCRSquare + 0xb,
           dxyVCRSquare + 2,1,0x42);
    ctok = 0;
    ibmp = -1;
    dpT._0_2_ = 0;
    dpT._2_2_ = 0;
    for (j = 0; j < (int)(uint)((BTLDATA *)vlpbdVCR)->ctok; j = j + 1) {
      local_1a0 = (uint)((TOK *)vrgtok)[j].brc;
      if ((local_1a0 == ((uVar10 & 0xf) << 4 | x & 0xfU)) && (((TOK *)vrgtok)[j].csh != 0)
         ) {
        ctok = ctok + 1;
        bVar13 = CARRY2((uint)dpT,((TOK *)vrgtok)[j].csh);
        dpT._0_2_ = (uint)dpT + ((TOK *)vrgtok)[j].csh;
        dpT._2_2_ = dpT._2_2_ + (uint)bVar13;
        if ((ibmp == -1) || (j == viVCRFocus)) {
          if (*&((TOK *)vrgtok)[j].u_TOK_0x0003 == '\x01') {
            local_1a0 = (*(byte *)((int)&((TOK *)vrgtok)[j].u_TOK_0x0003 + 1) - 0x10) *
                        0x93;
            iVar12 = (uint)((TOK *)vrgtok)[j].iplr * 4;
            ibmp = *(short *)(*(int *)(iVar12 + rglpshdefSB) + local_1a0 + 0x32);
          }
          else {
            local_1a0 = (uint)*(byte *)((int)&((TOK *)vrgtok)[j].u_TOK_0x0003 + 1) * 0x93;
            iVar12 = (uint)((TOK *)vrgtok)[j].iplr * 4;
            ibmp = *(short *)(*(int *)(iVar12 + rglpshdef) + local_1a0 + 0x32);
          }
          ibmpRace = *(uint *)((int)&rgplr[0].wMdPlr +
                              (uint)((TOK *)vrgtok)[j].iplr * 0xc0) >> 3 & 0x1f;
        }
      }
    }
    if ((dpT._2_2_ < 1) && ((dpT._2_2_ < 0 || ((uint)dpT < 0x7fff)))) {
      csh = (uint)dpT;
    }
    else {
      csh = 0x7fff;
    }
    if (ctok < 1) {
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,
             dxyVCRSquare + 2,dxyVCRSquare + 2,0x42);
    }
    else {
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,
             dxyVCRSquare + 2,1,0x42);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,1,
             dxyVCRSquare + 2,0x42);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + dxyVCRSquare + 0xb,
             (dxyVCRSquare + 3) * uVar10 + 10,1,dxyVCRSquare + 2,0x42);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,
             (dxyVCRSquare + 3) * uVar10 + dxyVCRSquare + 0xb,
             dxyVCRSquare + 2,1,0x42);
      DrawFleetBitmap
                ((FLEET *)0x0,hdc,(dxyVCRSquare + 3) * x + 0xb,
                 (dxyVCRSquare + 3) * uVar10 + 0xb,0,ibmp,ctok,
                 (uint)(dxyVCRSquare < 0x40),ibmpRace,csh);
    }
    local_1a0 = (uint)vbrcVCRFocus;
    if (((local_1a0 == ((uVar10 & 0xf) << 4 | x & 0xfU)) && (viVCRFocus == -1)) ||
       ((-1 < viVCRFocus &&
        ((local_1a0 = (uint)((TOK *)vrgtok)[viVCRFocus].brc,
         local_1a0 == ((uVar10 & 0xf) << 4 | x & 0xfU) &&
         (((TOK *)vrgtok)[viVCRFocus].csh != 0)))))) {
      local_1a0 = SelectObject(hdc,hbrBlue);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,
             dxyVCRSquare + 1,2,0xf00021);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,(dxyVCRSquare + 3) * uVar10 + 10,2,
             dxyVCRSquare + 1,0xf00021);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10,
             (dxyVCRSquare + 3) * uVar10 + 10 + dxyVCRSquare,
             dxyVCRSquare + 1,2,0xf00021);
      PatBlt(hdc,(dxyVCRSquare + 3) * x + 10 + dxyVCRSquare,
             (dxyVCRSquare + 3) * uVar10 + 10,2,dxyVCRSquare + 1,0xf00021);
      SelectObject(hdc,local_1a0);
    }
  }
  if (0 < ((BTLREC *)vlpbrVCR)->ctok) {
    AnimateAttack(hdc);
  }
  SetBkMode(hdc,bkMode);
  SelectObject(hdc,hbrSav);
  if (bVar14) {
    ReleaseDC(hwndVCRDlg,hdc);
  }
  return;
}



// ======================================================================
// Function: Delay
// Address: 10e8:3a3e
// Segment: MEMORY_VCR
// ======================================================================


void Delay(short ctick)

{
  uint uVar1;
  uint uVar2;
  uint uVar3;
  TIMERINFO **ppTVar4;
  undefined1 *puVar5;
  undefined2 unaff_SS;
  TIMERINFO *pTStack_20;
  TIMERINFO ti;
  ulong dwTickCur;
  ulong dwTickLast;
  
  ti.dwSize._0_2_ = 0xc;
  ti.dwSize._2_2_ = 0;
  pTStack_20 = &ti;
  TimerCount();
  uVar2 = ti.dwmsSinceStart._2_2_;
  uVar1 = (uint)ti.dwmsSinceStart;
  ppTVar4 = &pTStack_20;
  while( true ) {
    *(undefined2 *)((int)ppTVar4 + -2) = unaff_SS;
    *(int *)((int)ppTVar4 + -4) = (int)&ti;
    *(undefined2 *)((int)ppTVar4 + -6) = 0x14f8;
    *(undefined2 *)((int)ppTVar4 + -8) = 0x3a75;
    TimerCount();
    puVar5 = (undefined1 *)((int)ppTVar4 + -4);
    if (ti.dwmsSinceStart._2_2_ < uVar2) {
      return;
    }
    if ((ti.dwmsSinceStart._2_2_ <= uVar2) && ((uint)ti.dwmsSinceStart < uVar1)) break;
    uVar3 = (ctick >> 0xf) + uVar2 + (uint)CARRY2(ctick,uVar1);
    ppTVar4 = (TIMERINFO **)((int)ppTVar4 + -4);
    if ((uVar3 <= ti.dwmsSinceStart._2_2_) &&
       ((uVar3 < ti.dwmsSinceStart._2_2_ ||
        (ppTVar4 = puVar5, ctick + uVar1 <= (uint)ti.dwmsSinceStart)))) {
      return;
    }
  }
  return;
}



// ======================================================================
// Function: AnimateAttack
// Address: 10e8:3ac2
// Segment: MEMORY_VCR
// ======================================================================


void AnimateAttack(HDC hdc)

{
  byte bVar1;
  byte bVar2;
  TOK *pTVar3;
  short sVar4;
  short sVar5;
  undefined1 *puVar6;
  int iVar7;
  int iVar8;
  int iVar9;
  int iVar10;
  uint uVar11;
  int iVar12;
  int iVar13;
  int iVar14;
  int iVar15;
  int iVar16;
  int iVar17;
  short sVar18;
  HPEN HVar19;
  HDC HVar20;
  HBITMAP HVar21;
  HGDIOBJ HVar22;
  short sVar23;
  short sVar24;
  int iVar25;
  int iVar26;
  BTLREC *pBVar27;
  undefined1 *puVar28;
  undefined1 *puVar29;
  undefined2 uVar30;
  undefined2 uVar31;
  undefined2 unaff_SS;
  ulong uVar32;
  long lVar33;
  HBITMAP hbmpScreen;
  HBITMAP hbmpSav;
  HDC hdcMem;
  short x;
  POINT ptDestLeft;
  POINT ptDestRight;
  POINT ptDestTop;
  POINT ptBottom;
  POINT ptBeam2;
  POINT ptDestBottom;
  short fKill;
  short dx;
  short iFrame;
  TIMERINFO ti;
  POINT ptLeft;
  POINT ptTorp;
  POINT ptSrc;
  ushort grfWeapon;
  short iHit;
  POINT ptDest;
  POINT ptRight;
  short y;
  POINT ptRay1;
  short dy;
  POINT ptBase;
  ulong dwTickCur;
  short dxFrame;
  ulong dwTickLast;
  POINT ptTop;
  POINT ptRay2;
  short dyFrame;
  short cFrame;
  POINT ptBeam1;
  TOK *ptokAttack;
  TOK *ptokSrc;
  
  uVar30 = vrgtok._2_2_;
  pTVar3 = (TOK *)vrgtok;
  uVar31 = 0x10e8;
  puVar28 = &stack0xff7c;
  if (-1 < viStepVCRCur) {
    bVar1 = vlpbrVCR->itok;
    iVar7 = (dxyVCRSquare + 3) * (((TOK *)vrgtok)[bVar1].brc & 0xf) +
            dxyVCRSquare / 2 + 0xb;
    iVar8 = (dxyVCRSquare + 3) * ((int)(uint)((TOK *)vrgtok)[bVar1].brc >> 4) +
            dxyVCRSquare / 2 + 0xb;
    iVar9 = dxyVCRSquare / 3 + iVar8;
    iVar25 = iVar8 - dxyVCRSquare / 3;
    iVar26 = iVar7 - dxyVCRSquare / 3;
    iVar10 = dxyVCRSquare / 3 + iVar7;
    iHit = 0;
    do {
      grfWeapon = (ushort)*(byte *)((int)(BTLREC *)vlpbrVCR + iHit * 8 + 7);
      iFrame = iHit;
      while ((iFrame = iFrame + 1, sVar4 = iFrame, iFrame < ((BTLREC *)vlpbrVCR)->ctok &&
             (*(char *)((int)(BTLREC *)vlpbrVCR + iFrame * 8 + 6) ==
              *(char *)((int)(BTLREC *)vlpbrVCR + iHit * 8 + 6)))) {
        grfWeapon = grfWeapon | *(byte *)((int)(BTLREC *)vlpbrVCR + iFrame * 8 + 7);
      }
      bVar2 = *(byte *)((int)(BTLREC *)vlpbrVCR + iHit * 8 + 6);
      uVar11 = ((TOK *)vrgtok)[bVar2].brc & 0xf;
      iVar12 = (int)(uint)((TOK *)vrgtok)[bVar2].brc >> 4;
      iVar13 = (pTVar3[bVar1].brc & 0xf) - uVar11;
      iVar14 = ((int)(uint)pTVar3[bVar1].brc >> 4) - iVar12;
      iVar15 = (dxyVCRSquare + 3) * uVar11 + dxyVCRSquare / 2;
      iVar16 = iVar15 + 0xb;
      iVar12 = (dxyVCRSquare + 3) * iVar12 + dxyVCRSquare / 2;
      iVar17 = iVar12 + 0xb;
      iHit = iFrame;
      if ((iVar13 != 0) || (iVar14 != 0)) {
        ptBeam2.x = iVar26;
        ptBeam2.y = iVar8;
        if (iVar13 == 0) {
LAB_10e8_3ec2:
          ptTorp.x = iVar7;
          ptTorp.y = iVar25;
          ptBeam1.x = iVar10;
          ptBeam1.y = iVar8;
          if (iVar14 < 1) {
            ptTorp.y = iVar9;
          }
        }
        else {
          *(int *)(puVar28 + -2) = iVar13;
          *(undefined2 *)(puVar28 + -4) = uVar31;
          *(undefined2 *)(puVar28 + -6) = 0x3ea4;
          sVar18 = _abs(*(short *)(puVar28 + -2));
          if (sVar18 == 1) {
            *(int *)(puVar28 + -2) = iVar14;
            *(undefined2 *)(puVar28 + -4) = 0x1118;
            uVar31 = 0x1118;
            *(undefined2 *)(puVar28 + -6) = 0x3eb7;
            sVar18 = _abs(*(short *)(puVar28 + -2));
            if (2 < sVar18) goto LAB_10e8_3ec2;
          }
          ptTorp.x = iVar26;
          ptBeam1.x = iVar7;
          ptBeam1.y = iVar25;
          if (iVar14 == 0) {
LAB_10e8_3f66:
            uVar31 = 0x1118;
            ptBeam2.x = iVar7;
            ptBeam2.y = iVar9;
            ptTorp.y = iVar8;
            if (iVar13 < 1) {
              ptTorp.x = iVar10;
            }
          }
          else {
            *(int *)(puVar28 + -2) = iVar14;
            *(undefined2 *)(puVar28 + -4) = 0x1118;
            *(undefined2 *)(puVar28 + -6) = 0x3f48;
            sVar18 = _abs(*(short *)(puVar28 + -2));
            if (sVar18 == 1) {
              *(int *)(puVar28 + -2) = iVar13;
              *(undefined2 *)(puVar28 + -4) = 0x1118;
              *(undefined2 *)(puVar28 + -6) = 0x3f5b;
              sVar18 = _abs(*(short *)(puVar28 + -2));
              if (2 < sVar18) goto LAB_10e8_3f66;
            }
            uVar31 = 0x1118;
            if (iVar13 < 1) {
              if (iVar14 < 1) {
                ptBeam1.y = iVar9;
              }
              ptTorp.y = ptBeam1.y;
              ptBeam2.x = iVar10;
              ptTorp.x = iVar10;
            }
            else {
              if (iVar14 < 1) {
                ptBeam1.y = iVar9;
              }
              ptTorp.y = ptBeam1.y;
            }
          }
        }
        sVar5 = ptTorp.y;
        sVar18 = ptTorp.x;
        if ((grfWeapon & 3) != 0) {
          *(HDC *)(puVar28 + -2) = hdc;
          HVar19 = hpenStarbase;
          if ((grfWeapon & 2) == 0) {
            HVar19 = hpenEnemy;
          }
          *(HPEN *)(puVar28 + -4) = HVar19;
          *(undefined2 *)(puVar28 + -6) = uVar31;
          *(undefined2 *)(puVar28 + -8) = 0x40ed;
          SelectObject(*(HDC *)(puVar28 + -2),*(HGDIOBJ *)(puVar28 + -4));
          *(HDC *)(puVar28 + -2) = hdc;
          *(short *)(puVar28 + -4) = ptBeam1.x;
          *(short *)(puVar28 + -6) = ptBeam1.y;
          *(undefined2 *)(puVar28 + -8) = 0x14f8;
          *(undefined2 *)(puVar28 + -10) = 0x40fb;
          MoveTo(*(HDC *)(puVar28 + -2),*(short *)(puVar28 + -4),*(short *)(puVar28 + -6));
          *(HDC *)(puVar28 + -2) = hdc;
          *(int *)(puVar28 + -4) = iVar16;
          *(int *)(puVar28 + -6) = iVar17;
          *(undefined2 *)(puVar28 + -8) = 0x14f8;
          *(undefined2 *)(puVar28 + -10) = 0x4109;
          LineTo(*(HDC *)(puVar28 + -2),*(short *)(puVar28 + -4),*(short *)(puVar28 + -6));
          *(HDC *)(puVar28 + -2) = hdc;
          *(short *)(puVar28 + -4) = ptBeam2.x;
          *(short *)(puVar28 + -6) = ptBeam2.y;
          *(undefined2 *)(puVar28 + -8) = 0x14f8;
          *(undefined2 *)(puVar28 + -10) = 0x4117;
          MoveTo(*(HDC *)(puVar28 + -2),*(short *)(puVar28 + -4),*(short *)(puVar28 + -6));
          *(HDC *)(puVar28 + -2) = hdc;
          *(int *)(puVar28 + -4) = iVar16;
          *(int *)(puVar28 + -6) = iVar17;
          *(undefined2 *)(puVar28 + -8) = 0x14f8;
          *(undefined2 *)(puVar28 + -10) = 0x4125;
          LineTo(*(HDC *)(puVar28 + -2),*(short *)(puVar28 + -4),*(short *)(puVar28 + -6));
          *(HDC *)(puVar28 + -2) = hdc;
          *(int *)(puVar28 + -4) = iVar15 + -5;
          *(int *)(puVar28 + -6) = iVar12 + -5;
          *(ushort *)(puVar28 + -8) = rghiconVCR[0];
          *(undefined2 *)(puVar28 + -10) = 0x14f8;
          uVar31 = 0x14f8;
          *(undefined2 *)(puVar28 + -0xc) = 0x413f;
          DrawIcon(*(HDC *)(puVar28 + -2),*(short *)(puVar28 + -4),*(short *)(puVar28 + -6),
                   *(HICON *)(puVar28 + -8));
        }
        if ((grfWeapon & 4) != 0) {
          if (fAnimate == 0) {
LAB_10e8_43b4:
            if ((grfWeapon & 0x40) == 0) {
              *(HDC *)(puVar28 + -2) = hdc;
              *(int *)(puVar28 + -4) = iVar15 + -5;
              *(int *)(puVar28 + -6) = iVar12 + -5;
              *(ushort *)(puVar28 + -8) = rghiconVCR[1];
              *(undefined2 *)(puVar28 + -10) = uVar31;
              uVar31 = 0x14f8;
              *(undefined2 *)(puVar28 + -0xc) = 0x43dc;
              DrawIcon(*(HDC *)(puVar28 + -2),*(short *)(puVar28 + -4),*(short *)(puVar28 + -6),
                       *(HICON *)(puVar28 + -8));
            }
          }
          else {
            *(HDC *)(puVar28 + -2) = hdc;
            *(undefined2 *)(puVar28 + -4) = uVar31;
            uVar31 = 0x14f8;
            *(undefined2 *)(puVar28 + -6) = 0x415f;
            HVar20 = CreateCompatibleDC(*(HDC *)(puVar28 + -2));
            if (HVar20 != 0) {
              *(HDC *)(puVar28 + -2) = hdc;
              *(undefined2 *)(puVar28 + -4) = 0x20;
              *(undefined2 *)(puVar28 + -6) = 0x20;
              *(undefined2 *)(puVar28 + -8) = 0x14f8;
              *(undefined2 *)(puVar28 + -10) = 0x417e;
              HVar21 = CreateCompatibleBitmap
                                 (*(HDC *)(puVar28 + -2),*(short *)(puVar28 + -4),
                                  *(short *)(puVar28 + -6));
              if (HVar21 != 0) {
                *(HDC *)(puVar28 + -2) = HVar20;
                *(HBITMAP *)(puVar28 + -4) = HVar21;
                *(undefined2 *)(puVar28 + -6) = 0x14f8;
                *(undefined2 *)(puVar28 + -8) = 0x41a0;
                HVar22 = SelectObject(*(HDC *)(puVar28 + -2),*(HGDIOBJ *)(puVar28 + -4));
                *(int *)(puVar28 + -2) = iVar13;
                *(undefined2 *)(puVar28 + -4) = 0x14f8;
                *(undefined2 *)(puVar28 + -6) = 0x41ab;
                sVar23 = _abs(*(short *)(puVar28 + -2));
                *(int *)(puVar28 + -2) = iVar14;
                *(undefined2 *)(puVar28 + -4) = 0x1118;
                *(undefined2 *)(puVar28 + -6) = 0x41b9;
                sVar24 = _abs(*(short *)(puVar28 + -2));
                if (sVar24 < sVar23) {
                  *(int *)(puVar28 + -2) = iVar13;
                  *(undefined2 *)(puVar28 + -4) = 0x1118;
                  *(undefined2 *)(puVar28 + -6) = 0x41ce;
                  iVar13 = _abs(*(short *)(puVar28 + -2));
                }
                else {
                  *(int *)(puVar28 + -2) = iVar14;
                  *(undefined2 *)(puVar28 + -4) = 0x1118;
                  *(undefined2 *)(puVar28 + -6) = 0x41dc;
                  iVar13 = _abs(*(short *)(puVar28 + -2));
                }
                if ((grfWeapon & 4) == 0) {
                  iVar14 = 4;
                }
                else {
                  iVar14 = 8;
                }
                iVar13 = iVar13 * iVar14;
                iVar16 = ptTorp.x - iVar16;
                iVar17 = ptTorp.y - iVar17;
                ti.dwSize._0_2_ = 0xc;
                ti.dwSize._2_2_ = 0;
                *(undefined2 *)(puVar28 + -2) = unaff_SS;
                *(TIMERINFO **)(puVar28 + -4) = &ti;
                *(undefined2 *)(puVar28 + -6) = 0x1118;
                uVar31 = 0x14f8;
                *(undefined2 *)(puVar28 + -8) = 0x4237;
                TimerCount();
                puVar28 = puVar28 + -4;
                dwTickLast._0_2_ = (uint)ti.dwmsSinceStart;
                dwTickLast._2_2_ = ti.dwmsSinceStart._2_2_;
                for (iFrame = 0; iFrame < iVar13; iFrame = iFrame + 1) {
                  *(HDC *)(puVar28 + -2) = HVar20;
                  *(undefined2 *)(puVar28 + -4) = 0;
                  *(undefined2 *)(puVar28 + -6) = 0;
                  *(undefined2 *)(puVar28 + -8) = 0x20;
                  *(undefined2 *)(puVar28 + -10) = 0x20;
                  *(HDC *)(puVar28 + -0xc) = hdc;
                  *(short *)(puVar28 + -0xe) = ptTorp.x + -0x10;
                  *(short *)(puVar28 + -0x10) = ptTorp.y + -0x10;
                  *(undefined2 *)(puVar28 + -0x12) = 0xcc;
                  *(undefined2 *)(puVar28 + -0x14) = 0x20;
                  *(undefined2 *)(puVar28 + -0x16) = uVar31;
                  *(undefined2 *)(puVar28 + -0x18) = 0x427c;
                  BitBlt(*(HDC *)(puVar28 + -2),*(short *)(puVar28 + -4),*(short *)(puVar28 + -6),
                         *(short *)(puVar28 + -8),*(short *)(puVar28 + -10),*(HDC *)(puVar28 + -0xc)
                         ,*(short *)(puVar28 + -0xe),*(short *)(puVar28 + -0x10),
                         *(DWORD *)(puVar28 + -0x14));
                  *(HDC *)(puVar28 + -2) = hdc;
                  *(short *)(puVar28 + -4) = ptTorp.x + -0x10;
                  *(short *)(puVar28 + -6) = ptTorp.y + -0x10;
                  *(ushort *)(puVar28 + -8) = ((ushort *)rghiconVCR)[(iFrame & 3U) + 3];
                  *(undefined2 *)(puVar28 + -10) = 0x14f8;
                  *(undefined2 *)(puVar28 + -0xc) = 0x42a1;
                  DrawIcon(*(HDC *)(puVar28 + -2),*(short *)(puVar28 + -4),*(short *)(puVar28 + -6),
                           *(HICON *)(puVar28 + -8));
                  puVar6 = puVar28;
                  do {
                    puVar29 = puVar6;
                    *(undefined2 *)(puVar29 + -2) = unaff_SS;
                    *(TIMERINFO **)(puVar29 + -4) = &ti;
                    *(undefined2 *)(puVar29 + -6) = 0x14f8;
                    *(undefined2 *)(puVar29 + -8) = 0x42ad;
                    TimerCount();
                    if ((ti.dwmsSinceStart._2_2_ < dwTickLast._2_2_) ||
                       ((ti.dwmsSinceStart._2_2_ <= dwTickLast._2_2_ &&
                        ((uint)ti.dwmsSinceStart < (uint)dwTickLast)))) break;
                    uVar11 = ((dwTickLast._2_2_ + (0xffdc < (uint)dwTickLast)) -
                             (viSpeedVCR * 10 >> 0xf)) -
                             (uint)((uint)dwTickLast + 0x23 < (uint)(viSpeedVCR * 10));
                    puVar6 = puVar29 + -4;
                  } while ((ti.dwmsSinceStart._2_2_ < uVar11) ||
                          ((ti.dwmsSinceStart._2_2_ <= uVar11 &&
                           (puVar6 = puVar29 + -4,
                           (uint)ti.dwmsSinceStart <
                           (uint)dwTickLast + 0x23 + viSpeedVCR * -10))));
                  dwTickLast._0_2_ = (uint)ti.dwmsSinceStart;
                  dwTickLast._2_2_ = ti.dwmsSinceStart._2_2_;
                  *(HDC *)(puVar29 + -6) = hdc;
                  *(short *)(puVar29 + -8) = ptTorp.x + -0x10;
                  *(short *)(puVar29 + -10) = ptTorp.y + -0x10;
                  *(undefined2 *)(puVar29 + -0xc) = 0x20;
                  *(undefined2 *)(puVar29 + -0xe) = 0x20;
                  *(HDC *)(puVar29 + -0x10) = HVar20;
                  *(undefined2 *)(puVar29 + -0x12) = 0;
                  *(undefined2 *)(puVar29 + -0x14) = 0;
                  *(undefined2 *)(puVar29 + -0x16) = 0xcc;
                  *(undefined2 *)(puVar29 + -0x18) = 0x20;
                  *(undefined2 *)(puVar29 + -0x1a) = 0x14f8;
                  *(undefined2 *)(puVar29 + -0x1c) = 0x433e;
                  BitBlt(*(HDC *)(puVar29 + -6),*(short *)(puVar29 + -8),*(short *)(puVar29 + -10),
                         *(short *)(puVar29 + -0xc),*(short *)(puVar29 + -0xe),
                         *(HDC *)(puVar29 + -0x10),*(short *)(puVar29 + -0x12),
                         *(short *)(puVar29 + -0x14),*(DWORD *)(puVar29 + -0x18));
                  *(int *)(puVar29 + -6) = iVar13 >> 0xf;
                  *(int *)(puVar29 + -8) = iVar13;
                  *(short *)(puVar29 + -10) = iFrame >> 0xf;
                  *(short *)(puVar29 + -0xc) = iFrame;
                  *(int *)(puVar29 + -0xe) = iVar16 >> 0xf;
                  *(int *)(puVar29 + -0x10) = iVar16;
                  *(undefined2 *)(puVar29 + -0x12) = 0x14f8;
                  *(undefined2 *)(puVar29 + -0x14) = 0x4355;
                  uVar32 = __aFulmul(*(ulong *)(puVar29 + -0x10),*(ulong *)(puVar29 + -0xc))
                  ;
                  *(int *)(puVar29 + -10) = (int)(uVar32 >> 0x10);
                  *(int *)(puVar29 + -0xc) = (int)uVar32;
                  *(undefined2 *)(puVar29 + -0xe) = 0x1118;
                  *(undefined2 *)(puVar29 + -0x10) = 0x435c;
                  lVar33 = __aFldiv(*(long *)(puVar29 + -0xc),*(long *)(puVar29 + -8));
                  ptTorp.x = sVar18 - (int)lVar33;
                  *(int *)(puVar29 + -6) = iVar13 >> 0xf;
                  *(int *)(puVar29 + -8) = iVar13;
                  *(short *)(puVar29 + -10) = iFrame >> 0xf;
                  *(short *)(puVar29 + -0xc) = iFrame;
                  *(int *)(puVar29 + -0xe) = iVar17 >> 0xf;
                  *(int *)(puVar29 + -0x10) = iVar17;
                  *(undefined2 *)(puVar29 + -0x12) = 0x1118;
                  *(undefined2 *)(puVar29 + -0x14) = 0x437b;
                  uVar32 = __aFulmul(*(ulong *)(puVar29 + -0x10),*(ulong *)(puVar29 + -0xc))
                  ;
                  *(int *)(puVar29 + -10) = (int)(uVar32 >> 0x10);
                  *(int *)(puVar29 + -0xc) = (int)uVar32;
                  *(undefined2 *)(puVar29 + -0xe) = 0x1118;
                  uVar31 = 0x1118;
                  *(undefined2 *)(puVar29 + -0x10) = 0x4382;
                  lVar33 = __aFldiv(*(long *)(puVar29 + -0xc),*(long *)(puVar29 + -8));
                  puVar28 = puVar29 + -4;
                  ptTorp.y = sVar5 - (int)lVar33;
                }
                *(HDC *)(puVar28 + -2) = HVar20;
                *(HGDIOBJ *)(puVar28 + -4) = HVar22;
                *(undefined2 *)(puVar28 + -6) = uVar31;
                *(undefined2 *)(puVar28 + -8) = 0x43a4;
                SelectObject(*(HDC *)(puVar28 + -2),*(HGDIOBJ *)(puVar28 + -4));
                *(HBITMAP *)(puVar28 + -2) = HVar21;
                *(undefined2 *)(puVar28 + -4) = 0x14f8;
                *(undefined2 *)(puVar28 + -6) = 0x43ac;
                DeleteObject(*(HGDIOBJ *)(puVar28 + -2));
                *(HDC *)(puVar28 + -2) = HVar20;
                *(undefined2 *)(puVar28 + -4) = 0x14f8;
                uVar31 = 0x14f8;
                *(undefined2 *)(puVar28 + -6) = 0x43b4;
                DeleteDC(*(HDC *)(puVar28 + -2));
                goto LAB_10e8_43b4;
              }
              *(HDC *)(puVar28 + -2) = HVar20;
              *(undefined2 *)(puVar28 + -4) = 0x14f8;
              uVar31 = 0x14f8;
              *(undefined2 *)(puVar28 + -6) = 0x4192;
              DeleteDC(*(HDC *)(puVar28 + -2));
            }
          }
        }
      }
    } while (sVar4 < ((BTLREC *)vlpbrVCR)->ctok);
    iFrame = 0;
    while( true ) {
      uVar30 = (undefined2)((ulong)vlpbrVCR >> 0x10);
      pBVar27 = (BTLREC *)vlpbrVCR;
      if (pBVar27->ctok <= iFrame) break;
      iVar7 = *(int *)((int)pBVar27 + iFrame * 8 + 8);
      bVar1 = *(byte *)((int)pBVar27 + iFrame * 8 + 6);
      bVar2 = ((TOK *)vrgtok)[bVar1].brc;
      bVar1 = ((TOK *)vrgtok)[bVar1].brc;
      *(HDC *)(puVar28 + -2) = hdc;
      *(uint *)(puVar28 + -4) =
           (bVar2 & 0xf) * (dxyVCRSquare + 3) + dxyVCRSquare / 2 + -5;
      *(int *)(puVar28 + -6) =
           ((int)(uint)bVar1 >> 4) * (dxyVCRSquare + 3) + dxyVCRSquare / 2 + -5;
      if (iVar7 == 0) {
        iVar7 = 0;
      }
      else {
        iVar7 = 2;
      }
      *(ushort *)(puVar28 + -8) = ((ushort *)rghiconVCR)[iVar7];
      *(undefined2 *)(puVar28 + -10) = uVar31;
      uVar31 = 0x14f8;
      *(undefined2 *)(puVar28 + -0xc) = 0x4509;
      DrawIcon(*(HDC *)(puVar28 + -2),*(short *)(puVar28 + -4),*(short *)(puVar28 + -6),
               *(HICON *)(puVar28 + -8));
      iFrame = iFrame + 1;
    }
    fAnimate = 0;
  }
  return;
}



// ======================================================================
// Function: PopupVCRMenu
// Address: 10e8:4518
// Segment: MEMORY_VCR
// ======================================================================


short PopupVCRMenu(HWND hwnd,short x,short y,byte brc)

{
  byte bVar1;
  ushort uVar2;
  short sVar3;
  int iVar4;
  BTLREC *pBVar5;
  undefined2 uVar6;
  short cKilled;
  short cch;
  char *psz;
  short j;
  short iSel;
  short iChecked;
  short rgid [40];
  SHDEF *lpshdef;
  char rgch [1536];
  short c;
  short i;
  char *rgsz [40];
  short fAttack;
  
  c = 0;
  iChecked = -1;
  psz = rgch;
  bVar1 = ((TOK *)vrgtok)[((BTLREC *)vlpbrVCR)->wFlags_0x4 >> 8].brc;
  for (i = 0; i < (int)(uint)((BTLDATA *)vlpbdVCR)->ctok; i = i + 1) {
    if ((((TOK *)vrgtok)[i].brc == brc) && (((TOK *)vrgtok)[i].csh != 0)) {
      PszPlayerName((uint)((TOK *)vrgtok)[i].iplr,0,0,0,0,(PLAYER *)0x0);
      uVar2 = _strlen((char *)szWork);
      if (*&((TOK *)vrgtok)[i].u_TOK_0x0003 == '\x01') {
        iVar4 = (uint)((TOK *)vrgtok)[i].iplr * 4;
        lpshdef._2_2_ = *(undefined2 *)(iVar4 + rglpshdefSB_0x2);
        lpshdef._0_2_ =
             (SHDEF *)(*(int *)(iVar4 + rglpshdefSB) +
                      (*(byte *)((int)&((TOK *)vrgtok)[i].u_TOK_0x0003 + 1) - 0x10) * 0x93
                      );
      }
      else {
        iVar4 = (uint)((TOK *)vrgtok)[i].iplr * 4;
        lpshdef._2_2_ = *(undefined2 *)(iVar4 + rglpshdef_0x2);
        lpshdef._0_2_ =
             (SHDEF *)(*(int *)(iVar4 + rglpshdef) +
                      (uint)*(byte *)((int)&((TOK *)vrgtok)[i].u_TOK_0x0003 + 1) * 0x93);
      }
      sVar3 = _wsprintf((char *)szWork + uVar2,s_s_d_1120_1432,
                        (((SHDEF *)lpshdef)->hul).szClass,lpshdef._2_2_,
                        ((TOK *)vrgtok)[i].csh);
      cch = uVar2 + sVar3;
      if (brc == bVar1) {
        uVar6 = (undefined2)((ulong)vlpbrVCR >> 0x10);
        pBVar5 = (BTLREC *)vlpbrVCR;
        if ((0 < pBVar5->ctok) && (-1 < viStepVCRCur)) {
          cKilled = 0;
          for (j = 0; j < pBVar5->ctok; j = j + 1) {
            if ((uint)*(byte *)((int)pBVar5 + j * 8 + 6) == i) {
              cKilled = cKilled + *(int *)((int)pBVar5 + j * 8 + 8);
            }
          }
          if (0 < cKilled) {
            sVar3 = _wsprintf((char *)szWork + cch,s_d_1120_143b,cKilled);
            cch = cch + sVar3;
          }
        }
      }
      if ((rgch + 0x5ff <= psz + cch + 1) || (0x27 < c)) break;
      rgsz[c] = psz;
      rgid[c] = i;
      _strcpy(psz,(char *)szWork);
      psz = psz + cch + 1;
      if (i == viVCRFocus) {
        iChecked = c;
      }
      c = c + 1;
    }
  }
  if (c == 0) {
    sVar3 = -1;
  }
  else {
    sVar3 = PopupMenu(hwnd,x,y,c,(long *)0x0,rgsz,iChecked,1);
    if (sVar3 == -1) {
      sVar3 = -1;
    }
    else {
      sVar3 = rgid[sVar3];
    }
  }
  return sVar3;
}



// ======================================================================
// Function: EnableVCRButtons
// Address: 10e8:48f6
// Segment: MEMORY_VCR
// ======================================================================


void EnableVCRButtons(void)

{
  HWND HVar1;
  short i;
  
  for (i = 0xa1; i < 0xa3; i = i + 1) {
    HVar1 = GetDlgItem(hwndVCRDlg,i);
    EnableWindow(HVar1,(uint)((uint)viStepVCRCur < 0x8000));
  }
  for (i = 0xa3; i < 0xa6; i = i + 1) {
    HVar1 = GetDlgItem(hwndVCRDlg,i);
    EnableWindow(HVar1,(uint)(viStepVCRCur < vcStepVCR));
  }
  if (viStepVCRCur == -1) {
    HVar1 = GetDlgItem(hwndVCRDlg,IDC_U16_0x00A3);
    SetFocus(HVar1);
  }
  else if (viStepVCRCur == vcStepVCR) {
    HVar1 = GetDlgItem(hwndVCRDlg,IDOK);
    SetFocus(HVar1);
  }
  return;
}



