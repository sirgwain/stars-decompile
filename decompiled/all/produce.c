// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: ChangeProduction
// Address: 10d0:0000
// Segment: MEMORY_PRODUCE
// ======================================================================


short ChangeProduction(short fClear)

{
  short (*pasVar1) [9];
  short sVar2;
  char *sz;
  FARPROC pvVar3;
  short fSuccess;
  PROD rgprod [64];
  fn_lpProcProd *lpProcProd;
  short (*penvMemSav) [9];
  short env [9];
  
                    /* Segment:    27
                       Offset:     000bc100
                       Length:     5ff4
                       Min Alloc:  5ff4
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  pasVar1 = penvMem;
  penvMem = &env;
  sVar2 = __setjmp(env);
  if (sVar2 == 0) {
    if (fClear == 0) {
      InitProduction(rgprod);
      fDlgUp = 1;
      pvVar3 = MakeProcInstance(ProductionDlg,hInst);
      fSuccess = DialogBox(0,(LPCSTR)CONCAT22(0x5d,hwndFrame),
                           (HWND)((ulong)pvVar3 >> 0x10),(char)pvVar3);
      FreeProcInstance(pvVar3);
      hwndProdDlg = 0;
      fDlgUp = 0;
    }
    else {
      fSuccess = 1;
    }
    FinishProduction(fSuccess);
    if ((fSuccess != 0) && (sel.grobj == grobjPlanet)) {
      DrawPlanShip(0,8);
    }
    sVar2 = 1;
  }
  else {
    if (((PLPROD *)lpplProdGlob != (PLPROD *)0x0) || (lpplProdGlob._2_2_ != 0)) {
      FreePl((PL *)CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob));
    }
    lpplProdGlob._0_2_ = (PLPROD *)0x0;
    lpplProdGlob._2_2_ = 0;
    if (hwndProdDlg != 0) {
      EndDialog(hwndProdDlg,0);
    }
    hwndProdDlg = 0;
    fDlgUp = 0;
    sVar2 = 0x10;
    sz = PszFormatIds(idsThereIsntEnoughFreeMemoryModifyProduction,(short *)0x0);
    AlertSz(sz,sVar2);
    sVar2 = 0;
  }
  penvMem = pasVar1;
  return sVar2;
}



// ======================================================================
// Function: InitProduction
// Address: 10d0:015e
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d00ef7) */
/* WARNING: Removing unreachable block (ram,0x10d00a78) */
/* WARNING: Removing unreachable block (ram,0x10d00efc) */
/* WARNING: Removing unreachable block (ram,0x10d00fb0) */
/* WARNING: Removing unreachable block (ram,0x10d00de1) */
/* WARNING: Removing unreachable block (ram,0x10d00fb5) */
/* WARNING: Removing unreachable block (ram,0x10d00e3f) */

void InitProduction(PROD *rgprod)

{
  byte *pbVar1;
  PROD *pPVar2;
  undefined2 *puVar3;
  short sVar4;
  uint uVar5;
  PROD *pPVar6;
  undefined2 unaff_SI;
  PROD *pPVar7;
  undefined2 unaff_DI;
  undefined2 uVar8;
  undefined2 uVar9;
  ulong uVar10;
  HULDEF *pHVar11;
  long lVar12;
  ulong uVar13;
  uint in_stack_0000ffde;
  PROD *lpprod;
  PART part;
  short ipl;
  short i;
  ushort u;
  short iSrc;
  short iWarp;
  
  uVar13 = CONCAT22(unaff_SI,unaff_DI);
  uVar10 = __aFulshr(uVar13,in_stack_0000ffde);
  gd.grBits._0_2_ = (uint)gd.grBits & 0xffdf | ((uint)uVar10 & 1) << 5;
  if (rgprod == (PROD *)0x0) {
    rgprod = pProdGlob;
  }
  if (((PLPROD *)sel.pl.lpplprod == (PLPROD *)0x0) &&
     (sel.pl.lpplprod._2_2_ == 0)) {
    i = 2;
  }
  else {
    i = (short)((PLPROD *)sel.pl.lpplprod)->iprodMac;
  }
  lpplProdGlob = LpplAlloc(4,i,htOrd);
  if (((PLPROD *)sel.pl.lpplprod == (PLPROD *)0x0) &&
     (sel.pl.lpplprod._2_2_ == 0)) {
    i = 0;
  }
  else {
    __fmemcpy((PL *)CONCAT22((int)((ulong)lpplProdGlob >> 0x10),
                                     (PL *)lpplProdGlob + 1),
                      (PLPROD *)sel.pl.lpplprod + 1,i << 2);
  }
  ((PLPROD *)lpplProdGlob)->iprodMac = (byte)i;
  cProdGlob = 0;
  pProdGlob = rgprod;
  _memset(rgprod,0,0x100);
  if (((sel.pl.wFlags_0x4 >> 9 & 1) != 0) &&
     (pHVar11 = LphuldefFromId
                          (*(HullDef *)
                            (*(int *)(idPlayer * 4 + rglpshdefSB) +
                            ((uint)sel.pl.lStarbase & 0xf) * 0x93)),
     (((HULDEF *)pHVar11)->hul).wtCargoMax != 0)) {
    for (i = 0; i < 0x10; i = i + 1) {
      if ((((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0) &&
          (-1 < *(int *)((int)&rgshdef[0].wFlags + i * 0x93))) &&
         (uVar5 = *(uint *)((int)&rgshdef[0].hul + 0x28 + i * 0x93),
         pHVar11 = LphuldefFromId
                             (*(HullDef *)
                               (*(int *)(idPlayer * 4 + rglpshdefSB) +
                               ((uint)sel.pl.lStarbase & 0xf) * 0x93)),
         uVar5 <= (((HULDEF *)pHVar11)->hul).wtCargoMax)) {
        uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
        *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
        lVar12 = __aFlshl(uVar13,in_stack_0000ffde);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 4;
        cProdGlob = cProdGlob + 1;
      }
    }
  }
  for (i = 0; i < 10; i = i + 1) {
    if ((((*(uint *)(*(int *)(idPlayer * 4 + rglpshdefSB) + i * 0x93 + 0x7b) >> 9 & 1) == 0)
        && (-1 < *(int *)(*(int *)(idPlayer * 4 + rglpshdefSB) + i * 0x93 + 0x7b))) &&
       ((((uint)sel.pl.lStarbase & 0xf) != i ||
        ((sel.pl.wFlags_0x4 >> 9 & 1) == 0)))) {
      uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
      *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
      lVar12 = __aFlshl(uVar13,in_stack_0000ffde);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 4;
      cProdGlob = cProdGlob + 1;
    }
  }
  part.hs.grhst = hstPlanetary;
  part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | 0xe;
  sVar4 = FLookupPart(&part);
  if (sVar4 == 1) {
    uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
    *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x3400;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  sVar4 = IWarpMAFromLppl(&sel.pl,(short *)0x0);
  if (0 < sVar4) {
    for (i = 0; i < 4; i = i + 1) {
      uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
      *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
      lVar12 = __aFlshl(uVar13,in_stack_0000ffde);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
      cProdGlob = cProdGlob + 1;
    }
  }
  uVar10 = __aFulshr(uVar13,in_stack_0000ffde);
  sVar4 = CMaxFactories(&sel.pl,idPlayer);
  if (0 < (int)(sVar4 - ((uint)uVar10 & 0xfff))) {
    lVar12 = __aFlshl(uVar13,in_stack_0000ffde);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x1c00;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  uVar10 = __aFulshr(uVar13,in_stack_0000ffde);
  sVar4 = CMaxMines(&sel.pl,idPlayer);
  if (0 < (int)(sVar4 - ((uint)uVar10 & 0xfff))) {
    lVar12 = __aFlshl(uVar13,in_stack_0000ffde);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2000;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  uVar5 = sel.pl.rgbImp._4_2_ & 0xfff;
  sVar4 = CMaxDefenses(&sel.pl,idPlayer);
  if (0 < (int)(sVar4 - uVar5)) {
    lVar12 = __aFlshl(uVar13,in_stack_0000ffde);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2400;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
  pPVar6 = rgprod + cProdGlob;
  *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
  *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
  uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
  pPVar6 = rgprod + cProdGlob;
  *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2c00;
  *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
  uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
  pPVar6 = rgprod + cProdGlob;
  *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
  *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
  cProdGlob = cProdGlob + 1;
  uVar10 = __aFulshr(uVar13,in_stack_0000ffde);
  if ((((uint)uVar10 & 0x1f) == 0x1f) &&
     (sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
     sVar4 != raMacintosh)) {
    uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
    *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x6c00;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  sVar4 = IpctCanTerraformLppl(&sel.pl);
  if (0 < sVar4) {
    lVar12 = __aFlshl(uVar13,in_stack_0000ffde);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x3000;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  for (i = 0; i < 7; i = i + 1) {
    sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (((sVar4 != raMacintosh) || (((i != 0 && (i != 1)) && (i != 2)))) &&
       ((sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
        sVar4 != raTerra || ((i != 4 && (i != 5)))))) {
      uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
      *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
      lVar12 = __aFlshl(uVar13,in_stack_0000ffde);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
      cProdGlob = cProdGlob + 1;
    }
  }
  ipl = 0;
  lpprod = (PROD *)((PLPROD *)lpplProdGlob + 1);
  do {
    if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= ipl) {
      if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
        AdvanceTutor();
      }
      return;
    }
    iSrc = 0;
    while( true ) {
      pPVar6 = (PROD *)lpprod;
      uVar8 = (undefined2)((ulong)lpprod >> 0x10);
      if (cProdGlob <= iSrc) break;
      uVar10 = __aFulshr(uVar13,in_stack_0000ffde);
      in_stack_0000ffde = (uint)uVar10 & 7;
      uVar10 = __aFulshr(uVar13,in_stack_0000ffde);
      if (in_stack_0000ffde == ((uint)uVar10 & 7)) {
        uVar10 = __aFulshr(uVar13,in_stack_0000ffde);
        in_stack_0000ffde = (uint)uVar10 & 0x7f;
        uVar10 = __aFulshr(uVar13,in_stack_0000ffde);
        if (in_stack_0000ffde == ((uint)uVar10 & 0x7f)) break;
      }
      iSrc = iSrc + 1;
    }
    if (iSrc < cProdGlob) {
      if (((uint)(pProdGlob + iSrc)->dwFlags & 0x3ff) < ((uint)lpprod->dwFlags & 0x3ff)) {
        lVar12 = __aFlshl(uVar13,in_stack_0000ffde);
        uVar5 = *(uint *)((int)&pPVar6->dwFlags + 2);
        *&lpprod->dwFlags = (uint)lpprod->dwFlags & 0xfc00 | (uint)lVar12;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
      }
      if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
        if (((uint)(pProdGlob + iSrc)->dwFlags & 0x3ff) < ((uint)lpprod->dwFlags & 0x3ff))
        {
          uVar9 = *(undefined2 *)((int)&pProdGlob[iSrc].dwFlags + 2);
          pPVar7 = pProdGlob + iSrc;
          *&pPVar7->dwFlags = (uint)(pProdGlob + iSrc)->dwFlags & 0xfc00;
          *(undefined2 *)((int)&pPVar7->dwFlags + 2) = uVar9;
        }
        else {
          lVar12 = __aFlshl(uVar13,in_stack_0000ffde);
          uVar10 = (pProdGlob + iSrc)->dwFlags;
          pPVar7 = pProdGlob + iSrc;
          pPVar2 = pPVar7;
          *&pPVar2->dwFlags = (uint)pPVar2->dwFlags & 0xfc00;
          puVar3 = (undefined2 *)((int)&pPVar7->dwFlags + 2);
          *puVar3 = *puVar3;
          pPVar7 = pProdGlob + iSrc;
          pPVar2 = pPVar7;
          *&pPVar2->dwFlags = (uint)pPVar2->dwFlags | (int)uVar10 - (int)lVar12 & 0x3ffU;
          puVar3 = (undefined2 *)((int)&pPVar7->dwFlags + 2);
          *puVar3 = *puVar3;
        }
      }
    }
    else {
      uVar9 = (undefined2)((ulong)lpplProdGlob >> 0x10);
      if (ipl + 1 < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
        __fmemcpy(lpprod,(PROD *)CONCAT22(uVar8,pPVar6 + 1),
                          ((uint)((PLPROD *)lpplProdGlob)->iprodMac - (ipl + 1)) * 4);
        ipl = ipl + -1;
      }
      pbVar1 = &((PLPROD *)lpplProdGlob)->iprodMac;
      *pbVar1 = *pbVar1 - 1;
    }
    ipl = ipl + 1;
    lpprod = (PROD *)CONCAT22(uVar8,pPVar6 + 1);
  } while( true );
}



// ======================================================================
// Function: FinishProduction
// Address: 10d0:1090
// Segment: MEMORY_PRODUCE
// ======================================================================


void FinishProduction(short fWrite)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar1;
  
  if (fWrite == 0) {
    lVar1 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),(uint)gd.grBits >> 5 & 1);
    sel.pl.rgbImp._4_2_ = sel.pl.rgbImp._4_2_ | (uint)lVar1;
    sel.pl.rgbImp._6_2_ =
         sel.pl.rgbImp._6_2_ & 0xff7f | (uint)((ulong)lVar1 >> 0x10);
    FreePl(lpplProdGlob);
  }
  else {
    FreePl((PL *)CONCAT22(sel.pl.lpplprod._2_2_,
                                  (PLPROD *)sel.pl.lpplprod));
    if ((((PLPROD *)lpplProdGlob != (PLPROD *)0x0) || (lpplProdGlob._2_2_ != 0)) &&
       (((PLPROD *)lpplProdGlob)->iprodMac == 0)) {
      FreePl(lpplProdGlob);
      lpplProdGlob = (PLPROD *)0x0;
    }
    sel.pl.lpplprod._0_2_ = (PLPROD *)lpplProdGlob;
    sel.pl.lpplprod._2_2_ = lpplProdGlob._2_2_;
    lpplProdGlob = (PLPROD *)0x0;
    FLookupPlanet(-1,(PLANET *)&sel.pl);
    FLookupPlanet(sel.pl.id,(PLANET *)&sel.pl);
    if (fAi == 0) {
      FillPlanetProdLB(0,(PLPROD *)0x0,(PLANET *)0x0);
      DrawPlanShip(0,0x40);
    }
  }
  lpplProdGlob = (PLPROD *)0x0;
  if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
    tutor.wFlags = tutor.wFlags & 0xfbffU | 0x400;
    AdvanceTutor();
  }
  return;
}



// ======================================================================
// Function: ProductionDlg
// Address: 10d0:1204
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: fRet */

short ProductionDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  POINT PVar1;
  int iVar2;
  HWND HVar3;
  char *pcVar4;
  BOOL BVar5;
  HDC hdc_00;
  short sVar6;
  char **ppcVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  bool bVar8;
  ulong uVar9;
  FARPROC pvVar10;
  short fRet;
  fn_lpProc *lpProc;
  undefined1 local_e4 [140];
  int local_58;
  short local_56 [9];
  char *local_44;
  int local_42;
  short local_40;
  int local_3e;
  int local_3c;
  undefined8 local_3a;
  POINT local_32;
  RECT rc;
  PAINTSTRUCT ps;
  HDC hdc;
  
  uVar9 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    hdc_00 = BeginPaint(hwnd,&ps);
    GetClientRect(hwnd,&rc);
    DrawProductionDlg(hwnd,hdc_00,&rc,-1);
    EndPaint(hwnd,&ps);
    sVar6 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    sVar6 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      local_32.y = (HWND)lParam;
      HVar3 = GetDlgItem(hwnd,0x8b);
      if ((local_32.y == HVar3) || (uVar9 = __aFulshr(uVar9,fRet), (int)uVar9 == 6)) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else if (message == WM_SETCURSOR) {
      local_3a._6_2_ = 0;
      GetCursorPos(&local_32);
      ScreenToClient(hwnd,&local_32);
      BVar5 = PtInRect(&rcProdDiamond,local_32);
      if (BVar5 != 0) {
        setcursor(hcurArrowHelp);
        return 1;
      }
    }
    else {
      if (message == WM_DRAWITEM) {
        local_32 = (POINT)lParam;
        if (*(int *)((HWND)lParam + 4) == -1) {
          HandleFocusState((DRAWITEMSTRUCT *)lParam,-2);
        }
        else {
          iVar2 = *(int *)((HWND)lParam + 6);
          if (((iVar2 == 1) || (iVar2 == 2)) || (iVar2 == 4)) {
            DrawCBEntireItem((DRAWITEMSTRUCT *)lParam,4);
          }
        }
        return 1;
      }
      if (message == WM_MEASUREITEM) {
        *(int *)((HWND)lParam + 8) = dyArial8 + 2;
        return 1;
      }
      if (message == WM_INITDIALOG) {
        local_56[0] = 0x42e;
        local_56[1] = 0x42f;
        local_56[2] = 1;
        local_56[3] = 2;
        local_56[4] = 0x418;
        local_56[5] = 0x419;
        local_56[6] = 0x439;
        local_56[7] = 0x43a;
        local_56[8] = 0x42d;
        local_44 = (char *)&game.mdDensity;
        hwndProdDlg = hwnd;
        if (*(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) < 2) {
          HVar3 = GetDlgItem(hwnd,0x42f);
          EnableWindow(HVar3,0);
          HVar3 = GetDlgItem(hwnd,0x42e);
          EnableWindow(HVar3,0);
        }
        if ((uint)gd.grBits >> 0xe == 0) {
          local_40 = 0x262;
          local_32.x = dyArial8 * 0x18 + 0x18;
        }
        else {
          local_40 = 0x2f8;
          local_32.x = 0x244;
        }
        SetWindowPos(hwnd,0,0,0,local_40,local_32.x,6);
        GetClientRect(hwnd,&rc);
        local_3e = rc.right >> 1;
        local_42 = (rc.bottom - (dyArial8 * 0x11) / 2) + -0x18;
        rc.left = (rc.right * 0xb) / 0x14 + 0x10;
        local_32.y = (rc.right - rc.left) / 4;
        rc.bottom = rc.bottom - ((dyArial8 * 3) / 2 + 6);
        HVar3 = GetDlgItem(hwnd,0x8b);
        SetWindowPos(HVar3,0,6,rc.bottom,rc.left + -0xc,(dyArial8 * 3) / 2,4);
        for (local_3c = 0; local_3c < 4; local_3c = local_3c + 1) {
          HVar3 = GetDlgItem(hwnd,local_56[local_3c]);
          SetWindowPos(HVar3,0,rc.left,rc.bottom,local_32.y + -6,(dyArial8 * 3) / 2,4);
          rc.left = rc.left + local_32.y;
        }
        rc.left = local_3e - (local_32.y + 0x12 >> 1);
        local_58 = (dyArial8 * 3) / 2;
        iVar2 = (local_42 + dyArial8 * -9) / 5 + local_58;
        local_32.x = iVar2 + -3;
        rc.top = 8;
        if (0x32 < local_32.x) {
          rc.top = ((iVar2 + -0x35) * 5) / 2 + 8;
          local_32.x = 0x32;
        }
        local_32.y = local_32.y + 0x18;
        for (local_3c = 4; local_3c < 10; local_3c = local_3c + 1) {
          HVar3 = GetDlgItem(hwnd,local_56[local_3c]);
          SetWindowPos(HVar3,0,rc.left,rc.top,local_32.y + -6,(dyArial8 * 3) / 2,4);
          rc.top = rc.top + local_32.x;
        }
        HVar3 = GetDlgItem(hwnd,0x416);
        SetWindowPos(HVar3,0,6,6,rc.left + -0xc,local_42,4);
        HVar3 = GetDlgItem(hwnd,0x416);
        GetWindowRect(HVar3,&local_3a);
        HVar3 = GetDlgItem(hwnd,0x417);
        SetWindowPos(HVar3,0,rc.left + local_32.y,6,rc.left + -0xc,local_3a._6_2_ - local_3a._2_2_,4
                    );
        ScreenToClient(hwnd,(POINT *)((int)&local_3a + 4));
        yTopFutureTech = local_3a._6_2_;
        InitializeProductionDlg(hwnd);
        if (((uint)gd.grBits >> 0xe == 1) && (ptStickyProduceDlg.y == -1)) {
          ptStickyProduceDlg.y = 0;
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyProduceDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        ProdCommandHandler(hwnd,wParam,lParam);
      }
      else if ((message == WM_LBUTTONDOWN) || (message == WM_RBUTTONDOWN)) {
        local_32.x = (HWND)lParam;
        uVar9 = __aFulshr(uVar9,fRet);
        PVar1.y = (short)uVar9;
        PVar1.x = local_32.x;
        local_32.y = (short)uVar9;
        BVar5 = PtInRect(&rcProdDiamond,PVar1);
        if (BVar5 != 0) {
          if (message == WM_LBUTTONDOWN) {
            GlobalPD.grPopup = 10;
            GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = hstMining|hstTorp|hstBeam|hstShield;
            GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = (ushort)szPopupBuffer;
            CchGetString
                      (idsRightClickBlueDiamondApplyProductionTemplate,
                       (char *)szPopupBuffer);
            Popup(hwnd,local_32.x,local_32.y);
          }
          else {
            local_3a._4_1_ = 0xff;
            local_3a._5_1_ = 0;
            local_3a._6_2_ = 0;
            for (local_3a._2_2_ = 0; local_3a._2_2_ < 4; local_3a._2_2_ = local_3a._2_2_ + 1) {
              if (*(char *)((int)&vrgZipProd[0].fValid + local_3a._2_2_ * 0x28) != '\0') {
                ppcVar7 = &local_44 + local_3a._6_2_;
                local_3a._6_2_ = local_3a._6_2_ + 1;
                *ppcVar7 = ((ZIPPRODQ *)vrgZipProd)[local_3a._2_2_].szName;
              }
            }
            ppcVar7 = &local_44 + local_3a._6_2_;
            local_3a._6_2_ = local_3a._6_2_ + 1;
            *ppcVar7 = (char *)((int)&local_3a + 4);
            pcVar4 = PszGetCompressedString(idsCustomize);
            ppcVar7 = &local_44 + local_3a._6_2_;
            local_3a._6_2_ = local_3a._6_2_ + 1;
            *ppcVar7 = pcVar4;
            local_3a._2_2_ =
                 PopupMenu(hwnd,local_32.x,local_32.y,local_3a._6_2_,(long *)0x0,&local_44,-1
                                  ,1);
            if (local_3a._2_2_ == local_3a._6_2_ + -1) {
              _memcpy(local_e4,(ZIPPRODQ *)vrgZipProd,0xa0);
              pvVar10 = MakeProcInstance(ZipProdDlg,hInst);
              sVar6 = DialogBox(0,(LPCSTR)CONCAT22(0x59,hwnd),(HWND)((ulong)pvVar10 >> 0x10),
                                (char)pvVar10);
              FreeProcInstance(pvVar10);
              if (sVar6 == 0) {
                _memcpy((ZIPPRODQ *)vrgZipProd,local_e4,0xa0);
              }
            }
            else if (-1 < local_3a._2_2_) {
              local_3a._6_2_ = 0;
              while ((local_3a._6_2_ < 4 &&
                     ((*(char *)((int)&vrgZipProd[0].fValid + local_3a._6_2_ * 0x28) ==
                       '\0' || (iVar2 = local_3a._2_2_ + -1, bVar8 = local_3a._2_2_ != 0,
                               local_3a._2_2_ = iVar2, bVar8))))) {
                local_3a._6_2_ = local_3a._6_2_ + 1;
              }
              ProdCommandHandler(hwnd,0x816,(long)local_3a._6_2_);
            }
          }
        }
      }
    }
    sVar6 = 0;
  }
  return sVar6;
}



// ======================================================================
// Function: ProdCommandHandler
// Address: 10d0:1994
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d01f07) */
/* WARNING: Removing unreachable block (ram,0x10d01a99) */
/* WARNING: Removing unreachable block (ram,0x10d026c2) */
/* WARNING: Removing unreachable block (ram,0x10d023e0) */
/* WARNING: Removing unreachable block (ram,0x10d02357) */
/* WARNING: Removing unreachable block (ram,0x10d02404) */
/* WARNING: Removing unreachable block (ram,0x10d025ca) */
/* WARNING: Removing unreachable block (ram,0x10d01a12) */
/* WARNING: Removing unreachable block (ram,0x10d01e16) */
/* WARNING: Removing unreachable block (ram,0x10d021cd) */
/* WARNING: Removing unreachable block (ram,0x10d029e0) */
/* WARNING: Removing unreachable block (ram,0x10d01dc1) */
/* WARNING: Removing unreachable block (ram,0x10d01b8e) */
/* WARNING: Removing unreachable block (ram,0x10d01b0c) */
/* WARNING: Removing unreachable block (ram,0x10d01a9e) */
/* WARNING: Removing unreachable block (ram,0x10d01b07) */
/* WARNING: Removing unreachable block (ram,0x10d01b89) */
/* WARNING: Removing unreachable block (ram,0x10d01d7f) */
/* WARNING: Removing unreachable block (ram,0x10d022cf) */
/* WARNING: Removing unreachable block (ram,0x10d029ab) */
/* WARNING: Removing unreachable block (ram,0x10d029e5) */
/* WARNING: Removing unreachable block (ram,0x10d027b8) */
/* WARNING: Removing unreachable block (ram,0x10d0231d) */
/* WARNING: Removing unreachable block (ram,0x10d02093) */
/* WARNING: Removing unreachable block (ram,0x10d02051) */
/* WARNING: Removing unreachable block (ram,0x10d01f51) */
/* WARNING: Removing unreachable block (ram,0x10d01f0c) */
/* WARNING: Removing unreachable block (ram,0x10d01f8e) */
/* WARNING: Removing unreachable block (ram,0x10d02816) */
/* WARNING: Removing unreachable block (ram,0x10d03237) */
/* WARNING: Removing unreachable block (ram,0x10d02222) */
/* WARNING: Removing unreachable block (ram,0x10d03098) */
/* WARNING: Type propagation algorithm not settling */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void ProdCommandHandler(HWND hwnd,ushort wParam,long lParam)

{
  PROD *pPVar1;
  undefined2 *puVar2;
  uint *puVar3;
  byte *pbVar4;
  undefined2 uVar5;
  PL *pPVar6;
  undefined2 uVar7;
  uint uVar8;
  uint uVar9;
  uint uVar10;
  uint uVar11;
  HWND HVar12;
  HWND HVar13;
  short sVar14;
  int iVar15;
  ushort uVar16;
  PROD *pPVar17;
  PLPROD *pPVar18;
  uint *puVar19;
  undefined2 *puVar20;
  short *psVar21;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar22;
  undefined2 unaff_SS;
  bool bVar23;
  ulong uVar24;
  ulong uVar25;
  PL *pPVar26;
  ulong uVar27;
  long lVar28;
  LRESULT LVar29;
  void *pvVar30;
  PLANET *pPVar31;
  undefined2 uVar32;
  short sVar33;
  undefined2 uVar34;
  UINT UVar35;
  ushort uVar36;
  ushort in_stack_0000ffc2;
  PLPROD *lpplprodT;
  short cMax;
  PROD prod;
  PROD *lpprod;
  RECT rc;
  short iMac;
  short fRefillSrc;
  short ipl;
  PROD prodLast;
  short iDst;
  short c;
  HWND hwndLB;
  short iSrc;
  long lSel;
  
  uVar24 = CONCAT22(unaff_SI,unaff_DI);
  if ((wParam == 1) || (wParam == 2)) {
    hwndProdDlg = 0;
    StickyDlgPos(hwnd,(POINT *)&ptStickyProduceDlg,0);
    EndDialog(hwnd,(uint)(wParam == 1));
    return;
  }
  if (wParam == 0x76) {
    WinHelp(hwnd,_szHelpFile,1,0x423);
    return;
  }
  if (wParam == 0x8b) {
    HVar12 = GetDlgItem(hwnd,0x417);
    HVar13 = GetDlgItem(hwnd,0x8b);
    SendMessage(HVar13,0x400,0,0);
    lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
    sel.pl.rgbImp._4_2_ = sel.pl.rgbImp._4_2_ | (uint)lVar28;
    sel.pl.rgbImp._6_2_ =
         sel.pl.rgbImp._6_2_ & 0xff7f | (uint)((ulong)lVar28 >> 0x10);
    LVar29 = SendMessage(HVar12,0x409,0,0);
    FillPlanetProdLB(HVar12,lpplProdGlob,(PLANET *)0x0);
    lSel._0_2_ = (uint)LVar29;
    uVar22 = 0x14f8;
    SendMessage(HVar12,0x407,(uint)lSel,0);
    psVar21 = &stack0xffbe;
    goto PRODUCE_RedrawText;
  }
  if ((wParam == 0x416) || (wParam == 0x417)) {
    uVar22 = 0x1118;
    uVar27 = __aFulshr(uVar24,in_stack_0000ffc2);
    psVar21 = &stack0xffbe;
    if ((int)uVar27 == 1) goto PRODUCE_RedrawText;
    uVar27 = __aFulshr(uVar24,in_stack_0000ffc2);
    if ((int)uVar27 != 2) {
      return;
    }
    if (wParam == 0x416) goto PRODUCE_AddItem;
  }
  else {
    if (wParam == 0x418) {
PRODUCE_AddItem:
      uVar36 = (ushort)uVar24;
      HVar12 = GetDlgItem(hwnd,0x416);
      lVar28 = SendMessage(HVar12,0x409,0,0);
      if (((int)((ulong)lVar28 >> 0x10) < 1) && (lVar28 < 0)) {
        return;
      }
      iSrc = 0;
      while( true ) {
        lSel._2_2_ = (int)((ulong)lVar28 >> 0x10);
        lSel._0_2_ = (uint)lVar28;
        if ((cProdGlob <= iSrc) ||
           ((((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0 &&
            (bVar23 = lVar28 == 0,
            lVar28 = CONCAT22(lSel._2_2_ - (uint)((uint)lSel == 0),(uint)lSel + -1), bVar23))))
        break;
        iSrc = iSrc + 1;
      }
      uVar9 = (uint)(pProdGlob + iSrc)->dwFlags;
      prod.dwFlags._2_2_ = *(uint *)((int)&pProdGlob[iSrc].dwFlags + 2);
      uVar22 = 0x11;
      uVar8 = GetAsyncKeyState(0x11);
      if ((uVar8 & 0xfffe) == 0) {
        uVar34 = 0x10;
        uVar8 = GetAsyncKeyState(0x10);
        if ((uVar8 & 0xfffe) == 0) {
          prod.dwFlags._0_2_ = uVar9 & 0xfc00 | 1;
        }
        else {
          lVar28 = __aFlshl(CONCAT22(uVar22,uVar34),uVar36);
          prod.dwFlags._0_2_ = uVar9 & 0xfc00 | (uint)lVar28;
          prod.dwFlags._2_2_ = prod.dwFlags._2_2_ | (uint)((ulong)lVar28 >> 0x10);
        }
      }
      else {
        uVar34 = 0x10;
        uVar8 = GetAsyncKeyState(0x10);
        if ((uVar8 & 0xfffe) == 0) {
          lVar28 = __aFlshl(CONCAT22(uVar22,uVar34),uVar36);
          uVar8 = (uint)((ulong)lVar28 >> 0x10);
          prod.dwFlags._0_2_ = uVar9 & 0xfc00 | (uint)lVar28;
        }
        else {
          lVar28 = __aFlshl(CONCAT22(uVar22,uVar34),uVar36);
          uVar8 = (uint)((ulong)lVar28 >> 0x10);
          prod.dwFlags._0_2_ = uVar9 & 0xfc00 | (uint)lVar28;
        }
        prod.dwFlags._2_2_ = prod.dwFlags._2_2_ | uVar8;
      }
      if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
        lVar28 = __aFlshl(CONCAT22(uVar22,uVar34),uVar36);
        lpplprodT._2_2_ = (int)(pProdGlob + iSrc)->dwFlags - (int)lVar28 & 0x3ff;
        pPVar17 = pProdGlob + iSrc;
        pPVar1 = pPVar17;
        *&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
        puVar2 = (undefined2 *)((int)&pPVar17->dwFlags + 2);
        *puVar2 = *puVar2;
        pPVar17 = pProdGlob + iSrc;
        pPVar1 = pPVar17;
        *&pPVar1->dwFlags = (uint)pPVar1->dwFlags | lpplprodT._2_2_;
        puVar2 = (undefined2 *)((int)&pPVar17->dwFlags + 2);
        *puVar2 = *puVar2;
      }
      uVar9 = (uint)((PLPROD *)lpplProdGlob)->iprodMac;
      HVar12 = GetDlgItem(hwnd,0x417);
      LVar29 = SendMessage(HVar12,0x409,0,0);
      if ((LVar29 < 0x10000) && (LVar29 < 0)) {
        iDst = uVar9 - 1;
        if (iDst < 0) {
          iDst = 0;
        }
      }
      else {
        iDst = (int)LVar29 + -1;
      }
      if (iDst < (int)uVar9) {
        if (iDst < 0) {
LAB_10d0_1fde:
          iDst = iDst + 1;
          if (iDst < (int)uVar9) {
            uVar24 = __aFulshr(CONCAT22(uVar22,uVar34),uVar36);
            lpplprodT._2_2_ = (uint)uVar24 & 0x7f;
            uVar24 = __aFulshr(CONCAT22(uVar22,uVar34),uVar36);
            if (lpplprodT._2_2_ == ((uint)uVar24 & 0x7f)) {
              uVar24 = __aFulshr(CONCAT22(uVar22,uVar34),uVar36);
              lpplprodT._2_2_ = (uint)uVar24 & 7;
              uVar24 = __aFulshr(CONCAT22(uVar22,uVar34),uVar36);
              if (lpplprodT._2_2_ == ((uint)uVar24 & 7)) goto PRODUCE_RingItUp;
            }
          }
          goto LAB_10d0_2099;
        }
        uVar24 = __aFulshr(CONCAT22(uVar22,uVar34),uVar36);
        lpplprodT._2_2_ = (uint)uVar24 & 0x7f;
        uVar24 = __aFulshr(CONCAT22(uVar22,uVar34),uVar36);
        if (lpplprodT._2_2_ != ((uint)uVar24 & 0x7f)) goto LAB_10d0_1fde;
        uVar24 = __aFulshr(CONCAT22(uVar22,uVar34),uVar36);
        lpplprodT._2_2_ = (uint)uVar24 & 7;
        uVar24 = __aFulshr(CONCAT22(uVar22,uVar34),uVar36);
        if (lpplprodT._2_2_ != ((uint)uVar24 & 7)) goto LAB_10d0_1fde;
PRODUCE_RingItUp:
        lVar28 = __aFlshl(CONCAT22(uVar22,uVar34),uVar36);
        uVar32 = lpplProdGlob._2_2_;
        uVar9 = *(uint *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
        pPVar18 = (PLPROD *)lpplProdGlob + iDst + 1;
        pPVar18->wFlags = ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0xfc00 | (uint)lVar28
        ;
        *(uint *)&pPVar18->iprodMax = uVar9 | (uint)((ulong)lVar28 >> 0x10);
        if (((1 < (((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0x3ff)) &&
            (uVar24 = __aFulshr(CONCAT22(uVar22,uVar34),uVar36), ((uint)uVar24 & 0x7f) == 3)
            ) && (uVar24 = __aFulshr(CONCAT22(uVar22,uVar34),uVar36),
                 ((uint)uVar24 & 7) == 1)) {
          uVar34 = lpplProdGlob._2_2_;
          uVar22 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
          pPVar18 = (PLPROD *)lpplProdGlob + iDst + 1;
          pPVar18->wFlags = ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0xfc00 | 1;
          *(undefined2 *)&pPVar18->iprodMax = uVar22;
        }
      }
      else {
LAB_10d0_2099:
        if (0x27 < uVar9) {
          uVar22 = 0x14f8;
          MessageBeep(0);
          psVar21 = &stack0xffba;
          goto PRODUCE_RedrawText;
        }
        if (uVar9 == ((PLPROD *)lpplProdGlob)->iprodMax) {
          lpplProdGlob = LpplReAlloc(lpplProdGlob,uVar9 + 4);
        }
        if (iDst != uVar9) {
          __fmemmove((PLPROD *)
                             CONCAT22(lpplProdGlob._2_2_,
                                      (PLPROD *)lpplProdGlob + iDst + 2),
                             (PLPROD *)
                             CONCAT22(lpplProdGlob._2_2_,
                                      (PLPROD *)lpplProdGlob + iDst + 1),(uVar9 - iDst) * 4);
        }
        uVar22 = lpplProdGlob._2_2_;
        pPVar18 = (PLPROD *)lpplProdGlob + iDst + 1;
        pPVar18->wFlags = (uint)prod.dwFlags;
        *(uint *)&pPVar18->iprodMax = prod.dwFlags._2_2_;
        pbVar4 = &((PLPROD *)lpplProdGlob)->iprodMac;
        *pbVar4 = *pbVar4 + 1;
      }
      psVar21 = &stack0xffba;
      uVar34 = 0;
      pPVar31 = (PLANET *)0x0;
      pPVar18 = (PLPROD *)lpplProdGlob;
      uVar22 = lpplProdGlob._2_2_;
      HVar12 = GetDlgItem(hwnd,0x417);
      FillPlanetProdLB
                (HVar12,(PLPROD *)CONCAT22(uVar22,pPVar18),(PLANET *)CONCAT22(uVar34,pPVar31));
      HVar12 = GetDlgItem(hwnd,0x417);
      uVar22 = 0x14f8;
      SendMessage(HVar12,0x407,iDst + 1,0);
      if (((pProdGlob + iSrc)->dwFlags & 0x3ff) == 0) {
        sVar33 = -1;
        HVar12 = GetDlgItem(hwnd,0x416);
        uVar22 = 0x10d0;
        FillProdSrcLB(HVar12,sVar33);
        psVar21 = &stack0xffba;
      }
      goto PRODUCE_RedrawText;
    }
    if (wParam != 0x419) {
      if (wParam != 0x42d) {
        if ((wParam == 0x42e) || (wParam == 0x42f)) {
          if (wParam == 0x42f) {
            sVar33 = 1;
          }
          else {
            sVar33 = -1;
          }
          FinishProduction(1);
          sVar14 = GetKeyState(0x10);
          if (sVar14 < 0) {
            sVar33 = IdFindAdjStarbase(sel.pl.id,(uint)(wParam == 0x42f));
            SelectAdjPlanet(0,sVar33);
          }
          else {
            SelectAdjPlanet(sVar33,0);
          }
          InitProduction((PROD *)0x0);
          InitializeProductionDlg(hwnd);
          GetClientRect(hwnd,&rc);
          rc.top = yTopFutureTech;
          rc.bottom = dyArial8 * 9 + yTopFutureTech;
          InvalidateRect(hwnd,&rc,1);
          return;
        }
        if (wParam == 0x439) {
          HVar12 = GetDlgItem(hwnd,0x417);
          LVar29 = SendMessage(HVar12,0x409,0,0);
          if (LVar29 < 2) {
            return;
          }
          uVar34 = (undefined2)((ulong)lpplProdGlob >> 0x10);
          pPVar18 = (PLPROD *)lpplProdGlob;
          lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar20 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar28);
          uVar22 = *puVar20;
          uVar34 = puVar20[1];
          pPVar18 = (PLPROD *)lpplProdGlob;
          uVar5 = lpplProdGlob._2_2_;
          lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar20 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar28);
          uVar32 = *puVar20;
          uVar5 = puVar20[1];
          pPVar18 = (PLPROD *)lpplProdGlob;
          uVar7 = lpplProdGlob._2_2_;
          lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar20 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar28);
          *puVar20 = uVar32;
          puVar20[1] = uVar5;
          pPVar18 = (PLPROD *)lpplProdGlob;
          uVar32 = lpplProdGlob._2_2_;
          lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar20 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar28);
          *puVar20 = uVar22;
          puVar20[1] = uVar34;
          uVar34 = 0;
          pPVar31 = (PLANET *)0x0;
          pPVar18 = (PLPROD *)lpplProdGlob;
          uVar22 = lpplProdGlob._2_2_;
          HVar12 = GetDlgItem(hwnd,0x417);
          FillPlanetProdLB
                    (HVar12,(PLPROD *)CONCAT22(uVar22,pPVar18),(PLANET *)CONCAT22(uVar34,pPVar31));
          HVar12 = GetDlgItem(hwnd,0x417);
          uVar22 = 0x14f8;
          SendMessage(HVar12,0x407,(int)LVar29 - 1,0);
          psVar21 = &stack0xffbe;
          goto PRODUCE_RedrawText;
        }
        if (wParam == 0x43a) {
          HVar12 = GetDlgItem(hwnd,0x417);
          LVar29 = SendMessage(HVar12,0x409,0,0);
          uVar22 = (undefined2)((ulong)lpplProdGlob >> 0x10);
          pPVar18 = (PLPROD *)lpplProdGlob;
          if (LVar29 < 1) {
            return;
          }
          if (-1 < LVar29) {
            if (0xffff < LVar29) {
              return;
            }
            if ((uint)pPVar18->iprodMac <= (uint)LVar29) {
              return;
            }
          }
          lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar20 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar28);
          uVar34 = *puVar20;
          uVar22 = puVar20[1];
          pPVar18 = (PLPROD *)lpplProdGlob;
          uVar5 = lpplProdGlob._2_2_;
          lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar20 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar28);
          uVar32 = *puVar20;
          uVar5 = puVar20[1];
          pPVar18 = (PLPROD *)lpplProdGlob;
          uVar7 = lpplProdGlob._2_2_;
          lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar20 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar28);
          *puVar20 = uVar32;
          puVar20[1] = uVar5;
          pPVar18 = (PLPROD *)lpplProdGlob;
          uVar32 = lpplProdGlob._2_2_;
          lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar20 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar28);
          *puVar20 = uVar34;
          puVar20[1] = uVar22;
          uVar34 = 0;
          pPVar31 = (PLANET *)0x0;
          pPVar18 = (PLPROD *)lpplProdGlob;
          uVar22 = lpplProdGlob._2_2_;
          HVar12 = GetDlgItem(hwnd,0x417);
          FillPlanetProdLB
                    (HVar12,(PLPROD *)CONCAT22(uVar22,pPVar18),(PLANET *)CONCAT22(uVar34,pPVar31));
          HVar12 = GetDlgItem(hwnd,0x417);
          uVar22 = 0x14f8;
          SendMessage(HVar12,0x407,(uint)LVar29 + 1,0);
          psVar21 = &stack0xffbe;
          goto PRODUCE_RedrawText;
        }
        if (wParam != 0x816) {
          return;
        }
      }
      ipl = 0;
      while( true ) {
        uVar22 = (undefined2)((ulong)lpplProdGlob >> 0x10);
        if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= ipl) break;
        for (iSrc = 0; iSrc < cProdGlob; iSrc = iSrc + 1) {
          uVar27 = __aFulshr(uVar24,in_stack_0000ffc2);
          uVar25 = __aFulshr(uVar24,in_stack_0000ffc2);
          if (((uint)uVar27 & 7) == ((uint)uVar25 & 7)) {
            uVar27 = __aFulshr(uVar24,in_stack_0000ffc2);
            uVar25 = __aFulshr(uVar24,in_stack_0000ffc2);
            if (((uint)uVar27 & 0x7f) == ((uint)uVar25 & 0x7f)) break;
          }
        }
        if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
          lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
          lpplprodT._2_2_ = (int)lVar28 + (int)(pProdGlob + iSrc)->dwFlags & 0x3ff;
          pPVar17 = pProdGlob + iSrc;
          pPVar1 = pPVar17;
          *&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
          puVar2 = (undefined2 *)((int)&pPVar17->dwFlags + 2);
          *puVar2 = *puVar2;
          pPVar17 = pProdGlob + iSrc;
          pPVar1 = pPVar17;
          *&pPVar1->dwFlags = (uint)pPVar1->dwFlags | lpplprodT._2_2_;
          puVar2 = (undefined2 *)((int)&pPVar17->dwFlags + 2);
          *puVar2 = *puVar2;
        }
        ipl = ipl + 1;
      }
      if (wParam == 0x816) {
        uVar27 = __aFulmul(lParam,0x28);
        cMax = (uint)((PLPROD *)lpplProdGlob)->iprodMac +
               (uint)*(byte *)((int)((ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1)->
                                    rgpq + (int)uVar27 + -1);
        if (cMax == 0) {
          cMax = 1;
        }
        pPVar26 = LpplAlloc(4,cMax,htOrd);
        uVar22 = (undefined2)((ulong)pPVar26 >> 0x10);
        pPVar6 = (PL *)pPVar26;
        __fmemset((PL *)CONCAT22(uVar22,pPVar6 + 1),0,cMax << 2);
        iDst = 0;
        for (iSrc = 0; iSrc < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; iSrc = iSrc + 1)
        {
          uVar27 = __aFulshr(uVar24,in_stack_0000ffc2);
          if ((((uint)uVar27 & 7) != 1) ||
             (uVar27 = __aFulshr(uVar24,in_stack_0000ffc2), 6 < ((uint)uVar27 & 0x7f))) {
            uVar34 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iSrc + 1].iprodMax;
            (pPVar6 + iDst + 1)->wFlags = ((PLPROD *)lpplProdGlob + iSrc + 1)->wFlags;
            *(undefined2 *)&pPVar6[iDst + 1].iMax = uVar34;
            iDst = iDst + 1;
          }
        }
        for (iSrc = 0; uVar27 = __aFulmul(lParam,0x28),
            iSrc < (int)(uint)*(byte *)((int)((ZIPPRODQ1 *)
                                             &vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1)->rgpq
                                       + (int)uVar27 + -1); iSrc = iSrc + 1) {
          sVar33 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
          if (((sVar33 != raMacintosh) ||
              (uVar27 = __aFulmul(lParam,0x28),
              2 < (*(uint *)((int)uVar27 + 0x2306 + iSrc * 2) & 0x3f))) &&
             ((sVar33 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
              sVar33 != raTerra ||
              ((uVar27 = __aFulmul(lParam,0x28),
               (*(uint *)((int)uVar27 + 0x2306 + iSrc * 2) & 0x3f) != 4 &&
               (uVar27 = __aFulmul(lParam,0x28),
               (*(uint *)((int)uVar27 + 0x2306 + iSrc * 2) & 0x3f) != 5)))))) {
            uVar9 = *(uint *)&pPVar6[iDst + 1].iMax;
            (pPVar6 + iDst + 1)->wFlags = (pPVar6 + iDst + 1)->wFlags;
            *(uint *)&pPVar6[iDst + 1].iMax = uVar9 & 0xfff1 | 2;
            __aFulmul(lParam,0x28);
            lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
            uVar9 = *(uint *)&pPVar6[iDst + 1].iMax;
            (pPVar6 + iDst + 1)->wFlags = (pPVar6 + iDst + 1)->wFlags & 0x3ff | (uint)lVar28;
            *(uint *)&pPVar6[iDst + 1].iMax = uVar9 & 0xfffe | (uint)((ulong)lVar28 >> 0x10);
            __aFulmul(lParam,0x28);
            lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
            uVar9 = *(uint *)&pPVar6[iDst + 1].iMax;
            (pPVar6 + iDst + 1)->wFlags = (pPVar6 + iDst + 1)->wFlags & 0xfc00 | (uint)lVar28;
            *(uint *)&pPVar6[iDst + 1].iMax = uVar9 | (uint)((ulong)lVar28 >> 0x10);
            iDst = iDst + 1;
          }
        }
        pPVar6->iMac = (byte)iDst;
        FreePl(lpplProdGlob);
        lpplProdGlob = pPVar26;
        __aFulmul(lParam,0x28);
        lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
        uVar36 = (ushort)uVar24;
        sel.pl.rgbImp._4_2_ = sel.pl.rgbImp._4_2_ | (uint)lVar28;
        sel.pl.rgbImp._6_2_ =
             sel.pl.rgbImp._6_2_ & 0xff7f | (uint)((ulong)lVar28 >> 0x10);
        HVar12 = GetDlgItem(hwnd,0x8b);
        UVar35 = 0x401;
        uVar24 = __aFulshr(CONCAT22(HVar12,0x401),uVar36);
        SendMessage(HVar12,UVar35,(uint)uVar24 & 1,0);
      }
      else {
        ((PLPROD *)lpplProdGlob)->iprodMac = 0;
      }
      uVar34 = 0;
      pPVar31 = (PLANET *)0x0;
      pPVar18 = (PLPROD *)lpplProdGlob;
      uVar22 = lpplProdGlob._2_2_;
      HVar12 = GetDlgItem(hwnd,0x417);
      FillPlanetProdLB
                (HVar12,(PLPROD *)CONCAT22(uVar22,pPVar18),(PLANET *)CONCAT22(uVar34,pPVar31));
      HVar12 = GetDlgItem(hwnd,0x417);
      SendMessage(HVar12,0x407,0,0);
      sVar33 = -1;
      HVar12 = GetDlgItem(hwnd,0x416);
      FillProdSrcLB(HVar12,sVar33);
      HVar12 = GetDlgItem(hwnd,0x416);
      uVar22 = 0x14f8;
      SendMessage(HVar12,0x407,0,0);
      psVar21 = &stack0xffbe;
      goto PRODUCE_RedrawText;
    }
  }
  HVar12 = GetDlgItem(hwnd,0x417);
  LVar29 = SendMessage(HVar12,0x409,0,0);
  uVar9 = (uint)LVar29;
  if (LVar29 < 1) {
    return;
  }
  uVar22 = (undefined2)((ulong)lpplProdGlob >> 0x10);
  pPVar18 = (PLPROD *)lpplProdGlob;
  uVar10 = (uint)pPVar18->iprodMac;
  lSel._0_2_ = uVar9 - 1;
  lSel._2_2_ = (int)((ulong)LVar29 >> 0x10) - (uint)(uVar9 == 0);
  lVar28 = __aFlshl(uVar24,in_stack_0000ffc2);
  uVar8 = *(uint *)((int)&pPVar18[1].wFlags + (int)lVar28);
  for (iSrc = 0; iSrc < cProdGlob; iSrc = iSrc + 1) {
    uVar27 = __aFulshr(uVar24,in_stack_0000ffc2);
    lpplprodT._2_2_ = (uint)uVar27 & 7;
    uVar27 = __aFulshr(uVar24,in_stack_0000ffc2);
    if (lpplprodT._2_2_ == ((uint)uVar27 & 7)) {
      uVar27 = __aFulshr(uVar24,in_stack_0000ffc2);
      lpplprodT._2_2_ = (uint)uVar27 & 0x7f;
      uVar27 = __aFulshr(uVar24,in_stack_0000ffc2);
      if (lpplprodT._2_2_ == ((uint)uVar27 & 0x7f)) break;
    }
  }
  uVar16 = (ushort)uVar24;
  uVar24 = (pProdGlob + iSrc)->dwFlags;
  uVar36 = 0x11;
  uVar11 = GetAsyncKeyState(0x11);
  if ((uVar11 & 0xfffe) == 0) {
    uVar22 = 0x10;
    uVar11 = GetAsyncKeyState(0x10);
    if ((uVar11 & 0xfffe) == 0) {
      c = 1;
    }
    else {
      c = 10;
    }
  }
  else {
    uVar22 = 0x10;
    uVar11 = GetAsyncKeyState(0x10);
    if ((uVar11 & 0xfffe) == 0) {
      c = 100;
    }
    else {
      c = 0x3fc;
    }
  }
  uVar27 = __aFulshr(CONCAT22(uVar36,uVar22),uVar16);
  if ((((uint)uVar27 & 7) == 1) &&
     (uVar27 = __aFulshr(CONCAT22(uVar36,uVar22),uVar16), ((uint)uVar27 & 0x7f) == 3)) {
    c = 0x3fc;
  }
  if ((uVar8 & 0x3ff) <= (uint)c) {
    c = uVar8 & 0x3ff;
  }
  if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
    uVar27 = (pProdGlob + iSrc)->dwFlags;
    pPVar17 = pProdGlob + iSrc;
    pPVar1 = pPVar17;
    *&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
    puVar2 = (undefined2 *)((int)&pPVar17->dwFlags + 2);
    *puVar2 = *puVar2;
    pPVar17 = pProdGlob + iSrc;
    pPVar1 = pPVar17;
    *&pPVar1->dwFlags = (uint)pPVar1->dwFlags | c + (int)uVar27 & 0x3ffU;
    puVar2 = (undefined2 *)((int)&pPVar17->dwFlags + 2);
    *puVar2 = *puVar2;
  }
  pPVar18 = (PLPROD *)lpplProdGlob;
  uVar34 = lpplProdGlob._2_2_;
  lVar28 = __aFlshl(CONCAT22(uVar36,uVar22),uVar16);
  lpplprodT._2_2_ = *(int *)((int)&pPVar18[1].wFlags + (int)lVar28) - c & 0x3ff;
  pPVar18 = (PLPROD *)lpplProdGlob;
  uVar34 = lpplProdGlob._2_2_;
  lVar28 = __aFlshl(CONCAT22(uVar36,uVar22),uVar16);
  puVar19 = (uint *)((int)&pPVar18[1].wFlags + (int)lVar28);
  puVar3 = puVar19;
  *puVar3 = *puVar3 & 0xfc00;
  puVar3 = puVar19 + 1;
  *puVar3 = *puVar3;
  uVar34 = lpplProdGlob._2_2_;
  pPVar18 = (PLPROD *)lpplProdGlob + 1;
  lVar28 = __aFlshl(CONCAT22(uVar36,uVar22),uVar16);
  puVar19 = (uint *)((int)&pPVar18->wFlags + (int)lVar28);
  puVar3 = puVar19;
  *puVar3 = *puVar3 | lpplprodT._2_2_;
  puVar3 = puVar19 + 1;
  *puVar3 = *puVar3;
  pPVar18 = (PLPROD *)lpplProdGlob;
  uVar34 = lpplProdGlob._2_2_;
  lVar28 = __aFlshl(CONCAT22(uVar36,uVar22),uVar16);
  if ((*(uint *)((int)&pPVar18[1].wFlags + (int)lVar28) & 0x3ff) == 0) {
    iVar15 = lSel._2_2_ + (uint)(0xfffe < (uint)lSel);
    if ((iVar15 < 1) && ((iVar15 < 0 || (uVar9 < uVar10)))) {
      uVar16 = ((uVar10 - (uint)lSel) + -1) * 4;
      pPVar18 = (PLPROD *)lpplProdGlob;
      uVar34 = lpplProdGlob._2_2_;
      lVar28 = __aFlshl(CONCAT22(uVar22,uVar16),uVar36);
      pvVar30 = (void *)((int)&pPVar18[1].wFlags + (int)lVar28);
      pPVar18 = (PLPROD *)lpplProdGlob;
      uVar22 = lpplProdGlob._2_2_;
      lVar28 = __aFlshl((long)CONCAT22(uVar34,pvVar30),uVar16);
      __fmemmove((void *)CONCAT22(uVar22,(void *)((int)&pPVar18[1].wFlags + (int)lVar28)),
                         (void *)CONCAT22(uVar34,pvVar30),uVar16);
    }
    else {
      bVar23 = (uint)lSel == 0;
      lSel._0_2_ = uVar9 - 2;
      lSel._2_2_ = lSel._2_2_ - (uint)bVar23;
    }
    pbVar4 = &((PLPROD *)lpplProdGlob)->iprodMac;
    *pbVar4 = *pbVar4 - 1;
  }
  uVar32 = 0;
  pPVar31 = (PLANET *)0x0;
  pPVar18 = (PLPROD *)lpplProdGlob;
  uVar34 = lpplProdGlob._2_2_;
  HVar12 = GetDlgItem(hwnd,0x417);
  uVar22 = 0x1048;
  FillPlanetProdLB
            (HVar12,(PLPROD *)CONCAT22(uVar34,pPVar18),(PLANET *)CONCAT22(uVar32,pPVar31));
  if (-1 < lSel._2_2_) {
    HVar12 = GetDlgItem(hwnd,0x417);
    uVar22 = 0x14f8;
    SendMessage(HVar12,0x407,(uint)lSel + 1,0);
  }
  if ((uVar24 & 0x3ff) == 0) {
    sVar33 = -1;
    HVar12 = GetDlgItem(hwnd,0x416);
    uVar22 = 0x10d0;
    FillProdSrcLB(HVar12,sVar33);
  }
  psVar21 = &stack0xffba;
PRODUCE_RedrawText:
  psVar21[-1] = hwnd;
  psVar21[-2] = unaff_SS;
  psVar21[-3] = (short)&rc;
  psVar21[-4] = uVar22;
  psVar21[-5] = 0x2e21;
  GetClientRect(psVar21[-1],*(RECT **)(psVar21 + -3));
  rc.top = yTopFutureTech;
  rc.bottom = dyArial8 * 7 + yTopFutureTech;
  rc.left = rc.left + 0x82;
  psVar21[-1] = hwnd;
  psVar21[-2] = unaff_SS;
  psVar21[-3] = (short)&rc;
  psVar21[-4] = 1;
  psVar21[-5] = 0x14f8;
  psVar21[-6] = 0x2e4c;
  InvalidateRect(psVar21[-1],*(RECT **)(psVar21 + -3),psVar21[-4]);
  *psVar21 = 0xffff;
  psVar21[-1] = (short)&rc;
  psVar21[-2] = 0;
  psVar21[-3] = hwnd;
  psVar21[-4] = 0x14f8;
  psVar21[-5] = 0x2e60;
  DrawProductionDlg(psVar21[-3],psVar21[-2],(RECT *)psVar21[-1],*psVar21);
  return;
}



// ======================================================================
// Function: InitializeProductionDlg
// Address: 10d0:3430
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d0353f) */
/* WARNING: Removing unreachable block (ram,0x10d0351f) */
/* WARNING: Removing unreachable block (ram,0x10d03544) */

void InitializeProductionDlg(HWND hwnd)

{
  char *pcVar1;
  char *pcVar2;
  HWND HVar3;
  HWND HVar4;
  PLPROD *pPVar5;
  undefined2 unaff_SS;
  ulong uVar6;
  PLANET *pPVar7;
  UINT UVar8;
  short mdFill;
  undefined2 uVar9;
  undefined2 uVar10;
  PROD *lpprod;
  short iSel;
  short i;
  char rgch [86];
  
  iSel = -1;
  pcVar1 = PszGetPlanetName(sel.pl.id);
  uVar10 = 0x1120;
  pcVar2 = PszGetCompressedString(idsProductionQueueS);
  _wsprintf(rgch,pcVar2,pcVar1,uVar10);
  pcVar1 = rgch;
  HVar4 = hwnd;
  SetWindowText(hwnd,pcVar1);
  mdFill = -1;
  HVar3 = GetDlgItem(hwnd,0x416);
  FillProdSrcLB(HVar3,mdFill);
  HVar3 = GetDlgItem(hwnd,0x416);
  SendMessage(HVar3,0x407,0,0);
  i = 0;
  while( true ) {
    uVar10 = (undefined2)((ulong)lpplProdGlob >> 0x10);
    pPVar5 = (PLPROD *)lpplProdGlob;
    if ((int)(uint)pPVar5->iprodMac <= i) break;
    uVar6 = __aFulshr(pcVar1,HVar4);
    if ((((uint)uVar6 & 7) != 1) ||
       (uVar6 = __aFulshr(pcVar1,HVar4), 6 < ((uint)uVar6 & 0x7f))) {
      iSel = i;
    }
    i = i + 1;
  }
  uVar9 = 0;
  pPVar7 = (PLANET *)0x0;
  HVar4 = GetDlgItem(hwnd,0x417);
  FillPlanetProdLB(HVar4,(PLPROD *)CONCAT22(uVar10,pPVar5),(PLANET *)CONCAT22(uVar9,pPVar7))
  ;
  HVar4 = GetDlgItem(hwnd,0x417);
  SendMessage(HVar4,0x407,iSel + 1,0);
  HVar4 = GetDlgItem(hwnd,0x8b);
  UVar8 = 0x401;
  uVar6 = __aFulshr(CONCAT22(HVar4,0x401),(ushort)pcVar1);
  SendMessage(HVar4,UVar8,(uint)uVar6 & 1,0);
  return;
}



// ======================================================================
// Function: DrawProductionDlg
// Address: 10d0:35dc
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d036d8) */
/* WARNING: Removing unreachable block (ram,0x10d0372f) */
/* WARNING: Variable defined which should be unmapped: szT */

void DrawProductionDlg(HWND hwnd,HDC hdc,RECT *prc,short iDraw)

{
  ulong uVar1;
  bool bVar2;
  char *pcVar3;
  short sVar4;
  HWND HVar5;
  short sVar6;
  int iVar7;
  uint uVar8;
  ushort uVar9;
  uint *puVar10;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  bool bVar11;
  DWORD DVar12;
  ulong uVar13;
  long lVar14;
  undefined2 uVar15;
  short sVar16;
  HDC HVar17;
  ulong uVar18;
  char szT [100];
  PROD prod;
  RECT rc;
  short k;
  short dxkT;
  long rgCost [4];
  short c;
  short i;
  short fCreatedDC;
  short idc;
  short iSrc;
  long lSel;
  
  uVar18 = CONCAT22(unaff_SI,unaff_DI);
  bVar11 = hdc == 0;
  if (bVar11) {
    hdc = GetDC(hwnd);
  }
  SelectObject(hdc,rghfontArial8[0]);
  HVar17 = hdc;
  pcVar3 = PszGetCompressedString(idsKt);
  DVar12 = GetTextExtent(HVar17,pcVar3,2);
  SelectObject(hdc,rghfontArial8[1]);
  SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  i = 0;
  do {
    if (1 < i) {
      GetClientRect(hwnd,&rc);
      rc.top = rc.bottom - ((dyArial8 * 5) / 2 + 0xc);
      rc.bottom = (dyArial8 | 1U) + rc.top;
      rc.left = 6;
      rc.right = dyArial8 + 6;
      DrawDiamond(hdc,&rc,hbrBBlue);
      rcProdDiamond.left = rc.left;
      rcProdDiamond.top = rc.top;
      rcProdDiamond.right = rc.right;
      rcProdDiamond.bottom = rc.bottom;
      SelectObject(hdc,rghfontArial8[1]);
      sVar4 = CchGetString(idsApplyDefineProductionTemplate,(char *)szWork);
      TextOut(hdc,rc.right + 4,rc.top,szWork,sVar4);
      if (bVar11) {
        ReleaseDC(hwnd,hdc);
      }
      return;
    }
    if (i == 0) {
      sVar4 = 0x416;
    }
    else {
      sVar4 = 0x417;
    }
    HVar5 = GetDlgItem(hwnd,sVar4);
    GetWindowRect(HVar5,&rc);
    ScreenToClient(hwnd,(POINT *)&rc);
    ScreenToClient(hwnd,(POINT *)&rc.right);
    HVar5 = GetDlgItem(hwnd,sVar4);
    uVar13 = SendMessage(HVar5,0x409,0,0);
    if ((-1 < (long)uVar13) && ((uVar13 != 0 || (i != 1)))) {
      if (i == 0) {
        iSrc = 0;
        while( true ) {
          lSel._2_2_ = (int)(uVar13 >> 0x10);
          lSel._0_2_ = (int)uVar13;
          uVar1 = uVar13;
          if (cProdGlob <= iSrc) break;
          if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0) {
            iVar7 = lSel._2_2_ - (uint)((int)lSel == 0);
            uVar1 = CONCAT22(iVar7,(int)lSel + -1);
            bVar2 = uVar13 == 0;
            uVar13 = CONCAT22(iVar7,(int)lSel + -1);
            if (bVar2) break;
          }
          iSrc = iSrc + 1;
        }
        prod.dwFlags._2_2_ = *(uint *)((int)&pProdGlob[iSrc].dwFlags + 2);
        prod.dwFlags._0_2_ = (uint)(pProdGlob + iSrc)->dwFlags & 0xfc00 | 1;
      }
      else {
        szT._96_2_ = (PLPROD *)lpplProdGlob + 1;
        szT[0x62] = lpplProdGlob._2_1_;
        szT[99] = lpplProdGlob._3_1_;
        lVar14 = __aFlshl(uVar18,szT._0_2_);
        uVar1 = (ulong)((int)uVar13 - 1);
        puVar10 = (uint *)(szT._96_2_ + (int)lVar14);
        prod.dwFlags._0_2_ = *puVar10;
        prod.dwFlags._2_2_ = puVar10[1];
      }
      GetProductionCosts(&sel.pl,&prod,rgCost,idPlayer,0);
      rc.bottom = yTopFutureTech + 4;
      SelectObject(hdc,rghfontArial8[1]);
      sVar4 = CchGetString(idsRequiredMinerals,(char *)szWork);
      TextOut(hdc,rc.left,rc.bottom,szWork,sVar4);
      rc.left = rc.left + 0x14;
      rc.right = rc.right + -0x14;
      for (k = 0; k < 4; k = k + 1) {
        iVar7 = k;
        if (k == 3) {
          iVar7 = 5;
        }
        rc.bottom = rc.bottom + dyArial8;
        SelectObject(hdc,rghfontArial8[1]);
        SetTextColor(hdc,CONCAT22(*(undefined2 *)(iVar7 * 4 + rgcrMinerals_0x2),
                                  *(undefined2 *)(iVar7 * 4 + rgcrMinerals)));
        pcVar3 = (char *)*(undefined2 *)(iVar7 * 2 + rgszMinerals);
        uVar15 = 0x1120;
        sVar4 = rc.bottom;
        sVar16 = rc.left;
        HVar17 = hdc;
        sVar6 = lstrlen((char *)*(undefined2 *)(iVar7 * 2 + rgszMinerals));
        TextOut(HVar17,sVar16,sVar4,(LPCSTR)CONCAT22(uVar15,pcVar3),sVar6);
        SelectObject(hdc,rghfontArial8[0]);
        SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
        sVar4 = _wsprintf(szWork,PCTLD,(int)rgCost[k],
                          *(undefined2 *)((int)rgCost + k * 4 + 2));
        RightTextOut
                  (hdc,(rc.right - (int)DVar12) + -2,rc.bottom,(char *)szWork,sVar4,
                   dxMaxMineralQuan);
        if (k < 3) {
          iVar7 = rc.right - (int)DVar12;
          sVar4 = rc.bottom;
          HVar17 = hdc;
          pcVar3 = PszGetCompressedString(idsKt);
          TextOut(HVar17,iVar7,sVar4,pcVar3,2);
        }
      }
      if (i != 0) {
        rc.bottom = rc.bottom + (dyArial8 * 3) / 2;
        SelectObject(hdc,rghfontArial8[1]);
        uVar13 = __aFulshr(uVar18,szT._0_2_);
        uVar8 = (uint)uVar13 & 0x7f;
        pcVar3 = PszGetCompressedString(idsDDoneCompletion);
        sVar4 = _wsprintf(szT,pcVar3,uVar8);
        lSel._0_2_ = (int)uVar1;
        PszProductionETA
                  (&sel.pl,
                   (PLPROD *)CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob),
                   (int)lSel,(short *)0x0,(short *)0x0);
        _strcpy(szT + sVar4,(char *)szWork);
        iVar7 = rc.left + -0x14;
        pcVar3 = szT;
        uVar15 = unaff_SS;
        sVar4 = rc.bottom;
        HVar17 = hdc;
        uVar9 = _strlen(szT);
        TextOut(HVar17,iVar7,sVar4,(LPCSTR)CONCAT22(uVar15,pcVar3),uVar9);
        SelectObject(hdc,rghfontArial8[0]);
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FillProdSrcLB
// Address: 10d0:3b00
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d03c3a) */
/* WARNING: Removing unreachable block (ram,0x10d03bce) */
/* WARNING: Removing unreachable block (ram,0x10d03b6b) */
/* WARNING: Removing unreachable block (ram,0x10d03b66) */
/* WARNING: Removing unreachable block (ram,0x10d03bfb) */
/* WARNING: Removing unreachable block (ram,0x10d03bf6) */
/* WARNING: Removing unreachable block (ram,0x10d03c3f) */
/* WARNING: Variable defined which should be unmapped: psz */

void FillProdSrcLB(HWND hwndLB,short mdFill)

{
  char *pcVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar2;
  ulong uVar3;
  char *psz;
  short i;
  char szT [80];
  
  uVar3 = CONCAT22(unaff_SI,unaff_DI);
  for (i = 0; i < 6; i = i + 1) {
    szT[i] = ' ';
  }
  SendMessage(hwndLB,0x405,0,0);
  for (i = 0; i < cProdGlob; i = i + 1) {
    if (((pProdGlob + i)->dwFlags & 0x3ff) != 0) {
      pcVar1 = PszNameProdItem(pProdGlob + i);
      _strcpy(szT + 6,pcVar1);
      uVar2 = __aFulshr(uVar3,(ushort)pcVar1);
      if (((uint)uVar2 & 7) == 2) {
        uVar2 = __aFulshr(uVar3,(ushort)pcVar1);
        if (((uint)uVar2 & 0x7f) < 0x10) {
          szT[0] = '*';
        }
        else {
          szT[0] = '#';
        }
      }
      else {
        uVar2 = __aFulshr(uVar3,(ushort)pcVar1);
        if (((uint)uVar2 & 0x7f) < 7) {
          szT[0] = 'I';
          _strcat(szT + 6,(char *)s__Auto_Build__1120_0cda);
        }
        else {
          szT[0] = ' ';
        }
      }
      SendMessage(hwndLB,0x401,0,(LPARAM)szT);
    }
  }
  return;
}



// ======================================================================
// Function: PszNameProdItem
// Address: 10d0:3c92
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d03cde) */
/* WARNING: Removing unreachable block (ram,0x10d03ce7) */
/* WARNING: Removing unreachable block (ram,0x10d03e82) */
/* WARNING: Removing unreachable block (ram,0x10d03ee7) */
/* WARNING: Removing unreachable block (ram,0x10d03e99) */
/* WARNING: Removing unreachable block (ram,0x10d03e87) */
/* WARNING: Removing unreachable block (ram,0x10d03e9e) */
/* WARNING: Removing unreachable block (ram,0x10d03cec) */

char * PszNameProdItem(PROD *lpprod)

{
  int iVar1;
  int iVar2;
  uint uVar3;
  int iVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar5;
  ulong uVar6;
  PLANETARY *pPVar7;
  ushort in_stack_0000fff4;
  short iDelta;
  ulong iItem;
  
  uVar6 = CONCAT22(unaff_SI,unaff_DI);
  uVar5 = __aFulshr(uVar6,in_stack_0000fff4);
  uVar3 = (uint)uVar5 & 0x7f;
  uVar6 = __aFulshr(uVar6,in_stack_0000fff4);
  if (((uint)uVar6 & 7) == 2) {
    if (uVar3 < 0x10) {
      uVar6 = __aFulmul(uVar5 & 0x7f,0x93);
      if ((*(uint *)((int)&rgshdef[0].wFlags + (int)uVar6) >> 9 & 1) == 0) {
        uVar5 = __aFulmul(uVar5 & 0x7f,0x93);
        _strcpy((char *)szWork,
                        (char *)((int)&rgshdef[0].hul + 8 + (int)uVar5));
        goto LAB_10d0_3f19;
      }
    }
    else {
      iVar1 = uVar3 - 0x10;
      iVar2 = -(uint)(uVar3 < 0x10);
      uVar5 = __aFulmul(CONCAT22(iVar2,iVar1),0x93);
      if ((*(uint *)(*(int *)(idPlayer * 4 + rglpshdefSB) + (int)uVar5 + 0x7b) >> 9 & 1) == 0
         ) {
        uVar5 = __aFulmul(CONCAT22(iVar2,iVar1),0x93);
        __fstrcpy(szWork,
                          (char *)CONCAT22(*(undefined2 *)(idPlayer * 4 + rglpshdefSB_0x2),
                                           (char *)(*(int *)(idPlayer * 4 + rglpshdefSB) +
                                                    (int)uVar5 + 8)));
        if ((sel.pl.wFlags_0x4 >> 9 & 1) != 0) {
          iVar4 = *(int *)(*(int *)(idPlayer * 4 + rglpshdefSB) +
                          ((uint)sel.pl.lStarbase & 0xf) * 0x93);
          uVar5 = __aFulmul(CONCAT22(iVar2,iVar1),0x93);
          iVar4 = iVar4 - *(int *)(*(int *)(idPlayer * 4 + rglpshdefSB) + (int)uVar5);
          if (iVar4 < 1) {
            if (iVar4 < 0) {
              _strcat((char *)szWork,(char *)s__upgrade__1120_0cf5);
            }
          }
          else {
            _strcat((char *)szWork,(char *)s__downgrade__1120_0ce8);
          }
        }
        goto LAB_10d0_3f19;
      }
    }
    szWork[0] = '\0';
  }
  else if ((uVar3 < 0x12) || (0x1a < uVar3)) {
    if (uVar3 == 0x1b) {
      CchGetString(idsPlanetaryScanner,(char *)szWork);
    }
    else {
      CchGetString(uVar3 + idsMines,(char *)szWork);
    }
  }
  else {
    pPVar7 = LpplanetaryFromId(uVar3 - 0x12);
    __fstrcpy(szWork,
                      (char *)CONCAT22((int)((ulong)pPVar7 >> 0x10),((PLANETARY *)pPVar7)->szName));
  }
LAB_10d0_3f19:
  return (char *)szWork;
}



// ======================================================================
// Function: GetProductionCosts
// Address: 10d0:3f20
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d03faf) */
/* WARNING: Removing unreachable block (ram,0x10d03fa6) */
/* WARNING: Removing unreachable block (ram,0x10d03fb4) */

void GetProductionCosts(PLANET *lppl,PROD *lpprod,ulong *rgCost,short iplr,short fOnlyOne)

{
  byte bVar1;
  ulong uVar2;
  short sVar3;
  int iVar4;
  ushort uVar5;
  short sVar6;
  HUL *pHVar7;
  HUL *pHVar8;
  PLANET *pPVar9;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar10;
  bool bVar11;
  bool bVar12;
  ulong uVar13;
  ulong uVar14;
  ushort *rgCost_00;
  undefined2 uVar15;
  ushort in_stack_0000ffac;
  short rgCostsPartNew [4];
  short rgCostsPartCur [4];
  HUL *lphulCur;
  HUL *lphulNew;
  short chs;
  short cost;
  PART part;
  short fStarbase;
  ulong cItem;
  short raMajor;
  SHDEF *lpshdef;
  short j;
  short i;
  ushort rgCosts [4];
  ulong iItem;
  ushort rgCostsCur [4];
  
  uVar14 = CONCAT22(unaff_SI,unaff_DI);
  uVar10 = (undefined2)((ulong)lppl >> 0x10);
  pPVar9 = (PLANET *)lppl;
  sVar3 = GetRaceStat((PLAYER *)rgplr + pPVar9->iPlayer,rsMajorAdv);
  uVar13 = __aFulshr(uVar14,in_stack_0000ffac);
  iItem._0_2_ = (uint)uVar13 & 0x7f;
  iItem._2_2_ = 0;
  uVar2 = lpprod->dwFlags;
  uVar14 = __aFulshr(uVar14,in_stack_0000ffac);
  if (((uint)uVar14 & 7) == 2) {
    bVar11 = 0xf < (uint)iItem;
    if (bVar11) {
      lpshdef._0_2_ = (SHDEF *)*(undefined2 *)(iplr * 4 + rglpshdefSB);
      lpshdef._2_2_ = *(undefined2 *)(iplr * 4 + rglpshdefSB_0x2);
      bVar12 = (uint)iItem < 0x10;
      iItem._0_2_ = (uint)iItem - 0x10;
      iItem._2_2_ = -(uint)bVar12;
    }
    else {
      lpshdef._0_2_ = (SHDEF *)*(undefined2 *)(iplr * 4 + rglpshdef);
      lpshdef._2_2_ = *(undefined2 *)(iplr * 4 + rglpshdef_0x2);
    }
    uVar13 = __aFulmul(CONCAT22(iItem._2_2_,(uint)iItem),0x93);
    if ((*(uint *)((int)(&((SHDEF *)lpshdef)->hul + 1) + (int)uVar13) >> 9 & 1) != 0) {
      for (i = 0; i < 4; i = i + 1) {
        *(undefined2 *)(rgCost + i) = 0;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
      }
      return;
    }
    rgCost_00 = rgCosts;
    uVar13 = __aFulmul(CONCAT22(iItem._2_2_,(uint)iItem),0x93);
    GetTrueHullCost
              (iplr,(HUL *)CONCAT22(lpshdef._2_2_,
                                    (((SHDEF *)lpshdef)->hul).rgTech + (int)uVar13 + -2),rgCost_00);
    if ((bVar11) && ((pPVar9->wFlags_0x4 >> 9 & 1) != 0)) {
      uVar15 = *(undefined2 *)(iplr * 4 + rglpshdefSB_0x2);
      pHVar7 = (HUL *)(*(int *)(iplr * 4 + rglpshdefSB) + (*(uint *)&pPVar9->lStarbase & 0xf) * 0x93
                      );
      lphulCur = (HUL *)CONCAT22(uVar15,pHVar7);
      uVar13 = __aFulmul(CONCAT22(iItem._2_2_,(uint)iItem),0x93);
      pHVar8 = (((SHDEF *)lpshdef)->hul).rgTech + (int)uVar13 + -2;
      lphulNew = (HUL *)CONCAT22(lpshdef._2_2_,pHVar8);
      GetTrueHullCost(iplr,(HUL *)CONCAT22(uVar15,pHVar7),rgCostsCur);
      if (lphulCur->ihuldef == lphulNew->ihuldef) {
        part.u_PART_0x0004.parmor = LphuldefFromId(lphulCur->ihuldef);
        part.hs.grhst =
             ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines
               |hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine);
        GetTruePartCost(iplr,&part,rgCostsPartCur);
        for (i = 0; i < 4; i = i + 1) {
          rgCosts[i] = rgCosts[i] - rgCostsPartCur[i];
        }
        bVar1 = pHVar7->chs;
        for (i = 0; i < (int)(uint)bVar1; i = i + 1) {
          if ((pHVar7->rghs[i].wFlags_0x2 >> 8 != 0) && (pHVar8->rghs[i].wFlags_0x2 >> 8 != 0)) {
            part.hs.grhst = (pHVar7->rghs + i)->grhst;
            part.hs.wFlags_0x2 = pHVar7->rghs[i].wFlags_0x2;
            FLookupPart(&part);
            GetTruePartCost(iplr,&part,rgCostsPartCur);
            part.hs.grhst = (pHVar8->rghs + i)->grhst;
            part.hs.wFlags_0x2 = pHVar8->rghs[i].wFlags_0x2;
            FLookupPart(&part);
            GetTruePartCost(iplr,&part,rgCostsPartNew);
            if ((pHVar7->rghs + i)->grhst == (pHVar8->rghs + i)->grhst) {
              if ((pHVar7->rghs[i].wFlags_0x2 & 0xff) == (pHVar8->rghs[i].wFlags_0x2 & 0xff)) {
                for (j = 0; j < 4; j = j + 1) {
                  rgCostsPartCur[j] = rgCostsPartCur[j] * (pHVar7->rghs[i].wFlags_0x2 >> 8);
                  rgCostsPartNew[j] = rgCostsPartNew[j] * (pHVar8->rghs[i].wFlags_0x2 >> 8);
                  if ((uint)(rgCostsPartNew[j] - rgCostsPartCur[j]) < 0x8000) {
                    iVar4 = rgCostsPartNew[j] - rgCostsPartCur[j];
                  }
                  else {
                    iVar4 = 0;
                  }
                  if (rgCosts[j] < (uint)(rgCostsPartNew[j] - iVar4)) {
                    uVar5 = rgCosts[j];
                  }
                  else {
                    uVar5 = rgCostsPartNew[j] - iVar4;
                  }
                  rgCosts[j] = rgCosts[j] - uVar5;
                }
              }
              else {
                for (j = 0; j < 4; j = j + 1) {
                  rgCostsPartCur[j] = rgCostsPartCur[j] * (pHVar7->rghs[i].wFlags_0x2 >> 8);
                  rgCostsPartNew[j] = rgCostsPartNew[j] * (pHVar8->rghs[i].wFlags_0x2 >> 8);
                  if (rgCostsPartNew[j] - (rgCostsPartCur[j] << 3) / 10 <
                      (rgCostsPartNew[j] << 1) / 10) {
                    iVar4 = (rgCostsPartNew[j] << 1) / 10;
                  }
                  else {
                    iVar4 = rgCostsPartNew[j] - (rgCostsPartCur[j] << 3) / 10;
                  }
                  if (rgCosts[j] < (uint)(rgCostsPartNew[j] - iVar4)) {
                    uVar5 = rgCosts[j];
                  }
                  else {
                    uVar5 = rgCostsPartNew[j] - iVar4;
                  }
                  rgCosts[j] = rgCosts[j] - uVar5;
                }
              }
            }
            else {
              for (j = 0; j < 4; j = j + 1) {
                rgCostsPartCur[j] = rgCostsPartCur[j] * (pHVar7->rghs[i].wFlags_0x2 >> 8);
                rgCostsPartNew[j] = rgCostsPartNew[j] * (pHVar8->rghs[i].wFlags_0x2 >> 8);
                if (rgCostsPartNew[j] - (rgCostsPartCur[j] * 7) / 10 < (rgCostsPartNew[j] * 3) / 10)
                {
                  iVar4 = (rgCostsPartNew[j] * 3) / 10;
                }
                else {
                  iVar4 = rgCostsPartNew[j] - (rgCostsPartCur[j] * 7) / 10;
                }
                if (rgCosts[j] < (uint)(rgCostsPartNew[j] - iVar4)) {
                  uVar5 = rgCosts[j];
                }
                else {
                  uVar5 = rgCostsPartNew[j] - iVar4;
                }
                rgCosts[j] = rgCosts[j] - uVar5;
              }
            }
          }
        }
      }
      else {
        for (i = 0; i < 4; i = i + 1) {
          uVar5 = rgCosts[i] - (int)rgCostsCur[i] / 2;
          if ((int)uVar5 < (int)(rgCosts[i] / 2)) {
            rgCosts[i] = rgCosts[i] / 2;
          }
          else {
            rgCosts[i] = uVar5;
          }
        }
      }
    }
    if ((bVar11) &&
       ((sVar3 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceISB), sVar3 != 0 ||
        (sVar3 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv),
        sVar3 == raMacintosh)))) {
      for (i = 0; i < 4; i = i + 1) {
        rgCosts[i] = rgCosts[i] - rgCosts[i] / 5;
      }
    }
    if (bVar11) {
      for (i = 0; i < 4; i = i + 1) {
        *(uint *)(rgCost + i) = (rgCosts[i] + 1) / 2;
        *(uint *)((int)(rgCost + i) + 2) = 0;
      }
    }
    else {
      for (i = 0; i < 4; i = i + 1) {
        *(ushort *)(rgCost + i) = rgCosts[i];
        *(ushort *)((int)(rgCost + i) + 2) = 0;
      }
    }
    goto LAB_10d0_4eef;
  }
  if ((uVar13 & 0x7f) == 0) {
LAB_10d0_4915:
    for (i = 0; i < 3; i = i + 1) {
      *(undefined2 *)(rgCost + i) = 0;
      *(undefined2 *)((int)(rgCost + i) + 2) = 0;
    }
    sVar3 = GetRaceStat((PLAYER *)rgplr + iplr,rsMineBuild);
    *(short *)(rgCost + 3) = sVar3;
    *(int *)((int)rgCost + 0xe) = sVar3 >> 0xf;
    goto LAB_10d0_4eef;
  }
  if ((uint)iItem == 1) {
LAB_10d0_4867:
    sVar3 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceCheapFact);
    if (((uint)gd.grBits >> 0xb & 1) == 0) {
      *(undefined2 *)(rgCost + 1) = 0;
      *(undefined2 *)((int)rgCost + 6) = 0;
      *(undefined2 *)rgCost = 0;
      *(undefined2 *)((int)rgCost + 2) = 0;
      *(int *)(rgCost + 2) = 4 - sVar3;
      *(int *)((int)rgCost + 10) = 4 - sVar3 >> 0xf;
    }
    else {
      for (i = 0; i < 3; i = i + 1) {
        *(int *)(rgCost + i) = 2 - sVar3;
        *(int *)((int)(rgCost + i) + 2) = 2 - sVar3 >> 0xf;
      }
    }
    sVar3 = GetRaceStat((PLAYER *)rgplr + iplr,rsFactBuild);
    *(short *)(rgCost + 3) = sVar3;
    *(int *)((int)rgCost + 0xe) = sVar3 >> 0xf;
  }
  else {
    if ((uint)iItem == 2) {
LAB_10d0_4964:
      part.hs.grhst = hstPlanetary;
      part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | 9;
      FLookupPart(&part);
      i = 0;
      while( true ) {
        if (2 < i) break;
        iVar4 = (part.u_PART_0x0004.parmor._0_2_)->rgwtOreCost[i];
        *(int *)(rgCost + i) = iVar4;
        *(int *)((int)(rgCost + i) + 2) = iVar4 >> 0xf;
        i = i + 1;
      }
      *(ushort *)(rgCost + 3) = (part.u_PART_0x0004.parmor._0_2_)->resCost;
      *(undefined2 *)((int)rgCost + 0xe) = 0;
      sVar3 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
      if (sVar3 == raDefend) {
        for (i = 0; i < 4; i = i + 1) {
          uVar15 = 0;
          uVar10 = 5;
          uVar13 = __aFulmul(CONCAT22(*(undefined2 *)((int)(rgCost + i) + 2),(int)rgCost[i])
                                     ,3);
          uVar13 = __aFuldiv(uVar13,CONCAT22(uVar15,uVar10));
          *(int *)(rgCost + i) = (int)uVar13;
          *(undefined2 *)((int)(rgCost + i) + 2) = (int)(uVar13 >> 0x10);
        }
      }
      goto LAB_10d0_4eef;
    }
    if ((uint)iItem == 3) {
LAB_10d0_4a48:
      for (i = 0; i < 3; i = i + 1) {
        *(undefined2 *)(rgCost + i) = 0;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
      }
      sVar3 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceMineralAlchemy);
      if (sVar3 == 0) {
        uVar10 = 100;
      }
      else {
        uVar10 = 0x19;
      }
      *(undefined2 *)(rgCost + 3) = uVar10;
      *(undefined2 *)((int)rgCost + 0xe) = 0;
      goto LAB_10d0_4eef;
    }
    if (((uint)iItem == 4) || ((uint)iItem == 5)) {
LAB_10d0_4c24:
      *(undefined2 *)(rgCost + 2) = 0;
      *(undefined2 *)((int)rgCost + 10) = 0;
      *(undefined2 *)(rgCost + 1) = 0;
      *(undefined2 *)((int)rgCost + 6) = 0;
      *(undefined2 *)rgCost = 0;
      *(undefined2 *)((int)rgCost + 2) = 0;
      sVar6 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceTT);
      if (sVar6 == 0) {
        *(undefined2 *)(rgCost + 3) = 100;
        *(undefined2 *)((int)rgCost + 0xe) = 0;
      }
      else {
        *(undefined2 *)(rgCost + 3) = 0x46;
        *(undefined2 *)((int)rgCost + 0xe) = 0;
      }
      if (sVar3 == 3) {
        uVar13 = __aFuldiv(CONCAT22(*(undefined2 *)((int)rgCost + 0xe),(int)rgCost[3]),2);
        *(int *)(rgCost + 3) = (int)uVar13;
        *(undefined2 *)((int)rgCost + 0xe) = (int)(uVar13 >> 0x10);
      }
      goto LAB_10d0_4eef;
    }
    if ((uint)iItem != 6) {
      if ((uint)iItem == 7) goto LAB_10d0_4867;
      if ((uint)iItem == 8) goto LAB_10d0_4915;
      if ((uint)iItem == 9) goto LAB_10d0_4964;
      if ((uint)iItem == 0xb) goto LAB_10d0_4a48;
      if ((uint)iItem == 0xc) goto LAB_10d0_4c24;
      if ((uint)iItem == 0xd) {
        part.hs.grhst = hstPlanetary;
        part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | 0xe;
        FLookupPart(&part);
        GetTruePartCost(iplr,&part,rgCosts);
        for (i = 0; i < 4; i = i + 1) {
          *(ushort *)(rgCost + i) = rgCosts[i];
          *(ushort *)((int)(rgCost + i) + 2) = 0;
        }
        goto LAB_10d0_4eef;
      }
      if ((((uint)iItem == 0xe) || ((uint)iItem == 0xf)) || ((uint)iItem == 0x10)) {
        if (sVar3 == 6) {
          uVar10 = 0x46;
        }
        else if (sVar3 == 7) {
          uVar10 = 0x78;
        }
        else {
          uVar10 = 0x6e;
        }
        for (i = 0; i < 3; i = i + 1) {
          if (((uint)iItem - 0xe != i) || (uVar15 = uVar10, (uint)iItem < 0xe)) {
            uVar15 = 0;
          }
          *(undefined2 *)(rgCost + i) = uVar15;
          *(undefined2 *)((int)(rgCost + i) + 2) = 0;
        }
        if (sVar3 == 6) {
          uVar10 = 5;
        }
        else {
          uVar10 = 10;
        }
        *(undefined2 *)(rgCost + i) = uVar10;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
        goto LAB_10d0_4eef;
      }
      if ((uint)iItem != 0x11) {
        if (((((uint)iItem != 0x12) && ((uint)iItem != 0x13)) &&
            (((uint)iItem != 0x14 &&
             (((((uint)iItem != 0x15 && ((uint)iItem != 0x16)) && ((uint)iItem != 0x17)) &&
              (((uint)iItem != 0x18 && ((uint)iItem != 0x19)))))))) && ((uint)iItem != 0x1a)) {
          if ((uint)iItem != 0x1b) goto LAB_10d0_4eef;
          iItem._0_2_ = 0x12;
        }
        part.hs.grhst = hstPlanetary;
        part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | (uint)iItem - 0x12 & 0xff;
        FLookupPart(&part);
        GetTruePartCost(iplr,&part,rgCosts);
        for (i = 0; i < 4; i = i + 1) {
          *(ushort *)(rgCost + i) = rgCosts[i];
          *(ushort *)((int)(rgCost + i) + 2) = 0;
        }
        goto LAB_10d0_4eef;
      }
    }
    if (sVar3 == 6) {
      uVar10 = 0x19;
    }
    else if (sVar3 == 7) {
      uVar10 = 0x30;
    }
    else {
      uVar10 = 0x2c;
    }
    for (i = 0; i < 3; i = i + 1) {
      *(undefined2 *)(rgCost + i) = uVar10;
      *(undefined2 *)((int)(rgCost + i) + 2) = 0;
    }
    if (sVar3 == 6) {
      uVar10 = 5;
    }
    else {
      uVar10 = 10;
    }
    *(undefined2 *)(rgCost + i) = uVar10;
    *(undefined2 *)((int)(rgCost + i) + 2) = 0;
  }
LAB_10d0_4eef:
  if (fOnlyOne == 0) {
    for (i = 0; i < 4; i = i + 1) {
      uVar13 = __aFulmul(CONCAT22(*(undefined2 *)((int)(rgCost + i) + 2),(int)rgCost[i]),
                                 (ulong)((uint)uVar2 & 0x3ff));
      *(int *)(rgCost + i) = (int)uVar13;
      *(undefined2 *)((int)(rgCost + i) + 2) = (int)(uVar13 >> 0x10);
    }
  }
  return;
}



// ======================================================================
// Function: EstimateItemProdSched
// Address: 10d0:4f40
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d05159) */
/* WARNING: Removing unreachable block (ram,0x10d050ac) */
/* WARNING: Removing unreachable block (ram,0x10d052cc) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10d05184) */
/* WARNING: Removing unreachable block (ram,0x10d051ac) */

void EstimateItemProdSched
               (PLANET *lppl,PLPROD *lpplprod,short iItem,short *piFirst,short *piLast)

{
  PLANET *pPVar1;
  PLANET *pPVar2;
  byte bVar3;
  PROD *pprodPartial;
  short sVar4;
  uint uVar5;
  int iVar6;
  PLPROD *pPVar7;
  undefined2 unaff_SI;
  PLANET *pPVar8;
  undefined2 unaff_DI;
  PLANET *pPVar9;
  undefined2 uVar10;
  undefined2 unaff_SS;
  bool bVar11;
  ulong uVar12;
  long lVar13;
  ulong uVar14;
  long lVar15;
  undefined2 uVar16;
  ulong uVar17;
  uint in_stack_0000ff8a;
  ushort uVar18;
  PROD *lpprod;
  long rgRes [4];
  short iMac;
  short fAlchemy;
  short iPass;
  short j;
  short i;
  short mdStatus;
  PROD prodPartial;
  short cBuilt;
  long rglQuan [3];
  PLANET pl;
  long cResearch;
  
  uVar17 = CONCAT22(unaff_SI,unaff_DI);
  if (((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) {
                    /* WARNING: Load size is inaccurate */
    lpplprod = (PLPROD *)
               CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                        ((PLANET *)lppl)->lpplprod);
  }
  pPVar9 = &pl;
  pPVar8 = (PLANET *)lppl;
  for (iVar6 = 0x1c; iVar6 != 0; iVar6 = iVar6 + -1) {
    pPVar2 = pPVar9;
    pPVar9 = &pPVar9->iPlayer;
    pPVar1 = pPVar8;
    pPVar8 = &pPVar8->iPlayer;
    pPVar2->id = pPVar1->id;
  }
  uVar10 = (undefined2)((ulong)lpplprod >> 0x10);
  pPVar7 = (PLPROD *)lpplprod;
  pl.lpplprod = LpplAlloc(4,(uint)pPVar7->iprodMax,htOrd);
  __fmemcpy((PL *)CONCAT22((int)((ulong)pl.lpplprod >> 0x10),(PL *)pl.lpplprod + 1),
                    (PLPROD *)CONCAT22(uVar10,pPVar7 + 1),(uint)pPVar7->iprodMac << 2);
  bVar3 = pPVar7->iprodMac;
  ((PLPROD *)pl.lpplprod)->iprodMac = bVar3;
  prodPartial.dwFlags._0_2_ = (uint)prodPartial.dwFlags & 0xfc00;
  *piLast = 0;
  *piFirst = 0;
  iPass = 1;
  do {
    if (99 < iPass) {
      if (*piFirst == 0) {
        *piFirst = 100;
      }
      *piLast = 100;
PRODUCE_LCleanUp:
      if (((PLPROD *)pl.lpplprod != (PLPROD *)0x0) || (pl.lpplprod._2_2_ != 0)) {
        FreePl(pl.lpplprod);
      }
      return;
    }
    EstMineralsMined(&pl,rglQuan,-1,1);
    for (j = 0; j < 3; j = j + 1) {
      uVar10 = *(undefined2 *)((int)pl.rgwtMin + j * 4 + 2);
      *(int *)(rgRes + j) = (int)pl.rgwtMin[j];
      *(undefined2 *)((int)rgRes + j * 4 + 2) = uVar10;
    }
    rgRes[3]._0_2_ = CResourcesAtPlanet(&pl,((PLANET *)lppl)->iPlayer);
    rgRes[3]._2_2_ = (int)(uint)rgRes[3] >> 0xf;
    uVar12 = __aFulshr(uVar17,in_stack_0000ff8a);
    if ((uVar12 & 1) == 0) {
      uVar16 = 0;
      uVar10 = 100;
      uVar12 = __aFulmul(CONCAT22(rgRes[3]._2_2_,(uint)rgRes[3]),
                                 (long)(int)*(char *)((int)&rgplr[0].pctResearch +
                                                     ((PLANET *)lppl)->iPlayer * 0xc0));
      lVar13 = __aFldiv(uVar12,CONCAT22(uVar16,uVar10));
      bVar11 = (uint)rgRes[3] < (uint)lVar13;
      rgRes[3]._0_2_ = (uint)rgRes[3] - (uint)lVar13;
      rgRes[3]._2_2_ = (rgRes[3]._2_2_ - (int)((ulong)lVar13 >> 0x10)) - (uint)bVar11;
    }
    else {
      lVar13 = 0;
    }
    uVar12 = (ulong)in_stack_0000ff8a;
    fAlchemy = 0;
    for (i = -1; uVar18 = (ushort)uVar12, i < (int)(uint)bVar3; i = i + 1) {
      if (i == -1) {
        lpprod = &prodPartial;
      }
      else {
        lpprod = (PROD *)CONCAT22(pl.lpplprod._2_2_,(PLPROD *)pl.lpplprod + i + 1);
      }
      if ((lpprod->dwFlags & 0x3ff) != 0) {
        uVar12 = __aFulshr(uVar17,uVar18);
        uVar10 = (undefined2)((ulong)lpprod >> 0x10);
        if (((uint)uVar12 & 0x7f) == 3) {
          uVar14 = __aFulshr(uVar17,uVar18);
          uVar12 = (ulong)uVar18;
          if (((uint)uVar14 & 7) == 1) {
            if (i < (int)(bVar3 - 1)) {
              if (i != iItem) {
                fAlchemy = 1;
                goto LAB_10d0_53bf;
              }
              *piLast = -1;
              *piFirst = -1;
              goto PRODUCE_LCleanUp;
            }
            uVar16 = *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2);
            *&lpprod->dwFlags = (uint)lpprod->dwFlags & 0xfc00 | 0x3fc;
            *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2) = uVar16;
          }
        }
        if (i == -1) {
          pprodPartial = (PROD *)0x0;
        }
        else {
          pprodPartial = &prodPartial;
        }
        sVar4 = CBuildProdItem(&pl,lpprod,pprodPartial,rgRes,fAlchemy,&mdStatus,0);
        if (iItem == i) {
          if ((0 < sVar4) && (*piFirst == 0)) {
            *piFirst = iPass;
          }
          if (mdStatus == 2) {
            if (*piFirst != 0) {
              *piLast = iPass + -1;
            }
            goto PRODUCE_LCleanUp;
          }
          if ((mdStatus == 0) || (mdStatus == 1)) {
            *piLast = iPass;
            goto PRODUCE_LCleanUp;
          }
        }
        fAlchemy = 0;
        uVar14 = __aFulshr(uVar17,uVar18);
        uVar12 = (ulong)uVar18;
        if (((uint)uVar14 & 7) == 1) {
          uVar14 = __aFulshr(uVar17,uVar18);
          uVar12 = (ulong)uVar18;
          uVar5 = (uint)uVar14 & 0x7f;
          if ((uVar14 & 0x7f) == 0) {
LAB_10d0_52ea:
            lVar15 = __aFlshl(uVar17,uVar18);
            uVar12 = lVar15 + CONCAT22(pl.rgbImp._2_2_,pl.rgbImp._0_2_) & 0xfff00;
            uVar5 = pl.rgbImp._0_2_ & 0xff | (uint)uVar12;
            pl.rgbImp[0] = (char)uVar5;
            pl.rgbImp[1] = (char)(uVar5 >> 8);
            uVar5 = pl.rgbImp._2_2_ & 0xfff0 | (uint)(uVar12 >> 0x10);
            pl.rgbImp[2] = (char)uVar5;
            pl.rgbImp[3] = (char)(uVar5 >> 8);
          }
          else if ((uVar5 == 1) || (uVar5 == 7)) {
            lVar15 = __aFlshl(uVar17,uVar18);
            uVar12 = 0;
            uVar5 = pl.rgbImp._2_2_ & 0xf |
                    (int)((ulong)lVar15 >> 0x10) + pl.rgbImp._2_2_ +
                    (uint)CARRY2((uint)lVar15,pl.rgbImp._0_2_) & 0xfff0;
            pl.rgbImp[2] = (char)uVar5;
            pl.rgbImp[3] = (char)(uVar5 >> 8);
          }
          else if (uVar5 == 8) goto LAB_10d0_52ea;
        }
        if (4 < mdStatus) break;
      }
LAB_10d0_53bf:
    }
    in_stack_0000ff8a = (uint)uVar12;
    cResearch._0_2_ = (int)lVar13;
    if (iItem < 0) {
      *piFirst = (uint)rgRes[3];
      if (iItem == -1) {
        *piFirst = *piFirst + (int)cResearch;
      }
      goto PRODUCE_LCleanUp;
    }
    for (j = 0; j < 3; j = j + 1) {
      uVar10 = *(undefined2 *)((int)rgRes + j * 4 + 2);
      *(int *)(pl.rgwtMin + j) = (int)rgRes[j];
      *(undefined2 *)((int)pl.rgwtMin + j * 4 + 2) = uVar10;
    }
    ChgPopFromPlanet(&pl,1);
    iPass = iPass + 1;
  } while( true );
}



// ======================================================================
// Function: ZipProdDlg
// Address: 10d0:5490
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d05b5e) */
/* WARNING: Removing unreachable block (ram,0x10d05b29) */
/* WARNING: Removing unreachable block (ram,0x10d05b63) */
/* WARNING: Variable defined which should be unmapped: pszT */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short ZipProdDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char *pcVar1;
  char cVar2;
  FARPROC pvVar3;
  char *pcVar4;
  HDC HVar5;
  HWND HVar6;
  short sVar7;
  undefined1 *puVar8;
  ulong *puVar9;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar10;
  undefined2 unaff_SS;
  ulong uVar11;
  char *pszT;
  char *psz;
  HWND hwndRad;
  undefined1 local_3c [4];
  char *local_38;
  undefined4 local_36;
  RECT rc;
  short iBase;
  short i;
  PAINTSTRUCT ps;
  HDC hdc;
  
  if (message == WM_PAINT) {
    HVar5 = BeginPaint(hwnd,&ps);
    GetClientRect(hwnd,&rc);
    HVar6 = GetDlgItem(hwnd,0x431);
    GetWindowRect(HVar6,local_3c + 2);
    ScreenToClient(hwnd,local_3c + 2);
    HVar6 = GetDlgItem(hwnd,0x434);
    GetWindowRect(HVar6,&rc);
    ScreenToClient(hwnd,(POINT *)&rc.right);
    local_36._0_2_ = (void *)rc.right;
    local_36._2_2_ = rc.bottom;
    ExpandRc(local_3c + 2,dyArial8,dyArial8 >> 1);
    _Draw3dFrame();
    SelectObject(HVar5,rghfontArial8[1]);
    SetBkColor(HVar5,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    local_3c._0_2_ = CchGetString(idsCustomOrders,(char *)szWork);
    TextOut(HVar5,(short)(local_3c._2_2_ + 8),(int)local_38 - (dyArial8 >> 1),
            szWork,local_3c._0_2_);
    local_38 = (char *)(local_36._2_2_ + 8);
    if (*(char *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) != '\0') {
      local_3c._0_2_ =
           CchGetString
                     (*(byte *)((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 +
                               iResTechNow * 0x28) + idsContributeResearch,
                      (char *)szWork);
      TextOut(HVar5,local_3c._2_2_,vyZPDStatic,szWork,local_3c._0_2_);
    }
    EndPaint(hwnd,&ps);
    return 1;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    for (i = 0x431; i < 0x435; i = i + 1) {
      local_36._2_2_ = (HWND)lParam;
      HVar6 = GetDlgItem(hwnd,i);
      if (local_36._2_2_ == HVar6) break;
    }
    if (0x434 < i) {
      return 0;
    }
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    return hbrButtonFace;
  }
  if (message == WM_INITDIALOG) {
    HVar6 = hwnd;
    pcVar4 = PszGetCompressedString(idsCustomizeProductionTemplates);
    SetWindowText(HVar6,pcVar4);
    GetWindowRect(hwnd,&rc);
    GetClientRect(hwnd,local_3c);
    local_36._2_2_ = (rc.bottom - rc.top) - (int)(void *)local_36;
    HVar6 = GetDlgItem(hwnd,0x417);
    GetWindowRect(HVar6,local_3c);
    MapWindowPoints(0,hwnd,(POINT *)CONCAT13((char)((uint)unaff_SS >> 8),
                                             CONCAT12((char)unaff_SS,local_3c)),2);
    vyZPDStatic = (int)(void *)local_36 + 2;
    local_36._2_2_ = local_36._2_2_ + (int)(void *)local_36 + dyArial8 + 6;
    SetWindowPos(hwnd,0,0,0,rc.right - rc.left,local_36._2_2_,6);
    CheckRadioButton(hwnd,0x431,0x434,0x431);
    EnableZipProdBtns(hwnd,0);
    iResTechNow = 0;
    uVar10 = 0x10d0;
    FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd);
    puVar8 = &stack0xffb4;
    for (i = 0x431; i < 0x435; i = i + 1) {
      if (*(char *)((int)&vrgZipProd[0].fValid + (i + -0x431) * 0x28) == '\0') {
        *(undefined2 *)(puVar8 + -2) = 0x4be;
        *(undefined2 *)(puVar8 + -4) = uVar10;
        *(undefined2 *)(puVar8 + -6) = 0x5614;
        pcVar4 = PszGetCompressedString(*(StringId *)(puVar8 + -2));
        *(short *)(puVar8 + -2) = i + -0x430;
        *(undefined2 *)(puVar8 + -4) = 0x1120;
        *(char **)(puVar8 + -6) = pcVar4;
        *(undefined2 *)(puVar8 + -8) = 0x1120;
        *(char **)(puVar8 + -10) = (char *)szWork;
        *(undefined2 *)(puVar8 + -0xc) = 0x1010;
        uVar10 = 0x14f8;
        *(undefined2 *)(puVar8 + -0xe) = 0x5634;
        _wsprintf(*(char **)(puVar8 + -10),*(char **)(puVar8 + -6));
      }
      else {
        pszT = (char *)szWork;
        pcVar4 = pszT;
        psz = ((ZIPPRODQ *)vrgZipProd)[i + -0x431].szName;
        while (pszT = pcVar4, *psz != '\0') {
          pcVar1 = psz + 1;
          cVar2 = *psz;
          *pszT = cVar2;
          pcVar4 = pszT + 1;
          psz = pcVar1;
          if (cVar2 == '&') {
            pszT[1] = '&';
            pcVar4 = pszT + 2;
          }
        }
        *pszT = '\0';
      }
      *(HWND *)(puVar8 + -2) = hwnd;
      *(short *)(puVar8 + -4) = i;
      *(undefined2 *)(puVar8 + -6) = uVar10;
      *(undefined2 *)(puVar8 + -8) = 0x5647;
      HVar6 = GetDlgItem(*(HWND *)(puVar8 + -2),*(short *)(puVar8 + -4));
      *(HWND *)(puVar8 + -2) = HVar6;
      *(undefined2 *)(puVar8 + -4) = 0x1120;
      *(char **)(puVar8 + -6) = (char *)szWork;
      *(undefined2 *)(puVar8 + -8) = 0x14f8;
      uVar10 = 0x14f8;
      *(undefined2 *)(puVar8 + -10) = 0x5659;
      SetWindowText(*(HWND *)(puVar8 + -2),*(LPCSTR *)(puVar8 + -6));
      puVar8 = puVar8 + -6;
    }
    *(undefined2 *)(puVar8 + -2) = 1;
    *(undefined2 *)(puVar8 + -4) = 0xd00;
    *(HWND *)(puVar8 + -6) = hwnd;
    *(undefined2 *)(puVar8 + -8) = uVar10;
    *(undefined2 *)(puVar8 + -10) = 0x5677;
    StickyDlgPos(*(HWND *)(puVar8 + -6),*(POINT **)(puVar8 + -4),*(short *)(puVar8 + -2));
    if (((uint)gd.grBits >> 0xb & 1) != 0) {
      *(undefined2 *)(puVar8 + -2) = 0x1040;
      *(ushort (**) [2])(puVar8 + -4) = (ushort (*) [2])rghbrMinSum;
      AdvanceTutor();
    }
    return 1;
  }
  if (message != WM_COMMAND) {
    return 0;
  }
  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),(ushort)pszT);
  if ((((int)uVar11 == 0) && (0x430 < wParam)) && (wParam < 0x435)) {
    iResTechNow = wParam - 0x431;
    EnableZipProdBtns(hwnd,iResTechNow);
    FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd + iResTechNow);
    return 0;
  }
  if ((wParam == 1) || (wParam == 2)) {
    StickyDlgPos(hwnd,(POINT *)&ptStickyZipProdDlg,0);
    EndDialog(hwnd,(uint)(wParam == 1));
    vyZPDStatic = -1;
    if (((uint)gd.grBits >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    return 1;
  }
  if ((wParam != 0x816) && (wParam != 0x41b)) {
    if (wParam == 0x817) {
      *(undefined1 *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) = 0;
      pcVar4 = PszGetCompressedString(idsUnusedD);
      _wsprintf(szWork,pcVar4);
      HVar6 = GetDlgItem(hwnd,iResTechNow + 0x431);
      SetWindowText(HVar6,szWork);
      FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd + iResTechNow);
      gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xffdf | 0x20;
      return 0;
    }
    if (wParam != 0x76) {
      return 0;
    }
    WinHelp(hwnd,_szHelpFile,1,0x452);
    return 1;
  }
  if (*(char *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) == '\0') {
    pcVar4 = PszGetCompressedString(idsCustomD);
    _wsprintf(szWork,pcVar4);
  }
  else {
    _strcpy((char *)szWork,
                    ((ZIPPRODQ *)vrgZipProd)[iResTechNow].szName);
  }
  local_36 = MakeProcInstance(RenameZipDlg,hInst);
  puVar9 = &stack0xffba;
  if (iResTechNow != 0) {
    uVar10 = 0x14f8;
    sVar7 = DialogBox(0,(LPCSTR)CONCAT22(0x7e3,hwndFrame),(HWND)((ulong)local_36 >> 0x10),
                      (char)local_36);
    puVar9 = &stack0xffba;
    pvVar3 = local_36;
    if (sVar7 == 0) goto LAB_10d0_5ce2;
    if (szWork[0] == '\0') {
      pcVar4 = PszGetCompressedString(idsCustomD);
      _wsprintf(szWork,pcVar4);
    }
    _strcpy(((ZIPPRODQ *)vrgZipProd)[iResTechNow].szName,
                    (char *)szWork);
    local_3c._2_2_ = (char *)szWork + 0x40;
    local_38 = (char *)szWork;
    pcVar4 = (char *)local_3c._2_2_;
    while (local_3c._2_2_ = pcVar4, *local_38 != '\0') {
      pcVar1 = local_38 + 1;
      cVar2 = *local_38;
      *(char *)local_3c._2_2_ = cVar2;
      pcVar4 = (char *)(local_3c._2_2_ + 1);
      local_38 = pcVar1;
      if (cVar2 == '&') {
        *(char *)(local_3c._2_2_ + 1) = '&';
        pcVar4 = (char *)(local_3c._2_2_ + 2);
      }
    }
    *(char *)local_3c._2_2_ = '\0';
    HVar6 = GetDlgItem(hwnd,iResTechNow + 0x431);
    SetWindowText(HVar6,szWork + 0x40);
    puVar9 = &stack0xffb4;
  }
  uVar10 = 0x14f8;
  if (wParam == 0x816) {
    *(undefined1 *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) = 1;
    local_3c._0_2_ = 0;
    for (i = 0; i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
      *(undefined2 *)((int)puVar9 + -2) = uVar10;
      *(undefined2 *)(puVar9 + -1) = 0x5b16;
      uVar11 = __aFulshr(*puVar9,(ushort)puVar9[1]);
      if (((uint)uVar11 & 7) == 1) {
        *(undefined2 *)((int)puVar9 + -2) = 0x1118;
        *(undefined2 *)(puVar9 + -1) = 0x5b53;
        uVar11 = __aFulshr(*puVar9,(ushort)puVar9[1]);
        if (((uint)uVar11 & 0x7f) < 7) {
          *(undefined2 *)((int)puVar9 + -2) = 0x1118;
          uVar10 = 0x1118;
          *(undefined2 *)(puVar9 + -1) = 0x5b98;
          uVar11 = __aFulshr(*puVar9,(ushort)puVar9[1]);
          *(uint *)(iResTechNow * hbrBlue + 0x2306 + local_3c._0_2_ * 2) =
               *(uint *)(iResTechNow * hbrBlue + 0x2306 + local_3c._0_2_ * 2) & 0xffc0 |
               (uint)uVar11 & 0x3f;
          *(uint *)(iResTechNow * hbrBlue + 0x2306 + local_3c._0_2_ * 2) =
               *(uint *)(iResTechNow * hbrBlue + 0x2306 + local_3c._0_2_ * 2) & 0x3f |
               ((PLPROD *)lpplProdGlob + i + 1)->wFlags << 6;
          local_3c._0_2_ = local_3c._0_2_ + 1;
          if (0xb < (int)local_3c._0_2_) break;
        }
      }
      uVar10 = 0x1118;
    }
    *(undefined1 *)
     ((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 +
     iResTechNow * 0x28 + 1) = (char)local_3c._0_2_;
    *(undefined2 *)((int)puVar9 + -2) = uVar10;
    *(undefined2 *)(puVar9 + -1) = 0x5ca0;
    uVar11 = __aFulshr(*puVar9,(ushort)puVar9[1]);
    *(byte *)((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 +
             iResTechNow * 0x28) = (byte)uVar11 & 1;
    *(undefined2 *)((int)puVar9 + -2) = (ZIPPRODQ *)vrgZipProd + iResTechNow;
    *(HWND *)(puVar9 + -1) = hwnd;
    *(undefined2 *)((int)puVar9 + -6) = 0x1118;
    uVar10 = 0x10d0;
    *(undefined2 *)(puVar9 + -2) = 0x5cd0;
    FillZipProdLB((HWND)puVar9[-1],(ZIPPRODQ *)*(undefined2 *)((int)puVar9 + -2));
  }
  *(short *)((int)puVar9 + -2) = iResTechNow;
  *(HWND *)(puVar9 + -1) = hwnd;
  *(undefined2 *)((int)puVar9 + -6) = uVar10;
  uVar10 = 0x10d0;
  *(undefined2 *)(puVar9 + -2) = 0x5cdf;
  EnableZipProdBtns((HWND)puVar9[-1],*(short *)((int)puVar9 + -2));
  pvVar3 = local_36;
LAB_10d0_5ce2:
  local_36._2_2_ = (HWND)((ulong)pvVar3 >> 0x10);
  *(undefined2 *)((int)puVar9 + -2) = local_36._2_2_;
  local_36 = pvVar3;
  *(undefined2 *)((int)puVar9 + -4) = (void *)local_36;
  *(undefined2 *)((int)puVar9 + -6) = uVar10;
  *(undefined2 *)((int)puVar9 + -8) = 0x5ced;
  FreeProcInstance((FARPROC)*(undefined4 *)((int)puVar9 + -4));
  *(HWND *)((int)puVar9 + -2) = hwnd;
  *(undefined2 *)((int)puVar9 + -4) = 0x14f8;
  *(undefined2 *)((int)puVar9 + -6) = 0x5cf5;
  SetFocus(*(HWND *)((int)puVar9 + -2));
  gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xffdf | 0x20;
  return 0;
}



// ======================================================================
// Function: EnableZipProdBtns
// Address: 10d0:5df0
// Segment: MEMORY_PRODUCE
// ======================================================================


void EnableZipProdBtns(HWND hwnd,short iSel)

{
  BOOL BVar1;
  HWND HVar2;
  short fEnabled;
  
  if ((*(char *)((int)&vrgZipProd[0].fValid + iSel * 0x28) == '\0') || (iSel < 1)) {
    BVar1 = 0;
  }
  else {
    BVar1 = 1;
  }
  HVar2 = GetDlgItem(hwnd,0x817);
  EnableWindow(HVar2,BVar1);
  HVar2 = GetDlgItem(hwnd,0x41b);
  EnableWindow(HVar2,BVar1);
  return;
}



// ======================================================================
// Function: FillZipProdLB
// Address: 10d0:5e58
// Segment: MEMORY_PRODUCE
// ======================================================================


void FillZipProdLB(HWND hwndDlg,ZIPPRODQ *pzpq)

{
  HWND HVar1;
  char *pcVar2;
  undefined2 unaff_SS;
  WPARAM WVar3;
  UINT UVar4;
  RECT rc;
  char szFormat [15];
  char szAuto [40];
  HWND hwndLB;
  short i;
  
  HVar1 = GetDlgItem(hwndDlg,0x417);
  GetClientRect(hwndDlg,&rc);
  rc.top = vyZPDStatic;
  rc.bottom = vyZPDStatic + dyArial8;
  InvalidateRect(hwndDlg,&rc,1);
  SendMessage(HVar1,0x405,0,0);
  if ((pzpq->fValid == 0) || (*(char *)((int)&pzpq->u_ZIPPRODQ_0x000e + 1) == '\0')) {
    UVar4 = 0x401;
    WVar3 = 0;
    pcVar2 = PszGetCompressedString(idsAutoBuildOrders);
    SendMessage(HVar1,UVar4,WVar3,(LPARAM)pcVar2);
  }
  else {
    CchGetString(idsSD2,szFormat);
    for (i = 0; i < (int)(uint)*(byte *)((int)&pzpq->u_ZIPPRODQ_0x000e + 1); i = i + 1) {
      CchGetString((*(uint *)(pzpq->szName + i * 2 + 0x10) & 0x3f) + idsMines,szAuto);
      if ((*(uint *)(pzpq->szName + i * 2 + 0x10) >> 6 == 1) ||
         ((*(uint *)(pzpq->szName + i * 2 + 0x10) & 0x3f) == 3)) {
        _strcpy((char *)szWork,szAuto);
      }
      else {
        _wsprintf(szWork,szFormat,szAuto);
      }
      SendMessage(HVar1,0x401,0,0x112057a4);
    }
  }
  return;
}



