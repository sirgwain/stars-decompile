// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: ChangeProduction
// Address: 10d0:0000
// Segment: MEMORY_PRODUCE
// ======================================================================


short ChangeProduction(short fClear)

{
  short sVar1;
  char *sz;
  short fSuccess;
  PROD rgprod [64];
  undefined4 lpProcProd;
  undefined2 penvMemSav;
  undefined1 env [20];
  
                    /* Segment:    27
                       Offset:     000bc100
                       Length:     5ff4
                       Min Alloc:  5ff4
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  penvMemSav = penvMem;
  penvMem = env;
  sVar1 = __setjmp(env);
  if (sVar1 == 0) {
    if (fClear == 0) {
      InitProduction(rgprod);
      fDlgUp = 1;
      lpProcProd = MakeProcInstance(ProductionDlg,hInst);
      fSuccess = DialogBox(0,(LPCSTR)CONCAT22(0x5d,hwndFrame),
                           (HWND)((ulong)lpProcProd >> 0x10),(void *)lpProcProd);
      FreeProcInstance(lpProcProd);
      hwndProdDlg = 0;
      fDlgUp = 0;
    }
    else {
      fSuccess = 1;
    }
    FinishProduction(fSuccess);
    if ((fSuccess != 0) && (sel.grobj == grobjPlanet)) {
      DrawPlanShip(0,8);
    }
    penvMem = (undefined1 *)penvMemSav;
    sVar1 = 1;
  }
  else {
    if (((PLPROD *)lpplProdGlob != (PLPROD *)0x0) || (lpplProdGlob._2_2_ != 0)) {
      FreePl((PL *)CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob));
    }
    lpplProdGlob._0_2_ = (PLPROD *)0x0;
    lpplProdGlob._2_2_ = 0;
    if (hwndProdDlg != 0) {
      EndDialog(hwndProdDlg,0);
    }
    hwndProdDlg = 0;
    fDlgUp = 0;
    sVar1 = 0x10;
    sz = PszFormatIds(idsThereIsntEnoughFreeMemoryModifyProduction,(short *)0x0);
    AlertSz(sz,sVar1);
    penvMem = (undefined1 *)penvMemSav;
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: InitProduction
// Address: 10d0:015e
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d00ef7) */
/* WARNING: Removing unreachable block (ram,0x10d00a78) */
/* WARNING: Removing unreachable block (ram,0x10d00efc) */
/* WARNING: Removing unreachable block (ram,0x10d00fb0) */
/* WARNING: Removing unreachable block (ram,0x10d00de1) */
/* WARNING: Removing unreachable block (ram,0x10d00fb5) */
/* WARNING: Removing unreachable block (ram,0x10d00e3f) */

void InitProduction(PROD *rgprod)

{
  byte *pbVar1;
  PROD *pPVar2;
  undefined2 *puVar3;
  short sVar4;
  uint uVar5;
  PROD *pPVar6;
  undefined2 unaff_SI;
  PROD *pPVar7;
  undefined2 unaff_DI;
  undefined2 uVar8;
  undefined2 uVar9;
  ulong uVar10;
  HULDEF *pHVar11;
  long lVar12;
  long lVar13;
  ulong uVar14;
  uint in_stack_0000ffde;
  PROD *lpprod;
  PART part;
  short ipl;
  short i;
  ushort u;
  short iSrc;
  short iWarp;
  
  uVar14 = CONCAT22(unaff_SI,unaff_DI);
  uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
  gd._0_2_ = gd._0_2_ & 0xffdf | ((uint)uVar10 & 1) << 5;
  if (rgprod == (PROD *)0x0) {
    rgprod = pProdGlob;
  }
  if (((PLPROD *)sel.pl.lpplprod == (PLPROD *)0x0) &&
     (sel.pl.lpplprod._2_2_ == 0)) {
    i = 2;
  }
  else {
    i = (short)((PLPROD *)sel.pl.lpplprod)->iprodMac;
  }
  lpplProdGlob = (PLPROD *)LpplAlloc(4,i,htOrd);
  if (((PLPROD *)sel.pl.lpplprod == (PLPROD *)0x0) &&
     (sel.pl.lpplprod._2_2_ == 0)) {
    i = 0;
  }
  else {
    __fmemcpy((PL *)CONCAT22((int)((ulong)lpplProdGlob >> 0x10),
                                     (PL *)lpplProdGlob + 1),
                      (PLPROD *)
                      CONCAT22(sel.pl.lpplprod._2_2_,
                               (PLPROD *)sel.pl.lpplprod + 1),i << 2);
  }
  ((PLPROD *)lpplProdGlob)->iprodMac = (byte)i;
  cProdGlob = 0;
  pProdGlob = rgprod;
  _memset(rgprod,0,0x100);
  if ((((uint)sel.pl.wFlags >> 9 & 1) != 0) &&
     (pHVar11 = LphuldefFromId
                          (*(HullDef *)
                            (*(int *)(idPlayer * 4 + 0x14c) +
                            (sel.pl._44_2_ & 0xf) * 0x93)),
     (((HULDEF *)pHVar11)->hul).wtCargoMax != 0)) {
    for (i = 0; i < 0x10; i = i + 1) {
      if ((((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0) &&
          (-1 < *(int *)((int)&rgshdef[0].wFlags + i * 0x93))) &&
         (uVar5 = *(uint *)((int)&rgshdef[0].hul + 0x28 + i * 0x93),
         pHVar11 = LphuldefFromId
                             (*(HullDef *)
                               (*(int *)(idPlayer * 4 + 0x14c) +
                               (sel.pl._44_2_ & 0xf) * 0x93)),
         uVar5 <= (uint)(((HULDEF *)pHVar11)->hul).wtCargoMax)) {
        uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
        *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
        lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *(uint *)&pPVar6->dwFlags =
             (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 4;
        cProdGlob = cProdGlob + 1;
      }
    }
  }
  for (i = 0; i < 10; i = i + 1) {
    if ((((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) &&
        (-1 < *(int *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b))) &&
       (((sel.pl._44_2_ & 0xf) != i || (((uint)sel.pl.wFlags >> 9 & 1) == 0))))
    {
      uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
      *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
      lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(uint *)&pPVar6->dwFlags =
           (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 4;
      cProdGlob = cProdGlob + 1;
    }
  }
  part.hs.grhst = hstPlanetary;
  part.hs.wFlags = part.hs.wFlags & 0xff00U | 0xe;
  sVar4 = FLookupPart(&part);
  if (sVar4 == 1) {
    uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
    *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x3400;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  iWarp = IWarpMAFromLppl(&sel.pl,(short *)0x0);
  if (0 < iWarp) {
    for (i = 0; i < 4; i = i + 1) {
      uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
      *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
      lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(uint *)&pPVar6->dwFlags =
           (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
      cProdGlob = cProdGlob + 1;
    }
  }
  uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
  sVar4 = CMaxFactories(&sel.pl,idPlayer);
  u = sVar4 - ((uint)uVar10 & 0xfff);
  if (0 < (int)u) {
    lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags =
         (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x1c00;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
  sVar4 = CMaxMines(&sel.pl,idPlayer);
  u = sVar4 - ((uint)uVar10 & 0xfff);
  if (0 < (int)u) {
    lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags =
         (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2000;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  uVar5 = (uint)sel.pl.dwFlags & 0xfff;
  sVar4 = CMaxDefenses(&sel.pl,idPlayer);
  u = sVar4 - uVar5;
  if (0 < (int)u) {
    lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags =
         (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2400;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
  pPVar6 = rgprod + cProdGlob;
  *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
  *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
  uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
  pPVar6 = rgprod + cProdGlob;
  *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2c00;
  *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
  uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
  pPVar6 = rgprod + cProdGlob;
  *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
  *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
  cProdGlob = cProdGlob + 1;
  uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
  if ((((uint)uVar10 & 0x1f) == 0x1f) &&
     (sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
     sVar4 != raMacintosh)) {
    uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
    *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x6c00;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  i = IpctCanTerraformLppl(&sel.pl);
  if (0 < i) {
    lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags =
         (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x3000;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  for (i = 0; i < 7; i = i + 1) {
    sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (((sVar4 != raMacintosh) || (((i != 0 && (i != 1)) && (i != 2)))) &&
       ((sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
        sVar4 != raTerra || ((i != 4 && (i != 5)))))) {
      uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
      *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
      lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(uint *)&pPVar6->dwFlags =
           (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
      cProdGlob = cProdGlob + 1;
    }
  }
  ipl = 0;
  lpprod = (PROD *)CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob + 1);
  do {
    if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= ipl) {
      if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
        AdvanceTutor();
      }
      return;
    }
    iSrc = 0;
    while( true ) {
      pPVar6 = (PROD *)lpprod;
      uVar8 = (undefined2)((ulong)lpprod >> 0x10);
      if (cProdGlob <= iSrc) break;
      uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
      in_stack_0000ffde = (uint)uVar10 & 7;
      uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
      if (in_stack_0000ffde == ((uint)uVar10 & 7)) {
        uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
        in_stack_0000ffde = (uint)uVar10 & 0x7f;
        uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
        if (in_stack_0000ffde == ((uint)uVar10 & 0x7f)) break;
      }
      iSrc = iSrc + 1;
    }
    if (iSrc < cProdGlob) {
      if (((uint)(pProdGlob + iSrc)->dwFlags & 0x3ff) < ((uint)lpprod->dwFlags & 0x3ff)) {
        lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
        uVar5 = *(uint *)((int)&pPVar6->dwFlags + 2);
        *(uint *)&lpprod->dwFlags = (uint)lpprod->dwFlags & 0xfc00 | (uint)lVar12;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
      }
      if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
        if (((uint)(pProdGlob + iSrc)->dwFlags & 0x3ff) < ((uint)lpprod->dwFlags & 0x3ff))
        {
          uVar9 = *(undefined2 *)((int)&pProdGlob[iSrc].dwFlags + 2);
          pPVar7 = pProdGlob + iSrc;
          *(uint *)&pPVar7->dwFlags = (uint)(pProdGlob + iSrc)->dwFlags & 0xfc00;
          *(undefined2 *)((int)&pPVar7->dwFlags + 2) = uVar9;
        }
        else {
          lVar13 = __aFlshl(uVar14,in_stack_0000ffde);
          lVar12 = (pProdGlob + iSrc)->dwFlags;
          pPVar7 = pProdGlob + iSrc;
          pPVar2 = pPVar7;
          *(uint *)&pPVar2->dwFlags = (uint)pPVar2->dwFlags & 0xfc00;
          puVar3 = (undefined2 *)((int)&pPVar7->dwFlags + 2);
          *puVar3 = *puVar3;
          pPVar7 = pProdGlob + iSrc;
          pPVar2 = pPVar7;
          *(uint *)&pPVar2->dwFlags = (uint)pPVar2->dwFlags | (int)lVar12 - (int)lVar13 & 0x3ffU;
          puVar3 = (undefined2 *)((int)&pPVar7->dwFlags + 2);
          *puVar3 = *puVar3;
        }
      }
    }
    else {
      uVar9 = (undefined2)((ulong)lpplProdGlob >> 0x10);
      if (ipl + 1 < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
        __fmemcpy(lpprod,(PROD *)CONCAT22(uVar8,pPVar6 + 1),
                          ((uint)((PLPROD *)lpplProdGlob)->iprodMac - (ipl + 1)) * 4);
        ipl = ipl + -1;
      }
      pbVar1 = &((PLPROD *)lpplProdGlob)->iprodMac;
      *pbVar1 = *pbVar1 - 1;
    }
    ipl = ipl + 1;
    lpprod = (PROD *)CONCAT22(uVar8,pPVar6 + 1);
  } while( true );
}



// ======================================================================
// Function: FinishProduction
// Address: 10d0:1090
// Segment: MEMORY_PRODUCE
// ======================================================================


void FinishProduction(short fWrite)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar1;
  
  if (fWrite == 0) {
    lVar1 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),(uint)gd._0_2_ >> 5 & 1);
    sel.pl.dwFlags._0_2_ = (uint)sel.pl.dwFlags | (uint)lVar1;
    sel.pl.dwFlags._2_2_ =
         sel.pl.dwFlags._2_2_ & 0xff7f | (uint)((ulong)lVar1 >> 0x10);
    FreePl((PL *)lpplProdGlob);
  }
  else {
    FreePl((PL *)CONCAT22(sel.pl.lpplprod._2_2_,
                                  (PLPROD *)sel.pl.lpplprod));
    if ((((PLPROD *)lpplProdGlob != (PLPROD *)0x0) || (lpplProdGlob._2_2_ != 0)) &&
       (((PLPROD *)lpplProdGlob)->iprodMac == 0)) {
      FreePl((PL *)lpplProdGlob);
      lpplProdGlob = (PLPROD *)0x0;
    }
    sel.pl.lpplprod._0_2_ = (PLPROD *)lpplProdGlob;
    sel.pl.lpplprod._2_2_ = lpplProdGlob._2_2_;
    lpplProdGlob = (PLPROD *)0x0;
    FLookupPlanet(-1,(PLANET *)&sel.pl);
    FLookupPlanet(sel.pl.id,(PLANET *)&sel.pl);
    if (fAi == 0) {
      FillPlanetProdLB(0,(PLPROD *)0x0,(PLANET *)0x0);
      DrawPlanShip(0,0x40);
    }
  }
  lpplProdGlob = (PLPROD *)0x0;
  if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
    tutor.wFlags = tutor.wFlags & 0xfbffU | 0x400;
    AdvanceTutor();
  }
  return;
}



// ======================================================================
// Function: ProductionDlg
// Address: 10d0:1204
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: fRet */

short ProductionDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  POINT PVar1;
  int iVar2;
  HWND HVar3;
  char *pcVar4;
  BOOL BVar5;
  short sVar6;
  char **ppcVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  bool bVar8;
  ulong uVar9;
  FARPROC pvVar10;
  short fRet;
  undefined1 rgzp [140];
  int local_58;
  short rgidProdBtns [9];
  char *rgszZip;
  short dyLB;
  short dx;
  short xCtr;
  short i;
  short i__56;
  char sz255;
  undefined1 local_35;
  short cMax;
  POINT pt;
  RECT rc;
  PAINTSTRUCT ps;
  HDC hdc;
  
  uVar9 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    hdc = BeginPaint(hwnd,(PAINTSTRUCT *)&ps);
    GetClientRect(hwnd,(RECT *)&rc);
    DrawProductionDlg(hwnd,hdc,&rc,-1);
    EndPaint(hwnd,(PAINTSTRUCT *)&ps);
    sVar6 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(RECT *)&rc);
    FillRect(wParam,(RECT *)&rc,hbrButtonFace);
    sVar6 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      pt.y = (int)lParam;
      HVar3 = GetDlgItem(hwnd,0x8b);
      if ((pt.y == HVar3) || (uVar9 = __aFulshr(uVar9,fRet), (int)uVar9 == 6)) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else if (message == WM_SETCURSOR) {
      cMax = 0;
      GetCursorPos((POINT *)(POINT *)&pt);
      ScreenToClient(hwnd,(POINT *)(POINT *)&pt);
      BVar5 = PtInRect(&rcProdDiamond,(POINT)pt);
      if (BVar5 != 0) {
        setcursor(hcurArrowHelp);
        return 1;
      }
    }
    else {
      if (message == WM_DRAWITEM) {
        pt = (POINT)lParam;
        if (*(int *)((int)lParam + 4) == -1) {
          HandleFocusState((DRAWITEMSTRUCT *)lParam,-2);
        }
        else {
          iVar2 = *(int *)((int)lParam + 6);
          if (((iVar2 == 1) || (iVar2 == 2)) || (iVar2 == 4)) {
            DrawCBEntireItem((DRAWITEMSTRUCT *)lParam,4);
          }
        }
        return 1;
      }
      if (message == WM_MEASUREITEM) {
        *(int *)((int)lParam + 8) = dyArial8 + 2;
        return 1;
      }
      if (message == WM_INITDIALOG) {
        rgidProdBtns[0] = 0x42e;
        rgidProdBtns[1] = 0x42f;
        rgidProdBtns[2] = 1;
        rgidProdBtns[3] = 2;
        rgidProdBtns[4] = 0x418;
        rgidProdBtns[5] = 0x419;
        rgidProdBtns[6] = 0x439;
        rgidProdBtns[7] = 0x43a;
        rgidProdBtns[8] = 0x42d;
        rgszZip = (char *)&game.mdDensity;
        hwndProdDlg = hwnd;
        if (*(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) < 2) {
          HVar3 = GetDlgItem(hwnd,0x42f);
          EnableWindow(HVar3,0);
          HVar3 = GetDlgItem(hwnd,0x42e);
          EnableWindow(HVar3,0);
        }
        if ((uint)gd._0_2_ >> 0xe == 0) {
          dx = 0x262;
          pt.x = dyArial8 * 0x18 + 0x18;
        }
        else {
          dx = 0x2f8;
          pt.x = 0x244;
        }
        SetWindowPos(hwnd,0,0,0,dx,pt.x,6);
        GetClientRect(hwnd,(RECT *)&rc);
        xCtr = rc.right >> 1;
        dyLB = (rc.bottom - (dyArial8 * 0x11) / 2) + -0x18;
        rc.left = (rc.right * 0xb) / 0x14 + 0x10;
        pt.y = (rc.right - rc.left) / 4;
        rc.bottom = rc.bottom - ((dyArial8 * 3) / 2 + 6);
        HVar3 = GetDlgItem(hwnd,0x8b);
        SetWindowPos(HVar3,0,6,rc.bottom,rc.left + -0xc,(dyArial8 * 3) / 2,4);
        for (i = 0; i < 4; i = i + 1) {
          HVar3 = GetDlgItem(hwnd,rgidProdBtns[i]);
          SetWindowPos(HVar3,0,rc.left,rc.bottom,pt.y + -6,(dyArial8 * 3) / 2,4);
          rc.left = rc.left + pt.y;
        }
        rc.left = xCtr - (pt.y + 0x12 >> 1);
        local_58 = (dyArial8 * 3) / 2;
        iVar2 = (dyLB + dyArial8 * -9) / 5 + local_58;
        pt.x = iVar2 + -3;
        rc.top = 8;
        if (0x32 < pt.x) {
          rc.top = ((iVar2 + -0x35) * 5) / 2 + 8;
          pt.x = 0x32;
        }
        pt.y = pt.y + 0x18;
        for (i = 4; i < 10; i = i + 1) {
          HVar3 = GetDlgItem(hwnd,rgidProdBtns[i]);
          SetWindowPos(HVar3,0,rc.left,rc.top,pt.y + -6,(dyArial8 * 3) / 2,4);
          rc.top = rc.top + pt.x;
        }
        HVar3 = GetDlgItem(hwnd,0x416);
        SetWindowPos(HVar3,0,6,6,rc.left + -0xc,dyLB,4);
        HVar3 = GetDlgItem(hwnd,0x416);
        GetWindowRect(HVar3,(RECT *)(RECT *)&stack0xffc6);
        HVar3 = GetDlgItem(hwnd,0x417);
        SetWindowPos(HVar3,0,rc.left + pt.y,6,rc.left + -0xc,cMax - i__56,4);
        ScreenToClient(hwnd,(POINT *)(POINT *)&stack0xffca);
        yTopFutureTech = cMax;
        InitializeProductionDlg(hwnd);
        if (((uint)gd._0_2_ >> 0xe == 1) && (ptStickyProduceDlg.y == -1)) {
          ptStickyProduceDlg.y = 0;
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyProduceDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        ProdCommandHandler(hwnd,wParam,lParam);
      }
      else if ((message == WM_LBUTTONDOWN) || (message == WM_RBUTTONDOWN)) {
        pt.x = (int)lParam;
        uVar9 = __aFulshr(uVar9,fRet);
        pt.y = (short)uVar9;
        PVar1.y = (short)uVar9;
        PVar1.x = pt.x;
        BVar5 = PtInRect(&rcProdDiamond,PVar1);
        if (BVar5 != 0) {
          if (message == WM_LBUTTONDOWN) {
            GlobalPD.grPopup = 10;
            GlobalPD.field1_0x2 = 0xb4;
            GlobalPD.field2_0x3 = 0;
            GlobalPD.psz = (char *)szPopupBuffer;
            CchGetString
                      (idsRightClickBlueDiamondApplyProductionTemplate,
                       (char *)szPopupBuffer);
            Popup(hwnd,pt.x,pt.y);
          }
          else {
            sz255 = -1;
            local_35 = 0;
            cMax = 0;
            for (i__56 = 0; i__56 < 4; i__56 = i__56 + 1) {
              if (*(char *)((int)&vrgZipProd[0].fValid + i__56 * 0x28) != '\0') {
                ppcVar7 = &rgszZip + cMax;
                cMax = cMax + 1;
                *ppcVar7 = ((ZIPPRODQ *)vrgZipProd)[i__56].szName;
              }
            }
            ppcVar7 = &rgszZip + cMax;
            cMax = cMax + 1;
            *ppcVar7 = &stack0xffca;
            pcVar4 = PszGetCompressedString(idsCustomize);
            ppcVar7 = &rgszZip + cMax;
            cMax = cMax + 1;
            *ppcVar7 = pcVar4;
            i__56 = PopupMenu(hwnd,pt.x,pt.y,cMax,(long *)0x0,&rgszZip,-1,1);
            if (i__56 == cMax + -1) {
              _memcpy(rgzp,(ZIPPRODQ *)vrgZipProd,0xa0);
              pvVar10 = MakeProcInstance(ZipProdDlg,hInst);
              sVar6 = DialogBox(0,(LPCSTR)CONCAT22(0x59,hwnd),(HWND)((ulong)pvVar10 >> 0x10),
                                (void *)pvVar10);
              FreeProcInstance(pvVar10);
              if (sVar6 == 0) {
                _memcpy((ZIPPRODQ *)vrgZipProd,rgzp,0xa0);
              }
            }
            else if (-1 < i__56) {
              cMax = 0;
              while ((cMax < 4 &&
                     ((*(char *)((int)&vrgZipProd[0].fValid + cMax * 0x28) == '\0' ||
                      (iVar2 = i__56 + -1, bVar8 = i__56 != 0, i__56 = iVar2, bVar8))))) {
                cMax = cMax + 1;
              }
              ProdCommandHandler(hwnd,0x816,(long)cMax);
            }
          }
        }
      }
    }
    sVar6 = 0;
  }
  return sVar6;
}



// ======================================================================
// Function: ProdCommandHandler
// Address: 10d0:1994
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d01f07) */
/* WARNING: Removing unreachable block (ram,0x10d01a99) */
/* WARNING: Removing unreachable block (ram,0x10d026c2) */
/* WARNING: Removing unreachable block (ram,0x10d023e0) */
/* WARNING: Removing unreachable block (ram,0x10d02357) */
/* WARNING: Removing unreachable block (ram,0x10d02404) */
/* WARNING: Removing unreachable block (ram,0x10d025ca) */
/* WARNING: Removing unreachable block (ram,0x10d01a12) */
/* WARNING: Removing unreachable block (ram,0x10d01e16) */
/* WARNING: Removing unreachable block (ram,0x10d021cd) */
/* WARNING: Removing unreachable block (ram,0x10d029e0) */
/* WARNING: Removing unreachable block (ram,0x10d01dc1) */
/* WARNING: Removing unreachable block (ram,0x10d01b8e) */
/* WARNING: Removing unreachable block (ram,0x10d01b0c) */
/* WARNING: Removing unreachable block (ram,0x10d01a9e) */
/* WARNING: Removing unreachable block (ram,0x10d01b07) */
/* WARNING: Removing unreachable block (ram,0x10d01b89) */
/* WARNING: Removing unreachable block (ram,0x10d01d7f) */
/* WARNING: Removing unreachable block (ram,0x10d022cf) */
/* WARNING: Removing unreachable block (ram,0x10d029ab) */
/* WARNING: Removing unreachable block (ram,0x10d029e5) */
/* WARNING: Removing unreachable block (ram,0x10d027b8) */
/* WARNING: Removing unreachable block (ram,0x10d0231d) */
/* WARNING: Removing unreachable block (ram,0x10d02093) */
/* WARNING: Removing unreachable block (ram,0x10d02051) */
/* WARNING: Removing unreachable block (ram,0x10d01f51) */
/* WARNING: Removing unreachable block (ram,0x10d01f0c) */
/* WARNING: Removing unreachable block (ram,0x10d01f8e) */
/* WARNING: Removing unreachable block (ram,0x10d02816) */
/* WARNING: Removing unreachable block (ram,0x10d03237) */
/* WARNING: Removing unreachable block (ram,0x10d02222) */
/* WARNING: Removing unreachable block (ram,0x10d03098) */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void ProdCommandHandler(HWND hwnd,ushort wParam,long lParam)

{
  PROD *pPVar1;
  undefined2 *puVar2;
  uint *puVar3;
  byte *pbVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  long lVar7;
  PL *pPVar8;
  undefined2 uVar9;
  uint uVar10;
  HWND HVar11;
  uint uVar12;
  int iVar13;
  ushort uVar14;
  PROD *pPVar15;
  PLPROD *pPVar16;
  uint *puVar17;
  undefined2 *puVar18;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar19;
  undefined2 unaff_SS;
  bool bVar20;
  LRESULT LVar21;
  ulong uVar22;
  ulong uVar23;
  PL *pPVar24;
  ulong uVar25;
  long lVar26;
  void *pvVar27;
  PLANET *pPVar28;
  undefined2 uVar29;
  short sVar30;
  UINT UVar31;
  ushort uVar32;
  ushort in_stack_0000ffc2;
  PLPROD *lpplprodT;
  short cMax;
  uint prod;
  uint local_28;
  PROD *lpprod;
  RECT rc;
  short iMac;
  short fRefillSrc;
  short ipl;
  short prodLast;
  undefined2 local_12;
  short iDst;
  short c;
  HWND hwndLB;
  short iSrc;
  undefined4 lSel;
  
  uVar22 = CONCAT22(unaff_SI,unaff_DI);
  if ((wParam == 1) || (wParam == 2)) {
    hwndProdDlg = 0;
    StickyDlgPos(hwnd,(POINT *)&ptStickyProduceDlg,0);
    EndDialog(hwnd,(uint)(wParam == 1));
    return;
  }
  if (wParam == 0x76) {
    WinHelp(hwnd,(LPCSTR)_szHelpFile,1,0x423);
    return;
  }
  if (wParam == 0x8b) {
    hwndLB = GetDlgItem(hwnd,0x417);
    HVar11 = GetDlgItem(hwnd,0x8b);
    SendMessage(HVar11,0x400,0,0);
    lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
    sel.pl.dwFlags._0_2_ = (uint)sel.pl.dwFlags | (uint)lVar26;
    sel.pl.dwFlags._2_2_ =
         sel.pl.dwFlags._2_2_ & 0xff7f | (uint)((ulong)lVar26 >> 0x10);
    lSel = SendMessage(hwndLB,0x409,0,0);
    FillPlanetProdLB(hwndLB,lpplProdGlob,(PLANET *)0x0);
    SendMessage(hwndLB,0x407,(uint)lSel,0);
    goto PRODUCE_RedrawText;
  }
  if ((wParam == 0x416) || (wParam == 0x417)) {
    uVar25 = __aFulshr(uVar22,in_stack_0000ffc2);
    if ((int)uVar25 == 1) goto PRODUCE_RedrawText;
    uVar25 = __aFulshr(uVar22,in_stack_0000ffc2);
    if ((int)uVar25 != 2) {
      return;
    }
    if (wParam == 0x416) goto PRODUCE_AddItem;
  }
  else {
    if (wParam == 0x418) {
PRODUCE_AddItem:
      uVar32 = (ushort)uVar22;
      HVar11 = GetDlgItem(hwnd,0x416);
      lVar26 = SendMessage(HVar11,0x409,0,0);
      if (((int)((ulong)lVar26 >> 0x10) < 1) && (lVar26 < 0)) {
        return;
      }
      iSrc = 0;
      while( true ) {
        lSel._2_2_ = (int)((ulong)lVar26 >> 0x10);
        lSel._0_2_ = (uint)lVar26;
        lVar7 = lVar26;
        if (cProdGlob <= iSrc) break;
        if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0) {
          lSel._2_2_ = lSel._2_2_ - (uint)((uint)lSel == 0);
          lVar7 = CONCAT22(lSel._2_2_,(uint)lSel + -1);
          bVar20 = lVar26 == 0;
          lVar26 = CONCAT22(lSel._2_2_,(uint)lSel + -1);
          if (bVar20) break;
        }
        iSrc = iSrc + 1;
      }
      uVar12 = (uint)(pProdGlob + iSrc)->dwFlags;
      local_28 = *(uint *)((int)&pProdGlob[iSrc].dwFlags + 2);
      uVar19 = 0x11;
      lSel = lVar7;
      uVar10 = GetAsyncKeyState(0x11);
      if ((uVar10 & 0xfffe) == 0) {
        uVar29 = 0x10;
        uVar10 = GetAsyncKeyState(0x10);
        if ((uVar10 & 0xfffe) == 0) {
          prod = uVar12 & 0xfc00 | 1;
        }
        else {
          lVar26 = __aFlshl(CONCAT22(uVar19,uVar29),uVar32);
          prod = uVar12 & 0xfc00 | (uint)lVar26;
          local_28 = local_28 | (uint)((ulong)lVar26 >> 0x10);
        }
      }
      else {
        uVar29 = 0x10;
        uVar10 = GetAsyncKeyState(0x10);
        if ((uVar10 & 0xfffe) == 0) {
          lVar26 = __aFlshl(CONCAT22(uVar19,uVar29),uVar32);
          uVar10 = (uint)((ulong)lVar26 >> 0x10);
          prod = uVar12 & 0xfc00 | (uint)lVar26;
        }
        else {
          lVar26 = __aFlshl(CONCAT22(uVar19,uVar29),uVar32);
          uVar10 = (uint)((ulong)lVar26 >> 0x10);
          prod = uVar12 & 0xfc00 | (uint)lVar26;
        }
        local_28 = local_28 | uVar10;
      }
      if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
        lVar26 = __aFlshl(CONCAT22(uVar19,uVar29),uVar32);
        lpplprodT._2_2_ = (int)(pProdGlob + iSrc)->dwFlags - (int)lVar26 & 0x3ff;
        pPVar15 = pProdGlob + iSrc;
        pPVar1 = pPVar15;
        *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
        puVar2 = (undefined2 *)((int)&pPVar15->dwFlags + 2);
        *puVar2 = *puVar2;
        pPVar15 = pProdGlob + iSrc;
        pPVar1 = pPVar15;
        *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags | lpplprodT._2_2_;
        puVar2 = (undefined2 *)((int)&pPVar15->dwFlags + 2);
        *puVar2 = *puVar2;
      }
      iMac = (short)((PLPROD *)lpplProdGlob)->iprodMac;
      HVar11 = GetDlgItem(hwnd,0x417);
      LVar21 = SendMessage(HVar11,0x409,0,0);
      if ((LVar21 < 0x10000) && (LVar21 < 0)) {
        iDst = iMac + -1;
        if (iDst < 0) {
          iDst = 0;
        }
      }
      else {
        iDst = (int)LVar21 + -1;
      }
      iVar13 = iDst;
      if (iDst < iMac) {
        lSel = LVar21;
        if (iDst < 0) {
LAB_10d0_1fde:
          iVar13 = iDst + 1;
          LVar21 = lSel;
          if (iVar13 < iMac) {
            prodLast = ((PLPROD *)lpplProdGlob + iDst + 2)->wFlags;
            local_12 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 2].iprodMax;
            iDst = iVar13;
            uVar22 = __aFulshr(CONCAT22(uVar19,uVar29),uVar32);
            lpplprodT._2_2_ = (uint)uVar22 & 0x7f;
            uVar22 = __aFulshr(CONCAT22(uVar19,uVar29),uVar32);
            iVar13 = iDst;
            LVar21 = lSel;
            if (lpplprodT._2_2_ == ((uint)uVar22 & 0x7f)) {
              uVar22 = __aFulshr(CONCAT22(uVar19,uVar29),uVar32);
              lpplprodT._2_2_ = (uint)uVar22 & 7;
              uVar22 = __aFulshr(CONCAT22(uVar19,uVar29),uVar32);
              iVar13 = iDst;
              LVar21 = lSel;
              if (lpplprodT._2_2_ == ((uint)uVar22 & 7)) goto PRODUCE_RingItUp;
            }
          }
          goto LAB_10d0_2099;
        }
        prodLast = ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags;
        local_12 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
        uVar22 = __aFulshr(CONCAT22(uVar19,uVar29),uVar32);
        lpplprodT._2_2_ = (uint)uVar22 & 0x7f;
        uVar22 = __aFulshr(CONCAT22(uVar19,uVar29),uVar32);
        if (lpplprodT._2_2_ != ((uint)uVar22 & 0x7f)) goto LAB_10d0_1fde;
        uVar22 = __aFulshr(CONCAT22(uVar19,uVar29),uVar32);
        lpplprodT._2_2_ = (uint)uVar22 & 7;
        uVar22 = __aFulshr(CONCAT22(uVar19,uVar29),uVar32);
        if (lpplprodT._2_2_ != ((uint)uVar22 & 7)) goto LAB_10d0_1fde;
PRODUCE_RingItUp:
        lVar26 = __aFlshl(CONCAT22(uVar19,uVar29),uVar32);
        uVar5 = lpplProdGlob._2_2_;
        uVar12 = *(uint *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
        pPVar16 = (PLPROD *)lpplProdGlob + iDst + 1;
        pPVar16->wFlags =
             ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0xfc00U | (uint)lVar26;
        *(uint *)&pPVar16->iprodMax = uVar12 | (uint)((ulong)lVar26 >> 0x10);
        if (1 < (((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0x3ffU)) {
          uVar22 = __aFulshr(CONCAT22(uVar19,uVar29),uVar32);
          if (((uint)uVar22 & 0x7f) == 3) {
            uVar22 = __aFulshr(CONCAT22(uVar19,uVar29),uVar32);
            if (((uint)uVar22 & 7) == 1) {
              uVar29 = lpplProdGlob._2_2_;
              uVar19 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
              pPVar16 = (PLPROD *)lpplProdGlob + iDst + 1;
              pPVar16->wFlags = ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0xfc00U | 1;
              *(undefined2 *)&pPVar16->iprodMax = uVar19;
            }
          }
        }
      }
      else {
LAB_10d0_2099:
        iDst = iVar13;
        lSel = LVar21;
        if (0x27 < iMac) {
          MessageBeep(0);
          goto PRODUCE_RedrawText;
        }
        if (iMac == (uint)((PLPROD *)lpplProdGlob)->iprodMax) {
          lpplProdGlob = (PLPROD *)LpplReAlloc((PL *)lpplProdGlob,iMac + 4);
          LVar21 = lSel;
        }
        lSel = LVar21;
        if (iDst != iMac) {
          __fmemmove((PLPROD *)
                             CONCAT22(lpplProdGlob._2_2_,
                                      (PLPROD *)lpplProdGlob + iDst + 2),
                             (PLPROD *)
                             CONCAT22(lpplProdGlob._2_2_,
                                      (PLPROD *)lpplProdGlob + iDst + 1),(iMac - iDst) * 4);
        }
        uVar19 = lpplProdGlob._2_2_;
        pPVar16 = (PLPROD *)lpplProdGlob + iDst + 1;
        pPVar16->wFlags = prod;
        *(uint *)&pPVar16->iprodMax = local_28;
        pbVar4 = &((PLPROD *)lpplProdGlob)->iprodMac;
        *pbVar4 = *pbVar4 + 1;
      }
      uVar29 = 0;
      pPVar28 = (PLANET *)0x0;
      pPVar16 = (PLPROD *)lpplProdGlob;
      uVar19 = lpplProdGlob._2_2_;
      HVar11 = GetDlgItem(hwnd,0x417);
      FillPlanetProdLB
                (HVar11,(PLPROD *)CONCAT22(uVar19,pPVar16),(PLANET *)CONCAT22(uVar29,pPVar28));
      HVar11 = GetDlgItem(hwnd,0x417);
      SendMessage(HVar11,0x407,iDst + 1,0);
      if (((pProdGlob + iSrc)->dwFlags & 0x3ff) == 0) {
        sVar30 = -1;
        HVar11 = GetDlgItem(hwnd,0x416);
        FillProdSrcLB(HVar11,sVar30);
      }
      goto PRODUCE_RedrawText;
    }
    if (wParam != 0x419) {
      if (wParam != 0x42d) {
        if ((wParam == 0x42e) || (wParam == 0x42f)) {
          if (wParam == 0x42f) {
            c = 1;
          }
          else {
            c = -1;
          }
          FinishProduction(1);
          sVar30 = GetKeyState(0x10);
          if (sVar30 < 0) {
            sVar30 = IdFindAdjStarbase(sel.pl.id,(uint)(wParam == 0x42f));
            SelectAdjPlanet(0,sVar30);
          }
          else {
            SelectAdjPlanet(c,0);
          }
          InitProduction((PROD *)0x0);
          InitializeProductionDlg(hwnd);
          GetClientRect(hwnd,(RECT *)&rc);
          rc.top = yTopFutureTech;
          rc.bottom = dyArial8 * 9 + yTopFutureTech;
          InvalidateRect(hwnd,(RECT *)&rc,1);
          return;
        }
        if (wParam == 0x439) {
          HVar11 = GetDlgItem(hwnd,0x417);
          LVar21 = SendMessage(HVar11,0x409,0,0);
          if (LVar21 < 2) {
            return;
          }
          uVar29 = (undefined2)((ulong)lpplProdGlob >> 0x10);
          pPVar16 = (PLPROD *)lpplProdGlob;
          iMac = (short)pPVar16->iprodMac;
          lSel._0_2_ = (uint)LVar21 - 2;
          lSel._2_2_ = (int)((ulong)LVar21 >> 0x10) - (uint)((uint)LVar21 < 2);
          lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar26);
          uVar19 = *puVar18;
          uVar29 = puVar18[1];
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar6 = lpplProdGlob._2_2_;
          lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar26);
          uVar5 = *puVar18;
          uVar6 = puVar18[1];
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar9 = lpplProdGlob._2_2_;
          lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar26);
          *puVar18 = uVar5;
          puVar18[1] = uVar6;
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar5 = lpplProdGlob._2_2_;
          lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar26);
          *puVar18 = uVar19;
          puVar18[1] = uVar29;
          uVar29 = 0;
          pPVar28 = (PLANET *)0x0;
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar19 = lpplProdGlob._2_2_;
          HVar11 = GetDlgItem(hwnd,0x417);
          FillPlanetProdLB
                    (HVar11,(PLPROD *)CONCAT22(uVar19,pPVar16),(PLANET *)CONCAT22(uVar29,pPVar28));
          HVar11 = GetDlgItem(hwnd,0x417);
          SendMessage(HVar11,0x407,(uint)lSel + 1,0);
          goto PRODUCE_RedrawText;
        }
        if (wParam == 0x43a) {
          HVar11 = GetDlgItem(hwnd,0x417);
          LVar21 = SendMessage(HVar11,0x409,0,0);
          uVar12 = (uint)LVar21;
          uVar19 = (undefined2)((ulong)lpplProdGlob >> 0x10);
          pPVar16 = (PLPROD *)lpplProdGlob;
          iMac = (short)pPVar16->iprodMac;
          if (LVar21 < 1) {
            return;
          }
          if (-1 < LVar21) {
            if (0xffff < LVar21) {
              return;
            }
            if ((uint)iMac <= uVar12) {
              return;
            }
          }
          lSel._0_2_ = uVar12 - 1;
          lSel._2_2_ = (int)((ulong)LVar21 >> 0x10) - (uint)(uVar12 == 0);
          lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar26);
          uVar29 = *puVar18;
          uVar19 = puVar18[1];
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar6 = lpplProdGlob._2_2_;
          lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar26);
          uVar5 = *puVar18;
          uVar6 = puVar18[1];
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar9 = lpplProdGlob._2_2_;
          lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar26);
          *puVar18 = uVar5;
          puVar18[1] = uVar6;
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar5 = lpplProdGlob._2_2_;
          lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar26);
          *puVar18 = uVar29;
          puVar18[1] = uVar19;
          uVar29 = 0;
          pPVar28 = (PLANET *)0x0;
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar19 = lpplProdGlob._2_2_;
          HVar11 = GetDlgItem(hwnd,0x417);
          FillPlanetProdLB
                    (HVar11,(PLPROD *)CONCAT22(uVar19,pPVar16),(PLANET *)CONCAT22(uVar29,pPVar28));
          HVar11 = GetDlgItem(hwnd,0x417);
          SendMessage(HVar11,0x407,(uint)lSel + 2,0);
          goto PRODUCE_RedrawText;
        }
        if (wParam != 0x816) {
          return;
        }
      }
      ipl = 0;
      while( true ) {
        uVar19 = (undefined2)((ulong)lpplProdGlob >> 0x10);
        if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= ipl) break;
        for (iSrc = 0; iSrc < cProdGlob; iSrc = iSrc + 1) {
          uVar25 = __aFulshr(uVar22,in_stack_0000ffc2);
          uVar23 = __aFulshr(uVar22,in_stack_0000ffc2);
          if (((uint)uVar25 & 7) == ((uint)uVar23 & 7)) {
            uVar25 = __aFulshr(uVar22,in_stack_0000ffc2);
            uVar23 = __aFulshr(uVar22,in_stack_0000ffc2);
            if (((uint)uVar25 & 0x7f) == ((uint)uVar23 & 0x7f)) break;
          }
        }
        if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
          lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
          lpplprodT._2_2_ = (int)lVar26 + (int)(pProdGlob + iSrc)->dwFlags & 0x3ff;
          pPVar15 = pProdGlob + iSrc;
          pPVar1 = pPVar15;
          *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
          puVar2 = (undefined2 *)((int)&pPVar15->dwFlags + 2);
          *puVar2 = *puVar2;
          pPVar15 = pProdGlob + iSrc;
          pPVar1 = pPVar15;
          *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags | lpplprodT._2_2_;
          puVar2 = (undefined2 *)((int)&pPVar15->dwFlags + 2);
          *puVar2 = *puVar2;
        }
        ipl = ipl + 1;
      }
      if (wParam == 0x816) {
        uVar25 = __aFulmul(lParam,0x28);
        cMax = (uint)((PLPROD *)lpplProdGlob)->iprodMac +
               (uint)*(byte *)((int)&vrgZipProd[0].cpq + (int)uVar25);
        if (cMax == 0) {
          cMax = 1;
        }
        pPVar24 = LpplAlloc(4,cMax,htOrd);
        uVar19 = (undefined2)((ulong)pPVar24 >> 0x10);
        pPVar8 = (PL *)pPVar24;
        __fmemset((PL *)CONCAT22(uVar19,pPVar8 + 1),0,cMax << 2);
        iDst = 0;
        for (iSrc = 0; iSrc < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; iSrc = iSrc + 1)
        {
          uVar25 = __aFulshr(uVar22,in_stack_0000ffc2);
          if ((((uint)uVar25 & 7) != 1) ||
             (uVar25 = __aFulshr(uVar22,in_stack_0000ffc2), 6 < ((uint)uVar25 & 0x7f))) {
            uVar29 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iSrc + 1].iprodMax;
            (pPVar8 + iDst + 1)->wFlags = ((PLPROD *)lpplProdGlob + iSrc + 1)->wFlags;
            *(undefined2 *)&pPVar8[iDst + 1].iMax = uVar29;
            iDst = iDst + 1;
          }
        }
        iSrc = 0;
        while (uVar25 = __aFulmul(lParam,0x28),
              iSrc < (int)(uint)*(byte *)((int)&vrgZipProd[0].cpq + (int)uVar25)) {
          sVar30 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
          if (((sVar30 != raMacintosh) ||
              (uVar25 = __aFulmul(lParam,0x28),
              2 < (*(uint *)((int)uVar25 + 0x2306 + iSrc * 2) & 0x3f))) &&
             ((sVar30 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
              sVar30 != raTerra ||
              ((uVar25 = __aFulmul(lParam,0x28),
               (*(uint *)((int)uVar25 + 0x2306 + iSrc * 2) & 0x3f) != 4 &&
               (uVar25 = __aFulmul(lParam,0x28),
               (*(uint *)((int)uVar25 + 0x2306 + iSrc * 2) & 0x3f) != 5)))))) {
            uVar12 = *(uint *)&pPVar8[iDst + 1].iMax;
            (pPVar8 + iDst + 1)->wFlags = (pPVar8 + iDst + 1)->wFlags;
            *(uint *)&pPVar8[iDst + 1].iMax = uVar12 & 0xfff1 | 2;
            __aFulmul(lParam,0x28);
            lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
            uVar12 = *(uint *)&pPVar8[iDst + 1].iMax;
            (pPVar8 + iDst + 1)->wFlags = (pPVar8 + iDst + 1)->wFlags & 0x3ffU | (uint)lVar26;
            *(uint *)&pPVar8[iDst + 1].iMax = uVar12 & 0xfffe | (uint)((ulong)lVar26 >> 0x10);
            __aFulmul(lParam,0x28);
            lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
            uVar12 = *(uint *)&pPVar8[iDst + 1].iMax;
            (pPVar8 + iDst + 1)->wFlags = (pPVar8 + iDst + 1)->wFlags & 0xfc00U | (uint)lVar26;
            *(uint *)&pPVar8[iDst + 1].iMax = uVar12 | (uint)((ulong)lVar26 >> 0x10);
            iDst = iDst + 1;
          }
          iSrc = iSrc + 1;
        }
        pPVar8->iMac = (byte)iDst;
        FreePl((PL *)lpplProdGlob);
        lpplProdGlob = (PLPROD *)pPVar24;
        __aFulmul(lParam,0x28);
        lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
        uVar32 = (ushort)uVar22;
        sel.pl.dwFlags._0_2_ = (uint)sel.pl.dwFlags | (uint)lVar26;
        sel.pl.dwFlags._2_2_ =
             sel.pl.dwFlags._2_2_ & 0xff7f | (uint)((ulong)lVar26 >> 0x10);
        HVar11 = GetDlgItem(hwnd,0x8b);
        UVar31 = 0x401;
        uVar22 = __aFulshr(CONCAT22(HVar11,0x401),uVar32);
        SendMessage(HVar11,UVar31,(uint)uVar22 & 1,0);
      }
      else {
        ((PLPROD *)lpplProdGlob)->iprodMac = 0;
      }
      uVar29 = 0;
      pPVar28 = (PLANET *)0x0;
      pPVar16 = (PLPROD *)lpplProdGlob;
      uVar19 = lpplProdGlob._2_2_;
      HVar11 = GetDlgItem(hwnd,0x417);
      FillPlanetProdLB
                (HVar11,(PLPROD *)CONCAT22(uVar19,pPVar16),(PLANET *)CONCAT22(uVar29,pPVar28));
      HVar11 = GetDlgItem(hwnd,0x417);
      SendMessage(HVar11,0x407,0,0);
      sVar30 = -1;
      HVar11 = GetDlgItem(hwnd,0x416);
      FillProdSrcLB(HVar11,sVar30);
      HVar11 = GetDlgItem(hwnd,0x416);
      SendMessage(HVar11,0x407,0,0);
      goto PRODUCE_RedrawText;
    }
  }
  HVar11 = GetDlgItem(hwnd,0x417);
  LVar21 = SendMessage(HVar11,0x409,0,0);
  if (LVar21 < 1) {
    return;
  }
  uVar19 = (undefined2)((ulong)lpplProdGlob >> 0x10);
  pPVar16 = (PLPROD *)lpplProdGlob;
  iMac = (short)pPVar16->iprodMac;
  lSel._0_2_ = (int)LVar21 - 1;
  lSel._2_2_ = (int)((ulong)LVar21 >> 0x10) - (uint)((int)LVar21 == 0);
  lVar26 = __aFlshl(uVar22,in_stack_0000ffc2);
  uVar12 = *(uint *)((int)&pPVar16[1].wFlags + (int)lVar26);
  for (iSrc = 0; iSrc < cProdGlob; iSrc = iSrc + 1) {
    uVar25 = __aFulshr(uVar22,in_stack_0000ffc2);
    lpplprodT._2_2_ = (uint)uVar25 & 7;
    uVar25 = __aFulshr(uVar22,in_stack_0000ffc2);
    if (lpplprodT._2_2_ == ((uint)uVar25 & 7)) {
      uVar25 = __aFulshr(uVar22,in_stack_0000ffc2);
      lpplprodT._2_2_ = (uint)uVar25 & 0x7f;
      uVar25 = __aFulshr(uVar22,in_stack_0000ffc2);
      if (lpplprodT._2_2_ == ((uint)uVar25 & 0x7f)) break;
    }
  }
  uVar14 = (ushort)uVar22;
  fRefillSrc = (short)(((pProdGlob + iSrc)->dwFlags & 0x3ff) == 0);
  uVar32 = 0x11;
  uVar10 = GetAsyncKeyState(0x11);
  if ((uVar10 & 0xfffe) == 0) {
    uVar19 = 0x10;
    uVar10 = GetAsyncKeyState(0x10);
    if ((uVar10 & 0xfffe) == 0) {
      c = 1;
    }
    else {
      c = 10;
    }
  }
  else {
    uVar19 = 0x10;
    uVar10 = GetAsyncKeyState(0x10);
    if ((uVar10 & 0xfffe) == 0) {
      c = 100;
    }
    else {
      c = 0x3fc;
    }
  }
  uVar22 = __aFulshr(CONCAT22(uVar32,uVar19),uVar14);
  if ((((uint)uVar22 & 7) == 1) &&
     (uVar22 = __aFulshr(CONCAT22(uVar32,uVar19),uVar14), ((uint)uVar22 & 0x7f) == 3)) {
    c = 0x3fc;
  }
  uVar10 = c;
  if ((int)(uVar12 & 0x3ff) <= c) {
    uVar10 = uVar12 & 0x3ff;
  }
  if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
    lVar26 = (pProdGlob + iSrc)->dwFlags;
    pPVar15 = pProdGlob + iSrc;
    pPVar1 = pPVar15;
    *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
    puVar2 = (undefined2 *)((int)&pPVar15->dwFlags + 2);
    *puVar2 = *puVar2;
    pPVar15 = pProdGlob + iSrc;
    pPVar1 = pPVar15;
    *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags | uVar10 + (int)lVar26 & 0x3ff;
    puVar2 = (undefined2 *)((int)&pPVar15->dwFlags + 2);
    *puVar2 = *puVar2;
  }
  pPVar16 = (PLPROD *)lpplProdGlob;
  uVar29 = lpplProdGlob._2_2_;
  c = uVar10;
  lVar26 = __aFlshl(CONCAT22(uVar32,uVar19),uVar14);
  lpplprodT._2_2_ = *(int *)((int)&pPVar16[1].wFlags + (int)lVar26) - uVar10 & 0x3ff;
  pPVar16 = (PLPROD *)lpplProdGlob;
  uVar29 = lpplProdGlob._2_2_;
  lVar26 = __aFlshl(CONCAT22(uVar32,uVar19),uVar14);
  puVar17 = (uint *)((int)&pPVar16[1].wFlags + (int)lVar26);
  puVar3 = puVar17;
  *puVar3 = *puVar3 & 0xfc00;
  puVar3 = puVar17 + 1;
  *puVar3 = *puVar3;
  uVar29 = lpplProdGlob._2_2_;
  pPVar16 = (PLPROD *)lpplProdGlob + 1;
  lVar26 = __aFlshl(CONCAT22(uVar32,uVar19),uVar14);
  puVar17 = (uint *)((int)&pPVar16->wFlags + (int)lVar26);
  puVar3 = puVar17;
  *puVar3 = *puVar3 | lpplprodT._2_2_;
  puVar3 = puVar17 + 1;
  *puVar3 = *puVar3;
  pPVar16 = (PLPROD *)lpplProdGlob;
  uVar29 = lpplProdGlob._2_2_;
  lVar26 = __aFlshl(CONCAT22(uVar32,uVar19),uVar14);
  if ((*(uint *)((int)&pPVar16[1].wFlags + (int)lVar26) & 0x3ff) == 0) {
    iVar13 = lSel._2_2_ + (uint)(0xfffe < (uint)lSel);
    if ((iMac >> 0xf < iVar13) || ((iMac >> 0xf <= iVar13 && ((uint)iMac <= (uint)lSel + 1)))) {
      bVar20 = (uint)lSel == 0;
      lSel._0_2_ = (uint)lSel - 1;
      lSel._2_2_ = lSel._2_2_ - (uint)bVar20;
    }
    else {
      uVar14 = ((iMac - (uint)lSel) + -1) * 4;
      pPVar16 = (PLPROD *)lpplProdGlob;
      uVar29 = lpplProdGlob._2_2_;
      lVar26 = __aFlshl(CONCAT22(uVar19,uVar14),uVar32);
      pvVar27 = (void *)((int)&pPVar16[1].wFlags + (int)lVar26);
      pPVar16 = (PLPROD *)lpplProdGlob;
      uVar19 = lpplProdGlob._2_2_;
      lVar26 = __aFlshl((long)CONCAT22(uVar29,pvVar27),uVar14);
      __fmemmove((void *)CONCAT22(uVar19,(void *)((int)&pPVar16[1].wFlags + (int)lVar26)),
                         (void *)CONCAT22(uVar29,pvVar27),uVar14);
    }
    pbVar4 = &((PLPROD *)lpplProdGlob)->iprodMac;
    *pbVar4 = *pbVar4 - 1;
  }
  uVar29 = 0;
  pPVar28 = (PLANET *)0x0;
  pPVar16 = (PLPROD *)lpplProdGlob;
  uVar19 = lpplProdGlob._2_2_;
  HVar11 = GetDlgItem(hwnd,0x417);
  FillPlanetProdLB
            (HVar11,(PLPROD *)CONCAT22(uVar19,pPVar16),(PLANET *)CONCAT22(uVar29,pPVar28));
  if (-1 < lSel._2_2_) {
    HVar11 = GetDlgItem(hwnd,0x417);
    SendMessage(HVar11,0x407,(uint)lSel + 1,0);
  }
  if (fRefillSrc != 0) {
    sVar30 = -1;
    HVar11 = GetDlgItem(hwnd,0x416);
    FillProdSrcLB(HVar11,sVar30);
  }
PRODUCE_RedrawText:
  GetClientRect(hwnd,(RECT *)&rc);
  rc.top = yTopFutureTech;
  rc.bottom = dyArial8 * 7 + yTopFutureTech;
  rc.left = rc.left + 0x82;
  InvalidateRect(hwnd,(RECT *)&rc,1);
  DrawProductionDlg(hwnd,0,&rc,-1);
  return;
}



// ======================================================================
// Function: InitializeProductionDlg
// Address: 10d0:3430
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d0353f) */
/* WARNING: Removing unreachable block (ram,0x10d0351f) */
/* WARNING: Removing unreachable block (ram,0x10d03544) */
/* WARNING: Variable defined which should be unmapped: i */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Variable defined which should be unmapped: iSel */

void InitializeProductionDlg(HWND hwnd)

{
  char *pcVar1;
  char *pcVar2;
  HWND HVar3;
  PLPROD *pPVar4;
  undefined2 unaff_SS;
  ulong uVar5;
  undefined2 uVar6;
  PROD *pPStack_64;
  PROD *lpprod;
  short iSel;
  short i;
  char rgch [88];
  
  pcVar1 = PszGetPlanetName(sel.pl.id);
  uVar6 = 0x1120;
  pcVar2 = PszGetCompressedString(idsProductionQueueS);
  wsprintf((char *)rgch,(char *)pcVar2,pcVar1,uVar6);
  stack0xffa0 = (LPCSTR)rgch;
  SetWindowText(hwnd,stack0xffa0);
  HVar3 = GetDlgItem(hwnd,0x416);
  FillProdSrcLB(HVar3,-1);
  HVar3 = GetDlgItem(hwnd,0x416);
  SendMessage(HVar3,0x407,0,0);
  i = 0;
  stack0xffa0 = (LPCSTR)lpplProdGlob._2_2_;
  while( true ) {
    uVar6 = (undefined2)((ulong)lpplProdGlob >> 0x10);
    pPVar4 = (PLPROD *)lpplProdGlob;
    if ((int)(uint)pPVar4->iprodMac <= i) break;
    uVar5 = __aFulshr((ulong)stack0xffa0,i);
    if ((((uint)uVar5 & 7) != 1) ||
       (uVar5 = __aFulshr((ulong)stack0xffa0,i), 6 < ((uint)uVar5 & 0x7f))) {
      stack0xffa0 = (LPCSTR)CONCAT22(i,lpprod._2_2_);
    }
    i = i + 1;
  }
  HVar3 = GetDlgItem(hwnd,0x417);
  FillPlanetProdLB(HVar3,(PLPROD *)CONCAT22(uVar6,pPVar4),(PLANET *)0x0);
  HVar3 = GetDlgItem(hwnd,0x417);
  SendMessage(HVar3,0x407,iSel + 1,0);
  HVar3 = GetDlgItem(hwnd,0x8b);
  pPStack_64 = (PROD *)CONCAT22(HVar3,0x401);
  uVar5 = __aFulshr((ulong)pPStack_64,lpprod._2_2_);
  SendMessage(HVar3,0x401,(uint)uVar5 & 1,0);
  return;
}



// ======================================================================
// Function: DrawProductionDlg
// Address: 10d0:35dc
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d036d8) */
/* WARNING: Removing unreachable block (ram,0x10d0372f) */

void DrawProductionDlg(HWND hwnd,HDC hdc,RECT *prc,short iDraw)

{
  long lVar1;
  bool bVar2;
  PLPROD *pPVar3;
  char *pcVar4;
  HWND HVar5;
  short sVar6;
  int iVar7;
  uint uVar8;
  uint *puVar9;
  char *unaff_SI;
  HDC unaff_DI;
  undefined2 unaff_SS;
  DWORD DVar10;
  long lVar11;
  ulong uVar12;
  undefined2 uVar13;
  ushort uVar14;
  HDC HVar15;
  ushort in_stack_0000ff6a;
  PROD prod;
  undefined8 rc;
  short k;
  short dxkT;
  undefined4 rgCost;
  short c;
  short i;
  short fCreatedDC;
  short idc;
  short iSrc;
  undefined4 lSel;
  
  fCreatedDC = 0;
  if (hdc == 0) {
    fCreatedDC = 1;
    hdc = GetDC(hwnd);
  }
  SelectObject(hdc,rghfontArial8[0]);
  HVar15 = hdc;
  pcVar4 = PszGetCompressedString(idsKt);
  DVar10 = GetTextExtent(HVar15,(LPCSTR)pcVar4,2);
  dxkT = (short)DVar10;
  SelectObject(hdc,rghfontArial8[1]);
  SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  lVar11 = CONCAT22(lSel._2_2_,(int)lSel);
  i = 0;
  do {
    lSel = lVar11;
    if (1 < i) {
      GetClientRect(hwnd,(RECT *)(RECT *)&rc);
      rc._2_2_ = rc._6_2_ - ((dyArial8 * 5) / 2 + 0xc);
      rc._6_2_ = (dyArial8 | 1U) + rc._2_2_;
      rc._0_2_ = 6;
      rc._4_2_ = dyArial8 + 6;
      DrawDiamond(hdc,(RECT *)&rc,hbrBBlue);
      rcProdDiamond.left = (int)rc;
      rcProdDiamond.top = rc._2_2_;
      rcProdDiamond.right = rc._4_2_;
      rcProdDiamond.bottom = rc._6_2_;
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsApplyDefineProductionTemplate,(char *)szWork);
      TextOut(hdc,rc._4_2_ + 4,rc._2_2_,szWork,c);
      if (fCreatedDC != 0) {
        ReleaseDC(hwnd,hdc);
      }
      return;
    }
    if (i == 0) {
      idc = 0x416;
    }
    else {
      idc = 0x417;
    }
    HVar5 = GetDlgItem(hwnd,idc);
    GetWindowRect(HVar5,(RECT *)(RECT *)&rc);
    ScreenToClient(hwnd,(POINT *)(POINT *)&rc);
    ScreenToClient(hwnd,(POINT *)(POINT *)((int)&rc + 4));
    HVar5 = GetDlgItem(hwnd,idc);
    lVar11 = SendMessage(HVar5,0x409,0,0);
    uVar13 = lpplProdGlob._2_2_;
    pPVar3 = (PLPROD *)lpplProdGlob;
    if ((-1 < lVar11) && ((lVar11 != 0 || (i != 1)))) {
      if (i == 0) {
        iSrc = 0;
        while( true ) {
          lSel._2_2_ = (int)((ulong)lVar11 >> 0x10);
          lSel._0_2_ = (int)lVar11;
          lVar1 = lVar11;
          if (cProdGlob <= iSrc) break;
          if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0) {
            lSel._2_2_ = lSel._2_2_ - (uint)((int)lSel == 0);
            lVar1 = CONCAT22(lSel._2_2_,(int)lSel + -1);
            bVar2 = lVar11 == 0;
            lVar11 = CONCAT22(lSel._2_2_,(int)lSel + -1);
            if (bVar2) break;
          }
          iSrc = iSrc + 1;
        }
        prod.dwFlags._2_2_ = *(uint *)((int)&pProdGlob[iSrc].dwFlags + 2);
        prod.dwFlags._0_2_ = (uint)(pProdGlob + iSrc)->dwFlags & 0xfc00 | 1;
      }
      else {
        lSel._0_2_ = (int)lVar11 + -1;
        lSel._2_2_ = (int)((ulong)lVar11 >> 0x10) - (uint)((int)lVar11 == 0);
        lVar11 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff6a);
        lVar1 = CONCAT22(lSel._2_2_,(int)lSel);
        puVar9 = (uint *)((int)&pPVar3[1].wFlags + (int)lVar11);
        prod.dwFlags._0_2_ = *puVar9;
        prod.dwFlags._2_2_ = puVar9[1];
      }
      lSel = lVar1;
      GetProductionCosts(&sel.pl,(PROD *)&prod,&rgCost,idPlayer,0);
      rc._6_2_ = yTopFutureTech + 4;
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsRequiredMinerals,(char *)szWork);
      TextOut(hdc,(int)rc,rc._6_2_,szWork,c);
      rc._0_2_ = (int)rc + 0x14;
      rc._4_2_ = rc._4_2_ + -0x14;
      for (k = 0; k < 4; k = k + 1) {
        c = k;
        if (k == 3) {
          c = 5;
        }
        rc._6_2_ = rc._6_2_ + dyArial8;
        SelectObject(hdc,rghfontArial8[1]);
        SetTextColor(hdc,CONCAT22(*(undefined2 *)(c * 4 + 0x44a),*(undefined2 *)(c * 4 + 0x448)));
        pcVar4 = (char *)*(undefined2 *)(c * 2 + 0x4cc);
        uVar13 = 0x1120;
        uVar14 = rc._6_2_;
        iVar7 = (int)rc;
        HVar15 = hdc;
        sVar6 = lstrlen((LPCSTR)(char *)*(undefined2 *)(c * 2 + 0x4cc));
        TextOut(HVar15,iVar7,uVar14,(LPCSTR)CONCAT22(uVar13,pcVar4),sVar6);
        SelectObject(hdc,rghfontArial8[0]);
        SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
        c = wsprintf(szWork,(char *)PCTLD,*(undefined2 *)(&rgCost + k),
                     *(undefined2 *)((int)&rgCost + k * 4 + 2));
        unaff_SI = (char *)((rc._4_2_ - dxkT) + -2);
        unaff_DI = hdc;
        in_stack_0000ff6a = rc._6_2_;
        RightTextOut
                  (hdc,(short)unaff_SI,rc._6_2_,(char *)szWork,c,
                   dxMaxMineralQuan);
        if (k < 3) {
          iVar7 = rc._4_2_ - dxkT;
          uVar14 = rc._6_2_;
          HVar15 = hdc;
          unaff_SI = PszGetCompressedString(idsKt);
          in_stack_0000ff6a = 0x1120;
          unaff_DI = 2;
          TextOut(HVar15,iVar7,uVar14,(LPCSTR)unaff_SI,2);
        }
      }
      lVar11 = lSel;
      if (i != 0) {
        rc._6_2_ = rc._6_2_ + (dyArial8 * 3) / 2;
        SelectObject(hdc,rghfontArial8[1]);
        uVar12 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff6a);
        uVar8 = (uint)uVar12 & 0x7f;
        pcVar4 = PszGetCompressedString(idsDDoneCompletion);
        c = wsprintf((char *)&stack0xff6a,(char *)pcVar4,uVar8);
        PszProductionETA
                  (&sel.pl,
                   (PLPROD *)CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob),
                   (int)lSel,(short *)0x0,(short *)0x0);
        _strcpy(&stack0xff6a + c,(char *)szWork);
        iVar7 = (int)rc + -0x14;
        unaff_SI = &stack0xff6a;
        uVar13 = unaff_SS;
        uVar14 = rc._6_2_;
        HVar15 = hdc;
        unaff_DI = _strlen(&stack0xff6a);
        TextOut(HVar15,iVar7,uVar14,(LPCSTR)CONCAT22(uVar13,unaff_SI),unaff_DI);
        in_stack_0000ff6a = 0x3a39;
        SelectObject(hdc,rghfontArial8[0]);
        lVar11 = lSel;
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FillProdSrcLB
// Address: 10d0:3b00
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d03c3a) */
/* WARNING: Removing unreachable block (ram,0x10d03bce) */
/* WARNING: Removing unreachable block (ram,0x10d03b6b) */
/* WARNING: Removing unreachable block (ram,0x10d03b66) */
/* WARNING: Removing unreachable block (ram,0x10d03bfb) */
/* WARNING: Removing unreachable block (ram,0x10d03bf6) */
/* WARNING: Removing unreachable block (ram,0x10d03c3f) */

void FillProdSrcLB(HWND hwndLB,short mdFill)

{
  char *pcVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar2;
  ulong uVar3;
  short i;
  undefined1 szT [6];
  char local_4e [76];
  
  uVar3 = CONCAT22(unaff_SI,unaff_DI);
  for (i = 0; i < 6; i = i + 1) {
    szT[i] = 0x20;
  }
  SendMessage(hwndLB,0x405,0,0);
  for (i = 0; i < cProdGlob; i = i + 1) {
    if (((pProdGlob + i)->dwFlags & 0x3ff) != 0) {
      pcVar1 = PszNameProdItem((PROD *)(pProdGlob + i));
      _strcpy(local_4e,pcVar1);
      uVar2 = __aFulshr(uVar3,(ushort)pcVar1);
      if (((uint)uVar2 & 7) == 2) {
        uVar2 = __aFulshr(uVar3,(ushort)pcVar1);
        if (((uint)uVar2 & 0x7f) < 0x10) {
          szT[0] = 0x2a;
        }
        else {
          szT[0] = 0x23;
        }
      }
      else {
        uVar2 = __aFulshr(uVar3,(ushort)pcVar1);
        if (((uint)uVar2 & 0x7f) < 7) {
          szT[0] = 0x49;
          _strcat(local_4e,(char *)s__Auto_Build__1120_0cda);
        }
        else {
          szT[0] = 0x20;
        }
      }
      SendMessage(hwndLB,0x401,0,(LPARAM)szT);
    }
  }
  return;
}



// ======================================================================
// Function: PszNameProdItem
// Address: 10d0:3c92
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d03cde) */
/* WARNING: Removing unreachable block (ram,0x10d03ce7) */
/* WARNING: Removing unreachable block (ram,0x10d03e82) */
/* WARNING: Removing unreachable block (ram,0x10d03ee7) */
/* WARNING: Removing unreachable block (ram,0x10d03e99) */
/* WARNING: Removing unreachable block (ram,0x10d03e87) */
/* WARNING: Removing unreachable block (ram,0x10d03e9e) */
/* WARNING: Removing unreachable block (ram,0x10d03cec) */

char * PszNameProdItem(PROD *lpprod)

{
  int iVar1;
  int iVar2;
  uint uVar3;
  int iVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar5;
  ulong uVar6;
  PLANETARY *pPVar7;
  ushort in_stack_0000fff4;
  short iDelta;
  
  uVar6 = CONCAT22(unaff_SI,unaff_DI);
  uVar5 = __aFulshr(uVar6,in_stack_0000fff4);
  uVar3 = (uint)uVar5 & 0x7f;
  uVar6 = __aFulshr(uVar6,in_stack_0000fff4);
  if (((uint)uVar6 & 7) == 2) {
    if (uVar3 < 0x10) {
      uVar6 = __aFulmul(uVar5 & 0x7f,0x93);
      if ((*(uint *)((int)&rgshdef[0].wFlags + (int)uVar6) >> 9 & 1) == 0) {
        uVar5 = __aFulmul(uVar5 & 0x7f,0x93);
        _strcpy((char *)szWork,
                        (char *)((int)&rgshdef[0].hul + 8 + (int)uVar5));
        goto LAB_10d0_3f19;
      }
    }
    else {
      iVar1 = uVar3 - 0x10;
      iVar2 = -(uint)(uVar3 < 0x10);
      uVar5 = __aFulmul(CONCAT22(iVar2,iVar1),0x93);
      if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + (int)uVar5 + 0x7b) >> 9 & 1) == 0) {
        uVar5 = __aFulmul(CONCAT22(iVar2,iVar1),0x93);
        __fstrcpy(szWork,
                          (char *)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x14e),
                                           (char *)(*(int *)(idPlayer * 4 + 0x14c) +
                                                    (int)uVar5 + 8)));
        if (((uint)sel.pl.wFlags >> 9 & 1) != 0) {
          iVar4 = *(int *)(*(int *)(idPlayer * 4 + 0x14c) +
                          (sel.pl._44_2_ & 0xf) * 0x93);
          uVar5 = __aFulmul(CONCAT22(iVar2,iVar1),0x93);
          iVar4 = iVar4 - *(int *)(*(int *)(idPlayer * 4 + 0x14c) + (int)uVar5);
          if (iVar4 < 1) {
            if (iVar4 < 0) {
              _strcat((char *)szWork,(char *)s__upgrade__1120_0cf5);
            }
          }
          else {
            _strcat((char *)szWork,(char *)s__downgrade__1120_0ce8);
          }
        }
        goto LAB_10d0_3f19;
      }
    }
    szWork[0] = '\0';
  }
  else if ((uVar3 < 0x12) || (0x1a < uVar3)) {
    if (uVar3 == 0x1b) {
      CchGetString(idsPlanetaryScanner,(char *)szWork);
    }
    else {
      CchGetString(uVar3 + idsMines,(char *)szWork);
    }
  }
  else {
    pPVar7 = LpplanetaryFromId(uVar3 - 0x12);
    __fstrcpy(szWork,
                      (char *)CONCAT22((int)((ulong)pPVar7 >> 0x10),((PLANETARY *)pPVar7)->szName));
  }
LAB_10d0_3f19:
  return (char *)szWork;
}



// ======================================================================
// Function: GetProductionCosts
// Address: 10d0:3f20
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d03faf) */
/* WARNING: Removing unreachable block (ram,0x10d03fa6) */

void GetProductionCosts(PLANET *lppl,PROD *lpprod,ulong *rgCost,short iplr,short fOnlyOne)

{
  int iVar1;
  ushort uVar2;
  short sVar3;
  PLANET *pPVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  bool bVar6;
  ulong uVar7;
  ushort *rgCost_00;
  undefined2 uVar8;
  ulong uVar9;
  ushort in_stack_0000ffac;
  ushort rgCostsPartNew [4];
  ushort rgCostsPartCur [4];
  short costHalf;
  short costUpg;
  HUL *lphulCur;
  HUL *lphulNew;
  short chs;
  short cost;
  PART part;
  short fStarbase;
  uint cItem;
  undefined2 local_24;
  short raMajor;
  int lpshdef;
  undefined2 local_1e;
  short j;
  short i;
  ushort rgCosts [4];
  uint iItem;
  int local_e;
  ushort rgCostsCur [5];
  
  uVar9 = CONCAT22(unaff_SI,unaff_DI);
  uVar5 = (undefined2)((ulong)lppl >> 0x10);
  pPVar4 = (PLANET *)lppl;
  raMajor = GetRaceStat((PLAYER *)rgplr + pPVar4->iPlayer,rsMajorAdv);
  fStarbase = 0;
  uVar7 = __aFulshr(uVar9,in_stack_0000ffac);
  iItem = (uint)uVar7 & 0x7f;
  local_e = 0;
  cItem = (uint)lpprod->dwFlags & 0x3ff;
  local_24 = 0;
  uVar7 = __aFulshr(uVar9,in_stack_0000ffac);
  if (((uint)uVar7 & 7) == 2) {
    if ((local_e == 0) && (iItem < 0x10)) {
      lpshdef = *(int *)(iplr * 4 + 0xfe);
      local_1e = *(undefined2 *)(iplr * 4 + 0x100);
    }
    else {
      lpshdef = *(int *)(iplr * 4 + 0x14c);
      local_1e = *(undefined2 *)(iplr * 4 + 0x14e);
      bVar6 = iItem < 0x10;
      iItem = iItem - 0x10;
      local_e = local_e - (uint)bVar6;
      fStarbase = 1;
    }
    uVar7 = __aFulmul(CONCAT22(local_e,iItem),0x93);
    if ((*(uint *)(lpshdef + (int)uVar7 + 0x7b) >> 9 & 1) != 0) {
      for (i = 0; i < 4; i = i + 1) {
        *(undefined2 *)(rgCost + i) = 0;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
      }
      return;
    }
    rgCost_00 = rgCosts;
    uVar7 = __aFulmul(CONCAT22(local_e,iItem),0x93);
    GetTrueHullCost(iplr,(HUL *)CONCAT22(local_1e,(HUL *)(lpshdef + (int)uVar7)),rgCost_00);
    if ((fStarbase != 0) && (((uint)pPVar4->wFlags >> 9 & 1) != 0)) {
      lphulCur = (HUL *)CONCAT22(*(undefined2 *)(iplr * 4 + 0x14e),
                                 (HUL *)(*(int *)(iplr * 4 + 0x14c) +
                                        (*(uint *)&pPVar4->field11_0x2c & 0xf) * 0x93));
      uVar7 = __aFulmul(CONCAT22(local_e,iItem),0x93);
      lphulNew = (HUL *)CONCAT22(local_1e,(HUL *)(lpshdef + (int)uVar7));
      GetTrueHullCost(iplr,lphulCur,rgCostsCur);
      if (lphulCur->ihuldef == lphulNew->ihuldef) {
        part.pcom = (COMPART *)LphuldefFromId(lphulCur->ihuldef);
        costUpg = (short)((ulong)part.pcom >> 0x10);
        costHalf = (short)part.pcom;
        part.hs.grhst =
             ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines
               |hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine);
        GetTruePartCost(iplr,&part,rgCostsPartCur);
        for (i = 0; i < 4; i = i + 1) {
          rgCosts[i] = rgCosts[i] - rgCostsPartCur[i];
        }
        chs = (uint)((HUL *)lphulCur)->chs;
        for (i = 0; i < chs; i = i + 1) {
          if ((uint)((HUL *)lphulCur)->rghs[i].wFlags >> 8 != 0) {
            if ((uint)((HUL *)lphulNew)->rghs[i].wFlags >> 8 != 0) {
              part.hs.grhst = (((HUL *)lphulCur)->rghs + i)->grhst;
              part.hs.wFlags = ((HUL *)lphulCur)->rghs[i].wFlags;
              FLookupPart(&part);
              GetTruePartCost(iplr,&part,rgCostsPartCur);
              part.hs.grhst = (((HUL *)lphulNew)->rghs + i)->grhst;
              part.hs.wFlags = ((HUL *)lphulNew)->rghs[i].wFlags;
              FLookupPart(&part);
              GetTruePartCost(iplr,&part,rgCostsPartNew);
              if ((((HUL *)lphulCur)->rghs + i)->grhst == (((HUL *)lphulNew)->rghs + i)->grhst) {
                if ((((HUL *)lphulCur)->rghs[i].wFlags & 0xffU) ==
                    (((HUL *)lphulNew)->rghs[i].wFlags & 0xffU)) {
                  for (j = 0; j < 4; j = j + 1) {
                    rgCostsPartCur[j] =
                         rgCostsPartCur[j] * ((uint)((HUL *)lphulCur)->rghs[i].wFlags >> 8);
                    rgCostsPartNew[j] =
                         rgCostsPartNew[j] * ((uint)((HUL *)lphulNew)->rghs[i].wFlags >> 8);
                    if (rgCostsPartNew[j] - rgCostsPartCur[j] < 0x8000) {
                      cost = rgCostsPartNew[j] - rgCostsPartCur[j];
                    }
                    else {
                      cost = 0;
                    }
                    if (rgCosts[j] < rgCostsPartNew[j] - cost) {
                      uVar2 = rgCosts[j];
                    }
                    else {
                      uVar2 = rgCostsPartNew[j] - cost;
                    }
                    rgCosts[j] = rgCosts[j] - uVar2;
                  }
                }
                else {
                  for (j = 0; j < 4; j = j + 1) {
                    rgCostsPartCur[j] =
                         rgCostsPartCur[j] * ((uint)((HUL *)lphulCur)->rghs[i].wFlags >> 8);
                    rgCostsPartNew[j] =
                         rgCostsPartNew[j] * ((uint)((HUL *)lphulNew)->rghs[i].wFlags >> 8);
                    if ((int)(rgCostsPartNew[j] - (int)(rgCostsPartCur[j] << 3) / 10) <
                        (int)(rgCostsPartNew[j] << 1) / 10) {
                      cost = (int)(rgCostsPartNew[j] << 1) / 10;
                    }
                    else {
                      cost = rgCostsPartNew[j] - (int)(rgCostsPartCur[j] << 3) / 10;
                    }
                    if (rgCosts[j] < rgCostsPartNew[j] - cost) {
                      uVar2 = rgCosts[j];
                    }
                    else {
                      uVar2 = rgCostsPartNew[j] - cost;
                    }
                    rgCosts[j] = rgCosts[j] - uVar2;
                  }
                }
              }
              else {
                for (j = 0; j < 4; j = j + 1) {
                  rgCostsPartCur[j] =
                       rgCostsPartCur[j] * ((uint)((HUL *)lphulCur)->rghs[i].wFlags >> 8);
                  rgCostsPartNew[j] =
                       rgCostsPartNew[j] * ((uint)((HUL *)lphulNew)->rghs[i].wFlags >> 8);
                  if ((int)(rgCostsPartNew[j] - (int)(rgCostsPartCur[j] * 7) / 10) <
                      (int)(rgCostsPartNew[j] * 3) / 10) {
                    cost = (int)(rgCostsPartNew[j] * 3) / 10;
                  }
                  else {
                    cost = rgCostsPartNew[j] - (int)(rgCostsPartCur[j] * 7) / 10;
                  }
                  if (rgCosts[j] < rgCostsPartNew[j] - cost) {
                    uVar2 = rgCosts[j];
                  }
                  else {
                    uVar2 = rgCostsPartNew[j] - cost;
                  }
                  rgCosts[j] = rgCosts[j] - uVar2;
                }
              }
            }
          }
        }
      }
      else {
        for (i = 0; i < 4; i = i + 1) {
          costHalf = rgCosts[i] / 2;
          costUpg = rgCosts[i] - (int)rgCostsCur[i] / 2;
          if (costUpg < costHalf) {
            rgCosts[i] = costHalf;
          }
          else {
            rgCosts[i] = costUpg;
          }
        }
      }
    }
    if ((fStarbase != 0) &&
       ((sVar3 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceISB), sVar3 != 0 ||
        (sVar3 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv),
        sVar3 == raMacintosh)))) {
      for (i = 0; i < 4; i = i + 1) {
        rgCosts[i] = rgCosts[i] - rgCosts[i] / 5;
      }
    }
    if (fStarbase == 0) {
      for (i = 0; i < 4; i = i + 1) {
        *(ushort *)(rgCost + i) = rgCosts[i];
        *(ushort *)((int)(rgCost + i) + 2) = 0;
      }
    }
    else {
      for (i = 0; i < 4; i = i + 1) {
        *(uint *)(rgCost + i) = (rgCosts[i] + 1) / 2;
        *(uint *)((int)(rgCost + i) + 2) = 0;
      }
    }
    goto LAB_10d0_4eef;
  }
  if ((iItem == 0) && (local_e == 0)) {
LAB_10d0_4915:
    for (i = 0; i < 3; i = i + 1) {
      *(undefined2 *)(rgCost + i) = 0;
      *(undefined2 *)((int)(rgCost + i) + 2) = 0;
    }
    sVar3 = GetRaceStat((PLAYER *)rgplr + iplr,rsMineBuild);
    *(short *)(rgCost + 3) = sVar3;
    *(int *)((int)rgCost + 0xe) = sVar3 >> 0xf;
    goto LAB_10d0_4eef;
  }
  if ((iItem == 1) && (local_e == 0)) {
LAB_10d0_4867:
    cost = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceCheapFact);
    if (((uint)gd._0_2_ >> 0xb & 1) == 0) {
      *(undefined2 *)(rgCost + 1) = 0;
      *(undefined2 *)((int)rgCost + 6) = 0;
      *(undefined2 *)rgCost = 0;
      *(undefined2 *)((int)rgCost + 2) = 0;
      *(int *)(rgCost + 2) = 4 - cost;
      *(int *)((int)rgCost + 10) = 4 - cost >> 0xf;
    }
    else {
      for (i = 0; i < 3; i = i + 1) {
        *(int *)(rgCost + i) = 2 - cost;
        *(int *)((int)(rgCost + i) + 2) = 2 - cost >> 0xf;
      }
    }
    sVar3 = GetRaceStat((PLAYER *)rgplr + iplr,rsFactBuild);
    *(short *)(rgCost + 3) = sVar3;
    *(int *)((int)rgCost + 0xe) = sVar3 >> 0xf;
  }
  else {
    if ((iItem == 2) && (local_e == 0)) {
LAB_10d0_4964:
      part.hs.grhst = hstPlanetary;
      part.hs.wFlags = part.hs.wFlags & 0xff00U | 9;
      FLookupPart(&part);
      i = 0;
      while( true ) {
        if (2 < i) break;
        iVar1 = ((HUL *)&((COMPART *)part.pcom)->id)->rgwtOreCost[i];
        *(int *)(rgCost + i) = iVar1;
        *(int *)((int)(rgCost + i) + 2) = iVar1 >> 0xf;
        i = i + 1;
      }
      *(short *)(rgCost + 3) = ((HUL *)&((COMPART *)part.pcom)->id)->resCost;
      *(undefined2 *)((int)rgCost + 0xe) = 0;
      sVar3 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
      if (sVar3 == raDefend) {
        for (i = 0; i < 4; i = i + 1) {
          uVar8 = 0;
          uVar5 = 5;
          uVar7 = __aFulmul(CONCAT22(*(undefined2 *)((int)(rgCost + i) + 2),(int)rgCost[i]),
                                    3);
          uVar7 = __aFuldiv(uVar7,CONCAT22(uVar8,uVar5));
          *(int *)(rgCost + i) = (int)uVar7;
          *(undefined2 *)((int)(rgCost + i) + 2) = (int)(uVar7 >> 0x10);
        }
      }
      goto LAB_10d0_4eef;
    }
    if ((iItem == 3) && (local_e == 0)) {
LAB_10d0_4a48:
      for (i = 0; i < 3; i = i + 1) {
        *(undefined2 *)(rgCost + i) = 0;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
      }
      sVar3 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceMineralAlchemy);
      if (sVar3 == 0) {
        uVar5 = 100;
      }
      else {
        uVar5 = 0x19;
      }
      *(undefined2 *)(rgCost + 3) = uVar5;
      *(undefined2 *)((int)rgCost + 0xe) = 0;
      goto LAB_10d0_4eef;
    }
    if (((iItem == 4) && (local_e == 0)) || ((iItem == 5 && (local_e == 0)))) {
LAB_10d0_4c24:
      *(undefined2 *)(rgCost + 2) = 0;
      *(undefined2 *)((int)rgCost + 10) = 0;
      *(undefined2 *)(rgCost + 1) = 0;
      *(undefined2 *)((int)rgCost + 6) = 0;
      *(undefined2 *)rgCost = 0;
      *(undefined2 *)((int)rgCost + 2) = 0;
      sVar3 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceTT);
      if (sVar3 == 0) {
        *(undefined2 *)(rgCost + 3) = 100;
        *(undefined2 *)((int)rgCost + 0xe) = 0;
      }
      else {
        *(undefined2 *)(rgCost + 3) = 0x46;
        *(undefined2 *)((int)rgCost + 0xe) = 0;
      }
      if (raMajor == 3) {
        uVar7 = __aFuldiv(CONCAT22(*(undefined2 *)((int)rgCost + 0xe),(int)rgCost[3]),2);
        *(int *)(rgCost + 3) = (int)uVar7;
        *(undefined2 *)((int)rgCost + 0xe) = (int)(uVar7 >> 0x10);
      }
      goto LAB_10d0_4eef;
    }
    if ((iItem != 6) || (local_e != 0)) {
      if ((iItem == 7) && (local_e == 0)) goto LAB_10d0_4867;
      if ((iItem == 8) && (local_e == 0)) goto LAB_10d0_4915;
      if ((iItem == 9) && (local_e == 0)) goto LAB_10d0_4964;
      if ((iItem == 0xb) && (local_e == 0)) goto LAB_10d0_4a48;
      if ((iItem == 0xc) && (local_e == 0)) goto LAB_10d0_4c24;
      if ((iItem == 0xd) && (local_e == 0)) {
        part.hs.grhst = hstPlanetary;
        part.hs.wFlags = part.hs.wFlags & 0xff00U | 0xe;
        FLookupPart(&part);
        GetTruePartCost(iplr,&part,rgCosts);
        for (i = 0; i < 4; i = i + 1) {
          *(ushort *)(rgCost + i) = rgCosts[i];
          *(ushort *)((int)(rgCost + i) + 2) = 0;
        }
        goto LAB_10d0_4eef;
      }
      if ((((iItem == 0xe) && (local_e == 0)) || ((iItem == 0xf && (local_e == 0)))) ||
         ((iItem == 0x10 && (local_e == 0)))) {
        if (raMajor == 6) {
          j = 0x46;
        }
        else if (raMajor == 7) {
          j = 0x78;
        }
        else {
          j = 0x6e;
        }
        for (i = 0; i < 3; i = i + 1) {
          if ((iItem - 0xe != i) || (sVar3 = j, local_e + -1 + (uint)(0xd < iItem) != 0)) {
            sVar3 = 0;
          }
          *(short *)(rgCost + i) = sVar3;
          *(undefined2 *)((int)(rgCost + i) + 2) = 0;
        }
        if (raMajor == 6) {
          uVar5 = 5;
        }
        else {
          uVar5 = 10;
        }
        *(undefined2 *)(rgCost + i) = uVar5;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
        goto LAB_10d0_4eef;
      }
      if ((iItem != 0x11) || (local_e != 0)) {
        if ((((((iItem != 0x12) || (local_e != 0)) &&
              (((iItem != 0x13 || (local_e != 0)) && ((iItem != 0x14 || (local_e != 0)))))) &&
             ((((iItem != 0x15 || (local_e != 0)) && ((iItem != 0x16 || (local_e != 0)))) &&
              ((iItem != 0x17 || (local_e != 0)))))) && ((iItem != 0x18 || (local_e != 0)))) &&
           (((iItem != 0x19 || (local_e != 0)) && ((iItem != 0x1a || (local_e != 0)))))) {
          if ((iItem != 0x1b) || (local_e != 0)) goto LAB_10d0_4eef;
          iItem = 0x12;
          local_e = 0;
        }
        part.hs.grhst = hstPlanetary;
        chs = iItem - 0x12;
        part.hs.wFlags = part.hs.wFlags & 0xff00U | chs & 0xffU;
        FLookupPart(&part);
        GetTruePartCost(iplr,&part,rgCosts);
        for (i = 0; i < 4; i = i + 1) {
          *(ushort *)(rgCost + i) = rgCosts[i];
          *(ushort *)((int)(rgCost + i) + 2) = 0;
        }
        goto LAB_10d0_4eef;
      }
    }
    if (raMajor == 6) {
      j = 0x19;
    }
    else if (raMajor == 7) {
      j = 0x30;
    }
    else {
      j = 0x2c;
    }
    for (i = 0; i < 3; i = i + 1) {
      *(short *)(rgCost + i) = j;
      *(undefined2 *)((int)(rgCost + i) + 2) = 0;
    }
    if (raMajor == 6) {
      uVar5 = 5;
    }
    else {
      uVar5 = 10;
    }
    *(undefined2 *)(rgCost + i) = uVar5;
    *(undefined2 *)((int)(rgCost + i) + 2) = 0;
  }
LAB_10d0_4eef:
  if (fOnlyOne == 0) {
    for (i = 0; i < 4; i = i + 1) {
      uVar7 = __aFulmul(CONCAT22(*(undefined2 *)((int)(rgCost + i) + 2),(int)rgCost[i]),
                                CONCAT22(local_24,cItem));
      *(int *)(rgCost + i) = (int)uVar7;
      *(undefined2 *)((int)(rgCost + i) + 2) = (int)(uVar7 >> 0x10);
    }
  }
  return;
}



// ======================================================================
// Function: EstimateItemProdSched
// Address: 10d0:4f40
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d05159) */
/* WARNING: Removing unreachable block (ram,0x10d050ac) */
/* WARNING: Removing unreachable block (ram,0x10d052cc) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10d05184) */
/* WARNING: Removing unreachable block (ram,0x10d051ac) */

void EstimateItemProdSched
          (PLANET *lppl,PLPROD *lpplprod,short iItem,short *piFirst,short *piLast)

{
  PLANET *pPVar1;
  PLANET *pPVar2;
  byte bVar3;
  PROD *pprodPartial;
  uint uVar4;
  int iVar5;
  PLPROD *pPVar6;
  undefined2 unaff_SI;
  PLANET *pPVar7;
  undefined2 unaff_DI;
  PLANET *pPVar8;
  undefined2 uVar9;
  undefined2 unaff_SS;
  bool bVar10;
  PL *pPVar11;
  ulong uVar12;
  ulong uVar13;
  long lVar14;
  undefined2 uVar15;
  ulong uVar16;
  uint in_stack_0000ff8a;
  ushort uVar17;
  PROD *lpprod;
  undefined4 rgRes;
  uint local_62;
  int local_60;
  short iMac;
  short fAlchemy;
  short iPass;
  short j;
  short i;
  short mdStatus;
  PROD prodPartial;
  short cBuilt;
  long rglQuan [3];
  PLANET pl;
  undefined4 cResearch;
  
  uVar16 = CONCAT22(unaff_SI,unaff_DI);
  if (((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) {
                    /* WARNING: Load size is inaccurate */
    lpplprod = (PLPROD *)
               CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                        ((PLANET *)lppl)->lpplprod);
  }
  pPVar8 = &pl;
  pPVar7 = (PLANET *)lppl;
  for (iVar5 = 0x1c; iVar5 != 0; iVar5 = iVar5 + -1) {
    pPVar2 = pPVar8;
    pPVar8 = (PLANET *)&pPVar8->iPlayer;
    pPVar1 = pPVar7;
    pPVar7 = (PLANET *)&pPVar7->iPlayer;
    pPVar2->id = pPVar1->id;
  }
  uVar9 = (undefined2)((ulong)lpplprod >> 0x10);
  pPVar6 = (PLPROD *)lpplprod;
  pPVar11 = LpplAlloc(4,(uint)pPVar6->iprodMax,htOrd);
  pl.lpplprod._2_2_ = (int)((ulong)pPVar11 >> 0x10);
  pl.lpplprod._0_2_ = (PLPROD *)pPVar11;
  __fmemcpy((PL *)CONCAT22(pl.lpplprod._2_2_,(PL *)(PLPROD *)pl.lpplprod + 1),
                    (PLPROD *)CONCAT22(uVar9,pPVar6 + 1),(uint)pPVar6->iprodMac << 2);
  bVar3 = pPVar6->iprodMac;
  ((PLPROD *)pl.lpplprod)->iprodMac = bVar3;
  iMac = (short)bVar3;
  prodPartial.dwFlags._0_2_ = (uint)prodPartial.dwFlags & 0xfc00;
  *piLast = 0;
  *piFirst = 0;
  iPass = 1;
  do {
    if (99 < iPass) {
      if (*piFirst == 0) {
        *piFirst = 100;
      }
      *piLast = 100;
      lVar14 = cResearch;
PRODUCE_LCleanUp:
      if (((PL *)(PLPROD *)pl.lpplprod != (PL *)0x0) || (pl.lpplprod._2_2_ != 0)) {
        cResearch = lVar14;
        FreePl((PL *)CONCAT22(pl.lpplprod._2_2_,(PLPROD *)pl.lpplprod));
      }
      return;
    }
    EstMineralsMined((PLANET *)&pl,rglQuan,-1,1);
    for (j = 0; j < 3; j = j + 1) {
      uVar9 = *(undefined2 *)((int)pl.rgwtMin + j * 4 + 2);
      iVar5 = j * 4;
      *(int *)(&rgRes + j) = (int)pl.rgwtMin[j];
      *(undefined2 *)((int)&rgRes + iVar5 + 2) = uVar9;
    }
    local_62 = CResourcesAtPlanet((PLANET *)&pl,((PLANET *)lppl)->iPlayer);
    local_60 = (int)local_62 >> 0xf;
    uVar12 = __aFulshr(uVar16,in_stack_0000ff8a);
    if ((uVar12 & 1) == 0) {
      uVar15 = 0;
      uVar9 = 100;
      uVar12 = __aFulmul(CONCAT22(local_60,local_62),
                                 (long)(int)*(char *)((int)&rgplr[0].pctResearch +
                                                     ((PLANET *)lppl)->iPlayer * 0xc0));
      lVar14 = __aFldiv(uVar12,CONCAT22(uVar15,uVar9));
      cResearch = lVar14;
      bVar10 = local_62 < (uint)lVar14;
      local_62 = local_62 - (uint)lVar14;
      local_60 = (local_60 - (int)((ulong)lVar14 >> 0x10)) - (uint)bVar10;
    }
    else {
      cResearch._0_2_ = 0;
      cResearch._2_2_ = 0;
      lVar14 = 0;
    }
    uVar12 = (ulong)in_stack_0000ff8a;
    fAlchemy = 0;
    for (i = -1; uVar17 = (ushort)uVar12, i < iMac; i = i + 1) {
      if (i == -1) {
        lpprod = (PROD *)&prodPartial;
      }
      else {
        lpprod = (PROD *)CONCAT22(pl.lpplprod._2_2_,(PL *)((PLPROD *)pl.lpplprod + i + 1));
      }
      if ((lpprod->dwFlags & 0x3ff) != 0) {
        cResearch = lVar14;
        uVar12 = __aFulshr(uVar16,uVar17);
        uVar9 = (undefined2)((ulong)lpprod >> 0x10);
        if (((uint)uVar12 & 0x7f) == 3) {
          uVar13 = __aFulshr(uVar16,uVar17);
          uVar12 = (ulong)uVar17;
          if (((uint)uVar13 & 7) == 1) {
            if (i < iMac + -1) {
              lVar14 = cResearch;
              if (i != iItem) {
                fAlchemy = 1;
                goto LAB_10d0_53bf;
              }
              *piLast = -1;
              *piFirst = -1;
              goto PRODUCE_LCleanUp;
            }
            uVar15 = *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2);
            *(uint *)&lpprod->dwFlags = (uint)lpprod->dwFlags & 0xfc00 | 0x3fc;
            *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2) = uVar15;
          }
        }
        if (i == -1) {
          pprodPartial = (PROD *)0x0;
        }
        else {
          pprodPartial = &prodPartial;
        }
        cBuilt = CBuildProdItem
                           ((PLANET *)&pl,lpprod,pprodPartial,&rgRes,fAlchemy,&mdStatus,0);
        if (iItem == i) {
          if ((0 < cBuilt) && (*piFirst == 0)) {
            *piFirst = iPass;
          }
          lVar14 = cResearch;
          if (mdStatus == 2) {
            if (*piFirst != 0) {
              *piLast = iPass + -1;
            }
            goto PRODUCE_LCleanUp;
          }
          if ((mdStatus == 0) || (mdStatus == 1)) {
            *piLast = iPass;
            goto PRODUCE_LCleanUp;
          }
        }
        fAlchemy = 0;
        uVar13 = __aFulshr(uVar16,uVar17);
        uVar12 = (ulong)uVar17;
        lVar14 = cResearch;
        if (((uint)uVar13 & 7) == 1) {
          uVar13 = __aFulshr(uVar16,uVar17);
          uVar12 = (ulong)uVar17;
          uVar4 = (uint)uVar13 & 0x7f;
          if ((uVar13 & 0x7f) == 0) {
LAB_10d0_52ea:
            lVar14 = __aFlshl(uVar16,uVar17);
            uVar12 = lVar14 + CONCAT22(pl.dwFlags._2_2_,(uint)pl.dwFlags) & 0xfff00;
            pl.dwFlags._0_2_ = (uint)pl.dwFlags & 0xff | (uint)uVar12;
            pl.dwFlags._2_2_ = pl.dwFlags._2_2_ & 0xfff0 | (uint)(uVar12 >> 0x10);
            lVar14 = cResearch;
          }
          else if ((uVar4 == 1) || (uVar4 == 7)) {
            lVar14 = __aFlshl(uVar16,uVar17);
            uVar12 = 0;
            pl.dwFlags._2_2_ =
                 pl.dwFlags._2_2_ & 0xf |
                 (int)((ulong)lVar14 >> 0x10) + pl.dwFlags._2_2_ +
                 (uint)CARRY2((uint)lVar14,(uint)pl.dwFlags) & 0xfff0;
            lVar14 = cResearch;
          }
          else {
            lVar14 = cResearch;
            if (uVar4 == 8) goto LAB_10d0_52ea;
          }
        }
        if (4 < mdStatus) break;
      }
LAB_10d0_53bf:
    }
    in_stack_0000ff8a = (uint)uVar12;
    cResearch._0_2_ = (int)lVar14;
    if (iItem < 0) {
      *piFirst = local_62;
      if (iItem == -1) {
        *piFirst = *piFirst + (int)cResearch;
      }
      goto PRODUCE_LCleanUp;
    }
    cResearch = lVar14;
    for (j = 0; j < 3; j = j + 1) {
      uVar9 = *(undefined2 *)((int)&rgRes + j * 4 + 2);
      *(undefined2 *)(pl.rgwtMin + j) = *(undefined2 *)(&rgRes + j);
      *(undefined2 *)((int)pl.rgwtMin + j * 4 + 2) = uVar9;
    }
    ChgPopFromPlanet((PLANET *)&pl,1);
    iPass = iPass + 1;
  } while( true );
}



// ======================================================================
// Function: ZipProdDlg
// Address: 10d0:5490
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d05b5e) */
/* WARNING: Removing unreachable block (ram,0x10d05b29) */
/* WARNING: Removing unreachable block (ram,0x10d05b63) */
/* WARNING: Variable defined which should be unmapped: hwndRad */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short ZipProdDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char cVar1;
  char *pcVar2;
  int iVar3;
  HWND HVar4;
  short sVar5;
  void *pvVar6;
  uint uVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar8;
  void *pvVar9;
  ushort in_stack_0000ffbe;
  ZIPPRODQ *pZVar10;
  HWND hwndRad;
  int iVar11;
  char *pcVar12;
  POINT in_stack_0000ffc6;
  char *pcVar13;
  int in_stack_0000ffca;
  short dy;
  undefined8 rc;
  short iBase;
  short i;
  PAINTSTRUCT ps;
  HDC hdc;
  
  if (message == WM_PAINT) {
    hdc = BeginPaint(hwnd,(PAINTSTRUCT *)&ps);
    GetClientRect(hwnd,(RECT *)(RECT *)&rc);
    HVar4 = GetDlgItem(hwnd,0x431);
    GetWindowRect(HVar4,(RECT *)(RECT *)&stack0xffc6);
    ScreenToClient(hwnd,(POINT *)(POINT *)&stack0xffc6);
    HVar4 = GetDlgItem(hwnd,0x434);
    GetWindowRect(HVar4,(RECT *)(RECT *)&rc);
    ScreenToClient(hwnd,(POINT *)(POINT *)((int)&rc + 4));
    ExpandRc((RECT *)&stack0xffc6,dyArial8,dyArial8 >> 1);
    _Draw3dFrame();
    SelectObject(hdc,rghfontArial8[1]);
    SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    sVar5 = CchGetString(idsCustomOrders,(char *)szWork);
    TextOut(hdc,(short)((char *)in_stack_0000ffc6.x + 8),
            in_stack_0000ffc6.y - (dyArial8 >> 1),szWork,sVar5);
    pcVar2 = (char *)in_stack_0000ffc6.x;
    if (*(char *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) != '\0') {
      sVar5 = CchGetString
                        (*(byte *)((int)&vrgZipProd[0].field2_0xe +
                                  iResTechNow * 0x28) + idsContributeResearch,
                         (char *)szWork);
      TextOut(hdc,(short)pcVar2,vyZPDStatic,szWork,sVar5);
    }
    EndPaint(hwnd,(PAINTSTRUCT *)&ps);
    return 1;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(RECT *)(RECT *)&rc);
    FillRect(wParam,(RECT *)(RECT *)&rc,hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    for (i = 0x431; i < 0x435; i = i + 1) {
      HVar4 = GetDlgItem(hwnd,i);
      if ((HWND)lParam == HVar4) break;
    }
    if (0x434 < i) {
      return 0;
    }
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    return hbrButtonFace;
  }
  if (message == WM_INITDIALOG) {
    HVar4 = hwnd;
    pcVar2 = PszGetCompressedString(idsCustomizeProductionTemplates);
    SetWindowText(HVar4,(LPCSTR)pcVar2);
    GetWindowRect(hwnd,(RECT *)(RECT *)&rc);
    GetClientRect(hwnd,(RECT *)(RECT *)&stack0xffc4);
    iVar3 = (rc._6_2_ - rc._2_2_) - in_stack_0000ffca;
    HVar4 = GetDlgItem(hwnd,0x417);
    GetWindowRect(HVar4,(RECT *)(RECT *)&stack0xffc4);
    MapWindowPoints(0,hwnd,(POINT *)(POINT *)&stack0xffc4,2);
    vyZPDStatic = in_stack_0000ffca + 2;
    SetWindowPos(hwnd,0,0,0,rc._4_2_ - (int)rc,iVar3 + in_stack_0000ffca + dyArial8 + 6,6)
    ;
    CheckRadioButton(hwnd,0x431,0x434,0x431);
    EnableZipProdBtns(hwnd,0);
    iResTechNow = 0;
    FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd);
    for (i = 0x431; i < 0x435; i = i + 1) {
      iBase = i + -0x431;
      if (*(char *)((int)&vrgZipProd[0].fValid + iBase * 0x28) == '\0') {
        pcVar2 = PszGetCompressedString(idsUnusedD);
        wsprintf(szWork,(char *)pcVar2,iBase + 1);
      }
      else {
        pcVar2 = (char *)szWork;
        pZVar10 = (ZIPPRODQ *)vrgZipProd + iBase;
        while (pcVar13 = pcVar2, pZVar10->szName[0] != '\0') {
          pcVar12 = pZVar10->szName;
          cVar1 = pZVar10->szName[0];
          *pcVar13 = cVar1;
          pcVar2 = pcVar13 + 1;
          pZVar10 = (ZIPPRODQ *)(pcVar12 + 1);
          if (cVar1 == '&') {
            pcVar13[1] = '&';
            pcVar2 = pcVar13 + 2;
          }
        }
        *pcVar13 = '\0';
      }
      pcVar2 = (char *)szWork;
      HVar4 = GetDlgItem(hwnd,i);
      SetWindowText(HVar4,(LPCSTR)pcVar2);
    }
    StickyDlgPos(hwnd,(POINT *)&ptStickyZipProdDlg,1);
    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    return 1;
  }
  if (message != WM_COMMAND) {
    return 0;
  }
  uVar8 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffbe);
  if ((((int)uVar8 == 0) && (0x430 < wParam)) && (wParam < 0x435)) {
    iResTechNow = wParam - 0x431;
    EnableZipProdBtns(hwnd,iResTechNow);
    FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd + iResTechNow);
    return 0;
  }
  if ((wParam == 1) || (wParam == 2)) {
    StickyDlgPos(hwnd,(POINT *)&ptStickyZipProdDlg,0);
    EndDialog(hwnd,(uint)(wParam == 1));
    vyZPDStatic = -1;
    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    return 1;
  }
  if ((wParam != 0x816) && (wParam != 0x41b)) {
    if (wParam == 0x817) {
      *(undefined1 *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) = 0;
      iVar3 = iResTechNow + 1;
      pcVar2 = PszGetCompressedString(idsUnusedD);
      wsprintf(szWork,(char *)pcVar2,iVar3);
      HVar4 = GetDlgItem(hwnd,iResTechNow + 0x431);
      SetWindowText(HVar4,szWork);
      FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd + iResTechNow);
      uVar7 = gd._4_2_ & 0xffdf | 0x20;
      gd.field3_0x4 = (char)uVar7;
      gd.field4_0x5 = (char)(uVar7 >> 8);
      return 0;
    }
    if (wParam != 0x76) {
      return 0;
    }
    WinHelp(hwnd,(LPCSTR)_szHelpFile,1,0x452);
    return 1;
  }
  if (*(char *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) == '\0') {
    sVar5 = iResTechNow;
    pcVar2 = PszGetCompressedString(idsCustomD);
    wsprintf(szWork,(char *)pcVar2,sVar5);
  }
  else {
    _strcpy((char *)szWork,
                    ((ZIPPRODQ *)vrgZipProd)[iResTechNow].szName);
  }
  pvVar9 = MakeProcInstance(RenameZipDlg,hInst);
  dy = (short)((ulong)pvVar9 >> 0x10);
  pvVar6 = (void *)pvVar9;
  if (iResTechNow != 0) {
    sVar5 = DialogBox(0,(LPCSTR)CONCAT22(0x7e3,hwndFrame),dy,pvVar6);
    if (sVar5 == 0) goto LAB_10d0_5ce2;
    if (szWork[0] == '\0') {
      pcVar2 = PszGetCompressedString(idsCustomD);
      wsprintf(szWork,(char *)pcVar2);
    }
    _strcpy(((ZIPPRODQ *)vrgZipProd)[iResTechNow].szName,
                    (char *)szWork);
    in_stack_0000ffc6.x = 0x57e4;
    in_stack_0000ffc6.y = 0x57a4;
    while( true ) {
      pcVar13 = (char *)in_stack_0000ffc6.y;
      pcVar2 = (char *)in_stack_0000ffc6.x;
      if (*pcVar13 == '\0') break;
      cVar1 = *pcVar13;
      pcVar12 = pcVar2 + 1;
      *pcVar2 = cVar1;
      if (cVar1 == '&') {
        *pcVar12 = '&';
        pcVar12 = pcVar2 + 2;
      }
      in_stack_0000ffc6.y = (short)(pcVar13 + 1);
      in_stack_0000ffc6.x = (short)pcVar12;
    }
    *pcVar2 = '\0';
    HVar4 = GetDlgItem(hwnd,iResTechNow + 0x431);
    SetWindowText(HVar4,szWork + 0x40);
    pvVar9 = (void *)CONCAT22(dy,pvVar6);
  }
  iVar3 = 0x14f8;
  if (wParam == 0x816) {
    *(undefined1 *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) = 1;
    iVar11 = 0;
    i = 0;
    while( true ) {
      dy = (short)((ulong)pvVar9 >> 0x10);
      pvVar6 = (void *)pvVar9;
      if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= i) break;
      uVar8 = __aFulshr((ulong)in_stack_0000ffc6,(ushort)pvVar6);
      iVar11 = iVar3;
      if (((uint)uVar8 & 7) == 1) {
        iVar11 = 0x1118;
        uVar8 = __aFulshr((ulong)in_stack_0000ffc6,(ushort)pvVar6);
        if (((uint)uVar8 & 0x7f) < 7) {
          iVar11 = 0x1118;
          uVar8 = __aFulshr((ulong)in_stack_0000ffc6,(ushort)pvVar6);
          pvVar9 = (void *)CONCAT22(dy,pvVar6);
          *(uint *)(iResTechNow * 0x28 + 0x2306 + iVar11 * 2) =
               *(uint *)(iResTechNow * 0x28 + 0x2306 + iVar11 * 2) & 0xffc0 |
               (uint)uVar8 & 0x3f;
          *(uint *)(iResTechNow * 0x28 + 0x2306 + iVar11 * 2) =
               *(uint *)(iResTechNow * 0x28 + 0x2306 + iVar11 * 2) & 0x3f |
               ((PLPROD *)lpplProdGlob + i + 1)->wFlags << 6;
          iVar11 = iVar11 + 1;
          if (0xb < iVar11) break;
        }
      }
      pvVar9 = (void *)CONCAT22(dy,pvVar6);
      iVar3 = 0x1118;
      i = i + 1;
    }
    dy = (short)((ulong)pvVar9 >> 0x10);
    pvVar6 = (void *)pvVar9;
    *(undefined1 *)((int)&vrgZipProd[0].cpq + iResTechNow * 0x28) = (char)iVar11
    ;
    uVar8 = __aFulshr((ulong)in_stack_0000ffc6,(ushort)pvVar6);
    *(byte *)((int)&vrgZipProd[0].field2_0xe + iResTechNow * 0x28) =
         (byte)uVar8 & 1;
    FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd + iResTechNow);
    pvVar9 = (void *)CONCAT22(dy,pvVar6);
  }
  dy = (short)((ulong)pvVar9 >> 0x10);
  pvVar6 = (void *)pvVar9;
  EnableZipProdBtns(hwnd,iResTechNow);
LAB_10d0_5ce2:
  FreeProcInstance((FARPROC)CONCAT22(dy,pvVar6));
  SetFocus(hwnd);
  uVar7 = gd._4_2_ & 0xffdf | 0x20;
  gd.field3_0x4 = (char)uVar7;
  gd.field4_0x5 = (char)(uVar7 >> 8);
  return 0;
}



// ======================================================================
// Function: EnableZipProdBtns
// Address: 10d0:5df0
// Segment: MEMORY_PRODUCE
// ======================================================================


void EnableZipProdBtns(HWND hwnd,short iSel)

{
  BOOL BVar1;
  HWND HVar2;
  short fEnabled;
  
  if ((*(char *)((int)&vrgZipProd[0].fValid + iSel * 0x28) == '\0') || (iSel < 1)) {
    BVar1 = 0;
  }
  else {
    BVar1 = 1;
  }
  HVar2 = GetDlgItem(hwnd,0x817);
  EnableWindow(HVar2,BVar1);
  HVar2 = GetDlgItem(hwnd,0x41b);
  EnableWindow(HVar2,BVar1);
  return;
}



// ======================================================================
// Function: FillZipProdLB
// Address: 10d0:5e58
// Segment: MEMORY_PRODUCE
// ======================================================================


void FillZipProdLB(HWND hwndDlg,ZIPPRODQ *pzpq)

{
  char *pcVar1;
  undefined2 unaff_SS;
  WPARAM WVar2;
  UINT UVar3;
  HWND HVar4;
  RECT rc;
  char szFormat [16];
  char szAuto [40];
  HWND hwndLB;
  short i;
  
  hwndLB = GetDlgItem(hwndDlg,0x417);
  GetClientRect(hwndDlg,(RECT *)&rc);
  rc.top = vyZPDStatic;
  rc.bottom = vyZPDStatic + dyArial8;
  InvalidateRect(hwndDlg,(RECT *)&rc,1);
  SendMessage(hwndLB,0x405,0,0);
  if ((pzpq->fValid == 0) || (pzpq->cpq == 0)) {
    UVar3 = 0x401;
    WVar2 = 0;
    HVar4 = hwndLB;
    pcVar1 = PszGetCompressedString(idsAutoBuildOrders);
    SendMessage(HVar4,UVar3,WVar2,(LPARAM)pcVar1);
  }
  else {
    CchGetString(idsSD2,szFormat);
    for (i = 0; i < (int)(uint)pzpq->cpq; i = i + 1) {
      CchGetString(((pzpq->rgpq + i)->w & 0x3fU) + idsMines,szAuto);
      if (((uint)(pzpq->rgpq + i)->w >> 6 == 1) || (((pzpq->rgpq + i)->w & 0x3fU) == 3)) {
        _strcpy((char *)szWork,szAuto);
      }
      else {
        wsprintf(szWork,(char *)szFormat,szAuto);
      }
      SendMessage(hwndLB,0x401,0,0x112057a4);
    }
  }
  return;
}



