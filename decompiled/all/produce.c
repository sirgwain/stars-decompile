// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: ChangeProduction
// Address: 10d0:0000
// Segment: MEMORY_PRODUCE
// ======================================================================


short ChangeProduction(short fClear)

{
  short sVar1;
  char *sz;
  short fSuccess;
  PROD rgprod [64];
  undefined4 lpProcProd;
  short (*penvMemSav) [9];
  short env [10];
  
                    /* Segment:    27
                       Offset:     000bc100
                       Length:     5ff4
                       Min Alloc:  5ff4
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  penvMemSav = penvMem;
  penvMem = (short (*) [9])env;
  sVar1 = __setjmp(env);
  if (sVar1 == 0) {
    if (fClear == 0) {
      InitProduction(rgprod);
      fDlgUp = 1;
      lpProcProd = MakeProcInstance(ProductionDlg,hInst);
      fSuccess = DialogBox(0,(LPCSTR)CONCAT22(0x5d,hwndFrame),
                           (HWND)((ulong)lpProcProd >> 0x10),(char)lpProcProd);
      FreeProcInstance(lpProcProd);
      hwndProdDlg = 0;
      fDlgUp = 0;
    }
    else {
      fSuccess = 1;
    }
    FinishProduction(fSuccess);
    if ((fSuccess != 0) && (sel.grobj == grobjPlanet)) {
      DrawPlanShip(0,8);
    }
    penvMem = penvMemSav;
    sVar1 = 1;
  }
  else {
    if (((PLPROD *)lpplProdGlob != (PLPROD *)0x0) || (lpplProdGlob._2_2_ != 0)) {
      FreePl((PL *)CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob));
    }
    lpplProdGlob._0_2_ = (PLPROD *)0x0;
    lpplProdGlob._2_2_ = 0;
    if (hwndProdDlg != 0) {
      EndDialog(hwndProdDlg,0);
    }
    hwndProdDlg = 0;
    fDlgUp = 0;
    sVar1 = 0x10;
    sz = PszFormatIds(idsThereIsntEnoughFreeMemoryModifyProduction,(short *)0x0);
    AlertSz(sz,sVar1);
    penvMem = penvMemSav;
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: InitProduction
// Address: 10d0:015e
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d00ef7) */
/* WARNING: Removing unreachable block (ram,0x10d00a78) */
/* WARNING: Removing unreachable block (ram,0x10d00efc) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10d00fb0) */
/* WARNING: Removing unreachable block (ram,0x10d00fb5) */

void InitProduction(PROD *rgprod)

{
  byte *pbVar1;
  PROD *pPVar2;
  undefined2 *puVar3;
  undefined2 uVar4;
  PLPROD *pPVar5;
  uint uVar6;
  short sVar7;
  undefined2 unaff_SI;
  PROD *pPVar8;
  undefined2 unaff_DI;
  undefined2 uVar9;
  ulong uVar10;
  HULDEF *pHVar11;
  long lVar12;
  ushort in_stack_0000ffde;
  uint uVar13;
  int iVar14;
  uint in_stack_0000ffe2;
  PROD *lpprod;
  PART part;
  short ipl;
  short i;
  ushort u;
  short iSrc;
  short iWarp;
  
  uVar10 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffde);
  uVar6 = (uint)uVar10 & 1;
  gd.grBits._0_2_ = (uint)gd.grBits & 0xffdf | uVar6 << 5;
  if (rgprod == (PROD *)0x0) {
    rgprod = pProdGlob;
  }
  if (((PLPROD *)sel.pl.lpplprod == (PLPROD *)0x0) &&
     (sel.pl.lpplprod._2_2_ == 0)) {
    i = 2;
  }
  else {
    i = (short)((PLPROD *)sel.pl.lpplprod)->iprodMac;
  }
  lpplProdGlob = (PLPROD *)LpplAlloc(4,i,htOrd);
  if (((PLPROD *)sel.pl.lpplprod == (PLPROD *)0x0) &&
     (sel.pl.lpplprod._2_2_ == 0)) {
    i = 0;
  }
  else {
    __fmemcpy((PL *)CONCAT22((int)((ulong)lpplProdGlob >> 0x10),
                                     (PL *)lpplProdGlob + 1),
                      (PLPROD *)
                      CONCAT22(sel.pl.lpplprod._2_2_,
                               (PLPROD *)sel.pl.lpplprod + 1),i << 2);
  }
  ((PLPROD *)lpplProdGlob)->iprodMac = (byte)i;
  cProdGlob = 0;
  pProdGlob = rgprod;
  _memset(rgprod,0,0x100);
  if (((sel.pl.wFlags_0x4 >> 9 & 1) != 0) &&
     (pHVar11 = LphuldefFromId
                          (*(HullDef *)
                            (*(int *)(idPlayer * 4 + 0x14c) +
                            ((uint)sel.pl.lStarbase & 0xf) * 0x93)),
     (((HULDEF *)pHVar11)->hul).wtCargoMax != 0)) {
    for (i = 0; i < 0x10; i = i + 1) {
      if (((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0) &&
         (-1 < *(int *)((int)&rgshdef[0].wFlags + i * 0x93))) {
        uVar6 = *(uint *)((int)&rgshdef[0].hul + 0x28 + i * 0x93);
        pHVar11 = LphuldefFromId
                            (*(HullDef *)
                              (*(int *)(idPlayer * 4 + 0x14c) +
                              ((uint)sel.pl.lStarbase & 0xf) * 0x93));
        if (uVar6 <= (((HULDEF *)pHVar11)->hul).wtCargoMax) {
          uVar4 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
          pPVar8 = rgprod + cProdGlob;
          *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff
          ;
          *(undefined2 *)((int)&pPVar8->dwFlags + 2) = uVar4;
          in_stack_0000ffe2 = 0x1008;
          lVar12 = __aFlshl(CONCAT22((PROD *)lpprod,uVar6),lpprod._2_2_);
          uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
          pPVar8 = rgprod + cProdGlob;
          *(uint *)&pPVar8->dwFlags =
               (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
          *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
          uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
          pPVar8 = rgprod + cProdGlob;
          *(int *)&pPVar8->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
          *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfff1 | 4;
          cProdGlob = cProdGlob + 1;
        }
      }
    }
  }
  for (i = 0; i < 10; i = i + 1) {
    if ((((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) &&
        (-1 < *(int *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b))) &&
       ((((uint)sel.pl.lStarbase & 0xf) != i ||
        ((sel.pl.wFlags_0x4 >> 9 & 1) == 0)))) {
      uVar4 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar8 = rgprod + cProdGlob;
      *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
      *(undefined2 *)((int)&pPVar8->dwFlags + 2) = uVar4;
      in_stack_0000ffe2 = i + 0x10;
      uVar6 = (int)in_stack_0000ffe2 >> 0xf;
      lVar12 = __aFlshl((long)(int)in_stack_0000ffe2,(ushort)(PROD *)lpprod);
      uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar8 = rgprod + cProdGlob;
      *(uint *)&pPVar8->dwFlags =
           (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
      *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
      uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar8 = rgprod + cProdGlob;
      *(int *)&pPVar8->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
      *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfff1 | 4;
      cProdGlob = cProdGlob + 1;
    }
  }
  part.hs.grhst = hstPlanetary;
  part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | 0xe;
  sVar7 = FLookupPart(&part);
  if (sVar7 == 1) {
    uVar4 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
    *(undefined2 *)((int)&pPVar8->dwFlags + 2) = uVar4;
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x3400;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfffe;
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(int *)&pPVar8->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  iWarp = IWarpMAFromLppl(&sel.pl,(short *)0x0);
  if (0 < iWarp) {
    for (i = 0; i < 4; i = i + 1) {
      uVar4 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar8 = rgprod + cProdGlob;
      *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
      *(undefined2 *)((int)&pPVar8->dwFlags + 2) = uVar4;
      in_stack_0000ffe2 = i + 0xe;
      uVar6 = (int)in_stack_0000ffe2 >> 0xf;
      lVar12 = __aFlshl((long)(int)in_stack_0000ffe2,(ushort)(PROD *)lpprod);
      uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar8 = rgprod + cProdGlob;
      *(uint *)&pPVar8->dwFlags =
           (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
      *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
      uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar8 = rgprod + cProdGlob;
      *(int *)&pPVar8->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
      *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfff1 | 2;
      cProdGlob = cProdGlob + 1;
    }
  }
  uVar10 = __aFulshr(CONCAT22(uVar6,in_stack_0000ffe2),(ushort)(PROD *)lpprod);
  uVar6 = (uint)uVar10 & 0xfff;
  sVar7 = CMaxFactories(&sel.pl,idPlayer);
  u = sVar7 - uVar6;
  if (0 < (int)u) {
    in_stack_0000ffe2 = u;
    if (0x3fc < u) {
      in_stack_0000ffe2 = 0x3fc;
    }
    uVar6 = 0;
    lVar12 = __aFlshl((ulong)in_stack_0000ffe2,(ushort)(PROD *)lpprod);
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(uint *)&pPVar8->dwFlags =
         (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 | (uint)((ulong)lVar12 >> 0x10);
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x1c00;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfffe;
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(int *)&pPVar8->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  uVar10 = __aFulshr(CONCAT22(uVar6,in_stack_0000ffe2),(ushort)(PROD *)lpprod);
  uVar6 = (uint)uVar10 & 0xfff;
  sVar7 = CMaxMines(&sel.pl,idPlayer);
  u = sVar7 - uVar6;
  if (0 < (int)u) {
    in_stack_0000ffe2 = u;
    if (0x3fc < u) {
      in_stack_0000ffe2 = 0x3fc;
    }
    lVar12 = __aFlshl((ulong)in_stack_0000ffe2,(ushort)(PROD *)lpprod);
    uVar6 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(uint *)&pPVar8->dwFlags =
         (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar6 | (uint)((ulong)lVar12 >> 0x10);
    uVar6 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2000;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar6 & 0xfffe;
    uVar6 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(int *)&pPVar8->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar6 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  uVar6 = sel.pl.rgbImp._4_2_ & 0xfff;
  sVar7 = CMaxDefenses(&sel.pl,idPlayer);
  u = sVar7 - uVar6;
  if (0 < (int)u) {
    lVar12 = __aFlshl(CONCAT22(uVar6,in_stack_0000ffe2),(ushort)(PROD *)lpprod);
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(uint *)&pPVar8->dwFlags =
         (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 | (uint)((ulong)lVar12 >> 0x10);
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2400;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfffe;
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(int *)&pPVar8->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  uVar4 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
  pPVar8 = rgprod + cProdGlob;
  *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
  *(undefined2 *)((int)&pPVar8->dwFlags + 2) = uVar4;
  uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
  pPVar8 = rgprod + cProdGlob;
  *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2c00;
  *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfffe;
  uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
  pPVar8 = rgprod + cProdGlob;
  *(int *)&pPVar8->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
  *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfff1 | 2;
  cProdGlob = cProdGlob + 1;
  uVar10 = __aFulshr(CONCAT22(uVar6,in_stack_0000ffe2),(ushort)(PROD *)lpprod);
  if ((((uint)uVar10 & 0x1f) == 0x1f) &&
     (sVar7 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
     sVar7 != raMacintosh)) {
    uVar4 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
    *(undefined2 *)((int)&pPVar8->dwFlags + 2) = uVar4;
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x6c00;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfffe;
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(int *)&pPVar8->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  i = IpctCanTerraformLppl(&sel.pl);
  if (0 < i) {
    uVar6 = 0;
    lVar12 = __aFlshl((ulong)(uint)i,(ushort)(PROD *)lpprod);
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(uint *)&pPVar8->dwFlags =
         (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 | (uint)((ulong)lVar12 >> 0x10);
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x3000;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfffe;
    uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar8 = rgprod + cProdGlob;
    *(int *)&pPVar8->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
    in_stack_0000ffe2 = i;
  }
  for (i = 0; i < 7; i = i + 1) {
    sVar7 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (((sVar7 != raMacintosh) || (((i != 0 && (i != 1)) && (i != 2)))) &&
       ((sVar7 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
        sVar7 != raTerra || ((i != 4 && (i != 5)))))) {
      uVar4 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar8 = rgprod + cProdGlob;
      *(uint *)&pPVar8->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
      *(undefined2 *)((int)&pPVar8->dwFlags + 2) = uVar4;
      uVar6 = i >> 0xf;
      in_stack_0000ffe2 = i;
      lVar12 = __aFlshl((long)i,(ushort)(PROD *)lpprod);
      uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar8 = rgprod + cProdGlob;
      *(uint *)&pPVar8->dwFlags =
           (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
      *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
      uVar13 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar8 = rgprod + cProdGlob;
      *(int *)&pPVar8->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
      *(uint *)((int)&pPVar8->dwFlags + 2) = uVar13 & 0xfff1 | 2;
      cProdGlob = cProdGlob + 1;
    }
  }
  ipl = 0;
  uVar4 = lpplProdGlob._2_2_;
  pPVar5 = (PLPROD *)lpplProdGlob;
  do {
    lpprod._0_2_ = (PROD *)(pPVar5 + 1);
    if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= ipl) {
      if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
        AdvanceTutor();
      }
      return;
    }
    for (iSrc = 0; iSrc < cProdGlob; iSrc = iSrc + 1) {
      __aFulshr(CONCAT22(uVar6,in_stack_0000ffe2),(ushort)(PROD *)lpprod);
      in_stack_0000ffe2 = (uint)((PROD *)CONCAT22(uVar4,(PROD *)lpprod))->dwFlags;
      uVar6 = *(uint *)&pPVar5[1].iprodMax;
      iVar14 = 0x1118;
      uVar13 = 0xdca;
      uVar10 = __aFulshr(CONCAT22(uVar6,in_stack_0000ffe2),(ushort)(PROD *)lpprod);
      if ((uVar13 == ((uint)uVar10 & 7)) && (iVar14 == 0)) {
        __aFulshr(CONCAT22(uVar6,in_stack_0000ffe2),(ushort)(PROD *)lpprod);
        in_stack_0000ffe2 = (uint)((PROD *)CONCAT22(uVar4,(PROD *)lpprod))->dwFlags;
        uVar6 = *(uint *)&pPVar5[1].iprodMax;
        iVar14 = 0x1118;
        uVar13 = 0xe28;
        uVar10 = __aFulshr(CONCAT22(uVar6,in_stack_0000ffe2),(ushort)(PROD *)lpprod);
        if ((uVar13 == ((uint)uVar10 & 0x7f)) && (iVar14 == 0)) break;
      }
    }
    if (iSrc < cProdGlob) {
      if (((uint)(pProdGlob + iSrc)->dwFlags & 0x3ff) <
          ((uint)((PROD *)CONCAT22(uVar4,(PROD *)lpprod))->dwFlags & 0x3ff)) {
        in_stack_0000ffe2 = (uint)(pProdGlob + iSrc)->dwFlags & 0x3ff;
        uVar6 = 0;
        lVar12 = __aFlshl((ulong)in_stack_0000ffe2,(ushort)(PROD *)lpprod);
        uVar13 = *(uint *)&pPVar5[1].iprodMax;
        *(uint *)&((PROD *)CONCAT22(uVar4,(PROD *)lpprod))->dwFlags =
             (uint)((PROD *)CONCAT22(uVar4,(PROD *)lpprod))->dwFlags & 0xfc00 | (uint)lVar12;
        *(uint *)&pPVar5[1].iprodMax = uVar13 | (uint)((ulong)lVar12 >> 0x10);
      }
      if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
        if (((uint)(pProdGlob + iSrc)->dwFlags & 0x3ff) <
            ((uint)((PROD *)CONCAT22(uVar4,(PROD *)lpprod))->dwFlags & 0x3ff)) {
          uVar9 = *(undefined2 *)((int)&pProdGlob[iSrc].dwFlags + 2);
          pPVar8 = pProdGlob + iSrc;
          *(uint *)&pPVar8->dwFlags = (uint)(pProdGlob + iSrc)->dwFlags & 0xfc00;
          *(undefined2 *)((int)&pPVar8->dwFlags + 2) = uVar9;
        }
        else {
          lVar12 = __aFlshl(CONCAT22(uVar6,in_stack_0000ffe2),(ushort)(PROD *)lpprod);
          in_stack_0000ffe2 = (int)(pProdGlob + iSrc)->dwFlags - (int)lVar12 & 0x3ff;
          uVar6 = 0;
          pPVar8 = pProdGlob + iSrc;
          pPVar2 = pPVar8;
          *(uint *)&pPVar2->dwFlags = (uint)pPVar2->dwFlags & 0xfc00;
          puVar3 = (undefined2 *)((int)&pPVar8->dwFlags + 2);
          *puVar3 = *puVar3;
          pPVar8 = pProdGlob + iSrc;
          pPVar2 = pPVar8;
          *(uint *)&pPVar2->dwFlags = (uint)pPVar2->dwFlags | in_stack_0000ffe2;
          puVar3 = (undefined2 *)((int)&pPVar8->dwFlags + 2);
          *puVar3 = *puVar3;
        }
      }
    }
    else {
      uVar6 = ipl + 1;
      uVar9 = (undefined2)((ulong)lpplProdGlob >> 0x10);
      if ((int)uVar6 < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
        uVar6 = ipl + 1;
        __fmemcpy((PROD *)CONCAT22(uVar4,(PROD *)lpprod),
                          (PLPROD *)CONCAT22(uVar4,pPVar5 + 2),
                          (((PLPROD *)lpplProdGlob)->iprodMac - uVar6) * 4);
        ipl = ipl + -1;
      }
      pbVar1 = &((PLPROD *)lpplProdGlob)->iprodMac;
      *pbVar1 = *pbVar1 - 1;
    }
    ipl = ipl + 1;
    pPVar5 = (PLPROD *)(PROD *)lpprod;
  } while( true );
}



// ======================================================================
// Function: FinishProduction
// Address: 10d0:1090
// Segment: MEMORY_PRODUCE
// ======================================================================


void FinishProduction(short fWrite)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar1;
  
  if (fWrite == 0) {
    lVar1 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),(uint)gd.grBits >> 5 & 1);
    sel.pl.rgbImp._4_2_ = sel.pl.rgbImp._4_2_ | (uint)lVar1;
    sel.pl.rgbImp._6_2_ =
         sel.pl.rgbImp._6_2_ & 0xff7f | (uint)((ulong)lVar1 >> 0x10);
    FreePl((PL *)lpplProdGlob);
  }
  else {
    FreePl((PL *)CONCAT22(sel.pl.lpplprod._2_2_,
                                  (PLPROD *)sel.pl.lpplprod));
    if ((((PLPROD *)lpplProdGlob != (PLPROD *)0x0) || (lpplProdGlob._2_2_ != 0)) &&
       (((PLPROD *)lpplProdGlob)->iprodMac == 0)) {
      FreePl((PL *)lpplProdGlob);
      lpplProdGlob = (PLPROD *)0x0;
    }
    sel.pl.lpplprod._0_2_ = (PLPROD *)lpplProdGlob;
    sel.pl.lpplprod._2_2_ = lpplProdGlob._2_2_;
    lpplProdGlob = (PLPROD *)0x0;
    FLookupPlanet(-1,(PLANET *)&sel.pl);
    FLookupPlanet(sel.pl.id,(PLANET *)&sel.pl);
    if (fAi == 0) {
      FillPlanetProdLB(0,(PLPROD *)0x0,(PLANET *)0x0);
      DrawPlanShip(0,0x40);
    }
  }
  lpplProdGlob = (PLPROD *)0x0;
  if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
    tutor.wFlags = tutor.wFlags & 0xfbffU | 0x400;
    AdvanceTutor();
  }
  return;
}



// ======================================================================
// Function: ProductionDlg
// Address: 10d0:1204
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: fRet */

short ProductionDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  POINT PVar1;
  int iVar2;
  HWND HVar3;
  char *pcVar4;
  BOOL BVar5;
  short sVar6;
  char **ppcVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  bool bVar8;
  ulong uVar9;
  FARPROC pvVar10;
  short fRet;
  undefined1 rgzp [140];
  int local_58;
  short rgidProdBtns [9];
  char *rgszZip;
  short dyLB;
  short dx;
  short xCtr;
  short i;
  short i__56;
  char sz255;
  undefined1 local_35;
  short cMax;
  POINT pt;
  RECT rc;
  PAINTSTRUCT ps;
  HDC hdc;
  
  uVar9 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    hdc = BeginPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,&ps));
    GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,&rc));
    DrawProductionDlg(hwnd,hdc,&rc,-1);
    EndPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,&ps));
    sVar6 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(RECT *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar6 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      pt.y = (int)lParam;
      HVar3 = GetDlgItem(hwnd,0x8b);
      if ((pt.y == HVar3) || (uVar9 = __aFulshr(uVar9,fRet), (int)uVar9 == 6)) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else if (message == WM_SETCURSOR) {
      cMax = 0;
      GetCursorPos((POINT *)CONCAT22(unaff_SS,&pt));
      ScreenToClient(hwnd,(POINT *)CONCAT22(unaff_SS,&pt));
      BVar5 = PtInRect(&rcProdDiamond,pt);
      if (BVar5 != 0) {
        setcursor(hcurArrowHelp);
        return 1;
      }
    }
    else {
      if (message == WM_DRAWITEM) {
        pt = (POINT)lParam;
        if (*(int *)((int)lParam + 4) == -1) {
          HandleFocusState((DRAWITEMSTRUCT *)lParam,-2);
        }
        else {
          iVar2 = *(int *)((int)lParam + 6);
          if (((iVar2 == 1) || (iVar2 == 2)) || (iVar2 == 4)) {
            DrawCBEntireItem((DRAWITEMSTRUCT *)lParam,4);
          }
        }
        return 1;
      }
      if (message == WM_MEASUREITEM) {
        *(int *)((int)lParam + 8) = dyArial8 + 2;
        return 1;
      }
      if (message == WM_INITDIALOG) {
        rgidProdBtns[0] = 0x42e;
        rgidProdBtns[1] = 0x42f;
        rgidProdBtns[2] = 1;
        rgidProdBtns[3] = 2;
        rgidProdBtns[4] = 0x418;
        rgidProdBtns[5] = 0x419;
        rgidProdBtns[6] = 0x439;
        rgidProdBtns[7] = 0x43a;
        rgidProdBtns[8] = 0x42d;
        rgszZip = (char *)&game.mdDensity;
        hwndProdDlg = hwnd;
        if (*(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) < 2) {
          HVar3 = GetDlgItem(hwnd,0x42f);
          EnableWindow(HVar3,0);
          HVar3 = GetDlgItem(hwnd,0x42e);
          EnableWindow(HVar3,0);
        }
        if ((uint)gd.grBits >> 0xe == 0) {
          dx = 0x262;
          pt.x = dyArial8 * 0x18 + 0x18;
        }
        else {
          dx = 0x2f8;
          pt.x = 0x244;
        }
        SetWindowPos(hwnd,0,0,0,dx,pt.x,6);
        GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,&rc));
        xCtr = rc.right >> 1;
        dyLB = (rc.bottom - (dyArial8 * 0x11) / 2) + -0x18;
        rc.left = (rc.right * 0xb) / 0x14 + 0x10;
        pt.y = (rc.right - rc.left) / 4;
        rc.bottom = rc.bottom - ((dyArial8 * 3) / 2 + 6);
        HVar3 = GetDlgItem(hwnd,0x8b);
        SetWindowPos(HVar3,0,6,rc.bottom,rc.left + -0xc,(dyArial8 * 3) / 2,4);
        for (i = 0; i < 4; i = i + 1) {
          HVar3 = GetDlgItem(hwnd,rgidProdBtns[i]);
          SetWindowPos(HVar3,0,rc.left,rc.bottom,pt.y + -6,(dyArial8 * 3) / 2,4);
          rc.left = rc.left + pt.y;
        }
        rc.left = xCtr - (pt.y + 0x12 >> 1);
        local_58 = (dyArial8 * 3) / 2;
        iVar2 = (dyLB + dyArial8 * -9) / 5 + local_58;
        pt.x = iVar2 + -3;
        rc.top = 8;
        if (0x32 < pt.x) {
          rc.top = ((iVar2 + -0x35) * 5) / 2 + 8;
          pt.x = 0x32;
        }
        pt.y = pt.y + 0x18;
        for (i = 4; i < 10; i = i + 1) {
          HVar3 = GetDlgItem(hwnd,rgidProdBtns[i]);
          SetWindowPos(HVar3,0,rc.left,rc.top,pt.y + -6,(dyArial8 * 3) / 2,4);
          rc.top = rc.top + pt.x;
        }
        HVar3 = GetDlgItem(hwnd,0x416);
        SetWindowPos(HVar3,0,6,6,rc.left + -0xc,dyLB,4);
        HVar3 = GetDlgItem(hwnd,0x416);
        GetWindowRect(HVar3,(RECT *)CONCAT22(unaff_SS,(RECT *)&stack0xffc6));
        HVar3 = GetDlgItem(hwnd,0x417);
        SetWindowPos(HVar3,0,rc.left + pt.y,6,rc.left + -0xc,cMax - i__56,4);
        ScreenToClient(hwnd,(POINT *)CONCAT22(unaff_SS,(POINT *)&stack0xffca));
        yTopFutureTech = cMax;
        InitializeProductionDlg(hwnd);
        if (((uint)gd.grBits >> 0xe == 1) && (ptStickyProduceDlg.y == -1)) {
          ptStickyProduceDlg.y = 0;
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyProduceDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        ProdCommandHandler(hwnd,wParam,lParam);
      }
      else if ((message == WM_LBUTTONDOWN) || (message == WM_RBUTTONDOWN)) {
        pt.x = (int)lParam;
        uVar9 = __aFulshr(uVar9,fRet);
        pt.y = (short)uVar9;
        PVar1.y = (short)uVar9;
        PVar1.x = pt.x;
        BVar5 = PtInRect(&rcProdDiamond,PVar1);
        if (BVar5 != 0) {
          if (message == WM_LBUTTONDOWN) {
            GlobalPD.grPopup = 10;
            GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = hstMining|hstTorp|hstBeam|hstShield;
            GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = (ushort)szPopupBuffer;
            CchGetString
                      (idsRightClickBlueDiamondApplyProductionTemplate,
                       (char *)szPopupBuffer);
            Popup(hwnd,pt.x,pt.y);
          }
          else {
            sz255 = -1;
            local_35 = 0;
            cMax = 0;
            for (i__56 = 0; i__56 < 4; i__56 = i__56 + 1) {
              if (*(char *)((int)&vrgZipProd[0].fValid + i__56 * 0x28) != '\0') {
                ppcVar7 = &rgszZip + cMax;
                cMax = cMax + 1;
                *ppcVar7 = ((ZIPPRODQ *)vrgZipProd)[i__56].szName;
              }
            }
            ppcVar7 = &rgszZip + cMax;
            cMax = cMax + 1;
            *ppcVar7 = &stack0xffca;
            pcVar4 = PszGetCompressedString(idsCustomize);
            ppcVar7 = &rgszZip + cMax;
            cMax = cMax + 1;
            *ppcVar7 = pcVar4;
            i__56 = PopupMenu(hwnd,pt.x,pt.y,cMax,(long *)0x0,&rgszZip,-1,1);
            if (i__56 == cMax + -1) {
              _memcpy(rgzp,(ZIPPRODQ *)vrgZipProd,0xa0);
              pvVar10 = MakeProcInstance(ZipProdDlg,hInst);
              sVar6 = DialogBox(0,(LPCSTR)CONCAT22(0x59,hwnd),(HWND)((ulong)pvVar10 >> 0x10),
                                (char)pvVar10);
              FreeProcInstance(pvVar10);
              if (sVar6 == 0) {
                _memcpy((ZIPPRODQ *)vrgZipProd,rgzp,0xa0);
              }
            }
            else if (-1 < i__56) {
              cMax = 0;
              while ((cMax < 4 &&
                     ((*(char *)((int)&vrgZipProd[0].fValid + cMax * 0x28) == '\0' ||
                      (iVar2 = i__56 + -1, bVar8 = i__56 != 0, i__56 = iVar2, bVar8))))) {
                cMax = cMax + 1;
              }
              ProdCommandHandler(hwnd,0x816,(long)cMax);
            }
          }
        }
      }
    }
    sVar6 = 0;
  }
  return sVar6;
}



// ======================================================================
// Function: ProdCommandHandler
// Address: 10d0:1994
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d01f07) */
/* WARNING: Removing unreachable block (ram,0x10d01a99) */
/* WARNING: Removing unreachable block (ram,0x10d026c2) */
/* WARNING: Removing unreachable block (ram,0x10d023e0) */
/* WARNING: Removing unreachable block (ram,0x10d02357) */
/* WARNING: Removing unreachable block (ram,0x10d02404) */
/* WARNING: Removing unreachable block (ram,0x10d025ca) */
/* WARNING: Removing unreachable block (ram,0x10d01a12) */
/* WARNING: Removing unreachable block (ram,0x10d01e16) */
/* WARNING: Removing unreachable block (ram,0x10d021cd) */
/* WARNING: Removing unreachable block (ram,0x10d029e0) */
/* WARNING: Removing unreachable block (ram,0x10d01dc1) */
/* WARNING: Removing unreachable block (ram,0x10d01b8e) */
/* WARNING: Removing unreachable block (ram,0x10d01b0c) */
/* WARNING: Removing unreachable block (ram,0x10d01a9e) */
/* WARNING: Removing unreachable block (ram,0x10d01b07) */
/* WARNING: Removing unreachable block (ram,0x10d01b89) */
/* WARNING: Removing unreachable block (ram,0x10d01d7f) */
/* WARNING: Removing unreachable block (ram,0x10d022cf) */
/* WARNING: Removing unreachable block (ram,0x10d029ab) */
/* WARNING: Removing unreachable block (ram,0x10d029e5) */
/* WARNING: Removing unreachable block (ram,0x10d027b8) */
/* WARNING: Removing unreachable block (ram,0x10d0231d) */
/* WARNING: Removing unreachable block (ram,0x10d02093) */
/* WARNING: Removing unreachable block (ram,0x10d02051) */
/* WARNING: Removing unreachable block (ram,0x10d01f51) */
/* WARNING: Removing unreachable block (ram,0x10d01f0c) */
/* WARNING: Removing unreachable block (ram,0x10d01f8e) */
/* WARNING: Removing unreachable block (ram,0x10d02816) */
/* WARNING: Removing unreachable block (ram,0x10d03237) */
/* WARNING: Removing unreachable block (ram,0x10d02222) */
/* WARNING: Removing unreachable block (ram,0x10d03098) */
/* WARNING: Type propagation algorithm not settling */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void ProdCommandHandler(HWND hwnd,ushort wParam,long lParam)

{
  PROD *pPVar1;
  undefined2 *puVar2;
  uint *puVar3;
  byte *pbVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  long lVar7;
  PL *pPVar8;
  undefined2 uVar9;
  uint uVar10;
  HWND HVar11;
  uint uVar12;
  int iVar13;
  ushort uVar14;
  PROD *pPVar15;
  PLPROD *pPVar16;
  uint *puVar17;
  undefined2 *puVar18;
  undefined2 unaff_SI;
  ushort unaff_DI;
  undefined2 uVar19;
  undefined2 unaff_SS;
  bool bVar20;
  LRESULT LVar21;
  ulong uVar22;
  PL *pPVar23;
  ulong uVar24;
  long lVar25;
  void *pvVar26;
  PLANET *pPVar27;
  undefined2 uVar28;
  short sVar29;
  ushort uVar30;
  UINT UVar31;
  ushort in_stack_0000ffc2;
  ulong in_stack_0000ffc4;
  ushort in_stack_0000ffc8;
  PLPROD *lpplprodT;
  short cMax;
  ushort prod;
  uint local_28;
  PROD *lpprod;
  RECT rc;
  short iMac;
  short fRefillSrc;
  short ipl;
  ushort prodLast;
  undefined2 local_12;
  short iDst;
  short c;
  HWND hwndLB;
  short iSrc;
  undefined4 lSel;
  
  if ((wParam == 1) || (wParam == 2)) {
    hwndProdDlg = 0;
    StickyDlgPos(hwnd,(POINT *)&ptStickyProduceDlg,0);
    EndDialog(hwnd,(uint)(wParam == 1));
    return;
  }
  if (wParam == 0x76) {
    WinHelp(hwnd,(LPCSTR)CONCAT22(0x1120,_szHelpFile),1,0x423);
    return;
  }
  if (wParam == 0x8b) {
    hwndLB = GetDlgItem(hwnd,0x417);
    HVar11 = GetDlgItem(hwnd,0x8b);
    SendMessage(HVar11,0x400,0,0);
    lVar25 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
    sel.pl.rgbImp._4_2_ = sel.pl.rgbImp._4_2_ | (uint)lVar25;
    sel.pl.rgbImp._6_2_ =
         sel.pl.rgbImp._6_2_ & 0xff7f | (uint)((ulong)lVar25 >> 0x10);
    lSel = SendMessage(hwndLB,0x409,0,0);
    FillPlanetProdLB(hwndLB,lpplProdGlob,(PLANET *)0x0);
    SendMessage(hwndLB,0x407,(uint)lSel,0);
    goto PRODUCE_RedrawText;
  }
  if ((wParam == 0x416) || (wParam == 0x417)) {
    uVar24 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
    if ((int)uVar24 == 1) goto PRODUCE_RedrawText;
    uVar24 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
    if ((int)uVar24 != 2) {
      return;
    }
    if (wParam == 0x416) goto PRODUCE_AddItem;
  }
  else {
    if (wParam == 0x418) {
PRODUCE_AddItem:
      HVar11 = GetDlgItem(hwnd,0x416);
      lVar25 = SendMessage(HVar11,0x409,0,0);
      if (((int)((ulong)lVar25 >> 0x10) < 1) && (lVar25 < 0)) {
        return;
      }
      iSrc = 0;
      while( true ) {
        lSel._2_2_ = (int)((ulong)lVar25 >> 0x10);
        lSel._0_2_ = (uint)lVar25;
        lVar7 = lVar25;
        if (cProdGlob <= iSrc) break;
        if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0) {
          lSel._2_2_ = lSel._2_2_ - (uint)((uint)lSel == 0);
          lVar7 = CONCAT22(lSel._2_2_,(uint)lSel + -1);
          bVar20 = lVar25 == 0;
          lVar25 = CONCAT22(lSel._2_2_,(uint)lSel + -1);
          if (bVar20) break;
        }
        iSrc = iSrc + 1;
      }
      uVar12 = (uint)(pProdGlob + iSrc)->dwFlags;
      local_28 = *(uint *)((int)&pProdGlob[iSrc].dwFlags + 2);
      uVar19 = 0x11;
      lSel = lVar7;
      uVar10 = GetAsyncKeyState(0x11);
      if ((uVar10 & 0xfffe) == 0) {
        uVar28 = 0x10;
        uVar10 = GetAsyncKeyState(0x10);
        if ((uVar10 & 0xfffe) == 0) {
          prod = uVar12 & 0xfc00 | 1;
        }
        else {
          lVar25 = __aFlshl(CONCAT22(uVar19,uVar28),unaff_DI);
          prod = uVar12 & 0xfc00 | (uint)lVar25;
          local_28 = local_28 | (uint)((ulong)lVar25 >> 0x10);
        }
      }
      else {
        uVar28 = 0x10;
        uVar10 = GetAsyncKeyState(0x10);
        if ((uVar10 & 0xfffe) == 0) {
          lVar25 = __aFlshl(CONCAT22(uVar19,uVar28),unaff_DI);
          uVar10 = (uint)((ulong)lVar25 >> 0x10);
          prod = uVar12 & 0xfc00 | (uint)lVar25;
        }
        else {
          lVar25 = __aFlshl(CONCAT22(uVar19,uVar28),unaff_DI);
          uVar10 = (uint)((ulong)lVar25 >> 0x10);
          prod = uVar12 & 0xfc00 | (uint)lVar25;
        }
        local_28 = local_28 | uVar10;
      }
      if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
        lVar25 = __aFlshl(CONCAT22(uVar19,uVar28),unaff_DI);
        lpplprodT._2_2_ = (int)(pProdGlob + iSrc)->dwFlags - (int)lVar25 & 0x3ff;
        pPVar15 = pProdGlob + iSrc;
        pPVar1 = pPVar15;
        *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
        puVar2 = (undefined2 *)((int)&pPVar15->dwFlags + 2);
        *puVar2 = *puVar2;
        pPVar15 = pProdGlob + iSrc;
        pPVar1 = pPVar15;
        *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags | lpplprodT._2_2_;
        puVar2 = (undefined2 *)((int)&pPVar15->dwFlags + 2);
        *puVar2 = *puVar2;
      }
      iMac = (short)((PLPROD *)lpplProdGlob)->iprodMac;
      HVar11 = GetDlgItem(hwnd,0x417);
      LVar21 = SendMessage(HVar11,0x409,0,0);
      if ((LVar21 < 0x10000) && (LVar21 < 0)) {
        iDst = iMac + -1;
        if (iDst < 0) {
          iDst = 0;
        }
      }
      else {
        iDst = (int)LVar21 + -1;
      }
      iVar13 = iDst;
      if (iDst < iMac) {
        lSel = LVar21;
        if (iDst < 0) {
LAB_10d0_1fde:
          iVar13 = iDst + 1;
          LVar21 = lSel;
          if (iVar13 < iMac) {
            prodLast = ((PLPROD *)lpplProdGlob + iDst + 2)->wFlags;
            local_12 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 2].iprodMax;
            iDst = iVar13;
            uVar24 = __aFulshr(CONCAT22(uVar19,uVar28),unaff_DI);
            lpplprodT._2_2_ = (uint)uVar24 & 0x7f;
            uVar24 = __aFulshr(CONCAT22(uVar19,uVar28),unaff_DI);
            iVar13 = iDst;
            LVar21 = lSel;
            if (lpplprodT._2_2_ == ((uint)uVar24 & 0x7f)) {
              uVar24 = __aFulshr(CONCAT22(uVar19,uVar28),unaff_DI);
              lpplprodT._2_2_ = (uint)uVar24 & 7;
              uVar24 = __aFulshr(CONCAT22(uVar19,uVar28),unaff_DI);
              iVar13 = iDst;
              LVar21 = lSel;
              if (lpplprodT._2_2_ == ((uint)uVar24 & 7)) goto PRODUCE_RingItUp;
            }
          }
          goto LAB_10d0_2099;
        }
        prodLast = ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags;
        local_12 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
        uVar24 = __aFulshr(CONCAT22(uVar19,uVar28),unaff_DI);
        lpplprodT._2_2_ = (uint)uVar24 & 0x7f;
        uVar24 = __aFulshr(CONCAT22(uVar19,uVar28),unaff_DI);
        if (lpplprodT._2_2_ != ((uint)uVar24 & 0x7f)) goto LAB_10d0_1fde;
        uVar24 = __aFulshr(CONCAT22(uVar19,uVar28),unaff_DI);
        lpplprodT._2_2_ = (uint)uVar24 & 7;
        uVar24 = __aFulshr(CONCAT22(uVar19,uVar28),unaff_DI);
        if (lpplprodT._2_2_ != ((uint)uVar24 & 7)) goto LAB_10d0_1fde;
PRODUCE_RingItUp:
        lVar25 = __aFlshl(CONCAT22(uVar19,uVar28),unaff_DI);
        uVar5 = lpplProdGlob._2_2_;
        uVar12 = *(uint *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
        pPVar16 = (PLPROD *)lpplProdGlob + iDst + 1;
        pPVar16->wFlags = ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0xfc00 | (uint)lVar25
        ;
        *(uint *)&pPVar16->iprodMax = uVar12 | (uint)((ulong)lVar25 >> 0x10);
        if (1 < (((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0x3ff)) {
          uVar24 = __aFulshr(CONCAT22(uVar19,uVar28),unaff_DI);
          if (((uint)uVar24 & 0x7f) == 3) {
            uVar24 = __aFulshr(CONCAT22(uVar19,uVar28),unaff_DI);
            if (((uint)uVar24 & 7) == 1) {
              uVar28 = lpplProdGlob._2_2_;
              uVar19 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
              pPVar16 = (PLPROD *)lpplProdGlob + iDst + 1;
              pPVar16->wFlags = ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0xfc00 | 1;
              *(undefined2 *)&pPVar16->iprodMax = uVar19;
            }
          }
        }
      }
      else {
LAB_10d0_2099:
        iDst = iVar13;
        lSel = LVar21;
        if (0x27 < iMac) {
          MessageBeep(0);
          goto PRODUCE_RedrawText;
        }
        if (iMac == (uint)((PLPROD *)lpplProdGlob)->iprodMax) {
          lpplProdGlob = (PLPROD *)LpplReAlloc((PL *)lpplProdGlob,iMac + 4);
          LVar21 = lSel;
        }
        lSel = LVar21;
        if (iDst != iMac) {
          __fmemmove((PLPROD *)
                             CONCAT22(lpplProdGlob._2_2_,
                                      (PLPROD *)lpplProdGlob + iDst + 2),
                             (PLPROD *)
                             CONCAT22(lpplProdGlob._2_2_,
                                      (PLPROD *)lpplProdGlob + iDst + 1),(iMac - iDst) * 4);
        }
        uVar19 = lpplProdGlob._2_2_;
        pPVar16 = (PLPROD *)lpplProdGlob + iDst + 1;
        pPVar16->wFlags = prod;
        *(uint *)&pPVar16->iprodMax = local_28;
        pbVar4 = &((PLPROD *)lpplProdGlob)->iprodMac;
        *pbVar4 = *pbVar4 + 1;
      }
      uVar28 = 0;
      pPVar27 = (PLANET *)0x0;
      pPVar16 = (PLPROD *)lpplProdGlob;
      uVar19 = lpplProdGlob._2_2_;
      HVar11 = GetDlgItem(hwnd,0x417);
      FillPlanetProdLB
                (HVar11,(PLPROD *)CONCAT22(uVar19,pPVar16),(PLANET *)CONCAT22(uVar28,pPVar27));
      HVar11 = GetDlgItem(hwnd,0x417);
      SendMessage(HVar11,0x407,iDst + 1,0);
      if (((pProdGlob + iSrc)->dwFlags & 0x3ff) == 0) {
        sVar29 = -1;
        HVar11 = GetDlgItem(hwnd,0x416);
        FillProdSrcLB(HVar11,sVar29);
      }
      goto PRODUCE_RedrawText;
    }
    if (wParam != 0x419) {
      if (wParam != 0x42d) {
        if ((wParam == 0x42e) || (wParam == 0x42f)) {
          if (wParam == 0x42f) {
            c = 1;
          }
          else {
            c = -1;
          }
          FinishProduction(1);
          sVar29 = GetKeyState(0x10);
          if (sVar29 < 0) {
            sVar29 = IdFindAdjStarbase(sel.pl.id,(uint)(wParam == 0x42f));
            SelectAdjPlanet(0,sVar29);
          }
          else {
            SelectAdjPlanet(c,0);
          }
          InitProduction((PROD *)0x0);
          InitializeProductionDlg(hwnd);
          GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,&rc));
          rc.top = yTopFutureTech;
          rc.bottom = dyArial8 * 9 + yTopFutureTech;
          InvalidateRect(hwnd,(RECT *)CONCAT22(unaff_SS,&rc),1);
          return;
        }
        if (wParam == 0x439) {
          HVar11 = GetDlgItem(hwnd,0x417);
          LVar21 = SendMessage(HVar11,0x409,0,0);
          if (LVar21 < 2) {
            return;
          }
          uVar28 = (undefined2)((ulong)lpplProdGlob >> 0x10);
          pPVar16 = (PLPROD *)lpplProdGlob;
          iMac = (short)pPVar16->iprodMac;
          lSel._0_2_ = (uint)LVar21 - 2;
          lSel._2_2_ = (int)((ulong)LVar21 >> 0x10) - (uint)((uint)LVar21 < 2);
          lVar25 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar25);
          uVar19 = *puVar18;
          uVar28 = puVar18[1];
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar6 = lpplProdGlob._2_2_;
          lVar25 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar25);
          uVar5 = *puVar18;
          uVar6 = puVar18[1];
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar9 = lpplProdGlob._2_2_;
          lVar25 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar25);
          *puVar18 = uVar5;
          puVar18[1] = uVar6;
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar5 = lpplProdGlob._2_2_;
          lVar25 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar25);
          *puVar18 = uVar19;
          puVar18[1] = uVar28;
          uVar28 = 0;
          pPVar27 = (PLANET *)0x0;
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar19 = lpplProdGlob._2_2_;
          HVar11 = GetDlgItem(hwnd,0x417);
          FillPlanetProdLB
                    (HVar11,(PLPROD *)CONCAT22(uVar19,pPVar16),(PLANET *)CONCAT22(uVar28,pPVar27));
          HVar11 = GetDlgItem(hwnd,0x417);
          SendMessage(HVar11,0x407,(uint)lSel + 1,0);
          goto PRODUCE_RedrawText;
        }
        if (wParam == 0x43a) {
          HVar11 = GetDlgItem(hwnd,0x417);
          LVar21 = SendMessage(HVar11,0x409,0,0);
          uVar12 = (uint)LVar21;
          uVar19 = (undefined2)((ulong)lpplProdGlob >> 0x10);
          pPVar16 = (PLPROD *)lpplProdGlob;
          iMac = (short)pPVar16->iprodMac;
          if (LVar21 < 1) {
            return;
          }
          if (-1 < LVar21) {
            if (0xffff < LVar21) {
              return;
            }
            if ((uint)iMac <= uVar12) {
              return;
            }
          }
          lSel._0_2_ = uVar12 - 1;
          lSel._2_2_ = (int)((ulong)LVar21 >> 0x10) - (uint)(uVar12 == 0);
          lVar25 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar25);
          uVar28 = *puVar18;
          uVar19 = puVar18[1];
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar6 = lpplProdGlob._2_2_;
          lVar25 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar25);
          uVar5 = *puVar18;
          uVar6 = puVar18[1];
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar9 = lpplProdGlob._2_2_;
          lVar25 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar25);
          *puVar18 = uVar5;
          puVar18[1] = uVar6;
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar5 = lpplProdGlob._2_2_;
          lVar25 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
          puVar18 = (undefined2 *)((int)&pPVar16[1].wFlags + (int)lVar25);
          *puVar18 = uVar28;
          puVar18[1] = uVar19;
          uVar28 = 0;
          pPVar27 = (PLANET *)0x0;
          pPVar16 = (PLPROD *)lpplProdGlob;
          uVar19 = lpplProdGlob._2_2_;
          HVar11 = GetDlgItem(hwnd,0x417);
          FillPlanetProdLB
                    (HVar11,(PLPROD *)CONCAT22(uVar19,pPVar16),(PLANET *)CONCAT22(uVar28,pPVar27));
          HVar11 = GetDlgItem(hwnd,0x417);
          SendMessage(HVar11,0x407,(uint)lSel + 2,0);
          goto PRODUCE_RedrawText;
        }
        if (wParam != 0x816) {
          return;
        }
      }
      ipl = 0;
      while( true ) {
        uVar19 = (undefined2)((ulong)lpplProdGlob >> 0x10);
        if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= ipl) break;
        for (iSrc = 0; iSrc < cProdGlob; iSrc = iSrc + 1) {
          uVar24 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
          uVar22 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
          if (((uint)uVar24 & 7) == ((uint)uVar22 & 7)) {
            uVar24 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
            uVar22 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
            if (((uint)uVar24 & 0x7f) == ((uint)uVar22 & 0x7f)) break;
          }
        }
        if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
          lVar25 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
          lpplprodT._2_2_ = (int)lVar25 + (int)(pProdGlob + iSrc)->dwFlags & 0x3ff;
          pPVar15 = pProdGlob + iSrc;
          pPVar1 = pPVar15;
          *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
          puVar2 = (undefined2 *)((int)&pPVar15->dwFlags + 2);
          *puVar2 = *puVar2;
          pPVar15 = pProdGlob + iSrc;
          pPVar1 = pPVar15;
          *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags | lpplprodT._2_2_;
          puVar2 = (undefined2 *)((int)&pPVar15->dwFlags + 2);
          *puVar2 = *puVar2;
        }
        ipl = ipl + 1;
      }
      if (wParam == 0x816) {
        uVar24 = __aFulmul(lParam,0x28);
        cMax = (uint)((PLPROD *)lpplProdGlob)->iprodMac +
               (uint)*(byte *)((int)((ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1)->
                                    rgpq + (int)uVar24 + -1);
        if (cMax == 0) {
          cMax = 1;
        }
        pPVar23 = LpplAlloc(4,cMax,htOrd);
        uVar19 = (undefined2)((ulong)pPVar23 >> 0x10);
        pPVar8 = (PL *)pPVar23;
        __fmemset((PL *)CONCAT22(uVar19,pPVar8 + 1),0,cMax << 2);
        iDst = 0;
        for (iSrc = 0; iSrc < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; iSrc = iSrc + 1)
        {
          uVar24 = __aFulshr(in_stack_0000ffc4,in_stack_0000ffc8);
          if ((((uint)uVar24 & 7) != 1) ||
             (uVar24 = __aFulshr(in_stack_0000ffc4,in_stack_0000ffc8),
             6 < ((uint)uVar24 & 0x7f))) {
            uVar28 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iSrc + 1].iprodMax;
            (pPVar8 + iDst + 1)->wFlags = ((PLPROD *)lpplProdGlob + iSrc + 1)->wFlags;
            *(undefined2 *)&pPVar8[iDst + 1].iMax = uVar28;
            iDst = iDst + 1;
          }
        }
        iSrc = 0;
        while (uVar24 = __aFulmul(lParam,0x28),
              iSrc < (int)(uint)*(byte *)((int)((ZIPPRODQ1 *)
                                               &vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1)->
                                               rgpq + (int)uVar24 + -1)) {
          sVar29 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
          if (((sVar29 != raMacintosh) ||
              (uVar24 = __aFulmul(lParam,0x28),
              2 < (*(uint *)((int)uVar24 + 0x2306 + iSrc * 2) & 0x3f))) &&
             ((sVar29 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
              sVar29 != raTerra ||
              ((uVar24 = __aFulmul(lParam,0x28),
               (*(uint *)((int)uVar24 + 0x2306 + iSrc * 2) & 0x3f) != 4 &&
               (uVar24 = __aFulmul(lParam,0x28),
               (*(uint *)((int)uVar24 + 0x2306 + iSrc * 2) & 0x3f) != 5)))))) {
            uVar12 = *(uint *)&pPVar8[iDst + 1].iMax;
            (pPVar8 + iDst + 1)->wFlags = (pPVar8 + iDst + 1)->wFlags;
            *(uint *)&pPVar8[iDst + 1].iMax = uVar12 & 0xfff1 | 2;
            __aFulmul(lParam,0x28);
            lVar25 = __aFlshl(in_stack_0000ffc4,in_stack_0000ffc8);
            uVar12 = *(uint *)&pPVar8[iDst + 1].iMax;
            (pPVar8 + iDst + 1)->wFlags = (pPVar8 + iDst + 1)->wFlags & 0x3ff | (uint)lVar25;
            *(uint *)&pPVar8[iDst + 1].iMax = uVar12 & 0xfffe | (uint)((ulong)lVar25 >> 0x10);
            __aFulmul(lParam,0x28);
            lVar25 = __aFlshl(in_stack_0000ffc4,in_stack_0000ffc8);
            uVar12 = *(uint *)&pPVar8[iDst + 1].iMax;
            (pPVar8 + iDst + 1)->wFlags = (pPVar8 + iDst + 1)->wFlags & 0xfc00 | (uint)lVar25;
            *(uint *)&pPVar8[iDst + 1].iMax = uVar12 | (uint)((ulong)lVar25 >> 0x10);
            iDst = iDst + 1;
          }
          iSrc = iSrc + 1;
        }
        pPVar8->iMac = (byte)iDst;
        FreePl((PL *)lpplProdGlob);
        lpplProdGlob = (PLPROD *)pPVar23;
        __aFulmul(lParam,0x28);
        lVar25 = __aFlshl(in_stack_0000ffc4,in_stack_0000ffc8);
        uVar30 = (ushort)in_stack_0000ffc4;
        sel.pl.rgbImp._4_2_ = sel.pl.rgbImp._4_2_ | (uint)lVar25;
        sel.pl.rgbImp._6_2_ =
             sel.pl.rgbImp._6_2_ & 0xff7f | (uint)((ulong)lVar25 >> 0x10);
        HVar11 = GetDlgItem(hwnd,0x8b);
        UVar31 = 0x401;
        uVar24 = __aFulshr(CONCAT22(HVar11,0x401),uVar30);
        SendMessage(HVar11,UVar31,(uint)uVar24 & 1,0);
      }
      else {
        ((PLPROD *)lpplProdGlob)->iprodMac = 0;
      }
      uVar28 = 0;
      pPVar27 = (PLANET *)0x0;
      pPVar16 = (PLPROD *)lpplProdGlob;
      uVar19 = lpplProdGlob._2_2_;
      HVar11 = GetDlgItem(hwnd,0x417);
      FillPlanetProdLB
                (HVar11,(PLPROD *)CONCAT22(uVar19,pPVar16),(PLANET *)CONCAT22(uVar28,pPVar27));
      HVar11 = GetDlgItem(hwnd,0x417);
      SendMessage(HVar11,0x407,0,0);
      sVar29 = -1;
      HVar11 = GetDlgItem(hwnd,0x416);
      FillProdSrcLB(HVar11,sVar29);
      HVar11 = GetDlgItem(hwnd,0x416);
      SendMessage(HVar11,0x407,0,0);
      goto PRODUCE_RedrawText;
    }
  }
  HVar11 = GetDlgItem(hwnd,0x417);
  LVar21 = SendMessage(HVar11,0x409,0,0);
  if (LVar21 < 1) {
    return;
  }
  uVar19 = (undefined2)((ulong)lpplProdGlob >> 0x10);
  pPVar16 = (PLPROD *)lpplProdGlob;
  iMac = (short)pPVar16->iprodMac;
  lSel._0_2_ = (int)LVar21 - 1;
  lSel._2_2_ = (int)((ulong)LVar21 >> 0x10) - (uint)((int)LVar21 == 0);
  lVar25 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
  uVar12 = *(uint *)((int)&pPVar16[1].wFlags + (int)lVar25);
  for (iSrc = 0; iSrc < cProdGlob; iSrc = iSrc + 1) {
    uVar24 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
    lpplprodT._2_2_ = (uint)uVar24 & 7;
    uVar24 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
    if (lpplprodT._2_2_ == ((uint)uVar24 & 7)) {
      uVar24 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
      lpplprodT._2_2_ = (uint)uVar24 & 0x7f;
      uVar24 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc2);
      if (lpplprodT._2_2_ == ((uint)uVar24 & 0x7f)) break;
    }
  }
  fRefillSrc = (short)(((pProdGlob + iSrc)->dwFlags & 0x3ff) == 0);
  uVar30 = 0x11;
  uVar10 = GetAsyncKeyState(0x11);
  if ((uVar10 & 0xfffe) == 0) {
    uVar19 = 0x10;
    uVar10 = GetAsyncKeyState(0x10);
    if ((uVar10 & 0xfffe) == 0) {
      c = 1;
    }
    else {
      c = 10;
    }
  }
  else {
    uVar19 = 0x10;
    uVar10 = GetAsyncKeyState(0x10);
    if ((uVar10 & 0xfffe) == 0) {
      c = 100;
    }
    else {
      c = 0x3fc;
    }
  }
  uVar24 = __aFulshr(CONCAT22(uVar30,uVar19),unaff_DI);
  if ((((uint)uVar24 & 7) == 1) &&
     (uVar24 = __aFulshr(CONCAT22(uVar30,uVar19),unaff_DI), ((uint)uVar24 & 0x7f) == 3)) {
    c = 0x3fc;
  }
  uVar10 = c;
  if ((int)(uVar12 & 0x3ff) <= c) {
    uVar10 = uVar12 & 0x3ff;
  }
  if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
    uVar24 = (pProdGlob + iSrc)->dwFlags;
    pPVar15 = pProdGlob + iSrc;
    pPVar1 = pPVar15;
    *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
    puVar2 = (undefined2 *)((int)&pPVar15->dwFlags + 2);
    *puVar2 = *puVar2;
    pPVar15 = pProdGlob + iSrc;
    pPVar1 = pPVar15;
    *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags | uVar10 + (int)uVar24 & 0x3ff;
    puVar2 = (undefined2 *)((int)&pPVar15->dwFlags + 2);
    *puVar2 = *puVar2;
  }
  pPVar16 = (PLPROD *)lpplProdGlob;
  uVar28 = lpplProdGlob._2_2_;
  c = uVar10;
  lVar25 = __aFlshl(CONCAT22(uVar30,uVar19),unaff_DI);
  lpplprodT._2_2_ = *(int *)((int)&pPVar16[1].wFlags + (int)lVar25) - uVar10 & 0x3ff;
  pPVar16 = (PLPROD *)lpplProdGlob + 1;
  uVar28 = lpplProdGlob._2_2_;
  lVar25 = __aFlshl(CONCAT22(uVar30,uVar19),unaff_DI);
  puVar17 = (uint *)((int)&pPVar16->wFlags + (int)lVar25);
  puVar3 = puVar17;
  *puVar3 = *puVar3 & 0xfc00;
  puVar3 = puVar17 + 1;
  *puVar3 = *puVar3;
  pPVar16 = (PLPROD *)lpplProdGlob + 1;
  uVar28 = lpplProdGlob._2_2_;
  lVar25 = __aFlshl(CONCAT22(uVar30,uVar19),unaff_DI);
  puVar17 = (uint *)((int)&pPVar16->wFlags + (int)lVar25);
  puVar3 = puVar17;
  *puVar3 = *puVar3 | lpplprodT._2_2_;
  puVar3 = puVar17 + 1;
  *puVar3 = *puVar3;
  pPVar16 = (PLPROD *)lpplProdGlob;
  uVar28 = lpplProdGlob._2_2_;
  lVar25 = __aFlshl(CONCAT22(uVar30,uVar19),unaff_DI);
  if ((*(uint *)((int)&pPVar16[1].wFlags + (int)lVar25) & 0x3ff) == 0) {
    iVar13 = lSel._2_2_ + (uint)(0xfffe < (uint)lSel);
    if ((iMac >> 0xf < iVar13) || ((iMac >> 0xf <= iVar13 && ((uint)iMac <= (uint)lSel + 1)))) {
      bVar20 = (uint)lSel == 0;
      lSel._0_2_ = (uint)lSel - 1;
      lSel._2_2_ = lSel._2_2_ - (uint)bVar20;
    }
    else {
      uVar14 = ((iMac - (uint)lSel) + -1) * 4;
      pPVar16 = (PLPROD *)lpplProdGlob;
      uVar28 = lpplProdGlob._2_2_;
      lVar25 = __aFlshl(CONCAT22(uVar19,uVar14),uVar30);
      pvVar26 = (void *)((int)&pPVar16[1].wFlags + (int)lVar25);
      pPVar16 = (PLPROD *)lpplProdGlob;
      uVar19 = lpplProdGlob._2_2_;
      lVar25 = __aFlshl((long)CONCAT22(uVar28,pvVar26),uVar14);
      __fmemmove((void *)CONCAT22(uVar19,(void *)((int)&pPVar16[1].wFlags + (int)lVar25)),
                         (void *)CONCAT22(uVar28,pvVar26),uVar14);
    }
    pbVar4 = &((PLPROD *)lpplProdGlob)->iprodMac;
    *pbVar4 = *pbVar4 - 1;
  }
  uVar28 = 0;
  pPVar27 = (PLANET *)0x0;
  pPVar16 = (PLPROD *)lpplProdGlob;
  uVar19 = lpplProdGlob._2_2_;
  HVar11 = GetDlgItem(hwnd,0x417);
  FillPlanetProdLB
            (HVar11,(PLPROD *)CONCAT22(uVar19,pPVar16),(PLANET *)CONCAT22(uVar28,pPVar27));
  if (-1 < lSel._2_2_) {
    HVar11 = GetDlgItem(hwnd,0x417);
    SendMessage(HVar11,0x407,(uint)lSel + 1,0);
  }
  if (fRefillSrc != 0) {
    sVar29 = -1;
    HVar11 = GetDlgItem(hwnd,0x416);
    FillProdSrcLB(HVar11,sVar29);
  }
PRODUCE_RedrawText:
  GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,&rc));
  rc.top = yTopFutureTech;
  rc.bottom = dyArial8 * 7 + yTopFutureTech;
  rc.left = rc.left + 0x82;
  InvalidateRect(hwnd,(RECT *)CONCAT22(unaff_SS,&rc),1);
  DrawProductionDlg(hwnd,0,&rc,-1);
  return;
}



// ======================================================================
// Function: InitializeProductionDlg
// Address: 10d0:3430
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d0353f) */
/* WARNING: Removing unreachable block (ram,0x10d0351f) */
/* WARNING: Removing unreachable block (ram,0x10d03544) */

void InitializeProductionDlg(HWND hwnd)

{
  char *pcVar1;
  char *pcVar2;
  HWND HVar3;
  HWND HVar4;
  PLPROD *pPVar5;
  undefined2 unaff_SS;
  ulong uVar6;
  PLANET *pPVar7;
  UINT UVar8;
  short mdFill;
  undefined2 uVar9;
  undefined2 uVar10;
  PROD *lpprod;
  short iSel;
  short i;
  char rgch [88];
  
  iSel = -1;
  pcVar1 = PszGetPlanetName(sel.pl.id);
  uVar10 = 0x1120;
  pcVar2 = PszGetCompressedString(idsProductionQueueS);
  _wsprintf((char *)CONCAT22(unaff_SS,rgch),(char *)CONCAT22(0x1120,pcVar2),pcVar1,uVar10);
  pcVar1 = rgch;
  HVar4 = hwnd;
  SetWindowText(hwnd,(LPCSTR)CONCAT22(unaff_SS,pcVar1));
  mdFill = -1;
  HVar3 = GetDlgItem(hwnd,0x416);
  FillProdSrcLB(HVar3,mdFill);
  HVar3 = GetDlgItem(hwnd,0x416);
  SendMessage(HVar3,0x407,0,0);
  i = 0;
  while( true ) {
    uVar10 = (undefined2)((ulong)lpplProdGlob >> 0x10);
    pPVar5 = (PLPROD *)lpplProdGlob;
    if ((int)(uint)pPVar5->iprodMac <= i) break;
    uVar6 = __aFulshr((ulong)CONCAT22(unaff_SS,pcVar1),HVar4);
    if ((((uint)uVar6 & 7) != 1) ||
       (uVar6 = __aFulshr((ulong)CONCAT22(unaff_SS,pcVar1),HVar4), 6 < ((uint)uVar6 & 0x7f))
       ) {
      iSel = i;
    }
    i = i + 1;
  }
  uVar9 = 0;
  pPVar7 = (PLANET *)0x0;
  HVar4 = GetDlgItem(hwnd,0x417);
  FillPlanetProdLB(HVar4,(PLPROD *)CONCAT22(uVar10,pPVar5),(PLANET *)CONCAT22(uVar9,pPVar7))
  ;
  HVar4 = GetDlgItem(hwnd,0x417);
  SendMessage(HVar4,0x407,iSel + 1,0);
  HVar4 = GetDlgItem(hwnd,0x8b);
  UVar8 = 0x401;
  uVar6 = __aFulshr(CONCAT22(HVar4,0x401),(ushort)pcVar1);
  SendMessage(HVar4,UVar8,(uint)uVar6 & 1,0);
  return;
}



// ======================================================================
// Function: DrawProductionDlg
// Address: 10d0:35dc
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d036d8) */
/* WARNING: Removing unreachable block (ram,0x10d0372f) */

void DrawProductionDlg(HWND hwnd,HDC hdc,RECT *prc,short iDraw)

{
  long lVar1;
  bool bVar2;
  PLPROD *pPVar3;
  char *pcVar4;
  HWND HVar5;
  short sVar6;
  int iVar7;
  uint uVar8;
  int iVar9;
  ushort uVar10;
  uint *puVar11;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  DWORD DVar12;
  long lVar13;
  ulong uVar14;
  undefined2 uVar15;
  HDC HVar16;
  ulong uVar17;
  ushort in_stack_0000ff6a;
  PROD prod;
  undefined8 rc;
  short k;
  short dxkT;
  undefined4 rgCost;
  short c;
  short i;
  short fCreatedDC;
  short idc;
  short iSrc;
  undefined4 lSel;
  
  uVar17 = CONCAT22(unaff_SI,unaff_DI);
  fCreatedDC = 0;
  if (hdc == 0) {
    fCreatedDC = 1;
    hdc = GetDC(hwnd);
  }
  SelectObject(hdc,rghfontArial8[0]);
  HVar16 = hdc;
  pcVar4 = PszGetCompressedString(idsKt);
  DVar12 = GetTextExtent(HVar16,(LPCSTR)CONCAT22(0x1120,pcVar4),2);
  dxkT = (short)DVar12;
  SelectObject(hdc,rghfontArial8[1]);
  SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  lVar13 = CONCAT22(lSel._2_2_,(int)lSel);
  i = 0;
  do {
    lSel = lVar13;
    if (1 < i) {
      GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,(RECT *)&rc));
      rc._2_2_ = rc._6_2_ - ((dyArial8 * 5) / 2 + 0xc);
      rc._6_2_ = (dyArial8 | 1U) + rc._2_2_;
      rc._0_2_ = 6;
      rc._4_2_ = dyArial8 + 6;
      DrawDiamond(hdc,(RECT *)&rc,hbrBBlue);
      rcProdDiamond.left = (int)rc;
      rcProdDiamond.top = rc._2_2_;
      rcProdDiamond.right = rc._4_2_;
      rcProdDiamond.bottom = rc._6_2_;
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsApplyDefineProductionTemplate,(char *)szWork);
      TextOut(hdc,rc._4_2_ + 4,rc._2_2_,szWork,c);
      if (fCreatedDC != 0) {
        ReleaseDC(hwnd,hdc);
      }
      return;
    }
    if (i == 0) {
      idc = 0x416;
    }
    else {
      idc = 0x417;
    }
    HVar5 = GetDlgItem(hwnd,idc);
    GetWindowRect(HVar5,(RECT *)CONCAT22(unaff_SS,(RECT *)&rc));
    ScreenToClient(hwnd,(POINT *)CONCAT22(unaff_SS,(POINT *)&rc));
    ScreenToClient(hwnd,(POINT *)CONCAT22(unaff_SS,(POINT *)((int)&rc + 4)));
    HVar5 = GetDlgItem(hwnd,idc);
    lVar13 = SendMessage(HVar5,0x409,0,0);
    uVar15 = lpplProdGlob._2_2_;
    pPVar3 = (PLPROD *)lpplProdGlob;
    if ((-1 < lVar13) && ((lVar13 != 0 || (i != 1)))) {
      if (i == 0) {
        iSrc = 0;
        while( true ) {
          lSel._2_2_ = (int)((ulong)lVar13 >> 0x10);
          lSel._0_2_ = (int)lVar13;
          lVar1 = lVar13;
          if (cProdGlob <= iSrc) break;
          if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0) {
            lSel._2_2_ = lSel._2_2_ - (uint)((int)lSel == 0);
            lVar1 = CONCAT22(lSel._2_2_,(int)lSel + -1);
            bVar2 = lVar13 == 0;
            lVar13 = CONCAT22(lSel._2_2_,(int)lSel + -1);
            if (bVar2) break;
          }
          iSrc = iSrc + 1;
        }
        prod.dwFlags._2_2_ = *(uint *)((int)&pProdGlob[iSrc].dwFlags + 2);
        prod.dwFlags._0_2_ = (uint)(pProdGlob + iSrc)->dwFlags & 0xfc00 | 1;
      }
      else {
        lSel._0_2_ = (int)lVar13 + -1;
        lSel._2_2_ = (int)((ulong)lVar13 >> 0x10) - (uint)((int)lVar13 == 0);
        lVar13 = __aFlshl(uVar17,in_stack_0000ff6a);
        lVar1 = CONCAT22(lSel._2_2_,(int)lSel);
        puVar11 = (uint *)((int)&pPVar3[1].wFlags + (int)lVar13);
        prod.dwFlags._0_2_ = *puVar11;
        prod.dwFlags._2_2_ = puVar11[1];
      }
      lSel = lVar1;
      GetProductionCosts(&sel.pl,(PROD *)CONCAT22(unaff_SS,&prod),&rgCost,idPlayer,
                         0);
      rc._6_2_ = yTopFutureTech + 4;
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsRequiredMinerals,(char *)szWork);
      TextOut(hdc,(int)rc,rc._6_2_,szWork,c);
      rc._0_2_ = (int)rc + 0x14;
      rc._4_2_ = rc._4_2_ + -0x14;
      for (k = 0; k < 4; k = k + 1) {
        c = k;
        if (k == 3) {
          c = 5;
        }
        rc._6_2_ = rc._6_2_ + dyArial8;
        SelectObject(hdc,rghfontArial8[1]);
        SetTextColor(hdc,CONCAT22(*(undefined2 *)(c * 4 + 0x44a),*(undefined2 *)(c * 4 + 0x448)));
        pcVar4 = (char *)*(undefined2 *)(c * 2 + 0x4cc);
        uVar15 = 0x1120;
        iVar7 = rc._6_2_;
        iVar9 = (int)rc;
        HVar16 = hdc;
        sVar6 = lstrlen((LPCSTR)CONCAT22(0x1120,(char *)*(undefined2 *)(c * 2 + 0x4cc)));
        TextOut(HVar16,iVar9,iVar7,(LPCSTR)CONCAT22(uVar15,pcVar4),sVar6);
        SelectObject(hdc,rghfontArial8[0]);
        SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
        c = _wsprintf(szWork,(char *)CONCAT22(0x1120,PCTLD),
                      *(undefined2 *)(&rgCost + k),*(undefined2 *)((int)&rgCost + k * 4 + 2));
        RightTextOut
                  (hdc,(rc._4_2_ - dxkT) + -2,rc._6_2_,(char *)szWork,c,
                   dxMaxMineralQuan);
        if (k < 3) {
          iVar7 = rc._4_2_ - dxkT;
          sVar6 = rc._6_2_;
          HVar16 = hdc;
          pcVar4 = PszGetCompressedString(idsKt);
          TextOut(HVar16,iVar7,sVar6,(LPCSTR)CONCAT22(0x1120,pcVar4),2);
        }
      }
      lVar13 = lSel;
      if (i != 0) {
        rc._6_2_ = rc._6_2_ + (dyArial8 * 3) / 2;
        SelectObject(hdc,rghfontArial8[1]);
        uVar14 = __aFulshr(uVar17,in_stack_0000ff6a);
        uVar8 = (uint)uVar14 & 0x7f;
        pcVar4 = PszGetCompressedString(idsDDoneCompletion);
        c = _wsprintf((char *)CONCAT22(unaff_SS,&stack0xff6a),(char *)CONCAT22(0x1120,pcVar4),uVar8)
        ;
        PszProductionETA
                  (&sel.pl,
                   (PLPROD *)CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob),
                   (int)lSel,(short *)0x0,(short *)0x0);
        _strcpy(&stack0xff6a + c,(char *)szWork);
        iVar9 = (int)rc + -0x14;
        pcVar4 = &stack0xff6a;
        uVar15 = unaff_SS;
        iVar7 = rc._6_2_;
        HVar16 = hdc;
        uVar10 = _strlen(&stack0xff6a);
        TextOut(HVar16,iVar9,iVar7,(LPCSTR)CONCAT22(uVar15,pcVar4),uVar10);
        SelectObject(hdc,rghfontArial8[0]);
        lVar13 = lSel;
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FillProdSrcLB
// Address: 10d0:3b00
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d03c3a) */
/* WARNING: Removing unreachable block (ram,0x10d03bce) */
/* WARNING: Removing unreachable block (ram,0x10d03b6b) */
/* WARNING: Removing unreachable block (ram,0x10d03b66) */
/* WARNING: Removing unreachable block (ram,0x10d03bfb) */
/* WARNING: Removing unreachable block (ram,0x10d03bf6) */
/* WARNING: Removing unreachable block (ram,0x10d03c3f) */
/* WARNING: Variable defined which should be unmapped: psz */

void FillProdSrcLB(HWND hwndLB,short mdFill)

{
  char *pcVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar2;
  ulong uVar3;
  char *psz;
  short i;
  undefined1 szT [6];
  char local_4e [76];
  
  uVar3 = CONCAT22(unaff_SI,unaff_DI);
  for (i = 0; i < 6; i = i + 1) {
    szT[i] = 0x20;
  }
  SendMessage(hwndLB,0x405,0,0);
  for (i = 0; i < cProdGlob; i = i + 1) {
    if (((pProdGlob + i)->dwFlags & 0x3ff) != 0) {
      pcVar1 = PszNameProdItem((PROD *)CONCAT22(0x1120,pProdGlob + i));
      _strcpy(local_4e,pcVar1);
      uVar2 = __aFulshr(uVar3,(ushort)pcVar1);
      if (((uint)uVar2 & 7) == 2) {
        uVar2 = __aFulshr(uVar3,(ushort)pcVar1);
        if (((uint)uVar2 & 0x7f) < 0x10) {
          szT[0] = 0x2a;
        }
        else {
          szT[0] = 0x23;
        }
      }
      else {
        uVar2 = __aFulshr(uVar3,(ushort)pcVar1);
        if (((uint)uVar2 & 0x7f) < 7) {
          szT[0] = 0x49;
          _strcat(local_4e,(char *)s__Auto_Build__1120_0cda);
        }
        else {
          szT[0] = 0x20;
        }
      }
      SendMessage(hwndLB,0x401,0,(LPARAM)CONCAT22(unaff_SS,szT));
    }
  }
  return;
}



// ======================================================================
// Function: PszNameProdItem
// Address: 10d0:3c92
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d03cde) */
/* WARNING: Removing unreachable block (ram,0x10d03ce7) */
/* WARNING: Removing unreachable block (ram,0x10d03e82) */
/* WARNING: Removing unreachable block (ram,0x10d03ee7) */
/* WARNING: Removing unreachable block (ram,0x10d03e99) */
/* WARNING: Removing unreachable block (ram,0x10d03e87) */
/* WARNING: Removing unreachable block (ram,0x10d03e9e) */
/* WARNING: Removing unreachable block (ram,0x10d03cec) */

char * PszNameProdItem(PROD *lpprod)

{
  int iVar1;
  int iVar2;
  uint uVar3;
  int iVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar5;
  PLANETARY *pPVar6;
  ushort in_stack_0000fff4;
  short iDelta;
  
  uVar5 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000fff4);
  uVar3 = (uint)uVar5 & 0x7f;
  uVar5 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000fff4);
  if (((uint)uVar5 & 7) == 2) {
    if (uVar3 < 0x10) {
      uVar5 = __aFulmul((ulong)uVar3,0x93);
      if ((*(uint *)((int)&rgshdef[0].wFlags + (int)uVar5) >> 9 & 1) == 0) {
        uVar5 = __aFulmul((ulong)uVar3,0x93);
        _strcpy((char *)szWork,
                        (char *)((int)&rgshdef[0].hul + 8 + (int)uVar5));
        goto LAB_10d0_3f19;
      }
    }
    else {
      iVar1 = uVar3 - 0x10;
      iVar2 = -(uint)(uVar3 < 0x10);
      uVar5 = __aFulmul(CONCAT22(iVar2,iVar1),0x93);
      if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + (int)uVar5 + 0x7b) >> 9 & 1) == 0) {
        uVar5 = __aFulmul(CONCAT22(iVar2,iVar1),0x93);
        __fstrcpy(szWork,
                          (char *)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x14e),
                                           (char *)(*(int *)(idPlayer * 4 + 0x14c) +
                                                    (int)uVar5 + 8)));
        if ((sel.pl.wFlags_0x4 >> 9 & 1) != 0) {
          iVar4 = *(int *)(*(int *)(idPlayer * 4 + 0x14c) +
                          ((uint)sel.pl.lStarbase & 0xf) * 0x93);
          uVar5 = __aFulmul(CONCAT22(iVar2,iVar1),0x93);
          iVar4 = iVar4 - *(int *)(*(int *)(idPlayer * 4 + 0x14c) + (int)uVar5);
          if (iVar4 < 1) {
            if (iVar4 < 0) {
              _strcat((char *)szWork,(char *)s__upgrade__1120_0cf5);
            }
          }
          else {
            _strcat((char *)szWork,(char *)s__downgrade__1120_0ce8);
          }
        }
        goto LAB_10d0_3f19;
      }
    }
    szWork[0] = '\0';
  }
  else if ((uVar3 < 0x12) || (0x1a < uVar3)) {
    if (uVar3 == 0x1b) {
      CchGetString(idsPlanetaryScanner,(char *)szWork);
    }
    else {
      CchGetString(uVar3 + idsMines,(char *)szWork);
    }
  }
  else {
    pPVar6 = LpplanetaryFromId(uVar3 - 0x12);
    __fstrcpy(szWork,
                      (char *)CONCAT22((int)((ulong)pPVar6 >> 0x10),((PLANETARY *)pPVar6)->szName));
  }
LAB_10d0_3f19:
  return (char *)szWork;
}



// ======================================================================
// Function: GetProductionCosts
// Address: 10d0:3f20
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d03faf) */
/* WARNING: Removing unreachable block (ram,0x10d03fa6) */

void GetProductionCosts(PLANET *lppl,PROD *lpprod,ulong *rgCost,short iplr,short fOnlyOne)

{
  ushort uVar1;
  short sVar2;
  PLANET *pPVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar4;
  bool bVar5;
  ulong uVar6;
  ushort *rgCost_00;
  undefined2 uVar7;
  ulong uVar8;
  ushort in_stack_0000ffac;
  ushort rgCostsPartNew [4];
  ushort rgCostsPartCur [4];
  short costHalf;
  short costUpg;
  HUL *lphulCur;
  HUL *lphulNew;
  short chs;
  short cost;
  PART part;
  short fStarbase;
  uint cItem;
  undefined2 local_24;
  short raMajor;
  int lpshdef;
  undefined2 local_1e;
  short j;
  short i;
  ushort rgCosts [4];
  uint iItem;
  int local_e;
  ushort rgCostsCur [5];
  
  uVar8 = CONCAT22(unaff_SI,unaff_DI);
  uVar4 = (undefined2)((ulong)lppl >> 0x10);
  pPVar3 = (PLANET *)lppl;
  raMajor = GetRaceStat((PLAYER *)rgplr + pPVar3->iPlayer,rsMajorAdv);
  fStarbase = 0;
  uVar6 = __aFulshr(uVar8,in_stack_0000ffac);
  iItem = (uint)uVar6 & 0x7f;
  local_e = 0;
  cItem = (uint)lpprod->dwFlags & 0x3ff;
  local_24 = 0;
  uVar6 = __aFulshr(uVar8,in_stack_0000ffac);
  if (((uint)uVar6 & 7) == 2) {
    if ((local_e == 0) && (iItem < 0x10)) {
      lpshdef = *(int *)(iplr * 4 + 0xfe);
      local_1e = *(undefined2 *)(iplr * 4 + 0x100);
    }
    else {
      lpshdef = *(int *)(iplr * 4 + 0x14c);
      local_1e = *(undefined2 *)(iplr * 4 + 0x14e);
      bVar5 = iItem < 0x10;
      iItem = iItem - 0x10;
      local_e = local_e - (uint)bVar5;
      fStarbase = 1;
    }
    uVar6 = __aFulmul(CONCAT22(local_e,iItem),0x93);
    if ((*(uint *)(lpshdef + (int)uVar6 + 0x7b) >> 9 & 1) != 0) {
      for (i = 0; i < 4; i = i + 1) {
        *(undefined2 *)(rgCost + i) = 0;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
      }
      return;
    }
    rgCost_00 = rgCosts;
    uVar6 = __aFulmul(CONCAT22(local_e,iItem),0x93);
    GetTrueHullCost(iplr,(HUL *)CONCAT22(local_1e,(HUL *)(lpshdef + (int)uVar6)),rgCost_00);
    if ((fStarbase != 0) && ((pPVar3->wFlags_0x4 >> 9 & 1) != 0)) {
      lphulCur = (HUL *)CONCAT22(*(undefined2 *)(iplr * 4 + 0x14e),
                                 (HUL *)(*(int *)(iplr * 4 + 0x14c) +
                                        (*(uint *)&pPVar3->lStarbase & 0xf) * 0x93));
      uVar6 = __aFulmul(CONCAT22(local_e,iItem),0x93);
      lphulNew = (HUL *)CONCAT22(local_1e,(HUL *)(lpshdef + (int)uVar6));
      GetTrueHullCost(iplr,lphulCur,rgCostsCur);
      if (lphulCur->ihuldef == lphulNew->ihuldef) {
        part.u_PART_0x0004.parmor = (ARMOR *)LphuldefFromId(lphulCur->ihuldef);
        costUpg = part.u_PART_0x0004._2_2_;
        costHalf = (short)part.u_PART_0x0004.parmor;
        part.hs.grhst =
             ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines
               |hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine);
        GetTruePartCost(iplr,&part,rgCostsPartCur);
        for (i = 0; i < 4; i = i + 1) {
          rgCosts[i] = rgCosts[i] - rgCostsPartCur[i];
        }
        chs = (uint)((HUL *)lphulCur)->chs;
        for (i = 0; i < chs; i = i + 1) {
          if (((HUL *)lphulCur)->rghs[i].wFlags_0x2 >> 8 != 0) {
            if (((HUL *)lphulNew)->rghs[i].wFlags_0x2 >> 8 != 0) {
              part.hs.grhst = (((HUL *)lphulCur)->rghs + i)->grhst;
              part.hs.wFlags_0x2 = ((HUL *)lphulCur)->rghs[i].wFlags_0x2;
              FLookupPart(&part);
              GetTruePartCost(iplr,&part,rgCostsPartCur);
              part.hs.grhst = (((HUL *)lphulNew)->rghs + i)->grhst;
              part.hs.wFlags_0x2 = ((HUL *)lphulNew)->rghs[i].wFlags_0x2;
              FLookupPart(&part);
              GetTruePartCost(iplr,&part,rgCostsPartNew);
              if ((((HUL *)lphulCur)->rghs + i)->grhst == (((HUL *)lphulNew)->rghs + i)->grhst) {
                if ((((HUL *)lphulCur)->rghs[i].wFlags_0x2 & 0xff) ==
                    (((HUL *)lphulNew)->rghs[i].wFlags_0x2 & 0xff)) {
                  for (j = 0; j < 4; j = j + 1) {
                    rgCostsPartCur[j] =
                         rgCostsPartCur[j] * (((HUL *)lphulCur)->rghs[i].wFlags_0x2 >> 8);
                    rgCostsPartNew[j] =
                         rgCostsPartNew[j] * (((HUL *)lphulNew)->rghs[i].wFlags_0x2 >> 8);
                    if (rgCostsPartNew[j] - rgCostsPartCur[j] < 0x8000) {
                      cost = rgCostsPartNew[j] - rgCostsPartCur[j];
                    }
                    else {
                      cost = 0;
                    }
                    if (rgCosts[j] < rgCostsPartNew[j] - cost) {
                      uVar1 = rgCosts[j];
                    }
                    else {
                      uVar1 = rgCostsPartNew[j] - cost;
                    }
                    rgCosts[j] = rgCosts[j] - uVar1;
                  }
                }
                else {
                  for (j = 0; j < 4; j = j + 1) {
                    rgCostsPartCur[j] =
                         rgCostsPartCur[j] * (((HUL *)lphulCur)->rghs[i].wFlags_0x2 >> 8);
                    rgCostsPartNew[j] =
                         rgCostsPartNew[j] * (((HUL *)lphulNew)->rghs[i].wFlags_0x2 >> 8);
                    if ((int)(rgCostsPartNew[j] - (int)(rgCostsPartCur[j] << 3) / 10) <
                        (int)(rgCostsPartNew[j] << 1) / 10) {
                      cost = (int)(rgCostsPartNew[j] << 1) / 10;
                    }
                    else {
                      cost = rgCostsPartNew[j] - (int)(rgCostsPartCur[j] << 3) / 10;
                    }
                    if (rgCosts[j] < rgCostsPartNew[j] - cost) {
                      uVar1 = rgCosts[j];
                    }
                    else {
                      uVar1 = rgCostsPartNew[j] - cost;
                    }
                    rgCosts[j] = rgCosts[j] - uVar1;
                  }
                }
              }
              else {
                for (j = 0; j < 4; j = j + 1) {
                  rgCostsPartCur[j] =
                       rgCostsPartCur[j] * (((HUL *)lphulCur)->rghs[i].wFlags_0x2 >> 8);
                  rgCostsPartNew[j] =
                       rgCostsPartNew[j] * (((HUL *)lphulNew)->rghs[i].wFlags_0x2 >> 8);
                  if ((int)(rgCostsPartNew[j] - (int)(rgCostsPartCur[j] * 7) / 10) <
                      (int)(rgCostsPartNew[j] * 3) / 10) {
                    cost = (int)(rgCostsPartNew[j] * 3) / 10;
                  }
                  else {
                    cost = rgCostsPartNew[j] - (int)(rgCostsPartCur[j] * 7) / 10;
                  }
                  if (rgCosts[j] < rgCostsPartNew[j] - cost) {
                    uVar1 = rgCosts[j];
                  }
                  else {
                    uVar1 = rgCostsPartNew[j] - cost;
                  }
                  rgCosts[j] = rgCosts[j] - uVar1;
                }
              }
            }
          }
        }
      }
      else {
        for (i = 0; i < 4; i = i + 1) {
          costHalf = rgCosts[i] / 2;
          costUpg = rgCosts[i] - (int)rgCostsCur[i] / 2;
          if (costUpg < costHalf) {
            rgCosts[i] = costHalf;
          }
          else {
            rgCosts[i] = costUpg;
          }
        }
      }
    }
    if ((fStarbase != 0) &&
       ((sVar2 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceISB), sVar2 != 0 ||
        (sVar2 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv),
        sVar2 == raMacintosh)))) {
      for (i = 0; i < 4; i = i + 1) {
        rgCosts[i] = rgCosts[i] - rgCosts[i] / 5;
      }
    }
    if (fStarbase == 0) {
      for (i = 0; i < 4; i = i + 1) {
        *(ushort *)(rgCost + i) = rgCosts[i];
        *(ushort *)((int)(rgCost + i) + 2) = 0;
      }
    }
    else {
      for (i = 0; i < 4; i = i + 1) {
        *(uint *)(rgCost + i) = (rgCosts[i] + 1) / 2;
        *(uint *)((int)(rgCost + i) + 2) = 0;
      }
    }
    goto LAB_10d0_4eef;
  }
  if ((iItem == 0) && (local_e == 0)) {
LAB_10d0_4915:
    for (i = 0; i < 3; i = i + 1) {
      *(undefined2 *)(rgCost + i) = 0;
      *(undefined2 *)((int)(rgCost + i) + 2) = 0;
    }
    sVar2 = GetRaceStat((PLAYER *)rgplr + iplr,rsMineBuild);
    *(short *)(rgCost + 3) = sVar2;
    *(int *)((int)rgCost + 0xe) = sVar2 >> 0xf;
    goto LAB_10d0_4eef;
  }
  if ((iItem == 1) && (local_e == 0)) {
LAB_10d0_4867:
    cost = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceCheapFact);
    if (((uint)gd.grBits >> 0xb & 1) == 0) {
      *(undefined2 *)(rgCost + 1) = 0;
      *(undefined2 *)((int)rgCost + 6) = 0;
      *(undefined2 *)rgCost = 0;
      *(undefined2 *)((int)rgCost + 2) = 0;
      *(int *)(rgCost + 2) = 4 - cost;
      *(int *)((int)rgCost + 10) = 4 - cost >> 0xf;
    }
    else {
      for (i = 0; i < 3; i = i + 1) {
        *(int *)(rgCost + i) = 2 - cost;
        *(int *)((int)(rgCost + i) + 2) = 2 - cost >> 0xf;
      }
    }
    sVar2 = GetRaceStat((PLAYER *)rgplr + iplr,rsFactBuild);
    *(short *)(rgCost + 3) = sVar2;
    *(int *)((int)rgCost + 0xe) = sVar2 >> 0xf;
  }
  else {
    if ((iItem == 2) && (local_e == 0)) {
LAB_10d0_4964:
      part.hs.grhst = hstPlanetary;
      part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | 9;
      FLookupPart(&part);
      i = 0;
      while( true ) {
        if (2 < i) break;
        uVar1 = (part.u_PART_0x0004.parmor._0_2_)->rgwtOreCost[i];
        *(ushort *)(rgCost + i) = uVar1;
        *(ushort *)((int)(rgCost + i) + 2) = (int)uVar1 >> 0xf;
        i = i + 1;
      }
      *(ushort *)(rgCost + 3) = (part.u_PART_0x0004.parmor._0_2_)->resCost;
      *(undefined2 *)((int)rgCost + 0xe) = 0;
      sVar2 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
      if (sVar2 == raDefend) {
        for (i = 0; i < 4; i = i + 1) {
          uVar7 = 0;
          uVar4 = 5;
          uVar6 = __aFulmul(CONCAT22(*(undefined2 *)((int)(rgCost + i) + 2),(int)rgCost[i]),
                                    3);
          uVar6 = __aFuldiv(uVar6,CONCAT22(uVar7,uVar4));
          *(int *)(rgCost + i) = (int)uVar6;
          *(undefined2 *)((int)(rgCost + i) + 2) = (int)(uVar6 >> 0x10);
        }
      }
      goto LAB_10d0_4eef;
    }
    if ((iItem == 3) && (local_e == 0)) {
LAB_10d0_4a48:
      for (i = 0; i < 3; i = i + 1) {
        *(undefined2 *)(rgCost + i) = 0;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
      }
      sVar2 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceMineralAlchemy);
      if (sVar2 == 0) {
        uVar4 = 100;
      }
      else {
        uVar4 = 0x19;
      }
      *(undefined2 *)(rgCost + 3) = uVar4;
      *(undefined2 *)((int)rgCost + 0xe) = 0;
      goto LAB_10d0_4eef;
    }
    if (((iItem == 4) && (local_e == 0)) || ((iItem == 5 && (local_e == 0)))) {
LAB_10d0_4c24:
      *(undefined2 *)(rgCost + 2) = 0;
      *(undefined2 *)((int)rgCost + 10) = 0;
      *(undefined2 *)(rgCost + 1) = 0;
      *(undefined2 *)((int)rgCost + 6) = 0;
      *(undefined2 *)rgCost = 0;
      *(undefined2 *)((int)rgCost + 2) = 0;
      sVar2 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceTT);
      if (sVar2 == 0) {
        *(undefined2 *)(rgCost + 3) = 100;
        *(undefined2 *)((int)rgCost + 0xe) = 0;
      }
      else {
        *(undefined2 *)(rgCost + 3) = 0x46;
        *(undefined2 *)((int)rgCost + 0xe) = 0;
      }
      if (raMajor == 3) {
        uVar6 = __aFuldiv(CONCAT22(*(undefined2 *)((int)rgCost + 0xe),(int)rgCost[3]),2);
        *(int *)(rgCost + 3) = (int)uVar6;
        *(undefined2 *)((int)rgCost + 0xe) = (int)(uVar6 >> 0x10);
      }
      goto LAB_10d0_4eef;
    }
    if ((iItem != 6) || (local_e != 0)) {
      if ((iItem == 7) && (local_e == 0)) goto LAB_10d0_4867;
      if ((iItem == 8) && (local_e == 0)) goto LAB_10d0_4915;
      if ((iItem == 9) && (local_e == 0)) goto LAB_10d0_4964;
      if ((iItem == 0xb) && (local_e == 0)) goto LAB_10d0_4a48;
      if ((iItem == 0xc) && (local_e == 0)) goto LAB_10d0_4c24;
      if ((iItem == 0xd) && (local_e == 0)) {
        part.hs.grhst = hstPlanetary;
        part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | 0xe;
        FLookupPart(&part);
        GetTruePartCost(iplr,&part,rgCosts);
        for (i = 0; i < 4; i = i + 1) {
          *(ushort *)(rgCost + i) = rgCosts[i];
          *(ushort *)((int)(rgCost + i) + 2) = 0;
        }
        goto LAB_10d0_4eef;
      }
      if ((((iItem == 0xe) && (local_e == 0)) || ((iItem == 0xf && (local_e == 0)))) ||
         ((iItem == 0x10 && (local_e == 0)))) {
        if (raMajor == 6) {
          j = 0x46;
        }
        else if (raMajor == 7) {
          j = 0x78;
        }
        else {
          j = 0x6e;
        }
        for (i = 0; i < 3; i = i + 1) {
          if ((iItem - 0xe != i) || (sVar2 = j, local_e + -1 + (uint)(0xd < iItem) != 0)) {
            sVar2 = 0;
          }
          *(short *)(rgCost + i) = sVar2;
          *(undefined2 *)((int)(rgCost + i) + 2) = 0;
        }
        if (raMajor == 6) {
          uVar4 = 5;
        }
        else {
          uVar4 = 10;
        }
        *(undefined2 *)(rgCost + i) = uVar4;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
        goto LAB_10d0_4eef;
      }
      if ((iItem != 0x11) || (local_e != 0)) {
        if ((((((iItem != 0x12) || (local_e != 0)) &&
              (((iItem != 0x13 || (local_e != 0)) && ((iItem != 0x14 || (local_e != 0)))))) &&
             ((((iItem != 0x15 || (local_e != 0)) && ((iItem != 0x16 || (local_e != 0)))) &&
              ((iItem != 0x17 || (local_e != 0)))))) && ((iItem != 0x18 || (local_e != 0)))) &&
           (((iItem != 0x19 || (local_e != 0)) && ((iItem != 0x1a || (local_e != 0)))))) {
          if ((iItem != 0x1b) || (local_e != 0)) goto LAB_10d0_4eef;
          iItem = 0x12;
          local_e = 0;
        }
        part.hs.grhst = hstPlanetary;
        chs = iItem - 0x12;
        part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | chs & 0xffU;
        FLookupPart(&part);
        GetTruePartCost(iplr,&part,rgCosts);
        for (i = 0; i < 4; i = i + 1) {
          *(ushort *)(rgCost + i) = rgCosts[i];
          *(ushort *)((int)(rgCost + i) + 2) = 0;
        }
        goto LAB_10d0_4eef;
      }
    }
    if (raMajor == 6) {
      j = 0x19;
    }
    else if (raMajor == 7) {
      j = 0x30;
    }
    else {
      j = 0x2c;
    }
    for (i = 0; i < 3; i = i + 1) {
      *(short *)(rgCost + i) = j;
      *(undefined2 *)((int)(rgCost + i) + 2) = 0;
    }
    if (raMajor == 6) {
      uVar4 = 5;
    }
    else {
      uVar4 = 10;
    }
    *(undefined2 *)(rgCost + i) = uVar4;
    *(undefined2 *)((int)(rgCost + i) + 2) = 0;
  }
LAB_10d0_4eef:
  if (fOnlyOne == 0) {
    for (i = 0; i < 4; i = i + 1) {
      uVar6 = __aFulmul(CONCAT22(*(undefined2 *)((int)(rgCost + i) + 2),(int)rgCost[i]),
                                CONCAT22(local_24,cItem));
      *(int *)(rgCost + i) = (int)uVar6;
      *(undefined2 *)((int)(rgCost + i) + 2) = (int)(uVar6 >> 0x10);
    }
  }
  return;
}



// ======================================================================
// Function: EstimateItemProdSched
// Address: 10d0:4f40
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d05159) */
/* WARNING: Removing unreachable block (ram,0x10d050ac) */
/* WARNING: Removing unreachable block (ram,0x10d052cc) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10d05184) */
/* WARNING: Removing unreachable block (ram,0x10d051ac) */

void EstimateItemProdSched
          (PLANET *lppl,PLPROD *lpplprod,short iItem,short *piFirst,short *piLast)

{
  PLANET *pPVar1;
  PLANET *pPVar2;
  byte bVar3;
  PROD *pprodPartial;
  uint uVar4;
  int iVar5;
  PLPROD *pPVar6;
  PLANET *pPVar7;
  PLANET *pPVar8;
  undefined2 uVar9;
  ushort unaff_SS;
  bool bVar10;
  PL *pPVar11;
  ulong uVar12;
  long lVar13;
  undefined2 uVar14;
  uint local_74;
  PROD *lpprod;
  undefined4 rgRes;
  uint local_62;
  int local_60;
  short iMac;
  short fAlchemy;
  short iPass;
  short j;
  short i;
  short mdStatus;
  PROD prodPartial;
  short cBuilt;
  long rglQuan [3];
  PLANET pl;
  undefined4 cResearch;
  
  if (((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) {
                    /* WARNING: Load size is inaccurate */
    lpplprod = (PLPROD *)
               CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                        ((PLANET *)lppl)->lpplprod);
  }
  pPVar8 = &pl;
  pPVar7 = (PLANET *)lppl;
  for (iVar5 = 0x1c; iVar5 != 0; iVar5 = iVar5 + -1) {
    pPVar2 = pPVar8;
    pPVar8 = (PLANET *)&pPVar8->iPlayer;
    pPVar1 = pPVar7;
    pPVar7 = (PLANET *)&pPVar7->iPlayer;
    pPVar2->id = pPVar1->id;
  }
  uVar9 = (undefined2)((ulong)lpplprod >> 0x10);
  pPVar6 = (PLPROD *)lpplprod;
  pPVar11 = LpplAlloc(4,(uint)pPVar6->iprodMax,htOrd);
  pl.lpplprod._2_2_ = (ushort)((ulong)pPVar11 >> 0x10);
  pl.lpplprod._0_2_ = (PLPROD *)pPVar11;
  __fmemcpy((PL *)CONCAT22(pl.lpplprod._2_2_,(PL *)(PLPROD *)pl.lpplprod + 1),
                    (PLPROD *)CONCAT22(uVar9,pPVar6 + 1),(uint)pPVar6->iprodMac << 2);
  bVar3 = pPVar6->iprodMac;
  ((PLPROD *)pl.lpplprod)->iprodMac = bVar3;
  iMac = (short)bVar3;
  prodPartial.dwFlags._0_2_ = (uint)prodPartial.dwFlags & 0xfc00;
  *piLast = 0;
  *piFirst = 0;
  iPass = 1;
  do {
    if (99 < iPass) {
      if (*piFirst == 0) {
        *piFirst = 100;
      }
      *piLast = 100;
      lVar13 = cResearch;
PRODUCE_LCleanUp:
      if (((PL *)(PLPROD *)pl.lpplprod != (PL *)0x0) || (pl.lpplprod._2_2_ != 0)) {
        cResearch = lVar13;
        FreePl((PL *)CONCAT22(pl.lpplprod._2_2_,(PLPROD *)pl.lpplprod));
      }
      return;
    }
    EstMineralsMined((PLANET *)CONCAT22(unaff_SS,&pl),rglQuan,-1,1);
    for (j = 0; j < 3; j = j + 1) {
      uVar9 = *(undefined2 *)((int)pl.rgwtMin + j * 4 + 2);
      iVar5 = j * 4;
      *(int *)(&rgRes + j) = (int)pl.rgwtMin[j];
      *(undefined2 *)((int)&rgRes + iVar5 + 2) = uVar9;
    }
    local_62 = CResourcesAtPlanet
                         ((PLANET *)CONCAT22(unaff_SS,&pl),((PLANET *)lppl)->iPlayer);
    local_60 = (int)local_62 >> 0xf;
    uVar12 = __aFulshr(CONCAT22((PROD *)lpprod,local_74),lpprod._2_2_);
    if ((uVar12 & 1) == 0) {
      uVar14 = 0;
      uVar9 = 100;
      uVar12 = __aFulmul(CONCAT22(local_60,local_62),
                                 (long)(int)*(char *)((int)&rgplr[0].pctResearch +
                                                     ((PLANET *)lppl)->iPlayer * 0xc0));
      lVar13 = __aFldiv(uVar12,CONCAT22(uVar14,uVar9));
      cResearch = lVar13;
      bVar10 = local_62 < (uint)lVar13;
      local_62 = local_62 - (uint)lVar13;
      local_60 = (local_60 - (int)((ulong)lVar13 >> 0x10)) - (uint)bVar10;
    }
    else {
      cResearch._0_2_ = 0;
      cResearch._2_2_ = 0;
      lVar13 = 0;
    }
    fAlchemy = 0;
    for (i = -1; i < iMac; i = i + 1) {
      if (i == -1) {
        lpprod._0_2_ = &prodPartial;
        lpprod._2_2_ = unaff_SS;
      }
      else {
        lpprod._0_2_ = (PROD *)((PLPROD *)pl.lpplprod + i + 1);
        lpprod._2_2_ = pl.lpplprod._2_2_;
      }
      if ((((PROD *)CONCAT22(lpprod._2_2_,(PROD *)lpprod))->dwFlags & 0x3ff) != 0) {
        cResearch = lVar13;
        uVar12 = __aFulshr(CONCAT22((PROD *)lpprod,local_74),lpprod._2_2_);
        if (((uint)uVar12 & 0x7f) == 3) {
          uVar12 = __aFulshr(CONCAT22((PROD *)lpprod,local_74),lpprod._2_2_);
          if (((uint)uVar12 & 7) == 1) {
            if (i < iMac + -1) {
              lVar13 = cResearch;
              if (i != iItem) {
                fAlchemy = 1;
                goto LAB_10d0_53bf;
              }
              *piLast = -1;
              *piFirst = -1;
              goto PRODUCE_LCleanUp;
            }
            uVar9 = *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2);
            *(uint *)&((PROD *)CONCAT22(lpprod._2_2_,(PROD *)lpprod))->dwFlags =
                 (uint)((PROD *)CONCAT22(lpprod._2_2_,(PROD *)lpprod))->dwFlags & 0xfc00 | 0x3fc;
            *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2) = uVar9;
          }
        }
        if (i == -1) {
          pprodPartial = (PROD *)0x0;
        }
        else {
          pprodPartial = &prodPartial;
        }
        cBuilt = CBuildProdItem
                           ((PLANET *)CONCAT22(unaff_SS,&pl),
                            (PROD *)CONCAT22(lpprod._2_2_,(PROD *)lpprod),pprodPartial,&rgRes,
                            fAlchemy,&mdStatus,0);
        if (iItem == i) {
          if ((0 < cBuilt) && (*piFirst == 0)) {
            *piFirst = iPass;
          }
          lVar13 = cResearch;
          if (mdStatus == 2) {
            if (*piFirst != 0) {
              *piLast = iPass + -1;
            }
            goto PRODUCE_LCleanUp;
          }
          if ((mdStatus == 0) || (mdStatus == 1)) {
            *piLast = iPass;
            goto PRODUCE_LCleanUp;
          }
        }
        fAlchemy = 0;
        uVar12 = __aFulshr(CONCAT22((PROD *)lpprod,local_74),lpprod._2_2_);
        lVar13 = cResearch;
        if (((uint)uVar12 & 7) == 1) {
          uVar12 = __aFulshr(CONCAT22((PROD *)lpprod,local_74),lpprod._2_2_);
          uVar4 = (uint)uVar12 & 0x7f;
          if ((uVar12 & 0x7f) == 0) {
LAB_10d0_52ea:
            lVar13 = __aFlshl(CONCAT22((PROD *)lpprod,local_74),lpprod._2_2_);
            uVar12 = lVar13 + CONCAT22(pl.rgbImp._2_2_,pl.rgbImp._0_2_) & 0xfff00;
            local_74 = (uint)(uVar12 >> 0x10);
            uVar4 = pl.rgbImp._0_2_ & 0xff | (uint)uVar12;
            pl.rgbImp[0] = (char)uVar4;
            pl.rgbImp[1] = (char)(uVar4 >> 8);
            uVar4 = pl.rgbImp._2_2_ & 0xfff0 | local_74;
            pl.rgbImp[2] = (char)uVar4;
            pl.rgbImp[3] = (char)(uVar4 >> 8);
            lVar13 = cResearch;
          }
          else if ((uVar4 == 1) || (uVar4 == 7)) {
            lVar13 = __aFlshl(CONCAT22((PROD *)lpprod,local_74),lpprod._2_2_);
            local_74 = (int)((ulong)lVar13 >> 0x10) + pl.rgbImp._2_2_ +
                       (uint)CARRY2((uint)lVar13,pl.rgbImp._0_2_) & 0xfff0;
            uVar4 = pl.rgbImp._2_2_ & 0xf | local_74;
            pl.rgbImp[2] = (char)uVar4;
            pl.rgbImp[3] = (char)(uVar4 >> 8);
            lVar13 = cResearch;
          }
          else {
            lVar13 = cResearch;
            if (uVar4 == 8) goto LAB_10d0_52ea;
          }
        }
        if (4 < mdStatus) break;
      }
LAB_10d0_53bf:
    }
    cResearch._0_2_ = (int)lVar13;
    if (iItem < 0) {
      *piFirst = local_62;
      if (iItem == -1) {
        *piFirst = *piFirst + (int)cResearch;
      }
      goto PRODUCE_LCleanUp;
    }
    cResearch = lVar13;
    for (j = 0; j < 3; j = j + 1) {
      uVar9 = *(undefined2 *)((int)&rgRes + j * 4 + 2);
      *(undefined2 *)(pl.rgwtMin + j) = *(undefined2 *)(&rgRes + j);
      *(undefined2 *)((int)pl.rgwtMin + j * 4 + 2) = uVar9;
    }
    ChgPopFromPlanet((PLANET *)CONCAT22(unaff_SS,&pl),1);
    iPass = iPass + 1;
  } while( true );
}



// ======================================================================
// Function: ZipProdDlg
// Address: 10d0:5490
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d05b5e) */
/* WARNING: Removing unreachable block (ram,0x10d05b29) */
/* WARNING: Removing unreachable block (ram,0x10d05b63) */
/* WARNING: Variable defined which should be unmapped: pszT */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short ZipProdDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char *pcVar1;
  char cVar2;
  char *pcVar3;
  HWND HVar4;
  short sVar5;
  int iVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar7;
  void *pvVar8;
  undefined2 uVar9;
  char *pszT;
  char *psz;
  HWND hwndRad;
  undefined1 rc2 [4];
  char *psz__56;
  void *lpProc;
  short dy;
  undefined8 rc;
  short iBase;
  short i;
  PAINTSTRUCT ps;
  HDC hdc;
  
  if (message == WM_PAINT) {
    hdc = BeginPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,&ps));
    GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,(RECT *)&rc));
    HVar4 = GetDlgItem(hwnd,0x431);
    GetWindowRect(HVar4,(RECT *)CONCAT22(unaff_SS,(RECT *)(rc2 + 2)));
    ScreenToClient(hwnd,(POINT *)CONCAT22(unaff_SS,(POINT *)(rc2 + 2)));
    HVar4 = GetDlgItem(hwnd,0x434);
    GetWindowRect(HVar4,(RECT *)CONCAT22(unaff_SS,(RECT *)&rc));
    ScreenToClient(hwnd,(POINT *)CONCAT22(unaff_SS,(POINT *)((int)&rc + 4)));
    lpProc = (void *)rc._4_2_;
    dy = rc._6_2_;
    ExpandRc((RECT *)(rc2 + 2),dyArial8,dyArial8 >> 1);
    _Draw3dFrame();
    SelectObject(hdc,rghfontArial8[1]);
    SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    rc2._0_2_ = CchGetString(idsCustomOrders,(char *)szWork);
    TextOut(hdc,(short)(rc2._2_2_ + 8),(int)psz__56 - (dyArial8 >> 1),szWork,
            rc2._0_2_);
    psz__56 = (char *)(dy + 8);
    if (*(char *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) != '\0') {
      rc2._0_2_ = CchGetString
                            (*(byte *)((int)(ZIPPRODQ1 *)
                                            &vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 +
                                      iResTechNow * 0x28) + idsContributeResearch,
                             (char *)szWork);
      TextOut(hdc,rc2._2_2_,vyZPDStatic,szWork,rc2._0_2_);
    }
    EndPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,&ps));
    return 1;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,(RECT *)&rc));
    FillRect(wParam,(RECT *)CONCAT22(unaff_SS,(RECT *)&rc),hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    for (i = 0x431; i < 0x435; i = i + 1) {
      dy = (short)lParam;
      HVar4 = GetDlgItem(hwnd,i);
      if (dy == HVar4) break;
    }
    if (0x434 < i) {
      return 0;
    }
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    return hbrButtonFace;
  }
  if (message == WM_INITDIALOG) {
    HVar4 = hwnd;
    pcVar3 = PszGetCompressedString(idsCustomizeProductionTemplates);
    SetWindowText(HVar4,(LPCSTR)CONCAT22(0x1120,pcVar3));
    GetWindowRect(hwnd,(RECT *)CONCAT22(unaff_SS,(RECT *)&rc));
    GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,(RECT *)rc2));
    dy = (rc._6_2_ - rc._2_2_) - (int)lpProc;
    HVar4 = GetDlgItem(hwnd,0x417);
    GetWindowRect(HVar4,(RECT *)CONCAT22(unaff_SS,(RECT *)rc2));
    MapWindowPoints(0,hwnd,(POINT *)CONCAT13((char)((uint)unaff_SS >> 8),
                                             CONCAT12((char)unaff_SS,rc2)),2);
    vyZPDStatic = (int)lpProc + 2;
    dy = dy + (int)lpProc + dyArial8 + 6;
    SetWindowPos(hwnd,0,0,0,rc._4_2_ - (int)rc,dy,6);
    CheckRadioButton(hwnd,0x431,0x434,0x431);
    EnableZipProdBtns(hwnd,0);
    iResTechNow = 0;
    FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd);
    for (i = 0x431; i < 0x435; i = i + 1) {
      iBase = i + -0x431;
      if (*(char *)((int)&vrgZipProd[0].fValid + iBase * 0x28) == '\0') {
        pcVar3 = PszGetCompressedString(idsUnusedD);
        _wsprintf(szWork,(char *)CONCAT22(0x1120,pcVar3),(char)pcVar3,iBase + 1);
      }
      else {
        pszT = (char *)szWork;
        pcVar3 = pszT;
        psz = ((ZIPPRODQ *)vrgZipProd)[iBase].szName;
        while (pszT = pcVar3, *psz != '\0') {
          pcVar1 = psz + 1;
          cVar2 = *psz;
          *pszT = cVar2;
          pcVar3 = pszT + 1;
          psz = pcVar1;
          if (cVar2 == '&') {
            pszT[1] = '&';
            pcVar3 = pszT + 2;
          }
        }
        *pszT = '\0';
      }
      HVar4 = GetDlgItem(hwnd,i);
      SetWindowText(HVar4,szWork);
    }
    StickyDlgPos(hwnd,(POINT *)&ptStickyZipProdDlg,1);
    if (((uint)gd.grBits >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    return 1;
  }
  if (message != WM_COMMAND) {
    return 0;
  }
  uVar7 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),(ushort)pszT);
  if ((((int)uVar7 == 0) && (0x430 < wParam)) && (wParam < 0x435)) {
    iResTechNow = wParam - 0x431;
    EnableZipProdBtns(hwnd,iResTechNow);
    FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd + iResTechNow);
    return 0;
  }
  if ((wParam == 1) || (wParam == 2)) {
    StickyDlgPos(hwnd,(POINT *)&ptStickyZipProdDlg,0);
    EndDialog(hwnd,(uint)(wParam == 1));
    vyZPDStatic = -1;
    if (((uint)gd.grBits >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    return 1;
  }
  if ((wParam != 0x816) && (wParam != 0x41b)) {
    if (wParam == 0x817) {
      *(undefined1 *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) = 0;
      iVar6 = iResTechNow + 1;
      pcVar3 = PszGetCompressedString(idsUnusedD);
      _wsprintf(szWork,(char *)CONCAT22(0x1120,pcVar3),iVar6);
      HVar4 = GetDlgItem(hwnd,iResTechNow + 0x431);
      SetWindowText(HVar4,szWork);
      FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd + iResTechNow);
      gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xffdf | 0x20;
      return 0;
    }
    if (wParam != 0x76) {
      return 0;
    }
    WinHelp(hwnd,(LPCSTR)CONCAT22(0x1120,_szHelpFile),1,0x452);
    return 1;
  }
  if (*(char *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) == '\0') {
    sVar5 = iResTechNow;
    pcVar3 = PszGetCompressedString(idsCustomD);
    _wsprintf(szWork,(char *)CONCAT22(0x1120,pcVar3),sVar5);
  }
  else {
    _strcpy((char *)szWork,
                    ((ZIPPRODQ *)vrgZipProd)[iResTechNow].szName);
  }
  HVar4 = 0x1080;
  uVar9 = 0x880;
  pcVar3 = (char *)hInst;
  pvVar8 = MakeProcInstance(RenameZipDlg,hInst);
  dy = (short)((ulong)pvVar8 >> 0x10);
  lpProc = (void *)pvVar8;
  if (iResTechNow != 0) {
    sVar5 = DialogBox(0,(LPCSTR)CONCAT22(0x7e3,hwndFrame),dy,(char)pvVar8);
    if (sVar5 == 0) goto LAB_10d0_5ce2;
    if (szWork[0] == '\0') {
      sVar5 = iResTechNow;
      pcVar3 = PszGetCompressedString(idsCustomD);
      _wsprintf(szWork,(char *)CONCAT22(0x1120,pcVar3),sVar5);
    }
    _strcpy(((ZIPPRODQ *)vrgZipProd)[iResTechNow].szName,
                    (char *)szWork);
    rc2._2_2_ = (char *)szWork + 0x40;
    psz__56 = (char *)szWork;
    pcVar3 = (char *)rc2._2_2_;
    while (rc2._2_2_ = pcVar3, *psz__56 != '\0') {
      pcVar1 = psz__56 + 1;
      cVar2 = *psz__56;
      *(char *)rc2._2_2_ = cVar2;
      pcVar3 = (char *)(rc2._2_2_ + 1);
      psz__56 = pcVar1;
      if (cVar2 == '&') {
        *(char *)(rc2._2_2_ + 1) = '&';
        pcVar3 = (char *)(rc2._2_2_ + 2);
      }
    }
    *(char *)rc2._2_2_ = '\0';
    HVar4 = GetDlgItem(hwnd,iResTechNow + 0x431);
    uVar9 = 0x1120;
    pcVar3 = (char *)szWork + 0x40;
    SetWindowText(HVar4,szWork + 0x40);
    pvVar8 = (void *)CONCAT22(dy,lpProc);
  }
  if (wParam == 0x816) {
    *(undefined1 *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) = 1;
    rc2._0_2_ = 0;
    i = 0;
    while( true ) {
      dy = (short)((ulong)pvVar8 >> 0x10);
      lpProc = (void *)pvVar8;
      if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= i) break;
      uVar7 = __aFulshr((ulong)CONCAT22(uVar9,pcVar3),HVar4);
      if ((((uint)uVar7 & 7) == 1) &&
         (uVar7 = __aFulshr((ulong)CONCAT22(uVar9,pcVar3),HVar4), ((uint)uVar7 & 0x7f) < 7))
      {
        uVar7 = __aFulshr((ulong)CONCAT22(uVar9,pcVar3),HVar4);
        pvVar8 = (void *)CONCAT22(dy,lpProc);
        *(uint *)(iResTechNow * 0x28 + 0x2306 + rc2._0_2_ * 2) =
             *(uint *)(iResTechNow * 0x28 + 0x2306 + rc2._0_2_ * 2) & 0xffc0 |
             (uint)uVar7 & 0x3f;
        *(uint *)(iResTechNow * 0x28 + 0x2306 + rc2._0_2_ * 2) =
             *(uint *)(iResTechNow * 0x28 + 0x2306 + rc2._0_2_ * 2) & 0x3f |
             ((PLPROD *)lpplProdGlob + i + 1)->wFlags << 6;
        rc2._0_2_ = rc2._0_2_ + 1;
        if (0xb < (int)rc2._0_2_) break;
      }
      pvVar8 = (void *)CONCAT22(dy,lpProc);
      i = i + 1;
    }
    dy = (short)((ulong)pvVar8 >> 0x10);
    lpProc = (void *)pvVar8;
    *(undefined1 *)
     ((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 +
     iResTechNow * 0x28 + 1) = (char)rc2._0_2_;
    uVar7 = __aFulshr((ulong)CONCAT22(uVar9,pcVar3),HVar4);
    *(byte *)((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 +
             iResTechNow * 0x28) = (byte)uVar7 & 1;
    FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd + iResTechNow);
    pvVar8 = (void *)CONCAT22(dy,lpProc);
  }
  dy = (short)((ulong)pvVar8 >> 0x10);
  lpProc = (void *)pvVar8;
  EnableZipProdBtns(hwnd,iResTechNow);
LAB_10d0_5ce2:
  FreeProcInstance((FARPROC)CONCAT22(dy,lpProc));
  SetFocus(hwnd);
  gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xffdf | 0x20;
  return 0;
}



// ======================================================================
// Function: EnableZipProdBtns
// Address: 10d0:5df0
// Segment: MEMORY_PRODUCE
// ======================================================================


void EnableZipProdBtns(HWND hwnd,short iSel)

{
  BOOL BVar1;
  HWND HVar2;
  short fEnabled;
  
  if ((*(char *)((int)&vrgZipProd[0].fValid + iSel * 0x28) == '\0') || (iSel < 1)) {
    BVar1 = 0;
  }
  else {
    BVar1 = 1;
  }
  HVar2 = GetDlgItem(hwnd,0x817);
  EnableWindow(HVar2,BVar1);
  HVar2 = GetDlgItem(hwnd,0x41b);
  EnableWindow(HVar2,BVar1);
  return;
}



// ======================================================================
// Function: FillZipProdLB
// Address: 10d0:5e58
// Segment: MEMORY_PRODUCE
// ======================================================================


void FillZipProdLB(HWND hwndDlg,ZIPPRODQ *pzpq)

{
  char *pcVar1;
  undefined2 unaff_SS;
  WPARAM WVar2;
  UINT UVar3;
  HWND HVar4;
  RECT rc;
  char szFormat [16];
  char szAuto [40];
  HWND hwndLB;
  short i;
  
  hwndLB = GetDlgItem(hwndDlg,0x417);
  GetClientRect(hwndDlg,(RECT *)CONCAT22(unaff_SS,&rc));
  rc.top = vyZPDStatic;
  rc.bottom = vyZPDStatic + dyArial8;
  InvalidateRect(hwndDlg,(RECT *)CONCAT22(unaff_SS,&rc),1);
  SendMessage(hwndLB,0x405,0,0);
  if ((pzpq->fValid == 0) || (*(char *)((int)&pzpq->u_ZIPPRODQ_0x000e + 1) == '\0')) {
    UVar3 = 0x401;
    WVar2 = 0;
    HVar4 = hwndLB;
    pcVar1 = PszGetCompressedString(idsAutoBuildOrders);
    SendMessage(HVar4,UVar3,WVar2,(LPARAM)CONCAT22(0x1120,pcVar1));
  }
  else {
    CchGetString(idsSD2,szFormat);
    for (i = 0; i < (int)(uint)*(byte *)((int)&pzpq->u_ZIPPRODQ_0x000e + 1); i = i + 1) {
      CchGetString((*(uint *)(pzpq->szName + i * 2 + 0x10) & 0x3f) + idsMines,szAuto);
      if ((*(uint *)(pzpq->szName + i * 2 + 0x10) >> 6 == 1) ||
         ((*(uint *)(pzpq->szName + i * 2 + 0x10) & 0x3f) == 3)) {
        _strcpy((char *)szWork,szAuto);
      }
      else {
        _wsprintf(szWork,(char *)CONCAT22(unaff_SS,szFormat),szAuto);
      }
      SendMessage(hwndLB,0x401,0,0x112057a4);
    }
  }
  return;
}



