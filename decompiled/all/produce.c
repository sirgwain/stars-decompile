// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
//

// ======================================================================
// Function: ChangeProduction
// Address: 10d0:0000
// Segment: MEMORY_PRODUCE
// ======================================================================

short ChangeProduction(short fClear)

{
    short (*pasVar1)[9];
    short          sVar2;
    char          *sz;
    FARPROC        lpDlgProc;
    short          fSuccess;
    PROD           rgprod[64];
    fn_lpProcProd *lpProcProd;
    short (*penvMemSav)[9];
    short env[9];

    /* Segment:    27
       Offset:     000bc100
       Length:     5ff4
       Min Alloc:  5ff4
       Flags:      1d10
           Code
           Discardable
           Moveable
           LoadOnCall
           Impure (Non-shareable)
        */
    pasVar1 = penvMem;
    penvMem = &env;
    sVar2 = __setjmp(env);
    if (sVar2 == 0) {
        if (fClear == 0) {
            InitProduction(rgprod);
            fDlgUp = 1;
            lpDlgProc = MakeProcInstance(ProductionDlg, hInst);
            fSuccess = DialogBox(0, IDD_PRODUCTION, hwndFrame, lpDlgProc);
            FreeProcInstance(lpDlgProc);
            hwndProdDlg = 0;
            fDlgUp = 0;
        } else {
            fSuccess = 1;
        }
        FinishProduction(fSuccess);
        if ((fSuccess != 0) && (sel.grobj == grobjPlanet)) {
            DrawPlanShip(0, 8);
        }
        sVar2 = 1;
    } else {
        if (((PLPROD *)lpplProdGlob != 0) || (lpplProdGlob._2_2_ != 0)) {
            FreePl((PL *)CONCAT22(lpplProdGlob._2_2_, (PLPROD *)lpplProdGlob));
        }
        lpplProdGlob._0_2_ = 0;
        lpplProdGlob._2_2_ = 0;
        if (hwndProdDlg != 0) {
            EndDialog(hwndProdDlg, 0);
        }
        hwndProdDlg = 0;
        fDlgUp = 0;
        sVar2 = 0x10;
        sz = PszFormatIds(idsThereIsntEnoughFreeMemoryModifyProduction, 0);
        AlertSz(sz, sVar2);
        sVar2 = 0;
    }
    penvMem = pasVar1;
    return sVar2;
}

// ======================================================================
// Function: InitProduction
// Address: 10d0:015e
// Segment: MEMORY_PRODUCE
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10d00ef7) */
/* WARNING: Removing unreachable block (ram,0x10d00a78) */
/* WARNING: Removing unreachable block (ram,0x10d00efc) */
/* WARNING: Removing unreachable block (ram,0x10d00fb0) */
/* WARNING: Removing unreachable block (ram,0x10d00de1) */
/* WARNING: Removing unreachable block (ram,0x10d00fb5) */
/* WARNING: Removing unreachable block (ram,0x10d00e3f) */

void InitProduction(PROD *rgprod)

{
    byte       *pbVar1;
    PROD       *pPVar2;
    undefined2 *puVar3;
    short       sVar4;
    uint        uVar5;
    PROD       *pPVar6;
    PROD       *pPVar7;
    undefined2  uVar8;
    undefined2  uVar9;
    ulong       uVar10;
    HULDEF     *pHVar11;
    long        lVar12;
    ulong       uVar13;
    PROD       *lpprod;
    PART        part;
    short       ipl;
    short       i;
    ushort      u;
    short       iSrc;
    short       iWarp;

    uVar10 = __aFulshr(CONCAT22(sel.pl.rgbImp._6_2_, sel.pl.rgbImp._4_2_), 0x17);
    gd.grBits._0_2_ = (uint)gd.grBits & 0xffdf | ((uint)uVar10 & 1) << 5;
    if (rgprod == 0) {
        rgprod = pProdGlob;
    }
    if (((PLPROD *)sel.pl.lpplprod == 0) && (sel.pl.lpplprod._2_2_ == 0)) {
        i = 2;
    } else {
        i = (short)((PLPROD *)sel.pl.lpplprod)->iprodMac;
    }
    lpplProdGlob = LpplAlloc(4, i, htOrd);
    if (((PLPROD *)sel.pl.lpplprod == 0) && (sel.pl.lpplprod._2_2_ == 0)) {
        i = 0;
    } else {
        __fmemcpy((PL *)CONCAT22((int)((ulong)lpplProdGlob >> 0x10), (PL *)lpplProdGlob + 1), (PLPROD *)sel.pl.lpplprod + 1, i << 2);
    }
    ((PLPROD *)lpplProdGlob)->iprodMac = (byte)i;
    cProdGlob = 0;
    pProdGlob = rgprod;
    _memset(rgprod, 0, 0x100);
    if (((sel.pl.wFlags_0x4 >> 9 & 1) != 0) &&
        (pHVar11 = LphuldefFromId(*(HullDef *)(*(int *)(idPlayer * 4 + rglpshdefSB) + ((uint)sel.pl.lStarbase & 0xf) * 0x93)),
         (((HULDEF *)pHVar11)->hul).wtCargoMax != 0)) {
        for (i = 0; i < 0x10; i = i + 1) {
            if ((((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0) && (-1 < *(int *)((int)&rgshdef[0].wFlags + i * 0x93))) &&
                (uVar5 = *(uint *)((int)&rgshdef[0].hul + 0x28 + i * 0x93),
                 pHVar11 = LphuldefFromId(*(HullDef *)(*(int *)(idPlayer * 4 + rglpshdefSB) + ((uint)sel.pl.lStarbase & 0xf) * 0x93)),
                 uVar5 <= (((HULDEF *)pHVar11)->hul).wtCargoMax)) {
                uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
                pPVar6 = rgprod + cProdGlob;
                *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
                *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
                lVar12 = __aFlshl((ulong)(i & 0x7f), 10);
                uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
                pPVar6 = rgprod + cProdGlob;
                *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
                *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
                uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
                pPVar6 = rgprod + cProdGlob;
                *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
                *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 4;
                cProdGlob = cProdGlob + 1;
            }
        }
    }
    for (i = 0; i < 10; i = i + 1) {
        if ((((*(uint *)(*(int *)(idPlayer * 4 + rglpshdefSB) + i * 0x93 + 0x7b) >> 9 & 1) == 0) &&
             (-1 < *(int *)(*(int *)(idPlayer * 4 + rglpshdefSB) + i * 0x93 + 0x7b))) &&
            ((((uint)sel.pl.lStarbase & 0xf) != i || ((sel.pl.wFlags_0x4 >> 9 & 1) == 0)))) {
            uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
            pPVar6 = rgprod + cProdGlob;
            *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
            *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
            lVar12 = __aFlshl((ulong)(i + 0x10U & 0x7f), 10);
            uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
            pPVar6 = rgprod + cProdGlob;
            *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
            *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
            uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
            pPVar6 = rgprod + cProdGlob;
            *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
            *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 4;
            cProdGlob = cProdGlob + 1;
        }
    }
    part.hs.grhst = hstPlanetary;
    part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | 0xe;
    sVar4 = FLookupPart(&part);
    if (sVar4 == 1) {
        uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
        *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x3400;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
        cProdGlob = cProdGlob + 1;
    }
    sVar4 = IWarpMAFromLppl(&sel.pl, 0);
    if (0 < sVar4) {
        for (i = 0; i < 4; i = i + 1) {
            uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
            pPVar6 = rgprod + cProdGlob;
            *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
            *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
            lVar12 = __aFlshl((ulong)(i + 0xeU & 0x7f), 10);
            uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
            pPVar6 = rgprod + cProdGlob;
            *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
            *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
            uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
            pPVar6 = rgprod + cProdGlob;
            *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
            *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
            cProdGlob = cProdGlob + 1;
        }
    }
    uVar10 = __aFulshr(CONCAT22(sel.pl.rgbImp._2_2_, sel.pl.rgbImp._0_2_), 0x14);
    sVar4 = CMaxFactories(&sel.pl, idPlayer);
    uVar5 = sVar4 - ((uint)uVar10 & 0xfff);
    if (0 < (int)uVar5) {
        if (0x3fc < uVar5) {
            uVar5 = 0x3fc;
        }
        lVar12 = __aFlshl((ulong)(uVar5 & 0x3ff), 0);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x1c00;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
        cProdGlob = cProdGlob + 1;
    }
    uVar10 = __aFulshr(CONCAT22(sel.pl.rgbImp._2_2_, sel.pl.rgbImp._0_2_), 8);
    sVar4 = CMaxMines(&sel.pl, idPlayer);
    uVar5 = sVar4 - ((uint)uVar10 & 0xfff);
    if (0 < (int)uVar5) {
        if (0x3fc < uVar5) {
            uVar5 = 0x3fc;
        }
        lVar12 = __aFlshl((ulong)(uVar5 & 0x3ff), 0);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2000;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
        cProdGlob = cProdGlob + 1;
    }
    uVar5 = sel.pl.rgbImp._4_2_ & 0xfff;
    sVar4 = CMaxDefenses(&sel.pl, idPlayer);
    uVar5 = sVar4 - uVar5;
    if (0 < (int)uVar5) {
        lVar12 = __aFlshl((ulong)(uVar5 & 0x3ff), 0);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2400;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
        cProdGlob = cProdGlob + 1;
    }
    uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
    *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2c00;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
    uVar10 = __aFulshr(CONCAT22(sel.pl.rgbImp._6_2_, sel.pl.rgbImp._4_2_), 0xc);
    if ((((uint)uVar10 & 0x1f) == 0x1f) && (sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv), sVar4 != raMacintosh)) {
        uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
        *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x6c00;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
        cProdGlob = cProdGlob + 1;
    }
    uVar5 = IpctCanTerraformLppl(&sel.pl);
    if (0 < (int)uVar5) {
        lVar12 = __aFlshl((ulong)(uVar5 & 0x3ff), 0);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x3000;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
        cProdGlob = cProdGlob + 1;
    }
    for (i = 0; i < 7; i = i + 1) {
        sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv);
        if (((sVar4 != raMacintosh) || (((i != 0 && (i != 1)) && (i != 2)))) &&
            ((sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv), sVar4 != raTerra || ((i != 4 && (i != 5)))))) {
            uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
            pPVar6 = rgprod + cProdGlob;
            *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
            *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
            lVar12 = __aFlshl((ulong)(i & 0x7f), 10);
            uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
            pPVar6 = rgprod + cProdGlob;
            *&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
            *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
            uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
            pPVar6 = rgprod + cProdGlob;
            *&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
            *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
            cProdGlob = cProdGlob + 1;
        }
    }
    ipl = 0;
    lpprod = (PROD *)((PLPROD *)lpplProdGlob + 1);
    do {
        if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= ipl) {
            if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
                AdvanceTutor();
            }
            return;
        }
        iSrc = 0;
        while (true) {
            pPVar6 = (PROD *)lpprod;
            uVar8 = (undefined2)((ulong)lpprod >> 0x10);
            if (cProdGlob <= iSrc)
                break;
            uVar10 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[iSrc].dwFlags + 2), (int)(pProdGlob + iSrc)->dwFlags), 0x11);
            uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar6->dwFlags + 2), (int)lpprod->dwFlags), 0x11);
            if (((uint)uVar10 & 7) == ((uint)uVar13 & 7)) {
                uVar10 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[iSrc].dwFlags + 2), (int)(pProdGlob + iSrc)->dwFlags), 10);
                uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar6->dwFlags + 2), (int)lpprod->dwFlags), 10);
                if (((uint)uVar10 & 0x7f) == ((uint)uVar13 & 0x7f))
                    break;
            }
            iSrc = iSrc + 1;
        }
        if (iSrc < cProdGlob) {
            if (((uint)(pProdGlob + iSrc)->dwFlags & 0x3ff) < ((uint)lpprod->dwFlags & 0x3ff)) {
                lVar12 = __aFlshl((ulong)((uint)(pProdGlob + iSrc)->dwFlags & 0x3ff), 0);
                uVar5 = *(uint *)((int)&pPVar6->dwFlags + 2);
                *&lpprod->dwFlags = (uint)lpprod->dwFlags & 0xfc00 | (uint)lVar12;
                *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
            }
            if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
                if (((uint)(pProdGlob + iSrc)->dwFlags & 0x3ff) < ((uint)lpprod->dwFlags & 0x3ff)) {
                    uVar9 = *(undefined2 *)((int)&pProdGlob[iSrc].dwFlags + 2);
                    pPVar7 = pProdGlob + iSrc;
                    *&pPVar7->dwFlags = (uint)(pProdGlob + iSrc)->dwFlags & 0xfc00;
                    *(undefined2 *)((int)&pPVar7->dwFlags + 2) = uVar9;
                } else {
                    lVar12 = __aFlshl((ulong)((uint)lpprod->dwFlags & 0x3ff), 0);
                    uVar10 = (pProdGlob + iSrc)->dwFlags;
                    pPVar7 = pProdGlob + iSrc;
                    pPVar2 = pPVar7;
                    *&pPVar2->dwFlags = (uint)pPVar2->dwFlags & 0xfc00;
                    puVar3 = (undefined2 *)((int)&pPVar7->dwFlags + 2);
                    *puVar3 = *puVar3;
                    pPVar7 = pProdGlob + iSrc;
                    pPVar2 = pPVar7;
                    *&pPVar2->dwFlags = (uint)pPVar2->dwFlags | (int)uVar10 - (int)lVar12 & 0x3ffU;
                    puVar3 = (undefined2 *)((int)&pPVar7->dwFlags + 2);
                    *puVar3 = *puVar3;
                }
            }
        } else {
            uVar9 = (undefined2)((ulong)lpplProdGlob >> 0x10);
            if (ipl + 1 < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
                __fmemcpy(lpprod, (PROD *)CONCAT22(uVar8, pPVar6 + 1), ((uint)((PLPROD *)lpplProdGlob)->iprodMac - (ipl + 1)) * 4);
                ipl = ipl + -1;
            }
            pbVar1 = &((PLPROD *)lpplProdGlob)->iprodMac;
            *pbVar1 = *pbVar1 - 1;
        }
        ipl = ipl + 1;
        lpprod = (PROD *)CONCAT22(uVar8, pPVar6 + 1);
    } while (true);
}

// ======================================================================
// Function: FinishProduction
// Address: 10d0:1090
// Segment: MEMORY_PRODUCE
// ======================================================================

void FinishProduction(short fWrite)

{
    long lVar1;

    if (fWrite == 0) {
        lVar1 = __aFlshl((ulong)((uint)gd.grBits >> 5 & 1), 0x17);
        sel.pl.rgbImp._4_2_ = sel.pl.rgbImp._4_2_ | (uint)lVar1;
        sel.pl.rgbImp._6_2_ = sel.pl.rgbImp._6_2_ & 0xff7f | (uint)((ulong)lVar1 >> 0x10);
        FreePl(lpplProdGlob);
    } else {
        FreePl((PL *)CONCAT22(sel.pl.lpplprod._2_2_, (PLPROD *)sel.pl.lpplprod));
        if ((((PLPROD *)lpplProdGlob != 0) || (lpplProdGlob._2_2_ != 0)) && (((PLPROD *)lpplProdGlob)->iprodMac == 0)) {
            FreePl(lpplProdGlob);
            lpplProdGlob = 0;
        }
        sel.pl.lpplprod._0_2_ = (PLPROD *)lpplProdGlob;
        sel.pl.lpplprod._2_2_ = lpplProdGlob._2_2_;
        lpplProdGlob = 0;
        FLookupPlanet(-1, (PLANET *)&sel.pl);
        FLookupPlanet(sel.pl.id, (PLANET *)&sel.pl);
        if (fAi == 0) {
            FillPlanetProdLB(0, 0, 0);
            DrawPlanShip(0, 0x40);
        }
    }
    lpplProdGlob = 0;
    if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
        tutor.wFlags = tutor.wFlags & 0xfbffU | 0x400;
        AdvanceTutor();
    }
    return;
}

// ======================================================================
// Function: ProductionDlg
// Address: 10d0:1204
// Segment: MEMORY_PRODUCE
// ======================================================================

short ProductionDlg(HWND hwnd, WMType message, ushort wParam, long lParam)

{
    POINT       PVar1;
    int         iVar2;
    HWND        HVar3;
    char       *pcVar4;
    BOOL        BVar5;
    HDC         hdc_00;
    short       sVar6;
    char      **ppcVar7;
    undefined2  unaff_SS;
    bool        bVar8;
    ulong       uVar9;
    FARPROC     lpDlgProc;
    short       fRet;
    fn_lpProc  *lpProc;
    undefined1  local_e4[140];
    int         local_58;
    ControlId   local_56[9];
    char       *local_44;
    int         local_42;
    short       local_40;
    int         local_3e;
    int         local_3c;
    undefined8  local_3a;
    POINT       local_32;
    RECT        rc;
    PAINTSTRUCT ps;
    HDC         hdc;

    if (message == WM_PAINT) {
        hdc_00 = BeginPaint(hwnd, &ps);
        GetClientRect(hwnd, &rc);
        DrawProductionDlg(hwnd, hdc_00, &rc, -1);
        EndPaint(hwnd, &ps);
        sVar6 = 1;
    } else if (message == WM_ERASEBKGND) {
        GetClientRect(hwnd, &rc);
        FillRect(wParam, &rc, hbrButtonFace);
        sVar6 = 1;
    } else {
        if (message == WM_CTLCOLOR) {
            local_32.y = (HWND)lParam;
            HVar3 = GetDlgItem(hwnd, IDC_U16_0x008B);
            if ((local_32.y == HVar3) || (uVar9 = __aFulshr(lParam, 0x10), (int)uVar9 == 6)) {
                SetBkColor(wParam, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
                return hbrButtonFace;
            }
        } else if (message == WM_SETCURSOR) {
            local_3a._6_2_ = 0;
            GetCursorPos(&local_32);
            ScreenToClient(hwnd, &local_32);
            BVar5 = PtInRect(&rcProdDiamond, local_32);
            if (BVar5 != 0) {
                SetCursor(hcurArrowHelp);
                return 1;
            }
        } else {
            if (message == WM_DRAWITEM) {
                local_32 = (POINT)lParam;
                if (*(int *)((HWND)lParam + 4) == -1) {
                    HandleFocusState((DRAWITEMSTRUCT *)lParam, -2);
                } else {
                    iVar2 = *(int *)((HWND)lParam + 6);
                    if (((iVar2 == 1) || (iVar2 == 2)) || (iVar2 == 4)) {
                        DrawCBEntireItem((DRAWITEMSTRUCT *)lParam, 4);
                    }
                }
                return 1;
            }
            if (message == WM_MEASUREITEM) {
                *(int *)((HWND)lParam + 8) = dyArial8 + 2;
                return 1;
            }
            if (message == WM_INITDIALOG) {
                local_56[0] = IDC_U16_0x042E;
                local_56[1] = 0x42f;
                local_56[2] = 1;
                local_56[3] = 2;
                local_56[4] = 0x418;
                local_56[5] = 0x419;
                local_56[6] = 0x439;
                local_56[7] = 0x43a;
                local_56[8] = 0x42d;
                local_44 = (char *)&game.mdDensity;
                hwndProdDlg = hwnd;
                if (*(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) < 2) {
                    HVar3 = GetDlgItem(hwnd, IDC_U16_0x042E | IDOK);
                    EnableWindow(HVar3, 0);
                    HVar3 = GetDlgItem(hwnd, IDC_U16_0x042E);
                    EnableWindow(HVar3, 0);
                }
                if ((uint)gd.grBits >> 0xe == 0) {
                    local_40 = 0x262;
                    local_32.x = dyArial8 * 0x18 + 0x18;
                } else {
                    local_40 = 0x2f8;
                    local_32.x = 0x244;
                }
                SetWindowPos(hwnd, 0, 0, 0, local_40, local_32.x, 6);
                GetClientRect(hwnd, &rc);
                local_3e = rc.right >> 1;
                local_42 = (rc.bottom - (dyArial8 * 0x11) / 2) + -0x18;
                rc.left = (rc.right * 0xb) / 0x14 + 0x10;
                local_32.y = (rc.right - rc.left) / 4;
                rc.bottom = rc.bottom - ((dyArial8 * 3) / 2 + 6);
                HVar3 = GetDlgItem(hwnd, IDC_U16_0x008B);
                SetWindowPos(HVar3, 0, 6, rc.bottom, rc.left + -0xc, (dyArial8 * 3) / 2, 4);
                for (local_3c = 0; local_3c < 4; local_3c = local_3c + 1) {
                    HVar3 = GetDlgItem(hwnd, local_56[local_3c]);
                    SetWindowPos(HVar3, 0, rc.left, rc.bottom, local_32.y + -6, (dyArial8 * 3) / 2, 4);
                    rc.left = rc.left + local_32.y;
                }
                rc.left = local_3e - (local_32.y + 0x12 >> 1);
                local_58 = (dyArial8 * 3) / 2;
                iVar2 = (local_42 + dyArial8 * -9) / 5 + local_58;
                local_32.x = iVar2 + -3;
                rc.top = 8;
                if (0x32 < local_32.x) {
                    rc.top = ((iVar2 + -0x35) * 5) / 2 + 8;
                    local_32.x = 0x32;
                }
                local_32.y = local_32.y + 0x18;
                for (local_3c = 4; local_3c < 10; local_3c = local_3c + 1) {
                    HVar3 = GetDlgItem(hwnd, local_56[local_3c]);
                    SetWindowPos(HVar3, 0, rc.left, rc.top, local_32.y + -6, (dyArial8 * 3) / 2, 4);
                    rc.top = rc.top + local_32.x;
                }
                HVar3 = GetDlgItem(hwnd, IDC_U16_0x0416);
                SetWindowPos(HVar3, 0, 6, 6, rc.left + -0xc, local_42, 4);
                HVar3 = GetDlgItem(hwnd, IDC_U16_0x0416);
                GetWindowRect(HVar3, &local_3a);
                HVar3 = GetDlgItem(hwnd, IDC_U16_0x0417);
                SetWindowPos(HVar3, 0, rc.left + local_32.y, 6, rc.left + -0xc, local_3a._6_2_ - local_3a._2_2_, 4);
                ScreenToClient(hwnd, (POINT *)((int)&local_3a + 4));
                yTopFutureTech = local_3a._6_2_;
                InitializeProductionDlg(hwnd);
                if (((uint)gd.grBits >> 0xe == 1) && (ptStickyProduceDlg.y == -1)) {
                    ptStickyProduceDlg.y = 0;
                }
                StickyDlgPos(hwnd, (POINT *)&ptStickyProduceDlg, 1);
                return 1;
            }
            if (message == WM_COMMAND) {
                ProdCommandHandler(hwnd, wParam, lParam);
            } else if ((message == WM_LBUTTONDOWN) || (message == WM_RBUTTONDOWN)) {
                local_32.x = (HWND)lParam;
                uVar9 = __aFulshr(lParam, 0x10);
                PVar1.y = (short)uVar9;
                PVar1.x = local_32.x;
                local_32.y = (short)uVar9;
                BVar5 = PtInRect(&rcProdDiamond, PVar1);
                if (BVar5 != 0) {
                    if (message == WM_LBUTTONDOWN) {
                        GlobalPD.grPopup = 10;
                        GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = hstMining | hstTorp | hstBeam | hstShield;
                        GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = (ushort)szPopupBuffer;
                        CchGetString(idsRightClickBlueDiamondApplyProductionTemplate, (char *)szPopupBuffer);
                        Popup(hwnd, local_32.x, local_32.y);
                    } else {
                        local_3a._4_1_ = 0xff;
                        local_3a._5_1_ = 0;
                        local_3a._6_2_ = 0;
                        for (local_3a._2_2_ = 0; local_3a._2_2_ < 4; local_3a._2_2_ = local_3a._2_2_ + 1) {
                            if (*(char *)((int)&vrgZipProd[0].fValid + local_3a._2_2_ * 0x28) != '\0') {
                                ppcVar7 = &local_44 + local_3a._6_2_;
                                local_3a._6_2_ = local_3a._6_2_ + 1;
                                *ppcVar7 = ((ZIPPRODQ *)vrgZipProd)[local_3a._2_2_].szName;
                            }
                        }
                        ppcVar7 = &local_44 + local_3a._6_2_;
                        local_3a._6_2_ = local_3a._6_2_ + 1;
                        *ppcVar7 = (char *)((int)&local_3a + 4);
                        pcVar4 = PszGetCompressedString(idsCustomize);
                        ppcVar7 = &local_44 + local_3a._6_2_;
                        local_3a._6_2_ = local_3a._6_2_ + 1;
                        *ppcVar7 = pcVar4;
                        local_3a._2_2_ = PopupMenu(hwnd, local_32.x, local_32.y, local_3a._6_2_, 0, &local_44, -1, 1);
                        if (local_3a._2_2_ == local_3a._6_2_ + -1) {
                            _memcpy(local_e4, (ZIPPRODQ *)vrgZipProd, 0xa0);
                            lpDlgProc = MakeProcInstance(ZipProdDlg, hInst);
                            sVar6 = DialogBox(0, IDD_ZIP_PROD, hwnd, lpDlgProc);
                            FreeProcInstance(lpDlgProc);
                            if (sVar6 == 0) {
                                _memcpy((ZIPPRODQ *)vrgZipProd, local_e4, 0xa0);
                            }
                        } else if (-1 < local_3a._2_2_) {
                            local_3a._6_2_ = 0;
                            while ((local_3a._6_2_ < 4 && ((*(char *)((int)&vrgZipProd[0].fValid + local_3a._6_2_ * 0x28) == '\0' ||
                                                            (iVar2 = local_3a._2_2_ + -1, bVar8 = local_3a._2_2_ != 0, local_3a._2_2_ = iVar2, bVar8))))) {
                                local_3a._6_2_ = local_3a._6_2_ + 1;
                            }
                            ProdCommandHandler(hwnd, 0x816, (long)local_3a._6_2_);
                        }
                    }
                }
            }
        }
        sVar6 = 0;
    }
    return sVar6;
}

// ======================================================================
// Function: ProdCommandHandler
// Address: 10d0:1994
// Segment: MEMORY_PRODUCE
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10d01f07) */
/* WARNING: Removing unreachable block (ram,0x10d01a99) */
/* WARNING: Removing unreachable block (ram,0x10d026c2) */
/* WARNING: Removing unreachable block (ram,0x10d023e0) */
/* WARNING: Removing unreachable block (ram,0x10d02357) */
/* WARNING: Removing unreachable block (ram,0x10d02404) */
/* WARNING: Removing unreachable block (ram,0x10d025ca) */
/* WARNING: Removing unreachable block (ram,0x10d01a12) */
/* WARNING: Removing unreachable block (ram,0x10d01e16) */
/* WARNING: Removing unreachable block (ram,0x10d021cd) */
/* WARNING: Removing unreachable block (ram,0x10d029e0) */
/* WARNING: Removing unreachable block (ram,0x10d01dc1) */
/* WARNING: Removing unreachable block (ram,0x10d01b8e) */
/* WARNING: Removing unreachable block (ram,0x10d01b0c) */
/* WARNING: Removing unreachable block (ram,0x10d01a9e) */
/* WARNING: Removing unreachable block (ram,0x10d01b07) */
/* WARNING: Removing unreachable block (ram,0x10d01b89) */
/* WARNING: Removing unreachable block (ram,0x10d01d7f) */
/* WARNING: Removing unreachable block (ram,0x10d022cf) */
/* WARNING: Removing unreachable block (ram,0x10d029ab) */
/* WARNING: Removing unreachable block (ram,0x10d029e5) */
/* WARNING: Removing unreachable block (ram,0x10d027b8) */
/* WARNING: Removing unreachable block (ram,0x10d0231d) */
/* WARNING: Removing unreachable block (ram,0x10d02093) */
/* WARNING: Removing unreachable block (ram,0x10d02051) */
/* WARNING: Removing unreachable block (ram,0x10d01f51) */
/* WARNING: Removing unreachable block (ram,0x10d01f0c) */
/* WARNING: Removing unreachable block (ram,0x10d01f8e) */
/* WARNING: Removing unreachable block (ram,0x10d02816) */
/* WARNING: Removing unreachable block (ram,0x10d03237) */
/* WARNING: Removing unreachable block (ram,0x10d02222) */
/* WARNING: Removing unreachable block (ram,0x10d03098) */
/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

void ProdCommandHandler(HWND hwnd, ushort wParam, long lParam)

{
    PROD       *pPVar1;
    undefined2 *puVar2;
    uint       *puVar3;
    byte       *pbVar4;
    uint        uVar5;
    undefined2  uVar6;
    PL         *pPVar7;
    undefined2  uVar8;
    uint        uVar9;
    uint        uVar10;
    uint        uVar11;
    HWND        HVar12;
    HWND        HVar13;
    short       sVar14;
    uint        uVar15;
    int         iVar16;
    ushort      uVar17;
    PLPROD     *pPVar18;
    uint       *puVar19;
    PROD       *pPVar20;
    PROD       *pPVar21;
    undefined2 *puVar22;
    short      *psVar23;
    undefined2  uVar24;
    undefined2  unaff_SS;
    bool        bVar25;
    ulong       uVar26;
    PL         *pPVar27;
    ulong       uVar28;
    LRESULT     LVar29;
    long        lVar30;
    void       *pvVar31;
    PLANET     *pPVar32;
    undefined2  uVar33;
    undefined2  uVar34;
    short       sVar35;
    WMType      WVar36;
    PLPROD     *lpplprodT;
    short       cMax;
    PROD        prod;
    PROD       *lpprod;
    RECT        rc;
    short       iMac;
    short       fRefillSrc;
    short       ipl;
    PROD        prodLast;
    short       iDst;
    short       c;
    HWND        hwndLB;
    short       iSrc;
    long        lSel;

    if ((wParam == 1) || (wParam == 2)) {
        hwndProdDlg = 0;
        StickyDlgPos(hwnd, (POINT *)&ptStickyProduceDlg, 0);
        EndDialog(hwnd, (uint)(wParam == 1));
        return;
    }
    if (wParam == 0x76) {
        WinHelp(hwnd, szHelpFile, 1, 0x423);
        return;
    }
    if (wParam == 0x8b) {
        HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
        HVar13 = GetDlgItem(hwnd, IDC_U16_0x008B);
        LVar29 = SendMessage(HVar13, WM_USER, 0, 0);
        lVar30 = __aFlshl((ulong)((uint)LVar29 & 1), 0x17);
        sel.pl.rgbImp._4_2_ = sel.pl.rgbImp._4_2_ | (uint)lVar30;
        sel.pl.rgbImp._6_2_ = sel.pl.rgbImp._6_2_ & 0xff7f | (uint)((ulong)lVar30 >> 0x10);
        LVar29 = SendMessage(HVar12, CB_GETLBTEXTLEN, 0, 0);
        FillPlanetProdLB(HVar12, lpplProdGlob, 0);
        lSel._0_2_ = (WParamMessageId)LVar29;
        uVar24 = 0x14f8;
        SendMessage(HVar12, CB_GETCURSEL, (WParamMessageId)lSel, 0);
        psVar23 = &stack0xffbe;
        goto PRODUCE_RedrawText;
    }
    if ((wParam == 0x416) || (wParam == 0x417)) {
        uVar24 = 0x1118;
        uVar28 = __aFulshr(lParam, 0x10);
        psVar23 = &stack0xffbe;
        if ((int)uVar28 == 1)
            goto PRODUCE_RedrawText;
        uVar28 = __aFulshr(lParam, 0x10);
        if ((int)uVar28 != 2) {
            return;
        }
        if (wParam == 0x416)
            goto PRODUCE_AddItem;
    } else {
        if (wParam == 0x418) {
        PRODUCE_AddItem:
            HVar12 = GetDlgItem(hwnd, IDC_U16_0x0416);
            lVar30 = SendMessage(HVar12, CB_GETLBTEXTLEN, 0, 0);
            if (((int)((ulong)lVar30 >> 0x10) < 1) && (lVar30 < 0)) {
                return;
            }
            iSrc = 0;
            while (true) {
                lSel._2_2_ = (int)((ulong)lVar30 >> 0x10);
                lSel._0_2_ = (WParamMessageId)lVar30;
                if ((cProdGlob <= iSrc) ||
                    ((((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0 &&
                      (bVar25 = lVar30 == 0, lVar30 = CONCAT22(lSel._2_2_ - (uint)((WParamMessageId)lSel == 0), (WParamMessageId)lSel + -1), bVar25))))
                    break;
                iSrc = iSrc + 1;
            }
            uVar15 = (uint)(pProdGlob + iSrc)->dwFlags;
            prod.dwFlags._2_2_ = *(uint *)((int)&pProdGlob[iSrc].dwFlags + 2);
            uVar9 = GetAsyncKeyState(0x11);
            if ((uVar9 & 0xfffe) == 0) {
                uVar9 = GetAsyncKeyState(0x10);
                if ((uVar9 & 0xfffe) == 0) {
                    prod.dwFlags._0_2_ = uVar15 & 0xfc00 | 1;
                } else {
                    if ((uVar15 & 0x3ff) < 10) {
                        uVar9 = uVar15 & 0x3ff;
                    } else {
                        uVar9 = 10;
                    }
                    lVar30 = __aFlshl((ulong)uVar9, 0);
                    prod.dwFlags._0_2_ = uVar15 & 0xfc00 | (uint)lVar30;
                    prod.dwFlags._2_2_ = prod.dwFlags._2_2_ | (uint)((ulong)lVar30 >> 0x10);
                }
            } else {
                uVar9 = GetAsyncKeyState(0x10);
                if ((uVar9 & 0xfffe) == 0) {
                    if ((uVar15 & 0x3ff) < 100) {
                        uVar9 = uVar15 & 0x3ff;
                    } else {
                        uVar9 = 100;
                    }
                    lVar30 = __aFlshl((ulong)uVar9, 0);
                    uVar9 = (uint)((ulong)lVar30 >> 0x10);
                    prod.dwFlags._0_2_ = uVar15 & 0xfc00 | (uint)lVar30;
                } else {
                    if ((uVar15 & 0x3ff) < 0x3fc) {
                        uVar9 = uVar15 & 0x3ff;
                    } else {
                        uVar9 = 0x3fc;
                    }
                    lVar30 = __aFlshl((ulong)uVar9, 0);
                    uVar9 = (uint)((ulong)lVar30 >> 0x10);
                    prod.dwFlags._0_2_ = uVar15 & 0xfc00 | (uint)lVar30;
                }
                prod.dwFlags._2_2_ = prod.dwFlags._2_2_ | uVar9;
            }
            if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
                lVar30 = __aFlshl((ulong)((uint)prod.dwFlags & 0x3ff), 0);
                lpplprodT._2_2_ = (int)(pProdGlob + iSrc)->dwFlags - (int)lVar30 & 0x3ff;
                pPVar20 = pProdGlob + iSrc;
                pPVar1 = pPVar20;
                *&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
                puVar2 = (undefined2 *)((int)&pPVar20->dwFlags + 2);
                *puVar2 = *puVar2;
                pPVar20 = pProdGlob + iSrc;
                pPVar1 = pPVar20;
                *&pPVar1->dwFlags = (uint)pPVar1->dwFlags | lpplprodT._2_2_;
                puVar2 = (undefined2 *)((int)&pPVar20->dwFlags + 2);
                *puVar2 = *puVar2;
            }
            uVar15 = (uint)((PLPROD *)lpplProdGlob)->iprodMac;
            HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
            LVar29 = SendMessage(HVar12, CB_GETLBTEXTLEN, 0, 0);
            if ((LVar29 < 0x10000) && (LVar29 < 0)) {
                iDst = uVar15 - 1;
                if (iDst < 0) {
                    iDst = 0;
                }
            } else {
                iDst = (int)LVar29 + -1;
            }
            iVar16 = iDst;
            if (iDst < (int)uVar15) {
                if (iDst < 0) {
                LAB_10d0_1fde:
                    iVar16 = iDst + 1;
                    if (iVar16 < (int)uVar15) {
                        uVar17 = ((PLPROD *)lpplProdGlob + iDst + 2)->wFlags;
                        uVar24 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 2].iprodMax;
                        uVar28 = __aFulshr(CONCAT22(uVar24, uVar17), 10);
                        lpplprodT._2_2_ = (uint)uVar28 & 0x7f;
                        uVar28 = __aFulshr(CONCAT22(prod.dwFlags._2_2_, (uint)prod.dwFlags), 10);
                        if (lpplprodT._2_2_ == ((uint)uVar28 & 0x7f)) {
                            uVar28 = __aFulshr(CONCAT22(uVar24, uVar17), 0x11);
                            lpplprodT._2_2_ = (uint)uVar28 & 7;
                            uVar28 = __aFulshr(CONCAT22(prod.dwFlags._2_2_, (uint)prod.dwFlags), 0x11);
                            iDst = iVar16;
                            if (lpplprodT._2_2_ == ((uint)uVar28 & 7))
                                goto PRODUCE_RingItUp;
                        }
                    }
                    goto LAB_10d0_2099;
                }
                uVar17 = ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags;
                uVar24 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
                uVar28 = __aFulshr(CONCAT22(uVar24, uVar17), 10);
                lpplprodT._2_2_ = (uint)uVar28 & 0x7f;
                uVar28 = __aFulshr(CONCAT22(prod.dwFlags._2_2_, (uint)prod.dwFlags), 10);
                if (lpplprodT._2_2_ != ((uint)uVar28 & 0x7f))
                    goto LAB_10d0_1fde;
                uVar28 = __aFulshr(CONCAT22(uVar24, uVar17), 0x11);
                lpplprodT._2_2_ = (uint)uVar28 & 7;
                uVar28 = __aFulshr(CONCAT22(prod.dwFlags._2_2_, (uint)prod.dwFlags), 0x11);
                if (lpplprodT._2_2_ != ((uint)uVar28 & 7))
                    goto LAB_10d0_1fde;
            PRODUCE_RingItUp:
                uVar15 = ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0x3ff;
                if ((CARRY2(uVar15, (uint)prod.dwFlags & 0x3ff)) || (0x3fc < uVar15 + ((uint)prod.dwFlags & 0x3ff))) {
                    uVar15 = 0x3fc;
                } else {
                    uVar15 = (((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0x3ff) + ((uint)prod.dwFlags & 0x3ff);
                }
                lVar30 = __aFlshl((ulong)(uVar15 & 0x3ff), 0);
                uVar24 = lpplProdGlob._2_2_;
                uVar15 = *(uint *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
                pPVar18 = (PLPROD *)lpplProdGlob + iDst + 1;
                pPVar18->wFlags = ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0xfc00 | (uint)lVar30;
                *(uint *)&pPVar18->iprodMax = uVar15 | (uint)((ulong)lVar30 >> 0x10);
                if ((1 < (((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0x3ff)) &&
                    (uVar28 = __aFulshr(CONCAT22(*(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax, ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags), 10),
                     ((uint)uVar28 & 0x7f) == 3)) {
                    uVar28 =
                        __aFulshr(CONCAT22(*(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax, ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags), 0x11);
                    if (((uint)uVar28 & 7) == 1) {
                        uVar33 = lpplProdGlob._2_2_;
                        uVar24 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
                        pPVar18 = (PLPROD *)lpplProdGlob + iDst + 1;
                        pPVar18->wFlags = ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0xfc00 | 1;
                        *(undefined2 *)&pPVar18->iprodMax = uVar24;
                    }
                }
            } else {
            LAB_10d0_2099:
                iDst = iVar16;
                if (0x27 < uVar15) {
                    uVar24 = 0x14f8;
                    MessageBeep(0);
                    psVar23 = &stack0xffba;
                    goto PRODUCE_RedrawText;
                }
                if (uVar15 == ((PLPROD *)lpplProdGlob)->iprodMax) {
                    lpplProdGlob = LpplReAlloc(lpplProdGlob, uVar15 + 4);
                }
                if (iDst != uVar15) {
                    __fmemmove((PLPROD *)CONCAT22(lpplProdGlob._2_2_, (PLPROD *)lpplProdGlob + iDst + 2),
                               (PLPROD *)CONCAT22(lpplProdGlob._2_2_, (PLPROD *)lpplProdGlob + iDst + 1), (uVar15 - iDst) * 4);
                }
                uVar24 = lpplProdGlob._2_2_;
                pPVar18 = (PLPROD *)lpplProdGlob + iDst + 1;
                pPVar18->wFlags = (uint)prod.dwFlags;
                *(uint *)&pPVar18->iprodMax = prod.dwFlags._2_2_;
                pbVar4 = &((PLPROD *)lpplProdGlob)->iprodMac;
                *pbVar4 = *pbVar4 + 1;
            }
            psVar23 = &stack0xffba;
            uVar33 = 0;
            pPVar32 = 0;
            pPVar18 = (PLPROD *)lpplProdGlob;
            uVar24 = lpplProdGlob._2_2_;
            HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
            FillPlanetProdLB(HVar12, (PLPROD *)CONCAT22(uVar24, pPVar18), (PLANET *)CONCAT22(uVar33, pPVar32));
            HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
            uVar24 = 0x14f8;
            SendMessage(HVar12, CB_GETCURSEL, iDst + 1, 0);
            if (((pProdGlob + iSrc)->dwFlags & 0x3ff) == 0) {
                sVar35 = -1;
                HVar12 = GetDlgItem(hwnd, IDC_U16_0x0416);
                uVar24 = 0x10d0;
                FillProdSrcLB(HVar12, sVar35);
                psVar23 = &stack0xffba;
            }
            goto PRODUCE_RedrawText;
        }
        if (wParam != 0x419) {
            if (wParam != 0x42d) {
                if ((wParam == 0x42e) || (wParam == 0x42f)) {
                    if (wParam == 0x42f) {
                        sVar35 = 1;
                    } else {
                        sVar35 = -1;
                    }
                    FinishProduction(1);
                    sVar14 = GetKeyState(0x10);
                    if (sVar14 < 0) {
                        sVar35 = IdFindAdjStarbase(sel.pl.id, (uint)(wParam == 0x42f));
                        SelectAdjPlanet(0, sVar35);
                    } else {
                        SelectAdjPlanet(sVar35, 0);
                    }
                    InitProduction(0);
                    InitializeProductionDlg(hwnd);
                    GetClientRect(hwnd, &rc);
                    rc.top = yTopFutureTech;
                    rc.bottom = dyArial8 * 9 + yTopFutureTech;
                    InvalidateRect(hwnd, &rc, 1);
                    return;
                }
                if (wParam == 0x439) {
                    HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
                    LVar29 = SendMessage(HVar12, CB_GETLBTEXTLEN, 0, 0);
                    uVar15 = (uint)LVar29;
                    if (LVar29 < 2) {
                        return;
                    }
                    uVar33 = (undefined2)((ulong)lpplProdGlob >> 0x10);
                    pPVar18 = (PLPROD *)lpplProdGlob;
                    uVar9 = uVar15 - 2;
                    iVar16 = (int)((ulong)LVar29 >> 0x10) - (uint)(uVar15 < 2);
                    lVar30 = __aFlshl(CONCAT22(iVar16, uVar9), 2);
                    puVar22 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar30);
                    uVar24 = *puVar22;
                    uVar33 = puVar22[1];
                    pPVar18 = (PLPROD *)lpplProdGlob;
                    uVar6 = lpplProdGlob._2_2_;
                    lVar30 = __aFlshl(CONCAT22(iVar16 + (uint)(0xfffe < uVar9), uVar15 - 1), 2);
                    puVar22 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar30);
                    uVar34 = *puVar22;
                    uVar6 = puVar22[1];
                    pPVar18 = (PLPROD *)lpplProdGlob;
                    uVar8 = lpplProdGlob._2_2_;
                    lVar30 = __aFlshl(CONCAT22(iVar16, uVar9), 2);
                    puVar22 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar30);
                    *puVar22 = uVar34;
                    puVar22[1] = uVar6;
                    pPVar18 = (PLPROD *)lpplProdGlob;
                    uVar34 = lpplProdGlob._2_2_;
                    lVar30 = __aFlshl(CONCAT22(iVar16 + (uint)(0xfffe < uVar9), uVar15 - 1), 2);
                    puVar22 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar30);
                    *puVar22 = uVar24;
                    puVar22[1] = uVar33;
                    uVar33 = 0;
                    pPVar32 = 0;
                    pPVar18 = (PLPROD *)lpplProdGlob;
                    uVar24 = lpplProdGlob._2_2_;
                    HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
                    FillPlanetProdLB(HVar12, (PLPROD *)CONCAT22(uVar24, pPVar18), (PLANET *)CONCAT22(uVar33, pPVar32));
                    HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
                    uVar24 = 0x14f8;
                    SendMessage(HVar12, CB_GETCURSEL, uVar15 - 1, 0);
                    psVar23 = &stack0xffbe;
                    goto PRODUCE_RedrawText;
                }
                if (wParam == 0x43a) {
                    HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
                    LVar29 = SendMessage(HVar12, CB_GETLBTEXTLEN, 0, 0);
                    uVar15 = (uint)LVar29;
                    uVar24 = (undefined2)((ulong)lpplProdGlob >> 0x10);
                    pPVar18 = (PLPROD *)lpplProdGlob;
                    if (LVar29 < 1) {
                        return;
                    }
                    if (-1 < LVar29) {
                        if (0xffff < LVar29) {
                            return;
                        }
                        if (pPVar18->iprodMac <= uVar15) {
                            return;
                        }
                    }
                    uVar9 = uVar15 - 1;
                    iVar16 = (int)((ulong)LVar29 >> 0x10) - (uint)(uVar15 == 0);
                    lVar30 = __aFlshl(CONCAT22(iVar16, uVar9), 2);
                    puVar22 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar30);
                    uVar33 = *puVar22;
                    uVar24 = puVar22[1];
                    pPVar18 = (PLPROD *)lpplProdGlob;
                    uVar6 = lpplProdGlob._2_2_;
                    lVar30 = __aFlshl(CONCAT22(iVar16 + (uint)(0xfffe < uVar9), uVar15), 2);
                    puVar22 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar30);
                    uVar34 = *puVar22;
                    uVar6 = puVar22[1];
                    pPVar18 = (PLPROD *)lpplProdGlob;
                    uVar8 = lpplProdGlob._2_2_;
                    lVar30 = __aFlshl(CONCAT22(iVar16, uVar9), 2);
                    puVar22 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar30);
                    *puVar22 = uVar34;
                    puVar22[1] = uVar6;
                    pPVar18 = (PLPROD *)lpplProdGlob;
                    uVar34 = lpplProdGlob._2_2_;
                    lVar30 = __aFlshl(CONCAT22(iVar16 + (uint)(0xfffe < uVar9), uVar15), 2);
                    puVar22 = (undefined2 *)((int)&pPVar18[1].wFlags + (int)lVar30);
                    *puVar22 = uVar33;
                    puVar22[1] = uVar24;
                    uVar33 = 0;
                    pPVar32 = 0;
                    pPVar18 = (PLPROD *)lpplProdGlob;
                    uVar24 = lpplProdGlob._2_2_;
                    HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
                    FillPlanetProdLB(HVar12, (PLPROD *)CONCAT22(uVar24, pPVar18), (PLANET *)CONCAT22(uVar33, pPVar32));
                    HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
                    uVar24 = 0x14f8;
                    SendMessage(HVar12, CB_GETCURSEL, uVar15 + 1, 0);
                    psVar23 = &stack0xffbe;
                    goto PRODUCE_RedrawText;
                }
                if (wParam != 0x816) {
                    return;
                }
            }
            ipl = 0;
            lpprod = (PROD *)((PLPROD *)lpplProdGlob + 1);
            while (true) {
                uVar24 = (undefined2)((ulong)lpplProdGlob >> 0x10);
                if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= ipl)
                    break;
                iSrc = 0;
                while (true) {
                    pPVar20 = (PROD *)lpprod;
                    uVar24 = (undefined2)((ulong)lpprod >> 0x10);
                    if (cProdGlob <= iSrc)
                        break;
                    uVar28 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[iSrc].dwFlags + 2), (int)(pProdGlob + iSrc)->dwFlags), 0x11);
                    uVar26 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar20->dwFlags + 2), (int)lpprod->dwFlags), 0x11);
                    if (((uint)uVar28 & 7) == ((uint)uVar26 & 7)) {
                        uVar28 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[iSrc].dwFlags + 2), (int)(pProdGlob + iSrc)->dwFlags), 10);
                        uVar26 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar20->dwFlags + 2), (int)lpprod->dwFlags), 10);
                        if (((uint)uVar28 & 0x7f) == ((uint)uVar26 & 0x7f))
                            break;
                    }
                    iSrc = iSrc + 1;
                }
                if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
                    lVar30 = __aFlshl((ulong)((uint)lpprod->dwFlags & 0x3ff), 0);
                    lpplprodT._2_2_ = (int)lVar30 + (int)(pProdGlob + iSrc)->dwFlags & 0x3ff;
                    pPVar21 = pProdGlob + iSrc;
                    pPVar1 = pPVar21;
                    *&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
                    puVar2 = (undefined2 *)((int)&pPVar21->dwFlags + 2);
                    *puVar2 = *puVar2;
                    pPVar21 = pProdGlob + iSrc;
                    pPVar1 = pPVar21;
                    *&pPVar1->dwFlags = (uint)pPVar1->dwFlags | lpplprodT._2_2_;
                    puVar2 = (undefined2 *)((int)&pPVar21->dwFlags + 2);
                    *puVar2 = *puVar2;
                }
                ipl = ipl + 1;
                lpprod = (PROD *)CONCAT22(uVar24, pPVar20 + 1);
            }
            if (wParam == 0x816) {
                uVar28 = __aFulmul(lParam, 0x28);
                cMax = (uint)((PLPROD *)lpplProdGlob)->iprodMac +
                       (uint) * (byte *)((int)((ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1)->rgpq + (int)uVar28 + -1);
                if (cMax == 0) {
                    cMax = 1;
                }
                pPVar27 = LpplAlloc(4, cMax, htOrd);
                uVar24 = (undefined2)((ulong)pPVar27 >> 0x10);
                pPVar7 = (PL *)pPVar27;
                __fmemset((PL *)CONCAT22(uVar24, pPVar7 + 1), 0, cMax << 2);
                iDst = 0;
                iSrc = 0;
                while (true) {
                    uVar33 = (undefined2)((ulong)lpplProdGlob >> 0x10);
                    if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= iSrc)
                        break;
                    pPVar18 = (PLPROD *)lpplProdGlob + iSrc + 1;
                    uVar28 = __aFulshr(CONCAT22(*(undefined2 *)&pPVar18->iprodMax, pPVar18->wFlags), 0x11);
                    if (((uint)uVar28 & 7) == 1) {
                        uVar28 =
                            __aFulshr(CONCAT22(*(undefined2 *)&((PLPROD *)lpplProdGlob)[iSrc + 1].iprodMax, ((PLPROD *)lpplProdGlob + iSrc + 1)->wFlags), 10);
                        if (6 < ((uint)uVar28 & 0x7f))
                            goto LAB_10d0_29f0;
                    } else {
                    LAB_10d0_29f0:
                        uVar33 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iSrc + 1].iprodMax;
                        (pPVar7 + iDst + 1)->wFlags = ((PLPROD *)lpplProdGlob + iSrc + 1)->wFlags;
                        *(undefined2 *)&pPVar7[iDst + 1].iMax = uVar33;
                        iDst = iDst + 1;
                    }
                    iSrc = iSrc + 1;
                }
                for (iSrc = 0; uVar28 = __aFulmul(lParam, 0x28),
                    iSrc < (int)(uint) * (byte *)((int)((ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1)->rgpq + (int)uVar28 + -1);
                     iSrc = iSrc + 1) {
                    sVar35 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv);
                    if (((sVar35 != raMacintosh) || (uVar28 = __aFulmul(lParam, 0x28), 2 < (*(uint *)((int)uVar28 + 0x2306 + iSrc * 2) & 0x3f))) &&
                        ((sVar35 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv),
                          sVar35 != raTerra || ((uVar28 = __aFulmul(lParam, 0x28),
                                                 (*(uint *)((int)uVar28 + 0x2306 + iSrc * 2) & 0x3f) != 4 &&
                                                     (uVar28 = __aFulmul(lParam, 0x28), (*(uint *)((int)uVar28 + 0x2306 + iSrc * 2) & 0x3f) != 5)))))) {
                        uVar15 = *(uint *)&pPVar7[iDst + 1].iMax;
                        (pPVar7 + iDst + 1)->wFlags = (pPVar7 + iDst + 1)->wFlags;
                        *(uint *)&pPVar7[iDst + 1].iMax = uVar15 & 0xfff1 | 2;
                        uVar28 = __aFulmul(lParam, 0x28);
                        lVar30 = __aFlshl((ulong)(*(uint *)((int)uVar28 + 0x2306 + iSrc * 2) & 0x3f), 10);
                        uVar15 = *(uint *)&pPVar7[iDst + 1].iMax;
                        (pPVar7 + iDst + 1)->wFlags = (pPVar7 + iDst + 1)->wFlags & 0x3ff | (uint)lVar30;
                        *(uint *)&pPVar7[iDst + 1].iMax = uVar15 & 0xfffe | (uint)((ulong)lVar30 >> 0x10);
                        uVar28 = __aFulmul(lParam, 0x28);
                        lVar30 = __aFlshl((ulong)(*(uint *)((int)uVar28 + 0x2306 + iSrc * 2) >> 6), 0);
                        uVar15 = *(uint *)&pPVar7[iDst + 1].iMax;
                        (pPVar7 + iDst + 1)->wFlags = (pPVar7 + iDst + 1)->wFlags & 0xfc00 | (uint)lVar30;
                        *(uint *)&pPVar7[iDst + 1].iMax = uVar15 | (uint)((ulong)lVar30 >> 0x10);
                        iDst = iDst + 1;
                    }
                }
                pPVar7->iMac = (byte)iDst;
                FreePl(lpplProdGlob);
                lpplProdGlob = pPVar27;
                uVar28 = __aFulmul(lParam, 0x28);
                lVar30 = __aFlshl((ulong)((&(((ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1)->rgpq + -1)->fNoResearch)[(int)uVar28] & 1), 0x17);
                sel.pl.rgbImp._4_2_ = sel.pl.rgbImp._4_2_ | (uint)lVar30;
                sel.pl.rgbImp._6_2_ = sel.pl.rgbImp._6_2_ & 0xff7f | (uint)((ulong)lVar30 >> 0x10);
                HVar12 = GetDlgItem(hwnd, IDC_U16_0x008B);
                WVar36 = CB_LIMITTEXT;
                uVar28 = __aFulshr(CONCAT22(sel.pl.rgbImp._6_2_, sel.pl.rgbImp._4_2_), 0x17);
                SendMessage(HVar12, WVar36, (WParamMessageId)uVar28 & 1, 0);
            } else {
                ((PLPROD *)lpplProdGlob)->iprodMac = 0;
            }
            uVar33 = 0;
            pPVar32 = 0;
            pPVar18 = (PLPROD *)lpplProdGlob;
            uVar24 = lpplProdGlob._2_2_;
            HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
            FillPlanetProdLB(HVar12, (PLPROD *)CONCAT22(uVar24, pPVar18), (PLANET *)CONCAT22(uVar33, pPVar32));
            HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
            SendMessage(HVar12, CB_GETCURSEL, 0, 0);
            sVar35 = -1;
            HVar12 = GetDlgItem(hwnd, IDC_U16_0x0416);
            FillProdSrcLB(HVar12, sVar35);
            HVar12 = GetDlgItem(hwnd, IDC_U16_0x0416);
            uVar24 = 0x14f8;
            SendMessage(HVar12, CB_GETCURSEL, 0, 0);
            psVar23 = &stack0xffbe;
            goto PRODUCE_RedrawText;
        }
    }
    HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
    LVar29 = SendMessage(HVar12, CB_GETLBTEXTLEN, 0, 0);
    uVar15 = (uint)LVar29;
    if (LVar29 < 1) {
        return;
    }
    uVar24 = (undefined2)((ulong)lpplProdGlob >> 0x10);
    pPVar18 = (PLPROD *)lpplProdGlob;
    uVar10 = (uint)pPVar18->iprodMac;
    lSel._0_2_ = uVar15 - 1;
    lSel._2_2_ = (int)((ulong)LVar29 >> 0x10) - (uint)(uVar15 == 0);
    lVar30 = __aFlshl(CONCAT22(lSel._2_2_, (WParamMessageId)lSel), 2);
    puVar19 = (uint *)((int)&pPVar18[1].wFlags + (int)lVar30);
    uVar9 = *puVar19;
    uVar5 = puVar19[1];
    for (iSrc = 0; iSrc < cProdGlob; iSrc = iSrc + 1) {
        uVar28 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[iSrc].dwFlags + 2), (int)(pProdGlob + iSrc)->dwFlags), 0x11);
        lpplprodT._2_2_ = (uint)uVar28 & 7;
        uVar28 = __aFulshr(CONCAT22(uVar5, uVar9), 0x11);
        if (lpplprodT._2_2_ == ((uint)uVar28 & 7)) {
            uVar28 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[iSrc].dwFlags + 2), (int)(pProdGlob + iSrc)->dwFlags), 10);
            lpplprodT._2_2_ = (uint)uVar28 & 0x7f;
            uVar28 = __aFulshr(CONCAT22(uVar5, uVar9), 10);
            if (lpplprodT._2_2_ == ((uint)uVar28 & 0x7f))
                break;
        }
    }
    uVar28 = (pProdGlob + iSrc)->dwFlags;
    uVar11 = GetAsyncKeyState(0x11);
    if ((uVar11 & 0xfffe) == 0) {
        uVar11 = GetAsyncKeyState(0x10);
        if ((uVar11 & 0xfffe) == 0) {
            c = 1;
        } else {
            c = 10;
        }
    } else {
        uVar11 = GetAsyncKeyState(0x10);
        if ((uVar11 & 0xfffe) == 0) {
            c = 100;
        } else {
            c = 0x3fc;
        }
    }
    uVar26 = __aFulshr(CONCAT22(uVar5, uVar9), 0x11);
    if ((((uint)uVar26 & 7) == 1) && (uVar26 = __aFulshr(CONCAT22(uVar5, uVar9), 10), ((uint)uVar26 & 0x7f) == 3)) {
        c = 0x3fc;
    }
    if ((uVar9 & 0x3ff) <= (uint)c) {
        c = uVar9 & 0x3ff;
    }
    if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
        uVar26 = (pProdGlob + iSrc)->dwFlags;
        pPVar20 = pProdGlob + iSrc;
        pPVar1 = pPVar20;
        *&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
        puVar2 = (undefined2 *)((int)&pPVar20->dwFlags + 2);
        *puVar2 = *puVar2;
        pPVar20 = pProdGlob + iSrc;
        pPVar1 = pPVar20;
        *&pPVar1->dwFlags = (uint)pPVar1->dwFlags | c + (int)uVar26 & 0x3ffU;
        puVar2 = (undefined2 *)((int)&pPVar20->dwFlags + 2);
        *puVar2 = *puVar2;
    }
    pPVar18 = (PLPROD *)lpplProdGlob;
    uVar24 = lpplProdGlob._2_2_;
    lVar30 = __aFlshl(CONCAT22(lSel._2_2_, (WParamMessageId)lSel), 2);
    lpplprodT._2_2_ = *(int *)((int)&pPVar18[1].wFlags + (int)lVar30) - c & 0x3ff;
    pPVar18 = (PLPROD *)lpplProdGlob;
    uVar24 = lpplProdGlob._2_2_;
    lVar30 = __aFlshl(CONCAT22(lSel._2_2_, (WParamMessageId)lSel), 2);
    puVar19 = (uint *)((int)&pPVar18[1].wFlags + (int)lVar30);
    puVar3 = puVar19;
    *puVar3 = *puVar3 & 0xfc00;
    puVar3 = puVar19 + 1;
    *puVar3 = *puVar3;
    pPVar18 = (PLPROD *)lpplProdGlob;
    uVar24 = lpplProdGlob._2_2_;
    lVar30 = __aFlshl(CONCAT22(lSel._2_2_, (WParamMessageId)lSel), 2);
    puVar19 = (uint *)((int)&pPVar18[1].wFlags + (int)lVar30);
    puVar3 = puVar19;
    *puVar3 = *puVar3 | lpplprodT._2_2_;
    puVar3 = puVar19 + 1;
    *puVar3 = *puVar3;
    pPVar18 = (PLPROD *)lpplProdGlob;
    uVar24 = lpplProdGlob._2_2_;
    lVar30 = __aFlshl(CONCAT22(lSel._2_2_, (WParamMessageId)lSel), 2);
    if ((*(uint *)((int)&pPVar18[1].wFlags + (int)lVar30) & 0x3ff) == 0) {
        iVar16 = lSel._2_2_ + (uint)(0xfffe < (WParamMessageId)lSel);
        if ((iVar16 < 1) && ((iVar16 < 0 || (uVar15 < uVar10)))) {
            uVar17 = ((uVar10 - (WParamMessageId)lSel) + -1) * 4;
            pPVar18 = (PLPROD *)lpplProdGlob;
            uVar24 = lpplProdGlob._2_2_;
            lVar30 = __aFlshl(CONCAT22(lSel._2_2_ + (uint)(0xfffe < (WParamMessageId)lSel), uVar15), 2);
            pvVar31 = (void *)((int)&pPVar18[1].wFlags + (int)lVar30);
            pPVar18 = (PLPROD *)lpplProdGlob;
            uVar33 = lpplProdGlob._2_2_;
            lVar30 = __aFlshl(CONCAT22(lSel._2_2_, (WParamMessageId)lSel), 2);
            __fmemmove((void *)CONCAT22(uVar33, (void *)((int)&pPVar18[1].wFlags + (int)lVar30)), (void *)CONCAT22(uVar24, pvVar31), uVar17);
        } else {
            bVar25 = (WParamMessageId)lSel == 0;
            lSel._0_2_ = uVar15 - 2;
            lSel._2_2_ = lSel._2_2_ - (uint)bVar25;
        }
        pbVar4 = &((PLPROD *)lpplProdGlob)->iprodMac;
        *pbVar4 = *pbVar4 - 1;
    }
    uVar34 = 0;
    pPVar32 = 0;
    pPVar18 = (PLPROD *)lpplProdGlob;
    uVar33 = lpplProdGlob._2_2_;
    HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
    uVar24 = 0x1048;
    FillPlanetProdLB(HVar12, (PLPROD *)CONCAT22(uVar33, pPVar18), (PLANET *)CONCAT22(uVar34, pPVar32));
    if (-1 < lSel._2_2_) {
        HVar12 = GetDlgItem(hwnd, IDC_U16_0x0417);
        uVar24 = 0x14f8;
        SendMessage(HVar12, CB_GETCURSEL, (WParamMessageId)lSel + 1, 0);
    }
    if ((uVar28 & 0x3ff) == 0) {
        sVar35 = -1;
        HVar12 = GetDlgItem(hwnd, IDC_U16_0x0416);
        uVar24 = 0x10d0;
        FillProdSrcLB(HVar12, sVar35);
    }
    psVar23 = &stack0xffba;
PRODUCE_RedrawText:
    psVar23[-1] = hwnd;
    psVar23[-2] = unaff_SS;
    psVar23[-3] = (short)&rc;
    psVar23[-4] = uVar24;
    psVar23[-5] = 0x2e21;
    GetClientRect(psVar23[-1], *(RECT **)(psVar23 + -3));
    rc.top = yTopFutureTech;
    rc.bottom = dyArial8 * 7 + yTopFutureTech;
    rc.left = rc.left + 0x82;
    psVar23[-1] = hwnd;
    psVar23[-2] = unaff_SS;
    psVar23[-3] = (short)&rc;
    psVar23[-4] = 1;
    psVar23[-5] = 0x14f8;
    psVar23[-6] = 0x2e4c;
    InvalidateRect(psVar23[-1], *(RECT **)(psVar23 + -3), psVar23[-4]);
    *psVar23 = 0xffff;
    psVar23[-1] = (short)&rc;
    psVar23[-2] = 0;
    psVar23[-3] = hwnd;
    psVar23[-4] = 0x14f8;
    psVar23[-5] = 0x2e60;
    DrawProductionDlg(psVar23[-3], psVar23[-2], (RECT *)psVar23[-1], *psVar23);
    return;
}

// ======================================================================
// Function: InitializeProductionDlg
// Address: 10d0:3430
// Segment: MEMORY_PRODUCE
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10d0353f) */
/* WARNING: Removing unreachable block (ram,0x10d0351f) */
/* WARNING: Removing unreachable block (ram,0x10d03544) */
/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

void InitializeProductionDlg(HWND hwnd)

{
    char      *pcVar1;
    char      *pcVar2;
    HWND       HVar3;
    PLPROD    *pPVar4;
    PROD      *pPVar5;
    undefined2 unaff_SS;
    ulong      uVar6;
    PLANET    *pPVar7;
    WMType     WVar8;
    short      mdFill;
    undefined2 uVar9;
    undefined2 uVar10;
    PROD      *lpprod;
    short      iSel;
    short      i;
    char       rgch[86];

    iSel = -1;
    pcVar1 = PszGetPlanetName(sel.pl.id);
    uVar10 = 0x1120;
    pcVar2 = PszGetCompressedString(idsProductionQueueS);
    _wsprintf(rgch, pcVar2, pcVar1, uVar10);
    SetWindowText(hwnd, rgch);
    mdFill = -1;
    HVar3 = GetDlgItem(hwnd, IDC_U16_0x0416);
    FillProdSrcLB(HVar3, mdFill);
    HVar3 = GetDlgItem(hwnd, IDC_U16_0x0416);
    SendMessage(HVar3, CB_GETCURSEL, 0, 0);
    i = 0;
    lpprod = (PROD *)((PLPROD *)lpplProdGlob + 1);
    while (true) {
        uVar10 = (undefined2)((ulong)lpplProdGlob >> 0x10);
        pPVar4 = (PLPROD *)lpplProdGlob;
        if ((int)(uint)pPVar4->iprodMac <= i)
            break;
        uVar10 = (undefined2)((ulong)lpprod >> 0x10);
        pPVar5 = (PROD *)lpprod;
        uVar6 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar5->dwFlags + 2), (int)lpprod->dwFlags), 0x11);
        if ((((uint)uVar6 & 7) != 1) ||
            (uVar6 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar5->dwFlags + 2), (int)lpprod->dwFlags), 10), 6 < ((uint)uVar6 & 0x7f))) {
            iSel = i;
        }
        i = i + 1;
        lpprod = (PROD *)CONCAT22(uVar10, pPVar5 + 1);
    }
    uVar9 = 0;
    pPVar7 = 0;
    HVar3 = GetDlgItem(hwnd, IDC_U16_0x0417);
    FillPlanetProdLB(HVar3, (PLPROD *)CONCAT22(uVar10, pPVar4), (PLANET *)CONCAT22(uVar9, pPVar7));
    HVar3 = GetDlgItem(hwnd, IDC_U16_0x0417);
    SendMessage(HVar3, CB_GETCURSEL, iSel + 1, 0);
    HVar3 = GetDlgItem(hwnd, IDC_U16_0x008B);
    WVar8 = CB_LIMITTEXT;
    uVar6 = __aFulshr(CONCAT22(sel.pl.rgbImp._6_2_, sel.pl.rgbImp._4_2_), 0x17);
    SendMessage(HVar3, WVar8, (WParamMessageId)uVar6 & 1, 0);
    return;
}

// ======================================================================
// Function: DrawProductionDlg
// Address: 10d0:35dc
// Segment: MEMORY_PRODUCE
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10d036d8) */
/* WARNING: Removing unreachable block (ram,0x10d0372f) */
/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

void DrawProductionDlg(HWND hwnd, HDC hdc, RECT *prc, short iDraw)

{
    int        iVar1;
    long       lVar2;
    bool       bVar3;
    char      *pcVar4;
    ControlId  CVar5;
    HWND       HVar6;
    short      sVar7;
    short      sVar8;
    int        iVar9;
    uint       uVar10;
    ushort     uVar11;
    uint      *puVar12;
    undefined2 unaff_SS;
    bool       bVar13;
    DWORD      DVar14;
    long       lVar15;
    ulong      uVar16;
    undefined2 uVar17;
    short      sVar18;
    HDC        HVar19;
    char       szT[100];
    PROD       prod;
    RECT       rc;
    short      k;
    short      dxkT;
    long       rgCost[4];
    short      c;
    short      i;
    short      fCreatedDC;
    short      idc;
    short      iSrc;
    long       lSel;

    bVar13 = hdc == 0;
    if (bVar13) {
        hdc = GetDC(hwnd);
    }
    SelectObject(hdc, rghfontArial8[0]);
    HVar19 = hdc;
    pcVar4 = PszGetCompressedString(idsKt);
    DVar14 = GetTextExtent(HVar19, pcVar4, 2);
    SelectObject(hdc, rghfontArial8[1]);
    SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
    i = 0;
    do {
        if (1 < i) {
            GetClientRect(hwnd, &rc);
            rc.top = rc.bottom - ((dyArial8 * 5) / 2 + 0xc);
            rc.bottom = (dyArial8 | 1U) + rc.top;
            rc.left = 6;
            rc.right = dyArial8 + 6;
            DrawDiamond(hdc, &rc, hbrBBlue);
            rcProdDiamond.left = rc.left;
            rcProdDiamond.top = rc.top;
            rcProdDiamond.right = rc.right;
            rcProdDiamond.bottom = rc.bottom;
            SelectObject(hdc, rghfontArial8[1]);
            sVar7 = CchGetString(idsApplyDefineProductionTemplate, (char *)szWork);
            TextOut(hdc, rc.right + 4, rc.top, szWork, sVar7);
            if (bVar13) {
                ReleaseDC(hwnd, hdc);
            }
            return;
        }
        if (i == 0) {
            CVar5 = IDC_U16_0x0416;
        } else {
            CVar5 = IDC_U16_0x0417;
        }
        HVar6 = GetDlgItem(hwnd, CVar5);
        GetWindowRect(HVar6, &rc);
        ScreenToClient(hwnd, (POINT *)&rc);
        ScreenToClient(hwnd, (POINT *)&rc.right);
        HVar6 = GetDlgItem(hwnd, CVar5);
        lVar15 = SendMessage(HVar6, CB_GETLBTEXTLEN, 0, 0);
        if ((-1 < lVar15) && ((lVar15 != 0 || (i != 1)))) {
            if (i == 0) {
                iSrc = 0;
                while (true) {
                    lSel._2_2_ = (int)((ulong)lVar15 >> 0x10);
                    lSel._0_2_ = (int)lVar15;
                    lVar2 = lVar15;
                    if (cProdGlob <= iSrc)
                        break;
                    if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0) {
                        iVar9 = lSel._2_2_ - (uint)((int)lSel == 0);
                        lVar2 = CONCAT22(iVar9, (int)lSel + -1);
                        bVar3 = lVar15 == 0;
                        lVar15 = CONCAT22(iVar9, (int)lSel + -1);
                        if (bVar3)
                            break;
                    }
                    iSrc = iSrc + 1;
                }
                prod.dwFlags._2_2_ = *(uint *)((int)&pProdGlob[iSrc].dwFlags + 2);
                prod.dwFlags._0_2_ = (uint)(pProdGlob + iSrc)->dwFlags & 0xfc00 | 1;
            } else {
                iVar9 = (int)lVar15 + -1;
                iVar1 = (int)((ulong)lVar15 >> 0x10) - (uint)((int)lVar15 == 0);
                szT._96_2_ = (PLPROD *)lpplProdGlob + 1;
                szT[0x62] = lpplProdGlob._2_1_;
                szT[99] = lpplProdGlob._3_1_;
                lVar15 = __aFlshl(CONCAT22(iVar1, iVar9), 2);
                lVar2 = CONCAT22(iVar1, iVar9);
                puVar12 = (uint *)(szT._96_2_ + (int)lVar15);
                prod.dwFlags._0_2_ = *puVar12;
                prod.dwFlags._2_2_ = puVar12[1];
            }
            GetProductionCosts(&sel.pl, &prod, rgCost, idPlayer, 0);
            rc.bottom = yTopFutureTech + 4;
            SelectObject(hdc, rghfontArial8[1]);
            sVar7 = CchGetString(idsRequiredMinerals, (char *)szWork);
            TextOut(hdc, rc.left, rc.bottom, szWork, sVar7);
            rc.left = rc.left + 0x14;
            rc.right = rc.right + -0x14;
            for (k = 0; k < 4; k = k + 1) {
                iVar9 = k;
                if (k == 3) {
                    iVar9 = 5;
                }
                rc.bottom = rc.bottom + dyArial8;
                SelectObject(hdc, rghfontArial8[1]);
                SetTextColor(hdc, CONCAT22(*(undefined2 *)(iVar9 * 4 + rgcrMinerals_0x2), *(undefined2 *)(iVar9 * 4 + rgcrMinerals)));
                pcVar4 = (char *)*(undefined2 *)(iVar9 * 2 + rgszMinerals);
                uVar17 = 0x1120;
                sVar7 = rc.bottom;
                sVar18 = rc.left;
                HVar19 = hdc;
                sVar8 = lstrlen((char *)*(undefined2 *)(iVar9 * 2 + rgszMinerals));
                TextOut(HVar19, sVar18, sVar7, (LPCSTR)CONCAT22(uVar17, pcVar4), sVar8);
                SelectObject(hdc, rghfontArial8[0]);
                SetTextColor(hdc, CONCAT22(crWindowText._2_2_, (undefined2)crWindowText));
                sVar7 = _wsprintf(szWork, PCTLD, (int)rgCost[k], *(undefined2 *)((int)rgCost + k * 4 + 2));
                RightTextOut(hdc, (rc.right - (int)DVar14) + -2, rc.bottom, (char *)szWork, sVar7, dxMaxMineralQuan);
                if (k < 3) {
                    iVar9 = rc.right - (int)DVar14;
                    sVar7 = rc.bottom;
                    HVar19 = hdc;
                    pcVar4 = PszGetCompressedString(idsKt);
                    TextOut(HVar19, iVar9, sVar7, pcVar4, 2);
                }
            }
            if (i != 0) {
                rc.bottom = rc.bottom + (dyArial8 * 3) / 2;
                SelectObject(hdc, rghfontArial8[1]);
                uVar16 = __aFulshr(CONCAT22(prod.dwFlags._2_2_, (uint)prod.dwFlags), 0x14);
                uVar10 = (uint)uVar16 & 0x7f;
                pcVar4 = PszGetCompressedString(idsDDoneCompletion);
                sVar7 = _wsprintf(szT, pcVar4, uVar10);
                lSel._0_2_ = (int)lVar2;
                PszProductionETA(&sel.pl, (PLPROD *)CONCAT22(lpplProdGlob._2_2_, (PLPROD *)lpplProdGlob), (int)lSel, 0, 0);
                _strcpy(szT + sVar7, (char *)szWork);
                iVar9 = rc.left + -0x14;
                pcVar4 = szT;
                uVar17 = unaff_SS;
                sVar7 = rc.bottom;
                HVar19 = hdc;
                uVar11 = _strlen(szT);
                TextOut(HVar19, iVar9, sVar7, (LPCSTR)CONCAT22(uVar17, pcVar4), uVar11);
                SelectObject(hdc, rghfontArial8[0]);
            }
        }
        i = i + 1;
    } while (true);
}

// ======================================================================
// Function: FillProdSrcLB
// Address: 10d0:3b00
// Segment: MEMORY_PRODUCE
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10d03c3a) */
/* WARNING: Removing unreachable block (ram,0x10d03bce) */
/* WARNING: Removing unreachable block (ram,0x10d03b6b) */
/* WARNING: Removing unreachable block (ram,0x10d03b66) */
/* WARNING: Removing unreachable block (ram,0x10d03bfb) */
/* WARNING: Removing unreachable block (ram,0x10d03bf6) */
/* WARNING: Removing unreachable block (ram,0x10d03c3f) */
/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

void FillProdSrcLB(HWND hwndLB, short mdFill)

{
    char      *pcVar1;
    undefined2 unaff_SS;
    ulong      uVar2;
    char      *psz;
    short      i;
    char       szT[80];

    for (i = 0; i < 6; i = i + 1) {
        szT[i] = ' ';
    }
    SendMessage(hwndLB, CB_DIR, 0, 0);
    for (i = 0; i < cProdGlob; i = i + 1) {
        if (((pProdGlob + i)->dwFlags & 0x3ff) != 0) {
            pcVar1 = PszNameProdItem(pProdGlob + i);
            _strcpy(szT + 6, pcVar1);
            uVar2 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[i].dwFlags + 2), (int)(pProdGlob + i)->dwFlags), 0x11);
            if (((uint)uVar2 & 7) == 2) {
                uVar2 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[i].dwFlags + 2), (int)(pProdGlob + i)->dwFlags), 10);
                if (((uint)uVar2 & 0x7f) < 0x10) {
                    szT[0] = '*';
                } else {
                    szT[0] = '#';
                }
            } else {
                uVar2 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[i].dwFlags + 2), (int)(pProdGlob + i)->dwFlags), 10);
                if (((uint)uVar2 & 0x7f) < 7) {
                    szT[0] = 'I';
                    _strcat(szT + 6, (char *)" (Auto Build)");
                } else {
                    szT[0] = ' ';
                }
            }
            SendMessage(hwndLB, CB_LIMITTEXT, 0, (LPARAM)szT);
        }
    }
    return;
}

// ======================================================================
// Function: PszNameProdItem
// Address: 10d0:3c92
// Segment: MEMORY_PRODUCE
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10d03cde) */
/* WARNING: Removing unreachable block (ram,0x10d03ce7) */
/* WARNING: Removing unreachable block (ram,0x10d03e82) */
/* WARNING: Removing unreachable block (ram,0x10d03ee7) */
/* WARNING: Removing unreachable block (ram,0x10d03e99) */
/* WARNING: Removing unreachable block (ram,0x10d03e87) */
/* WARNING: Removing unreachable block (ram,0x10d03e9e) */
/* WARNING: Removing unreachable block (ram,0x10d03cec) */

char *PszNameProdItem(PROD *lpprod)

{
    int        iVar1;
    int        iVar2;
    uint       uVar3;
    int        iVar4;
    undefined2 uVar5;
    ulong      uVar6;
    ulong      uVar7;
    PLANETARY *pPVar8;
    short      iDelta;
    ulong      iItem;

    uVar5 = (undefined2)((ulong)lpprod >> 0x10);
    uVar6 = __aFulshr(CONCAT22(*(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2), (int)lpprod->dwFlags), 10);
    uVar3 = (uint)uVar6 & 0x7f;
    uVar7 = __aFulshr(CONCAT22(*(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2), (int)lpprod->dwFlags), 0x11);
    if (((uint)uVar7 & 7) == 2) {
        if (uVar3 < 0x10) {
            uVar7 = __aFulmul(uVar6 & 0x7f, 0x93);
            if ((*(uint *)((int)&rgshdef[0].wFlags + (int)uVar7) >> 9 & 1) == 0) {
                uVar6 = __aFulmul(uVar6 & 0x7f, 0x93);
                _strcpy((char *)szWork, (char *)((int)&rgshdef[0].hul + 8 + (int)uVar6));
                goto LAB_10d0_3f19;
            }
        } else {
            iVar1 = uVar3 - 0x10;
            iVar2 = -(uint)(uVar3 < 0x10);
            uVar6 = __aFulmul(CONCAT22(iVar2, iVar1), 0x93);
            if ((*(uint *)(*(int *)(idPlayer * 4 + rglpshdefSB) + (int)uVar6 + 0x7b) >> 9 & 1) == 0) {
                uVar6 = __aFulmul(CONCAT22(iVar2, iVar1), 0x93);
                __fstrcpy(szWork,
                          (char *)CONCAT22(*(undefined2 *)(idPlayer * 4 + rglpshdefSB_0x2), (char *)(*(int *)(idPlayer * 4 + rglpshdefSB) + (int)uVar6 + 8)));
                if ((sel.pl.wFlags_0x4 >> 9 & 1) != 0) {
                    iVar4 = *(int *)(*(int *)(idPlayer * 4 + rglpshdefSB) + ((uint)sel.pl.lStarbase & 0xf) * 0x93);
                    uVar6 = __aFulmul(CONCAT22(iVar2, iVar1), 0x93);
                    iVar4 = iVar4 - *(int *)(*(int *)(idPlayer * 4 + rglpshdefSB) + (int)uVar6);
                    if (iVar4 < 1) {
                        if (iVar4 < 0) {
                            _strcat((char *)szWork, (char *)" (upgrade)");
                        }
                    } else {
                        _strcat((char *)szWork, (char *)" (downgrade)");
                    }
                }
                goto LAB_10d0_3f19;
            }
        }
        szWork[0] = '\0';
    } else if ((uVar3 < 0x12) || (0x1a < uVar3)) {
        if (uVar3 == 0x1b) {
            CchGetString(idsPlanetaryScanner, (char *)szWork);
        } else {
            CchGetString(uVar3 + idsMines, (char *)szWork);
        }
    } else {
        pPVar8 = LpplanetaryFromId(uVar3 - 0x12);
        __fstrcpy(szWork, (char *)CONCAT22((int)((ulong)pPVar8 >> 0x10), ((PLANETARY *)pPVar8)->szName));
    }
LAB_10d0_3f19:
    return (char *)szWork;
}

// ======================================================================
// Function: GetProductionCosts
// Address: 10d0:3f20
// Segment: MEMORY_PRODUCE
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10d03faf) */
/* WARNING: Removing unreachable block (ram,0x10d03fa6) */
/* WARNING: Removing unreachable block (ram,0x10d03fb4) */

void GetProductionCosts(PLANET *lppl, PROD *lpprod, ulong *rgCost, short iplr, short fOnlyOne)

{
    byte       bVar1;
    ulong      uVar2;
    short      sVar3;
    int        iVar4;
    ushort     uVar5;
    short      sVar6;
    HUL       *pHVar7;
    HUL       *pHVar8;
    PLANET    *pPVar9;
    undefined2 uVar10;
    undefined2 uVar11;
    bool       bVar12;
    bool       bVar13;
    ulong      uVar14;
    ulong      uVar15;
    ushort    *rgCost_00;
    short      rgCostsPartNew[4];
    short      rgCostsPartCur[4];
    HUL       *lphulCur;
    HUL       *lphulNew;
    short      chs;
    short      cost;
    PART       part;
    short      fStarbase;
    ulong      cItem;
    short      raMajor;
    SHDEF     *lpshdef;
    short      j;
    short      i;
    ushort     rgCosts[4];
    ulong      iItem;
    ushort     rgCostsCur[4];

    uVar10 = (undefined2)((ulong)lppl >> 0x10);
    pPVar9 = (PLANET *)lppl;
    sVar3 = GetRaceStat((PLAYER *)rgplr + pPVar9->iPlayer, rsMajorAdv);
    uVar11 = (undefined2)((ulong)lpprod >> 0x10);
    uVar14 = __aFulshr(CONCAT22(*(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2), (int)lpprod->dwFlags), 10);
    iItem._0_2_ = (uint)uVar14 & 0x7f;
    iItem._2_2_ = 0;
    uVar2 = lpprod->dwFlags;
    uVar15 = __aFulshr(CONCAT22(*(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2), (int)lpprod->dwFlags), 0x11);
    if (((uint)uVar15 & 7) == 2) {
        bVar12 = 0xf < (uint)iItem;
        if (bVar12) {
            lpshdef._0_2_ = (SHDEF *)*(undefined2 *)(iplr * 4 + rglpshdefSB);
            lpshdef._2_2_ = *(undefined2 *)(iplr * 4 + rglpshdefSB_0x2);
            bVar13 = (uint)iItem < 0x10;
            iItem._0_2_ = (uint)iItem - 0x10;
            iItem._2_2_ = -(uint)bVar13;
        } else {
            lpshdef._0_2_ = (SHDEF *)*(undefined2 *)(iplr * 4 + rglpshdef);
            lpshdef._2_2_ = *(undefined2 *)(iplr * 4 + rglpshdef_0x2);
        }
        uVar14 = __aFulmul(CONCAT22(iItem._2_2_, (uint)iItem), 0x93);
        if ((*(uint *)((int)(&((SHDEF *)lpshdef)->hul + 1) + (int)uVar14) >> 9 & 1) != 0) {
            for (i = 0; i < 4; i = i + 1) {
                *(undefined2 *)(rgCost + i) = 0;
                *(undefined2 *)((int)(rgCost + i) + 2) = 0;
            }
            return;
        }
        rgCost_00 = rgCosts;
        uVar14 = __aFulmul(CONCAT22(iItem._2_2_, (uint)iItem), 0x93);
        GetTrueHullCost(iplr, (HUL *)CONCAT22(lpshdef._2_2_, (((SHDEF *)lpshdef)->hul).rgTech + (int)uVar14 + -2), rgCost_00);
        if ((bVar12) && ((pPVar9->wFlags_0x4 >> 9 & 1) != 0)) {
            uVar11 = *(undefined2 *)(iplr * 4 + rglpshdefSB_0x2);
            pHVar7 = (HUL *)(*(int *)(iplr * 4 + rglpshdefSB) + (*(uint *)&pPVar9->lStarbase & 0xf) * 0x93);
            lphulCur = (HUL *)CONCAT22(uVar11, pHVar7);
            uVar14 = __aFulmul(CONCAT22(iItem._2_2_, (uint)iItem), 0x93);
            pHVar8 = (((SHDEF *)lpshdef)->hul).rgTech + (int)uVar14 + -2;
            lphulNew = (HUL *)CONCAT22(lpshdef._2_2_, pHVar8);
            GetTrueHullCost(iplr, (HUL *)CONCAT22(uVar11, pHVar7), rgCostsCur);
            if (lphulCur->ihuldef == lphulNew->ihuldef) {
                part.u_PART_0x0004.parmor = LphuldefFromId(lphulCur->ihuldef);
                part.hs.grhst = hstNone;
                GetTruePartCost(iplr, &part, rgCostsPartCur);
                for (i = 0; i < 4; i = i + 1) {
                    rgCosts[i] = rgCosts[i] - rgCostsPartCur[i];
                }
                bVar1 = pHVar7->chs;
                for (i = 0; i < (int)(uint)bVar1; i = i + 1) {
                    if ((pHVar7->rghs[i].wFlags_0x2 >> 8 != 0) && (pHVar8->rghs[i].wFlags_0x2 >> 8 != 0)) {
                        part.hs.grhst = (pHVar7->rghs + i)->grhst;
                        part.hs.wFlags_0x2 = pHVar7->rghs[i].wFlags_0x2;
                        FLookupPart(&part);
                        GetTruePartCost(iplr, &part, rgCostsPartCur);
                        part.hs.grhst = (pHVar8->rghs + i)->grhst;
                        part.hs.wFlags_0x2 = pHVar8->rghs[i].wFlags_0x2;
                        FLookupPart(&part);
                        GetTruePartCost(iplr, &part, rgCostsPartNew);
                        if ((pHVar7->rghs + i)->grhst == (pHVar8->rghs + i)->grhst) {
                            if ((pHVar7->rghs[i].wFlags_0x2 & 0xff) == (pHVar8->rghs[i].wFlags_0x2 & 0xff)) {
                                for (j = 0; j < 4; j = j + 1) {
                                    rgCostsPartCur[j] = rgCostsPartCur[j] * (pHVar7->rghs[i].wFlags_0x2 >> 8);
                                    rgCostsPartNew[j] = rgCostsPartNew[j] * (pHVar8->rghs[i].wFlags_0x2 >> 8);
                                    if ((uint)(rgCostsPartNew[j] - rgCostsPartCur[j]) < 0x8000) {
                                        iVar4 = rgCostsPartNew[j] - rgCostsPartCur[j];
                                    } else {
                                        iVar4 = 0;
                                    }
                                    if (rgCosts[j] < (uint)(rgCostsPartNew[j] - iVar4)) {
                                        uVar5 = rgCosts[j];
                                    } else {
                                        uVar5 = rgCostsPartNew[j] - iVar4;
                                    }
                                    rgCosts[j] = rgCosts[j] - uVar5;
                                }
                            } else {
                                for (j = 0; j < 4; j = j + 1) {
                                    rgCostsPartCur[j] = rgCostsPartCur[j] * (pHVar7->rghs[i].wFlags_0x2 >> 8);
                                    rgCostsPartNew[j] = rgCostsPartNew[j] * (pHVar8->rghs[i].wFlags_0x2 >> 8);
                                    if (rgCostsPartNew[j] - (rgCostsPartCur[j] << 3) / 10 < (rgCostsPartNew[j] << 1) / 10) {
                                        iVar4 = (rgCostsPartNew[j] << 1) / 10;
                                    } else {
                                        iVar4 = rgCostsPartNew[j] - (rgCostsPartCur[j] << 3) / 10;
                                    }
                                    if (rgCosts[j] < (uint)(rgCostsPartNew[j] - iVar4)) {
                                        uVar5 = rgCosts[j];
                                    } else {
                                        uVar5 = rgCostsPartNew[j] - iVar4;
                                    }
                                    rgCosts[j] = rgCosts[j] - uVar5;
                                }
                            }
                        } else {
                            for (j = 0; j < 4; j = j + 1) {
                                rgCostsPartCur[j] = rgCostsPartCur[j] * (pHVar7->rghs[i].wFlags_0x2 >> 8);
                                rgCostsPartNew[j] = rgCostsPartNew[j] * (pHVar8->rghs[i].wFlags_0x2 >> 8);
                                if (rgCostsPartNew[j] - (rgCostsPartCur[j] * 7) / 10 < (rgCostsPartNew[j] * 3) / 10) {
                                    iVar4 = (rgCostsPartNew[j] * 3) / 10;
                                } else {
                                    iVar4 = rgCostsPartNew[j] - (rgCostsPartCur[j] * 7) / 10;
                                }
                                if (rgCosts[j] < (uint)(rgCostsPartNew[j] - iVar4)) {
                                    uVar5 = rgCosts[j];
                                } else {
                                    uVar5 = rgCostsPartNew[j] - iVar4;
                                }
                                rgCosts[j] = rgCosts[j] - uVar5;
                            }
                        }
                    }
                }
            } else {
                for (i = 0; i < 4; i = i + 1) {
                    uVar5 = rgCosts[i] - (int)rgCostsCur[i] / 2;
                    if ((int)uVar5 < (int)(rgCosts[i] / 2)) {
                        rgCosts[i] = rgCosts[i] / 2;
                    } else {
                        rgCosts[i] = uVar5;
                    }
                }
            }
        }
        if ((bVar12) && ((sVar3 = GetRaceGrbit((PLAYER *)rgplr + iplr, ibitRaceISB),
                          sVar3 != 0 || (sVar3 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv), sVar3 == raMacintosh)))) {
            for (i = 0; i < 4; i = i + 1) {
                rgCosts[i] = rgCosts[i] - rgCosts[i] / 5;
            }
        }
        if (bVar12) {
            for (i = 0; i < 4; i = i + 1) {
                *(uint *)(rgCost + i) = (rgCosts[i] + 1) / 2;
                *(uint *)((int)(rgCost + i) + 2) = 0;
            }
        } else {
            for (i = 0; i < 4; i = i + 1) {
                *(ushort *)(rgCost + i) = rgCosts[i];
                *(ushort *)((int)(rgCost + i) + 2) = 0;
            }
        }
        goto LAB_10d0_4eef;
    }
    if ((uVar14 & 0x7f) == 0) {
    LAB_10d0_4915:
        for (i = 0; i < 3; i = i + 1) {
            *(undefined2 *)(rgCost + i) = 0;
            *(undefined2 *)((int)(rgCost + i) + 2) = 0;
        }
        sVar3 = GetRaceStat((PLAYER *)rgplr + iplr, rsMineBuild);
        *(short *)(rgCost + 3) = sVar3;
        *(int *)((int)rgCost + 0xe) = sVar3 >> 0xf;
        goto LAB_10d0_4eef;
    }
    if ((uint)iItem == 1) {
    LAB_10d0_4867:
        sVar3 = GetRaceGrbit((PLAYER *)rgplr + iplr, ibitRaceCheapFact);
        if (((uint)gd.grBits >> 0xb & 1) == 0) {
            *(undefined2 *)(rgCost + 1) = 0;
            *(undefined2 *)((int)rgCost + 6) = 0;
            *(undefined2 *)rgCost = 0;
            *(undefined2 *)((int)rgCost + 2) = 0;
            *(int *)(rgCost + 2) = 4 - sVar3;
            *(int *)((int)rgCost + 10) = 4 - sVar3 >> 0xf;
        } else {
            for (i = 0; i < 3; i = i + 1) {
                *(int *)(rgCost + i) = 2 - sVar3;
                *(int *)((int)(rgCost + i) + 2) = 2 - sVar3 >> 0xf;
            }
        }
        sVar3 = GetRaceStat((PLAYER *)rgplr + iplr, rsFactBuild);
        *(short *)(rgCost + 3) = sVar3;
        *(int *)((int)rgCost + 0xe) = sVar3 >> 0xf;
    } else {
        if ((uint)iItem == 2) {
        LAB_10d0_4964:
            part.hs.grhst = hstPlanetary;
            part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | 9;
            FLookupPart(&part);
            i = 0;
            while (true) {
                if (2 < i)
                    break;
                iVar4 = (part.u_PART_0x0004.parmor._0_2_)->rgwtOreCost[i];
                *(int *)(rgCost + i) = iVar4;
                *(int *)((int)(rgCost + i) + 2) = iVar4 >> 0xf;
                i = i + 1;
            }
            *(ushort *)(rgCost + 3) = (part.u_PART_0x0004.parmor._0_2_)->resCost;
            *(undefined2 *)((int)rgCost + 0xe) = 0;
            sVar3 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv);
            if (sVar3 == raDefend) {
                for (i = 0; i < 4; i = i + 1) {
                    uVar11 = 0;
                    uVar10 = 5;
                    uVar14 = __aFulmul(CONCAT22(*(undefined2 *)((int)(rgCost + i) + 2), (int)rgCost[i]), 3);
                    uVar14 = __aFuldiv(uVar14, CONCAT22(uVar11, uVar10));
                    *(int *)(rgCost + i) = (int)uVar14;
                    *(undefined2 *)((int)(rgCost + i) + 2) = (int)(uVar14 >> 0x10);
                }
            }
            goto LAB_10d0_4eef;
        }
        if ((uint)iItem == 3) {
        LAB_10d0_4a48:
            for (i = 0; i < 3; i = i + 1) {
                *(undefined2 *)(rgCost + i) = 0;
                *(undefined2 *)((int)(rgCost + i) + 2) = 0;
            }
            sVar3 = GetRaceGrbit((PLAYER *)rgplr + iplr, ibitRaceMineralAlchemy);
            if (sVar3 == 0) {
                uVar10 = 100;
            } else {
                uVar10 = 0x19;
            }
            *(undefined2 *)(rgCost + 3) = uVar10;
            *(undefined2 *)((int)rgCost + 0xe) = 0;
            goto LAB_10d0_4eef;
        }
        if (((uint)iItem == 4) || ((uint)iItem == 5)) {
        LAB_10d0_4c24:
            *(undefined2 *)(rgCost + 2) = 0;
            *(undefined2 *)((int)rgCost + 10) = 0;
            *(undefined2 *)(rgCost + 1) = 0;
            *(undefined2 *)((int)rgCost + 6) = 0;
            *(undefined2 *)rgCost = 0;
            *(undefined2 *)((int)rgCost + 2) = 0;
            sVar6 = GetRaceGrbit((PLAYER *)rgplr + iplr, ibitRaceTT);
            if (sVar6 == 0) {
                *(undefined2 *)(rgCost + 3) = 100;
                *(undefined2 *)((int)rgCost + 0xe) = 0;
            } else {
                *(undefined2 *)(rgCost + 3) = 0x46;
                *(undefined2 *)((int)rgCost + 0xe) = 0;
            }
            if (sVar3 == 3) {
                uVar14 = __aFuldiv(CONCAT22(*(undefined2 *)((int)rgCost + 0xe), (int)rgCost[3]), 2);
                *(int *)(rgCost + 3) = (int)uVar14;
                *(undefined2 *)((int)rgCost + 0xe) = (int)(uVar14 >> 0x10);
            }
            goto LAB_10d0_4eef;
        }
        if ((uint)iItem != 6) {
            if ((uint)iItem == 7)
                goto LAB_10d0_4867;
            if ((uint)iItem == 8)
                goto LAB_10d0_4915;
            if ((uint)iItem == 9)
                goto LAB_10d0_4964;
            if ((uint)iItem == 0xb)
                goto LAB_10d0_4a48;
            if ((uint)iItem == 0xc)
                goto LAB_10d0_4c24;
            if ((uint)iItem == 0xd) {
                part.hs.grhst = hstPlanetary;
                part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | 0xe;
                FLookupPart(&part);
                GetTruePartCost(iplr, &part, rgCosts);
                for (i = 0; i < 4; i = i + 1) {
                    *(ushort *)(rgCost + i) = rgCosts[i];
                    *(ushort *)((int)(rgCost + i) + 2) = 0;
                }
                goto LAB_10d0_4eef;
            }
            if ((((uint)iItem == 0xe) || ((uint)iItem == 0xf)) || ((uint)iItem == 0x10)) {
                if (sVar3 == 6) {
                    uVar10 = 0x46;
                } else if (sVar3 == 7) {
                    uVar10 = 0x78;
                } else {
                    uVar10 = 0x6e;
                }
                for (i = 0; i < 3; i = i + 1) {
                    if (((uint)iItem - 0xe != i) || (uVar11 = uVar10, (uint)iItem < 0xe)) {
                        uVar11 = 0;
                    }
                    *(undefined2 *)(rgCost + i) = uVar11;
                    *(undefined2 *)((int)(rgCost + i) + 2) = 0;
                }
                if (sVar3 == 6) {
                    uVar10 = 5;
                } else {
                    uVar10 = 10;
                }
                *(undefined2 *)(rgCost + i) = uVar10;
                *(undefined2 *)((int)(rgCost + i) + 2) = 0;
                goto LAB_10d0_4eef;
            }
            if ((uint)iItem != 0x11) {
                if (((((uint)iItem != 0x12) && ((uint)iItem != 0x13)) &&
                     (((uint)iItem != 0x14 &&
                       (((((uint)iItem != 0x15 && ((uint)iItem != 0x16)) && ((uint)iItem != 0x17)) && (((uint)iItem != 0x18 && ((uint)iItem != 0x19)))))))) &&
                    ((uint)iItem != 0x1a)) {
                    if ((uint)iItem != 0x1b)
                        goto LAB_10d0_4eef;
                    iItem._0_2_ = 0x12;
                }
                part.hs.grhst = hstPlanetary;
                part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | (uint)iItem - 0x12 & 0xff;
                FLookupPart(&part);
                GetTruePartCost(iplr, &part, rgCosts);
                for (i = 0; i < 4; i = i + 1) {
                    *(ushort *)(rgCost + i) = rgCosts[i];
                    *(ushort *)((int)(rgCost + i) + 2) = 0;
                }
                goto LAB_10d0_4eef;
            }
        }
        if (sVar3 == 6) {
            uVar10 = 0x19;
        } else if (sVar3 == 7) {
            uVar10 = 0x30;
        } else {
            uVar10 = 0x2c;
        }
        for (i = 0; i < 3; i = i + 1) {
            *(undefined2 *)(rgCost + i) = uVar10;
            *(undefined2 *)((int)(rgCost + i) + 2) = 0;
        }
        if (sVar3 == 6) {
            uVar10 = 5;
        } else {
            uVar10 = 10;
        }
        *(undefined2 *)(rgCost + i) = uVar10;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
    }
LAB_10d0_4eef:
    if (fOnlyOne == 0) {
        for (i = 0; i < 4; i = i + 1) {
            uVar14 = __aFulmul(CONCAT22(*(undefined2 *)((int)(rgCost + i) + 2), (int)rgCost[i]), (ulong)((uint)uVar2 & 0x3ff));
            *(int *)(rgCost + i) = (int)uVar14;
            *(undefined2 *)((int)(rgCost + i) + 2) = (int)(uVar14 >> 0x10);
        }
    }
    return;
}

// ======================================================================
// Function: EstimateItemProdSched
// Address: 10d0:4f40
// Segment: MEMORY_PRODUCE
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10d05159) */
/* WARNING: Removing unreachable block (ram,0x10d050ac) */
/* WARNING: Removing unreachable block (ram,0x10d052cc) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10d05184) */
/* WARNING: Removing unreachable block (ram,0x10d051ac) */

void EstimateItemProdSched(PLANET *lppl, PLPROD *lpplprod, short iItem, short *piFirst, short *piLast)

{
    PLANET    *pPVar1;
    PLANET    *pPVar2;
    byte       bVar3;
    PROD      *pprodPartial;
    short      sVar4;
    uint       uVar5;
    int        iVar6;
    PLPROD    *pPVar7;
    PROD      *pPVar8;
    PLANET    *pPVar9;
    PLANET    *pPVar10;
    undefined2 uVar11;
    undefined2 unaff_SS;
    bool       bVar12;
    ulong      uVar13;
    long       lVar14;
    long       lVar15;
    undefined2 uVar16;
    PROD      *lpprod;
    long       rgRes[4];
    short      iMac;
    short      fAlchemy;
    short      iPass;
    short      j;
    short      i;
    short      mdStatus;
    PROD       prodPartial;
    short      cBuilt;
    long       rglQuan[3];
    PLANET     pl;
    long       cResearch;

    if (((PLPROD *)lpplprod == 0) && (lpplprod._2_2_ == 0)) {
        /* WARNING: Load size is inaccurate */
        lpplprod = (PLPROD *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2), ((PLANET *)lppl)->lpplprod);
    }
    pPVar10 = &pl;
    pPVar9 = (PLANET *)lppl;
    for (iVar6 = 0x1c; iVar6 != 0; iVar6 = iVar6 + -1) {
        pPVar2 = pPVar10;
        pPVar10 = &pPVar10->iPlayer;
        pPVar1 = pPVar9;
        pPVar9 = &pPVar9->iPlayer;
        pPVar2->id = pPVar1->id;
    }
    uVar11 = (undefined2)((ulong)lpplprod >> 0x10);
    pPVar7 = (PLPROD *)lpplprod;
    pl.lpplprod = LpplAlloc(4, (uint)pPVar7->iprodMax, htOrd);
    __fmemcpy((PL *)CONCAT22((int)((ulong)pl.lpplprod >> 0x10), (PL *)pl.lpplprod + 1), (PLPROD *)CONCAT22(uVar11, pPVar7 + 1), (uint)pPVar7->iprodMac << 2);
    bVar3 = pPVar7->iprodMac;
    ((PLPROD *)pl.lpplprod)->iprodMac = bVar3;
    prodPartial.dwFlags._0_2_ = (uint)prodPartial.dwFlags & 0xfc00;
    *piLast = 0;
    *piFirst = 0;
    iPass = 1;
    do {
        if (99 < iPass) {
            if (*piFirst == 0) {
                *piFirst = 100;
            }
            *piLast = 100;
        PRODUCE_LCleanUp:
            if (((PLPROD *)pl.lpplprod != 0) || (pl.lpplprod._2_2_ != 0)) {
                FreePl(pl.lpplprod);
            }
            return;
        }
        EstMineralsMined(&pl, rglQuan, -1, 1);
        for (j = 0; j < 3; j = j + 1) {
            uVar11 = *(undefined2 *)((int)pl.rgwtMin + j * 4 + 2);
            *(int *)(rgRes + j) = (int)pl.rgwtMin[j];
            *(undefined2 *)((int)rgRes + j * 4 + 2) = uVar11;
        }
        rgRes[3]._0_2_ = CResourcesAtPlanet(&pl, ((PLANET *)lppl)->iPlayer);
        rgRes[3]._2_2_ = (int)(uint)rgRes[3] >> 0xf;
        uVar13 = __aFulshr(CONCAT22(pl.rgbImp._6_2_, pl.rgbImp._4_2_), 0x17);
        if ((uVar13 & 1) == 0) {
            uVar16 = 0;
            uVar11 = 100;
            uVar13 = __aFulmul(CONCAT22(rgRes[3]._2_2_, (uint)rgRes[3]), (long)(int)*(char *)((int)&rgplr[0].pctResearch + ((PLANET *)lppl)->iPlayer * 0xc0));
            lVar14 = __aFldiv(uVar13, CONCAT22(uVar16, uVar11));
            bVar12 = (uint)rgRes[3] < (uint)lVar14;
            rgRes[3]._0_2_ = (uint)rgRes[3] - (uint)lVar14;
            rgRes[3]._2_2_ = (rgRes[3]._2_2_ - (int)((ulong)lVar14 >> 0x10)) - (uint)bVar12;
        } else {
            lVar14 = 0;
        }
        fAlchemy = 0;
        for (i = -1; i < (int)(uint)bVar3; i = i + 1) {
            if (i == -1) {
                lpprod = &prodPartial;
            } else {
                lpprod = (PROD *)CONCAT22(pl.lpplprod._2_2_, (PLPROD *)pl.lpplprod + i + 1);
            }
            if ((lpprod->dwFlags & 0x3ff) != 0) {
                uVar11 = (undefined2)((ulong)lpprod >> 0x10);
                pPVar8 = (PROD *)lpprod;
                uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar8->dwFlags + 2), (int)lpprod->dwFlags), 10);
                if ((((uint)uVar13 & 0x7f) == 3) &&
                    (uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar8->dwFlags + 2), (int)lpprod->dwFlags), 0x11), ((uint)uVar13 & 7) == 1)) {
                    if (i < (int)(bVar3 - 1)) {
                        if (i != iItem) {
                            fAlchemy = 1;
                            goto LAB_10d0_53bf;
                        }
                        *piLast = -1;
                        *piFirst = -1;
                        goto PRODUCE_LCleanUp;
                    }
                    uVar16 = *(undefined2 *)((int)&pPVar8->dwFlags + 2);
                    *&lpprod->dwFlags = (uint)lpprod->dwFlags & 0xfc00 | 0x3fc;
                    *(undefined2 *)((int)&pPVar8->dwFlags + 2) = uVar16;
                }
                if (i == -1) {
                    pprodPartial = 0;
                } else {
                    pprodPartial = &prodPartial;
                }
                sVar4 = CBuildProdItem(&pl, lpprod, pprodPartial, rgRes, fAlchemy, &mdStatus, 0);
                if (iItem == i) {
                    if ((0 < sVar4) && (*piFirst == 0)) {
                        *piFirst = iPass;
                    }
                    if (mdStatus == 2) {
                        if (*piFirst != 0) {
                            *piLast = iPass + -1;
                        }
                        goto PRODUCE_LCleanUp;
                    }
                    if ((mdStatus == 0) || (mdStatus == 1)) {
                        *piLast = iPass;
                        goto PRODUCE_LCleanUp;
                    }
                }
                fAlchemy = 0;
                uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar8->dwFlags + 2), (int)lpprod->dwFlags), 0x11);
                if (((uint)uVar13 & 7) == 1) {
                    uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar8->dwFlags + 2), (int)lpprod->dwFlags), 10);
                    uVar5 = (uint)uVar13 & 0x7f;
                    if ((uVar13 & 0x7f) == 0) {
                    LAB_10d0_52ea:
                        lVar15 = __aFlshl((long)sVar4, 8);
                        uVar13 = lVar15 + CONCAT22(pl.rgbImp._2_2_, pl.rgbImp._0_2_) & 0xfff00;
                        uVar5 = pl.rgbImp._0_2_ & 0xff | (uint)uVar13;
                        pl.rgbImp[0] = (char)uVar5;
                        pl.rgbImp[1] = (char)(uVar5 >> 8);
                        uVar5 = pl.rgbImp._2_2_ & 0xfff0 | (uint)(uVar13 >> 0x10);
                        pl.rgbImp[2] = (char)uVar5;
                        pl.rgbImp[3] = (char)(uVar5 >> 8);
                    } else if ((uVar5 == 1) || (uVar5 == 7)) {
                        lVar15 = __aFlshl((long)sVar4, 0x14);
                        uVar5 = pl.rgbImp._2_2_ & 0xf | (int)((ulong)lVar15 >> 0x10) + pl.rgbImp._2_2_ + (uint)CARRY2((uint)lVar15, pl.rgbImp._0_2_) & 0xfff0;
                        pl.rgbImp[2] = (char)uVar5;
                        pl.rgbImp[3] = (char)(uVar5 >> 8);
                    } else if (uVar5 == 8)
                        goto LAB_10d0_52ea;
                }
                if (4 < mdStatus)
                    break;
            }
        LAB_10d0_53bf:
        }
        cResearch._0_2_ = (int)lVar14;
        if (iItem < 0) {
            *piFirst = (uint)rgRes[3];
            if (iItem == -1) {
                *piFirst = *piFirst + (int)cResearch;
            }
            goto PRODUCE_LCleanUp;
        }
        for (j = 0; j < 3; j = j + 1) {
            uVar11 = *(undefined2 *)((int)rgRes + j * 4 + 2);
            *(int *)(pl.rgwtMin + j) = (int)rgRes[j];
            *(undefined2 *)((int)pl.rgwtMin + j * 4 + 2) = uVar11;
        }
        ChgPopFromPlanet(&pl, 1);
        iPass = iPass + 1;
    } while (true);
}

// ======================================================================
// Function: ZipProdDlg
// Address: 10d0:5490
// Segment: MEMORY_PRODUCE
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10d05b5e) */
/* WARNING: Removing unreachable block (ram,0x10d05b29) */
/* WARNING: Removing unreachable block (ram,0x10d05b63) */

short ZipProdDlg(HWND hwnd, WMType message, ushort wParam, long lParam)

{
    char       *pcVar1;
    char        cVar2;
    ushort      uVar3;
    FARPROC     pvVar4;
    char       *pcVar5;
    HDC         hdc_00;
    HWND        HVar6;
    short       sVar7;
    PLPROD     *pPVar8;
    undefined1 *puVar9;
    undefined1 *puVar10;
    undefined2  uVar11;
    undefined2  uVar12;
    undefined2  unaff_SS;
    ulong       uVar13;
    char       *pszT;
    char       *psz;
    HWND        hwndRad;
    undefined1  local_3c[4];
    char       *local_38;
    undefined4  local_36;
    RECT        rc;
    short       iBase;
    short       i;
    PAINTSTRUCT ps;
    HDC         hdc;

    if (message == WM_PAINT) {
        hdc_00 = BeginPaint(hwnd, &ps);
        GetClientRect(hwnd, &rc);
        HVar6 = GetDlgItem(hwnd, IDC_FINISH | IDOK);
        GetWindowRect(HVar6, local_3c + 2);
        ScreenToClient(hwnd, local_3c + 2);
        HVar6 = GetDlgItem(hwnd, IDC_U16_0x0434);
        GetWindowRect(HVar6, &rc);
        ScreenToClient(hwnd, (POINT *)&rc.right);
        local_36._0_2_ = (void *)rc.right;
        local_36._2_2_ = rc.bottom;
        ExpandRc(local_3c + 2, dyArial8, dyArial8 >> 1);
        Draw3dFrame(hdc_00, local_3c + 2, -1);
        SelectObject(hdc_00, rghfontArial8[1]);
        SetBkColor(hdc_00, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
        local_3c._0_2_ = CchGetString(idsCustomOrders, (char *)szWork);
        TextOut(hdc_00, (short)(local_3c._2_2_ + 8), (int)local_38 - (dyArial8 >> 1), szWork, local_3c._0_2_);
        local_38 = (char *)(local_36._2_2_ + 8);
        if (*(char *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) != '\0') {
            local_3c._0_2_ =
                CchGetString(*(byte *)((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 + iResTechNow * 0x28) + idsContributeResearch, (char *)szWork);
            TextOut(hdc_00, local_3c._2_2_, vyZPDStatic, szWork, local_3c._0_2_);
        }
        EndPaint(hwnd, &ps);
        return 1;
    }
    if (message == WM_ERASEBKGND) {
        GetClientRect(hwnd, &rc);
        FillRect(wParam, &rc, hbrButtonFace);
        return 1;
    }
    if (message == WM_CTLCOLOR) {
        for (i = 0x431; i < 0x435; i = i + 1) {
            local_36._2_2_ = (HWND)lParam;
            HVar6 = GetDlgItem(hwnd, i);
            if (local_36._2_2_ == HVar6)
                break;
        }
        if (0x434 < i) {
            return 0;
        }
        SetBkColor(wParam, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
        return hbrButtonFace;
    }
    if (message == WM_INITDIALOG) {
        HVar6 = hwnd;
        pcVar5 = PszGetCompressedString(idsCustomizeProductionTemplates);
        SetWindowText(HVar6, pcVar5);
        GetWindowRect(hwnd, &rc);
        GetClientRect(hwnd, local_3c);
        local_36._2_2_ = (rc.bottom - rc.top) - (int)(void *)local_36;
        HVar6 = GetDlgItem(hwnd, IDC_U16_0x0417);
        GetWindowRect(HVar6, local_3c);
        MapWindowPoints(0, hwnd, local_3c, 2);
        vyZPDStatic = (int)(void *)local_36 + 2;
        local_36._2_2_ = local_36._2_2_ + (int)(void *)local_36 + dyArial8 + 6;
        SetWindowPos(hwnd, 0, 0, 0, rc.right - rc.left, local_36._2_2_, 6);
        CheckRadioButton(hwnd, 0x431, 0x434, 0x431);
        EnableZipProdBtns(hwnd, 0);
        iResTechNow = 0;
        uVar12 = 0x10d0;
        FillZipProdLB(hwnd, (ZIPPRODQ *)vrgZipProd);
        puVar9 = &stack0xffb4;
        for (i = 0x431; i < 0x435; i = i + 1) {
            if (*(char *)((int)&vrgZipProd[0].fValid + (i + -0x431) * 0x28) == '\0') {
                *(undefined2 *)(puVar9 + -2) = 0x4be;
                *(undefined2 *)(puVar9 + -4) = uVar12;
                *(char **)(puVar9 + -6) = (char *)szBackup + 0x9a;
                pcVar5 = PszGetCompressedString(*(StringId *)(puVar9 + -2));
                *(short *)(puVar9 + -2) = i + -0x430;
                *(undefined2 *)(puVar9 + -4) = 0x1120;
                *(char **)(puVar9 + -6) = pcVar5;
                *(undefined2 *)(puVar9 + -8) = 0x1120;
                *(char **)(puVar9 + -10) = (char *)szWork;
                *(undefined2 *)(puVar9 + -0xc) = 0x1010;
                uVar12 = 0x14f8;
                *(char **)(puVar9 + -0xe) = (char *)szBackup + 0xba;
                _wsprintf(*(char **)(puVar9 + -10), *(char **)(puVar9 + -6));
            } else {
                pszT = (char *)szWork;
                pcVar5 = pszT;
                psz = ((ZIPPRODQ *)vrgZipProd)[i + -0x431].szName;
                while (pszT = pcVar5, *psz != '\0') {
                    pcVar1 = psz + 1;
                    cVar2 = *psz;
                    *pszT = cVar2;
                    pcVar5 = pszT + 1;
                    psz = pcVar1;
                    if (cVar2 == '&') {
                        pszT[1] = '&';
                        pcVar5 = pszT + 2;
                    }
                }
                *pszT = '\0';
            }
            *(HWND *)(puVar9 + -2) = hwnd;
            *(short *)(puVar9 + -4) = i;
            *(undefined2 *)(puVar9 + -6) = uVar12;
            *(char **)(puVar9 + -8) = (char *)szBackup + 0xcd;
            HVar6 = GetDlgItem(*(HWND *)(puVar9 + -2), *(ControlId *)(puVar9 + -4));
            *(HWND *)(puVar9 + -2) = HVar6;
            *(undefined2 *)(puVar9 + -4) = 0x1120;
            *(char **)(puVar9 + -6) = (char *)szWork;
            *(undefined2 *)(puVar9 + -8) = 0x14f8;
            uVar12 = 0x14f8;
            *(char **)(puVar9 + -10) = (char *)szBackup + 0xdf;
            SetWindowText(*(HWND *)(puVar9 + -2), *(LPCSTR *)(puVar9 + -6));
            puVar9 = puVar9 + -6;
        }
        *(undefined2 *)(puVar9 + -2) = 1;
        *(undefined2 *)(puVar9 + -4) = 0xd00;
        *(HWND *)(puVar9 + -6) = hwnd;
        *(undefined2 *)(puVar9 + -8) = uVar12;
        *(char **)(puVar9 + -10) = (char *)szBackup + 0xfd;
        StickyDlgPos(*(HWND *)(puVar9 + -6), *(POINT **)(puVar9 + -4), *(short *)(puVar9 + -2));
        if (((uint)gd.grBits >> 0xb & 1) != 0) {
            *(undefined2 *)(puVar9 + -2) = 0x1040;
            *(ushort(**)[2])(puVar9 + -4) = (ushort(*)[2])rghbrMinSum;
            AdvanceTutor();
        }
        return 1;
    }
    if (message != WM_COMMAND) {
        return 0;
    }
    uVar13 = __aFulshr(lParam, 0x10);
    if ((((int)uVar13 == 0) && (0x430 < wParam)) && (wParam < 0x435)) {
        iResTechNow = wParam - 0x431;
        EnableZipProdBtns(hwnd, iResTechNow);
        FillZipProdLB(hwnd, (ZIPPRODQ *)vrgZipProd + iResTechNow);
        return 0;
    }
    if ((wParam == 1) || (wParam == 2)) {
        StickyDlgPos(hwnd, (POINT *)&ptStickyZipProdDlg, 0);
        EndDialog(hwnd, (uint)(wParam == 1));
        vyZPDStatic = -1;
        if (((uint)gd.grBits >> 0xb & 1) != 0) {
            AdvanceTutor();
        }
        return 1;
    }
    if ((wParam != 0x816) && (wParam != 0x41b)) {
        if (wParam == 0x817) {
            *(undefined1 *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) = 0;
            pcVar5 = PszGetCompressedString(idsUnusedD);
            _wsprintf(szWork, pcVar5);
            HVar6 = GetDlgItem(hwnd, iResTechNow + (IDC_FINISH | IDOK));
            SetWindowText(HVar6, szWork);
            FillZipProdLB(hwnd, (ZIPPRODQ *)vrgZipProd + iResTechNow);
            gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xffdf | 0x20;
            return 0;
        }
        if (wParam != 0x76) {
            return 0;
        }
        WinHelp(hwnd, szHelpFile, 1, 0x452);
        return 1;
    }
    if (*(char *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) == '\0') {
        pcVar5 = PszGetCompressedString(idsCustomD);
        _wsprintf(szWork, pcVar5);
    } else {
        _strcpy((char *)szWork, ((ZIPPRODQ *)vrgZipProd)[iResTechNow].szName);
    }
    local_36 = MakeProcInstance(RenameZipDlg, hInst);
    puVar10 = &stack0xffba;
    if (iResTechNow != 0) {
        uVar12 = 0x14f8;
        sVar7 = DialogBox(0, IDD_RENAME, hwndFrame, local_36);
        puVar10 = &stack0xffba;
        pvVar4 = local_36;
        if (sVar7 == 0)
            goto LAB_10d0_5ce2;
        if (szWork[0] == '\0') {
            pcVar5 = PszGetCompressedString(idsCustomD);
            _wsprintf(szWork, pcVar5);
        }
        _strcpy(((ZIPPRODQ *)vrgZipProd)[iResTechNow].szName, (char *)szWork);
        local_3c._2_2_ = (char *)szWork + 0x40;
        local_38 = (char *)szWork;
        pcVar5 = (char *)local_3c._2_2_;
        while (local_3c._2_2_ = pcVar5, *local_38 != '\0') {
            pcVar1 = local_38 + 1;
            cVar2 = *local_38;
            *(char *)local_3c._2_2_ = cVar2;
            pcVar5 = (char *)(local_3c._2_2_ + 1);
            local_38 = pcVar1;
            if (cVar2 == '&') {
                *(char *)(local_3c._2_2_ + 1) = '&';
                pcVar5 = (char *)(local_3c._2_2_ + 2);
            }
        }
        *(char *)local_3c._2_2_ = '\0';
        HVar6 = GetDlgItem(hwnd, iResTechNow + (IDC_FINISH | IDOK));
        SetWindowText(HVar6, szWork + 0x40);
        puVar10 = &stack0xffb4;
    }
    uVar12 = 0x14f8;
    if (wParam == 0x816) {
        *(undefined1 *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) = 1;
        local_3c._0_2_ = 0;
        i = 0;
        while (true) {
            uVar11 = (undefined2)((ulong)lpplProdGlob >> 0x10);
            if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= i)
                break;
            pPVar8 = (PLPROD *)lpplProdGlob + i + 1;
            uVar3 = pPVar8->wFlags;
            uVar11 = *(undefined2 *)&pPVar8->iprodMax;
            *(undefined2 *)(puVar10 + -2) = uVar12;
            *(undefined2 *)(puVar10 + -4) = 0x5b16;
            uVar13 = __aFulshr(CONCAT22(uVar11, uVar3), 0x11);
            if (((uint)uVar13 & 7) == 1) {
                uVar3 = ((PLPROD *)lpplProdGlob + i + 1)->wFlags;
                uVar12 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[i + 1].iprodMax;
                *(undefined2 *)(puVar10 + -2) = 0x1118;
                *(undefined2 *)(puVar10 + -4) = 0x5b53;
                uVar13 = __aFulshr(CONCAT22(uVar12, uVar3), 10);
                if (((uint)uVar13 & 0x7f) < 7) {
                    uVar3 = ((PLPROD *)lpplProdGlob + i + 1)->wFlags;
                    uVar11 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[i + 1].iprodMax;
                    *(undefined2 *)(puVar10 + -2) = 0x1118;
                    uVar12 = 0x1118;
                    *(undefined2 *)(puVar10 + -4) = 0x5b98;
                    uVar13 = __aFulshr(CONCAT22(uVar11, uVar3), 10);
                    *(uint *)(iResTechNow * hbrBlue + 0x2306 + local_3c._0_2_ * 2) =
                        *(uint *)(iResTechNow * hbrBlue + 0x2306 + local_3c._0_2_ * 2) & 0xffc0 | (uint)uVar13 & 0x3f;
                    *(uint *)(iResTechNow * hbrBlue + 0x2306 + local_3c._0_2_ * 2) =
                        *(uint *)(iResTechNow * hbrBlue + 0x2306 + local_3c._0_2_ * 2) & 0x3f | ((PLPROD *)lpplProdGlob + i + 1)->wFlags << 6;
                    local_3c._0_2_ = local_3c._0_2_ + 1;
                    if (0xb < (int)local_3c._0_2_)
                        break;
                }
            }
            uVar12 = 0x1118;
            i = i + 1;
        }
        *(undefined1 *)((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 + iResTechNow * 0x28 + 1) = (char)local_3c._0_2_;
        *(undefined2 *)(puVar10 + -2) = uVar12;
        *(undefined2 *)(puVar10 + -4) = 0x5ca0;
        uVar13 = __aFulshr(CONCAT22(sel.pl.rgbImp._6_2_, sel.pl.rgbImp._4_2_), 0x17);
        *(byte *)((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 + iResTechNow * 0x28) = (byte)uVar13 & 1;
        *(ZIPPRODQ **)(puVar10 + -2) = (ZIPPRODQ *)vrgZipProd + iResTechNow;
        *(HWND *)(puVar10 + -4) = hwnd;
        *(undefined2 *)(puVar10 + -6) = 0x1118;
        uVar12 = 0x10d0;
        *(undefined2 *)(puVar10 + -8) = 0x5cd0;
        FillZipProdLB(*(HWND *)(puVar10 + -4), *(ZIPPRODQ **)(puVar10 + -2));
    }
    *(short *)(puVar10 + -2) = iResTechNow;
    *(HWND *)(puVar10 + -4) = hwnd;
    *(undefined2 *)(puVar10 + -6) = uVar12;
    uVar12 = 0x10d0;
    *(undefined2 *)(puVar10 + -8) = 0x5cdf;
    EnableZipProdBtns(*(HWND *)(puVar10 + -4), *(short *)(puVar10 + -2));
    pvVar4 = local_36;
LAB_10d0_5ce2:
    local_36._2_2_ = (HWND)((ulong)pvVar4 >> 0x10);
    *(HWND *)(puVar10 + -2) = local_36._2_2_;
    local_36 = pvVar4;
    *(void **)(puVar10 + -4) = (void *)local_36;
    *(undefined2 *)(puVar10 + -6) = uVar12;
    *(undefined2 *)(puVar10 + -8) = 0x5ced;
    FreeProcInstance(*(FARPROC *)(puVar10 + -4));
    *(HWND *)(puVar10 + -2) = hwnd;
    *(undefined2 *)(puVar10 + -4) = 0x14f8;
    *(undefined2 *)(puVar10 + -6) = 0x5cf5;
    SetFocus(*(HWND *)(puVar10 + -2));
    gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xffdf | 0x20;
    return 0;
}

// ======================================================================
// Function: EnableZipProdBtns
// Address: 10d0:5df0
// Segment: MEMORY_PRODUCE
// ======================================================================

void EnableZipProdBtns(HWND hwnd, short iSel)

{
    BOOL  BVar1;
    HWND  HVar2;
    short fEnabled;

    if ((*(char *)((int)&vrgZipProd[0].fValid + iSel * 0x28) == '\0') || (iSel < 1)) {
        BVar1 = 0;
    } else {
        BVar1 = 1;
    }
    HVar2 = GetDlgItem(hwnd, IDC_DELETE);
    EnableWindow(HVar2, BVar1);
    HVar2 = GetDlgItem(hwnd, IDC_RENAME);
    EnableWindow(HVar2, BVar1);
    return;
}

// ======================================================================
// Function: FillZipProdLB
// Address: 10d0:5e58
// Segment: MEMORY_PRODUCE
// ======================================================================

/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

void FillZipProdLB(HWND hwndDlg, ZIPPRODQ *pzpq)

{
    HWND            HVar1;
    char           *pcVar2;
    undefined2      unaff_SS;
    WParamMessageId WVar3;
    WMType          WVar4;
    RECT            rc;
    char            szFormat[15];
    char            szAuto[40];
    HWND            hwndLB;
    short           i;

    HVar1 = GetDlgItem(hwndDlg, IDC_U16_0x0417);
    GetClientRect(hwndDlg, &rc);
    rc.top = vyZPDStatic;
    rc.bottom = vyZPDStatic + dyArial8;
    InvalidateRect(hwndDlg, &rc, 1);
    SendMessage(HVar1, CB_DIR, 0, 0);
    if ((pzpq->fValid == 0) || (*(char *)((int)&pzpq->u_ZIPPRODQ_0x000e + 1) == '\0')) {
        WVar4 = CB_LIMITTEXT;
        WVar3 = 0;
        pcVar2 = PszGetCompressedString(idsAutoBuildOrders);
        SendMessage(HVar1, WVar4, WVar3, (LPARAM)pcVar2);
    } else {
        CchGetString(idsSD2, szFormat);
        for (i = 0; i < (int)(uint) * (byte *)((int)&pzpq->u_ZIPPRODQ_0x000e + 1); i = i + 1) {
            CchGetString((*(uint *)(pzpq->szName + i * 2 + 0x10) & 0x3f) + idsMines, szAuto);
            if ((*(uint *)(pzpq->szName + i * 2 + 0x10) >> 6 == 1) || ((*(uint *)(pzpq->szName + i * 2 + 0x10) & 0x3f) == 3)) {
                _strcpy((char *)szWork, szAuto);
            } else {
                _wsprintf(szWork, szFormat, szAuto);
            }
            SendMessage(HVar1, CB_LIMITTEXT, 0, szWork);
        }
    }
    return;
}
