// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: ChangeProduction
// Address: 10d0:0000
// Segment: MEMORY_PRODUCE
// ======================================================================


short ChangeProduction(short fClear)

{
  undefined2 uVar1;
  short sVar2;
  char *sz;
  FARPROC pvVar3;
  short fSuccess;
  PROD rgprod [64];
  void *lpProcProd;
  short (*penvMemSav) [9];
  short env [9];
  
                    /* Segment:    27
                       Offset:     000bc100
                       Length:     5ff4
                       Min Alloc:  5ff4
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  uVar1 = penvMem;
  penvMem = env;
  sVar2 = __setjmp(env);
  if (sVar2 == 0) {
    if (fClear == 0) {
      InitProduction(rgprod);
      fDlgUp = 1;
      pvVar3 = MakeProcInstance(ProductionDlg,hInst);
      fSuccess = DialogBox(0,(LPCSTR)CONCAT22(0x5d,hwndFrame),
                           (HWND)((ulong)pvVar3 >> 0x10),(void *)pvVar3);
      FreeProcInstance(pvVar3);
      hwndProdDlg = 0;
      fDlgUp = 0;
    }
    else {
      fSuccess = 1;
    }
    FinishProduction(fSuccess);
    if ((fSuccess != 0) && (sel.grobj == grobjPlanet)) {
      DrawPlanShip(0,8);
    }
    sVar2 = 1;
  }
  else {
    if (((PLPROD *)lpplProdGlob != (PLPROD *)0x0) || (lpplProdGlob._2_2_ != 0)) {
      FreePl((PL *)CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob));
    }
    lpplProdGlob._0_2_ = (PLPROD *)0x0;
    lpplProdGlob._2_2_ = 0;
    if (hwndProdDlg != 0) {
      EndDialog(hwndProdDlg,0);
    }
    hwndProdDlg = 0;
    fDlgUp = 0;
    sVar2 = 0x10;
    sz = PszFormatIds(idsThereIsntEnoughFreeMemoryModifyProduction,(short *)0x0);
    AlertSz(sz,sVar2);
    sVar2 = 0;
  }
  penvMem = (short *)uVar1;
  return sVar2;
}



// ======================================================================
// Function: InitProduction
// Address: 10d0:015e
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d00ef7) */
/* WARNING: Removing unreachable block (ram,0x10d00a78) */
/* WARNING: Removing unreachable block (ram,0x10d00efc) */
/* WARNING: Removing unreachable block (ram,0x10d00fb0) */
/* WARNING: Removing unreachable block (ram,0x10d00de1) */
/* WARNING: Removing unreachable block (ram,0x10d00fb5) */
/* WARNING: Removing unreachable block (ram,0x10d00e3f) */

void InitProduction(PROD *rgprod)

{
  byte *pbVar1;
  PROD *pPVar2;
  undefined2 *puVar3;
  short sVar4;
  uint uVar5;
  PROD *pPVar6;
  undefined2 unaff_SI;
  PROD *pPVar7;
  undefined2 unaff_DI;
  undefined2 uVar8;
  undefined2 uVar9;
  ulong uVar10;
  HULDEF *pHVar11;
  long lVar12;
  long lVar13;
  ulong uVar14;
  uint in_stack_0000ffde;
  PROD *lpprod;
  PART part;
  short ipl;
  short i;
  ushort u;
  short iSrc;
  short iWarp;
  
  uVar14 = CONCAT22(unaff_SI,unaff_DI);
  uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
  gd._0_2_ = gd._0_2_ & 0xffdf | ((uint)uVar10 & 1) << 5;
  if (rgprod == (PROD *)0x0) {
    rgprod = pProdGlob;
  }
  if (((PLPROD *)sel.pl.lpplprod == (PLPROD *)0x0) &&
     (sel.pl.lpplprod._2_2_ == 0)) {
    i = 2;
  }
  else {
    i = (short)((PLPROD *)sel.pl.lpplprod)->iprodMac;
  }
  lpplProdGlob = (PLPROD *)LpplAlloc(4,i,htOrd);
  if (((PLPROD *)sel.pl.lpplprod == (PLPROD *)0x0) &&
     (sel.pl.lpplprod._2_2_ == 0)) {
    i = 0;
  }
  else {
    __fmemcpy((PL *)CONCAT22((int)((ulong)lpplProdGlob >> 0x10),
                                     (PL *)lpplProdGlob + 1),
                      (PLPROD *)
                      CONCAT22(sel.pl.lpplprod._2_2_,
                               (PLPROD *)sel.pl.lpplprod + 1),i << 2);
  }
  ((PLPROD *)lpplProdGlob)->iprodMac = (byte)i;
  cProdGlob = 0;
  pProdGlob = rgprod;
  _memset(rgprod,0,0x100);
  if ((((uint)sel.pl.wFlags >> 9 & 1) != 0) &&
     (pHVar11 = LphuldefFromId
                          (*(HullDef *)
                            (*(int *)(idPlayer * 4 + 0x14c) +
                            (sel.pl._44_2_ & 0xf) * 0x93)),
     (((HULDEF *)pHVar11)->hul).wtCargoMax != 0)) {
    for (i = 0; i < 0x10; i = i + 1) {
      if ((((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0) &&
          (-1 < *(int *)((int)&rgshdef[0].wFlags + i * 0x93))) &&
         (uVar5 = *(uint *)((int)&rgshdef[0].hul + 0x28 + i * 0x93),
         pHVar11 = LphuldefFromId
                             (*(HullDef *)
                               (*(int *)(idPlayer * 4 + 0x14c) +
                               (sel.pl._44_2_ & 0xf) * 0x93)),
         uVar5 <= (uint)(((HULDEF *)pHVar11)->hul).wtCargoMax)) {
        uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
        *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
        lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *(uint *)&pPVar6->dwFlags =
             (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
        uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
        pPVar6 = rgprod + cProdGlob;
        *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 4;
        cProdGlob = cProdGlob + 1;
      }
    }
  }
  for (i = 0; i < 10; i = i + 1) {
    if ((((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) &&
        (-1 < *(int *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b))) &&
       (((sel.pl._44_2_ & 0xf) != i || (((uint)sel.pl.wFlags >> 9 & 1) == 0))))
    {
      uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
      *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
      lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(uint *)&pPVar6->dwFlags =
           (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 4;
      cProdGlob = cProdGlob + 1;
    }
  }
  part.hs.grhst = hstPlanetary;
  part.hs.wFlags = part.hs.wFlags & 0xff00U | 0xe;
  sVar4 = FLookupPart(&part);
  if (sVar4 == 1) {
    uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
    *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x3400;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  sVar4 = IWarpMAFromLppl(&sel.pl,(short *)0x0);
  if (0 < sVar4) {
    for (i = 0; i < 4; i = i + 1) {
      uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
      *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
      lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(uint *)&pPVar6->dwFlags =
           (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
      cProdGlob = cProdGlob + 1;
    }
  }
  uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
  sVar4 = CMaxFactories(&sel.pl,idPlayer);
  if (0 < (int)(sVar4 - ((uint)uVar10 & 0xfff))) {
    lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags =
         (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x1c00;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
  sVar4 = CMaxMines(&sel.pl,idPlayer);
  if (0 < (int)(sVar4 - ((uint)uVar10 & 0xfff))) {
    lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags =
         (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2000;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  uVar5 = (uint)sel.pl.dwFlags & 0xfff;
  sVar4 = CMaxDefenses(&sel.pl,idPlayer);
  if (0 < (int)(sVar4 - uVar5)) {
    lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags =
         (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2400;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
  pPVar6 = rgprod + cProdGlob;
  *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
  *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
  uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
  pPVar6 = rgprod + cProdGlob;
  *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x2c00;
  *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
  uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
  pPVar6 = rgprod + cProdGlob;
  *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
  *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
  cProdGlob = cProdGlob + 1;
  uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
  if ((((uint)uVar10 & 0x1f) == 0x1f) &&
     (sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv), sVar4 != 8)
     ) {
    uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 1;
    *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x6c00;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  sVar4 = IpctCanTerraformLppl(&sel.pl);
  if (0 < sVar4) {
    lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags =
         (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | (uint)lVar12;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | 0x3000;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe;
    uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
    pPVar6 = rgprod + cProdGlob;
    *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
    *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
    cProdGlob = cProdGlob + 1;
  }
  for (i = 0; i < 7; i = i + 1) {
    sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (((sVar4 != 8) || (((i != 0 && (i != 1)) && (i != 2)))) &&
       ((sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
        sVar4 != 3 || ((i != 4 && (i != 5)))))) {
      uVar8 = *(undefined2 *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(uint *)&pPVar6->dwFlags = (uint)(rgprod + cProdGlob)->dwFlags & 0xfc00 | 0x3ff;
      *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar8;
      lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(uint *)&pPVar6->dwFlags =
           (uint)(rgprod + cProdGlob)->dwFlags & 0x3ff | (uint)lVar12;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfffe | (uint)((ulong)lVar12 >> 0x10);
      uVar5 = *(uint *)((int)&rgprod[cProdGlob].dwFlags + 2);
      pPVar6 = rgprod + cProdGlob;
      *(int *)&pPVar6->dwFlags = (int)(rgprod + cProdGlob)->dwFlags;
      *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 & 0xfff1 | 2;
      cProdGlob = cProdGlob + 1;
    }
  }
  ipl = 0;
  lpprod = (PROD *)CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob + 1);
  do {
    if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= ipl) {
      if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
        AdvanceTutor();
      }
      return;
    }
    iSrc = 0;
    while( true ) {
      pPVar6 = (PROD *)lpprod;
      uVar8 = (undefined2)((ulong)lpprod >> 0x10);
      if (cProdGlob <= iSrc) break;
      uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
      in_stack_0000ffde = (uint)uVar10 & 7;
      uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
      if (in_stack_0000ffde == ((uint)uVar10 & 7)) {
        uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
        in_stack_0000ffde = (uint)uVar10 & 0x7f;
        uVar10 = __aFulshr(uVar14,in_stack_0000ffde);
        if (in_stack_0000ffde == ((uint)uVar10 & 0x7f)) break;
      }
      iSrc = iSrc + 1;
    }
    if (iSrc < cProdGlob) {
      if (((uint)(pProdGlob + iSrc)->dwFlags & 0x3ff) < ((uint)lpprod->dwFlags & 0x3ff)) {
        lVar12 = __aFlshl(uVar14,in_stack_0000ffde);
        uVar5 = *(uint *)((int)&pPVar6->dwFlags + 2);
        *(uint *)&lpprod->dwFlags = (uint)lpprod->dwFlags & 0xfc00 | (uint)lVar12;
        *(uint *)((int)&pPVar6->dwFlags + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
      }
      if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
        if (((uint)(pProdGlob + iSrc)->dwFlags & 0x3ff) < ((uint)lpprod->dwFlags & 0x3ff))
        {
          uVar9 = *(undefined2 *)((int)&pProdGlob[iSrc].dwFlags + 2);
          pPVar7 = pProdGlob + iSrc;
          *(uint *)&pPVar7->dwFlags = (uint)(pProdGlob + iSrc)->dwFlags & 0xfc00;
          *(undefined2 *)((int)&pPVar7->dwFlags + 2) = uVar9;
        }
        else {
          lVar13 = __aFlshl(uVar14,in_stack_0000ffde);
          lVar12 = (pProdGlob + iSrc)->dwFlags;
          pPVar7 = pProdGlob + iSrc;
          pPVar2 = pPVar7;
          *(uint *)&pPVar2->dwFlags = (uint)pPVar2->dwFlags & 0xfc00;
          puVar3 = (undefined2 *)((int)&pPVar7->dwFlags + 2);
          *puVar3 = *puVar3;
          pPVar7 = pProdGlob + iSrc;
          pPVar2 = pPVar7;
          *(uint *)&pPVar2->dwFlags = (uint)pPVar2->dwFlags | (int)lVar12 - (int)lVar13 & 0x3ffU;
          puVar3 = (undefined2 *)((int)&pPVar7->dwFlags + 2);
          *puVar3 = *puVar3;
        }
      }
    }
    else {
      uVar9 = (undefined2)((ulong)lpplProdGlob >> 0x10);
      if (ipl + 1 < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
        __fmemcpy(lpprod,(PROD *)CONCAT22(uVar8,pPVar6 + 1),
                          ((uint)((PLPROD *)lpplProdGlob)->iprodMac - (ipl + 1)) * 4);
        ipl = ipl + -1;
      }
      pbVar1 = &((PLPROD *)lpplProdGlob)->iprodMac;
      *pbVar1 = *pbVar1 - 1;
    }
    ipl = ipl + 1;
    lpprod = (PROD *)CONCAT22(uVar8,pPVar6 + 1);
  } while( true );
}



// ======================================================================
// Function: FinishProduction
// Address: 10d0:1090
// Segment: MEMORY_PRODUCE
// ======================================================================


void FinishProduction(short fWrite)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar1;
  
  if (fWrite == 0) {
    lVar1 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),(uint)gd._0_2_ >> 5 & 1);
    sel.pl.dwFlags._0_2_ = (uint)sel.pl.dwFlags | (uint)lVar1;
    sel.pl.dwFlags._2_2_ =
         sel.pl.dwFlags._2_2_ & 0xff7f | (uint)((ulong)lVar1 >> 0x10);
    FreePl((PL *)lpplProdGlob);
  }
  else {
    FreePl((PL *)CONCAT22(sel.pl.lpplprod._2_2_,
                                  (PLPROD *)sel.pl.lpplprod));
    if ((((PLPROD *)lpplProdGlob != (PLPROD *)0x0) || (lpplProdGlob._2_2_ != 0)) &&
       (((PLPROD *)lpplProdGlob)->iprodMac == 0)) {
      FreePl((PL *)lpplProdGlob);
      lpplProdGlob = (PLPROD *)0x0;
    }
    sel.pl.lpplprod._0_2_ = (PLPROD *)lpplProdGlob;
    sel.pl.lpplprod._2_2_ = lpplProdGlob._2_2_;
    lpplProdGlob = (PLPROD *)0x0;
    FLookupPlanet(-1,(PLANET *)&sel.pl);
    FLookupPlanet(sel.pl.id,(PLANET *)&sel.pl);
    if (fAi == 0) {
      FillPlanetProdLB(0,(PLPROD *)0x0,(PLANET *)0x0);
      DrawPlanShip(0,0x40);
    }
  }
  lpplProdGlob = (PLPROD *)0x0;
  if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
    tutor.wFlags = tutor.wFlags & 0xfbffU | 0x400;
    AdvanceTutor();
  }
  return;
}



// ======================================================================
// Function: ProductionDlg
// Address: 10d0:1204
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: fRet */

short ProductionDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  int iVar1;
  HWND HVar2;
  char *pcVar3;
  BOOL BVar4;
  HDC hdc_00;
  short sVar5;
  int iVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  bool bVar7;
  ulong uVar8;
  undefined2 *puVar9;
  FARPROC pvVar10;
  short fRet;
  void *lpProc;
  ZIPPRODQ rgzp [4];
  char *rgszZip [1];
  short dyLB;
  short dx;
  short xCtr;
  short i;
  undefined2 uStack_3a;
  short i_2;
  char sz255 [2];
  ushort hcs;
  POINT pt_2;
  RECT rc;
  PAINTSTRUCT ps;
  HDC hdc;
  
  uVar8 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_PAINT) {
    hdc_00 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    DrawProductionDlg(hwnd,hdc_00,&rc,-1);
    EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    sVar5 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar5 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      pt_2.y = (int)lParam;
      HVar2 = GetDlgItem(hwnd,0x8b);
      if ((pt_2.y == HVar2) || (uVar8 = __aFulshr(uVar8,fRet), (int)uVar8 == 6)) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else if (message == WM_SETCURSOR) {
      GetCursorPos((undefined2 *)CONCAT22(unaff_SS,&pt_2));
      ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&pt_2));
      BVar4 = PtInRect((undefined2 *)CONCAT22((RECT *)&rcProdDiamond,pt_2.y),pt_2.x);
      if (BVar4 != 0) {
        setcursor(hcurArrowHelp);
        return 1;
      }
    }
    else {
      if (message == WM_DRAWITEM) {
        pt_2 = (POINT)lParam;
        if (*(int *)((int)lParam + 4) == -1) {
          HandleFocusState((DRAWITEMSTRUCT *)lParam,-2);
        }
        else {
          iVar6 = *(int *)((int)lParam + 6);
          if (((iVar6 == 1) || (iVar6 == 2)) || (iVar6 == 4)) {
            DrawCBEntireItem((DRAWITEMSTRUCT *)lParam,4);
          }
        }
        return 1;
      }
      if (message == WM_MEASUREITEM) {
        *(int *)((int)lParam + 8) = dyArial8 + 2;
        return 1;
      }
      if (message == WM_INITDIALOG) {
        rgzp[3].rgpq[3].w = 0x42e;
        rgzp[3].rgpq[4].w = 0x42f;
        rgzp[3].rgpq[5].w = 1;
        rgzp[3].rgpq[6].w = 2;
        rgzp[3].rgpq[7].w = 0x418;
        rgzp[3].rgpq[8].w = 0x419;
        rgzp[3].rgpq[9].w = 0x439;
        rgzp[3].rgpq[10].w = 0x43a;
        rgzp[3].rgpq[0xb].w = 0x42d;
        rgszZip[0] = (char *)&game.mdDensity;
        hwndProdDlg = hwnd;
        if (*(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) < 2) {
          HVar2 = GetDlgItem(hwnd,0x42f);
          EnableWindow(HVar2,0);
          HVar2 = GetDlgItem(hwnd,0x42e);
          EnableWindow(HVar2,0);
        }
        if ((uint)gd._0_2_ >> 0xe == 0) {
          dx = 0x262;
          pt_2.x = dyArial8 * 0x18 + 0x18;
        }
        else {
          dx = 0x2f8;
          pt_2.x = 0x244;
        }
        SetWindowPos(hwnd,0,0,0,dx,pt_2.x,6);
        GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
        iVar6 = (rc.bottom - (dyArial8 * 0x11) / 2) + -0x18;
        rc.left = (rc.right * 0xb) / 0x14 + 0x10;
        pt_2.y = (rc.right - rc.left) / 4;
        rc.bottom = rc.bottom - ((dyArial8 * 3) / 2 + 6);
        HVar2 = GetDlgItem(hwnd,0x8b);
        SetWindowPos(HVar2,0,6,rc.bottom,rc.left + -0xc,(dyArial8 * 3) / 2,4);
        for (i = 0; i < 4; i = i + 1) {
          HVar2 = GetDlgItem(hwnd,(short)rgszZip[i + -9]);
          SetWindowPos(HVar2,0,rc.left,rc.bottom,pt_2.y + -6,(dyArial8 * 3) / 2,4);
          rc.left = rc.left + pt_2.y;
        }
        rc.left = (rc.right >> 1) - (pt_2.y + 0x12 >> 1);
        rgzp[3].rgpq[2].w = (dyArial8 * 3) / 2;
        iVar1 = (iVar6 + dyArial8 * -9) / 5 + rgzp[3].rgpq[2].w;
        pt_2.x = iVar1 + -3;
        rc.top = 8;
        if (0x32 < pt_2.x) {
          rc.top = ((iVar1 + -0x35) * 5) / 2 + 8;
          pt_2.x = 0x32;
        }
        pt_2.y = pt_2.y + 0x18;
        for (i = 4; i < 10; i = i + 1) {
          HVar2 = GetDlgItem(hwnd,(short)rgszZip[i + -9]);
          SetWindowPos(HVar2,0,rc.left,rc.top,pt_2.y + -6,(dyArial8 * 3) / 2,4);
          rc.top = rc.top + pt_2.x;
        }
        HVar2 = GetDlgItem(hwnd,0x416);
        SetWindowPos(HVar2,0,6,6,rc.left + -0xc,iVar6,4);
        HVar2 = GetDlgItem(hwnd,0x416);
        GetWindowRect(HVar2,(undefined2 *)CONCAT22(unaff_SS,&uStack_3a));
        HVar2 = GetDlgItem(hwnd,0x417);
        SetWindowPos(HVar2,0,rc.left + pt_2.y,6,rc.left + -0xc,hcs - i_2,4);
        ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,sz255));
        yTopFutureTech = hcs;
        InitializeProductionDlg(hwnd);
        if (((uint)gd._0_2_ >> 0xe == 1) && (ptStickyProduceDlg.y == -1)) {
          ptStickyProduceDlg.y = 0;
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyProduceDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        ProdCommandHandler(hwnd,wParam,lParam);
      }
      else if ((message == WM_LBUTTONDOWN) || (message == WM_RBUTTONDOWN)) {
        pt_2.x = (int)lParam;
        puVar9 = (undefined2 *)__aFulshr(uVar8,fRet);
        pt_2.y = (short)(undefined2 *)puVar9;
        BVar4 = PtInRect((undefined2 *)
                         CONCAT22((RECT *)&rcProdDiamond,(undefined2 *)puVar9),pt_2.x);
        if (BVar4 != 0) {
          if (message == WM_LBUTTONDOWN) {
            GlobalPD.grPopup = 10;
            GlobalPD.field1_0x2 = 0xb4;
            GlobalPD.field2_0x3 = 0;
            GlobalPD.psz = (char *)szPopupBuffer;
            CchGetString
                      (idsRightClickBlueDiamondApplyProductionTemplate,
                       (char *)szPopupBuffer);
            Popup(hwnd,pt_2.x,pt_2.y);
          }
          else {
            sz255[0] = -1;
            sz255[1] = '\0';
            hcs = 0;
            for (i_2 = 0; i_2 < 4; i_2 = i_2 + 1) {
              if (*(char *)((int)&vrgZipProd[0].fValid + i_2 * 0x28) != '\0') {
                rgszZip[hcs] = ((ZIPPRODQ *)vrgZipProd)[i_2].szName;
                hcs = hcs + 1;
              }
            }
            rgszZip[hcs] = sz255;
            pcVar3 = PszGetCompressedString(idsCustomize);
            rgszZip[hcs + 1] = pcVar3;
            i_2 = PopupMenu(hwnd,pt_2.x,pt_2.y,hcs + 2,(long *)0x0,rgszZip,-1,1);
            if (i_2 == hcs + 1) {
              _memcpy(rgzp,(ZIPPRODQ *)vrgZipProd,0xa0);
              pvVar10 = MakeProcInstance(ZipProdDlg,hInst);
              sVar5 = DialogBox(0,(LPCSTR)CONCAT22(0x59,hwnd),(HWND)((ulong)pvVar10 >> 0x10),
                                (void *)pvVar10);
              FreeProcInstance(pvVar10);
              if (sVar5 == 0) {
                _memcpy((ZIPPRODQ *)vrgZipProd,rgzp,0xa0);
              }
            }
            else if (-1 < i_2) {
              hcs = 0;
              while (((int)hcs < 4 &&
                     ((*(char *)((int)&vrgZipProd[0].fValid + hcs * 0x28) == '\0' ||
                      (iVar6 = i_2 + -1, bVar7 = i_2 != 0, i_2 = iVar6, bVar7))))) {
                hcs = hcs + 1;
              }
              ProdCommandHandler(hwnd,0x816,(long)(int)hcs);
            }
          }
        }
      }
    }
    sVar5 = 0;
  }
  return sVar5;
}



// ======================================================================
// Function: ProdCommandHandler
// Address: 10d0:1994
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d01f07) */
/* WARNING: Removing unreachable block (ram,0x10d01a99) */
/* WARNING: Removing unreachable block (ram,0x10d026c2) */
/* WARNING: Removing unreachable block (ram,0x10d023e0) */
/* WARNING: Removing unreachable block (ram,0x10d02357) */
/* WARNING: Removing unreachable block (ram,0x10d02404) */
/* WARNING: Removing unreachable block (ram,0x10d025ca) */
/* WARNING: Removing unreachable block (ram,0x10d01a12) */
/* WARNING: Removing unreachable block (ram,0x10d01e16) */
/* WARNING: Removing unreachable block (ram,0x10d021cd) */
/* WARNING: Removing unreachable block (ram,0x10d029e0) */
/* WARNING: Removing unreachable block (ram,0x10d01dc1) */
/* WARNING: Removing unreachable block (ram,0x10d01b8e) */
/* WARNING: Removing unreachable block (ram,0x10d01b0c) */
/* WARNING: Removing unreachable block (ram,0x10d01a9e) */
/* WARNING: Removing unreachable block (ram,0x10d01b07) */
/* WARNING: Removing unreachable block (ram,0x10d01b89) */
/* WARNING: Removing unreachable block (ram,0x10d01d7f) */
/* WARNING: Removing unreachable block (ram,0x10d022cf) */
/* WARNING: Removing unreachable block (ram,0x10d029ab) */
/* WARNING: Removing unreachable block (ram,0x10d029e5) */
/* WARNING: Removing unreachable block (ram,0x10d027b8) */
/* WARNING: Removing unreachable block (ram,0x10d0231d) */
/* WARNING: Removing unreachable block (ram,0x10d02093) */
/* WARNING: Removing unreachable block (ram,0x10d02051) */
/* WARNING: Removing unreachable block (ram,0x10d01f51) */
/* WARNING: Removing unreachable block (ram,0x10d01f0c) */
/* WARNING: Removing unreachable block (ram,0x10d01f8e) */
/* WARNING: Removing unreachable block (ram,0x10d02816) */
/* WARNING: Removing unreachable block (ram,0x10d03237) */
/* WARNING: Removing unreachable block (ram,0x10d02222) */
/* WARNING: Removing unreachable block (ram,0x10d03098) */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void ProdCommandHandler(HWND hwnd,ushort wParam,long lParam)

{
  PROD *pPVar1;
  undefined2 *puVar2;
  uint *puVar3;
  byte *pbVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  PL *pPVar7;
  undefined2 uVar8;
  uint uVar9;
  uint uVar10;
  uint uVar11;
  uint uVar12;
  HWND HVar13;
  HWND HVar14;
  short sVar15;
  int iVar16;
  ushort uVar17;
  PROD *pPVar18;
  PLPROD *pPVar19;
  uint *puVar20;
  undefined2 *puVar21;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar22;
  undefined2 unaff_SS;
  bool bVar23;
  ulong uVar24;
  long lVar25;
  ulong uVar26;
  PL *pPVar27;
  ulong uVar28;
  long lVar29;
  LRESULT LVar30;
  void *pvVar31;
  PLANET *pPVar32;
  undefined2 uVar33;
  short sVar34;
  UINT UVar35;
  ushort uVar36;
  ushort in_stack_0000ffc2;
  PLPROD *lpplprodT;
  short cMax;
  PROD prod;
  PROD *lpprod;
  RECT rc;
  short iMac;
  short fRefillSrc;
  short ipl;
  PROD prodLast;
  short iDst;
  short c;
  HWND hwndLB;
  short iSrc;
  long lSel;
  
  uVar24 = CONCAT22(unaff_SI,unaff_DI);
  if ((wParam == 1) || (wParam == 2)) {
    hwndProdDlg = 0;
    StickyDlgPos(hwnd,(POINT *)&ptStickyProduceDlg,0);
    EndDialog(hwnd,(uint)(wParam == 1));
    return;
  }
  if (wParam == 0x76) {
    WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x423);
    return;
  }
  if (wParam == 0x8b) {
    HVar13 = GetDlgItem(hwnd,0x417);
    HVar14 = GetDlgItem(hwnd,0x8b);
    SendMessage(HVar14,0x400,0,0);
    lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
    sel.pl.dwFlags._0_2_ = (uint)sel.pl.dwFlags | (uint)lVar29;
    sel.pl.dwFlags._2_2_ =
         sel.pl.dwFlags._2_2_ & 0xff7f | (uint)((ulong)lVar29 >> 0x10);
    LVar30 = SendMessage(HVar13,0x409,0,0);
    FillPlanetProdLB(HVar13,lpplProdGlob,(PLANET *)0x0);
    lSel._0_2_ = (uint)LVar30;
    SendMessage(HVar13,0x407,(uint)lSel,0);
    goto PRODUCE_RedrawText;
  }
  if ((wParam == 0x416) || (wParam == 0x417)) {
    uVar28 = __aFulshr(uVar24,in_stack_0000ffc2);
    if ((int)uVar28 == 1) goto PRODUCE_RedrawText;
    uVar28 = __aFulshr(uVar24,in_stack_0000ffc2);
    if ((int)uVar28 != 2) {
      return;
    }
    if (wParam == 0x416) goto PRODUCE_AddItem;
  }
  else {
    if (wParam == 0x418) {
PRODUCE_AddItem:
      uVar36 = (ushort)uVar24;
      HVar13 = GetDlgItem(hwnd,0x416);
      lVar29 = SendMessage(HVar13,0x409,0,0);
      if (((int)((ulong)lVar29 >> 0x10) < 1) && (lVar29 < 0)) {
        return;
      }
      iSrc = 0;
      while( true ) {
        lSel._2_2_ = (int)((ulong)lVar29 >> 0x10);
        lSel._0_2_ = (uint)lVar29;
        if ((cProdGlob <= iSrc) ||
           ((((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0 &&
            (bVar23 = lVar29 == 0,
            lVar29 = CONCAT22(lSel._2_2_ - (uint)((uint)lSel == 0),(uint)lSel + -1), bVar23))))
        break;
        iSrc = iSrc + 1;
      }
      uVar10 = (uint)(pProdGlob + iSrc)->dwFlags;
      prod.dwFlags._2_2_ = *(uint *)((int)&pProdGlob[iSrc].dwFlags + 2);
      uVar22 = 0x11;
      uVar9 = GetAsyncKeyState(0x11);
      if ((uVar9 & 0xfffe) == 0) {
        uVar33 = 0x10;
        uVar9 = GetAsyncKeyState(0x10);
        if ((uVar9 & 0xfffe) == 0) {
          prod.dwFlags._0_2_ = uVar10 & 0xfc00 | 1;
        }
        else {
          lVar29 = __aFlshl(CONCAT22(uVar22,uVar33),uVar36);
          prod.dwFlags._0_2_ = uVar10 & 0xfc00 | (uint)lVar29;
          prod.dwFlags._2_2_ = prod.dwFlags._2_2_ | (uint)((ulong)lVar29 >> 0x10);
        }
      }
      else {
        uVar33 = 0x10;
        uVar9 = GetAsyncKeyState(0x10);
        if ((uVar9 & 0xfffe) == 0) {
          lVar29 = __aFlshl(CONCAT22(uVar22,uVar33),uVar36);
          uVar9 = (uint)((ulong)lVar29 >> 0x10);
          prod.dwFlags._0_2_ = uVar10 & 0xfc00 | (uint)lVar29;
        }
        else {
          lVar29 = __aFlshl(CONCAT22(uVar22,uVar33),uVar36);
          uVar9 = (uint)((ulong)lVar29 >> 0x10);
          prod.dwFlags._0_2_ = uVar10 & 0xfc00 | (uint)lVar29;
        }
        prod.dwFlags._2_2_ = prod.dwFlags._2_2_ | uVar9;
      }
      if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
        lVar29 = __aFlshl(CONCAT22(uVar22,uVar33),uVar36);
        lpplprodT._2_2_ = (int)(pProdGlob + iSrc)->dwFlags - (int)lVar29 & 0x3ff;
        pPVar18 = pProdGlob + iSrc;
        pPVar1 = pPVar18;
        *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
        puVar2 = (undefined2 *)((int)&pPVar18->dwFlags + 2);
        *puVar2 = *puVar2;
        pPVar18 = pProdGlob + iSrc;
        pPVar1 = pPVar18;
        *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags | lpplprodT._2_2_;
        puVar2 = (undefined2 *)((int)&pPVar18->dwFlags + 2);
        *puVar2 = *puVar2;
      }
      uVar10 = (uint)((PLPROD *)lpplProdGlob)->iprodMac;
      HVar13 = GetDlgItem(hwnd,0x417);
      LVar30 = SendMessage(HVar13,0x409,0,0);
      if ((LVar30 < 0x10000) && (LVar30 < 0)) {
        iDst = uVar10 - 1;
        if (iDst < 0) {
          iDst = 0;
        }
      }
      else {
        iDst = (int)LVar30 + -1;
      }
      if (iDst < (int)uVar10) {
        if (iDst < 0) {
LAB_10d0_1fde:
          iDst = iDst + 1;
          if (iDst < (int)uVar10) {
            uVar24 = __aFulshr(CONCAT22(uVar22,uVar33),uVar36);
            lpplprodT._2_2_ = (uint)uVar24 & 0x7f;
            uVar24 = __aFulshr(CONCAT22(uVar22,uVar33),uVar36);
            if (lpplprodT._2_2_ == ((uint)uVar24 & 0x7f)) {
              uVar24 = __aFulshr(CONCAT22(uVar22,uVar33),uVar36);
              lpplprodT._2_2_ = (uint)uVar24 & 7;
              uVar24 = __aFulshr(CONCAT22(uVar22,uVar33),uVar36);
              if (lpplprodT._2_2_ == ((uint)uVar24 & 7)) goto PRODUCE_RingItUp;
            }
          }
          goto LAB_10d0_2099;
        }
        uVar24 = __aFulshr(CONCAT22(uVar22,uVar33),uVar36);
        lpplprodT._2_2_ = (uint)uVar24 & 0x7f;
        uVar24 = __aFulshr(CONCAT22(uVar22,uVar33),uVar36);
        if (lpplprodT._2_2_ != ((uint)uVar24 & 0x7f)) goto LAB_10d0_1fde;
        uVar24 = __aFulshr(CONCAT22(uVar22,uVar33),uVar36);
        lpplprodT._2_2_ = (uint)uVar24 & 7;
        uVar24 = __aFulshr(CONCAT22(uVar22,uVar33),uVar36);
        if (lpplprodT._2_2_ != ((uint)uVar24 & 7)) goto LAB_10d0_1fde;
PRODUCE_RingItUp:
        lVar29 = __aFlshl(CONCAT22(uVar22,uVar33),uVar36);
        uVar5 = lpplProdGlob._2_2_;
        uVar10 = *(uint *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
        pPVar19 = (PLPROD *)lpplProdGlob + iDst + 1;
        pPVar19->wFlags =
             ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0xfc00U | (uint)lVar29;
        *(uint *)&pPVar19->iprodMax = uVar10 | (uint)((ulong)lVar29 >> 0x10);
        if (((1 < (((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0x3ffU)) &&
            (uVar24 = __aFulshr(CONCAT22(uVar22,uVar33),uVar36), ((uint)uVar24 & 0x7f) == 3)
            ) && (uVar24 = __aFulshr(CONCAT22(uVar22,uVar33),uVar36),
                 ((uint)uVar24 & 7) == 1)) {
          uVar33 = lpplProdGlob._2_2_;
          uVar22 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iDst + 1].iprodMax;
          pPVar19 = (PLPROD *)lpplProdGlob + iDst + 1;
          pPVar19->wFlags = ((PLPROD *)lpplProdGlob + iDst + 1)->wFlags & 0xfc00U | 1;
          *(undefined2 *)&pPVar19->iprodMax = uVar22;
        }
      }
      else {
LAB_10d0_2099:
        if (0x27 < uVar10) {
          MessageBeep(0);
          goto PRODUCE_RedrawText;
        }
        if (uVar10 == ((PLPROD *)lpplProdGlob)->iprodMax) {
          lpplProdGlob = (PLPROD *)LpplReAlloc((PL *)lpplProdGlob,uVar10 + 4);
        }
        if (iDst != uVar10) {
          __fmemmove((PLPROD *)
                             CONCAT22(lpplProdGlob._2_2_,
                                      (PLPROD *)lpplProdGlob + iDst + 2),
                             (PLPROD *)
                             CONCAT22(lpplProdGlob._2_2_,
                                      (PLPROD *)lpplProdGlob + iDst + 1),(uVar10 - iDst) * 4)
          ;
        }
        uVar22 = lpplProdGlob._2_2_;
        pPVar19 = (PLPROD *)lpplProdGlob + iDst + 1;
        pPVar19->wFlags = (uint)prod.dwFlags;
        *(uint *)&pPVar19->iprodMax = prod.dwFlags._2_2_;
        pbVar4 = &((PLPROD *)lpplProdGlob)->iprodMac;
        *pbVar4 = *pbVar4 + 1;
      }
      uVar33 = 0;
      pPVar32 = (PLANET *)0x0;
      pPVar19 = (PLPROD *)lpplProdGlob;
      uVar22 = lpplProdGlob._2_2_;
      HVar13 = GetDlgItem(hwnd,0x417);
      FillPlanetProdLB
                (HVar13,(PLPROD *)CONCAT22(uVar22,pPVar19),(PLANET *)CONCAT22(uVar33,pPVar32));
      HVar13 = GetDlgItem(hwnd,0x417);
      SendMessage(HVar13,0x407,iDst + 1,0);
      if (((pProdGlob + iSrc)->dwFlags & 0x3ff) == 0) {
        sVar34 = -1;
        HVar13 = GetDlgItem(hwnd,0x416);
        FillProdSrcLB(HVar13,sVar34);
      }
      goto PRODUCE_RedrawText;
    }
    if (wParam != 0x419) {
      if (wParam != 0x42d) {
        if ((wParam == 0x42e) || (wParam == 0x42f)) {
          if (wParam == 0x42f) {
            sVar34 = 1;
          }
          else {
            sVar34 = -1;
          }
          FinishProduction(1);
          sVar15 = GetKeyState(0x10);
          if (sVar15 < 0) {
            sVar34 = IdFindAdjStarbase(sel.pl.id,(uint)(wParam == 0x42f));
            SelectAdjPlanet(0,sVar34);
          }
          else {
            SelectAdjPlanet(sVar34,0);
          }
          InitProduction((PROD *)0x0);
          InitializeProductionDlg(hwnd);
          GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
          rc.top = yTopFutureTech;
          rc.bottom = dyArial8 * 9 + yTopFutureTech;
          InvalidateRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc),1);
          return;
        }
        if (wParam == 0x439) {
          HVar13 = GetDlgItem(hwnd,0x417);
          LVar30 = SendMessage(HVar13,0x409,0,0);
          if (LVar30 < 2) {
            return;
          }
          uVar33 = (undefined2)((ulong)lpplProdGlob >> 0x10);
          pPVar19 = (PLPROD *)lpplProdGlob;
          lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar21 = (undefined2 *)((int)&pPVar19[1].wFlags + (int)lVar29);
          uVar22 = *puVar21;
          uVar33 = puVar21[1];
          pPVar19 = (PLPROD *)lpplProdGlob;
          uVar6 = lpplProdGlob._2_2_;
          lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar21 = (undefined2 *)((int)&pPVar19[1].wFlags + (int)lVar29);
          uVar5 = *puVar21;
          uVar6 = puVar21[1];
          pPVar19 = (PLPROD *)lpplProdGlob;
          uVar8 = lpplProdGlob._2_2_;
          lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar21 = (undefined2 *)((int)&pPVar19[1].wFlags + (int)lVar29);
          *puVar21 = uVar5;
          puVar21[1] = uVar6;
          pPVar19 = (PLPROD *)lpplProdGlob;
          uVar5 = lpplProdGlob._2_2_;
          lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar21 = (undefined2 *)((int)&pPVar19[1].wFlags + (int)lVar29);
          *puVar21 = uVar22;
          puVar21[1] = uVar33;
          uVar33 = 0;
          pPVar32 = (PLANET *)0x0;
          pPVar19 = (PLPROD *)lpplProdGlob;
          uVar22 = lpplProdGlob._2_2_;
          HVar13 = GetDlgItem(hwnd,0x417);
          FillPlanetProdLB
                    (HVar13,(PLPROD *)CONCAT22(uVar22,pPVar19),(PLANET *)CONCAT22(uVar33,pPVar32));
          HVar13 = GetDlgItem(hwnd,0x417);
          SendMessage(HVar13,0x407,(int)LVar30 - 1,0);
          goto PRODUCE_RedrawText;
        }
        if (wParam == 0x43a) {
          HVar13 = GetDlgItem(hwnd,0x417);
          LVar30 = SendMessage(HVar13,0x409,0,0);
          uVar22 = (undefined2)((ulong)lpplProdGlob >> 0x10);
          pPVar19 = (PLPROD *)lpplProdGlob;
          if (LVar30 < 1) {
            return;
          }
          if (-1 < LVar30) {
            if (0xffff < LVar30) {
              return;
            }
            if ((uint)pPVar19->iprodMac <= (uint)LVar30) {
              return;
            }
          }
          lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar21 = (undefined2 *)((int)&pPVar19[1].wFlags + (int)lVar29);
          uVar33 = *puVar21;
          uVar22 = puVar21[1];
          pPVar19 = (PLPROD *)lpplProdGlob;
          uVar6 = lpplProdGlob._2_2_;
          lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar21 = (undefined2 *)((int)&pPVar19[1].wFlags + (int)lVar29);
          uVar5 = *puVar21;
          uVar6 = puVar21[1];
          pPVar19 = (PLPROD *)lpplProdGlob;
          uVar8 = lpplProdGlob._2_2_;
          lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar21 = (undefined2 *)((int)&pPVar19[1].wFlags + (int)lVar29);
          *puVar21 = uVar5;
          puVar21[1] = uVar6;
          pPVar19 = (PLPROD *)lpplProdGlob;
          uVar5 = lpplProdGlob._2_2_;
          lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
          puVar21 = (undefined2 *)((int)&pPVar19[1].wFlags + (int)lVar29);
          *puVar21 = uVar33;
          puVar21[1] = uVar22;
          uVar33 = 0;
          pPVar32 = (PLANET *)0x0;
          pPVar19 = (PLPROD *)lpplProdGlob;
          uVar22 = lpplProdGlob._2_2_;
          HVar13 = GetDlgItem(hwnd,0x417);
          FillPlanetProdLB
                    (HVar13,(PLPROD *)CONCAT22(uVar22,pPVar19),(PLANET *)CONCAT22(uVar33,pPVar32));
          HVar13 = GetDlgItem(hwnd,0x417);
          SendMessage(HVar13,0x407,(uint)LVar30 + 1,0);
          goto PRODUCE_RedrawText;
        }
        if (wParam != 0x816) {
          return;
        }
      }
      ipl = 0;
      while( true ) {
        uVar22 = (undefined2)((ulong)lpplProdGlob >> 0x10);
        if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= ipl) break;
        for (iSrc = 0; iSrc < cProdGlob; iSrc = iSrc + 1) {
          uVar28 = __aFulshr(uVar24,in_stack_0000ffc2);
          uVar26 = __aFulshr(uVar24,in_stack_0000ffc2);
          if (((uint)uVar28 & 7) == ((uint)uVar26 & 7)) {
            uVar28 = __aFulshr(uVar24,in_stack_0000ffc2);
            uVar26 = __aFulshr(uVar24,in_stack_0000ffc2);
            if (((uint)uVar28 & 0x7f) == ((uint)uVar26 & 0x7f)) break;
          }
        }
        if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
          lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
          lpplprodT._2_2_ = (int)lVar29 + (int)(pProdGlob + iSrc)->dwFlags & 0x3ff;
          pPVar18 = pProdGlob + iSrc;
          pPVar1 = pPVar18;
          *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
          puVar2 = (undefined2 *)((int)&pPVar18->dwFlags + 2);
          *puVar2 = *puVar2;
          pPVar18 = pProdGlob + iSrc;
          pPVar1 = pPVar18;
          *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags | lpplprodT._2_2_;
          puVar2 = (undefined2 *)((int)&pPVar18->dwFlags + 2);
          *puVar2 = *puVar2;
        }
        ipl = ipl + 1;
      }
      if (wParam == 0x816) {
        uVar28 = __aFulmul(lParam,0x28);
        cMax = (uint)((PLPROD *)lpplProdGlob)->iprodMac +
               (uint)*(byte *)((int)&vrgZipProd[0].cpq + (int)uVar28);
        if (cMax == 0) {
          cMax = 1;
        }
        pPVar27 = LpplAlloc(4,cMax,htOrd);
        uVar22 = (undefined2)((ulong)pPVar27 >> 0x10);
        pPVar7 = (PL *)pPVar27;
        __fmemset((PL *)CONCAT22(uVar22,pPVar7 + 1),0,cMax << 2);
        iDst = 0;
        for (iSrc = 0; iSrc < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; iSrc = iSrc + 1)
        {
          uVar28 = __aFulshr(uVar24,in_stack_0000ffc2);
          if ((((uint)uVar28 & 7) != 1) ||
             (uVar28 = __aFulshr(uVar24,in_stack_0000ffc2), 6 < ((uint)uVar28 & 0x7f))) {
            uVar33 = *(undefined2 *)&((PLPROD *)lpplProdGlob)[iSrc + 1].iprodMax;
            (pPVar7 + iDst + 1)->wFlags = ((PLPROD *)lpplProdGlob + iSrc + 1)->wFlags;
            *(undefined2 *)&pPVar7[iDst + 1].iMax = uVar33;
            iDst = iDst + 1;
          }
        }
        for (iSrc = 0; uVar28 = __aFulmul(lParam,0x28),
            iSrc < (int)(uint)*(byte *)((int)&vrgZipProd[0].cpq + (int)uVar28);
            iSrc = iSrc + 1) {
          sVar34 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
          if (((sVar34 != 8) ||
              (uVar28 = __aFulmul(lParam,0x28),
              2 < (*(uint *)((int)uVar28 + 0x2306 + iSrc * 2) & 0x3f))) &&
             ((sVar34 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
              sVar34 != 3 ||
              ((uVar28 = __aFulmul(lParam,0x28),
               (*(uint *)((int)uVar28 + 0x2306 + iSrc * 2) & 0x3f) != 4 &&
               (uVar28 = __aFulmul(lParam,0x28),
               (*(uint *)((int)uVar28 + 0x2306 + iSrc * 2) & 0x3f) != 5)))))) {
            uVar10 = *(uint *)&pPVar7[iDst + 1].iMax;
            (pPVar7 + iDst + 1)->wFlags = (pPVar7 + iDst + 1)->wFlags;
            *(uint *)&pPVar7[iDst + 1].iMax = uVar10 & 0xfff1 | 2;
            __aFulmul(lParam,0x28);
            lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
            uVar10 = *(uint *)&pPVar7[iDst + 1].iMax;
            (pPVar7 + iDst + 1)->wFlags = (pPVar7 + iDst + 1)->wFlags & 0x3ffU | (uint)lVar29;
            *(uint *)&pPVar7[iDst + 1].iMax = uVar10 & 0xfffe | (uint)((ulong)lVar29 >> 0x10);
            __aFulmul(lParam,0x28);
            lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
            uVar10 = *(uint *)&pPVar7[iDst + 1].iMax;
            (pPVar7 + iDst + 1)->wFlags = (pPVar7 + iDst + 1)->wFlags & 0xfc00U | (uint)lVar29;
            *(uint *)&pPVar7[iDst + 1].iMax = uVar10 | (uint)((ulong)lVar29 >> 0x10);
            iDst = iDst + 1;
          }
        }
        pPVar7->iMac = (byte)iDst;
        FreePl((PL *)lpplProdGlob);
        lpplProdGlob = (PLPROD *)pPVar27;
        __aFulmul(lParam,0x28);
        lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
        uVar36 = (ushort)uVar24;
        sel.pl.dwFlags._0_2_ = (uint)sel.pl.dwFlags | (uint)lVar29;
        sel.pl.dwFlags._2_2_ =
             sel.pl.dwFlags._2_2_ & 0xff7f | (uint)((ulong)lVar29 >> 0x10);
        HVar13 = GetDlgItem(hwnd,0x8b);
        UVar35 = 0x401;
        uVar24 = __aFulshr(CONCAT22(HVar13,0x401),uVar36);
        SendMessage(HVar13,UVar35,(uint)uVar24 & 1,0);
      }
      else {
        ((PLPROD *)lpplProdGlob)->iprodMac = 0;
      }
      uVar33 = 0;
      pPVar32 = (PLANET *)0x0;
      pPVar19 = (PLPROD *)lpplProdGlob;
      uVar22 = lpplProdGlob._2_2_;
      HVar13 = GetDlgItem(hwnd,0x417);
      FillPlanetProdLB
                (HVar13,(PLPROD *)CONCAT22(uVar22,pPVar19),(PLANET *)CONCAT22(uVar33,pPVar32));
      HVar13 = GetDlgItem(hwnd,0x417);
      SendMessage(HVar13,0x407,0,0);
      sVar34 = -1;
      HVar13 = GetDlgItem(hwnd,0x416);
      FillProdSrcLB(HVar13,sVar34);
      HVar13 = GetDlgItem(hwnd,0x416);
      SendMessage(HVar13,0x407,0,0);
      goto PRODUCE_RedrawText;
    }
  }
  HVar13 = GetDlgItem(hwnd,0x417);
  LVar30 = SendMessage(HVar13,0x409,0,0);
  uVar10 = (uint)LVar30;
  if (LVar30 < 1) {
    return;
  }
  uVar22 = (undefined2)((ulong)lpplProdGlob >> 0x10);
  pPVar19 = (PLPROD *)lpplProdGlob;
  uVar11 = (uint)pPVar19->iprodMac;
  lSel._0_2_ = uVar10 - 1;
  lSel._2_2_ = (int)((ulong)LVar30 >> 0x10) - (uint)(uVar10 == 0);
  lVar29 = __aFlshl(uVar24,in_stack_0000ffc2);
  uVar9 = *(uint *)((int)&pPVar19[1].wFlags + (int)lVar29);
  for (iSrc = 0; iSrc < cProdGlob; iSrc = iSrc + 1) {
    uVar28 = __aFulshr(uVar24,in_stack_0000ffc2);
    lpplprodT._2_2_ = (uint)uVar28 & 7;
    uVar28 = __aFulshr(uVar24,in_stack_0000ffc2);
    if (lpplprodT._2_2_ == ((uint)uVar28 & 7)) {
      uVar28 = __aFulshr(uVar24,in_stack_0000ffc2);
      lpplprodT._2_2_ = (uint)uVar28 & 0x7f;
      uVar28 = __aFulshr(uVar24,in_stack_0000ffc2);
      if (lpplprodT._2_2_ == ((uint)uVar28 & 0x7f)) break;
    }
  }
  uVar17 = (ushort)uVar24;
  lVar29 = (pProdGlob + iSrc)->dwFlags;
  uVar36 = 0x11;
  uVar12 = GetAsyncKeyState(0x11);
  if ((uVar12 & 0xfffe) == 0) {
    uVar22 = 0x10;
    uVar12 = GetAsyncKeyState(0x10);
    if ((uVar12 & 0xfffe) == 0) {
      c = 1;
    }
    else {
      c = 10;
    }
  }
  else {
    uVar22 = 0x10;
    uVar12 = GetAsyncKeyState(0x10);
    if ((uVar12 & 0xfffe) == 0) {
      c = 100;
    }
    else {
      c = 0x3fc;
    }
  }
  uVar24 = __aFulshr(CONCAT22(uVar36,uVar22),uVar17);
  if ((((uint)uVar24 & 7) == 1) &&
     (uVar24 = __aFulshr(CONCAT22(uVar36,uVar22),uVar17), ((uint)uVar24 & 0x7f) == 3)) {
    c = 0x3fc;
  }
  if ((uVar9 & 0x3ff) <= (uint)c) {
    c = uVar9 & 0x3ff;
  }
  if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0x3ff) {
    lVar25 = (pProdGlob + iSrc)->dwFlags;
    pPVar18 = pProdGlob + iSrc;
    pPVar1 = pPVar18;
    *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags & 0xfc00;
    puVar2 = (undefined2 *)((int)&pPVar18->dwFlags + 2);
    *puVar2 = *puVar2;
    pPVar18 = pProdGlob + iSrc;
    pPVar1 = pPVar18;
    *(uint *)&pPVar1->dwFlags = (uint)pPVar1->dwFlags | c + (int)lVar25 & 0x3ffU;
    puVar2 = (undefined2 *)((int)&pPVar18->dwFlags + 2);
    *puVar2 = *puVar2;
  }
  pPVar19 = (PLPROD *)lpplProdGlob;
  uVar33 = lpplProdGlob._2_2_;
  lVar25 = __aFlshl(CONCAT22(uVar36,uVar22),uVar17);
  lpplprodT._2_2_ = *(int *)((int)&pPVar19[1].wFlags + (int)lVar25) - c & 0x3ff;
  pPVar19 = (PLPROD *)lpplProdGlob;
  uVar33 = lpplProdGlob._2_2_;
  lVar25 = __aFlshl(CONCAT22(uVar36,uVar22),uVar17);
  puVar20 = (uint *)((int)&pPVar19[1].wFlags + (int)lVar25);
  puVar3 = puVar20;
  *puVar3 = *puVar3 & 0xfc00;
  puVar3 = puVar20 + 1;
  *puVar3 = *puVar3;
  uVar33 = lpplProdGlob._2_2_;
  pPVar19 = (PLPROD *)lpplProdGlob + 1;
  lVar25 = __aFlshl(CONCAT22(uVar36,uVar22),uVar17);
  puVar20 = (uint *)((int)&pPVar19->wFlags + (int)lVar25);
  puVar3 = puVar20;
  *puVar3 = *puVar3 | lpplprodT._2_2_;
  puVar3 = puVar20 + 1;
  *puVar3 = *puVar3;
  pPVar19 = (PLPROD *)lpplProdGlob;
  uVar33 = lpplProdGlob._2_2_;
  lVar25 = __aFlshl(CONCAT22(uVar36,uVar22),uVar17);
  if ((*(uint *)((int)&pPVar19[1].wFlags + (int)lVar25) & 0x3ff) == 0) {
    iVar16 = lSel._2_2_ + (uint)(0xfffe < (uint)lSel);
    if ((iVar16 < 1) && ((iVar16 < 0 || (uVar10 < uVar11)))) {
      uVar17 = ((uVar11 - (uint)lSel) + -1) * 4;
      pPVar19 = (PLPROD *)lpplProdGlob;
      uVar33 = lpplProdGlob._2_2_;
      lVar25 = __aFlshl(CONCAT22(uVar22,uVar17),uVar36);
      pvVar31 = (void *)((int)&pPVar19[1].wFlags + (int)lVar25);
      pPVar19 = (PLPROD *)lpplProdGlob;
      uVar22 = lpplProdGlob._2_2_;
      lVar25 = __aFlshl((long)CONCAT22(uVar33,pvVar31),uVar17);
      __fmemmove((void *)CONCAT22(uVar22,(void *)((int)&pPVar19[1].wFlags + (int)lVar25)),
                         (void *)CONCAT22(uVar33,pvVar31),uVar17);
    }
    else {
      bVar23 = (uint)lSel == 0;
      lSel._0_2_ = uVar10 - 2;
      lSel._2_2_ = lSel._2_2_ - (uint)bVar23;
    }
    pbVar4 = &((PLPROD *)lpplProdGlob)->iprodMac;
    *pbVar4 = *pbVar4 - 1;
  }
  uVar33 = 0;
  pPVar32 = (PLANET *)0x0;
  pPVar19 = (PLPROD *)lpplProdGlob;
  uVar22 = lpplProdGlob._2_2_;
  HVar13 = GetDlgItem(hwnd,0x417);
  FillPlanetProdLB
            (HVar13,(PLPROD *)CONCAT22(uVar22,pPVar19),(PLANET *)CONCAT22(uVar33,pPVar32));
  if (-1 < lSel._2_2_) {
    HVar13 = GetDlgItem(hwnd,0x417);
    SendMessage(HVar13,0x407,(uint)lSel + 1,0);
  }
  if ((lVar29 & 0x3ff) == 0) {
    sVar34 = -1;
    HVar13 = GetDlgItem(hwnd,0x416);
    FillProdSrcLB(HVar13,sVar34);
  }
PRODUCE_RedrawText:
  GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
  rc.top = yTopFutureTech;
  rc.bottom = dyArial8 * 7 + yTopFutureTech;
  rc.left = rc.left + 0x82;
  InvalidateRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc),1);
  DrawProductionDlg(hwnd,0,&rc,-1);
  return;
}



// ======================================================================
// Function: InitializeProductionDlg
// Address: 10d0:3430
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d0353f) */
/* WARNING: Removing unreachable block (ram,0x10d0351f) */
/* WARNING: Removing unreachable block (ram,0x10d03544) */

void InitializeProductionDlg(HWND hwnd)

{
  char *pcVar1;
  char *pcVar2;
  HWND HVar3;
  HWND HVar4;
  PLPROD *pPVar5;
  undefined2 uVar6;
  char *unaff_SS;
  ulong uVar7;
  short mdFill;
  PLANET *lppl;
  ulong uVar8;
  LPCSTR pcVar9;
  PROD *lpprod;
  short iSel;
  short i;
  char rgch [86];
  
  iSel = -1;
  pcVar1 = PszGetPlanetName(sel.pl.id);
  pcVar2 = PszGetCompressedString(idsProductionQueueS);
  _WSPRINTF((LPSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(LPCSTR)CONCAT22(pcVar2,unaff_SS),rgch);
  pcVar9 = (LPCSTR)CONCAT22(unaff_SS,rgch);
  HVar4 = hwnd;
  SetWindowText(hwnd,pcVar9);
  mdFill = -1;
  HVar3 = GetDlgItem(hwnd,0x416);
  FillProdSrcLB(HVar3,mdFill);
  HVar3 = GetDlgItem(hwnd,0x416);
  SendMessage(HVar3,0x407,0,0);
  i = 0;
  while( true ) {
    uVar6 = (undefined2)((ulong)lpplProdGlob >> 0x10);
    pPVar5 = (PLPROD *)lpplProdGlob;
    if ((int)(uint)pPVar5->iprodMac <= i) break;
    uVar7 = __aFulshr((ulong)pcVar9,HVar4);
    if ((((uint)uVar7 & 7) != 1) ||
       (uVar7 = __aFulshr((ulong)pcVar9,HVar4), 6 < ((uint)uVar7 & 0x7f))) {
      iSel = i;
    }
    i = i + 1;
  }
  lppl = (PLANET *)0x0;
  HVar4 = GetDlgItem(hwnd,0x417);
  pcVar1 = (char *)pcVar9;
  FillPlanetProdLB(HVar4,(PLPROD *)CONCAT22(uVar6,pPVar5),lppl);
  HVar4 = GetDlgItem(hwnd,0x417);
  SendMessage(HVar4,0x407,iSel + 1,0);
  HVar4 = GetDlgItem(hwnd,0x8b);
  uVar8 = CONCAT22(HVar4,0x401);
  uVar7 = __aFulshr(uVar8,(ushort)pcVar1);
  SendMessage((HWND)(uVar8 >> 0x10),(UINT)uVar8,(uint)uVar7 & 1,0);
  return;
}



// ======================================================================
// Function: DrawProductionDlg
// Address: 10d0:35dc
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d036d8) */
/* WARNING: Removing unreachable block (ram,0x10d0372f) */
/* WARNING: Variable defined which should be unmapped: szT */

void DrawProductionDlg(HWND hwnd,HDC hdc,RECT *prc,short iDraw)

{
  ulong uVar1;
  bool bVar2;
  char *pcVar3;
  short sVar4;
  HWND HVar5;
  short sVar6;
  int iVar7;
  uint uVar8;
  ushort uVar9;
  uint *puVar10;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  char *unaff_SS;
  bool bVar11;
  DWORD DVar12;
  ulong uVar13;
  long lVar14;
  undefined1 *puVar15;
  char *pcVar16;
  short sVar17;
  HDC HVar18;
  ulong uVar19;
  char szT [100];
  PROD prod;
  RECT rc;
  short k;
  short dxkT;
  long rgCost [4];
  short c;
  short i;
  short fCreatedDC;
  short idc;
  short iSrc;
  long lSel;
  
  uVar19 = CONCAT22(unaff_SI,unaff_DI);
  bVar11 = hdc == 0;
  if (bVar11) {
    hdc = GetDC(hwnd);
  }
  SelectObject(hdc,rghfontArial8[0]);
  HVar18 = hdc;
  pcVar3 = PszGetCompressedString(idsKt);
  DVar12 = GetTextExtent(HVar18,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar3),2);
  SelectObject(hdc,rghfontArial8[1]);
  SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  i = 0;
  do {
    if (1 < i) {
      GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
      rc.top = rc.bottom - ((dyArial8 * 5) / 2 + 0xc);
      rc.bottom = (dyArial8 | 1U) + rc.top;
      rc.left = 6;
      rc.right = dyArial8 + 6;
      DrawDiamond(hdc,&rc,hbrBBlue);
      rcProdDiamond.left = rc.left;
      rcProdDiamond.top = rc.top;
      rcProdDiamond.right = rc.right;
      rcProdDiamond.bottom = rc.bottom;
      SelectObject(hdc,rghfontArial8[1]);
      sVar4 = CchGetString(idsApplyDefineProductionTemplate,(char *)szWork);
      TextOut(hdc,rc.right + 4,rc.top,szWork,sVar4);
      if (bVar11) {
        ReleaseDC(hwnd,hdc);
      }
      return;
    }
    if (i == 0) {
      sVar4 = 0x416;
    }
    else {
      sVar4 = 0x417;
    }
    HVar5 = GetDlgItem(hwnd,sVar4);
    GetWindowRect(HVar5,(undefined2 *)CONCAT22(unaff_SS,&rc));
    ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&rc.right));
    HVar5 = GetDlgItem(hwnd,sVar4);
    uVar13 = SendMessage(HVar5,0x409,0,0);
    if ((-1 < (long)uVar13) && ((uVar13 != 0 || (i != 1)))) {
      if (i == 0) {
        iSrc = 0;
        while( true ) {
          lSel._2_2_ = (int)(uVar13 >> 0x10);
          lSel._0_2_ = (int)uVar13;
          uVar1 = uVar13;
          if (cProdGlob <= iSrc) break;
          if (((pProdGlob + iSrc)->dwFlags & 0x3ff) != 0) {
            iVar7 = lSel._2_2_ - (uint)((int)lSel == 0);
            uVar1 = CONCAT22(iVar7,(int)lSel + -1);
            bVar2 = uVar13 == 0;
            uVar13 = CONCAT22(iVar7,(int)lSel + -1);
            if (bVar2) break;
          }
          iSrc = iSrc + 1;
        }
        prod.dwFlags._2_2_ = *(uint *)((int)&pProdGlob[iSrc].dwFlags + 2);
        prod.dwFlags._0_2_ = (uint)(pProdGlob + iSrc)->dwFlags & 0xfc00 | 1;
      }
      else {
        szT._96_2_ = (PLPROD *)lpplProdGlob + 1;
        szT[0x62] = lpplProdGlob._2_1_;
        szT[99] = lpplProdGlob._3_1_;
        lVar14 = __aFlshl(uVar19,szT._0_2_);
        uVar1 = (ulong)((int)uVar13 - 1);
        puVar10 = (uint *)(szT._96_2_ + (int)lVar14);
        prod.dwFlags._0_2_ = *puVar10;
        prod.dwFlags._2_2_ = puVar10[1];
      }
      GetProductionCosts(&sel.pl,(PROD *)CONCAT22(unaff_SS,&prod),(ulong *)rgCost,
                         idPlayer,0);
      rc.bottom = yTopFutureTech + 4;
      SelectObject(hdc,rghfontArial8[1]);
      sVar4 = CchGetString(idsRequiredMinerals,(char *)szWork);
      TextOut(hdc,rc.left,rc.bottom,szWork,sVar4);
      rc.left = rc.left + 0x14;
      rc.right = rc.right + -0x14;
      for (k = 0; k < 4; k = k + 1) {
        iVar7 = k;
        if (k == 3) {
          iVar7 = 5;
        }
        rc.bottom = rc.bottom + dyArial8;
        SelectObject(hdc,rghfontArial8[1]);
        SetTextColor(hdc,CONCAT22(*(undefined2 *)(iVar7 * 4 + 0x44a),
                                  *(undefined2 *)(iVar7 * 4 + 0x448)));
        pcVar3 = (char *)*(undefined2 *)(iVar7 * 2 + 0x4cc);
        puVar15 = (undefined1 *)&DAT_1120_1120;
        sVar4 = rc.bottom;
        sVar17 = rc.left;
        HVar18 = hdc;
        sVar6 = lstrlen((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,
                                         (char *)*(undefined2 *)(iVar7 * 2 + 0x4cc)));
        TextOut(HVar18,sVar17,sVar4,(LPCSTR)CONCAT22(puVar15,pcVar3),sVar6);
        SelectObject(hdc,rghfontArial8[0]);
        SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
        sVar4 = _WSPRINTF((LPSTR)CONCAT22((int)rgCost[k],(char *)&DAT_1120_1120),
                          (LPCSTR)CONCAT22(PCTLD,(char *)&DAT_1120_1120),
                          (char *)szWork);
        RightTextOut
                  (hdc,(rc.right - (int)DVar12) + -2,rc.bottom,(char *)szWork,sVar4,
                   dxMaxMineralQuan);
        if (k < 3) {
          iVar7 = rc.right - (int)DVar12;
          sVar4 = rc.bottom;
          HVar18 = hdc;
          pcVar3 = PszGetCompressedString(idsKt);
          TextOut(HVar18,iVar7,sVar4,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar3),2);
        }
      }
      if (i != 0) {
        rc.bottom = rc.bottom + (dyArial8 * 3) / 2;
        SelectObject(hdc,rghfontArial8[1]);
        uVar13 = __aFulshr(uVar19,szT._0_2_);
        uVar8 = (uint)uVar13 & 0x7f;
        pcVar3 = PszGetCompressedString(idsDDoneCompletion);
        iVar7 = _WSPRINTF((LPSTR)CONCAT22(uVar8,(char *)&DAT_1120_1120),
                          (LPCSTR)CONCAT22(pcVar3,unaff_SS),szT);
        lSel._0_2_ = (int)uVar1;
        PszProductionETA
                  (&sel.pl,
                   (PLPROD *)CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob),
                   (int)lSel,(short *)0x0,(short *)0x0);
        _strcpy(szT + iVar7,(char *)szWork);
        iVar7 = rc.left + -0x14;
        pcVar3 = szT;
        pcVar16 = unaff_SS;
        sVar4 = rc.bottom;
        HVar18 = hdc;
        uVar9 = _strlen(szT);
        TextOut(HVar18,iVar7,sVar4,(LPCSTR)CONCAT22(pcVar16,pcVar3),uVar9);
        SelectObject(hdc,rghfontArial8[0]);
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FillProdSrcLB
// Address: 10d0:3b00
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d03c3a) */
/* WARNING: Removing unreachable block (ram,0x10d03bce) */
/* WARNING: Removing unreachable block (ram,0x10d03b6b) */
/* WARNING: Removing unreachable block (ram,0x10d03b66) */
/* WARNING: Removing unreachable block (ram,0x10d03bfb) */
/* WARNING: Removing unreachable block (ram,0x10d03bf6) */
/* WARNING: Removing unreachable block (ram,0x10d03c3f) */
/* WARNING: Variable defined which should be unmapped: psz */

void FillProdSrcLB(HWND hwndLB,short mdFill)

{
  char *pcVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar2;
  ulong uVar3;
  char *psz;
  short i;
  char szT [80];
  
  uVar3 = CONCAT22(unaff_SI,unaff_DI);
  for (i = 0; i < 6; i = i + 1) {
    szT[i] = ' ';
  }
  SendMessage(hwndLB,0x405,0,0);
  for (i = 0; i < cProdGlob; i = i + 1) {
    if (((pProdGlob + i)->dwFlags & 0x3ff) != 0) {
      pcVar1 = PszNameProdItem((PROD *)CONCAT22((undefined1 *)&DAT_1120_1120,pProdGlob + i
                                               ));
      _strcpy(szT + 6,pcVar1);
      uVar2 = __aFulshr(uVar3,(ushort)pcVar1);
      if (((uint)uVar2 & 7) == 2) {
        uVar2 = __aFulshr(uVar3,(ushort)pcVar1);
        if (((uint)uVar2 & 0x7f) < 0x10) {
          szT[0] = '*';
        }
        else {
          szT[0] = '#';
        }
      }
      else {
        uVar2 = __aFulshr(uVar3,(ushort)pcVar1);
        if (((uint)uVar2 & 0x7f) < 7) {
          szT[0] = 'I';
          _strcat(szT + 6,(char *)s__Auto_Build__1120_0cda);
        }
        else {
          szT[0] = ' ';
        }
      }
      SendMessage(hwndLB,0x401,0,(LPARAM)CONCAT22(unaff_SS,szT));
    }
  }
  return;
}



// ======================================================================
// Function: PszNameProdItem
// Address: 10d0:3c92
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d03cde) */
/* WARNING: Removing unreachable block (ram,0x10d03ce7) */
/* WARNING: Removing unreachable block (ram,0x10d03e82) */
/* WARNING: Removing unreachable block (ram,0x10d03ee7) */
/* WARNING: Removing unreachable block (ram,0x10d03e99) */
/* WARNING: Removing unreachable block (ram,0x10d03e87) */
/* WARNING: Removing unreachable block (ram,0x10d03e9e) */
/* WARNING: Removing unreachable block (ram,0x10d03cec) */

char * PszNameProdItem(PROD *lpprod)

{
  int iVar1;
  int iVar2;
  uint uVar3;
  int iVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar5;
  ulong uVar6;
  PLANETARY *pPVar7;
  ushort in_stack_0000fff4;
  short iDelta;
  ulong iItem;
  
  uVar6 = CONCAT22(unaff_SI,unaff_DI);
  uVar5 = __aFulshr(uVar6,in_stack_0000fff4);
  uVar3 = (uint)uVar5 & 0x7f;
  uVar6 = __aFulshr(uVar6,in_stack_0000fff4);
  if (((uint)uVar6 & 7) == 2) {
    if (uVar3 < 0x10) {
      uVar6 = __aFulmul(uVar5 & 0x7f,0x93);
      if ((*(uint *)((int)&rgshdef[0].wFlags + (int)uVar6) >> 9 & 1) == 0) {
        uVar5 = __aFulmul(uVar5 & 0x7f,0x93);
        _strcpy((char *)szWork,
                        (char *)((int)&rgshdef[0].hul + 8 + (int)uVar5));
        goto LAB_10d0_3f19;
      }
    }
    else {
      iVar1 = uVar3 - 0x10;
      iVar2 = -(uint)(uVar3 < 0x10);
      uVar5 = __aFulmul(CONCAT22(iVar2,iVar1),0x93);
      if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + (int)uVar5 + 0x7b) >> 9 & 1) == 0) {
        uVar5 = __aFulmul(CONCAT22(iVar2,iVar1),0x93);
        __fstrcpy(szWork,
                          (char *)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x14e),
                                           (char *)(*(int *)(idPlayer * 4 + 0x14c) +
                                                    (int)uVar5 + 8)));
        if (((uint)sel.pl.wFlags >> 9 & 1) != 0) {
          iVar4 = *(int *)(*(int *)(idPlayer * 4 + 0x14c) +
                          (sel.pl._44_2_ & 0xf) * 0x93);
          uVar5 = __aFulmul(CONCAT22(iVar2,iVar1),0x93);
          iVar4 = iVar4 - *(int *)(*(int *)(idPlayer * 4 + 0x14c) + (int)uVar5);
          if (iVar4 < 1) {
            if (iVar4 < 0) {
              _strcat((char *)szWork,(char *)s__upgrade__1120_0cf5);
            }
          }
          else {
            _strcat((char *)szWork,(char *)s__downgrade__1120_0ce8);
          }
        }
        goto LAB_10d0_3f19;
      }
    }
    szWork[0] = '\0';
  }
  else if ((uVar3 < 0x12) || (0x1a < uVar3)) {
    if (uVar3 == 0x1b) {
      CchGetString(idsPlanetaryScanner,(char *)szWork);
    }
    else {
      CchGetString(uVar3 + idsMines,(char *)szWork);
    }
  }
  else {
    pPVar7 = LpplanetaryFromId(uVar3 - 0x12);
    __fstrcpy(szWork,
                      (char *)CONCAT22((int)((ulong)pPVar7 >> 0x10),((PLANETARY *)pPVar7)->szName));
  }
LAB_10d0_3f19:
  return (char *)szWork;
}



// ======================================================================
// Function: GetProductionCosts
// Address: 10d0:3f20
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d03faf) */
/* WARNING: Removing unreachable block (ram,0x10d03fa6) */
/* WARNING: Removing unreachable block (ram,0x10d03fb4) */

void GetProductionCosts(PLANET *lppl,PROD *lpprod,ulong *rgCost,short iplr,short fOnlyOne)

{
  byte bVar1;
  long lVar2;
  short sVar3;
  int iVar4;
  ushort uVar5;
  short sVar6;
  HUL *pHVar7;
  HUL *pHVar8;
  PLANET *pPVar9;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar10;
  bool bVar11;
  bool bVar12;
  ulong uVar13;
  ulong uVar14;
  ushort *rgCost_00;
  undefined2 uVar15;
  ushort in_stack_0000ffac;
  short rgCostsPartNew [4];
  short rgCostsPartCur [4];
  HUL *lphulT;
  HUL *lphulCur;
  HUL *lphulNew;
  short chs;
  short cost;
  PART part;
  short fStarbase;
  ulong cItem;
  short raMajor;
  SHDEF *lpshdef;
  short j;
  short i;
  ushort rgCosts [4];
  ulong iItem;
  ushort rgCostsCur [4];
  
  uVar14 = CONCAT22(unaff_SI,unaff_DI);
  uVar10 = (undefined2)((ulong)lppl >> 0x10);
  pPVar9 = (PLANET *)lppl;
  sVar3 = GetRaceStat((PLAYER *)rgplr + pPVar9->iPlayer,rsMajorAdv);
  uVar13 = __aFulshr(uVar14,in_stack_0000ffac);
  iItem._0_2_ = (uint)uVar13 & 0x7f;
  iItem._2_2_ = 0;
  lVar2 = lpprod->dwFlags;
  uVar14 = __aFulshr(uVar14,in_stack_0000ffac);
  if (((uint)uVar14 & 7) == 2) {
    bVar11 = 0xf < (uint)iItem;
    if (bVar11) {
      lpshdef._0_2_ = (SHDEF *)*(undefined2 *)(iplr * 4 + 0x14c);
      lpshdef._2_2_ = *(undefined2 *)(iplr * 4 + 0x14e);
      bVar12 = (uint)iItem < 0x10;
      iItem._0_2_ = (uint)iItem - 0x10;
      iItem._2_2_ = -(uint)bVar12;
    }
    else {
      lpshdef._0_2_ = (SHDEF *)*(undefined2 *)(iplr * 4 + 0xfe);
      lpshdef._2_2_ = *(undefined2 *)(iplr * 4 + 0x100);
    }
    uVar13 = __aFulmul(CONCAT22(iItem._2_2_,(uint)iItem),0x93);
    if ((*(uint *)((int)(&((SHDEF *)lpshdef)->hul + 1) + (int)uVar13) >> 9 & 1) != 0) {
      for (i = 0; i < 4; i = i + 1) {
        *(undefined2 *)(rgCost + i) = 0;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
      }
      return;
    }
    rgCost_00 = rgCosts;
    uVar13 = __aFulmul(CONCAT22(iItem._2_2_,(uint)iItem),0x93);
    GetTrueHullCost
              (iplr,(HUL *)CONCAT22(lpshdef._2_2_,
                                    (HUL *)((((SHDEF *)lpshdef)->hul).rgTech + (int)uVar13 + -2)),
               rgCost_00);
    if ((bVar11) && (((uint)pPVar9->wFlags >> 9 & 1) != 0)) {
      uVar15 = *(undefined2 *)(iplr * 4 + 0x14e);
      pHVar7 = (HUL *)(*(int *)(iplr * 4 + 0x14c) + (*(uint *)&pPVar9->field11_0x2c & 0xf) * 0x93);
      lphulCur = (HUL *)CONCAT22(uVar15,pHVar7);
      uVar13 = __aFulmul(CONCAT22(iItem._2_2_,(uint)iItem),0x93);
      pHVar8 = (HUL *)((((SHDEF *)lpshdef)->hul).rgTech + (int)uVar13 + -2);
      lphulNew = (HUL *)CONCAT22(lpshdef._2_2_,pHVar8);
      GetTrueHullCost(iplr,(HUL *)CONCAT22(uVar15,pHVar7),rgCostsCur);
      if (lphulCur->ihuldef == lphulNew->ihuldef) {
        part.pcom = (COMPART *)LphuldefFromId(lphulCur->ihuldef);
        part.hs.grhst =
             ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines
               |hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine);
        GetTruePartCost(iplr,&part,(ushort *)rgCostsPartCur);
        for (i = 0; i < 4; i = i + 1) {
          rgCosts[i] = rgCosts[i] - rgCostsPartCur[i];
        }
        bVar1 = pHVar7->chs;
        for (i = 0; i < (int)(uint)bVar1; i = i + 1) {
          if (((uint)pHVar7->rghs[i].wFlags >> 8 != 0) && ((uint)pHVar8->rghs[i].wFlags >> 8 != 0))
          {
            part.hs.grhst = (pHVar7->rghs + i)->grhst;
            part.hs.wFlags = pHVar7->rghs[i].wFlags;
            FLookupPart(&part);
            GetTruePartCost(iplr,&part,(ushort *)rgCostsPartCur);
            part.hs.grhst = (pHVar8->rghs + i)->grhst;
            part.hs.wFlags = pHVar8->rghs[i].wFlags;
            FLookupPart(&part);
            GetTruePartCost(iplr,&part,(ushort *)rgCostsPartNew);
            if ((pHVar7->rghs + i)->grhst == (pHVar8->rghs + i)->grhst) {
              if ((pHVar7->rghs[i].wFlags & 0xffU) == (pHVar8->rghs[i].wFlags & 0xffU)) {
                for (j = 0; j < 4; j = j + 1) {
                  rgCostsPartCur[j] = rgCostsPartCur[j] * ((uint)pHVar7->rghs[i].wFlags >> 8);
                  rgCostsPartNew[j] = rgCostsPartNew[j] * ((uint)pHVar8->rghs[i].wFlags >> 8);
                  if ((uint)(rgCostsPartNew[j] - rgCostsPartCur[j]) < 0x8000) {
                    iVar4 = rgCostsPartNew[j] - rgCostsPartCur[j];
                  }
                  else {
                    iVar4 = 0;
                  }
                  if (rgCosts[j] < (uint)(rgCostsPartNew[j] - iVar4)) {
                    uVar5 = rgCosts[j];
                  }
                  else {
                    uVar5 = rgCostsPartNew[j] - iVar4;
                  }
                  rgCosts[j] = rgCosts[j] - uVar5;
                }
              }
              else {
                for (j = 0; j < 4; j = j + 1) {
                  rgCostsPartCur[j] = rgCostsPartCur[j] * ((uint)pHVar7->rghs[i].wFlags >> 8);
                  rgCostsPartNew[j] = rgCostsPartNew[j] * ((uint)pHVar8->rghs[i].wFlags >> 8);
                  if (rgCostsPartNew[j] - (rgCostsPartCur[j] << 3) / 10 <
                      (rgCostsPartNew[j] << 1) / 10) {
                    iVar4 = (rgCostsPartNew[j] << 1) / 10;
                  }
                  else {
                    iVar4 = rgCostsPartNew[j] - (rgCostsPartCur[j] << 3) / 10;
                  }
                  if (rgCosts[j] < (uint)(rgCostsPartNew[j] - iVar4)) {
                    uVar5 = rgCosts[j];
                  }
                  else {
                    uVar5 = rgCostsPartNew[j] - iVar4;
                  }
                  rgCosts[j] = rgCosts[j] - uVar5;
                }
              }
            }
            else {
              for (j = 0; j < 4; j = j + 1) {
                rgCostsPartCur[j] = rgCostsPartCur[j] * ((uint)pHVar7->rghs[i].wFlags >> 8);
                rgCostsPartNew[j] = rgCostsPartNew[j] * ((uint)pHVar8->rghs[i].wFlags >> 8);
                if (rgCostsPartNew[j] - (rgCostsPartCur[j] * 7) / 10 < (rgCostsPartNew[j] * 3) / 10)
                {
                  iVar4 = (rgCostsPartNew[j] * 3) / 10;
                }
                else {
                  iVar4 = rgCostsPartNew[j] - (rgCostsPartCur[j] * 7) / 10;
                }
                if (rgCosts[j] < (uint)(rgCostsPartNew[j] - iVar4)) {
                  uVar5 = rgCosts[j];
                }
                else {
                  uVar5 = rgCostsPartNew[j] - iVar4;
                }
                rgCosts[j] = rgCosts[j] - uVar5;
              }
            }
          }
        }
      }
      else {
        for (i = 0; i < 4; i = i + 1) {
          uVar5 = rgCosts[i] - (int)rgCostsCur[i] / 2;
          if ((int)uVar5 < (int)(rgCosts[i] / 2)) {
            rgCosts[i] = rgCosts[i] / 2;
          }
          else {
            rgCosts[i] = uVar5;
          }
        }
      }
    }
    if ((bVar11) &&
       ((sVar3 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceISB), sVar3 != 0 ||
        (sVar3 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv), sVar3 == 8)))) {
      for (i = 0; i < 4; i = i + 1) {
        rgCosts[i] = rgCosts[i] - rgCosts[i] / 5;
      }
    }
    if (bVar11) {
      for (i = 0; i < 4; i = i + 1) {
        *(uint *)(rgCost + i) = (rgCosts[i] + 1) / 2;
        *(uint *)((int)(rgCost + i) + 2) = 0;
      }
    }
    else {
      for (i = 0; i < 4; i = i + 1) {
        *(ushort *)(rgCost + i) = rgCosts[i];
        *(ushort *)((int)(rgCost + i) + 2) = 0;
      }
    }
    goto LAB_10d0_4eef;
  }
  if ((uVar13 & 0x7f) == 0) {
LAB_10d0_4915:
    for (i = 0; i < 3; i = i + 1) {
      *(undefined2 *)(rgCost + i) = 0;
      *(undefined2 *)((int)(rgCost + i) + 2) = 0;
    }
    sVar3 = GetRaceStat((PLAYER *)rgplr + iplr,rsMineBuild);
    *(short *)(rgCost + 3) = sVar3;
    *(int *)((int)rgCost + 0xe) = sVar3 >> 0xf;
    goto LAB_10d0_4eef;
  }
  if ((uint)iItem == 1) {
LAB_10d0_4867:
    sVar3 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceCheapFact);
    if (((uint)gd._0_2_ >> 0xb & 1) == 0) {
      *(undefined2 *)(rgCost + 1) = 0;
      *(undefined2 *)((int)rgCost + 6) = 0;
      *(undefined2 *)rgCost = 0;
      *(undefined2 *)((int)rgCost + 2) = 0;
      *(int *)(rgCost + 2) = 4 - sVar3;
      *(int *)((int)rgCost + 10) = 4 - sVar3 >> 0xf;
    }
    else {
      for (i = 0; i < 3; i = i + 1) {
        *(int *)(rgCost + i) = 2 - sVar3;
        *(int *)((int)(rgCost + i) + 2) = 2 - sVar3 >> 0xf;
      }
    }
    sVar3 = GetRaceStat((PLAYER *)rgplr + iplr,rsFactBuild);
    *(short *)(rgCost + 3) = sVar3;
    *(int *)((int)rgCost + 0xe) = sVar3 >> 0xf;
  }
  else {
    if ((uint)iItem == 2) {
LAB_10d0_4964:
      part.hs.grhst = hstPlanetary;
      part.hs.wFlags = part.hs.wFlags & 0xff00U | 9;
      FLookupPart(&part);
      i = 0;
      while( true ) {
        if (2 < i) break;
        iVar4 = ((COMPART *)part.pcom)->rgwtOreCost[i];
        *(int *)(rgCost + i) = iVar4;
        *(int *)((int)(rgCost + i) + 2) = iVar4 >> 0xf;
        i = i + 1;
      }
      *(short *)(rgCost + 3) = ((COMPART *)part.pcom)->resCost;
      *(undefined2 *)((int)rgCost + 0xe) = 0;
      sVar3 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
      if (sVar3 == 4) {
        for (i = 0; i < 4; i = i + 1) {
          uVar15 = 0;
          uVar10 = 5;
          uVar13 = __aFulmul(CONCAT22(*(undefined2 *)((int)(rgCost + i) + 2),(int)rgCost[i])
                                     ,3);
          uVar13 = __aFuldiv(uVar13,CONCAT22(uVar15,uVar10));
          *(int *)(rgCost + i) = (int)uVar13;
          *(undefined2 *)((int)(rgCost + i) + 2) = (int)(uVar13 >> 0x10);
        }
      }
      goto LAB_10d0_4eef;
    }
    if ((uint)iItem == 3) {
LAB_10d0_4a48:
      for (i = 0; i < 3; i = i + 1) {
        *(undefined2 *)(rgCost + i) = 0;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
      }
      sVar3 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceMineralAlchemy);
      if (sVar3 == 0) {
        uVar10 = 100;
      }
      else {
        uVar10 = 0x19;
      }
      *(undefined2 *)(rgCost + 3) = uVar10;
      *(undefined2 *)((int)rgCost + 0xe) = 0;
      goto LAB_10d0_4eef;
    }
    if (((uint)iItem == 4) || ((uint)iItem == 5)) {
LAB_10d0_4c24:
      *(undefined2 *)(rgCost + 2) = 0;
      *(undefined2 *)((int)rgCost + 10) = 0;
      *(undefined2 *)(rgCost + 1) = 0;
      *(undefined2 *)((int)rgCost + 6) = 0;
      *(undefined2 *)rgCost = 0;
      *(undefined2 *)((int)rgCost + 2) = 0;
      sVar6 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceTT);
      if (sVar6 == 0) {
        *(undefined2 *)(rgCost + 3) = 100;
        *(undefined2 *)((int)rgCost + 0xe) = 0;
      }
      else {
        *(undefined2 *)(rgCost + 3) = 0x46;
        *(undefined2 *)((int)rgCost + 0xe) = 0;
      }
      if (sVar3 == 3) {
        uVar13 = __aFuldiv(CONCAT22(*(undefined2 *)((int)rgCost + 0xe),(int)rgCost[3]),2);
        *(int *)(rgCost + 3) = (int)uVar13;
        *(undefined2 *)((int)rgCost + 0xe) = (int)(uVar13 >> 0x10);
      }
      goto LAB_10d0_4eef;
    }
    if ((uint)iItem != 6) {
      if ((uint)iItem == 7) goto LAB_10d0_4867;
      if ((uint)iItem == 8) goto LAB_10d0_4915;
      if ((uint)iItem == 9) goto LAB_10d0_4964;
      if ((uint)iItem == 0xb) goto LAB_10d0_4a48;
      if ((uint)iItem == 0xc) goto LAB_10d0_4c24;
      if ((uint)iItem == 0xd) {
        part.hs.grhst = hstPlanetary;
        part.hs.wFlags = part.hs.wFlags & 0xff00U | 0xe;
        FLookupPart(&part);
        GetTruePartCost(iplr,&part,rgCosts);
        for (i = 0; i < 4; i = i + 1) {
          *(ushort *)(rgCost + i) = rgCosts[i];
          *(ushort *)((int)(rgCost + i) + 2) = 0;
        }
        goto LAB_10d0_4eef;
      }
      if ((((uint)iItem == 0xe) || ((uint)iItem == 0xf)) || ((uint)iItem == 0x10)) {
        if (sVar3 == 6) {
          uVar10 = 0x46;
        }
        else if (sVar3 == 7) {
          uVar10 = 0x78;
        }
        else {
          uVar10 = 0x6e;
        }
        for (i = 0; i < 3; i = i + 1) {
          if (((uint)iItem - 0xe != i) || (uVar15 = uVar10, (uint)iItem < 0xe)) {
            uVar15 = 0;
          }
          *(undefined2 *)(rgCost + i) = uVar15;
          *(undefined2 *)((int)(rgCost + i) + 2) = 0;
        }
        if (sVar3 == 6) {
          uVar10 = 5;
        }
        else {
          uVar10 = 10;
        }
        *(undefined2 *)(rgCost + i) = uVar10;
        *(undefined2 *)((int)(rgCost + i) + 2) = 0;
        goto LAB_10d0_4eef;
      }
      if ((uint)iItem != 0x11) {
        if (((((uint)iItem != 0x12) && ((uint)iItem != 0x13)) &&
            (((uint)iItem != 0x14 &&
             (((((uint)iItem != 0x15 && ((uint)iItem != 0x16)) && ((uint)iItem != 0x17)) &&
              (((uint)iItem != 0x18 && ((uint)iItem != 0x19)))))))) && ((uint)iItem != 0x1a)) {
          if ((uint)iItem != 0x1b) goto LAB_10d0_4eef;
          iItem._0_2_ = 0x12;
        }
        part.hs.grhst = hstPlanetary;
        part.hs.wFlags = part.hs.wFlags & 0xff00U | (uint)iItem - 0x12 & 0xff;
        FLookupPart(&part);
        GetTruePartCost(iplr,&part,rgCosts);
        for (i = 0; i < 4; i = i + 1) {
          *(ushort *)(rgCost + i) = rgCosts[i];
          *(ushort *)((int)(rgCost + i) + 2) = 0;
        }
        goto LAB_10d0_4eef;
      }
    }
    if (sVar3 == 6) {
      uVar10 = 0x19;
    }
    else if (sVar3 == 7) {
      uVar10 = 0x30;
    }
    else {
      uVar10 = 0x2c;
    }
    for (i = 0; i < 3; i = i + 1) {
      *(undefined2 *)(rgCost + i) = uVar10;
      *(undefined2 *)((int)(rgCost + i) + 2) = 0;
    }
    if (sVar3 == 6) {
      uVar10 = 5;
    }
    else {
      uVar10 = 10;
    }
    *(undefined2 *)(rgCost + i) = uVar10;
    *(undefined2 *)((int)(rgCost + i) + 2) = 0;
  }
LAB_10d0_4eef:
  if (fOnlyOne == 0) {
    for (i = 0; i < 4; i = i + 1) {
      uVar13 = __aFulmul(CONCAT22(*(undefined2 *)((int)(rgCost + i) + 2),(int)rgCost[i]),
                                 (ulong)((uint)lVar2 & 0x3ff));
      *(int *)(rgCost + i) = (int)uVar13;
      *(undefined2 *)((int)(rgCost + i) + 2) = (int)(uVar13 >> 0x10);
    }
  }
  return;
}



// ======================================================================
// Function: EstimateItemProdSched
// Address: 10d0:4f40
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d05159) */
/* WARNING: Removing unreachable block (ram,0x10d050ac) */
/* WARNING: Removing unreachable block (ram,0x10d052cc) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10d05184) */
/* WARNING: Removing unreachable block (ram,0x10d051ac) */

void EstimateItemProdSched
          (PLANET *lppl,PLPROD *lpplprod,short iItem,short *piFirst,short *piLast)

{
  PLANET *pPVar1;
  PLANET *pPVar2;
  byte bVar3;
  PROD *pprodPartial;
  short sVar4;
  uint uVar5;
  int iVar6;
  PLPROD *pPVar7;
  undefined2 unaff_SI;
  PLANET *pPVar8;
  undefined2 unaff_DI;
  PLANET *pPVar9;
  undefined2 uVar10;
  undefined2 unaff_SS;
  bool bVar11;
  ulong uVar12;
  long lVar13;
  ulong uVar14;
  long lVar15;
  undefined2 uVar16;
  ulong uVar17;
  uint in_stack_0000ff8a;
  ushort uVar18;
  PROD *lpprod;
  long rgRes [4];
  short iMac;
  short fAlchemy;
  short iPass;
  short j;
  short i;
  short mdStatus;
  PROD prodPartial;
  short cBuilt;
  long rglQuan [3];
  PLANET pl;
  long cResearch;
  
  uVar17 = CONCAT22(unaff_SI,unaff_DI);
  if (((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) {
                    /* WARNING: Load size is inaccurate */
    lpplprod = (PLPROD *)
               CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                        ((PLANET *)lppl)->lpplprod);
  }
  pPVar9 = &pl;
  pPVar8 = (PLANET *)lppl;
  for (iVar6 = 0x1c; iVar6 != 0; iVar6 = iVar6 + -1) {
    pPVar2 = pPVar9;
    pPVar9 = (PLANET *)&pPVar9->iPlayer;
    pPVar1 = pPVar8;
    pPVar8 = (PLANET *)&pPVar8->iPlayer;
    pPVar2->id = pPVar1->id;
  }
  uVar10 = (undefined2)((ulong)lpplprod >> 0x10);
  pPVar7 = (PLPROD *)lpplprod;
  pl.lpplprod = (PLPROD *)LpplAlloc(4,(uint)pPVar7->iprodMax,htOrd);
  __fmemcpy((PL *)CONCAT22((int)((ulong)pl.lpplprod >> 0x10),(PL *)pl.lpplprod + 1),
                    (PLPROD *)CONCAT22(uVar10,pPVar7 + 1),(uint)pPVar7->iprodMac << 2);
  bVar3 = pPVar7->iprodMac;
  ((PLPROD *)pl.lpplprod)->iprodMac = bVar3;
  prodPartial.dwFlags._0_2_ = (uint)prodPartial.dwFlags & 0xfc00;
  *piLast = 0;
  *piFirst = 0;
  iPass = 1;
  do {
    if (99 < iPass) {
      if (*piFirst == 0) {
        *piFirst = 100;
      }
      *piLast = 100;
PRODUCE_LCleanUp:
      if (((PLPROD *)pl.lpplprod != (PLPROD *)0x0) || (pl.lpplprod._2_2_ != 0)) {
        FreePl((PL *)pl.lpplprod);
      }
      return;
    }
    EstMineralsMined((PLANET *)CONCAT22(unaff_SS,&pl),rglQuan,-1,1);
    for (j = 0; j < 3; j = j + 1) {
      uVar10 = *(undefined2 *)((int)pl.rgwtMin + j * 4 + 2);
      *(int *)(rgRes + j) = (int)pl.rgwtMin[j];
      *(undefined2 *)((int)rgRes + j * 4 + 2) = uVar10;
    }
    rgRes[3]._0_2_ =
         CResourcesAtPlanet((PLANET *)CONCAT22(unaff_SS,&pl),((PLANET *)lppl)->iPlayer);
    rgRes[3]._2_2_ = (int)(uint)rgRes[3] >> 0xf;
    uVar12 = __aFulshr(uVar17,in_stack_0000ff8a);
    if ((uVar12 & 1) == 0) {
      uVar16 = 0;
      uVar10 = 100;
      uVar12 = __aFulmul(CONCAT22(rgRes[3]._2_2_,(uint)rgRes[3]),
                                 (long)(int)*(char *)((int)&rgplr[0].pctResearch +
                                                     ((PLANET *)lppl)->iPlayer * 0xc0));
      lVar13 = __aFldiv(uVar12,CONCAT22(uVar16,uVar10));
      bVar11 = (uint)rgRes[3] < (uint)lVar13;
      rgRes[3]._0_2_ = (uint)rgRes[3] - (uint)lVar13;
      rgRes[3]._2_2_ = (rgRes[3]._2_2_ - (int)((ulong)lVar13 >> 0x10)) - (uint)bVar11;
    }
    else {
      lVar13 = 0;
    }
    uVar12 = (ulong)in_stack_0000ff8a;
    fAlchemy = 0;
    for (i = -1; uVar18 = (ushort)uVar12, i < (int)(uint)bVar3; i = i + 1) {
      if (i == -1) {
        lpprod = (PROD *)CONCAT22(unaff_SS,&prodPartial);
      }
      else {
        lpprod = (PROD *)CONCAT22(pl.lpplprod._2_2_,(PLPROD *)pl.lpplprod + i + 1);
      }
      if ((lpprod->dwFlags & 0x3ff) != 0) {
        uVar12 = __aFulshr(uVar17,uVar18);
        uVar10 = (undefined2)((ulong)lpprod >> 0x10);
        if (((uint)uVar12 & 0x7f) == 3) {
          uVar14 = __aFulshr(uVar17,uVar18);
          uVar12 = (ulong)uVar18;
          if (((uint)uVar14 & 7) == 1) {
            if (i < (int)(bVar3 - 1)) {
              if (i != iItem) {
                fAlchemy = 1;
                goto LAB_10d0_53bf;
              }
              *piLast = -1;
              *piFirst = -1;
              goto PRODUCE_LCleanUp;
            }
            uVar16 = *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2);
            *(uint *)&lpprod->dwFlags = (uint)lpprod->dwFlags & 0xfc00 | 0x3fc;
            *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2) = uVar16;
          }
        }
        if (i == -1) {
          pprodPartial = (PROD *)0x0;
        }
        else {
          pprodPartial = &prodPartial;
        }
        sVar4 = CBuildProdItem
                          ((PLANET *)CONCAT22(unaff_SS,&pl),lpprod,pprodPartial,rgRes,fAlchemy,
                           &mdStatus,0);
        if (iItem == i) {
          if ((0 < sVar4) && (*piFirst == 0)) {
            *piFirst = iPass;
          }
          if (mdStatus == 2) {
            if (*piFirst != 0) {
              *piLast = iPass + -1;
            }
            goto PRODUCE_LCleanUp;
          }
          if ((mdStatus == 0) || (mdStatus == 1)) {
            *piLast = iPass;
            goto PRODUCE_LCleanUp;
          }
        }
        fAlchemy = 0;
        uVar14 = __aFulshr(uVar17,uVar18);
        uVar12 = (ulong)uVar18;
        if (((uint)uVar14 & 7) == 1) {
          uVar14 = __aFulshr(uVar17,uVar18);
          uVar12 = (ulong)uVar18;
          uVar5 = (uint)uVar14 & 0x7f;
          if ((uVar14 & 0x7f) == 0) {
LAB_10d0_52ea:
            lVar15 = __aFlshl(uVar17,uVar18);
            uVar12 = lVar15 + CONCAT22(pl.dwFlags._2_2_,(uint)pl.dwFlags) & 0xfff00;
            pl.dwFlags._0_2_ = (uint)pl.dwFlags & 0xff | (uint)uVar12;
            pl.dwFlags._2_2_ = pl.dwFlags._2_2_ & 0xfff0 | (uint)(uVar12 >> 0x10);
          }
          else if ((uVar5 == 1) || (uVar5 == 7)) {
            lVar15 = __aFlshl(uVar17,uVar18);
            uVar12 = 0;
            pl.dwFlags._2_2_ =
                 pl.dwFlags._2_2_ & 0xf |
                 (int)((ulong)lVar15 >> 0x10) + pl.dwFlags._2_2_ +
                 (uint)CARRY2((uint)lVar15,(uint)pl.dwFlags) & 0xfff0;
          }
          else if (uVar5 == 8) goto LAB_10d0_52ea;
        }
        if (4 < mdStatus) break;
      }
LAB_10d0_53bf:
    }
    in_stack_0000ff8a = (uint)uVar12;
    cResearch._0_2_ = (int)lVar13;
    if (iItem < 0) {
      *piFirst = (uint)rgRes[3];
      if (iItem == -1) {
        *piFirst = *piFirst + (int)cResearch;
      }
      goto PRODUCE_LCleanUp;
    }
    for (j = 0; j < 3; j = j + 1) {
      uVar10 = *(undefined2 *)((int)rgRes + j * 4 + 2);
      *(int *)(pl.rgwtMin + j) = (int)rgRes[j];
      *(undefined2 *)((int)pl.rgwtMin + j * 4 + 2) = uVar10;
    }
    ChgPopFromPlanet((PLANET *)CONCAT22(unaff_SS,&pl),1);
    iPass = iPass + 1;
  } while( true );
}



// ======================================================================
// Function: ZipProdDlg
// Address: 10d0:5490
// Segment: MEMORY_PRODUCE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10d05b5e) */
/* WARNING: Removing unreachable block (ram,0x10d05b29) */
/* WARNING: Removing unreachable block (ram,0x10d05b63) */
/* WARNING: Variable defined which should be unmapped: pszT */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short ZipProdDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char *pcVar1;
  char cVar2;
  char *pcVar3;
  HDC HVar4;
  HWND HVar5;
  short sVar6;
  uint uVar7;
  int iVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar9;
  char *pcVar10;
  undefined1 *puVar11;
  undefined *puVar12;
  char *pszT;
  char *psz;
  HWND hwndRad;
  short cpq;
  char *pcStack_3a;
  char *psz_2;
  char *pszT_2;
  char *pcStack_34;
  RECT rc;
  short iBase;
  short i;
  PAINTSTRUCT ps;
  HDC hdc;
  
  if (message == WM_PAINT) {
    HVar4 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    HVar5 = GetDlgItem(hwnd,0x431);
    GetWindowRect(HVar5,(undefined2 *)CONCAT22(unaff_SS,&stack0xffc6));
    ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&stack0xffc6));
    HVar5 = GetDlgItem(hwnd,0x434);
    GetWindowRect(HVar5,(undefined2 *)CONCAT22(unaff_SS,&rc));
    ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&rc.right));
    pszT_2 = (char *)rc.right;
    pcStack_34 = (char *)rc.bottom;
    ExpandRc((RECT *)&stack0xffc6,dyArial8,dyArial8 >> 1);
    _Draw3dFrame();
    SelectObject(HVar4,rghfontArial8[1]);
    SetBkColor(HVar4,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    cpq = CchGetString(idsCustomOrders,(char *)szWork);
    TextOut(HVar4,(short)(pcStack_3a + 8),(int)psz_2 - (dyArial8 >> 1),szWork,
            cpq);
    psz_2 = (char *)((int)pcStack_34 + 8);
    if (*(char *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) != '\0') {
      cpq = CchGetString
                      (*(byte *)((int)&vrgZipProd[0].field2_0xe +
                                iResTechNow * 0x28) + idsContributeResearch,
                       (char *)szWork);
      TextOut(HVar4,(short)pcStack_3a,vyZPDStatic,szWork,cpq);
    }
    EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    return 1;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    for (i = 0x431; i < 0x435; i = i + 1) {
      pcStack_34 = (char *)(HWND)lParam;
      HVar5 = GetDlgItem(hwnd,i);
      if (pcStack_34 == (char *)HVar5) break;
    }
    if (0x434 < i) {
      return 0;
    }
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    return hbrButtonFace;
  }
  if (message == WM_INITDIALOG) {
    HVar5 = hwnd;
    pcVar3 = PszGetCompressedString(idsCustomizeProductionTemplates);
    SetWindowText(HVar5,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar3));
    GetWindowRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    GetClientRect(hwnd,(short *)CONCAT22(unaff_SS,&cpq));
    pcStack_34 = (char *)((rc.bottom - rc.top) - (int)pszT_2);
    HVar5 = GetDlgItem(hwnd,0x417);
    GetWindowRect(HVar5,(short *)CONCAT22(unaff_SS,&cpq));
    MapWindowPoints(0,hwnd,(short *)CONCAT22(unaff_SS,&cpq),2);
    vyZPDStatic = (short)(pszT_2 + 2);
    pcStack_34 = pszT_2 + (int)pcStack_34 + dyArial8 + 6;
    SetWindowPos(hwnd,0,0,0,rc.right - rc.left,(short)pcStack_34,6);
    CheckRadioButton(hwnd,0x431,0x434,0x431);
    EnableZipProdBtns(hwnd,0);
    iResTechNow = 0;
    FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd);
    for (i = 0x431; i < 0x435; i = i + 1) {
      if (*(char *)((int)&vrgZipProd[0].fValid + (i + -0x431) * 0x28) == '\0') {
        pcVar3 = PszGetCompressedString(idsUnusedD);
        _WSPRINTF((LPSTR)CONCAT22(i + -0x430,(char *)&DAT_1120_1120),
                  (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
      }
      else {
        pszT = (char *)szWork;
        pcVar3 = pszT;
        psz = ((ZIPPRODQ *)vrgZipProd)[i + -0x431].szName;
        while (pszT = pcVar3, *psz != '\0') {
          pcVar1 = psz + 1;
          cVar2 = *psz;
          *pszT = cVar2;
          pcVar3 = pszT + 1;
          psz = pcVar1;
          if (cVar2 == '&') {
            pszT[1] = '&';
            pcVar3 = pszT + 2;
          }
        }
        *pszT = '\0';
      }
      HVar5 = GetDlgItem(hwnd,i);
      SetWindowText(HVar5,szWork);
    }
    StickyDlgPos(hwnd,(POINT *)&ptStickyZipProdDlg,1);
    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    return 1;
  }
  if (message != WM_COMMAND) {
    return 0;
  }
  uVar9 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),(ushort)pszT);
  if ((((int)uVar9 == 0) && (0x430 < wParam)) && (wParam < 0x435)) {
    iResTechNow = wParam - 0x431;
    EnableZipProdBtns(hwnd,iResTechNow);
    FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd + iResTechNow);
    return 0;
  }
  if ((wParam == 1) || (wParam == 2)) {
    StickyDlgPos(hwnd,(POINT *)&ptStickyZipProdDlg,0);
    EndDialog(hwnd,(uint)(wParam == 1));
    vyZPDStatic = -1;
    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    return 1;
  }
  if ((wParam != 0x816) && (wParam != 0x41b)) {
    if (wParam == 0x817) {
      *(undefined1 *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) = 0;
      iVar8 = iResTechNow + 1;
      pcVar3 = PszGetCompressedString(idsUnusedD);
      _WSPRINTF((LPSTR)CONCAT22(iVar8,(char *)&DAT_1120_1120),
                (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
      HVar5 = GetDlgItem(hwnd,iResTechNow + 0x431);
      SetWindowText(HVar5,szWork);
      FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd + iResTechNow);
      uVar7 = gd._4_2_ & 0xffdf | 0x20;
      gd.field3_0x4 = (char)uVar7;
      gd.field4_0x5 = (char)(uVar7 >> 8);
      return 0;
    }
    if (wParam != 0x76) {
      return 0;
    }
    WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x452);
    return 1;
  }
  if (*(char *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) == '\0') {
    sVar6 = iResTechNow;
    pcVar3 = PszGetCompressedString(idsCustomD);
    _WSPRINTF((LPSTR)CONCAT22(sVar6,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
  }
  else {
    _strcpy((char *)szWork,
                    ((ZIPPRODQ *)vrgZipProd)[iResTechNow].szName);
  }
  puVar12 = (undefined *)&DAT_1120_1080;
  puVar11 = (undefined1 *)0x880;
  pcVar3 = (char *)hInst;
  pcVar10 = MakeProcInstance(RenameZipDlg,hInst);
  pcStack_34 = (char *)((ulong)pcVar10 >> 0x10);
  pszT_2 = (char *)pcVar10;
  if (iResTechNow != 0) {
    sVar6 = DialogBox(0,(LPCSTR)CONCAT22(0x7e3,hwndFrame),(HWND)pcStack_34,pszT_2);
    if (sVar6 == 0) goto LAB_10d0_5ce2;
    if (szWork[0] == '\0') {
      sVar6 = iResTechNow;
      pcVar3 = PszGetCompressedString(idsCustomD);
      _WSPRINTF((LPSTR)CONCAT22(sVar6,(char *)&DAT_1120_1120),
                (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
    }
    _strcpy(((ZIPPRODQ *)vrgZipProd)[iResTechNow].szName,
                    (char *)szWork);
    pcStack_3a = (char *)szWork + 0x40;
    psz_2 = (char *)szWork;
    pcVar3 = pcStack_3a;
    while (pcStack_3a = pcVar3, *psz_2 != '\0') {
      pcVar1 = psz_2 + 1;
      cVar2 = *psz_2;
      *pcStack_3a = cVar2;
      pcVar3 = pcStack_3a + 1;
      psz_2 = pcVar1;
      if (cVar2 == '&') {
        pcStack_3a[1] = '&';
        pcVar3 = pcStack_3a + 2;
      }
    }
    *pcStack_3a = '\0';
    puVar12 = (undefined *)GetDlgItem(hwnd,iResTechNow + 0x431);
    puVar11 = (undefined1 *)&DAT_1120_1120;
    pcVar3 = (char *)szWork + 0x40;
    SetWindowText((HWND)puVar12,szWork + 0x40);
    pcVar10 = (char *)CONCAT22(pcStack_34,pszT_2);
  }
  if (wParam == 0x816) {
    *(undefined1 *)((int)&vrgZipProd[0].fValid + iResTechNow * 0x28) = 1;
    cpq = 0;
    i = 0;
    while( true ) {
      pcStack_34 = (char *)((ulong)pcVar10 >> 0x10);
      pszT_2 = (char *)pcVar10;
      if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= i) break;
      uVar9 = __aFulshr((ulong)CONCAT22(puVar11,pcVar3),(ushort)puVar12);
      if ((((uint)uVar9 & 7) == 1) &&
         (uVar9 = __aFulshr((ulong)CONCAT22(puVar11,pcVar3),(ushort)puVar12),
         ((uint)uVar9 & 0x7f) < 7)) {
        uVar9 = __aFulshr((ulong)CONCAT22(puVar11,pcVar3),(ushort)puVar12);
        pcVar10 = (char *)CONCAT22(pcStack_34,pszT_2);
        *(uint *)(iResTechNow * 0x28 + 0x2306 + cpq * 2) =
             *(uint *)(iResTechNow * 0x28 + 0x2306 + cpq * 2) & 0xffc0 |
             (uint)uVar9 & 0x3f;
        *(uint *)(iResTechNow * 0x28 + 0x2306 + cpq * 2) =
             *(uint *)(iResTechNow * 0x28 + 0x2306 + cpq * 2) & 0x3f |
             ((PLPROD *)lpplProdGlob + i + 1)->wFlags << 6;
        cpq = cpq + 1;
        if (0xb < cpq) break;
      }
      pcVar10 = (char *)CONCAT22(pcStack_34,pszT_2);
      i = i + 1;
    }
    pcStack_34 = (char *)((ulong)pcVar10 >> 0x10);
    pszT_2 = (char *)pcVar10;
    *(undefined1 *)((int)&vrgZipProd[0].cpq + iResTechNow * 0x28) = (char)cpq;
    uVar9 = __aFulshr((ulong)CONCAT22(puVar11,pcVar3),(ushort)puVar12);
    *(byte *)((int)&vrgZipProd[0].field2_0xe + iResTechNow * 0x28) =
         (byte)uVar9 & 1;
    FillZipProdLB(hwnd,(ZIPPRODQ *)vrgZipProd + iResTechNow);
    pcVar10 = (char *)CONCAT22(pcStack_34,pszT_2);
  }
  pcStack_34 = (char *)((ulong)pcVar10 >> 0x10);
  pszT_2 = (char *)pcVar10;
  EnableZipProdBtns(hwnd,iResTechNow);
LAB_10d0_5ce2:
  FreeProcInstance((char *)CONCAT22(pcStack_34,pszT_2));
  SetFocus(hwnd);
  uVar7 = gd._4_2_ & 0xffdf | 0x20;
  gd.field3_0x4 = (char)uVar7;
  gd.field4_0x5 = (char)(uVar7 >> 8);
  return 0;
}



// ======================================================================
// Function: EnableZipProdBtns
// Address: 10d0:5df0
// Segment: MEMORY_PRODUCE
// ======================================================================


void EnableZipProdBtns(HWND hwnd,short iSel)

{
  BOOL BVar1;
  HWND HVar2;
  short fEnabled;
  
  if ((*(char *)((int)&vrgZipProd[0].fValid + iSel * 0x28) == '\0') || (iSel < 1)) {
    BVar1 = 0;
  }
  else {
    BVar1 = 1;
  }
  HVar2 = GetDlgItem(hwnd,0x817);
  EnableWindow(HVar2,BVar1);
  HVar2 = GetDlgItem(hwnd,0x41b);
  EnableWindow(HVar2,BVar1);
  return;
}



// ======================================================================
// Function: FillZipProdLB
// Address: 10d0:5e58
// Segment: MEMORY_PRODUCE
// ======================================================================


void FillZipProdLB(HWND hwndDlg,ZIPPRODQ *pzpq)

{
  HWND HVar1;
  char *pcVar2;
  char *unaff_SS;
  WPARAM WVar3;
  UINT UVar4;
  RECT rc;
  char szFormat [15];
  char szAuto [40];
  HWND hwndLB;
  short i;
  
  HVar1 = GetDlgItem(hwndDlg,0x417);
  GetClientRect(hwndDlg,(undefined2 *)CONCAT22(unaff_SS,&rc));
  rc.top = vyZPDStatic;
  rc.bottom = vyZPDStatic + dyArial8;
  InvalidateRect(hwndDlg,(undefined2 *)CONCAT22(unaff_SS,&rc),1);
  SendMessage(HVar1,0x405,0,0);
  if ((pzpq->fValid == 0) || (pzpq->cpq == 0)) {
    UVar4 = 0x401;
    WVar3 = 0;
    pcVar2 = PszGetCompressedString(idsAutoBuildOrders);
    SendMessage(HVar1,UVar4,WVar3,(LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar2));
  }
  else {
    CchGetString(idsSD2,szFormat);
    for (i = 0; i < (int)(uint)pzpq->cpq; i = i + 1) {
      CchGetString(((pzpq->rgpq + i)->w & 0x3fU) + idsMines,szAuto);
      if (((uint)(pzpq->rgpq + i)->w >> 6 == 1) || (((pzpq->rgpq + i)->w & 0x3fU) == 3)) {
        _strcpy((char *)szWork,szAuto);
      }
      else {
        _WSPRINTF((LPSTR)CONCAT22(szAuto,unaff_SS),(LPCSTR)CONCAT22(szFormat,(char *)&DAT_1120_1120)
                  ,(char *)szWork);
      }
      SendMessage(HVar1,0x401,0,0x112057a4);
    }
  }
  return;
}



