// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: ShipBuilder
// Address: 10c8:008c
// Segment: MEMORY_BUILD
// ======================================================================


short ShipBuilder(POINT ptDlgSize)

{
  SHDEF *pSVar1;
  FARPROC pvVar2;
  short fSuccess;
  
  ptslotGlob.x = ptDlgSize.x;
  ptslotGlob.y = ptDlgSize.y;
  if ((uint)gd.grBits >> 0xe != 0) {
    ptslotGlob.y = ptDlgSize.y + dyArial8 * 3;
  }
  fStarbaseMode = 0;
  lpshdefBuild = NthValidShdef(0);
  pvVar2 = MakeProcInstance(SlotDlg,hInst);
  DialogBox(0,(LPCSTR)CONCAT22(0x5c,hwndFrame),(HWND)((ulong)pvVar2 >> 0x10),(char)pvVar2)
  ;
  FreeProcInstance(pvVar2);
  pSVar1 = lpshdefBuild;
  if ((sel.grobj == grobjPlanet) &&
     (((PLPROD *)sel.pl.lpplprod != (PLPROD *)0x0 ||
      (sel.pl.lpplprod._2_2_ != 0)))) {
    FillPlanetProdLB
              (hwndPlanetProdLB,
               (PLPROD *)
               CONCAT22(sel.pl.lpplprod._2_2_,(PLPROD *)sel.pl.lpplprod),
               (PLANET *)0x0);
    pSVar1 = lpshdefBuild;
  }
  lpshdefBuild._2_2_ = (undefined2)((ulong)pSVar1 >> 0x10);
  lpshdefBuild._0_2_ = (SHDEF *)pSVar1;
  return 0;
}



// ======================================================================
// Function: ShowMainControls
// Address: 10c8:0160
// Segment: MEMORY_BUILD
// ======================================================================


void ShowMainControls(HWND hwnd,short sw)

{
  HWND HVar1;
  short sVar2;
  StringId ids;
  char *pcVar3;
  
  HVar1 = GetDlgItem(hwnd,0x816);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x818);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x817);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x810);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x811);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x812);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x813);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x814);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x815);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,1);
  if (sw == 5) {
    sVar2 = 0;
  }
  else {
    sVar2 = 5;
  }
  ShowWindow(HVar1,sVar2);
  sVar2 = 2;
  if (sw == 5) {
    ids = idsDone;
  }
  else {
    ids = idsCancel;
  }
  pcVar3 = PszGetCompressedString(ids);
  SetDlgItemText(hwnd,sVar2,pcVar3);
  return;
}



// ======================================================================
// Function: FCheckQueuedShip
// Address: 10c8:027c
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10c80310) */
/* WARNING: Removing unreachable block (ram,0x10c802b7) */
/* WARNING: Removing unreachable block (ram,0x10c804cc) */

short FCheckQueuedShip(HWND hwnd,SHDEF *lpshdef,short fEdit)

{
  short sVar1;
  undefined2 uVar2;
  char *pcVar3;
  HWND HVar4;
  SHDEF *pSVar5;
  undefined2 uVar6;
  undefined2 unaff_SS;
  char *pcVar7;
  undefined4 uVar8;
  undefined4 uVar9;
  undefined2 uVar10;
  char *pcVar11;
  undefined2 uVar12;
  short cshQueued;
  short ids;
  short id;
  short fProgress;
  char rgch [42];
  
  uVar6 = (undefined2)((ulong)lpshdef >> 0x10);
  pSVar5 = (SHDEF *)lpshdef;
  sVar1 = CshQueued(pSVar5->wFlags >> 10 & 0x1f,&fProgress,fEdit);
  if (((*(int *)((int)&pSVar5->cExist + 2) != 0) || ((int)pSVar5->cExist != 0)) || (sVar1 != 0)) {
    if (fEdit == 0) {
      if (fStarbaseMode == 0) {
        ids = 0x26b;
      }
      else {
        ids = 0x26e;
      }
    }
    else {
      ids = 0x270;
    }
    CchGetString(idsWorkDone,rgch);
    if (((*(int *)((int)&pSVar5->cExist + 2) == 0) && ((int)pSVar5->cExist == 0)) || (sVar1 == 0)) {
      if (sVar1 == 0) {
        if (((int)pSVar5->cExist == 1) && (*(int *)((int)&pSVar5->cExist + 2) == 0)) {
          uVar2 = 0xc8c;
        }
        else {
          uVar2 = 0xc8d;
        }
        uVar12 = 0x1120;
        uVar8 = CONCAT22((pSVar5->hul).szClass,(int)pSVar5->cExist);
        uVar10 = uVar6;
        pcVar3 = PszGetCompressedString
                           (ids + idsHistoryFileAppearsCorruptHistoricalDataWill);
        _wsprintf(szWork,pcVar3,uVar8,uVar10,uVar2,uVar12);
      }
      else {
        if (fProgress == 0) {
          pcVar3 = (char *)0xc88;
          unaff_SS = 0x1120;
        }
        else {
          pcVar3 = rgch;
        }
        if (sVar1 == 1) {
          uVar2 = 0xc89;
        }
        else {
          uVar2 = 0xc8a;
        }
        uVar10 = 0x1120;
        uVar9 = CONCAT22(uVar2,uVar6);
        uVar8 = CONCAT22((pSVar5->hul).szClass,sVar1);
        pcVar11 = PszGetCompressedString(ids + idsPlayerLogFileAppearsCorruptUnableLoad);
        _wsprintf(szWork,pcVar11,uVar8,uVar9,uVar10,pcVar3,unaff_SS);
      }
    }
    else {
      if (fProgress == 0) {
        pcVar3 = (char *)0xc84;
        unaff_SS = 0x1120;
      }
      else {
        pcVar3 = rgch;
      }
      if (((int)pSVar5->cExist == 1) && (*(int *)((int)&pSVar5->cExist + 2) == 0)) {
        uVar2 = 0xc85;
      }
      else {
        uVar2 = 0xc86;
      }
      uVar8 = uVar2;
      pcVar7 = (char *)CONCAT22(uVar6,(pSVar5->hul).szClass);
      uVar2 = (undefined2)pSVar5->cExist;
      pcVar11 = PszGetCompressedString(ids);
      _wsprintf(szWork,pcVar11,uVar2,pcVar7,uVar8,sVar1,pcVar3,unaff_SS);
    }
    HVar4 = GetFocus();
    uVar2 = 0x1120;
    pcVar11 = (char *)szWork;
    pcVar3 = PszGetCompressedString(fEdit + idsDeleteDesign);
    sVar1 = MessageBox(HVar4,(LPCSTR)CONCAT22(uVar2,pcVar11),pcVar3,0x2024);
    SetFocus(hwnd);
    if (sVar1 == 7) {
      return 0;
    }
    if ((*(int *)((int)&pSVar5->cExist + 2) == 0) && ((int)pSVar5->cExist == 0)) {
      RemoveIshdefFromAllQueues(pSVar5->wFlags >> 10 & 0x1f,fEdit);
    }
    else {
      DestroyAllIshdef(pSVar5->wFlags >> 10 & 0x1f,idPlayer);
      InvalidateRect(hwndScanner,(RECT *)0x0,1);
      InvalidateRect(hwndMessage,(RECT *)0x0,1);
    }
  }
  return 1;
}



// ======================================================================
// Function: SlotDlg
// Address: 10c8:0550
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10c819d8) */
/* WARNING: Removing unreachable block (ram,0x10c81f25) */
/* WARNING: Removing unreachable block (ram,0x10c81585) */
/* WARNING: Variable defined which should be unmapped: fProgress */
/* WARNING: Removing unreachable block (ram,0x10c8130f) */
/* WARNING: Removing unreachable block (ram,0x10c811cf) */
/* WARNING: Removing unreachable block (ram,0x10c81192) */
/* WARNING: Removing unreachable block (ram,0x10c812a2) */
/* WARNING: Removing unreachable block (ram,0x10c81c54) */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short SlotDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  uint *puVar1;
  char *pcVar2;
  SHDEF *pSVar3;
  SHDEF *pSVar4;
  HullDef *pHVar5;
  fn_lpfnRealListProc *pfVar6;
  long lVar7;
  char *pcVar8;
  BOOL BVar9;
  HWND HVar10;
  int iVar11;
  HULDEF *pHVar12;
  ushort uVar13;
  uint uVar14;
  HBRUSH HVar15;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  SHDEF *pSVar16;
  SHDEF *pSVar17;
  HullDef *pHVar18;
  undefined2 uVar19;
  undefined2 uVar20;
  undefined2 unaff_SS;
  bool bVar21;
  ulong uVar22;
  LRESULT LVar23;
  long lVar24;
  HULDEF *pHVar25;
  short sVar26;
  HullSlotType in_stack_0000ffa8;
  HullSlotType grbit;
  HullSlotType in_stack_0000ffaa;
  undefined2 in_stack_0000ffac;
  short fProgress;
  POINT pt;
  undefined8 rc;
  undefined4 lSel;
  short cch;
  HWND hwndItem;
  PAINTSTRUCT ps;
  short left;
  SHDEF *lpshdef;
  RECT rcGBox;
  HDC hdc;
  RECT rcWindow;
  
  if (message == WM_PAINT) {
    hdc = BeginPaint(hwnd,&ps);
    if (mdBuild != 4) {
      HVar10 = GetDlgItem(hwnd,0x810);
      GetWindowRect(HVar10,&rcGBox);
      ScreenToClient(hwnd,(POINT *)&rcGBox);
      HVar10 = GetDlgItem(hwnd,0x811);
      GetWindowRect(HVar10,&rc);
      ScreenToClient(hwnd,(POINT *)((int)&rc + 4));
      rcGBox.right = rc._4_2_;
      rcGBox.bottom = rc._6_2_;
      ExpandRc(&rcGBox,dyArial8,dyArial8 >> 1);
      _Draw3dFrame();
      SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SelectObject(hdc,rghfontArial8[1]);
      cch = CchGetString(idsDesign,(char *)szWork);
      TextOut(hdc,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,cch);
      SelectObject(hdc,rghfontArial8[0]);
      HVar10 = GetDlgItem(hwnd,0x812);
      GetWindowRect(HVar10,&rcGBox);
      ScreenToClient(hwnd,(POINT *)&rcGBox);
      HVar10 = GetDlgItem(hwnd,0x815);
      GetWindowRect(HVar10,&rc);
      ScreenToClient(hwnd,(POINT *)((int)&rc + 4));
      rcGBox.right = rc._4_2_;
      rcGBox.bottom = rc._6_2_;
      ExpandRc(&rcGBox,dyArial8,dyArial8 >> 1);
      _Draw3dFrame();
      SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SelectObject(hdc,rghfontArial8[1]);
      cch = CchGetString(idsView,(char *)szWork);
      TextOut(hdc,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,cch);
      SelectObject(hdc,rghfontArial8[0]);
    }
    GetClientRect(hwnd,&rc);
    DrawSlotDlg(hwnd,hdc,&rc,-1);
    DrawBuildSelComp(hwnd,hdc,-1);
    DrawBuildSelHull(hwnd,hdc,-1,(RECT *)0x0);
    EndPaint(hwnd,&ps);
    HVar15 = 1;
    pfVar6 = (fn_lpfnRealListProc *)
             CONCAT22(lpfnRealListProc._2_2_,
                      (fn_lpfnRealListProc *)lpfnRealListProc);
    goto LAB_10c8_2647;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    HVar15 = 1;
    pfVar6 = (fn_lpfnRealListProc *)
             CONCAT22(lpfnRealListProc._2_2_,
                      (fn_lpfnRealListProc *)lpfnRealListProc);
    goto LAB_10c8_2647;
  }
  if (message == WM_CTLCOLOR) {
    pt.y = 0x810;
    while (pt.y < 0x816) {
      pt.x = (HWND)lParam;
      HVar10 = GetDlgItem(hwnd,pt.y);
      if (pt.x == HVar10) break;
      pt.y = pt.y + 1;
    }
    if (0x815 < pt.y) {
      pt.x = (HWND)lParam;
      HVar10 = GetDlgItem(hwnd,0x40b);
      if (pt.x != HVar10) goto LAB_10c8_2641;
    }
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    HVar15 = hbrButtonFace;
    pfVar6 = (fn_lpfnRealListProc *)
             CONCAT22(lpfnRealListProc._2_2_,
                      (fn_lpfnRealListProc *)lpfnRealListProc);
    goto LAB_10c8_2647;
  }
  if (message == WM_SETCURSOR) {
    GetCursorPos(&pt);
    ScreenToClient(hwnd,&pt);
    BVar9 = PtInRect(rgrcBuildSpin,pt);
    if ((BVar9 != 0) || (BVar9 = PtInRect(rgrcBuildSpin + 1,pt), BVar9 != 0)) {
      setcursor(hcurHand);
      HVar15 = 1;
      pfVar6 = (fn_lpfnRealListProc *)
               CONCAT22(lpfnRealListProc._2_2_,
                        (fn_lpfnRealListProc *)lpfnRealListProc);
      goto LAB_10c8_2647;
    }
    goto LAB_10c8_2641;
  }
  if (message == WM_DRAWITEM) {
    pt = (POINT)lParam;
    if (*(int *)((HWND)lParam + 4) == -1) {
      HandleFocusState((DRAWITEMSTRUCT *)lParam,-2);
    }
    else {
      iVar11 = *(int *)((HWND)lParam + 6);
      if (iVar11 == 1) {
        DrawDlgLBEntireItem((DRAWITEMSTRUCT *)lParam,-4);
      }
      else if (iVar11 == 2) {
        DrawDlgLBEntireItem((DRAWITEMSTRUCT *)lParam,-4);
      }
      else if (iVar11 == 4) {
        DrawDlgLBEntireItem((DRAWITEMSTRUCT *)lParam,-4);
      }
    }
    HVar15 = 1;
    pfVar6 = (fn_lpfnRealListProc *)
             CONCAT22(lpfnRealListProc._2_2_,
                      (fn_lpfnRealListProc *)lpfnRealListProc);
    goto LAB_10c8_2647;
  }
  if (message == WM_MEASUREITEM) {
    *(undefined2 *)((HWND)lParam + 8) = 0x42;
    HVar15 = 1;
    pfVar6 = (fn_lpfnRealListProc *)
             CONCAT22(lpfnRealListProc._2_2_,
                      (fn_lpfnRealListProc *)lpfnRealListProc);
    goto LAB_10c8_2647;
  }
  if (message == WM_INITDIALOG) {
    fHullCopy = 0;
    hwndSlotDlg = hwnd;
    GetWindowRect(hwnd,&rcWindow);
    GetClientRect(hwnd,&rc);
    SetWindowPos(hwnd,0,0,0,((ptslotGlob.x + rcWindow.right) - rcWindow.left) - rc._4_2_,
                 ((ptslotGlob.y + rcWindow.bottom) - rcWindow.top) - rc._6_2_,6);
    StickyDlgPos(hwnd,(POINT *)&ptStickySlotDlg,1);
    UpdateSlotGlobals();
    hwndItem = GetDlgItem(hwnd,0x80c);
    SetWindowPos(hwndItem,0,ptslotGlob.x + -0x100,0x20,0xf0,0x10a,4);
    FillBuildPartsLB(hwndItem,rggrbitParts[0]);
    yBuildInfoSum = 0x154;
    lpfnRealListProc = (fn_lpfnRealListProc *)GetWindowLong(hwndItem,-4);
    SetWindowLong(hwndItem,-4,
                  (long)CONCAT22(lpfnFakeListProc._2_2_,
                                 (fn_lpfnFakeListProc *)lpfnFakeListProc));
    CheckRadioButton(hwnd,0x810,0x811,0x810);
    CheckRadioButton(hwnd,0x812,0x815,0x812);
    mdBuild = 0;
    hwndItem = GetDlgItem(hwnd,0x81a);
    SetWindowPos(hwndItem,0,ptslotGlob.x + -0x108,8,0xf0,100,4);
    FillBuildDD(hwndItem,mdBuild);
    HVar10 = GetDlgItem(hwnd,1);
    SetWindowPos(HVar10,0,ptslotGlob.x + -0xe2,
                 (ptslotGlob.y - (dyArial8 * 3) / 2) + -6,0x44,
                 (dyArial8 * 3) / 2,0x84);
    HVar10 = GetDlgItem(hwnd,2);
    SetWindowPos(HVar10,0,ptslotGlob.x + -0x94,
                 (ptslotGlob.y - (dyArial8 * 3) / 2) + -6,0x44,
                 (dyArial8 * 3) / 2,4);
    HVar10 = GetDlgItem(hwnd,0x76);
    SetWindowPos(HVar10,0,ptslotGlob.x + -0x4a,
                 (ptslotGlob.y - (dyArial8 * 3) / 2) + -6,0x44,
                 (dyArial8 * 3) / 2,4);
    sVar26 = 2;
    pcVar8 = PszGetCompressedString(idsDone);
    SetDlgItemText(hwnd,sVar26,pcVar8);
    if (((uint)gd.grBits >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    HVar15 = 1;
    pfVar6 = lpfnRealListProc;
    goto LAB_10c8_2647;
  }
  if (message != WM_COMMAND) {
    if (((message == WM_LBUTTONDOWN) || (message == WM_LBUTTONDBLCLK)) ||
       (message == WM_RBUTTONDOWN)) {
      uVar14 = (uint)(message == WM_RBUTTONDOWN);
      sVar26 = 0;
      uVar22 = __aFulshr((ulong)wParam,uVar14);
      HVar15 = FTrackSlot(hwnd,(HWND)lParam,(short)uVar22,wParam,sVar26,uVar14);
      pfVar6 = (fn_lpfnRealListProc *)
               CONCAT22(lpfnRealListProc._2_2_,
                        (fn_lpfnRealListProc *)lpfnRealListProc);
      goto LAB_10c8_2647;
    }
    goto LAB_10c8_2641;
  }
  uVar22 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa8);
  if ((((int)uVar22 == 0) && (0x80f < wParam)) && (wParam < 0x812)) {
    fStarbaseMode = wParam - 0x810;
    GetClientRect(hwnd,&rc);
    rc._0_2_ = rc._4_2_ >> 1;
    if (rc._4_2_ + -0x160 <= (int)rc) {
      rc._0_2_ = rc._4_2_ + -0x160;
    }
    InvalidateRect(hwnd,&rc,1);
    lpshdefBuild = (SHDEF *)0x0;
    fHullCopy = 0;
    uVar13 = rggrbitPartsSB[0];
    if (fStarbaseMode == 0) {
      uVar13 = rggrbitParts[0];
    }
    lSel._2_2_ = 0;
    lSel._0_2_ = uVar13;
    HVar10 = GetDlgItem(hwnd,0x80c);
    FillBuildPartsLB(HVar10,uVar13);
    hwndItem = GetDlgItem(hwnd,0x81a);
    FillBuildDD(hwndItem,mdBuild);
    SendMessage(hwndItem,0x40e,0,0);
BUILD_FixupShip:
    hwndItem = GetDlgItem(hwnd,0x81a);
    LVar23 = SendMessage(hwndItem,0x407,0,0);
    lSel = LVar23;
    if ((mdBuild == 3) || (mdBuild == 4)) {
      if (LVar23 == -1) {
        lSel._0_2_ = ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|
                       hstMines|hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|
                      hstEngine);
      }
      else if (fStarbaseMode == 0) {
        lVar24 = __aFlshl(CONCAT22(in_stack_0000ffac,in_stack_0000ffaa),fProgress);
        lSel._0_2_ = *(HullSlotType *)((int)lVar24 + 0x38);
      }
      else {
        lVar24 = __aFlshl(CONCAT22(in_stack_0000ffac,in_stack_0000ffaa),fProgress);
        lSel._0_2_ = *(HullSlotType *)((int)lVar24 + 0x6c);
      }
      lSel._2_2_ = 0;
      grbit = (HullSlotType)lSel;
      HVar10 = GetDlgItem(hwnd,0x80c);
      FillBuildPartsLB(HVar10,grbit);
      LVar23 = CONCAT22(lSel._2_2_,(HullSlotType)lSel);
    }
    else if (((mdBuild == 0) || (mdBuild == 1)) || (mdBuild == 2)) {
      if (LVar23 != -1) {
        if (mdBuild == 0) {
          if (fStarbaseMode == 0) {
LAB_10c8_110d:
            sVar26 = 0;
            lSel = LVar23;
          }
          else {
            sVar26 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
            LVar23 = lSel;
            if (sVar26 != raMacintosh) goto LAB_10c8_110d;
            sVar26 = 1;
          }
          pt.x = sVar26;
          lpshdefBuild = NthValidShdef((HullSlotType)lSel);
          CshQueued(((SHDEF *)lpshdefBuild)->wFlags >> 10 & 0x1f,&fProgress,0);
          HVar10 = GetDlgItem(hwndSlotDlg,0x818);
          uVar19 = (undefined2)((ulong)lpshdefBuild >> 0x10);
          if ((((int)((SHDEF *)lpshdefBuild)->cExist == 0) &&
              (*(int *)((int)&((SHDEF *)lpshdefBuild)->cExist + 2) == 0)) &&
             ((fProgress == 0 && ((pt.x == 0 || (0 < lSel)))))) {
            BVar9 = 1;
          }
          else {
            BVar9 = 0;
          }
          EnableWindow(HVar10,BVar9);
          LVar23 = lSel;
          if (pt.x != 0) {
            HVar10 = GetDlgItem(hwndSlotDlg,0x817);
            if (lSel < 1) {
LAB_10c8_11f8:
              BVar9 = 0;
            }
            else {
              uVar19 = (undefined2)((ulong)lpshdefBuild >> 0x10);
              if (((int)((SHDEF *)lpshdefBuild)->cExist != 0) ||
                 (*(int *)((int)&((SHDEF *)lpshdefBuild)->cExist + 2) != 0))
              goto LAB_10c8_11f8;
              BVar9 = 1;
            }
            EnableWindow(HVar10,BVar9);
            LVar23 = lSel;
          }
        }
        else if (mdBuild == 2) {
          lpshdefBuild = NthValidEnemyShdef((short)LVar23);
          LVar23 = lSel;
          if ((((SHDEF *)lpshdefBuild)->wFlags & 0xff) != 7) {
            pt.y = (lpshdefBuild->hul).ihuldef;
          }
        }
        else {
          if (fStarbaseMode == 0) {
            pt = (POINT)((ulong)pt & 0xffff);
            while (pt.y < 0x20) {
              lSel = LVar23;
              sVar26 = FLookupPart(&stack0xffaa);
              LVar23 = lSel;
              if ((sVar26 == 1) &&
                 (LVar23 = CONCAT22(lSel._2_2_ - (uint)((HullSlotType)lSel == 0),
                                    (HullSlotType)lSel + -1), lSel < 1)) break;
              pt.y = pt.y + 1;
            }
          }
          else {
            pt = (POINT)((ulong)pt & 0xffff);
            while (pt.y < 5) {
              lSel = LVar23;
              sVar26 = FLookupPart(&stack0xffaa);
              LVar23 = lSel;
              if ((sVar26 == 1) &&
                 (LVar23 = CONCAT22(lSel._2_2_ - (uint)((HullSlotType)lSel == 0),
                                    (HullSlotType)lSel + -1), lSel < 1)) break;
              pt.y = pt.y + 1;
            }
            pt.y = pt.y + 0x20;
          }
          lSel = LVar23;
          pHVar25 = LphuldefFromId(pt.y);
          uVar19 = (undefined2)((ulong)pHVar25 >> 0x10);
          pHVar12 = (HULDEF *)pHVar25;
          pSVar16 = (SHDEF *)&shdefBuild;
          for (iVar11 = 0x3d; iVar11 != 0; iVar11 = iVar11 + -1) {
            pSVar3 = pSVar16;
            pSVar16 = (pSVar16->hul).rgTech;
            pHVar25 = pHVar12;
            pHVar12 = (pHVar12->hul).rgTech;
            (pSVar3->hul).ihuldef = (pHVar25->hul).ihuldef;
          }
          *&(pSVar16->hul).ihuldef = (char)(pHVar12->hul).ihuldef;
          shdefBuild.hul.ihuldef = pt.y & 0xff;
          pt = (POINT)((ulong)pt & 0xffff);
          while (pt.y < (int)(uint)shdefBuild.hul.chs) {
            *(uint *)((int)&shdefBuild.hul + 0x3c + pt.y * 4) =
                 *(uint *)((int)&shdefBuild.hul + 0x3c + pt.y * 4) & 0xff;
            pt.y = pt.y + 1;
          }
                    /* WARNING: Ignoring partial resolution of indirect */
                    /* WARNING: Ignoring partial resolution of indirect */
          lpshdefBuild._2_2_ = 0x1120;
          UpdateShdefCost(&shdefBuild);
          LVar23 = lSel;
        }
      }
      lSel = LVar23;
      UpdateSlotGlobals();
      GetClientRect(hwnd,&rc);
      rc._0_2_ = rc._4_2_ >> 1;
      if (rc._4_2_ + -0x160 <= (int)rc) {
        rc._0_2_ = rc._4_2_ + -0x160;
      }
      InvalidateRect(hwnd,&rc,1);
      LVar23 = lSel;
    }
    lSel = LVar23;
    SetBuildSelection(-2);
    DrawBuildSelHull(hwnd,0,-1,(RECT *)0x0);
    if (((SHDEF *)lpshdefBuild == (SHDEF *)0x0) && (lpshdefBuild._2_2_ == 0)) {
      HVar10 = GetDlgItem(hwndSlotDlg,0x817);
      EnableWindow(HVar10,0);
      HVar10 = GetDlgItem(hwndSlotDlg,0x818);
      EnableWindow(HVar10,0);
      HVar10 = GetDlgItem(hwndSlotDlg,0x816);
      EnableWindow(HVar10,0);
    }
    if (((uint)gd.grBits >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
  }
  else {
    uVar22 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa8);
    if ((((int)uVar22 == 0) && (0x811 < wParam)) && (wParam < 0x816)) {
      lSel = 0;
BUILD_LRestart:
      lpshdefBuild = (SHDEF *)0x0;
      fHullCopy = 0;
      mdBuild = wParam - 0x812;
      hwndItem = GetDlgItem(hwnd,0x81a);
      UpdateSlotGlobals();
      FillBuildDD(hwndItem,mdBuild);
      SendMessage(hwndItem,0x40e,(HullSlotType)lSel,0);
      if (wParam == 0x815) {
        iVar11 = 0;
      }
      else {
        iVar11 = 8;
      }
      SetWindowPos(hwndItem,0,(ptslotGlob.x + -0x100) - iVar11,8,0,0,5);
      GetClientRect(hwnd,&rc);
      left = (int)rc;
      rc._0_2_ = rc._4_2_ >> 1;
      if (rc._4_2_ + -0x160 <= (int)rc) {
        rc._0_2_ = rc._4_2_ + -0x160;
      }
      InvalidateRect(hwnd,&rc,1);
      rc._4_2_ = (int)rc;
      rc._0_2_ = left;
      rc._2_2_ = yBuildInfoSum;
      InvalidateRect(hwnd,&rc,1);
      hwndItem = GetDlgItem(hwnd,0x80c);
      if (mdBuild == 3) {
        sVar26 = 5;
      }
      else {
        sVar26 = 0;
      }
      ShowWindow(hwndItem,sVar26);
      if (wParam != 0x815) goto BUILD_FixupShip;
      if (((uint)gd.grBits >> 0xb & 1) != 0) {
        AdvanceTutor();
      }
    }
    else if (((wParam == 0x81b) &&
             (uVar22 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa8),
             (int)uVar22 == 0x400)) && (fInEditUpdate == 0)) {
      fInEditUpdate = 1;
      GetWindowText((HWND)lParam,szWork,0xfa);
      lSel = SendMessage((HWND)lParam,0x400,0,0);
      sVar26 = FStringFitsScreen(szWork,0xa0);
      if (sVar26 == 0) {
        SetWindowText((HWND)lParam,szWork);
        SendMessage((HWND)lParam,0x401,0,lSel);
      }
      lstrcpy((LPSTR)CONCAT22((int)((ulong)lpshdefBuild >> 0x10),
                              (((SHDEF *)lpshdefBuild)->hul).szClass),szWork);
      DrawBuildSelHull(hwnd,0,0x100,(RECT *)0x0);
      fInEditUpdate = 0;
      if (((uint)gd.grBits >> 0xb & 1) != 0) {
        AdvanceTutor();
      }
    }
    else if (wParam == 0x81a) {
      uVar22 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa8);
      if ((int)uVar22 == 1) goto BUILD_FixupShip;
    }
    else if (wParam == 0x80c) {
      uVar22 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa8);
      if ((int)uVar22 == 1) {
        SetBuildSelection(-1);
      }
    }
    else if (wParam == 0x817) {
      uVar22 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa8);
      if (((int)uVar22 == 0) &&
         ((pt.x = 0, pt.y = 0, ((uint)gd.grBits >> 0xb & 1) == 0 ||
          (sVar26 = FTutorialEnabledShipBuilder(0), sVar26 != 0)))) {
        hwndItem = GetDlgItem(hwnd,0x81a);
        lSel = SendMessage(hwndItem,0x407,0,0);
        lpshdef = NthValidShdef((short)lSel);
        if ((-1 < lSel) &&
           (((SHDEF *)lpshdef != (SHDEF *)0x0 || ((int)((ulong)lpshdef >> 0x10) != 0)))) {
          if ((fStarbaseMode != 0) && (lSel == 0)) {
            sVar26 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
            if (sVar26 == raMacintosh) goto LAB_10c8_2641;
          }
          sVar26 = FCheckQueuedShip(hwnd,lpshdef,0);
          if (sVar26 != 0) {
            uVar19 = (undefined2)((ulong)lpshdef >> 0x10);
            pSVar16 = (SHDEF *)lpshdef;
            pSVar16->wFlags = pSVar16->wFlags & 0xfdff | 0x200;
            *(undefined2 *)&pSVar16->cBuilt = 0;
            *(undefined2 *)((int)&pSVar16->cBuilt + 2) = 0;
            *(undefined2 *)&pSVar16->cExist = 0;
            *(undefined2 *)((int)&pSVar16->cExist + 2) = 0;
            if (fStarbaseMode == 0) {
              pcVar2 = (char *)((int)&rgplr[0].cShDef + idPlayer * 0xc0);
              *pcVar2 = *pcVar2 + -1;
            }
            else {
              fProgress = *(int *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0) -
                          0x1000U & 0xf000;
              puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0);
              *puVar1 = *puVar1 & 0xfff;
              puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0);
              *puVar1 = *puVar1 | fProgress;
            }
            LogChangeShDef(lpshdef);
            FillBuildDD(hwndItem,mdBuild);
            lpshdefBuild = NthValidShdef(0);
            if (fStarbaseMode == 0) {
LAB_10c8_16eb:
              if (((SHDEF *)lpshdefBuild == (SHDEF *)0x0) &&
                 (lpshdefBuild._2_2_ == 0)) goto LAB_10c8_16ff;
            }
            else {
              sVar26 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
              if (sVar26 != raMacintosh) goto LAB_10c8_16eb;
LAB_10c8_16ff:
              HVar10 = GetDlgItem(hwndSlotDlg,0x817);
              EnableWindow(HVar10,0);
              HVar10 = GetDlgItem(hwndSlotDlg,0x818);
              EnableWindow(HVar10,0);
              if (((SHDEF *)lpshdefBuild == (SHDEF *)0x0) &&
                 (lpshdefBuild._2_2_ == 0)) {
                HVar10 = GetDlgItem(hwndSlotDlg,0x816);
                EnableWindow(HVar10,0);
              }
            }
            UpdateSlotGlobals();
            GetClientRect(hwnd,&rc);
            rc._0_2_ = rc._4_2_ >> 1;
            if (rc._4_2_ + -0x160 <= (int)rc) {
              rc._0_2_ = rc._4_2_ + -0x160;
            }
            InvalidateRect(hwnd,&rc,1);
            if (fHullCopy != 0) goto BUILD_LRestart;
          }
        }
      }
    }
    else if (wParam == 0x816) {
      uVar22 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa8);
      if ((int)uVar22 == 0) {
        if ((((uint)gd.grBits >> 0xb & 1) == 0) ||
           (sVar26 = FTutorialEnabledShipBuilder(1), sVar26 != 0)) {
          hwndItem = GetDlgItem(hwnd,0x81a);
          lVar24 = SendMessage(hwndItem,0x407,0,0);
          if ((0xffff < lVar24) || (-1 < lVar24)) {
            if (fStarbaseMode == 0) {
              pt = (POINT)((ulong)pt & 0xffff);
              while ((pt.y < 0x10 &&
                     ((*(uint *)((int)&rgshdef[0].wFlags + pt.y * 0x93) >> 9 & 1) == 0)))
              {
                pt.y = pt.y + 1;
              }
            }
            else {
              pt = (POINT)((ulong)pt & 0xffff);
              while ((pt.y < 10 &&
                     ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + pt.y * 0x93 + 0x7b) >> 9 &
                      1) == 0))) {
                pt.y = pt.y + 1;
              }
            }
            if ((mdBuild != 0) && (mdBuild != 2)) {
              pt = (POINT)((ulong)pt & 0xffff0000);
              while( true ) {
                if (fStarbaseMode == 0) {
                  iVar11 = 0x20;
                }
                else {
                  iVar11 = 5;
                }
                if (iVar11 <= pt.x) break;
                lSel = lVar24;
                sVar26 = FLookupPart(&stack0xffa8);
                lVar7 = lSel;
                if (sVar26 == 1) {
                  iVar11 = lSel._2_2_ - (uint)((HullSlotType)lSel == 0);
                  lVar24 = CONCAT22(iVar11,(HullSlotType)lSel + -1);
                  lVar7 = CONCAT22(iVar11,(HullSlotType)lSel + -1);
                  if (lSel < 1) break;
                }
                lVar24 = lVar7;
                pt.x = pt.x + 1;
              }
              if (fStarbaseMode == 0) {
                lpshdef = (SHDEF *)(pt.y * 0x93 + 0x3f00);
              }
              else {
                lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x14e),
                                            (SHDEF *)(*(int *)(idPlayer * 4 + 0x14c) +
                                                     pt.y * 0x93));
                pt.x = pt.x + 0x20;
              }
              lSel = lVar24;
              __fmemset(lpshdef,0,0x93);
              pHVar25 = LphuldefFromId(pt.x);
              uVar19 = (undefined2)((ulong)pHVar25 >> 0x10);
              pHVar12 = (HULDEF *)pHVar25;
              uVar20 = (undefined2)((ulong)lpshdef >> 0x10);
              pSVar17 = (SHDEF *)lpshdef;
              pSVar16 = pSVar17;
              for (iVar11 = 0x3d; iVar11 != 0; iVar11 = iVar11 + -1) {
                pSVar3 = pSVar16;
                pSVar16 = (pSVar16->hul).rgTech;
                pHVar25 = pHVar12;
                pHVar12 = (pHVar12->hul).rgTech;
                (pSVar3->hul).ihuldef = (pHVar25->hul).ihuldef;
              }
              *&(pSVar16->hul).ihuldef = (char)(pHVar12->hul).ihuldef;
              pSVar17->wFlags = pSVar17->wFlags & 0xff00 | 7;
              __fmemset((HS *)CONCAT22(uVar20,(pSVar17->hul).rghs),0,0x40);
LAB_10c8_1d0f:
              CheckRadioButton(hwnd,0x812,0x815,0x812);
              uVar19 = (undefined2)((ulong)lpshdef >> 0x10);
              pSVar16 = (SHDEF *)lpshdef;
              pSVar16->turn = game.turn;
              if (fStarbaseMode == 0) {
                iVar11 = 0;
              }
              else {
                iVar11 = 0x10;
              }
              pt.x = iVar11 + pt.y;
              pSVar16->wFlags = pSVar16->wFlags & 0x83ff | (iVar11 + pt.y & 0x1fU) << 10;
              UpdateShdefCost(lpshdef);
              if (fStarbaseMode == 0) {
                pcVar2 = (char *)((int)&rgplr[0].cShDef + idPlayer * 0xc0);
                *pcVar2 = *pcVar2 + '\x01';
              }
              else {
                pt = (POINT)(CONCAT22(pt.y,*(int *)((int)&rgplr[0].wFlags_0x4 +
                                                   idPlayer * 0xc0) + 0x1000) & 0xfffff000);
                puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0);
                *puVar1 = *puVar1 & 0xfff;
                puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0);
                *puVar1 = *puVar1 | pt.x;
              }
              LogChangeShDef(lpshdef);
              FillBuildDD(hwndItem,mdBuild);
              SendMessage(hwndItem,0x40e,pt.y,0);
              HVar10 = GetDlgItem(hwndSlotDlg,0x818);
              EnableWindow(HVar10,1);
                    /* WARNING: Ignoring partial resolution of indirect */
              lpshdefBuild._0_2_ = (SHDEF *)lpshdef;
                    /* WARNING: Ignoring partial resolution of indirect */
              lpshdefBuild._2_2_ = lpshdef._2_2_;
              UpdateSlotGlobals();
              fHullCopy = 1;
              goto BUILD_EditDesign;
            }
            lSel = lVar24;
            if (mdBuild == 0) {
              lpshdef = NthValidShdef((short)lVar24);
              if ((int)((SHDEF *)lpshdef)->wFlags < 0) goto BUILD_LStripDown;
            }
            else {
              lpshdef = NthValidEnemyShdef((short)lVar24);
BUILD_LStripDown:
              sVar26 = FLookupPart(&stack0xffaa);
              if (sVar26 != 1) {
                sVar26 = 0x10;
                pcVar8 = PszFormatIds(idsCantCopyShipDesignBecauseCantBuild,(short *)0x0);
                AlertSz(pcVar8,sVar26);
                goto LAB_10c8_2641;
              }
            }
            if (-1 < lSel) {
              if (((SHDEF *)lpshdef != (SHDEF *)0x0) || (lpshdef._2_2_ != 0)) {
                if (fStarbaseMode == 0) {
                  pHVar18 = (HullDef *)(pt.y * 0x93 + 0x3f00);
                  for (iVar11 = 0x49; iVar11 != 0; iVar11 = iVar11 + -1) {
                    pHVar5 = pHVar18;
                    pHVar18 = pHVar18 + 1;
                    pSVar3 = (SHDEF *)lpshdef;
                    lpshdef._0_2_ = (((SHDEF *)lpshdef)->hul).rgTech;
                    *pHVar5 = (pSVar3->hul).ihuldef;
                  }
                  *(char *)pHVar18 = (char)(((SHDEF *)lpshdef)->hul).ihuldef;
                  lpshdef = (SHDEF *)(pt.y * 0x93 + 0x3f00);
                }
                else {
                  uVar19 = *(undefined2 *)(idPlayer * 4 + 0x14e);
                  pHVar18 = (HullDef *)(*(int *)(idPlayer * 4 + 0x14c) + pt.y * 0x93);
                  for (iVar11 = 0x49; iVar11 != 0; iVar11 = iVar11 + -1) {
                    pHVar5 = pHVar18;
                    pHVar18 = pHVar18 + 1;
                    pSVar3 = (SHDEF *)lpshdef;
                    lpshdef._0_2_ = (((SHDEF *)lpshdef)->hul).rgTech;
                    *pHVar5 = (pSVar3->hul).ihuldef;
                  }
                  *(char *)pHVar18 = (char)(((SHDEF *)lpshdef)->hul).ihuldef;
                  pt.x = pt.y * 0x93;
                  lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x14e),
                                              (SHDEF *)(*(int *)(idPlayer * 4 + 0x14c) +
                                                       pt.y * 0x93));
                }
                uVar19 = (undefined2)((ulong)lpshdef >> 0x10);
                pSVar16 = (SHDEF *)lpshdef;
                *(undefined2 *)&pSVar16->cExist = 0;
                *(undefined2 *)((int)&pSVar16->cExist + 2) = 0;
                *(undefined2 *)&pSVar16->cBuilt = 0;
                *(undefined2 *)((int)&pSVar16->cBuilt + 2) = 0;
                if ((mdBuild == 0) && (-1 < (int)pSVar16->wFlags)) {
                  MakeNewName((char *)CONCAT22(uVar19,(pSVar16->hul).szClass));
                }
                else {
                  pSVar16->wFlags = pSVar16->wFlags & 0x7fff;
                  pt = (POINT)((ulong)pt & 0xffff0000);
                  while( true ) {
                    uVar19 = (undefined2)((ulong)lpshdef >> 0x10);
                    if ((int)(uint)(((SHDEF *)lpshdef)->hul).chs <= pt.x) break;
                    if ((((SHDEF *)lpshdef)->hul).rghs[pt.x].wFlags_0x2 >> 8 != 0) {
                      sVar26 = FLookupPart(&stack0xffa8);
                      if (sVar26 != 1) {
                        (((SHDEF *)lpshdef)->hul).rghs[pt.x].wFlags_0x2 =
                             (((SHDEF *)lpshdef)->hul).rghs[pt.x].wFlags_0x2 & 0xff;
                      }
                    }
                    pt.x = pt.x + 1;
                  }
                }
                goto LAB_10c8_1d0f;
              }
            }
          }
        }
      }
      else if (((uint)gd.grBits >> 0xb & 1) != 0) {
        AdvanceTutor();
      }
    }
    else if (wParam == 0x818) {
      if (((((uint)gd.grBits >> 0xb & 1) == 0) ||
          (sVar26 = FTutorialEnabledShipBuilder(2), sVar26 != 0)) &&
         ((fStarbaseMode == 0 ||
          (((((SHDEF *)lpshdefBuild)->wFlags >> 10 & 0x1f) != 0x10 ||
           (sVar26 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
           sVar26 != raMacintosh)))))) {
        hwndItem = GetDlgItem(hwnd,0x81a);
        lSel = SendMessage(hwndItem,0x407,0,0);
        lpshdef = NthValidShdef((short)lSel);
        if ((-1 < lSel) &&
           (((SHDEF *)lpshdef != (SHDEF *)0x0 || ((int)((ulong)lpshdef >> 0x10) != 0)))) {
          if (fStarbaseMode == 0) {
            sVar26 = FCheckQueuedShip(hwnd,lpshdef,1);
            if (sVar26 == 0) goto LAB_10c8_2641;
          }
BUILD_EditDesign:
          if (((SHDEF *)lpshdefBuild != (SHDEF *)0x0) ||
             (lpshdefBuild._2_2_ != 0)) {
            InvalidateRect(hwnd,(RECT *)0x0,1);
            mdBuild = 4;
            uVar19 = (undefined2)((ulong)lpshdefBuild >> 0x10);
            pSVar16 = (SHDEF *)lpshdefBuild;
            ishdefBuild = pSVar16->wFlags >> 10 & 0x1f;
            pSVar17 = (SHDEF *)&shdefBuild;
            for (iVar11 = 0x49; iVar11 != 0; iVar11 = iVar11 + -1) {
              pSVar4 = pSVar17;
              pSVar17 = (pSVar17->hul).rgTech;
              pSVar3 = pSVar16;
              pSVar16 = (pSVar16->hul).rgTech;
              (pSVar4->hul).ihuldef = (pSVar3->hul).ihuldef;
            }
            *&(pSVar17->hul).ihuldef = (char)(pSVar16->hul).ihuldef;
                    /* WARNING: Ignoring partial resolution of indirect */
                    /* WARNING: Ignoring partial resolution of indirect */
            lpshdefBuild._2_2_ = 0x1120;
            if (fStarbaseMode == 0) {
              sVar26 = 0x19ff;
            }
            else {
              sVar26 = 0xa3c;
            }
            HVar10 = GetDlgItem(hwnd,0x80c);
            FillBuildPartsLB(HVar10,sVar26);
            sVar26 = mdBuild;
            HVar10 = GetDlgItem(hwnd,0x81a);
            FillBuildDD(HVar10,sVar26);
            ShowMainControls(hwnd,0);
            HVar10 = GetDlgItem(hwnd,0x80c);
            SetWindowPos(HVar10,0,0x10,0x20,0,0,0x45);
            HVar10 = GetDlgItem(hwnd,0x81a);
            SetWindowPos(HVar10,0,0x10,8,0,0,0x45);
            HVar10 = GetDlgItem(hwnd,0x81b);
            SetWindowPos(HVar10,0,ptslotGlob.x + -0x108,8,0xf0,dyArial8 * 3 >> 1
                         ,0x44);
            HVar10 = GetDlgItem(hwnd,0x81b);
            SetWindowText(HVar10,shdefBuild.hul.szClass);
            HVar10 = GetDlgItem(hwnd,0x81b);
            SendMessage(HVar10,0x415,0x1f,0);
            if (((uint)gd.grBits >> 0xb & 1) != 0) {
              AdvanceTutor();
            }
          }
        }
      }
    }
    else if ((wParam == 1) || (wParam == 2)) {
      if (mdBuild != 4) {
        SetBuildSelection(-2);
        StickyDlgPos(hwnd,(POINT *)&ptStickySlotDlg,0);
        hwndSlotDlg = 0;
        EndDialog(hwnd,(uint)(wParam == 1));
        if (((uint)gd.grBits >> 0xb & 1) != 0) {
          AdvanceTutor();
        }
        pfVar6 = (fn_lpfnRealListProc *)
                 CONCAT22(lpfnRealListProc._2_2_,
                          (fn_lpfnRealListProc *)lpfnRealListProc);
        HVar15 = 1;
        goto LAB_10c8_2647;
      }
      lSel._0_2_ = 0;
      lSel._2_2_ = 0;
      if (wParam == 1) {
        if ((fStarbaseMode == 0) &&
           (shdefBuild.hul.rghs[0].wFlags_0x2 >> 8 == 0)) {
          sVar26 = 0x10;
          pcVar8 = PszFormatIds(idsShipDesignDoesHaveAnyEnginesMust,(short *)0x0);
          AlertSz(pcVar8,sVar26);
          pfVar6 = (fn_lpfnRealListProc *)
                   CONCAT22(lpfnRealListProc._2_2_,
                            (fn_lpfnRealListProc *)lpfnRealListProc);
          HVar15 = 0;
          goto LAB_10c8_2647;
        }
        if ((((uint)gd.grBits >> 0xb & 1) == 0) ||
           (sVar26 = FTutorialEnabledShipBuilder(3), sVar26 != 0)) {
          HVar10 = GetDlgItem(hwnd,0x81b);
          GetWindowText(HVar10,shdefBuild.hul.szClass,0x20);
          shdefBuild.cBuilt._0_2_ = 0;
          shdefBuild.cBuilt._2_2_ = 0;
          shdefBuild.cExist._0_2_ = 0;
          shdefBuild.cExist._2_2_ = 0;
          shdefBuild.wFlags = shdefBuild.wFlags & 0xfdff;
          UpdateShdefCost(&shdefBuild);
          if (fStarbaseMode == 0) {
            pHVar18 = (HullDef *)(ishdefBuild * 0x93 + 0x3f00);
            pSVar16 = (SHDEF *)&shdefBuild;
            for (iVar11 = 0x49; iVar11 != 0; iVar11 = iVar11 + -1) {
              pHVar5 = pHVar18;
              pHVar18 = pHVar18 + 1;
              pSVar3 = pSVar16;
              pSVar16 = (pSVar16->hul).rgTech;
              *pHVar5 = (pSVar3->hul).ihuldef;
            }
            *(char *)pHVar18 = (char)(pSVar16->hul).ihuldef;
            LogChangeShDef((SHDEF *)(ishdefBuild * 0x93 + 0x3f00));
            pt = (POINT)((ulong)pt & 0xffff);
            while (pt.y < ishdefBuild) {
              if ((*(uint *)((int)&rgshdef[0].wFlags + pt.y * 0x93) >> 9 & 1) == 0) {
                bVar21 = 0xfffe < (HullSlotType)lSel;
                lSel._0_2_ = (HullSlotType)lSel + 1;
                lSel._2_2_ = lSel._2_2_ + (uint)bVar21;
              }
              pt.y = pt.y + 1;
            }
          }
          else {
            ishdefBuild = ishdefBuild + -0x10;
            uVar19 = *(undefined2 *)(idPlayer * 4 + 0x14e);
            pHVar18 = (HullDef *)
                      (*(int *)(idPlayer * 4 + 0x14c) + ishdefBuild * 0x93);
            pSVar16 = (SHDEF *)&shdefBuild;
            for (iVar11 = 0x49; iVar11 != 0; iVar11 = iVar11 + -1) {
              pHVar5 = pHVar18;
              pHVar18 = pHVar18 + 1;
              pSVar3 = pSVar16;
              pSVar16 = (pSVar16->hul).rgTech;
              *pHVar5 = (pSVar3->hul).ihuldef;
            }
            *(char *)pHVar18 = (char)(pSVar16->hul).ihuldef;
            pt.x = ishdefBuild * 0x93;
            LogChangeShDef(&shdefBuild);
            pt = (POINT)((ulong)pt & 0xffff);
            while (pt.y < ishdefBuild) {
              if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + pt.y * 0x93 + 0x7b) >> 9 & 1)
                  == 0) {
                bVar21 = 0xfffe < (HullSlotType)lSel;
                lSel._0_2_ = (HullSlotType)lSel + 1;
                lSel._2_2_ = lSel._2_2_ + (uint)bVar21;
              }
              pt.y = pt.y + 1;
            }
            ishdefBuild = ishdefBuild + 0x10;
          }
          goto LAB_10c8_234f;
        }
      }
      else if ((((uint)gd.grBits >> 0xb & 1) == 0) ||
              (sVar26 = FTutorialEnabledShipBuilder(4), sVar26 != 0)) {
LAB_10c8_234f:
        InvalidateRect(hwnd,(RECT *)0x0,1);
        ShowMainControls(hwnd,5);
        HVar10 = GetDlgItem(hwnd,0x81b);
        ShowWindow(HVar10,0);
        hwndItem = GetDlgItem(hwnd,0x80c);
        uVar13 = rggrbitPartsSB[0];
        if (fStarbaseMode == 0) {
          uVar13 = rggrbitParts[0];
        }
        FillBuildPartsLB(hwndItem,uVar13);
        SetWindowPos(hwndItem,0,ptslotGlob.x + -0x100,0x20,0xf0,0x10a,4);
        HVar10 = GetDlgItem(hwnd,0x80c);
        ShowWindow(HVar10,0);
        if (fHullCopy != 0) {
          if (((wParam != 2) && (fStarbaseMode == 0)) &&
             ((((SHDEF *)lpshdefBuild)->hul).rghs[0].wFlags_0x2 >> 8 == 0)) {
            wParam = 2;
          }
          if (wParam == 2) {
            if (fStarbaseMode == 0) {
              pt = (POINT)(CONCAT22(pt.y,*(undefined2 *)
                                          ((int)&rgshdef[0].wFlags +
                                          ishdefBuild * 0x93)) & 0xfffffdff | 0x200);
              *(short *)((int)&rgshdef[0].wFlags + ishdefBuild * 0x93) = pt.x;
              pcVar2 = (char *)((int)&rgplr[0].cShDef + idPlayer * 0xc0);
              *pcVar2 = *pcVar2 + -1;
              LogChangeShDef((SHDEF *)(ishdefBuild * 0x93 + 0x3f00));
            }
            else {
              shdefBuild.wFlags = shdefBuild.wFlags & 0xfdff | 0x200;
              uVar19 = *(undefined2 *)(idPlayer * 4 + 0x14e);
              pHVar18 = (HullDef *)
                        (*(int *)(idPlayer * 4 + 0x14c) +
                        (ishdefBuild + -0x10) * 0x93);
              pSVar16 = (SHDEF *)&shdefBuild;
              for (iVar11 = 0x49; iVar11 != 0; iVar11 = iVar11 + -1) {
                pHVar5 = pHVar18;
                pHVar18 = pHVar18 + 1;
                pSVar3 = pSVar16;
                pSVar16 = (pSVar16->hul).rgTech;
                *pHVar5 = (pSVar3->hul).ihuldef;
              }
              *(char *)pHVar18 = (char)(pSVar16->hul).ihuldef;
              pt = (POINT)(CONCAT22(pt.y,*(int *)((int)&rgplr[0].wFlags_0x4 +
                                                 idPlayer * 0xc0) + -0x1000) & 0xfffff000);
              puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0);
              *puVar1 = *puVar1 & 0xfff;
              puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0);
              *puVar1 = *puVar1 | pt.x;
              LogChangeShDef(&shdefBuild);
            }
          }
        }
        wParam = 0x812;
        goto BUILD_LRestart;
      }
    }
    else if (wParam == 0x76) {
      if (mdBuild == 4) {
        uVar14 = 0xbdf;
      }
      else {
        uVar14 = 0x42a;
      }
      WinHelp(hwnd,_szHelpFile,1,(ulong)uVar14);
      pfVar6 = (fn_lpfnRealListProc *)
               CONCAT22(lpfnRealListProc._2_2_,
                        (fn_lpfnRealListProc *)lpfnRealListProc);
      HVar15 = 1;
      goto LAB_10c8_2647;
    }
  }
LAB_10c8_2641:
  HVar15 = 0;
  pfVar6 = (fn_lpfnRealListProc *)
           CONCAT22(lpfnRealListProc._2_2_,
                    (fn_lpfnRealListProc *)lpfnRealListProc);
LAB_10c8_2647:
  lpfnRealListProc._2_2_ = (undefined2)((ulong)pfVar6 >> 0x10);
  lpfnRealListProc._0_2_ = (fn_lpfnRealListProc *)pfVar6;
  return HVar15;
}



// ======================================================================
// Function: DrawSlotDlg
// Address: 10c8:2650
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10c829b7) */

void DrawSlotDlg(HWND hwnd,HDC hdc,RECT *prc,short iDraw)

{
  uint uVar1;
  HGDIOBJ HVar2;
  HGDIOBJ HVar3;
  HBRUSH HVar4;
  int iVar5;
  int iVar6;
  char *pcVar7;
  HS *pHVar8;
  SHDEF *pSVar9;
  undefined2 uVar10;
  undefined2 unaff_SS;
  COLORREF CVar11;
  DWORD DVar12;
  RECT *pRVar13;
  undefined2 uVar14;
  undefined2 uVar15;
  undefined2 uVar16;
  HDC HVar17;
  short sVar18;
  HPEN hpenSav;
  short iInventSel;
  RECT rc;
  HULDEF *lphuldef;
  PART part;
  short xLeft;
  HBITMAP hbmpSav;
  short ibmp;
  short cItem;
  short j;
  short bkMode;
  short i;
  short c;
  HDC hdcMem;
  short fCreatedDC;
  short cSlot;
  short iMax;
  short yTop;
  
  fCreatedDC = 0;
  if ((mdBuild != 3) &&
     (((SHDEF *)lpshdefBuild != (SHDEF *)0x0 || (lpshdefBuild._2_2_ != 0)))) {
    lphuldef = LphuldefFromId((lpshdefBuild->hul).ihuldef);
    cSlot = (short)(((HULDEF *)lphuldef)->hul).chs;
    if (hdc == 0) {
      fCreatedDC = 1;
      hdc = GetDC(hwnd);
    }
    if (hwndSlotDlg == 0) {
      xLeft = 4;
    }
    else {
      xLeft = ptslotGlob.x + -0x152;
    }
    yTop = 6;
    DrawFleetBitmap
              ((FLEET *)0x0,hdc,xLeft,6,1,(((SHDEF *)lpshdefBuild)->hul).ibmp,0,0,-1,0);
    hdcMem = CreateCompatibleDC(hdc);
    hbmpSav = SelectObject(hdcMem,hbmpScanner);
    if (mdBuild == 4) {
      SetRect(rgrcBuildSpin,xLeft + 0x15,yTop + 0x45,xLeft + 0x23,yTop + 0x53);
      rgrcBuildSpin[1].left = rgrcBuildSpin[0].left;
      rgrcBuildSpin[1].top = rgrcBuildSpin[0].top;
      rgrcBuildSpin[1].right = rgrcBuildSpin[0].right;
      rgrcBuildSpin[1].bottom = rgrcBuildSpin[0].bottom;
      OffsetRect(rgrcBuildSpin + 1,0xe,0);
      for (i = 0; i < 2; i = i + 1) {
        if (i == 0) {
          uVar1 = 2;
        }
        else {
          uVar1 = 3;
        }
        DrawBtn(hdc,(RECT *)rgrcBuildSpin + i,uVar1 | 0x20,0,(char *)0x0);
      }
    }
    else {
      rgrcBuildSpin[1].top = -5;
      rgrcBuildSpin[0].top = -5;
      rgrcBuildSpin[1].bottom = -6;
      rgrcBuildSpin[0].bottom = -6;
    }
    SelectObject(hdc,rghfontArial8[1]);
    bkMode = SetBkMode(hdc,1);
    if (iDraw == -1) {
      i = 0;
      iMax = cSlot;
    }
    else {
      i = iDraw;
      iMax = iDraw + 1;
    }
    if ((((HULDEF *)lphuldef)->hul).wtCargoMax != 0) {
      rc.left = rcCargo.left;
      rc.top = rcCargo.top;
      rc.right = rcCargo.right;
      rc.bottom = rcCargo.bottom;
      if ((fStarbaseMode == 0) ||
         (((lphuldef->hul).ihuldef != (ihuldefCount|ihuldefMediumFreighter) &&
          ((lphuldef->hul).ihuldef != (ihuldefCount|ihuldefScout))))) {
        uVar15 = 0x1120;
        pRVar13 = (RECT *)&rcCargo;
        HVar17 = hdc;
        HVar3 = GetStockObject(4);
        FillRect(HVar17,(RECT *)CONCAT22(uVar15,pRVar13),HVar3);
        rc.top = rc.top + 1;
        rc.bottom = rc.bottom + -1;
        rc.left = rc.left + 1;
        rc.right = rc.right + -1;
        HVar4 = hbrDock;
        if (fStarbaseMode == 0) {
          HVar4 = hbrCargo;
        }
        FillRect(hdc,&rc,HVar4);
      }
      else {
        HVar3 = SelectObject(hdc,hbrDock);
        HVar17 = hdc;
        HVar2 = GetStockObject(7);
        HVar2 = SelectObject(HVar17,HVar2);
        Ellipse(hdc,rc.left + -0xc,rc.top + -0xc,rc.right + 0xc,rc.bottom + 0xc);
        SelectObject(hdc,HVar2);
        SelectObject(hdc,HVar3);
      }
      rc.bottom = (rc.bottom - rc.top) / 2 + rc.top;
      if (fStarbaseMode == 0) {
        sVar18 = 0;
        pcVar7 = PszGetCompressedString(idsCargo3);
        RcCtrTextOut(hdc,&rc,pcVar7,sVar18);
        sVar18 = WtMaxShdefStat(lpshdefBuild,grStatCargo);
        c = _wsprintf(szWork,PCTDKT,sVar18);
        RcCtrTextOut(hdc,(RECT *)&rcCargo,(char *)szWork,0);
      }
      else {
        uVar15 = (undefined2)((ulong)lphuldef >> 0x10);
        if ((((HULDEF *)lphuldef)->hul).wtCargoMax == 0xffff) {
          sVar18 = 0;
          pcVar7 = PszGetCompressedString(idsUnlimited);
          RcCtrTextOut(hdc,&rc,pcVar7,sVar18);
        }
        else {
          c = _wsprintf(szWork,PCTDKT,(((HULDEF *)lphuldef)->hul).wtCargoMax);
          RcCtrTextOut(hdc,&rc,(char *)szWork,0);
        }
        sVar18 = 0;
        pcVar7 = PszGetCompressedString(idsSpace);
        RcCtrTextOut(hdc,(RECT *)&rcCargo,pcVar7,sVar18);
      }
      rc.top = rc.bottom;
      rc.bottom = rcCargo.bottom + -1;
      if (fStarbaseMode == 0) {
        sVar18 = 0;
        pcVar7 = PszGetCompressedString(idsMax);
        RcCtrTextOut(hdc,&rc,pcVar7,sVar18);
      }
      else {
        sVar18 = 0;
        pcVar7 = PszGetCompressedString(idsDock);
        RcCtrTextOut(hdc,&rc,pcVar7,sVar18);
      }
    }
    for (; i < iMax; i = i + 1) {
      FillRect(hdc,(RECT *)vrgrcSlot + i,hbr50Screen);
      cItem = (((SHDEF *)lpshdefBuild)->hul).rghs[i].wFlags_0x2 >> 8;
      if (cItem == 0) {
        SelectObject(hdcMem,hbmpBackBld);
        ibmp = IEmptyBmpFromGrhst(((((HULDEF *)lphuldef)->hul).rghs + i)->grhst);
        BitBlt(hdc,((RECT *)vrgrcSlot + i)->left,
               *(short *)((int)&vrgrcSlot[0].top + i * 8),0x40,0x40,hdcMem,
               (ibmp & 7U) << 6,(ibmp >> 3 & 3U) << 6,0xcc0020);
        if ((((((HULDEF *)lphuldef)->hul).rghs + i)->grhst & hstEngine) ==
            ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
              hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
          uVar1 = (((HULDEF *)lphuldef)->hul).rghs[i].wFlags_0x2 >> 8;
          pcVar7 = PszGetCompressedString(idsD3);
          c = _wsprintf(szWork,pcVar7,uVar1);
        }
        else {
          uVar1 = (((HULDEF *)lphuldef)->hul).rghs[i].wFlags_0x2 >> 8;
          pcVar7 = PszGetCompressedString(idsNeedsD);
          c = _wsprintf(szWork,pcVar7,uVar1);
        }
      }
      else {
        pHVar8 = (((SHDEF *)lpshdefBuild)->hul).rghs + i;
        part.hs.grhst = pHVar8->grhst;
        part.hs.wFlags_0x2 = pHVar8->wFlags_0x2;
        FLookupPart(&part);
        ibmp = ((ARMOR *)part.u_PART_0x0004.parmor)->ibmp;
        DibBlt(hdc,((RECT *)vrgrcSlot + i)->left,
                        *(short *)((int)&vrgrcSlot[0].top + i * 8),0x40,0x40,
                        ((ushort *)rghdibInventory)[ibmp >> 5],(ibmp & 7U) << 6,
                        (3 - (ibmp >> 3 & 3U)) * 0x40,0x40,0x40,0xcc0020);
        if (mdBuild != 4) {
          SelectObject(hdcMem,hbmpScanner);
          for (j = 0; j < 4; j = j + 1) {
            if (j < 2) {
              iVar5 = 3;
            }
            else {
              iVar5 = 0x39;
            }
            if ((j & 1U) == 0) {
              iVar6 = 0x39;
            }
            else {
              iVar6 = 3;
            }
            BitBlt(hdc,iVar5 + ((RECT *)vrgrcSlot + i)->left,
                   iVar6 + *(int *)((int)&vrgrcSlot[0].top + i * 8),4,4,hdcMem,0x16,0x21,
                   0xcc0020);
          }
        }
        if (((cItem == 1) && ((((HULDEF *)lphuldef)->hul).rghs[i].wFlags_0x2 >> 8 == 1)) &&
           (part.hs.grhst == hstSpecialSB)) {
          szWork[0] = '\0';
          c = 0;
        }
        else {
          uVar1 = (((HULDEF *)lphuldef)->hul).rghs[i].wFlags_0x2 >> 8;
          sVar18 = cItem;
          pcVar7 = PszGetCompressedString(idsDD);
          c = _wsprintf(szWork,pcVar7,sVar18,uVar1);
        }
      }
      CtrTextOut(hdc,((RECT *)vrgrcSlot + i)->left + 0x20,
                          (*(int *)((int)&vrgrcSlot[0].bottom + i * 8) -
                          dyArial6) + -4,(char *)szWork,c);
      if (iselSlot == i) {
        CVar11 = SetBkColor(hdc,0xffffff);
        FrameRect(hdc,(RECT *)vrgrcSlot + i,hbr50Screen);
        ExpandRc((RECT *)vrgrcSlot + i,-1,-1);
        FrameRect(hdc,(RECT *)vrgrcSlot + i,hbr50Screen);
        ExpandRc((RECT *)vrgrcSlot + i,1,1);
        SetBkColor(hdc,CVar11);
      }
    }
    if (((hwndPopup == 0) ||
        (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate == 0)) &&
       (mdBuild == 0)) {
      SetRect(&rc,ptPlaque.x,ptPlaque.y,ptPlaque.x + 0x3c,
              ptPlaque.y + 0x1e);
      SelectPalette(hdc,vhpal,0);
      RealizePalette(hdc);
      DibBlt(hdc,ptPlaque.x,ptPlaque.y,0x3c,0x1e,hdibPlaque,0,0,
                      0x3c,0x1e,0xcc0020);
      uVar10 = (undefined2)((ulong)lpshdefBuild >> 0x10);
      pSVar9 = (SHDEF *)lpshdefBuild;
      uVar15 = *(undefined2 *)((int)&pSVar9->cBuilt + 2);
      uVar16 = (undefined2)pSVar9->cBuilt;
      uVar14 = *(undefined2 *)((int)&pSVar9->cExist + 2);
      uVar10 = (undefined2)pSVar9->cExist;
      pcVar7 = PszGetCompressedString(idsLdLd);
      c = _wsprintf(szWork,pcVar7,uVar10,uVar14,uVar16,uVar15);
      SelectObject(hdc,rghfontArial8[1]);
      DVar12 = GetTextExtent(hdc,szWork,c);
      if (0x32 < (uint)DVar12) {
        SelectObject(hdc,rghfontArial7[0]);
        DVar12 = GetTextExtent(hdc,szWork,c);
        if (0x32 < (uint)DVar12) {
          SelectObject(hdc,rghfontArial6[0]);
        }
      }
      RcCtrTextOut(hdc,&rc,(char *)szWork,c);
    }
    SetBkMode(hdc,bkMode);
    SelectObject(hdcMem,hbmpSav);
    DeleteDC(hdcMem);
    if (fCreatedDC != 0) {
      ReleaseDC(hwnd,hdc);
    }
  }
  return;
}



// ======================================================================
// Function: FTrackSlot
// Address: 10c8:306a
// Segment: MEMORY_BUILD
// ======================================================================


short FTrackSlot(HWND hwnd,short x,short y,short fkb,short fListBox,short fRightBtn)

{
  uint uVar1;
  POINT pt_00;
  POINT pt_01;
  POINT PVar2;
  POINT PVar3;
  POINT PVar4;
  POINT PVar5;
  HS hsSrc;
  HS hsSrc_00;
  HWND hwnd_00;
  short y_00;
  int x_00;
  BOOL BVar6;
  int iVar7;
  short sVar8;
  HCURSOR HVar9;
  HS *pHVar10;
  undefined2 unaff_SS;
  HULDEF *pHVar11;
  LRESULT LVar12;
  short xLeft;
  short iCur;
  short iBase;
  RECT *prc;
  BTNT btnt;
  short bt;
  short yTop;
  short iDir;
  RECT rc;
  PART part;
  short fFirst;
  HullSlotType hs;
  uint local_40;
  HBITMAP hbmpSav;
  short iSel;
  int ptD;
  int local_38;
  HDC hdcMemFull;
  HBITMAP hbmpOld;
  short ibmp;
  HBITMAP hbmpScreen;
  short fUseMem;
  POINT rcStart;
  POINT local_28;
  HBITMAP hbmpFullSav;
  short i;
  HDC hdcMem;
  short ibmpX;
  int ptDNew;
  short local_1a;
  short iSrc;
  short cSlot;
  POINT pt;
  short ibmpY;
  short ptTileSize;
  short local_c;
  int ptOld;
  int local_8;
  HDC hdc;
  
  fFirst = 1;
  if (((SHDEF *)lpshdefBuild == (SHDEF *)0x0) && (lpshdefBuild._2_2_ == 0)) {
    sVar8 = 0;
  }
  else {
    pt.x = x;
    pt.y = y;
    pHVar11 = LphuldefFromId((lpshdefBuild->hul).ihuldef);
    cSlot = (short)(((HULDEF *)pHVar11)->hul).chs;
    if (((fRightBtn == 0) && (hwndSlotDlg != 0)) &&
       ((PVar2.y = pt.y, PVar2.x = pt.x, BVar6 = PtInRect(rgrcBuildSpin,PVar2), BVar6 != 0
        || (PVar3.y = pt.y, PVar3.x = pt.x, BVar6 = PtInRect(rgrcBuildSpin + 1,PVar3),
           BVar6 != 0)))) {
      PVar4.y = pt.y;
      PVar4.x = pt.x;
      BVar6 = PtInRect(rgrcBuildSpin,PVar4);
      if (BVar6 == 0) {
        iDir = 1;
        bt = 0x23;
        prc = (RECT *)(rgrcBuildSpin + 1);
      }
      else {
        iDir = -1;
        bt = 0x22;
        prc = (RECT *)rgrcBuildSpin;
      }
      uVar1 = (((SHDEF *)lpshdefBuild)->hul).ibmp;
      iCur = uVar1 & 3;
      iVar7 = uVar1 - iCur;
      x_00 = ptslotGlob.x + -0x150;
      yTop = 8;
      InitBtnTrack(&btnt,hwnd,0,prc,bt,0x50,0,0,(char *)0x0);
      while (sVar8 = FTrackBtn(&btnt), sVar8 != 0) {
        iCur = iCur + 4 + iDir & 3;
        DrawFleetBitmap((FLEET *)0x0,btnt.hdc,x_00,yTop,0,iVar7 + iCur,0,0,-1,0);
      }
      (((SHDEF *)lpshdefBuild)->hul).ibmp = iVar7 + iCur;
      sVar8 = 1;
    }
    else {
      if (fListBox == 0) {
        GetClientRect(hwnd,&rc);
        iSrc = 0;
        while ((iSrc < cSlot &&
               (PVar5.y = pt.y, PVar5.x = pt.x,
               BVar6 = PtInRect((RECT *)vrgrcSlot + iSrc,PVar5), BVar6 == 0))) {
          iSrc = iSrc + 1;
        }
        if (iSrc == cSlot) {
          return 0;
        }
        pHVar10 = (((SHDEF *)lpshdefBuild)->hul).rghs + iSrc;
        part.hs.grhst = pHVar10->grhst;
        part.hs.wFlags_0x2 = pHVar10->wFlags_0x2;
        hs = part.hs.grhst;
        local_40 = part.hs.wFlags_0x2;
        if (part.hs.wFlags_0x2 >> 8 == 0) {
          SetBuildSelection(iSrc);
          return 0;
        }
        FLookupPart(&part);
        ibmp = ((ARMOR *)part.u_PART_0x0004.parmor)->ibmp;
        iVar7 = iSrc * 8;
        rcStart.x = ((RECT *)vrgrcSlot + iSrc)->left;
        rcStart.y = *(int *)((int)&vrgrcSlot[0].top + iVar7);
        local_28.x = *(int *)((int)&vrgrcSlot[0].right + iVar7);
        local_28.y = *(int *)((int)&vrgrcSlot[0].bottom + iVar7);
      }
      else {
        LVar12 = SendMessage(hwnd,0x409,0,0);
        iSel = (short)LVar12;
        if (iSel == 0xffff) {
          return 0;
        }
        SendMessage(hwnd,0x40a,iSel,0x112057a4);
        ibmp = szWork[2] + -0x41 + (szWork[3] + -0x41) * 0x1a;
        iSrc = -1;
        hs = 1 << (szWork[0] + 0xbfU & 0x1f);
        iDir = (int)szWork[1] - 0x41;
        local_40 = iDir & 0xffU | 0x100;
        rcStart.x = 2;
        local_28.x = 0x42;
        local_28.y = (y / 0x42) * 0x42;
        rcStart.y = local_28.y + 1;
        local_28.y = local_28.y + 0x41;
        ClientToScreen(hwnd,&rcStart);
        ClientToScreen(hwnd,&local_28);
        ClientToScreen(hwnd,&pt);
        hwnd_00 = hwndSlotDlg;
        hwnd = hwndSlotDlg;
        ScreenToClient(hwndSlotDlg,&rcStart);
        ScreenToClient(hwnd_00,&local_28);
        ScreenToClient(hwnd_00,&pt);
        y_00 = pt.y;
        sVar8 = pt.x;
        x = pt.x;
        y = pt.y;
        if (((hs == hstEngine) && ((local_40 & 0xff) == 0)) &&
           ((lpshdefBuild->hul).ihuldef != ihuldefMiniColonyShip)) {
          GlobalPD.grPopup = 10;
          GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = hstMining|hstTorp|hstBeam|hstShield;
          GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = (ushort)szPopupBuffer;
          CchGetString
                    (idsSettlersDelightEngineMayMountedDesignsBased,(char *)szPopupBuffer)
          ;
          Popup(hwnd_00,sVar8,y_00);
          return 1;
        }
        if (((hs == hstSpecialM) && ((local_40 & 0xff) == 1)) &&
           ((lpshdefBuild->hul).ihuldef != ihuldefColonyShip)) {
          GlobalPD.grPopup = 10;
          GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = hstMining|hstTorp|hstBeam|hstShield;
          GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = (ushort)szPopupBuffer;
          CchGetString
                    (idsOrbitalConstructionModuleMayMountedDesignsBased,
                     (char *)szPopupBuffer);
          Popup(hwnd_00,sVar8,y_00);
          return 1;
        }
        if (((hs == hstSpecialE) && ((local_40 & 0xff) == 0)) &&
           (pHVar11 = LphuldefFromId((lpshdefBuild->hul).ihuldef),
           (((HULDEF *)pHVar11)->wFlags_0x7b >> 6 & 0xf) != 0)) {
          GlobalPD.grPopup = 10;
          GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = hstMining|hstTorp|hstBeam|hstShield;
          GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = (ushort)szPopupBuffer;
          CchGetString
                    (idsTransportCloakingModuleMayPlacedHullCould,(char *)szPopupBuffer);
          Popup(hwnd_00,sVar8,y_00);
          return 1;
        }
      }
      SetBuildSelection(iSrc);
      if (fRightBtn == 0) {
        if (mdBuild == 4) {
          local_c = 0x40;
          ptTileSize = 0x40;
          ibmpX = ibmp & 7;
          ibmpY = ibmp >> 3 & 3;
          hdc = GetDC(hwnd);
          SelectPalette(hdc,vhpal,0);
          RealizePalette(hdc);
          hdcMem = CreateCompatibleDC(hdc);
          hdcMemFull = CreateCompatibleDC(hdc);
          SelectPalette(hdcMemFull,vhpal,0);
          RealizePalette(hdcMemFull);
          hbmpOld = CreateCompatibleBitmap(hdc,ptTileSize,local_c);
          hbmpSav = SelectObject(hdcMem,hbmpOld);
          hbmpScreen = CreateCompatibleBitmap(hdc,ptTileSize * 3,local_c * 3);
          hbmpFullSav = SelectObject(hdcMemFull,hbmpScreen);
          SetCapture(hwnd);
          local_8 = -1;
          ptOld = -1;
          while (sVar8 = FGetMouseMove(&pt), sVar8 != 0) {
            if ((pt.x != ptOld) || (pt.y != local_8)) {
              if (fFirst == 0) {
                SelectObject(hdcMem,hbmpOld);
                ptDNew = pt.x - ptOld;
                local_1a = pt.y - local_8;
                sVar8 = _abs(ptDNew);
                if ((sVar8 < ptTileSize) && (sVar8 = _abs(local_1a), sVar8 < local_c)) {
                  fUseMem = 1;
                }
                else {
                  fUseMem = 0;
                }
                if (fUseMem == 0) {
                  BitBlt(hdc,rcStart.x + ptD,rcStart.y + local_38,ptTileSize,local_c,hdcMem,0,0,
                         0xcc0020);
                }
                else {
                  BitBlt(hdcMemFull,0,0,ptTileSize * 3,local_c * 3,hdc,
                         (rcStart.x + ptD) - ptTileSize,(rcStart.y + local_38) - local_c,0xcc0020);
                  BitBlt(hdcMemFull,ptTileSize,local_c,ptTileSize,local_c,hdcMem,0,0,0xcc0020);
                }
              }
              else {
                fUseMem = 0;
                fFirst = 0;
              }
              ptOld = pt.x;
              local_8 = pt.y;
              ptD = pt.x - x;
              local_38 = pt.y - y;
              SelectObject(hdcMem,hbmpOld);
              if (fUseMem == 0) {
                BitBlt(hdcMem,0,0,ptTileSize,local_c,hdc,rcStart.x + ptD,rcStart.y + local_38,
                       0xcc0020);
                DibBlt(hdc,rcStart.x + ptD,rcStart.y + local_38,0x40,0x40,
                                ((ushort *)rghdibInventory)[ibmp / 0x20],ibmpX << 6,
                                (3 - ibmpY) * 0x40,0x40,0x40,0xcc0020);
              }
              else {
                yTop = 0;
                iDir = 0;
                BitBlt(hdcMem,0,0,ptTileSize,local_c,hdcMemFull,ptTileSize + ptDNew,
                       local_c + local_1a,0xcc0020);
                DibBlt(hdcMemFull,ptTileSize + ptDNew,local_c + local_1a,0x40,0x40,
                                ((ushort *)rghdibInventory)[ibmp / 0x20],ibmpX << 6,
                                (3 - ibmpY) * 0x40,0x40,0x40,0xcc0020);
                rc.left = rcStart.x;
                rc.top = rcStart.y;
                rc.right = local_28.x;
                rc.bottom = local_28.y;
                OffsetRc(&rc,ptD,local_38);
                if (ptDNew < 1) {
                  rc.right = rc.right - ptDNew;
                }
                else {
                  rc.left = rc.left - ptDNew;
                  yTop = ptDNew;
                }
                if (local_1a < 1) {
                  rc.bottom = rc.bottom - local_1a;
                }
                else {
                  rc.top = rc.top - local_1a;
                  iDir = local_1a;
                }
                BitBlt(hdc,rc.left,rc.top,rc.right - rc.left,rc.bottom - rc.top,hdcMemFull,
                       (ptTileSize + ptDNew) - yTop,(local_c + local_1a) - iDir,0xcc0020);
              }
              pt_00.y = pt.y;
              pt_00.x = pt.x;
              hsSrc.wFlags_0x2 = local_40;
              hsSrc.grhst = hs;
              i = IDropPart(pt_00,hsSrc,iSrc,1);
              if ((i < 0) || (i == 2)) {
                HVar9 = LoadCursor(0,(LPCSTR)0x7f00);
                setcursor(HVar9);
              }
              else if ((i == 1) && (-1 < iSrc)) {
                setcursor(hcurTrashCan);
              }
              else {
                setcursor(hcurNoWay);
              }
            }
          }
          if (fFirst == 0) {
            SelectObject(hdcMem,hbmpOld);
            BitBlt(hdc,rcStart.x + ptD,rcStart.y + local_38,0x40,0x40,hdcMem,0,0,0xcc0020);
          }
          ReleaseCapture();
          SelectObject(hdcMem,hbmpSav);
          SelectObject(hdcMemFull,hbmpFullSav);
          DeleteObject(hbmpOld);
          DeleteObject(hbmpScreen);
          DeleteDC(hdcMem);
          DeleteDC(hdcMemFull);
          pt_01.y = pt.y;
          pt_01.x = pt.x;
          hsSrc_00.wFlags_0x2 = local_40;
          hsSrc_00.grhst = hs;
          i = IDropPart(pt_01,hsSrc_00,iSrc,0);
          ReleaseDC(hwnd,hdc);
          sVar8 = 1;
        }
        else {
          sVar8 = 0;
        }
      }
      else {
        GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = part.hs.grhst;
        GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = part.hs.wFlags_0x2;
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur =
             (short)part.u_PART_0x0004.parmor._0_2_;
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = part.u_PART_0x0004._2_2_;
        GlobalPD.grPopup = 9;
        Popup(hwnd,x,y);
        sVar8 = 1;
      }
    }
  }
  return sVar8;
}



// ======================================================================
// Function: DrawBuildSelComp
// Address: 10c8:3ab2
// Segment: MEMORY_BUILD
// ======================================================================


void DrawBuildSelComp(HWND hwnd,HDC hdc,short iDraw)

{
  HWND HVar1;
  StringId ids;
  short sVar2;
  char *pcVar3;
  char *pcVar4;
  short sVar5;
  int iVar6;
  HS *pHVar7;
  undefined2 unaff_SS;
  LRESULT LVar8;
  HULDEF *pHVar9;
  DWORD DVar10;
  ulong uVar11;
  undefined2 uVar12;
  short sVar13;
  HDC HVar14;
  short iSel;
  RECT rc;
  short dxkT;
  short x;
  PART part;
  short cch;
  HullSlotType hsHul;
  uint local_76;
  undefined4 crBackSav;
  char szWord;
  undefined1 local_6f [79];
  short k;
  short fPlural;
  COLORREF crForeSav;
  short i;
  short c;
  short fCreatedDC;
  ushort rgCosts [3];
  uint local_c;
  HullSlotType hsShip;
  uint local_8;
  ushort grhst;
  
  fCreatedDC = 0;
  if (hdc == 0) {
    fCreatedDC = 1;
    hdc = GetDC(hwnd);
  }
  GetClientRect(hwndSlotDlg,&rc);
  rc.bottom = rc.bottom + -8;
  rc.left = 8;
  rc.right = 0x108;
  rc.top = yBuildInfoSum;
  SelectObject(hdc,rghfontArial8[1]);
  crForeSav = SetTextColor(hdc,0);
  crBackSav = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,
                                      (undefined2)crButtonFace));
  FillRect(hdc,&rc,hbrButtonFace);
  if (fStarbaseMode != 0) {
    rc.top = rc.top + dyArial8;
  }
  if (iselSlot == -2) goto BUILD_Restore;
  if (iselSlot == -1) {
    HVar1 = GetDlgItem(hwndSlotDlg,0x80c);
    LVar8 = SendMessage(HVar1,0x409,0,0);
    if ((WPARAM)LVar8 == 0xffff) goto BUILD_Restore;
    HVar1 = GetDlgItem(hwndSlotDlg,0x80c);
    SendMessage(HVar1,0x40a,(WPARAM)LVar8,0x112057a4);
    hsShip = 1 << (szWork[0] + 0xbfU & 0x1f);
    local_8 = (int)szWork[1] - 0x41U & 0xff | 0x100;
  }
  else {
    if (((SHDEF *)lpshdefBuild == (SHDEF *)0x0) && (lpshdefBuild._2_2_ == 0))
    goto BUILD_Restore;
    pHVar7 = (((SHDEF *)lpshdefBuild)->hul).rghs + iselSlot;
    hsShip = pHVar7->grhst;
    local_8 = pHVar7->wFlags_0x2;
    pHVar9 = LphuldefFromId((lpshdefBuild->hul).ihuldef);
    uVar12 = (undefined2)((ulong)pHVar9 >> 0x10);
    pHVar7 = (((HULDEF *)pHVar9)->hul).rghs + iselSlot;
    hsHul = pHVar7->grhst;
    local_76 = pHVar7->wFlags_0x2;
    if (local_8 >> 8 == 0) {
      if ((hsHul & hstEngine) ==
          ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
            hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
        ids = idsCanHold;
      }
      else {
        ids = idsRequiresExactly;
      }
      i = CchGetString(ids,(char *)szWork);
      fPlural = (short)(local_76 >> 8 != 1);
      if (fPlural == 0) {
        sVar2 = CchGetString(idsOne,(char *)szWork + i);
        i = i + sVar2;
      }
      else {
        sVar2 = _wsprintf((char *)szWork + i,(char *)0x11200c92,local_76 >> 8);
        i = i + sVar2;
      }
      grhst = hsHul;
      while (grhst != 0) {
        for (i = 0; i < 0xe; i = i + 1) {
          if ((grhst & *(uint *)(i * 2)) == *(uint *)(i * 2)) {
            grhst = grhst & ~*(uint *)(i * 2);
            break;
          }
        }
        cch = CchGetString(*(StringId *)(i * 2 + 0x1c),&szWord);
        if (fPlural == 0) {
          if (*(char *)((int)&crBackSav + cch + 3) == 's') {
            if ((*(char *)((int)&crBackSav + cch + 2) == 'e') &&
               (*(char *)((int)&crBackSav + cch + 1) == 'o')) {
              *(undefined1 *)((int)&crBackSav + cch + 2) = 0;
            }
            else {
              *(undefined1 *)((int)&crBackSav + cch + 3) = 0;
            }
          }
          else {
            for (iSel = (int)&crBackSav + cch + 3; (&szWord < (uint)iSel && (*(char *)iSel != '('));
                iSel = iSel + -1) {
            }
            if ((((*(char *)iSel == '(') && (local_6f < (uint)iSel)) &&
                (*(char *)(iSel + -1) == ' ')) && (*(char *)(iSel + -2) == 's')) {
              _strcpy((char *)(iSel + -2),(char *)(iSel + -1));
            }
          }
        }
        if (grhst != 0) {
          if ((grhst - 1 & grhst) == 0) {
            pcVar3 = PszGetCompressedString(idsOr);
            _strcat(&szWord,pcVar3);
          }
          else {
            _strcat(&szWord,(char *)0xc96);
          }
        }
        _strcat((char *)szWork,&szWord);
      }
      x = rc.left;
      WrapTextOut
                (hdc,&x,&rc.top,(char *)szWork,0,rc.left,rc.right - rc.left,(short *)0x0,0
                 ,1);
      rc.top = rc.top + dyArial8;
      goto BUILD_Restore;
    }
  }
  part.hs.grhst = hsShip;
  part.hs.wFlags_0x2 = local_8;
  FLookupPart(&part);
  HVar14 = hdc;
  pcVar3 = PszGetCompressedString(idsKt);
  DVar10 = GetTextExtent(HVar14,pcVar3,2);
  dxkT = (short)DVar10;
  fPlural = (short)(local_8 >> 8 != 1);
  if (fPlural == 0) {
    CchGetString(idsOne,&szWord);
  }
  else {
    _wsprintf(&szWord,(char *)0x11200c99,local_8 >> 8);
  }
  __fstrcat(&szWord,(char *)CONCAT22(part.u_PART_0x0004._2_2_,
                                             (part.u_PART_0x0004.parmor._0_2_)->szName));
  if (fPlural != 0) {
    _strcat(&szWord,(char *)0xc9d);
  }
  pcVar3 = &szWord;
  pcVar4 = PszGetCompressedString(idsCostS);
  cch = _wsprintf(szWork,pcVar4,pcVar3);
  TextOut(hdc,rc.left,rc.top,szWork,cch);
  rc.left = rc.left + 8;
  rc.right = rc.right + -8;
  c = local_8 >> 8;
  GetTruePartCost(idPlayer,&part,rgCosts);
  for (k = 0; k < 3; k = k + 1) {
    rc.top = rc.top + dyArial8;
    SelectObject(hdc,rghfontArial8[1]);
    SetTextColor(hdc,CONCAT22(*(undefined2 *)(k * 4 + 0x44a),*(undefined2 *)(k * 4 + 0x448)));
    pcVar3 = (char *)*(undefined2 *)(k * 2 + 0x4cc);
    uVar12 = 0x1120;
    sVar2 = rc.top;
    sVar13 = rc.left;
    HVar14 = hdc;
    sVar5 = lstrlen((char *)*(undefined2 *)(k * 2 + 0x4cc));
    TextOut(HVar14,sVar13,sVar2,(LPCSTR)CONCAT22(uVar12,pcVar3),sVar5);
    SelectObject(hdc,rghfontArial8[0]);
    SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
    uVar11 = __aFulmul((long)c,(ulong)rgCosts[k]);
    cch = _wsprintf(szWork,PCTLD,(int)uVar11,(int)(uVar11 >> 0x10));
    RightTextOut
              (hdc,(rc.right - dxkT) + -0x40,rc.top,(char *)szWork,cch,
               dxMaxMineralQuan);
    iVar6 = (rc.right - dxkT) + -0x40;
    sVar2 = rc.top;
    HVar14 = hdc;
    pcVar3 = PszGetCompressedString(idsKt);
    TextOut(HVar14,iVar6,sVar2,pcVar3,2);
  }
  rc.top = rc.top + dyArial8;
  SelectObject(hdc,rghfontArial8[1]);
  SetTextColor(hdc,CONCAT22(rgcrMinerals[5]._2_2_,(undefined2)rgcrMinerals[5]));
  uVar12 = 0x1120;
  pcVar3 = pcRam112004d6;
  sVar2 = rc.top;
  sVar13 = rc.left;
  HVar14 = hdc;
  sVar5 = lstrlen(pcRam112004d6);
  TextOut(HVar14,sVar13,sVar2,(LPCSTR)CONCAT22(uVar12,pcVar3),sVar5);
  SelectObject(hdc,rghfontArial8[0]);
  SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
  uVar11 = __aFulmul((long)c,(ulong)local_c);
  cch = _wsprintf(szWork,PCTLD,(int)uVar11,(int)(uVar11 >> 0x10));
  RightTextOut
            (hdc,(rc.right - dxkT) + -0x40,rc.top,(char *)szWork,cch,
             dxMaxMineralQuan);
  if (fStarbaseMode == 0) {
    rc.left = rc.left + -8;
    rc.top = rc.top + dyArial8;
    SelectObject(hdc,rghfontArial8[1]);
    uVar11 = __aFulmul((long)c,(long)((ARMOR *)part.u_PART_0x0004.parmor)->cMass);
    pcVar3 = PszGetCompressedString(idsMassLdkt);
    cch = _wsprintf(szWork,pcVar3,(int)uVar11,(int)(uVar11 >> 0x10));
    TextOut(hdc,rc.left,rc.top,szWork,cch);
  }
BUILD_Restore:
  SelectObject(hdc,rghfontArial8[0]);
  SetTextColor(hdc,crForeSav);
  SetBkColor(hdc,crBackSav);
  if (fCreatedDC != 0) {
    ReleaseDC(hwnd,hdc);
  }
  return;
}



// ======================================================================
// Function: PctJammerFromHul
// Address: 10c8:42e6
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10c84495) */

short PctJammerFromHul(HUL *lphul)

{
  HS *pHVar1;
  undefined2 uVar2;
  bool bVar3;
  ulong uVar4;
  long lVar5;
  PART part;
  ulong pctHit;
  short i;
  short ihs;
  uint pctJam;
  int local_6;
  
  uVar4 = 10000;
  ihs = 0;
  while( true ) {
    uVar2 = (undefined2)((ulong)lphul >> 0x10);
    if ((int)(uint)((HUL *)lphul)->chs <= ihs) break;
    pHVar1 = ((HUL *)lphul)->rghs + ihs;
    part.hs.grhst = pHVar1->grhst;
    part.hs.wFlags_0x2 = pHVar1->wFlags_0x2;
    if (part.hs.grhst == hstSpecialE) {
      if (((part.hs.wFlags_0x2 & 0xff) < 8) || (0xb < (part.hs.wFlags_0x2 & 0xff))) {
        if ((part.hs.wFlags_0x2 & 0xff) == 4) {
          pctJam = 0x5a;
          local_6 = 0;
        }
        else {
          pctJam = 100;
          local_6 = 0;
        }
      }
      else {
        pctHit = uVar4;
        FLookupPart(&part);
        pctJam = 100 - ((ARMOR *)part.u_PART_0x0004.parmor)->dp;
        local_6 = (int)pctJam >> 0xf;
        uVar4 = pctHit;
      }
    }
    else if ((part.hs.grhst == hstArmor) && ((part.hs.wFlags_0x2 & 0xff) == 9)) {
      pctJam = 0x50;
      local_6 = 0;
    }
    else if ((part.hs.grhst == hstMining) && ((part.hs.wFlags_0x2 & 0xff) == 6)) {
      pctJam = 0x46;
      local_6 = 0;
    }
    else if ((part.hs.grhst == hstShield) && ((part.hs.wFlags_0x2 & 0xff) == 6)) {
      pctJam = 0x5f;
      local_6 = 0;
    }
    else {
      pctJam = 100;
      local_6 = 0;
    }
    if ((local_6 < 1) && ((local_6 < 0 || (pctJam < 100)))) {
      for (i = part.hs.wFlags_0x2 >> 8; 0 < i; i = i + -1) {
        pctHit = uVar4;
        uVar4 = __aFulmul(uVar4,CONCAT22(local_6,pctJam));
        pctHit = uVar4;
        uVar4 = __aFldiv(uVar4,100);
      }
    }
    ihs = ihs + 1;
  }
  if ((long)uVar4 < 100) {
    uVar4 = 100;
  }
  pctHit._0_2_ = (int)uVar4;
  pctJam = 100 - ((int)pctHit + 0x32) / 100;
  local_6 = (int)pctJam >> 0xf;
  if (0x20 < (int)lphul->ihuldef) {
    pctHit = uVar4;
    lVar5 = __aFldiv((long)(int)pctJam,4);
    bVar3 = pctJam < (uint)lVar5;
    pctJam = pctJam - (uint)lVar5;
    local_6 = (local_6 - (int)((ulong)lVar5 >> 0x10)) - (uint)bVar3;
  }
  if ((-1 < local_6) && ((0 < local_6 || (0x5f < pctJam)))) {
    pctJam = 0x5f;
  }
  return pctJam;
}



// ======================================================================
// Function: DrawBuildSelHull
// Address: 10c8:451e
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Variable defined which should be unmapped: pctDetect */
/* WARNING: Variable defined which should be unmapped: dRange */
/* WARNING: Variable defined which should be unmapped: i */

void DrawBuildSelHull(HWND hwnd,HDC hdc,short iDraw,RECT *prc)

{
  char *pcVar1;
  ushort uVar2;
  char *pcVar3;
  short sVar4;
  int iVar5;
  short sVar6;
  SHDEF *pSVar7;
  short unaff_SS;
  bool bVar8;
  DWORD DVar9;
  PLANET *pPVar10;
  ulong uVar11;
  long lVar12;
  undefined2 uVar13;
  HDC HVar14;
  char *pcVar15;
  short sVar16;
  short pctDetect;
  short dRange;
  short i;
  short dPlanRange;
  ushort lwt;
  short i__76;
  RECT rc;
  short dxkT;
  ushort dp;
  short local_3e;
  short cch;
  undefined4 dpShield;
  HUL *lphul;
  short csh;
  undefined4 crBackSav;
  short k;
  short dxMineral;
  undefined4 crForeSav;
  short fCreatedDC;
  ushort rgCosts [4];
  DV dv;
  char rgch [22];
  
  fCreatedDC = 0;
  if (mdBuild == 3) {
    return;
  }
  if (hdc == 0) {
    fCreatedDC = 1;
    hdc = GetDC(hwnd);
  }
  if (prc == (RECT *)0x0) {
    GetClientRect(hwnd,&rc);
    rc.bottom = rc.bottom + -0x20;
    rc.left = rc.right + -0x144;
    rc.top = dyArial8;
    if (fStarbaseMode == 0) {
      rc.top = 0;
    }
    rc.top = rc.top + yBuildInfoSum;
    rc.right = rc.right + -4;
    FillRect(hdc,&rc,hbrButtonFace);
  }
  else {
    rc.left = prc->left;
    rc.top = prc->top;
    rc.right = prc->right;
    rc.bottom = prc->bottom;
  }
  if (((SHDEF *)lpshdefBuild == (SHDEF *)0x0) && (lpshdefBuild._2_2_ == 0))
  goto BUILD_LReleaseDC;
  lphul = &lpshdefBuild->hul;
  SelectObject(hdc,rghfontArial8[0]);
  HVar14 = hdc;
  pcVar1 = PszGetCompressedString(idsKt);
  DVar9 = GetTextExtent(HVar14,pcVar1,2);
  dxkT = (short)DVar9;
  SelectObject(hdc,rghfontArial8[1]);
  uVar13 = 0x1120;
  pcVar1 = pcRam112004d0;
  HVar14 = hdc;
  uVar2 = _strlen(pcRam112004d0);
  DVar9 = GetTextExtent(HVar14,(LPCSTR)CONCAT22(uVar13,pcVar1),uVar2);
  dxMineral = (int)DVar9 + 6;
  crForeSav = SetTextColor(hdc,0);
  crBackSav = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,
                                      (undefined2)crButtonFace));
  if ((hwndPopup == 0) ||
     ((GlobalPD.grPopup != 0xb ||
      (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory == 0)))) {
    dp = ((HUL *)lphul)->dp;
    local_3e = 0;
    dpShield = DpShieldOfShdef(lpshdefBuild,idPlayer);
LAB_10c8_4737:
    if ((hwndPopup == 0) || (fStarbaseMode == 0)) {
      pctDetect = (short)rgch;
      CchGetString(idsHull,(char *)pctDetect);
      if (mdBuild == 1) {
        pcVar1 = rgch;
      }
      else {
        pcVar1 = (char *)0xcbe;
        unaff_SS = 0x1120;
      }
      pcVar15 = ((HUL *)lphul)->szClass;
      uVar13 = lphul._2_2_;
      pctDetect = unaff_SS;
      pcVar3 = PszGetCompressedString(idsCostOneSS);
      cch = _wsprintf(szWork,pcVar3,pcVar15,uVar13,pcVar1);
    }
    else {
      rc.top = rc.top + dyArial8;
      pctDetect = (short)szWork;
      cch = CchGetString(idsCost,(char *)szWork);
    }
    pctDetect = hdc;
    TextOut(hdc,rc.left,rc.top,szWork,cch);
    rc.left = rc.left + 8;
    rc.right = rc.right + -8;
    pctDetect = (short)rgCosts;
    GetTrueHullCost(idPlayer,lphul,(ushort *)pctDetect);
    if (fStarbaseMode != 0) {
      pctDetect = 3;
      sVar6 = GetRaceGrbit((PLAYER *)rgplr + idPlayer,ibitRaceISB);
      if (sVar6 == 0) {
        pctDetect = 0xe;
        sVar6 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
        if (sVar6 != raMacintosh) goto LAB_10c8_4875;
      }
      for (k = 0; k < 4; k = k + 1) {
        rgCosts[k] = rgCosts[k] - rgCosts[k] / 5;
      }
    }
LAB_10c8_4875:
    if (fStarbaseMode != 0) {
      for (k = 0; k < 4; k = k + 1) {
        rgCosts[k] = rgCosts[k] - rgCosts[k] / 2;
      }
    }
    for (k = 0; k < 6; k = k + 1) {
      if (k == 3) {
        k = 5;
      }
      rc.top = rc.top + dyArial8;
      pctDetect = hdc;
      SelectObject(hdc,rghfontArial8[1]);
      pctDetect = hdc;
      SetTextColor(hdc,CONCAT22(*(undefined2 *)(k * 4 + 0x44a),*(undefined2 *)(k * 4 + 0x448)));
      pctDetect = hdc;
      pcVar1 = (char *)*(undefined2 *)(k * 2 + 0x4cc);
      uVar13 = 0x1120;
      sVar6 = rc.top;
      sVar16 = rc.left;
      sVar4 = lstrlen((char *)*(undefined2 *)(k * 2 + 0x4cc));
      TextOut(pctDetect,sVar16,sVar6,(LPCSTR)CONCAT22(uVar13,pcVar1),sVar4);
      pctDetect = hdc;
      SelectObject(hdc,rghfontArial8[0]);
      pctDetect = hdc;
      SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
      pctDetect = rgCosts[3];
      if (k != 5) {
        pctDetect = rgCosts[k];
      }
      cch = _wsprintf(szWork,PCTD);
      pctDetect = dxMaxMineralQuan;
      RightTextOut
                (hdc,(rc.left + dxMineral + dxMaxMineralQuan) - dxkT,rc.top,
                 (char *)szWork,cch,dxMaxMineralQuan);
      if (k < 5) {
        pctDetect = hdc;
        iVar5 = (rc.left + dxMineral + dxMaxMineralQuan) - dxkT;
        sVar6 = rc.top;
        pcVar1 = PszGetCompressedString(idsKt);
        TextOut(pctDetect,iVar5,sVar6,pcVar1,2);
      }
    }
    rc.left = rc.left + -8;
    rc.top = rc.top + dyArial8;
    pctDetect = hdc;
    SelectObject(hdc,rghfontArial8[1]);
    if (fStarbaseMode == 0) {
      if (((hwndPopup == 0) || (GlobalPD.grPopup != 0xb)) ||
         (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory == 0)) {
        lwt = ((HUL *)lphul)->wtEmpty;
      }
      else {
        lwt = ((TOK *)vrgtok)[viVCRFocus].wt;
      }
      i__76 = 0;
      pctDetect = 0;
      uVar2 = lwt;
      pcVar1 = PszGetCompressedString(idsMassLdkt);
      cch = _wsprintf(szWork,pcVar1,uVar2);
      pctDetect = hdc;
      TextOut(hdc,rc.left,rc.top,szWork,cch);
    }
    rc.top = rc.top + dyArial8 * -4;
    rc.left = rc.left + dxMineral + dxMaxMineralQuan + 0x18;
    if ((fStarbaseMode == 0) &&
       (((hwndPopup == 0 || (GlobalPD.grPopup != 0xb)) ||
        (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory == 0)))) {
      pctDetect = 1;
      pctDetect = WtMaxShdefStat(lpshdefBuild,grStatFuel);
      pcVar1 = PszGetCompressedString(idsDmg);
      cch = _wsprintf(szWork,pcVar1);
      pctDetect = dxMaxMineralQuan;
      RightTextOut
                (hdc,rc.right + -8,rc.top,(char *)szWork,cch,dxMaxMineralQuan);
      pctDetect = (short)szWork;
      cch = CchGetString(idsMaxFuel,(char *)szWork);
      pctDetect = hdc;
      TextOut(hdc,rc.left,rc.top,szWork,cch);
      rc.top = rc.top + dyArial8;
    }
    pctDetect = local_3e;
    uVar2 = dp;
    pcVar1 = PszGetCompressedString(idsLddp);
    cch = _wsprintf(szWork,pcVar1,uVar2);
    pctDetect = dxMaxMineralQuan + 10;
    RightTextOut(hdc,rc.right + -8,rc.top,(char *)szWork,cch,pctDetect);
    pctDetect = (short)szWork;
    cch = CchGetString(idsArmor,(char *)szWork);
    pctDetect = hdc;
    TextOut(hdc,rc.left,rc.top,szWork,cch);
    rc.top = rc.top + dyArial8;
    if (mdBuild != 1) {
      pctDetect = dpShield._2_2_;
      uVar13 = (uint)dpShield;
      if (dpShield == 0) {
        pcVar1 = PszGetCompressedString(idsNone);
      }
      else {
        pcVar1 = (char *)0xcbf;
      }
      cch = _wsprintf(szWork,pcVar1,uVar13);
      pctDetect = dxMaxMineralQuan + 10;
      RightTextOut(hdc,rc.right + -8,rc.top,(char *)szWork,cch,pctDetect);
      pctDetect = (short)szWork;
      cch = CchGetString(idsShields,(char *)szWork);
      pctDetect = hdc;
      TextOut(hdc,rc.left,rc.top,szWork,cch);
    }
    rc.top = rc.top + dyArial8;
    if (mdBuild != 1) {
      pctDetect = lpshdefBuild._2_2_;
      lVar12 = LComputePower(lpshdefBuild);
      uVar13 = (undefined2)((ulong)lpshdefBuild >> 0x10);
      pSVar7 = (SHDEF *)lpshdefBuild;
      *&pSVar7->u_SHDEF_0x0087 = (int)lVar12;
      *(undefined2 *)((int)&pSVar7->u_SHDEF_0x0087 + 2) = (int)((ulong)lVar12 >> 0x10);
      uVar13 = (undefined2)((ulong)lpshdefBuild >> 0x10);
      pSVar7 = (SHDEF *)lpshdefBuild;
      if ((*&pSVar7->u_SHDEF_0x0087 != 0) || (*(int *)((int)&pSVar7->u_SHDEF_0x0087 + 2) != 0)) {
        i = *(short *)((int)&pSVar7->u_SHDEF_0x0087 + 2);
        dRange = *&pSVar7->u_SHDEF_0x0087;
        pctDetect = 0x1120;
        dRange = _wsprintf(szWork,PCTLD);
        i = dxMaxMineralQuan;
        pctDetect = (short)szWork;
        cch = dRange;
        RightTextOut
                  (hdc,rc.right + -8,rc.top,(char *)szWork,dRange,
                   dxMaxMineralQuan);
        i = (short)szWork;
        dRange = 0x306;
        pctDetect = 0x1040;
        cch = CchGetString(idsRating,(char *)szWork);
        i = hdc;
        dRange = rc.left;
        pctDetect = rc.top;
        TextOut(hdc,rc.left,rc.top,szWork,cch);
        rc.top = rc.top + dyArial8;
      }
    }
    if (((uint)gd.grBits >> 0xe != 0) && (mdBuild != 1)) {
      if (mdBuild == 2) {
        i__76 = -1;
      }
      else {
        i__76 = idPlayer;
      }
      pctDetect = 0;
      i__76 = PctCloakFromHuldef(&lpshdefBuild->hul,i__76,(short *)0x0);
      pctDetect = lpshdefBuild._2_2_;
      pctDetect = PctJammerFromHul(&lpshdefBuild->hul);
      sVar6 = i__76;
      lwt = pctDetect;
      pcVar1 = PszGetCompressedString(idsDD4);
      cch = _wsprintf(szWork,pcVar1,sVar6);
      pctDetect = dxMaxMineralQuan;
      RightTextOut
                (hdc,rc.right + -8,rc.top,(char *)szWork,cch,dxMaxMineralQuan);
      pctDetect = (short)szWork;
      cch = CchGetString(idsCloakJam,(char *)szWork);
      pctDetect = hdc;
      TextOut(hdc,rc.left,rc.top,szWork,cch);
      rc.top = rc.top + dyArial8;
      pctDetect = 0;
      i__76 = InitFromHuldef(&lpshdefBuild->hul,(short *)0x0);
      if ((fStarbaseMode == 0) &&
         (pctDetect = (short)((ulong)lpshdefBuild >> 0x10),
         (((SHDEF *)lpshdefBuild)->hul).rghs[0].wFlags_0x2 >> 8 != 0)) {
        sVar6 = SpdOfShip((FLEET *)0x0,0,(TOK *)0x0,0,lpshdefBuild);
        lwt = sVar6 + 1;
      }
      else {
        lwt = 0;
      }
      iVar5 = lwt * 3 + 0xca0;
      pctDetect = 0x1120;
      sVar6 = i__76;
      pcVar1 = PszGetCompressedString(idsDS);
      cch = _wsprintf(szWork,pcVar1,sVar6,iVar5);
      pctDetect = dxMaxMineralQuan;
      RightTextOut
                (hdc,rc.right + -8,rc.top,(char *)szWork,cch,dxMaxMineralQuan);
      pctDetect = (short)szWork;
      cch = CchGetString
                      ((0xe < dyArial8) + idsInitiativeMoves,(char *)szWork);
      pctDetect = hdc;
      TextOut(hdc,rc.left,rc.top,szWork,cch);
      rc.top = rc.top + dyArial8;
      if (fStarbaseMode == 0) {
        if (mdBuild == 2) {
          i = -1;
        }
        else {
          i = idPlayer;
        }
        pctDetect = 0;
        sVar6 = GetShdefScannerRange
                          (lpshdefBuild,i,&dPlanRange,&pctDetect,(short *)0x0);
        dRange = sVar6;
        if (0 < sVar6) {
          if (pctDetect < 100) {
            pcVar1 = PszGetCompressedString(idsDDD);
            cch = _wsprintf(szWork,pcVar1,sVar6,dPlanRange);
          }
          else {
            pctDetect = dPlanRange;
            pcVar1 = PszGetCompressedString(idsDD6);
            cch = _wsprintf(szWork,pcVar1,sVar6);
          }
          pctDetect = dxMaxMineralQuan + 0x28;
          RightTextOut(hdc,rc.right + -8,rc.top,(char *)szWork,cch,pctDetect);
          pctDetect = (short)szWork;
          cch = CchGetString
                          ((0xe < dyArial8) + idsScannerRange2,(char *)szWork);
          pctDetect = hdc;
          TextOut(hdc,rc.left,rc.top,szWork,cch);
          rc.top = rc.top + dyArial8;
        }
      }
      else {
        pctDetect = 0xe;
        sVar6 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
        if (sVar6 == raMacintosh) {
          pctDetect = 0;
          iVar5 = ((lpshdefBuild->hul).ihuldef - ihuldefCount) * 4;
          uVar11 = __aFulmul(CONCAT22(*(undefined2 *)(iVar5 + 0x8ce),
                                              *(undefined2 *)(iVar5 + 0x8cc)),100);
          pctDetect = (short)(uVar11 >> 0x10);
          cch = CommaFormatLong((char *)szWork,uVar11);
          pctDetect = dxMaxMineralQuan + 0x10;
          RightTextOut(hdc,rc.right + -8,rc.top,(char *)szWork,cch,pctDetect);
          pctDetect = (short)szWork;
          cch = CchGetString
                          ((0xe < dyArial8) + idsMaxPopulation,(char *)szWork);
          pctDetect = hdc;
          TextOut(hdc,rc.left,rc.top,szWork,cch);
          rc.top = rc.top + dyArial8;
        }
      }
    }
    if (((hwndPopup != 0) && (GlobalPD.grPopup == 0xb)) &&
       (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur != 0)) {
      if (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory == 0) {
        if (fStarbaseMode == 0) {
          uVar13 = (undefined2)((ulong)lpshdefBuild >> 0x10);
          if (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary == 0) {
            k = ((SHDEF *)lpshdefBuild)->wFlags >> 10 & 0x1f;
            csh = *(short *)((int)&sel.fl + 0xc + k * 2);
            dv.dp = *(ushort *)((int)&sel.fl + 0x2c + k * 2);
          }
          else {
            k = ((SHDEF *)lpshdefBuild)->wFlags >> 10 & 0x1f;
            csh = *(short *)(*(int *)((FLEET **)rglpfl + sel.scan.ifl) + 0xc +
                            k * 2);
            dv.dp = *(ushort *)
                     (*(int *)((FLEET **)rglpfl + sel.scan.ifl) + 0x2c + k * 2);
          }
        }
        else {
          dv.dp = 0;
          if (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary == 0) {
            i__76 = (uint)sel.pl.lStarbase >> 4;
            dv.dp = i__76 << 7;
          }
          else {
            pctDetect = sel.scan.idpl;
            pPVar10 = LpplFromId(sel.scan.idpl);
            i__76 = *(uint *)&((PLANET *)pPVar10)->lStarbase >> 4;
            dv.dp = dv.dp & 0x7f | i__76 << 7;
          }
          csh = 1;
          if (dv.dp >> 7 != 0) {
            dv.dp = dv.dp & 0xff80 | 100;
          }
        }
      }
      if (dv.dp == 0) {
        dp = 0;
      }
      else {
        pctDetect = hdc;
        SetTextColor(hdc,0x7f);
        i__76 = dv.dp / 0x280;
        if (i__76 == 0) {
          i__76 = 1;
        }
        pctDetect = 0;
        uVar13 = 100;
        uVar11 = __aFulmul((long)csh,(ulong)(dv.dp & 0x7f));
        lVar12 = __aFldiv(uVar11,CONCAT22(pctDetect,uVar13));
        csh = (short)lVar12;
        if (csh < 1) {
          csh = 1;
        }
        if (fStarbaseMode == 0) {
          pctDetect = i__76;
          iVar5 = csh >> 0xf;
          sVar6 = csh;
          pcVar1 = PszGetCompressedString(idsLdD);
          cch = _wsprintf(szWork,pcVar1,sVar6,iVar5);
        }
        else {
          pctDetect = i__76;
          cch = _wsprintf(szWork,PCTDPCTPCT);
        }
        dp = 1;
      }
      local_3e = 0;
      if (dp != 0) {
        pctDetect = dxMaxMineralQuan + 0xf;
        RightTextOut(hdc,rc.right + -8,rc.top,(char *)szWork,cch,pctDetect);
        pctDetect = (short)szWork;
        cch = CchGetString(idsDamage,(char *)szWork);
        pctDetect = hdc;
        TextOut(hdc,rc.left,rc.top,szWork,cch);
      }
    }
  }
  else {
    GetVCRStats(viVCRFocus,&dp,&dv,&dpShield,&csh);
    bVar8 = ((TOK *)vrgtok)[viVCRFocus].dpShield < (uint)dpShield;
    dpShield._0_2_ = ((TOK *)vrgtok)[viVCRFocus].dpShield - (uint)dpShield;
    dpShield._2_2_ = -(uint)bVar8 - dpShield._2_2_;
    if ((dpShield._2_2_ < 1) && (dpShield._2_2_ < 0)) {
      dpShield._0_2_ = 0;
      dpShield._2_2_ = 0;
    }
    dpShield = __aFulmul(CONCAT22(dpShield._2_2_,(uint)dpShield),(long)csh);
    if (csh != 0) goto LAB_10c8_4737;
  }
  pctDetect = hdc;
  SelectObject(hdc,rghfontArial8[0]);
  pctDetect = hdc;
  SetTextColor(hdc,crForeSav);
  pctDetect = hdc;
  SetBkColor(hdc,crBackSav);
BUILD_LReleaseDC:
  if (fCreatedDC != 0) {
    pctDetect = hwnd;
    ReleaseDC(hwnd,hdc);
  }
  return;
}



// ======================================================================
// Function: SetBuildSelection
// Address: 10c8:53da
// Segment: MEMORY_BUILD
// ======================================================================


void SetBuildSelection(short iSrc)

{
  undefined2 unaff_SS;
  RECT rc;
  short iSelOld;
  
  if (iSrc == iselSlot) {
    if (iSrc != -1) {
      return;
    }
  }
  else {
    iSelOld = iselSlot;
    iselSlot = iSrc;
    GetClientRect(hwndSlotDlg,&rc);
    if (-1 < iSelOld) {
      DrawSlotDlg(hwndSlotDlg,0,&rc,iSelOld);
    }
    if (-1 < iselSlot) {
      DrawSlotDlg(hwndSlotDlg,0,&rc,iselSlot);
    }
  }
  DrawBuildSelComp(hwndSlotDlg,0,-1);
  return;
}



// ======================================================================
// Function: IDropPart
// Address: 10c8:5476
// Segment: MEMORY_BUILD
// ======================================================================


short IDropPart(POINT pt,HS hsSrc,short iSrc,short fNoModify)

{
  uint *puVar1;
  ushort uVar2;
  uint uVar3;
  BOOL BVar4;
  int iVar5;
  short sVar6;
  undefined2 uVar7;
  HS *pHVar8;
  undefined2 unaff_SS;
  HULDEF *pHVar9;
  RECT rc;
  HullSlotType hsDst;
  uint local_10;
  HullSlotType hsHul;
  uint local_c;
  short i;
  short cNew;
  short cSlot;
  
  GetClientRect(hwndSlotDlg,&rc);
  uVar3 = GetAsyncKeyState(0x11);
  if ((uVar3 & 0xfffe) == 0) {
    uVar3 = GetAsyncKeyState(0x10);
    if ((uVar3 & 0xfffe) == 0) {
      if (-1 < iSrc) {
        hsSrc = (HS)((ulong)hsSrc & 0xffffff | 0x1000000);
      }
    }
    else if ((iSrc < 0) || (4 < hsSrc.wFlags_0x2 >> 8)) {
      hsSrc = (HS)((ulong)hsSrc & 0xffffff | 0x4000000);
    }
  }
  else if (iSrc < 0) {
    hsSrc = (HS)((ulong)hsSrc & 0xffffff | 0x64000000);
  }
  pHVar9 = LphuldefFromId((lpshdefBuild->hul).ihuldef);
  cSlot = (short)(((HULDEF *)pHVar9)->hul).chs;
  i = 0;
  while ((i < cSlot && (BVar4 = PtInRect((RECT *)vrgrcSlot + i,pt), BVar4 == 0))) {
    i = i + 1;
  }
  if (i == cSlot) {
    if (pt.x < rc.right >> 1) {
      if ((fNoModify == 0) && (-1 < iSrc)) {
        if ((((((SHDEF *)lpshdefBuild)->hul).rghs + iSrc)->grhst & hstEngine) !=
            ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
              hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
          hsSrc.grhst = ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|
                          hstSpecialSB|hstMines|hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield
                          |hstScanner|hstEngine);
          hsSrc.wFlags_0x2 = 0x6400;
        }
        if (((((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags_0x2 >> 8) -
            (hsSrc.wFlags_0x2 >> 8) < 0x8000) {
          iVar5 = ((((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags_0x2 >> 8) -
                  (hsSrc.wFlags_0x2 >> 8);
        }
        else {
          iVar5 = 0;
        }
        (((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags_0x2 =
             (((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags_0x2 & 0xff | iVar5 << 8;
        UpdateShdefCost(lpshdefBuild);
        GetClientRect(hwndSlotDlg,&rc);
        DrawSlotDlg(hwndSlotDlg,0,&rc,iSrc);
        rc.top = yBuildInfoSum;
        InvalidateRect(hwndSlotDlg,&rc,1);
        DrawBuildSelComp(hwndSlotDlg,0,-1);
        DrawBuildSelHull(hwndSlotDlg,0,-1,(RECT *)0x0);
        if (((uint)gd.grBits >> 0xb & 1) != 0) {
          AdvanceTutor();
        }
      }
      sVar6 = 1;
    }
    else {
      sVar6 = 0;
    }
  }
  else {
    pHVar8 = (((SHDEF *)lpshdefBuild)->hul).rghs + i;
    hsDst = pHVar8->grhst;
    local_10 = pHVar8->wFlags_0x2;
    pHVar9 = LphuldefFromId((lpshdefBuild->hul).ihuldef);
    uVar7 = (undefined2)((ulong)pHVar9 >> 0x10);
    pHVar8 = (((HULDEF *)pHVar9)->hul).rghs + i;
    hsHul = pHVar8->grhst;
    local_c = pHVar8->wFlags_0x2;
    if ((hsHul & hstEngine) !=
        ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
          hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
      hsSrc = (HS)((ulong)hsSrc & 0xffffff | 0x64000000);
    }
    if (i == iSrc) {
      sVar6 = 2;
    }
    else {
      if (local_10 >> 8 < local_c >> 8) {
        if (((local_10 >> 8 == 0) ||
            ((hsDst == hsSrc.grhst && ((local_10 & 0xff) == (hsSrc.wFlags_0x2 & 0xff))))) &&
           ((local_10 >> 8 != 0 ||
            ((hsSrc.grhst & hsHul) !=
             ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines
               |hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine))))) {
          if (fNoModify == 0) {
            hsDst = hsSrc.grhst;
            if ((local_10 >> 8) + (hsSrc.wFlags_0x2 >> 8) < local_c >> 8) {
              cNew = (local_10 >> 8) + (hsSrc.wFlags_0x2 >> 8);
            }
            else {
              cNew = local_c >> 8;
            }
            if (-1 < iSrc) {
              uVar2 = (((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags_0x2;
              puVar1 = &(((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags_0x2;
              *puVar1 = *puVar1 & 0xff;
              puVar1 = &(((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags_0x2;
              *puVar1 = *puVar1 | uVar2 + (cNew - (local_10 >> 8)) * -0x100 & 0xff00;
            }
            local_10 = hsSrc.wFlags_0x2 & 0xff | cNew << 8;
            uVar7 = lpshdefBuild._2_2_;
            pHVar8 = (((SHDEF *)lpshdefBuild)->hul).rghs + i;
            pHVar8->grhst = hsSrc.grhst;
            pHVar8->wFlags_0x2 = local_10;
            UpdateShdefCost(lpshdefBuild);
            SetBuildSelection(i);
            GetClientRect(hwndSlotDlg,&rc);
            rc.top = yBuildInfoSum;
            InvalidateRect(hwndSlotDlg,&rc,1);
            if (((uint)gd.grBits >> 0xb & 1) != 0) {
              AdvanceTutor();
            }
          }
          return -1;
        }
      }
      if (fNoModify == 0) {
        MessageBeep(0);
      }
      sVar6 = 3;
    }
  }
  return sVar6;
}



// ======================================================================
// Function: DrawDlgLBEntireItem
// Address: 10c8:59f0
// Segment: MEMORY_BUILD
// ======================================================================


void DrawDlgLBEntireItem(DRAWITEMSTRUCT *lpdis,short inflate)

{
  short sVar1;
  HGDIOBJ HVar2;
  int iVar3;
  ushort uVar4;
  int iVar5;
  undefined2 unaff_SS;
  char *pcVar6;
  undefined2 uVar7;
  RECT *pRVar8;
  ushort uVar9;
  RECT rc;
  short bkSav;
  short ibmp;
  COLORREF crForeSav;
  int cr;
  int local_6;
  
  CopyRect(&rc,(RECT *)CONCAT22(lpdis._2_2_,&((DRAWITEMSTRUCT *)lpdis)->rcItem));
  uVar9 = ((DRAWITEMSTRUCT *)lpdis)->hDC;
  pRVar8 = &((DRAWITEMSTRUCT *)lpdis)->rcItem;
  if ((((DRAWITEMSTRUCT *)lpdis)->itemState & 0x10) == 0) {
    sVar1 = 0;
  }
  else {
    sVar1 = 4;
  }
  uVar7 = lpdis._2_2_;
  HVar2 = GetStockObject(sVar1);
  FillRect(uVar9,(RECT *)CONCAT22(uVar7,pRVar8),HVar2);
  InflateRect(&rc,-2,-1);
  SendMessage(((DRAWITEMSTRUCT *)lpdis)->hwndItem,0x40a,((DRAWITEMSTRUCT *)lpdis)->itemID,0x112057a4
             );
  SelectPalette(((DRAWITEMSTRUCT *)lpdis)->hDC,vhpal,0);
  RealizePalette(((DRAWITEMSTRUCT *)lpdis)->hDC);
  ibmp = szWork[2] + -0x41 + (szWork[3] + -0x41) * 0x1a;
  DibBlt(((DRAWITEMSTRUCT *)lpdis)->hDC,rc.left,rc.top,0x40,0x40,
                  ((ushort *)rghdibInventory)[ibmp >> 5],(ibmp & 7U) << 6,
                  (3U - (ibmp >> 3) & 3) << 6,0x40,0x40,0xcc0020);
  cr = (int)crWindow;
  local_6 = crWindow._2_2_;
  if ((((DRAWITEMSTRUCT *)lpdis)->itemState & 0x10) == 0) {
    if (((int)crWindow == 0) && (crWindow._2_2_ == 0)) {
      cr = -1;
      local_6 = 0xff;
    }
    else {
      cr = 0;
      local_6 = 0;
    }
  }
  crForeSav = SetTextColor(((DRAWITEMSTRUCT *)lpdis)->hDC,CONCAT22(local_6,cr));
  bkSav = SetBkMode(((DRAWITEMSTRUCT *)lpdis)->hDC,1);
  uVar9 = ((DRAWITEMSTRUCT *)lpdis)->hDC;
  iVar3 = rc.left + 0x42;
  iVar5 = (rc.top + 0x20) - (dyArial8 >> 1);
  uVar7 = 0x1120;
  pcVar6 = (char *)szWork + 4;
  uVar4 = _strlen((char *)szWork + 4);
  TextOut(uVar9,iVar3,iVar5,(LPCSTR)CONCAT22(uVar7,pcVar6),uVar4);
  SetTextColor(((DRAWITEMSTRUCT *)lpdis)->hDC,crForeSav);
  SetBkMode(((DRAWITEMSTRUCT *)lpdis)->hDC,bkSav);
  HandleFocusState(lpdis,inflate + 2);
  return;
}



// ======================================================================
// Function: NthValidShdef
// Address: 10c8:5c06
// Segment: MEMORY_BUILD
// ======================================================================


SHDEF * NthValidShdef(short n)

{
  SHDEF *pSVar1;
  undefined2 uVar2;
  bool bVar3;
  short i;
  
  if (fStarbaseMode == 0) {
    for (i = 0; i < 0x10; i = i + 1) {
      if (((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0) &&
         (bVar3 = n == 0, n = n + -1, bVar3)) {
        pSVar1 = (SHDEF *)(i * 0x93 + 0x3f00);
        uVar2 = 0x1120;
        goto LAB_10c8_5cee;
      }
    }
  }
  else {
    for (i = 0; i < 10; i = i + 1) {
      if (((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) &&
         (bVar3 = n == 0, n = n + -1, bVar3)) {
        uVar2 = *(undefined2 *)(idPlayer * 4 + 0x14e);
        pSVar1 = (SHDEF *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93);
        goto LAB_10c8_5cee;
      }
    }
  }
  pSVar1 = (SHDEF *)0x0;
  uVar2 = 0;
LAB_10c8_5cee:
  return (SHDEF *)CONCAT22(uVar2,pSVar1);
}



// ======================================================================
// Function: NthValidEnemyShdef
// Address: 10c8:5cf4
// Segment: MEMORY_BUILD
// ======================================================================


SHDEF * NthValidEnemyShdef(short n)

{
  SHDEF *pSVar1;
  undefined2 uVar2;
  bool bVar3;
  short j;
  short i;
  
  if (fStarbaseMode == 0) {
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (((*(int *)(i * 4 + 0xfe) != 0) || (*(int *)(i * 4 + 0x100) != 0)) &&
         (i != idPlayer)) {
        for (j = 0; j < 0x10; j = j + 1) {
          if (((*(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) >> 9 & 1) == 0) &&
             (bVar3 = n == 0, n = n + -1, bVar3)) {
            uVar2 = *(undefined2 *)(i * 4 + 0x100);
            pSVar1 = (SHDEF *)(*(int *)(i * 4 + 0xfe) + j * 0x93);
            goto LAB_10c8_5e79;
          }
        }
      }
    }
  }
  else {
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (((*(int *)(i * 4 + 0x14c) != 0) || (*(int *)(i * 4 + 0x14e) != 0)) &&
         (i != idPlayer)) {
        for (j = 0; j < 10; j = j + 1) {
          if (((*(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) >> 9 & 1) == 0) &&
             (bVar3 = n == 0, n = n + -1, bVar3)) {
            uVar2 = *(undefined2 *)(i * 4 + 0x14e);
            pSVar1 = (SHDEF *)(*(int *)(i * 4 + 0x14c) + j * 0x93);
            goto LAB_10c8_5e79;
          }
        }
      }
    }
  }
  pSVar1 = (SHDEF *)0x0;
  uVar2 = 0;
LAB_10c8_5e79:
  return (SHDEF *)CONCAT22(uVar2,pSVar1);
}



// ======================================================================
// Function: FillBuildDD
// Address: 10c8:5e80
// Segment: MEMORY_BUILD
// ======================================================================


void FillBuildDD(HWND hwndDD,short md)

{
  HWND HVar1;
  int iVar2;
  BOOL BVar3;
  ushort uVar4;
  short sVar5;
  int iVar6;
  undefined2 unaff_SS;
  LRESULT LVar7;
  char *pcVar8;
  undefined2 uVar9;
  WPARAM WVar10;
  UINT UVar11;
  PART part;
  RECT rc;
  int lpshdef;
  int local_10;
  short j;
  short i;
  short fAdded;
  short fProgress;
  short ishdefMac;
  
  SendMessage(hwndDD,0x40b,0,0);
  if (md != 0) {
    HVar1 = GetDlgItem(hwndSlotDlg,0x817);
    EnableWindow(HVar1,0);
    HVar1 = GetDlgItem(hwndSlotDlg,0x818);
    EnableWindow(HVar1,0);
  }
  if (fStarbaseMode == 0) {
    ishdefMac = 0x10;
    lpshdef = 0x3f00;
    local_10 = 0x1120;
  }
  else {
    ishdefMac = 10;
    lpshdef = *(int *)(idPlayer * 4 + 0x14c);
    local_10 = *(int *)(idPlayer * 4 + 0x14e);
  }
  i = 0;
  while ((i < ishdefMac && ((*(uint *)(lpshdef + i * 0x93 + 0x7b) >> 9 & 1) == 0))) {
    i = i + 1;
  }
  if ((((md == 0) || (md == 1)) || (md == 2)) && (i < ishdefMac)) {
    fAdded = 1;
  }
  else {
    fAdded = 0;
  }
  HVar1 = GetDlgItem(hwndSlotDlg,0x816);
  EnableWindow(HVar1,fAdded);
  if (md != 0) {
    if (md == 1) {
      if (fStarbaseMode == 0) {
        part.hs.grhst = hstHull;
        j = 0x20;
      }
      else {
        part.hs.grhst = hstSBHull;
        j = 5;
      }
      for (i = 0; i < j; i = i + 1) {
        part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | i & 0xffU;
        sVar5 = FLookupPart(&part);
        if (sVar5 == 1) {
          SendMessage(hwndDD,0x403,0,
                      (LPARAM)CONCAT22(part.u_PART_0x0004._2_2_,
                                       (part.u_PART_0x0004.parmor._0_2_)->szName));
        }
      }
      goto LAB_10c8_632a;
    }
    if (md == 2) {
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if (i != idPlayer) {
          if (fStarbaseMode == 0) {
            lpshdef = *(int *)(i * 4 + 0xfe);
            local_10 = *(int *)(i * 4 + 0x100);
          }
          else {
            lpshdef = *(int *)(i * 4 + 0x14c);
            local_10 = *(int *)(i * 4 + 0x14e);
          }
          if ((lpshdef != 0) || (local_10 != 0)) {
            for (j = 0; j < ishdefMac; j = j + 1) {
              if ((*(uint *)(lpshdef + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
                PszPlayerName(i,1,0,0,0,(PLAYER *)0x0);
                iVar6 = lpshdef + j * 0x93 + 8;
                uVar9 = 0x1120;
                pcVar8 = (char *)0xcc5;
                iVar2 = local_10;
                uVar4 = _strlen((char *)szWork);
                _wsprintf((char *)szWork + uVar4,(char *)CONCAT22(uVar9,pcVar8),iVar6,
                          iVar2);
                SendMessage(hwndDD,0x403,0,0x112057a4);
              }
            }
          }
        }
      }
      goto LAB_10c8_632a;
    }
    if ((md == 3) || (md == 4)) {
      if (fStarbaseMode == 0) {
        for (i = 0; i < 0xd; i = i + 1) {
          UVar11 = 0x403;
          WVar10 = 0;
          HVar1 = hwndDD;
          pcVar8 = PszGetCompressedString(*(StringId *)(i * 2 + rgidsParts));
          SendMessage(HVar1,UVar11,WVar10,(LPARAM)pcVar8);
        }
      }
      else {
        for (i = 0; i < 8; i = i + 1) {
          UVar11 = 0x403;
          WVar10 = 0;
          HVar1 = hwndDD;
          pcVar8 = PszGetCompressedString(*(StringId *)(i * 2 + rgidsPartsSB));
          SendMessage(HVar1,UVar11,WVar10,(LPARAM)pcVar8);
        }
      }
      goto LAB_10c8_632a;
    }
  }
  fAdded = 0;
  for (i = 0; i < ishdefMac; i = i + 1) {
    if ((*(uint *)(lpshdef + i * 0x93 + 0x7b) >> 9 & 1) == 0) {
      if (fAdded == 0) {
        if (fStarbaseMode == 0) {
          iVar2 = 0;
        }
        else {
          iVar2 = 0x10;
        }
        CshQueued(iVar2 + i,&fProgress,0);
        HVar1 = GetDlgItem(hwndSlotDlg,0x818);
        iVar2 = lpshdef + i * 0x93;
        if (((*(int *)(iVar2 + 0x83) == 0) && (*(int *)(iVar2 + 0x85) == 0)) && (fProgress == 0)) {
          BVar3 = 1;
        }
        else {
          BVar3 = 0;
        }
        EnableWindow(HVar1,BVar3);
        HVar1 = GetDlgItem(hwndSlotDlg,0x817);
        EnableWindow(HVar1,1);
        iVar2 = lpshdef + i * 0x93;
        if ((*(int *)(iVar2 + 0x83) == 0) && (*(int *)(iVar2 + 0x85) == 0)) {
          iVar2 = 0;
        }
        else {
          iVar2 = 1;
        }
        fAdded = iVar2 + 1;
      }
      SendMessage(hwndDD,0x403,0,CONCAT22(local_10,lpshdef + i * 0x93 + 8));
    }
  }
LAB_10c8_632a:
  LVar7 = SendMessage(hwndDD,0x406,0,0);
  i = (short)LVar7;
  if (0x20 < i) {
    i = 0x20;
  }
  GetWindowRect(hwndDD,&rc);
  SetWindowPos(hwndDD,0,0,0,rc.right - rc.left,
               (i + 1) * (dyArial8 - (uint)(dyArial8 < 0xf)) + 8 +
               (uint)(0xe < dyArial8),6);
  SendMessage(hwndDD,0x40e,0,0);
  return;
}



// ======================================================================
// Function: FillBuildPartsLB
// Address: 10c8:63e8
// Segment: MEMORY_BUILD
// ======================================================================


void FillBuildPartsLB(HWND hwndLB,short grbit)

{
  ARMOR *pAVar1;
  undefined2 uVar2;
  undefined2 unaff_SS;
  PART part;
  short grbitCur;
  char sz;
  char local_cf;
  char local_ce;
  char local_cd;
  char local_cc [196];
  short i;
  short mdAvail;
  
  grbitCur = 1;
  sz = 'A';
  SendMessage(hwndLB,0x405,0,0);
  for (; grbitCur != 0; grbitCur = grbitCur << 1) {
    if ((grbitCur & grbit) != 0) {
      i = 0;
      part.hs.grhst = grbitCur;
      while( true ) {
        part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | i & 0xffU;
        mdAvail = FLookupPart(&part);
        if (mdAvail == 0) break;
        if (((fStarbaseMode != 0) && (grbitCur == 0x800)) && ((i == 0xf || (i == 0x10))))
        {
          mdAvail = -1;
        }
        if (mdAvail == 1) {
          local_cf = (char)i + 'A';
          uVar2 = part.u_PART_0x0004._2_2_;
          pAVar1 = (ARMOR *)part.u_PART_0x0004.parmor;
          local_ce = (char)(pAVar1->ibmp % 0x1a) + 'A';
          local_cd = (char)(pAVar1->ibmp / 0x1a) + 'A';
          __fstrcpy(local_cc,(char *)CONCAT22(uVar2,pAVar1->szName));
          SendMessage(hwndLB,0x401,0,(LPARAM)&sz);
        }
        i = i + 1;
      }
    }
    sz = sz + '\x01';
  }
  return;
}



// ======================================================================
// Function: UpdateSlotGlobals
// Address: 10c8:6528
// Segment: MEMORY_BUILD
// ======================================================================


void UpdateSlotGlobals(void)

{
  byte bVar1;
  uint uVar2;
  HULDEF *pHVar3;
  undefined2 uVar4;
  HULDEF *pHVar5;
  HULDEF *lphuldef;
  short xLeft;
  ushort wrc;
  short i;
  short cSlot;
  short yTop;
  
  if (((SHDEF *)lpshdefBuild != (SHDEF *)0x0) || (lpshdefBuild._2_2_ != 0)) {
    pHVar5 = LphuldefFromId((lpshdefBuild->hul).ihuldef);
    uVar4 = (undefined2)((ulong)pHVar5 >> 0x10);
    pHVar3 = (HULDEF *)pHVar5;
    if (hwndSlotDlg == 0) {
      xLeft = 0xc;
      yTop = dyArial8 + 0xc;
    }
    else {
      xLeft = ptslotGlob.x + -0x14a;
      yTop = 0x20;
    }
    bVar1 = (pHVar3->hul).chs;
    for (i = 0; i < (int)(uint)bVar1; i = i + 1) {
      ((RECT *)vrgrcSlot + i)->left = (pHVar3->rgbrc[i] & 0xf) * 0x20 + xLeft;
      *(int *)((int)&vrgrcSlot[0].top + i * 8) =
           ((int)(uint)pHVar3->rgbrc[i] >> 4) * 0x20 + yTop;
      *(int *)((int)&vrgrcSlot[0].right + i * 8) =
           ((RECT *)vrgrcSlot + i)->left + 0x40;
      *(int *)((int)&vrgrcSlot[0].bottom + i * 8) =
           *(int *)((int)&vrgrcSlot[0].top + i * 8) + 0x40;
    }
    if ((pHVar3->hul).wtCargoMax != 0) {
      uVar2 = pHVar3->wrcCargo;
      rcCargo.left = (uVar2 >> 8 & 0xf) * 0x20 + xLeft;
      rcCargo.top = ((int)(uVar2 >> 8) >> 4) * 0x20 + yTop;
      rcCargo.right = (uVar2 & 0xf) * 0x20 + xLeft;
      rcCargo.bottom = ((int)(uVar2 & 0xff) >> 4) * 0x20 + yTop;
    }
    ptPlaque.x = xLeft + 0x102;
    ptPlaque.y = yTop + 0x111;
  }
  return;
}



// ======================================================================
// Function: IEmptyBmpFromGrhst
// Address: 10c8:6716
// Segment: MEMORY_BUILD
// ======================================================================


short IEmptyBmpFromGrhst(HullSlotType grhst)

{
  short i;
  
  i = 0;
  while( true ) {
    if (0x14 < i) {
      return 0;
    }
    if (*(HullSlotType *)(i * 2 + 0xc52) == grhst) break;
    i = i + 1;
  }
  return i;
}



// ======================================================================
// Function: FakeListProc
// Address: 10c8:6758
// Segment: MEMORY_BUILD
// ======================================================================


long FakeListProc(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  uint uVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar2;
  LRESULT LVar3;
  short fListBox;
  short fRightBtn;
  int in_stack_0000fff8;
  short iSel;
  
  uVar2 = CONCAT22(unaff_SI,unaff_DI);
  if (msg == 0x20) {
    GetCursorPos(&stack0xfff8);
    ScreenToClient(hwnd,&stack0xfff8);
    if (in_stack_0000fff8 < 0x40) {
      setcursor(hcurHand);
      return 1;
    }
  }
  else if ((((msg == 0x201) || (msg == 0x204)) && ((uint)lParam < 0x40)) &&
          ((mdBuild == 4 || (msg == 0x204)))) {
    CallWindowProc((fn_lpfnRealListProc *)
                   CONCAT22(lpfnRealListProc._2_2_,
                            (fn_lpfnRealListProc *)lpfnRealListProc),hwnd,0x201,wParam,
                   lParam);
    CallWindowProc((fn_lpfnRealListProc *)
                   CONCAT22(lpfnRealListProc._2_2_,
                            (fn_lpfnRealListProc *)lpfnRealListProc),hwnd,0x202,wParam,
                   lParam);
    if ((msg != 0x204) && (mdBuild == 4)) {
      fRightBtn = 0;
      fListBox = 1;
      uVar2 = __aFulshr(CONCAT22(1,wParam),0);
      FTrackSlot(hwnd,(uint)lParam,(short)uVar2,wParam,fListBox,fRightBtn);
      return 0;
    }
    LVar3 = SendMessage(hwnd,0x409,0,0);
    if ((WPARAM)LVar3 != 0xffff) {
      SendMessage(hwnd,0x40a,(WPARAM)LVar3,0x112057a4);
      GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = 1 << (szWork[0] + 0xbfU & 0x1f);
      uVar1 = (int)szWork[1] - 0x41;
      GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 =
           GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 & 0xff00 | uVar1 & 0xff;
      FLookupPart((PART *)&GlobalPD.u_POPUPDATA_0x0002.part);
      GlobalPD.grPopup = 9;
      uVar2 = __aFulshr(uVar2,uVar1);
      Popup(hwnd,(uint)lParam,(short)uVar2);
      return 0;
    }
    return 0;
  }
  LVar3 = CallWindowProc((fn_lpfnRealListProc *)
                         CONCAT22(lpfnRealListProc._2_2_,
                                  (fn_lpfnRealListProc *)lpfnRealListProc),hwnd,msg,wParam
                         ,lParam);
  return LVar3;
}



// ======================================================================
// Function: MakeNewName
// Address: 10c8:694c
// Segment: MEMORY_BUILD
// ======================================================================


void MakeNewName(char *lpsz)

{
  ushort uVar1;
  short cLen;
  
  uVar1 = __fstrlen(lpsz);
  if ((int)uVar1 < 0x1c) {
    if (((((char *)lpsz)[uVar1 - 1] == ')') &&
        ((*(byte *)(((char *)lpsz)[uVar1 - 2] + 0x175f) & 4) != 0)) &&
       (((char *)lpsz)[uVar1 - 3] == '(')) {
      if (((char *)lpsz)[uVar1 - 2] == '9') {
        ((char *)lpsz)[uVar1 - 2] = '0';
      }
      else {
        ((char *)lpsz)[uVar1 - 2] = ((char *)lpsz)[uVar1 - 2] + '\x01';
      }
    }
    else {
      __fstrcpy((char *)CONCAT22(lpsz._2_2_,(char *)lpsz + uVar1),(char *)0x11200cc9);
    }
  }
  FStringFitsScreen(lpsz,0xa0);
  return;
}



// ======================================================================
// Function: KillQueuedMassPackets
// Address: 10c8:6a52
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10c86b1c) */
/* WARNING: Removing unreachable block (ram,0x10c86afc) */
/* WARNING: Removing unreachable block (ram,0x10c86b21) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10c86b49) */
/* WARNING: Removing unreachable block (ram,0x10c86b4e) */

void KillQueuedMassPackets(PLANET *lppl)

{
  undefined2 uVar1;
  undefined2 uVar2;
  PLANET *pPVar3;
  undefined2 *puVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  undefined2 uVar6;
  ulong uVar7;
  ulong uVar8;
  PROD *lpprod;
  short iDst;
  short iprod;
  
  uVar8 = CONCAT22(unaff_SI,unaff_DI);
  uVar5 = (undefined2)((ulong)lppl >> 0x10);
  pPVar3 = (PLANET *)lppl;
  if (((*(int *)&pPVar3->lpplprod != 0) || (*(int *)((int)&pPVar3->lpplprod + 2) != 0)) &&
     (((PLPROD *)pPVar3->lpplprod)->iprodMac != 0)) {
    iDst = 0;
    iprod = 0;
    lpprod = (PROD *)CONCAT22(*(undefined2 *)((int)&pPVar3->lpplprod + 2),
                              (PROD *)(*(int *)&pPVar3->lpplprod + 4));
    for (; iprod < (int)(uint)((PLPROD *)pPVar3->lpplprod)->iprodMac; iprod = iprod + 1) {
      uVar7 = __aFulshr(uVar8,(ushort)(PROD *)lpprod);
      uVar6 = (undefined2)((ulong)lpprod >> 0x10);
      if (((((uint)uVar7 & 7) != 1) ||
          (uVar7 = __aFulshr(uVar8,(ushort)(PROD *)lpprod), ((uint)uVar7 & 0x7f) < 0xe)) ||
         (uVar7 = __aFulshr(uVar8,(ushort)(PROD *)lpprod), 0x11 < ((uint)uVar7 & 0x7f))) {
        if (iDst != iprod) {
          uVar1 = *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2);
          uVar2 = *(undefined2 *)((int)&pPVar3->lpplprod + 2);
          puVar4 = (undefined2 *)(*(int *)&pPVar3->lpplprod + 4 + iDst * 4);
          *puVar4 = (int)lpprod->dwFlags;
          puVar4[1] = uVar1;
        }
        iDst = iDst + 1;
      }
      lpprod = (PROD *)CONCAT22(uVar6,(PROD *)lpprod + 1);
    }
    if (iDst == 0) {
      FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pPVar3->lpplprod + 2),
                                    *(PL **)&pPVar3->lpplprod));
      *(undefined2 *)&pPVar3->lpplprod = 0;
      *(undefined2 *)((int)&pPVar3->lpplprod + 2) = 0;
    }
    else if (iDst != iprod) {
      ((PLPROD *)pPVar3->lpplprod)->iprodMac = (byte)iDst;
    }
    if ((sel.grobj == grobjPlanet) && (sel.pl.id == lppl->id)) {
      FLookupPlanet(sel.pl.id,(PLANET *)&sel.pl);
      FillPlanetProdLB
                (hwndPlanetProdLB,
                 (PLPROD *)
                 CONCAT22(sel.pl.lpplprod._2_2_,(PLPROD *)sel.pl.lpplprod),
                 (PLANET *)0x0);
    }
  }
  return;
}



// ======================================================================
// Function: KillQueuedShips
// Address: 10c8:6c2a
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10c86cd4) */
/* WARNING: Removing unreachable block (ram,0x10c86cf4) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10c86cf9) */
/* WARNING: Removing unreachable block (ram,0x10c86d29) */

void KillQueuedShips(PLANET *lppl)

{
  uint uVar1;
  undefined2 uVar2;
  undefined2 uVar3;
  PLANET *pPVar4;
  undefined2 *puVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar6;
  undefined2 uVar7;
  ulong uVar8;
  ulong uVar9;
  PROD *lpprod;
  short iDst;
  short iprod;
  
  uVar9 = CONCAT22(unaff_SI,unaff_DI);
  uVar6 = (undefined2)((ulong)lppl >> 0x10);
  pPVar4 = (PLANET *)lppl;
  if (((*(int *)&pPVar4->lpplprod != 0) || (*(int *)((int)&pPVar4->lpplprod + 2) != 0)) &&
     (((PLPROD *)pPVar4->lpplprod)->iprodMac != 0)) {
    iDst = 0;
    iprod = 0;
    lpprod = (PROD *)CONCAT22(*(undefined2 *)((int)&pPVar4->lpplprod + 2),
                              (PROD *)(*(int *)&pPVar4->lpplprod + 4));
    for (; iprod < (int)(uint)((PLPROD *)pPVar4->lpplprod)->iprodMac; iprod = iprod + 1) {
      uVar8 = __aFulshr(uVar9,(ushort)(PROD *)lpprod);
      uVar7 = (undefined2)((ulong)lpprod >> 0x10);
      if ((((uint)uVar8 & 7) != 2) ||
         (uVar8 = __aFulshr(uVar9,(ushort)(PROD *)lpprod), 0xf < ((uint)uVar8 & 0x7f))) {
        uVar8 = __aFulshr(uVar9,(ushort)(PROD *)lpprod);
        if (((uint)uVar8 & 7) == 2) {
          uVar1 = *(uint *)((int)&((PROD *)lpprod)->dwFlags + 2);
          *&lpprod->dwFlags = (int)lpprod->dwFlags;
          *(uint *)((int)&((PROD *)lpprod)->dwFlags + 2) = uVar1 & 0xf80f;
        }
        if (iDst != iprod) {
          uVar2 = *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2);
          uVar3 = *(undefined2 *)((int)&pPVar4->lpplprod + 2);
          puVar5 = (undefined2 *)(*(int *)&pPVar4->lpplprod + 4 + iDst * 4);
          *puVar5 = (int)lpprod->dwFlags;
          puVar5[1] = uVar2;
        }
        iDst = iDst + 1;
      }
      lpprod = (PROD *)CONCAT22(uVar7,(PROD *)lpprod + 1);
    }
    if (iDst == 0) {
      FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pPVar4->lpplprod + 2),
                                    *(PL **)&pPVar4->lpplprod));
      *(undefined2 *)&pPVar4->lpplprod = 0;
      *(undefined2 *)((int)&pPVar4->lpplprod + 2) = 0;
    }
    else if (iDst != iprod) {
      ((PLPROD *)pPVar4->lpplprod)->iprodMac = (byte)iDst;
    }
    if ((sel.grobj == grobjPlanet) && (sel.pl.id == lppl->id)) {
      FLookupPlanet(sel.pl.id,(PLANET *)&sel.pl);
      FillPlanetProdLB
                (hwndPlanetProdLB,
                 (PLPROD *)
                 CONCAT22(sel.pl.lpplprod._2_2_,(PLPROD *)sel.pl.lpplprod),
                 (PLANET *)0x0);
    }
  }
  return;
}



