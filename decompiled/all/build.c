// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: ShipBuilder
// Address: 10c8:008c
// Segment: MEMORY_BUILD
// ======================================================================


short ShipBuilder(POINT ptDlgSize)

{
  SHDEF *pSVar1;
  FARPROC pvVar2;
  short fSuccess;
  void *lpProcSlot;
  
  ptslotGlob.x = ptDlgSize.x;
  ptslotGlob.y = ptDlgSize.y;
  if ((uint)gd._0_2_ >> 0xe != 0) {
    ptslotGlob.y = ptDlgSize.y + dyArial8 * 3;
  }
  fStarbaseMode = 0;
  lpshdefBuild = NthValidShdef(0);
  pvVar2 = MakeProcInstance(SlotDlg,hInst);
  DialogBox(0,(LPCSTR)CONCAT22(0x5c,hwndFrame),(HWND)((ulong)pvVar2 >> 0x10),
            (void *)pvVar2);
  FreeProcInstance(pvVar2);
  pSVar1 = lpshdefBuild;
  if ((sel.grobj == grobjPlanet) &&
     (((PLPROD *)sel.pl.lpplprod != (PLPROD *)0x0 ||
      (sel.pl.lpplprod._2_2_ != 0)))) {
    FillPlanetProdLB
              (hwndPlanetProdLB,
               (PLPROD *)
               CONCAT22(sel.pl.lpplprod._2_2_,(PLPROD *)sel.pl.lpplprod),
               (PLANET *)0x0);
    pSVar1 = lpshdefBuild;
  }
  lpshdefBuild._2_2_ = (undefined2)((ulong)pSVar1 >> 0x10);
  lpshdefBuild._0_2_ = (SHDEF *)pSVar1;
  return 0;
}



// ======================================================================
// Function: ShowMainControls
// Address: 10c8:0160
// Segment: MEMORY_BUILD
// ======================================================================


void ShowMainControls(HWND hwnd,short sw)

{
  HWND HVar1;
  short sVar2;
  StringId ids;
  char *pcVar3;
  
  HVar1 = GetDlgItem(hwnd,0x816);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x818);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x817);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x810);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x811);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x812);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x813);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x814);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,0x815);
  ShowWindow(HVar1,sw);
  HVar1 = GetDlgItem(hwnd,1);
  if (sw == 5) {
    sVar2 = 0;
  }
  else {
    sVar2 = 5;
  }
  ShowWindow(HVar1,sVar2);
  sVar2 = 2;
  if (sw == 5) {
    ids = idsDone;
  }
  else {
    ids = idsCancel;
  }
  pcVar3 = PszGetCompressedString(ids);
  SetDlgItemText(hwnd,sVar2,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar3));
  return;
}



// ======================================================================
// Function: FCheckQueuedShip
// Address: 10c8:027c
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10c80310) */
/* WARNING: Removing unreachable block (ram,0x10c802b7) */
/* WARNING: Removing unreachable block (ram,0x10c804cc) */

short FCheckQueuedShip(HWND hwnd,SHDEF *lpshdef,short fEdit)

{
  short sVar1;
  char *pcVar2;
  HWND HVar3;
  SHDEF *pSVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  char *pcVar7;
  undefined1 *puVar8;
  short cshQueued;
  short ids;
  short id;
  short fProgress;
  char rgch [40];
  
  uVar5 = (undefined2)((ulong)lpshdef >> 0x10);
  pSVar4 = (SHDEF *)lpshdef;
  sVar1 = CshQueued((uint)pSVar4->wFlags >> 10 & 0x1f,&fProgress,fEdit);
  if (((*(int *)((int)&pSVar4->cExist + 2) != 0) || ((int)pSVar4->cExist != 0)) || (sVar1 != 0)) {
    if (fEdit == 0) {
      if (fStarbaseMode == 0) {
        ids = 0x26b;
      }
      else {
        ids = 0x26e;
      }
    }
    else {
      ids = 0x270;
    }
    CchGetString(idsWorkDone,rgch);
    if (((*(int *)((int)&pSVar4->cExist + 2) == 0) && ((int)pSVar4->cExist == 0)) || (sVar1 == 0)) {
      if (sVar1 == 0) {
        uVar6 = (undefined2)pSVar4->cExist;
        pcVar2 = PszGetCompressedString
                           (ids + idsHistoryFileAppearsCorruptHistoricalDataWill);
        _WSPRINTF((LPSTR)CONCAT22(uVar6,(char *)&DAT_1120_1120),
                  (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
      }
      else {
        pcVar2 = PszGetCompressedString(ids + idsPlayerLogFileAppearsCorruptUnableLoad);
        _WSPRINTF((LPSTR)CONCAT22(sVar1,(char *)&DAT_1120_1120),
                  (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
      }
    }
    else {
      uVar6 = (undefined2)pSVar4->cExist;
      pcVar2 = PszGetCompressedString(ids);
      _WSPRINTF((LPSTR)CONCAT22(uVar6,(char *)&DAT_1120_1120),
                (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
    }
    HVar3 = GetFocus();
    puVar8 = (undefined1 *)&DAT_1120_1120;
    pcVar7 = (char *)szWork;
    pcVar2 = PszGetCompressedString(fEdit + idsDeleteDesign);
    sVar1 = MessageBox(HVar3,(LPCSTR)CONCAT22(puVar8,pcVar7),
                       (LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar2),0x2024);
    SetFocus(hwnd);
    if (sVar1 == 7) {
      return 0;
    }
    if ((*(int *)((int)&pSVar4->cExist + 2) == 0) && ((int)pSVar4->cExist == 0)) {
      RemoveIshdefFromAllQueues((uint)pSVar4->wFlags >> 10 & 0x1f,fEdit);
    }
    else {
      DestroyAllIshdef((uint)pSVar4->wFlags >> 10 & 0x1f,idPlayer);
      InvalidateRect(hwndScanner,(undefined2 *)0x0,1);
      InvalidateRect(hwndMessage,(undefined2 *)0x0,1);
    }
  }
  return 1;
}



// ======================================================================
// Function: SlotDlg
// Address: 10c8:0550
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10c819d8) */
/* WARNING: Removing unreachable block (ram,0x10c81f25) */
/* WARNING: Removing unreachable block (ram,0x10c81585) */
/* WARNING: Variable defined which should be unmapped: part_4 */
/* WARNING: Removing unreachable block (ram,0x10c8130f) */
/* WARNING: Removing unreachable block (ram,0x10c811cf) */
/* WARNING: Removing unreachable block (ram,0x10c81192) */
/* WARNING: Removing unreachable block (ram,0x10c812a2) */
/* WARNING: Removing unreachable block (ram,0x10c81c54) */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short SlotDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  uint *puVar1;
  char *pcVar2;
  SHDEF *pSVar3;
  HullDef *pHVar4;
  fn_lpfnRealListProc *pfVar5;
  char *pcVar6;
  BOOL BVar7;
  HDC hdc_00;
  HWND HVar8;
  int iVar9;
  undefined2 uVar10;
  HULDEF *pHVar11;
  ushort uVar12;
  uint uVar13;
  HBRUSH HVar14;
  HS *pHVar15;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  SHDEF *pSVar16;
  SHDEF *pSVar17;
  HullDef *pHVar18;
  undefined *puVar19;
  undefined2 unaff_SS;
  bool bVar20;
  ulong uVar21;
  LRESULT LVar22;
  long lVar23;
  HULDEF *pHVar24;
  SHDEF *pSVar25;
  short sVar26;
  PART part_4;
  short j_2;
  short i_4;
  RECT RStack_4c;
  long lSel;
  short cch;
  HWND hwndItem;
  PAINTSTRUCT ps;
  short left;
  SHDEF *lpshdef;
  RECT rcGBox;
  HDC hdc;
  RECT rcWindow;
  
  if (message == WM_PAINT) {
    hdc_00 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    if (mdBuild != 4) {
      HVar8 = GetDlgItem(hwnd,0x810);
      GetWindowRect(HVar8,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
      ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
      HVar8 = GetDlgItem(hwnd,0x811);
      GetWindowRect(HVar8,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c));
      ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&RStack_4c.right));
      rcGBox.right = RStack_4c.right;
      rcGBox.bottom = RStack_4c.bottom;
      ExpandRc(&rcGBox,dyArial8,dyArial8 >> 1);
      _Draw3dFrame(hdc_00,&rcGBox,-1);
      SetBkColor(hdc_00,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SelectObject(hdc_00,rghfontArial8[1]);
      cch = CchGetString(idsDesign,(char *)szWork);
      TextOut(hdc_00,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,cch);
      SelectObject(hdc_00,rghfontArial8[0]);
      HVar8 = GetDlgItem(hwnd,0x812);
      GetWindowRect(HVar8,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
      ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
      HVar8 = GetDlgItem(hwnd,0x815);
      GetWindowRect(HVar8,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c));
      ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&RStack_4c.right));
      rcGBox.right = RStack_4c.right;
      rcGBox.bottom = RStack_4c.bottom;
      ExpandRc(&rcGBox,dyArial8,dyArial8 >> 1);
      _Draw3dFrame(hdc_00,&rcGBox,-1);
      SetBkColor(hdc_00,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SelectObject(hdc_00,rghfontArial8[1]);
      cch = CchGetString(idsView,(char *)szWork);
      TextOut(hdc_00,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,cch);
      SelectObject(hdc_00,rghfontArial8[0]);
    }
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c));
    DrawSlotDlg(hwnd,hdc_00,&RStack_4c,-1);
    DrawBuildSelComp(hwnd,hdc_00,-1);
    DrawBuildSelHull(hwnd,hdc_00,-1,(RECT *)0x0);
    EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    HVar14 = 1;
    pfVar5 = (fn_lpfnRealListProc *)
             CONCAT22(lpfnRealListProc._2_2_,
                      (fn_lpfnRealListProc *)lpfnRealListProc);
    goto LAB_10c8_2647;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c),hbrButtonFace);
    HVar14 = 1;
    pfVar5 = (fn_lpfnRealListProc *)
             CONCAT22(lpfnRealListProc._2_2_,
                      (fn_lpfnRealListProc *)lpfnRealListProc);
    goto LAB_10c8_2647;
  }
  if (message == WM_CTLCOLOR) {
    for (i_4 = 0x810; i_4 < 0x816; i_4 = i_4 + 1) {
      j_2 = (HWND)lParam;
      HVar8 = GetDlgItem(hwnd,i_4);
      if (j_2 == HVar8) break;
    }
    if (0x815 < i_4) {
      j_2 = (HWND)lParam;
      HVar8 = GetDlgItem(hwnd,0x40b);
      if (j_2 != HVar8) goto LAB_10c8_2641;
    }
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    HVar14 = hbrButtonFace;
    pfVar5 = (fn_lpfnRealListProc *)
             CONCAT22(lpfnRealListProc._2_2_,
                      (fn_lpfnRealListProc *)lpfnRealListProc);
    goto LAB_10c8_2647;
  }
  if (message == WM_SETCURSOR) {
    GetCursorPos((short *)CONCAT22(unaff_SS,&j_2));
    ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&j_2));
    BVar7 = PtInRect((undefined2 *)CONCAT22((RECT *)rgrcBuildSpin,i_4),j_2);
    if (BVar7 == 0) {
      BVar7 = PtInRect((undefined2 *)CONCAT22(0x592e,i_4),j_2);
      if (BVar7 == 0) goto LAB_10c8_2641;
    }
    setcursor(hcurHand);
    HVar14 = 1;
    pfVar5 = (fn_lpfnRealListProc *)
             CONCAT22(lpfnRealListProc._2_2_,
                      (fn_lpfnRealListProc *)lpfnRealListProc);
    goto LAB_10c8_2647;
  }
  if (message == WM_DRAWITEM) {
    _j_2 = lParam;
    if (*(int *)((HWND)lParam + 4) == -1) {
      HandleFocusState((DRAWITEMSTRUCT *)lParam,-2);
    }
    else {
      iVar9 = *(int *)((HWND)lParam + 6);
      if (iVar9 == 1) {
        DrawDlgLBEntireItem((DRAWITEMSTRUCT *)lParam,-4);
      }
      else if (iVar9 == 2) {
        DrawDlgLBEntireItem((DRAWITEMSTRUCT *)lParam,-4);
      }
      else if (iVar9 == 4) {
        DrawDlgLBEntireItem((DRAWITEMSTRUCT *)lParam,-4);
      }
    }
    HVar14 = 1;
    pfVar5 = (fn_lpfnRealListProc *)
             CONCAT22(lpfnRealListProc._2_2_,
                      (fn_lpfnRealListProc *)lpfnRealListProc);
    goto LAB_10c8_2647;
  }
  if (message == WM_MEASUREITEM) {
    *(undefined2 *)((HWND)lParam + 8) = 0x42;
    HVar14 = 1;
    pfVar5 = (fn_lpfnRealListProc *)
             CONCAT22(lpfnRealListProc._2_2_,
                      (fn_lpfnRealListProc *)lpfnRealListProc);
    goto LAB_10c8_2647;
  }
  if (message == WM_INITDIALOG) {
    fHullCopy = 0;
    hwndSlotDlg = hwnd;
    GetWindowRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rcWindow));
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c));
    SetWindowPos(hwnd,0,0,0,
                 ((ptslotGlob.x + rcWindow.right) - rcWindow.left) - RStack_4c.right,
                 ((ptslotGlob.y + rcWindow.bottom) - rcWindow.top) - RStack_4c.bottom,6);
    StickyDlgPos(hwnd,(POINT *)&ptStickySlotDlg,1);
    UpdateSlotGlobals();
    hwndItem = GetDlgItem(hwnd,0x80c);
    SetWindowPos(hwndItem,0,ptslotGlob.x + -0x100,0x20,0xf0,0x10a,4);
    FillBuildPartsLB(hwndItem,rggrbitParts[0]);
    yBuildInfoSum = 0x154;
    lpfnRealListProc = (fn_lpfnRealListProc *)GetWindowLong(hwndItem,-4);
    SetWindowLong(hwndItem,-4,
                  (long)CONCAT22(lpfnFakeListProc._2_2_,
                                 (fn_lpfnFakeListProc *)lpfnFakeListProc));
    CheckRadioButton(hwnd,0x810,0x811,0x810);
    CheckRadioButton(hwnd,0x812,0x815,0x812);
    mdBuild = 0;
    hwndItem = GetDlgItem(hwnd,0x81a);
    SetWindowPos(hwndItem,0,ptslotGlob.x + -0x108,8,0xf0,100,4);
    FillBuildDD(hwndItem,mdBuild);
    HVar8 = GetDlgItem(hwnd,1);
    SetWindowPos(HVar8,0,ptslotGlob.x + -0xe2,
                 (ptslotGlob.y - (dyArial8 * 3) / 2) + -6,0x44,
                 (dyArial8 * 3) / 2,0x84);
    HVar8 = GetDlgItem(hwnd,2);
    SetWindowPos(HVar8,0,ptslotGlob.x + -0x94,
                 (ptslotGlob.y - (dyArial8 * 3) / 2) + -6,0x44,
                 (dyArial8 * 3) / 2,4);
    HVar8 = GetDlgItem(hwnd,0x76);
    SetWindowPos(HVar8,0,ptslotGlob.x + -0x4a,
                 (ptslotGlob.y - (dyArial8 * 3) / 2) + -6,0x44,
                 (dyArial8 * 3) / 2,4);
    sVar26 = 2;
    pcVar6 = PszGetCompressedString(idsDone);
    SetDlgItemText(hwnd,sVar26,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar6));
    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    HVar14 = 1;
    pfVar5 = lpfnRealListProc;
    goto LAB_10c8_2647;
  }
  if (message != WM_COMMAND) {
    if (((message == WM_LBUTTONDOWN) || (message == WM_LBUTTONDBLCLK)) ||
       (message == WM_RBUTTONDOWN)) {
      uVar13 = (uint)(message == WM_RBUTTONDOWN);
      sVar26 = 0;
      uVar21 = __aFulshr((ulong)wParam,uVar13);
      HVar14 = FTrackSlot(hwnd,(HWND)lParam,(short)uVar21,wParam,sVar26,uVar13);
      pfVar5 = (fn_lpfnRealListProc *)
               CONCAT22(lpfnRealListProc._2_2_,
                        (fn_lpfnRealListProc *)lpfnRealListProc);
      goto LAB_10c8_2647;
    }
    goto LAB_10c8_2641;
  }
  uVar21 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),part_4.hs.grhst);
  if ((((int)uVar21 == 0) && (0x80f < wParam)) && (wParam < 0x812)) {
    fStarbaseMode = wParam - 0x810;
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c));
    RStack_4c.left = RStack_4c.right >> 1;
    if (RStack_4c.right + -0x160 <= RStack_4c.left) {
      RStack_4c.left = RStack_4c.right + -0x160;
    }
    InvalidateRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c),1);
    lpshdefBuild = (SHDEF *)0x0;
    fHullCopy = 0;
    uVar12 = rggrbitPartsSB[0];
    if (fStarbaseMode == 0) {
      uVar12 = rggrbitParts[0];
    }
    lSel._2_2_ = 0;
    lSel._0_2_ = uVar12;
    HVar8 = GetDlgItem(hwnd,0x80c);
    FillBuildPartsLB(HVar8,uVar12);
    hwndItem = GetDlgItem(hwnd,0x81a);
    FillBuildDD(hwndItem,mdBuild);
    SendMessage(hwndItem,0x40e,0,0);
BUILD_FixupShip:
    part_4.hs.grhst = hwnd;
    part_4.hs.grhst = GetDlgItem(hwnd,0x81a);
    puVar19 = (undefined *)0x14f8;
    hwndItem = part_4.hs.grhst;
    LVar22 = SendMessage(part_4.hs.grhst,0x407,0,0);
    lSel._2_2_ = (int)((ulong)LVar22 >> 0x10);
    part_4.hs.grhst = (HullSlotType)LVar22;
    lSel = LVar22;
    if ((mdBuild == 3) || (mdBuild == 4)) {
      if (LVar22 == -1) {
        lSel._0_2_ = ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|
                       hstMines|hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|
                      hstEngine);
      }
      else if (fStarbaseMode == 0) {
        part_4.hs.grhst = hstSpecialM|hstSBHull|hstMining|hstBomb|hstTorp|hstBeam|hstArmor;
        lVar23 = __aFlshl(part_4._2_4_,part_4.pcom._2_2_);
        lSel._0_2_ = *(HullSlotType *)((int)lVar23 + 0x38);
      }
      else {
        part_4.hs.grhst = hstSpecialM|hstSBHull|hstMining|hstBomb|hstTorp|hstBeam|hstArmor;
        lVar23 = __aFlshl(part_4._2_4_,part_4.pcom._2_2_);
        lSel._0_2_ = *(HullSlotType *)((int)lVar23 + 0x6c);
      }
      lSel._2_2_ = 0;
      part_4.hs.grhst = (HullSlotType)lSel;
      HVar8 = GetDlgItem(hwnd,0x80c);
      FillBuildPartsLB(HVar8,part_4.hs.grhst);
      LVar22 = CONCAT22(lSel._2_2_,(HullSlotType)lSel);
    }
    else if (((mdBuild == 0) || (mdBuild == 1)) || (mdBuild == 2)) {
      if (LVar22 != -1) {
        if (mdBuild == 0) {
          if (fStarbaseMode == 0) {
LAB_10c8_110d:
            uVar10 = 0;
            lSel = LVar22;
          }
          else {
            part_4.hs.grhst = hstArmor|hstShield|hstScanner;
            sVar26 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
            LVar22 = lSel;
            if (sVar26 != raMacintosh) goto LAB_10c8_110d;
            uVar10 = 1;
          }
          _j_2 = CONCAT22(i_4,uVar10);
          part_4.hs.grhst = (HullSlotType)lSel;
          lpshdefBuild = NthValidShdef((HullSlotType)lSel);
          part_4.hs.grhst =
               ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|
                 hstMines|hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)
          ;
          CshQueued((uint)((SHDEF *)lpshdefBuild)->wFlags >> 10 & 0x1f,
                          (short *)((int)&part_4.pcom + 2),0);
          part_4.hs.grhst = hwndSlotDlg;
          part_4.hs.grhst = GetDlgItem(hwndSlotDlg,0x818);
          uVar10 = (undefined2)((ulong)lpshdefBuild >> 0x10);
          if ((((int)((SHDEF *)lpshdefBuild)->cExist == 0) &&
              (*(int *)((int)&((SHDEF *)lpshdefBuild)->cExist + 2) == 0)) &&
             ((part_4.pcom._2_2_ == 0 && ((j_2 == 0 || (0 < lSel)))))) {
            BVar7 = 1;
          }
          else {
            BVar7 = 0;
          }
          EnableWindow(part_4.hs.grhst,BVar7);
          if (j_2 != 0) {
            part_4.hs.grhst = hwndSlotDlg;
            part_4.hs.grhst = GetDlgItem(hwndSlotDlg,0x817);
            if (lSel < 1) {
LAB_10c8_11f8:
              BVar7 = 0;
            }
            else {
              uVar10 = (undefined2)((ulong)lpshdefBuild >> 0x10);
              if (((int)((SHDEF *)lpshdefBuild)->cExist != 0) ||
                 (*(int *)((int)&((SHDEF *)lpshdefBuild)->cExist + 2) != 0))
              goto LAB_10c8_11f8;
              BVar7 = 1;
            }
            EnableWindow(part_4.hs.grhst,BVar7);
          }
          puVar19 = (undefined *)0x14f8;
          LVar22 = lSel;
        }
        else if (mdBuild == 2) {
          puVar19 = (undefined *)&DAT_1120_10c8;
          lSel._0_2_ = part_4.hs.grhst;
          lpshdefBuild = NthValidEnemyShdef(part_4.hs.grhst);
          LVar22 = CONCAT22(lSel._2_2_,(HullSlotType)lSel);
          if ((((SHDEF *)lpshdefBuild)->wFlags & 0xffU) != 7) {
            _j_2 = CONCAT22((lpshdefBuild->hul).ihuldef,j_2);
            LVar22 = CONCAT22(lSel._2_2_,(HullSlotType)lSel);
          }
        }
        else {
          if (fStarbaseMode == 0) {
            part_4.hs.wFlags = 0x4000;
            _j_2 = _j_2 & 0xffff;
            while (i_4 < 0x20) {
              part_4.pcom._0_2_ = (COMPART *)((uint)(COMPART *)part_4.pcom & 0xff00 | i_4 & 0xffU);
              part_4.hs.grhst = (HullSlotType)&part_4.hs.wFlags;
              lSel = LVar22;
              sVar26 = FLookupPart((PART *)part_4.hs.grhst);
              LVar22 = lSel;
              if ((sVar26 == 1) &&
                 (LVar22 = CONCAT22(lSel._2_2_ - (uint)((HullSlotType)lSel == 0),
                                    (HullSlotType)lSel + -1), lSel < 1)) break;
              _j_2 = CONCAT22(i_4 + 1,j_2);
            }
          }
          else {
            part_4.hs.wFlags = 0x400;
            _j_2 = _j_2 & 0xffff;
            while (i_4 < 5) {
              part_4.pcom._0_2_ = (COMPART *)((uint)(COMPART *)part_4.pcom & 0xff00 | i_4 & 0xffU);
              part_4.hs.grhst = (HullSlotType)&part_4.hs.wFlags;
              lSel = LVar22;
              sVar26 = FLookupPart((PART *)part_4.hs.grhst);
              LVar22 = lSel;
              if ((sVar26 == 1) &&
                 (LVar22 = CONCAT22(lSel._2_2_ - (uint)((HullSlotType)lSel == 0),
                                    (HullSlotType)lSel + -1), lSel < 1)) break;
              _j_2 = CONCAT22(i_4 + 1,j_2);
            }
            _j_2 = CONCAT22(i_4 + 0x20,j_2);
          }
          part_4.hs.grhst = i_4;
          lSel = LVar22;
          pHVar24 = LphuldefFromId(i_4);
          uVar10 = (undefined2)((ulong)pHVar24 >> 0x10);
          pHVar11 = (HULDEF *)pHVar24;
          pSVar16 = (SHDEF *)&shdefBuild;
          for (iVar9 = 0x3d; iVar9 != 0; iVar9 = iVar9 + -1) {
            pSVar25 = pSVar16;
            pSVar16 = (SHDEF *)(pSVar16->hul).rgTech;
            pHVar24 = pHVar11;
            pHVar11 = (HULDEF *)(pHVar11->hul).rgTech;
            (pSVar25->hul).ihuldef = (pHVar24->hul).ihuldef;
          }
          *(char *)&(pSVar16->hul).ihuldef = (char)(pHVar11->hul).ihuldef;
          shdefBuild.hul.ihuldef = i_4 & 0xff;
          _j_2 = _j_2 & 0xffff;
          while (i_4 < (int)(uint)shdefBuild.hul.chs) {
            *(uint *)((int)&shdefBuild.hul + 0x3c + i_4 * 4) =
                 *(uint *)((int)&shdefBuild.hul + 0x3c + i_4 * 4) & 0xff;
            _j_2 = CONCAT22(i_4 + 1,j_2);
          }
                    /* WARNING: Ignoring partial resolution of indirect */
                    /* WARNING: Ignoring partial resolution of indirect */
          part_4.hs.grhst = (HullSlotType)&DAT_1120_1120;
          puVar19 = (undefined *)&DAT_1120_1038;
          UpdateShdefCost(&shdefBuild);
          LVar22 = lSel;
        }
      }
      part_4.hs.grhst = (HullSlotType)puVar19;
      lSel = LVar22;
      UpdateSlotGlobals();
      part_4.hs.grhst = hwnd;
      GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c));
      RStack_4c.left = RStack_4c.right >> 1;
      if (RStack_4c.right + -0x160 <= RStack_4c.left) {
        RStack_4c.left = RStack_4c.right + -0x160;
      }
      part_4.hs.grhst = hwnd;
      InvalidateRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c),1);
      LVar22 = lSel;
    }
    part_4.hs.grhst =
         hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
         hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner;
    lSel = LVar22;
    SetBuildSelection(-2);
    part_4.hs.grhst =
         ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
           hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine);
    puVar19 = (undefined *)&DAT_1120_10c8;
    DrawBuildSelHull(hwnd,0,-1,(RECT *)0x0);
    if (((SHDEF *)lpshdefBuild == (SHDEF *)0x0) && (lpshdefBuild._2_2_ == 0)) {
      part_4.hs.grhst = hwndSlotDlg;
      part_4.hs.grhst = GetDlgItem(hwndSlotDlg,0x817);
      EnableWindow(part_4.hs.grhst,0);
      part_4.hs.grhst = hwndSlotDlg;
      part_4.hs.grhst = GetDlgItem(hwndSlotDlg,0x818);
      EnableWindow(part_4.hs.grhst,0);
      part_4.hs.grhst = hwndSlotDlg;
      part_4.hs.grhst = GetDlgItem(hwndSlotDlg,0x816);
      puVar19 = (undefined *)0x14f8;
      EnableWindow(part_4.hs.grhst,0);
    }
    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
      part_4.hs.grhst = (HullSlotType)puVar19;
      AdvanceTutor();
    }
  }
  else {
    uVar21 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),part_4.hs.grhst);
    if ((((int)uVar21 == 0) && (0x811 < wParam)) && (wParam < 0x816)) {
      lSel = 0;
BUILD_LRestart:
      lpshdefBuild = (SHDEF *)0x0;
      fHullCopy = 0;
      mdBuild = wParam - 0x812;
      hwndItem = GetDlgItem(hwnd,0x81a);
      UpdateSlotGlobals();
      FillBuildDD(hwndItem,mdBuild);
      SendMessage(hwndItem,0x40e,(HullSlotType)lSel,0);
      if (wParam == 0x815) {
        iVar9 = 0;
      }
      else {
        iVar9 = 8;
      }
      SetWindowPos(hwndItem,0,(ptslotGlob.x + -0x100) - iVar9,8,0,0,5);
      GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c));
      sVar26 = RStack_4c.left;
      RStack_4c.left = RStack_4c.right >> 1;
      if (RStack_4c.right + -0x160 <= RStack_4c.left) {
        RStack_4c.left = RStack_4c.right + -0x160;
      }
      InvalidateRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c),1);
      RStack_4c.right = RStack_4c.left;
      RStack_4c.top = yBuildInfoSum;
      RStack_4c.left = sVar26;
      InvalidateRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c),1);
      part_4.hs.grhst = hwnd;
      part_4.hs.grhst = GetDlgItem(hwnd,0x80c);
      if (mdBuild == 3) {
        sVar26 = 5;
      }
      else {
        sVar26 = 0;
      }
      hwndItem = part_4.hs.grhst;
      ShowWindow(part_4.hs.grhst,sVar26);
      if (wParam != 0x815) goto BUILD_FixupShip;
      if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
        part_4.hs.grhst = hstSpecialM|hstSBHull|hstMining|hstBomb|hstTorp|hstBeam|hstArmor;
        AdvanceTutor();
      }
    }
    else if (((wParam == 0x81b) &&
             (uVar21 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),part_4.hs.grhst),
             (int)uVar21 == 0x400)) && (fInEditUpdate == 0)) {
      fInEditUpdate = 1;
      GetWindowText((HWND)lParam,szWork,0xfa);
      lSel = SendMessage((HWND)lParam,0x400,0,0);
      sVar26 = FStringFitsScreen(szWork,0xa0);
      if (sVar26 == 0) {
        SetWindowText((HWND)lParam,szWork);
        SendMessage((HWND)lParam,0x401,0,lSel);
      }
      lstrcpy((LPSTR)CONCAT22((int)((ulong)lpshdefBuild >> 0x10),
                              (((SHDEF *)lpshdefBuild)->hul).szClass),szWork);
      DrawBuildSelHull(hwnd,0,0x100,(RECT *)0x0);
      fInEditUpdate = 0;
      if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
        AdvanceTutor();
      }
    }
    else if (wParam == 0x81a) {
      uVar21 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),part_4.hs.grhst);
      if ((int)uVar21 == 1) goto BUILD_FixupShip;
    }
    else if (wParam == 0x80c) {
      uVar21 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),part_4.hs.grhst);
      if ((int)uVar21 == 1) {
        SetBuildSelection(-1);
      }
    }
    else if (wParam == 0x817) {
      uVar21 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),part_4.hs.grhst);
      if (((int)uVar21 == 0) &&
         ((_j_2 = 0, ((uint)gd._0_2_ >> 0xb & 1) == 0 ||
          (sVar26 = FTutorialEnabledShipBuilder(0), sVar26 != 0)))) {
        hwndItem = GetDlgItem(hwnd,0x81a);
        lSel = SendMessage(hwndItem,0x407,0,0);
        pSVar25 = NthValidShdef((short)lSel);
        iVar9 = (int)((ulong)pSVar25 >> 0x10);
        pSVar16 = (SHDEF *)pSVar25;
        if ((-1 < lSel) && ((pSVar16 != (SHDEF *)0x0 || (iVar9 != 0)))) {
          if ((fStarbaseMode != 0) && (lSel == 0)) {
            sVar26 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
            if (sVar26 == raMacintosh) goto LAB_10c8_2641;
          }
          sVar26 = FCheckQueuedShip(hwnd,pSVar25,0);
          if (sVar26 != 0) {
            pSVar16->wFlags = pSVar16->wFlags & 0xfdffU | 0x200;
            *(undefined2 *)&pSVar16->cBuilt = 0;
            *(undefined2 *)((int)&pSVar16->cBuilt + 2) = 0;
            *(undefined2 *)&pSVar16->cExist = 0;
            *(undefined2 *)((int)&pSVar16->cExist + 2) = 0;
            if (fStarbaseMode == 0) {
              pcVar2 = (char *)((int)&rgplr[0].cShDef + idPlayer * 0xc0);
              *pcVar2 = *pcVar2 + -1;
            }
            else {
              part_4.pcom._2_2_ =
                   *(int *)((int)&rgplr[0].wFlags + idPlayer * 0xc0) - 0x1000U &
                   0xf000;
              puVar1 = (uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0);
              *puVar1 = *puVar1 & 0xfff;
              puVar1 = (uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0);
              *puVar1 = *puVar1 | part_4.pcom._2_2_;
            }
            LogChangeShDef(pSVar25);
            FillBuildDD(hwndItem,mdBuild);
            lpshdefBuild = NthValidShdef(0);
            if (fStarbaseMode == 0) {
LAB_10c8_16eb:
              if (((SHDEF *)lpshdefBuild == (SHDEF *)0x0) &&
                 (lpshdefBuild._2_2_ == 0)) goto LAB_10c8_16ff;
            }
            else {
              sVar26 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
              if (sVar26 != raMacintosh) goto LAB_10c8_16eb;
LAB_10c8_16ff:
              HVar8 = GetDlgItem(hwndSlotDlg,0x817);
              EnableWindow(HVar8,0);
              HVar8 = GetDlgItem(hwndSlotDlg,0x818);
              EnableWindow(HVar8,0);
              if (((SHDEF *)lpshdefBuild == (SHDEF *)0x0) &&
                 (lpshdefBuild._2_2_ == 0)) {
                HVar8 = GetDlgItem(hwndSlotDlg,0x816);
                EnableWindow(HVar8,0);
              }
            }
            UpdateSlotGlobals();
            GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c));
            RStack_4c.left = RStack_4c.right >> 1;
            if (RStack_4c.right + -0x160 <= RStack_4c.left) {
              RStack_4c.left = RStack_4c.right + -0x160;
            }
            InvalidateRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&RStack_4c),1);
            if (fHullCopy != 0) goto BUILD_LRestart;
          }
        }
      }
    }
    else if (wParam == 0x816) {
      uVar21 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),part_4.hs.grhst);
      if ((int)uVar21 == 0) {
        if ((((uint)gd._0_2_ >> 0xb & 1) == 0) ||
           (sVar26 = FTutorialEnabledShipBuilder(1), sVar26 != 0)) {
          hwndItem = GetDlgItem(hwnd,0x81a);
          LVar22 = SendMessage(hwndItem,0x407,0,0);
          if ((0xffff < LVar22) || (-1 < LVar22)) {
            if (fStarbaseMode == 0) {
              _j_2 = _j_2 & 0xffff;
              while ((i_4 < 0x10 &&
                     ((*(uint *)((int)&rgshdef[0].wFlags + i_4 * 0x93) >> 9 & 1) == 0))) {
                _j_2 = CONCAT22(i_4 + 1,j_2);
              }
            }
            else {
              _j_2 = _j_2 & 0xffff;
              while ((i_4 < 10 &&
                     ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i_4 * 0x93 + 0x7b) >> 9 & 1
                      ) == 0))) {
                _j_2 = CONCAT22(i_4 + 1,j_2);
              }
            }
            if ((mdBuild != 0) && (mdBuild != 2)) {
              if (fStarbaseMode == 0) {
                part_4.hs.grhst = hstHull;
              }
              else {
                part_4.hs.grhst = hstSBHull;
              }
              _j_2 = _j_2 & 0xffff0000;
              while( true ) {
                if (fStarbaseMode == 0) {
                  iVar9 = 0x20;
                }
                else {
                  iVar9 = 5;
                }
                if (iVar9 <= j_2) break;
                part_4.hs.wFlags = part_4.hs.wFlags & 0xff00U | j_2 & 0xffU;
                lSel = LVar22;
                sVar26 = FLookupPart(&part_4);
                lVar23 = lSel;
                if (sVar26 == 1) {
                  iVar9 = lSel._2_2_ - (uint)((HullSlotType)lSel == 0);
                  LVar22 = CONCAT22(iVar9,(HullSlotType)lSel + -1);
                  lVar23 = CONCAT22(iVar9,(HullSlotType)lSel + -1);
                  if (lSel < 1) break;
                }
                LVar22 = lVar23;
                _j_2 = CONCAT22(i_4,j_2 + 1);
              }
              if (fStarbaseMode == 0) {
                lpshdef = (SHDEF *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                            (SHDEF *)(i_4 * 0x93 + 0x3f00));
              }
              else {
                lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x14e),
                                            (SHDEF *)(*(int *)(idPlayer * 4 + 0x14c) +
                                                     i_4 * 0x93));
                _j_2 = CONCAT22(i_4,j_2 + 0x20);
              }
              lSel = LVar22;
              __fmemset(lpshdef,0,0x93);
              pHVar24 = LphuldefFromId(j_2);
              uVar10 = (undefined2)((ulong)pHVar24 >> 0x10);
              pHVar11 = (HULDEF *)pHVar24;
              pSVar16 = (SHDEF *)lpshdef;
              for (iVar9 = 0x3d; iVar9 != 0; iVar9 = iVar9 + -1) {
                pSVar25 = pSVar16;
                pSVar16 = (SHDEF *)(pSVar16->hul).rgTech;
                pHVar24 = pHVar11;
                pHVar11 = (HULDEF *)(pHVar11->hul).rgTech;
                (pSVar25->hul).ihuldef = (pHVar24->hul).ihuldef;
              }
              *(char *)&(pSVar16->hul).ihuldef = (char)(pHVar11->hul).ihuldef;
              ((SHDEF *)lpshdef)->wFlags = ((SHDEF *)lpshdef)->wFlags & 0xff00U | 7;
              __fmemset((HS *)CONCAT22(lpshdef._2_2_,(((SHDEF *)lpshdef)->hul).rghs),0,0x40)
              ;
LAB_10c8_1d0f:
              CheckRadioButton(hwnd,0x812,0x815,0x812);
              uVar10 = (undefined2)((ulong)lpshdef >> 0x10);
              pSVar16 = (SHDEF *)lpshdef;
              pSVar16->turn = game.turn;
              if (fStarbaseMode == 0) {
                iVar9 = 0;
              }
              else {
                iVar9 = 0x10;
              }
              _j_2 = CONCAT22(i_4,iVar9 + i_4);
              pSVar16->wFlags = pSVar16->wFlags & 0x83ffU | (iVar9 + i_4 & 0x1fU) << 10;
              UpdateShdefCost(lpshdef);
              if (fStarbaseMode == 0) {
                pcVar2 = (char *)((int)&rgplr[0].cShDef + idPlayer * 0xc0);
                *pcVar2 = *pcVar2 + '\x01';
              }
              else {
                _j_2 = CONCAT22(i_4,*(int *)((int)&rgplr[0].wFlags +
                                            idPlayer * 0xc0) + 0x1000) & 0xfffff000;
                puVar1 = (uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0);
                *puVar1 = *puVar1 & 0xfff;
                puVar1 = (uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0);
                *puVar1 = *puVar1 | j_2;
              }
              LogChangeShDef(lpshdef);
              FillBuildDD(hwndItem,mdBuild);
              SendMessage(hwndItem,0x40e,i_4,0);
              HVar8 = GetDlgItem(hwndSlotDlg,0x818);
              EnableWindow(HVar8,1);
                    /* WARNING: Ignoring partial resolution of indirect */
              lpshdefBuild._0_2_ = pSVar16;
                    /* WARNING: Ignoring partial resolution of indirect */
              lpshdefBuild._2_2_ = uVar10;
              UpdateSlotGlobals();
              fHullCopy = 1;
              goto BUILD_EditDesign;
            }
            lSel = LVar22;
            if (mdBuild == 0) {
              lpshdef = NthValidShdef((short)LVar22);
              if (((SHDEF *)lpshdef)->wFlags < 0) goto BUILD_LStripDown;
            }
            else {
              lpshdef = NthValidEnemyShdef((short)LVar22);
BUILD_LStripDown:
              if (fStarbaseMode == 0) {
                part_4.hs.grhst = (lpshdef->hul).ihuldef;
                part_4.pcom._0_2_ =
                     (COMPART *)
                     ((uint)(COMPART *)part_4.pcom &
                      (hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|
                      hstMines) |
                     part_4.hs.grhst &
                     (hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine));
                part_4.hs.wFlags = 0x4000;
              }
              else {
                part_4.hs.grhst = (lpshdef->hul).ihuldef - hstTorp;
                part_4.pcom._0_2_ =
                     (COMPART *)
                     ((uint)(COMPART *)part_4.pcom &
                      (hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|
                      hstMines) |
                     part_4.hs.grhst &
                     (hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine));
                part_4.hs.wFlags = 0x400;
              }
              sVar26 = FLookupPart((PART *)&part_4.hs.wFlags);
              if (sVar26 != 1) {
                sVar26 = 0x10;
                pcVar6 = PszFormatIds(idsCantCopyShipDesignBecauseCantBuild,(short *)0x0);
                AlertSz(pcVar6,sVar26);
                goto LAB_10c8_2641;
              }
            }
            if (-1 < lSel) {
              if (((SHDEF *)lpshdef != (SHDEF *)0x0) || (lpshdef._2_2_ != 0)) {
                if (fStarbaseMode == 0) {
                  pHVar18 = (HullDef *)(i_4 * 0x93 + 0x3f00);
                  for (iVar9 = 0x49; iVar9 != 0; iVar9 = iVar9 + -1) {
                    pHVar4 = pHVar18;
                    pHVar18 = pHVar18 + 1;
                    pSVar25 = (SHDEF *)lpshdef;
                    lpshdef._0_2_ = (SHDEF *)(((SHDEF *)lpshdef)->hul).rgTech;
                    *pHVar4 = (pSVar25->hul).ihuldef;
                  }
                  *(char *)pHVar18 = (char)(((SHDEF *)lpshdef)->hul).ihuldef;
                  lpshdef = (SHDEF *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                              (SHDEF *)(i_4 * 0x93 + 0x3f00));
                }
                else {
                  uVar10 = *(undefined2 *)(idPlayer * 4 + 0x14e);
                  pHVar18 = (HullDef *)(*(int *)(idPlayer * 4 + 0x14c) + i_4 * 0x93);
                  for (iVar9 = 0x49; iVar9 != 0; iVar9 = iVar9 + -1) {
                    pHVar4 = pHVar18;
                    pHVar18 = pHVar18 + 1;
                    pSVar25 = (SHDEF *)lpshdef;
                    lpshdef._0_2_ = (SHDEF *)(((SHDEF *)lpshdef)->hul).rgTech;
                    *pHVar4 = (pSVar25->hul).ihuldef;
                  }
                  *(char *)pHVar18 = (char)(((SHDEF *)lpshdef)->hul).ihuldef;
                  _j_2 = CONCAT22(i_4,i_4 * 0x93);
                  lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x14e),
                                              (SHDEF *)(*(int *)(idPlayer * 4 + 0x14c) +
                                                       i_4 * 0x93));
                }
                uVar10 = (undefined2)((ulong)lpshdef >> 0x10);
                pSVar16 = (SHDEF *)lpshdef;
                *(undefined2 *)&pSVar16->cExist = 0;
                *(undefined2 *)((int)&pSVar16->cExist + 2) = 0;
                *(undefined2 *)&pSVar16->cBuilt = 0;
                *(undefined2 *)((int)&pSVar16->cBuilt + 2) = 0;
                if ((mdBuild == 0) && (-1 < pSVar16->wFlags)) {
                  MakeNewName((char *)CONCAT22(uVar10,(pSVar16->hul).szClass));
                }
                else {
                  pSVar16->wFlags = pSVar16->wFlags & 0x7fff;
                  _j_2 = _j_2 & 0xffff0000;
                  while (j_2 < (int)(uint)(pSVar16->hul).chs) {
                    if ((uint)(pSVar16->hul).rghs[j_2].wFlags >> 8 != 0) {
                      pHVar15 = (pSVar16->hul).rghs + j_2;
                      part_4.hs.grhst = pHVar15->grhst;
                      part_4.hs.wFlags = pHVar15->wFlags;
                      sVar26 = FLookupPart(&part_4);
                      if (sVar26 != 1) {
                        (pSVar16->hul).rghs[j_2].wFlags = (pSVar16->hul).rghs[j_2].wFlags & 0xff;
                      }
                    }
                    _j_2 = CONCAT22(i_4,j_2 + 1);
                  }
                }
                goto LAB_10c8_1d0f;
              }
            }
          }
        }
      }
      else if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
        AdvanceTutor();
      }
    }
    else if (wParam == 0x818) {
      if (((((uint)gd._0_2_ >> 0xb & 1) == 0) ||
          (sVar26 = FTutorialEnabledShipBuilder(2), sVar26 != 0)) &&
         ((fStarbaseMode == 0 ||
          ((((uint)((SHDEF *)lpshdefBuild)->wFlags >> 10 & 0x1f) != 0x10 ||
           (sVar26 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
           sVar26 != raMacintosh)))))) {
        hwndItem = GetDlgItem(hwnd,0x81a);
        lSel = SendMessage(hwndItem,0x407,0,0);
        pSVar25 = NthValidShdef((short)lSel);
        if ((-1 < lSel) &&
           (((SHDEF *)pSVar25 != (SHDEF *)0x0 || ((int)((ulong)pSVar25 >> 0x10) != 0)))) {
          if (fStarbaseMode == 0) {
            sVar26 = FCheckQueuedShip(hwnd,pSVar25,1);
            if (sVar26 == 0) goto LAB_10c8_2641;
          }
BUILD_EditDesign:
          if (((SHDEF *)lpshdefBuild != (SHDEF *)0x0) ||
             (lpshdefBuild._2_2_ != 0)) {
            InvalidateRect(hwnd,(undefined2 *)0x0,1);
            mdBuild = 4;
            uVar10 = (undefined2)((ulong)lpshdefBuild >> 0x10);
            pSVar16 = (SHDEF *)lpshdefBuild;
            ishdefBuild = (uint)pSVar16->wFlags >> 10 & 0x1f;
            pSVar17 = (SHDEF *)&shdefBuild;
            for (iVar9 = 0x49; iVar9 != 0; iVar9 = iVar9 + -1) {
              pSVar3 = pSVar17;
              pSVar17 = (SHDEF *)(pSVar17->hul).rgTech;
              pSVar25 = pSVar16;
              pSVar16 = (SHDEF *)(pSVar16->hul).rgTech;
              (pSVar3->hul).ihuldef = (pSVar25->hul).ihuldef;
            }
            *(char *)&(pSVar17->hul).ihuldef = (char)(pSVar16->hul).ihuldef;
                    /* WARNING: Ignoring partial resolution of indirect */
                    /* WARNING: Ignoring partial resolution of indirect */
            if (fStarbaseMode == 0) {
              puVar19 = (undefined *)&DAT_1120_19ff;
            }
            else {
              puVar19 = (undefined *)0xa3c;
            }
            HVar8 = GetDlgItem(hwnd,0x80c);
            FillBuildPartsLB(HVar8,(short)puVar19);
            sVar26 = mdBuild;
            HVar8 = GetDlgItem(hwnd,0x81a);
            FillBuildDD(HVar8,sVar26);
            ShowMainControls(hwnd,0);
            HVar8 = GetDlgItem(hwnd,0x80c);
            SetWindowPos(HVar8,0,0x10,0x20,0,0,0x45);
            HVar8 = GetDlgItem(hwnd,0x81a);
            SetWindowPos(HVar8,0,0x10,8,0,0,0x45);
            HVar8 = GetDlgItem(hwnd,0x81b);
            SetWindowPos(HVar8,0,ptslotGlob.x + -0x108,8,0xf0,dyArial8 * 3 >> 1,
                         0x44);
            HVar8 = GetDlgItem(hwnd,0x81b);
            SetWindowText(HVar8,shdefBuild.hul.szClass);
            HVar8 = GetDlgItem(hwnd,0x81b);
            SendMessage(HVar8,0x415,0x1f,0);
            if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
              AdvanceTutor();
            }
          }
        }
      }
    }
    else if ((wParam == 1) || (wParam == 2)) {
      if (mdBuild != 4) {
        SetBuildSelection(-2);
        StickyDlgPos(hwnd,(POINT *)&ptStickySlotDlg,0);
        hwndSlotDlg = 0;
        EndDialog(hwnd,(uint)(wParam == 1));
        if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
          AdvanceTutor();
        }
        pfVar5 = (fn_lpfnRealListProc *)
                 CONCAT22(lpfnRealListProc._2_2_,
                          (fn_lpfnRealListProc *)lpfnRealListProc);
        HVar14 = 1;
        goto LAB_10c8_2647;
      }
      lSel._0_2_ = 0;
      lSel._2_2_ = 0;
      if (wParam == 1) {
        if ((fStarbaseMode == 0) &&
           ((uint)shdefBuild.hul.rghs[0].wFlags >> 8 == 0)) {
          sVar26 = 0x10;
          pcVar6 = PszFormatIds(idsShipDesignDoesHaveAnyEnginesMust,(short *)0x0);
          AlertSz(pcVar6,sVar26);
          pfVar5 = (fn_lpfnRealListProc *)
                   CONCAT22(lpfnRealListProc._2_2_,
                            (fn_lpfnRealListProc *)lpfnRealListProc);
          HVar14 = 0;
          goto LAB_10c8_2647;
        }
        if ((((uint)gd._0_2_ >> 0xb & 1) == 0) ||
           (sVar26 = FTutorialEnabledShipBuilder(3), sVar26 != 0)) {
          HVar8 = GetDlgItem(hwnd,0x81b);
          GetWindowText(HVar8,shdefBuild.hul.szClass,0x20);
          shdefBuild.cBuilt._0_2_ = 0;
          shdefBuild.cBuilt._2_2_ = 0;
          shdefBuild.cExist._0_2_ = 0;
          shdefBuild.cExist._2_2_ = 0;
          shdefBuild.wFlags = shdefBuild.wFlags & 0xfdff;
          UpdateShdefCost(&shdefBuild);
          if (fStarbaseMode == 0) {
            pHVar18 = (HullDef *)(ishdefBuild * 0x93 + 0x3f00);
            pSVar16 = (SHDEF *)&shdefBuild;
            for (iVar9 = 0x49; iVar9 != 0; iVar9 = iVar9 + -1) {
              pHVar4 = pHVar18;
              pHVar18 = pHVar18 + 1;
              pSVar25 = pSVar16;
              pSVar16 = (SHDEF *)(pSVar16->hul).rgTech;
              *pHVar4 = (pSVar25->hul).ihuldef;
            }
            *(char *)pHVar18 = (char)(pSVar16->hul).ihuldef;
            LogChangeShDef
                      ((SHDEF *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                         (SHDEF *)(ishdefBuild * 0x93 + 0x3f00)));
            _j_2 = _j_2 & 0xffff;
            while (i_4 < ishdefBuild) {
              if ((*(uint *)((int)&rgshdef[0].wFlags + i_4 * 0x93) >> 9 & 1) == 0) {
                bVar20 = 0xfffe < (HullSlotType)lSel;
                lSel._0_2_ = (HullSlotType)lSel + 1;
                lSel._2_2_ = lSel._2_2_ + (uint)bVar20;
              }
              _j_2 = CONCAT22(i_4 + 1,j_2);
            }
          }
          else {
            ishdefBuild = ishdefBuild + -0x10;
            uVar10 = *(undefined2 *)(idPlayer * 4 + 0x14e);
            pHVar18 = (HullDef *)
                      (*(int *)(idPlayer * 4 + 0x14c) + ishdefBuild * 0x93);
            pSVar16 = (SHDEF *)&shdefBuild;
            for (iVar9 = 0x49; iVar9 != 0; iVar9 = iVar9 + -1) {
              pHVar4 = pHVar18;
              pHVar18 = pHVar18 + 1;
              pSVar25 = pSVar16;
              pSVar16 = (SHDEF *)(pSVar16->hul).rgTech;
              *pHVar4 = (pSVar25->hul).ihuldef;
            }
            *(char *)pHVar18 = (char)(pSVar16->hul).ihuldef;
            _j_2 = CONCAT22(i_4,ishdefBuild * 0x93);
            LogChangeShDef(&shdefBuild);
            _j_2 = _j_2 & 0xffff;
            while (i_4 < ishdefBuild) {
              if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i_4 * 0x93 + 0x7b) >> 9 & 1) ==
                  0) {
                bVar20 = 0xfffe < (HullSlotType)lSel;
                lSel._0_2_ = (HullSlotType)lSel + 1;
                lSel._2_2_ = lSel._2_2_ + (uint)bVar20;
              }
              _j_2 = CONCAT22(i_4 + 1,j_2);
            }
            ishdefBuild = ishdefBuild + 0x10;
          }
          goto LAB_10c8_234f;
        }
      }
      else if ((((uint)gd._0_2_ >> 0xb & 1) == 0) ||
              (sVar26 = FTutorialEnabledShipBuilder(4), sVar26 != 0)) {
LAB_10c8_234f:
        InvalidateRect(hwnd,(undefined2 *)0x0,1);
        ShowMainControls(hwnd,5);
        HVar8 = GetDlgItem(hwnd,0x81b);
        ShowWindow(HVar8,0);
        hwndItem = GetDlgItem(hwnd,0x80c);
        uVar12 = rggrbitPartsSB[0];
        if (fStarbaseMode == 0) {
          uVar12 = rggrbitParts[0];
        }
        FillBuildPartsLB(hwndItem,uVar12);
        SetWindowPos(hwndItem,0,ptslotGlob.x + -0x100,0x20,0xf0,0x10a,4);
        HVar8 = GetDlgItem(hwnd,0x80c);
        ShowWindow(HVar8,0);
        if (fHullCopy != 0) {
          if (((wParam != 2) && (fStarbaseMode == 0)) &&
             ((uint)(((SHDEF *)lpshdefBuild)->hul).rghs[0].wFlags >> 8 == 0)) {
            wParam = 2;
          }
          if (wParam == 2) {
            if (fStarbaseMode == 0) {
              _j_2 = CONCAT22(i_4,*(undefined2 *)
                                   ((int)&rgshdef[0].wFlags + ishdefBuild * 0x93
                                   )) & 0xfffffdff | 0x200;
              *(short *)((int)&rgshdef[0].wFlags + ishdefBuild * 0x93) = j_2;
              pcVar2 = (char *)((int)&rgplr[0].cShDef + idPlayer * 0xc0);
              *pcVar2 = *pcVar2 + -1;
              LogChangeShDef
                        ((SHDEF *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                           (SHDEF *)(ishdefBuild * 0x93 + 0x3f00)));
            }
            else {
              shdefBuild.wFlags = shdefBuild.wFlags & 0xfdffU | 0x200;
              uVar10 = *(undefined2 *)(idPlayer * 4 + 0x14e);
              pHVar18 = (HullDef *)
                        (*(int *)(idPlayer * 4 + 0x14c) +
                        (ishdefBuild + -0x10) * 0x93);
              pSVar16 = (SHDEF *)&shdefBuild;
              for (iVar9 = 0x49; iVar9 != 0; iVar9 = iVar9 + -1) {
                pHVar4 = pHVar18;
                pHVar18 = pHVar18 + 1;
                pSVar25 = pSVar16;
                pSVar16 = (SHDEF *)(pSVar16->hul).rgTech;
                *pHVar4 = (pSVar25->hul).ihuldef;
              }
              *(char *)pHVar18 = (char)(pSVar16->hul).ihuldef;
              _j_2 = CONCAT22(i_4,*(int *)((int)&rgplr[0].wFlags + idPlayer * 0xc0)
                                  + -0x1000) & 0xfffff000;
              puVar1 = (uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0);
              *puVar1 = *puVar1 & 0xfff;
              puVar1 = (uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0);
              *puVar1 = *puVar1 | j_2;
              LogChangeShDef(&shdefBuild);
            }
          }
        }
        wParam = 0x812;
        goto BUILD_LRestart;
      }
    }
    else if (wParam == 0x76) {
      if (mdBuild == 4) {
        uVar13 = 0xbdf;
      }
      else {
        uVar13 = 0x42a;
      }
      WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,(ulong)uVar13);
      pfVar5 = (fn_lpfnRealListProc *)
               CONCAT22(lpfnRealListProc._2_2_,
                        (fn_lpfnRealListProc *)lpfnRealListProc);
      HVar14 = 1;
      goto LAB_10c8_2647;
    }
  }
LAB_10c8_2641:
  HVar14 = 0;
  pfVar5 = (fn_lpfnRealListProc *)
           CONCAT22(lpfnRealListProc._2_2_,
                    (fn_lpfnRealListProc *)lpfnRealListProc);
LAB_10c8_2647:
  lpfnRealListProc._2_2_ = (undefined2)((ulong)pfVar5 >> 0x10);
  lpfnRealListProc._0_2_ = (fn_lpfnRealListProc *)pfVar5;
  return HVar14;
}



// ======================================================================
// Function: DrawSlotDlg
// Address: 10c8:2650
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10c829b7) */

void DrawSlotDlg(HWND hwnd,HDC hdc,RECT *prc,short iDraw)

{
  uint uVar1;
  HULDEF *pHVar2;
  HDC HVar3;
  HGDIOBJ HVar4;
  uint uVar5;
  short sVar6;
  HGDIOBJ HVar7;
  HGDIOBJ HVar8;
  HBRUSH HVar9;
  int iVar10;
  int iVar11;
  char *pcVar12;
  short sVar13;
  undefined2 uVar14;
  HS *pHVar15;
  undefined2 unaff_SS;
  bool bVar16;
  HULDEF *pHVar17;
  COLORREF CVar18;
  DWORD DVar19;
  RECT *pRVar20;
  undefined1 *puVar21;
  HDC HVar22;
  COLORREF crBkSav;
  RECT rc;
  HULDEF *lphuldef;
  PART part;
  short xLeft;
  HBITMAP hbmpSav;
  short ibmp;
  short cItem;
  short j;
  short bkMode;
  short i;
  short c;
  HDC hdcMem;
  short fCreatedDC;
  short cSlot;
  short iMax;
  short yTop;
  
  if ((mdBuild != 3) &&
     (((SHDEF *)lpshdefBuild != (SHDEF *)0x0 || (lpshdefBuild._2_2_ != 0)))) {
    pHVar17 = LphuldefFromId((lpshdefBuild->hul).ihuldef);
    uVar14 = (undefined2)((ulong)pHVar17 >> 0x10);
    pHVar2 = (HULDEF *)pHVar17;
    iMax = (short)(pHVar2->hul).chs;
    bVar16 = hdc == 0;
    if (bVar16) {
      hdc = GetDC(hwnd);
    }
    if (hwndSlotDlg == 0) {
      xLeft = 4;
    }
    else {
      xLeft = ptslotGlob.x + -0x152;
    }
    DrawFleetBitmap
              ((FLEET *)0x0,hdc,xLeft,6,1,(((SHDEF *)lpshdefBuild)->hul).ibmp,0,0,-1,0);
    HVar3 = CreateCompatibleDC(hdc);
    HVar4 = SelectObject(HVar3,hbmpScanner);
    if (mdBuild == 4) {
      SetRect(&rgrcBuildSpin[0].left,xLeft + 0x15,0x4b,xLeft + 0x23,0x59);
      rgrcBuildSpin[1].left = rgrcBuildSpin[0].left;
      rgrcBuildSpin[1].top = rgrcBuildSpin[0].top;
      rgrcBuildSpin[1].right = rgrcBuildSpin[0].right;
      rgrcBuildSpin[1].bottom = rgrcBuildSpin[0].bottom;
      OffsetRect(&rgrcBuildSpin[1].left,0xe,0);
      for (i = 0; i < 2; i = i + 1) {
        if (i == 0) {
          uVar5 = 2;
        }
        else {
          uVar5 = 3;
        }
        DrawBtn(hdc,(RECT *)rgrcBuildSpin + i,uVar5 | 0x20,0,(char *)0x0);
      }
    }
    else {
      rgrcBuildSpin[1].top = -5;
      rgrcBuildSpin[0].top = -5;
      rgrcBuildSpin[1].bottom = -6;
      rgrcBuildSpin[0].bottom = -6;
    }
    SelectObject(hdc,rghfontArial8[1]);
    sVar6 = SetBkMode(hdc,1);
    if (iDraw == -1) {
      i = 0;
    }
    else {
      i = iDraw;
      iMax = iDraw + 1;
    }
    if ((pHVar2->hul).wtCargoMax != 0) {
      rc.left = rcCargo.left;
      rc.top = rcCargo.top;
      rc.right = rcCargo.right;
      rc.bottom = rcCargo.bottom;
      if ((fStarbaseMode == 0) ||
         (((pHVar17->hul).ihuldef != (ihuldefCount|ihuldefMediumFreighter) &&
          ((pHVar17->hul).ihuldef != (ihuldefCount|ihuldefScout))))) {
        puVar21 = (undefined1 *)&DAT_1120_1120;
        pRVar20 = (RECT *)&rcCargo;
        HVar22 = hdc;
        HVar8 = GetStockObject(4);
        FillRect(HVar22,(undefined2 *)CONCAT22(puVar21,pRVar20),HVar8);
        rc.top = rc.top + 1;
        rc.bottom = rc.bottom + -1;
        rc.left = rc.left + 1;
        rc.right = rc.right + -1;
        HVar9 = hbrDock;
        if (fStarbaseMode == 0) {
          HVar9 = hbrCargo;
        }
        FillRect(hdc,(undefined2 *)CONCAT22(unaff_SS,&rc),HVar9);
      }
      else {
        HVar8 = SelectObject(hdc,hbrDock);
        HVar22 = hdc;
        HVar7 = GetStockObject(7);
        HVar7 = SelectObject(HVar22,HVar7);
        Ellipse(hdc,rc.left + -0xc,rc.top + -0xc,rc.right + 0xc,rc.bottom + 0xc);
        SelectObject(hdc,HVar7);
        SelectObject(hdc,HVar8);
      }
      rc.bottom = (rc.bottom - rc.top) / 2 + rc.top;
      if (fStarbaseMode == 0) {
        sVar13 = 0;
        pcVar12 = PszGetCompressedString(idsCargo3);
        RcCtrTextOut(hdc,&rc,pcVar12,sVar13);
        sVar13 = WtMaxShdefStat(lpshdefBuild,2);
        _WSPRINTF((LPSTR)CONCAT22(sVar13,(char *)&DAT_1120_1120),
                  (LPCSTR)CONCAT22(PCTDKT,(char *)&DAT_1120_1120),(char *)szWork);
        RcCtrTextOut(hdc,(RECT *)&rcCargo,(char *)szWork,0);
      }
      else {
        if ((pHVar2->hul).wtCargoMax == -1) {
          sVar13 = 0;
          pcVar12 = PszGetCompressedString(idsUnlimited);
          RcCtrTextOut(hdc,&rc,pcVar12,sVar13);
        }
        else {
          _WSPRINTF((LPSTR)CONCAT22((pHVar2->hul).wtCargoMax,(char *)&DAT_1120_1120),
                    (LPCSTR)CONCAT22(PCTDKT,(char *)&DAT_1120_1120),(char *)szWork)
          ;
          RcCtrTextOut(hdc,&rc,(char *)szWork,0);
        }
        sVar13 = 0;
        pcVar12 = PszGetCompressedString(idsSpace);
        RcCtrTextOut(hdc,(RECT *)&rcCargo,pcVar12,sVar13);
      }
      rc.top = rc.bottom;
      rc.bottom = rcCargo.bottom + -1;
      if (fStarbaseMode == 0) {
        sVar13 = 0;
        pcVar12 = PszGetCompressedString(idsMax);
        RcCtrTextOut(hdc,&rc,pcVar12,sVar13);
      }
      else {
        sVar13 = 0;
        pcVar12 = PszGetCompressedString(idsDock);
        RcCtrTextOut(hdc,&rc,pcVar12,sVar13);
      }
    }
    for (; i < iMax; i = i + 1) {
      FillRect(hdc,(undefined2 *)
                   CONCAT22((undefined1 *)&DAT_1120_1120,(RECT *)vrgrcSlot + i),
               hbr50Screen);
      uVar5 = (uint)(((SHDEF *)lpshdefBuild)->hul).rghs[i].wFlags >> 8;
      if (uVar5 == 0) {
        SelectObject(HVar3,hbmpBackBld);
        uVar5 = IEmptyBmpFromGrhst(((pHVar2->hul).rghs + i)->grhst);
        BitBlt(hdc,((RECT *)vrgrcSlot + i)->left,
               *(short *)((int)&vrgrcSlot[0].top + i * 8),0x40,0x40,HVar3,(uVar5 & 7) << 6
               ,((int)uVar5 >> 3 & 3U) << 6,0xcc0020);
        if ((((pHVar2->hul).rghs + i)->grhst & hstEngine) ==
            ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
              hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
          uVar5 = (uint)(pHVar2->hul).rghs[i].wFlags >> 8;
          pcVar12 = PszGetCompressedString(idsD3);
          c = _WSPRINTF((LPSTR)CONCAT22(uVar5,(char *)&DAT_1120_1120),
                        (LPCSTR)CONCAT22(pcVar12,(char *)&DAT_1120_1120),(char *)szWork);
        }
        else {
          uVar5 = (uint)(pHVar2->hul).rghs[i].wFlags >> 8;
          pcVar12 = PszGetCompressedString(idsNeedsD);
          c = _WSPRINTF((LPSTR)CONCAT22(uVar5,(char *)&DAT_1120_1120),
                        (LPCSTR)CONCAT22(pcVar12,(char *)&DAT_1120_1120),(char *)szWork);
        }
      }
      else {
        pHVar15 = (((SHDEF *)lpshdefBuild)->hul).rghs + i;
        part.hs.grhst = pHVar15->grhst;
        part.hs.wFlags = pHVar15->wFlags;
        FLookupPart(&part);
        uVar1 = ((COMPART *)part.pcom)->ibmp;
        DibBlt(hdc,((RECT *)vrgrcSlot + i)->left,
                        *(short *)((int)&vrgrcSlot[0].top + i * 8),0x40,0x40,
                        ((ushort *)rghdibInventory)[(int)uVar1 >> 5],(uVar1 & 7) << 6,
                        (3 - ((int)uVar1 >> 3 & 3U)) * 0x40,0x40,0x40,0xcc0020);
        if (mdBuild != 4) {
          SelectObject(HVar3,hbmpScanner);
          for (j = 0; j < 4; j = j + 1) {
            if (j < 2) {
              iVar10 = 3;
            }
            else {
              iVar10 = 0x39;
            }
            if ((j & 1U) == 0) {
              iVar11 = 0x39;
            }
            else {
              iVar11 = 3;
            }
            BitBlt(hdc,iVar10 + ((RECT *)vrgrcSlot + i)->left,
                   iVar11 + *(int *)((int)&vrgrcSlot[0].top + i * 8),4,4,HVar3,0x16,0x21,
                   0xcc0020);
          }
        }
        if (((uVar5 == 1) && ((uint)(pHVar2->hul).rghs[i].wFlags >> 8 == 1)) &&
           (part.hs.grhst == hstSpecialSB)) {
          szWork[0] = '\0';
          c = 0;
        }
        else {
          pcVar12 = PszGetCompressedString(idsDD);
          c = _WSPRINTF((LPSTR)CONCAT22(uVar5,(char *)&DAT_1120_1120),
                        (LPCSTR)CONCAT22(pcVar12,(char *)&DAT_1120_1120),(char *)szWork);
        }
      }
      CtrTextOut(hdc,((RECT *)vrgrcSlot + i)->left + 0x20,
                          (*(int *)((int)&vrgrcSlot[0].bottom + i * 8) -
                          dyArial6) + -4,(char *)szWork,c);
      if (iselSlot == i) {
        CVar18 = SetBkColor(hdc,0xffffff);
        FrameRect(hdc,(undefined2 *)
                      CONCAT22((undefined1 *)&DAT_1120_1120,(RECT *)vrgrcSlot + i),
                  hbr50Screen);
        ExpandRc((RECT *)vrgrcSlot + i,-1,-1);
        FrameRect(hdc,(undefined2 *)
                      CONCAT22((undefined1 *)&DAT_1120_1120,(RECT *)vrgrcSlot + i),
                  hbr50Screen);
        ExpandRc((RECT *)vrgrcSlot + i,1,1);
        SetBkColor(hdc,CVar18);
      }
    }
    if (((hwndPopup == 0) || (GlobalPD.iPlanMin == 0)) && (mdBuild == 0)) {
      SetRect((undefined2 *)CONCAT22(unaff_SS,&rc),ptPlaque.x,ptPlaque.y,
              ptPlaque.x + 0x3c,ptPlaque.y + 0x1e);
      SelectPalette(hdc,vhpal,0);
      RealizePalette(hdc);
      DibBlt(hdc,ptPlaque.x,ptPlaque.y,0x3c,0x1e,hdibPlaque,0,0,
                      0x3c,0x1e,0xcc0020);
      uVar14 = (undefined2)((SHDEF *)lpshdefBuild)->cExist;
      pcVar12 = PszGetCompressedString(idsLdLd);
      sVar13 = _WSPRINTF((LPSTR)CONCAT22(uVar14,(char *)&DAT_1120_1120),
                         (LPCSTR)CONCAT22(pcVar12,(char *)&DAT_1120_1120),(char *)szWork);
      SelectObject(hdc,rghfontArial8[1]);
      DVar19 = GetTextExtent(hdc,szWork,sVar13);
      if (0x32 < (uint)DVar19) {
        SelectObject(hdc,rghfontArial7[0]);
        DVar19 = GetTextExtent(hdc,szWork,sVar13);
        if (0x32 < (uint)DVar19) {
          SelectObject(hdc,rghfontArial6[0]);
        }
      }
      RcCtrTextOut(hdc,&rc,(char *)szWork,sVar13);
    }
    SetBkMode(hdc,sVar6);
    SelectObject(HVar3,HVar4);
    DeleteDC(HVar3);
    if (bVar16) {
      ReleaseDC(hwnd,hdc);
    }
  }
  return;
}



// ======================================================================
// Function: FTrackSlot
// Address: 10c8:306a
// Segment: MEMORY_BUILD
// ======================================================================


short FTrackSlot(HWND hwnd,short x,short y,short fkb,short fListBox,short fRightBtn)

{
  POINT pt_00;
  POINT pt_01;
  HS hsSrc;
  HS hsSrc_00;
  bool bVar1;
  bool bVar2;
  HWND hwnd_00;
  short y_00;
  int x_00;
  BOOL BVar3;
  uint uVar4;
  int iVar5;
  HDC hdc_00;
  HDC HVar6;
  HDC hdc_01;
  HBITMAP HVar7;
  HGDIOBJ HVar8;
  HBITMAP HVar9;
  HGDIOBJ HVar10;
  short sVar11;
  HCURSOR HVar12;
  HS *pHVar13;
  undefined2 unaff_SS;
  HULDEF *pHVar14;
  LRESULT LVar15;
  short xLeft;
  short iCur;
  short iBase;
  RECT *prc;
  BTNT btnt;
  short bt;
  short dxStart;
  short dyStart;
  RECT rc;
  PART part;
  short fFirst;
  HS hs;
  HBITMAP hbmpSav;
  short iSel;
  POINT ptD;
  HDC hdcMemFull;
  HBITMAP hbmpOld;
  short ibmp;
  HBITMAP hbmpScreen;
  short fUseMem;
  RECT rcStart;
  HBITMAP hbmpFullSav;
  short i;
  HDC hdcMem;
  short ibmpX;
  POINT ptDNew;
  short iSrc;
  short cSlot;
  POINT pt;
  short ibmpY;
  POINT ptTileSize;
  POINT ptOld;
  HDC hdc;
  
  bVar1 = true;
  if (((SHDEF *)lpshdefBuild == (SHDEF *)0x0) && (lpshdefBuild._2_2_ == 0)) {
    sVar11 = 0;
  }
  else {
    pt.x = x;
    pt.y = y;
    pHVar14 = LphuldefFromId((lpshdefBuild->hul).ihuldef);
    uVar4 = (uint)(((HULDEF *)pHVar14)->hul).chs;
    if (((fRightBtn == 0) && (hwndSlotDlg != 0)) &&
       ((BVar3 = PtInRect((undefined2 *)CONCAT22((RECT *)rgrcBuildSpin,pt.y),pt.x),
        BVar3 != 0 || (BVar3 = PtInRect((undefined2 *)CONCAT22(0x592e,pt.y),pt.x), BVar3 != 0)))) {
      BVar3 = PtInRect((undefined2 *)CONCAT22((RECT *)rgrcBuildSpin,pt.y),pt.x);
      if (BVar3 == 0) {
        dyStart = 1;
        bt = 0x23;
        prc = (RECT *)(rgrcBuildSpin + 1);
      }
      else {
        dyStart = -1;
        bt = 0x22;
        prc = (RECT *)rgrcBuildSpin;
      }
      uVar4 = (((SHDEF *)lpshdefBuild)->hul).ibmp;
      iCur = uVar4 & 3;
      iVar5 = uVar4 - iCur;
      x_00 = ptslotGlob.x + -0x150;
      InitBtnTrack(&btnt,hwnd,0,prc,bt,0x50,0,0,(char *)0x0);
      while (sVar11 = FTrackBtn(&btnt), sVar11 != 0) {
        iCur = iCur + 4 + dyStart & 3;
        DrawFleetBitmap((FLEET *)0x0,btnt.hdc,x_00,8,0,iVar5 + iCur,0,0,-1,0);
      }
      (((SHDEF *)lpshdefBuild)->hul).ibmp = iVar5 + iCur;
      sVar11 = 1;
    }
    else {
      if (fListBox == 0) {
        GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
        iSrc = 0;
        while ((iSrc < (int)uVar4 &&
               (BVar3 = PtInRect((undefined2 *)CONCAT22((RECT *)vrgrcSlot + iSrc,pt.y),
                                 pt.x), BVar3 == 0))) {
          iSrc = iSrc + 1;
        }
        if (iSrc == uVar4) {
          return 0;
        }
        pHVar13 = (((SHDEF *)lpshdefBuild)->hul).rghs + iSrc;
        hs.grhst = pHVar13->grhst;
        hs.wFlags = pHVar13->wFlags;
        if ((uint)hs.wFlags >> 8 == 0) {
          SetBuildSelection(iSrc);
          return 0;
        }
        part.hs.grhst = hs.grhst;
        part.hs.wFlags = hs.wFlags;
        FLookupPart(&part);
        ibmp = ((COMPART *)part.pcom)->ibmp;
        iVar5 = iSrc * 8;
        rcStart.left = ((RECT *)vrgrcSlot + iSrc)->left;
        rcStart.top = *(short *)((int)&vrgrcSlot[0].top + iVar5);
        rcStart.right = *(short *)((int)&vrgrcSlot[0].right + iVar5);
        rcStart.bottom = *(short *)((int)&vrgrcSlot[0].bottom + iVar5);
      }
      else {
        LVar15 = SendMessage(hwnd,0x409,0,0);
        if ((WPARAM)LVar15 == 0xffff) {
          return 0;
        }
        SendMessage(hwnd,0x40a,(WPARAM)LVar15,0x112057a4);
        ibmp = szWork[2] + -0x41 + (szWork[3] + -0x41) * 0x1a;
        iSrc = -1;
        hs.grhst = 1 << (szWork[0] + 0xbfU & 0x1f);
        uVar4 = (int)szWork[1] - 0x41U & 0xff;
        hs.wFlags = uVar4 | 0x100;
        rcStart.left = 2;
        rcStart.right = 0x42;
        iVar5 = (y / 0x42) * 0x42;
        rcStart.top = iVar5 + 1;
        rcStart.bottom = iVar5 + 0x41;
        ClientToScreen(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rcStart));
        ClientToScreen(hwnd,(short *)CONCAT22(unaff_SS,&rcStart.right));
        ClientToScreen(hwnd,(undefined2 *)CONCAT22(unaff_SS,&pt));
        hwnd_00 = hwndSlotDlg;
        hwnd = hwndSlotDlg;
        ScreenToClient(hwndSlotDlg,(undefined2 *)CONCAT22(unaff_SS,&rcStart));
        ScreenToClient(hwnd_00,(short *)CONCAT22(unaff_SS,&rcStart.right));
        ScreenToClient(hwnd_00,(undefined2 *)CONCAT22(unaff_SS,&pt));
        y_00 = pt.y;
        sVar11 = pt.x;
        x = pt.x;
        y = pt.y;
        if (((hs.grhst == hstEngine) && (uVar4 == 0)) &&
           ((lpshdefBuild->hul).ihuldef != ihuldefMiniColonyShip)) {
          GlobalPD.grPopup = 10;
          GlobalPD.field1_0x2 = 0xb4;
          GlobalPD.field2_0x3 = 0;
          GlobalPD.psz = (char *)szPopupBuffer;
          CchGetString
                    (idsSettlersDelightEngineMayMountedDesignsBased,(char *)szPopupBuffer)
          ;
          Popup(hwnd_00,sVar11,y_00);
          return 1;
        }
        if (((hs.grhst == hstSpecialM) && (uVar4 == 1)) &&
           ((lpshdefBuild->hul).ihuldef != ihuldefColonyShip)) {
          GlobalPD.grPopup = 10;
          GlobalPD.field1_0x2 = 0xb4;
          GlobalPD.field2_0x3 = 0;
          GlobalPD.psz = (char *)szPopupBuffer;
          CchGetString
                    (idsOrbitalConstructionModuleMayMountedDesignsBased,
                     (char *)szPopupBuffer);
          Popup(hwnd_00,sVar11,y_00);
          return 1;
        }
        if (((hs.grhst == hstSpecialE) && (uVar4 == 0)) &&
           (pHVar14 = LphuldefFromId((lpshdefBuild->hul).ihuldef),
           ((uint)((HULDEF *)pHVar14)->wFlags >> 6 & 0xf) != 0)) {
          GlobalPD.grPopup = 10;
          GlobalPD.field1_0x2 = 0xb4;
          GlobalPD.field2_0x3 = 0;
          GlobalPD.psz = (char *)szPopupBuffer;
          CchGetString
                    (idsTransportCloakingModuleMayPlacedHullCould,(char *)szPopupBuffer);
          Popup(hwnd_00,sVar11,y_00);
          return 1;
        }
      }
      SetBuildSelection(iSrc);
      if (fRightBtn == 0) {
        if (mdBuild == 4) {
          uVar4 = ibmp >> 3 & 3;
          hdc_00 = GetDC(hwnd);
          SelectPalette(hdc_00,vhpal,0);
          RealizePalette(hdc_00);
          HVar6 = CreateCompatibleDC(hdc_00);
          hdc_01 = CreateCompatibleDC(hdc_00);
          SelectPalette(hdc_01,vhpal,0);
          RealizePalette(hdc_01);
          HVar7 = CreateCompatibleBitmap(hdc_00,0x40,0x40);
          HVar8 = SelectObject(HVar6,HVar7);
          HVar9 = CreateCompatibleBitmap(hdc_00,0xc0,0xc0);
          HVar10 = SelectObject(hdc_01,HVar9);
          SetCapture(hwnd);
          ptOld.y = -1;
          ptOld.x = -1;
          while (sVar11 = FGetMouseMove(&pt), sVar11 != 0) {
            if ((pt.x != ptOld.x) || (pt.y != ptOld.y)) {
              if (bVar1) {
                bVar2 = false;
                bVar1 = false;
              }
              else {
                SelectObject(HVar6,HVar7);
                ptDNew.x = pt.x - ptOld.x;
                ptDNew.y = pt.y - ptOld.y;
                sVar11 = _abs(ptDNew.x);
                if ((sVar11 < 0x40) && (sVar11 = _abs(ptDNew.y), sVar11 < 0x40)) {
                  bVar2 = true;
                }
                else {
                  bVar2 = false;
                }
                if (bVar2) {
                  BitBlt(hdc_01,0,0,0xc0,0xc0,hdc_00,rcStart.left + ptD.x + -0x40,
                         rcStart.top + ptD.y + -0x40,0xcc0020);
                  BitBlt(hdc_01,0x40,0x40,0x40,0x40,HVar6,0,0,0xcc0020);
                }
                else {
                  BitBlt(hdc_00,rcStart.left + ptD.x,rcStart.top + ptD.y,0x40,0x40,HVar6,0,0,
                         0xcc0020);
                }
              }
              ptOld.x = pt.x;
              ptOld.y = pt.y;
              ptD.x = pt.x - x;
              ptD.y = pt.y - y;
              SelectObject(HVar6,HVar7);
              if (bVar2) {
                dxStart = 0;
                dyStart = 0;
                BitBlt(HVar6,0,0,0x40,0x40,hdc_01,ptDNew.x + 0x40,ptDNew.y + 0x40,0xcc0020);
                DibBlt(hdc_01,ptDNew.x + 0x40,ptDNew.y + 0x40,0x40,0x40,
                                ((ushort *)rghdibInventory)[ibmp / 0x20],(ibmp & 7U) << 6,
                                (3 - uVar4) * 0x40,0x40,0x40,0xcc0020);
                rc.left = rcStart.left;
                rc.top = rcStart.top;
                rc.right = rcStart.right;
                rc.bottom = rcStart.bottom;
                OffsetRc(&rc,ptD.x,ptD.y);
                if (ptDNew.x < 1) {
                  rc.right = rc.right - ptDNew.x;
                }
                else {
                  rc.left = rc.left - ptDNew.x;
                  dxStart = ptDNew.x;
                }
                if (ptDNew.y < 1) {
                  rc.bottom = rc.bottom - ptDNew.y;
                }
                else {
                  rc.top = rc.top - ptDNew.y;
                  dyStart = ptDNew.y;
                }
                BitBlt(hdc_00,rc.left,rc.top,rc.right - rc.left,rc.bottom - rc.top,hdc_01,
                       (ptDNew.x + 0x40) - dxStart,(ptDNew.y + 0x40) - dyStart,0xcc0020);
              }
              else {
                BitBlt(HVar6,0,0,0x40,0x40,hdc_00,rcStart.left + ptD.x,rcStart.top + ptD.y,0xcc0020)
                ;
                DibBlt(hdc_00,rcStart.left + ptD.x,rcStart.top + ptD.y,0x40,0x40,
                                ((ushort *)rghdibInventory)[ibmp / 0x20],(ibmp & 7U) << 6,
                                (3 - uVar4) * 0x40,0x40,0x40,0xcc0020);
              }
              pt_00.y = pt.y;
              pt_00.x = pt.x;
              hsSrc.wFlags = hs.wFlags;
              hsSrc.grhst = hs.grhst;
              sVar11 = IDropPart(pt_00,hsSrc,iSrc,1);
              if ((sVar11 < 0) || (sVar11 == 2)) {
                HVar12 = LoadCursor(0,&DAT_0000_7f00);
                setcursor(HVar12);
              }
              else if ((sVar11 == 1) && (-1 < iSrc)) {
                setcursor(hcurTrashCan);
              }
              else {
                setcursor(hcurNoWay);
              }
            }
          }
          if (!bVar1) {
            SelectObject(HVar6,HVar7);
            BitBlt(hdc_00,rcStart.left + ptD.x,rcStart.top + ptD.y,0x40,0x40,HVar6,0,0,0xcc0020);
          }
          ReleaseCapture();
          SelectObject(HVar6,HVar8);
          SelectObject(hdc_01,HVar10);
          DeleteObject(HVar7);
          DeleteObject(HVar9);
          DeleteDC(HVar6);
          DeleteDC(hdc_01);
          pt_01.y = pt.y;
          pt_01.x = pt.x;
          hsSrc_00.wFlags = hs.wFlags;
          hsSrc_00.grhst = hs.grhst;
          IDropPart(pt_01,hsSrc_00,iSrc,0);
          ReleaseDC(hwnd,hdc_00);
          sVar11 = 1;
        }
        else {
          sVar11 = 0;
        }
      }
      else {
        GlobalPD.field1_0x2 = (undefined1)part.hs.grhst;
        GlobalPD.field2_0x3 = part.hs.grhst._1_1_;
        GlobalPD.psz = (char *)part.hs.wFlags;
        GlobalPD.iPlanVal = (short)(COMPART *)part.pcom;
        GlobalPD.iPlanMin = part.pcom._2_2_;
        GlobalPD.grPopup = 9;
        Popup(hwnd,x,y);
        sVar11 = 1;
      }
    }
  }
  return sVar11;
}



// ======================================================================
// Function: DrawBuildSelComp
// Address: 10c8:3ab2
// Segment: MEMORY_BUILD
// ======================================================================


void DrawBuildSelComp(HWND hwnd,HDC hdc,short iDraw)

{
  HWND HVar1;
  StringId ids;
  char *pcVar2;
  int iVar3;
  char *pcVar4;
  short sVar5;
  uint uVar6;
  short sVar7;
  int iVar8;
  undefined2 uVar9;
  HS *pHVar10;
  char *unaff_SS;
  bool bVar11;
  bool bVar12;
  COLORREF CVar13;
  LRESULT LVar14;
  HULDEF *pHVar15;
  DWORD DVar16;
  ulong uVar17;
  undefined1 *puVar18;
  short sVar19;
  HDC HVar20;
  char *pch;
  RECT rc;
  short dxkT;
  short x;
  PART part;
  short cch;
  HS hsHul;
  COLORREF crBackSav;
  char szWord [80];
  short k;
  short fPlural;
  COLORREF crForeSav;
  short i;
  short c;
  short fCreatedDC;
  ushort rgCosts [4];
  HS hsShip;
  ushort grhst;
  
  bVar11 = hdc == 0;
  if (bVar11) {
    hdc = GetDC(hwnd);
  }
  GetClientRect(hwndSlotDlg,(undefined2 *)CONCAT22(unaff_SS,&rc));
  rc.bottom = rc.bottom + -8;
  rc.left = 8;
  rc.right = 0x108;
  rc.top = yBuildInfoSum;
  SelectObject(hdc,rghfontArial8[1]);
  CVar13 = SetTextColor(hdc,0);
  crBackSav = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,
                                      (undefined2)crButtonFace));
  FillRect(hdc,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
  if (fStarbaseMode != 0) {
    rc.top = rc.top + dyArial8;
  }
  if (iselSlot == -2) goto BUILD_Restore;
  if (iselSlot == -1) {
    HVar1 = GetDlgItem(hwndSlotDlg,0x80c);
    LVar14 = SendMessage(HVar1,0x409,0,0);
    if ((WPARAM)LVar14 == 0xffff) goto BUILD_Restore;
    HVar1 = GetDlgItem(hwndSlotDlg,0x80c);
    SendMessage(HVar1,0x40a,(WPARAM)LVar14,0x112057a4);
    hsShip.grhst = 1 << (szWork[0] + 0xbfU & 0x1f);
    hsShip.wFlags = (int)szWork[1] - 0x41U & 0xff | 0x100;
  }
  else {
    if (((SHDEF *)lpshdefBuild == (SHDEF *)0x0) && (lpshdefBuild._2_2_ == 0))
    goto BUILD_Restore;
    pHVar10 = (((SHDEF *)lpshdefBuild)->hul).rghs + iselSlot;
    hsShip.grhst = pHVar10->grhst;
    hsShip.wFlags = pHVar10->wFlags;
    pHVar15 = LphuldefFromId((lpshdefBuild->hul).ihuldef);
    uVar9 = (undefined2)((ulong)pHVar15 >> 0x10);
    pHVar10 = (((HULDEF *)pHVar15)->hul).rghs + iselSlot;
    grhst = pHVar10->grhst;
    uVar6 = pHVar10->wFlags;
    if ((uint)hsShip.wFlags >> 8 == 0) {
      if ((grhst & hstEngine) ==
          ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
            hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
        ids = idsCanHold;
      }
      else {
        ids = idsRequiresExactly;
      }
      sVar5 = CchGetString(ids,(char *)szWork);
      bVar12 = uVar6 >> 8 != 1;
      if (bVar12) {
        _WSPRINTF((LPSTR)CONCAT22(uVar6 >> 8,(char *)&DAT_1120_1120),(LPCSTR)0xc921120,
                  (char *)szWork + sVar5);
      }
      else {
        CchGetString(idsOne,(char *)szWork + sVar5);
      }
      while (grhst != 0) {
        for (i = 0; i < 0xe; i = i + 1) {
          if ((grhst & *(uint *)(i * 2)) == *(uint *)(i * 2)) {
            grhst = grhst & ~*(uint *)(i * 2);
            break;
          }
        }
        sVar5 = CchGetString(*(StringId *)(i * 2 + 0x1c),szWord);
        if (!bVar12) {
          if (szWord[sVar5 + -1] == 's') {
            if ((szWord[sVar5 + -2] == 'e') && (szWord[sVar5 + -3] == 'o')) {
              szWord[sVar5 + -2] = '\0';
            }
            else {
              szWord[sVar5 + -1] = '\0';
            }
          }
          else {
            for (pch = szWord + sVar5 + -1; (szWord < pch && (*pch != '(')); pch = pch + -1) {
            }
            if ((((*pch == '(') && (szWord + 1 < pch)) && (pch[-1] == ' ')) && (pch[-2] == 's')) {
              _strcpy(pch + -2,pch + -1);
            }
          }
        }
        if (grhst != 0) {
          if ((grhst - 1 & grhst) == 0) {
            pcVar2 = PszGetCompressedString(idsOr);
            _strcat(szWord,pcVar2);
          }
          else {
            _strcat(szWord,(char *)0xc96);
          }
        }
        _strcat((char *)szWork,szWord);
      }
      x = rc.left;
      WrapTextOut
                (hdc,&x,&rc.top,(char *)szWork,0,rc.left,rc.right - rc.left,(short *)0x0,0
                 ,1);
      rc.top = rc.top + dyArial8;
      goto BUILD_Restore;
    }
  }
  part.hs.grhst = hsShip.grhst;
  part.hs.wFlags = hsShip.wFlags;
  FLookupPart(&part);
  HVar20 = hdc;
  pcVar2 = PszGetCompressedString(idsKt);
  DVar16 = GetTextExtent(HVar20,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar2),2);
  iVar3 = (int)DVar16;
  bVar12 = (uint)hsShip.wFlags >> 8 != 1;
  if (bVar12) {
    _WSPRINTF((LPSTR)CONCAT22((uint)hsShip.wFlags >> 8,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(0xc99,unaff_SS),szWord);
  }
  else {
    CchGetString(idsOne,szWord);
  }
  __fstrcat((char *)CONCAT22(unaff_SS,szWord),
                    (char *)CONCAT22(part.pcom._2_2_,((COMPART *)part.pcom)->szName));
  if (bVar12) {
    _strcat(szWord,(char *)0xc9d);
  }
  pcVar2 = szWord;
  pcVar4 = PszGetCompressedString(idsCostS);
  sVar5 = _WSPRINTF((LPSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),
                    (LPCSTR)CONCAT22(pcVar4,(char *)&DAT_1120_1120),(char *)szWork);
  TextOut(hdc,rc.left,rc.top,szWork,sVar5);
  rc.left = rc.left + 8;
  rc.right = rc.right + -8;
  uVar6 = (uint)hsShip.wFlags >> 8;
  GetTruePartCost(idPlayer,&part,rgCosts);
  for (k = 0; k < 3; k = k + 1) {
    rc.top = rc.top + dyArial8;
    SelectObject(hdc,rghfontArial8[1]);
    SetTextColor(hdc,CONCAT22(*(undefined2 *)(k * 4 + 0x44a),*(undefined2 *)(k * 4 + 0x448)));
    pcVar2 = (char *)*(undefined2 *)(k * 2 + 0x4cc);
    puVar18 = (undefined1 *)&DAT_1120_1120;
    sVar5 = rc.top;
    sVar19 = rc.left;
    HVar20 = hdc;
    sVar7 = lstrlen((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,
                                     (char *)*(undefined2 *)(k * 2 + 0x4cc)));
    TextOut(HVar20,sVar19,sVar5,(LPCSTR)CONCAT22(puVar18,pcVar2),sVar7);
    SelectObject(hdc,rghfontArial8[0]);
    SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
    uVar17 = __aFulmul((long)(int)uVar6,(ulong)rgCosts[k]);
    sVar5 = _WSPRINTF((LPSTR)CONCAT22((int)uVar17,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(PCTLD,(char *)&DAT_1120_1120),(char *)szWork
                     );
    RightTextOut
              (hdc,(rc.right - iVar3) + -0x40,rc.top,(char *)szWork,sVar5,
               dxMaxMineralQuan);
    iVar8 = (rc.right - iVar3) + -0x40;
    sVar5 = rc.top;
    HVar20 = hdc;
    pcVar2 = PszGetCompressedString(idsKt);
    TextOut(HVar20,iVar8,sVar5,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar2),2);
  }
  rc.top = rc.top + dyArial8;
  SelectObject(hdc,rghfontArial8[1]);
  SetTextColor(hdc,CONCAT22(rgcrMinerals[5]._2_2_,(undefined2)rgcrMinerals[5]));
  puVar18 = (undefined1 *)&DAT_1120_1120;
  pcVar2 = DAT_1120_04d6;
  sVar5 = rc.top;
  sVar19 = rc.left;
  HVar20 = hdc;
  sVar7 = lstrlen((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,DAT_1120_04d6));
  TextOut(HVar20,sVar19,sVar5,(LPCSTR)CONCAT22(puVar18,pcVar2),sVar7);
  SelectObject(hdc,rghfontArial8[0]);
  SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
  uVar17 = __aFulmul((long)(int)uVar6,(ulong)rgCosts[3]);
  sVar5 = _WSPRINTF((LPSTR)CONCAT22((int)uVar17,(char *)&DAT_1120_1120),
                    (LPCSTR)CONCAT22(PCTLD,(char *)&DAT_1120_1120),(char *)szWork);
  RightTextOut
            (hdc,(rc.right - iVar3) + -0x40,rc.top,(char *)szWork,sVar5,
             dxMaxMineralQuan);
  if (fStarbaseMode == 0) {
    rc.left = rc.left + -8;
    rc.top = rc.top + dyArial8;
    SelectObject(hdc,rghfontArial8[1]);
    uVar17 = __aFulmul((long)(int)uVar6,(long)((COMPART *)part.pcom)->cMass);
    pcVar2 = PszGetCompressedString(idsMassLdkt);
    sVar5 = _WSPRINTF((LPSTR)CONCAT22((int)uVar17,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
    TextOut(hdc,rc.left,rc.top,szWork,sVar5);
  }
BUILD_Restore:
  SelectObject(hdc,rghfontArial8[0]);
  SetTextColor(hdc,CVar13);
  SetBkColor(hdc,crBackSav);
  if (bVar11) {
    ReleaseDC(hwnd,hdc);
  }
  return;
}



// ======================================================================
// Function: PctJammerFromHul
// Address: 10c8:42e6
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10c84495) */

short PctJammerFromHul(HUL *lphul)

{
  HS *pHVar1;
  undefined2 uVar2;
  bool bVar3;
  ulong num;
  undefined1 *a;
  long lVar4;
  PART part;
  long pctHit;
  short i;
  short ihs;
  long pctJam;
  
  a = &DAT_0000_2710;
  ihs = 0;
  while( true ) {
    pctHit._0_2_ = (undefined1 *)a;
    uVar2 = (undefined2)((ulong)lphul >> 0x10);
    if ((int)(uint)((HUL *)lphul)->chs <= ihs) break;
    pHVar1 = ((HUL *)lphul)->rghs + ihs;
    part.hs.grhst = pHVar1->grhst;
    part.hs.wFlags = pHVar1->wFlags;
    if (part.hs.grhst == hstSpecialE) {
      if (((part.hs.wFlags & 0xffU) < 8) || (0xb < (part.hs.wFlags & 0xffU))) {
        if ((part.hs.wFlags & 0xffU) == 4) {
          pctJam._0_2_ = 0x5a;
          pctJam._2_2_ = 0;
        }
        else {
          pctJam._0_2_ = 100;
          pctJam._2_2_ = 0;
        }
      }
      else {
        FLookupPart(&part);
        pctJam._0_2_ = 100 - ((COMPART *)part.pcom + 1)->id;
        pctJam._2_2_ = (int)(uint)pctJam >> 0xf;
      }
    }
    else if ((part.hs.grhst == hstArmor) && ((part.hs.wFlags & 0xffU) == 9)) {
      pctJam._0_2_ = 0x50;
      pctJam._2_2_ = 0;
    }
    else if ((part.hs.grhst == hstMining) && ((part.hs.wFlags & 0xffU) == 6)) {
      pctJam._0_2_ = 0x46;
      pctJam._2_2_ = 0;
    }
    else if ((part.hs.grhst == hstShield) && ((part.hs.wFlags & 0xffU) == 6)) {
      pctJam._0_2_ = 0x5f;
      pctJam._2_2_ = 0;
    }
    else {
      pctJam._0_2_ = 100;
      pctJam._2_2_ = 0;
    }
    if ((pctJam._2_2_ < 1) && ((pctJam._2_2_ < 0 || ((uint)pctJam < 100)))) {
      for (i = (uint)part.hs.wFlags >> 8; 0 < i; i = i + -1) {
        num = __aFulmul((ulong)a,CONCAT22(pctJam._2_2_,(uint)pctJam));
        a = (undefined1 *)__aFldiv(num,100);
      }
    }
    ihs = ihs + 1;
  }
  if ((long)a < 100) {
    pctHit._0_2_ = (undefined1 *)0x64;
  }
  pctJam._0_2_ = 100 - (int)((undefined1 *)pctHit + 0x32) / 100;
  pctJam._2_2_ = (int)(uint)pctJam >> 0xf;
  if (0x20 < (int)lphul->ihuldef) {
    lVar4 = __aFldiv((long)(int)(uint)pctJam,4);
    bVar3 = (uint)pctJam < (uint)lVar4;
    pctJam._0_2_ = (uint)pctJam - (uint)lVar4;
    pctJam._2_2_ = (pctJam._2_2_ - (int)((ulong)lVar4 >> 0x10)) - (uint)bVar3;
  }
  if ((-1 < pctJam._2_2_) && ((0 < pctJam._2_2_ || (0x5f < (uint)pctJam)))) {
    pctJam._0_2_ = 0x5f;
  }
  return (uint)pctJam;
}



// ======================================================================
// Function: DrawBuildSelHull
// Address: 10c8:451e
// Segment: MEMORY_BUILD
// ======================================================================


void DrawBuildSelHull(HWND hwnd,HDC hdc,short iDraw,RECT *prc)

{
  char *pcVar1;
  ushort uVar2;
  short sVar3;
  int iVar4;
  short sVar5;
  SHDEF *pSVar6;
  undefined2 unaff_SS;
  bool bVar7;
  DWORD DVar8;
  DWORD DVar9;
  PLANET *pPVar10;
  ulong uVar11;
  long lVar12;
  char *pcVar13;
  uint uVar14;
  undefined1 *puVar15;
  short sVar16;
  undefined2 uVar17;
  HDC HVar18;
  undefined2 uVar19;
  short pctDetect;
  short dRange;
  short i_2;
  short dPlanRange;
  short pct;
  uint uStack_4c;
  RECT rc;
  short dxkT;
  long dp;
  short cch;
  long dpShield;
  HUL *lphul;
  short csh;
  COLORREF crBackSav;
  short k;
  short dxMineral;
  COLORREF crForeSav;
  short fCreatedDC;
  ushort rgCosts [4];
  DV dv;
  char rgch [20];
  
  fCreatedDC = 0;
  if (mdBuild == 3) {
    return;
  }
  if (hdc == 0) {
    fCreatedDC = 1;
    hdc = GetDC(hwnd);
  }
  if (prc == (RECT *)0x0) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    rc.bottom = rc.bottom + -0x20;
    rc.left = rc.right + -0x144;
    iVar4 = dyArial8;
    if (fStarbaseMode == 0) {
      iVar4 = 0;
    }
    rc.top = iVar4 + yBuildInfoSum;
    rc.right = rc.right + -4;
    FillRect(hdc,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
  }
  else {
    rc.left = prc->left;
    rc.top = prc->top;
    rc.right = prc->right;
    rc.bottom = prc->bottom;
  }
  if (((SHDEF *)lpshdefBuild == (SHDEF *)0x0) && (lpshdefBuild._2_2_ == 0))
  goto BUILD_LReleaseDC;
  lphul = &lpshdefBuild->hul;
  SelectObject(hdc,rghfontArial8[0]);
  HVar18 = hdc;
  pcVar1 = PszGetCompressedString(idsKt);
  DVar8 = GetTextExtent(HVar18,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar1),2);
  SelectObject(hdc,rghfontArial8[1]);
  puVar15 = (undefined1 *)&DAT_1120_1120;
  pcVar1 = DAT_1120_04d0;
  HVar18 = hdc;
  uVar2 = _strlen(DAT_1120_04d0);
  DVar9 = GetTextExtent(HVar18,(LPCSTR)CONCAT22(puVar15,pcVar1),uVar2);
  dxMineral = (int)DVar9 + 6;
  crForeSav = SetTextColor(hdc,0);
  crBackSav = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,
                                      (undefined2)crButtonFace));
  if ((hwndPopup == 0) ||
     ((GlobalPD.grPopup != 0xb || (GlobalPD.iPlanMax == 0)))) {
    dp._0_2_ = ((HUL *)lphul)->dp;
    dp._2_2_ = 0;
    dpShield = DpShieldOfShdef(lpshdefBuild,idPlayer);
LAB_10c8_4737:
    if ((hwndPopup == 0) || (fStarbaseMode == 0)) {
      CchGetString(idsHull,rgch);
      pcVar13 = ((HUL *)lphul)->szClass;
      pcVar1 = PszGetCompressedString(idsCostOneSS);
      cch = _WSPRINTF((LPSTR)CONCAT22(pcVar13,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
    }
    else {
      rc.top = rc.top + dyArial8;
      cch = CchGetString(idsCost,(char *)szWork);
    }
    TextOut(hdc,rc.left,rc.top,szWork,cch);
    rc.left = rc.left + 8;
    rc.right = rc.right + -8;
    GetTrueHullCost(idPlayer,lphul,rgCosts);
    if (fStarbaseMode != 0) {
      sVar5 = GetRaceGrbit((PLAYER *)rgplr + idPlayer,ibitRaceISB);
      if (sVar5 == 0) {
        sVar5 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
        if (sVar5 != raMacintosh) goto LAB_10c8_4875;
      }
      for (k = 0; k < 4; k = k + 1) {
        rgCosts[k] = rgCosts[k] - rgCosts[k] / 5;
      }
    }
LAB_10c8_4875:
    if (fStarbaseMode != 0) {
      for (k = 0; k < 4; k = k + 1) {
        rgCosts[k] = rgCosts[k] - rgCosts[k] / 2;
      }
    }
    for (k = 0; k < 6; k = k + 1) {
      if (k == 3) {
        k = 5;
      }
      rc.top = rc.top + dyArial8;
      SelectObject(hdc,rghfontArial8[1]);
      SetTextColor(hdc,CONCAT22(*(undefined2 *)(k * 4 + 0x44a),*(undefined2 *)(k * 4 + 0x448)));
      pcVar1 = (char *)*(undefined2 *)(k * 2 + 0x4cc);
      puVar15 = (undefined1 *)&DAT_1120_1120;
      sVar5 = rc.top;
      sVar16 = rc.left;
      HVar18 = hdc;
      sVar3 = lstrlen((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,
                                       (char *)*(undefined2 *)(k * 2 + 0x4cc)));
      TextOut(HVar18,sVar16,sVar5,(LPCSTR)CONCAT22(puVar15,pcVar1),sVar3);
      SelectObject(hdc,rghfontArial8[0]);
      SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
      uVar2 = rgCosts[3];
      if (k != 5) {
        uVar2 = rgCosts[k];
      }
      cch = _WSPRINTF((LPSTR)CONCAT22(uVar2,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork)
      ;
      RightTextOut
                (hdc,(rc.left + dxMineral + dxMaxMineralQuan) - (int)DVar8,rc.top,
                 (char *)szWork,cch,dxMaxMineralQuan);
      if (k < 5) {
        iVar4 = (rc.left + dxMineral + dxMaxMineralQuan) - (int)DVar8;
        sVar5 = rc.top;
        HVar18 = hdc;
        pcVar1 = PszGetCompressedString(idsKt);
        TextOut(HVar18,iVar4,sVar5,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar1),2);
      }
    }
    rc.left = rc.left + -8;
    rc.top = rc.top + dyArial8;
    SelectObject(hdc,rghfontArial8[1]);
    if (fStarbaseMode == 0) {
      if (((hwndPopup == 0) || (GlobalPD.grPopup != 0xb)) ||
         (GlobalPD.iPlanMax == 0)) {
        pct = ((HUL *)lphul)->wtEmpty;
      }
      else {
        pct = ((TOK *)vrgtok)[viVCRFocus].wt;
      }
      uStack_4c = 0;
      sVar5 = pct;
      pcVar1 = PszGetCompressedString(idsMassLdkt);
      cch = _WSPRINTF((LPSTR)CONCAT22(sVar5,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
      TextOut(hdc,rc.left,rc.top,szWork,cch);
    }
    rc.top = rc.top + dyArial8 * -4;
    rc.left = rc.left + dxMineral + dxMaxMineralQuan + 0x18;
    if ((fStarbaseMode == 0) &&
       (((hwndPopup == 0 || (GlobalPD.grPopup != 0xb)) ||
        (GlobalPD.iPlanMax == 0)))) {
      sVar5 = WtMaxShdefStat(lpshdefBuild,1);
      pcVar1 = PszGetCompressedString(idsDmg);
      cch = _WSPRINTF((LPSTR)CONCAT22(sVar5,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
      RightTextOut
                (hdc,rc.right + -8,rc.top,(char *)szWork,cch,dxMaxMineralQuan);
      cch = CchGetString(idsMaxFuel,(char *)szWork);
      TextOut(hdc,rc.left,rc.top,szWork,cch);
      rc.top = rc.top + dyArial8;
    }
    iVar4 = (int)dp;
    pcVar1 = PszGetCompressedString(idsLddp);
    cch = _WSPRINTF((LPSTR)CONCAT22(iVar4,(char *)&DAT_1120_1120),
                    (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
    RightTextOut
              (hdc,rc.right + -8,rc.top,(char *)szWork,cch,dxMaxMineralQuan + 10
              );
    cch = CchGetString(idsArmor,(char *)szWork);
    TextOut(hdc,rc.left,rc.top,szWork,cch);
    rc.top = rc.top + dyArial8;
    if (mdBuild != 1) {
      if (dpShield == 0) {
        lVar12 = dpShield;
        pcVar1 = PszGetCompressedString(idsNone);
        uVar17 = (undefined2)lVar12;
      }
      else {
        pcVar1 = (char *)0xcbf;
        uVar17 = (uint)dpShield;
      }
      cch = _WSPRINTF((LPSTR)CONCAT22(uVar17,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
      RightTextOut
                (hdc,rc.right + -8,rc.top,(char *)szWork,cch,
                 dxMaxMineralQuan + 10);
      cch = CchGetString(idsShields,(char *)szWork);
      TextOut(hdc,rc.left,rc.top,szWork,cch);
    }
    rc.top = rc.top + dyArial8;
    if (mdBuild != 1) {
      lVar12 = LComputePower(lpshdefBuild);
      uVar17 = (undefined2)((ulong)lpshdefBuild >> 0x10);
      pSVar6 = (SHDEF *)lpshdefBuild;
      *(int *)&pSVar6->lPower = (int)lVar12;
      *(undefined2 *)((int)&pSVar6->lPower + 2) = (int)((ulong)lVar12 >> 0x10);
      uVar17 = (undefined2)((ulong)lpshdefBuild >> 0x10);
      pSVar6 = (SHDEF *)lpshdefBuild;
      if (((int)pSVar6->lPower != 0) || (*(int *)((int)&pSVar6->lPower + 2) != 0)) {
        cch = _WSPRINTF((LPSTR)CONCAT22((int)pSVar6->lPower,(char *)&DAT_1120_1120),
                        (LPCSTR)CONCAT22(PCTLD,(char *)&DAT_1120_1120),
                        (char *)szWork);
        RightTextOut
                  (hdc,rc.right + -8,rc.top,(char *)szWork,cch,dxMaxMineralQuan)
        ;
        cch = CchGetString(idsRating,(char *)szWork);
        TextOut(hdc,rc.left,rc.top,szWork,cch);
        rc.top = rc.top + dyArial8;
      }
    }
    if (((uint)gd._0_2_ >> 0xe != 0) && (mdBuild != 1)) {
      if (mdBuild == 2) {
        uStack_4c = -1;
      }
      else {
        uStack_4c = idPlayer;
      }
      uStack_4c = PctCloakFromHuldef(&lpshdefBuild->hul,uStack_4c,(short *)0x0);
      pct = PctJammerFromHul(&lpshdefBuild->hul);
      uVar14 = uStack_4c;
      pcVar1 = PszGetCompressedString(idsDD4);
      cch = _WSPRINTF((LPSTR)CONCAT22(uVar14,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
      RightTextOut
                (hdc,rc.right + -8,rc.top,(char *)szWork,cch,dxMaxMineralQuan);
      cch = CchGetString(idsCloakJam,(char *)szWork);
      TextOut(hdc,rc.left,rc.top,szWork,cch);
      rc.top = rc.top + dyArial8;
      uStack_4c = InitFromHuldef(&lpshdefBuild->hul,(short *)0x0);
      if ((fStarbaseMode == 0) &&
         ((uint)(((SHDEF *)lpshdefBuild)->hul).rghs[0].wFlags >> 8 != 0)) {
        sVar5 = SpdOfShip((FLEET *)0x0,0,(TOK *)0x0,0,lpshdefBuild);
        pct = sVar5 + 1;
      }
      else {
        pct = 0;
      }
      uVar14 = uStack_4c;
      pcVar1 = PszGetCompressedString(idsDS);
      cch = _WSPRINTF((LPSTR)CONCAT22(uVar14,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
      RightTextOut
                (hdc,rc.right + -8,rc.top,(char *)szWork,cch,dxMaxMineralQuan);
      cch = CchGetString
                      ((0xe < dyArial8) + idsInitiativeMoves,(char *)szWork);
      TextOut(hdc,rc.left,rc.top,szWork,cch);
      rc.top = rc.top + dyArial8;
      if (fStarbaseMode == 0) {
        if (mdBuild == 2) {
          i_2 = -1;
        }
        else {
          i_2 = idPlayer;
        }
        sVar5 = GetShdefScannerRange
                          (lpshdefBuild,i_2,&dPlanRange,&pctDetect,(short *)0x0);
        dRange = sVar5;
        if (0 < sVar5) {
          if (pctDetect < 100) {
            pcVar1 = PszGetCompressedString(idsDDD);
            cch = _WSPRINTF((LPSTR)CONCAT22(sVar5,(char *)&DAT_1120_1120),
                            (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork
                           );
          }
          else {
            pcVar1 = PszGetCompressedString(idsDD6);
            cch = _WSPRINTF((LPSTR)CONCAT22(sVar5,(char *)&DAT_1120_1120),
                            (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork
                           );
          }
          RightTextOut
                    (hdc,rc.right + -8,rc.top,(char *)szWork,cch,
                     dxMaxMineralQuan + 0x28);
          cch = CchGetString
                          ((0xe < dyArial8) + idsScannerRange2,(char *)szWork);
          TextOut(hdc,rc.left,rc.top,szWork,cch);
          rc.top = rc.top + dyArial8;
        }
      }
      else {
        sVar5 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
        if (sVar5 == raMacintosh) {
          iVar4 = ((lpshdefBuild->hul).ihuldef - ihuldefCount) * 4;
          uVar11 = __aFulmul(CONCAT22(*(undefined2 *)(iVar4 + 0x8ce),
                                              *(undefined2 *)(iVar4 + 0x8cc)),100);
          cch = CommaFormatLong((char *)szWork,uVar11);
          RightTextOut
                    (hdc,rc.right + -8,rc.top,(char *)szWork,cch,
                     dxMaxMineralQuan + 0x10);
          cch = CchGetString
                          ((0xe < dyArial8) + idsMaxPopulation,(char *)szWork);
          TextOut(hdc,rc.left,rc.top,szWork,cch);
          rc.top = rc.top + dyArial8;
        }
      }
    }
    if (((hwndPopup != 0) && (GlobalPD.grPopup == 0xb)) &&
       (GlobalPD.iPlanVal != 0)) {
      if (GlobalPD.iPlanMax == 0) {
        if (fStarbaseMode == 0) {
          uVar17 = (undefined2)((ulong)lpshdefBuild >> 0x10);
          if (GlobalPD.iPlrVal == 0) {
            k = (uint)((SHDEF *)lpshdefBuild)->wFlags >> 10 & 0x1f;
            csh = *(short *)((int)&sel.fl + 0xc + k * 2);
            dv.dp = *(short *)((int)&sel.fl + 0x2c + k * 2);
          }
          else {
            k = (uint)((SHDEF *)lpshdefBuild)->wFlags >> 10 & 0x1f;
            csh = *(short *)(*(int *)((FLEET **)rglpfl + sel.scan.ifl) + 0xc +
                            k * 2);
            dv.dp = *(short *)(*(int *)((FLEET **)rglpfl + sel.scan.ifl) + 0x2c +
                              k * 2);
          }
        }
        else {
          dv.dp = 0;
          if (GlobalPD.iPlrVal == 0) {
            uStack_4c = (uint)sel.pl._44_2_ >> 4;
            dv.dp = uStack_4c << 7;
          }
          else {
            pPVar10 = LpplFromId(sel.scan.idpl);
            uStack_4c = *(uint *)&((PLANET *)pPVar10)->field11_0x2c >> 4;
            dv.dp = dv.dp & 0x7fU | uStack_4c << 7;
          }
          csh = 1;
          if ((uint)dv.dp >> 7 != 0) {
            dv.dp = dv.dp & 0xff80U | 100;
          }
        }
      }
      if (dv.dp == 0) {
        dp._0_2_ = 0;
      }
      else {
        SetTextColor(hdc,0x7f);
        uStack_4c = (uint)dv.dp / 0x280;
        if (uStack_4c == 0) {
          uStack_4c = 1;
        }
        uVar19 = 0;
        uVar17 = 100;
        uVar11 = __aFulmul((long)csh,(ulong)(dv.dp & 0x7f));
        lVar12 = __aFldiv(uVar11,CONCAT22(uVar19,uVar17));
        csh = (short)lVar12;
        if (csh < 1) {
          csh = 1;
        }
        if (fStarbaseMode == 0) {
          sVar5 = csh;
          pcVar1 = PszGetCompressedString(idsLdD);
          cch = _WSPRINTF((LPSTR)CONCAT22(sVar5,(char *)&DAT_1120_1120),
                          (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
        }
        else {
          cch = _WSPRINTF((LPSTR)CONCAT22(uStack_4c,(char *)&DAT_1120_1120),
                          (LPCSTR)CONCAT22(PCTDPCTPCT,(char *)&DAT_1120_1120),
                          (char *)szWork);
        }
        dp._0_2_ = 1;
      }
      dp._2_2_ = 0;
      if ((int)dp != 0) {
        RightTextOut
                  (hdc,rc.right + -8,rc.top,(char *)szWork,cch,
                   dxMaxMineralQuan + 0xf);
        cch = CchGetString(idsDamage,(char *)szWork);
        TextOut(hdc,rc.left,rc.top,szWork,cch);
      }
    }
  }
  else {
    GetVCRStats(viVCRFocus,&dp,&dv,&dpShield,&csh);
    bVar7 = (uint)((TOK *)vrgtok)[viVCRFocus].dpShield < (uint)dpShield;
    dpShield._0_2_ = ((TOK *)vrgtok)[viVCRFocus].dpShield - (uint)dpShield;
    dpShield._2_2_ = -(uint)bVar7 - dpShield._2_2_;
    if ((dpShield._2_2_ < 1) && (dpShield._2_2_ < 0)) {
      dpShield._0_2_ = 0;
      dpShield._2_2_ = 0;
    }
    dpShield = __aFulmul(CONCAT22(dpShield._2_2_,(uint)dpShield),(long)csh);
    if (csh != 0) goto LAB_10c8_4737;
  }
  SelectObject(hdc,rghfontArial8[0]);
  SetTextColor(hdc,crForeSav);
  SetBkColor(hdc,crBackSav);
BUILD_LReleaseDC:
  if (fCreatedDC != 0) {
    ReleaseDC(hwnd,hdc);
  }
  return;
}



// ======================================================================
// Function: SetBuildSelection
// Address: 10c8:53da
// Segment: MEMORY_BUILD
// ======================================================================


void SetBuildSelection(short iSrc)

{
  short iDraw;
  undefined2 unaff_SS;
  RECT rc;
  short iSelOld;
  
  iDraw = iselSlot;
  if (iSrc == iselSlot) {
    if (iSrc != -1) {
      return;
    }
  }
  else {
    iselSlot = iSrc;
    GetClientRect(hwndSlotDlg,(undefined2 *)CONCAT22(unaff_SS,&rc));
    if (-1 < iDraw) {
      DrawSlotDlg(hwndSlotDlg,0,&rc,iDraw);
    }
    if (-1 < iselSlot) {
      DrawSlotDlg(hwndSlotDlg,0,&rc,iselSlot);
    }
  }
  DrawBuildSelComp(hwndSlotDlg,0,-1);
  return;
}



// ======================================================================
// Function: IDropPart
// Address: 10c8:5476
// Segment: MEMORY_BUILD
// ======================================================================


short IDropPart(POINT pt,HS hsSrc,short iSrc,short fNoModify)

{
  uint *puVar1;
  HullSlotType HVar2;
  HullSlotType HVar3;
  uint uVar4;
  BOOL BVar5;
  int iVar6;
  short sVar7;
  uint uVar8;
  undefined2 uVar9;
  HS *pHVar10;
  undefined2 unaff_SS;
  HULDEF *pHVar11;
  RECT rc;
  HS hsDst;
  HS hsHul;
  short i;
  short cNew;
  short cSlot;
  
  GetClientRect(hwndSlotDlg,(undefined2 *)CONCAT22(unaff_SS,&rc));
  uVar4 = GetAsyncKeyState(0x11);
  if ((uVar4 & 0xfffe) == 0) {
    uVar4 = GetAsyncKeyState(0x10);
    if ((uVar4 & 0xfffe) == 0) {
      if (-1 < iSrc) {
        hsSrc = (HS)((ulong)hsSrc & 0xffffff | 0x1000000);
      }
    }
    else if ((iSrc < 0) || (4 < (uint)hsSrc.wFlags >> 8)) {
      hsSrc = (HS)((ulong)hsSrc & 0xffffff | 0x4000000);
    }
  }
  else if (iSrc < 0) {
    hsSrc = (HS)((ulong)hsSrc & 0xffffff | 0x64000000);
  }
  pHVar11 = LphuldefFromId((lpshdefBuild->hul).ihuldef);
  uVar4 = (uint)(((HULDEF *)pHVar11)->hul).chs;
  for (i = 0; i < (int)uVar4; i = i + 1) {
    BVar5 = PtInRect((undefined2 *)CONCAT22((RECT *)vrgrcSlot + i,pt.y),pt.x);
    if (BVar5 != 0) break;
  }
  if (i == uVar4) {
    if (pt.x < rc.right >> 1) {
      if ((fNoModify == 0) && (-1 < iSrc)) {
        if ((((((SHDEF *)lpshdefBuild)->hul).rghs + iSrc)->grhst & hstEngine) !=
            ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
              hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
          hsSrc.grhst = ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|
                          hstSpecialSB|hstMines|hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield
                          |hstScanner|hstEngine);
          hsSrc.wFlags = 0x6400;
        }
        if (((uint)(((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags >> 8) -
            ((uint)hsSrc.wFlags >> 8) < 0x8000) {
          iVar6 = ((uint)(((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags >> 8) -
                  ((uint)hsSrc.wFlags >> 8);
        }
        else {
          iVar6 = 0;
        }
        (((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags =
             (((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags & 0xffU | iVar6 << 8;
        UpdateShdefCost(lpshdefBuild);
        GetClientRect(hwndSlotDlg,(undefined2 *)CONCAT22(unaff_SS,&rc));
        DrawSlotDlg(hwndSlotDlg,0,&rc,iSrc);
        rc.top = yBuildInfoSum;
        InvalidateRect(hwndSlotDlg,(undefined2 *)CONCAT22(unaff_SS,&rc),1);
        DrawBuildSelComp(hwndSlotDlg,0,-1);
        DrawBuildSelHull(hwndSlotDlg,0,-1,(RECT *)0x0);
        if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
          AdvanceTutor();
        }
      }
      sVar7 = 1;
    }
    else {
      sVar7 = 0;
    }
  }
  else {
    pHVar10 = (((SHDEF *)lpshdefBuild)->hul).rghs + i;
    HVar2 = pHVar10->grhst;
    uVar4 = pHVar10->wFlags;
    pHVar11 = LphuldefFromId((lpshdefBuild->hul).ihuldef);
    uVar9 = (undefined2)((ulong)pHVar11 >> 0x10);
    pHVar10 = (((HULDEF *)pHVar11)->hul).rghs + i;
    HVar3 = pHVar10->grhst;
    uVar8 = pHVar10->wFlags;
    if ((HVar3 & hstEngine) !=
        ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
          hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
      hsSrc = (HS)((ulong)hsSrc & 0xffffff | 0x64000000);
    }
    if (i == iSrc) {
      sVar7 = 2;
    }
    else {
      if (uVar4 >> 8 < uVar8 >> 8) {
        if (((uVar4 >> 8 == 0) ||
            ((HVar2 == hsSrc.grhst && ((uVar4 & 0xff) == (hsSrc.wFlags & 0xffU))))) &&
           ((uVar4 >> 8 != 0 ||
            ((hsSrc.grhst & HVar3) !=
             ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines
               |hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine))))) {
          if (fNoModify == 0) {
            if ((uVar4 >> 8) + ((uint)hsSrc.wFlags >> 8) < uVar8 >> 8) {
              uVar8 = (uVar4 >> 8) + ((uint)hsSrc.wFlags >> 8);
            }
            else {
              uVar8 = uVar8 >> 8;
            }
            if (-1 < iSrc) {
              iVar6 = (((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags;
              puVar1 = (uint *)&(((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags;
              *puVar1 = *puVar1 & 0xff;
              puVar1 = (uint *)&(((SHDEF *)lpshdefBuild)->hul).rghs[iSrc].wFlags;
              *puVar1 = *puVar1 | iVar6 + (uVar8 - (uVar4 >> 8)) * -0x100 & 0xff00;
            }
            uVar9 = lpshdefBuild._2_2_;
            pHVar10 = (((SHDEF *)lpshdefBuild)->hul).rghs + i;
            pHVar10->grhst = hsSrc.grhst;
            pHVar10->wFlags = hsSrc.wFlags & 0xffU | uVar8 << 8;
            UpdateShdefCost(lpshdefBuild);
            SetBuildSelection(i);
            GetClientRect(hwndSlotDlg,(undefined2 *)CONCAT22(unaff_SS,&rc));
            rc.top = yBuildInfoSum;
            InvalidateRect(hwndSlotDlg,(undefined2 *)CONCAT22(unaff_SS,&rc),1);
            if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
              AdvanceTutor();
            }
          }
          return -1;
        }
      }
      if (fNoModify == 0) {
        MessageBeep(0);
      }
      sVar7 = 3;
    }
  }
  return sVar7;
}



// ======================================================================
// Function: DrawDlgLBEntireItem
// Address: 10c8:59f0
// Segment: MEMORY_BUILD
// ======================================================================


void DrawDlgLBEntireItem(DRAWITEMSTRUCT *lpdis,short inflate)

{
  short sVar1;
  HGDIOBJ HVar2;
  uint uVar3;
  int iVar4;
  ushort uVar5;
  int iVar6;
  undefined2 unaff_SS;
  COLORREF CVar7;
  char *pcVar8;
  undefined1 *puVar9;
  RECT *pRVar10;
  undefined2 uVar11;
  HDC HVar12;
  RECT rc;
  short bkSav;
  short ibmp;
  COLORREF crForeSav;
  COLORREF cr;
  
  CopyRect((undefined2 *)CONCAT22(unaff_SS,&rc),
           (undefined2 *)CONCAT22(lpdis._2_2_,&((DRAWITEMSTRUCT *)lpdis)->rcItem));
  HVar12 = ((DRAWITEMSTRUCT *)lpdis)->hDC;
  pRVar10 = &((DRAWITEMSTRUCT *)lpdis)->rcItem;
  if ((((DRAWITEMSTRUCT *)lpdis)->itemState & 0x10U) == 0) {
    sVar1 = 0;
  }
  else {
    sVar1 = 4;
  }
  uVar11 = lpdis._2_2_;
  HVar2 = GetStockObject(sVar1);
  FillRect(HVar12,(undefined2 *)CONCAT22(uVar11,pRVar10),HVar2);
  InflateRect((undefined2 *)CONCAT22(unaff_SS,&rc),-2,-1);
  SendMessage(((DRAWITEMSTRUCT *)lpdis)->hwndItem,0x40a,((DRAWITEMSTRUCT *)lpdis)->itemID,0x112057a4
             );
  SelectPalette(((DRAWITEMSTRUCT *)lpdis)->hDC,vhpal,0);
  RealizePalette(((DRAWITEMSTRUCT *)lpdis)->hDC);
  uVar3 = szWork[2] + -0x41 + (szWork[3] + -0x41) * 0x1a;
  DibBlt(((DRAWITEMSTRUCT *)lpdis)->hDC,rc.left,rc.top,0x40,0x40,
                  ((ushort *)rghdibInventory)[(int)uVar3 >> 5],(uVar3 & 7) << 6,
                  (3U - ((int)uVar3 >> 3) & 3) << 6,0x40,0x40,0xcc0020);
  iVar4 = (int)crWindow;
  iVar6 = crWindow._2_2_;
  if ((((DRAWITEMSTRUCT *)lpdis)->itemState & 0x10U) == 0) {
    if (((int)crWindow == 0) && (crWindow._2_2_ == 0)) {
      iVar4 = -1;
      iVar6 = 0xff;
    }
    else {
      iVar4 = 0;
      iVar6 = 0;
    }
  }
  CVar7 = SetTextColor(((DRAWITEMSTRUCT *)lpdis)->hDC,CONCAT22(iVar6,iVar4));
  sVar1 = SetBkMode(((DRAWITEMSTRUCT *)lpdis)->hDC,1);
  HVar12 = ((DRAWITEMSTRUCT *)lpdis)->hDC;
  iVar4 = rc.left + 0x42;
  iVar6 = (rc.top + 0x20) - (dyArial8 >> 1);
  puVar9 = (undefined1 *)&DAT_1120_1120;
  pcVar8 = (char *)szWork + 4;
  uVar5 = _strlen((char *)szWork + 4);
  TextOut(HVar12,iVar4,iVar6,(LPCSTR)CONCAT22(puVar9,pcVar8),uVar5);
  SetTextColor(((DRAWITEMSTRUCT *)lpdis)->hDC,CVar7);
  SetBkMode(((DRAWITEMSTRUCT *)lpdis)->hDC,sVar1);
  HandleFocusState(lpdis,inflate + 2);
  return;
}



// ======================================================================
// Function: NthValidShdef
// Address: 10c8:5c06
// Segment: MEMORY_BUILD
// ======================================================================


SHDEF * NthValidShdef(short n)

{
  SHDEF *pSVar1;
  undefined1 *puVar2;
  bool bVar3;
  short i;
  
  if (fStarbaseMode == 0) {
    for (i = 0; i < 0x10; i = i + 1) {
      if (((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0) &&
         (bVar3 = n == 0, n = n + -1, bVar3)) {
        pSVar1 = (SHDEF *)(i * 0x93 + 0x3f00);
        puVar2 = (undefined1 *)&DAT_1120_1120;
        goto LAB_10c8_5cee;
      }
    }
  }
  else {
    for (i = 0; i < 10; i = i + 1) {
      if (((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) &&
         (bVar3 = n == 0, n = n + -1, bVar3)) {
        puVar2 = (undefined1 *)*(undefined2 *)(idPlayer * 4 + 0x14e);
        pSVar1 = (SHDEF *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93);
        goto LAB_10c8_5cee;
      }
    }
  }
  pSVar1 = (SHDEF *)0x0;
  puVar2 = (undefined1 *)0x0;
LAB_10c8_5cee:
  return (SHDEF *)CONCAT22(puVar2,pSVar1);
}



// ======================================================================
// Function: NthValidEnemyShdef
// Address: 10c8:5cf4
// Segment: MEMORY_BUILD
// ======================================================================


SHDEF * NthValidEnemyShdef(short n)

{
  SHDEF *pSVar1;
  undefined2 uVar2;
  bool bVar3;
  short j;
  short i;
  
  if (fStarbaseMode == 0) {
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (((*(int *)(i * 4 + 0xfe) != 0) || (*(int *)(i * 4 + 0x100) != 0)) &&
         (i != idPlayer)) {
        for (j = 0; j < 0x10; j = j + 1) {
          if (((*(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) >> 9 & 1) == 0) &&
             (bVar3 = n == 0, n = n + -1, bVar3)) {
            uVar2 = *(undefined2 *)(i * 4 + 0x100);
            pSVar1 = (SHDEF *)(*(int *)(i * 4 + 0xfe) + j * 0x93);
            goto LAB_10c8_5e79;
          }
        }
      }
    }
  }
  else {
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (((*(int *)(i * 4 + 0x14c) != 0) || (*(int *)(i * 4 + 0x14e) != 0)) &&
         (i != idPlayer)) {
        for (j = 0; j < 10; j = j + 1) {
          if (((*(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) >> 9 & 1) == 0) &&
             (bVar3 = n == 0, n = n + -1, bVar3)) {
            uVar2 = *(undefined2 *)(i * 4 + 0x14e);
            pSVar1 = (SHDEF *)(*(int *)(i * 4 + 0x14c) + j * 0x93);
            goto LAB_10c8_5e79;
          }
        }
      }
    }
  }
  pSVar1 = (SHDEF *)0x0;
  uVar2 = 0;
LAB_10c8_5e79:
  return (SHDEF *)CONCAT22(uVar2,pSVar1);
}



// ======================================================================
// Function: FillBuildDD
// Address: 10c8:5e80
// Segment: MEMORY_BUILD
// ======================================================================


void FillBuildDD(HWND hwndDD,short md)

{
  BOOL BVar1;
  HWND HVar2;
  int iVar3;
  ushort uVar4;
  short sVar5;
  char *pcVar6;
  int iVar7;
  undefined2 unaff_SS;
  LRESULT LVar8;
  undefined2 uVar9;
  LPSTR pcVar10;
  undefined4 uVar11;
  PART part;
  RECT rc;
  SHDEF *lpshdef;
  short j;
  short i;
  short fAdded;
  short fProgress;
  short ishdefMac;
  
  SendMessage(hwndDD,0x40b,0,0);
  if (md != 0) {
    HVar2 = GetDlgItem(hwndSlotDlg,0x817);
    EnableWindow(HVar2,0);
    HVar2 = GetDlgItem(hwndSlotDlg,0x818);
    EnableWindow(HVar2,0);
  }
  if (fStarbaseMode == 0) {
    ishdefMac = 0x10;
    lpshdef._0_2_ = (SHDEF *)rgshdef;
    lpshdef._2_2_ = (undefined1 *)&DAT_1120_1120;
  }
  else {
    ishdefMac = 10;
    lpshdef._0_2_ = (SHDEF *)*(undefined2 *)(idPlayer * 4 + 0x14c);
    lpshdef._2_2_ = (undefined1 *)*(undefined2 *)(idPlayer * 4 + 0x14e);
  }
  i = 0;
  while ((i < ishdefMac && (((uint)((SHDEF *)lpshdef)[i].wFlags >> 9 & 1) == 0))) {
    i = i + 1;
  }
  if ((((md == 0) || (md == 1)) || (md == 2)) && (i < ishdefMac)) {
    BVar1 = 1;
  }
  else {
    BVar1 = 0;
  }
  HVar2 = GetDlgItem(hwndSlotDlg,0x816);
  EnableWindow(HVar2,BVar1);
  if (md != 0) {
    if (md == 1) {
      if (fStarbaseMode == 0) {
        part.hs.grhst = hstHull;
        j = 0x20;
      }
      else {
        part.hs.grhst = hstSBHull;
        j = 5;
      }
      for (i = 0; i < j; i = i + 1) {
        part.hs.wFlags = part.hs.wFlags & 0xff00U | i & 0xffU;
        sVar5 = FLookupPart(&part);
        if (sVar5 == 1) {
          SendMessage(hwndDD,0x403,0,
                      (LPARAM)CONCAT22(part.pcom._2_2_,((COMPART *)part.pcom)->szName));
        }
      }
      goto LAB_10c8_632a;
    }
    if (md == 2) {
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if (i != idPlayer) {
          if (fStarbaseMode == 0) {
            iVar3 = *(int *)(i * 4 + 0xfe);
            iVar7 = *(int *)(i * 4 + 0x100);
          }
          else {
            iVar3 = *(int *)(i * 4 + 0x14c);
            iVar7 = *(int *)(i * 4 + 0x14e);
          }
          if ((iVar3 != 0) || (iVar7 != 0)) {
            for (j = 0; j < ishdefMac; j = j + 1) {
              if ((*(uint *)(iVar3 + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
                PszPlayerName(i,1,0,0,0,(PLAYER *)0x0);
                pcVar10 = (LPSTR)CONCAT22(iVar3 + j * 0x93 + 8,(char *)&DAT_1120_1120);
                uVar9 = 0xcc5;
                uVar4 = _strlen((char *)szWork);
                _WSPRINTF(pcVar10,(LPCSTR)CONCAT22(uVar9,(char *)&DAT_1120_1120),
                          (char *)szWork + uVar4);
                SendMessage(hwndDD,0x403,0,0x112057a4);
              }
            }
          }
        }
      }
      goto LAB_10c8_632a;
    }
    if ((md == 3) || (md == 4)) {
      if (fStarbaseMode == 0) {
        for (i = 0; i < 0xd; i = i + 1) {
          uVar11 = 0x4030000;
          HVar2 = hwndDD;
          pcVar6 = PszGetCompressedString(*(StringId *)(i * 2 + 0x52));
          SendMessage(HVar2,(UINT)((ulong)uVar11 >> 0x10),(WPARAM)uVar11,
                      (LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar6));
        }
      }
      else {
        for (i = 0; i < 8; i = i + 1) {
          uVar11 = 0x4030000;
          HVar2 = hwndDD;
          pcVar6 = PszGetCompressedString(*(StringId *)(i * 2 + 0x7c));
          SendMessage(HVar2,(UINT)((ulong)uVar11 >> 0x10),(WPARAM)uVar11,
                      (LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar6));
        }
      }
      goto LAB_10c8_632a;
    }
  }
  fAdded = 0;
  for (i = 0; i < ishdefMac; i = i + 1) {
    if (((uint)((SHDEF *)lpshdef)[i].wFlags >> 9 & 1) == 0) {
      if (fAdded == 0) {
        if (fStarbaseMode == 0) {
          iVar3 = 0;
        }
        else {
          iVar3 = 0x10;
        }
        CshQueued(iVar3 + i,&fProgress,0);
        HVar2 = GetDlgItem(hwndSlotDlg,0x818);
        if ((((int)((SHDEF *)lpshdef)[i].cExist == 0) &&
            (*(int *)((int)&((SHDEF *)lpshdef)[i].cExist + 2) == 0)) && (fProgress == 0)) {
          BVar1 = 1;
        }
        else {
          BVar1 = 0;
        }
        EnableWindow(HVar2,BVar1);
        HVar2 = GetDlgItem(hwndSlotDlg,0x817);
        EnableWindow(HVar2,1);
        if (((int)((SHDEF *)lpshdef)[i].cExist == 0) &&
           (*(int *)((int)&((SHDEF *)lpshdef)[i].cExist + 2) == 0)) {
          iVar3 = 0;
        }
        else {
          iVar3 = 1;
        }
        fAdded = iVar3 + 1;
      }
      SendMessage(hwndDD,0x403,0,(LPARAM)CONCAT22(lpshdef._2_2_,((SHDEF *)lpshdef)[i].hul.szClass));
    }
  }
LAB_10c8_632a:
  LVar8 = SendMessage(hwndDD,0x406,0,0);
  i = (short)LVar8;
  if (0x20 < i) {
    i = 0x20;
  }
  GetWindowRect(hwndDD,(undefined2 *)CONCAT22(unaff_SS,&rc));
  SetWindowPos(hwndDD,0,0,0,rc.right - rc.left,
               (i + 1) * (dyArial8 - (uint)(dyArial8 < 0xf)) + 8 +
               (uint)(0xe < dyArial8),6);
  SendMessage(hwndDD,0x40e,0,0);
  return;
}



// ======================================================================
// Function: FillBuildPartsLB
// Address: 10c8:63e8
// Segment: MEMORY_BUILD
// ======================================================================


void FillBuildPartsLB(HWND hwndLB,short grbit)

{
  COMPART *pCVar1;
  undefined2 uVar2;
  undefined2 unaff_SS;
  PART part;
  short grbitCur;
  char sz [200];
  short i;
  short mdAvail;
  
  grbitCur = 1;
  sz[0] = 'A';
  SendMessage(hwndLB,0x405,0,0);
  for (; grbitCur != 0; grbitCur = grbitCur << 1) {
    if ((grbitCur & grbit) != 0) {
      i = 0;
      part.hs.grhst = grbitCur;
      while( true ) {
        part.hs.wFlags = part.hs.wFlags & 0xff00U | i & 0xffU;
        mdAvail = FLookupPart(&part);
        if (mdAvail == 0) break;
        if (((fStarbaseMode != 0) && (grbitCur == 0x800)) && ((i == 0xf || (i == 0x10))))
        {
          mdAvail = -1;
        }
        if (mdAvail == 1) {
          sz[1] = (char)i + 'A';
          uVar2 = (undefined2)((ulong)part.pcom >> 0x10);
          pCVar1 = (COMPART *)part.pcom;
          sz[2] = (char)(pCVar1->ibmp % 0x1a) + 'A';
          sz[3] = (char)(pCVar1->ibmp / 0x1a) + 'A';
          __fstrcpy((char *)CONCAT22(unaff_SS,sz + 4),(char *)CONCAT22(uVar2,pCVar1->szName)
                           );
          SendMessage(hwndLB,0x401,0,(LPARAM)CONCAT22(unaff_SS,sz));
        }
        i = i + 1;
      }
    }
    sz[0] = sz[0] + '\x01';
  }
  return;
}



// ======================================================================
// Function: UpdateSlotGlobals
// Address: 10c8:6528
// Segment: MEMORY_BUILD
// ======================================================================


void UpdateSlotGlobals(void)

{
  byte bVar1;
  uint uVar2;
  HULDEF *pHVar3;
  undefined2 uVar4;
  HULDEF *pHVar5;
  HULDEF *lphuldef;
  short xLeft;
  ushort wrc;
  short i;
  short cSlot;
  short yTop;
  
  if (((SHDEF *)lpshdefBuild != (SHDEF *)0x0) || (lpshdefBuild._2_2_ != 0)) {
    pHVar5 = LphuldefFromId((lpshdefBuild->hul).ihuldef);
    uVar4 = (undefined2)((ulong)pHVar5 >> 0x10);
    pHVar3 = (HULDEF *)pHVar5;
    if (hwndSlotDlg == 0) {
      xLeft = 0xc;
      yTop = dyArial8 + 0xc;
    }
    else {
      xLeft = ptslotGlob.x + -0x14a;
      yTop = 0x20;
    }
    bVar1 = (pHVar3->hul).chs;
    for (i = 0; i < (int)(uint)bVar1; i = i + 1) {
      ((RECT *)vrgrcSlot + i)->left = (pHVar3->rgbrc[i] & 0xf) * 0x20 + xLeft;
      *(int *)((int)&vrgrcSlot[0].top + i * 8) =
           ((int)(uint)pHVar3->rgbrc[i] >> 4) * 0x20 + yTop;
      *(int *)((int)&vrgrcSlot[0].right + i * 8) =
           ((RECT *)vrgrcSlot + i)->left + 0x40;
      *(int *)((int)&vrgrcSlot[0].bottom + i * 8) =
           *(int *)((int)&vrgrcSlot[0].top + i * 8) + 0x40;
    }
    if ((pHVar3->hul).wtCargoMax != 0) {
      uVar2 = pHVar3->wrcCargo;
      rcCargo.left = (uVar2 >> 8 & 0xf) * 0x20 + xLeft;
      rcCargo.top = ((int)(uVar2 >> 8) >> 4) * 0x20 + yTop;
      rcCargo.right = (uVar2 & 0xf) * 0x20 + xLeft;
      rcCargo.bottom = ((int)(uVar2 & 0xff) >> 4) * 0x20 + yTop;
    }
    ptPlaque.x = xLeft + 0x102;
    ptPlaque.y = yTop + 0x111;
  }
  return;
}



// ======================================================================
// Function: IEmptyBmpFromGrhst
// Address: 10c8:6716
// Segment: MEMORY_BUILD
// ======================================================================


short IEmptyBmpFromGrhst(HullSlotType grhst)

{
  short i;
  
  i = 0;
  while( true ) {
    if (0x14 < i) {
      return 0;
    }
    if (*(HullSlotType *)(i * 2 + 0xc52) == grhst) break;
    i = i + 1;
  }
  return i;
}



// ======================================================================
// Function: FakeListProc
// Address: 10c8:6758
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Variable defined which should be unmapped: iSel */

long FakeListProc(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar1;
  LRESULT LVar2;
  short fListBox;
  short fRightBtn;
  short iSel;
  WPARAM WStack_6;
  
  uVar1 = CONCAT22(unaff_SI,unaff_DI);
  if (msg == 0x20) {
    GetCursorPos((short *)CONCAT22(unaff_SS,&iSel));
    ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&iSel));
    if (iSel < 0x40) {
      setcursor(hcurHand);
      return 1;
    }
  }
  else if ((((msg == 0x201) || (msg == 0x204)) && ((uint)lParam < 0x40)) &&
          ((mdBuild == 4 || (msg == 0x204)))) {
    CallWindowProc((fn_lpfnRealListProc *)
                   CONCAT22(lpfnRealListProc._2_2_,
                            (fn_lpfnRealListProc *)lpfnRealListProc),hwnd,0x201,wParam,
                   lParam);
    CallWindowProc((fn_lpfnRealListProc *)
                   CONCAT22(lpfnRealListProc._2_2_,
                            (fn_lpfnRealListProc *)lpfnRealListProc),hwnd,0x202,wParam,
                   lParam);
    if ((msg != 0x204) && (mdBuild == 4)) {
      fRightBtn = 0;
      fListBox = 1;
      uVar1 = __aFulshr(CONCAT22(1,wParam),0);
      FTrackSlot(hwnd,(uint)lParam,(short)uVar1,wParam,fListBox,fRightBtn);
      return 0;
    }
    LVar2 = SendMessage(hwnd,0x409,0,0);
    WStack_6 = (WPARAM)LVar2;
    if (WStack_6 != 0xffff) {
      SendMessage(hwnd,0x40a,WStack_6,0x112057a4);
      GlobalPD._2_2_ = 1 << (szWork[0] + 0xbfU & 0x1f);
      iSel = (int)szWork[1] - 0x41;
      GlobalPD.psz = (char *)((uint)GlobalPD.psz & 0xff00 | iSel & 0xffU);
      FLookupPart((PART *)&GlobalPD.field1_0x2);
      GlobalPD.grPopup = 9;
      uVar1 = __aFulshr(uVar1,iSel);
      Popup(hwnd,(uint)lParam,(short)uVar1);
      return 0;
    }
    return 0;
  }
  LVar2 = CallWindowProc((fn_lpfnRealListProc *)
                         CONCAT22(lpfnRealListProc._2_2_,
                                  (fn_lpfnRealListProc *)lpfnRealListProc),hwnd,msg,wParam
                         ,lParam);
  return LVar2;
}



// ======================================================================
// Function: MakeNewName
// Address: 10c8:694c
// Segment: MEMORY_BUILD
// ======================================================================


void MakeNewName(char *lpsz)

{
  ushort uVar1;
  short cLen;
  
  uVar1 = __fstrlen(lpsz);
  if ((int)uVar1 < 0x1c) {
    if (((((char *)lpsz)[uVar1 - 1] == ')') &&
        ((((undefined *)&DAT_1120_175f)[((char *)lpsz)[uVar1 - 2]] & 4) != 0)) &&
       (((char *)lpsz)[uVar1 - 3] == '(')) {
      if (((char *)lpsz)[uVar1 - 2] == '9') {
        ((char *)lpsz)[uVar1 - 2] = '0';
      }
      else {
        ((char *)lpsz)[uVar1 - 2] = ((char *)lpsz)[uVar1 - 2] + '\x01';
      }
    }
    else {
      __fstrcpy((char *)CONCAT22(lpsz._2_2_,(char *)lpsz + uVar1),(char *)0x11200cc9);
    }
  }
  FStringFitsScreen(lpsz,0xa0);
  return;
}



// ======================================================================
// Function: KillQueuedMassPackets
// Address: 10c8:6a52
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10c86b1c) */
/* WARNING: Removing unreachable block (ram,0x10c86afc) */
/* WARNING: Removing unreachable block (ram,0x10c86b21) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10c86b49) */
/* WARNING: Removing unreachable block (ram,0x10c86b4e) */

void KillQueuedMassPackets(PLANET *lppl)

{
  undefined2 uVar1;
  undefined2 uVar2;
  PLANET *pPVar3;
  undefined2 *puVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  undefined2 uVar6;
  ulong uVar7;
  ulong uVar8;
  PROD *lpprod;
  short iDst;
  short iprod;
  
  uVar8 = CONCAT22(unaff_SI,unaff_DI);
  uVar5 = (undefined2)((ulong)lppl >> 0x10);
  pPVar3 = (PLANET *)lppl;
  if (((*(int *)&pPVar3->lpplprod != 0) || (*(int *)((int)&pPVar3->lpplprod + 2) != 0)) &&
     (((PLPROD *)pPVar3->lpplprod)->iprodMac != 0)) {
    iDst = 0;
    iprod = 0;
    lpprod = (PROD *)CONCAT22(*(undefined2 *)((int)&pPVar3->lpplprod + 2),
                              (PROD *)(*(int *)&pPVar3->lpplprod + 4));
    for (; iprod < (int)(uint)((PLPROD *)pPVar3->lpplprod)->iprodMac; iprod = iprod + 1) {
      uVar7 = __aFulshr(uVar8,(ushort)(PROD *)lpprod);
      uVar6 = (undefined2)((ulong)lpprod >> 0x10);
      if (((((uint)uVar7 & 7) != 1) ||
          (uVar7 = __aFulshr(uVar8,(ushort)(PROD *)lpprod), ((uint)uVar7 & 0x7f) < 0xe)) ||
         (uVar7 = __aFulshr(uVar8,(ushort)(PROD *)lpprod), 0x11 < ((uint)uVar7 & 0x7f))) {
        if (iDst != iprod) {
          uVar1 = *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2);
          uVar2 = *(undefined2 *)((int)&pPVar3->lpplprod + 2);
          puVar4 = (undefined2 *)(*(int *)&pPVar3->lpplprod + 4 + iDst * 4);
          *puVar4 = (int)lpprod->dwFlags;
          puVar4[1] = uVar1;
        }
        iDst = iDst + 1;
      }
      lpprod = (PROD *)CONCAT22(uVar6,(PROD *)lpprod + 1);
    }
    if (iDst == 0) {
      FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pPVar3->lpplprod + 2),
                                    *(PL **)&pPVar3->lpplprod));
      *(undefined2 *)&pPVar3->lpplprod = 0;
      *(undefined2 *)((int)&pPVar3->lpplprod + 2) = 0;
    }
    else if (iDst != iprod) {
      ((PLPROD *)pPVar3->lpplprod)->iprodMac = (byte)iDst;
    }
    if ((sel.grobj == grobjPlanet) && (sel.pl.id == lppl->id)) {
      FLookupPlanet(sel.pl.id,(PLANET *)&sel.pl);
      FillPlanetProdLB
                (hwndPlanetProdLB,
                 (PLPROD *)
                 CONCAT22(sel.pl.lpplprod._2_2_,(PLPROD *)sel.pl.lpplprod),
                 (PLANET *)0x0);
    }
  }
  return;
}



// ======================================================================
// Function: KillQueuedShips
// Address: 10c8:6c2a
// Segment: MEMORY_BUILD
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10c86cd4) */
/* WARNING: Removing unreachable block (ram,0x10c86cf4) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10c86cf9) */
/* WARNING: Removing unreachable block (ram,0x10c86d29) */

void KillQueuedShips(PLANET *lppl)

{
  uint uVar1;
  undefined2 uVar2;
  undefined2 uVar3;
  PLANET *pPVar4;
  undefined2 *puVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar6;
  undefined2 uVar7;
  ulong uVar8;
  ulong uVar9;
  PROD *lpprod;
  short iDst;
  short iprod;
  
  uVar9 = CONCAT22(unaff_SI,unaff_DI);
  uVar6 = (undefined2)((ulong)lppl >> 0x10);
  pPVar4 = (PLANET *)lppl;
  if (((*(int *)&pPVar4->lpplprod != 0) || (*(int *)((int)&pPVar4->lpplprod + 2) != 0)) &&
     (((PLPROD *)pPVar4->lpplprod)->iprodMac != 0)) {
    iDst = 0;
    iprod = 0;
    lpprod = (PROD *)CONCAT22(*(undefined2 *)((int)&pPVar4->lpplprod + 2),
                              (PROD *)(*(int *)&pPVar4->lpplprod + 4));
    for (; iprod < (int)(uint)((PLPROD *)pPVar4->lpplprod)->iprodMac; iprod = iprod + 1) {
      uVar8 = __aFulshr(uVar9,(ushort)(PROD *)lpprod);
      uVar7 = (undefined2)((ulong)lpprod >> 0x10);
      if ((((uint)uVar8 & 7) != 2) ||
         (uVar8 = __aFulshr(uVar9,(ushort)(PROD *)lpprod), 0xf < ((uint)uVar8 & 0x7f))) {
        uVar8 = __aFulshr(uVar9,(ushort)(PROD *)lpprod);
        if (((uint)uVar8 & 7) == 2) {
          uVar1 = *(uint *)((int)&((PROD *)lpprod)->dwFlags + 2);
          *(int *)&lpprod->dwFlags = (int)lpprod->dwFlags;
          *(uint *)((int)&((PROD *)lpprod)->dwFlags + 2) = uVar1 & 0xf80f;
        }
        if (iDst != iprod) {
          uVar2 = *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2);
          uVar3 = *(undefined2 *)((int)&pPVar4->lpplprod + 2);
          puVar5 = (undefined2 *)(*(int *)&pPVar4->lpplprod + 4 + iDst * 4);
          *puVar5 = (int)lpprod->dwFlags;
          puVar5[1] = uVar2;
        }
        iDst = iDst + 1;
      }
      lpprod = (PROD *)CONCAT22(uVar7,(PROD *)lpprod + 1);
    }
    if (iDst == 0) {
      FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pPVar4->lpplprod + 2),
                                    *(PL **)&pPVar4->lpplprod));
      *(undefined2 *)&pPVar4->lpplprod = 0;
      *(undefined2 *)((int)&pPVar4->lpplprod + 2) = 0;
    }
    else if (iDst != iprod) {
      ((PLPROD *)pPVar4->lpplprod)->iprodMac = (byte)iDst;
    }
    if ((sel.grobj == grobjPlanet) && (sel.pl.id == lppl->id)) {
      FLookupPlanet(sel.pl.id,(PLANET *)&sel.pl);
      FillPlanetProdLB
                (hwndPlanetProdLB,
                 (PLPROD *)
                 CONCAT22(sel.pl.lpplprod._2_2_,(PLPROD *)sel.pl.lpplprod),
                 (PLANET *)0x0);
    }
  }
  return;
}



