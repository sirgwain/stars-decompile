// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: DrawShipOrders
// Address: 1050:0000
// Segment: MEMORY_SHIP
// ======================================================================

// Decompilation failed: Exception while decompiling 1050:0000: Decompiler process died


// ======================================================================
// Function: DrawShipWayPtOrders
// Address: 1050:0912
// Segment: MEMORY_SHIP
// ======================================================================

// Decompilation failed: Exception while decompiling 1050:0912: Decompiler process died


// ======================================================================
// Function: DrawShipPlanet
// Address: 1050:17b6
// Segment: MEMORY_SHIP
// ======================================================================

// Decompilation failed: Exception while decompiling 1050:17b6: Decompiler process died


// ======================================================================
// Function: DrawShipCargo
// Address: 1050:1a54
// Segment: MEMORY_SHIP
// ======================================================================

// Decompilation failed: Exception while decompiling 1050:1a54: Decompiler process died


// ======================================================================
// Function: DrawFleetComp
// Address: 1050:1e72
// Segment: MEMORY_SHIP
// ======================================================================

// Decompilation failed: Exception while decompiling 1050:1e72: Decompiler process died


// ======================================================================
// Function: FCanSplit
// Address: 1050:245c
// Segment: MEMORY_SHIP
// ======================================================================


short FCanSplit(long cBoat)

{
  short sVar1;
  
  if ((*(uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0) & 0xfff) == 0x200) {
    sVar1 = 0;
  }
  else if ((cBoat < 0) || ((cBoat < 0x10000 && ((uint)cBoat < 2)))) {
    sVar1 = 0;
  }
  else {
    sVar1 = 1;
  }
  return sVar1;
}



// ======================================================================
// Function: FCanSplitAll
// Address: 1050:24ae
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x105024e9) */
/* WARNING: Removing unreachable block (ram,0x10502506) */

short FCanSplitAll(long cBoat)

{
  short sVar1;
  
  if ((long)(cBoat + -1 +
            (ulong)(*(uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0) & 0xfff)
            ) < 0x201) {
    if (cBoat < 2) {
      sVar1 = 0;
    }
    else {
      sVar1 = 1;
    }
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: FCanMerge
// Address: 1050:2522
// Segment: MEMORY_SHIP
// ======================================================================


short FCanMerge(FLEET *pfl)

{
  int iVar1;
  int iVar2;
  uint uVar3;
  short sVar4;
  bool bVar5;
  short ishdef;
  short cfl;
  uint csh;
  int local_c;
  FLEET *lpfl;
  short i;
  
  cfl = 0;
  csh = 0;
  local_c = 0;
  for (i = 0; i < cFleet; i = i + 1) {
    iVar1 = *(int *)((FLEET **)rglpfl + i);
    iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    if ((iVar1 == 0) && (iVar2 == 0)) break;
    if ((*(int *)(iVar1 + 2) == pfl->iPlayer) &&
       ((*(int *)(iVar1 + 8) == sel.fl.pt.x &&
        (*(int *)(iVar1 + 10) == sel.fl.pt.y)))) {
      cfl = cfl + 1;
      for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
        uVar3 = *(uint *)(iVar1 + 0xc + ishdef * 2);
        bVar5 = CARRY2(csh,uVar3);
        csh = csh + uVar3;
        local_c = local_c + ((int)uVar3 >> 0xf) + (uint)bVar5;
      }
    }
  }
  if ((cfl == 1) ||
     ((-1 < local_c &&
      ((0 < local_c ||
       (0x7ffe - ((*(uint *)((int)&rgplr[0].wFlags_0x4 + pfl->iPlayer * 0xc0) & 0xfff) - 1
                 ) < csh)))))) {
    sVar4 = 0;
  }
  else {
    sVar4 = 1;
  }
  return sVar4;
}



// ======================================================================
// Function: ShipCommandProc
// Address: 1050:2640
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10502a10) */
/* WARNING: Removing unreachable block (ram,0x10502a4a) */

void ShipCommandProc(HWND hwnd,ushort wParam,long lParam)

{
  int iVar1;
  long lVar2;
  bool bVar3;
  PLORD *pPVar4;
  PLORD *pPVar5;
  short sVar6;
  uint uVar7;
  char *pcVar8;
  int iVar9;
  int *piVar10;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar11;
  FLEET *pFVar12;
  LRESULT LVar13;
  long lVar14;
  char *pcVar15;
  FLEET **ppFVar16;
  short sVar17;
  ulong uVar18;
  ushort in_stack_0000fb44;
  FLEET *lpflBest;
  short ishPrimary;
  FLEET *rgb;
  FLEET *pFStack_ba;
  short ifl;
  short ishdef;
  int lMin;
  int local_b2;
  char szT [34];
  XFER xf;
  undefined4 lSel;
  undefined4 lpProc;
  short fPercent;
  
  uVar18 = CONCAT22(unaff_SI,unaff_DI);
  fPercent = 0;
  uVar11 = __aFulshr(uVar18,in_stack_0000fb44);
  if ((int)uVar11 == 0) {
    SetFocus(hwndFrame);
  }
  if (((HWND)lParam == rghwndBtn[4]) &&
     (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0)) {
    SelectAdjFleet(-1,0);
  }
  else if (((HWND)lParam == rghwndBtn[5]) &&
          (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0)) {
    SelectAdjFleet(1,0);
  }
  else if (((HWND)lParam == rghwndBtn[6]) &&
          (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0)) {
    pcVar8 = PszGetFleetName(sel.fl.id);
    _strcpy((char *)szWork,pcVar8);
    StickyDlgPos(hwnd,(POINT *)&ptStickyRenameDlg,0);
    lpProc = MakeProcInstance(RenameDlg,hInst);
    sVar17 = DialogBox(0,(LPCSTR)CONCAT22(0x7e3,hwndFrame),(HWND)((ulong)lpProc >> 0x10),
                       (char)lpProc);
    if (sVar17 == 0) {
      FreeProcInstance(lpProc);
    }
    else {
      FreeProcInstance(lpProc);
      _strcpy(szT,(char *)szWork);
      pcVar8 = PszGetFleetName(sel.fl.id);
      sVar17 = _strcmp(szT,pcVar8);
      if (sVar17 != 0) {
        LogChangeName(grobjFleet,sel.fl.id,szT);
        InvalidateReport(1,1);
        FillOrdersLB();
        DrawPlanShip(0,-0x7f60);
        InvalidateRect(hwndMessage,(RECT *)0x0,1);
        InvalidateRect(hwndScanner,(RECT *)0x0,1);
        SetMineralTitleBar(hwndMine);
      }
    }
  }
  else if (((HWND)lParam == rghwndBtn[3]) &&
          (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0)) {
    SelectAdjPlanet(0,sel.fl.idPlanet);
    SetFleetDropDownSel(sel.fl.id);
  }
  else if (((HWND)lParam == rghwndBtn[7]) &&
          (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0)) {
    if (sel.fl.idPlanet == -1) {
      TransferStuff(sel.fl.id,2,-1,4,0);
    }
    else {
      TransferStuff(sel.fl.id,2,sel.fl.idPlanet,1,0);
    }
  }
  else if ((HWND)lParam == hwndShipDD) {
    uVar11 = __aFulshr(uVar18,in_stack_0000fb44);
    if ((int)uVar11 == 1) {
      DrawPlanShip(0,-0x7ffc);
    }
  }
  else if ((HWND)lParam == hwndShipLB) {
    uVar11 = __aFulshr(uVar18,in_stack_0000fb44);
    if ((int)uVar11 == 1) {
      lSel = SendMessage(hwndShipLB,0x409,0,0);
      SetScanWp((short)lSel);
    }
  }
  else if ((HWND)lParam == hwndFleetCompLB) {
    uVar11 = __aFulshr(uVar18,in_stack_0000fb44);
    if (((int)uVar11 == 1) &&
       (lVar14 = SendMessage(hwndFleetCompLB,0x409,0,0), -1 < lVar14)) {
      ishdef = 0;
      while( true ) {
        lSel._2_2_ = (int)((ulong)lVar14 >> 0x10);
        lSel._0_2_ = (uint)lVar14;
        lVar2 = lVar14;
        if (0xf < ishdef) break;
        if (0 < *(int *)((int)&sel.fl + 0xc + ishdef * 2)) {
          lSel._2_2_ = lSel._2_2_ - (uint)((uint)lSel == 0);
          lVar2 = CONCAT22(lSel._2_2_,(uint)lSel + -1);
          bVar3 = lVar14 < 1;
          lVar14 = CONCAT22(lSel._2_2_,(uint)lSel + -1);
          if (bVar3) break;
        }
        ishdef = ishdef + 1;
      }
      GlobalPD.grPopup = 0xb;
      GlobalPD.u_POPUPDATA_0x0002.lpfl._0_2_ = (FLEET *)(ishdef * 0x93 + 0x3f00);
      GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = 0x1120;
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = 0;
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = 1;
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = 0;
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary = 0;
      lSel = lVar2;
      Popup(hwndFleetCompLB,10,10);
    }
  }
  else if ((HWND)lParam == hwndBattleDD) {
    uVar11 = __aFulshr(uVar18,in_stack_0000fb44);
    if ((int)uVar11 == 1) {
      lSel = SendMessage(hwndBattleDD,0x407,0,0);
      if (lSel != -1) {
        if (lSel == 0) {
          lpProc = MakeProcInstance(BattlePlansDlg,hInst);
          sVar17 = DialogBox(0,(LPCSTR)CONCAT22(0x7dd,hwndFrame),
                             (HWND)((ulong)lpProc >> 0x10),(char)lpProc);
          lSel._2_2_ = sVar17 >> 0xf;
          lSel._0_2_ = sVar17;
          FreeProcInstance(lpProc);
          sel.fl.iplan = (byte)(uint)lSel;
        }
        else {
          sel.fl.iplan = (char)lSel - 1;
        }
        FLookupFleet(-1,(FLEET *)&sel.fl);
      }
    }
  }
  else if (((HWND)lParam == rghwndBtn[0]) &&
          (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0)) {
    lSel = SendMessage(hwndShipDD,0x407,0,0);
    if (lSel != -1) {
      sVar17 = FLookupOrbitingXfer(sel.pl.id,(short)lSel,&xf,sel.fl.id);
      if (sVar17 != 0) {
        TransferStuff(sel.fl.id,2,xf.id,xf.grobj,0);
      }
    }
  }
  else if (((HWND)lParam == rghwndBtn[1]) &&
          (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0)) {
    lSel = SendMessage(hwndShipDD,0x407,0,0);
    if (lSel != -1) {
      sVar17 = FLookupOrbitingXfer(sel.pl.id,(short)lSel,&xf,sel.fl.id);
      if ((sVar17 != 0) && (xf.grobj == grobjFleet)) {
        SelectAdjFleet(0,xf.id);
      }
    }
  }
  else if (((HWND)lParam == rghwndBtn[2]) &&
          (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0)) {
    lSel = SendMessage(hwndShipDD,0x407,0,0);
    if (lSel != -1) {
      sVar17 = FLookupOrbitingXfer(sel.pl.id,(short)lSel,&xf,sel.fl.id);
      if ((sVar17 != 0) && (xf.grobj == grobjFleet)) {
        TransferStuff(sel.fl.id,2,xf.id,2,1);
        if ((grbitScan & 0x80) != 0) {
          InvalidateRect(hwndScanner,(RECT *)0x0,1);
        }
        InvalidateReport(1,1);
      }
    }
  }
  else if (((HWND)lParam == rghwndBtn[8]) &&
          (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0)) {
    TransferStuff(sel.fl.id,2,-1,4,1);
    InvalidateReport(1,1);
    if (((uint)gd.grBits >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
  }
  else if (((HWND)lParam == rghwndBtn[9]) &&
          (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0)) {
    FFleetSplitAll((FLEET *)&sel.fl);
    FillShipDD(sel.fl.id);
    ishdef = -0x7c4b;
    FLookupFleet(sel.fl.id,(FLEET *)&sel.fl);
    FillFleetCompLB();
    DrawPlanShip(0,ishdef);
    InvalidateRect(hwndMine,(RECT *)0x0,1);
  }
  else if (((HWND)lParam == rghwndBtn[10]) &&
          (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0)) {
    vrgiflMerge = &stack0xfb44;
    vcflMerge = 0;
    for (ishdef = 0; ishdef < cFleet; ishdef = ishdef + 1) {
      iVar9 = *(int *)((FLEET **)rglpfl + ishdef);
      iVar1 = *(int *)((int)((FLEET **)rglpfl + ishdef) + 2);
      if ((iVar9 == 0) && (iVar1 == 0)) break;
      if ((*(int *)(iVar9 + 2) == idPlayer) &&
         ((((*(uint *)(iVar9 + 4) >> 10 & 1) == 0 && (*(int *)(iVar9 + 8) == sel.fl.pt.x))
          && (*(int *)(iVar9 + 10) == sel.fl.pt.y)))) {
        *(short *)(&stack0xfb44 + vcflMerge * 2) = ishdef;
        vcflMerge = vcflMerge + 1;
      }
    }
    pFStack_ba = (FLEET *)0x0;
    ifl = 0;
    lpProc = MakeProcInstance(MergeFleetsDlg,hInst);
    sVar17 = DialogBox(0,(LPCSTR)CONCAT22(0x52,hwndFrame),(HWND)((ulong)lpProc >> 0x10),
                       (char)lpProc);
    pFVar12 = (FLEET *)CONCAT22(ifl,pFStack_ba);
    if (sVar17 != 0) {
      for (ishdef = 0; pFVar12 = (FLEET *)CONCAT22(ifl,pFStack_ba), ishdef < vcflMerge;
          ishdef = ishdef + 1) {
        if (vrgiflMerge[ishdef] != -1) {
          if (((FLEET **)rglpfl)[vrgiflMerge[ishdef]]->id == sel.fl.id) {
                    /* WARNING: Load size is inaccurate */
            pFStack_ba = ((FLEET **)rglpfl)[vrgiflMerge[ishdef]];
            ifl = *(short *)((int)((FLEET **)rglpfl + vrgiflMerge[ishdef]) + 2);
          }
          vrgiflMerge[ishdef] =
               ((FLEET **)rglpfl)[vrgiflMerge[ishdef]]->id;
        }
      }
      ishdef = 0;
      while( true ) {
        ifl = (short)((ulong)pFVar12 >> 0x10);
        pFStack_ba = (FLEET *)pFVar12;
        if (vcflMerge <= ishdef) break;
        if (vrgiflMerge[ishdef] != -1) {
          if (pFVar12 == (FLEET *)0x0) {
            pFVar12 = LpflFromId(vrgiflMerge[ishdef]);
          }
          else if (vrgiflMerge[ishdef] != pFVar12->id) break;
        }
        ishdef = ishdef + 1;
      }
      if (ishdef == vcflMerge) {
        pFVar12 = (FLEET *)0x0;
      }
      else if (pFVar12->id != sel.fl.id) {
        SelectAdjFleet(0,pFVar12->id);
        pFVar12 = (FLEET *)CONCAT22(ifl,pFStack_ba);
      }
    }
    ifl = (short)((ulong)pFVar12 >> 0x10);
    pFStack_ba = (FLEET *)pFVar12;
    FreeProcInstance(lpProc);
    if ((pFStack_ba != (FLEET *)0x0) || (ifl != 0)) {
      FFleetMergeAll((FLEET *)&sel.fl);
      FillShipDD(sel.fl.id);
      rgb = (FLEET *)0x83b5;
      FLookupFleet(sel.fl.id,(FLEET *)&sel.fl);
      FillFleetCompLB();
      DrawPlanShip(0,(short)rgb);
      InvalidateRect(hwndMine,(RECT *)0x0,1);
      if ((grbitScan & 0x80) != 0) {
        InvalidateRect(hwndScanner,(RECT *)0x0,1);
      }
      vrgiflMerge = (short *)0x0;
      vcflMerge = 0;
      if (((uint)gd.grBits >> 0xb & 1) != 0) {
        AdvanceTutor();
      }
    }
  }
  else if (((HWND)lParam == hwndRepCB) &&
          (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0)) {
    LVar13 = SendMessage(hwndRepCB,0x400,0,0);
    ishdef = (short)LVar13;
    sel.fl.wFlags_0x4 = sel.fl.wFlags_0x4 & 0xfdff | (ishdef & 1U) << 9;
    FLookupFleet(-1,(FLEET *)&sel.fl);
  }
  else if ((HWND)lParam == rghwndOrderDD[0]) {
    uVar11 = __aFulshr(uVar18,in_stack_0000fb44);
    if ((int)uVar11 == 1) {
      LVar13 = SendMessage(rghwndOrderDD[0],0x407,0,0);
      lSel._2_2_ = (int)((ulong)LVar13 >> 0x10);
      ishdef = (short)LVar13;
      if (ishdef != (*(uint *)((int)(PLORD *)sel.fl.lpplord +
                              sel.iwpAct * 0x12 + 10) & 0xf)) {
        if ((LVar13 == 3) ||
           ((*(uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 10) &
            0xf) == 3)) {
          lSel._0_2_ = ishdef;
          InvalidateRect(hwndMine,(RECT *)0x0,1);
          LVar13 = CONCAT22(lSel._2_2_,(uint)lSel);
        }
        lSel._0_2_ = (uint)LVar13;
        pFStack_ba = (FLEET *)(*(uint *)((int)(PLORD *)sel.fl.lpplord +
                                        sel.iwpAct * 0x12 + 10) & 0xfff0 |
                              (uint)lSel & 0xf);
        *(uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 10) =
             (uint)pFStack_ba;
        ifl = (short)((PLORD *)sel.fl.lpplord + 1);
        ishdef = sel.fl.lpplord._2_2_;
        lSel = LVar13;
        __fmemset((void *)CONCAT22(sel.fl.lpplord._2_2_,
                                           (void *)(ifl + sel.iwpAct * 0x12 + 8)),0,10);
        if ((uint)lSel == 7) {
          *(undefined2 *)
           ((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xe) = 0;
          *(undefined2 *)
           ((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xc) = 0;
        }
        else if ((uint)lSel == 9) {
          *(undefined2 *)
           ((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xc) = 0;
        }
        else if ((uint)lSel == 6) {
          *(undefined2 *)
           ((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xc) = 5;
        }
        else if (((uint)lSel == 4) &&
                ((*(uint *)((int)(PLORD *)sel.fl.lpplord +
                           sel.iwpAct * 0x12 + 10) >> 8 & 0xf) != 2)) {
          lpflBest = (FLEET *)0x0;
          ishPrimary = 0;
          for (ishdef = 1; ishdef < 0x10; ishdef = ishdef + 1) {
            if (*(int *)((int)&sel.fl + 0xc + ishPrimary * 2) <
                *(int *)((int)&sel.fl + 0xc + ishdef * 2)) {
              ishPrimary = ishdef;
            }
          }
          for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
            rgb = ((FLEET **)rglpfl)[ifl];
            pFStack_ba = (FLEET *)*(uint *)((int)((FLEET **)rglpfl + ifl) + 2);
            if ((rgb == (FLEET *)0x0) && (pFStack_ba == (FLEET *)0x0)) break;
            piVar10 = (int *)((int)(PLORD *)sel.fl.lpplord +
                             sel.iwpAct * 0x12 + 4);
            if (((&rgb->pt)->x == *piVar10) &&
               (((((rgb->pt).y == piVar10[1] && (rgb->iPlayer == idPlayer)) &&
                 ((rgb->wFlags_0x4 >> 10 & 1) == 0)) &&
                (((FLEET *)CONCAT22(pFStack_ba,rgb))->id != sel.fl.id)))) {
              if (rgb->rgcsh[ishPrimary] < 1) {
                if ((((FLEET *)lpflBest == (FLEET *)0x0) && (lpflBest._2_2_ == 0)) ||
                   ((1 < ((FLEET *)lpflBest)->cord && (rgb->cord == 1)))) {
                  lpflBest = (FLEET *)CONCAT22(pFStack_ba,rgb);
                }
              }
              else {
                lpflBest = (FLEET *)CONCAT22(pFStack_ba,rgb);
                if (rgb->cord == 1) break;
              }
            }
          }
          if (((FLEET *)lpflBest != (FLEET *)0x0) || (lpflBest._2_2_ != 0)) {
            *(uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 10) =
                 *(uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 10
                          ) & 0xf0ff | 0x200;
            *(short *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 8) =
                 lpflBest->id;
            FLookupFleet(-1,(FLEET *)&sel.fl);
            FillOrdersLB();
          }
        }
        FLookupFleet(-1,(FLEET *)&sel.fl);
        UpdateOrdersDDs(1);
        DrawPlanShip(0,-0x7f00);
      }
    }
  }
  else if ((HWND)lParam == rghwndOrderDD[1]) {
    uVar11 = __aFulshr(uVar18,in_stack_0000fb44);
    if ((int)uVar11 == 1) {
      LVar13 = SendMessage(rghwndOrderDD[1],0x407,0,0);
      lSel._2_2_ = (int)((ulong)LVar13 >> 0x10);
      ishdef = (short)LVar13;
      lSel = LVar13;
      if ((*(uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 10) &
          0xf) == 7) {
        *(short *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xe) =
             ishdef;
        FLookupFleet(-1,(FLEET *)&sel.fl);
        UpdateOrdersDDs(1);
      }
      else {
        lSel._0_2_ = ishdef;
        if ((*(uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 10) &
            0xf) == 9) {
          *(short *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xc) =
               ishdef;
          FLookupFleet(-1,(FLEET *)&sel.fl);
          UpdateOrdersDDs(1);
        }
        else if ((*(uint *)((int)(PLORD *)sel.fl.lpplord +
                           sel.iwpAct * 0x12 + 10) & 0xf) == 1) {
          UpdateOrdersDDs(2);
          DrawPlanShip(0,0x100);
        }
        else {
          *(short *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xc) =
               ishdef;
          *(short *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xe) =
               ishdef;
          FLookupFleet(-1,(FLEET *)&sel.fl);
        }
      }
    }
  }
  else if ((HWND)lParam == rghwndOrderDD[2]) {
    uVar11 = __aFulshr(uVar18,in_stack_0000fb44);
    if ((int)uVar11 == 1) {
      lSel = SendMessage(rghwndOrderDD[2],0x407,0,0);
      LVar13 = SendMessage(rghwndOrderDD[1],0x407,0,0);
      if (LVar13 == 0) {
        lMin = 4;
        local_b2 = 0;
      }
      else {
        lMin = (int)LVar13 + -1;
        local_b2 = (int)((ulong)LVar13 >> 0x10) - (uint)((int)LVar13 == 0);
      }
      ishdef = (uint)lSel;
      ifl = (uint)lSel << 0xc;
      rgb = (FLEET *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xc);
      pFStack_ba = (FLEET *)sel.fl.lpplord._2_2_;
      lVar14 = __aFlshl(uVar18,in_stack_0000fb44);
      sVar17 = sel.fl.lpplord._2_2_;
      pPVar4 = (PLORD *)sel.fl.lpplord;
      uVar7 = *(uint *)((int)rgb->rgcsh + (int)lVar14 + -0xc) & 0xfff | ifl;
      iVar9 = sel.iwpAct * 0x12;
      lVar14 = __aFlshl(uVar18,in_stack_0000fb44);
      *(uint *)((int)pPVar4 + (int)lVar14 + iVar9 + 0xc) = uVar7;
      FLookupFleet(-1,(FLEET *)&sel.fl);
      UpdateOrdersDDs(3);
      DrawPlanShip(0,0x100);
    }
  }
  else if (((HWND)lParam == hwndOrderED) &&
          (uVar11 = __aFulshr(uVar18,in_stack_0000fb44), (int)uVar11 == 0x300)) {
    lSel = SendMessage(rghwndOrderDD[2],0x407,0,0);
    if ((lSel == 5) || (lSel == 6)) {
      fPercent = 1;
    }
    GetWindowText(hwndOrderED,(LPSTR)&rgb,8);
    ppFVar16 = &rgb;
    pcVar15 = (char *)0x14f83b75;
    uVar7 = _atoi(ppFVar16);
    ishPrimary = uVar7;
    if (0x7fff < uVar7) {
      ishPrimary = 0;
    }
    if (fPercent == 0) {
      if (4000 < ishPrimary) {
        ishPrimary = 4000;
      }
    }
    else if (100 < ishPrimary) {
      ishPrimary = 100;
    }
    if (uVar7 != ishPrimary) {
      sVar17 = 0x10;
      pcVar8 = PszFormatIds(idsAmountCargoMaySpecifyHereMustBetween,(short *)0x0);
      AlertSz(pcVar8,sVar17);
      _wsprintf(szWork,PCTD,ishPrimary);
      pcVar15 = szWork;
      ppFVar16 = (FLEET **)hwndOrderED;
      SetWindowText(hwndOrderED,szWork);
    }
    LVar13 = SendMessage(rghwndOrderDD[1],0x407,0,0);
    sVar17 = sel.fl.lpplord._2_2_;
    pPVar4 = (PLORD *)sel.fl.lpplord;
    if (LVar13 == 0) {
      lMin = 4;
      local_b2 = 0;
    }
    else {
      lMin = (int)LVar13 + -1;
      local_b2 = (int)((ulong)LVar13 >> 0x10) - (uint)((int)LVar13 == 0);
    }
    iVar9 = sel.iwpAct * 0x12;
    lVar14 = __aFlshl((long)pcVar15,(ushort)ppFVar16);
    sVar6 = sel.fl.lpplord._2_2_;
    pPVar5 = (PLORD *)sel.fl.lpplord;
    uVar7 = *(uint *)((int)pPVar4 + (int)lVar14 + iVar9 + 0xc);
    iVar9 = sel.iwpAct * 0x12;
    lVar14 = __aFlshl((long)pcVar15,(ushort)ppFVar16);
    *(uint *)((int)pPVar5 + (int)lVar14 + iVar9 + 0xc) = uVar7 & 0xf000 | ishPrimary & 0xfffU;
    FLookupFleet(-1,(FLEET *)&sel.fl);
  }
  return;
}



// ======================================================================
// Function: SelectAdjFleet
// Address: 1050:3d32
// Segment: MEMORY_SHIP
// ======================================================================


void SelectAdjFleet(short dInc,short idFleet)

{
  int iVar1;
  FLEET *pFVar2;
  undefined2 uVar3;
  POINT pt_00;
  SCAN scan;
  FLEET *lpflT;
  short idNew;
  FLEET *lpfl;
  short i;
  short idOld;
  short pt;
  short local_6;
  
  idOld = -1;
  if (0 < cFleet) {
    if (dInc != 0) {
      idFleet = sel.fl.id;
    }
    if (vrptFleet.fCached == 0) {
      InvalidateReport(1,1);
    }
    for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar2 = ((FLEET **)rglpfl)[i];
      iVar1 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpfl = (FLEET *)CONCAT22(iVar1,pFVar2);
      if (((pFVar2 == (FLEET *)0x0) && (iVar1 == 0)) || (lpfl->id == idFleet)) break;
    }
    pFVar2 = (FLEET *)lpfl;
    uVar3 = (undefined2)((ulong)lpfl >> 0x10);
    if ((i == cFleet) || (pFVar2->iPlayer != idPlayer)) {
      if (i == cFleet) {
        return;
      }
      scan.pt.x = (&pFVar2->pt)->x;
      scan.pt.y = (pFVar2->pt).y;
      scan.grobj = 0x83;
      pt = scan.pt.x;
      local_6 = scan.pt.y;
      ChangeScanSel(&scan,0);
    }
    else {
      if (dInc == 0) {
        if (((sel.grobj == grobjFleet) && (sel.fl.pt.x == (&pFVar2->pt)->x)) &&
           (sel.fl.pt.y == (pFVar2->pt).y)) {
          idOld = sel.fl.id;
        }
      }
      else {
        i = 0;
        while ((i < (int)(*(uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0) &
                         0xfff) &&
               (((FLEET **)rglpfl)[((ushort *)vlprgidFleet)[i]]->id != idFleet))) {
          i = i + 1;
        }
        i = i + dInc;
        if (i < (int)(*(uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0) &
                     0xfff)) {
          if (i < 0) {
            i = (*(uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0) & 0xfff) -
                1;
          }
        }
        else {
          i = 0;
        }
        i = ((ushort *)vlprgidFleet)[i];
      }
                    /* WARNING: Load size is inaccurate */
      pFVar2 = ((FLEET **)rglpfl)[i];
      iVar1 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpflT = (FLEET *)CONCAT22(iVar1,pFVar2);
      idNew = lpflT->id;
      scan.pt.x = (&pFVar2->pt)->x;
      scan.pt.y = (pFVar2->pt).y;
      scan.grobj = 0x82;
      pt = scan.pt.x;
      local_6 = scan.pt.y;
      ChangeScanSel(&scan,0);
      RedrawScanSel(0,0);
      ChangeMainObjSel(2,idNew);
      RedrawScanSel(0,1);
    }
    pt_00.y = local_6;
    pt_00.x = pt;
    CtrPointScan(pt_00,1);
    DrawScannerSBar(0,(RECT *)0x0,(SBAR *)0x0,0);
    InvalidateRect(hwndMine,(RECT *)0x0,1);
    SetMineralTitleBar(hwndMine);
    if (idOld != -1) {
      SetFleetDropDownSel(idOld);
    }
  }
  return;
}



// ======================================================================
// Function: SetFleetDropDownSel
// Address: 1050:400e
// Segment: MEMORY_SHIP
// ======================================================================


void SetFleetDropDownSel(short id)

{
  FLEET *pFVar1;
  int iVar2;
  int iVar3;
  short iOffset;
  FLEET *lpfl;
  short i;
  short idSkip;
  
  iOffset = 0;
  iVar3 = sel.fl.id;
  if (sel.grobj != grobjFleet) {
    iVar3 = -1;
  }
  i = 0;
  while ((i < cFleet && (((FLEET **)rglpfl)[i]->id != id))) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[i];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
    if (((sel.pt.x == (&pFVar1->pt)->x) && (sel.pt.y == (pFVar1->pt).y)) &&
       (lpfl->id != iVar3)) {
      iOffset = iOffset + 1;
    }
    i = i + 1;
  }
  SendMessage(hwndShipDD,0x40e,iOffset,0);
  DrawPlanShip(0,0x4004);
  return;
}



// ======================================================================
// Function: LGetFleetStat
// Address: 1050:40f2
// Segment: MEMORY_SHIP
// ======================================================================


long LGetFleetStat(FLEET *lpfl,GrStat grStat)

{
  long lVar1;
  short sVar2;
  FLEET *pFVar3;
  int iVar4;
  undefined2 uVar5;
  ulong uVar6;
  short i;
  
  lVar1 = 0;
  uVar5 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar3 = (FLEET *)lpfl;
  if ((pFVar3->wFlags_0x4 & 0xff) == 7) {
    for (i = 0; i < 0x10; i = i + 1) {
      if (pFVar3->rgcsh[i] != 0) {
        iVar4 = pFVar3->iPlayer * 4;
        sVar2 = WtMaxShdefStat((SHDEF *)CONCAT22(*(undefined2 *)(iVar4 + 0x100),
                                                 (SHDEF *)(*(int *)(iVar4 + 0xfe) + i * 0x93)),
                               grStat);
        uVar6 = __aFulmul((long)pFVar3->rgcsh[i],(long)sVar2);
        lVar1 = uVar6 + lVar1;
      }
    }
  }
  else {
    lVar1 = 32000;
  }
  return lVar1;
}



// ======================================================================
// Function: WtMaxShdefStat
// Address: 1050:41b2
// Segment: MEMORY_SHIP
// ======================================================================


short WtMaxShdefStat(SHDEF *lpshdef,GrStat grStat)

{
  SHDEF *pSVar1;
  HULDEF *pHVar2;
  HUL *lphul;
  short j;
  short wt;
  
  pSVar1 = (SHDEF *)lpshdef;
  if (grStat == grStatFuel) {
    pHVar2 = LphuldefFromId((lpshdef->hul).ihuldef);
    wt = (((HULDEF *)pHVar2)->hul).wtFuelMax;
    for (j = 0; j < (int)(uint)(pSVar1->hul).chs; j = j + 1) {
      if (((pSVar1->hul).rghs + j)->grhst == hstSpecialM) {
        if (((pSVar1->hul).rghs[j].wFlags_0x2 & 0xff) == 5) {
          wt = wt + ((pSVar1->hul).rghs[j].wFlags_0x2 >> 8) * 0xfa;
        }
        else if (((pSVar1->hul).rghs[j].wFlags_0x2 & 0xff) == 6) {
          wt = wt + ((pSVar1->hul).rghs[j].wFlags_0x2 >> 8) * 500;
        }
      }
      else if ((((pSVar1->hul).rghs + j)->grhst == hstSpecialE) &&
              (((pSVar1->hul).rghs[j].wFlags_0x2 & 0xff) == 0x10)) {
        wt = wt + ((pSVar1->hul).rghs[j].wFlags_0x2 >> 8) * 200;
      }
    }
  }
  else if (grStat == grStatCargo) {
    pHVar2 = LphuldefFromId((lpshdef->hul).ihuldef);
    wt = (((HULDEF *)pHVar2)->hul).wtCargoMax;
    for (j = 0; j < (int)(uint)(pSVar1->hul).chs; j = j + 1) {
      if (((pSVar1->hul).rghs + j)->grhst == hstSpecialM) {
        if (((pSVar1->hul).rghs[j].wFlags_0x2 & 0xff) == 2) {
          wt = wt + ((pSVar1->hul).rghs[j].wFlags_0x2 >> 8) * 0x32;
        }
        else if (((pSVar1->hul).rghs[j].wFlags_0x2 & 0xff) == 3) {
          wt = wt + ((pSVar1->hul).rghs[j].wFlags_0x2 >> 8) * 100;
        }
        else if (((pSVar1->hul).rghs[j].wFlags_0x2 & 0xff) == 4) {
          wt = wt + ((pSVar1->hul).rghs[j].wFlags_0x2 >> 8) * 0xfa;
        }
      }
    }
  }
  else {
    wt = 0;
  }
  return wt;
}



// ======================================================================
// Function: DrawFleetGauge
// Address: 1050:44b6
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Variable defined which should be unmapped: cSections */
/* WARNING: Variable defined which should be unmapped: iMode */
/* WARNING: Removing unreachable block (ram,0x105046af) */
/* WARNING: Removing unreachable block (ram,0x1050463c) */
/* WARNING: Removing unreachable block (ram,0x10504621) */
/* WARNING: Removing unreachable block (ram,0x105046aa) */
/* WARNING: Removing unreachable block (ram,0x1050461c) */
/* WARNING: Removing unreachable block (ram,0x105046ca) */
/* WARNING: Removing unreachable block (ram,0x10504754) */

void DrawFleetGauge(HDC hdc,RECT *prc,FLEET *lpfl,short grbit)

{
  ushort uVar1;
  uint uVar2;
  char *pcVar3;
  short sVar4;
  long lVar5;
  DWORD DVar6;
  short cSections;
  short iMode;
  short i;
  short c;
  ushort rghbr [6];
  
  if (((FLEET *)lpfl == (FLEET *)0x0) && (lpfl._2_2_ == 0)) {
    lpfl = &sel.fl;
  }
  SelectObject(hdc,rghfontArial8[1]);
  cSections = 1;
  lVar5 = LGetFleetStat(lpfl,grStatCargo);
  if ((grbit < 0) || (4 < grbit)) {
    if (grbit == 5) {
      for (i = 0; i < 4; i = i + 1) {
        rghbr[i] = ((ushort *)rghbrMineral)[i];
        uVar1 = *(ushort *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
        rghbr[i * 2 + -0xe] = *(ushort *)(((FLEET *)lpfl)->rgwtMin + i);
        rghbr[i * 2 + -0xd] = uVar1;
      }
      cSections = 4;
    }
    else if (grbit == 6) {
      uVar2 = *(uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 10)
              >> 4 & 0xf;
      if ((uVar2 < 0xb) &&
         ((uVar2 != 10 || (sVar4 = IFindIdealWarp(&sel.fl,0), 9 < sVar4)))) {
        rghbr[0] = rghbrMineral[4];
      }
      else {
        rghbr[0] = rghbrMineral[2];
      }
      lVar5 = 0xb;
    }
    else if (grbit == 7) {
      uVar2 = *(uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xc);
      if ((uVar2 < 0xb) &&
         ((uVar2 != 10 || (sVar4 = IFindIdealWarp(&sel.fl,0), 9 < sVar4)))) {
        lVar5 = 10;
        rghbr[0] = rghbrMineral[4];
      }
      else {
        lVar5 = 10;
        rghbr[0] = rghbrMineral[2];
      }
    }
  }
  else {
    rghbr[0] = ((ushort *)rghbrMineral)[grbit];
    if (grbit == 4) {
      lVar5 = LGetFleetStat(lpfl,grStatFuel);
    }
  }
  lVar5 = LDrawGauge(hdc,prc,cSections,&stack0xffd6,rghbr,lVar5);
  SetBkMode(hdc,1);
  if (grbit == 6) {
    if (lVar5 == 0) {
      sVar4 = 0x1040;
      c = CchGetString(idsStopped,(char *)szWork);
    }
    else if (lVar5 < 0xb) {
      pcVar3 = PszGetCompressedString(idsWarpLd);
      sVar4 = 0x14f8;
      c = _wsprintf(szWork,pcVar3);
    }
    else {
      sVar4 = 0x1040;
      c = CchGetString(idsUseStargate,(char *)szWork);
    }
  }
  else if (grbit == 7) {
    if (lVar5 == 0) {
      sVar4 = 0x1040;
      c = CchGetString(idsAutomatic,(char *)szWork);
    }
    else {
      pcVar3 = PszGetCompressedString(idsWarpLd);
      sVar4 = 0x14f8;
      c = _wsprintf(szWork,pcVar3);
    }
  }
  else if ((cSections == 1) && (grbit != 4)) {
    pcVar3 = PszGetCompressedString(idsLdkt);
    sVar4 = 0x14f8;
    c = _wsprintf(szWork,pcVar3);
  }
  else if (grbit == 4) {
    pcVar3 = PszGetCompressedString(idsLdLdmg);
    _cSections = pcVar3;
    sVar4 = 0x14f8;
    c = _wsprintf(szWork,_cSections);
  }
  else {
    pcVar3 = PszGetCompressedString(idsLdLdkt);
    _cSections = pcVar3;
    sVar4 = 0x14f8;
    c = _wsprintf(szWork,_cSections);
  }
  DVar6 = GetTextExtent(hdc,szWork,c);
  iMode = sVar4;
  if ((int)DVar6 < (prc->right - prc->left) + -3) {
    iMode = 0x14f8;
    RcCtrTextOut(hdc,prc,(char *)szWork,c);
  }
  SetBkMode(hdc,iMode);
  return;
}



// ======================================================================
// Function: DrawFleetBitmap
// Address: 1050:490e
// Segment: MEMORY_SHIP
// ======================================================================


void DrawFleetBitmap
          (FLEET *lpfl,HDC hdc,short x,short y,short fFrame,short ibmp,short cDiff,short fShrink,
          short ibmpRace,short csh)

{
  HGDIOBJ HVar1;
  int iVar2;
  int iVar3;
  short sVar4;
  uint uVar5;
  DWORD DVar6;
  HBRUSH hbrSav;
  short dxyPlusWidth;
  short xCur;
  short dx;
  short dxy;
  short i;
  short c;
  short yCur;
  short dxyPlus;
  
  if (fFrame != 0) {
    HVar1 = SelectObject(hdc,hbrButtonShadow);
    PatBlt(hdc,x,y,0x44,2,0xf00021);
    PatBlt(hdc,x,y,2,0x44,0xf00021);
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,x + 2,y + 0x42,0x42,1,0xf00021);
    PatBlt(hdc,x + 3,y + 0x42,0x41,1,0xf00021);
    PatBlt(hdc,x + 0x42,y + 2,1,0x40,0xf00021);
    PatBlt(hdc,x + 0x43,y + 1,1,0x41,0xf00021);
    SelectObject(hdc,HVar1);
    x = x + 2;
    y = y + 2;
  }
  if (ibmp < 0) {
    sVar4 = IshdefPrimaryFromLpfl(lpfl,&cDiff);
    iVar2 = ((FLEET *)lpfl)->iPlayer * 4;
    ibmp = *(short *)(*(int *)(iVar2 + 0xfe) + sVar4 * 0x93 + 0x32);
  }
  uVar5 = ibmp % 0x94;
  SelectPalette(hdc,vhpal,0);
  RealizePalette(hdc);
  if (fShrink == 0) {
    DibBlt(hdc,x,y,0x40,0x40,((ushort *)rghdibShips)[(int)uVar5 >> 5],
                    ((int)(uVar5 & 0x1f) >> 2) << 6,(3 - (uVar5 & 3)) * 0x40,0x40,0x40,0xcc0020);
    dxy = 0x40;
    dxyPlus = 8;
    dxyPlusWidth = 2;
    if (-1 < ibmpRace) {
      DibBlt(hdc,x,y + 0x30,0x10,0x10,hdibRacesT,(ibmpRace & 7U) << 4,
                      (3 - ((int)(ibmpRace & 0x1fU) >> 3)) * 0x10,0x10,0x10,0xcc0020);
    }
  }
  else {
    DibBlt(hdc,x,y,0x20,0x20,((ushort *)rghdibShipsT)[(int)uVar5 >> 5],
                    ((int)(uVar5 & 0x1f) >> 2) << 5,(3 - (uVar5 & 3)) * 0x20,0x20,0x20,0xcc0020);
    dxy = 0x20;
    dxyPlus = 5;
    dxyPlusWidth = 1;
    if (-1 < ibmpRace) {
      DibBlt(hdc,x,y + 0x18,8,8,hdibRacesX,(ibmpRace & 7U) << 3,
                      (3 - ((int)(ibmpRace & 0x1fU) >> 3)) * 8,8,8,0xcc0020);
    }
  }
  if ((csh == 0) || (fShrink != 0)) {
    if (4 < cDiff) {
      cDiff = 4;
    }
    cDiff = cDiff + -1;
    for (i = 0; i < cDiff; i = i + 1) {
      if ((i & 1U) == (uint)((i & 2U) == 2)) {
        iVar2 = x + 2;
      }
      else {
        iVar2 = (x + dxy + -2) - dxyPlus;
      }
      if ((i & 2U) == 0) {
        iVar3 = y + 2;
      }
      else {
        iVar3 = (y + dxy + -2) - dxyPlus;
      }
      PatBlt(hdc,iVar2,(dxyPlus + -1) / 2 + iVar3,dxyPlus,dxyPlusWidth,0xff0062);
      PatBlt(hdc,(dxyPlus + -1) / 2 + iVar2,iVar3,dxyPlusWidth,dxyPlus,0xff0062);
    }
  }
  else {
    SelectObject(hdc,rghfontArial7[0]);
    SetTextColor(hdc,0xffffff);
    if (1 < cDiff) {
      sVar4 = _wsprintf(szWork,PCTD,cDiff);
      TextOut(hdc,x + 1,y + 1,szWork,sVar4);
    }
    if (1 < csh) {
      sVar4 = _wsprintf(szWork,PCTD,csh);
      DVar6 = GetTextExtent(hdc,szWork,sVar4);
      TextOut(hdc,(x + dxy + -1) - (int)DVar6,y + 1,szWork,sVar4);
    }
  }
  return;
}



// ======================================================================
// Function: FEnumCalcJettison
// Address: 1050:4df4
// Segment: MEMORY_SHIP
// ======================================================================


short FEnumCalcJettison(void *lprt,short rt,short cb,PLANET *lppl,short iFleet)

{
  uint *puVar1;
  uint uVar2;
  void *pvVar3;
  void *pvVar4;
  short sVar5;
  uint uVar6;
  RTXFER *prtxfer;
  void *prtxferx;
  undefined2 local_8c;
  short j;
  FLEET fl;
  short grbit;
  short i;
  int pt;
  int local_6;
  
  if ((rt == 1) || (rt == 2)) {
    pvVar3 = (void *)lprt;
    if (((*(byte *)((int)pvVar3 + 4) & 0xf) == 2) &&
       (((int)(uint)*(byte *)((int)pvVar3 + 4) >> 4 == 4 &&
        (sVar5 = FLookupFleet(iFleet,&fl), sVar5 != 0)))) {
      pt = fl.pt.x;
      local_6 = fl.pt.y;
      sVar5 = FLookupFleet(*lprt,&fl);
      if ((sVar5 != 0) && ((fl.pt.x == pt && (fl.pt.y == local_6)))) {
        grbit = (short)*(byte *)((int)pvVar3 + 5);
        pvVar4 = lprt;
        if (rt != 2) {
          pvVar4 = (void *)CONCAT22(local_8c,prtxferx);
        }
        local_8c = (undefined2)((ulong)pvVar4 >> 0x10);
        prtxferx = (void *)pvVar4;
        j = 0;
        for (i = 0; i < 5; i = i + 1) {
          if ((grbit & 1U) != 0) {
            if (rt == 1) {
              uVar6 = (uint)*(char *)((int)pvVar3 + j + 6);
              puVar1 = (uint *)(((PLANET *)lppl)->rgwtMin + i);
              uVar2 = *puVar1;
              *puVar1 = *puVar1 - uVar6;
              puVar1 = (uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
              *puVar1 = (*puVar1 - ((int)uVar6 >> 0xf)) - (uint)(uVar2 < uVar6);
            }
            else {
              uVar6 = *(uint *)((int)prtxferx + j * 2 + 6);
              puVar1 = (uint *)(((PLANET *)lppl)->rgwtMin + i);
              uVar2 = *puVar1;
              *puVar1 = *puVar1 - uVar6;
              puVar1 = (uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
              *puVar1 = (*puVar1 - ((int)uVar6 >> 0xf)) - (uint)(uVar2 < uVar6);
            }
            j = j + 1;
          }
          grbit = grbit >> 1;
        }
      }
    }
  }
  return 1;
}



// ======================================================================
// Function: TransferStuff
// Address: 1050:4faa
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Type propagation algorithm not settling */

short TransferStuff(short id1,short grobj1,short id2,short grobj2,short mdXfer)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  short sVar3;
  int iVar4;
  undefined2 *puVar5;
  FLEET *pFVar6;
  FLEET *pFVar7;
  undefined2 unaff_SS;
  RECT rc;
  POINT pt;
  BTN rgbtn [32];
  short j;
  short grbit;
  short fSuccess;
  FLEET *lpfl;
  short i;
  short iDelFleet;
  int lPopPrev;
  int local_12a;
  short rgValidHull [16];
  FARPROC lpProcXfer;
  undefined1 xfer [4];
  FLEET local_100;
  short local_84;
  short local_82;
  FLEET local_80;
  
  lPopPrev = -1;
  local_12a = -1;
  xfer._0_2_ = id1;
  xfer._2_2_ = grobj1;
  local_84 = id2;
  local_82 = grobj2;
  pxfer = xfer;
  mdXferDlg = mdXfer;
  for (i = 0; i < 2; i = i + 1) {
    if (*(int *)((int)&local_100 + i * 0x80 + -2) == 4) {
      if (mdXfer == 1) {
        lpfl = LpflNewSplit(&local_100);
        pFVar6 = (FLEET *)lpfl;
        pFVar7 = &local_80;
        for (iVar4 = 0x3e; iVar4 != 0; iVar4 = iVar4 + -1) {
          pFVar2 = pFVar7;
          pFVar7 = &pFVar7->iPlayer;
          pFVar1 = pFVar6;
          pFVar6 = &pFVar6->iPlayer;
          pFVar2->id = pFVar1->id;
        }
        local_84 = lpfl->id;
        local_82 = 2;
      }
      else {
        *(undefined2 *)((int)&local_100 + i * 0x80) = 0xffff;
        for (j = 0; j < 4; j = j + 1) {
          puVar5 = (undefined2 *)((int)&local_100 + j * 4 + i * 0x80 + 0x1c);
          *puVar5 = 0;
          puVar5[1] = 0;
        }
        EnumLogRts(FEnumCalcJettison,(void *)((int)&local_100 + i * 0x80),id1);
      }
    }
    else {
      sVar3 = FLookupObject(*(GrobjClass *)((int)&local_100 + i * 0x80 + -2),
                                  *(short *)(xfer + i * 0x80),(void *)((int)&local_100 + i * 0x80));
      if (sVar3 == 0) {
        return 0;
      }
      if (*(int *)((int)&local_100 + i * 0x80 + -2) == 1) {
        lPopPrev = *(int *)((int)&local_100 + i * 0x80 + 0x28);
        local_12a = *(int *)((int)&local_100 + i * 0x80 + 0x2a);
      }
    }
  }
  if (mdXfer == 1) {
    cXferValidHulls = 0;
    for (i = 0; i < 0x10; i = i + 1) {
      if ((local_100.rgcsh[i] != 0) || ((local_82 == 2 && (local_80.rgcsh[i] != 0)))) {
        rgValidHull[cXferValidHulls] = i;
        cXferValidHulls = cXferValidHulls + 1;
      }
    }
    rgXferValidHulls = rgValidHull;
  }
  rgbtnXfer = rgbtn;
  crgbtnXfer = 0x20;
  if (((uint)gd.grBits >> 0xb & 1) != 0) {
    AdvanceTutor();
  }
  lpProcXfer = MakeProcInstance(TransferDlg,hInst);
  fSuccess = DialogBox(0,(LPCSTR)CONCAT22(0x5b,hwndFrame),
                       (HWND)((ulong)lpProcXfer >> 0x10),(char)lpProcXfer);
  FreeProcInstance(lpProcXfer);
  if (fSuccess == 0) {
    if (mdXfer != 1) {
      mdXferDlg = -1;
      return 0;
    }
    if (grobj2 != 4) {
      mdXferDlg = -1;
      return 0;
    }
SHIP_CancelSplit:
    FDeleteFleet(local_80.id,0,0);
    CancelMemRt(0x18);
  }
  else {
    iDelFleet = -1;
    if (mdXfer == 1) {
      for (i = 0; (i < 0x10 && (local_80.rgcsh[i] < 1)); i = i + 1) {
      }
      if ((i == 0x10) && (grobj2 == 4)) goto SHIP_CancelSplit;
      FleetTransferCargoBalance(&local_100,&local_80);
    }
    for (i = 0; i < 2; i = i + 1) {
      if ((*(int *)((int)&local_100 + i * 0x80 + -2) == 1) ||
         (*(int *)((int)&local_100 + i * 0x80 + -2) == 4)) {
        FLookupPlanet(-1,(PLANET *)((int)&local_100 + i * 0x80));
        if ((*(int *)((int)&local_100 + i * 0x80 + -2) == 1) &&
           ((lPopPrev == *(int *)((int)&local_100 + i * 0x80 + 0x28) &&
            (local_12a == *(int *)((int)&local_100 + i * 0x80 + 0x2a))))) {
          lPopPrev = -1;
          local_12a = -1;
        }
      }
      else if (*(int *)((int)&local_100 + i * 0x80 + -2) == 2) {
        FLookupFleet(-1,(FLEET *)((int)&local_100 + i * 0x80));
        if (mdXfer == 1) {
          j = 0;
          while ((j < 0x10 && (*(int *)((int)&local_100 + j * 2 + i * 0x80 + 0xc) == 0))) {
            j = j + 1;
          }
          if (j == 0x10) {
            iDelFleet = i;
          }
        }
      }
      else if (*(int *)((int)&local_100 + i * 0x80 + -2) == 8) {
        FLookupThing(-1,(THING *)((int)&local_100 + i * 0x80));
      }
    }
    if (iDelFleet != -1) {
      FDeleteFleet(*(short *)((int)&local_100 + iDelFleet * 0x80),2,
                         *(short *)((int)&local_100 + (uint)(iDelFleet == 0) * 0x80));
    }
    if (mdXfer == 1) {
      FillShipDD(sel.fl.id);
      if ((grbitScan & 0x80) != 0) {
        InvalidateRect(hwndScanner,(RECT *)0x0,1);
      }
    }
    if (sel.grobj == grobjPlanet) {
      grbit = -0x7fb3;
      FLookupPlanet(sel.pl.id,(PLANET *)&sel.pl);
      FillPlanetProdLB(0,(PLPROD *)0x0,(PLANET *)0x0);
    }
    else {
      grbit = -0x7c4b;
      FLookupFleet(sel.fl.id,(FLEET *)&sel.fl);
      FillFleetCompLB();
    }
    DrawPlanShip(0,grbit);
    if (sel.scan.grobj == grobjFleet) {
      InvalidateRect(hwndMine,(RECT *)0x0,1);
    }
    else {
      InvalidateMineralBars();
    }
    if ((lPopPrev != -1) || (local_12a != -1)) {
      sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
      if ((sVar3 == raMacintosh) && ((grbitScan & 0x20) != 0)) {
        InvalidateRect(hwndScanner,(RECT *)0x0,0);
        mdXferDlg = -1;
        return 0;
      }
    }
    if ((((lPopPrev != -1) || (local_12a != -1)) && ((grbitScan & 0xf) == 4)) ||
       ((grbitScan & 0xf) == 1)) {
      pt.x = sel.pt.x;
      pt.y = sel.pt.y;
      LogicalToScan(&pt);
      rc.right = pt.x;
      rc.bottom = pt.y;
      rc.left = pt.x;
      rc.top = pt.y;
      InflateRect(&rc,0x14,0x14);
      rc.top = rc.top + -0x14;
      InvalidateRect(hwndScanner,&rc,0);
    }
  }
  mdXferDlg = -1;
  return 0;
}



// ======================================================================
// Function: TransferDlg
// Address: 1050:5686
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short TransferDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char *pcVar1;
  short sVar2;
  uint uVar3;
  ushort unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar4;
  HWND HVar5;
  RECT rc;
  short dx;
  RECT rcBtn;
  HWND hwndBtn;
  POINT pt;
  PAINTSTRUCT ps;
  short dyMore;
  HDC hdc;
  
  if (message == WM_PAINT) {
    hdc = BeginPaint(hwnd,&ps);
    GetClientRect(hwnd,&rc);
    DrawXferDlg(hwnd,hdc,&rc,-1);
    EndPaint(hwnd,&ps);
    sVar2 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    sVar2 = 1;
  }
  else if (message == WM_INITDIALOG) {
    StickyDlgPos(hwnd,(POINT *)&ptStickyTransferDlg,1);
    GetClientRect(hwnd,&rc);
    if (mdXferDlg == 1) {
      HVar5 = hwnd;
      pcVar1 = PszGetCompressedString(idsShipTransfer);
      SetWindowText(HVar5,pcVar1);
      if (10 < cXferValidHulls) {
        dyMore = rc.bottom / 2;
        rc.bottom = rc.bottom + dyMore;
        SetWindowPos(hwnd,0,0,0,rc.right,rc.bottom,6);
        GetClientRect(hwnd,&rc);
        sVar2 = GetSystemMetrics(4);
        dyMore = dyMore - (sVar2 + 2);
        sVar2 = GetSystemMetrics(7);
        dx = sVar2 + 4;
        hwndBtn = GetDlgItem(hwnd,1);
        GetWindowRect(hwndBtn,&rcBtn);
        pt.x = rcBtn.left;
        pt.y = rcBtn.top;
        ScreenToClient(hwnd,&pt);
        pt.y = pt.y + dyMore;
        pt.x = pt.x - dx;
        SetWindowPos(hwndBtn,0,pt.x,pt.y,0,0,1);
        hwndBtn = GetDlgItem(hwnd,0x76);
        GetWindowRect(hwndBtn,&rcBtn);
        pt.x = rcBtn.left;
        pt.y = rcBtn.top;
        ScreenToClient(hwnd,&pt);
        pt.y = pt.y + dyMore;
        pt.x = pt.x - dx;
        SetWindowPos(hwndBtn,0,pt.x,pt.y,0,0,1);
        hwndBtn = GetDlgItem(hwnd,2);
        GetWindowRect(hwndBtn,&rcBtn);
        pt.x = rcBtn.left;
        pt.y = rcBtn.top;
        ScreenToClient(hwnd,&pt);
        pt.y = pt.y + dyMore;
        pt.x = pt.x - dx;
        SetWindowPos(hwndBtn,0,pt.x,pt.y,0,0,1);
      }
    }
    FSetupXferBtns(&rc);
    if (((uint)gd.grBits >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    sVar2 = 1;
  }
  else {
    if (message == WM_COMMAND) {
      if ((wParam == 1) || (wParam == 2)) {
        StickyDlgPos(hwnd,(POINT *)&ptStickyTransferDlg,0);
        EndDialog(hwnd,(uint)(wParam == 1));
        if (((uint)gd.grBits >> 0xb & 1) != 0) {
          AdvanceTutor();
        }
        return 1;
      }
      if (wParam == 0x76) {
        if (mdXferDlg == 1) {
          uVar3 = 0x438;
        }
        else {
          uVar3 = 0x433;
        }
        WinHelp(hwnd,_szHelpFile,1,(ulong)uVar3);
        return 1;
      }
    }
    else if ((message == WM_LBUTTONDOWN) || (message == WM_LBUTTONDBLCLK)) {
      uVar4 = __aFulshr(CONCAT22(unaff_DI,wParam),unaff_SI);
      sVar2 = FTrackXfer(hwnd,(short)lParam,(short)uVar4,wParam);
      return sVar2;
    }
    sVar2 = 0;
  }
  return sVar2;
}



// ======================================================================
// Function: FTrackXfer
// Address: 1050:5a16
// Segment: MEMORY_SHIP
// ======================================================================


short FTrackXfer(HWND hwnd,short x,short y,short fkb)

{
  int *piVar1;
  BTN *pBVar2;
  RECT *pRVar3;
  POINT PVar4;
  BOOL BVar5;
  short sVar6;
  int iVar7;
  int iVar8;
  BTN *pBVar9;
  RECT *pRVar10;
  undefined2 unaff_SS;
  ulong uVar11;
  long lVar12;
  long lVar13;
  RECT btn;
  short local_38;
  uint local_36;
  uint local_34;
  short iVal;
  short iBtn;
  short i;
  undefined4 cCur;
  BTNT btnt;
  undefined4 dChg;
  POINT pt;
  int ptOld;
  int local_6;
  
  GetClientRect(hwnd,&stack0xffb4);
  pt.x = x;
  pt.y = y;
  i = 0;
  while ((i < crgbtnXfer &&
         (((rgbtnXfer[i].bt & 4U) != 0 ||
          (PVar4.y = pt.y, PVar4.x = pt.x, BVar5 = PtInRect((RECT *)(rgbtnXfer + i),PVar4)
          , BVar5 == 0))))) {
    i = i + 1;
  }
  if (i == crgbtnXfer) {
    return 0;
  }
  iBtn = i >> 1;
  pBVar9 = rgbtnXfer + i;
  pRVar10 = &btn;
  iVar7 = 7;
  while( true ) {
    if (iVar7 == 0) break;
    iVar7 = iVar7 + -1;
    pRVar3 = pRVar10;
    pRVar10 = &pRVar10->top;
    pBVar2 = pBVar9;
    pBVar9 = &(pBVar9->rc).top;
    pRVar3->left = (pBVar2->rc).left;
  }
  iVal = local_36 & 0x7f;
  if ((local_34 & 1) == 0) {
    cCur = CONCAT22(cCur._2_2_,(undefined2)cCur);
    dChg = CONCAT22(dChg._2_2_,(int)dChg);
    if ((uint)iVal < 5) {
      if (pxfer[1].grobj == grobjThing) {
        cCur = CONCAT22(cCur._2_2_,(undefined2)cCur);
        dChg = CONCAT22(dChg._2_2_,(int)dChg);
        if ((iVal == 4) || (iVal == 3)) goto SHIP_FinishUp_4;
      }
      else {
        cCur = CONCAT22(cCur._2_2_,(undefined2)cCur);
        dChg = CONCAT22(dChg._2_2_,(int)dChg);
        if (*(int *)((int)&pxfer[local_34 >> 2 & 3].u_XFER_0x0004 + 2) != idPlayer)
        goto SHIP_FinishUp_4;
      }
      SetCapture(hwnd);
      local_6 = -1;
      ptOld = -1;
      while( true ) {
        sVar6 = FGetMouseMove(&pt);
        if (sVar6 == 0) break;
        if ((pt.x != ptOld) || (pt.y != local_6)) {
          ptOld = pt.x;
          local_6 = pt.y;
          if (((local_34 >> 2 & 3) == 1) && (pxfer[1].grobj == grobjThing)) {
            uVar11 = __aFulmul((ulong)(*(uint *)((int)&pxfer[1].u_XFER_0x0004 +
                                                        0xe) & 0x3fff),10);
          }
          else if (iVal == 4) {
            uVar11 = LGetFleetStat(&(&pxfer[local_34 >> 2 & 3].u_XFER_0x0004)->fl,
                                   grStatFuel);
          }
          else {
            uVar11 = LGetFleetStat(&(&pxfer[local_34 >> 2 & 3].u_XFER_0x0004)->fl,
                                   grStatCargo);
          }
          iVar7 = (btn.right - btn.left) + -2;
          iVar8 = iVar7 >> 0xf;
          uVar11 = __aFulmul((long)(pt.x - btn.left),uVar11);
          lVar13 = __aFldiv(uVar11,CONCAT22(iVar8,iVar7));
          lVar12 = ChgCargo(pxfer[local_34 >> 2 & 3].grobj,
                            (pxfer + (local_34 >> 2 & 3))->id,iVal,0,
                            &pxfer[local_34 >> 2 & 3].u_XFER_0x0004);
          dChg = lVar13 - lVar12;
          lVar13 = dChg;
          if ((local_34 >> 2 & 3) != 0) {
            lVar13 = CONCAT22(-((int)((ulong)dChg >> 0x10) + (uint)((int)dChg != 0)),-(int)dChg);
          }
          cCur = lVar12;
          lVar13 = XferSupply(iVal,lVar13);
          if (lVar13 != 0) {
            DrawXferDlg(hwnd,0,&stack0xffb4,iVal);
          }
        }
      }
      ReleaseCapture();
    }
  }
  else {
    InitBtnTrack(&btnt,hwnd,0,&btn,local_38,0x50,0,0,(char *)0x0);
    if ((fkb & 8U) == 0) {
      if ((fkb & 4U) == 0) {
        dChg._0_2_ = 1;
        dChg._2_2_ = 0;
      }
      else {
        dChg._0_2_ = 10;
        dChg._2_2_ = 0;
      }
    }
    else {
      if ((fkb & 4U) == 0) {
        dChg._0_2_ = 100;
      }
      else {
        dChg._0_2_ = 1000;
      }
      dChg._2_2_ = 0;
    }
    while( true ) {
      sVar6 = FTrackBtn(&btnt);
      if (sVar6 == 0) break;
      if (mdXferDlg == 1) {
        i = (int)dChg;
        if (*(int *)((int)&pxfer[(local_34 >> 2 & 3) == 0].u_XFER_0x0004 + iVal * 2 + 0xc)
            <= (int)dChg) {
          i = *(int *)((int)&pxfer[(local_34 >> 2 & 3) == 0].u_XFER_0x0004 +
                      iVal * 2 + 0xc);
        }
        if (i != 0) {
          if (0x7ffe - i <=
              *(int *)((int)&pxfer[local_34 >> 2 & 3].u_XFER_0x0004 + iVal * 2 + 0xc)) {
            i = 1;
          }
          piVar1 = (int *)((int)&pxfer[local_34 >> 2 & 3].u_XFER_0x0004 + iVal * 2 + 0xc);
          *piVar1 = *piVar1 + i;
          piVar1 = (int *)((int)&pxfer[(local_34 >> 2 & 3) == 0].u_XFER_0x0004 +
                          iVal * 2 + 0xc);
          *piVar1 = *piVar1 - i;
          DrawXferDlg(hwnd,btnt.hdc,&stack0xffb4,iBtn);
        }
      }
      else if ((-1 < iVal) && (iVal < 5)) {
        iVar7 = (int)dChg;
        iVar8 = dChg._2_2_;
        if ((local_34 >> 2 & 3) != 0) {
          iVar7 = -(int)dChg;
          iVar8 = -(dChg._2_2_ + (uint)((int)dChg != 0));
        }
        lVar13 = XferSupply(iVal,CONCAT22(iVar8,iVar7));
        if (lVar13 != 0) {
          DrawXferDlg(hwnd,btnt.hdc,&stack0xffb4,iVal);
        }
      }
    }
  }
SHIP_FinishUp_4:
  UpdateXferBtns();
  DrawXferDlg(hwnd,0,&stack0xffb4,-2);
  return 1;
}



// ======================================================================
// Function: GetCargoFree
// Address: 1050:5f98
// Segment: MEMORY_SHIP
// ======================================================================


long GetCargoFree(FLEET *lpfl)

{
  uint uVar1;
  bool bVar2;
  long lVar3;
  short i;
  uint cHave;
  int local_6;
  
  cHave = 0;
  local_6 = 0;
  for (i = 0; i < 4; i = i + 1) {
    uVar1 = *(uint *)(((FLEET *)lpfl)->rgwtMin + i);
    bVar2 = CARRY2(cHave,uVar1);
    cHave = cHave + uVar1;
    local_6 = local_6 + *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) + (uint)bVar2;
  }
  lVar3 = LGetFleetStat(lpfl,grStatCargo);
  return lVar3 - CONCAT22(local_6,cHave);
}



// ======================================================================
// Function: GetFuelFree
// Address: 1050:6004
// Segment: MEMORY_SHIP
// ======================================================================


long GetFuelFree(FLEET *lpfl)

{
  long lVar1;
  
  lVar1 = LGetFleetStat(lpfl,grStatFuel);
  return CONCAT22(((int)((ulong)lVar1 >> 0x10) - *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0x12)) -
                  (uint)((uint)lVar1 < *(uint *)(((FLEET *)lpfl)->rgwtMin + 4)),
                  (uint)lVar1 - *(uint *)(((FLEET *)lpfl)->rgwtMin + 4));
}



// ======================================================================
// Function: ChgCargo
// Address: 1050:6034
// Segment: MEMORY_SHIP
// ======================================================================


long ChgCargo(GrobjClass grobj,short id,short iSupply,long dChg,void *pobj)

{
  uint *puVar1;
  uint uVar2;
  int iVar3;
  ulong uVar4;
  long lVar5;
  PLANET *ppl;
  FLEET *pfl;
  short i;
  FLEET local_82;
  THING *pth;
  
  if ((grobj == grobjPlanet) || (grobj == grobjOther)) {
    if (pobj == (void *)0x0) {
      if (grobj == grobjPlanet) {
        FLookupPlanet(id,&local_82);
        ppl = &local_82;
      }
      else {
        _memset(&local_82,0,0x38);
        ppl = &local_82;
      }
    }
    else {
      ppl = pobj;
    }
    if (iSupply < 5) {
      if (iSupply == 4) {
        dChg._0_2_ = 0;
        dChg._2_2_ = 0;
        goto LAB_1050_64c6;
      }
      if (dChg == 0) {
        dChg._0_2_ = (uint)ppl->rgwtMin[iSupply];
        dChg._2_2_ = *(int *)((int)(ppl->rgwtMin + iSupply) + 2);
        goto LAB_1050_64c6;
      }
      iVar3 = *(uint *)((int)(ppl->rgwtMin + iSupply) + 2) + dChg._2_2_ +
              (uint)CARRY2(*(uint *)(ppl->rgwtMin + iSupply),(uint)dChg);
      if ((iVar3 < 1) && (iVar3 < 0)) {
        iVar3 = (int)ppl->rgwtMin[iSupply];
        dChg = CONCAT22(-(*(int *)((int)(ppl->rgwtMin + iSupply) + 2) + (uint)(iVar3 != 0)),-iVar3);
      }
      puVar1 = (uint *)(ppl->rgwtMin + iSupply);
      uVar2 = *puVar1;
      *puVar1 = *puVar1 + (uint)dChg;
      puVar1 = (uint *)((int)(ppl->rgwtMin + iSupply) + 2);
      *puVar1 = *puVar1 + dChg._2_2_ + (uint)CARRY2(uVar2,(uint)dChg);
    }
    if (((((uint)dChg != 0) || (dChg._2_2_ != 0)) && (pobj == (void *)0x0)) && (grobj != grobjOther)
       ) {
      FLookupPlanet(-1,&local_82);
    }
  }
  else if (grobj == grobjThing) {
    if (pobj == (void *)0x0) {
      FLookupThing(id,&local_82);
      pth = &local_82;
    }
    else {
      pth = pobj;
    }
    if (2 < iSupply) {
      dChg._0_2_ = 0;
      dChg._2_2_ = 0;
      goto LAB_1050_64c6;
    }
    if (iSupply < 5) {
      if (dChg == 0) {
        dChg._0_2_ = *(uint *)((pth->u_THING_0x0006).rgb + iSupply * 2 + 2);
        dChg._2_2_ = (int)(uint)dChg >> 0xf;
        goto LAB_1050_64c6;
      }
      iVar3 = ((int)*(uint *)((pth->u_THING_0x0006).rgb + iSupply * 2 + 2) >> 0xf) + dChg._2_2_ +
              (uint)CARRY2(*(uint *)((pth->u_THING_0x0006).rgb + iSupply * 2 + 2),(uint)dChg);
      if ((iVar3 < 1) && (iVar3 < 0)) {
        dChg = (long)-*(int *)((pth->u_THING_0x0006).rgb + iSupply * 2 + 2);
      }
      uVar4 = __aFulmul((ulong)*(uint *)((int)&pth->u_THING_0x0006 + 8) & 0xffff3fff,10);
      i = 0;
      while( true ) {
        iVar3 = (int)(uVar4 >> 0x10);
        if (2 < i) break;
        uVar4 = uVar4 - (long)*(int *)((pth->u_THING_0x0006).rgb + i * 2 + 2);
        i = i + 1;
      }
      if ((iVar3 <= dChg._2_2_) && ((iVar3 < dChg._2_2_ || ((uint)uVar4 < (uint)dChg)))) {
        dChg = uVar4;
      }
      *(uint *)((pth->u_THING_0x0006).rgb + iSupply * 2 + 2) =
           *(int *)((pth->u_THING_0x0006).rgb + iSupply * 2 + 2) + (uint)dChg;
    }
    if ((((uint)dChg != 0) || (dChg._2_2_ != 0)) && (pobj == (void *)0x0)) {
      FLookupThing(-1,pth);
    }
  }
  else {
    if (pobj == (void *)0x0) {
      FLookupFleet(id,&local_82);
      pfl = &local_82;
    }
    else {
      pfl = pobj;
    }
    if (iSupply < 5) {
      if (dChg == 0) {
        dChg._0_2_ = (uint)pfl->rgwtMin[iSupply];
        dChg._2_2_ = *(int *)((int)(pfl->rgwtMin + iSupply) + 2);
        goto LAB_1050_64c6;
      }
      iVar3 = *(uint *)((int)(pfl->rgwtMin + iSupply) + 2) + dChg._2_2_ +
              (uint)CARRY2(*(uint *)(pfl->rgwtMin + iSupply),(uint)dChg);
      if ((iVar3 < 1) && (iVar3 < 0)) {
        iVar3 = (int)pfl->rgwtMin[iSupply];
        dChg = CONCAT22(-(*(int *)((int)(pfl->rgwtMin + iSupply) + 2) + (uint)(iVar3 != 0)),-iVar3);
      }
      if ((iSupply == 3) && ((pfl->wFlags_0x4 & 0xff) != 7)) {
        dChg = 0;
      }
      if (iSupply == 4) {
        lVar5 = GetFuelFree(pfl);
      }
      else {
        lVar5 = GetCargoFree(pfl);
      }
      iVar3 = (int)((ulong)lVar5 >> 0x10);
      if ((iVar3 < dChg._2_2_) || ((iVar3 <= dChg._2_2_ && ((uint)lVar5 <= (uint)dChg)))) {
        if (iSupply == 4) {
          dChg = GetFuelFree(pfl);
        }
        else {
          dChg = GetCargoFree(pfl);
        }
      }
      puVar1 = (uint *)(pfl->rgwtMin + iSupply);
      uVar2 = *puVar1;
      *puVar1 = *puVar1 + (uint)dChg;
      puVar1 = (uint *)((int)(pfl->rgwtMin + iSupply) + 2);
      *puVar1 = *puVar1 + (int)((ulong)dChg >> 0x10) + (uint)CARRY2(uVar2,(uint)dChg);
    }
    if ((((uint)dChg != 0) || (dChg._2_2_ != 0)) && (pobj == (void *)0x0)) {
      FLookupFleet(-1,pfl);
    }
  }
LAB_1050_64c6:
  return CONCAT22(dChg._2_2_,(uint)dChg);
}



// ======================================================================
// Function: XferSupply
// Address: 1050:64cc
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Variable defined which should be unmapped: iSrc */
/* WARNING: Removing unreachable block (ram,0x105064fe) */

long XferSupply(short iSupply,long cQuan)

{
  uint uVar1;
  int iVar2;
  long lVar3;
  undefined2 uVar4;
  undefined2 uVar5;
  short iSrc;
  
  if (cQuan == 0) {
    lVar3 = 0;
  }
  else {
    uVar1 = (uint)(0 < cQuan);
    if (uVar1 == 0) {
      cQuan = CONCAT22(-(cQuan._2_2_ + (uint)((uint)cQuan != 0)),-(uint)cQuan);
    }
    lVar3 = ChgCargo(pxfer[uVar1].grobj,(pxfer + uVar1)->id,iSupply,0,
                     &pxfer[uVar1].u_XFER_0x0004);
    iVar2 = (int)((ulong)lVar3 >> 0x10);
    if ((iVar2 <= cQuan._2_2_) && ((iVar2 < cQuan._2_2_ || ((uint)lVar3 < (uint)cQuan)))) {
      cQuan = lVar3;
    }
    if (((uint)cQuan == 0) && (cQuan._2_2_ == 0)) {
      lVar3 = 0;
    }
    else {
      lVar3 = ChgCargo(pxfer[uVar1 == 0].grobj,(pxfer + (uVar1 == 0))->id,
                       iSupply,cQuan,&pxfer[uVar1 == 0].u_XFER_0x0004);
      if (lVar3 == 0) {
        lVar3 = 0;
      }
      else {
        uVar5 = 0x1050;
        uVar4 = 0x6696;
        ChgCargo(pxfer[uVar1].grobj,(pxfer + uVar1)->id,
                 (short)&pxfer[uVar1].u_XFER_0x0004,
                 CONCAT22(-((int)((ulong)lVar3 >> 0x10) + (uint)((int)lVar3 != 0)),-(int)lVar3),
                 &pxfer[uVar1].u_XFER_0x0004);
        lVar3 = CONCAT22(uVar5,uVar4);
      }
    }
  }
  return lVar3;
}



// ======================================================================
// Function: UpdateXferBtns
// Address: 1050:66a8
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Variable defined which should be unmapped: iVal */

void UpdateXferBtns(void)

{
  u_XFER_0x0004 *iSupply;
  uint uVar1;
  long lVar2;
  int lLeft;
  int local_e;
  short iVal;
  short iLastButton;
  short i;
  short iSide;
  
  if (mdXferDlg == 1) {
    uVar1 = cXferValidHulls << 1;
  }
  else {
    uVar1 = 4;
  }
  _iVal = (u_XFER_0x0004 *)((ulong)uVar1 << 0x10);
  for (i = 0; i < crgbtnXfer; i = i + 1) {
    iSupply = (u_XFER_0x0004 *)rgbtnXfer[i].iVal;
    _iVal = (u_XFER_0x0004 *)CONCAT22(iLastButton,iSupply);
    if (((rgbtnXfer[i].wFlags_0xc & 1) != 0) &&
       (((int)iSupply <= iLastButton || (mdXferDlg == 1)))) {
      uVar1 = rgbtnXfer[i].wFlags_0xc >> 2 & 3;
      if (mdXferDlg == 1) {
        if (*(int *)((int)&pxfer[uVar1].u_XFER_0x0004 + (int)iSupply * 2 + 0xc) == 0x7ffe)
        {
          lLeft = 0;
          local_e = 0;
        }
        else {
          lLeft = *(int *)((int)&pxfer[uVar1 == 0].u_XFER_0x0004 + (int)iSupply * 2 + 0xc)
          ;
          local_e = lLeft >> 0xf;
        }
        lVar2 = CONCAT22(local_e,lLeft);
      }
      else {
        lVar2 = ChgCargo(pxfer[uVar1 == 0].grobj,(pxfer + (uVar1 == 0))->id,
                         (short)iSupply,0,&pxfer[uVar1 == 0].u_XFER_0x0004);
        if ((lVar2 == 0) || (pxfer[uVar1].grobj != grobjFleet)) {
          if ((pxfer[uVar1].grobj == grobjPlanet) && (iSupply == (u_XFER_0x0004 *)0x4)) {
            lVar2 = 0;
          }
        }
        else if (iSupply == (u_XFER_0x0004 *)0x4) {
          _iVal = &pxfer[uVar1].u_XFER_0x0004;
          lVar2 = GetFuelFree(&_iVal->fl);
        }
        else {
          _iVal = &pxfer[uVar1].u_XFER_0x0004;
          lVar2 = GetCargoFree(&_iVal->fl);
        }
      }
      if (lVar2 == 0) {
        rgbtnXfer[i].bt = rgbtnXfer[i].bt | 4;
      }
      else {
        rgbtnXfer[i].bt = rgbtnXfer[i].bt & 0xfffb;
      }
    }
  }
  return;
}



// ======================================================================
// Function: DrawXferDlg
// Address: 1050:6908
// Segment: MEMORY_SHIP
// ======================================================================


void DrawXferDlg(HWND hwnd,HDC hdc,RECT *prc,short iSupply)

{
  bool bVar1;
  short dxCtr;
  short i;
  short fCreatedDC;
  RECT rgrc [2];
  
  bVar1 = hdc == 0;
  if (bVar1) {
    hdc = GetDC(hwnd);
  }
  if (iSupply < 0) {
    PatBlt(hdc,prc->right >> 1,0,1,prc->bottom,0x42);
    for (i = 0; i < crgbtnXfer; i = i + 1) {
      if ((rgbtnXfer[i].wFlags_0xc & 1) != 0) {
        DrawBtn(hdc,&rgbtnXfer[i].rc,rgbtnXfer[i].bt,0,(char *)0x0);
      }
    }
    if (iSupply == -2) goto SHIP_RelDC;
  }
  GetXferLeftRightRcs(prc,rgrc,rgrc + 1);
  for (i = 0; i < 2; i = i + 1) {
    if (mdXferDlg == 1) {
      DrawFleetShipsXferSide(hdc,rgrc + i,&pxfer[i].u_XFER_0x0004.fl,iSupply);
    }
    else if (pxfer[i].grobj == grobjFleet) {
      DrawFleetCargoXferSide(hdc,rgrc + i,&pxfer[i].u_XFER_0x0004.fl,iSupply);
    }
    else if ((pxfer[i].grobj == grobjPlanet) || (pxfer[i].grobj == grobjOther))
    {
      DrawPlanetXferSide(hdc,rgrc + i,&pxfer[i].u_XFER_0x0004.pl,iSupply);
    }
    else if (pxfer[i].grobj == grobjThing) {
      DrawThingXferSide(hdc,rgrc + i,&pxfer[i].u_XFER_0x0004.th,iSupply);
    }
  }
SHIP_RelDC:
  if (bVar1) {
    ReleaseDC(hwnd,hdc);
  }
  return;
}



// ======================================================================
// Function: GetXferLeftRightRcs
// Address: 1050:6b46
// Segment: MEMORY_SHIP
// ======================================================================


void GetXferLeftRightRcs(RECT *prcWhole,RECT *prcLeft,RECT *prcRight)

{
  SetRect(prcLeft,0,0,prcWhole->right >> 1,prcWhole->bottom);
  ExpandRc(prcLeft,-4 - (dyArial8 + 3),-4);
  prcLeft->left = prcLeft->left - (dyArial8 + 1);
  SetRect(prcRight,prcWhole->right >> 1,0,prcWhole->right,prcWhole->bottom);
  ExpandRc(prcRight,-4 - (dyArial8 + 3),-4);
  prcRight->right = prcRight->right + dyArial8 + 1;
  return;
}



// ======================================================================
// Function: FSetupXferBtns
// Address: 1050:6bea
// Segment: MEMORY_SHIP
// ======================================================================


short FSetupXferBtns(RECT *prc)

{
  short sVar1;
  BTN *pBVar2;
  undefined2 unaff_SS;
  int rc;
  int local_34;
  int local_32;
  RECT rcLeft;
  RECT rcBtn;
  short dxLabels;
  RECT rcRight;
  short dxCtr;
  short j;
  short fThingXfer;
  short i;
  short iMin;
  short dy;
  short iMax;
  short cBtn;
  
  cBtn = 0;
  if (mdXferDlg == 1) {
    dxLabels = 0x8c;
  }
  else {
    dxLabels = 0x4b;
  }
  fThingXfer = (short)(pxfer[1].grobj == grobjThing);
  dxCtr = prc->right >> 1;
  dy = dyArial8 + 10;
  iMax = cXferValidHulls;
  if (mdXferDlg != 1) {
    iMax = 5;
    dy = dy + (dyArial8 + 6) * 2;
  }
  for (i = 0; i < iMax; i = i + 1) {
    if ((i == 4) && (mdXferDlg != 1)) {
      dy = dy + (dyArial8 + 6) * -6;
    }
    SetRect(&rcBtn,(dxCtr - (dyArial8 + 3)) + 1,dy,dxCtr + 1,dyArial8 + 3 + dy);
    for (j = 0; j < 2; j = j + 1) {
      pBVar2 = rgbtnXfer + cBtn;
      (pBVar2->rc).left = rcBtn.left;
      (pBVar2->rc).top = rcBtn.top;
      (pBVar2->rc).right = rcBtn.right;
      (pBVar2->rc).bottom = rcBtn.bottom;
      if (j == 0) {
        sVar1 = 2;
      }
      else {
        sVar1 = 3;
      }
      rgbtnXfer[cBtn].bt = sVar1;
      if ((fThingXfer == 0) || (i < 4)) {
        rgbtnXfer[cBtn].wFlags_0xc = rgbtnXfer[cBtn].wFlags_0xc & 0xfffe | 1;
      }
      else {
        rgbtnXfer[cBtn].wFlags_0xc = rgbtnXfer[cBtn].wFlags_0xc & 0xfffe;
        rgbtnXfer[cBtn].rc.bottom = -100;
      }
      rgbtnXfer[cBtn].wFlags_0xc =
           rgbtnXfer[cBtn].wFlags_0xc & 0xfff3 | (j & 3U) << 2;
      sVar1 = i;
      if (mdXferDlg == 1) {
        sVar1 = rgXferValidHulls[i];
      }
      rgbtnXfer[cBtn].iVal = sVar1;
      cBtn = cBtn + 1;
      OffsetRc(&rcBtn,dyArial8 + 2,0);
    }
    dy = dy + dyArial8 + 6;
  }
  GetXferLeftRightRcs(prc,&rcLeft,&rcRight);
  if (mdXferDlg != 1) {
    if (pxfer->grobj == grobjPlanet) {
      if (pxfer[1].grobj == grobjPlanet) goto SHIP_NoGauges;
      rc = rcRight.left;
      local_34 = rcRight.top;
      local_32 = rcRight.right;
      i = 1;
    }
    else {
      rc = rcLeft.left;
      local_34 = rcLeft.top;
      local_32 = rcLeft.right;
      i = 0;
    }
    for (; i < 2; i = i + 1) {
      SetRect(&rcBtn,rc + dxLabels + 10,local_34 + dyArial8 + 6,local_32 + -4,
              dyArial8 * 2 + local_34 + 6);
      if (mdXferDlg == 1) {
        iMax = cXferValidHulls;
      }
      else {
        iMax = 5;
      }
      iMin = 0;
      for (j = 0; j < iMax; j = j + 1) {
        if (mdXferDlg != 1) {
          if (j == 0) {
            OffsetRc(&rcBtn,0,(dyArial8 + 6) * 2);
          }
          else if (j == 4) {
            OffsetRc(&rcBtn,0,(dyArial8 + 6) * -6);
          }
        }
        pBVar2 = rgbtnXfer + cBtn;
        (pBVar2->rc).left = rcBtn.left;
        (pBVar2->rc).top = rcBtn.top;
        (pBVar2->rc).right = rcBtn.right;
        (pBVar2->rc).bottom = rcBtn.bottom;
        rgbtnXfer[cBtn].bt = 0;
        rgbtnXfer[cBtn].wFlags_0xc = rgbtnXfer[cBtn].wFlags_0xc & 0xfffe;
        rgbtnXfer[cBtn].wFlags_0xc =
             rgbtnXfer[cBtn].wFlags_0xc & 0xfff3 | (i & 3U) << 2;
        rgbtnXfer[cBtn].iVal = j + 0x80;
        cBtn = cBtn + 1;
        OffsetRc(&rcBtn,0,dyArial8 + 6);
      }
      if (pxfer[1].grobj == grobjPlanet) break;
      rc = rcRight.left;
      local_34 = rcRight.top;
      local_32 = rcRight.right;
    }
  }
SHIP_NoGauges:
  crgbtnXfer = cBtn;
  UpdateXferBtns();
  return 1;
}



// ======================================================================
// Function: DrawThingXferSide
// Address: 1050:7088
// Segment: MEMORY_SHIP
// ======================================================================


void DrawThingXferSide(HDC hdc,RECT *prc,THING *pth,short iSupply)

{
  StringId ids;
  char *pcVar1;
  undefined2 unaff_SS;
  short sVar2;
  short dxErase;
  RECT rc;
  short xLeft;
  RECT rcGauge;
  short dxLabels;
  short xRight;
  short i;
  short yTop;
  
  dxLabels = 0x4b;
  rc.left = prc->left;
  rc.top = prc->top;
  rc.right = prc->right;
  rc.bottom = (rc.top + rc.right) - rc.left;
  SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
  SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  SelectObject(hdc,rghfontArial8[1]);
  if (iSupply == -1) {
    _Draw3dFrame();
  }
  ExpandRc(&rc,-1,-1);
  rc.bottom = rc.top + dyArial8 + 2;
  if (iSupply == -1) {
    _Draw3dFrame();
    sVar2 = 0;
    pcVar1 = PszGetThingName(pth->idFull);
    RcCtrTextOut(hdc,&rc,pcVar1,sVar2);
  }
  xLeft = prc->left + 4;
  xRight = prc->right + -4;
  yTop = rc.bottom + dyArial8 + 9;
  if (iSupply == -1) {
    SelectObject(hdc,rghfontArial8[1]);
    for (i = -1; i < 3; i = i + 1) {
      if ((i != 4) && (i != 4)) {
        dxErase = 0;
        sVar2 = 0;
        if (i == -1) {
          ids = idsPacketShell;
        }
        else {
          ids = i + idsIronium;
        }
        pcVar1 = PszGetCompressedString(ids);
        RightTextOut(hdc,xLeft + dxLabels,yTop,pcVar1,sVar2,dxErase);
      }
      yTop = yTop + dyArial8 + 6;
    }
  }
  if ((iSupply != 4) && (iSupply != 3)) {
    yTop = rc.bottom + dyArial8 + 9;
    xLeft = xLeft + dxLabels + 6;
    SetRect(&rcGauge,xLeft,yTop,xRight,yTop + dyArial8);
    DrawThingGauge(hdc,&rcGauge,pth,5);
    i = 0;
    while ((i < 3 && (((OffsetRc(&rcGauge,0,dyArial8 + 6), iSupply != -1 &&
                       (iSupply != i)) || (DrawThingGauge(hdc,&rcGauge,pth,i), iSupply != i))
                     ))) {
      i = i + 1;
    }
  }
  return;
}



// ======================================================================
// Function: DrawFleetCargoXferSide
// Address: 1050:72de
// Segment: MEMORY_SHIP
// ======================================================================


void DrawFleetCargoXferSide(HDC hdc,RECT *prc,FLEET *pfl,short iSupply)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  char *pcVar3;
  int iVar4;
  FLEET *pFVar5;
  undefined2 unaff_SS;
  short sVar6;
  undefined2 uVar7;
  short dxErase;
  undefined2 uVar8;
  short iMap;
  RECT rc;
  short xLeft;
  RECT rcGauge;
  short dxLabels;
  FLEET fl;
  short xRight;
  short i;
  short c;
  short fOtherPlr;
  short yTop;
  
  fOtherPlr = (short)(pfl->iPlayer != idPlayer);
  dxLabels = 0x4b;
  pFVar5 = &fl;
  for (iVar4 = 0x3e; iVar4 != 0; iVar4 = iVar4 + -1) {
    pFVar2 = pFVar5;
    pFVar5 = &pFVar5->iPlayer;
    pFVar1 = pfl;
    pfl = &pfl->iPlayer;
    pFVar2->id = pFVar1->id;
  }
  rc.left = prc->left;
  rc.top = prc->top;
  rc.right = prc->right;
  rc.bottom = (rc.top + rc.right) - rc.left;
  SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
  SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  SelectObject(hdc,rghfontArial8[1]);
  if (iSupply == -1) {
    _Draw3dFrame();
  }
  ExpandRc(&rc,-1,-1);
  rc.bottom = rc.top + dyArial8 + 2;
  if (iSupply == -1) {
    _Draw3dFrame();
    sVar6 = 0;
    pcVar3 = PszGetFleetName(fl.id);
    RcCtrTextOut(hdc,&rc,pcVar3,sVar6);
  }
  xLeft = prc->left + 4;
  xRight = prc->right + -4;
  yTop = rc.bottom + 3;
  if (iSupply == -1) {
    SelectObject(hdc,rghfontArial8[1]);
    for (i = 0; i < 6; i = i + 1) {
      if ((i != 6) || (fOtherPlr == 0)) {
        dxErase = 0;
        sVar6 = 0;
        pcVar3 = PszGetCompressedString(i + idsFuel);
        RightTextOut(hdc,xLeft + dxLabels,yTop,pcVar3,sVar6,dxErase);
      }
      yTop = yTop + dyArial8 + 6;
    }
  }
  yTop = rc.bottom + 3;
  xLeft = xLeft + dxLabels + 6;
  if (fOtherPlr == 0) {
    SetRect(&rcGauge,xLeft,yTop,xRight,yTop + dyArial8);
    if ((iSupply == -1) || (iSupply == 4)) {
      DrawFleetGauge(hdc,&rcGauge,&fl,4);
    }
    if (iSupply != 4) {
      yTop = yTop + dyArial8 + 6;
      OffsetRc(&rcGauge,0,dyArial8 + 6);
      DrawFleetGauge(hdc,&rcGauge,&fl,5);
      yTop = yTop + dyArial8 + 6;
      i = 0;
      while ((i < 4 && (((OffsetRc(&rcGauge,0,dyArial8 + 6), iSupply != -1 &&
                         (iSupply != i)) || (DrawFleetGauge(hdc,&rcGauge,&fl,i), iSupply != i))))) {
        yTop = yTop + dyArial8 + 6;
        i = i + 1;
      }
    }
  }
  else {
    xRight = xLeft + dxMaxMineralQuan;
    SetRect(&rc,xLeft + -2,rc.bottom + 2,xLeft + dxMaxMineralQuan + 2,
            yTop + dyArial8 + 1);
    for (i = 0; i < 6; i = i + 1) {
      if (i == 1) {
        OffsetRc(&rc,0,dyArial8 + 6);
      }
      else {
        if (i == 0) {
          iMap = 4;
        }
        else {
          iMap = i + -2;
        }
        if ((iSupply == -1) || (iSupply == iMap)) {
          _Draw3dFrame();
          uVar8 = *(undefined2 *)((int)fl.rgwtMin + iMap * 4 + 2);
          uVar7 = (undefined2)fl.rgwtMin[iMap];
          pcVar3 = PszGetCompressedString((iMap == 4) + idsLdkt);
          c = _wsprintf(szWork,pcVar3,uVar7,uVar8);
          RightTextOut(hdc,xRight,yTop,(char *)szWork,c,0);
          if (iSupply == i) {
            return;
          }
        }
        OffsetRc(&rc,0,dyArial8 + 6);
      }
      yTop = yTop + dyArial8 + 6;
    }
  }
  return;
}



// ======================================================================
// Function: DrawFleetShipsXferSide
// Address: 1050:7726
// Segment: MEMORY_SHIP
// ======================================================================


void DrawFleetShipsXferSide(HDC hdc,RECT *prc,FLEET *pfl,short iSupply)

{
  FLEET *pFVar1;
  short *psVar2;
  char *psz;
  int iVar3;
  FLEET *pFVar4;
  short *psVar5;
  undefined2 unaff_SS;
  short cLen;
  RECT rc;
  short xLeft;
  short fl [62];
  short xRight;
  short i;
  short c;
  short fOtherPlr;
  short yTop;
  
  fOtherPlr = (short)(pfl->iPlayer != idPlayer);
  psVar5 = fl;
  pFVar4 = pfl;
  for (iVar3 = 0x3e; iVar3 != 0; iVar3 = iVar3 + -1) {
    psVar2 = psVar5;
    psVar5 = psVar5 + 1;
    pFVar1 = pFVar4;
    pFVar4 = &pFVar4->iPlayer;
    *psVar2 = pFVar1->id;
  }
  rc.left = prc->left;
  rc.top = prc->top;
  rc.right = prc->right;
  rc.bottom = prc->bottom;
  SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
  SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  SelectObject(hdc,rghfontArial8[1]);
  if (iSupply == -1) {
    _Draw3dFrame();
  }
  ExpandRc(&rc,-1,-1);
  rc.bottom = rc.top + dyArial8 + 2;
  if (iSupply == -1) {
    _Draw3dFrame();
    cLen = 0;
    psz = PszGetFleetName(fl[0]);
    RcCtrTextOut(hdc,&rc,psz,cLen);
  }
  xLeft = (prc->right - dxMaxMineralQuan) + -6;
  xRight = xLeft + dxMaxMineralQuan;
  yTop = rc.bottom + 3;
  if (iSupply == -1) {
    SelectObject(hdc,rghfontArial8[1]);
    for (i = 0; i < cXferValidHulls; i = i + 1) {
      RightTextOut
                (hdc,xLeft + -8,yTop,
                 (char *)((int)&rgshdef[0].hul + 8 + rgXferValidHulls[i] * 0x93)
                 ,0,0);
      yTop = yTop + dyArial8 + 6;
    }
  }
  yTop = rc.bottom + 3;
  SetRect(&rc,xLeft + -2,rc.bottom + 2,xLeft + dxMaxMineralQuan + 2,
          yTop + dyArial8 + 1);
  i = 0;
  do {
    if (cXferValidHulls <= i) {
      return;
    }
    if ((iSupply == -1) || (iSupply == i)) {
      _Draw3dFrame();
      c = _wsprintf(szWork,PCTD,pfl->rgcsh[rgXferValidHulls[i]]);
      RightTextOut(hdc,xRight,yTop,(char *)szWork,c,0);
      if (iSupply == i) {
        return;
      }
    }
    OffsetRc(&rc,0,dyArial8 + 6);
    yTop = yTop + dyArial8 + 6;
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: DrawPlanetXferSide
// Address: 1050:79ca
// Segment: MEMORY_SHIP
// ======================================================================


void DrawPlanetXferSide(HDC hdc,RECT *prc,PLANET *ppl,short iSupply)

{
  PLANET *pPVar1;
  int *piVar2;
  int iVar3;
  char *pcVar4;
  int iVar5;
  int *piVar6;
  undefined2 unaff_SS;
  short cLen;
  undefined2 uVar7;
  short dxErase;
  undefined2 uVar8;
  RECT rc;
  short xLeft;
  char *psz;
  short xRight;
  short i;
  short c;
  short yTop;
  int pl [14];
  undefined2 local_20 [15];
  
  piVar6 = pl;
  for (iVar5 = 0x1c; iVar5 != 0; iVar5 = iVar5 + -1) {
    piVar2 = piVar6;
    piVar6 = piVar6 + 1;
    pPVar1 = ppl;
    ppl = &ppl->iPlayer;
    *piVar2 = pPVar1->id;
  }
  rc.left = prc->left;
  rc.top = prc->top;
  rc.right = prc->right;
  rc.bottom = (rc.top + rc.right) - rc.left;
  SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
  SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  SelectObject(hdc,rghfontArial8[1]);
  if (iSupply == -1) {
    _Draw3dFrame();
  }
  ExpandRc(&rc,-1,-1);
  rc.bottom = rc.top + dyArial8 + 2;
  if (iSupply == -1) {
    _Draw3dFrame();
    if (pl[0] == -1) {
      psz = PszGetCompressedString(idsDeepSpace);
    }
    else {
      psz = PszGetPlanetName(pl[0]);
    }
    RcCtrTextOut(hdc,&rc,psz,0);
  }
  xLeft = prc->left + 4;
  xRight = prc->right + -4;
  yTop = rc.bottom + 3;
  if (iSupply == -1) {
    SelectObject(hdc,rghfontArial8[1]);
    for (i = 0; i < 6; i = i + 1) {
      if (1 < i) {
        dxErase = 0;
        cLen = 0;
        pcVar4 = PszGetCompressedString(i + idsFuel);
        RightTextOut(hdc,xLeft + 0x4b,yTop,pcVar4,cLen,dxErase);
      }
      yTop = yTop + dyArial8 + 6;
    }
  }
  yTop = rc.bottom + 3;
  iVar5 = xLeft + 0x51;
  xRight = iVar5 + dxMaxMineralQuan + 0xc;
  iVar3 = xLeft + 0x4f;
  xLeft = iVar5;
  SetRect(&rc,iVar3,rc.bottom + 2,iVar5 + dxMaxMineralQuan + 0xe,
          yTop + dyArial8 + 1);
  i = 0;
  do {
    if (4 < i) {
      return;
    }
    if (i == 0) {
      yTop = yTop + (dyArial8 + 6) * 2;
      OffsetRc(&rc,0,(dyArial8 + 6) * 2);
    }
    else if (i == 4) {
      yTop = yTop + (dyArial8 + 6) * -6;
      OffsetRc(&rc,0,(dyArial8 + 6) * 6);
    }
    if (((iSupply == -1) || (iSupply == i)) && (i != 4)) {
      _Draw3dFrame();
      uVar8 = local_20[i * 2 + 1];
      uVar7 = local_20[i * 2];
      pcVar4 = PszGetCompressedString(idsLdkt);
      c = _wsprintf(szWork,pcVar4,uVar7,uVar8);
      RightTextOut(hdc,xRight,yTop,(char *)szWork,c,0);
      if (iSupply == i) {
        return;
      }
    }
    OffsetRc(&rc,0,dyArial8 + 6);
    i = i + 1;
    yTop = yTop + dyArial8 + 6;
  } while( true );
}



// ======================================================================
// Function: ClickInShipOrders
// Address: 1050:7cda
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1050860e) */
/* WARNING: Removing unreachable block (ram,0x105085b0) */
/* WARNING: Removing unreachable block (ram,0x10508c2e) */
/* WARNING: Removing unreachable block (ram,0x10508d23) */
/* WARNING: Removing unreachable block (ram,0x10508d4d) */
/* WARNING: Removing unreachable block (ram,0x10508d77) */

ushort ClickInShipOrders(POINT pt,short sks,short fCursor,short fRightBtn)

{
  ZIPORDER *pZVar1;
  ushort *puVar2;
  FLEET *pFVar3;
  ushort uVar4;
  POINT pt_00;
  BOOL BVar5;
  char *pcVar6;
  uint uVar7;
  short sVar8;
  uint uVar9;
  HCURSOR HVar10;
  int iVar11;
  TASKXPORT *pTVar12;
  ORDER *pOVar13;
  THING *pTVar14;
  undefined2 unaff_SI;
  ZIPORDER *pZVar15;
  undefined2 unaff_DI;
  ushort *puVar16;
  undefined2 uVar17;
  undefined2 unaff_SS;
  long lVar18;
  ulong uVar19;
  ulong uVar20;
  int iVar21;
  long lVar22;
  THING *in_stack_0000fd54;
  SCAN scan;
  THING *lpthMac;
  ORDER *local_296;
  short iChecked;
  ushort rgid;
  uint local_290 [143];
  short fRet;
  undefined4 lpProc;
  undefined1 rgzo [88];
  PLORD *local_114;
  undefined2 local_112;
  TASKXPORT *lptxp;
  char *rgszZip [4];
  long *local_104;
  FLEET *lpfl;
  THING *lpth;
  ORDER *lpord;
  short i;
  long lSel;
  undefined4 lTempMax;
  short fTwoMAs;
  short fFirst;
  int lTempMin;
  int local_e6;
  int dx;
  int local_e2;
  short irc;
  undefined4 lNew;
  XFER xf;
  short grbit;
  long xRnd;
  short iSkip;
  undefined4 lSel__82;
  undefined4 lMax;
  short idPlan;
  short ptOld;
  short local_46;
  short iWarp;
  PLANET pl;
  HDC hdc;
  undefined4 lCur;
  
  lVar22 = CONCAT22(unaff_SI,unaff_DI);
  lTempMin = 0;
  local_e6 = 0;
  irc = -1;
  if (sel.grobj == grobjNone) {
    HVar10 = 0;
    lVar18 = sel.fl.rgwtMin[4];
    goto LAB_1050_915f;
  }
  BVar5 = PtInRect(rgrcRef + 5,pt);
  if (BVar5 == 0) {
    BVar5 = PtInRect(rgrcRef + 0xc,pt);
    lVar18 = sel.fl.rgwtMin[4];
    if (BVar5 == 0) {
      if (fRightBtn != 0) {
        HVar10 = 0;
        goto LAB_1050_915f;
      }
      BVar5 = PtInRect(rgrcRef,pt);
      if (BVar5 == 0) {
        BVar5 = PtInRect(rgrcRef + 0xf,pt);
        if (BVar5 == 0) {
          BVar5 = PtInRect(rgrcRef + 1,pt);
          if (BVar5 == 0) {
            BVar5 = PtInRect(rgrcRef + 3,pt);
            if (BVar5 != 0) {
              HVar10 = hcurHand;
              lVar18 = sel.fl.rgwtMin[4];
              if (fCursor == 0) {
                if (sel.fl.idPlanet == -1) {
                  lSel = CONCAT22(lpThings._2_2_,(THING *)lpThings);
                  lpth = (THING *)CONCAT22((THING *)lpThings,(THING *)lpth);
                  pTVar14 = (THING *)lpThings + cThing;
                  lpord = (ORDER *)CONCAT22(pTVar14,lpThings._2_2_);
                  i = (short)lpThings._2_2_;
                  while( true ) {
                    if ((pTVar14 <= (THING *)lSel) ||
                       (((*(uint *)lSel >> 0xd == 1 &&
                         (sel.fl.pt.x == (&((THING *)lSel)->pt)->x)) &&
                        (sel.fl.pt.y == (((THING *)lSel)->pt).y)))) break;
                    lSel = (THING *)lSel + 1;
                  }
                  if (((THING *)lSel == pTVar14) && (lSel._2_2_ == lpThings._2_2_)) {
                    TransferStuff(sel.fl.id,2,-1,4,0);
                  }
                  else {
                    MessageBeep(0);
                  }
                }
                else {
                  TransferStuff(sel.fl.id,2,sel.fl.idPlanet,1,0);
                }
                HVar10 = 0;
                lVar18 = sel.fl.rgwtMin[4];
              }
              goto LAB_1050_915f;
            }
            BVar5 = PtInRect(rgrcRef + 4,pt);
            if (BVar5 != 0) {
              HVar10 = hcurHand;
              lVar18 = sel.fl.rgwtMin[4];
              if (fCursor == 0) {
                lSel = SendMessage(hwndShipDD,0x407,0,0);
                if (((int)lSel == -1) && ((int)((ulong)lSel >> 0x10) == -1)) {
                  HVar10 = 0;
                  lVar18 = sel.fl.rgwtMin[4];
                }
                else {
                  sVar8 = sel.fl.id;
                  if (sel.grobj != grobjFleet) {
                    sVar8 = -1;
                  }
                  sVar8 = FLookupOrbitingXfer(sel.pl.id,(int)lSel,&xf,sVar8);
                  if (sVar8 != 0) {
                    TransferStuff(sel.id,sel.grobj,xf.id,xf.grobj,0);
                  }
                  HVar10 = 0;
                  lVar18 = sel.fl.rgwtMin[4];
                }
              }
              goto LAB_1050_915f;
            }
            BVar5 = PtInRect(rgrcRef + 0x12,pt);
            lVar18 = sel.fl.rgwtMin[4];
            if (BVar5 != 0) {
              if (((sel.grobj != grobjFleet) && (fCursor != 0)) ||
                 ((*(uint *)((int)(PLORD *)sel.fl.lpplord +
                            sel.iwpAct * 0x12 + 10) & 0xf) != 7)) {
                HVar10 = 0;
                goto LAB_1050_915f;
              }
              irc = 0x12;
              lTempMax = 10;
              lMax = 10;
              lCur._0_2_ = *(uint *)((int)(PLORD *)sel.fl.lpplord +
                                    sel.iwpAct * 0x12 + 0xc);
              lCur._2_2_ = 0;
              grbit = 7;
              lpProc = (FARPROC)CONCAT22(lpProc._2_2_,(void *)lpProc);
              lSel__82 = CONCAT22(lSel__82._2_2_,(undefined2)lSel__82);
            }
          }
          else {
            if (sel.grobj == grobjFleet) {
              idPlan = sel.fl.idPlanet;
              iSkip = sel.fl.id;
            }
            else {
              iSkip = -1;
              idPlan = sel.pl.id;
            }
            lSel__82 = SendMessage(hwndShipDD,0x407,0,0);
            FLookupOrbitingXfer(idPlan,(short)lSel__82,&xf,iSkip);
            if ((xf.grobj != grobjFleet) || (xf.u_XFER_0x0004.fl.iPlayer != idPlayer)) {
              HVar10 = 0;
              lVar18 = sel.fl.rgwtMin[4];
              goto LAB_1050_915f;
            }
            irc = 1;
            lMax = LGetFleetStat(&(&xf.u_XFER_0x0004)->fl,grStatFuel);
            lCur._0_2_ = xf.u_XFER_0x0004.fl.rgwtMin[4]._0_2_;
            lCur._2_2_ = xf.u_XFER_0x0004.fl.rgwtMin[4]._2_2_;
            grbit = 4;
            if (sel.grobj == grobjFleet) {
              lTempMax = sel.fl.rgwtMin[4] +
                         CONCAT22(xf.u_XFER_0x0004.fl.rgwtMin[4]._2_2_,
                                  xf.u_XFER_0x0004.fl.rgwtMin[4]._0_2_);
              in_stack_0000fd54 = (THING *)0x1;
              lVar22 = 0x11204972;
              lVar18 = LGetFleetStat(&sel.fl,grStatFuel);
              uVar7 = (uint)(lVar18 - sel.fl.rgwtMin[4]);
              lTempMin = (uint)lCur - uVar7;
              local_e6 = (lCur._2_2_ - (int)((ulong)(lVar18 - sel.fl.rgwtMin[4]) >> 0x10))
                         - (uint)((uint)lCur < uVar7);
            }
            else {
              lTempMax = CONCAT22(xf.u_XFER_0x0004.fl.rgwtMin[4]._2_2_,
                                  xf.u_XFER_0x0004.fl.rgwtMin[4]._0_2_);
            }
            lVar18 = sel.fl.rgwtMin[4];
          }
        }
        else {
          irc = 0xf;
          iWarp = IWarpMAFromLppl(&sel.pl,&fTwoMAs);
          lTempMax = (ulong)(iWarp + -1);
          lMax = (ulong)(iWarp + -1);
          lTempMin = 1;
          local_e6 = 0;
          lCur._0_2_ = sel.pl.lStarbase._2_2_ >> 10 & 0xf;
          lCur._2_2_ = 0;
          lVar18 = sel.fl.rgwtMin[4];
        }
      }
      else {
        lVar18 = sel.fl.rgwtMin[4];
        if ((sel.grobj != grobjFleet) && (fCursor != 0)) {
          HVar10 = 0;
          goto LAB_1050_915f;
        }
        irc = 0;
        lTempMax = 0xb;
        lMax = 0xb;
        lCur._0_2_ = *(uint *)((int)(PLORD *)sel.fl.lpplord +
                              sel.iwpAct * 0x12 + 10) >> 4 & 0xf;
        lCur._2_2_ = 0;
        grbit = 6;
      }
    }
    else {
      HVar10 = hcurArrowHelp;
      if (fCursor != 0) goto LAB_1050_915f;
      if (fRightBtn == 0) {
        GlobalPD.grPopup = 10;
        GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = hstMining|hstTorp|hstBeam|hstShield;
        GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = (ushort)szPopupBuffer;
        CchGetString
                  (idsRightClickBlueDiamondBringPopupMenu,(char *)szPopupBuffer);
        Popup(hwndPlanet,pt.x,pt.y);
      }
      else {
        iChecked = -1;
        pOVar13 = (ORDER *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4
                           );
        lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,pOVar13);
        pt_00.y = (pOVar13->pt).y;
        pt_00.x = (lpord->pt).x;
        FFindNearestObject(pt_00,0x8f,&scan);
        if (scan.idpl == 0xffff) {
          rgid = 0;
          local_290[0] = 0x1000;
        }
        else {
          local_290[0] = scan.idpl >> 0xf;
          rgid = scan.idpl;
        }
        local_290[1] = 0xffff;
        local_290[2] = 0xffff;
        i = 2;
        uVar17 = (undefined2)((ulong)lpord >> 0x10);
        if (((((ORDER *)lpord)->wFlags_0x6 >> 8 & 0xf) == 1) ||
           ((((ORDER *)lpord)->wFlags_0x6 >> 8 & 0xf) == 4)) {
          iChecked = 0;
        }
        lSel = 0;
        while (sVar8 = i, (int)(THING *)lSel < cFleet) {
                    /* WARNING: Load size is inaccurate */
          pFVar3 = ((FLEET **)rglpfl)[(int)(THING *)lSel];
          iVar11 = *(int *)((int)((FLEET **)rglpfl + (int)(THING *)lSel) + 2);
          lpfl = (FLEET *)CONCAT22(iVar11,pFVar3);
          if ((pFVar3 == (FLEET *)0x0) && (iVar11 == 0)) break;
          if ((scan.pt.x == (&pFVar3->pt)->x) &&
             ((scan.pt.y == (pFVar3->pt).y && (lpfl->id != sel.fl.id)))) {
            uVar17 = (undefined2)((ulong)lpord >> 0x10);
            if (((((ORDER *)lpord)->wFlags_0x6 >> 8 & 0xf) == 2) &&
               (((ORDER *)lpord)->id == lpfl->id)) {
              iChecked = i;
            }
            uVar4 = lpfl->id;
            iVar11 = i * 2;
            i = i + 1;
            (&rgid)[iVar11] = uVar4;
            local_290[sVar8 * 2] = (int)uVar4 >> 0xf | 0x8000;
            if (99 < i) break;
          }
          lSel = (long)((int)(THING *)lSel + 1);
        }
        if (i == 2) {
          i = 1;
        }
        lSel = (long)CONCAT12(i == 0,(THING *)lSel);
        lpthMac = (THING *)lpThings + cThing;
        local_296 = lpThings._2_2_;
        lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
        while (sVar8 = i, (THING *)lpth < lpthMac) {
          uVar17 = (undefined2)((ulong)lpth >> 0x10);
          if ((scan.pt.x == (&((THING *)lpth)->pt)->x) && (scan.pt.y == (((THING *)lpth)->pt).y)) {
            if (lSel._2_2_ == (ORDER *)0x0) {
              if (99 < i) break;
              iVar11 = i * 2;
              i = i + 1;
              (&rgid)[iVar11] = 0xffff;
              local_290[sVar8 * 2] = 0xffff;
              lSel = CONCAT22(1,(THING *)lSel);
            }
            sVar8 = i;
            if (99 < i) break;
            iVar11 = i * 2;
            i = i + 1;
            (&rgid)[iVar11] = lpth->idFull;
            local_290[sVar8 * 2] = 0x2000;
          }
          lpth = (THING *)lpth + 1;
        }
        in_stack_0000fd54 = (THING *)lpThings;
        sVar8 = PopupMenu(hwndPlanet,pt.x,pt.y,i,&rgid,(char **)0x0,iChecked,1);
        lSel = CONCAT22(lSel._2_2_,sVar8);
        if (-1 < sVar8) {
          pOVar13 = (ORDER *)lpord;
          uVar17 = (undefined2)((ulong)lpord >> 0x10);
          if (((sVar8 == 0) && (rgid == 0)) && (local_290[0] == 0x1000)) {
            pOVar13->wFlags_0x6 = pOVar13->wFlags_0x6 & 0xf0ff | 0x400;
            pOVar13->id = -1;
          }
          else if ((local_290[sVar8 * 2] & 0x2000) == 0) {
            if ((local_290[sVar8 * 2] & 0x8000) == 0) {
              pOVar13->wFlags_0x6 = pOVar13->wFlags_0x6 & 0xf0ff | 0x100;
              pOVar13->id = rgid;
            }
            else {
              pOVar13->wFlags_0x6 = pOVar13->wFlags_0x6 & 0xf0ff | 0x200;
              pOVar13->id = (&rgid)[sVar8 * 2];
            }
          }
          else {
            pOVar13->wFlags_0x6 = pOVar13->wFlags_0x6 & 0xf0ff | 0x800;
            pOVar13->id = (&rgid)[sVar8 * 2];
          }
          FLookupFleet(-1,(FLEET *)&sel.fl);
          FillOrdersLB();
          SetOrdersLbSel(sel.iwpAct);
        }
      }
      lVar18 = sel.fl.rgwtMin[4];
    }
  }
  else {
    HVar10 = hcurArrowHelp;
    lVar18 = sel.fl.rgwtMin[4];
    if (fCursor != 0) goto LAB_1050_915f;
    if (fRightBtn == 0) {
      GlobalPD.grPopup = 6;
      Popup(hwndPlanet,pt.x,pt.y);
    }
    else {
      lSel = 0xff;
      for (i = 0; i < 4; i = i + 1) {
        rgszZip[i] = (char *)*(undefined2 *)(i * 2 + 0x906);
      }
      local_104 = &lSel;
      lSel = CONCAT22(5,(THING *)lSel);
      i = 0;
      while( true ) {
        iVar11 = (int)lSel._2_2_;
        if (3 < i) break;
        if (*(char *)((int)&vrgZip[0].fValid + i * 0x18) != '\0') {
          lSel = CONCAT22((int)lSel._2_2_ + 1,(THING *)lSel);
          rgszZip[iVar11] = (char *)(i * 0x18 + 0x526e);
        }
        i = i + 1;
      }
      if (5 < (int)lSel._2_2_) {
        lSel = CONCAT22((int)lSel._2_2_ + 1,(THING *)lSel);
        rgszZip[iVar11] = &lSel;
      }
      pcVar6 = PszGetCompressedString(idsCustomize);
      iVar11 = (int)lSel._2_2_;
      lSel = CONCAT22((int)lSel._2_2_ + 1,(THING *)lSel);
      rgszZip[iVar11] = pcVar6;
      i = PopupMenu(hwndPlanet,pt.x,pt.y,(short)lSel._2_2_,(long *)0x0,rgszZip,-1,1);
      uVar17 = sel.fl.lpplord._2_2_;
      sVar8 = sel.iwpAct;
      if (i == (int)lSel._2_2_ + -1) {
        _memcpy(rgzo,(ZIPORDER *)vrgZip,0x60);
        lpProc = MakeProcInstance(ZipOrderDlg,hInst);
        fRet = DialogBox(0,(LPCSTR)CONCAT22(0x59,hwndFrame),(HWND)((ulong)lpProc >> 0x10),
                         (char)lpProc);
        FreeProcInstance(lpProc);
        if (fRet == 0) {
          _memcpy((ZIPORDER *)vrgZip,rgzo,0x60);
        }
      }
      else {
        if (i < 5) {
          if (i == -1) goto LAB_1050_8237;
          local_114 = (PLORD *)sel.fl.lpplord + 1;
          local_112 = sel.fl.lpplord._2_2_;
          pTVar12 = (TASKXPORT *)((int)local_114 + sel.iwpAct * 0x12 + 8);
          lptxp = (TASKXPORT *)CONCAT22(sel.fl.lpplord._2_2_,pTVar12);
          if (i == 0) {
            *(uint *)((int)local_114 + sel.iwpAct * 0x12 + 0x10) =
                 *(uint *)((int)local_114 + sel.iwpAct * 0x12 + 0x10) & 0xfff | 0x7000;
            for (i = 0; i < 3; i = i + 1) {
              (pTVar12->rgia + i)->wFlags = (pTVar12->rgia + i)->wFlags & 0xfff | 0x1000;
            }
            *(uint *)((int)local_114 + sVar8 * 0x12 + 0xe) =
                 *(uint *)((int)local_114 + sVar8 * 0x12 + 0xe) & 0xfff;
          }
          else if (i == 1) {
            *(uint *)((int)local_114 + sel.iwpAct * 0x12 + 0x10) =
                 *(uint *)((int)local_114 + sel.iwpAct * 0x12 + 0x10) & 0xfff | 0x7000;
            for (i = 0; i < 4; i = i + 1) {
              (pTVar12->rgia + i)->wFlags = (pTVar12->rgia + i)->wFlags & 0xfff | 0x2000;
            }
          }
          else if (i == 2) {
            *(uint *)((int)local_114 + sel.iwpAct * 0x12 + 0x10) =
                 *(uint *)((int)local_114 + sel.iwpAct * 0x12 + 0x10) & 0xfff | 0x7000;
            for (i = 0; i < 3; i = i + 1) {
              (pTVar12->rgia + i)->wFlags = (pTVar12->rgia + i)->wFlags & 0xfff | 0x6000;
              (pTVar12->rgia + i)->wFlags = (pTVar12->rgia + i)->wFlags & 0xf000 | 100;
            }
            *(uint *)((int)local_114 + sVar8 * 0x12 + 0xe) =
                 *(uint *)((int)local_114 + sVar8 * 0x12 + 0xe) & 0xfff;
          }
          else if (i == 3) {
            for (i = 0; i < 5; i = i + 1) {
              (pTVar12->rgia + i)->wFlags = (pTVar12->rgia + i)->wFlags & 0xfff;
              (pTVar12->rgia + i)->wFlags = (pTVar12->rgia + i)->wFlags & 0xf000;
            }
          }
        }
        else {
          i = i + -4;
          iSkip = 0;
          while ((i != 0 &&
                 ((*(char *)((int)&vrgZip[0].fValid + iSkip * 0x18) == '\0' ||
                  (i = i + -1, i != 0))))) {
            iSkip = iSkip + 1;
          }
          pZVar15 = (ZIPORDER *)vrgZip + iSkip;
          puVar16 = (ushort *)
                    ((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xc);
          for (iVar11 = 5; iVar11 != 0; iVar11 = iVar11 + -1) {
            puVar2 = puVar16;
            puVar16 = puVar16 + 1;
            pZVar1 = pZVar15;
            pZVar15 = (pZVar15->txp).rgia + 1;
            *puVar2 = (pZVar1->txp).rgia[0].wFlags;
          }
          lptxp = (TASKXPORT *)
                  CONCAT22(sel.fl.lpplord._2_2_,(PLORD *)sel.fl.lpplord + 1);
        }
        FLookupFleet(-1,(FLEET *)&sel.fl);
        UpdateOrdersDDs(1);
        DrawPlanShip(0,0x100);
      }
    }
LAB_1050_8237:
    lVar18 = sel.fl.rgwtMin[4];
  }
  if (irc == -1) {
    HVar10 = 0;
  }
  else {
    HVar10 = hcurHand;
    if (fCursor == 0) {
      dx = (*(int *)((int)&rgrcRef[0].right + irc * 8) -
           ((RECT *)rgrcRef + irc)->left) + -2;
      local_e2 = dx >> 0xf;
      sel.fl.rgwtMin[4] = lVar18;
      __aFldiv((long)dx,lMax + 1);
      xRnd = __aFlshr(lVar22,(ushort)in_stack_0000fd54);
      hdc = GetDC(hwndPlanet);
      SetCapture(hwndPlanet);
      local_46 = -1;
      ptOld = -1;
      if ((long)lMax < (long)lTempMax) {
        lTempMax = lMax;
      }
      if ((local_e6 < 1) && (local_e6 < 0)) {
        lTempMin = 0;
        local_e6 = 0;
      }
      fFirst = 1;
      uVar19 = CONCAT22(lCur._2_2_,(uint)lCur);
LAB_1050_8c8b:
      if (fFirst == 0) {
        lCur = uVar19;
        sVar8 = FGetMouseMove(&pt);
        uVar19 = lCur;
        if (sVar8 == 0) goto LAB_1050_8f9c;
      }
      fFirst = 0;
      if ((pt.x != ptOld) || (pt.y != local_46)) {
        ptOld = pt.x;
        local_46 = pt.y;
        iVar11 = dx;
        iVar21 = local_e2;
        lCur = uVar19;
        uVar19 = __aFulmul(xRnd + (pt.x - ((RECT *)rgrcRef + irc)->left),lMax);
        uVar20 = __aFldiv(uVar19,CONCAT22(iVar21,iVar11));
        lNew = CONCAT22(local_e6,lTempMin);
        uVar19 = lTempMax;
        if ((long)uVar20 < (long)lTempMax) {
          uVar19 = uVar20;
        }
        if (((long)lNew <= (long)uVar19) && (lNew = lTempMax, (long)uVar20 < (long)lTempMax)) {
          lNew = uVar20;
        }
        uVar7 = (uint)lNew;
        uVar19 = lCur;
        if (lCur != lNew) {
          if (irc == 0) {
            uVar9 = (uVar7 & 0xf) << 4;
            lSel = CONCAT22(uVar7,uVar9);
            i = *(uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 10)
                & 0xff0f | uVar9;
            *(uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 10) = i
            ;
            DrawPlanShip(0,0x4020);
            uVar19 = lNew;
          }
          else if (irc == 0x12) {
            lSel = CONCAT22(uVar7,(THING *)lSel);
            *(uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xc) =
                 uVar7;
            DrawPlanShip(0,0x4100);
            uVar19 = lNew;
          }
          else if (irc == 0xf) {
            iVar11 = iWarp;
            if (fTwoMAs != 0) {
              iVar11 = -iWarp;
            }
            DrawMassWarpGauge(hdc,(RECT *)(rgrcRef + 0xf),iVar11,uVar7 + 4);
            uVar19 = lNew;
          }
          else if (irc == 2) {
            sel.fl.rgwtMin[4] = lNew;
            DrawFleetGauge(hdc,(RECT *)(rgrcRef + 2),(FLEET *)0x0,grbit);
            uVar19 = lNew;
          }
          else {
            uVar19 = lNew;
            if (irc == 1) {
              if (sel.grobj == grobjFleet) {
                sel.fl.rgwtMin[4] = sel.fl.rgwtMin[4] - (lNew - lCur);
                DrawFleetGauge(hdc,(RECT *)(rgrcRef + 2),&sel.fl,grbit);
              }
              else {
                DrawPlanShip(0,0x4001);
              }
              xf.u_XFER_0x0004.fl.rgwtMin[4] = lNew;
              DrawFleetGauge(hdc,(RECT *)rgrcRef + irc,&(&xf.u_XFER_0x0004)->fl,grbit);
              uVar19 = lNew;
            }
          }
        }
      }
      goto LAB_1050_8c8b;
    }
  }
LAB_1050_915f:
  sel.fl.rgwtMin[4]._2_2_ = (undefined2)((ulong)lVar18 >> 0x10);
  sel.fl.rgwtMin[4]._0_2_ = (undefined2)lVar18;
  return HVar10;
LAB_1050_8f9c:
  grbit = sel.scan.grobjFull;
  if (sel.scan.grobj != grobjOther) {
    grbit = sel.scan.grobj;
  }
  if (irc == 2) {
    FLookupFleet(-1,(FLEET *)&sel.fl);
    FLookupPlanet(-1,&pl);
    DrawPlanShip(0,0x4220);
    if (((grbit & 1U) == 0) || (sel.fl.idPlanet != sel.scan.idpl)) {
      if (((grbit & 2U) != 0) &&
         (sel.fl.id == ((FLEET **)rglpfl)[sel.scan.ifl]->id)) {
        InvalidateRect(hwndMine,(RECT *)0x0,1);
      }
    }
    else {
SHIP_FixMinWin:
      InvalidateMineralBars();
    }
  }
  else if (irc == 1) {
    FLookupFleet(-1,&xf.u_XFER_0x0004.fl);
    if (sel.grobj == grobjFleet) {
      FLookupFleet(-1,(FLEET *)&sel.fl);
      DrawPlanShip(0,0x4221);
    }
    else {
      FLookupPlanet(-1,(PLANET *)&sel.pl);
      if (((grbit & 1U) != 0) && (sel.pl.id == sel.scan.idpl))
      goto SHIP_FixMinWin;
    }
  }
  else if ((irc == 0) || (irc == 0x12)) {
    FLookupFleet(-1,(FLEET *)&sel.fl);
  }
  else if ((irc == 0xf) && ((uint)lCur != (sel.pl.lStarbase._2_2_ >> 10 & 0xf))) {
    lSel = CONCAT22((uint)lCur,(THING *)lSel);
    sel.pl.lStarbase._2_2_ =
         sel.pl.lStarbase._2_2_ & 0xc3ff | ((uint)lCur & 0xf) << 10;
    FLookupPlanet(-1,(PLANET *)&sel.pl);
  }
  ReleaseCapture();
  HVar10 = ReleaseDC(hwndPlanet,hdc);
  lVar18 = sel.fl.rgwtMin[4];
  goto LAB_1050_915f;
}



// ======================================================================
// Function: FillFleetCompLB
// Address: 1050:9166
// Segment: MEMORY_SHIP
// ======================================================================


void FillFleetCompLB(void)

{
  int iVar1;
  undefined2 uVar2;
  ulong uVar3;
  long lVar4;
  short i;
  
  SendMessage(hwndFleetCompLB,0x405,0,0);
  for (i = 0; i < 0x10; i = i + 1) {
    if (0 < *(int *)((int)&sel.fl + 0xc + i * 2)) {
      lVar4 = 500;
      uVar3 = __aFulmul((ulong)(*(uint *)((int)&sel.fl + 0x2c + i * 2) & 0x7f),
                                (ulong)(*(uint *)((int)&sel.fl + 0x2c + i * 2) >> 7));
      lVar4 = __aFldiv(uVar3 + 0xfa,lVar4);
      if (lVar4 == 0) {
        iVar1 = 0x20;
        uVar2 = 0x51;
      }
      else {
        iVar1 = (int)(char)lVar4;
        uVar2 = 0x50;
      }
      _wsprintf(szWork,(char *)0x1120098a,uVar2,iVar1,
                *(undefined2 *)((int)&sel.fl + 0xc + i * 2),i * 0x93 + 0x3f08);
      SendMessage(hwndFleetCompLB,0x401,0,0x112057a4);
    }
  }
  return;
}



// ======================================================================
// Function: FillOrdersLB
// Address: 1050:928c
// Segment: MEMORY_SHIP
// ======================================================================


void FillOrdersLB(void)

{
  short *psVar1;
  short *psVar2;
  int iVar3;
  short *psVar4;
  short *psVar5;
  undefined2 unaff_SS;
  short ord;
  short local_18;
  short local_16;
  uint local_14;
  char *psz;
  short i;
  
  SendMessage(hwndShipLB,0x405,0,0);
  for (i = 0; i < sel.fl.cord; i = i + 1) {
    psVar4 = (short *)((int)(PLORD *)sel.fl.lpplord + i * 0x12 + 4);
    psVar5 = &ord;
    for (iVar3 = 9; iVar3 != 0; iVar3 = iVar3 + -1) {
      psVar2 = psVar5;
      psVar5 = psVar5 + 1;
      psVar1 = psVar4;
      psVar4 = psVar4 + 1;
      *psVar2 = *psVar1;
    }
    psz = PszGetLocName(local_14 >> 8 & (grobjThing|grobjOther|grobjFleet|grobjPlanet),
                              local_16,ord,local_18);
    SendMessage(hwndShipLB,0x401,0,(LPARAM)psz);
  }
  SetOrdersLbSel(sel.iwpAct);
  if (sel.grobj == grobjFleet) {
    DrawPlanShip(0,0x120);
  }
  return;
}



// ======================================================================
// Function: SetOrdersLbSel
// Address: 1050:9354
// Segment: MEMORY_SHIP
// ======================================================================


void SetOrdersLbSel(short iSel)

{
  int iVar1;
  
  SendMessage(hwndShipLB,0x407,iSel,0);
  if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
    iVar1 = 2;
  }
  else {
    iVar1 = 1;
  }
  if (iVar1 < iSel) {
    if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
      iVar1 = 2;
    }
    else {
      iVar1 = 1;
    }
    SendMessage(hwndShipLB,0x418,iSel - iVar1,0);
  }
  UpdateWindow(hwndShipLB);
  UpdateOrdersDDs(0);
  return;
}



// ======================================================================
// Function: UpdateOrdersDDs
// Address: 1050:93ee
// Segment: MEMORY_SHIP
// ======================================================================


void UpdateOrdersDDs(short iLevel)

{
  undefined2 uVar1;
  int iVar2;
  char *pcVar3;
  undefined2 unaff_SS;
  long lVar4;
  long lVar5;
  LRESULT LVar6;
  WPARAM WVar7;
  UINT UVar8;
  ushort uVar9;
  short iMax;
  short iSel;
  char *psz;
  short i;
  short iMin;
  int local_c;
  int local_a;
  
  LVar6 = CONCAT22(local_a,local_c);
  iSel = -1;
  if (iLevel == 0) {
    lVar4 = SendMessage(rghwndOrderDD[0],0x40e,
                        *(uint *)((int)(PLORD *)sel.fl.lpplord +
                                 sel.iwpAct * 0x12 + 10) & 0xf,0);
  }
  else {
    lVar4 = SendMessage(rghwndOrderDD[0],0x407,0,0);
  }
  if (1 < iLevel) {
    LVar6 = SendMessage(rghwndOrderDD[1],0x407,0,0);
    if ((lVar4 != 1) || (3 < iLevel)) goto LAB_1050_987f;
    if ((int)LVar6 == 0) {
      iSel = 4;
    }
    else {
      iSel = (int)LVar6 + -1;
    }
  }
  SendMessage(rghwndOrderDD[1],0x40b,0,0);
  if (lVar4 == 1) {
    lVar5 = LGetFleetStat(&sel.fl,grStatCargo);
    if (lVar5 == 0) {
      iVar2 = 1;
    }
    else {
      iVar2 = 5;
    }
    for (i = 0; i < iVar2; i = i + 1) {
      if (i == 0) {
        iMin = 4;
      }
      else {
        iMin = i + -1;
      }
      _strcpy((char *)szWork + 1,(char *)*(undefined2 *)(iMin * 2 + 0x4cc));
      if (*(uint *)((int)(PLORD *)sel.fl.lpplord +
                   iMin * 2 + sel.iwpAct * 0x12 + 0xc) >> 0xc == 0) {
        szWork[0] = ' ';
      }
      else {
        szWork[0] = '*';
        if (iSel == -1) {
          iSel = iMin;
        }
      }
      SendMessage(rghwndOrderDD[1],0x403,0,0x112057a4);
    }
    if ((iSel == -1) || (iSel == 4)) {
      iSel = 0;
    }
    else {
      iSel = iSel + 1;
    }
    LVar6 = SendMessage(rghwndOrderDD[1],0x40e,iSel,0);
  }
  else if (lVar4 == 7) {
    pcVar3 = PszGetCompressedString(idsWithinDLY);
    for (i = 0; i < 0xb; i = i + 1) {
      _wsprintf(szWork,pcVar3,i * 0x32 + 0x32);
      SendMessage(rghwndOrderDD[1],0x403,0,0x112057a4);
    }
    pcVar3 = PszGetCompressedString(idsAnyEnemy);
    SendMessage(rghwndOrderDD[1],0x403,0,(LPARAM)pcVar3);
    LVar6 = SendMessage(rghwndOrderDD[1],0x40e,
                        *(WPARAM *)
                         ((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xe
                         ),0);
  }
  else if (lVar4 == 9) {
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (i != idPlayer) {
        pcVar3 = PszPlayerName(i,1,1,1,0,(PLAYER *)0x0);
        _strcpy(&stack0xff99,pcVar3);
        SendMessage(rghwndOrderDD[1],0x403,0,(LPARAM)&stack0xff98);
      }
    }
    LVar6 = SendMessage(rghwndOrderDD[1],0x40e,
                        *(WPARAM *)
                         ((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xc
                         ),0);
  }
  else if (lVar4 == 6) {
    for (i = 0; i < 5; i = i + 1) {
      if (i == 0) {
        uVar1 = 0x20;
      }
      else {
        uVar1 = 0x73;
      }
      iVar2 = i + 1;
      pcVar3 = PszGetCompressedString(idsDYearC);
      _wsprintf(szWork,pcVar3,iVar2,uVar1);
      SendMessage(rghwndOrderDD[1],0x403,0,0x112057a4);
    }
    UVar8 = 0x403;
    WVar7 = 0;
    uVar9 = rghwndOrderDD[1];
    pcVar3 = PszGetCompressedString(idsIindefinitely);
    SendMessage(uVar9,UVar8,WVar7,(LPARAM)pcVar3);
    LVar6 = SendMessage(rghwndOrderDD[1],0x40e,
                        *(WPARAM *)
                         ((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 0xc
                         ),0);
  }
LAB_1050_987f:
  local_c = (int)LVar6;
  if (iLevel < 3) {
    SendMessage(rghwndOrderDD[2],0x40b,0,0);
    if (lVar4 == 1) {
      for (i = 0x6d; local_a = (int)((ulong)LVar6 >> 0x10), i < 0x77; i = i + 1) {
        if (((i == 0x74) && (local_c == 0)) && (local_a == 0)) {
          psz = PszGetCompressedString(idsLoadOptimal);
        }
        else {
          psz = PszGetCompressedString(i);
        }
        SendMessage(rghwndOrderDD[2],0x403,0,(LPARAM)psz);
      }
      if (local_c == 0) {
        iSel = 4;
      }
      else {
        iSel = local_c + -1;
      }
      SendMessage(rghwndOrderDD[2],0x40e,
                  *(uint *)((int)(PLORD *)sel.fl.lpplord +
                           iSel * 2 + sel.iwpAct * 0x12 + 0xc) >> 0xc,0);
    }
  }
  else {
    SendMessage(rghwndOrderDD[2],0x407,0,0);
  }
  if ((iLevel < 4) && (lVar4 == 1)) {
    if (local_c == 0) {
      iSel = 4;
    }
    else {
      iSel = local_c + -1;
    }
    _wsprintf(szWork,(char *)0x11200994,
              *(uint *)((int)(PLORD *)sel.fl.lpplord +
                       iSel * 2 + sel.iwpAct * 0x12 + 0xc) & 0xfff);
    SetWindowText(hwndOrderED,szWork);
  }
  return;
}



// ======================================================================
// Function: FillBattleDD
// Address: 1050:9a36
// Segment: MEMORY_SHIP
// ======================================================================


void FillBattleDD(short iSel)

{
  short i;
  
  SendMessage(hwndBattleDD,0x40b,0,0);
  CchGetString(idsBattlePlans,(char *)szWork);
  SendMessage(hwndBattleDD,0x403,0,0x112057a4);
  for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
    __fstrcpy(szWork,
                      (char *)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x593a),
                                       ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                       szName));
    SendMessage(hwndBattleDD,0x403,0,0x112057a4);
  }
  SendMessage(hwndBattleDD,0x40e,iSel,0);
  return;
}



// ======================================================================
// Function: DeleteCurWayPoint
// Address: 1050:9b08
// Segment: MEMORY_SHIP
// ======================================================================


void DeleteCurWayPoint(short fBackup)

{
  byte *pbVar1;
  int iVar2;
  POINT pt_00;
  int iVar3;
  int iVar4;
  undefined2 *puVar5;
  int *piVar6;
  short *psVar7;
  undefined2 unaff_SS;
  RECT rc;
  short ipt;
  SCAN scan;
  short cpt;
  POINT rgpt;
  undefined2 local_10;
  undefined2 local_e;
  undefined2 local_c;
  undefined2 local_a;
  int pt;
  int local_6;
  
  if ((sel.fl.cord < 2) || (sel.iwpAct == 0)) {
    MessageBeep(0x40);
  }
  else {
    if ((grbitScan & 0x80) != 0) {
      psVar7 = (short *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
      rgpt.x = *psVar7;
      rgpt.y = psVar7[1];
      puVar5 = (undefined2 *)
               ((int)(PLORD *)sel.fl.lpplord + (sel.iwpAct + -1) * 0x12 + 4);
      local_10 = *puVar5;
      local_e = puVar5[1];
      if (sel.iwpAct < sel.fl.cord + -1) {
        cpt = 3;
        puVar5 = (undefined2 *)
                 ((int)(PLORD *)sel.fl.lpplord + (sel.iwpAct + 1) * 0x12 + 4);
        local_c = *puVar5;
        local_a = puVar5[1];
      }
      else {
        cpt = 2;
      }
    }
    RedrawScanSel(0,0);
    rc.bottom = (short)((PLORD *)sel.fl.lpplord + 1);
    ipt = sel.fl.lpplord._2_2_;
    rc.top = (short)((PLORD *)sel.fl.lpplord + 1);
    rc.right = sel.fl.lpplord._2_2_;
    __fmemmove((void *)CONCAT22(sel.fl.lpplord._2_2_,
                                        (void *)(rc.top + sel.iwpAct * 0x12)),
                       (void *)CONCAT22(sel.fl.lpplord._2_2_,
                                        (void *)(rc.bottom + (sel.iwpAct + 1) * 0x12)),
                       ((sel.fl.cord - sel.iwpAct) + -1) * 0x12);
    sel.fl.cord = sel.fl.cord + -1;
    pbVar1 = &((PLORD *)sel.fl.lpplord)->iordMac;
    *pbVar1 = *pbVar1 - 1;
    iVar2 = sel.iwpAct + -1;
    if (iVar2 < sel.fl.cord + -1) {
      piVar6 = (int *)((int)(PLORD *)sel.fl.lpplord + iVar2 * 0x12 + 4);
      pt = *piVar6;
      local_6 = piVar6[1];
      piVar6 = (int *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
      if ((pt == *piVar6) && (local_6 == piVar6[1])) {
        rc.bottom = (short)((PLORD *)sel.fl.lpplord + 1);
        iVar3 = sel.iwpAct + 1;
        ipt = sel.fl.lpplord._2_2_;
        rc.top = (short)((PLORD *)sel.fl.lpplord + 1);
        rc.right = sel.fl.lpplord._2_2_;
        iVar4 = sel.iwpAct * 0x12;
        sel.iwpAct = iVar2;
        __fmemmove((void *)CONCAT22(sel.fl.lpplord._2_2_,(void *)(rc.top + iVar4))
                           ,(void *)CONCAT22(sel.fl.lpplord._2_2_,
                                             (void *)(rc.bottom + iVar3 * 0x12)),
                           ((sel.fl.cord - iVar2) + -2) * 0x12);
        sel.fl.cord = sel.fl.cord + -1;
        pbVar1 = &((PLORD *)sel.fl.lpplord)->iordMac;
        *pbVar1 = *pbVar1 - 1;
        iVar2 = sel.iwpAct;
      }
    }
    sel.iwpAct = iVar2;
    if ((fBackup == 0) && (sel.iwpAct < sel.fl.cord + -1)) {
      sel.iwpAct = sel.iwpAct + 1;
    }
    RedrawScanSel(0,0);
    FLookupFleet(-1,(FLEET *)&sel.fl);
    psVar7 = (short *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
    pt_00.y = psVar7[1];
    pt_00.x = *psVar7;
    FFindNearestObject(pt_00,0x8f,&scan);
    sel.iwpAct = -2;
    ChangeScanSel(&scan,1);
    if ((grbitScan & 0x80) != 0) {
      for (ipt = 0; ipt < cpt; ipt = ipt + 1) {
        LogicalToScan(&rgpt + ipt);
      }
      BoundPoints(&rc,&rgpt,cpt);
      InvalidateRect(hwndScanner,&rc,1);
    }
  }
  return;
}



// ======================================================================
// Function: DeleteWpFar
// Address: 1050:9e28
// Segment: MEMORY_SHIP
// ======================================================================


void DeleteWpFar(FLEET *lpfl,short iDel,short fRecycle)

{
  byte *pbVar1;
  undefined2 *puVar2;
  undefined2 *puVar3;
  undefined2 uVar4;
  undefined2 uVar5;
  int iVar6;
  FLEET *pFVar7;
  int *piVar8;
  int *piVar9;
  undefined2 *puVar10;
  undefined2 *puVar11;
  undefined2 uVar12;
  undefined2 unaff_SS;
  undefined2 ord [10];
  
  pFVar7 = (FLEET *)lpfl;
  uVar12 = (undefined2)((ulong)lpfl >> 0x10);
  if (fRecycle != 0) {
    if ((iDel != 0x56) && (pFVar7->cord != 2)) {
      uVar5 = *(undefined2 *)((int)&pFVar7->lpplord + 2);
      piVar8 = (int *)(*(int *)&pFVar7->lpplord + 4 + iDel * 0x12);
      uVar4 = *(undefined2 *)((int)&pFVar7->lpplord + 2);
      piVar9 = (int *)(*(int *)&pFVar7->lpplord + 4 + (pFVar7->cord + -1) * 0x12);
      if ((*piVar9 != *piVar8) || (piVar9[1] != piVar8[1])) {
        uVar5 = *(undefined2 *)((int)&pFVar7->lpplord + 2);
        puVar11 = (undefined2 *)(*(int *)&pFVar7->lpplord + 4 + iDel * 0x12);
        puVar10 = ord;
        for (iVar6 = 9; iVar6 != 0; iVar6 = iVar6 + -1) {
          puVar3 = puVar10;
          puVar10 = puVar10 + 1;
          puVar2 = puVar11;
          puVar11 = puVar11 + 1;
          *puVar3 = *puVar2;
        }
        goto LAB_1050_9ef2;
      }
    }
    fRecycle = 0;
  }
LAB_1050_9ef2:
  __fmemmove((void *)CONCAT22(*(undefined2 *)((int)&pFVar7->lpplord + 2),
                                      (void *)(*(int *)&pFVar7->lpplord + 4 + iDel * 0x12)),
                     (void *)CONCAT22(*(undefined2 *)((int)&pFVar7->lpplord + 2),
                                      (void *)(*(int *)&pFVar7->lpplord + 4 + (iDel + 1) * 0x12)),
                     ((pFVar7->cord - iDel) + -1) * 0x12);
  if (fRecycle == 0) {
    pFVar7->cord = pFVar7->cord + -1;
    pbVar1 = &((PLORD *)pFVar7->lpplord)->iordMac;
    *pbVar1 = *pbVar1 - 1;
  }
  else {
    uVar5 = *(undefined2 *)((int)&pFVar7->lpplord + 2);
    puVar11 = (undefined2 *)(*(int *)&pFVar7->lpplord + 4 + (pFVar7->cord + -1) * 0x12);
    puVar10 = ord;
    for (iVar6 = 9; iVar6 != 0; iVar6 = iVar6 + -1) {
      puVar3 = puVar11;
      puVar11 = puVar11 + 1;
      puVar2 = puVar10;
      puVar10 = puVar10 + 1;
      *puVar3 = *puVar2;
    }
  }
  return;
}



// ======================================================================
// Function: EstFuelUse
// Address: 1050:9fe4
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1050a4de) */
/* WARNING: Removing unreachable block (ram,0x1050a4f6) */
/* WARNING: Removing unreachable block (ram,0x1050a3d8) */
/* WARNING: Removing unreachable block (ram,0x1050a680) */
/* WARNING: Removing unreachable block (ram,0x1050a50e) */
/* WARNING: Removing unreachable block (ram,0x1050a526) */
/* WARNING: Removing unreachable block (ram,0x1050a53e) */

long EstFuelUse(FLEET *lpfl,short iOrd,short iWarp,long dTravel,short fRangeOnly)

{
  uint *puVar1;
  uint uVar2;
  short sVar3;
  ORDER *pOVar4;
  FLEET *pFVar5;
  int iVar6;
  SHDEF *pSVar7;
  short unaff_SI;
  uint unaff_DI;
  undefined2 uVar8;
  bool bVar9;
  HULDEF *pHVar10;
  ENGINE *pEVar11;
  double *pdVar12;
  ulong uVar13;
  long lVar14;
  undefined2 uVar15;
  undefined2 uVar16;
  int in_stack_0000ff86;
  uint in_stack_0000ff88;
  uint rgieff [32];
  long wtMass;
  short j;
  uint wtCargo;
  int local_2e;
  SHDEF *lpshdef;
  short i;
  ORDER *lpord;
  undefined4 lFuel;
  undefined4 wtCargoT;
  uint iEffCur;
  uint local_18;
  double d;
  short fEfficient;
  long lT;
  uint iEffNext;
  uint local_6;
  
  iEffCur = 0;
  local_18 = 0;
  gd.grBits._0_2_ = (uint)gd.grBits & 0xffbf;
  pFVar5 = (FLEET *)lpfl;
  uVar8 = (undefined2)((ulong)lpfl >> 0x10);
  if (iWarp == -1) {
    iWarp = *(uint *)(*(int *)&pFVar5->lpplord + (iOrd + 1) * 0x12 + 10) >> 4 & 0xf;
  }
  fEfficient = GetRaceGrbit((PLAYER *)rgplr + pFVar5->iPlayer,ibitRaceIFE);
  i = 0;
  iVar6 = pFVar5->iPlayer * 4;
  lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iVar6 + 0x100),(SHDEF *)*(undefined2 *)(iVar6 + 0xfe))
  ;
  do {
    if (0xf < i) {
      wtCargo = 0;
      local_2e = 0;
      for (i = 0; i < 4; i = i + 1) {
        uVar2 = *(uint *)(pFVar5->rgwtMin + i);
        bVar9 = CARRY2(wtCargo,uVar2);
        wtCargo = wtCargo + uVar2;
        local_2e = local_2e + *(uint *)((int)(pFVar5->rgwtMin + i) + 2) + (uint)bVar9;
      }
      if (((int)dTravel == -1) && (dTravel._2_2_ == -1)) {
        if (fRangeOnly == 0) {
          in_stack_0000ff88 = *(uint *)((int)&pFVar5->lpplord + 2);
          in_stack_0000ff86 = *(int *)&pFVar5->lpplord + 4;
          pOVar4 = (ORDER *)(in_stack_0000ff86 + iOrd * 0x12);
          lpord = (ORDER *)CONCAT22(in_stack_0000ff88,pOVar4);
          pdVar12 = DGetDistance((double *)CONCAT22((pOVar4->pt).y,(double *)(lpord->pt).x),
                                       ((pOVar4 + 1)->pt).x,pOVar4[1].pt.y,unaff_DI,unaff_SI);
          d = *(double *)pdVar12;
          lVar14 = __ftol((double)CONCAT26(in_stack_0000ff88,
                                                   CONCAT24(in_stack_0000ff86,
                                                            CONCAT22(unaff_SI,unaff_DI))));
          dTravel = (long)(int)lVar14;
        }
        else {
          dTravel = 1000;
        }
      }
      uVar13 = CONCAT22(wtCargoT._2_2_,(undefined2)wtCargoT);
      lFuel._0_2_ = 0;
      lFuel._2_2_ = 0;
      lFuel = 0;
      while( true ) {
        iEffNext = 0x423f;
        local_6 = 0xf;
        for (i = 0; wtCargoT = uVar13, i < 0x10; i = i + 1) {
          if (0 < pFVar5->rgcsh[i]) {
            if ((rgieff[i * 2] == iEffCur) && (rgieff[i * 2 + 1] == local_18)) {
              iVar6 = pFVar5->iPlayer * 4;
              sVar3 = WtMaxShdefStat((SHDEF *)CONCAT22(*(undefined2 *)(iVar6 + 0x100),
                                                       (SHDEF *)(*(int *)(iVar6 + 0xfe) + i * 0x93))
                                     ,grStatCargo);
              uVar13 = __aFulmul((long)pFVar5->rgcsh[i],(long)sVar3);
              if (CONCAT22(local_2e,wtCargo) < (long)uVar13) {
                uVar13 = CONCAT22(local_2e,wtCargo);
              }
              else {
                iVar6 = pFVar5->iPlayer * 4;
                sVar3 = WtMaxShdefStat((SHDEF *)CONCAT22(*(undefined2 *)(iVar6 + 0x100),
                                                         (SHDEF *)(*(int *)(iVar6 + 0xfe) + i * 0x93
                                                                  )),grStatCargo);
                uVar13 = __aFulmul((long)pFVar5->rgcsh[i],(long)sVar3);
              }
              wtCargoT = uVar13;
              bVar9 = wtCargo < (uint)uVar13;
              wtCargo = wtCargo - (uint)uVar13;
              local_2e = (local_2e - (int)(uVar13 >> 0x10)) - (uint)bVar9;
              if ((-1 < (int)rgieff[i * 2 + 1]) &&
                 ((0 < (int)rgieff[i * 2 + 1] || (rgieff[i * 2] != 0)))) {
                iVar6 = pFVar5->iPlayer * 4;
                uVar13 = __aFulmul((long)pFVar5->rgcsh[i],
                                           (ulong)*(uint *)(*(int *)(iVar6 + 0xfe) + i * 0x93 + 0x28
                                                           ));
                wtMass = uVar13 + wtCargoT;
                uVar13 = __aFulmul(CONCAT22(local_18,iEffCur),dTravel);
                lT = uVar13;
                if ((wtMass < 200) ||
                   ((((long)uVar13 < 500000 && (wtMass < 4000)) ||
                    (((long)uVar13 < 100000 && (wtMass < 20000)))))) {
                  uVar16 = 0;
                  uVar15 = 2000;
                  uVar13 = __aFulmul(wtMass,uVar13);
                  lVar14 = __aFldiv(uVar13,CONCAT22(uVar16,uVar15));
                  lFuel = lVar14 + lFuel;
                  uVar13 = wtCargoT;
                }
                else {
                  lVar14 = __ftol((double)CONCAT26(in_stack_0000ff88,
                                                           CONCAT24(in_stack_0000ff86,
                                                                    CONCAT22(unaff_SI,unaff_DI))));
                  lFuel = lVar14 + lFuel;
                  uVar13 = wtCargoT;
                }
              }
            }
            else if (((int)local_18 <= (int)rgieff[i * 2 + 1]) &&
                    (((int)local_18 < (int)rgieff[i * 2 + 1] || (iEffCur < rgieff[i * 2])))) {
              if (((int)rgieff[i * 2 + 1] <= (int)local_6) &&
                 (((int)rgieff[i * 2 + 1] < (int)local_6 || (rgieff[i * 2] < iEffNext)))) {
                iEffNext = rgieff[i * 2];
                local_6 = rgieff[i * 2 + 1];
              }
            }
          }
        }
        if ((iEffNext == 0x423f) && (local_6 == 0xf)) break;
        iEffCur = iEffNext;
        local_18 = local_6;
      }
      if (fRangeOnly == 0) {
        lFuel = lFuel + 9;
      }
      lVar14 = __aFldiv(lFuel,10);
      if (fRangeOnly != 0) {
        if (lVar14 == 0) {
          lVar14 = 1000000000;
        }
        else {
          lFuel = lVar14;
          if (lVar14 < 0x186a1) {
            uVar13 = __aFulmul(CONCAT22(*(undefined2 *)((int)pFVar5->rgwtMin + 0x12),
                                                (int)pFVar5->rgwtMin[4]),1000);
            lVar14 = __aFldiv(uVar13,lVar14);
          }
          else {
            lVar14 = __aFldiv(lVar14,1000);
            lVar14 = __aFldiv(CONCAT22(*(undefined2 *)((int)pFVar5->rgwtMin + 0x12),
                                               (int)pFVar5->rgwtMin[4]),lVar14);
          }
        }
      }
      return lVar14;
    }
    if (pFVar5->rgcsh[i] != 0) {
      j = 0;
      while( true ) {
        uVar15 = (undefined2)((ulong)lpshdef >> 0x10);
        pSVar7 = (SHDEF *)lpshdef;
        if (((int)(uint)(pSVar7->hul).chs <= j) || (((pSVar7->hul).rghs + j)->grhst == hstEngine))
        break;
        j = j + 1;
      }
      if (j != (uint)(pSVar7->hul).chs) {
        in_stack_0000ff88 = (pSVar7->hul).rghs[j].wFlags_0x2 >> 8;
        pHVar10 = LphuldefFromId((lpshdef->hul).ihuldef);
        if ((((HULDEF *)pHVar10)->hul).rghs[j].wFlags_0x2 >> 8 <= in_stack_0000ff88) {
          unaff_DI = (((SHDEF *)lpshdef)->hul).rghs[j].wFlags_0x2 & 0xff;
          pEVar11 = LpengineFromId(unaff_DI);
          sVar3 = i;
          uVar2 = ((ENGINE *)pEVar11)->rgcFuelUsed[iWarp];
          rgieff[i * 2] = uVar2;
          rgieff[sVar3 * 2 + 1] = (int)uVar2 >> 0xf;
          if (fEfficient != 0) {
            unaff_SI = 0;
            unaff_DI = 100;
            uVar13 = __aFulmul(CONCAT22(rgieff[i * 2 + 1],rgieff[i * 2]),0xf);
            lVar14 = __aFldiv(uVar13,CONCAT22(unaff_SI,unaff_DI));
            sVar3 = i;
            puVar1 = rgieff + i * 2;
            uVar2 = *puVar1;
            *puVar1 = *puVar1 - (uint)lVar14;
            rgieff[sVar3 * 2 + 1] =
                 (rgieff[sVar3 * 2 + 1] - (int)((ulong)lVar14 >> 0x10)) -
                 (uint)(uVar2 < (uint)lVar14);
          }
          if (((((SHDEF *)lpshdef)->hul).rghs[j].wFlags_0x2 & 0xff) == 10) {
            gd.grBits._0_2_ = (uint)gd.grBits & 0xffbf | 0x40;
          }
          goto LAB_1050_a07d;
        }
      }
      sVar3 = i;
      rgieff[i * 2] = 0x869f;
      rgieff[sVar3 * 2 + 1] = 1;
    }
LAB_1050_a07d:
    i = i + 1;
    lpshdef = (SHDEF *)lpshdef + 1;
  } while( true );
}



// ======================================================================
// Function: FakeEditProc
// Address: 1050:a700
// Segment: MEMORY_SHIP
// ======================================================================


long FakeEditProc(HWND hwnd,WMType msg,ushort wParam,long lParam)

{
  LRESULT LVar1;
  
  if ((msg == WM_CHAR) && (((wParam < 0x30 || (0x39 < wParam)) && (wParam != 8)))) {
    LVar1 = 0;
  }
  else {
    LVar1 = CallWindowProc((fn_lpfnRealEditProc *)
                           CONCAT22(lpfnRealEditProc._2_2_,
                                    (fn_lpfnRealEditProc *)lpfnRealEditProc),hwnd,msg,
                           wParam,lParam);
  }
  return LVar1;
}



// ======================================================================
// Function: IFindIdealWarp
// Address: 1050:a76e
// Segment: MEMORY_SHIP
// ======================================================================


short IFindIdealWarp(FLEET *lpfl,short fIgnoreScoops)

{
  uint id;
  ENGINE *pEVar1;
  undefined2 uVar2;
  int iVar3;
  ENGINE *pEVar4;
  short iWorst;
  short j;
  short i;
  
  iWorst = 10;
  if (((FLEET *)lpfl == (FLEET *)0x0) && (lpfl._2_2_ == 0)) {
    lpfl = &sel.fl;
  }
  i = 0;
  do {
    if (0xf < i) {
      return iWorst;
    }
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      j = 0;
      while ((iVar3 = ((FLEET *)lpfl)->iPlayer * 4,
             j < (int)(uint)*(byte *)(*(int *)(iVar3 + 0xfe) + i * 0x93 + 0x7a) &&
             (iVar3 = ((FLEET *)lpfl)->iPlayer * 4,
             *(int *)(*(int *)(iVar3 + 0xfe) + i * 0x93 + 0x3a + j * 4) != 1))) {
        j = j + 1;
      }
      iVar3 = ((FLEET *)lpfl)->iPlayer * 4;
      if (j == (uint)*(byte *)(*(int *)(iVar3 + 0xfe) + i * 0x93 + 0x7a)) {
        return 0;
      }
      iVar3 = ((FLEET *)lpfl)->iPlayer * 4;
      id = *(uint *)(*(int *)(iVar3 + 0xfe) + i * 0x93 + j * 4 + 0x3c) & 0xff;
      pEVar4 = LpengineFromId(id);
      uVar2 = (undefined2)((ulong)pEVar4 >> 0x10);
      pEVar1 = (ENGINE *)pEVar4;
      for (; 0 < iWorst; iWorst = iWorst + -1) {
        if (pEVar1->rgcFuelUsed[iWorst] < 0x79) {
          if ((((0 < pEVar1->rgcFuelUsed[iWorst]) && (fIgnoreScoops == 0)) && (id != 0xe)) &&
             (id != 0xf)) {
            if ((iWorst < 5) || (pEVar1->rgcFuelUsed[iWorst + -1] != 0)) {
              if ((iWorst < 6) || (pEVar1->rgcFuelUsed[iWorst + -2] != 0)) {
                if ((6 < iWorst) && (pEVar1->rgwtOreCost[iWorst + 2] == 0)) {
                  iWorst = iWorst + -3;
                }
              }
              else {
                iWorst = iWorst + -2;
              }
            }
            else {
              iWorst = iWorst + -1;
            }
          }
          if (((((iWorst == 10) && (id != 7)) && (id != 8)) && ((id != 9 && (id != 0xe)))) &&
             (id != 0xf)) {
            iWorst = 9;
          }
          break;
        }
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: LFuelUseToWaypoint
// Address: 1050:a9f4
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lFuelGain */
/* WARNING: Variable defined which should be unmapped: dbl */
/* WARNING: Variable defined which should be unmapped: lpshdef */
/* WARNING: Removing unreachable block (ram,0x1050acd4) */

long LFuelUseToWaypoint(FLEET *lpfl,short iwp,short fMaxCargo)

{
  undefined2 uVar1;
  int iVar2;
  uint uVar3;
  FLEET *pFVar4;
  PLANET *pPVar5;
  undefined2 uVar6;
  FLEET *pFVar7;
  short *psVar8;
  undefined2 unaff_SI;
  FLEET *unaff_DI;
  undefined2 uVar9;
  bool bVar10;
  ulong uVar11;
  long lVar12;
  PLANET *pPVar13;
  HULDEF *pHVar14;
  FLEET *pFVar15;
  undefined2 uVar16;
  FLEET *in_stack_0000ffc2;
  FLEET *in_stack_0000ffc4;
  long lFuelGain;
  FLEET *pFVar17;
  FLEET *pFVar19;
  double dbl;
  short j;
  SHDEF *lpshdef;
  short cYears;
  uint lTot;
  int local_14;
  short i;
  PLANET *lppl;
  short dist;
  short iWarp;
  uint lCur;
  int local_6;
  uint uVar18;
  
  pFVar15 = (FLEET *)CONCAT22(unaff_SI,unaff_DI);
  lTot = 0;
  local_14 = 0;
  lCur = 0;
  local_6 = 0;
  uVar9 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar7 = (FLEET *)lpfl;
  uVar1 = *(undefined2 *)((int)&pFVar7->lpplord + 2);
  iVar2 = *(int *)&pFVar7->lpplord + 4;
  i = 0;
  while( true ) {
    if (iwp <= i) break;
    uVar3 = *(uint *)(iVar2 + (i + 1) * 0x12 + 6) >> 4;
    pFVar4 = (FLEET *)(uVar3 & 0xf);
    if ((pFVar4 == (FLEET *)0x0) || ((FLEET *)0xa < pFVar4)) {
      cYears = 1;
      pFVar17 = (FLEET *)0x0;
      pFVar19 = (FLEET *)0x0;
    }
    else {
      DGetDistance((double *)
                         CONCAT22(*(undefined2 *)(iVar2 + i * 0x12 + 2),
                                  (double *)*(undefined2 *)(iVar2 + i * 0x12)),
                         *(short *)(iVar2 + (i + 1) * 0x12),*(short *)(iVar2 + (i + 1) * 0x12 + 2),
                         (short)(FLEET *)pFVar15,(short)((ulong)pFVar15 >> 0x10));
      lVar12 = __ftol((double)CONCAT26(in_stack_0000ffc4,CONCAT24(in_stack_0000ffc2,pFVar15)
                                              ));
      dist = (short)lVar12;
      in_stack_0000ffc4 = (FLEET *)0x0;
      in_stack_0000ffc2 = pFVar4;
      lVar12 = __ftol((double)((qword)CONCAT24(uVar3,pFVar15) & 0xffff000fffffffff));
      cYears = (short)lVar12;
      lVar12 = EstFuelUse(lpfl,i,(short)pFVar4,-1,0);
      pFVar19 = (FLEET *)((ulong)lVar12 >> 0x10);
      pFVar17 = (FLEET *)(lVar12 << 0x10);
    }
    if (1 < cYears) {
      uVar11 = EstFuelUse(lpfl,i,(short)pFVar4,(long)((int)pFVar4 * (int)pFVar4),0);
      __aFulmul(uVar11,(long)(cYears + -1));
      in_stack_0000ffc2 = (FLEET *)i;
      in_stack_0000ffc4 = pFVar4;
      pFVar15 = lpfl;
      EstFuelUse(lpfl,i,(short)pFVar4,(long)(dist - (int)pFVar4 * (int)pFVar4 * (cYears + -1)),0);
      pFVar17 = lpfl;
      lVar12 = LCalcFuelGainFromRamScoops
                         (lpfl,(short)pFVar4,(long)((int)pFVar4 * (int)pFVar4));
      j = 0;
      pFVar19 = pFVar4;
      while( true ) {
        lFuelGain._2_2_ = (int)((ulong)lVar12 >> 0x10);
        lFuelGain._0_2_ = (uint)lVar12;
        if (0xf < j) break;
        if ((pFVar7->rgcsh[j] != 0) &&
           ((lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x100),
                                         (SHDEF *)(*(int *)(idPlayer * 4 + 0xfe) + j * 0x93))
            , (lpshdef->hul).ihuldef == ihuldefFuelTransport ||
            ((lpshdef->hul).ihuldef == ihuldefSuperFuelXport)))) {
          psVar8 = pFVar7->rgcsh + j;
          j = *psVar8 >> 0xf;
          uVar11 = __aFulmul((long)*psVar8,200);
          lVar12 = uVar11 + lVar12;
        }
        j = j + 1;
      }
      if (0 < lVar12) {
        pFVar4 = (FLEET *)pFVar17;
        if ((lFuelGain._2_2_ < (int)pFVar4) ||
           ((lFuelGain._2_2_ <= (int)pFVar4 && ((uint)lFuelGain < 0x1050)))) {
          lpshdef = (SHDEF *)(long)(cYears + -1);
          uVar11 = __aFulmul(CONCAT22((int)pFVar4 +
                                              (-(uint)(0x1050 < (uint)lFuelGain) - lFuelGain._2_2_),
                                              0x1050 - (uint)lFuelGain),(ulong)lpshdef);
          uVar3 = (uint)(uVar11 - 0xbefb0);
          pFVar4 = (FLEET *)((int)((FLEET *)pFVar17)->rgcsh + (int)(uVar11 - 0xbefb0 >> 0x10));
          uVar18 = (uint)((ulong)pFVar17 >> 0x10);
          pFVar17 = (FLEET *)CONCAT22(uVar18,pFVar4);
          if (((int)pFVar4 <= (int)pFVar19) && (((int)pFVar4 < (int)pFVar19 || (uVar3 < uVar18)))) {
            pFVar17 = (FLEET *)CONCAT22(uVar3,pFVar4);
            pFVar19 = pFVar4;
          }
        }
        else {
          pFVar17 = pFVar4;
          pFVar19 = pFVar4;
        }
      }
    }
    uVar3 = (uint)((ulong)pFVar17 >> 0x10);
    bVar10 = CARRY2(lCur,uVar3);
    lCur = lCur + uVar3;
    local_6 = (int)pFVar19->rgcsh + (uint)bVar10 + local_6 + -0xc;
    if ((local_14 <= local_6) && ((local_14 < local_6 || (lTot < lCur)))) {
      lTot = lCur;
      local_14 = local_6;
    }
    if ((*(uint *)(iVar2 + (i + 1) * 0x12 + 6) >> 8 & 0xf) == 1) {
      pPVar13 = LpplFromId(*(short *)(iVar2 + (i + 1) * 0x12 + 4));
      uVar16 = (undefined2)((ulong)pFVar15 >> 0x10);
      uVar6 = (undefined2)((ulong)pPVar13 >> 0x10);
      pPVar5 = (PLANET *)pPVar13;
      if (((pPVar13 != (PLANET *)0x0) && (pPVar5->iPlayer == idPlayer)) &&
         ((pPVar5->wFlags_0x4 >> 9 & 1) != 0)) {
        pFVar4 = (FLEET *)*(HullDef *)
                           (*(int *)(idPlayer * 4 + 0x14c) +
                           (*(uint *)&pPVar5->lStarbase & 0xf) * 0x93);
        pHVar14 = LphuldefFromId((HullDef)pFVar4);
        pFVar15 = (FLEET *)CONCAT22(uVar16,pFVar4);
        if ((((HULDEF *)pHVar14)->hul).wtCargoMax != 0) {
          lCur = 0;
          local_6 = 0;
          pFVar15 = (FLEET *)CONCAT22(uVar16,pFVar4);
        }
      }
    }
    i = i + 1;
  }
  return CONCAT22(local_14,lTot);
}



// ======================================================================
// Function: FleetTransferCargoBalance
// Address: 1050:ae74
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1050c10c) */
/* WARNING: Removing unreachable block (ram,0x1050b3ee) */
/* WARNING: Removing unreachable block (ram,0x1050c0db) */
/* WARNING: Removing unreachable block (ram,0x1050bfc6) */
/* WARNING: Removing unreachable block (ram,0x1050c066) */
/* WARNING: Removing unreachable block (ram,0x1050b848) */

void FleetTransferCargoBalance(FLEET *pflNew1,FLEET *pflNew2)

{
  uint *puVar1;
  int iVar2;
  uint uVar3;
  FLEET *pFVar4;
  short sVar5;
  uint uVar6;
  int iVar7;
  int iVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  bool bVar9;
  ulong uVar10;
  ulong uVar11;
  ulong uVar12;
  long lVar13;
  ulong uVar14;
  ulong uVar15;
  undefined2 uVar16;
  uint uVar17;
  undefined2 uVar18;
  undefined2 in_stack_0000fe3c;
  uint in_stack_0000fe3e;
  short iSrc;
  short ishdef;
  uint rgCargoCapacity [4];
  SHDEF *lpshdef;
  undefined2 local_19a;
  short j;
  FLEET rgflCur;
  int local_10e [56];
  uint rgFuelCapLoss [4];
  undefined4 lChg;
  short i;
  short wtFuelMax;
  short wtCargoMax;
  FLEET *rgpflNew [2];
  uint rgFuelCapacity [12];
  uint auStack_70 [12];
  uint rgrgcshLoss [16];
  int local_38 [16];
  long wtCargoTot;
  short fDeadFleet;
  long wtCargoXfer;
  uint rgCargoCapLoss [4];
  short iplr;
  
  fDeadFleet = 0;
  rgpflNew[0] = pflNew1;
  rgpflNew[1] = pflNew2;
  iplr = pflNew1->iPlayer;
  for (i = 0; i < 2; i = i + 1) {
    if ((rgpflNew[i]->wFlags_0x4 >> 10 & 1) == 0) {
      FLookupFleet(rgpflNew[i]->id,&rgflCur + i);
    }
    else {
      fDeadFleet = 1;
      _memset(&rgflCur + i,0,0x7c);
      (&rgflCur)[i].iPlayer = iplr;
    }
    sVar5 = i;
    rgCargoCapLoss[i * 2] = 0;
    rgCargoCapLoss[i * 2 + 1] = 0;
    rgCargoCapacity[i * 2] = 0;
    rgCargoCapacity[sVar5 * 2 + 1] = 0;
    sVar5 = i;
    rgFuelCapLoss[i * 2] = 0;
    rgFuelCapLoss[sVar5 * 2 + 1] = 0;
    rgFuelCapacity[i * 2] = 0;
    rgFuelCapacity[i * 2 + 1] = 0;
    for (j = 0; j < 5; j = j + 1) {
      rgFuelCapacity[i * 10 + j * 2 + 4] = 0;
      (rgFuelCapacity + i * 10 + j * 2 + 4)[1] = 0;
    }
  }
  ishdef = 0;
  while( true ) {
    uVar10 = CONCAT22(lChg._2_2_,(uint)lChg);
    uVar14 = CONCAT22(wtCargoXfer._2_2_,(undefined2)wtCargoXfer);
    if (0xf < ishdef) break;
    if ((rgflCur.rgcsh[ishdef] != 0) || (local_10e[ishdef] != 0)) {
      local_19a = *(undefined2 *)(iplr * 4 + 0x100);
      lpshdef = (SHDEF *)(*(int *)(iplr * 4 + 0xfe) + ishdef * 0x93);
      wtFuelMax = WtMaxShdefStat((SHDEF *)CONCAT22(local_19a,lpshdef),grStatFuel);
      wtCargoMax = WtMaxShdefStat((SHDEF *)CONCAT22(local_19a,lpshdef),grStatCargo);
      for (i = 0; i < 2; i = i + 1) {
        rgrgcshLoss[i * 0x10 + ishdef] = (&rgflCur)[i].rgcsh[ishdef] - rgpflNew[i]->rgcsh[ishdef];
        if ((&rgflCur)[i].rgcsh[ishdef] != 0) {
          uVar10 = __aFulmul((long)(&rgflCur)[i].rgcsh[ishdef],(long)wtFuelMax);
          puVar1 = rgFuelCapacity + i * 2;
          uVar6 = *puVar1;
          *puVar1 = *puVar1 + (uint)uVar10;
          rgFuelCapacity[i * 2 + 1] =
               rgFuelCapacity[i * 2 + 1] + (int)(uVar10 >> 0x10) + (uint)CARRY2(uVar6,(uint)uVar10);
          uVar10 = __aFulmul((long)(&rgflCur)[i].rgcsh[ishdef],(long)wtCargoMax);
          sVar5 = i;
          puVar1 = rgCargoCapacity + i * 2;
          uVar6 = *puVar1;
          *puVar1 = *puVar1 + (uint)uVar10;
          rgCargoCapacity[sVar5 * 2 + 1] =
               rgCargoCapacity[sVar5 * 2 + 1] + (int)(uVar10 >> 0x10) +
               (uint)CARRY2(uVar6,(uint)uVar10);
          if (0 < (int)rgrgcshLoss[i * 0x10 + ishdef]) {
            uVar10 = __aFulmul((long)(int)rgrgcshLoss[i * 0x10 + ishdef],(long)wtFuelMax);
            sVar5 = i;
            puVar1 = rgFuelCapLoss + i * 2;
            uVar6 = *puVar1;
            *puVar1 = *puVar1 + (uint)uVar10;
            rgFuelCapLoss[sVar5 * 2 + 1] =
                 rgFuelCapLoss[sVar5 * 2 + 1] + (int)(uVar10 >> 0x10) +
                 (uint)CARRY2(uVar6,(uint)uVar10);
            uVar10 = __aFulmul((long)(int)rgrgcshLoss[i * 0x10 + ishdef],(long)wtCargoMax);
            puVar1 = rgCargoCapLoss + i * 2;
            uVar6 = *puVar1;
            *puVar1 = *puVar1 + (uint)uVar10;
            rgCargoCapLoss[i * 2 + 1] =
                 rgCargoCapLoss[i * 2 + 1] + (int)(uVar10 >> 0x10) +
                 (uint)CARRY2(uVar6,(uint)uVar10);
          }
        }
      }
      if (((fDeadFleet == 0) && (rgrgcshLoss[ishdef] == -local_38[ishdef])) &&
         (rgrgcshLoss[ishdef] != 0)) {
        uVar6 = (uint)((int)rgrgcshLoss[ishdef] < 0);
        if ((&rgflCur)[uVar6].rgcsh[ishdef] < 1) {
          uVar10 = 0;
        }
        else {
          uVar18 = 0;
          uVar16 = 100;
          uVar10 = __aFulmul((ulong)(uint)(&rgflCur)[uVar6].rgcsh[ishdef + 0x10] &
                                     0xffff007f,(long)(&rgflCur)[uVar6].rgcsh[ishdef]);
          uVar10 = __aFldiv(uVar10,CONCAT22(uVar18,uVar16));
        }
        if ((&rgflCur)[uVar6 == 0].rgcsh[ishdef] < 1) {
          uVar14 = 0;
        }
        else {
          uVar18 = 0;
          uVar16 = 100;
          uVar14 = __aFulmul((ulong)(uint)(&rgflCur)[uVar6 == 0].rgcsh[ishdef + 0x10] &
                                     0xffff007f,(long)(&rgflCur)[uVar6 == 0].rgcsh[ishdef]);
          uVar14 = __aFldiv(uVar14,CONCAT22(uVar18,uVar16));
        }
        if ((uVar10 == 0) || (uVar14 == 0)) {
          if (uVar10 == 0) {
            if (uVar14 == 0) {
              rgpflNew[uVar6 == 0]->rgcsh[ishdef + 0x10] =
                   rgpflNew[uVar6 == 0]->rgcsh[ishdef + 0x10] & 0xff80;
            }
            else {
              iVar8 = rgpflNew[uVar6 == 0]->rgcsh[ishdef];
              iVar7 = iVar8 >> 0xf;
              iVar2 = rgpflNew[uVar6 == 0]->rgcsh[ishdef];
              uVar10 = __aFulmul(uVar14,100);
              lVar13 = __aFldiv(uVar10 + (long)iVar2 + -1,CONCAT22(iVar7,iVar8));
              rgpflNew[uVar6 == 0]->rgcsh[ishdef + 0x10] =
                   rgpflNew[uVar6 == 0]->rgcsh[ishdef + 0x10] & 0xff80U | (uint)lVar13 & 0x7f;
            }
          }
          else {
            uVar14 = uVar10;
            if ((long)(int)rgrgcshLoss[uVar6 * 0x10 + ishdef] < (long)uVar10) {
              uVar14 = (long)(int)rgrgcshLoss[uVar6 * 0x10 + ishdef];
            }
            rgpflNew[uVar6 == 0]->rgcsh[ishdef + 0x10] =
                 rgpflNew[uVar6 == 0]->rgcsh[ishdef + 0x10] & 0x7fU |
                 rgpflNew[uVar6]->rgcsh[ishdef + 0x10] & 0xff80U;
            iVar8 = rgpflNew[uVar6 == 0]->rgcsh[ishdef];
            iVar7 = iVar8 >> 0xf;
            iVar2 = rgpflNew[uVar6 == 0]->rgcsh[ishdef];
            uVar15 = __aFulmul(uVar14,100);
            lVar13 = __aFldiv(uVar15 + (long)iVar2 + -1,CONCAT22(iVar7,iVar8));
            in_stack_0000fe3e =
                 rgpflNew[uVar6 == 0]->rgcsh[ishdef + 0x10] & 0xff80U | (uint)lVar13 & 0x7f;
            rgpflNew[uVar6 == 0]->rgcsh[ishdef + 0x10] = in_stack_0000fe3e;
            if (uVar14 == uVar10) {
              rgpflNew[uVar6]->rgcsh[ishdef + 0x10] = 0;
            }
            else {
              iVar8 = rgpflNew[uVar6]->rgcsh[ishdef];
              iVar7 = iVar8 >> 0xf;
              iVar2 = rgpflNew[uVar6]->rgcsh[ishdef];
              uVar10 = __aFulmul(uVar10 - uVar14,100);
              lVar13 = __aFldiv(uVar10 + (long)iVar2 + -1,CONCAT22(iVar7,iVar8));
              rgpflNew[uVar6]->rgcsh[ishdef + 0x10] =
                   rgpflNew[uVar6]->rgcsh[ishdef + 0x10] & 0xff80U | (uint)lVar13 & 0x7f;
            }
          }
        }
        else {
          uVar15 = uVar10;
          if ((long)(int)rgrgcshLoss[uVar6 * 0x10 + ishdef] < (long)uVar10) {
            uVar15 = (long)(int)rgrgcshLoss[uVar6 * 0x10 + ishdef];
          }
          iVar8 = rgpflNew[uVar6 == 0]->rgcsh[ishdef];
          iVar7 = iVar8 >> 0xf;
          iVar2 = rgpflNew[uVar6 == 0]->rgcsh[ishdef];
          uVar11 = __aFulmul(uVar15,(ulong)((uint)(&rgflCur)[uVar6].rgcsh[ishdef + 0x10] >>
                                                   7));
          uVar12 = __aFulmul(uVar14,(ulong)((uint)(&rgflCur)[uVar6 == 0].rgcsh
                                                          [ishdef + 0x10] >> 7));
          lVar13 = __aFldiv(uVar12 + uVar11 + (long)iVar2 + -1,CONCAT22(iVar7,iVar8));
          in_stack_0000fe3c = (undefined2)uVar11;
          rgpflNew[uVar6 == 0]->rgcsh[ishdef + 0x10] =
               rgpflNew[uVar6 == 0]->rgcsh[ishdef + 0x10] & 0x7fU | (int)lVar13 << 7;
          iVar8 = rgpflNew[uVar6 == 0]->rgcsh[ishdef];
          iVar7 = iVar8 >> 0xf;
          iVar2 = rgpflNew[uVar6 == 0]->rgcsh[ishdef];
          uVar14 = __aFulmul(uVar15 + uVar14,100);
          lVar13 = __aFldiv(uVar14 + (long)iVar2 + -1,CONCAT22(iVar7,iVar8));
          in_stack_0000fe3e =
               rgpflNew[uVar6 == 0]->rgcsh[ishdef + 0x10] & 0xff80U | (uint)lVar13 & 0x7f;
          rgpflNew[uVar6 == 0]->rgcsh[ishdef + 0x10] = in_stack_0000fe3e;
          if (uVar15 == uVar10) {
            rgpflNew[uVar6]->rgcsh[ishdef + 0x10] = 0;
          }
          else {
            iVar8 = rgpflNew[uVar6]->rgcsh[ishdef];
            iVar7 = iVar8 >> 0xf;
            iVar2 = rgpflNew[uVar6]->rgcsh[ishdef];
            uVar10 = __aFulmul(uVar10 - uVar15,100);
            lVar13 = __aFldiv(uVar10 + (long)iVar2 + -1,CONCAT22(iVar7,iVar8));
            rgpflNew[uVar6]->rgcsh[ishdef + 0x10] =
                 rgpflNew[uVar6]->rgcsh[ishdef + 0x10] & 0xff80U | (uint)lVar13 & 0x7f;
          }
        }
      }
    }
    ishdef = ishdef + 1;
  }
  i = 0;
  do {
    if (1 < i) {
      for (i = 0; i < 2; i = i + 1) {
        for (j = 0; j < 5; j = j + 1) {
          uVar17 = rgFuelCapacity[i * 10 + j * 2 + 4];
          uVar3 = (rgFuelCapacity + i * 10 + j * 2 + 4)[1];
          pFVar4 = rgpflNew[i];
          puVar1 = (uint *)(pFVar4->rgwtMin + j);
          uVar6 = *puVar1;
          *puVar1 = *puVar1 + uVar17;
          puVar1 = (uint *)((int)(pFVar4->rgwtMin + j) + 2);
          *puVar1 = *puVar1 + uVar3 + (uint)CARRY2(uVar6,uVar17);
          uVar17 = rgFuelCapacity[i * 10 + j * 2 + 4];
          uVar3 = (rgFuelCapacity + i * 10 + j * 2 + 4)[1];
          pFVar4 = rgpflNew[i == 0];
          puVar1 = (uint *)(pFVar4->rgwtMin + j);
          uVar6 = *puVar1;
          *puVar1 = *puVar1 - uVar17;
          puVar1 = (uint *)((int)(pFVar4->rgwtMin + j) + 2);
          *puVar1 = (*puVar1 - uVar3) - (uint)(uVar6 < uVar17);
        }
      }
      return;
    }
    if ((rgFuelCapacity[i * 2] != 0) || (rgFuelCapacity[i * 2 + 1] != 0)) {
      iVar8 = *(int *)((int)rgpflNew[i]->rgwtMin + 0x12);
      lChg = uVar10;
      wtCargoXfer = uVar14;
      if ((iVar8 < 1) && ((iVar8 < 0 || (*(uint *)(rgpflNew[i]->rgwtMin + 4) < 0xafc9)))) {
        if ((-1 < (int)rgFuelCapLoss[i * 2 + 1]) &&
           ((0 < (int)rgFuelCapLoss[i * 2 + 1] || (45000 < rgFuelCapLoss[i * 2]))))
        goto LAB_1050_bd78;
        uVar6 = rgFuelCapacity[i * 2 + 1];
        uVar17 = rgFuelCapacity[i * 2];
        uVar10 = __aFulmul(CONCAT22(*(undefined2 *)((int)rgpflNew[i]->rgwtMin + 0x12),
                                            (int)rgpflNew[i]->rgwtMin[4]),
                                   CONCAT22(rgFuelCapLoss[i * 2 + 1],rgFuelCapLoss[i * 2]));
        uVar10 = __aFldiv(uVar10,CONCAT22(uVar6,uVar17));
        lChg = uVar10;
      }
      else {
LAB_1050_bd78:
        uVar10 = __ftol((double)CONCAT26(in_stack_0000fe3e,
                                                 CONCAT24(in_stack_0000fe3c,
                                                          CONCAT22(unaff_SI,unaff_DI))));
        lChg = uVar10;
      }
      lChg._2_2_ = (int)(uVar10 >> 0x10);
      lChg._0_2_ = (uint)uVar10;
      puVar1 = auStack_70 + i * 10;
      uVar6 = *puVar1;
      *puVar1 = *puVar1 - (uint)lChg;
      auStack_70[i * 10 + 1] = (auStack_70[i * 10 + 1] - lChg._2_2_) - (uint)(uVar6 < (uint)lChg);
      uVar14 = wtCargoXfer;
    }
    if ((rgCargoCapacity[i * 2] != 0) || (rgCargoCapacity[i * 2 + 1] != 0)) {
      wtCargoTot._0_2_ = 0;
      wtCargoTot._2_2_ = 0;
      for (j = 0; j < 4; j = j + 1) {
        uVar6 = *(uint *)(rgpflNew[i]->rgwtMin + j);
        bVar9 = CARRY2((uint)wtCargoTot,uVar6);
        wtCargoTot._0_2_ = (uint)wtCargoTot + uVar6;
        wtCargoTot._2_2_ =
             wtCargoTot._2_2_ + *(uint *)((int)(rgpflNew[i]->rgwtMin + j) + 2) + (uint)bVar9;
      }
      lChg = uVar10;
      wtCargoXfer = uVar14;
      if ((wtCargoTot._2_2_ < 1) && ((wtCargoTot._2_2_ < 0 || ((uint)wtCargoTot < 0xafc9)))) {
        if ((-1 < (int)rgCargoCapLoss[i * 2 + 1]) &&
           ((0 < (int)rgCargoCapLoss[i * 2 + 1] || (45000 < rgCargoCapLoss[i * 2]))))
        goto code_r0x1050bed2;
        uVar6 = rgCargoCapacity[i * 2 + 1];
        uVar17 = rgCargoCapacity[i * 2];
        uVar10 = __aFulmul(CONCAT22(wtCargoTot._2_2_,(uint)wtCargoTot),
                                   CONCAT22(rgCargoCapLoss[i * 2 + 1],rgCargoCapLoss[i * 2]));
        uVar14 = __aFldiv(uVar10,CONCAT22(uVar6,uVar17));
        wtCargoXfer = uVar14;
      }
      else {
code_r0x1050bed2:
        uVar14 = __ftol((double)CONCAT26(in_stack_0000fe3e,
                                                 CONCAT24(in_stack_0000fe3c,
                                                          CONCAT22(unaff_SI,unaff_DI))));
        wtCargoXfer = uVar14;
      }
      lChg = uVar14;
      uVar10 = uVar14;
      if ((uVar14 != 0) && (((uint)wtCargoTot != 0 || (wtCargoTot._2_2_ != 0)))) {
        for (j = 0; j < 4; j = j + 1) {
          uVar6 = *(uint *)((int)(rgpflNew[i]->rgwtMin + j) + 2);
          lChg = uVar10;
          wtCargoXfer = uVar14;
          if (((int)uVar6 < 1) &&
             ((((int)uVar6 < 0 || (*(uint *)(rgpflNew[i]->rgwtMin + j) < 0xafc9)) &&
              ((long)uVar14 < 0xafc9)))) {
            uVar6 = (uint)wtCargoTot;
            iVar8 = wtCargoTot._2_2_;
            uVar10 = __aFulmul(CONCAT22(*(undefined2 *)((int)(rgpflNew[i]->rgwtMin + j) + 2)
                                                ,(int)rgpflNew[i]->rgwtMin[j]),uVar14);
            uVar14 = __aFldiv(uVar10,CONCAT22(iVar8,uVar6));
            uVar10 = lChg;
          }
          else {
            uVar14 = __ftol((double)CONCAT26(in_stack_0000fe3e,
                                                     CONCAT24(in_stack_0000fe3c,
                                                              CONCAT22(unaff_SI,unaff_DI))));
            uVar10 = lChg;
          }
          uVar15 = uVar10;
          if ((long)uVar14 < (long)uVar10) {
            uVar15 = uVar14;
          }
          puVar1 = rgFuelCapacity + i * 10 + j * 2 + 4;
          uVar6 = *puVar1;
          *puVar1 = *puVar1 - (uint)uVar15;
          puVar1 = rgFuelCapacity + i * 10 + j * 2 + 4 + 1;
          *puVar1 = (*puVar1 - (int)(uVar15 >> 0x10)) - (uint)(uVar6 < (uint)uVar15);
          lChg = uVar10 - uVar15;
          uVar10 = uVar10 - uVar15;
          uVar14 = wtCargoXfer;
        }
        if (0 < (long)uVar10) {
          j = 0;
          while( true ) {
            lChg._2_2_ = (int)(uVar10 >> 0x10);
            lChg._0_2_ = (uint)uVar10;
            if ((3 < j) || ((long)uVar10 < 1)) break;
            uVar6 = *(uint *)(rgpflNew[i]->rgwtMin + j);
            puVar1 = rgFuelCapacity + i * 10 + j * 2 + 4;
            iVar8 = *(uint *)((int)(rgpflNew[i]->rgwtMin + j) + 2) +
                    (rgFuelCapacity + i * 10 + j * 2 + 4)[1] + (uint)CARRY2(uVar6,*puVar1);
            if ((-1 < iVar8) && ((0 < iVar8 || (uVar6 + *puVar1 != 0)))) {
              puVar1 = rgFuelCapacity + i * 10 + j * 2 + 4;
              uVar6 = *puVar1;
              wtCargoXfer = uVar14;
              *puVar1 = *puVar1 - 1;
              puVar1 = rgFuelCapacity + i * 10 + j * 2 + 4 + 1;
              *puVar1 = *puVar1 - (uint)(uVar6 == 0);
              bVar9 = (uint)lChg == 0;
              lChg._0_2_ = (uint)lChg + -1;
              lChg._2_2_ = lChg._2_2_ - (uint)bVar9;
              uVar10 = CONCAT22(lChg._2_2_,(uint)lChg);
              uVar14 = wtCargoXfer;
            }
            j = j + 1;
          }
        }
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: DestroyAllIshdefSB
// Address: 1050:c280
// Segment: MEMORY_SHIP
// ======================================================================


void DestroyAllIshdefSB(short ishdefSB,short iplr)

{
  PLANET *pPVar1;
  undefined2 uVar2;
  PLANET *lppl;
  
  pPVar1 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < pPVar1) {
    uVar2 = (undefined2)((ulong)lppl >> 0x10);
    if (((((PLANET *)lppl)->iPlayer == iplr) && ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0)) &&
       ((*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) == ishdefSB)) {
      ((PLANET *)lppl)->wFlags_0x4 = ((PLANET *)lppl)->wFlags_0x4 & 0xfdff;
      KillQueuedShips(lppl);
      KillQueuedMassPackets(lppl);
    }
    lppl = (PLANET *)CONCAT22(uVar2,(PLANET *)lppl + 1);
  }
  return;
}



// ======================================================================
// Function: DestroyAllIshdef
// Address: 1050:c336
// Segment: MEMORY_SHIP
// ======================================================================


void DestroyAllIshdef(short ishdef,short iplr)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  int iVar3;
  FLEET *pFVar4;
  FLEET *pFVar5;
  undefined2 uVar6;
  undefined2 unaff_SS;
  FLEET flNew;
  short cDel;
  short j;
  short grbit;
  short i;
  FLEET *lpfl;
  short cKill;
  FLEET flDead;
  
  cDel = 0;
  if (ishdef < 0x10) {
                    /* WARNING: Load size is inaccurate */
    lpfl = (FLEET *)CONCAT22(*(undefined2 *)((int)(FLEET **)rglpfl + 2),*rglpfl);
    i = 0;
    while (i < cFleet) {
      uVar6 = (undefined2)((ulong)lpfl >> 0x10);
      if ((((FLEET *)lpfl)->iPlayer == iplr) && (0 < ((FLEET *)lpfl)->rgcsh[ishdef])) {
        _memset(&flDead,0,0x7c);
        uVar6 = lpfl._2_2_;
        cKill = ((FLEET *)lpfl)->rgcsh[ishdef];
        cDel = cDel + cKill;
        for (j = 0; (j < 0x10 && ((j == ishdef || (((FLEET *)lpfl)->rgcsh[j] == 0)))); j = j + 1) {
        }
        if (j != 0x10) {
          flDead.id = flDead.id & 0xe1ffU | (iplr & 0xfU) << 9;
          flDead.wFlags_0x4 = flDead.wFlags_0x4 & 0xfbff | 0x400;
          flDead.rgcsh[ishdef] = cKill;
          pFVar4 = &flNew;
          pFVar5 = (FLEET *)lpfl;
          for (iVar3 = 0x3e; iVar3 != 0; iVar3 = iVar3 + -1) {
            pFVar2 = pFVar4;
            pFVar4 = &pFVar4->iPlayer;
            pFVar1 = pFVar5;
            pFVar5 = &pFVar5->iPlayer;
            pFVar2->id = pFVar1->id;
          }
          flNew.rgcsh[ishdef] = 0;
          FleetTransferCargoBalance(&flNew,&flDead);
          pFVar4 = &flNew;
          pFVar5 = (FLEET *)lpfl;
          for (iVar3 = 0x3e; iVar3 != 0; iVar3 = iVar3 + -1) {
            pFVar2 = pFVar5;
            pFVar5 = &pFVar5->iPlayer;
            pFVar1 = pFVar4;
            pFVar4 = &pFVar4->iPlayer;
            pFVar2->id = pFVar1->id;
          }
          if ((sel.grobj == grobjFleet) && (sel.fl.id == flNew.id)) {
            FLookupFleet(flNew.id,(FLEET *)&sel.fl);
            RedrawScanSel(0,0);
            FillShipDD(sel.fl.id);
            grbit = -0x7c4b;
            FLookupFleet(sel.fl.id,(FLEET *)&sel.fl);
            FillFleetCompLB();
            DrawPlanShip(0,grbit);
            InvalidateRect(hwndMine,(RECT *)0x0,1);
          }
          goto SHIP_IncrementI;
        }
        ((FLEET *)lpfl)->rgcsh[ishdef] = 0;
        FDeleteFleet(lpfl->id,0,-1);
      }
      else {
SHIP_IncrementI:
        i = i + 1;
      }
                    /* WARNING: Load size is inaccurate */
      lpfl = (FLEET *)CONCAT22(*(undefined2 *)((int)((FLEET **)rglpfl + i) + 2),
                               ((FLEET **)rglpfl)[i]);
    }
    InvalidateReport(1,1);
  }
  else {
    DestroyAllIshdefSB(ishdef + -0x10,iplr);
    InvalidateReport(0,1);
  }
  RemoveIshdefFromAllQueues(ishdef,0);
  return;
}



// ======================================================================
// Function: RemoveIshdefFromAllQueues
// Address: 1050:c5e6
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1050c716) */

void RemoveIshdefFromAllQueues(short ishdef,short fSpaceDocks)

{
  undefined2 uVar1;
  undefined2 uVar2;
  PLANET *pPVar3;
  undefined2 *puVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  undefined2 uVar6;
  ulong uVar7;
  ulong uVar8;
  PLANET *pPVar9;
  PROD *lpprod;
  short iDst;
  PLANET *lppl;
  short iprod;
  
  uVar8 = CONCAT22(unaff_SI,unaff_DI);
  pPVar3 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  pPVar9 = (PLANET *)lpPlanets;
  while ((PLANET *)lppl < pPVar3) {
    uVar5 = (undefined2)((ulong)lppl >> 0x10);
    if (((((*(int *)&((PLANET *)lppl)->lpplprod != 0) ||
          (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) &&
         (((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac != 0)) &&
        ((((PLANET *)lppl)->iPlayer == idPlayer &&
         ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0)))) &&
       ((fSpaceDocks == 0 ||
        (*(int *)(*(int *)(idPlayer * 4 + 0x14c) +
                 (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93) == 0x21)))) {
      iDst = 0;
      iprod = 0;
      lpprod = (PROD *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                (PROD *)(*(int *)&((PLANET *)lppl)->lpplprod + 4));
      for (; iprod < (int)(uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac; iprod = iprod + 1)
      {
        uVar7 = __aFulshr(uVar8,(ushort)pPVar9);
        uVar6 = (undefined2)((ulong)lpprod >> 0x10);
        if ((((uint)uVar7 & 7) != 2) ||
           (uVar7 = __aFulshr(uVar8,(ushort)pPVar9), ((uint)uVar7 & 0x7f) != ishdef)) {
          if (iDst != iprod) {
            uVar1 = *(undefined2 *)((int)&((PROD *)lpprod)->dwFlags + 2);
            uVar2 = *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2);
            puVar4 = (undefined2 *)(*(int *)&((PLANET *)lppl)->lpplprod + 4 + iDst * 4);
            *puVar4 = (int)lpprod->dwFlags;
            puVar4[1] = uVar1;
          }
          iDst = iDst + 1;
        }
        lpprod = (PROD *)CONCAT22(uVar6,(PROD *)lpprod + 1);
      }
      if (iDst == 0) {
        FreePl((PL *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                      *(PL **)&((PLANET *)lppl)->lpplprod));
        *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
        *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
      }
      else if (iDst != iprod) {
        ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac = (byte)iDst;
      }
    }
    lppl = (PLANET *)CONCAT22(uVar5,(PLANET *)lppl + 1);
  }
  if ((sel.grobj == grobjPlanet) &&
     (((PLPROD *)sel.pl.lpplprod != (PLPROD *)0x0 ||
      (sel.pl.lpplprod._2_2_ != 0)))) {
    FLookupPlanet(sel.pl.id,(PLANET *)&sel.pl);
    FillPlanetProdLB
              (hwndPlanetProdLB,
               (PLPROD *)
               CONCAT22(sel.pl.lpplprod._2_2_,(PLPROD *)sel.pl.lpplprod),
               (PLANET *)0x0);
  }
  return;
}



// ======================================================================
// Function: CshQueued
// Address: 1050:c82c
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1050c963) */
/* WARNING: Removing unreachable block (ram,0x1050c98f) */

short CshQueued(short ishdef,short *pfProgress,short fSpaceDocks)

{
  PLANET *pPVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar2;
  ulong uVar3;
  ulong uVar4;
  PLANET *pPVar5;
  PROD *lpprod;
  short csh;
  PLANET *lppl;
  short iprod;
  
  uVar4 = CONCAT22(unaff_SI,unaff_DI);
  csh = 0;
  *pfProgress = 0;
  pPVar1 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  pPVar5 = (PLANET *)lpPlanets;
  while ((PLANET *)lppl < pPVar1) {
    uVar2 = (undefined2)((ulong)lppl >> 0x10);
    if (((((*(int *)&((PLANET *)lppl)->lpplprod != 0) ||
          (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) &&
         (((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac != 0)) &&
        ((((PLANET *)lppl)->iPlayer == idPlayer &&
         ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0)))) &&
       ((fSpaceDocks == 0 ||
        (*(int *)(*(int *)(idPlayer * 4 + 0x14c) +
                 (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93) == 0x21)))) {
      iprod = 0;
      lpprod = (PROD *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                (PROD *)(*(int *)&((PLANET *)lppl)->lpplprod + 4));
      for (; iprod < (int)(uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac; iprod = iprod + 1)
      {
        uVar3 = __aFulshr(uVar4,(ushort)pPVar5);
        if ((((uint)uVar3 & 7) == 2) &&
           (uVar3 = __aFulshr(uVar4,(ushort)pPVar5), ((uint)uVar3 & 0x7f) == ishdef)) {
          csh = csh + ((uint)lpprod->dwFlags & 0x3ff);
          uVar3 = __aFulshr(uVar4,(ushort)pPVar5);
          if ((uVar3 & 0x7f) != 0) {
            *pfProgress = 1;
          }
        }
        lpprod = (PROD *)lpprod + 1;
      }
    }
    lppl = (PLANET *)CONCAT22(uVar2,(PLANET *)lppl + 1);
  }
  return csh;
}



// ======================================================================
// Function: Merge2Fleets
// Address: 1050:c9f6
// Segment: MEMORY_SHIP
// ======================================================================


void Merge2Fleets(FLEET *lpflDst,FLEET *lpflDel,short fNoDelete)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  int iVar3;
  FLEET *pFVar4;
  FLEET *pFVar5;
  undefined2 unaff_SS;
  short i;
  FLEET rgfl;
  FLEET local_80;
  
  pFVar5 = &rgfl;
  for (iVar3 = 0x3e; iVar3 != 0; iVar3 = iVar3 + -1) {
    pFVar2 = pFVar5;
    pFVar5 = &pFVar5->iPlayer;
    pFVar1 = (FLEET *)lpflDst;
    lpflDst._0_2_ = &((FLEET *)lpflDst)->iPlayer;
    pFVar2->id = pFVar1->id;
  }
  pFVar5 = &local_80;
  pFVar4 = (FLEET *)lpflDel;
  for (iVar3 = 0x3e; iVar3 != 0; iVar3 = iVar3 + -1) {
    pFVar2 = pFVar5;
    pFVar5 = &pFVar5->iPlayer;
    pFVar1 = pFVar4;
    pFVar4 = &pFVar4->iPlayer;
    pFVar2->id = pFVar1->id;
  }
  for (i = 0; i < 0x10; i = i + 1) {
    local_80.rgcsh[i + -0x3e] = local_80.rgcsh[i + -0x3e] + local_80.rgcsh[i];
    local_80.rgcsh[i] = 0;
  }
  FleetTransferCargoBalance(&rgfl,&local_80);
  for (i = 0; i < 2; i = i + 1) {
    FLookupFleet(-1,&rgfl + i);
  }
  if (fNoDelete == 0) {
    FDeleteFleet(local_80.id,2,rgfl.id);
    InvalidateReport(1,2);
  }
  else {
    ((FLEET *)lpflDel)->wFlags_0x4 = ((FLEET *)lpflDel)->wFlags_0x4 & 0xfbff | 0x400;
  }
  return;
}



// ======================================================================
// Function: FleetOrdersChangeTarget
// Address: 1050:cafe
// Segment: MEMORY_SHIP
// ======================================================================


void FleetOrdersChangeTarget(FLEET *lpflOld)

{
  int iVar1;
  short sVar2;
  FLEET *pFVar3;
  undefined2 uVar4;
  POINT pt_00;
  short grobj;
  SCAN scan;
  short iflMac;
  short iord;
  FLEET *lpfl;
  short fChg;
  short pt;
  short local_8;
  short id;
  
  fChg = 0;
  iflMac = 0;
  while( true ) {
    if (cFleet <= iflMac) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pFVar3 = ((FLEET **)rglpfl)[iflMac];
    iVar1 = *(int *)((int)((FLEET **)rglpfl + iflMac) + 2);
    lpfl = (FLEET *)CONCAT22(iVar1,pFVar3);
    if ((pFVar3 == (FLEET *)0x0) && (iVar1 == 0)) break;
    if ((*(int *)&pFVar3->lpplord != 0) || (*(int *)((int)&pFVar3->lpplord + 2) != 0)) {
      iord = pFVar3->cord;
      while (iord = iord + -1, -1 < iord) {
        uVar4 = (undefined2)((ulong)lpfl >> 0x10);
        pFVar3 = (FLEET *)lpfl;
        if (((*(uint *)(*(int *)&pFVar3->lpplord + iord * 0x12 + 10) >> 8 & 0xf) == 2) &&
           (*(int *)(*(int *)&pFVar3->lpplord + iord * 0x12 + 8) == lpflOld->id)) {
          if (fChg == 0) {
            uVar4 = (undefined2)((ulong)lpflOld >> 0x10);
            pFVar3 = (FLEET *)lpflOld;
            pt = (&pFVar3->pt)->x;
            local_8 = (pFVar3->pt).y;
            (&pFVar3->pt)->x = (&pFVar3->pt)->x + 1;
            pt_00.y = local_8;
            pt_00.x = pt;
            sVar2 = FFindNearestObject(pt_00,0x83,&scan);
            if (sVar2 == 0) {
              grobj = 4;
              id = iord;
            }
            else if ((scan.grobjFull & grobjFleet) == grobjNone) {
              grobj = 1;
              id = scan.idpl;
            }
            else {
              grobj = 2;
              id = ((FLEET **)rglpfl)[scan.ifl]->id;
            }
            (&pFVar3->pt)->x = (&pFVar3->pt)->x + -1;
          }
          uVar4 = (undefined2)((ulong)lpfl >> 0x10);
          pFVar3 = (FLEET *)lpfl;
          *(short *)(*(int *)&pFVar3->lpplord + iord * 0x12 + 8) = id;
          *(uint *)(*(int *)&pFVar3->lpplord + iord * 0x12 + 10) =
               *(uint *)(*(int *)&pFVar3->lpplord + iord * 0x12 + 10) & 0xf0ff | (grobj & 0xfU) << 8
          ;
        }
      }
    }
    iflMac = iflMac + 1;
  }
  return;
}



// ======================================================================
// Function: GetTruePartCost
// Address: 1050:cd00
// Segment: MEMORY_SHIP
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1050cdcf) */
/* WARNING: Removing unreachable block (ram,0x1050cff3) */

void GetTruePartCost(short iPlayer,PART *ppart,ushort *rgCost)

{
  int iVar1;
  undefined2 uVar2;
  int iVar3;
  short sVar4;
  COMPART *lpcom;
  short i;
  short cCur;
  short cExcess;
  
  iVar1 = *&(&ppart->u_PART_0x0004)->parmor;
  uVar2 = *(undefined2 *)((int)&ppart->u_PART_0x0004 + 2);
  for (i = 0; i < 3; i = i + 1) {
    rgCost[i] = *(ushort *)(iVar1 + 0x2c + i * 2);
  }
  rgCost[3] = *(ushort *)(iVar1 + 0x2a);
  if (iPlayer != -1) {
    if (((((ppart->hs).grhst & hstTerra) ==
          ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
            hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
        (((((ppart->hs).grhst & hstPlanetary) ==
           ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
             hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine) ||
          (((ppart->hs).wFlags_0x2 & 0xff) < 9)) || (0xd < ((ppart->hs).wFlags_0x2 & 0xff))))) &&
       ((((ppart->hs).grhst & hstPlanetary) ==
         ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
           hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine) ||
        (8 < ((ppart->hs).wFlags_0x2 & 0xff))))) {
      cExcess = 100;
      for (i = 0; i < 6; i = i + 1) {
        iVar3 = (int)*(char *)(iPlayer * 0xc0 + 0x59bc + i) - (int)*(char *)(iVar1 + 2 + i);
        sVar4 = cExcess;
        if (('\0' < *(char *)(iVar1 + 2 + i)) && (sVar4 = iVar3, cExcess <= iVar3)) {
          sVar4 = cExcess;
        }
        cExcess = sVar4;
      }
      if (cExcess == 100) {
        for (i = 0; i < 6; i = i + 1) {
          if (*(char *)(iPlayer * 0xc0 + 0x59bc + i) < cExcess) {
            cExcess = (short)*(char *)(iPlayer * 0xc0 + 0x59bc + i);
          }
        }
      }
      if (0 < cExcess) {
        if (0x13 < cExcess) {
          cExcess = 0x13;
        }
        sVar4 = GetRaceGrbit((PLAYER *)rgplr + iPlayer,ibitRaceBleedingEdgeTech);
        if (sVar4 == 0) {
          cExcess = cExcess << 2;
          if (0x4b < cExcess) {
            cExcess = 0x4b;
          }
        }
        else {
          cExcess = cExcess * 5;
          if (0x50 < cExcess) {
            cExcess = 0x50;
          }
        }
        for (i = 0; i < 4; i = i + 1) {
          if (rgCost[i] != 0) {
            sVar4 = MulDiv(rgCost[i],cExcess,100);
            rgCost[i] = rgCost[i] - sVar4;
            if (rgCost[i] == 0) {
              rgCost[i] = 1;
            }
          }
        }
      }
    }
    if (((((ppart->hs).grhst == hstSpecialSB) &&
         (sVar4 = GetRaceStat((PLAYER *)rgplr + iPlayer,rsMajorAdv),
         sVar4 == raStargate)) &&
        (sVar4 = GetRaceStat((PLAYER *)rgplr + iPlayer,rsMajorAdv),
        sVar4 == raStargate)) && (((ppart->hs).wFlags_0x2 & 0xff) < 7)) {
      for (i = 0; i < 4; i = i + 1) {
        rgCost[i] = rgCost[i] - (rgCost[i] >> 2);
      }
    }
    else if (((((ppart->hs).grhst == hstBeam) || ((ppart->hs).grhst == hstTorp)) ||
             ((ppart->hs).grhst == hstBomb)) &&
            (sVar4 = GetRaceStat((PLAYER *)rgplr + iPlayer,rsMajorAdv),
            sVar4 == raAttack)) {
      for (i = 0; i < 4; i = i + 1) {
        rgCost[i] = rgCost[i] - (rgCost[i] >> 2);
      }
    }
    else if (((((ppart->hs).grhst == hstBeam) || ((ppart->hs).grhst == hstTorp)) ||
             ((ppart->hs).grhst == hstBomb)) &&
            (sVar4 = GetRaceStat((PLAYER *)rgplr + iPlayer,rsMajorAdv),
            sVar4 == raDefend)) {
      for (i = 0; i < 4; i = i + 1) {
        rgCost[i] = rgCost[i] + (rgCost[i] >> 2);
      }
    }
    else if (((ppart->hs).grhst == hstTerra) &&
            (sVar4 = GetRaceStat((PLAYER *)rgplr + iPlayer,rsMajorAdv),
            sVar4 == raTerra)) {
      rgCost[3] = rgCost[3] / 2;
    }
    else if (((ppart->hs).grhst == hstEngine) &&
            (sVar4 = GetRaceGrbit((PLAYER *)rgplr + iPlayer,ibitRaceCheapEngines),
            sVar4 != 0)) {
      for (i = 0; i < 4; i = i + 1) {
        rgCost[i] = rgCost[i] - (rgCost[i] >> 1);
      }
    }
    if (((cExcess < 1) &&
        (sVar4 = GetRaceGrbit((PLAYER *)rgplr + iPlayer,ibitRaceBleedingEdgeTech),
        sVar4 != 0)) && (((uint)gd.grBits2 >> 3 & 1) == 0)) {
      for (i = 0; (i < 6 && (*(char *)(iVar1 + 2 + i) < '\x01')); i = i + 1) {
      }
      if (i < 6) {
        gd.grBits._2_2_ = gd.grBits._2_2_ & 0xbfff | 0x4000;
        for (i = 0; i < 4; i = i + 1) {
          rgCost[i] = rgCost[i] << 1;
        }
      }
      else {
        gd.grBits._2_2_ = gd.grBits._2_2_ & 0xbfff;
      }
    }
    else {
      gd.grBits._2_2_ = gd.grBits._2_2_ & 0xbfff;
    }
  }
  return;
}



