// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: TbWndProc
// Address: 1068:001e
// Segment: MEMORY_TB
// ======================================================================


/* WARNING: Variable defined which should be unmapped: pct */

long TbWndProc(HWND hwnd,WMType msg,ushort wParam,long lParam)

{
  POINT PVar1;
  POINT pt_00;
  POINT pt_01;
  int iVar2;
  short sVar3;
  HWND HVar4;
  short sVar5;
  HCURSOR HVar6;
  HDC HVar7;
  UINT *pUVar8;
  UINT *pUVar9;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  fn_lpfnRealComboProc *pfVar10;
  fn_lpfnRealCEProc *pfVar11;
  ulong uVar12;
  short pct;
  HWND hwndCE;
  RECT rc;
  short x;
  short j;
  POINT ptBtn;
  short dx;
  short iSel;
  short fDown;
  short fCur;
  short i;
  PAINTSTRUCT ps;
  short itb;
  short ids;
  POINT pt;
  short fInside;
  HDC hdc;
  
  uVar12 = CONCAT22(unaff_SI,unaff_DI);
  if (msg == WM_CREATE) {
    x = 4;
    pUVar9 = &stack0xffae;
    for (i = 0; i < 0x1d; i = i + 1) {
      iVar2 = (int)*(char *)i;
      pUVar9[-1] = iVar2;
      pUVar9[-2] = 0x1068;
      pUVar9[-3] = 0x4e;
      sVar3 = DxOfBtn(pUVar9[-1]);
      pUVar8 = pUVar9;
      if ((iVar2 < -2) && (iVar2 == -3)) {
        pUVar9[-1] = 0x1120;
        pUVar9[-2] = (UINT)(char *)s_COMBOBOX_1120_16ce;
        pUVar9[-3] = 0;
        pUVar9[-4] = 0;
        pUVar9[-5] = 0x5020;
        pUVar9[-6] = 0x42;
        pUVar9[-7] = x;
        pUVar9[-8] = (0x14 - dyArial8) / 2 + 4;
        pUVar9[-9] = sVar3;
        pUVar9[-10] = dyArial8 * 0xb + 0x1c;
        pUVar9[-0xb] = hwnd;
        pUVar9[-0xc] = 0;
        pUVar9[-0xd] = hInst;
        pUVar9[-0xe] = 0;
        pUVar9[-0xf] = 0;
        pUVar9[-0x10] = 0x1068;
        pUVar9[-0x11] = 0xba;
        hwndTBRadar =
             CreateWindow(*(LPCSTR *)(pUVar9 + -2),*(LPCSTR *)(pUVar9 + -4),*(DWORD *)(pUVar9 + -6),
                          pUVar9[-7],pUVar9[-8],pUVar9[-9],pUVar9[-10],pUVar9[-0xb],pUVar9[-0xc],
                          pUVar9[-0xd],*(void **)(pUVar9 + -0xf));
        pUVar9[1] = hwndTBRadar;
        *pUVar9 = 0x30;
        pUVar9[-1] = rghfontArial8[1];
        pUVar9[-2] = 0;
        pUVar9[-3] = 0;
        pUVar9[-4] = 0x14f8;
        pUVar9[-5] = 0xd6;
        SendMessage(pUVar9[1],*pUVar9,pUVar9[-1],*(LPARAM *)(pUVar9 + -3));
        iSel = -1;
        for (j = 0; j < 10; j = j + 1) {
          iVar2 = j * -10 + 100;
          if (iVar2 == vpctRadarView) {
            iSel = j;
          }
          pUVar9[1] = iVar2;
          *pUVar9 = 0x1120;
          pUVar9[-1] = (UINT)PCTDPCTPCT;
          pUVar9[-2] = 0x1120;
          pUVar9[-3] = (UINT)(char *)szWork;
          pUVar9[-4] = 0x14f8;
          pUVar9[-5] = 0x118;
          _wsprintf(*(char **)(pUVar9 + -3),*(char **)(pUVar9 + -1));
          pUVar9[1] = hwndTBRadar;
          *pUVar9 = 0x403;
          pUVar9[-1] = 0;
          pUVar9[-2] = 0x1120;
          pUVar9[-3] = (UINT)(char *)szWork;
          pUVar9[-4] = 0x14f8;
          pUVar9[-5] = 0x133;
          SendMessage(pUVar9[1],*pUVar9,pUVar9[-1],*(LPARAM *)(pUVar9 + -3));
        }
        pUVar9[1] = hwndTBRadar;
        *pUVar9 = 0x415;
        pUVar9[-1] = 4;
        pUVar9[-2] = 0;
        pUVar9[-3] = 0;
        pUVar9[-4] = 0x14f8;
        pUVar9[-5] = 0x159;
        SendMessage(pUVar9[1],*pUVar9,pUVar9[-1],*(LPARAM *)(pUVar9 + -3));
        pUVar9[1] = hwndTBRadar;
        *pUVar9 = 0x40e;
        pUVar9[-1] = iSel;
        pUVar9[-2] = 0;
        pUVar9[-3] = 0;
        pUVar9[-4] = 0x14f8;
        pUVar9[-5] = 0x172;
        SendMessage(pUVar9[1],*pUVar9,pUVar9[-1],*(LPARAM *)(pUVar9 + -3));
        pUVar9[1] = vpctRadarView;
        *pUVar9 = 0x1120;
        pUVar9[-1] = (UINT)PCTDPCTPCT;
        pUVar9[-2] = 0x1120;
        pUVar9[-3] = (UINT)(char *)szWork;
        pUVar9[-4] = 0x14f8;
        pUVar9[-5] = 0x189;
        _wsprintf(*(char **)(pUVar9 + -3),*(char **)(pUVar9 + -1));
        pUVar9[1] = hwndTBRadar;
        *pUVar9 = 0x1120;
        pUVar9[-1] = (UINT)(char *)szWork;
        pUVar9[-2] = 0x14f8;
        pUVar9[-3] = 0x19c;
        SetWindowText(pUVar9[1],*(LPCSTR *)(pUVar9 + -1));
        pUVar9[-2] = hwndTBRadar;
        pUVar9[-3] = 0xfffc;
        pUVar9[-4] = 0x14f8;
        pUVar9[-5] = 0x1a9;
        pfVar10 = (fn_lpfnRealComboProc *)GetWindowLong(pUVar9[-2],pUVar9[-3]);
        pUVar9[-2] = hwndTBRadar;
        pUVar9[-3] = 0xfffc;
        pUVar9[-4] = lpfnFakeComboProc._2_2_;
        pUVar9[-5] = (UINT)(fn_lpfnFakeComboProc *)lpfnFakeComboProc;
        pUVar9[-6] = 0x14f8;
        pUVar9[-7] = 0x1c6;
        lpfnRealComboProc = pfVar10;
        SetWindowLong(pUVar9[-2],pUVar9[-3],*(long *)(pUVar9 + -5));
        pUVar9[-2] = hwndTBRadar;
        pUVar9[-3] = 5;
        pUVar9[-4] = 0x14f8;
        pUVar9[-5] = 0x1d3;
        HVar4 = GetWindow(pUVar9[-2],pUVar9[-3]);
        pUVar8 = pUVar9 + -1;
        if (HVar4 != 0) {
          pUVar9[-2] = HVar4;
          pUVar9[-3] = 0xfffc;
          pUVar9[-4] = 0x14f8;
          pUVar9[-5] = 0x1eb;
          pfVar11 = (fn_lpfnRealCEProc *)GetWindowLong(pUVar9[-2],pUVar9[-3]);
          pUVar9[-2] = HVar4;
          pUVar9[-3] = 0xfffc;
          pUVar9[-4] = lpfnFakeCEProc._2_2_;
          pUVar9[-5] = (UINT)(fn_lpfnFakeCEProc *)lpfnFakeCEProc;
          pUVar9[-6] = 0x14f8;
          pUVar9[-7] = 0x207;
          lpfnRealCEProc = pfVar11;
          SetWindowLong(pUVar9[-2],pUVar9[-3],*(long *)(pUVar9 + -5));
          pUVar8 = pUVar9 + -1;
        }
      }
      x = x + sVar3;
      pUVar9 = pUVar8;
    }
  }
  else if (msg == WM_PAINT) {
    HVar7 = BeginPaint(hwnd,&ps);
    GetClientRect(hwnd,&rc);
    PatBlt(HVar7,0,0,rc.right,1,0x42);
    PatBlt(HVar7,0,rc.bottom + -1,rc.right,1,0x42);
    if (iWindowLayout == 0) {
      PatBlt(HVar7,0,0,1,rc.bottom,0x42);
    }
    DrawToolbar(HVar7,&rc);
    EndPaint(hwnd,&ps);
  }
  else {
    if (msg == WM_ERASEBKGND) {
      GetClientRect(hwnd,&rc);
      FillRect(wParam,&rc,hbrButtonFace);
      uVar12 = 1;
      pfVar10 = lpfnRealComboProc;
      pfVar11 = lpfnRealCEProc;
      goto LAB_1068_06e7;
    }
    if (msg == WM_CTLCOLOR) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      uVar12 = (ulong)hbrButtonFace;
      pfVar10 = lpfnRealComboProc;
      pfVar11 = lpfnRealCEProc;
      goto LAB_1068_06e7;
    }
    if (msg == WM_SETCURSOR) {
      HVar6 = LoadCursor(0,(LPCSTR)0x7f00);
      setcursor(HVar6);
      uVar12 = 1;
      pfVar10 = lpfnRealComboProc;
      pfVar11 = lpfnRealCEProc;
      goto LAB_1068_06e7;
    }
    if (msg == WM_COMMAND) {
      if ((HWND)lParam == hwndTBRadar) {
        uVar12 = __aFulshr(uVar12,pct);
        if ((int)uVar12 == 8) {
          PostMessage(hwnd,0x5f4,0,0);
        }
      }
    }
    else if (msg == WM_MOUSEMOVE) {
      pt.x = (HWND)lParam;
      uVar12 = __aFulshr(uVar12,pct);
      pt.y = (short)uVar12;
      if (hwnd != hwndTb) {
        MapWindowPoints(hwnd,hwndTb,&pt,1);
      }
      if ((pt.x != vptTbLast.x) || (pt.y != vptTbLast.y)) {
        vptTbLast.x = pt.x;
        vptTbLast.y = pt.y;
        sVar3 = ItbFromPpt(&pt);
        if (sVar3 < 0) {
          if (sVar3 != -3) goto LAB_1068_06de;
          ids = 0x17c;
        }
        else {
          ids = sVar3 + 0x16a;
        }
        rc.left = pt.x;
        sVar3 = DxOfBtn(sVar3);
        rc.right = sVar3 + rc.left;
        rc.top = pt.y;
        rc.bottom = 0x1c;
        MapWindowPoints(hwndTb,0,(POINT *)&rc,2);
        ShowTooltip(ids,&rc);
      }
    }
    else if ((msg == WM_LBUTTONDOWN) || (msg == WM_LBUTTONDBLCLK)) {
      ShowTooltip(~idsUniverseDefinitionFileSeemsMissingCorrupt,(RECT *)0x0);
      pt.x = (HWND)lParam;
      uVar12 = __aFulshr(uVar12,pct);
      ptBtn.y = (short)uVar12;
      ptBtn.x = pt.x;
      pt.y = ptBtn.y;
      sVar3 = ItbFromPpt(&ptBtn);
      if (-1 < sVar3) {
        fDown = FIsButtonDown(sVar3);
        if ((fDown == 0) || (5 < sVar3)) {
          if ((sVar3 == 0xd) || (((sVar3 == 0xf || (sVar3 == 0x10)) || (sVar3 == 8)))) {
            ExecuteButton(sVar3,(uint)(fDown == 0));
          }
          else {
            sVar5 = DxOfBtn(sVar3);
            rc.left = ptBtn.x;
            rc.top = ptBtn.y;
            rc.right = ptBtn.x + sVar5;
            rc.bottom = ptBtn.y + 0x1c;
            HVar7 = GetDC(hwnd);
            SelectPalette(HVar7,vhpal,0);
            RealizePalette(HVar7);
            SetCapture(hwnd);
            fCur = -1;
            while( true ) {
              sVar5 = FGetMouseMove(&pt);
              if (sVar5 == 0) break;
              PVar1.y = pt.y;
              PVar1.x = pt.x;
              fInside = PtInRect(&rc,PVar1);
              if (fCur != fInside) {
                pt_00.y = ptBtn.y;
                pt_00.x = ptBtn.x;
                DrawBitmapButton(HVar7,pt_00,sVar3,fDown + fInside);
                fCur = fInside;
              }
            }
            ReleaseCapture();
            if (fInside != 0) {
              ExecuteButton(sVar3,(uint)(fDown == 0));
              fDown = FIsButtonDown(sVar3);
            }
            if (sVar3 < 6) {
              GetClientRect(hwnd,&rc);
              DrawToolbar(HVar7,&rc);
            }
            else {
              pt_01.y = ptBtn.y;
              pt_01.x = ptBtn.x;
              DrawBitmapButton(HVar7,pt_01,sVar3,fDown);
            }
            ReleaseDC(hwnd,HVar7);
          }
        }
        else {
          MessageBeep(0);
        }
      }
    }
    else {
      if (msg != 0x5f4) {
        uVar12 = DefWindowProc(hwnd,msg,wParam,lParam);
        pfVar10 = lpfnRealComboProc;
        pfVar11 = lpfnRealCEProc;
        goto LAB_1068_06e7;
      }
      TerminateToolbarFocus(0);
    }
  }
LAB_1068_06de:
  uVar12 = 0;
  pfVar10 = lpfnRealComboProc;
  pfVar11 = lpfnRealCEProc;
LAB_1068_06e7:
  lpfnRealCEProc._2_2_ = (undefined2)((ulong)pfVar11 >> 0x10);
  lpfnRealCEProc._0_2_ = (fn_lpfnRealCEProc *)pfVar11;
  lpfnRealComboProc._2_2_ = (undefined2)((ulong)pfVar10 >> 0x10);
  lpfnRealComboProc._0_2_ = (fn_lpfnRealComboProc *)pfVar10;
  return uVar12;
}



// ======================================================================
// Function: DrawToolbar
// Address: 1068:06f0
// Segment: MEMORY_TB
// ======================================================================


void DrawToolbar(HDC hdc,RECT *prc)

{
  int itb;
  short sVar1;
  POINT pt_00;
  short ibtn;
  short i;
  POINT pt;
  
  SelectPalette(hdc,vhpal,0);
  RealizePalette(hdc);
  pt.x = 4;
  for (i = 0; i < 0x1d; i = i + 1) {
    itb = (int)*(char *)i;
    if (-1 < itb) {
      sVar1 = FIsButtonDown(itb);
      pt_00.y = 4;
      pt_00.x = pt.x;
      DrawBitmapButton(hdc,pt_00,(int)*(char *)i,sVar1);
    }
    sVar1 = DxOfBtn(itb);
    pt.x = pt.x + sVar1;
  }
  return;
}



// ======================================================================
// Function: DrawBitmapButton
// Address: 1068:078c
// Segment: MEMORY_TB
// ======================================================================


void DrawBitmapButton(HDC hdc,POINT pt,short ibtn,short fDown)

{
  short sVar1;
  short dx_00;
  short dxDraw;
  HBRUSH hbrTopLeft;
  HBRUSH hbrBotRight;
  short dx;
  
  sVar1 = DxOfBtn(ibtn);
  if (sVar1 < 0x18) {
    dx_00 = 7;
  }
  else {
    dx_00 = 0x18;
  }
  if (fDown == 0) {
    hbrTopLeft = hbrButtonHilite;
    hbrBotRight = hbrButtonShadow;
  }
  else {
    hbrTopLeft = hbrButtonShadow;
    hbrBotRight = hbrButtonHilite;
  }
  SelectObject(hdc,hbrTopLeft);
  PatBlt(hdc,pt.x + 2,pt.y,sVar1 + -4,1,0xf00021);
  PatBlt(hdc,pt.x,pt.y + 2,1,0x18,0xf00021);
  PatBlt(hdc,pt.x + 1,pt.y + 1,1,1,0xf00021);
  PatBlt(hdc,pt.x + 1,pt.y + 0x1a,1,1,0xf00021);
  SelectObject(hdc,hbrBotRight);
  PatBlt(hdc,pt.x + 2,pt.y + 0x1b,sVar1 + -4,1,0xf00021);
  PatBlt(hdc,pt.x + sVar1 + -1,pt.y + 2,1,0x18,0xf00021);
  PatBlt(hdc,pt.x + sVar1 + -2,pt.y + 1,1,1,0xf00021);
  PatBlt(hdc,pt.x + sVar1 + -2,pt.y + 0x1a,1,1,0xf00021);
  SelectObject(hdc,hbrButtonFace);
  PatBlt(hdc,pt.x + 2,pt.y + 1,sVar1 + -4,1,0xf00021);
  PatBlt(hdc,pt.x + 1,pt.y + 2,1,0x18,0xf00021);
  if (fDown == 0) {
    PatBlt(hdc,pt.x + 2,pt.y + 0x19,sVar1 + -4,2,0xf00021);
    PatBlt(hdc,pt.x + sVar1 + -3,pt.y + 2,2,0x18,0xf00021);
  }
  else {
    PatBlt(hdc,pt.x + 2,pt.y + 2,sVar1 + -4,fDown,0xf00021);
    PatBlt(hdc,pt.x + 2,pt.y + 2,fDown,0x18,0xf00021);
    if (fDown == 1) {
      PatBlt(hdc,pt.x + 2,pt.y + 0x1a,sVar1 + -4,1,0xf00021);
      PatBlt(hdc,pt.x + sVar1 + -2,pt.y + 2,1,0x18,0xf00021);
    }
  }
  DibBlt(hdc,pt.x + 2 + fDown,pt.y + 2 + fDown,dx_00,0x17,hdibToolbar,ibtn * 0x18
                  ,0,dx_00,0x17,0xcc0020);
  if (1 < fDown) {
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,pt.x + sVar1 + -2,pt.y + 0x1a,1,1,0xf00021);
  }
  return;
}



// ======================================================================
// Function: ItbFromPpt
// Address: 1068:0b12
// Segment: MEMORY_TB
// ======================================================================


short ItbFromPpt(POINT *ppt)

{
  short sVar1;
  short x;
  short dx;
  short i;
  
  x = 4;
  if (((3 < ppt->x) && (3 < ppt->y)) && (ppt->y < 0x20)) {
    for (i = 0; i < 0x1d; i = i + 1) {
      sVar1 = DxOfBtn((int)*(char *)i);
      if (ppt->x < x + sVar1) {
        ppt->x = x;
        ppt->y = 4;
        return (int)*(char *)i;
      }
      x = x + sVar1;
    }
  }
  return -1;
}



// ======================================================================
// Function: DxOfBtn
// Address: 1068:0bb2
// Segment: MEMORY_TB
// ======================================================================


short DxOfBtn(short itb)

{
  short sVar1;
  
  if (itb < 0) {
    if (itb == -1) {
      sVar1 = 6;
    }
    else if (itb == -2) {
      sVar1 = 2;
    }
    else if (itb == -3) {
      if (dyArial8 < 0x10) {
        sVar1 = 0x3c;
      }
      else {
        sVar1 = 0x46;
      }
    }
    else {
      sVar1 = 0;
    }
  }
  else if ((itb == 0xd) || (itb == 0xf)) {
    sVar1 = 0xb;
  }
  else {
    sVar1 = 0x1d;
  }
  return sVar1;
}



// ======================================================================
// Function: FIsButtonDown
// Address: 1068:0c3a
// Segment: MEMORY_TB
// ======================================================================


short FIsButtonDown(short itb)

{
  uint uVar1;
  
  switch(itb) {
  case 0:
  case 1:
  case 2:
  case 3:
  case 4:
  case 5:
    uVar1 = (uint)((grbitScan & 0xf) == itb);
    break;
  case 6:
    uVar1 = (uint)((grbitScan & 0x10) != 0);
    break;
  case 7:
    uVar1 = (uint)((grbitScan & 0x20) != 0);
    break;
  case 8:
    if (((grbitScan & 0x40) == 0) || (grbitScanMines != 0xf)) {
      uVar1 = 0;
    }
    else {
      uVar1 = 1;
    }
    break;
  case 9:
    uVar1 = (uint)((grbitScan & 0x80) != 0);
    break;
  case 10:
    uVar1 = (uint)((grbitScan & 0x100) != 0);
    break;
  case 0xb:
    uVar1 = (uint)((grbitScan & 0x400) != 0);
    break;
  case 0xc:
    uVar1 = (uint)((grbitScan & 0x200) != 0);
    break;
  case 0xd:
  case 0xf:
  case 0x10:
    uVar1 = 0;
    break;
  case 0xe:
    uVar1 = (uint)((grbitScan & 0x800) != 0);
    break;
  case 0x11:
    uVar1 = (uint)((grbitScan & 0x1000) != 0);
    break;
  default:
    uVar1 = 0;
  }
  return uVar1;
}



// ======================================================================
// Function: ExecuteButton
// Address: 1068:0db6
// Segment: MEMORY_TB
// ======================================================================


void ExecuteButton(short itb,short fDown)

{
  ushort uVar1;
  int iVar2;
  short sVar3;
  uint uVar4;
  byte bVar5;
  undefined1 *puVar6;
  undefined2 uVar7;
  undefined2 unaff_SS;
  short iSel;
  uint local_8a [24];
  int local_5a;
  uint local_58 [9];
  short local_46;
  uint local_44 [5];
  int local_3a;
  StringId local_38;
  int local_36;
  char *local_34 [6];
  undefined2 local_28;
  StringId local_26;
  int local_24;
  char *local_22;
  int local_20;
  int local_1e;
  char *local_1c [8];
  undefined1 local_c [4];
  uint local_8;
  ushort grbitNew;
  
  puVar6 = &stack0xff70;
  gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xffbf | 0x40;
  uVar7 = 0x1068;
  switch(itb) {
  case 0:
  case 1:
  case 2:
  case 3:
  case 4:
  case 5:
    if (fDown == 0) {
      return;
    }
    grbitScan = itb + (grbitScan & 0x3ff0);
    puVar6 = &stack0xff70;
    goto LAB_1068_1644;
  case 6:
    grbitNew = 0x10;
    break;
  case 7:
    grbitNew = 0x20;
    break;
  case 8:
    local_28 = 1;
    local_24 = 0;
    if ((grbitScan & 0x40) == 0) {
      grbitScanMines = 0;
    }
    for (local_26 = idsMineFields; iVar2 = local_24, (int)local_26 < 0x500;
        local_26 = local_26 + idsPlayerLogFileAppearsCorruptUnableLoad) {
      if (local_26 == idsMineFields) {
        local_58[local_24 * 2] = (uint)(grbitScanMines == 0xf);
        local_58[iVar2 * 2 + 1] = 0;
      }
      else {
        local_58[local_24 * 2] = (uint)(grbitScanMines == 0);
        local_58[iVar2 * 2 + 1] = 0;
      }
      CchGetString
                (local_26,(char *)szWork + 0xa0 + (local_26 - idsMineFields) * 0x1e);
      (&local_22)[local_24] = (char *)szWork + 0xa0 + (local_26 - idsMineFields) * 0x1e;
      local_24 = local_24 + 1;
    }
    local_58[local_24 * 2] = 0;
    local_58[iVar2 * 2 + 1] = 0;
    szWork[0xfa] = -1;
    szWork[0xfb] = '\0';
    (&local_22)[local_24] = (char *)szWork + 0xfa;
    for (local_26 = 0; local_24 = local_24 + 1, iVar2 = local_24, (int)local_26 < 4;
        local_26 = local_26 + 1) {
      local_58[local_24 * 2] =
           (uint)((1 << ((byte)local_26 & 0x1f) & grbitScanMines) != 0);
      local_58[iVar2 * 2 + 1] = 0;
      CchGetString(local_26 + idsMineFields3,(char *)szWork + local_26 * 0x1e);
      (&local_22)[local_24] = (char *)szWork + local_26 * 0x1e;
    }
    GetCursorPos(local_c + 2);
    ScreenToClient(hwndTb,local_c + 2);
    local_5a = PopupMenu(hwndTb,local_c._2_2_,local_8,local_24,local_58,&local_22,-2,0
                               );
    if (local_5a == -1) {
      return;
    }
    if (local_5a < 3) {
      if (local_5a == 0) {
        grbitScanMines = 0xf;
      }
      else {
        grbitScanMines = 0;
      }
    }
    else {
      local_5a = local_5a + -3;
      grbitScanMines = grbitScanMines ^ 1 << ((byte)local_5a & 0x1f);
    }
    if (grbitScanMines == 0) {
      grbitScan = grbitScan & 0xffbf;
    }
    else {
      grbitScan = grbitScan | 0x40;
    }
    uVar7 = 0x14f8;
    InvalidateRect(hwndTb,(RECT *)0x0,1);
    puVar6 = &stack0xff6e;
    goto LAB_1068_1644;
  case 9:
    grbitNew = 0x80;
    break;
  case 10:
    grbitNew = 0x100;
    break;
  case 0xb:
    grbitNew = 0x400;
    break;
  case 0xc:
    grbitNew = 0x200;
    break;
  case 0xd:
    local_3a = 0;
    for (local_38 = idsDesigns; iVar2 = local_3a, (int)local_38 < 0x4fe;
        local_38 = local_38 + idsPlayerLogFileAppearsCorruptUnableLoad) {
      local_8a[local_3a * 2] = 0;
      local_8a[iVar2 * 2 + 1] = 0;
      CchGetString(local_38,(char *)szWork + (local_38 - idsDesigns) * 0x14);
      local_34[local_3a] = (char *)szWork + (local_38 - idsDesigns) * 0x14;
      local_3a = local_3a + 1;
    }
    local_8a[local_3a * 2] = 0;
    local_8a[iVar2 * 2 + 1] = 0;
    szWork[200] = -1;
    szWork[0xc9] = '\0';
    local_34[local_3a] = (char *)szWork + 200;
    local_8 = 1;
    local_3a = local_3a + 1;
    for (local_36 = 0; iVar2 = local_3a, local_36 < 0x10; local_36 = local_36 + 1) {
      if ((*(uint *)((int)&rgshdef[0].wFlags + local_36 * 0x93) >> 9 & 1) == 0) {
        local_8a[local_3a * 2] = (uint)((local_8 & grbitScanShip) != 0);
        local_8a[iVar2 * 2 + 1] = 0;
        local_34[local_3a] = (char *)(local_36 * 0x93 + 0x3f08);
        local_3a = local_3a + 1;
      }
      local_8 = local_8 << 1;
    }
    GetCursorPos(local_c);
    ScreenToClient(hwndTb,local_c);
    uVar7 = 0x10c0;
    sVar3 = PopupMenu(hwndTb,local_c._0_2_,local_c._2_2_,local_3a,local_8a,local_34,-2
                             ,0);
    puVar6 = &stack0xff6c;
    if (sVar3 == -1) {
      return;
    }
    if (sVar3 < 4) {
      if (sVar3 == 0) {
        grbitScanShip = 0xffff;
      }
      else if (sVar3 == 1) {
        grbitScanShip = grbitScanShip ^ 0xffff;
      }
      else {
        grbitScanShip = 0;
      }
      puVar6 = &stack0xff6c;
      uVar1 = grbitScanShip;
      if ((grbitScan & 0x200) == 0) goto joined_r0x10681246;
    }
    else {
      iSel = sVar3 + -4;
      local_36 = 0;
      while ((local_36 < 0x10 &&
             (((*(uint *)((int)&rgshdef[0].wFlags + local_36 * 0x93) >> 9 & 1) != 0 ||
              (iSel = iSel + -1, -1 < iSel))))) {
        local_36 = local_36 + 1;
      }
      grbitScanShip = grbitScanShip ^ 1 << ((byte)local_36 & 0x1f);
      if ((grbitScan & 0x200) == 0) {
        uVar1 = 1 << ((byte)local_36 & 0x1f) & grbitScanShip;
joined_r0x10681246:
        puVar6 = &stack0xff6c;
        if (uVar1 != 0) {
          grbitScan = grbitScan | 0x200;
          uVar7 = 0x14f8;
          InvalidateRect(hwndTb,(RECT *)0x0,1);
          puVar6 = &stack0xff6e;
        }
      }
    }
    uVar4 = grbitScan & 0x200;
    goto joined_r0x1068150e;
  case 0xe:
    grbitNew = 0x800;
    break;
  case 0xf:
    local_28 = 1;
    local_24 = 0;
    for (local_26 = idsDesigns; iVar2 = local_24, (int)local_26 < 0x4fe;
        local_26 = local_26 + idsPlayerLogFileAppearsCorruptUnableLoad) {
      local_58[local_24 * 2] = 0;
      local_58[iVar2 * 2 + 1] = 0;
      CchGetString
                (local_26,(char *)szWork + 200 + (local_26 - idsDesigns) * 0x19);
      (&local_22)[local_24] = (char *)szWork + 200 + (local_26 - idsDesigns) * 0x19;
      local_24 = local_24 + 1;
    }
    local_58[local_24 * 2] = 0;
    local_58[iVar2 * 2 + 1] = 0;
    szWork[300] = -1;
    szWork[0x12d] = '\0';
    (&local_22)[local_24] = (char *)szWork + 300;
    for (local_26 = 0; local_24 = local_24 + 1, iVar2 = local_24, (int)local_26 < 8;
        local_26 = local_26 + 1) {
      local_58[local_24 * 2] =
           (uint)((1 << ((byte)local_26 & 0x1f) & grbitScanEShip) != 0);
      local_58[iVar2 * 2 + 1] = 0;
      CchGetString(local_26 + idsColony,(char *)szWork + local_26 * 0x19);
      (&local_22)[local_24] = (char *)szWork + local_26 * 0x19;
    }
    GetCursorPos(local_c + 2);
    ScreenToClient(hwndTb,local_c + 2);
    uVar7 = 0x10c0;
    sVar3 = PopupMenu(hwndTb,local_c._2_2_,local_8,local_24,local_58,&local_22,-2,0);
    puVar6 = &stack0xff6c;
    local_5a = sVar3;
    if (sVar3 == -1) {
      return;
    }
    if (sVar3 < 4) {
      if (sVar3 == 0) {
        grbitScanEShip = 0xff;
      }
      else if (sVar3 == 1) {
        grbitScanEShip = grbitScanEShip ^ 0xff;
      }
      else {
        grbitScanEShip = 0;
      }
      puVar6 = &stack0xff6c;
      uVar1 = grbitScanEShip;
      if ((grbitScan & 0x800) == 0) goto joined_r0x106814ad;
    }
    else {
      local_5a = sVar3 + -4;
      bVar5 = (byte)(sVar3 + -4);
      grbitScanEShip = grbitScanEShip ^ 1 << (bVar5 & 0x1f);
      if ((grbitScan & 0x800) == 0) {
        uVar1 = 1 << (bVar5 & 0x1f) & grbitScanEShip;
joined_r0x106814ad:
        puVar6 = &stack0xff6c;
        if (uVar1 != 0) {
          grbitScan = grbitScan | 0x800;
          uVar7 = 0x14f8;
          InvalidateRect(hwndTb,(RECT *)0x0,1);
          puVar6 = &stack0xff6e;
        }
      }
    }
    uVar4 = grbitScan & 0x800;
joined_r0x1068150e:
    if (uVar4 == 0) {
      return;
    }
    goto LAB_1068_1644;
  case 0x10:
    local_1e = 0;
    for (local_20 = 0; iVar2 = local_1e, local_20 < 9; local_20 = local_20 + 1) {
      local_44[local_1e * 2] = (uint)(iScanZoom + 4 == local_20);
      local_44[iVar2 * 2 + 1] = 0;
      _wsprintf((char *)szWork + local_20 * 8,PCTDPCTPCT);
      local_1c[local_1e] = (char *)szWork + local_20 * 8;
      local_1e = local_1e + 1;
    }
    GetCursorPos(local_c + 2);
    ScreenToClient(hwndTb,local_c + 2);
    local_46 = PopupMenu(hwndTb,local_c._2_2_,local_8,local_1e,local_44,local_1c,-2,0)
    ;
    if (local_46 == -1) {
      return;
    }
    CommandHandler(hwndFrame,local_46 + 0xf3d);
    return;
  case 0x11:
    grbitNew = 0x1000;
    break;
  default:
    goto switchD_1068_161b_default;
  }
  if (fDown == 0) {
    grbitScan = grbitScan & ~grbitNew;
    puVar6 = &stack0xff70;
  }
  else {
    grbitScan = grbitScan | grbitNew;
  }
LAB_1068_1644:
  if (itb != 6) {
    *(HWND *)(puVar6 + -2) = hwndScanner;
    *(undefined2 *)(puVar6 + -4) = 0;
    *(undefined2 *)(puVar6 + -6) = 0;
    *(undefined2 *)(puVar6 + -8) = 1;
    *(undefined2 *)(puVar6 + -10) = uVar7;
    uVar7 = 0x14f8;
    *(char **)(puVar6 + -0xc) = (char *)s__s_pla_1120_165c + 6;
    InvalidateRect(*(HWND *)(puVar6 + -2),*(RECT **)(puVar6 + -6),*(BOOL *)(puVar6 + -8));
    puVar6 = puVar6 + 2;
  }
  if (((uint)gd.grBits >> 0xb & 1) != 0) {
    *(undefined2 *)(puVar6 + -2) = uVar7;
    *(undefined2 *)(puVar6 + -4) = 0x167a;
    AdvanceTutor();
  }
switchD_1068_161b_default:
  return;
}



// ======================================================================
// Function: TerminateToolbarFocus
// Address: 1068:1680
// Segment: MEMORY_TB
// ======================================================================


void TerminateToolbarFocus(short fCancel)

{
  undefined1 *puVar1;
  undefined1 *puVar2;
  undefined1 *puVar3;
  undefined2 uVar4;
  undefined2 unaff_SS;
  char *psz;
  short pct;
  
  uVar4 = 0x1068;
  gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xffbf | 0x40;
  if (fCancel == 0) {
    uVar4 = 0x14f8;
    GetWindowText(hwndTBRadar,szWork,0x14);
    puVar1 = &stack0xffea;
    pct = 0;
    for (psz = (char *)szWork; ('/' < *psz && (*psz < ':')); psz = psz + 1) {
      pct = pct * 10 + *psz + -0x30;
    }
    if ((*psz != '\0') && (puVar1 = &stack0xffea, *psz != '%')) {
      pct = 0;
      puVar1 = &stack0xffea;
    }
  }
  else {
    pct = vpctRadarView;
    puVar1 = &stack0xfff2;
  }
  if (pct < 2) {
    pct = 2;
  }
  else if (100 < pct) {
    pct = 100;
  }
  *(HWND *)(puVar1 + -2) = hwndTBRadar;
  *(undefined2 *)(puVar1 + -4) = 0x40e;
  *(int *)(puVar1 + -6) = (100 - pct) / 10;
  *(undefined2 *)(puVar1 + -8) = 0;
  *(undefined2 *)(puVar1 + -10) = 0;
  *(undefined2 *)(puVar1 + -0xc) = uVar4;
  *(undefined2 *)(puVar1 + -0xe) = 0x1764;
  SendMessage(*(HWND *)(puVar1 + -2),*(UINT *)(puVar1 + -4),*(WPARAM *)(puVar1 + -6),
              *(LPARAM *)(puVar1 + -10));
  *(short *)(puVar1 + -2) = pct;
  *(undefined2 *)(puVar1 + -4) = 0x1120;
  *(char **)(puVar1 + -6) = PCTDPCTPCT;
  *(undefined2 *)(puVar1 + -8) = 0x1120;
  *(char **)(puVar1 + -10) = (char *)szWork;
  *(undefined2 *)(puVar1 + -0xc) = 0x14f8;
  *(undefined2 *)(puVar1 + -0xe) = 0x177a;
  _wsprintf(*(char **)(puVar1 + -10),*(char **)(puVar1 + -6));
  *(HWND *)(puVar1 + -2) = hwndTBRadar;
  *(undefined2 *)(puVar1 + -4) = 0x1120;
  *(char **)(puVar1 + -6) = (char *)szWork;
  *(undefined2 *)(puVar1 + -8) = 0x14f8;
  *(undefined2 *)(puVar1 + -10) = 0x178d;
  SetWindowText(*(HWND *)(puVar1 + -2),*(LPCSTR *)(puVar1 + -6));
  puVar2 = puVar1 + -6;
  puVar3 = puVar1 + -6;
  if (pct != vpctRadarView) {
    vpctRadarView = pct;
    if ((grbitScan & 0x20) == 0) {
      *(HWND *)(puVar1 + -8) = hwndTb;
      *(undefined2 *)(puVar1 + -10) = 0;
      *(undefined2 *)(puVar1 + -0xc) = 0;
      *(undefined2 *)(puVar1 + -0xe) = 1;
      *(undefined2 *)(puVar1 + -0x10) = 0x14f8;
      *(undefined2 *)(puVar1 + -0x12) = 0x17c1;
      InvalidateRect(*(HWND *)(puVar1 + -8),*(RECT **)(puVar1 + -0xc),*(BOOL *)(puVar1 + -0xe));
      puVar2 = puVar1 + -4;
    }
    grbitScan = grbitScan | 0x20;
    *(HWND *)(puVar2 + -2) = hwndScanner;
    *(undefined2 *)(puVar2 + -4) = 0;
    *(undefined2 *)(puVar2 + -6) = 0;
    *(undefined2 *)(puVar2 + -8) = 1;
    *(undefined2 *)(puVar2 + -10) = 0x14f8;
    *(undefined2 *)(puVar2 + -0xc) = 0x17db;
    InvalidateRect(*(HWND *)(puVar2 + -2),*(RECT **)(puVar2 + -6),*(BOOL *)(puVar2 + -8));
    puVar3 = puVar2 + 2;
  }
  *(HWND *)(puVar3 + -2) = hwndFrame;
  *(undefined2 *)(puVar3 + -4) = 0x14f8;
  *(undefined2 *)(puVar3 + -6) = 0x17e4;
  SetFocus(*(HWND *)(puVar3 + -2));
  return;
}



// ======================================================================
// Function: ShowTooltip
// Address: 1068:17ea
// Segment: MEMORY_TB
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x106819a8) */

void ShowTooltip(StringId ids,RECT *prc)

{
  bool bVar1;
  undefined1 *puVar2;
  BOOL BVar3;
  short sVar4;
  HDC HVar5;
  HGDIOBJ HVar6;
  int iVar7;
  int iVar8;
  undefined1 *puVar9;
  undefined1 *puVar10;
  undefined2 uVar11;
  undefined2 unaff_SS;
  DWORD DVar12;
  short fShowNow;
  short cch;
  short fVisCur;
  HFONT hfontSav;
  HDC hdc;
  
  uVar11 = 0x1068;
  puVar2 = &stack0xffea;
  if (hwndTooltip == 0) {
LAB_1068_1814:
    puVar9 = puVar2;
    bVar1 = false;
  }
  else {
    uVar11 = 0x14f8;
    BVar3 = IsWindowVisible(hwndTooltip);
    puVar9 = &stack0xffe8;
    puVar2 = &stack0xffe8;
    if (BVar3 == 0) goto LAB_1068_1814;
    bVar1 = true;
  }
  if (((int)ids < 0) || (prc == (RECT *)0x0)) {
    if (hwndTooltip != 0) {
      *(HWND *)(puVar9 + -2) = hwndTooltip;
      *(undefined2 *)(puVar9 + -4) = uVar11;
      uVar11 = 0x14f8;
      *(undefined2 *)(puVar9 + -6) = 0x183f;
      DestroyWindow(*(HWND *)(puVar9 + -2));
    }
    DVar12 = CONCAT22(vtickTooltipLast._2_2_,(uint)vtickTooltipLast);
    if (bVar1) {
      *(undefined2 *)(puVar9 + -2) = uVar11;
      *(undefined2 *)(puVar9 + -4) = 0x184d;
      DVar12 = GetTickCount();
    }
  }
  else {
    if (ids == vidsTooltip) {
      *(undefined2 *)(puVar9 + -2) = 0x1120;
      *(RECT **)(puVar9 + -4) = prc;
      *(undefined2 *)(puVar9 + -6) = 0x1120;
      *(RECT **)(puVar9 + -8) = (RECT *)&vrcTooltip;
      *(undefined2 *)(puVar9 + -10) = uVar11;
      uVar11 = 0x14f8;
      *(undefined2 *)(puVar9 + -0xc) = 0x1875;
      BVar3 = EqualRect(*(RECT **)(puVar9 + -4),*(RECT **)(puVar9 + -8));
      DVar12 = CONCAT22(vtickTooltipLast._2_2_,(uint)vtickTooltipLast);
      if (BVar3 != 0) goto LAB_1068_19dd;
    }
    vidsTooltip = ids;
    *(char **)(puVar9 + -2) = (char *)szWork;
    *(StringId *)(puVar9 + -4) = ids;
    *(undefined2 *)(puVar9 + -6) = uVar11;
    *(undefined2 *)(puVar9 + -8) = 0x1893;
    sVar4 = CchGetString(*(StringId *)(puVar9 + -4),*(char **)(puVar9 + -2));
    *(undefined2 *)(puVar9 + -2) = 0x1120;
    uVar11 = *(undefined2 *)(puVar9 + -2);
    ((RECT *)&vrcTooltip)->left = prc->left;
    *(short *)&vrcTooltip.top = prc->top;
    *(short *)&vrcTooltip.right = prc->right;
    *(short *)&vrcTooltip.bottom = prc->bottom;
    *(undefined2 *)(puVar9 + -2) = 0;
    *(undefined2 *)(puVar9 + -4) = 0x1040;
    *(undefined2 *)(puVar9 + -6) = 0x18b1;
    HVar5 = GetDC(*(HWND *)(puVar9 + -2));
    *(HDC *)(puVar9 + -2) = HVar5;
    *(ushort *)(puVar9 + -4) = rghfontArial8[0];
    *(undefined2 *)(puVar9 + -6) = 0x14f8;
    *(undefined2 *)(puVar9 + -8) = 0x18c0;
    HVar6 = SelectObject(*(HDC *)(puVar9 + -2),*(HGDIOBJ *)(puVar9 + -4));
    *(HDC *)(puVar9 + -2) = HVar5;
    *(undefined2 *)(puVar9 + -4) = 0x1120;
    *(char **)(puVar9 + -6) = (char *)szWork;
    *(short *)(puVar9 + -8) = sVar4;
    *(undefined2 *)(puVar9 + -10) = 0x14f8;
    *(undefined2 *)(puVar9 + -0xc) = 0x18d5;
    DVar12 = GetTextExtent(*(HDC *)(puVar9 + -2),*(LPCSTR *)(puVar9 + -6),*(short *)(puVar9 + -8));
    dxTip = (short)DVar12;
    *(HDC *)(puVar9 + -2) = HVar5;
    *(HGDIOBJ *)(puVar9 + -4) = HVar6;
    *(undefined2 *)(puVar9 + -6) = 0x14f8;
    *(undefined2 *)(puVar9 + -8) = 0x18e3;
    SelectObject(*(HDC *)(puVar9 + -2),*(HGDIOBJ *)(puVar9 + -4));
    *(undefined2 *)(puVar9 + -2) = 0;
    *(HDC *)(puVar9 + -4) = HVar5;
    *(undefined2 *)(puVar9 + -6) = 0x14f8;
    *(undefined2 *)(puVar9 + -8) = 0x18ef;
    ReleaseDC(*(HWND *)(puVar9 + -2),*(HDC *)(puVar9 + -4));
    if (hwndTooltip == 0) {
      *(undefined2 *)(puVar9 + -2) = 0x1120;
      *(undefined2 *)(puVar9 + -4) = 0x24a;
      *(undefined2 *)(puVar9 + -6) = 0;
      *(undefined2 *)(puVar9 + -8) = 0;
      *(undefined2 *)(puVar9 + -10) = 0x8000;
      *(undefined2 *)(puVar9 + -0xc) = 0;
      *(undefined2 *)(puVar9 + -0xe) = 100;
      *(undefined2 *)(puVar9 + -0x10) = 100;
      *(short *)(puVar9 + -0x12) = dxTip + 6;
      *(short *)(puVar9 + -0x14) = dyArial8 + 6;
      *(HWND *)(puVar9 + -0x16) = hwndTb;
      *(undefined2 *)(puVar9 + -0x18) = 0;
      *(HINSTANCE *)(puVar9 + -0x1a) = hInst;
      *(undefined2 *)(puVar9 + -0x1c) = 0;
      *(undefined2 *)(puVar9 + -0x1e) = 0;
      *(undefined2 *)(puVar9 + -0x20) = 0x14f8;
      *(undefined2 *)(puVar9 + -0x22) = 0x193f;
      CreateWindow(*(LPCSTR *)(puVar9 + -4),*(LPCSTR *)(puVar9 + -8),*(DWORD *)(puVar9 + -0xc),
                   *(short *)(puVar9 + -0xe),*(short *)(puVar9 + -0x10),*(short *)(puVar9 + -0x12),
                   *(short *)(puVar9 + -0x14),*(HWND *)(puVar9 + -0x16),*(HMENU *)(puVar9 + -0x18),
                   *(HINSTANCE *)(puVar9 + -0x1a),*(void **)(puVar9 + -0x1e));
      puVar10 = puVar9 + 4;
    }
    else {
      *(HWND *)(puVar9 + -2) = hwndTooltip;
      *(undefined2 *)(puVar9 + -4) = 0;
      *(undefined2 *)(puVar9 + -6) = 0;
      *(undefined2 *)(puVar9 + -8) = 1;
      *(undefined2 *)(puVar9 + -10) = 0x14f8;
      *(undefined2 *)(puVar9 + -0xc) = 0x1957;
      InvalidateRect(*(HWND *)(puVar9 + -2),*(RECT **)(puVar9 + -6),*(BOOL *)(puVar9 + -8));
      puVar10 = puVar9 + 2;
    }
    *(HWND *)(puVar10 + -2) = hwndTooltip;
    *(undefined2 *)(puVar10 + -4) = 0xffff;
    *(undefined2 *)(puVar10 + -6) = 0;
    *(undefined2 *)(puVar10 + -8) = 0;
    *(short *)(puVar10 + -10) = dxTip + 6;
    *(short *)(puVar10 + -0xc) = dyArial8 + 6;
    *(undefined2 *)(puVar10 + -0xe) = 0x216;
    *(undefined2 *)(puVar10 + -0x10) = 0x14f8;
    *(undefined2 *)(puVar10 + -0x12) = 0x197e;
    SetWindowPos(*(HWND *)(puVar10 + -2),*(HWND *)(puVar10 + -4),*(short *)(puVar10 + -6),
                 *(short *)(puVar10 + -8),*(short *)(puVar10 + -10),*(short *)(puVar10 + -0xc),
                 *(UINT *)(puVar10 + -0xe));
    iVar7 = (uint)vtickTooltipLast + 400;
    iVar8 = vtickTooltipLast._2_2_ + (uint)(0xfe6f < (uint)vtickTooltipLast);
    *(undefined2 *)(puVar10 + -2) = 0x14f8;
    *(undefined2 *)(puVar10 + -4) = 0x1996;
    DVar12 = GetTickCount();
    if ((DVar12 <= CONCAT22(iVar8,iVar7)) || (bVar1)) {
      uVar11 = 1;
    }
    else {
      uVar11 = 0;
    }
    *(HWND *)(puVar10 + -2) = hwndTooltip;
    *(undefined2 *)(puVar10 + -4) = 0x5f3;
    *(undefined2 *)(puVar10 + -6) = uVar11;
    *(undefined2 *)(puVar10 + -8) = 0;
    *(undefined2 *)(puVar10 + -10) = 0;
    *(undefined2 *)(puVar10 + -0xc) = 0x14f8;
    *(undefined2 *)(puVar10 + -0xe) = 0x19dd;
    TooltipWndProc(*(HWND *)(puVar10 + -2),*(WMType *)(puVar10 + -4),*(ushort *)(puVar10 + -6),
                   *(long *)(puVar10 + -10));
    DVar12 = CONCAT22(vtickTooltipLast._2_2_,(uint)vtickTooltipLast);
  }
LAB_1068_19dd:
  vtickTooltipLast._2_2_ = (int)(DVar12 >> 0x10);
  vtickTooltipLast._0_2_ = (uint)DVar12;
  return;
}



// ======================================================================
// Function: TooltipWndProc
// Address: 1068:19e4
// Segment: MEMORY_TB
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10681bfc) */

long TooltipWndProc(HWND hwnd,WMType msg,ushort wParam,long lParam)

{
  ulong uVar1;
  ulong uVar2;
  BOOL BVar3;
  HDC HVar4;
  UINT UVar5;
  short sVar6;
  undefined1 *puVar7;
  undefined1 *puVar8;
  undefined2 uVar9;
  undefined2 unaff_SS;
  LRESULT LVar10;
  POINT PVar11;
  short cch;
  short bkSav;
  RECT rc;
  PAINTSTRUCT ps;
  POINT pt;
  HDC hdc;
  
  uVar9 = 0x1068;
  puVar7 = &stack0xffc6;
  if (msg == WM_CREATE) {
    hwndTooltip = hwnd;
  }
  else if (msg == WM_DESTROY) {
    hwndTooltip = 0;
    if (vidTimerTooltip != -1) {
      KillTimer(hwnd,vidTimerTooltip);
      vidTimerTooltip = -1;
    }
    vidsTooltip = -1;
  }
  else {
    if (msg == WM_PAINT) {
      HVar4 = BeginPaint(hwnd,&ps);
      GetClientRect(hwnd,&rc);
      FrameRect(HVar4,&rc,hbrWindowFrame);
      SelectObject(HVar4,rghfontArial8[0]);
      UVar5 = CchGetString(vidsTooltip,(char *)szWork);
      sVar6 = SetBkMode(HVar4,1);
      SetTextColor(HVar4,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
      ExtTextOut(HVar4,3,3,0,(RECT *)0x0,szWork,UVar5,(short *)0x0);
      SetBkMode(HVar4,sVar6);
      EndPaint(hwnd,&ps);
      LVar10 = 0;
      uVar2 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
      uVar1 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
      goto LAB_1068_1d6a;
    }
    if (msg == WM_ERASEBKGND) {
      GetClientRect(hwnd,&rc);
      FillRect(wParam,&rc,hbrTooltip);
      LVar10 = 1;
      uVar2 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
      uVar1 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
      goto LAB_1068_1d6a;
    }
    if (msg != WM_TIMER) {
      if (((msg == WM_MOUSEMOVE) || (msg == WM_LBUTTONDOWN)) || (msg == WM_LBUTTONDBLCLK)) {
        DestroyWindow(hwnd);
        uVar1 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
        uVar2 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
        LVar10 = 0;
        goto LAB_1068_1d6a;
      }
      if (msg != 0x5f3) goto LAB_1068_1d53;
      if (wParam == 0) {
        if (vidTimerTooltip != -1) {
          KillTimer(hwnd,vidTimerTooltip);
        }
        UVar5 = SetTimer(0x39e,700,0,0);
        uVar1 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
        uVar2 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
        if (UVar5 == 0) {
          vidTimerTooltip = -1;
        }
        else {
          vidTimerTooltip = 0x39e;
        }
        LVar10 = 0;
        goto LAB_1068_1d6a;
      }
      wParam = 0x39e;
    }
    if (wParam == 0x39e) {
      if (msg == WM_TIMER) {
        uVar9 = 0x14f8;
        BVar3 = IsWindowVisible(hwnd);
        puVar7 = &stack0xffc4;
        if (BVar3 == 0) goto LAB_1068_1abb;
        vtickTooltipLast = GetTickCount();
        GetCursorPos(&pt);
        PVar11.y = pt.y;
        PVar11.x = pt.x;
        BVar3 = PtInRect(&vrcTooltip,PVar11);
        uVar1 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
        puVar8 = &stack0xffc0;
        vtickTooltip1stVis =
             CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
        if ((BVar3 == 0) ||
           (puVar8 = &stack0xffc0,
           vtickTooltip1stVis =
                CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis),
           CONCAT22(vtickTooltip1stVis._2_2_ +
                    (uint)(0xd8ef < (uint)vtickTooltip1stVis),
                    (uint)vtickTooltip1stVis + 10000) < vtickTooltipLast))
        goto TB_LKillTip;
      }
      else {
LAB_1068_1abb:
        *(undefined2 *)(puVar7 + -2) = uVar9;
        *(undefined2 *)(puVar7 + -4) = 0x1ac0;
        vtickTooltip1stVis = GetTickCount();
        *(undefined2 *)(puVar7 + -2) = unaff_SS;
        *(POINT **)(puVar7 + -4) = &pt;
        *(undefined2 *)(puVar7 + -6) = 0x14f8;
        *(undefined2 *)(puVar7 + -8) = 0x1ad3;
        GetCursorPos(*(POINT **)(puVar7 + -4));
        *(undefined2 *)(puVar7 + -6) = 0x1120;
        *(RECT **)(puVar7 + -8) = (RECT *)&vrcTooltip;
        *(short *)(puVar7 + -10) = pt.y;
        *(short *)(puVar7 + -0xc) = pt.x;
        *(undefined2 *)(puVar7 + -0xe) = 0x14f8;
        *(undefined2 *)(puVar7 + -0x10) = 0x1ae5;
        BVar3 = PtInRect(*(RECT **)(puVar7 + -8),*(puVar7 + -0xc));
        puVar8 = puVar7 + -4;
        if (BVar3 != 0) {
          *(HWND *)(puVar7 + -6) = hwndFrame;
          *(undefined2 *)(puVar7 + -8) = unaff_SS;
          *(POINT **)(puVar7 + -10) = &pt;
          *(undefined2 *)(puVar7 + -0xc) = 0x14f8;
          *(undefined2 *)(puVar7 + -0xe) = 0x1b00;
          ScreenToClient(*(HWND *)(puVar7 + -6),*(POINT **)(puVar7 + -10));
          if (vfs.dx < pt.x + dxTip) {
            pt.x = (vfs.dx - dxTip) + -5;
          }
          *(HWND *)(puVar7 + -6) = hwndFrame;
          *(undefined2 *)(puVar7 + -8) = unaff_SS;
          *(POINT **)(puVar7 + -10) = &pt;
          *(undefined2 *)(puVar7 + -0xc) = 0x14f8;
          *(undefined2 *)(puVar7 + -0xe) = 0x1b2d;
          ClientToScreen(*(HWND *)(puVar7 + -6),*(POINT **)(puVar7 + -10));
          *(HWND *)(puVar7 + -6) = hwnd;
          *(undefined2 *)(puVar7 + -8) = 0xffff;
          *(short *)(puVar7 + -10) = pt.x;
          *(int *)(puVar7 + -0xc) = (dyArial8 * 3) / 2 + pt.y;
          *(undefined2 *)(puVar7 + -0xe) = 0;
          *(undefined2 *)(puVar7 + -0x10) = 0;
          *(undefined2 *)(puVar7 + -0x12) = 0x251;
          *(undefined2 *)(puVar7 + -0x14) = 0x14f8;
          *(undefined2 *)(puVar7 + -0x16) = 0x1b59;
          SetWindowPos(*(HWND *)(puVar7 + -6),*(HWND *)(puVar7 + -8),*(short *)(puVar7 + -10),
                       *(short *)(puVar7 + -0xc),*(short *)(puVar7 + -0xe),
                       *(short *)(puVar7 + -0x10),*(UINT *)(puVar7 + -0x12));
          *(HWND *)(puVar7 + -6) = hwnd;
          *(undefined2 *)(puVar7 + -8) = 0x14f8;
          *(undefined2 *)(puVar7 + -10) = 0x1b61;
          UpdateWindow(*(HWND *)(puVar7 + -6));
          if (vidTimerTooltip != -1) {
            *(HWND *)(puVar7 + -6) = hwnd;
            *(short *)(puVar7 + -8) = vidTimerTooltip;
            *(undefined2 *)(puVar7 + -10) = 0x14f8;
            *(undefined2 *)(puVar7 + -0xc) = 0x1b77;
            KillTimer(*(HWND *)(puVar7 + -6),*(UINT *)(puVar7 + -8));
          }
          *(HWND *)(puVar7 + -6) = hwnd;
          *(undefined2 *)(puVar7 + -8) = 0x39e;
          *(undefined2 *)(puVar7 + -10) = 0x32;
          *(undefined2 *)(puVar7 + -0xc) = 0;
          *(undefined2 *)(puVar7 + -0xe) = 0;
          *(undefined2 *)(puVar7 + -0x10) = 0x14f8;
          *(undefined2 *)(puVar7 + -0x12) = 0x1b8f;
          UVar5 = SetTimer(*(HWND *)(puVar7 + -8),*(UINT *)(puVar7 + -10),*(UINT *)(puVar7 + -0xc),
                           puVar7[-0xe]);
          if (UVar5 == 0) {
            vidTimerTooltip = -1;
          }
          else {
            vidTimerTooltip = 0x39e;
          }
          LVar10 = 0;
          uVar2 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
          uVar1 = vtickTooltip1stVis;
          goto LAB_1068_1d6a;
        }
TB_LKillTip:
        *(HWND *)(puVar8 + -2) = hwnd;
        *(undefined2 *)(puVar8 + -4) = 0x14f8;
        *(undefined2 *)(puVar8 + -6) = 0x1c0d;
        DestroyWindow(*(HWND *)(puVar8 + -2));
        uVar1 = vtickTooltip1stVis;
      }
      LVar10 = 0;
      uVar2 = vtickTooltipLast;
      goto LAB_1068_1d6a;
    }
  }
LAB_1068_1d53:
  LVar10 = DefWindowProc(hwnd,msg,wParam,lParam);
  uVar2 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
  uVar1 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
LAB_1068_1d6a:
  vtickTooltip1stVis._2_2_ = (int)(uVar1 >> 0x10);
  vtickTooltip1stVis._0_2_ = (uint)uVar1;
  vtickTooltipLast._2_2_ = (undefined2)(uVar2 >> 0x10);
  vtickTooltipLast._0_2_ = (undefined2)uVar2;
  return LVar10;
}



// ======================================================================
// Function: FakeComboProc
// Address: 1068:1d72
// Segment: MEMORY_TB
// ======================================================================


long FakeComboProc(HWND hwnd,WMType msg,ushort wParam,long lParam)

{
  LRESULT LVar1;
  
  if (msg == WM_MOUSEMOVE) {
    TbWndProc(hwnd,WM_MOUSEMOVE,wParam,lParam);
  }
  else if ((msg == WM_LBUTTONDOWN) || (msg == WM_LBUTTONDBLCLK)) {
    ShowTooltip(~idsUniverseDefinitionFileSeemsMissingCorrupt,(RECT *)0x0);
  }
  LVar1 = CallWindowProc((fn_lpfnRealComboProc *)
                         CONCAT22(lpfnRealComboProc._2_2_,
                                  (fn_lpfnRealComboProc *)lpfnRealComboProc),hwnd,msg,
                         wParam,lParam);
  return LVar1;
}



// ======================================================================
// Function: FakeCEProc
// Address: 1068:1df0
// Segment: MEMORY_TB
// ======================================================================


long FakeCEProc(HWND hwnd,WMType msg,ushort wParam,long lParam)

{
  LRESULT LVar1;
  
  if (msg == WM_MOUSEMOVE) {
    TbWndProc(hwnd,WM_MOUSEMOVE,wParam,lParam);
  }
  else if ((msg == WM_LBUTTONDOWN) || (msg == WM_LBUTTONDBLCLK)) {
    ShowTooltip(~idsUniverseDefinitionFileSeemsMissingCorrupt,(RECT *)0x0);
  }
  LVar1 = CallWindowProc((fn_lpfnRealCEProc *)
                         CONCAT22(lpfnRealCEProc._2_2_,
                                  (fn_lpfnRealCEProc *)lpfnRealCEProc),hwnd,msg,wParam,
                         lParam);
  return LVar1;
}



