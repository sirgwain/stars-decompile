// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: TbWndProc
// Address: 1068:001e
// Segment: MEMORY_TB
// ======================================================================


/* WARNING: Variable defined which should be unmapped: pct */

long TbWndProc(HWND hwnd,WMType msg,ushort wParam,long lParam)

{
  POINT PVar1;
  POINT pt_00;
  POINT pt_01;
  HWND HVar2;
  short sVar3;
  HCURSOR HVar4;
  int iVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  fn_lpfnRealComboProc *pfVar6;
  fn_lpfnRealCEProc *pfVar7;
  ulong uVar8;
  short pct;
  HWND hwndCE;
  RECT rc;
  short x;
  short j;
  POINT ptBtn;
  short dx;
  short iSel;
  short fDown;
  short fCur;
  short i;
  PAINTSTRUCT ps;
  short itb;
  short ids;
  POINT pt;
  short fInside;
  HDC hdc;
  
  if (msg == WM_CREATE) {
    x = 4;
    for (i = 0; i < 0x1d; i = i + 1) {
      itb = (short)*(char *)i;
      dx = DxOfBtn(itb);
      if ((itb < -2) && (itb == -3)) {
        hwndTBRadar =
             CreateWindow(s_COMBOBOX_1120_16ce,(LPCSTR)0x0,0x50200042,x,
                          (0x14 - dyArial8) / 2 + 4,dx,dyArial8 * 0xb + 0x1c,
                          hwnd,0,hInst,(void *)0x0);
        SendMessage(hwndTBRadar,0x30,rghfontArial8[1],0);
        iSel = -1;
        for (j = 0; j < 10; j = j + 1) {
          iVar5 = j * -10 + 100;
          if (iVar5 == vpctRadarView) {
            iSel = j;
          }
          _wsprintf(szWork,PCTDPCTPCT,iVar5);
          SendMessage(hwndTBRadar,0x403,0,0x112057a4);
        }
        SendMessage(hwndTBRadar,0x415,4,0);
        SendMessage(hwndTBRadar,0x40e,iSel,0);
        _wsprintf(szWork,PCTDPCTPCT,vpctRadarView);
        SetWindowText(hwndTBRadar,szWork);
        pfVar6 = (fn_lpfnRealComboProc *)GetWindowLong(hwndTBRadar,-4);
        lpfnRealComboProc = pfVar6;
        SetWindowLong(hwndTBRadar,-4,
                      (long)CONCAT22(lpfnFakeComboProc._2_2_,
                                     (fn_lpfnFakeComboProc *)lpfnFakeComboProc));
        HVar2 = GetWindow(hwndTBRadar,5);
        if (HVar2 != 0) {
          pfVar7 = (fn_lpfnRealCEProc *)GetWindowLong(HVar2,-4);
          lpfnRealCEProc = pfVar7;
          SetWindowLong(HVar2,-4,(long)CONCAT22(lpfnFakeCEProc._2_2_,
                                                (fn_lpfnFakeCEProc *)lpfnFakeCEProc));
        }
      }
      x = x + dx;
    }
  }
  else if (msg == WM_PAINT) {
    hdc = BeginPaint(hwnd,&ps);
    GetClientRect(hwnd,&rc);
    PatBlt(hdc,0,0,rc.right,1,0x42);
    PatBlt(hdc,0,rc.bottom + -1,rc.right,1,0x42);
    if (iWindowLayout == 0) {
      PatBlt(hdc,0,0,1,rc.bottom,0x42);
    }
    DrawToolbar(hdc,&rc);
    EndPaint(hwnd,&ps);
  }
  else {
    if (msg == WM_ERASEBKGND) {
      GetClientRect(hwnd,&rc);
      FillRect(wParam,&rc,hbrButtonFace);
      uVar8 = 1;
      pfVar6 = lpfnRealComboProc;
      pfVar7 = lpfnRealCEProc;
      goto LAB_1068_06e7;
    }
    if (msg == WM_CTLCOLOR) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      uVar8 = (ulong)hbrButtonFace;
      pfVar6 = lpfnRealComboProc;
      pfVar7 = lpfnRealCEProc;
      goto LAB_1068_06e7;
    }
    if (msg == WM_SETCURSOR) {
      HVar4 = LoadCursor(0,(LPCSTR)0x7f00);
      setcursor(HVar4);
      uVar8 = 1;
      pfVar6 = lpfnRealComboProc;
      pfVar7 = lpfnRealCEProc;
      goto LAB_1068_06e7;
    }
    if (msg == WM_COMMAND) {
      if ((HWND)lParam == hwndTBRadar) {
        uVar8 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),pct);
        if ((int)uVar8 == 8) {
          PostMessage(hwnd,0x5f4,0,0);
        }
      }
    }
    else if (msg == WM_MOUSEMOVE) {
      pt.x = (HWND)lParam;
      uVar8 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),pct);
      pt.y = (short)uVar8;
      if (hwnd != hwndTb) {
        MapWindowPoints(hwnd,hwndTb,&pt,1);
      }
      if ((pt.x != vptTbLast.x) || (pt.y != vptTbLast.y)) {
        vptTbLast.x = pt.x;
        vptTbLast.y = pt.y;
        itb = ItbFromPpt(&pt);
        if (itb < 0) {
          if (itb != -3) goto LAB_1068_06de;
          ids = 0x17c;
        }
        else {
          ids = itb + 0x16a;
        }
        rc.left = pt.x;
        sVar3 = DxOfBtn(itb);
        rc.right = sVar3 + rc.left;
        rc.top = pt.y;
        rc.bottom = 0x1c;
        MapWindowPoints(hwndTb,0,(POINT *)&rc,2);
        ShowTooltip(ids,&rc);
      }
    }
    else if ((msg == WM_LBUTTONDOWN) || (msg == WM_LBUTTONDBLCLK)) {
      ShowTooltip(~idsUniverseDefinitionFileSeemsMissingCorrupt,(RECT *)0x0);
      pt.x = (HWND)lParam;
      uVar8 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),pct);
      ptBtn.y = (short)uVar8;
      ptBtn.x = pt.x;
      pt.y = ptBtn.y;
      itb = ItbFromPpt(&ptBtn);
      if (-1 < itb) {
        fDown = FIsButtonDown(itb);
        if ((fDown == 0) || (5 < itb)) {
          if ((itb == 0xd) || (((itb == 0xf || (itb == 0x10)) || (itb == 8)))) {
            ExecuteButton(itb,(uint)(fDown == 0));
          }
          else {
            dx = DxOfBtn(itb);
            rc.left = ptBtn.x;
            rc.top = ptBtn.y;
            rc.right = ptBtn.x + dx;
            rc.bottom = ptBtn.y + 0x1c;
            hdc = GetDC(hwnd);
            SelectPalette(hdc,vhpal,0);
            RealizePalette(hdc);
            SetCapture(hwnd);
            fCur = -1;
            while( true ) {
              sVar3 = FGetMouseMove(&pt);
              if (sVar3 == 0) break;
              PVar1.y = pt.y;
              PVar1.x = pt.x;
              fInside = PtInRect(&rc,PVar1);
              if (fCur != fInside) {
                pt_00.y = ptBtn.y;
                pt_00.x = ptBtn.x;
                DrawBitmapButton(hdc,pt_00,itb,fDown + fInside);
                fCur = fInside;
              }
            }
            ReleaseCapture();
            if (fInside != 0) {
              ExecuteButton(itb,(uint)(fDown == 0));
              fDown = FIsButtonDown(itb);
            }
            if (itb < 6) {
              GetClientRect(hwnd,&rc);
              DrawToolbar(hdc,&rc);
            }
            else {
              pt_01.y = ptBtn.y;
              pt_01.x = ptBtn.x;
              DrawBitmapButton(hdc,pt_01,itb,fDown);
            }
            ReleaseDC(hwnd,hdc);
          }
        }
        else {
          MessageBeep(0);
        }
      }
    }
    else {
      if (msg != 0x5f4) {
        uVar8 = DefWindowProc(hwnd,msg,wParam,lParam);
        pfVar6 = lpfnRealComboProc;
        pfVar7 = lpfnRealCEProc;
        goto LAB_1068_06e7;
      }
      TerminateToolbarFocus(0);
    }
  }
LAB_1068_06de:
  uVar8 = 0;
  pfVar6 = lpfnRealComboProc;
  pfVar7 = lpfnRealCEProc;
LAB_1068_06e7:
  lpfnRealCEProc._2_2_ = (undefined2)((ulong)pfVar7 >> 0x10);
  lpfnRealCEProc._0_2_ = (fn_lpfnRealCEProc *)pfVar7;
  lpfnRealComboProc._2_2_ = (undefined2)((ulong)pfVar6 >> 0x10);
  lpfnRealComboProc._0_2_ = (fn_lpfnRealComboProc *)pfVar6;
  return uVar8;
}



// ======================================================================
// Function: DrawToolbar
// Address: 1068:06f0
// Segment: MEMORY_TB
// ======================================================================


void DrawToolbar(HDC hdc,RECT *prc)

{
  int itb;
  short sVar1;
  POINT pt_00;
  short ibtn;
  short i;
  int pt;
  
  SelectPalette(hdc,vhpal,0);
  RealizePalette(hdc);
  pt = 4;
  for (i = 0; i < 0x1d; i = i + 1) {
    itb = (int)*(char *)i;
    if (-1 < itb) {
      sVar1 = FIsButtonDown(itb);
      pt_00.y = 4;
      pt_00.x = pt;
      DrawBitmapButton(hdc,pt_00,(int)*(char *)i,sVar1);
    }
    sVar1 = DxOfBtn(itb);
    pt = pt + sVar1;
  }
  return;
}



// ======================================================================
// Function: DrawBitmapButton
// Address: 1068:078c
// Segment: MEMORY_TB
// ======================================================================


void DrawBitmapButton(HDC hdc,POINT pt,short ibtn,short fDown)

{
  short sVar1;
  short dx_00;
  short dxDraw;
  HBRUSH hbrTopLeft;
  HBRUSH hbrBotRight;
  short dx;
  
  sVar1 = DxOfBtn(ibtn);
  if (sVar1 < 0x18) {
    dx_00 = 7;
  }
  else {
    dx_00 = 0x18;
  }
  if (fDown == 0) {
    hbrTopLeft = hbrButtonHilite;
    hbrBotRight = hbrButtonShadow;
  }
  else {
    hbrTopLeft = hbrButtonShadow;
    hbrBotRight = hbrButtonHilite;
  }
  SelectObject(hdc,hbrTopLeft);
  PatBlt(hdc,pt.x + 2,pt.y,sVar1 + -4,1,0xf00021);
  PatBlt(hdc,pt.x,pt.y + 2,1,0x18,0xf00021);
  PatBlt(hdc,pt.x + 1,pt.y + 1,1,1,0xf00021);
  PatBlt(hdc,pt.x + 1,pt.y + 0x1a,1,1,0xf00021);
  SelectObject(hdc,hbrBotRight);
  PatBlt(hdc,pt.x + 2,pt.y + 0x1b,sVar1 + -4,1,0xf00021);
  PatBlt(hdc,pt.x + sVar1 + -1,pt.y + 2,1,0x18,0xf00021);
  PatBlt(hdc,pt.x + sVar1 + -2,pt.y + 1,1,1,0xf00021);
  PatBlt(hdc,pt.x + sVar1 + -2,pt.y + 0x1a,1,1,0xf00021);
  SelectObject(hdc,hbrButtonFace);
  PatBlt(hdc,pt.x + 2,pt.y + 1,sVar1 + -4,1,0xf00021);
  PatBlt(hdc,pt.x + 1,pt.y + 2,1,0x18,0xf00021);
  if (fDown == 0) {
    PatBlt(hdc,pt.x + 2,pt.y + 0x19,sVar1 + -4,2,0xf00021);
    PatBlt(hdc,pt.x + sVar1 + -3,pt.y + 2,2,0x18,0xf00021);
  }
  else {
    PatBlt(hdc,pt.x + 2,pt.y + 2,sVar1 + -4,fDown,0xf00021);
    PatBlt(hdc,pt.x + 2,pt.y + 2,fDown,0x18,0xf00021);
    if (fDown == 1) {
      PatBlt(hdc,pt.x + 2,pt.y + 0x1a,sVar1 + -4,1,0xf00021);
      PatBlt(hdc,pt.x + sVar1 + -2,pt.y + 2,1,0x18,0xf00021);
    }
  }
  DibBlt(hdc,pt.x + 2 + fDown,pt.y + 2 + fDown,dx_00,0x17,hdibToolbar,ibtn * 0x18
                  ,0,dx_00,0x17,0xcc0020);
  if (1 < fDown) {
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,pt.x + sVar1 + -2,pt.y + 0x1a,1,1,0xf00021);
  }
  return;
}



// ======================================================================
// Function: ItbFromPpt
// Address: 1068:0b12
// Segment: MEMORY_TB
// ======================================================================


short ItbFromPpt(POINT *ppt)

{
  short sVar1;
  short x;
  short dx;
  short i;
  
  x = 4;
  if (((3 < ppt->x) && (3 < ppt->y)) && (ppt->y < 0x20)) {
    for (i = 0; i < 0x1d; i = i + 1) {
      sVar1 = DxOfBtn((int)*(char *)i);
      if (ppt->x < x + sVar1) {
        ppt->x = x;
        ppt->y = 4;
        return (int)*(char *)i;
      }
      x = x + sVar1;
    }
  }
  return -1;
}



// ======================================================================
// Function: DxOfBtn
// Address: 1068:0bb2
// Segment: MEMORY_TB
// ======================================================================


short DxOfBtn(short itb)

{
  short sVar1;
  
  if (itb < 0) {
    if (itb == -1) {
      sVar1 = 6;
    }
    else if (itb == -2) {
      sVar1 = 2;
    }
    else if (itb == -3) {
      if (dyArial8 < 0x10) {
        sVar1 = 0x3c;
      }
      else {
        sVar1 = 0x46;
      }
    }
    else {
      sVar1 = 0;
    }
  }
  else if ((itb == 0xd) || (itb == 0xf)) {
    sVar1 = 0xb;
  }
  else {
    sVar1 = 0x1d;
  }
  return sVar1;
}



// ======================================================================
// Function: FIsButtonDown
// Address: 1068:0c3a
// Segment: MEMORY_TB
// ======================================================================


short FIsButtonDown(short itb)

{
  uint uVar1;
  
  switch(itb) {
  case 0:
  case 1:
  case 2:
  case 3:
  case 4:
  case 5:
    uVar1 = (uint)((grbitScan & 0xf) == itb);
    break;
  case 6:
    uVar1 = (uint)((grbitScan & 0x10) != 0);
    break;
  case 7:
    uVar1 = (uint)((grbitScan & 0x20) != 0);
    break;
  case 8:
    if (((grbitScan & 0x40) == 0) || (grbitScanMines != 0xf)) {
      uVar1 = 0;
    }
    else {
      uVar1 = 1;
    }
    break;
  case 9:
    uVar1 = (uint)((grbitScan & 0x80) != 0);
    break;
  case 10:
    uVar1 = (uint)((grbitScan & 0x100) != 0);
    break;
  case 0xb:
    uVar1 = (uint)((grbitScan & 0x400) != 0);
    break;
  case 0xc:
    uVar1 = (uint)((grbitScan & 0x200) != 0);
    break;
  case 0xd:
  case 0xf:
  case 0x10:
    uVar1 = 0;
    break;
  case 0xe:
    uVar1 = (uint)((grbitScan & 0x800) != 0);
    break;
  case 0x11:
    uVar1 = (uint)((grbitScan & 0x1000) != 0);
    break;
  default:
    uVar1 = 0;
  }
  return uVar1;
}



// ======================================================================
// Function: ExecuteButton
// Address: 1068:0db6
// Segment: MEMORY_TB
// ======================================================================


void ExecuteButton(short itb,short fDown)

{
  ushort uVar1;
  short sVar2;
  uint uVar3;
  undefined2 unaff_SS;
  short iSel;
  uint rgid [24];
  short iSel__90;
  uint rgid__88 [9];
  short iSel__70;
  uint rgid__68 [5];
  short c;
  short i;
  short ish;
  char *rgszScan [6];
  ushort grbit;
  short i__38;
  short c__36;
  char *rgszScan__34;
  short i__32;
  short c__30;
  char *rgszScan__28 [8];
  undefined1 pt [4];
  ushort grbitSh;
  ushort grbitNew;
  
  gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xffbf | 0x40;
  switch(itb) {
  case 0:
  case 1:
  case 2:
  case 3:
  case 4:
  case 5:
    if (fDown == 0) {
      return;
    }
    grbitScan = itb + (grbitScan & 0x3ff0);
    goto LAB_1068_1644;
  case 6:
    grbitNew = 0x10;
    break;
  case 7:
    grbitNew = 0x20;
    break;
  case 8:
    grbit = 1;
    c__36 = 0;
    if ((grbitScan & 0x40) == 0) {
      grbitScanMines = 0;
    }
    for (i__38 = 0x4fe; sVar2 = c__36, i__38 < 0x500; i__38 = i__38 + 1) {
      if (i__38 == 0x4fe) {
        rgid__88[c__36 * 2] = (uint)(grbitScanMines == 0xf);
        rgid__88[sVar2 * 2 + 1] = 0;
      }
      else {
        rgid__88[c__36 * 2] = (uint)(grbitScanMines == 0);
        rgid__88[sVar2 * 2 + 1] = 0;
      }
      CchGetString(i__38,(char *)szWork + 0xa0 + (i__38 + -0x4fe) * 0x1e);
      (&rgszScan__34)[c__36] = (char *)szWork + 0xa0 + (i__38 + -0x4fe) * 0x1e;
      c__36 = c__36 + 1;
    }
    rgid__88[c__36 * 2] = 0;
    rgid__88[sVar2 * 2 + 1] = 0;
    szWork[0xfa] = -1;
    szWork[0xfb] = '\0';
    (&rgszScan__34)[c__36] = (char *)szWork + 0xfa;
    for (i__38 = 0; c__36 = c__36 + 1, sVar2 = c__36, i__38 < 4; i__38 = i__38 + 1) {
      rgid__88[c__36 * 2] = (uint)((1 << ((byte)i__38 & 0x1f) & grbitScanMines) != 0);
      rgid__88[sVar2 * 2 + 1] = 0;
      CchGetString(i__38 + idsMineFields3,(char *)szWork + i__38 * 0x1e);
      (&rgszScan__34)[c__36] = (char *)szWork + i__38 * 0x1e;
    }
    GetCursorPos(pt + 2);
    ScreenToClient(hwndTb,pt + 2);
    iSel__90 = PopupMenu(hwndTb,pt._2_2_,grbitSh,c__36,rgid__88,&rgszScan__34,-2,0);
    if (iSel__90 == -1) {
      return;
    }
    if (iSel__90 < 3) {
      if (iSel__90 == 0) {
        grbitScanMines = 0xf;
      }
      else {
        grbitScanMines = 0;
      }
    }
    else {
      iSel__90 = iSel__90 + -3;
      grbitScanMines = grbitScanMines ^ 1 << ((byte)iSel__90 & 0x1f);
    }
    if (grbitScanMines == 0) {
      grbitScan = grbitScan & 0xffbf;
    }
    else {
      grbitScan = grbitScan | 0x40;
    }
    InvalidateRect(hwndTb,(RECT *)0x0,1);
    goto LAB_1068_1644;
  case 9:
    grbitNew = 0x80;
    break;
  case 10:
    grbitNew = 0x100;
    break;
  case 0xb:
    grbitNew = 0x400;
    break;
  case 0xc:
    grbitNew = 0x200;
    break;
  case 0xd:
    c = 0;
    for (i = 0x4fb; sVar2 = c, i < 0x4fe; i = i + 1) {
      rgid[c * 2] = 0;
      rgid[sVar2 * 2 + 1] = 0;
      CchGetString(i,(char *)szWork + (i + -0x4fb) * 0x14);
      rgszScan[c] = (char *)szWork + (i + -0x4fb) * 0x14;
      c = c + 1;
    }
    rgid[c * 2] = 0;
    rgid[sVar2 * 2 + 1] = 0;
    szWork[200] = -1;
    szWork[0xc9] = '\0';
    rgszScan[c] = (char *)szWork + 200;
    grbitSh = 1;
    c = c + 1;
    for (ish = 0; sVar2 = c, ish < 0x10; ish = ish + 1) {
      if ((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) == 0) {
        rgid[c * 2] = (uint)((grbitSh & grbitScanShip) != 0);
        rgid[sVar2 * 2 + 1] = 0;
        rgszScan[c] = (char *)(ish * 0x93 + 0x3f08);
        c = c + 1;
      }
      grbitSh = grbitSh << 1;
    }
    GetCursorPos(pt);
    ScreenToClient(hwndTb,pt);
    sVar2 = PopupMenu(hwndTb,pt._0_2_,pt._2_2_,c,rgid,rgszScan,-2,0);
    if (sVar2 == -1) {
      return;
    }
    if (sVar2 < 4) {
      if (sVar2 == 0) {
        grbitScanShip = 0xffff;
      }
      else if (sVar2 == 1) {
        grbitScanShip = grbitScanShip ^ 0xffff;
      }
      else {
        grbitScanShip = 0;
      }
      uVar1 = grbitScanShip;
      if ((grbitScan & 0x200) == 0) goto joined_r0x10681246;
    }
    else {
      iSel = sVar2 + -4;
      ish = 0;
      while ((ish < 0x10 &&
             (((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0 ||
              (iSel = iSel + -1, -1 < iSel))))) {
        ish = ish + 1;
      }
      grbitScanShip = grbitScanShip ^ 1 << ((byte)ish & 0x1f);
      if ((grbitScan & 0x200) == 0) {
        uVar1 = 1 << ((byte)ish & 0x1f) & grbitScanShip;
joined_r0x10681246:
        if (uVar1 != 0) {
          grbitScan = grbitScan | 0x200;
          InvalidateRect(hwndTb,(RECT *)0x0,1);
        }
      }
    }
    uVar3 = grbitScan & 0x200;
    goto joined_r0x1068150e;
  case 0xe:
    grbitNew = 0x800;
    break;
  case 0xf:
    grbit = 1;
    c__36 = 0;
    for (i__38 = 0x4fb; sVar2 = c__36, i__38 < 0x4fe; i__38 = i__38 + 1) {
      rgid__88[c__36 * 2] = 0;
      rgid__88[sVar2 * 2 + 1] = 0;
      CchGetString(i__38,(char *)szWork + 200 + (i__38 + -0x4fb) * 0x19);
      (&rgszScan__34)[c__36] = (char *)szWork + 200 + (i__38 + -0x4fb) * 0x19;
      c__36 = c__36 + 1;
    }
    rgid__88[c__36 * 2] = 0;
    rgid__88[sVar2 * 2 + 1] = 0;
    szWork[300] = -1;
    szWork[0x12d] = '\0';
    (&rgszScan__34)[c__36] = (char *)szWork + 300;
    for (i__38 = 0; c__36 = c__36 + 1, sVar2 = c__36, i__38 < 8; i__38 = i__38 + 1) {
      rgid__88[c__36 * 2] = (uint)((1 << ((byte)i__38 & 0x1f) & grbitScanEShip) != 0);
      rgid__88[sVar2 * 2 + 1] = 0;
      CchGetString(i__38 + idsColony,(char *)szWork + i__38 * 0x19);
      (&rgszScan__34)[c__36] = (char *)szWork + i__38 * 0x19;
    }
    GetCursorPos(pt + 2);
    ScreenToClient(hwndTb,pt + 2);
    iSel__90 = PopupMenu(hwndTb,pt._2_2_,grbitSh,c__36,rgid__88,&rgszScan__34,-2,0);
    if (iSel__90 == -1) {
      return;
    }
    if (iSel__90 < 4) {
      if (iSel__90 == 0) {
        grbitScanEShip = 0xff;
      }
      else if (iSel__90 == 1) {
        grbitScanEShip = grbitScanEShip ^ 0xff;
      }
      else {
        grbitScanEShip = 0;
      }
      uVar1 = grbitScanEShip;
      if ((grbitScan & 0x800) == 0) goto joined_r0x106814ad;
    }
    else {
      iSel__90 = iSel__90 + -4;
      grbitScanEShip = grbitScanEShip ^ 1 << ((byte)iSel__90 & 0x1f);
      if ((grbitScan & 0x800) == 0) {
        uVar1 = 1 << ((byte)iSel__90 & 0x1f) & grbitScanEShip;
joined_r0x106814ad:
        if (uVar1 != 0) {
          grbitScan = grbitScan | 0x800;
          InvalidateRect(hwndTb,(RECT *)0x0,1);
        }
      }
    }
    uVar3 = grbitScan & 0x800;
joined_r0x1068150e:
    if (uVar3 == 0) {
      return;
    }
    goto LAB_1068_1644;
  case 0x10:
    c__30 = 0;
    for (i__32 = 0; sVar2 = c__30, i__32 < 9; i__32 = i__32 + 1) {
      rgid__68[c__30 * 2] = (uint)(iScanZoom + 4 == i__32);
      rgid__68[sVar2 * 2 + 1] = 0;
      _wsprintf((char *)szWork + i__32 * 8,PCTDPCTPCT,
                *(undefined2 *)(i__32 * 2 + vrgpctZoom));
      rgszScan__28[c__30] = (char *)szWork + i__32 * 8;
      c__30 = c__30 + 1;
    }
    GetCursorPos(pt + 2);
    ScreenToClient(hwndTb,pt + 2);
    iSel__70 = PopupMenu(hwndTb,pt._2_2_,grbitSh,c__30,rgid__68,rgszScan__28,-2,0);
    if (iSel__70 == -1) {
      return;
    }
    CommandHandler(hwndFrame,iSel__70 + 0xf3d);
    return;
  case 0x11:
    grbitNew = 0x1000;
    break;
  default:
    goto switchD_1068_161b_default;
  }
  if (fDown == 0) {
    grbitScan = grbitScan & ~grbitNew;
  }
  else {
    grbitScan = grbitScan | grbitNew;
  }
LAB_1068_1644:
  if (itb != 6) {
    InvalidateRect(hwndScanner,(RECT *)0x0,1);
  }
  if (((uint)gd.grBits >> 0xb & 1) != 0) {
    AdvanceTutor();
  }
switchD_1068_161b_default:
  return;
}



// ======================================================================
// Function: TerminateToolbarFocus
// Address: 1068:1680
// Segment: MEMORY_TB
// ======================================================================


void TerminateToolbarFocus(short fCancel)

{
  char *psz;
  short pct;
  
  gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xffbf | 0x40;
  if (fCancel == 0) {
    GetWindowText(hwndTBRadar,szWork,0x14);
    pct = 0;
    for (psz = (char *)szWork; ('/' < *psz && (*psz < ':')); psz = psz + 1) {
      pct = pct * 10 + *psz + -0x30;
    }
    if ((*psz != '\0') && (*psz != '%')) {
      pct = 0;
    }
  }
  else {
    pct = vpctRadarView;
  }
  if (pct < 2) {
    pct = 2;
  }
  else if (100 < pct) {
    pct = 100;
  }
  SendMessage(hwndTBRadar,0x40e,(100 - pct) / 10,0);
  _wsprintf(szWork,PCTDPCTPCT,pct);
  SetWindowText(hwndTBRadar,szWork);
  if (pct != vpctRadarView) {
    vpctRadarView = pct;
    if ((grbitScan & 0x20) == 0) {
      InvalidateRect(hwndTb,(RECT *)0x0,1);
    }
    grbitScan = grbitScan | 0x20;
    InvalidateRect(hwndScanner,(RECT *)0x0,1);
  }
  SetFocus(hwndFrame);
  return;
}



// ======================================================================
// Function: ShowTooltip
// Address: 1068:17ea
// Segment: MEMORY_TB
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x106819a8) */

void ShowTooltip(StringId ids,RECT *prc)

{
  bool bVar1;
  BOOL BVar2;
  short sVar3;
  HDC HVar4;
  HGDIOBJ HVar5;
  int iVar6;
  ushort wParam;
  int iVar7;
  DWORD DVar8;
  short fShowNow;
  short cch;
  short fVisCur;
  HFONT hfontSav;
  HDC hdc;
  
  if ((hwndTooltip == 0) || (BVar2 = IsWindowVisible(hwndTooltip), BVar2 == 0)) {
    bVar1 = false;
  }
  else {
    bVar1 = true;
  }
  if (((int)ids < 0) || (prc == (RECT *)0x0)) {
    if (hwndTooltip != 0) {
      DestroyWindow(hwndTooltip);
    }
    DVar8 = CONCAT22(vtickTooltipLast._2_2_,(uint)vtickTooltipLast);
    if (bVar1) {
      DVar8 = GetTickCount();
    }
  }
  else {
    if (ids == vidsTooltip) {
      BVar2 = EqualRect(prc,&vrcTooltip);
      DVar8 = CONCAT22(vtickTooltipLast._2_2_,(uint)vtickTooltipLast);
      if (BVar2 != 0) goto LAB_1068_19dd;
    }
    vidsTooltip = ids;
    sVar3 = CchGetString(ids,(char *)szWork);
    vrcTooltip.left = prc->left;
    vrcTooltip.top = prc->top;
    vrcTooltip.right = prc->right;
    vrcTooltip.bottom = prc->bottom;
    HVar4 = GetDC(0);
    HVar5 = SelectObject(HVar4,rghfontArial8[0]);
    DVar8 = GetTextExtent(HVar4,szWork,sVar3);
    dxTip = (short)DVar8;
    SelectObject(HVar4,HVar5);
    ReleaseDC(0,HVar4);
    if (hwndTooltip == 0) {
      CreateWindow(szTooltip,(LPCSTR)0x0,0x80000000,100,100,dxTip + 6,
                   dyArial8 + 6,hwndTb,0,hInst,(void *)0x0);
    }
    else {
      InvalidateRect(hwndTooltip,(RECT *)0x0,1);
    }
    SetWindowPos(hwndTooltip,0xffff,0,0,dxTip + 6,dyArial8 + 6,0x216);
    iVar6 = (uint)vtickTooltipLast + 400;
    iVar7 = vtickTooltipLast._2_2_ + (uint)(0xfe6f < (uint)vtickTooltipLast);
    DVar8 = GetTickCount();
    if ((DVar8 <= CONCAT22(iVar7,iVar6)) || (bVar1)) {
      wParam = 1;
    }
    else {
      wParam = 0;
    }
    TooltipWndProc(hwndTooltip,0x5f3,wParam,0);
    DVar8 = CONCAT22(vtickTooltipLast._2_2_,(uint)vtickTooltipLast);
  }
LAB_1068_19dd:
  vtickTooltipLast._2_2_ = (int)(DVar8 >> 0x10);
  vtickTooltipLast._0_2_ = (uint)DVar8;
  return;
}



// ======================================================================
// Function: TooltipWndProc
// Address: 1068:19e4
// Segment: MEMORY_TB
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10681bfc) */

long TooltipWndProc(HWND hwnd,WMType msg,ushort wParam,long lParam)

{
  POINT PVar1;
  POINT PVar2;
  ulong uVar3;
  ulong uVar4;
  BOOL BVar5;
  UINT UVar6;
  short sVar7;
  undefined2 unaff_SS;
  LRESULT LVar8;
  undefined1 uVar9;
  short cch;
  short bkSav;
  RECT rc;
  PAINTSTRUCT ps;
  POINT pt;
  HDC hdc;
  
  if (msg == WM_CREATE) {
    hwndTooltip = hwnd;
  }
  else if (msg == WM_DESTROY) {
    hwndTooltip = 0;
    if (vidTimerTooltip != -1) {
      KillTimer(hwnd,vidTimerTooltip);
      vidTimerTooltip = -1;
    }
    vidsTooltip = -1;
  }
  else {
    if (msg == WM_PAINT) {
      hdc = BeginPaint(hwnd,&ps);
      GetClientRect(hwnd,&rc);
      FrameRect(hdc,&rc,hbrWindowFrame);
      SelectObject(hdc,rghfontArial8[0]);
      UVar6 = CchGetString(vidsTooltip,(char *)szWork);
      sVar7 = SetBkMode(hdc,1);
      SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
      ExtTextOut(hdc,3,3,0,(RECT *)0x0,szWork,UVar6,(short *)0x0);
      SetBkMode(hdc,sVar7);
      EndPaint(hwnd,&ps);
      LVar8 = 0;
      uVar4 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
      uVar3 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
      goto LAB_1068_1d6a;
    }
    if (msg == WM_ERASEBKGND) {
      GetClientRect(hwnd,&rc);
      FillRect(wParam,&rc,hbrTooltip);
      LVar8 = 1;
      uVar4 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
      uVar3 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
      goto LAB_1068_1d6a;
    }
    if (msg != WM_TIMER) {
      if (((msg == WM_MOUSEMOVE) || (msg == WM_LBUTTONDOWN)) || (msg == WM_LBUTTONDBLCLK)) {
        DestroyWindow(hwnd);
        uVar3 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
        uVar4 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
        LVar8 = 0;
        goto LAB_1068_1d6a;
      }
      if (msg != 0x5f3) goto LAB_1068_1d53;
      if (wParam == 0) {
        if (vidTimerTooltip != -1) {
          KillTimer(hwnd,vidTimerTooltip);
        }
        UVar6 = SetTimer(0x39e,700,0,0);
        uVar3 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
        uVar4 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
        if (UVar6 == 0) {
          vidTimerTooltip = -1;
        }
        else {
          vidTimerTooltip = 0x39e;
        }
        LVar8 = 0;
        goto LAB_1068_1d6a;
      }
      wParam = 0x39e;
    }
    if (wParam == 0x39e) {
      if ((msg == WM_TIMER) && (BVar5 = IsWindowVisible(hwnd), BVar5 != 0)) {
        vtickTooltipLast = GetTickCount();
        GetCursorPos(&pt);
        PVar2.y = pt.y;
        PVar2.x = pt.x;
        BVar5 = PtInRect(&vrcTooltip,PVar2);
        uVar3 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
        vtickTooltip1stVis =
             CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
        if ((BVar5 == 0) ||
           (vtickTooltip1stVis =
                 CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis),
           CONCAT22(vtickTooltip1stVis._2_2_ +
                    (uint)(0xd8ef < (uint)vtickTooltip1stVis),
                    (uint)vtickTooltip1stVis + 10000) < vtickTooltipLast))
        goto TB_LKillTip;
      }
      else {
        vtickTooltip1stVis = GetTickCount();
        GetCursorPos(&pt);
        PVar1.y = pt.y;
        PVar1.x = pt.x;
        BVar5 = PtInRect(&vrcTooltip,PVar1);
        if (BVar5 != 0) {
          uVar9 = (undefined1)((uint)unaff_SS >> 8);
          ScreenToClient(hwndFrame,(POINT *)CONCAT13(uVar9,CONCAT12((char)unaff_SS,&pt)));
          if (vfs.dx < pt.x + dxTip) {
            pt.x = (vfs.dx - dxTip) + -5;
          }
          ClientToScreen(hwndFrame,(POINT *)CONCAT13(uVar9,CONCAT12((char)unaff_SS,&pt)));
          SetWindowPos(hwnd,0xffff,pt.x,(dyArial8 * 3) / 2 + pt.y,0,0,0x251);
          UpdateWindow(hwnd);
          if (vidTimerTooltip != -1) {
            KillTimer(hwnd,vidTimerTooltip);
          }
          UVar6 = SetTimer(0x39e,0x32,0,0);
          if (UVar6 == 0) {
            vidTimerTooltip = -1;
          }
          else {
            vidTimerTooltip = 0x39e;
          }
          LVar8 = 0;
          uVar4 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
          uVar3 = vtickTooltip1stVis;
          goto LAB_1068_1d6a;
        }
TB_LKillTip:
        DestroyWindow(hwnd);
        uVar3 = vtickTooltip1stVis;
      }
      LVar8 = 0;
      uVar4 = vtickTooltipLast;
      goto LAB_1068_1d6a;
    }
  }
LAB_1068_1d53:
  LVar8 = DefWindowProc(hwnd,msg,wParam,lParam);
  uVar4 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
  uVar3 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
LAB_1068_1d6a:
  vtickTooltip1stVis._2_2_ = (int)(uVar3 >> 0x10);
  vtickTooltip1stVis._0_2_ = (uint)uVar3;
  vtickTooltipLast._2_2_ = (undefined2)(uVar4 >> 0x10);
  vtickTooltipLast._0_2_ = (undefined2)uVar4;
  return LVar8;
}



// ======================================================================
// Function: FakeComboProc
// Address: 1068:1d72
// Segment: MEMORY_TB
// ======================================================================


long FakeComboProc(HWND hwnd,WMType msg,ushort wParam,long lParam)

{
  LRESULT LVar1;
  
  if (msg == WM_MOUSEMOVE) {
    TbWndProc(hwnd,WM_MOUSEMOVE,wParam,lParam);
  }
  else if ((msg == WM_LBUTTONDOWN) || (msg == WM_LBUTTONDBLCLK)) {
    ShowTooltip(~idsUniverseDefinitionFileSeemsMissingCorrupt,(RECT *)0x0);
  }
  LVar1 = CallWindowProc((fn_lpfnRealComboProc *)
                         CONCAT22(lpfnRealComboProc._2_2_,
                                  (fn_lpfnRealComboProc *)lpfnRealComboProc),hwnd,msg,
                         wParam,lParam);
  return LVar1;
}



// ======================================================================
// Function: FakeCEProc
// Address: 1068:1df0
// Segment: MEMORY_TB
// ======================================================================


long FakeCEProc(HWND hwnd,WMType msg,ushort wParam,long lParam)

{
  LRESULT LVar1;
  
  if (msg == WM_MOUSEMOVE) {
    TbWndProc(hwnd,WM_MOUSEMOVE,wParam,lParam);
  }
  else if ((msg == WM_LBUTTONDOWN) || (msg == WM_LBUTTONDBLCLK)) {
    ShowTooltip(~idsUniverseDefinitionFileSeemsMissingCorrupt,(RECT *)0x0);
  }
  LVar1 = CallWindowProc((fn_lpfnRealCEProc *)
                         CONCAT22(lpfnRealCEProc._2_2_,
                                  (fn_lpfnRealCEProc *)lpfnRealCEProc),hwnd,msg,wParam,
                         lParam);
  return LVar1;
}



