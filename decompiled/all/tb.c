// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: TbWndProc
// Address: 1068:001e
// Segment: MEMORY_TB
// ======================================================================


/* WARNING: Variable defined which should be unmapped: pct */

long TbWndProc(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  POINT pt_00;
  POINT pt_01;
  int iVar1;
  short sVar2;
  HWND HVar3;
  short sVar4;
  HCURSOR HVar5;
  HDC HVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  fn_lpfnRealComboProc *pfVar7;
  fn_lpfnRealCEProc *pfVar8;
  ulong uVar9;
  short pct;
  HWND hwndCE;
  RECT rc;
  short x;
  short j;
  POINT ptBtn;
  short dx;
  short iSel;
  short fDown;
  short fCur;
  short i;
  PAINTSTRUCT ps;
  short itb;
  short ids;
  POINT pt;
  short fInside;
  HDC hdc;
  
  if (msg == 1) {
    x = 4;
    for (i = 0; i < 0x1d; i = i + 1) {
      iVar1 = (int)*(char *)i;
      sVar2 = DxOfBtn(iVar1);
      if ((iVar1 < -2) && (iVar1 == -3)) {
        hwndTBRadar =
             CreateWindow(s_COMBOBOX_1120_16ce,(LPCSTR)0x0,0x50200042,x,
                          (0x14 - dyArial8) / 2 + 4,sVar2,dyArial8 * 0xb + 0x1c,
                          hwnd,0,hInst,(void *)0x0);
        SendMessage(hwndTBRadar,0x30,rghfontArial8[1],0);
        iSel = -1;
        for (j = 0; j < 10; j = j + 1) {
          iVar1 = j * -10 + 100;
          if (iVar1 == vpctRadarView) {
            iSel = j;
          }
          _WSPRINTF((LPSTR)CONCAT22(iVar1,(char *)&DAT_1120_1120),
                    (LPCSTR)CONCAT22(PCTDPCTPCT,(char *)&DAT_1120_1120),
                    (char *)szWork);
          SendMessage(hwndTBRadar,0x403,0,0x112057a4);
        }
        SendMessage(hwndTBRadar,0x415,4,0);
        SendMessage(hwndTBRadar,0x40e,iSel,0);
        _WSPRINTF((LPSTR)CONCAT22(vpctRadarView,(char *)&DAT_1120_1120),
                  (LPCSTR)CONCAT22(PCTDPCTPCT,(char *)&DAT_1120_1120),
                  (char *)szWork);
        SetWindowText(hwndTBRadar,szWork);
        pfVar7 = (fn_lpfnRealComboProc *)GetWindowLong(hwndTBRadar,-4);
        lpfnRealComboProc = pfVar7;
        SetWindowLong(hwndTBRadar,-4,
                      (long)CONCAT22(lpfnFakeComboProc._2_2_,
                                     (fn_lpfnFakeComboProc *)lpfnFakeComboProc));
        HVar3 = GetWindow(hwndTBRadar,5);
        if (HVar3 != 0) {
          pfVar8 = (fn_lpfnRealCEProc *)GetWindowLong(HVar3,-4);
          lpfnRealCEProc = pfVar8;
          SetWindowLong(HVar3,-4,(long)CONCAT22(lpfnFakeCEProc._2_2_,
                                                (fn_lpfnFakeCEProc *)lpfnFakeCEProc));
        }
      }
      x = x + sVar2;
    }
  }
  else if (msg == 0xf) {
    HVar6 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    PatBlt(HVar6,0,0,rc.right,1,0x42);
    PatBlt(HVar6,0,rc.bottom + -1,rc.right,1,0x42);
    if (iWindowLayout == 0) {
      PatBlt(HVar6,0,0,1,rc.bottom,0x42);
    }
    DrawToolbar(HVar6,&rc);
    EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
  }
  else {
    if (msg == 0x14) {
      GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
      FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
      uVar9 = 1;
      pfVar7 = lpfnRealComboProc;
      pfVar8 = lpfnRealCEProc;
      goto LAB_1068_06e7;
    }
    if (msg == 0x19) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      uVar9 = (ulong)hbrButtonFace;
      pfVar7 = lpfnRealComboProc;
      pfVar8 = lpfnRealCEProc;
      goto LAB_1068_06e7;
    }
    if (msg == 0x20) {
      HVar5 = LoadCursor(0,&DAT_0000_7f00);
      setcursor(HVar5);
      uVar9 = 1;
      pfVar7 = lpfnRealComboProc;
      pfVar8 = lpfnRealCEProc;
      goto LAB_1068_06e7;
    }
    if (msg == 0x111) {
      if ((HWND)lParam == hwndTBRadar) {
        uVar9 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),pct);
        if ((int)uVar9 == 8) {
          PostMessage(hwnd,0x5f4,0,0);
        }
      }
    }
    else if (msg == 0x200) {
      pt.x = (HWND)lParam;
      uVar9 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),pct);
      pt.y = (short)uVar9;
      if (hwnd != hwndTb) {
        MapWindowPoints(hwnd,hwndTb,(undefined2 *)CONCAT22(unaff_SS,&pt),1);
      }
      if ((pt.x != vptTbLast.x) || (pt.y != vptTbLast.y)) {
        vptTbLast.x = pt.x;
        vptTbLast.y = pt.y;
        sVar2 = ItbFromPpt(&pt);
        if (sVar2 < 0) {
          if (sVar2 != -3) goto LAB_1068_06de;
          ids = 0x17c;
        }
        else {
          ids = sVar2 + 0x16a;
        }
        rc.left = pt.x;
        sVar2 = DxOfBtn(sVar2);
        rc.right = sVar2 + rc.left;
        rc.top = pt.y;
        rc.bottom = 0x1c;
        MapWindowPoints(hwndTb,0,(undefined2 *)CONCAT22(unaff_SS,&rc),2);
        ShowTooltip(ids,&rc);
      }
    }
    else if ((msg == 0x201) || (msg == 0x203)) {
      ShowTooltip(~idsUniverseDefinitionFileSeemsMissingCorrupt,(RECT *)0x0);
      pt.x = (HWND)lParam;
      uVar9 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),pct);
      ptBtn.y = (short)uVar9;
      ptBtn.x = pt.x;
      pt.y = ptBtn.y;
      sVar2 = ItbFromPpt(&ptBtn);
      if (-1 < sVar2) {
        fDown = FIsButtonDown(sVar2);
        if ((fDown == 0) || (5 < sVar2)) {
          if ((sVar2 == 0xd) || (((sVar2 == 0xf || (sVar2 == 0x10)) || (sVar2 == 8)))) {
            ExecuteButton(sVar2,(uint)(fDown == 0));
          }
          else {
            sVar4 = DxOfBtn(sVar2);
            rc.left = ptBtn.x;
            rc.top = ptBtn.y;
            rc.right = ptBtn.x + sVar4;
            rc.bottom = ptBtn.y + 0x1c;
            HVar6 = GetDC(hwnd);
            SelectPalette(HVar6,vhpal,0);
            RealizePalette(HVar6);
            SetCapture(hwnd);
            fCur = -1;
            while( true ) {
              sVar4 = FGetMouseMove(&pt);
              if (sVar4 == 0) break;
              fInside = PtInRect((undefined2 *)CONCAT22(&rc,pt.y),pt.x);
              if (fCur != fInside) {
                pt_00.y = ptBtn.y;
                pt_00.x = ptBtn.x;
                DrawBitmapButton(HVar6,pt_00,sVar2,fDown + fInside);
                fCur = fInside;
              }
            }
            ReleaseCapture();
            if (fInside != 0) {
              ExecuteButton(sVar2,(uint)(fDown == 0));
              fDown = FIsButtonDown(sVar2);
            }
            if (sVar2 < 6) {
              GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
              DrawToolbar(HVar6,&rc);
            }
            else {
              pt_01.y = ptBtn.y;
              pt_01.x = ptBtn.x;
              DrawBitmapButton(HVar6,pt_01,sVar2,fDown);
            }
            ReleaseDC(hwnd,HVar6);
          }
        }
        else {
          MessageBeep(0);
        }
      }
    }
    else {
      if (msg != 0x5f4) {
        uVar9 = DefWindowProc(hwnd,msg,wParam,lParam);
        pfVar7 = lpfnRealComboProc;
        pfVar8 = lpfnRealCEProc;
        goto LAB_1068_06e7;
      }
      TerminateToolbarFocus(0);
    }
  }
LAB_1068_06de:
  uVar9 = 0;
  pfVar7 = lpfnRealComboProc;
  pfVar8 = lpfnRealCEProc;
LAB_1068_06e7:
  lpfnRealCEProc._2_2_ = (undefined2)((ulong)pfVar8 >> 0x10);
  lpfnRealCEProc._0_2_ = (fn_lpfnRealCEProc *)pfVar8;
  lpfnRealComboProc._2_2_ = (undefined2)((ulong)pfVar7 >> 0x10);
  lpfnRealComboProc._0_2_ = (fn_lpfnRealComboProc *)pfVar7;
  return uVar9;
}



// ======================================================================
// Function: DrawToolbar
// Address: 1068:06f0
// Segment: MEMORY_TB
// ======================================================================


void DrawToolbar(HDC hdc,RECT *prc)

{
  int itb;
  short sVar1;
  POINT pt_00;
  short ibtn;
  short i;
  POINT pt;
  
  SelectPalette(hdc,vhpal,0);
  RealizePalette(hdc);
  pt.x = 4;
  for (i = 0; i < 0x1d; i = i + 1) {
    itb = (int)*(char *)i;
    if (-1 < itb) {
      sVar1 = FIsButtonDown(itb);
      pt_00.y = 4;
      pt_00.x = pt.x;
      DrawBitmapButton(hdc,pt_00,(int)*(char *)i,sVar1);
    }
    sVar1 = DxOfBtn(itb);
    pt.x = pt.x + sVar1;
  }
  return;
}



// ======================================================================
// Function: DrawBitmapButton
// Address: 1068:078c
// Segment: MEMORY_TB
// ======================================================================


void DrawBitmapButton(HDC hdc,POINT pt,short ibtn,short fDown)

{
  short sVar1;
  short dx_00;
  short dxDraw;
  HBRUSH hbrTopLeft;
  HBRUSH hbrBotRight;
  short dx;
  
  sVar1 = DxOfBtn(ibtn);
  if (sVar1 < 0x18) {
    dx_00 = 7;
  }
  else {
    dx_00 = 0x18;
  }
  if (fDown == 0) {
    hbrTopLeft = hbrButtonHilite;
    hbrBotRight = hbrButtonShadow;
  }
  else {
    hbrTopLeft = hbrButtonShadow;
    hbrBotRight = hbrButtonHilite;
  }
  SelectObject(hdc,hbrTopLeft);
  PatBlt(hdc,pt.x + 2,pt.y,sVar1 + -4,1,0xf00021);
  PatBlt(hdc,pt.x,pt.y + 2,1,0x18,0xf00021);
  PatBlt(hdc,pt.x + 1,pt.y + 1,1,1,0xf00021);
  PatBlt(hdc,pt.x + 1,pt.y + 0x1a,1,1,0xf00021);
  SelectObject(hdc,hbrBotRight);
  PatBlt(hdc,pt.x + 2,pt.y + 0x1b,sVar1 + -4,1,0xf00021);
  PatBlt(hdc,pt.x + sVar1 + -1,pt.y + 2,1,0x18,0xf00021);
  PatBlt(hdc,pt.x + sVar1 + -2,pt.y + 1,1,1,0xf00021);
  PatBlt(hdc,pt.x + sVar1 + -2,pt.y + 0x1a,1,1,0xf00021);
  SelectObject(hdc,hbrButtonFace);
  PatBlt(hdc,pt.x + 2,pt.y + 1,sVar1 + -4,1,0xf00021);
  PatBlt(hdc,pt.x + 1,pt.y + 2,1,0x18,0xf00021);
  if (fDown == 0) {
    PatBlt(hdc,pt.x + 2,pt.y + 0x19,sVar1 + -4,2,0xf00021);
    PatBlt(hdc,pt.x + sVar1 + -3,pt.y + 2,2,0x18,0xf00021);
  }
  else {
    PatBlt(hdc,pt.x + 2,pt.y + 2,sVar1 + -4,fDown,0xf00021);
    PatBlt(hdc,pt.x + 2,pt.y + 2,fDown,0x18,0xf00021);
    if (fDown == 1) {
      PatBlt(hdc,pt.x + 2,pt.y + 0x1a,sVar1 + -4,1,0xf00021);
      PatBlt(hdc,pt.x + sVar1 + -2,pt.y + 2,1,0x18,0xf00021);
    }
  }
  DibBlt(hdc,pt.x + 2 + fDown,pt.y + 2 + fDown,dx_00,0x17,hdibToolbar,ibtn * 0x18
                  ,0,dx_00,0x17,0xcc0020);
  if (1 < fDown) {
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,pt.x + sVar1 + -2,pt.y + 0x1a,1,1,0xf00021);
  }
  return;
}



// ======================================================================
// Function: ItbFromPpt
// Address: 1068:0b12
// Segment: MEMORY_TB
// ======================================================================


short ItbFromPpt(POINT *ppt)

{
  short sVar1;
  short x;
  short dx;
  short i;
  
  x = 4;
  if (((3 < ppt->x) && (3 < ppt->y)) && (ppt->y < 0x20)) {
    for (i = 0; i < 0x1d; i = i + 1) {
      sVar1 = DxOfBtn((int)*(char *)i);
      if (ppt->x < x + sVar1) {
        ppt->x = x;
        ppt->y = 4;
        return (int)*(char *)i;
      }
      x = x + sVar1;
    }
  }
  return -1;
}



// ======================================================================
// Function: DxOfBtn
// Address: 1068:0bb2
// Segment: MEMORY_TB
// ======================================================================


short DxOfBtn(short itb)

{
  short sVar1;
  
  if (itb < 0) {
    if (itb == -1) {
      sVar1 = 6;
    }
    else if (itb == -2) {
      sVar1 = 2;
    }
    else if (itb == -3) {
      if (dyArial8 < 0x10) {
        sVar1 = 0x3c;
      }
      else {
        sVar1 = 0x46;
      }
    }
    else {
      sVar1 = 0;
    }
  }
  else if ((itb == 0xd) || (itb == 0xf)) {
    sVar1 = 0xb;
  }
  else {
    sVar1 = 0x1d;
  }
  return sVar1;
}



// ======================================================================
// Function: FIsButtonDown
// Address: 1068:0c3a
// Segment: MEMORY_TB
// ======================================================================


short FIsButtonDown(short itb)

{
  uint uVar1;
  
  switch(itb) {
  case 0:
  case 1:
  case 2:
  case 3:
  case 4:
  case 5:
    uVar1 = (uint)((grbitScan & 0xf) == itb);
    break;
  case 6:
    uVar1 = (uint)((grbitScan & 0x10) != 0);
    break;
  case 7:
    uVar1 = (uint)((grbitScan & 0x20) != 0);
    break;
  case 8:
    if (((grbitScan & 0x40) == 0) || (grbitScanMines != 0xf)) {
      uVar1 = 0;
    }
    else {
      uVar1 = 1;
    }
    break;
  case 9:
    uVar1 = (uint)((grbitScan & 0x80) != 0);
    break;
  case 10:
    uVar1 = (uint)((grbitScan & 0x100) != 0);
    break;
  case 0xb:
    uVar1 = (uint)((grbitScan & 0x400) != 0);
    break;
  case 0xc:
    uVar1 = (uint)((grbitScan & 0x200) != 0);
    break;
  case 0xd:
  case 0xf:
  case 0x10:
    uVar1 = 0;
    break;
  case 0xe:
    uVar1 = (uint)((grbitScan & 0x800) != 0);
    break;
  case 0x11:
    uVar1 = (uint)((grbitScan & 0x1000) != 0);
    break;
  default:
    uVar1 = 0;
  }
  return uVar1;
}



// ======================================================================
// Function: ExecuteButton
// Address: 1068:0db6
// Segment: MEMORY_TB
// ======================================================================


void ExecuteButton(short itb,short fDown)

{
  ushort uVar1;
  int iVar2;
  short sVar3;
  uint uVar4;
  undefined2 unaff_SS;
  short iSel_2;
  uint auStack_8a [24];
  short iSel_3;
  uint auStack_58 [9];
  short iSel_4;
  long rgid_4 [9];
  short i_4;
  short c_4;
  char *rgszScan_4 [1];
  short sStack_c;
  POINT pt_4;
  ushort grbitNew;
  
  gd._4_2_ = gd._4_2_ & 0xffbf | 0x40;
  switch(itb) {
  case 0:
  case 1:
  case 2:
  case 3:
  case 4:
  case 5:
    if (fDown == 0) {
      gd.field3_0x4 = (char)gd._4_2_;
      gd.field4_0x5 = (char)((uint)gd._4_2_ >> 8);
      return;
    }
    grbitScan = itb + (grbitScan & 0x3ff0);
    goto LAB_1068_1644;
  case 6:
    grbitNew = 0x10;
    break;
  case 7:
    grbitNew = 0x20;
    break;
  case 8:
    rgid_4[7]._0_2_ = 1;
    rgid_4[8]._0_2_ = 0;
    if ((grbitScan & 0x40) == 0) {
      grbitScanMines = 0;
    }
    for (rgid_4[7]._2_2_ = idsMineFields; iVar2 = (int)rgid_4[8], (int)rgid_4[7]._2_2_ < 0x500;
        rgid_4[7]._2_2_ = rgid_4[7]._2_2_ + idsPlayerLogFileAppearsCorruptUnableLoad) {
      if (rgid_4[7]._2_2_ == idsMineFields) {
        auStack_58[(int)rgid_4[8] * 2] = (uint)(grbitScanMines == 0xf);
        auStack_58[iVar2 * 2 + 1] = 0;
      }
      else {
        auStack_58[(int)rgid_4[8] * 2] = (uint)(grbitScanMines == 0);
        auStack_58[iVar2 * 2 + 1] = 0;
      }
      CchGetString
                (rgid_4[7]._2_2_,
                 (char *)szWork + 0xa0 + (rgid_4[7]._2_2_ - idsMineFields) * 0x1e);
      *(undefined2 *)((int)rgid_4 + (int)rgid_4[8] * 2 + 0x22) =
           (char *)szWork + 0xa0 + (rgid_4[7]._2_2_ - idsMineFields) * 0x1e;
      rgid_4[8]._0_2_ = (int)rgid_4[8] + 1;
    }
    auStack_58[(int)rgid_4[8] * 2] = 0;
    auStack_58[iVar2 * 2 + 1] = 0;
    szWork[0xfa] = -1;
    szWork[0xfb] = '\0';
    *(undefined2 *)((int)rgid_4 + (int)rgid_4[8] * 2 + 0x22) = (char *)szWork + 0xfa;
    for (rgid_4[7]._2_2_ = 0; rgid_4[8]._0_2_ = (int)rgid_4[8] + 1, iVar2 = (int)rgid_4[8],
        (int)rgid_4[7]._2_2_ < 4; rgid_4[7]._2_2_ = rgid_4[7]._2_2_ + 1) {
      auStack_58[(int)rgid_4[8] * 2] =
           (uint)((1 << ((byte)rgid_4[7]._2_2_ & 0x1f) & grbitScanMines) != 0);
      auStack_58[iVar2 * 2 + 1] = 0;
      CchGetString
                (rgid_4[7]._2_2_ + idsMineFields3,(char *)szWork + rgid_4[7]._2_2_ * 0x1e)
      ;
      *(undefined2 *)((int)rgid_4 + (int)rgid_4[8] * 2 + 0x22) =
           (char *)szWork + rgid_4[7]._2_2_ * 0x1e;
    }
    GetCursorPos((undefined2 *)CONCAT22(unaff_SS,&pt_4));
    ScreenToClient(hwndTb,(undefined2 *)CONCAT22(unaff_SS,&pt_4));
    iSel_3 = PopupMenu(hwndTb,pt_4.x,pt_4.y,(int)rgid_4[8],(long *)auStack_58,
                              (char **)((int)rgid_4 + 0x22),-2,0);
    if (iSel_3 == -1) {
      return;
    }
    if (iSel_3 < 3) {
      if (iSel_3 == 0) {
        grbitScanMines = 0xf;
      }
      else {
        grbitScanMines = 0;
      }
    }
    else {
      iSel_3 = iSel_3 + -3;
      grbitScanMines = grbitScanMines ^ 1 << ((byte)iSel_3 & 0x1f);
    }
    if (grbitScanMines == 0) {
      grbitScan = grbitScan & 0xffbf;
    }
    else {
      grbitScan = grbitScan | 0x40;
    }
    InvalidateRect(hwndTb,(undefined2 *)0x0,1);
    goto LAB_1068_1644;
  case 9:
    grbitNew = 0x80;
    break;
  case 10:
    grbitNew = 0x100;
    break;
  case 0xb:
    grbitNew = 0x400;
    break;
  case 0xc:
    grbitNew = 0x200;
    break;
  case 0xd:
    rgid_4[2]._2_2_ = 0;
    for (rgid_4[3]._0_2_ = idsDesigns; iVar2 = rgid_4[2]._2_2_, (int)(StringId)rgid_4[3] < 0x4fe;
        rgid_4[3]._0_2_ = (StringId)rgid_4[3] + idsPlayerLogFileAppearsCorruptUnableLoad) {
      auStack_8a[rgid_4[2]._2_2_ * 2] = 0;
      auStack_8a[iVar2 * 2 + 1] = 0;
      CchGetString
                ((StringId)rgid_4[3],
                 (char *)szWork + ((StringId)rgid_4[3] - idsDesigns) * 0x14);
      *(undefined2 *)((int)rgid_4 + rgid_4[2]._2_2_ * 2 + 0x10) =
           (char *)szWork + ((StringId)rgid_4[3] - idsDesigns) * 0x14;
      rgid_4[2]._2_2_ = rgid_4[2]._2_2_ + 1;
    }
    auStack_8a[rgid_4[2]._2_2_ * 2] = 0;
    auStack_8a[iVar2 * 2 + 1] = 0;
    szWork[200] = -1;
    szWork[0xc9] = '\0';
    *(undefined2 *)((int)rgid_4 + rgid_4[2]._2_2_ * 2 + 0x10) = (char *)szWork + 200;
    pt_4.y = 1;
    rgid_4[2]._2_2_ = rgid_4[2]._2_2_ + 1;
    for (rgid_4[3]._2_2_ = 0; iVar2 = rgid_4[2]._2_2_, rgid_4[3]._2_2_ < 0x10;
        rgid_4[3]._2_2_ = rgid_4[3]._2_2_ + 1) {
      if ((*(uint *)((int)&rgshdef[0].wFlags + rgid_4[3]._2_2_ * 0x93) >> 9 & 1) == 0) {
        auStack_8a[rgid_4[2]._2_2_ * 2] = (uint)((pt_4.y & grbitScanShip) != 0);
        auStack_8a[iVar2 * 2 + 1] = 0;
        *(int *)((int)rgid_4 + rgid_4[2]._2_2_ * 2 + 0x10) = rgid_4[3]._2_2_ * 0x93 + 0x3f08;
        rgid_4[2]._2_2_ = rgid_4[2]._2_2_ + 1;
      }
      pt_4.y = pt_4.y << 1;
    }
    GetCursorPos((short *)CONCAT22(unaff_SS,&sStack_c));
    ScreenToClient(hwndTb,(short *)CONCAT22(unaff_SS,&sStack_c));
    sVar3 = PopupMenu(hwndTb,sStack_c,pt_4.x,rgid_4[2]._2_2_,(long *)auStack_8a,
                             (char **)(rgid_4 + 4),-2,0);
    if (sVar3 == -1) {
      return;
    }
    if (sVar3 < 4) {
      if (sVar3 == 0) {
        grbitScanShip = 0xffff;
      }
      else if (sVar3 == 1) {
        grbitScanShip = grbitScanShip ^ 0xffff;
      }
      else {
        grbitScanShip = 0;
      }
      uVar1 = grbitScanShip;
      if ((grbitScan & 0x200) == 0) goto joined_r0x10681246;
    }
    else {
      iSel_2 = sVar3 + -4;
      rgid_4[3]._2_2_ = 0;
      while ((rgid_4[3]._2_2_ < 0x10 &&
             (((*(uint *)((int)&rgshdef[0].wFlags + rgid_4[3]._2_2_ * 0x93) >> 9 & 1) != 0
              || (iSel_2 = iSel_2 + -1, -1 < iSel_2))))) {
        rgid_4[3]._2_2_ = rgid_4[3]._2_2_ + 1;
      }
      grbitScanShip = grbitScanShip ^ 1 << ((byte)rgid_4[3]._2_2_ & 0x1f);
      if ((grbitScan & 0x200) == 0) {
        uVar1 = 1 << ((byte)rgid_4[3]._2_2_ & 0x1f) & grbitScanShip;
joined_r0x10681246:
        if (uVar1 != 0) {
          grbitScan = grbitScan | 0x200;
          InvalidateRect(hwndTb,(undefined2 *)0x0,1);
        }
      }
    }
    uVar4 = grbitScan & 0x200;
    goto joined_r0x1068150e;
  case 0xe:
    grbitNew = 0x800;
    break;
  case 0xf:
    rgid_4[7]._0_2_ = 1;
    rgid_4[8]._0_2_ = 0;
    for (rgid_4[7]._2_2_ = idsDesigns; iVar2 = (int)rgid_4[8], (int)rgid_4[7]._2_2_ < 0x4fe;
        rgid_4[7]._2_2_ = rgid_4[7]._2_2_ + idsPlayerLogFileAppearsCorruptUnableLoad) {
      auStack_58[(int)rgid_4[8] * 2] = 0;
      auStack_58[iVar2 * 2 + 1] = 0;
      CchGetString
                (rgid_4[7]._2_2_,
                 (char *)szWork + 200 + (rgid_4[7]._2_2_ - idsDesigns) * 0x19);
      *(undefined2 *)((int)rgid_4 + (int)rgid_4[8] * 2 + 0x22) =
           (char *)szWork + 200 + (rgid_4[7]._2_2_ - idsDesigns) * 0x19;
      rgid_4[8]._0_2_ = (int)rgid_4[8] + 1;
    }
    auStack_58[(int)rgid_4[8] * 2] = 0;
    auStack_58[iVar2 * 2 + 1] = 0;
    szWork[300] = -1;
    szWork[0x12d] = '\0';
    *(undefined2 *)((int)rgid_4 + (int)rgid_4[8] * 2 + 0x22) = (char *)szWork + 300;
    for (rgid_4[7]._2_2_ = 0; rgid_4[8]._0_2_ = (int)rgid_4[8] + 1, iVar2 = (int)rgid_4[8],
        (int)rgid_4[7]._2_2_ < 8; rgid_4[7]._2_2_ = rgid_4[7]._2_2_ + 1) {
      auStack_58[(int)rgid_4[8] * 2] =
           (uint)((1 << ((byte)rgid_4[7]._2_2_ & 0x1f) & grbitScanEShip) != 0);
      auStack_58[iVar2 * 2 + 1] = 0;
      CchGetString
                (rgid_4[7]._2_2_ + idsColony,(char *)szWork + rgid_4[7]._2_2_ * 0x19);
      *(undefined2 *)((int)rgid_4 + (int)rgid_4[8] * 2 + 0x22) =
           (char *)szWork + rgid_4[7]._2_2_ * 0x19;
    }
    GetCursorPos((undefined2 *)CONCAT22(unaff_SS,&pt_4));
    ScreenToClient(hwndTb,(undefined2 *)CONCAT22(unaff_SS,&pt_4));
    iSel_3 = PopupMenu(hwndTb,pt_4.x,pt_4.y,(int)rgid_4[8],(long *)auStack_58,
                              (char **)((int)rgid_4 + 0x22),-2,0);
    if (iSel_3 == -1) {
      return;
    }
    if (iSel_3 < 4) {
      if (iSel_3 == 0) {
        grbitScanEShip = 0xff;
      }
      else if (iSel_3 == 1) {
        grbitScanEShip = grbitScanEShip ^ 0xff;
      }
      else {
        grbitScanEShip = 0;
      }
      uVar1 = grbitScanEShip;
      if ((grbitScan & 0x800) == 0) goto joined_r0x106814ad;
    }
    else {
      iSel_3 = iSel_3 + -4;
      grbitScanEShip = grbitScanEShip ^ 1 << ((byte)iSel_3 & 0x1f);
      if ((grbitScan & 0x800) == 0) {
        uVar1 = 1 << ((byte)iSel_3 & 0x1f) & grbitScanEShip;
joined_r0x106814ad:
        if (uVar1 != 0) {
          grbitScan = grbitScan | 0x800;
          InvalidateRect(hwndTb,(undefined2 *)0x0,1);
        }
      }
    }
    uVar4 = grbitScan & 0x800;
joined_r0x1068150e:
    if (uVar4 == 0) {
      gd.field0_0x0 = gd.field0_0x0;
      gd.field1_0x1 = gd.field1_0x1;
      gd.field3_0x4 = gd.field3_0x4;
      gd.field4_0x5 = gd.field4_0x5;
      return;
    }
    goto LAB_1068_1644;
  case 0x10:
    c_4 = 0;
    for (i_4 = 0; i_4 < 9; i_4 = i_4 + 1) {
      *(uint *)(rgid_4 + c_4) = (uint)(iScanZoom + 4 == i_4);
      *(undefined2 *)((int)rgid_4 + c_4 * 4 + 2) = 0;
      _WSPRINTF((LPSTR)CONCAT22(*(undefined2 *)(i_4 * 2 + 0xda4),(char *)&DAT_1120_1120),
                (LPCSTR)CONCAT22(PCTDPCTPCT,(char *)&DAT_1120_1120),
                (char *)szWork + i_4 * 8);
      rgszScan_4[c_4] = (char *)szWork + i_4 * 8;
      c_4 = c_4 + 1;
    }
    GetCursorPos((undefined2 *)CONCAT22(unaff_SS,&pt_4));
    ScreenToClient(hwndTb,(undefined2 *)CONCAT22(unaff_SS,&pt_4));
    iSel_4 = PopupMenu(hwndTb,pt_4.x,pt_4.y,c_4,rgid_4,rgszScan_4,-2,0);
    if (iSel_4 == -1) {
      return;
    }
    CommandHandler(hwndFrame,iSel_4 + 0xf3d);
    return;
  case 0x11:
    grbitNew = 0x1000;
    break;
  default:
    goto switchD_1068_161b_default;
  }
  if (fDown == 0) {
    grbitScan = grbitScan & ~grbitNew;
  }
  else {
    grbitScan = grbitScan | grbitNew;
  }
LAB_1068_1644:
  if (itb != 6) {
    InvalidateRect(hwndScanner,(undefined2 *)0x0,1);
  }
  if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
    AdvanceTutor();
  }
switchD_1068_161b_default:
  return;
}



// ======================================================================
// Function: TerminateToolbarFocus
// Address: 1068:1680
// Segment: MEMORY_TB
// ======================================================================


void TerminateToolbarFocus(short fCancel)

{
  char *psz;
  short pct;
  
  gd._4_2_ = gd._4_2_ & 0xffbf | 0x40;
  if (fCancel == 0) {
    GetWindowText(hwndTBRadar,szWork,0x14);
    pct = 0;
    for (psz = (char *)szWork; ('/' < *psz && (*psz < ':')); psz = psz + 1) {
      pct = pct * 10 + *psz + -0x30;
    }
    if ((*psz != '\0') && (*psz != '%')) {
      pct = 0;
    }
  }
  else {
    pct = vpctRadarView;
  }
  if (pct < 2) {
    pct = 2;
  }
  else if (100 < pct) {
    pct = 100;
  }
  SendMessage(hwndTBRadar,0x40e,(100 - pct) / 10,0);
  _WSPRINTF((LPSTR)CONCAT22(pct,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(PCTDPCTPCT,(char *)&DAT_1120_1120),(char *)szWork);
  SetWindowText(hwndTBRadar,szWork);
  if (pct != vpctRadarView) {
    vpctRadarView = pct;
    if ((grbitScan & 0x20) == 0) {
      InvalidateRect(hwndTb,(undefined2 *)0x0,1);
    }
    grbitScan = grbitScan | 0x20;
    InvalidateRect(hwndScanner,(undefined2 *)0x0,1);
  }
  SetFocus(hwndFrame);
  return;
}



// ======================================================================
// Function: ShowTooltip
// Address: 1068:17ea
// Segment: MEMORY_TB
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x106819a8) */

void ShowTooltip(StringId ids,RECT *prc)

{
  bool bVar1;
  BOOL BVar2;
  short sVar3;
  HDC HVar4;
  HGDIOBJ HVar5;
  int iVar6;
  ushort wParam;
  int iVar7;
  DWORD DVar8;
  short fShowNow;
  short cch;
  short fVisCur;
  HFONT hfontSav;
  HDC hdc;
  
  if ((hwndTooltip == 0) || (BVar2 = IsWindowVisible(hwndTooltip), BVar2 == 0)) {
    bVar1 = false;
  }
  else {
    bVar1 = true;
  }
  if (((int)ids < 0) || (prc == (RECT *)0x0)) {
    if (hwndTooltip != 0) {
      DestroyWindow(hwndTooltip);
    }
    DVar8 = CONCAT22(vtickTooltipLast._2_2_,(uint)vtickTooltipLast);
    if (bVar1) {
      DVar8 = GetTickCount();
    }
  }
  else {
    if (ids == vidsTooltip) {
      BVar2 = EqualRect((undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,prc),
                        &vrcTooltip.left);
      DVar8 = CONCAT22(vtickTooltipLast._2_2_,(uint)vtickTooltipLast);
      if (BVar2 != 0) goto LAB_1068_19dd;
    }
    vidsTooltip = ids;
    sVar3 = CchGetString(ids,(char *)szWork);
    vrcTooltip.left = prc->left;
    vrcTooltip.top = prc->top;
    vrcTooltip.right = prc->right;
    vrcTooltip.bottom = prc->bottom;
    HVar4 = GetDC(0);
    HVar5 = SelectObject(HVar4,rghfontArial8[0]);
    DVar8 = GetTextExtent(HVar4,szWork,sVar3);
    dxTip = (short)DVar8;
    SelectObject(HVar4,HVar5);
    ReleaseDC(0,HVar4);
    if (hwndTooltip == 0) {
      CreateWindow(szTooltip,(LPCSTR)0x0,0x80000000,100,100,dxTip + 6,
                   dyArial8 + 6,hwndTb,0,hInst,(void *)0x0);
    }
    else {
      InvalidateRect(hwndTooltip,(undefined2 *)0x0,1);
    }
    SetWindowPos(hwndTooltip,0xffff,0,0,dxTip + 6,dyArial8 + 6,0x216);
    iVar6 = (uint)vtickTooltipLast + 400;
    iVar7 = vtickTooltipLast._2_2_ + (uint)(0xfe6f < (uint)vtickTooltipLast);
    DVar8 = GetTickCount();
    if ((DVar8 <= CONCAT22(iVar7,iVar6)) || (bVar1)) {
      wParam = 1;
    }
    else {
      wParam = 0;
    }
    TooltipWndProc(hwndTooltip,0x5f3,wParam,0);
    DVar8 = CONCAT22(vtickTooltipLast._2_2_,(uint)vtickTooltipLast);
  }
LAB_1068_19dd:
  vtickTooltipLast._2_2_ = (int)(DVar8 >> 0x10);
  vtickTooltipLast._0_2_ = (uint)DVar8;
  return;
}



// ======================================================================
// Function: TooltipWndProc
// Address: 1068:19e4
// Segment: MEMORY_TB
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10681bfc) */

long TooltipWndProc(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  ulong uVar1;
  ulong uVar2;
  BOOL BVar3;
  HDC HVar4;
  UINT UVar5;
  short sVar6;
  undefined2 unaff_SS;
  LRESULT LVar7;
  short cch;
  short bkSav;
  RECT rc;
  PAINTSTRUCT ps;
  POINT pt;
  HDC hdc;
  
  if (msg == 1) {
    hwndTooltip = hwnd;
  }
  else if (msg == 2) {
    hwndTooltip = 0;
    if (vidTimerTooltip != -1) {
      KillTimer(hwnd,vidTimerTooltip);
      vidTimerTooltip = -1;
    }
    vidsTooltip = -1;
  }
  else {
    if (msg == 0xf) {
      HVar4 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
      GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
      FrameRect(HVar4,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrWindowFrame);
      SelectObject(HVar4,rghfontArial8[0]);
      UVar5 = CchGetString(vidsTooltip,(char *)szWork);
      sVar6 = SetBkMode(HVar4,1);
      SetTextColor(HVar4,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
      ExtTextOut(HVar4,3,3,0,(undefined2 *)0x0,szWork,UVar5,(short *)0x0);
      SetBkMode(HVar4,sVar6);
      EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
      LVar7 = 0;
      uVar2 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
      uVar1 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
      goto LAB_1068_1d6a;
    }
    if (msg == 0x14) {
      GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
      FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrTooltip);
      LVar7 = 1;
      uVar2 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
      uVar1 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
      goto LAB_1068_1d6a;
    }
    if (msg != 0x113) {
      if (((msg == 0x200) || (msg == 0x201)) || (msg == 0x203)) {
        DestroyWindow(hwnd);
        uVar1 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
        uVar2 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
        LVar7 = 0;
        goto LAB_1068_1d6a;
      }
      if (msg != 0x5f3) goto LAB_1068_1d53;
      if (wParam == 0) {
        if (vidTimerTooltip != -1) {
          KillTimer(hwnd,vidTimerTooltip);
        }
        UVar5 = SetTimer(0x39e,700,0,0);
        uVar1 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
        uVar2 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
        if (UVar5 == 0) {
          vidTimerTooltip = -1;
        }
        else {
          vidTimerTooltip = 0x39e;
        }
        LVar7 = 0;
        goto LAB_1068_1d6a;
      }
      wParam = 0x39e;
    }
    if (wParam == 0x39e) {
      if ((msg == 0x113) && (BVar3 = IsWindowVisible(hwnd), BVar3 != 0)) {
        vtickTooltipLast = GetTickCount();
        GetCursorPos((undefined2 *)CONCAT22(unaff_SS,&pt));
        BVar3 = PtInRect((undefined2 *)CONCAT22((RECT *)&vrcTooltip,pt.y),pt.x);
        uVar1 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
        vtickTooltip1stVis =
             CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
        if ((BVar3 == 0) ||
           (vtickTooltip1stVis =
                 CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis),
           CONCAT22(vtickTooltip1stVis._2_2_ +
                    (uint)(0xd8ef < (uint)vtickTooltip1stVis),
                    (uint)vtickTooltip1stVis + 10000) < vtickTooltipLast))
        goto TB_LKillTip;
      }
      else {
        vtickTooltip1stVis = GetTickCount();
        GetCursorPos((undefined2 *)CONCAT22(unaff_SS,&pt));
        BVar3 = PtInRect((undefined2 *)CONCAT22((RECT *)&vrcTooltip,pt.y),pt.x);
        if (BVar3 != 0) {
          ScreenToClient(hwndFrame,(undefined2 *)CONCAT22(unaff_SS,&pt));
          if (vfs.dx < pt.x + dxTip) {
            pt.x = (vfs.dx - dxTip) + -5;
          }
          ClientToScreen(hwndFrame,(undefined2 *)CONCAT22(unaff_SS,&pt));
          SetWindowPos(hwnd,0xffff,pt.x,(dyArial8 * 3) / 2 + pt.y,0,0,0x251);
          UpdateWindow(hwnd);
          if (vidTimerTooltip != -1) {
            KillTimer(hwnd,vidTimerTooltip);
          }
          UVar5 = SetTimer(0x39e,0x32,0,0);
          if (UVar5 == 0) {
            vidTimerTooltip = -1;
          }
          else {
            vidTimerTooltip = 0x39e;
          }
          LVar7 = 0;
          uVar2 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
          uVar1 = vtickTooltip1stVis;
          goto LAB_1068_1d6a;
        }
TB_LKillTip:
        DestroyWindow(hwnd);
        uVar1 = vtickTooltip1stVis;
      }
      LVar7 = 0;
      uVar2 = vtickTooltipLast;
      goto LAB_1068_1d6a;
    }
  }
LAB_1068_1d53:
  LVar7 = DefWindowProc(hwnd,msg,wParam,lParam);
  uVar2 = CONCAT22(vtickTooltipLast._2_2_,(undefined2)vtickTooltipLast);
  uVar1 = CONCAT22(vtickTooltip1stVis._2_2_,(uint)vtickTooltip1stVis);
LAB_1068_1d6a:
  vtickTooltip1stVis._2_2_ = (int)(uVar1 >> 0x10);
  vtickTooltip1stVis._0_2_ = (uint)uVar1;
  vtickTooltipLast._2_2_ = (undefined2)(uVar2 >> 0x10);
  vtickTooltipLast._0_2_ = (undefined2)uVar2;
  return LVar7;
}



// ======================================================================
// Function: FakeComboProc
// Address: 1068:1d72
// Segment: MEMORY_TB
// ======================================================================


long FakeComboProc(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  LRESULT LVar1;
  
  if (msg == 0x200) {
    TbWndProc(hwnd,0x200,wParam,lParam);
  }
  else if ((msg == 0x201) || (msg == 0x203)) {
    ShowTooltip(~idsUniverseDefinitionFileSeemsMissingCorrupt,(RECT *)0x0);
  }
  LVar1 = CallWindowProc((fn_lpfnRealComboProc *)
                         CONCAT22(lpfnRealComboProc._2_2_,
                                  (fn_lpfnRealComboProc *)lpfnRealComboProc),hwnd,msg,
                         wParam,lParam);
  return LVar1;
}



// ======================================================================
// Function: FakeCEProc
// Address: 1068:1df0
// Segment: MEMORY_TB
// ======================================================================


long FakeCEProc(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  LRESULT LVar1;
  
  if (msg == 0x200) {
    TbWndProc(hwnd,0x200,wParam,lParam);
  }
  else if ((msg == 0x201) || (msg == 0x203)) {
    ShowTooltip(~idsUniverseDefinitionFileSeemsMissingCorrupt,(RECT *)0x0);
  }
  LVar1 = CallWindowProc((fn_lpfnRealCEProc *)
                         CONCAT22(lpfnRealCEProc._2_2_,
                                  (fn_lpfnRealCEProc *)lpfnRealCEProc),hwnd,msg,wParam,
                         lParam);
  return LVar1;
}



