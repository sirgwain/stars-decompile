// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: MineWndProc
// Address: 1028:0000
// Segment: MEMORY_MINE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

long MineWndProc(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  POINT PVar1;
  char *pcVar2;
  BOOL BVar3;
  HCURSOR HVar4;
  short fEnabled;
  undefined2 unaff_SI;
  ushort unaff_DI;
  undefined2 unaff_SS;
  COLORREF CVar5;
  DWORD DVar6;
  ulong uVar7;
  LRESULT LVar8;
  char *pcVar9;
  undefined2 uVar10;
  ushort in_stack_0000ffbe;
  int local_40;
  int local_3e;
  int rc;
  short cch;
  short crBack;
  short local_36;
  uint rtlt;
  short pt;
  short fDetonate;
  RECT rc__46;
  PAINTSTRUCT ps;
  HDC hdc;
  
  if (message == WM_CREATE) {
    uVar10 = 0x1120;
    pcVar9 = _szButton;
    pcVar2 = PszGetCompressedString(idsDetonateMineFieldYear);
    hwndMineCB =
         CreateWindow((LPCSTR)CONCAT22(uVar10,pcVar9),(LPCSTR)pcVar2,0x40000003,100,100,0x96,
                      dyArial8,hwnd,0,hInst,(void *)0x0);
    SendMessage(hwndMineCB,0x30,rghfontArial8[1],0);
    SetMineralTitleBar(hwnd);
  }
  else if (message == WM_PAINT) {
    hdc = BeginPaint(hwnd,(PAINTSTRUCT *)&ps);
    GetClientRect(hwnd,(RECT *)&rc__46);
    SetRect((RECT *)(RECT *)&stack0xffbe,4,4,rc__46.right + -4,dyArial8 * 2 + -4);
    _Draw3dFrame();
    CVar5 = SetTextColor(hdc,CONCAT22(crButtonText._2_2_,
                                      (undefined2)crButtonText));
    fDetonate = (short)(CVar5 >> 0x10);
    pt = (short)CVar5;
    _crBack = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,
                                      (undefined2)crButtonFace));
    cch = _strlen((char *)szMineralTitle);
    rtlt = (local_3e - in_stack_0000ffbe) - 0x18;
    for (; 0 < cch; cch = cch + -1) {
      DVar6 = GetTextExtent(hdc,szMineralTitle,cch);
      if ((uint)DVar6 <= rtlt) break;
    }
    RcCtrTextOut(hdc,(RECT *)&stack0xffbe,(char *)szMineralTitle,cch);
    SetTextColor(hdc,CONCAT22(fDetonate,pt));
    SetBkColor(hdc,_crBack);
    SetRect((RECT *)(RECT *)&stack0xffbe,(local_3e - (rc - local_40)) + 2,local_40 + 3,local_3e + -4
            ,rc + -2);
    fEnabled = FOtherStuffAtScanSel();
    DrawSelectionArrow(hdc,(RECT *)&stack0xffbe,fEnabled);
    rc__46.top = rc__46.top + dyArial8 * 2 + -4;
    DrawMineSurvey(hdc,&rc__46);
    EndPaint(hwnd,(PAINTSTRUCT *)&ps);
  }
  else {
    if (message == WM_ERASEBKGND) {
      GetClientRect(hwnd,(RECT *)&rc__46);
      FillRect(wParam,(RECT *)&rc__46,hbrButtonFace);
      return 1;
    }
    if (message == WM_CTLCOLOR) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return (ulong)hbrButtonFace;
    }
    if (message == WM_SETCURSOR) {
      GetCursorPos((POINT *)(POINT *)&stack0xffce);
      ScreenToClient(hwnd,(POINT *)(POINT *)&stack0xffce);
      GetClientRect(hwnd,(RECT *)(RECT *)&stack0xffc4);
      PVar1.y = fDetonate;
      PVar1.x = pt;
      BVar3 = PtInRect((RECT *)(RECT *)&stack0xffc4,PVar1);
      if (BVar3 != 0) {
        rtlt = HtMineWindow(hwnd,pt,fDetonate);
        if (rtlt != 0) {
          HVar4 = hcurHand;
          if (rtlt != 9) {
            HVar4 = hcurArrowHelp;
          }
          setcursor(HVar4);
          return 1;
        }
        rtlt = 0;
      }
MINE_Default_7:
      LVar8 = DefWindowProc(hwnd,message,wParam,lParam);
      return LVar8;
    }
    if (message == WM_COMMAND) {
      if (((HWND)lParam == hwndMineCB) &&
         (uVar7 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffbe), (int)uVar7 == 0)
         ) {
        LVar8 = SendMessage(hwndMineCB,0x400,0,0);
        pt = (short)LVar8;
        rtlt = ((THING *)lpThings + sel.scan.ith)->idFull;
        fDetonate = pt;
        WriteMemRt(0x2b,4,&rtlt);
        ((THING *)lpThings)[sel.scan.ith].rgb[7] = (byte)fDetonate;
      }
    }
    else {
      if (((message != WM_LBUTTONDOWN) && (message != WM_LBUTTONDBLCLK)) &&
         (message != WM_RBUTTONDOWN)) goto MINE_Default_7;
      if (hwndPopup == 0) {
        uVar7 = __aFulshr(CONCAT22(wParam,message),unaff_DI);
        MineClick((HWND)lParam,(short)uVar7,message,wParam);
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: InvalidateMineralBars
// Address: 1028:040a
// Segment: MEMORY_MINE
// ======================================================================


void InvalidateMineralBars(void)

{
  char *pcVar1;
  ushort uVar2;
  undefined2 unaff_SS;
  DWORD DVar3;
  undefined2 uVar4;
  HDC HVar5;
  RECT rc;
  short dxPop;
  short dx;
  RECT rcPop;
  HFONT hfontSav;
  short dyRow;
  HDC hdc;
  
  GetClientRect(hwndMine,(RECT *)&rc);
  hdc = GetDC(hwndMine);
  hfontSav = SelectObject(hdc,rghfontArial8[0]);
  HVar5 = hdc;
  pcVar1 = PszGetCompressedString(idsN999mr);
  DVar3 = GetTextExtent(HVar5,(LPCSTR)pcVar1,5);
  rc.right = rc.right - ((int)DVar3 + 6);
  SelectObject(hdc,rghfontArial8[1]);
  HVar5 = hdc;
  pcVar1 = PszGetCompressedString(idsPopulation1000000);
  DVar3 = GetTextExtent(HVar5,(LPCSTR)pcVar1,0x15);
  dxPop = (int)DVar3 + 6;
  uVar4 = 0x1120;
  pcVar1 = DAT_1120_0480;
  HVar5 = hdc;
  uVar2 = _strlen(DAT_1120_0480);
  DVar3 = GetTextExtent(HVar5,(LPCSTR)CONCAT22(uVar4,pcVar1),uVar2);
  dx = (int)DVar3 + 6;
  if (dx * 4 - rc.right == 0 || dx * 4 < rc.right) {
    rc.left = rc.left + dx;
  }
  else {
    DVar3 = GetTextExtent(hdc,(LPCSTR)DAT_1120_0480,4);
    rc.left = rc.left + (int)DVar3 + 6;
  }
  SelectObject(hdc,hfontSav);
  ReleaseDC(hwndMine,hdc);
  rc.top = rc.top + dyArial8 * 2 + -4;
  rcPop.top = rc.top + 2;
  rcPop.bottom = rcPop.top + dyArial8;
  rcPop.right = rc.right;
  rcPop.left = rc.right - dxPop;
  InvalidateRect(hwndMine,(RECT *)&rcPop,1);
  dyRow = ((rc.bottom - rc.top) + dyArial8 * -4 + -2) / 6 + 1U & 0xfffe;
  rc.top = rc.top + (dyArial8 * 5 >> 1) + dyRow * 3 + 1;
  rc.bottom = dyRow * 3 + rc.top;
  InvalidateRect(hwndMine,(RECT *)&rc,0);
  return;
}



// ======================================================================
// Function: GetMineFieldCounts
// Address: 1028:05ac
// Segment: MEMORY_MINE
// ======================================================================


void GetMineFieldCounts(ushort id,short *pithm,short *pcthm)

{
  short sVar1;
  THING *lpth;
  short ithFound;
  short cthTotal;
  
  ithFound = 0;
  cthTotal = 0;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < (THING *)lpThings + cThing) {
    sVar1 = ithFound;
    if ((((uint)lpth->idFull >> 0xd == 0) && (((uint)lpth->idFull >> 9 & 0xf) == idPlayer))
       && (cthTotal = cthTotal + 1, sVar1 = cthTotal, lpth->idFull != id)) {
      sVar1 = ithFound;
    }
    ithFound = sVar1;
    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
  }
  *pithm = ithFound;
  *pcthm = cthTotal;
  return;
}



// ======================================================================
// Function: DrawMineSurvey
// Address: 1028:065a
// Segment: MEMORY_MINE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: ifl */
/* WARNING: Variable defined which should be unmapped: dNum */
/* WARNING: Variable defined which should be unmapped: dx */
/* WARNING: Variable defined which should be unmapped: iCur */
/* WARNING: Variable defined which should be unmapped: hbmpSav */
/* WARNING: Variable defined which should be unmapped: dxLabels */
/* WARNING: Variable defined which should be unmapped: xBeg */
/* WARNING: Variable defined which should be unmapped: dxRLabels */
/* WARNING: Variable defined which should be unmapped: xEnd */
/* WARNING: Variable defined which should be unmapped: yCur */
/* WARNING: Variable defined which should be unmapped: c */
/* WARNING: Variable defined which should be unmapped: dxNum */
/* WARNING: Variable defined which should be unmapped: xR */
/* WARNING: Removing unreachable block (ram,0x10281e54) */
/* WARNING: Removing unreachable block (ram,0x10283270) */
/* WARNING: Removing unreachable block (ram,0x10280be1) */
/* WARNING: Removing unreachable block (ram,0x10281e94) */
/* WARNING: Removing unreachable block (ram,0x1028101a) */

void DrawMineSurvey(HDC hdc,RECT *prc)

{
  uint *puVar1;
  PLAYER *pPVar2;
  int *piVar3;
  uint uVar4;
  POINT pt;
  short *psVar5;
  short sVar6;
  char *pcVar7;
  ushort uVar8;
  int iVar9;
  HDC HVar10;
  HGDIOBJ HVar11;
  StringId SVar12;
  uint uVar13;
  int iVar14;
  int iVar15;
  int iVar16;
  int iVar17;
  int iVar18;
  FLEET *pFVar19;
  THING *pTVar20;
  int iVar21;
  PLAYER *pPVar22;
  int *piVar23;
  undefined2 uVar24;
  undefined2 unaff_SS;
  bool bVar25;
  DWORD DVar26;
  DWORD DVar27;
  COLORREF CVar28;
  COLORREF CVar29;
  ulong uVar30;
  long lVar31;
  undefined2 uVar32;
  short sVar33;
  char *in_stack_0000fe04;
  undefined2 in_stack_0000fe06;
  ushort in_stack_0000fe08;
  undefined2 uVar34;
  short ifl;
  HBITMAP hbmpSav;
  short dNum;
  short xBeg;
  short dx;
  short dxLabels;
  short iCur;
  short dxRLabels;
  short xR;
  short dxNum;
  short dxBar;
  short c;
  short yCur;
  short xEnd;
  short iMin;
  int plrSav [83];
  char *pszT;
  char szWP [24];
  undefined4 dy;
  short iplrbmp;
  undefined4 xLeft;
  short iOffset;
  uint cShip;
  uint pctDecay;
  short rgMin;
  undefined4 yTop;
  short yTop__208;
  RECT rc;
  undefined4 l__198;
  short grobj;
  char szT [80];
  RECT rcGauge;
  short cch;
  char *psz;
  short bkMode;
  HDC hdcMem;
  COLORREF crBack;
  FLEET *lpfl;
  short i;
  short c__86;
  uint rgl [6];
  short c2;
  COLORREF crFore;
  undefined4 l2;
  HBRUSH hbrSav;
  PLANET pl;
  
  hdcMem = CreateCompatibleDC(hdc);
  crBack = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
  ;
  crFore = SetTextColor(hdc,0xffff);
  bkMode = SetBkMode(hdc,2);
  grobj = sel.scan.grobj;
  if (sel.scan.grobj == grobjOther) {
    if ((sel.scan.grobjFull & grobjPlanet) == grobjNone) {
      if ((sel.scan.grobjFull & grobjFleet) == grobjNone) {
        if ((sel.scan.grobjFull & grobjThing) == grobjNone) {
          grobj = 0;
        }
        else {
          grobj = 8;
        }
      }
      else {
        grobj = 2;
      }
    }
    else {
      grobj = 1;
    }
  }
  l__198 = CONCAT22(l__198._2_2_,(int)l__198);
  l2 = CONCAT22(l2._2_2_,(undefined2)l2);
  if (grobj == 0) goto MINE_FinishUp_5;
  if (grobj == 2) {
    yTop = (THING *)((ulong)yTop & 0xffff);
    yTop__208 = 0;
    l__198 = CONCAT22(l__198._2_2_,(int)l__198);
    l2 = CONCAT22(l2._2_2_,(undefined2)l2);
    if (sel.scan.ifl != -1) {
      rgMin = prc->left + 6;
      yTop = (THING *)(ulong)(prc->top + 6);
      hbrSav = SelectObject(hdc,hbrButtonShadow);
      PatBlt(hdc,rgMin,(short)(THING *)yTop,0x46,2,0xf00021);
      PatBlt(hdc,rgMin,(int)(THING *)yTop + 2,2,0x44,0xf00021);
      PatBlt(hdc,rgMin + 0x10,(int)(THING *)yTop + 0x44,2,0x26,0xf00021);
      hbrSav = SelectObject(hdc,hbrButtonHilite);
      PatBlt(hdc,rgMin + 2,(int)(THING *)yTop + 0x44,0xf,1,0xf00021);
      PatBlt(hdc,rgMin + 1,(int)(THING *)yTop + 0x45,0xf,1,0xf00021);
      PatBlt(hdc,rgMin + 0x34,(int)(THING *)yTop + 0x44,0x12,2,0xf00021);
      PatBlt(hdc,rgMin + 0x44,(int)(THING *)yTop + 2,2,0x42,0xf00021);
      PatBlt(hdc,rgMin + 0x45,(int)(THING *)yTop + 1,1,1,0xf00021);
      PatBlt(hdc,rgMin + 0x11,(int)(THING *)yTop + 0x68,0x25,2,0xf00021);
      PatBlt(hdc,rgMin + 0x10,(int)(THING *)yTop + 0x69,1,1,0xf00021);
      PatBlt(hdc,rgMin + 0x34,(int)(THING *)yTop + 0x46,2,0x22,0xf00021);
      PatBlt(hdc,rgMin + 2,(int)(THING *)yTop + 2,0x42,0x42,0x42);
      PatBlt(hdc,rgMin + 0x12,(int)(THING *)yTop + 0x44,0x22,0x24,0x42);
      SelectObject(hdc,hbrSav);
                    /* WARNING: Load size is inaccurate */
      pFVar19 = ((FLEET **)rglpfl)[sel.scan.ifl];
      uVar34 = *(undefined2 *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
      lpfl = (FLEET *)CONCAT22(uVar34,pFVar19);
      DrawFleetBitmap
                ((FLEET *)CONCAT22(uVar34,pFVar19),hdc,rgMin + 2,(int)(THING *)yTop + 2,0,-1,0,0,-1,
                 0);
      iOffset = *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpfl->id >> 9 & 0xf) * 0xc0) >> 3
                & 0x1f;
      SelectPalette(hdc,vhpal,0);
      RealizePalette(hdc);
      DibBlt(hdc,rgMin + 0x13,(int)(THING *)yTop + 0x47,0x20,0x20,hdibRaces,
                      (iOffset & 7U) << 5,(3 - (iOffset >> 3)) * 0x20,0x20,0x20,0xcc0020);
      SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SelectObject(hdc,rghfontArial8[1]);
      cShip = 0;
      pctDecay = 0;
      for (i = 0; i < 0x10; i = i + 1) {
        uVar13 = ((FLEET *)lpfl)->rgcsh[i];
        bVar25 = CARRY2(cShip,uVar13);
        cShip = cShip + uVar13;
        pctDecay = pctDecay + ((int)uVar13 >> 0xf) + (uint)bVar25;
      }
      CchGetString(idsShipCountLd,szT);
      c__86 = wsprintf(szWork,(char *)szT,cShip,pctDecay);
      TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c__86);
      iVar15 = (int)(THING *)yTop + dyArial8 + 2;
      yTop = (THING *)CONCAT22(yTop._2_2_,iVar15);
      uVar34 = (undefined2)((ulong)lpfl >> 0x10);
      pFVar19 = (FLEET *)lpfl;
      if (((pFVar19->wFlags & 0xffU) == 7) || ((pFVar19->wFlags & 0xffU) == 4)) {
        lVar31 = WtFromLpfl(lpfl);
        yTop__208 = (short)((ulong)lVar31 >> 0x10);
        yTop._2_2_ = (short)lVar31;
        c__86 = CchGetString(idsFuel2,szT);
        l__198 = GetTextExtent(hdc,(LPCSTR)szT,c__86);
        c2 = CchGetString(idsCargo,(char *)szWork);
        l2 = GetTextExtent(hdc,szWork,c2);
        if ((long)l__198 < (long)l2) {
          l__198 = l2;
        }
        SetRect((RECT *)&rcGauge,prc->left + 0x5a + (int)l__198,(short)(THING *)yTop,prc->right + -4
                ,(int)(THING *)yTop + dyArial8);
        if (rcGauge.left < rcGauge.right) {
          TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,(LPCSTR)szT,c__86);
          yTop._0_2_ = (THING *)((int)(THING *)yTop + dyArial8 + 2);
          TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c2);
          DrawFleetGauge(hdc,&rcGauge,lpfl,4);
          OffsetRc(&rcGauge,0,dyArial8 + 4);
          DrawFleetGauge(hdc,&rcGauge,lpfl,5);
          yTop._0_2_ = (THING *)((int)(THING *)yTop + dyArial8 + 2);
        }
      }
      else {
        yTop._2_2_ = pFVar19->rgdv->dp;
        yTop__208 = (pFVar19->rgdv + 1)->dp;
        yTop._0_2_ = (THING *)iVar15;
      }
      if (((uint)gd.wFlags >> 3 & 1) == 0) {
        SVar12 = idsFleetMassLdkt;
      }
      else {
        SVar12 = idsMassLdkt;
      }
      c__86 = CchGetString(SVar12,szT);
      c__86 = wsprintf(szWork,(char *)szT,yTop._2_2_);
      TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c__86);
      yTop = (THING *)CONCAT22(yTop._2_2_,(THING *)((int)(THING *)yTop + dyArial8 + 2));
      uVar34 = (undefined2)((ulong)lpfl >> 0x10);
      pFVar19 = (FLEET *)lpfl;
      if ((pFVar19->wFlags & 0xffU) == 7) {
        psVar5 = (short *)(*(int *)&pFVar19->lpplord + 4);
        if (1 < pFVar19->cord) {
          psVar5 = (short *)(*(int *)&pFVar19->lpplord + 0x16);
        }
        xLeft = (short *)CONCAT22(*(undefined2 *)((int)&pFVar19->lpplord + 2),psVar5);
        if (((uint)gd.wFlags >> 3 & 1) == 0) {
          SVar12 = idsWaypointS;
        }
        else {
          SVar12 = idsWpS;
        }
        CchGetString(SVar12,szWP);
        if (((FLEET *)lpfl)->cord == 1) {
          PszGetCompressedString(idsNone);
          c__86 = wsprintf((char *)szT,(char *)szWP);
        }
        else {
          uVar34 = (undefined2)((ulong)xLeft >> 0x10);
          psVar5 = (short *)xLeft;
          PszGetLocName((uint)psVar5[3] >> 8 & (grobjThing|grobjOther|grobjFleet|grobjPlanet),
                              psVar5[2],*xLeft,psVar5[1]);
          c__86 = wsprintf((char *)szT,(char *)szWP);
        }
        TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,(LPCSTR)szT,c__86);
        if (((uint)gd.wFlags >> 3 & 1) == 0) {
          SVar12 = idsWaypointTaskS;
        }
        else {
          SVar12 = idsTaskS;
        }
        yTop._0_2_ = (THING *)(((THING *)yTop)->rgb + dyArial8 + -4);
        CchGetString(SVar12,szT);
        PszGetCompressedString((((short *)xLeft)[3] & 0xfU) + idsTaskHere);
        c__86 = wsprintf(szWork,(char *)szT);
        TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c__86);
        yTop = (THING *)CONCAT22(yTop._2_2_,(byte *)((int)(THING *)yTop + dyArial8 + 2));
        if (((FLEET *)lpfl)->cord < 2) {
          if (((uint)gd.wFlags >> 3 & 1) == 0) {
            SVar12 = idsWarpSpeedStopped;
          }
          else {
            SVar12 = idsWarpStopped;
          }
          c__86 = CchGetString(SVar12,(char *)szWork);
        }
        else if (((uint)((short *)xLeft)[3] >> 4 & 0xf) == 0xb) {
          c__86 = CchGetString(idsUseStargate,(char *)szWork);
        }
        else {
          if (((uint)gd.wFlags >> 3 & 1) == 0) {
            SVar12 = idsWarpSpeedD;
          }
          else {
            SVar12 = idsWarpD;
          }
          CchGetString(SVar12,szT);
          c__86 = wsprintf(szWork,(char *)szT);
        }
        TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c__86);
        yTop = (THING *)CONCAT22(yTop._2_2_,(THING *)((int)(THING *)yTop + dyArial8 + 2));
        DVar26 = CMineSweepFromLpfl(lpfl);
        l__198 = DVar26;
        if (0 < (long)DVar26) {
          pszT = PszGetCompressedString(idsFleetCanDestroyLdMinesPerYear);
          c__86 = wsprintf(szWork,(char *)pszT,(int)l__198,l__198._2_2_);
          TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c__86);
          yTop = (THING *)CONCAT22(yTop._2_2_,
                                   (THING *)(((THING *)yTop)->rgb + dyArial8 + -4));
        }
      }
      else if (((uint)pFVar19->wFlags >> 4 & 1) != 0) {
        if ((pFVar19->wFlags & 0xfU) == 0) {
          if (((uint)gd.wFlags >> 3 & 1) == 0) {
            SVar12 = idsWarpSpeedStopped;
          }
          else {
            SVar12 = idsWarpStopped;
          }
          c__86 = CchGetString(SVar12,(char *)szWork);
        }
        else {
          if (((uint)gd.wFlags >> 3 & 1) == 0) {
            SVar12 = idsWarpSpeedD;
          }
          else {
            SVar12 = idsWarpD;
          }
          CchGetString(SVar12,szT);
          c__86 = wsprintf(szWork,(char *)szT);
        }
        TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c__86);
        yTop = (THING *)CONCAT22(yTop._2_2_,
                                 (THING *)(((THING *)yTop)->rgb + dyArial8 + -4));
      }
    }
    goto MINE_FinishUp_5;
  }
  if (grobj != 8) {
    if (sel.scan.idpl != -1) {
      sVar6 = FLookupPlanet(sel.scan.idpl,&pl);
      if (sVar6 != 0) {
        iplrbmp = 0;
        pPVar22 = (PLAYER *)rgplr + idPlayer;
        piVar23 = plrSav;
        for (iVar15 = 0x60; iVar15 != 0; iVar15 = iVar15 + -1) {
          piVar3 = piVar23;
          piVar23 = piVar23 + 1;
          pPVar2 = pPVar22;
          pPVar22 = (PLAYER *)&pPVar22->cPlanet;
          *piVar3 = *(int *)pPVar2;
        }
        rc.left = prc->left;
        rc.top = prc->top;
        rc.right = prc->right;
        rc.bottom = prc->bottom;
        sVar6 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
        if (((sVar6 == raTerra) && (pl.iPlayer != -1)) &&
           ((idPlayer == pl.iPlayer ||
            (*(char *)(idPlayer * 0xc0 + 0x5a12 + pl.iPlayer) == '\x01')))) {
          for (c = 0; c < 3; c = c + 1) {
            *(undefined1 *)(idPlayer * 0xc0 + 0x59b2 + c) =
                 *(undefined1 *)(pl.iPlayer * 0xc0 + 0x59b2 + c);
            *(undefined1 *)(idPlayer * 0xc0 + 0x59b5 + c) =
                 *(undefined1 *)(pl.iPlayer * 0xc0 + 0x59b5 + c);
            *(undefined1 *)(idPlayer * 0xc0 + 0x59b8 + c) =
                 *(undefined1 *)(pl.iPlayer * 0xc0 + 0x59b8 + c);
          }
        }
        SelectObject(hdc,rghfontArial8[0]);
        HVar10 = hdc;
        pcVar7 = PszGetCompressedString(idsN999mr);
        DVar26 = GetTextExtent(HVar10,(LPCSTR)pcVar7,5);
        SelectObject(hdc,rghfontArial8[1]);
        uVar34 = 0x1120;
        pcVar7 = DAT_1120_0480;
        HVar10 = hdc;
        uVar8 = _strlen(DAT_1120_0480);
        DVar27 = GetTextExtent(HVar10,(LPCSTR)CONCAT22(uVar34,pcVar7),uVar8);
        dxLabels = (int)DVar27 + 6;
        if (dxLabels * 4 - rc.right != 0 && rc.right <= dxLabels * 4) {
          iplrbmp = 1;
          DVar27 = GetTextExtent(hdc,(LPCSTR)DAT_1120_0480,4);
          dxLabels = (int)DVar27 + 6;
        }
        sVar6 = rc.top;
        pctDecay = rc.left + dxLabels;
        iVar9 = rc.right - ((int)DVar26 + 6);
        cShip = ((rc.bottom - rc.top) + dyArial8 * -4 + -2) / 6 + 1U & 0xfffe;
        iVar15 = rc.top + 2;
        if (((uint)pl.wFlags >> 9 & 1) != 0) {
          HVar10 = CreateCompatibleDC(hdc);
          HVar11 = SelectObject(HVar10,hbmpMono);
          CVar28 = SetTextColor(hdc,0);
          CVar29 = SetBkColor(hdc,0xffffff);
          BitBlt(hdc,rc.right + -0x16,sVar6 + 4,0xd,0x10,HVar10,0,0xc,0x8800c6);
          SetTextColor(hdc,0xffff);
          SetBkColor(hdc,0);
          in_stack_0000fe08 = 0x86;
          in_stack_0000fe06 = 0x14f8;
          in_stack_0000fe04 = (char *)szLastGet + 0xe;
          BitBlt(hdc,rc.right + -0x16,sVar6 + 4,0xd,0x10,HVar10,0,0xc,0xee0086);
          SetTextColor(hdc,CVar28);
          SetBkColor(hdc,CVar29);
          SelectObject(HVar10,HVar11);
          DeleteDC(HVar10);
        }
        if (2 < (pl.wFlags & 0xffU)) {
          sVar6 = CchGetString((iplrbmp == 0) + idsVal,(char *)szWork);
          DVar26 = GetTextExtent(hdc,szWork,sVar6);
          SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText)
                      );
          TextOut(hdc,pctDecay,iVar15,szWork,sVar6);
          sVar6 = PctPlanetDesirability((PLANET *)&pl,idPlayer);
          sVar33 = wsprintf(szWork,(char *)PCTDPCTPCT,sVar6);
          if (sVar6 < 0) {
            uVar13 = 0xff;
          }
          else {
            uVar13 = 0x7f00;
          }
          SetTextColor(hdc,(ulong)uVar13);
          TextOut(hdc,pctDecay + (int)DVar26,iVar15,szWork,sVar33);
          if (iplrbmp == 0) {
            DVar27 = GetTextExtent(hdc,szWork,sVar33);
            sVar33 = PctPlanetOptValue((PLANET *)&pl,idPlayer);
            if (sVar6 < sVar33) {
              if (0 < sVar33) {
                if (sVar33 < 0xb) {
                  uVar13 = 0x7f7f;
                }
                else {
                  uVar13 = 0x7f00;
                }
                SetTextColor(hdc,(ulong)uVar13);
              }
              sVar6 = wsprintf(szWork,(char *)0x112004fa);
              TextOut(hdc,pctDecay + (int)DVar26 + (int)DVar27,iVar15,szWork,sVar6);
            }
          }
        }
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        if (pl.iPlayer != -1) {
          pcVar7 = PszGetCompressedString((iplrbmp == 0) + idsPop);
          _strcpy(szT,pcVar7);
        }
        if ((pl.wFlags & 0xffU) == 7) {
          uVar8 = _strlen(szT);
          uVar30 = __aFulmul(CONCAT22(pl.rgwtMin[3]._2_2_,(undefined2)pl.rgwtMin[3]),100);
          sVar6 = CommaFormatLong(szT + uVar8,uVar30);
          RightTextOut(hdc,iVar9,iVar15,szT,uVar8 + sVar6,0);
        }
        else if (pl.iPlayer == -1) {
          sVar6 = CchGetString(idsUninhabited,szT);
          RightTextOut(hdc,iVar9,iVar15,szT,sVar6,0);
        }
        else {
          if (2 < (pl.wFlags & 0xffU)) {
            lVar31 = __aFlshl((long)CONCAT22(in_stack_0000fe06,in_stack_0000fe04),
                                      in_stack_0000fe08);
            uVar34 = (undefined2)((ulong)lVar31 >> 0x10);
            iVar16 = (int)lVar31;
            _strcpy((char *)szWork,szT);
            uVar8 = _strlen(szT);
            if ((lVar31 < 0) || ((lVar31 < 0x10000 && (iVar16 == 0)))) {
              iVar16 = CchGetString(idsMsg1264,(char *)szWork + uVar8);
            }
            else {
              uVar32 = 0xb1;
              pcVar7 = PszGetCompressedString(idsCLd00);
              iVar16 = wsprintf((char *)((char *)szWork + uVar8),(char *)pcVar7,uVar32,
                                iVar16,uVar34);
            }
            c = uVar8 + iVar16;
            RightTextOut(hdc,iVar9,iVar15,(char *)szWork,c,0);
          }
          SetTextColor(hdc,0xff);
          sVar33 = 0;
          sVar6 = 0;
          pcVar7 = PszPlayerName(pl.iPlayer,0,1,0,0,(PLAYER *)0x0);
          RightTextOut(hdc,iVar9,iVar15 + dyArial8 + -2,pcVar7,sVar6,sVar33);
        }
        iVar15 = iVar15 + dyArial8 + -2;
        iVar16 = game.turn - pl.turn;
        if (iVar16 == 0) {
          if (iplrbmp == 0) {
            SVar12 = idsReportCurrent;
          }
          else {
            SVar12 = idsCurrent;
          }
          pcVar7 = PszGetCompressedString(SVar12);
          c = wsprintf(szWork,(char *)pcVar7);
        }
        else if (iplrbmp == 0) {
          iVar14 = iVar16;
          pcVar7 = PszGetCompressedString(idsReportDYear);
          c = wsprintf(szWork,(char *)pcVar7,iVar14);
          if (1 < iVar16) {
            _strcat((char *)szWork,(char *)0x502);
            c = c + 1;
          }
          sVar6 = CchGetString(idsOld,(char *)szWork + c);
          c = c + sVar6;
        }
        else {
          iVar14 = iVar16;
          pcVar7 = PszGetCompressedString(idsOld2);
          c = wsprintf(szWork,(char *)pcVar7,iVar14);
        }
        if (iVar16 < 6) {
          uVar13 = 0;
        }
        else {
          uVar13 = 0xff;
        }
        SetTextColor(hdc,(ulong)uVar13);
        TextOut(hdc,pctDecay,iVar15,szWork,c);
        yCur = iVar15 + dyArial8;
        hbrSav = SelectObject(hdc,hbrButtonShadow);
        PatBlt(hdc,pctDecay,yCur,iVar9 - pctDecay,1,0xf00021);
        PatBlt(hdc,pctDecay + 1,yCur + 1,(iVar9 - pctDecay) + -2,cShip * 3 + -1,0x42);
        PatBlt(hdc,pctDecay,yCur,1,cShip * 3,0xf00021);
        PatBlt(hdc,pctDecay + 2,yCur + cShip,(iVar9 - pctDecay) + -4,1,0xf00021);
        PatBlt(hdc,pctDecay + 2,cShip * 2 + yCur,(iVar9 - pctDecay) + -4,1,0xf00021);
        SelectObject(hdc,hbrButtonHilite);
        PatBlt(hdc,iVar9 + -1,yCur + 1,1,cShip * 3,0xf00021);
        PatBlt(hdc,pctDecay,cShip * 3 + yCur,iVar9 - pctDecay,1,0xf00021);
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        SetBkMode(hdc,1);
        yTop__208 = FCanTerraformLppl
                              ((PLANET *)&pl,&rgMin,(short *)&stack0xfe3c,(short *)&stack0xfe42,1);
        iVar15 = (iVar9 - pctDecay) + -4;
        dy = (THING *)CONCAT22(dy._2_2_,(int)(cShip - dyArial8) >> 1);
        for (i = 0; i < 3; i = i + 1) {
          iVar16 = (int)*(char *)(idPlayer * 0xc0 + 0x59b5 + i);
          xLeft = (short *)CONCAT22((int)*(char *)(idPlayer * 0xc0 + 0x59b8 + i),
                                    (short *)xLeft);
          iVar14 = (int)pl.rgEnvVar[i];
          if (iplrbmp == 0) {
            pcVar7 = (char *)*(undefined2 *)(i * 2 + 0x47e);
          }
          else {
            pcVar7 = (char *)*(undefined2 *)(i * 2 + 0x492);
          }
          RightTextOut(hdc,pctDecay - 2,yCur + (int)(THING *)dy,pcVar7,0,0);
          if (2 < (pl.wFlags & 0xffU)) {
            psz = PszCalcEnvVar(i,iVar14);
            uVar8 = _strlen(psz);
            SelectObject(hdc,rghfontArial8[0]);
            TextOut(hdc,iVar9 + 2,yCur + (int)(THING *)dy,(LPCSTR)psz,uVar8);
          }
          SelectObject(hdc,rghfontArial8[1]);
          SelectObject(hdc,(*((ushort (*) [2])rghbrPlanetAttr + i))[0]);
          HVar10 = hdc;
          sVar6 = MulDiv(iVar16,iVar15,100);
          iVar17 = pctDecay + 2 + sVar6;
          iVar21 = yCur + 2;
          sVar6 = MulDiv(xLeft._2_2_ - iVar16,iVar15,100);
          PatBlt(HVar10,iVar17,iVar21,sVar6,cShip - 3,0xf00021);
          if (2 < (pl.wFlags & 0xffU)) {
            SelectObject(hdc,*(HGDIOBJ *)((int)rghbrPlanetAttr[0] + 2 + i * 4));
            sVar6 = MulDiv((int)pl.rgEnvVarOrig[i],iVar15,100);
            iVar21 = pctDecay + 2 + sVar6;
            iVar16 = (int)cShip / 2 + yCur;
            c = (int)cShip / 4 + -1;
            if (c < 2) {
              c = 2;
            }
            PatBlt(hdc,iVar21 - c,iVar16,c * 2 + 1,1,0xf00021);
            PatBlt(hdc,iVar21,iVar16 - c,1,c * 2 + 1,0xf00021);
            iOffset = yCur + 3;
            xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)(yCur + cShip + -3));
            c = 1;
            sVar6 = MulDiv(iVar14,iVar15,100);
            xBeg = pctDecay + 2 + sVar6;
            while( true ) {
              PatBlt(hdc,xBeg,iOffset,1,1,0xf00021);
              sVar6 = iOffset;
              iOffset = iOffset + 1;
              PatBlt(hdc,xBeg + c + -1,sVar6,1,1,0xf00021);
              if ((int)(short *)xLeft < iOffset) break;
              PatBlt(hdc,xBeg,(short)(short *)xLeft,1,1,0xf00021);
              psVar5 = (short *)xLeft;
              xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)((int)(short *)xLeft + -1));
              PatBlt(hdc,xBeg + c + -1,(short)psVar5,1,1,0xf00021);
              xBeg = xBeg + -1;
              c = c + 2;
            }
            if (yTop__208 != 0) {
              iOffset = iOffset + -1;
              if ((&rgMin)[i] == -1) {
                dxBar = 0;
              }
              else if ((uint)(iVar14 - (&rgMin)[i]) < 0x8000) {
                dxBar = iVar14 - (&rgMin)[i];
              }
              else {
                dxBar = 0;
              }
              sVar6 = MulDiv(iVar14 - dxBar,iVar15,100);
              iVar16 = pctDecay + 2 + sVar6;
              if (plrSav[i + -0xf] == -1) {
                dxBar = 0;
              }
              else if ((uint)(plrSav[i + -0xf] - iVar14) < 0x8000) {
                dxBar = plrSav[i + -0xf] - iVar14;
              }
              else {
                dxBar = 0;
              }
              sVar6 = MulDiv(iVar14 + dxBar,iVar15,100);
              PatBlt(hdc,iVar16,iOffset,((pctDecay + sVar6) - iVar16) + 3,1,0xf00021);
            }
          }
          yCur = yCur + cShip;
        }
        yCur = yCur + (dyArial8 >> 1);
        SelectObject(hdc,hbrButtonShadow);
        PatBlt(hdc,pctDecay,yCur,iVar9 - pctDecay,1,0xf00021);
        PatBlt(hdc,pctDecay + 1,yCur + 1,(iVar9 - pctDecay) + -2,cShip * 3 + 1,0x42);
        PatBlt(hdc,pctDecay,yCur,1,cShip * 3 + 2,0xf00021);
        SelectObject(hdc,hbrButtonHilite);
        PatBlt(hdc,iVar9 + -1,yCur + 1,1,cShip * 3 + 2,0xf00021);
        PatBlt(hdc,pctDecay,cShip * 3 + yCur + 2,iVar9 - pctDecay,1,0xf00021);
        SelectObject(hdc,rghfontArial7[0]);
        sVar6 = wsprintf(szWork,(char *)PCTD,cMinGrafMax);
        DVar26 = GetTextExtent(hdc,szWork,sVar6);
        iVar15 = iVar9 - pctDecay;
        iVar16 = iVar15 + -3;
        iVar14 = cMinGrafMax / (iVar16 / (((int)DVar26 >> 1) + (int)DVar26));
        if (cMinGrafMax < 500) {
          dNum = ((iVar14 + 0x31) / 0x32) * 10;
        }
        else if (cMinGrafMax < 1000) {
          dNum = ((iVar14 + 0x31) / 0x32) * 0x32;
        }
        else if (cMinGrafMax < 0x9c4) {
          dNum = ((iVar14 + 99) / 100) * 100;
        }
        else if (cMinGrafMax < 0x1d4c) {
          dNum = ((iVar14 + 0xf9) / 0xfa) * 0xfa;
        }
        else if (cMinGrafMax < 15000) {
          dNum = ((iVar14 + 499) / 500) * 500;
        }
        else {
          dNum = ((iVar14 + 999) / 1000) * 1000;
        }
        dy._2_2_ = cMinGrafMax / dNum;
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        dy._0_2_ = (THING *)(cShip * 3 + yCur + 4);
        for (i = 0; iVar14 = iVar16 >> 0xf, i <= dy._2_2_; i = i + 1) {
          iVar17 = cMinGrafMax >> 0xf;
          iVar21 = iVar16;
          sVar6 = cMinGrafMax;
          uVar30 = __aFulmul((long)i,(long)dNum);
          uVar30 = __aFulmul(uVar30,CONCAT22(iVar14,iVar21));
          lVar31 = __aFldiv(uVar30,CONCAT22(iVar17,sVar6));
          iVar14 = (int)lVar31 + pctDecay;
          PatBlt(hdc,iVar14,yCur + 2,1,cShip * 3 + -1,0xf00021);
          sVar6 = wsprintf(szWork,(char *)PCTD,i * dNum);
          CtrTextOut(hdc,iVar14,(short)(THING *)dy,(char *)szWork,sVar6);
        }
        RightTextOut(hdc,pctDecay - 4,(short)(THING *)dy,(char *)0x504,2,0);
        if (pl.iPlayer == idPlayer) {
          EstMineralsMined((PLANET *)&pl,(long *)rgl,-1,0);
        }
        else {
          rgl[4] = 0;
          rgl[5] = 0;
          rgl[2] = 0;
          rgl[3] = 0;
          rgl[0] = 0;
          rgl[1] = 0;
          if (pl.iPlayer == -1) {
            for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
              pFVar19 = ((FLEET **)rglpfl)[ifl];
              iVar14 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
              lpfl = (FLEET *)CONCAT22(iVar14,pFVar19);
              if ((pFVar19 == (FLEET *)0x0) && (iVar14 == 0)) break;
              if ((pFVar19->idPlanet == pl.id) &&
                 (((pFVar19->iPlayer == idPlayer && (((uint)pFVar19->wFlags >> 10 & 1) == 0))
                  && ((*(uint *)&((PLORD *)pFVar19->lpplord)[2].iordMax & 0xf) == 3)))) {
                lVar31 = CMineFromLpfl((FLEET *)CONCAT22(iVar14,pFVar19));
                if (0 < lVar31) {
                  EstMineralsMined((PLANET *)&pl,(long *)&stack0xfe26,lVar31,0);
                  for (hbmpSav = 0; (int)hbmpSav < 3; hbmpSav = hbmpSav + 1) {
                    uVar4 = *(uint *)(&stack0xfe26 + hbmpSav * 4);
                    iVar14 = *(int *)(&stack0xfe28 + hbmpSav * 4);
                    puVar1 = rgl + hbmpSav * 2;
                    uVar13 = *puVar1;
                    *puVar1 = *puVar1 + uVar4;
                    rgl[hbmpSav * 2 + 1] =
                         rgl[hbmpSav * 2 + 1] + iVar14 + (uint)CARRY2(uVar13,uVar4);
                  }
                }
              }
            }
          }
        }
        SelectObject(hdc,rghfontArial8[1]);
        dy = (THING *)CONCAT22(dy._2_2_,(THING *)(((int)(cShip - dyArial8) >> 1) + 2));
        for (i = 0; i < 3; i = i + 1) {
          SetTextColor(hdc,CONCAT22(*(undefined2 *)(i * 4 + 0x44a),*(undefined2 *)(i * 4 + 0x448)));
          sVar6 = 0;
          if (iplrbmp == 0) {
            uVar8 = _strlen((char *)*(undefined2 *)(i * 2 + 0x4cc));
          }
          else {
            uVar8 = 4;
          }
          RightTextOut
                    (hdc,pctDecay - 2,(short)(((THING *)dy)->rgb + yCur + -6),
                     (char *)*(undefined2 *)(i * 2 + 0x4cc),uVar8,sVar6);
          iVar14 = cMinGrafMax >> 0xf;
          iVar21 = rgl[i * 2 + 1] + *(int *)((int)pl.rgwtMin + i * 4 + 2) +
                   (uint)CARRY2(rgl[i * 2],*(uint *)(pl.rgwtMin + i));
          if ((iVar21 < iVar14) ||
             ((iVar17 = cMinGrafMax, iVar18 = iVar14, iVar21 <= iVar14 &&
              (rgl[i * 2] + *(uint *)(pl.rgwtMin + i) <= (uint)cMinGrafMax)))) {
            iVar17 = rgl[i * 2] + *(uint *)(pl.rgwtMin + i);
            iVar18 = rgl[i * 2 + 1] + *(int *)((int)pl.rgwtMin + i * 4 + 2) +
                     (uint)CARRY2(rgl[i * 2],*(uint *)(pl.rgwtMin + i));
          }
          sVar6 = cMinGrafMax;
          uVar30 = __aFulmul((long)iVar16,CONCAT22(iVar18,iVar17));
          lVar31 = __aFldiv(uVar30,CONCAT22(iVar14,sVar6));
          SetRect((RECT *)&rcGauge,pctDecay + 1,yCur + 4,pctDecay + (int)lVar31 + 1,
                  yCur + cShip + -1);
          if ((int)lVar31 != 0) {
            FillRect(hdc,(RECT *)&rcGauge,*(HBRUSH *)((int)rghbrMinSum[0] + 2 + i * 4));
          }
          iVar14 = rgl[i * 2 + 1] + *(int *)((int)pl.rgwtMin + i * 4 + 2) +
                   (uint)CARRY2(rgl[i * 2],*(uint *)(pl.rgwtMin + i));
          if ((cMinGrafMax >> 0xf <= iVar14) &&
             ((cMinGrafMax >> 0xf < iVar14 ||
              ((uint)cMinGrafMax < rgl[i * 2] + *(uint *)(pl.rgwtMin + i))))) {
            SetTextColor(hdc,CONCAT22(crButtonText._2_2_,
                                      (undefined2)crButtonText));
            TextOut(hdc,iVar9,(short)(((THING *)dy)->rgb + yCur + -6),(LPCSTR)0x11200507,1);
          }
          iVar21 = cMinGrafMax >> 0xf;
          iVar14 = *(int *)((int)pl.rgwtMin + i * 4 + 2);
          if ((iVar14 < iVar21) ||
             ((sVar6 = cMinGrafMax, iVar17 = iVar21, iVar14 <= iVar21 &&
              (*(uint *)(pl.rgwtMin + i) <= (uint)cMinGrafMax)))) {
            sVar6 = (short)pl.rgwtMin[i];
            iVar17 = *(int *)((int)pl.rgwtMin + i * 4 + 2);
          }
          sVar33 = cMinGrafMax;
          uVar30 = __aFulmul((long)iVar16,CONCAT22(iVar17,sVar6));
          lVar31 = __aFldiv(uVar30,CONCAT22(iVar21,sVar33));
          SetRect((RECT *)&rcGauge,pctDecay + 1,yCur + 4,pctDecay + (int)lVar31 + 1,
                  yCur + cShip + -1);
          if ((int)lVar31 != 0) {
            FillRect(hdc,(RECT *)&rcGauge,(*((ushort (*) [2])rghbrMinSum + i))[0]);
          }
          if (2 < (pl.wFlags & 0xffU)) {
            for (hbmpSav = 0; (int)hbmpSav < 2; hbmpSav = hbmpSav + 1) {
              SelectObject(hdc,((ushort (*) [2])rghbrMinSum)[i][hbmpSav]);
              iOffset = yCur + 4;
              xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)(yCur + cShip + -2));
              c = 1;
              if (pl.rgMinConc[i] < 0x65) {
                uVar13 = (uint)pl.rgMinConc[i];
              }
              else {
                uVar13 = 100;
              }
              sVar6 = MulDiv(uVar13,iVar15 + -0xb,100);
              xBeg = pctDecay + 1 + hbmpSav + sVar6;
              while( true ) {
                sVar6 = iOffset;
                iOffset = iOffset + 1;
                PatBlt(hdc,xBeg,sVar6,c,1,0xf00021);
                psVar5 = (short *)xLeft;
                if ((int)(short *)xLeft < iOffset) break;
                xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)((int)(short *)xLeft + -1));
                PatBlt(hdc,xBeg,(short)psVar5,c,1,0xf00021);
                c = c + 2;
                xBeg = xBeg + -1;
              }
            }
          }
          yCur = yCur + cShip;
        }
        SetBkMode(hdc,2);
        SelectObject(hdc,hbrSav);
        pPVar22 = (PLAYER *)rgplr + idPlayer;
        piVar23 = plrSav;
        for (iVar15 = 0x60; l__198 = CONCAT22(l__198._2_2_,(int)l__198),
            l2 = CONCAT22(l2._2_2_,(undefined2)l2), iVar15 != 0; iVar15 = iVar15 + -1) {
          pPVar2 = pPVar22;
          pPVar22 = (PLAYER *)&pPVar22->cPlanet;
          piVar3 = piVar23;
          piVar23 = piVar23 + 1;
          iVar9 = *piVar3;
          pPVar2->iPlayer = (char)iVar9;
          pPVar2->cShDef = (char)((uint)iVar9 >> 8);
        }
        goto MINE_FinishUp_5;
      }
    }
    l__198 = CONCAT22(l__198._2_2_,(int)l__198);
    l2 = CONCAT22(l2._2_2_,(undefined2)l2);
    if (sel.scan.idpl != -1) {
      yTop__208 = SelectObject(hdcMem,hbmpUnknownPlanet);
      SetTextColor(hdc,0);
      BitBlt(hdc,((prc->right - prc->left) + -0x40 >> 1) + prc->left,
             ((prc->bottom - prc->top) + -0x40 >> 1) + prc->top,0x40,0x40,hdcMem,0,0,0xcc0020);
      SelectObject(hdcMem,yTop__208);
      l__198 = CONCAT22(l__198._2_2_,(int)l__198);
      l2 = CONCAT22(l2._2_2_,(undefined2)l2);
    }
    goto MINE_FinishUp_5;
  }
  l__198 = CONCAT22(l__198._2_2_,(int)l__198);
  l2 = CONCAT22(l2._2_2_,(undefined2)l2);
  if (sel.scan.ith == -1) goto MINE_FinishUp_5;
  yTop = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings + sel.scan.ith);
  iplrbmp = *(uint *)((int)&rgplr[0].wMdPlr + ((uint)yTop->idFull >> 9 & 0xf) * 0xc0) >> 3
            & 0x1f;
  xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)(prc->left + 6));
  yTop__208 = prc->top + 6;
  hbrSav = SelectObject(hdc,hbrButtonShadow);
  PatBlt(hdc,(short)(short *)xLeft,yTop__208,0x46,2,0xf00021);
  PatBlt(hdc,(short)(short *)xLeft,yTop__208 + 2,2,0x44,0xf00021);
  uVar34 = (undefined2)((ulong)yTop >> 0x10);
  if ((uint)yTop->idFull >> 0xd == 0) {
    cShip = (uint)((THING *)yTop)->rgb[6];
  }
  else if ((uint)yTop->idFull >> 0xd == 1) {
    cShip = ((*(uint *)((THING *)yTop)->rgb >> 10 & 0xf) != 0) + 3;
  }
  else if ((uint)yTop->idFull >> 0xd == 3) {
    cShip = 6;
  }
  else {
    cShip = 5;
  }
  SelectPalette(hdc,vhpal,0);
  RealizePalette(hdc);
  if (((uint)yTop->idFull >> 0xd == 2) || ((uint)yTop->idFull >> 0xd == 3)) {
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,(short)((short *)xLeft + 1),yTop__208 + 0x44,0x44,1,0xf00021);
    PatBlt(hdc,(int)(short *)xLeft + 1,yTop__208 + 0x45,0x45,1,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 0x22),yTop__208 + 2,2,0x42,0xf00021);
    PatBlt(hdc,(int)(short *)xLeft + 0x45,yTop__208 + 1,1,1,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 1),yTop__208 + 2,0x42,0x42,0x42);
  }
  else {
    PatBlt(hdc,(short)((short *)xLeft + 8),yTop__208 + 0x44,2,0x26,0xf00021);
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,(short)((short *)xLeft + 1),yTop__208 + 0x44,0xf,1,0xf00021);
    PatBlt(hdc,(int)(short *)xLeft + 1,yTop__208 + 0x45,0xf,1,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 0x1a),yTop__208 + 0x44,0x12,2,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 0x22),yTop__208 + 2,2,0x42,0xf00021);
    PatBlt(hdc,(int)(short *)xLeft + 0x45,yTop__208 + 1,1,1,0xf00021);
    PatBlt(hdc,(int)(short *)xLeft + 0x11,yTop__208 + 0x68,0x25,2,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 8),yTop__208 + 0x69,1,1,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 0x1a),yTop__208 + 0x46,2,0x22,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 1),yTop__208 + 2,0x42,0x42,0x42);
    PatBlt(hdc,(short)((short *)xLeft + 9),yTop__208 + 0x44,0x22,0x24,0x42);
    DibBlt(hdc,(int)(short *)xLeft + 0x13,yTop__208 + 0x47,0x20,0x20,hdibRaces,
                    (iplrbmp & 7U) << 5,(3 - (iplrbmp >> 3)) * 0x20,0x20,0x20,0xcc0020);
  }
  SelectObject(hdc,hbrSav);
  DibBlt(hdc,(short)((short *)xLeft + 1),yTop__208 + 2,0x40,0x40,hdibThings,
                  cShip << 6,0,0x40,0x40,0xcc0020);
  if ((uint)yTop->idFull >> 0xd == 1) {
    xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)xLeft + 0x28);
    SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
    SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    SelectObject(hdc,rghfontArial8[1]);
    if ((*(uint *)((THING *)yTop)->rgb >> 10 & 0xf) != 0) {
      CchGetString(idsTravelingWarpD,szT);
      c__86 = wsprintf(szWork,(char *)szT,(*(uint *)((THING *)yTop)->rgb >> 10 & 0xf) + 4)
      ;
      TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
      yTop__208 = yTop__208 + dyArial8 + 2;
      CchGetString(idsDestination,szT);
      psz = PszGetPlanetName(*(uint *)((THING *)yTop)->rgb & 0x3ff);
      _strcat(szT,psz);
      psVar5 = (short *)xLeft;
      pcVar7 = szT;
      sVar6 = yTop__208;
      HVar10 = hdc;
      uVar8 = _strlen(szT);
      TextOut(HVar10,(short)psVar5,sVar6,(LPCSTR)pcVar7,uVar8);
    }
    yTop__208 = yTop__208 + (dyArial8 * 3) / 2;
    uVar34 = 0x1120;
    pcVar7 = DAT_1120_04d0;
    HVar10 = hdc;
    uVar8 = _strlen(DAT_1120_04d0);
    DVar26 = GetTextExtent(HVar10,(LPCSTR)CONCAT22(uVar34,pcVar7),uVar8);
    xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)((int)(short *)xLeft + (int)DVar26));
    i = 0;
    while( true ) {
      l__198 = CONCAT22(l__198._2_2_,(int)l__198);
      l2 = CONCAT22(l2._2_2_,(undefined2)l2);
      if (2 < i) break;
      uVar34 = *(undefined2 *)(i * 2 + 0x4cc);
      uVar32 = 0x1120;
      pcVar7 = PszGetCompressedString(idsS2);
      c__86 = wsprintf(szWork,(char *)pcVar7,uVar34,uVar32);
      RightTextOut(hdc,(short)(short *)xLeft,yTop__208,(char *)szWork,c__86,0);
      c__86 = wsprintf(szWork,(char *)PCTDKT);
      TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
      yTop__208 = yTop__208 + dyArial8 + 2;
      i = i + 1;
    }
    goto MINE_FinishUp_5;
  }
  if ((uint)yTop->idFull >> 0xd != 2) {
    if ((uint)yTop->idFull >> 0xd == 3) {
      xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)xLeft + 0x28);
      SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SelectObject(hdc,rghfontArial8[1]);
      SetRect((RECT *)&rc,(short)(short *)xLeft,yTop__208,prc->right + -8,prc->bottom + -8);
      if ((1 << ((byte)idPlayer & 0x1f) & *(uint *)(((THING *)yTop)->rgb + 6)) == 0) {
        pcVar7 = PszGetCompressedString(idsTraderRequestsInterestedPartiesSendFleetLeast);
        uVar34 = 0x1120;
        HVar10 = hdc;
        psz = pcVar7;
        uVar8 = _strlen(pcVar7);
        sVar6 = DRAWTEXT(HVar10,(LPCSTR)CONCAT22(uVar34,pcVar7),uVar8,(RECT *)&rc,0x810);
        yTop__208 = yTop__208 + sVar6 + 8;
      }
      uVar13 = *(uint *)(((THING *)yTop)->rgb + 4) & 0xf;
      pcVar7 = PszGetCompressedString(idsTraderTravelingWarpD);
      cch = wsprintf(szWork,(char *)pcVar7,uVar13);
      TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,cch);
      l__198 = CONCAT22(l__198._2_2_,(int)l__198);
      l2 = CONCAT22(l2._2_2_,(undefined2)l2);
    }
    else {
      l__198 = CONCAT22(l__198._2_2_,(int)l__198);
      l2 = CONCAT22(l2._2_2_,(undefined2)l2);
      if ((uint)yTop->idFull >> 0xd == 0) {
        xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)xLeft + 0x28);
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
        SelectObject(hdc,rghfontArial8[1]);
        CchGetString(idsLocationDD,szT);
        uVar34 = (undefined2)((ulong)yTop >> 0x10);
        c__86 = wsprintf(szWork,(char *)szT,(&((THING *)yTop)->pt)->x,
                         (((THING *)yTop)->pt).y);
        TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
        yTop__208 = yTop__208 + dyArial8 + 2;
        CchGetString(idsFieldTypeS,szT);
        c__86 = wsprintf(szWork,(char *)szT,
                         *(undefined2 *)((uint)((THING *)yTop)->rgb[6] * 2 + 0x4f2));
        TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
        yTop__208 = yTop__208 + dyArial8 + 2;
        CchGetString(idsFieldRadiusDLYLdMines,szT);
        uVar24 = (undefined2)((ulong)yTop >> 0x10);
        pTVar20 = (THING *)yTop;
        uVar34 = *(undefined2 *)(pTVar20->rgb + 2);
        uVar32 = *(undefined2 *)pTVar20->rgb;
        _sqrt(SUB84((double)*(long *)pTVar20->rgb,0),
                      (double)CONCAT26(uVar34,CONCAT24(uVar32,(long)((qword)(double)*(long *)pTVar20
                                                  ->rgb >> 0x20))));
        __ftol((double)CONCAT26(xBeg,CONCAT24(dNum,CONCAT22(uVar34,uVar32))));
        c__86 = wsprintf(szWork,(char *)szT);
        TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
        yTop__208 = yTop__208 + dyArial8 + 2;
        sVar6 = GetRaceStat((PLAYER *)rgplr + ((uint)yTop->idFull >> 9 & 0xf),
                                  rsMajorAdv);
        dy = (THING *)CONCAT22((uint)(sVar6 != raMines) * 3 + 1,(THING *)dy);
        uVar34 = (undefined2)((ulong)yTop >> 0x10);
        pTVar20 = (THING *)yTop;
        pt.y = (pTVar20->pt).y;
        pt.x = (&pTVar20->pt)->x;
        sVar6 = CPlanetsInCircle
                          (pt,CONCAT22(*(undefined2 *)(pTVar20->rgb + 2),*(undefined2 *)pTVar20->rgb
                                      ));
        pctDecay = dy._2_2_ * sVar6 + 2;
        rgMin = (int)pctDecay >> 0xf;
        if ((-1 < rgMin) && ((0 < rgMin || (0x32 < pctDecay)))) {
          pctDecay = 0x32;
          rgMin = 0;
        }
        uVar34 = (undefined2)((ulong)yTop >> 0x10);
        pTVar20 = (THING *)yTop;
        if (pTVar20->rgb[7] != 0) {
          bVar25 = 0xffe6 < pctDecay;
          pctDecay = pctDecay + 0x19;
          rgMin = rgMin + (uint)bVar25;
        }
        lVar31 = 100;
        uVar30 = __aFulmul(CONCAT22(*(undefined2 *)(pTVar20->rgb + 2),
                                            *(undefined2 *)pTVar20->rgb),CONCAT22(rgMin,pctDecay));
        lVar31 = __aFldiv(uVar30,lVar31);
        if (lVar31 < CONCAT22(rgMin,pctDecay)) {
          lVar31 = CONCAT22(rgMin,pctDecay);
        }
        if ((((THING *)yTop)->rgb[6] != 2) && (lVar31 < 10)) {
          lVar31 = 10;
        }
        iOffset = (short)((ulong)lVar31 >> 0x10);
        xLeft = (short *)CONCAT22((int)lVar31,(short *)xLeft);
        CchGetString(idsDecayRateLdYear,szT);
        c__86 = wsprintf(szWork,(char *)szT);
        TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
        yTop__208 = yTop__208 + dyArial8 + 2;
        if (((uint)yTop->idFull >> 9 & 0xf) == idPlayer) {
          GetMineFieldCounts(yTop->idFull,&i,&c2);
          CchGetString(idsFieldDD,szT);
          c__86 = wsprintf(szWork,(char *)szT);
          TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
          yTop__208 = yTop__208 + dyArial8 + 2;
        }
        l__198 = CONCAT22(l__198._2_2_,(int)l__198);
        l2 = CONCAT22(l2._2_2_,(undefined2)l2);
      }
    }
    goto MINE_FinishUp_5;
  }
  xLeft._0_2_ = (short *)xLeft + 0x2f;
  SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
  SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  SelectObject(hdc,rghfontArial8[1]);
  cch = CchGetString(idsLocation,szT);
  DVar26 = GetTextExtent(hdc,(LPCSTR)szT,cch);
  xLeft._0_2_ = (short *)((int)(short *)xLeft + (int)DVar26 + 0x14);
  RightTextOut(hdc,(short)((short *)xLeft + -2),yTop__208,szT,cch,0);
  cch = CchGetString(idsDD5,szT);
  uVar34 = (undefined2)((ulong)yTop >> 0x10);
  c__86 = wsprintf(szWork,(char *)szT,(&((THING *)yTop)->pt)->x,(((THING *)yTop)->pt).y);
  TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
  yTop__208 = yTop__208 + (dyArial8 * 3) / 2;
  c__86 = CchGetString(idsDestination2,(char *)szWork);
  RightTextOut(hdc,(short)((short *)xLeft + -2),yTop__208,(char *)szWork,c__86,0)
  ;
  uVar34 = (undefined2)((ulong)yTop >> 0x10);
  if ((1 << ((byte)idPlayer & 0x1f) & *(uint *)(((THING *)yTop)->rgb + 4)) == 0) {
LAB_1028_19f8:
    c__86 = CchGetString(idsUnknown2,(char *)szWork);
  }
  else {
    dy = LpthFromId(*(short *)(((THING *)yTop)->rgb + 6));
    if (dy == (THING *)0x0) goto LAB_1028_19f8;
    c__86 = wsprintf(szWork,(char *)szT,(&((THING *)dy)->pt)->x);
  }
  TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
  yTop__208 = yTop__208 + (dyArial8 * 3) / 2;
  c__86 = CchGetString(idsStability,(char *)szWork);
  RightTextOut(hdc,(short)((short *)xLeft + -2),yTop__208,(char *)szWork,c__86,0)
  ;
  pcVar7 = (char *)szWork;
  sVar6 = PctWormholeMoves(yTop);
  c__86 = CchGetString(sVar6 + idsRockSolid,pcVar7);
  TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
  l__198 = CONCAT22(l__198._2_2_,(int)l__198);
  l2 = CONCAT22(l2._2_2_,(undefined2)l2);
MINE_FinishUp_5:
  SetBkMode(hdc,bkMode);
  SetTextColor(hdc,crFore);
  SetBkColor(hdc,crBack);
  DeleteDC(hdcMem);
  return;
}



// ======================================================================
// Function: HtMineWindow
// Address: 1028:37ac
// Segment: MEMORY_MINE
// ======================================================================


short HtMineWindow(HWND hwnd,short x,short y)

{
  int iVar1;
  short sVar2;
  uint uVar3;
  undefined2 unaff_SS;
  RECT rc;
  short grobj;
  short yCur;
  short dyRow;
  PLANET pl;
  
  grobj = sel.scan.grobj;
  if (sel.scan.grobj == grobjOther) {
    if ((sel.scan.grobjFull & grobjPlanet) == grobjNone) {
      if ((sel.scan.grobjFull & grobjFleet) == grobjNone) {
        grobj = 0;
      }
      else {
        grobj = 2;
      }
    }
    else {
      grobj = 1;
    }
  }
  GetClientRect(hwnd,(RECT *)&rc);
  rc.top = rc.top + dyArial8 * 2;
  if ((((y < rc.top + -5) && (4 < y)) && (x < rc.right + -4)) &&
     ((rc.right - rc.top < x && (sVar2 = FOtherStuffAtScanSel(), sVar2 != 0)))) {
    sVar2 = 9;
  }
  else if ((grobj == 2) ||
          (((grobj == 8 &&
            ((uint)((THING *)lpThings + sel.scan.ith)->idFull >> 0xd != 2)) &&
           ((uint)((THING *)lpThings + sel.scan.ith)->idFull >> 0xd != 3)))) {
    if (((x < rc.left + 0x19) || (rc.left + 0x39 <= x)) ||
       ((y < rc.top + 0x47 || (rc.top + 0x67 <= y)))) {
      if (((grobj == 8) &&
          ((uint)((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0)) &&
         ((rc.left + 9 <= x && (((x < rc.left + 0x49 && (rc.top + 9 <= y)) && (y < rc.top + 0x49))))
         )) {
        sVar2 = 0xe;
      }
      else if (grobj == 8) {
        sVar2 = 0;
      }
      else if (((x < rc.left + 9) || (rc.left + 0x49 <= x)) ||
              ((y < rc.top + 9 || (rc.top + 0x49 <= y)))) {
        if (((x < rc.left + 0x5c) || (y < rc.top + 4)) || (rc.top + 7 + dyArial8 <= y)) {
          sVar2 = 0;
        }
        else {
          sVar2 = 0xb;
        }
      }
      else {
        sVar2 = 0xb;
      }
    }
    else {
      sVar2 = 10;
    }
  }
  else if ((sel.scan.idpl == -1) ||
          (sVar2 = FLookupPlanet(sel.scan.idpl,&pl), sVar2 == 0)) {
    sVar2 = 0;
  }
  else {
    uVar3 = ((rc.bottom - (rc.top + -4)) + dyArial8 * -4 + -2) / 6 + 1U & 0xfffe;
    iVar1 = rc.top + dyArial8 * 2 + -4;
    if (y < iVar1) {
      if (rc.top + -4 < y) {
        if (x < rc.right + -0x18) {
          if ((((pl.iPlayer == idPlayer) || (x <= (rc.right * 3) / 5)) ||
              (y < iVar1 - dyArial8)) || (pl.iPlayer == -1)) {
            sVar2 = 0xc;
          }
          else {
            sVar2 = 10;
          }
        }
        else if (((uint)pl.wFlags >> 9 & 1) == 0) {
          sVar2 = 0;
        }
        else {
          sVar2 = 0xd;
        }
      }
      else {
        sVar2 = 0;
      }
    }
    else if (y < (int)(uVar3 * 3 + iVar1)) {
      sVar2 = (y - iVar1) / (int)uVar3 + 6;
    }
    else {
      iVar1 = iVar1 + uVar3 * 3 + (dyArial8 >> 1) + 1;
      if (y < (int)(uVar3 * 3 + iVar1)) {
        sVar2 = (y - iVar1) / (int)uVar3 + 1;
      }
      else {
        sVar2 = 5;
      }
    }
  }
  return sVar2;
}



// ======================================================================
// Function: MineClick
// Address: 1028:3b4e
// Segment: MEMORY_MINE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10284727) */

void MineClick(short x,short y,short msg,short sks)

{
  short *psVar1;
  SCAN *pSVar2;
  PLANET *pPVar3;
  undefined4 uVar4;
  FLEET *pFVar5;
  FLEET *pFVar6;
  short sVar7;
  int iVar8;
  short *psVar9;
  SCAN *pSVar10;
  undefined2 uVar11;
  undefined2 unaff_SS;
  bool bVar12;
  long cMines_00;
  short ishdef;
  short rgid [16];
  FLEET *lpfl;
  short c;
  char *rgpsz [16];
  char rgsz [382];
  char *psz [9];
  short iChecked;
  int rgi [4];
  undefined *local_70;
  undefined2 local_6e;
  undefined2 local_6c;
  char *lVal;
  int local_68;
  undefined4 cMines;
  FLEET *lpfl__98;
  short ifl;
  uint rglT [4];
  uint rgMax [2];
  short i;
  undefined1 pl [8];
  byte abStack_46 [2];
  uint local_44;
  char acStack_42 [16];
  short local_32 [3];
  int local_2c;
  int local_2a;
  SCAN scan;
  short idNew;
  PLPROD *rglQuan;
  FLEET *lpfl__20;
  char *rgMin;
  PLANET *lppl;
  short ht;
  PLANET *lppl__8;
  
  ht = HtMineWindow(hwndMine,x,y);
  if (((msg == 0x204) && (ht != 9)) && (ht != 0xb)) {
    return;
  }
  switch(ht) {
  default:
    break;
  case 1:
  case 2:
  case 3:
    FLookupPlanet(sel.scan.idpl,(PLANET *)pl);
    GlobalPD.grPopup = 1;
    GlobalPD._2_4_ = SEXT24(ht + -1);
    for (i = 1; i < 5; i = i + 1) {
      *(undefined2 *)(i * 4 + 0xb82) = 0xffff;
      *(undefined2 *)(i * 4 + 0xb84) = 0xffff;
    }
    if (2 < (pl._4_2_ & 0xff)) {
      GlobalPD.iPlrMin = (short)abStack_46[ht];
      GlobalPD.iPlrMax = 0;
      GlobalPD.iPlanVal = (uint)pl._4_2_ >> 10 & 1;
      GlobalPD.iPlanMin = 0;
      cMines = CONCAT22(cMines._2_2_,(short)cMines);
      if (3 < (pl._4_2_ & 0xff)) {
        lVal = (char *)0x0;
        local_68 = 0;
        GlobalPD.iPlanMax = local_32[(ht + -1) * 2];
        GlobalPD.iPlrVal = local_32[(ht + -1) * 2 + 1];
        EstMineralsMined((PLANET *)(PLANET *)pl,(long *)&rglQuan,-1,0);
        cMines_00 = CONCAT22(cMines._2_2_,(short)cMines);
        GlobalPD._18_2_ = (&rglQuan)[(ht + -1) * 2];
        GlobalPD._20_2_ = *(undefined2 *)(&lpfl__20 + ht + -1);
        cMines = cMines_00;
        if (pl._2_2_ == -1) {
          for (ifl = 0; cMines = cMines_00, ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
            pFVar6 = ((FLEET **)rglpfl)[ifl];
            iVar8 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
            lpfl__98 = (FLEET *)CONCAT22(iVar8,pFVar6);
            if ((pFVar6 == (FLEET *)0x0) && (iVar8 == 0)) break;
            if ((pFVar6->idPlanet == pl._0_2_) &&
               (((pFVar6->iPlayer == idPlayer && (((uint)pFVar6->wFlags >> 10 & 1) == 0)) &&
                ((*(uint *)&((PLORD *)pFVar6->lpplord)[2].iordMax & 0xf) == 3)))) {
              cMines_00 = CMineFromLpfl((FLEET *)CONCAT22(iVar8,pFVar6));
              if (0 < cMines_00) {
                cMines = cMines_00;
                EstMineralsMined((PLANET *)(PLANET *)pl,(long *)rglT,cMines_00,0);
                bVar12 = CARRY2((uint)lVal,rglT[(ht + -1) * 2]);
                lVal = (char *)((int)lVal + rglT[(ht + -1) * 2]);
                local_68 = local_68 + rglT[(ht + -1) * 2 + 1] + (uint)bVar12;
                cMines_00 = cMines;
              }
            }
          }
          if ((-1 < local_68) && ((0 < local_68 || (lVal != (char *)0x0)))) {
            GlobalPD._18_2_ = lVal;
            GlobalPD.field12_0x14 = (undefined1)local_68;
            GlobalPD.field13_0x15 = local_68._1_1_;
          }
        }
      }
    }
    Popup(hwndMine,x,y);
    break;
  case 5:
    iChecked = -1;
    rgi[0] = 100;
    rgi[1] = 500;
    rgi[2] = 1000;
    rgi[3] = 0x9c4;
    local_70 = (undefined *)&DAT_1120_1388;
    local_6e = 0x1d4c;
    local_6c = 10000;
    lVal = (char *)rgbCur + 0x288;
    local_68 = 30000;
    for (cMines._0_2_ = 0; (short)cMines < 9; cMines._0_2_ = (short)cMines + 1) {
      wsprintf((char *)(char *)((int)&cMines + (short)cMines * 10 + 2),(char *)PCTDKT,
               rgi[(short)cMines]);
      psz[(short)cMines] = (char *)((int)&cMines + (short)cMines * 10 + 2);
      if (rgi[(short)cMines] == cMinGrafMax) {
        iChecked = (short)cMines;
      }
    }
    cMines._0_2_ = PopupMenu(hwndMine,x,y,9,(long *)0x0,psz,iChecked,1);
    if (((short)cMines != -1) && (rgi[(short)cMines] != cMinGrafMax)) {
      cMinGrafMax = rgi[(short)cMines];
      InvalidateRect(hwndMine,(RECT *)0x0,1);
      if ((grbitScan & 0xf) == 1) {
        InvalidateRect(hwndScanner,(RECT *)0x0,1);
      }
    }
    break;
  case 6:
  case 7:
  case 8:
    FLookupPlanet(sel.scan.idpl,(PLANET *)(pl + 6));
    GlobalPD.grPopup = 5;
    GlobalPD.psz = (char *)(ht + -6);
    GlobalPD.field1_0x2 = pl[6];
    GlobalPD.field2_0x3 = pl[7];
    if ((local_44 & 0xff) < 3) {
      GlobalPD.iPlanVal = -1;
    }
    else {
      GlobalPD.iPlanVal = (short)(acStack_42 + 6)[(int)(ht + -6)];
    }
    if (((local_44 & 0xff) < 3) ||
       (sVar7 = FCanTerraformLppl
                          ((PLANET *)(PLANET *)(pl + 6),(short *)&rgMin,(short *)(rglT + 4),
                           (short *)pl,1), sVar7 == 0)) {
MINE_NoTerra:
      GlobalPD.iPlanMin = -1;
      GlobalPD.iPlanMax = -1;
    }
    else {
      GlobalPD.iPlanMin = (short)(&rgMin)[(int)GlobalPD.psz];
      GlobalPD.iPlanMax = rglT[(int)(GlobalPD.psz + 4)];
      if ((char *)GlobalPD.iPlanMin == (char *)0xffff) {
        GlobalPD.iPlanMin = GlobalPD.iPlanVal;
      }
      if (GlobalPD.iPlanMax == 0xffff) {
        GlobalPD.iPlanMax = GlobalPD.iPlanVal;
      }
      if (GlobalPD.iPlanMin == GlobalPD.iPlanMax) goto MINE_NoTerra;
    }
    GlobalPD.iPlrVal = (short)GlobalPD.psz[idPlayer * 0xc0 + 0x59b2];
    GlobalPD.iPlrMin = (short)GlobalPD.psz[idPlayer * 0xc0 + 0x59b5];
    GlobalPD.iPlrMax = (short)GlobalPD.psz[idPlayer * 0xc0 + 0x59b8];
    Popup(hwndMine,x,y);
    break;
  case 9:
    if (msg == 0x204) {
      PopupMineralScanChoices(hwndMine,x,y);
    }
    else {
      psVar9 = (short *)&sel.scan;
      pSVar10 = &scan;
      for (iVar8 = 8; iVar8 != 0; iVar8 = iVar8 + -1) {
        pSVar2 = pSVar10;
        pSVar10 = (SCAN *)&(pSVar10->pt).y;
        psVar1 = psVar9;
        psVar9 = psVar9 + 1;
        (pSVar2->pt).x = *psVar1;
      }
      scan.iwp = 0;
      if (scan.grobj == grobjThing) {
        rglQuan = (PLPROD *)((int)(short *)scan.ith + 1);
        goto LAB_1028_4113;
      }
LAB_1028_4192:
      if (scan.grobj == grobjFleet) {
        rglQuan = (PLPROD *)((int)(short *)scan.ifl + 1);
      }
      else {
        rglQuan = (PLPROD *)0x0;
      }
      for (; (int)rglQuan < cFleet; rglQuan = (PLPROD *)((int)&rglQuan->wFlags + 1)) {
                    /* WARNING: Load size is inaccurate */
        pFVar6 = ((FLEET **)rglpfl)[(int)rglQuan];
        iVar8 = *(int *)((int)((FLEET **)rglpfl + (int)rglQuan) + 2);
        lpfl__20 = (FLEET *)CONCAT22(iVar8,pFVar6);
        if (((pFVar6 == (FLEET *)0x0) && (iVar8 == 0)) ||
           ((scan.pt.x == (&pFVar6->pt)->x && (scan.pt.y == (pFVar6->pt).y)))) break;
      }
      if ((int)rglQuan < cFleet) {
        scan.ifl = (short)rglQuan;
        scan.grobj = grobjFleet;
        idNew = ((FLEET **)rglpfl)[(int)rglQuan]->id;
        rgMin = (char *)(uint)(((FLEET *)((FLEET **)rglpfl)[(int)rglQuan])->iPlayer ==
                              idPlayer);
      }
      else {
        if ((scan.grobjFull & grobjThing) != grobjNone) {
          rglQuan = (PLPROD *)0x0;
          goto LAB_1028_4113;
        }
        if ((scan.grobjFull & grobjPlanet) == grobjNone) {
          do {
            for (rglQuan = (PLPROD *)0x0; (int)rglQuan < cFleet;
                rglQuan = (PLPROD *)((int)&rglQuan->wFlags + 1)) {
                    /* WARNING: Load size is inaccurate */
              pFVar6 = ((FLEET **)rglpfl)[(int)rglQuan];
              iVar8 = *(int *)((int)((FLEET **)rglpfl + (int)rglQuan) + 2);
              lpfl__20 = (FLEET *)CONCAT22(iVar8,pFVar6);
              if (((pFVar6 == (FLEET *)0x0) && (iVar8 == 0)) ||
                 ((scan.pt.x == (&pFVar6->pt)->x && (scan.pt.y == (pFVar6->pt).y)))) break;
            }
            if ((rglQuan != (PLPROD *)cFleet) ||
               ((scan.grobjFull & grobjThing) == grobjNone)) {
              scan.grobj = grobjFleet;
              scan.ifl = (short)rglQuan;
              idNew = ((FLEET **)rglpfl)[(int)rglQuan]->id;
              rgMin = (char *)(uint)(((FLEET *)((FLEET **)rglpfl)[(int)rglQuan])->iPlayer ==
                                    idPlayer);
              goto MINE_ChangeIt;
            }
            rglQuan = (PLPROD *)0x0;
LAB_1028_4113:
            for (; (int)rglQuan < cThing; rglQuan = (PLPROD *)((int)&rglQuan->wFlags + 1)) {
              local_2c = scan.pt.x;
              local_2a = scan.pt.y;
              if (((&((THING *)lpThings)[(int)rglQuan].pt)->x == scan.pt.x) &&
                 (((THING *)lpThings)[(int)rglQuan].pt.y == scan.pt.y)) break;
            }
            if ((int)rglQuan < cThing) {
              scan.ith = (short)rglQuan;
              scan.grobj = grobjThing;
              idNew = ((THING *)lpThings + (int)rglQuan)->idFull;
              rgMin = (char *)0x0;
              goto MINE_ChangeIt;
            }
            if ((scan.grobjFull & grobjPlanet) != grobjNone) break;
            if ((scan.grobjFull & grobjFleet) == grobjNone) {
              if ((scan.grobjFull & grobjThing) == grobjNone) goto LAB_1028_4192;
              rglQuan = (PLPROD *)0x0;
              goto LAB_1028_4113;
            }
          } while( true );
        }
        scan.grobj = grobjPlanet;
        idNew = scan.idpl;
        lppl = LpplFromId(scan.idpl);
        iVar8 = (int)((ulong)lppl >> 0x10);
        if (((PLANET *)lppl == (PLANET *)0x0) && (iVar8 == 0)) {
          rgMin = (char *)0x0;
        }
        else {
          rgMin = (char *)(uint)(((PLANET *)lppl)->iPlayer == idPlayer);
        }
      }
MINE_ChangeIt:
      if ((rgMin == (char *)0x0) || (sel.grobj != grobjFleet)) {
        scan.iwp = sel.scan.iwp;
      }
      ChangeScanSel(&scan,2);
      if (rgMin != (char *)0x0) {
        RedrawScanSel(0,0);
        ChangeMainObjSel(scan.grobj,idNew);
        RedrawScanSel(0,1);
      }
    }
    break;
  case 10:
    if (sel.scan.grobj == grobjPlanet) {
      lppl = LpplFromId(sel.scan.idpl);
      GlobalPD._2_2_ = ((PLANET *)lppl)->iPlayer;
    }
    else if (sel.scan.grobj == grobjThing) {
      GlobalPD._2_4_ =
           CONCAT22(GlobalPD.psz,
                    (uint)((THING *)lpThings + sel.scan.ith)->idFull >> 9) &
           0xffff000f;
    }
    else {
      GlobalPD._2_4_ =
           CONCAT22(GlobalPD.psz,
                    (uint)((FLEET **)rglpfl)[sel.scan.ifl]->id >> 9) & 0xffff000f;
    }
    GlobalPD.grPopup = 2;
    Popup(hwndMine,x,y);
    break;
  case 0xb:
    if (msg == 0x204) {
                    /* WARNING: Load size is inaccurate */
      lpfl = (FLEET *)CONCAT22(*(undefined2 *)
                                ((int)((FLEET **)rglpfl + sel.scan.ifl) + 2),
                               ((FLEET **)rglpfl)[sel.scan.ifl]);
      c = 0;
      for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
        if (0 < ((FLEET *)lpfl)->rgcsh[ishdef]) {
          rgid[c] = ishdef;
          iVar8 = ((FLEET *)lpfl)->iPlayer * 4;
          __fstrcpy((char *)(rgsz + c * 0x20),
                            (char *)CONCAT22(*(undefined2 *)(iVar8 + 0x100),
                                             (char *)(*(int *)(iVar8 + 0xfe) + ishdef * 0x93 + 8)));
          rgpsz[c] = rgsz + c * 0x20;
          c = c + 1;
        }
      }
      if (c < 2) {
        c = 0;
      }
      else {
        c = PopupMenu(hwndMine,x,y,c,(long *)0x0,rgpsz,-1,1);
        if (c == -1) {
          return;
        }
      }
      GlobalPD.grPopup = 0xb;
      uVar11 = (undefined2)((ulong)lpfl >> 0x10);
      iVar8 = ((FLEET *)lpfl)->iPlayer * 4;
      GlobalPD.psz = (char *)*(undefined2 *)(iVar8 + 0x100);
      GlobalPD._2_2_ = *(int *)(iVar8 + 0xfe) + rgid[c] * 0x93;
      GlobalPD.iPlanMin = (short)(idPlayer != ((FLEET *)lpfl)->iPlayer);
      GlobalPD.iPlanVal = 0;
      GlobalPD.iPlanMax = 0;
      GlobalPD.iPlrVal = 1;
    }
    else {
      GlobalPD.grPopup = 3;
      iVar8 = *(int *)((FLEET **)rglpfl + sel.scan.ifl);
      GlobalPD.psz =
           (char *)*(int *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
      GlobalPD.field1_0x2 = (char)iVar8;
      GlobalPD.field2_0x3 = (char)((uint)iVar8 >> 8);
      GlobalPD.iPlanVal = (short)((*(uint *)(iVar8 + 4) & 0xff) == 7);
      GlobalPD.iPlanMax = 0xff;
    }
    Popup(hwndMine,x,y);
    break;
  case 0xc:
    GlobalPD.grPopup = 7;
    GlobalPD.field1_0x2 = (undefined1)sel.scan.idpl;
    GlobalPD.field2_0x3 = sel.scan.idpl._1_1_;
    Popup(hwndMine,x,y);
    break;
  case 0xd:
    GlobalPD.grPopup = 0xb;
    lppl__8 = LpplFromId(sel.scan.idpl);
    uVar11 = (undefined2)((ulong)lppl__8 >> 0x10);
    pPVar3 = (PLANET *)lppl__8;
    iVar8 = pPVar3->iPlayer * 4;
    GlobalPD.psz = (char *)*(undefined2 *)(iVar8 + 0x14e);
    GlobalPD._2_2_ = *(int *)(iVar8 + 0x14c) + (*(uint *)&pPVar3->field11_0x2c & 0xf) * 0x93;
    GlobalPD.iPlanMin = (short)(idPlayer != pPVar3->iPlayer);
    GlobalPD.iPlanVal = 1;
    GlobalPD.iPlanMax = 0;
    GlobalPD.iPlrVal = 1;
    Popup(hwndMine,x,y);
    break;
  case 0xe:
    pFVar6 = (FLEET *)(uint)*(byte *)(((THING *)lpThings)[sel.scan.ith].rgb[6] +
                                     0x50a);
    rgMin = (char *)((uint)rgMin & 0xff00 | (uint)pFVar6);
    lpfl__20 = (FLEET *)CONCAT22(0x100,pFVar6);
    FLookupPart((PART *)((int)&lpfl__20 + 2));
    pFVar5 = lpfl__20;
    uVar4 = GlobalPD._2_4_;
    GlobalPD.grPopup = 9;
    GlobalPD.field1_0x2 = lpfl__20._2_1_;
    GlobalPD.field2_0x3 = lpfl__20._3_1_;
    GlobalPD._2_4_ = uVar4;
                    /* WARNING: Ignoring partial resolution of indirect */
                    /* WARNING: Ignoring partial resolution of indirect */
    GlobalPD.psz = rgMin;
    GlobalPD.iPlanVal = (short)(PLANET *)lppl;
    GlobalPD.iPlanMin = lppl._2_2_;
    lpfl__20 = pFVar5;
    Popup(hwndMine,x,y);
  }
  return;
}



// ======================================================================
// Function: SetMineralTitleBar
// Address: 1028:47dc
// Segment: MEMORY_MINE
// ======================================================================


void SetMineralTitleBar(HWND hwnd)

{
  short sVar1;
  uint uVar2;
  undefined2 unaff_SS;
  RECT rc;
  short grobj;
  char *psz;
  short fVisCB;
  char szSummary [40];
  char szDeepSpace [42];
  
  fVisCB = 0;
  CchGetString(idsDeepSpace,szDeepSpace);
  CchGetString(idsSummary,szSummary);
  grobj = sel.scan.grobjFull;
  if (sel.scan.grobj != grobjOther) {
    grobj = sel.scan.grobj;
  }
  if ((grobj & grobjPlanet) == grobjNone) {
    if ((grobj & grobjFleet) == grobjNone) {
      if ((grobj & grobjThing) == grobjNone) {
        psz = szDeepSpace;
      }
      else if (sel.scan.ith != -1) {
        fVisCB = 1;
        psz = PszGetThingName(((THING *)lpThings + sel.scan.ith)->idFull);
        _strcat(psz,szSummary);
      }
    }
    else if (sel.scan.ifl != -1) {
      psz = PszGetFleetName(((FLEET **)rglpfl)[sel.scan.ifl]->id);
      _strcat(psz,szSummary);
    }
  }
  else if (sel.scan.idpl != -1) {
    psz = PszGetPlanetName(sel.scan.idpl);
    _strcat(psz,szSummary);
  }
  _strcpy((char *)szMineralTitle,psz);
  InvalidateRect(hwnd,(RECT *)0x0,1);
  if (fVisCB != 0) {
    if (((((uint)((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0) &&
         (((THING *)lpThings)[sel.scan.ith].rgb[6] == 0)) &&
        (((uint)((THING *)lpThings + sel.scan.ith)->idFull >> 9 & 0xf) ==
         idPlayer)) &&
       (sVar1 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
       sVar1 == raMines)) {
      fVisCB = 1;
    }
    else {
      fVisCB = 0;
    }
  }
  if (fVisCB != 0) {
    SendMessage(hwndMineCB,0x401,
                (uint)(((THING *)lpThings)[sel.scan.ith].rgb[7] != 0),0);
  }
  GetClientRect(hwnd,(RECT *)&rc);
  if (fVisCB == 0) {
    uVar2 = 0x80;
  }
  else {
    uVar2 = 0x40;
  }
  SetWindowPos(hwndMineCB,0,0x50,rc.bottom + dyArial8 * -2,rc.right + -0x58,
               dyArial8 + 4,uVar2 | 4);
  return;
}



// ======================================================================
// Function: DrawSelectionArrow
// Address: 1028:4a68
// Segment: MEMORY_MINE
// ======================================================================


void DrawSelectionArrow(HDC hdc,RECT *prc,short fEnabled)

{
  HDC HVar1;
  HGDIOBJ HVar2;
  int iVar3;
  short sVar4;
  short sVar5;
  short xCtr;
  HDC hdcMem;
  HBITMAP hbmpSav;
  
  HVar1 = CreateCompatibleDC(hdc);
  HVar2 = SelectObject(HVar1,hbmpScanner);
  iVar3 = (prc->right - prc->left) / 2 + prc->left;
  BitBlt(hdc,iVar3 + -5,(prc->bottom - prc->top >> 1) + prc->top + -5,0xb,0xc,HVar1,0x23,0x39,
         0x8800c6);
  if (fEnabled == 0) {
    sVar4 = 0;
    sVar5 = 0x2d;
  }
  else {
    sVar4 = 0x18;
    sVar5 = 0x39;
  }
  BitBlt(hdc,iVar3 + -5,(prc->bottom - prc->top >> 1) + prc->top + -5,0xb,0xc,HVar1,sVar4,sVar5,
         0xee0086);
  SelectObject(HVar1,HVar2);
  DeleteDC(HVar1);
  return;
}



// ======================================================================
// Function: DrawDiamond
// Address: 1028:4b60
// Segment: MEMORY_MINE
// ======================================================================


void DrawDiamond(HDC hdc,RECT *prc,HBRUSH hbr)

{
  int iVar1;
  int iVar2;
  int iVar3;
  HGDIOBJ HVar4;
  short xCur;
  short dx;
  short xCtr;
  short yBot;
  short yTop;
  HBRUSH hbrSav;
  
  iVar3 = (prc->right - prc->left) / 2 + prc->left;
  yTop = prc->top;
  iVar1 = prc->bottom;
  HVar4 = SelectObject(hdc,hbrButtonHilite);
  yBot = iVar1 + -2;
  xCur = iVar3;
  while (yTop = yTop + 1, xCur = xCur + -1, yTop <= yBot) {
    PatBlt(hdc,xCur,yTop,2,1,0xf00021);
    PatBlt(hdc,xCur,yBot,2,1,0xf00021);
    yBot = yBot + -1;
  }
  SelectObject(hdc,hbrButtonShadow);
  PatBlt(hdc,iVar3,prc->top,1,1,0xf00021);
  PatBlt(hdc,iVar3,prc->bottom + -1,1,1,0xf00021);
  yTop = prc->top;
  xCur = iVar3;
  yBot = prc->bottom + -2;
  while (yTop = yTop + 1, yTop <= yBot) {
    PatBlt(hdc,xCur,yTop,2,1,0xf00021);
    PatBlt(hdc,xCur,yBot,2,1,0xf00021);
    xCur = xCur + 1;
    yBot = yBot + -1;
  }
  iVar1 = prc->top;
  iVar2 = prc->bottom;
  dx = 1;
  SelectObject(hdc,hbr);
  xCur = iVar3;
  yBot = iVar2 + -5;
  yTop = iVar1 + 4;
  while (yTop <= yBot) {
    PatBlt(hdc,xCur,yTop,dx,1,0xf00021);
    PatBlt(hdc,xCur,yBot,dx,1,0xf00021);
    dx = dx + 2;
    xCur = xCur + -1;
    yBot = yBot + -1;
    yTop = yTop + 1;
  }
  SelectObject(hdc,HVar4);
  return;
}



// ======================================================================
// Function: FOtherStuffAtScanSel
// Address: 1028:4d6e
// Segment: MEMORY_MINE
// ======================================================================


short FOtherStuffAtScanSel(void)

{
  int iVar1;
  int iVar2;
  short sVar3;
  undefined2 uVar4;
  bool bVar5;
  FLEET *lpfl;
  THING *lpth;
  short i;
  short c;
  
  if ((sel.scan.idpl == -1) ||
     ((sel.scan.ifl == -1 && (sel.scan.ith == -1)))) {
    if (sel.scan.ifl != -1) {
      if (sel.scan.ith != -1) {
        return 1;
      }
      c = 1;
      for (i = 0; i < cFleet; i = i + 1) {
        iVar1 = *(int *)((FLEET **)rglpfl + i);
        iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        if ((iVar1 == 0) && (iVar2 == 0)) break;
        if ((*(int *)(iVar1 + 8) == sel.scan.pt.x) &&
           ((*(int *)(iVar1 + 10) == sel.scan.pt.y && (bVar5 = c == 0, c = c + -1, bVar5))
           )) {
          return 1;
        }
      }
    }
    if (sel.scan.ith != -1) {
      c = 1;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      while ((THING *)lpth < (THING *)lpThings + cThing) {
        uVar4 = (undefined2)((ulong)lpth >> 0x10);
        if ((((&((THING *)lpth)->pt)->x == sel.scan.pt.x) &&
            ((((THING *)lpth)->pt).y == sel.scan.pt.y)) &&
           (bVar5 = c == 0, c = c + -1, bVar5)) {
          return 1;
        }
        lpth = (THING *)CONCAT22(uVar4,(THING *)lpth + 1);
      }
    }
    sVar3 = 0;
  }
  else {
    sVar3 = 1;
  }
  return sVar3;
}



// ======================================================================
// Function: PopupMineralScanChoices
// Address: 1028:4ecc
// Segment: MEMORY_MINE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10285231) */
/* WARNING: Removing unreachable block (ram,0x10285166) */

void PopupMineralScanChoices(HWND hwnd,short x,short y)

{
  short *psVar1;
  SCAN *pSVar2;
  FLEET *pFVar3;
  int iVar4;
  undefined4 *puVar5;
  int iVar6;
  int *piVar7;
  short *psVar8;
  SCAN *pSVar9;
  undefined2 uVar10;
  undefined2 unaff_SS;
  SCAN scan;
  short iChecked;
  short idNew;
  undefined4 rgid;
  undefined2 local_1aa;
  undefined2 local_1a8;
  THING *lpthMac;
  undefined2 local_1c;
  FLEET *lpfl;
  THING *lpth;
  short c;
  short i;
  PLANET *lppl;
  short fOurs;
  short id;
  short fSep;
  
  iChecked = -1;
  if (sel.scan.idpl == -1) {
    c = 0;
  }
  else {
    rgid._2_2_ = sel.scan.idpl >> 0xf;
    rgid._0_2_ = sel.scan.idpl;
    local_1aa = 0xffff;
    local_1a8 = 0xffff;
    c = 2;
    if (sel.scan.grobj == grobjPlanet) {
      iChecked = 0;
    }
  }
  for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar3 = ((FLEET **)rglpfl)[i];
    iVar6 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    lpfl = (FLEET *)CONCAT22(iVar6,pFVar3);
    if ((pFVar3 == (FLEET *)0x0) && (iVar6 == 0)) break;
    if ((sel.scan.pt.x == (&pFVar3->pt)->x) && (sel.scan.pt.y == (pFVar3->pt).y)
       ) {
      if ((sel.scan.grobj == grobjFleet) &&
         (((FLEET **)rglpfl)[sel.scan.ifl]->id == lpfl->id)) {
        iChecked = c;
      }
      iVar6 = lpfl->id;
      iVar4 = c * 4;
      piVar7 = (int *)(&rgid + c);
      c = c + 1;
      *piVar7 = iVar6;
      *(uint *)((int)&rgid + iVar4 + 2) = iVar6 >> 0xf | 0x8000;
      if (99 < c) break;
    }
  }
  if ((c == 2) && (sel.scan.idpl != -1)) {
    c = 1;
  }
  fSep = (short)(c == 0);
  lpthMac = (THING *)lpThings + cThing;
  local_1c = lpThings._2_2_;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < lpthMac) {
    uVar10 = (undefined2)((ulong)lpth >> 0x10);
    if ((sel.scan.pt.x == (&((THING *)lpth)->pt)->x) &&
       (sel.scan.pt.y == (((THING *)lpth)->pt).y)) {
      if (fSep == 0) {
        iVar6 = c * 4;
        puVar5 = &rgid + c;
        c = c + 1;
        *(undefined2 *)puVar5 = 0xffff;
        *(undefined2 *)((int)&rgid + iVar6 + 2) = 0xffff;
        fSep = 1;
      }
      if ((sel.scan.grobj == grobjThing) &&
         (((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12 == sel.scan.ith)) {
        iChecked = c;
      }
      iVar6 = c * 4;
      psVar8 = (short *)(&rgid + c);
      c = c + 1;
      *psVar8 = lpth->idFull;
      *(undefined2 *)((int)&rgid + iVar6 + 2) = 0x2000;
    }
    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
  }
  i = PopupMenu(hwnd,x,y,c,&rgid,(char **)0x0,iChecked,1);
  if (-1 < i) {
    psVar8 = (short *)&sel.scan;
    pSVar9 = &scan;
    for (iVar6 = 8; iVar6 != 0; iVar6 = iVar6 + -1) {
      pSVar2 = pSVar9;
      pSVar9 = (SCAN *)&(pSVar9->pt).y;
      psVar1 = psVar8;
      psVar8 = psVar8 + 1;
      (pSVar2->pt).x = *psVar1;
    }
    if ((*(uint *)((int)&rgid + i * 4 + 2) & 0x8000) == 0) {
      if ((*(uint *)((int)&rgid + i * 4 + 2) & 0x2000) == 0) {
        scan.grobj = grobjPlanet;
        idNew = sel.scan.idpl;
        lppl = LpplFromId(sel.scan.idpl);
        fOurs = (short)(((PLANET *)lppl)->iPlayer == idPlayer);
      }
      else {
        scan.grobj = grobjThing;
        lpthMac = (THING *)lpThings + cThing;
        local_1c = lpThings._2_2_;
        lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
        while (((THING *)lpth < (THING *)lpThings + cThing &&
               (lpth->idFull != *(int *)(&rgid + i)))) {
          lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
        }
        scan.ith = ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12;
        idNew = lpth->idFull;
        fOurs = 0;
      }
    }
    else {
      scan.grobj = grobjFleet;
      idNew = *(short *)(&rgid + i);
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar3 = ((FLEET **)rglpfl)[i];
        iVar6 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar6,pFVar3);
        if (((pFVar3 == (FLEET *)0x0) && (iVar6 == 0)) || (lpfl->id == idNew)) break;
      }
      scan.ifl = i;
      fOurs = (short)(((FLEET *)lpfl)->iPlayer == idPlayer);
      id = idNew;
    }
    ChangeScanSel(&scan,2);
    if (fOurs != 0) {
      RedrawScanSel(0,0);
      ChangeMainObjSel(scan.grobj,idNew);
      RedrawScanSel(0,1);
    }
  }
  return;
}



// ======================================================================
// Function: EstMineralsMined
// Address: 1028:5362
// Segment: MEMORY_MINE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10285712) */
/* WARNING: Removing unreachable block (ram,0x102854bf) */
/* WARNING: Removing unreachable block (ram,0x102856b7) */
/* WARNING: Removing unreachable block (ram,0x102856ca) */
/* WARNING: Removing unreachable block (ram,0x102854c4) */
/* WARNING: Removing unreachable block (ram,0x102856cf) */
/* WARNING: Removing unreachable block (ram,0x102856ee) */
/* WARNING: Removing unreachable block (ram,0x102856f3) */
/* WARNING: Removing unreachable block (ram,0x10285717) */
/* WARNING: Removing unreachable block (ram,0x1028582c) */
/* WARNING: Removing unreachable block (ram,0x1028563d) */
/* WARNING: Removing unreachable block (ram,0x10285775) */
/* WARNING: Removing unreachable block (ram,0x10285806) */

void EstMineralsMined(PLANET *lppl,long *plQuan,long cMines,short fApply)

{
  uint *puVar1;
  byte bVar2;
  FLEET *pFVar3;
  int iVar4;
  uint uVar5;
  uint uVar6;
  short sVar7;
  PLANET *pPVar8;
  ushort unaff_DI;
  undefined2 uVar9;
  ulong uVar10;
  long lVar11;
  long lVar12;
  long cMines_00;
  undefined2 uVar13;
  undefined2 uVar14;
  uint uVar15;
  FLEET *lpfl;
  short ifl;
  uint rglQuan [2];
  undefined4 lLeft;
  uint lConc;
  undefined2 local_20;
  short lMineEff;
  int local_1c;
  undefined4 lMine;
  short fRemote;
  short fMacintosh;
  undefined4 lQuan;
  short i;
  undefined4 lQuanAct;
  undefined4 lQuanRem;
  
  fRemote = (short)(cMines != -1);
  uVar9 = (undefined2)((ulong)lppl >> 0x10);
  pPVar8 = (PLANET *)lppl;
  if ((pPVar8->iPlayer == -1) ||
     (sVar7 = GetRaceStat((PLAYER *)rgplr + pPVar8->iPlayer,rsMajorAdv),
     sVar7 != raMacintosh)) {
    fMacintosh = 0;
  }
  else {
    fMacintosh = 1;
  }
  if (cMines == -1) {
    if ((pPVar8->iPlayer == -1) ||
       (((int)pPVar8->rgwtMin[3] == 0 && (*(int *)((int)pPVar8->rgwtMin + 0xe) == 0)))) {
      for (i = 0; i < 3; i = i + 1) {
        *(undefined2 *)(plQuan + i) = 0xffff;
        *(undefined2 *)((int)(plQuan + i) + 2) = 0xffff;
      }
      return;
    }
    lMine._0_2_ = CMinesOperating(lppl);
    lMine._2_2_ = (short)lMine >> 0xf;
    if (fMacintosh == 0) {
      lMineEff = GetRaceStat((PLAYER *)rgplr + pPVar8->iPlayer,rsMineProd);
      local_1c = lMineEff >> 0xf;
    }
    else {
      lMineEff = 10;
      local_1c = 0;
    }
    cMines = CONCAT22(lMine._2_2_,(short)lMine);
  }
  else {
    lMineEff = 10;
    local_1c = 0;
  }
  lVar11 = CONCAT22(lQuan._2_2_,(uint)lQuan);
  lVar12 = CONCAT22(lLeft._2_2_,(undefined2)lLeft);
  i = 0;
  do {
    if (2 < i) {
      if ((fMacintosh != 0) && (fRemote == 0)) {
        for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar3 = ((FLEET **)rglpfl)[ifl];
          iVar4 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
          if ((pFVar3 == (FLEET *)0x0) && (iVar4 == 0)) {
            return;
          }
          if ((((pFVar3->idPlanet == lppl->id) && (pFVar3->iPlayer == pPVar8->iPlayer)) &&
              (((uint)pFVar3->wFlags >> 10 & 1) == 0)) &&
             ((pFVar3->cord < 2 && ((*(uint *)&((PLORD *)pFVar3->lpplord)[2].iordMax & 0xf) == 3))))
          {
            lLeft = lVar12;
            lQuan = lVar11;
            lMine = cMines;
            cMines_00 = CMineFromLpfl((FLEET *)CONCAT22(iVar4,pFVar3));
            lVar12 = lLeft;
            lVar11 = lQuan;
            cMines = lMine;
            if ((-1 < cMines_00) && ((0 < (int)((ulong)cMines_00 >> 0x10) || ((int)cMines_00 != 0)))
               ) {
              EstMineralsMined(lppl,(long *)rglQuan,cMines_00,fApply);
              for (i = 0; i < 3; i = i + 1) {
                uVar5 = rglQuan[i * 2];
                uVar6 = rglQuan[i * 2 + 1];
                puVar1 = (uint *)(plQuan + i);
                uVar15 = *puVar1;
                *puVar1 = *puVar1 + uVar5;
                puVar1 = (uint *)((int)(plQuan + i) + 2);
                *puVar1 = *puVar1 + uVar6 + (uint)CARRY2(uVar15,uVar5);
              }
              lVar12 = lLeft;
              lVar11 = lQuan;
              cMines = lMine;
              if (fApply != 0) {
                pFVar3->wFlags = pFVar3->wFlags & 0xdfff;
              }
            }
          }
        }
      }
      return;
    }
    lConc = (uint)pPVar8->rgMinConc[i];
    if (((lConc < 0x1e) && (((uint)pPVar8->wFlags >> 10 & 1) != 0)) &&
       ((fRemote == 0 || (fMacintosh != 0)))) {
      lConc = 0x1e;
    }
    local_20 = 0;
    lLeft = lVar12;
    lQuan = lVar11;
    lMine = cMines;
    uVar10 = __aFulmul(cMines,(ulong)lConc);
    lQuanAct = uVar10;
    if (fRemote == 0) {
      uVar14 = 0;
      uVar13 = 10;
      uVar10 = __aFulmul(uVar10,CONCAT22(local_1c,lMineEff));
      uVar10 = __aFldiv(uVar10,CONCAT22(uVar14,uVar13));
    }
    lQuan = uVar10;
    lVar11 = __aFlrem(uVar10,100);
    lQuanRem = lVar11;
    lVar11 = __aFldiv(lQuan,100);
    lVar12 = lLeft;
    if ((lQuanRem != 0) && (((uint)gd._0_2_ >> 1 & 1) != 0)) {
      lQuan = lVar11;
      sVar7 = Random(100);
      lVar11 = lQuan;
      lVar12 = CONCAT22(sVar7,(undefined2)lLeft);
      if (sVar7 < (int)lQuanRem) {
        lVar11 = lQuan + 1;
        lVar12 = CONCAT22(sVar7,(undefined2)lLeft);
      }
    }
    lQuan._2_2_ = (uint)((ulong)lVar11 >> 0x10);
    lQuan._0_2_ = (uint)lVar11;
    *(uint *)(plQuan + i) = (uint)lQuan;
    *(uint *)((int)(plQuan + i) + 2) = lQuan._2_2_;
    cMines = lMine;
    if (fApply != 0) {
      puVar1 = (uint *)(pPVar8->rgwtMin + i);
      uVar15 = *puVar1;
      *puVar1 = *puVar1 + (uint)lQuan;
      puVar1 = (uint *)((int)(pPVar8->rgwtMin + i) + 2);
      *puVar1 = *puVar1 + lQuan._2_2_ + (uint)CARRY2(uVar15,(uint)lQuan);
      lQuan = lVar11;
      lLeft = lVar12;
      uVar10 = __aFldiv(lQuanAct,100);
      lVar12 = lLeft;
      while( true ) {
        lVar11 = lQuan;
        lQuanAct = uVar10;
        cMines = lMine;
        if (((long)uVar10 < 1) || (pPVar8->rgMinConc[i] < 2)) goto LAB_1028_588f;
        rglQuan[0] = (uint)pPVar8->rgpctMinLevel[i];
        bVar2 = pPVar8->rgMinConc[i];
        lpfl._2_2_ = (uint)bVar2;
        if (rglQuan[0] == 0) {
          rglQuan[0] = 0x100;
        }
        rglQuan[1] = 0;
        if (bVar2 < 0x65) {
          if (bVar2 < 5) {
            lpfl._2_2_ = 10;
          }
          else if (bVar2 < 0x19) {
            lpfl._2_2_ = 0x19;
          }
        }
        else {
          lpfl._2_2_ = 100;
        }
        ifl = 0;
        uVar14 = 0;
        uVar13 = 0x100;
        uVar15 = lpfl._2_2_;
        lLeft = lVar12;
        uVar10 = __aFulmul((ulong)rglQuan[0],0x30d4);
        lVar11 = __aFldiv(uVar10,CONCAT22(uVar14,uVar13));
        lVar12 = __aFldiv(lVar11,CONCAT22(ifl,uVar15));
        if ((long)lQuanAct < lVar12) break;
        uVar10 = lQuanAct - lVar12;
        pPVar8->rgMinConc[i] = pPVar8->rgMinConc[i] - 1;
        pPVar8->rgpctMinLevel[i] = 0;
      }
      lLeft = lVar12;
      lVar11 = __aFldiv(0x30d4,(ulong)lpfl._2_2_);
      lVar12 = __aFlshl(lVar11,unaff_DI);
      lVar12 = __aFldiv(lVar12,lVar11);
      if (lVar12 < 1) {
        lVar12 = 1;
      }
      if (CONCAT22(rglQuan[1],rglQuan[0]) <= lVar12) {
        lVar12 = CONCAT22(rglQuan[1] + -1 + (uint)(rglQuan[0] != 0),rglQuan[0] - 1);
      }
      pPVar8->rgpctMinLevel[i] = (byte)lVar12;
      lVar11 = lQuan;
      cMines = lMine;
      if (lVar12 == 0) {
        pPVar8->rgMinConc[i] = pPVar8->rgMinConc[i] - 1;
      }
    }
LAB_1028_588f:
    i = i + 1;
  } while( true );
}



