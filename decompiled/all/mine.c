// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: MineWndProc
// Address: 1028:0000
// Segment: MEMORY_MINE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

long MineWndProc(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  POINT PVar1;
  char *pcVar2;
  BOOL BVar3;
  HCURSOR HVar4;
  short fEnabled;
  undefined2 unaff_SI;
  ushort unaff_DI;
  undefined2 unaff_SS;
  COLORREF CVar5;
  DWORD DVar6;
  ulong uVar7;
  LRESULT LVar8;
  char *pcVar9;
  undefined2 uVar10;
  ushort in_stack_0000ffbe;
  int local_40;
  int local_3e;
  int rc;
  short cch;
  short crBack;
  short local_36;
  uint rtlt;
  short pt;
  short fDetonate;
  RECT rc__46;
  PAINTSTRUCT ps;
  HDC hdc;
  
  if (message == WM_CREATE) {
    uVar10 = 0x1120;
    pcVar9 = _szButton;
    pcVar2 = PszGetCompressedString(idsDetonateMineFieldYear);
    hwndMineCB =
         CreateWindow((LPCSTR)CONCAT22(uVar10,pcVar9),pcVar2,0x40000003,100,100,0x96,
                      dyArial8,hwnd,0,hInst,(void *)0x0);
    SendMessage(hwndMineCB,0x30,rghfontArial8[1],0);
    SetMineralTitleBar(hwnd);
  }
  else if (message == WM_PAINT) {
    hdc = BeginPaint(hwnd,&ps);
    GetClientRect(hwnd,&rc__46);
    SetRect(&stack0xffbe,4,4,rc__46.right + -4,dyArial8 * 2 + -4);
    _Draw3dFrame();
    CVar5 = SetTextColor(hdc,CONCAT22(crButtonText._2_2_,
                                      (undefined2)crButtonText));
    fDetonate = (short)(CVar5 >> 0x10);
    pt = (short)CVar5;
    _crBack = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,
                                      (undefined2)crButtonFace));
    cch = _strlen((char *)szMineralTitle);
    rtlt = (local_3e - in_stack_0000ffbe) - 0x18;
    for (; 0 < cch; cch = cch + -1) {
      DVar6 = GetTextExtent(hdc,szMineralTitle,cch);
      if ((uint)DVar6 <= rtlt) break;
    }
    RcCtrTextOut(hdc,&stack0xffbe,(char *)szMineralTitle,cch);
    SetTextColor(hdc,CONCAT22(fDetonate,pt));
    SetBkColor(hdc,_crBack);
    SetRect(&stack0xffbe,(local_3e - (rc - local_40)) + 2,local_40 + 3,local_3e + -4,rc + -2);
    fEnabled = FOtherStuffAtScanSel();
    DrawSelectionArrow(hdc,&stack0xffbe,fEnabled);
    rc__46.top = rc__46.top + dyArial8 * 2 + -4;
    DrawMineSurvey(hdc,&rc__46);
    EndPaint(hwnd,&ps);
  }
  else {
    if (message == WM_ERASEBKGND) {
      GetClientRect(hwnd,&rc__46);
      FillRect(wParam,&rc__46,hbrButtonFace);
      return 1;
    }
    if (message == WM_CTLCOLOR) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return (ulong)hbrButtonFace;
    }
    if (message == WM_SETCURSOR) {
      GetCursorPos(&stack0xffce);
      ScreenToClient(hwnd,&stack0xffce);
      GetClientRect(hwnd,&stack0xffc4);
      PVar1.y = fDetonate;
      PVar1.x = pt;
      BVar3 = PtInRect(&stack0xffc4,PVar1);
      if (BVar3 != 0) {
        rtlt = HtMineWindow(hwnd,pt,fDetonate);
        if (rtlt != 0) {
          HVar4 = hcurHand;
          if (rtlt != 9) {
            HVar4 = hcurArrowHelp;
          }
          setcursor(HVar4);
          return 1;
        }
        rtlt = 0;
      }
MINE_Default_7:
      LVar8 = DefWindowProc(hwnd,message,wParam,lParam);
      return LVar8;
    }
    if (message == WM_COMMAND) {
      if (((HWND)lParam == hwndMineCB) &&
         (uVar7 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffbe), (int)uVar7 == 0)
         ) {
        LVar8 = SendMessage(hwndMineCB,0x400,0,0);
        pt = (short)LVar8;
        rtlt = ((THING *)lpThings + sel.scan.ith)->idFull;
        fDetonate = pt;
        WriteMemRt(0x2b,4,&rtlt);
        *(undefined1 *)((int)&((THING *)lpThings)[sel.scan.ith].u_THING_0x0006 + 7)
             = (char)fDetonate;
      }
    }
    else {
      if (((message != WM_LBUTTONDOWN) && (message != WM_LBUTTONDBLCLK)) &&
         (message != WM_RBUTTONDOWN)) goto MINE_Default_7;
      if (hwndPopup == 0) {
        uVar7 = __aFulshr(CONCAT22(wParam,message),unaff_DI);
        MineClick((HWND)lParam,(short)uVar7,message,wParam);
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: InvalidateMineralBars
// Address: 1028:040a
// Segment: MEMORY_MINE
// ======================================================================


void InvalidateMineralBars(void)

{
  char *pcVar1;
  ushort uVar2;
  undefined2 unaff_SS;
  DWORD DVar3;
  undefined2 uVar4;
  HDC HVar5;
  RECT rc;
  short dxPop;
  short dx;
  RECT rcPop;
  HFONT hfontSav;
  short dyRow;
  HDC hdc;
  
  GetClientRect(hwndMine,&rc);
  hdc = GetDC(hwndMine);
  hfontSav = SelectObject(hdc,rghfontArial8[0]);
  HVar5 = hdc;
  pcVar1 = PszGetCompressedString(idsN999mr);
  DVar3 = GetTextExtent(HVar5,pcVar1,5);
  rc.right = rc.right - ((int)DVar3 + 6);
  SelectObject(hdc,rghfontArial8[1]);
  HVar5 = hdc;
  pcVar1 = PszGetCompressedString(idsPopulation1000000);
  DVar3 = GetTextExtent(HVar5,pcVar1,0x15);
  dxPop = (int)DVar3 + 6;
  uVar4 = 0x1120;
  pcVar1 = pcRam11200480;
  HVar5 = hdc;
  uVar2 = _strlen(pcRam11200480);
  DVar3 = GetTextExtent(HVar5,(LPCSTR)CONCAT22(uVar4,pcVar1),uVar2);
  dx = (int)DVar3 + 6;
  if (dx * 4 - rc.right == 0 || dx * 4 < rc.right) {
    rc.left = rc.left + dx;
  }
  else {
    DVar3 = GetTextExtent(hdc,pcRam11200480,4);
    rc.left = rc.left + (int)DVar3 + 6;
  }
  SelectObject(hdc,hfontSav);
  ReleaseDC(hwndMine,hdc);
  rc.top = rc.top + dyArial8 * 2 + -4;
  rcPop.top = rc.top + 2;
  rcPop.bottom = rcPop.top + dyArial8;
  rcPop.right = rc.right;
  rcPop.left = rc.right - dxPop;
  InvalidateRect(hwndMine,&rcPop,1);
  dyRow = ((rc.bottom - rc.top) + dyArial8 * -4 + -2) / 6 + 1U & 0xfffe;
  rc.top = rc.top + (dyArial8 * 5 >> 1) + dyRow * 3 + 1;
  rc.bottom = dyRow * 3 + rc.top;
  InvalidateRect(hwndMine,&rc,0);
  return;
}



// ======================================================================
// Function: GetMineFieldCounts
// Address: 1028:05ac
// Segment: MEMORY_MINE
// ======================================================================


void GetMineFieldCounts(ushort id,short *pithm,short *pcthm)

{
  short sVar1;
  THING *lpth;
  short ithFound;
  short cthTotal;
  
  ithFound = 0;
  cthTotal = 0;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < (THING *)lpThings + cThing) {
    sVar1 = ithFound;
    if (((lpth->idFull >> 0xd == 0) && ((lpth->idFull >> 9 & 0xf) == idPlayer)) &&
       (cthTotal = cthTotal + 1, sVar1 = cthTotal, lpth->idFull != id)) {
      sVar1 = ithFound;
    }
    ithFound = sVar1;
    lpth = (THING *)lpth + 1;
  }
  *pithm = ithFound;
  *pcthm = cthTotal;
  return;
}



// ======================================================================
// Function: DrawMineSurvey
// Address: 1028:065a
// Segment: MEMORY_MINE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: ifl */
/* WARNING: Removing unreachable block (ram,0x10281e54) */
/* WARNING: Removing unreachable block (ram,0x10283270) */
/* WARNING: Removing unreachable block (ram,0x10280be1) */
/* WARNING: Removing unreachable block (ram,0x10281e94) */
/* WARNING: Removing unreachable block (ram,0x1028101a) */

void DrawMineSurvey(HDC hdc,RECT *prc)

{
  uint *puVar1;
  PLAYER *pPVar2;
  undefined2 *puVar3;
  undefined1 uVar4;
  uint uVar5;
  double dVar6;
  POINT pt;
  short *psVar7;
  short sVar8;
  char *pcVar9;
  ushort uVar10;
  StringId SVar11;
  uint uVar12;
  int iVar13;
  int iVar14;
  int iVar15;
  int iVar16;
  FLEET *pFVar17;
  THING *pTVar18;
  undefined2 unaff_SI;
  PLAYER *pPVar19;
  undefined2 *puVar20;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  bool bVar21;
  DWORD DVar22;
  ulong uVar23;
  long lVar24;
  undefined2 uVar25;
  HDC HVar26;
  HBITMAP HVar27;
  short sVar28;
  ushort in_stack_0000fe20;
  short ifl;
  undefined2 in_stack_0000fe26;
  undefined2 uVar29;
  undefined4 crTextSav;
  undefined4 crBkSav;
  HDC l;
  HBITMAP hbmpSav;
  short dNum;
  short xBeg;
  short dx;
  short dxLabels;
  uint rgMax [6];
  short iCur;
  short dxRLabels;
  short xR;
  short dxNum;
  short dxBar;
  short c;
  short yCur;
  short xEnd;
  short iMin;
  undefined2 plrSav [83];
  char *pszT;
  char szWP [24];
  undefined4 dy;
  short iplrbmp;
  undefined4 xLeft;
  short iOffset;
  uint cShip;
  uint pctDecay;
  short rgMin;
  undefined4 yTop;
  short yTop__208;
  RECT rc;
  undefined4 l__198;
  short grobj;
  char szT [80];
  RECT rcGauge;
  short cch;
  char *psz;
  short bkMode;
  HDC hdcMem;
  COLORREF crBack;
  FLEET *lpfl;
  short i;
  short c__86;
  uint rgl [6];
  short c2;
  COLORREF crFore;
  undefined4 l2;
  HBRUSH hbrSav;
  PLANET pl;
  
  hdcMem = CreateCompatibleDC(hdc);
  crBack = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
  ;
  crFore = SetTextColor(hdc,0xffff);
  bkMode = SetBkMode(hdc,2);
  grobj = sel.scan.grobj;
  if (sel.scan.grobj == grobjOther) {
    if ((sel.scan.grobjFull & grobjPlanet) == grobjNone) {
      if ((sel.scan.grobjFull & grobjFleet) == grobjNone) {
        if ((sel.scan.grobjFull & grobjThing) == grobjNone) {
          grobj = 0;
        }
        else {
          grobj = 8;
        }
      }
      else {
        grobj = 2;
      }
    }
    else {
      grobj = 1;
    }
  }
  l__198 = CONCAT22(l__198._2_2_,(int)l__198);
  l2 = CONCAT22(l2._2_2_,(undefined2)l2);
  crTextSav = CONCAT22(crTextSav._2_2_,(undefined2)crTextSav);
  crBkSav = CONCAT22(crBkSav._2_2_,(undefined2)crBkSav);
  if (grobj == 0) goto MINE_FinishUp_5;
  if (grobj == 2) {
    yTop = (THING *)((ulong)yTop & 0xffff);
    yTop__208 = 0;
    l__198 = CONCAT22(l__198._2_2_,(int)l__198);
    l2 = CONCAT22(l2._2_2_,(undefined2)l2);
    crTextSav = CONCAT22(crTextSav._2_2_,(undefined2)crTextSav);
    crBkSav = CONCAT22(crBkSav._2_2_,(undefined2)crBkSav);
    if (sel.scan.ifl != -1) {
      rgMin = prc->left + 6;
      yTop = (THING *)(ulong)(prc->top + 6);
      hbrSav = SelectObject(hdc,hbrButtonShadow);
      PatBlt(hdc,rgMin,(short)(THING *)yTop,0x46,2,0xf00021);
      PatBlt(hdc,rgMin,(int)(THING *)yTop + 2,2,0x44,0xf00021);
      PatBlt(hdc,rgMin + 0x10,(int)(THING *)yTop + 0x44,2,0x26,0xf00021);
      hbrSav = SelectObject(hdc,hbrButtonHilite);
      PatBlt(hdc,rgMin + 2,(int)(THING *)yTop + 0x44,0xf,1,0xf00021);
      PatBlt(hdc,rgMin + 1,(int)(THING *)yTop + 0x45,0xf,1,0xf00021);
      PatBlt(hdc,rgMin + 0x34,(int)(THING *)yTop + 0x44,0x12,2,0xf00021);
      PatBlt(hdc,rgMin + 0x44,(int)(THING *)yTop + 2,2,0x42,0xf00021);
      PatBlt(hdc,rgMin + 0x45,(int)(THING *)yTop + 1,1,1,0xf00021);
      PatBlt(hdc,rgMin + 0x11,(int)(THING *)yTop + 0x68,0x25,2,0xf00021);
      PatBlt(hdc,rgMin + 0x10,(int)(THING *)yTop + 0x69,1,1,0xf00021);
      PatBlt(hdc,rgMin + 0x34,(int)(THING *)yTop + 0x46,2,0x22,0xf00021);
      PatBlt(hdc,rgMin + 2,(int)(THING *)yTop + 2,0x42,0x42,0x42);
      PatBlt(hdc,rgMin + 0x12,(int)(THING *)yTop + 0x44,0x22,0x24,0x42);
      SelectObject(hdc,hbrSav);
                    /* WARNING: Load size is inaccurate */
      pFVar17 = ((FLEET **)rglpfl)[sel.scan.ifl];
      uVar25 = *(undefined2 *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
      lpfl = (FLEET *)CONCAT22(uVar25,pFVar17);
      DrawFleetBitmap
                ((FLEET *)CONCAT22(uVar25,pFVar17),hdc,rgMin + 2,(int)(THING *)yTop + 2,0,-1,0,0,-1,
                 0);
      iOffset = *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpfl->id >> 9 & 0xf) * 0xc0) >> 3
                & 0x1f;
      SelectPalette(hdc,vhpal,0);
      RealizePalette(hdc);
      DibBlt(hdc,rgMin + 0x13,(int)(THING *)yTop + 0x47,0x20,0x20,hdibRaces,
                      (iOffset & 7U) << 5,(3 - (iOffset >> 3)) * 0x20,0x20,0x20,0xcc0020);
      SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SelectObject(hdc,rghfontArial8[1]);
      cShip = 0;
      pctDecay = 0;
      for (i = 0; i < 0x10; i = i + 1) {
        uVar12 = ((FLEET *)lpfl)->rgcsh[i];
        bVar21 = CARRY2(cShip,uVar12);
        cShip = cShip + uVar12;
        pctDecay = pctDecay + ((int)uVar12 >> 0xf) + (uint)bVar21;
      }
      CchGetString(idsShipCountLd,szT);
      c__86 = _wsprintf(szWork,szT,cShip,pctDecay);
      TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c__86);
      iVar14 = (int)(THING *)yTop + dyArial8 + 2;
      yTop = (THING *)CONCAT22(yTop._2_2_,iVar14);
      uVar25 = (undefined2)((ulong)lpfl >> 0x10);
      pFVar17 = (FLEET *)lpfl;
      if (((pFVar17->wFlags_0x4 & 0xff) == 7) || ((pFVar17->wFlags_0x4 & 0xff) == 4)) {
        lVar24 = WtFromLpfl(lpfl);
        yTop__208 = (short)((ulong)lVar24 >> 0x10);
        yTop._2_2_ = (ushort)lVar24;
        c__86 = CchGetString(idsFuel2,szT);
        l__198 = GetTextExtent(hdc,szT,c__86);
        c2 = CchGetString(idsCargo,(char *)szWork);
        l2 = GetTextExtent(hdc,szWork,c2);
        if ((long)l__198 < (long)l2) {
          l__198 = l2;
        }
        SetRect(&rcGauge,prc->left + 0x5a + (int)l__198,(short)(THING *)yTop,prc->right + -4,
                (int)(THING *)yTop + dyArial8);
        if (rcGauge.left < rcGauge.right) {
          TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szT,c__86);
          yTop._0_2_ = (THING *)((int)(THING *)yTop + dyArial8 + 2);
          TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c2);
          DrawFleetGauge(hdc,&rcGauge,lpfl,4);
          OffsetRc(&rcGauge,0,dyArial8 + 4);
          DrawFleetGauge(hdc,&rcGauge,lpfl,5);
          yTop._0_2_ = (THING *)((int)(THING *)yTop + dyArial8 + 2);
        }
      }
      else {
        yTop._2_2_ = (&pFVar17->u_FLEET_0x002c)->rgdv[0].dp;
        yTop__208 = *(short *)((int)&pFVar17->u_FLEET_0x002c + 2);
        yTop._0_2_ = (THING *)iVar14;
      }
      if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
        SVar11 = idsFleetMassLdkt;
      }
      else {
        SVar11 = idsMassLdkt;
      }
      c__86 = CchGetString(SVar11,szT);
      c__86 = _wsprintf(szWork,szT,yTop._2_2_,yTop__208);
      TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c__86);
      yTop = (THING *)CONCAT22(yTop._2_2_,(THING *)((int)(THING *)yTop + dyArial8 + 2));
      uVar25 = (undefined2)((ulong)lpfl >> 0x10);
      pFVar17 = (FLEET *)lpfl;
      if ((pFVar17->wFlags_0x4 & 0xff) == 7) {
        psVar7 = (short *)(*(int *)&pFVar17->lpplord + 4);
        if (1 < pFVar17->cord) {
          psVar7 = (short *)(*(int *)&pFVar17->lpplord + 0x16);
        }
        xLeft = (short *)CONCAT22(*(undefined2 *)((int)&pFVar17->lpplord + 2),psVar7);
        if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
          SVar11 = idsWaypointS;
        }
        else {
          SVar11 = idsWpS;
        }
        CchGetString(SVar11,szWP);
        if (((FLEET *)lpfl)->cord == 1) {
          pcVar9 = PszGetCompressedString(idsNone);
          c__86 = _wsprintf(szT,szWP,pcVar9,0x1120);
        }
        else {
          uVar25 = (undefined2)((ulong)xLeft >> 0x10);
          psVar7 = (short *)xLeft;
          pcVar9 = PszGetLocName((uint)psVar7[3] >> 8 &
                                       (grobjThing|grobjOther|grobjFleet|grobjPlanet),psVar7[2],
                                       *xLeft,psVar7[1]);
          c__86 = _wsprintf(szT,szWP,pcVar9,0x1120);
        }
        TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szT,c__86);
        if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
          SVar11 = idsWaypointTaskS;
        }
        else {
          SVar11 = idsTaskS;
        }
        yTop._0_2_ = (THING *)((int)&(((THING *)yTop)->pt).x + dyArial8);
        CchGetString(SVar11,szT);
        pcVar9 = PszGetCompressedString((((short *)xLeft)[3] & 0xfU) + idsTaskHere);
        c__86 = _wsprintf(szWork,szT,pcVar9,0x1120);
        TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c__86);
        yTop = (THING *)CONCAT22(yTop._2_2_,(int)(THING *)yTop + dyArial8 + 2);
        if (((FLEET *)lpfl)->cord < 2) {
          if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
            SVar11 = idsWarpSpeedStopped;
          }
          else {
            SVar11 = idsWarpStopped;
          }
          c__86 = CchGetString(SVar11,(char *)szWork);
        }
        else if (((uint)((short *)xLeft)[3] >> 4 & 0xf) == 0xb) {
          c__86 = CchGetString(idsUseStargate,(char *)szWork);
        }
        else {
          if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
            SVar11 = idsWarpSpeedD;
          }
          else {
            SVar11 = idsWarpD;
          }
          CchGetString(SVar11,szT);
          c__86 = _wsprintf(szWork,szT,(uint)((short *)xLeft)[3] >> 4 & 0xf);
        }
        TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c__86);
        yTop = (THING *)CONCAT22(yTop._2_2_,(THING *)((int)(THING *)yTop + dyArial8 + 2));
        DVar22 = CMineSweepFromLpfl(lpfl);
        l__198 = DVar22;
        if (0 < (long)DVar22) {
          pszT = PszGetCompressedString(idsFleetCanDestroyLdMinesPerYear);
          c__86 = _wsprintf(szWork,pszT,(int)l__198,l__198._2_2_);
          TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c__86);
          yTop = (THING *)CONCAT22(yTop._2_2_,
                                   (THING *)((int)&(((THING *)yTop)->pt).x + dyArial8));
        }
      }
      else if ((*(uint *)((int)&pFVar17->dirLong + 2) >> 4 & 1) != 0) {
        if ((*(uint *)((int)&pFVar17->dirLong + 2) & 0xf) == 0) {
          if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
            SVar11 = idsWarpSpeedStopped;
          }
          else {
            SVar11 = idsWarpStopped;
          }
          c__86 = CchGetString(SVar11,(char *)szWork);
        }
        else {
          if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
            SVar11 = idsWarpSpeedD;
          }
          else {
            SVar11 = idsWarpD;
          }
          CchGetString(SVar11,szT);
          c__86 = _wsprintf(szWork,szT,*(uint *)((int)&((FLEET *)lpfl)->dirLong + 2) & 0xf
                           );
        }
        TextOut(hdc,prc->left + 0x56,(short)(THING *)yTop,szWork,c__86);
        yTop = (THING *)CONCAT22(yTop._2_2_,
                                 (THING *)((int)&(((THING *)yTop)->pt).x + dyArial8));
      }
      crTextSav = CONCAT22(crTextSav._2_2_,(undefined2)crTextSav);
      crBkSav = CONCAT22(crBkSav._2_2_,(undefined2)crBkSav);
    }
    goto MINE_FinishUp_5;
  }
  if (grobj != 8) {
    if (sel.scan.idpl != -1) {
      sVar8 = FLookupPlanet(sel.scan.idpl,&pl);
      if (sVar8 != 0) {
        iplrbmp = 0;
        pPVar19 = (PLAYER *)rgplr + idPlayer;
        puVar20 = plrSav;
        for (iVar14 = 0x60; iVar14 != 0; iVar14 = iVar14 + -1) {
          puVar3 = puVar20;
          puVar20 = puVar20 + 1;
          pPVar2 = pPVar19;
          pPVar19 = &pPVar19->cPlanet;
          *puVar3 = *pPVar2;
        }
        rc.left = prc->left;
        rc.top = prc->top;
        rc.right = prc->right;
        rc.bottom = prc->bottom;
        sVar8 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
        if (((sVar8 == raTerra) && (pl.iPlayer != -1)) &&
           ((idPlayer == pl.iPlayer ||
            (*(char *)(idPlayer * 0xc0 + 0x5a12 + pl.iPlayer) == '\x01')))) {
          for (c = 0; c < 3; c = c + 1) {
            *(undefined1 *)(idPlayer * 0xc0 + 0x59b2 + c) =
                 *(undefined1 *)(pl.iPlayer * 0xc0 + 0x59b2 + c);
            *(undefined1 *)(idPlayer * 0xc0 + 0x59b5 + c) =
                 *(undefined1 *)(pl.iPlayer * 0xc0 + 0x59b5 + c);
            uVar4 = *(undefined1 *)(pl.iPlayer * 0xc0 + 0x59b8 + c);
            hbmpSav = CONCAT11((char)((uint)c >> 8),uVar4);
            *(undefined1 *)(idPlayer * 0xc0 + 0x59b8 + c) = uVar4;
          }
        }
        SelectObject(hdc,rghfontArial8[0]);
        HVar26 = hdc;
        pcVar9 = PszGetCompressedString(idsN999mr);
        DVar22 = GetTextExtent(HVar26,pcVar9,5);
        dxRLabels = (int)DVar22 + 6;
        SelectObject(hdc,rghfontArial8[1]);
        uVar25 = 0x1120;
        pcVar9 = pcRam11200480;
        HVar26 = hdc;
        uVar10 = _strlen(pcRam11200480);
        DVar22 = GetTextExtent(HVar26,(LPCSTR)CONCAT22(uVar25,pcVar9),uVar10);
        dxLabels = (int)DVar22 + 6;
        if (dxLabels * 4 - rc.right != 0 && rc.right <= dxLabels * 4) {
          iplrbmp = 1;
          DVar22 = GetTextExtent(hdc,pcRam11200480,4);
          dxLabels = (int)DVar22 + 6;
        }
        pctDecay = rc.left + dxLabels;
        xR = rc.right - dxRLabels;
        hbmpSav = dyArial8 * 4;
        cShip = ((rc.bottom - rc.top) + dyArial8 * -4 + -2) / 6 + 1U & 0xfffe;
        yCur = rc.top + 2;
        if ((pl.wFlags_0x4 >> 9 & 1) != 0) {
          l = CreateCompatibleDC(hdc);
          hbmpSav = SelectObject(l,hbmpMono);
          crTextSav = SetTextColor(hdc,0);
          crBkSav = SetBkColor(hdc,0xffffff);
          BitBlt(hdc,rc.right + -0x16,yCur + 2,0xd,0x10,l,0,0xc,0x8800c6);
          SetTextColor(hdc,0xffff);
          SetBkColor(hdc,0);
          BitBlt(hdc,rc.right + -0x16,yCur + 2,0xd,0x10,l,0,0xc,0xee0086);
          SetTextColor(hdc,crTextSav);
          SetBkColor(hdc,crBkSav);
          SelectObject(l,hbmpSav);
          DeleteDC(l);
        }
        if (2 < (pl.wFlags_0x4 & 0xff)) {
          c = CchGetString((iplrbmp == 0) + idsVal,(char *)szWork);
          DVar22 = GetTextExtent(hdc,szWork,c);
          dx = (short)DVar22;
          SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText)
                      );
          TextOut(hdc,pctDecay,yCur,szWork,c);
          dNum = PctPlanetDesirability(&pl,idPlayer);
          c = _wsprintf(szWork,PCTDPCTPCT,dNum);
          if (dNum < 0) {
            uVar12 = 0xff;
          }
          else {
            uVar12 = 0x7f00;
          }
          SetTextColor(hdc,(ulong)uVar12);
          TextOut(hdc,pctDecay + dx,yCur,szWork,c);
          if (iplrbmp == 0) {
            DVar22 = GetTextExtent(hdc,szWork,c);
            dx = dx + (int)DVar22;
            hbmpSav = PctPlanetOptValue(&pl,idPlayer);
            if (dNum < (int)hbmpSav) {
              if (0 < (int)hbmpSav) {
                if ((int)hbmpSav < 0xb) {
                  uVar12 = 0x7f7f;
                }
                else {
                  uVar12 = 0x7f00;
                }
                SetTextColor(hdc,(ulong)uVar12);
              }
              c = _wsprintf(szWork,(char *)0x112004fa,hbmpSav);
              TextOut(hdc,pctDecay + dx,yCur,szWork,c);
            }
          }
        }
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        if (pl.iPlayer != -1) {
          pcVar9 = PszGetCompressedString((iplrbmp == 0) + idsPop);
          _strcpy(szT,pcVar9);
        }
        if ((pl.wFlags_0x4 & 0xff) == 7) {
          c = _strlen(szT);
          uVar23 = __aFulmul(CONCAT22(pl.rgwtMin[3]._2_2_,(undefined2)pl.rgwtMin[3]),100);
          sVar8 = CommaFormatLong(szT + c,uVar23);
          c = c + sVar8;
          RightTextOut(hdc,xR,yCur,szT,c,0);
        }
        else if (pl.iPlayer == -1) {
          c = CchGetString(idsUninhabited,szT);
          RightTextOut(hdc,xR,yCur,szT,c,0);
        }
        else {
          if (2 < (pl.wFlags_0x4 & 0xff)) {
            lVar24 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000fe20);
            hbmpSav = (HBITMAP)((ulong)lVar24 >> 0x10);
            l = (HDC)lVar24;
            _strcpy((char *)szWork,szT);
            c = _strlen(szT);
            if (((int)hbmpSav < 0) || (((int)hbmpSav < 1 && (l == 0)))) {
              sVar8 = CchGetString(idsMsg1264,(char *)szWork + c);
              c = c + sVar8;
            }
            else {
              uVar25 = 0xb1;
              HVar26 = l;
              HVar27 = hbmpSav;
              pcVar9 = PszGetCompressedString(idsCLd00);
              sVar8 = _wsprintf((char *)szWork + c,pcVar9,uVar25,HVar26,HVar27);
              c = c + sVar8;
            }
            RightTextOut(hdc,xR,yCur,(char *)szWork,c,0);
          }
          SetTextColor(hdc,0xff);
          sVar28 = 0;
          sVar8 = 0;
          pcVar9 = PszPlayerName(pl.iPlayer,0,1,0,0,(PLAYER *)0x0);
          RightTextOut(hdc,xR,yCur + dyArial8 + -2,pcVar9,sVar8,sVar28);
        }
        yCur = yCur + dyArial8 + -2;
        iVar14 = game.turn - pl.turn;
        dNum = iVar14;
        if (iVar14 == 0) {
          if (iplrbmp == 0) {
            SVar11 = idsReportCurrent;
          }
          else {
            SVar11 = idsCurrent;
          }
          pcVar9 = PszGetCompressedString(SVar11);
          c = _wsprintf(szWork,pcVar9);
        }
        else if (iplrbmp == 0) {
          pcVar9 = PszGetCompressedString(idsReportDYear);
          c = _wsprintf(szWork,pcVar9,iVar14);
          if (1 < dNum) {
            _strcat((char *)szWork,(char *)0x502);
            c = c + 1;
          }
          sVar8 = CchGetString(idsOld,(char *)szWork + c);
          c = c + sVar8;
        }
        else {
          pcVar9 = PszGetCompressedString(idsOld2);
          c = _wsprintf(szWork,pcVar9,iVar14);
        }
        if (dNum < 6) {
          uVar12 = 0;
        }
        else {
          uVar12 = 0xff;
        }
        SetTextColor(hdc,(ulong)uVar12);
        TextOut(hdc,pctDecay,yCur,szWork,c);
        yCur = yCur + dyArial8;
        hbrSav = SelectObject(hdc,hbrButtonShadow);
        PatBlt(hdc,pctDecay,yCur,xR - pctDecay,1,0xf00021);
        PatBlt(hdc,pctDecay + 1,yCur + 1,(xR - pctDecay) + -2,cShip * 3 + -1,0x42);
        PatBlt(hdc,pctDecay,yCur,1,cShip * 3,0xf00021);
        PatBlt(hdc,pctDecay + 2,yCur + cShip,(xR - pctDecay) + -4,1,0xf00021);
        PatBlt(hdc,pctDecay + 2,cShip * 2 + yCur,(xR - pctDecay) + -4,1,0xf00021);
        SelectObject(hdc,hbrButtonHilite);
        PatBlt(hdc,xR + -1,yCur + 1,1,cShip * 3,0xf00021);
        PatBlt(hdc,pctDecay,cShip * 3 + yCur,xR - pctDecay,1,0xf00021);
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        SetBkMode(hdc,1);
        yTop__208 = FCanTerraformLppl(&pl,&rgMin,rgMax,rgMax + 3,1);
        dx = (xR - pctDecay) + -4;
        dy = (THING *)CONCAT22(dy._2_2_,(int)(cShip - dyArial8) >> 1);
        for (i = 0; i < 3; i = i + 1) {
          iMin = (int)*(char *)(idPlayer * 0xc0 + 0x59b5 + i);
          xLeft = (short *)CONCAT22((int)*(char *)(idPlayer * 0xc0 + 0x59b8 + i),
                                    (short *)xLeft);
          iCur = (short)pl.rgEnvVar[i];
          if (iplrbmp == 0) {
            pcVar9 = (char *)*(undefined2 *)(i * 2 + rgszPlanetAttr);
          }
          else {
            pcVar9 = (char *)*(undefined2 *)(i * 2 + rgszPlanetAttrAbbr);
          }
          RightTextOut(hdc,pctDecay - 2,yCur + (int)(THING *)dy,pcVar9,0,0);
          if (2 < (pl.wFlags_0x4 & 0xff)) {
            psz = PszCalcEnvVar(i,iCur);
            c = _strlen(psz);
            SelectObject(hdc,rghfontArial8[0]);
            TextOut(hdc,xR + 2,yCur + (int)(THING *)dy,psz,c);
          }
          SelectObject(hdc,rghfontArial8[1]);
          SelectObject(hdc,(*((ushort (*) [2])rghbrPlanetAttr + i))[0]);
          HVar26 = hdc;
          sVar8 = MulDiv(iMin,dx,100);
          iVar15 = pctDecay + 2 + sVar8;
          iVar14 = yCur + 2;
          sVar8 = MulDiv(xLeft._2_2_ - iMin,dx,100);
          PatBlt(HVar26,iVar15,iVar14,sVar8,cShip - 3,0xf00021);
          if (2 < (pl.wFlags_0x4 & 0xff)) {
            SelectObject(hdc,*(HGDIOBJ *)((int)rghbrPlanetAttr[0] + 2 + i * 4));
            sVar8 = MulDiv((int)pl.rgEnvVarOrig[i],dx,100);
            l = pctDecay + 2 + sVar8;
            hbmpSav = (int)cShip / 2 + yCur;
            c = (int)cShip / 4 + -1;
            if (c < 2) {
              c = 2;
            }
            PatBlt(hdc,l - c,hbmpSav,c * 2 + 1,1,0xf00021);
            PatBlt(hdc,l,hbmpSav - c,1,c * 2 + 1,0xf00021);
            iOffset = yCur + 3;
            xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)(yCur + cShip + -3));
            c = 1;
            sVar8 = MulDiv(iCur,dx,100);
            xBeg = pctDecay + 2 + sVar8;
            while( true ) {
              PatBlt(hdc,xBeg,iOffset,1,1,0xf00021);
              sVar8 = iOffset;
              iOffset = iOffset + 1;
              PatBlt(hdc,xBeg + c + -1,sVar8,1,1,0xf00021);
              if ((int)(short *)xLeft < iOffset) break;
              PatBlt(hdc,xBeg,(short)(short *)xLeft,1,1,0xf00021);
              psVar7 = (short *)xLeft;
              xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)((int)(short *)xLeft + -1));
              PatBlt(hdc,xBeg + c + -1,(short)psVar7,1,1,0xf00021);
              xBeg = xBeg + -1;
              c = c + 2;
            }
            if (yTop__208 != 0) {
              iOffset = iOffset + -1;
              if ((&rgMin)[i] == -1) {
                dxBar = 0;
              }
              else if ((uint)(iCur - (&rgMin)[i]) < 0x8000) {
                dxBar = iCur - (&rgMin)[i];
              }
              else {
                dxBar = 0;
              }
              sVar8 = MulDiv(iCur - dxBar,dx,100);
              xBeg = pctDecay + 2 + sVar8;
              if (rgMax[i] == 0xffff) {
                dxBar = 0;
              }
              else if (rgMax[i] - iCur < 0x8000) {
                dxBar = rgMax[i] - iCur;
              }
              else {
                dxBar = 0;
              }
              sVar8 = MulDiv(iCur + dxBar,dx,100);
              xEnd = pctDecay + 2 + sVar8;
              PatBlt(hdc,xBeg,iOffset,(xEnd - xBeg) + 1,1,0xf00021);
            }
          }
          yCur = yCur + cShip;
        }
        yCur = yCur + (dyArial8 >> 1);
        SelectObject(hdc,hbrButtonShadow);
        PatBlt(hdc,pctDecay,yCur,xR - pctDecay,1,0xf00021);
        PatBlt(hdc,pctDecay + 1,yCur + 1,(xR - pctDecay) + -2,cShip * 3 + 1,0x42);
        PatBlt(hdc,pctDecay,yCur,1,cShip * 3 + 2,0xf00021);
        SelectObject(hdc,hbrButtonHilite);
        PatBlt(hdc,xR + -1,yCur + 1,1,cShip * 3 + 2,0xf00021);
        PatBlt(hdc,pctDecay,cShip * 3 + yCur + 2,xR - pctDecay,1,0xf00021);
        SelectObject(hdc,rghfontArial7[0]);
        c = _wsprintf(szWork,PCTD,cMinGrafMax);
        DVar22 = GetTextExtent(hdc,szWork,c);
        dxNum = (short)DVar22;
        dxBar = (xR - pctDecay) + -3;
        iVar14 = cMinGrafMax / (dxBar / ((dxNum >> 1) + dxNum));
        if (cMinGrafMax < 500) {
          dNum = ((iVar14 + 0x31) / 0x32) * 10;
        }
        else if (cMinGrafMax < 1000) {
          dNum = ((iVar14 + 0x31) / 0x32) * 0x32;
        }
        else if (cMinGrafMax < 0x9c4) {
          dNum = ((iVar14 + 99) / 100) * 100;
        }
        else if (cMinGrafMax < 0x1d4c) {
          dNum = ((iVar14 + 0xf9) / 0xfa) * 0xfa;
        }
        else if (cMinGrafMax < 15000) {
          dNum = ((iVar14 + 499) / 500) * 500;
        }
        else {
          dNum = ((iVar14 + 999) / 1000) * 1000;
        }
        dy._2_2_ = cMinGrafMax / dNum;
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        dy._0_2_ = (THING *)(cShip * 3 + yCur + 4);
        for (i = 0; i <= dy._2_2_; i = i + 1) {
          iVar14 = cMinGrafMax >> 0xf;
          iVar15 = dxBar >> 0xf;
          sVar8 = dxBar;
          sVar28 = cMinGrafMax;
          uVar23 = __aFulmul((long)i,(long)dNum);
          uVar23 = __aFulmul(uVar23,CONCAT22(iVar15,sVar8));
          lVar24 = __aFldiv(uVar23,CONCAT22(iVar14,sVar28));
          xBeg = (int)lVar24 + pctDecay;
          PatBlt(hdc,xBeg,yCur + 2,1,cShip * 3 + -1,0xf00021);
          c = _wsprintf(szWork,PCTD,i * dNum);
          CtrTextOut(hdc,xBeg,(short)(THING *)dy,(char *)szWork,c);
        }
        RightTextOut(hdc,pctDecay - 4,(short)(THING *)dy,(char *)0x504,2,0);
        if (pl.iPlayer == idPlayer) {
          EstMineralsMined(&pl,rgl,-1,0);
        }
        else {
          rgl[4] = 0;
          rgl[5] = 0;
          rgl[2] = 0;
          rgl[3] = 0;
          rgl[0] = 0;
          rgl[1] = 0;
          if (pl.iPlayer == -1) {
            for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
              pFVar17 = ((FLEET **)rglpfl)[ifl];
              iVar14 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
              lpfl = (FLEET *)CONCAT22(iVar14,pFVar17);
              if ((pFVar17 == (FLEET *)0x0) && (iVar14 == 0)) break;
              if ((pFVar17->idPlanet == pl.id) &&
                 (((pFVar17->iPlayer == idPlayer && ((pFVar17->wFlags_0x4 >> 10 & 1) == 0))
                  && ((*(uint *)&((PLORD *)pFVar17->lpplord)[2].iordMax & 0xf) == 3)))) {
                lVar24 = CMineFromLpfl((FLEET *)CONCAT22(iVar14,pFVar17));
                if (0 < lVar24) {
                  EstMineralsMined(&pl,&stack0xfe26,lVar24,0);
                  for (hbmpSav = 0; (int)hbmpSav < 3; hbmpSav = hbmpSav + 1) {
                    uVar5 = rgMax[hbmpSav * 2 + -0xb];
                    iVar14 = *(int *)(&crTextSav + hbmpSav);
                    puVar1 = rgl + hbmpSav * 2;
                    uVar12 = *puVar1;
                    *puVar1 = *puVar1 + uVar5;
                    rgl[hbmpSav * 2 + 1] =
                         rgl[hbmpSav * 2 + 1] + iVar14 + (uint)CARRY2(uVar12,uVar5);
                  }
                }
              }
            }
          }
        }
        SelectObject(hdc,rghfontArial8[1]);
        dy = (THING *)CONCAT22(dy._2_2_,(THING *)(((int)(cShip - dyArial8) >> 1) + 2));
        for (i = 0; i < 3; i = i + 1) {
          SetTextColor(hdc,CONCAT22(*(undefined2 *)(i * 4 + rgcrMinerals_0x2),
                                    *(undefined2 *)(i * 4 + rgcrMinerals)));
          sVar8 = 0;
          if (iplrbmp == 0) {
            uVar10 = _strlen((char *)*(undefined2 *)(i * 2 + rgszMinerals));
          }
          else {
            uVar10 = 4;
          }
          RightTextOut
                    (hdc,pctDecay - 2,(int)&((THING *)dy)->idFull + yCur,
                     (char *)*(undefined2 *)(i * 2 + rgszMinerals),uVar10,sVar8);
          iVar14 = cMinGrafMax >> 0xf;
          iVar15 = rgl[i * 2 + 1] + *(int *)((int)pl.rgwtMin + i * 4 + 2) +
                   (uint)CARRY2(rgl[i * 2],*(uint *)(pl.rgwtMin + i));
          if ((iVar15 < iVar14) ||
             ((iVar13 = cMinGrafMax, iVar16 = iVar14, iVar15 <= iVar14 &&
              (rgl[i * 2] + *(uint *)(pl.rgwtMin + i) <= (uint)cMinGrafMax)))) {
            iVar13 = rgl[i * 2] + *(uint *)(pl.rgwtMin + i);
            iVar16 = rgl[i * 2 + 1] + *(int *)((int)pl.rgwtMin + i * 4 + 2) +
                     (uint)CARRY2(rgl[i * 2],*(uint *)(pl.rgwtMin + i));
          }
          sVar8 = cMinGrafMax;
          uVar23 = __aFulmul((long)dxBar,CONCAT22(iVar16,iVar13));
          lVar24 = __aFldiv(uVar23,CONCAT22(iVar14,sVar8));
          dx = (short)lVar24;
          SetRect(&rcGauge,pctDecay + 1,yCur + 4,pctDecay + dx + 1,yCur + cShip + -1);
          if (dx != 0) {
            FillRect(hdc,&rcGauge,*(HBRUSH *)((int)rghbrMinSum[0] + 2 + i * 4));
          }
          l = rgl[i * 2] + *(uint *)(pl.rgwtMin + i);
          hbmpSav = rgl[i * 2 + 1] + *(int *)((int)pl.rgwtMin + i * 4 + 2) +
                    (uint)CARRY2(rgl[i * 2],*(uint *)(pl.rgwtMin + i));
          if ((cMinGrafMax >> 0xf <= (int)hbmpSav) &&
             ((cMinGrafMax >> 0xf < (int)hbmpSav || ((uint)cMinGrafMax < l)))) {
            SetTextColor(hdc,CONCAT22(crButtonText._2_2_,
                                      (undefined2)crButtonText));
            TextOut(hdc,xR,(int)&((THING *)dy)->idFull + yCur,(LPCSTR)0x11200507,1);
          }
          iVar15 = cMinGrafMax >> 0xf;
          iVar14 = *(int *)((int)pl.rgwtMin + i * 4 + 2);
          if ((iVar14 < iVar15) ||
             ((sVar8 = cMinGrafMax, iVar13 = iVar15, iVar14 <= iVar15 &&
              (*(uint *)(pl.rgwtMin + i) <= (uint)cMinGrafMax)))) {
            sVar8 = (short)pl.rgwtMin[i];
            iVar13 = *(int *)((int)pl.rgwtMin + i * 4 + 2);
          }
          sVar28 = cMinGrafMax;
          uVar23 = __aFulmul((long)dxBar,CONCAT22(iVar13,sVar8));
          lVar24 = __aFldiv(uVar23,CONCAT22(iVar15,sVar28));
          dx = (short)lVar24;
          SetRect(&rcGauge,pctDecay + 1,yCur + 4,pctDecay + dx + 1,yCur + cShip + -1);
          if (dx != 0) {
            FillRect(hdc,&rcGauge,(*((ushort (*) [2])rghbrMinSum + i))[0]);
          }
          if (2 < (pl.wFlags_0x4 & 0xff)) {
            for (hbmpSav = 0; (int)hbmpSav < 2; hbmpSav = hbmpSav + 1) {
              SelectObject(hdc,((ushort (*) [2])rghbrMinSum)[i][hbmpSav]);
              iOffset = yCur + 4;
              xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)(yCur + cShip + -2));
              c = 1;
              if (pl.rgMinConc[i] < 0x65) {
                uVar12 = (uint)pl.rgMinConc[i];
              }
              else {
                uVar12 = 100;
              }
              sVar8 = MulDiv(uVar12,dxBar + -8,100);
              xBeg = pctDecay + 1 + hbmpSav + sVar8;
              while( true ) {
                sVar8 = iOffset;
                iOffset = iOffset + 1;
                PatBlt(hdc,xBeg,sVar8,c,1,0xf00021);
                sVar8 = xBeg;
                psVar7 = (short *)xLeft;
                if ((int)(short *)xLeft < iOffset) break;
                xBeg = xBeg + -1;
                xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)((int)(short *)xLeft + -1));
                PatBlt(hdc,sVar8,(short)psVar7,c,1,0xf00021);
                c = c + 2;
              }
            }
          }
          yCur = yCur + cShip;
        }
        SetBkMode(hdc,2);
        SelectObject(hdc,hbrSav);
        pPVar19 = (PLAYER *)rgplr + idPlayer;
        puVar20 = plrSav;
        for (iVar14 = 0x60; l__198 = CONCAT22(l__198._2_2_,(int)l__198),
            l2 = CONCAT22(l2._2_2_,(undefined2)l2), iVar14 != 0; iVar14 = iVar14 + -1) {
          pPVar2 = pPVar19;
          pPVar19 = &pPVar19->cPlanet;
          puVar3 = puVar20;
          puVar20 = puVar20 + 1;
          uVar25 = *puVar3;
          pPVar2->iPlayer = (char)uVar25;
          pPVar2->cShDef = (char)((uint)uVar25 >> 8);
        }
        goto MINE_FinishUp_5;
      }
    }
    l__198 = CONCAT22(l__198._2_2_,(int)l__198);
    l2 = CONCAT22(l2._2_2_,(undefined2)l2);
    crTextSav = CONCAT22(crTextSav._2_2_,(undefined2)crTextSav);
    crBkSav = CONCAT22(crBkSav._2_2_,(undefined2)crBkSav);
    if (sel.scan.idpl != -1) {
      yTop__208 = SelectObject(hdcMem,hbmpUnknownPlanet);
      SetTextColor(hdc,0);
      BitBlt(hdc,((prc->right - prc->left) + -0x40 >> 1) + prc->left,
             ((prc->bottom - prc->top) + -0x40 >> 1) + prc->top,0x40,0x40,hdcMem,0,0,0xcc0020);
      SelectObject(hdcMem,yTop__208);
      l__198 = CONCAT22(l__198._2_2_,(int)l__198);
      l2 = CONCAT22(l2._2_2_,(undefined2)l2);
      crTextSav = CONCAT22(crTextSav._2_2_,(undefined2)crTextSav);
      crBkSav = CONCAT22(crBkSav._2_2_,(undefined2)crBkSav);
    }
    goto MINE_FinishUp_5;
  }
  l__198 = CONCAT22(l__198._2_2_,(int)l__198);
  l2 = CONCAT22(l2._2_2_,(undefined2)l2);
  crTextSav = CONCAT22(crTextSav._2_2_,(undefined2)crTextSav);
  crBkSav = CONCAT22(crBkSav._2_2_,(undefined2)crBkSav);
  if (sel.scan.ith == -1) goto MINE_FinishUp_5;
  yTop = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings + sel.scan.ith);
  iplrbmp = *(uint *)((int)&rgplr[0].wMdPlr + (yTop->idFull >> 9 & 0xf) * 0xc0) >> 3 &
            0x1f;
  xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)(prc->left + 6));
  yTop__208 = prc->top + 6;
  hbrSav = SelectObject(hdc,hbrButtonShadow);
  PatBlt(hdc,(short)(short *)xLeft,yTop__208,0x46,2,0xf00021);
  PatBlt(hdc,(short)(short *)xLeft,yTop__208 + 2,2,0x44,0xf00021);
  uVar25 = (undefined2)((ulong)yTop >> 0x10);
  if (yTop->idFull >> 0xd == 0) {
    cShip = (uint)*(byte *)((int)&((THING *)yTop)->u_THING_0x0006 + 6);
  }
  else if (yTop->idFull >> 0xd == 1) {
    cShip = ((((&((THING *)yTop)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) != 0) + 3;
  }
  else if (yTop->idFull >> 0xd == 3) {
    cShip = 6;
  }
  else {
    cShip = 5;
  }
  SelectPalette(hdc,vhpal,0);
  RealizePalette(hdc);
  if ((yTop->idFull >> 0xd == 2) || (yTop->idFull >> 0xd == 3)) {
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,(short)((short *)xLeft + 1),yTop__208 + 0x44,0x44,1,0xf00021);
    PatBlt(hdc,(int)(short *)xLeft + 1,yTop__208 + 0x45,0x45,1,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 0x22),yTop__208 + 2,2,0x42,0xf00021);
    PatBlt(hdc,(int)(short *)xLeft + 0x45,yTop__208 + 1,1,1,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 1),yTop__208 + 2,0x42,0x42,0x42);
  }
  else {
    PatBlt(hdc,(short)((short *)xLeft + 8),yTop__208 + 0x44,2,0x26,0xf00021);
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,(short)((short *)xLeft + 1),yTop__208 + 0x44,0xf,1,0xf00021);
    PatBlt(hdc,(int)(short *)xLeft + 1,yTop__208 + 0x45,0xf,1,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 0x1a),yTop__208 + 0x44,0x12,2,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 0x22),yTop__208 + 2,2,0x42,0xf00021);
    PatBlt(hdc,(int)(short *)xLeft + 0x45,yTop__208 + 1,1,1,0xf00021);
    PatBlt(hdc,(int)(short *)xLeft + 0x11,yTop__208 + 0x68,0x25,2,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 8),yTop__208 + 0x69,1,1,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 0x1a),yTop__208 + 0x46,2,0x22,0xf00021);
    PatBlt(hdc,(short)((short *)xLeft + 1),yTop__208 + 2,0x42,0x42,0x42);
    PatBlt(hdc,(short)((short *)xLeft + 9),yTop__208 + 0x44,0x22,0x24,0x42);
    DibBlt(hdc,(int)(short *)xLeft + 0x13,yTop__208 + 0x47,0x20,0x20,hdibRaces,
                    (iplrbmp & 7U) << 5,(3 - (iplrbmp >> 3)) * 0x20,0x20,0x20,0xcc0020);
  }
  SelectObject(hdc,hbrSav);
  DibBlt(hdc,(short)((short *)xLeft + 1),yTop__208 + 2,0x40,0x40,hdibThings,
                  cShip << 6,0,0x40,0x40,0xcc0020);
  if (yTop->idFull >> 0xd == 1) {
    xLeft = (short *)xLeft + 0x28;
    SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
    SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    SelectObject(hdc,rghfontArial8[1]);
    if ((((&((THING *)yTop)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) != 0) {
      CchGetString(idsTravelingWarpD,szT);
      c__86 = _wsprintf(szWork,szT,
                        (((&((THING *)yTop)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) + 4);
      TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
      yTop__208 = yTop__208 + dyArial8 + 2;
      CchGetString(idsDestination,szT);
      psz = PszGetPlanetName(((&((THING *)yTop)->u_THING_0x0006)->thp).wFlags & 0x3ff);
      _strcat(szT,psz);
      pcVar9 = szT;
      sVar8 = yTop__208;
      psVar7 = (short *)xLeft;
      HVar26 = hdc;
      uVar10 = _strlen(szT);
      TextOut(HVar26,(short)psVar7,sVar8,pcVar9,uVar10);
    }
    yTop__208 = yTop__208 + (dyArial8 * 3) / 2;
    uVar25 = 0x1120;
    pcVar9 = pcRam112004d0;
    HVar26 = hdc;
    uVar10 = _strlen(pcRam112004d0);
    DVar22 = GetTextExtent(HVar26,(LPCSTR)CONCAT22(uVar25,pcVar9),uVar10);
    xLeft = (short *)CONCAT22(xLeft._2_2_,(short *)((int)(short *)xLeft + (int)DVar22));
    i = 0;
    while( true ) {
      l__198 = CONCAT22(l__198._2_2_,(int)l__198);
      l2 = CONCAT22(l2._2_2_,(undefined2)l2);
      crTextSav = CONCAT22(crTextSav._2_2_,(undefined2)crTextSav);
      crBkSav = CONCAT22(crBkSav._2_2_,(undefined2)crBkSav);
      if (2 < i) break;
      uVar25 = *(undefined2 *)(i * 2 + rgszMinerals);
      uVar29 = 0x1120;
      pcVar9 = PszGetCompressedString(idsS2);
      c__86 = _wsprintf(szWork,pcVar9,uVar25,uVar29);
      RightTextOut(hdc,(short)(short *)xLeft,yTop__208,(char *)szWork,c__86,0);
      c__86 = _wsprintf(szWork,PCTDKT,
                        *(undefined2 *)((((THING *)yTop)->u_THING_0x0006).rgb + i * 2 + 2));
      TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
      yTop__208 = yTop__208 + dyArial8 + 2;
      i = i + 1;
    }
    goto MINE_FinishUp_5;
  }
  if (yTop->idFull >> 0xd != 2) {
    if (yTop->idFull >> 0xd == 3) {
      xLeft = (short *)xLeft + 0x28;
      SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SelectObject(hdc,rghfontArial8[1]);
      SetRect(&rc,(short)(short *)xLeft,yTop__208,prc->right + -8,prc->bottom + -8);
      if ((1 << ((byte)idPlayer & 0x1f) &
          *(uint *)((int)&((THING *)yTop)->u_THING_0x0006 + 6)) == 0) {
        pcVar9 = PszGetCompressedString(idsTraderRequestsInterestedPartiesSendFleetLeast);
        uVar25 = 0x1120;
        HVar26 = hdc;
        psz = pcVar9;
        uVar10 = _strlen(pcVar9);
        sVar8 = DRAWTEXT(HVar26,(LPCSTR)CONCAT22(uVar25,pcVar9),uVar10,&rc,0x810);
        yTop__208 = yTop__208 + sVar8 + 8;
      }
      uVar12 = *(uint *)((int)&((THING *)yTop)->u_THING_0x0006 + 4) & 0xf;
      pcVar9 = PszGetCompressedString(idsTraderTravelingWarpD);
      cch = _wsprintf(szWork,pcVar9,uVar12);
      TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,cch);
      l__198 = CONCAT22(l__198._2_2_,(int)l__198);
      l2 = CONCAT22(l2._2_2_,(undefined2)l2);
      crTextSav = CONCAT22(crTextSav._2_2_,(undefined2)crTextSav);
      crBkSav = CONCAT22(crBkSav._2_2_,(undefined2)crBkSav);
    }
    else {
      l__198 = CONCAT22(l__198._2_2_,(int)l__198);
      l2 = CONCAT22(l2._2_2_,(undefined2)l2);
      crTextSav = CONCAT22(crTextSav._2_2_,(undefined2)crTextSav);
      crBkSav = CONCAT22(crBkSav._2_2_,(undefined2)crBkSav);
      if (yTop->idFull >> 0xd == 0) {
        xLeft = (short *)xLeft + 0x28;
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
        SelectObject(hdc,rghfontArial8[1]);
        CchGetString(idsLocationDD,szT);
        uVar25 = (undefined2)((ulong)yTop >> 0x10);
        c__86 = _wsprintf(szWork,szT,(&((THING *)yTop)->pt)->x,(((THING *)yTop)->pt).y);
        TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
        yTop__208 = yTop__208 + dyArial8 + 2;
        CchGetString(idsFieldTypeS,szT);
        c__86 = _wsprintf(szWork,szT,
                          *(undefined2 *)
                           ((uint)*(byte *)((int)&((THING *)yTop)->u_THING_0x0006 + 6) * 2 + 0x4f2),
                          0x1120);
        TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
        yTop__208 = yTop__208 + dyArial8 + 2;
        CchGetString(idsFieldRadiusDLYLdMines,szT);
        uVar25 = (undefined2)((ulong)yTop >> 0x10);
        pTVar18 = (THING *)yTop;
        dVar6 = (double)((&pTVar18->u_THING_0x0006)->thm).cMines;
        _sqrt(SUB84(dVar6,0),
                      (double)CONCAT26(*(undefined2 *)((int)&pTVar18->u_THING_0x0006 + 2),
                                       CONCAT24(((&pTVar18->u_THING_0x0006)->thp).wFlags,
                                                (long)((qword)dVar6 >> 0x20))));
        lVar24 = __ftol((double)CONCAT26(crTextSav._2_2_,
                                                 CONCAT24((undefined2)crTextSav,
                                                          CONCAT22(in_stack_0000fe26,ifl))));
        c__86 = _wsprintf(szWork,szT,(int)lVar24);
        TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
        yTop__208 = yTop__208 + dyArial8 + 2;
        sVar8 = GetRaceStat((PLAYER *)rgplr + (yTop->idFull >> 9 & 0xf),rsMajorAdv);
        dy = (THING *)CONCAT22((uint)(sVar8 != raMines) * 3 + 1,(THING *)dy);
        uVar25 = (undefined2)((ulong)yTop >> 0x10);
        pTVar18 = (THING *)yTop;
        pt.y = (pTVar18->pt).y;
        pt.x = (&pTVar18->pt)->x;
        sVar8 = CPlanetsInCircle
                          (pt,CONCAT22(*(undefined2 *)((int)&pTVar18->u_THING_0x0006 + 2),
                                       ((&pTVar18->u_THING_0x0006)->thp).wFlags));
        pctDecay = dy._2_2_ * sVar8 + 2;
        rgMin = (int)pctDecay >> 0xf;
        if ((-1 < rgMin) && ((0 < rgMin || (0x32 < pctDecay)))) {
          pctDecay = 0x32;
          rgMin = 0;
        }
        uVar25 = (undefined2)((ulong)yTop >> 0x10);
        pTVar18 = (THING *)yTop;
        if (*(char *)((int)&pTVar18->u_THING_0x0006 + 7) != '\0') {
          bVar21 = 0xffe6 < pctDecay;
          pctDecay = pctDecay + 0x19;
          rgMin = rgMin + (uint)bVar21;
        }
        uVar29 = 0;
        uVar23 = __aFulmul(CONCAT22(*(undefined2 *)((int)&pTVar18->u_THING_0x0006 + 2),
                                            ((&pTVar18->u_THING_0x0006)->thp).wFlags),
                                   CONCAT22(rgMin,pctDecay));
        lVar24 = __aFldiv(uVar23,CONCAT22(uVar29,100));
        if (lVar24 < CONCAT22(rgMin,pctDecay)) {
          lVar24 = CONCAT22(rgMin,pctDecay);
        }
        if ((*(char *)((int)&((THING *)yTop)->u_THING_0x0006 + 6) != '\x02') && (lVar24 < 10)) {
          lVar24 = 10;
        }
        iOffset = (short)((ulong)lVar24 >> 0x10);
        xLeft = (short *)CONCAT22((int)lVar24,(short *)xLeft);
        CchGetString(idsDecayRateLdYear,szT);
        c__86 = _wsprintf(szWork,szT,xLeft._2_2_);
        TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
        yTop__208 = yTop__208 + dyArial8 + 2;
        if ((yTop->idFull >> 9 & 0xf) == idPlayer) {
          GetMineFieldCounts(yTop->idFull,&i,&c2);
          CchGetString(idsFieldDD,szT);
          c__86 = _wsprintf(szWork,szT,i);
          TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
          yTop__208 = yTop__208 + dyArial8 + 2;
        }
        l__198 = CONCAT22(l__198._2_2_,(int)l__198);
        l2 = CONCAT22(l2._2_2_,(undefined2)l2);
        crTextSav = CONCAT22(crTextSav._2_2_,(undefined2)crTextSav);
        crBkSav = CONCAT22(crBkSav._2_2_,(undefined2)crBkSav);
      }
    }
    goto MINE_FinishUp_5;
  }
  xLeft._0_2_ = (short *)xLeft + 0x2f;
  SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
  SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  SelectObject(hdc,rghfontArial8[1]);
  cch = CchGetString(idsLocation,szT);
  DVar22 = GetTextExtent(hdc,szT,cch);
  xLeft._0_2_ = (short *)((int)(short *)xLeft + (int)DVar22 + 0x14);
  RightTextOut(hdc,(short)((short *)xLeft + -2),yTop__208,szT,cch,0);
  cch = CchGetString(idsDD5,szT);
  uVar25 = (undefined2)((ulong)yTop >> 0x10);
  c__86 = _wsprintf(szWork,szT,(&((THING *)yTop)->pt)->x,(((THING *)yTop)->pt).y);
  TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
  yTop__208 = yTop__208 + (dyArial8 * 3) / 2;
  c__86 = CchGetString(idsDestination2,(char *)szWork);
  RightTextOut(hdc,(short)((short *)xLeft + -2),yTop__208,(char *)szWork,c__86,0)
  ;
  uVar25 = (undefined2)((ulong)yTop >> 0x10);
  if ((1 << ((byte)idPlayer & 0x1f) & *(uint *)((int)&((THING *)yTop)->u_THING_0x0006 + 4))
      == 0) {
LAB_1028_19f8:
    c__86 = CchGetString(idsUnknown2,(char *)szWork);
  }
  else {
    dy = LpthFromId(*(short *)((int)&((THING *)yTop)->u_THING_0x0006 + 6));
    uVar25 = (undefined2)((ulong)dy >> 0x10);
    if (dy == (THING *)0x0) goto LAB_1028_19f8;
    c__86 = _wsprintf(szWork,szT,(&((THING *)dy)->pt)->x,(((THING *)dy)->pt).y);
  }
  TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
  yTop__208 = yTop__208 + (dyArial8 * 3) / 2;
  c__86 = CchGetString(idsStability,(char *)szWork);
  RightTextOut(hdc,(short)((short *)xLeft + -2),yTop__208,(char *)szWork,c__86,0)
  ;
  pcVar9 = (char *)szWork;
  sVar8 = PctWormholeMoves(yTop);
  c__86 = CchGetString(sVar8 + idsRockSolid,pcVar9);
  TextOut(hdc,(short)(short *)xLeft,yTop__208,szWork,c__86);
  l__198 = CONCAT22(l__198._2_2_,(int)l__198);
  l2 = CONCAT22(l2._2_2_,(undefined2)l2);
  crTextSav = CONCAT22(crTextSav._2_2_,(undefined2)crTextSav);
  crBkSav = CONCAT22(crBkSav._2_2_,(undefined2)crBkSav);
MINE_FinishUp_5:
  SetBkMode(hdc,bkMode);
  SetTextColor(hdc,crFore);
  SetBkColor(hdc,crBack);
  DeleteDC(hdcMem);
  return;
}



// ======================================================================
// Function: HtMineWindow
// Address: 1028:37ac
// Segment: MEMORY_MINE
// ======================================================================


short HtMineWindow(HWND hwnd,short x,short y)

{
  int iVar1;
  short sVar2;
  uint uVar3;
  undefined2 unaff_SS;
  RECT rc;
  short grobj;
  short yCur;
  short dyRow;
  PLANET pl;
  
  grobj = sel.scan.grobj;
  if (sel.scan.grobj == grobjOther) {
    if ((sel.scan.grobjFull & grobjPlanet) == grobjNone) {
      if ((sel.scan.grobjFull & grobjFleet) == grobjNone) {
        grobj = 0;
      }
      else {
        grobj = 2;
      }
    }
    else {
      grobj = 1;
    }
  }
  GetClientRect(hwnd,&rc);
  rc.top = rc.top + dyArial8 * 2;
  if ((((y < rc.top + -5) && (4 < y)) && (x < rc.right + -4)) &&
     ((rc.right - rc.top < x && (sVar2 = FOtherStuffAtScanSel(), sVar2 != 0)))) {
    sVar2 = 9;
  }
  else if ((grobj == 2) ||
          (((grobj == 8 && (((THING *)lpThings + sel.scan.ith)->idFull >> 0xd != 2)
            ) && (((THING *)lpThings + sel.scan.ith)->idFull >> 0xd != 3)))) {
    if (((x < rc.left + 0x19) || (rc.left + 0x39 <= x)) ||
       ((y < rc.top + 0x47 || (rc.top + 0x67 <= y)))) {
      if (((grobj == 8) && (((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0)
          ) && ((rc.left + 9 <= x &&
                (((x < rc.left + 0x49 && (rc.top + 9 <= y)) && (y < rc.top + 0x49)))))) {
        sVar2 = 0xe;
      }
      else if (grobj == 8) {
        sVar2 = 0;
      }
      else if (((x < rc.left + 9) || (rc.left + 0x49 <= x)) ||
              ((y < rc.top + 9 || (rc.top + 0x49 <= y)))) {
        if (((x < rc.left + 0x5c) || (y < rc.top + 4)) || (rc.top + 7 + dyArial8 <= y)) {
          sVar2 = 0;
        }
        else {
          sVar2 = 0xb;
        }
      }
      else {
        sVar2 = 0xb;
      }
    }
    else {
      sVar2 = 10;
    }
  }
  else if ((sel.scan.idpl == -1) ||
          (sVar2 = FLookupPlanet(sel.scan.idpl,&pl), sVar2 == 0)) {
    sVar2 = 0;
  }
  else {
    uVar3 = ((rc.bottom - (rc.top + -4)) + dyArial8 * -4 + -2) / 6 + 1U & 0xfffe;
    iVar1 = rc.top + dyArial8 * 2 + -4;
    if (y < iVar1) {
      if (rc.top + -4 < y) {
        if (x < rc.right + -0x18) {
          if ((((pl.iPlayer == idPlayer) || (x <= (rc.right * 3) / 5)) ||
              (y < iVar1 - dyArial8)) || (pl.iPlayer == -1)) {
            sVar2 = 0xc;
          }
          else {
            sVar2 = 10;
          }
        }
        else if ((pl.wFlags_0x4 >> 9 & 1) == 0) {
          sVar2 = 0;
        }
        else {
          sVar2 = 0xd;
        }
      }
      else {
        sVar2 = 0;
      }
    }
    else if (y < (int)(uVar3 * 3 + iVar1)) {
      sVar2 = (y - iVar1) / (int)uVar3 + 6;
    }
    else {
      iVar1 = iVar1 + uVar3 * 3 + (dyArial8 >> 1) + 1;
      if (y < (int)(uVar3 * 3 + iVar1)) {
        sVar2 = (y - iVar1) / (int)uVar3 + 1;
      }
      else {
        sVar2 = 5;
      }
    }
  }
  return sVar2;
}



// ======================================================================
// Function: MineClick
// Address: 1028:3b4e
// Segment: MEMORY_MINE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10284727) */

void MineClick(short x,short y,short msg,short sks)

{
  short *psVar1;
  SCAN *pSVar2;
  PLANET *pPVar3;
  FLEET *pFVar4;
  short sVar5;
  int iVar6;
  short *psVar7;
  SCAN *pSVar8;
  undefined2 uVar9;
  undefined2 unaff_SS;
  bool bVar10;
  long cMines_00;
  short ishdef;
  short rgid [16];
  FLEET *lpfl;
  short c;
  char *rgpsz [16];
  char rgsz [382];
  char *psz [9];
  short iChecked;
  int rgi [7];
  char *lVal;
  int local_68;
  undefined4 cMines;
  FLEET *lpfl__98;
  short ifl;
  uint rglT [4];
  uint rgMax [2];
  short i;
  undefined1 pl [8];
  byte abStack_46 [2];
  uint local_44;
  char acStack_42 [16];
  short local_32 [3];
  int local_2c;
  int local_2a;
  SCAN scan;
  short idNew;
  PLPROD *rglQuan;
  FLEET *lpfl__20;
  uint rgMin;
  PLANET *lppl;
  short ht;
  PLANET *lppl__8;
  
  ht = HtMineWindow(hwndMine,x,y);
  if (((msg == 0x204) && (ht != 9)) && (ht != 0xb)) {
    return;
  }
  switch(ht) {
  default:
    break;
  case 1:
  case 2:
  case 3:
    FLookupPlanet(sel.scan.idpl,pl);
    GlobalPD.grPopup = 1;
    GlobalPD.u_POPUPDATA_0x0002.rgi[0] = (long)(ht + -1);
    for (i = 1; i < 5; i = i + 1) {
      *(undefined2 *)(i * 4 + GlobalPD_0x2) = 0xffff;
      *(undefined2 *)(i * 4 + 0xb84) = 0xffff;
    }
    if (2 < (pl._4_2_ & 0xff)) {
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.iPlrMin = (short)abStack_46[ht];
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.iPlrMax = 0;
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = (uint)pl._4_2_ >> 10 & 1;
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = 0;
      cMines = CONCAT22(cMines._2_2_,(short)cMines);
      if (3 < (pl._4_2_ & 0xff)) {
        lVal = (char *)0x0;
        local_68 = 0;
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = local_32[(ht + -1) * 2];
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary = local_32[(ht + -1) * 2 + 1]
        ;
        EstMineralsMined(pl,&rglQuan,-1,0);
        cMines_00 = CONCAT22(cMines._2_2_,(short)cMines);
        GlobalPD.u_POPUPDATA_0x0002.rgi[4]._0_2_ = (&rglQuan)[(ht + -1) * 2];
        GlobalPD.u_POPUPDATA_0x0002.rgi[4]._2_2_ = *(undefined2 *)(&lpfl__20 + ht + -1);
        cMines = cMines_00;
        if (pl._2_2_ == -1) {
          for (ifl = 0; cMines = cMines_00, ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
            pFVar4 = ((FLEET **)rglpfl)[ifl];
            iVar6 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
            lpfl__98 = (FLEET *)CONCAT22(iVar6,pFVar4);
            if ((pFVar4 == (FLEET *)0x0) && (iVar6 == 0)) break;
            if ((pFVar4->idPlanet == pl._0_2_) &&
               (((pFVar4->iPlayer == idPlayer && ((pFVar4->wFlags_0x4 >> 10 & 1) == 0)) &&
                ((*(uint *)&((PLORD *)pFVar4->lpplord)[2].iordMax & 0xf) == 3)))) {
              cMines_00 = CMineFromLpfl((FLEET *)CONCAT22(iVar6,pFVar4));
              if (0 < cMines_00) {
                cMines = cMines_00;
                EstMineralsMined(pl,rglT,cMines_00,0);
                bVar10 = CARRY2((uint)lVal,rglT[(ht + -1) * 2]);
                lVal = (char *)((int)lVal + rglT[(ht + -1) * 2]);
                local_68 = local_68 + rglT[(ht + -1) * 2 + 1] + (uint)bVar10;
                cMines_00 = cMines;
              }
            }
          }
          if ((-1 < local_68) && ((0 < local_68 || (lVal != (char *)0x0)))) {
            GlobalPD.u_POPUPDATA_0x0002.rgi[4]._0_2_ = lVal;
            GlobalPD.u_POPUPDATA_0x0002.rgi[4]._2_2_ = local_68;
          }
        }
      }
    }
    Popup(hwndMine,x,y);
    break;
  case 5:
    iChecked = -1;
    rgi[0] = 100;
    rgi[1] = 500;
    rgi[2] = 1000;
    rgi[3] = 0x9c4;
    rgi[4] = 5000;
    rgi[5] = 0x1d4c;
    rgi[6] = 10000;
    lVal = (char *)rgbCur + 0x288;
    local_68 = 30000;
    for (cMines._0_2_ = 0; (short)cMines < 9; cMines._0_2_ = (short)cMines + 1) {
      _wsprintf((char *)((int)&cMines + (short)cMines * 10 + 2),PCTDKT,rgi[(short)cMines]);
      psz[(short)cMines] = (char *)((int)&cMines + (short)cMines * 10 + 2);
      if (rgi[(short)cMines] == cMinGrafMax) {
        iChecked = (short)cMines;
      }
    }
    cMines._0_2_ = PopupMenu(hwndMine,x,y,9,(long *)0x0,psz,iChecked,1);
    if (((short)cMines != -1) && (rgi[(short)cMines] != cMinGrafMax)) {
      cMinGrafMax = rgi[(short)cMines];
      InvalidateRect(hwndMine,(RECT *)0x0,1);
      if ((grbitScan & 0xf) == 1) {
        InvalidateRect(hwndScanner,(RECT *)0x0,1);
      }
    }
    break;
  case 6:
  case 7:
  case 8:
    FLookupPlanet(sel.scan.idpl,pl + 6);
    GlobalPD.grPopup = 5;
    GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = ht + -6;
    GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = pl._6_2_;
    if ((local_44 & 0xff) < 3) {
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = -1;
    }
    else {
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = (short)acStack_42[ht];
    }
    if (((local_44 & 0xff) < 3) ||
       (sVar5 = FCanTerraformLppl(pl + 6,&rgMin,rglT + 4,pl,1), sVar5 == 0)) {
MINE_NoTerra:
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = -1;
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = -1;
    }
    else {
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate =
           (&rgMin)[GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2];
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory =
           rglT[GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 + 4];
      if (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate == 0xffff) {
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate =
             GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur;
      }
      if (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory == 0xffff) {
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory =
             GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur;
      }
      if (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate ==
          GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory) goto MINE_NoTerra;
    }
    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary =
         (short)*(char *)(idPlayer * 0xc0 + 0x59b2 +
                         GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2);
    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.iPlrMin =
         (short)*(char *)(idPlayer * 0xc0 + 0x59b5 +
                         GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2);
    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.iPlrMax =
         (short)*(char *)(idPlayer * 0xc0 + 0x59b8 +
                         GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2);
    Popup(hwndMine,x,y);
    break;
  case 9:
    if (msg == 0x204) {
      PopupMineralScanChoices(hwndMine,x,y);
    }
    else {
      psVar7 = (short *)&sel.scan;
      pSVar8 = &scan;
      for (iVar6 = 8; iVar6 != 0; iVar6 = iVar6 + -1) {
        pSVar2 = pSVar8;
        pSVar8 = &(pSVar8->pt).y;
        psVar1 = psVar7;
        psVar7 = psVar7 + 1;
        (pSVar2->pt).x = *psVar1;
      }
      scan.iwp = 0;
      if (scan.grobj == grobjThing) {
        rglQuan = (PLPROD *)((int)(ushort *)scan.ith + 1);
        goto LAB_1028_4113;
      }
LAB_1028_4192:
      if (scan.grobj == grobjFleet) {
        rglQuan = (PLPROD *)((int)(ushort *)scan.ifl + 1);
      }
      else {
        rglQuan = (PLPROD *)0x0;
      }
      for (; (int)rglQuan < cFleet; rglQuan = (PLPROD *)((int)&rglQuan->wFlags + 1)) {
                    /* WARNING: Load size is inaccurate */
        pFVar4 = ((FLEET **)rglpfl)[(int)rglQuan];
        iVar6 = *(int *)((int)((FLEET **)rglpfl + (int)rglQuan) + 2);
        lpfl__20 = (FLEET *)CONCAT22(iVar6,pFVar4);
        if (((pFVar4 == (FLEET *)0x0) && (iVar6 == 0)) ||
           ((scan.pt.x == (&pFVar4->pt)->x && (scan.pt.y == (pFVar4->pt).y)))) break;
      }
      if ((int)rglQuan < cFleet) {
        scan.ifl = (short)rglQuan;
        scan.grobj = grobjFleet;
        idNew = ((FLEET **)rglpfl)[(int)rglQuan]->id;
        rgMin = (uint)(((FLEET *)((FLEET **)rglpfl)[(int)rglQuan])->iPlayer ==
                      idPlayer);
      }
      else {
        if ((scan.grobjFull & grobjThing) != grobjNone) {
          rglQuan = (PLPROD *)0x0;
          goto LAB_1028_4113;
        }
        if ((scan.grobjFull & grobjPlanet) == grobjNone) {
          do {
            for (rglQuan = (PLPROD *)0x0; (int)rglQuan < cFleet;
                rglQuan = (PLPROD *)((int)&rglQuan->wFlags + 1)) {
                    /* WARNING: Load size is inaccurate */
              pFVar4 = ((FLEET **)rglpfl)[(int)rglQuan];
              iVar6 = *(int *)((int)((FLEET **)rglpfl + (int)rglQuan) + 2);
              lpfl__20 = (FLEET *)CONCAT22(iVar6,pFVar4);
              if (((pFVar4 == (FLEET *)0x0) && (iVar6 == 0)) ||
                 ((scan.pt.x == (&pFVar4->pt)->x && (scan.pt.y == (pFVar4->pt).y)))) break;
            }
            if ((rglQuan != (PLPROD *)cFleet) ||
               ((scan.grobjFull & grobjThing) == grobjNone)) {
              scan.grobj = grobjFleet;
              scan.ifl = (short)rglQuan;
              idNew = ((FLEET **)rglpfl)[(int)rglQuan]->id;
              rgMin = (uint)(((FLEET *)((FLEET **)rglpfl)[(int)rglQuan])->iPlayer ==
                            idPlayer);
              goto MINE_ChangeIt;
            }
            rglQuan = (PLPROD *)0x0;
LAB_1028_4113:
            for (; (int)rglQuan < cThing; rglQuan = (PLPROD *)((int)&rglQuan->wFlags + 1)) {
              local_2c = scan.pt.x;
              local_2a = scan.pt.y;
              if (((&((THING *)lpThings)[(int)rglQuan].pt)->x == scan.pt.x) &&
                 (((THING *)lpThings)[(int)rglQuan].pt.y == scan.pt.y)) break;
            }
            if ((int)rglQuan < cThing) {
              scan.ith = (short)rglQuan;
              scan.grobj = grobjThing;
              idNew = ((THING *)lpThings + (int)rglQuan)->idFull;
              rgMin = 0;
              goto MINE_ChangeIt;
            }
            if ((scan.grobjFull & grobjPlanet) != grobjNone) break;
            if ((scan.grobjFull & grobjFleet) == grobjNone) {
              if ((scan.grobjFull & grobjThing) == grobjNone) goto LAB_1028_4192;
              rglQuan = (PLPROD *)0x0;
              goto LAB_1028_4113;
            }
          } while( true );
        }
        scan.grobj = grobjPlanet;
        idNew = scan.idpl;
        lppl = LpplFromId(scan.idpl);
        iVar6 = (int)((ulong)lppl >> 0x10);
        if (((PLANET *)lppl == (PLANET *)0x0) && (iVar6 == 0)) {
          rgMin = 0;
        }
        else {
          rgMin = (uint)(((PLANET *)lppl)->iPlayer == idPlayer);
        }
      }
MINE_ChangeIt:
      if ((rgMin == 0) || (sel.grobj != grobjFleet)) {
        scan.iwp = sel.scan.iwp;
      }
      ChangeScanSel(&scan,2);
      if (rgMin != 0) {
        RedrawScanSel(0,0);
        ChangeMainObjSel(scan.grobj,idNew);
        RedrawScanSel(0,1);
      }
    }
    break;
  case 10:
    if (sel.scan.grobj == grobjPlanet) {
      lppl = LpplFromId(sel.scan.idpl);
      GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = ((PLANET *)lppl)->iPlayer;
    }
    else if (sel.scan.grobj == grobjThing) {
      GlobalPD.u_POPUPDATA_0x0002.rgi[0] =
           CONCAT22(GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2,
                    ((THING *)lpThings + sel.scan.ith)->idFull >> 9) & 0xffff000f;
    }
    else {
      GlobalPD.u_POPUPDATA_0x0002.rgi[0] =
           CONCAT22(GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2,
                    (uint)((FLEET **)rglpfl)[sel.scan.ifl]->id >> 9) & 0xffff000f;
    }
    GlobalPD.grPopup = 2;
    Popup(hwndMine,x,y);
    break;
  case 0xb:
    if (msg == 0x204) {
                    /* WARNING: Load size is inaccurate */
      lpfl = (FLEET *)CONCAT22(*(undefined2 *)
                                ((int)((FLEET **)rglpfl + sel.scan.ifl) + 2),
                               ((FLEET **)rglpfl)[sel.scan.ifl]);
      c = 0;
      for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
        if (0 < ((FLEET *)lpfl)->rgcsh[ishdef]) {
          rgid[c] = ishdef;
          iVar6 = ((FLEET *)lpfl)->iPlayer * 4;
          __fstrcpy(rgsz + c * 0x20,
                            (char *)CONCAT22(*(undefined2 *)(iVar6 + 0x100),
                                             (char *)(*(int *)(iVar6 + rglpshdef) + ishdef * 0x93 +
                                                     8)));
          rgpsz[c] = rgsz + c * 0x20;
          c = c + 1;
        }
      }
      if (c < 2) {
        c = 0;
      }
      else {
        c = PopupMenu(hwndMine,x,y,c,(long *)0x0,rgpsz,-1,1);
        if (c == -1) {
          return;
        }
      }
      GlobalPD.grPopup = 0xb;
      uVar9 = (undefined2)((ulong)lpfl >> 0x10);
      iVar6 = ((FLEET *)lpfl)->iPlayer * 4;
      GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = *(undefined2 *)(iVar6 + 0x100);
      GlobalPD.u_POPUPDATA_0x0002.lpfl._0_2_ =
           (FLEET *)(*(int *)(iVar6 + rglpshdef) + rgid[c] * 0x93);
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate =
           (short)(idPlayer != ((FLEET *)lpfl)->iPlayer);
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = 0;
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = 0;
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary = 1;
    }
    else {
      GlobalPD.grPopup = 3;
      GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst =
           *(undefined2 *)((FLEET **)rglpfl + sel.scan.ifl);
      GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 =
           *(int *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur =
           (short)((*(uint *)((int)GlobalPD.u_POPUPDATA_0x0002.lpfl._0_2_ + 4) & 0xff) == 7);
      GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = 0xff;
    }
    Popup(hwndMine,x,y);
    break;
  case 0xc:
    GlobalPD.grPopup = 7;
    GlobalPD.u_POPUPDATA_0x0002.dxOut = sel.scan.idpl;
    Popup(hwndMine,x,y);
    break;
  case 0xd:
    GlobalPD.grPopup = 0xb;
    lppl__8 = LpplFromId(sel.scan.idpl);
    uVar9 = (undefined2)((ulong)lppl__8 >> 0x10);
    pPVar3 = (PLANET *)lppl__8;
    iVar6 = pPVar3->iPlayer * 4;
    GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = *(undefined2 *)(iVar6 + 0x14e);
    GlobalPD.u_POPUPDATA_0x0002.lpfl._0_2_ =
         (FLEET *)(*(int *)(iVar6 + rglpshdefSB) + (*(uint *)&pPVar3->lStarbase & 0xf) * 0x93);
    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate =
         (short)(idPlayer != pPVar3->iPlayer);
    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = 1;
    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = 0;
    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary = 1;
    Popup(hwndMine,x,y);
    break;
  case 0xe:
    pFVar4 = (FLEET *)(uint)*(byte *)(*(byte *)((int)&((THING *)lpThings)
                                                      [sel.scan.ith].u_THING_0x0006 + 6) +
                                     0x50a);
    rgMin = rgMin & 0xff00 | (uint)pFVar4;
    lpfl__20 = (FLEET *)CONCAT22(0x100,pFVar4);
    FLookupPart((PART *)((int)&lpfl__20 + 2));
    GlobalPD.grPopup = 9;
                    /* WARNING: Ignoring partial resolution of indirect */
    GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = lpfl__20._2_2_;
                    /* WARNING: Ignoring partial resolution of indirect */
    GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = rgMin;
    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = (short)(PLANET *)lppl;
    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = lppl._2_2_;
    Popup(hwndMine,x,y);
  }
  return;
}



// ======================================================================
// Function: SetMineralTitleBar
// Address: 1028:47dc
// Segment: MEMORY_MINE
// ======================================================================


void SetMineralTitleBar(HWND hwnd)

{
  short sVar1;
  uint uVar2;
  undefined2 unaff_SS;
  RECT rc;
  short grobj;
  char *psz;
  short fVisCB;
  char szSummary [40];
  char szDeepSpace [42];
  
  fVisCB = 0;
  CchGetString(idsDeepSpace,szDeepSpace);
  CchGetString(idsSummary,szSummary);
  grobj = sel.scan.grobjFull;
  if (sel.scan.grobj != grobjOther) {
    grobj = sel.scan.grobj;
  }
  if ((grobj & grobjPlanet) == grobjNone) {
    if ((grobj & grobjFleet) == grobjNone) {
      if ((grobj & grobjThing) == grobjNone) {
        psz = szDeepSpace;
      }
      else if (sel.scan.ith != -1) {
        fVisCB = 1;
        psz = PszGetThingName(((THING *)lpThings + sel.scan.ith)->idFull);
        _strcat(psz,szSummary);
      }
    }
    else if (sel.scan.ifl != -1) {
      psz = PszGetFleetName(((FLEET **)rglpfl)[sel.scan.ifl]->id);
      _strcat(psz,szSummary);
    }
  }
  else if (sel.scan.idpl != -1) {
    psz = PszGetPlanetName(sel.scan.idpl);
    _strcat(psz,szSummary);
  }
  _strcpy((char *)szMineralTitle,psz);
  InvalidateRect(hwnd,(RECT *)0x0,1);
  if (fVisCB != 0) {
    if ((((((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0) &&
         (*(char *)((int)&((THING *)lpThings)[sel.scan.ith].u_THING_0x0006 + 6) ==
          '\0')) &&
        ((((THING *)lpThings + sel.scan.ith)->idFull >> 9 & 0xf) == idPlayer
        )) && (sVar1 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv),
              sVar1 == raMines)) {
      fVisCB = 1;
    }
    else {
      fVisCB = 0;
    }
  }
  if (fVisCB != 0) {
    SendMessage(hwndMineCB,0x401,
                (uint)(*(char *)((int)&((THING *)lpThings)[sel.scan.ith].
                                       u_THING_0x0006 + 7) != '\0'),0);
  }
  GetClientRect(hwnd,&rc);
  if (fVisCB == 0) {
    uVar2 = 0x80;
  }
  else {
    uVar2 = 0x40;
  }
  SetWindowPos(hwndMineCB,0,0x50,rc.bottom + dyArial8 * -2,rc.right + -0x58,
               dyArial8 + 4,uVar2 | 4);
  return;
}



// ======================================================================
// Function: DrawSelectionArrow
// Address: 1028:4a68
// Segment: MEMORY_MINE
// ======================================================================


void DrawSelectionArrow(HDC hdc,RECT *prc,short fEnabled)

{
  HDC HVar1;
  HGDIOBJ HVar2;
  int iVar3;
  short sVar4;
  short sVar5;
  short xCtr;
  HDC hdcMem;
  HBITMAP hbmpSav;
  
  HVar1 = CreateCompatibleDC(hdc);
  HVar2 = SelectObject(HVar1,hbmpScanner);
  iVar3 = (prc->right - prc->left) / 2 + prc->left;
  BitBlt(hdc,iVar3 + -5,(prc->bottom - prc->top >> 1) + prc->top + -5,0xb,0xc,HVar1,0x23,0x39,
         0x8800c6);
  if (fEnabled == 0) {
    sVar4 = 0;
    sVar5 = 0x2d;
  }
  else {
    sVar4 = 0x18;
    sVar5 = 0x39;
  }
  BitBlt(hdc,iVar3 + -5,(prc->bottom - prc->top >> 1) + prc->top + -5,0xb,0xc,HVar1,sVar4,sVar5,
         0xee0086);
  SelectObject(HVar1,HVar2);
  DeleteDC(HVar1);
  return;
}



// ======================================================================
// Function: DrawDiamond
// Address: 1028:4b60
// Segment: MEMORY_MINE
// ======================================================================


void DrawDiamond(HDC hdc,RECT *prc,HBRUSH hbr)

{
  int iVar1;
  int iVar2;
  int iVar3;
  HGDIOBJ HVar4;
  short xCur;
  short dx;
  short xCtr;
  short yBot;
  short yTop;
  HBRUSH hbrSav;
  
  iVar3 = (prc->right - prc->left) / 2 + prc->left;
  yTop = prc->top;
  iVar1 = prc->bottom;
  HVar4 = SelectObject(hdc,hbrButtonHilite);
  yBot = iVar1 + -2;
  xCur = iVar3;
  while (yTop = yTop + 1, xCur = xCur + -1, yTop <= yBot) {
    PatBlt(hdc,xCur,yTop,2,1,0xf00021);
    PatBlt(hdc,xCur,yBot,2,1,0xf00021);
    yBot = yBot + -1;
  }
  SelectObject(hdc,hbrButtonShadow);
  PatBlt(hdc,iVar3,prc->top,1,1,0xf00021);
  PatBlt(hdc,iVar3,prc->bottom + -1,1,1,0xf00021);
  yTop = prc->top;
  xCur = iVar3;
  yBot = prc->bottom + -2;
  while (yTop = yTop + 1, yTop <= yBot) {
    PatBlt(hdc,xCur,yTop,2,1,0xf00021);
    PatBlt(hdc,xCur,yBot,2,1,0xf00021);
    xCur = xCur + 1;
    yBot = yBot + -1;
  }
  iVar1 = prc->top;
  iVar2 = prc->bottom;
  dx = 1;
  SelectObject(hdc,hbr);
  xCur = iVar3;
  yBot = iVar2 + -5;
  yTop = iVar1 + 4;
  while (yTop <= yBot) {
    PatBlt(hdc,xCur,yTop,dx,1,0xf00021);
    PatBlt(hdc,xCur,yBot,dx,1,0xf00021);
    dx = dx + 2;
    xCur = xCur + -1;
    yBot = yBot + -1;
    yTop = yTop + 1;
  }
  SelectObject(hdc,HVar4);
  return;
}



// ======================================================================
// Function: FOtherStuffAtScanSel
// Address: 1028:4d6e
// Segment: MEMORY_MINE
// ======================================================================


short FOtherStuffAtScanSel(void)

{
  int iVar1;
  int iVar2;
  short sVar3;
  undefined2 uVar4;
  bool bVar5;
  FLEET *lpfl;
  THING *lpth;
  short i;
  short c;
  
  if ((sel.scan.idpl == -1) ||
     ((sel.scan.ifl == -1 && (sel.scan.ith == -1)))) {
    if (sel.scan.ifl != -1) {
      if (sel.scan.ith != -1) {
        return 1;
      }
      c = 1;
      for (i = 0; i < cFleet; i = i + 1) {
        iVar1 = *(int *)((FLEET **)rglpfl + i);
        iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        if ((iVar1 == 0) && (iVar2 == 0)) break;
        if ((*(int *)(iVar1 + 8) == sel.scan.pt.x) &&
           ((*(int *)(iVar1 + 10) == sel.scan.pt.y && (bVar5 = c == 0, c = c + -1, bVar5))
           )) {
          return 1;
        }
      }
    }
    if (sel.scan.ith != -1) {
      c = 1;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      while ((THING *)lpth < (THING *)lpThings + cThing) {
        uVar4 = (undefined2)((ulong)lpth >> 0x10);
        if ((((&((THING *)lpth)->pt)->x == sel.scan.pt.x) &&
            ((((THING *)lpth)->pt).y == sel.scan.pt.y)) &&
           (bVar5 = c == 0, c = c + -1, bVar5)) {
          return 1;
        }
        lpth = (THING *)CONCAT22(uVar4,(THING *)lpth + 1);
      }
    }
    sVar3 = 0;
  }
  else {
    sVar3 = 1;
  }
  return sVar3;
}



// ======================================================================
// Function: PopupMineralScanChoices
// Address: 1028:4ecc
// Segment: MEMORY_MINE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10285231) */
/* WARNING: Removing unreachable block (ram,0x10285166) */

void PopupMineralScanChoices(HWND hwnd,short x,short y)

{
  short *psVar1;
  SCAN *pSVar2;
  ushort uVar3;
  FLEET *pFVar4;
  short sVar5;
  int iVar6;
  short *psVar7;
  SCAN *pSVar8;
  undefined2 uVar9;
  undefined2 unaff_SS;
  SCAN scan;
  short iChecked;
  short idNew;
  ushort rgid;
  uint local_1ac [199];
  THING *lpthMac;
  undefined2 local_1c;
  FLEET *lpfl;
  THING *lpth;
  short c;
  short i;
  PLANET *lppl;
  short fOurs;
  short id;
  short fSep;
  
  iChecked = -1;
  if (sel.scan.idpl == -1) {
    c = 0;
  }
  else {
    local_1ac[0] = sel.scan.idpl >> 0xf;
    rgid = sel.scan.idpl;
    local_1ac[1] = 0xffff;
    local_1ac[2] = 0xffff;
    c = 2;
    if (sel.scan.grobj == grobjPlanet) {
      iChecked = 0;
    }
  }
  for (i = 0; sVar5 = c, i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar4 = ((FLEET **)rglpfl)[i];
    iVar6 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    lpfl = (FLEET *)CONCAT22(iVar6,pFVar4);
    if ((pFVar4 == (FLEET *)0x0) && (iVar6 == 0)) break;
    if ((sel.scan.pt.x == (&pFVar4->pt)->x) && (sel.scan.pt.y == (pFVar4->pt).y)
       ) {
      if ((sel.scan.grobj == grobjFleet) &&
         (((FLEET **)rglpfl)[sel.scan.ifl]->id == lpfl->id)) {
        iChecked = c;
      }
      uVar3 = lpfl->id;
      iVar6 = c * 2;
      c = c + 1;
      (&rgid)[iVar6] = uVar3;
      local_1ac[sVar5 * 2] = (int)uVar3 >> 0xf | 0x8000;
      if (99 < c) break;
    }
  }
  if ((c == 2) && (sel.scan.idpl != -1)) {
    c = 1;
  }
  fSep = (short)(c == 0);
  lpthMac = (THING *)lpThings + cThing;
  local_1c = lpThings._2_2_;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while (sVar5 = c, (THING *)lpth < lpthMac) {
    uVar9 = (undefined2)((ulong)lpth >> 0x10);
    if ((sel.scan.pt.x == (&((THING *)lpth)->pt)->x) &&
       (sel.scan.pt.y == (((THING *)lpth)->pt).y)) {
      if (fSep == 0) {
        iVar6 = c * 2;
        c = c + 1;
        (&rgid)[iVar6] = 0xffff;
        local_1ac[sVar5 * 2] = 0xffff;
        fSep = 1;
      }
      sVar5 = c;
      if ((sel.scan.grobj == grobjThing) &&
         (((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12 == sel.scan.ith)) {
        iChecked = c;
      }
      iVar6 = c * 2;
      c = c + 1;
      (&rgid)[iVar6] = lpth->idFull;
      local_1ac[sVar5 * 2] = 0x2000;
    }
    lpth = (THING *)lpth + 1;
  }
  i = PopupMenu(hwnd,x,y,c,&rgid,(char **)0x0,iChecked,1);
  if (-1 < i) {
    psVar7 = (short *)&sel.scan;
    pSVar8 = &scan;
    for (iVar6 = 8; iVar6 != 0; iVar6 = iVar6 + -1) {
      pSVar2 = pSVar8;
      pSVar8 = &(pSVar8->pt).y;
      psVar1 = psVar7;
      psVar7 = psVar7 + 1;
      (pSVar2->pt).x = *psVar1;
    }
    if ((local_1ac[i * 2] & 0x8000) == 0) {
      if ((local_1ac[i * 2] & 0x2000) == 0) {
        scan.grobj = grobjPlanet;
        idNew = sel.scan.idpl;
        lppl = LpplFromId(sel.scan.idpl);
        fOurs = (short)(((PLANET *)lppl)->iPlayer == idPlayer);
      }
      else {
        scan.grobj = grobjThing;
        lpthMac = (THING *)lpThings + cThing;
        local_1c = lpThings._2_2_;
        lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
        while (((THING *)lpth < (THING *)lpThings + cThing &&
               (lpth->idFull != (&rgid)[i * 2]))) {
          lpth = (THING *)lpth + 1;
        }
        scan.ith = ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12;
        idNew = lpth->idFull;
        fOurs = 0;
      }
    }
    else {
      scan.grobj = grobjFleet;
      idNew = (&rgid)[i * 2];
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar4 = ((FLEET **)rglpfl)[i];
        iVar6 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar6,pFVar4);
        if (((pFVar4 == (FLEET *)0x0) && (iVar6 == 0)) || (lpfl->id == idNew)) break;
      }
      scan.ifl = i;
      fOurs = (short)(((FLEET *)lpfl)->iPlayer == idPlayer);
      id = idNew;
    }
    ChangeScanSel(&scan,2);
    if (fOurs != 0) {
      RedrawScanSel(0,0);
      ChangeMainObjSel(scan.grobj,idNew);
      RedrawScanSel(0,1);
    }
  }
  return;
}



// ======================================================================
// Function: EstMineralsMined
// Address: 1028:5362
// Segment: MEMORY_MINE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10285712) */
/* WARNING: Removing unreachable block (ram,0x102854bf) */
/* WARNING: Removing unreachable block (ram,0x102856b7) */
/* WARNING: Removing unreachable block (ram,0x102856ca) */
/* WARNING: Removing unreachable block (ram,0x102854c4) */
/* WARNING: Removing unreachable block (ram,0x102856cf) */
/* WARNING: Removing unreachable block (ram,0x102856ee) */
/* WARNING: Removing unreachable block (ram,0x102856f3) */
/* WARNING: Removing unreachable block (ram,0x10285717) */
/* WARNING: Removing unreachable block (ram,0x1028582c) */
/* WARNING: Removing unreachable block (ram,0x1028563d) */
/* WARNING: Removing unreachable block (ram,0x10285775) */
/* WARNING: Removing unreachable block (ram,0x10285806) */

void EstMineralsMined(PLANET *lppl,long *plQuan,long cMines,short fApply)

{
  uint *puVar1;
  byte bVar2;
  FLEET *pFVar3;
  int iVar4;
  uint uVar5;
  uint uVar6;
  short sVar7;
  PLANET *pPVar8;
  ushort unaff_DI;
  undefined2 uVar9;
  ulong uVar10;
  long lVar11;
  long lVar12;
  long cMines_00;
  undefined2 uVar13;
  uint uVar14;
  undefined2 uVar15;
  FLEET *lpfl;
  short ifl;
  uint rglQuan [2];
  undefined4 lLeft;
  uint lConc;
  undefined2 local_20;
  short lMineEff;
  int local_1c;
  undefined4 lMine;
  short fRemote;
  short fMacintosh;
  undefined4 lQuan;
  short i;
  undefined4 lQuanAct;
  undefined4 lQuanRem;
  
  fRemote = (short)(cMines != -1);
  uVar9 = (undefined2)((ulong)lppl >> 0x10);
  pPVar8 = (PLANET *)lppl;
  if ((pPVar8->iPlayer == -1) ||
     (sVar7 = GetRaceStat((PLAYER *)rgplr + pPVar8->iPlayer,rsMajorAdv),
     sVar7 != raMacintosh)) {
    fMacintosh = 0;
  }
  else {
    fMacintosh = 1;
  }
  if (cMines == -1) {
    if ((pPVar8->iPlayer == -1) ||
       (((int)pPVar8->rgwtMin[3] == 0 && (*(int *)((int)pPVar8->rgwtMin + 0xe) == 0)))) {
      for (i = 0; i < 3; i = i + 1) {
        *(undefined2 *)(plQuan + i) = 0xffff;
        *(undefined2 *)((int)(plQuan + i) + 2) = 0xffff;
      }
      return;
    }
    lMine._0_2_ = CMinesOperating(lppl);
    lMine._2_2_ = (short)lMine >> 0xf;
    if (fMacintosh == 0) {
      lMineEff = GetRaceStat((PLAYER *)rgplr + pPVar8->iPlayer,rsMineProd);
      local_1c = lMineEff >> 0xf;
    }
    else {
      lMineEff = 10;
      local_1c = 0;
    }
    cMines = CONCAT22(lMine._2_2_,(short)lMine);
  }
  else {
    lMineEff = 10;
    local_1c = 0;
  }
  lVar11 = CONCAT22(lQuan._2_2_,(uint)lQuan);
  lVar12 = CONCAT22(lLeft._2_2_,(undefined2)lLeft);
  i = 0;
  do {
    if (2 < i) {
      if ((fMacintosh != 0) && (fRemote == 0)) {
        for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar3 = ((FLEET **)rglpfl)[ifl];
          iVar4 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
          if ((pFVar3 == (FLEET *)0x0) && (iVar4 == 0)) {
            return;
          }
          if ((((pFVar3->idPlanet == lppl->id) && (pFVar3->iPlayer == pPVar8->iPlayer)) &&
              ((pFVar3->wFlags_0x4 >> 10 & 1) == 0)) &&
             ((pFVar3->cord < 2 && ((*(uint *)&((PLORD *)pFVar3->lpplord)[2].iordMax & 0xf) == 3))))
          {
            lLeft = lVar12;
            lQuan = lVar11;
            lMine = cMines;
            cMines_00 = CMineFromLpfl((FLEET *)CONCAT22(iVar4,pFVar3));
            lVar12 = lLeft;
            lVar11 = lQuan;
            cMines = lMine;
            if ((-1 < cMines_00) && ((0 < (int)((ulong)cMines_00 >> 0x10) || ((int)cMines_00 != 0)))
               ) {
              EstMineralsMined(lppl,rglQuan,cMines_00,fApply);
              for (i = 0; i < 3; i = i + 1) {
                uVar5 = rglQuan[i * 2];
                uVar6 = rglQuan[i * 2 + 1];
                puVar1 = (uint *)(plQuan + i);
                uVar14 = *puVar1;
                *puVar1 = *puVar1 + uVar5;
                puVar1 = (uint *)((int)(plQuan + i) + 2);
                *puVar1 = *puVar1 + uVar6 + (uint)CARRY2(uVar14,uVar5);
              }
              lVar12 = lLeft;
              lVar11 = lQuan;
              cMines = lMine;
              if (fApply != 0) {
                pFVar3->wFlags_0x4 = pFVar3->wFlags_0x4 & 0xdfff;
              }
            }
          }
        }
      }
      return;
    }
    lConc = (uint)pPVar8->rgMinConc[i];
    if (((lConc < 0x1e) && ((pPVar8->wFlags_0x4 >> 10 & 1) != 0)) &&
       ((fRemote == 0 || (fMacintosh != 0)))) {
      lConc = 0x1e;
    }
    local_20 = 0;
    lLeft = lVar12;
    lQuan = lVar11;
    lMine = cMines;
    uVar10 = __aFulmul(cMines,(ulong)lConc);
    lQuanAct = uVar10;
    if (fRemote == 0) {
      uVar15 = 0;
      uVar13 = 10;
      uVar10 = __aFulmul(uVar10,CONCAT22(local_1c,lMineEff));
      uVar10 = __aFldiv(uVar10,CONCAT22(uVar15,uVar13));
    }
    lQuan = uVar10;
    lVar11 = __aFlrem(uVar10,100);
    lQuanRem = lVar11;
    lVar11 = __aFldiv(lQuan,100);
    lVar12 = lLeft;
    if ((lQuanRem != 0) && (((uint)gd.grBits >> 1 & 1) != 0)) {
      lQuan = lVar11;
      sVar7 = Random(100);
      lVar11 = lQuan;
      lVar12 = CONCAT22(sVar7,(undefined2)lLeft);
      if (sVar7 < (int)lQuanRem) {
        lVar11 = lQuan + 1;
        lVar12 = CONCAT22(sVar7,(undefined2)lLeft);
      }
    }
    lQuan._2_2_ = (uint)((ulong)lVar11 >> 0x10);
    lQuan._0_2_ = (uint)lVar11;
    *(uint *)(plQuan + i) = (uint)lQuan;
    *(uint *)((int)(plQuan + i) + 2) = lQuan._2_2_;
    cMines = lMine;
    if (fApply != 0) {
      puVar1 = (uint *)(pPVar8->rgwtMin + i);
      uVar14 = *puVar1;
      *puVar1 = *puVar1 + (uint)lQuan;
      puVar1 = (uint *)((int)(pPVar8->rgwtMin + i) + 2);
      *puVar1 = *puVar1 + lQuan._2_2_ + (uint)CARRY2(uVar14,(uint)lQuan);
      lQuan = lVar11;
      lLeft = lVar12;
      uVar10 = __aFldiv(lQuanAct,100);
      lVar12 = lLeft;
      while( true ) {
        lVar11 = lQuan;
        lQuanAct = uVar10;
        cMines = lMine;
        if (((long)uVar10 < 1) || (pPVar8->rgMinConc[i] < 2)) goto LAB_1028_588f;
        rglQuan[0] = (uint)pPVar8->rgpctMinLevel[i];
        bVar2 = pPVar8->rgMinConc[i];
        lpfl._2_2_ = (uint)bVar2;
        if (rglQuan[0] == 0) {
          rglQuan[0] = 0x100;
        }
        rglQuan[1] = 0;
        if (bVar2 < 0x65) {
          if (bVar2 < 5) {
            lpfl._2_2_ = 10;
          }
          else if (bVar2 < 0x19) {
            lpfl._2_2_ = 0x19;
          }
        }
        else {
          lpfl._2_2_ = 100;
        }
        ifl = 0;
        lVar11 = 0x100;
        uVar14 = lpfl._2_2_;
        lLeft = lVar12;
        uVar10 = __aFulmul((ulong)rglQuan[0],0x30d4);
        lVar11 = __aFldiv(uVar10,lVar11);
        lVar12 = __aFldiv(lVar11,CONCAT22(ifl,uVar14));
        if ((long)lQuanAct < lVar12) break;
        uVar10 = lQuanAct - lVar12;
        pPVar8->rgMinConc[i] = pPVar8->rgMinConc[i] - 1;
        pPVar8->rgpctMinLevel[i] = 0;
      }
      lLeft = lVar12;
      lVar11 = __aFldiv(0x30d4,(ulong)lpfl._2_2_);
      lVar12 = __aFlshl(lVar11,unaff_DI);
      lVar12 = __aFldiv(lVar12,lVar11);
      if (lVar12 < 1) {
        lVar12 = 1;
      }
      if (CONCAT22(rglQuan[1],rglQuan[0]) <= lVar12) {
        lVar12 = CONCAT22(rglQuan[1] + -1 + (uint)(rglQuan[0] != 0),rglQuan[0] - 1);
      }
      pPVar8->rgpctMinLevel[i] = (byte)lVar12;
      lVar11 = lQuan;
      cMines = lMine;
      if (lVar12 == 0) {
        pPVar8->rgMinConc[i] = pPVar8->rgMinConc[i] - 1;
      }
    }
LAB_1028_588f:
    i = i + 1;
  } while( true );
}



