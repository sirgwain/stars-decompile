// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
//

// ======================================================================
// Function: MineWndProc
// Address: 1028:0000
// Segment: MEMORY_MINE
// ======================================================================

/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

long MineWndProc(HWND hwnd, WMType message, ushort wParam, long lParam)

{
    POINT       PVar1;
    char       *pcVar2;
    BOOL        BVar3;
    HCURSOR     HVar4;
    HDC         hdc_00;
    short       fEnabled;
    undefined1 *puVar5;
    undefined2  unaff_SI;
    ushort      unaff_DI;
    undefined2  unaff_SS;
    DWORD       DVar6;
    ulong       uVar7;
    LRESULT     LVar8;
    char       *pcVar9;
    undefined2  uVar10;
    ushort      in_stack_0000ffbe;
    int         local_40;
    int         local_3e;
    RECT        local_3c;
    uint        local_34;
    POINT       local_32;
    RECT        rc;
    PAINTSTRUCT ps;
    HDC         hdc;

    /* Segment:    6
       Offset:     0001d340
       Length:     59fa
       Min Alloc:  59fa
       Flags:      1d50
           Code
           Discardable
           Moveable
           Preload
           Impure (Non-shareable)
        */
    uVar10 = 0x1028;
    puVar5 = &stack0xffba;
    if (message == WM_CREATE) {
        uVar10 = 0x1120;
        pcVar9 = szButton;
        pcVar2 = PszGetCompressedString(idsDetonateMineFieldYear);
        hwndMineCB = CreateWindow((LPCSTR)CONCAT22(uVar10, pcVar9), pcVar2, 0x40000003, 100, 100, 0x96, dyArial8, hwnd, 0, hInst, 0);
        SendMessage(hwndMineCB, WM_SETFONT, rghfontArial8[1], 0);
        SetMineralTitleBar(hwnd);
    } else if (message == WM_PAINT) {
        hdc_00 = BeginPaint(hwnd, &ps);
        GetClientRect(hwnd, &rc);
        SetRect(&stack0xffbe, 4, 4, rc.right + -4, dyArial8 * 2 + -4);
        Draw3dFrame(hdc_00, &stack0xffbe, 0);
        local_32 = (POINT)SetTextColor(hdc_00, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
        local_3c._4_4_ = SetBkColor(hdc_00, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
        local_3c.top = _strlen((char *)szMineralTitle);
        local_34 = (local_3e - in_stack_0000ffbe) - 0x18;
        for (; 0 < local_3c.top; local_3c.top = local_3c.top - 1) {
            DVar6 = GetTextExtent(hdc_00, szMineralTitle, local_3c.top);
            if ((uint)DVar6 <= local_34)
                break;
        }
        RcCtrTextOut(hdc_00, &stack0xffbe, (char *)szMineralTitle, local_3c.top);
        SetTextColor(hdc_00, (COLORREF)local_32);
        SetBkColor(hdc_00, local_3c._4_4_);
        SetRect(&stack0xffbe, (local_3e - (local_3c.left - local_40)) + 2, local_40 + 3, local_3e + -4, local_3c.left + -2);
        fEnabled = FOtherStuffAtScanSel();
        DrawSelectionArrow(hdc_00, &stack0xffbe, fEnabled);
        rc.top = rc.top + dyArial8 * 2 + -4;
        DrawMineSurvey(hdc_00, &rc);
        EndPaint(hwnd, &ps);
    } else {
        if (message == WM_ERASEBKGND) {
            GetClientRect(hwnd, &rc);
            FillRect(wParam, &rc, hbrButtonFace);
            return 1;
        }
        if (message == WM_CTLCOLOR) {
            SetBkColor(wParam, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
            return (ulong)hbrButtonFace;
        }
        if (message == WM_SETCURSOR) {
            GetCursorPos(&local_32);
            ScreenToClient(hwnd, &local_32);
            GetClientRect(hwnd, &local_3c);
            uVar10 = 0x14f8;
            PVar1.y = local_32.y;
            PVar1.x = local_32.x;
            BVar3 = PtInRect(&local_3c, PVar1);
            if (BVar3 != 0) {
                uVar10 = 0x1028;
                local_34 = HtMineWindow(hwnd, local_32.x, local_32.y);
                if (local_34 != 0) {
                    HVar4 = hcurHand;
                    if (local_34 != 9) {
                        HVar4 = hcurArrowHelp;
                    }
                    SetCursor(HVar4);
                    return 1;
                }
            }
            puVar5 = &stack0xffb6;
        MINE_Default_7:
            *(HWND *)(puVar5 + -2) = hwnd;
            *(WMType *)(puVar5 + -4) = message;
            *(ushort *)(puVar5 + -6) = wParam;
            *(undefined2 *)(puVar5 + -8) = lParam._2_2_;
            *(HWND *)(puVar5 + -10) = (HWND)lParam;
            *(undefined2 *)(puVar5 + -0xc) = uVar10;
            *(undefined2 *)(puVar5 + -0xe) = 0x3a7;
            LVar8 = DefWindowProc(*(HWND *)(puVar5 + -2), *(UINT *)(puVar5 + -4), *(WPARAM *)(puVar5 + -6), *(LPARAM *)(puVar5 + -10));
            return LVar8;
        }
        if (message == WM_COMMAND) {
            if (((HWND)lParam == hwndMineCB) && (uVar7 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), in_stack_0000ffbe), (int)uVar7 == 0)) {
                LVar8 = SendMessage(hwndMineCB, WM_USER, 0, 0);
                local_32.x = (short)LVar8;
                local_34 = ((THING *)lpThings + sel.scan.ith)->idFull;
                local_32.y = local_32.x;
                WriteMemRt(0x2b, 4, &local_34);
                *(undefined1 *)((int)&((THING *)lpThings)[sel.scan.ith].u_THING_0x0006 + 7) = (char)local_32.y;
            }
        } else {
            if (((message != WM_LBUTTONDOWN) && (message != WM_LBUTTONDBLCLK)) && (message != WM_RBUTTONDOWN))
                goto MINE_Default_7;
            if (hwndPopup == 0) {
                uVar7 = __aFulshr(CONCAT22(wParam, message), unaff_DI);
                MineClick((HWND)lParam, (short)uVar7, message, wParam);
            }
        }
    }
    return 0;
}

// ======================================================================
// Function: InvalidateMineralBars
// Address: 1028:040a
// Segment: MEMORY_MINE
// ======================================================================

void InvalidateMineralBars(void)

{
    HDC        HVar1;
    HGDIOBJ    HVar2;
    char      *pcVar3;
    ushort     uVar4;
    int        iVar5;
    int        iVar6;
    uint       uVar7;
    undefined2 unaff_SS;
    DWORD      DVar8;
    DWORD      DVar9;
    undefined2 uVar10;
    HDC        HVar11;
    RECT       rc;
    short      dxPop;
    short      dx;
    RECT       rcPop;
    HFONT      hfontSav;
    short      dyRow;
    HDC        hdc;

    GetClientRect(hwndMine, &rc);
    HVar1 = GetDC(hwndMine);
    HVar2 = SelectObject(HVar1, rghfontArial8[0]);
    HVar11 = HVar1;
    pcVar3 = PszGetCompressedString(idsN999mr);
    DVar8 = GetTextExtent(HVar11, pcVar3, 5);
    rc.right = rc.right - ((int)DVar8 + 6);
    SelectObject(HVar1, rghfontArial8[1]);
    HVar11 = HVar1;
    pcVar3 = PszGetCompressedString(idsPopulation1000000);
    DVar8 = GetTextExtent(HVar11, pcVar3, 0x15);
    uVar10 = 0x1120;
    pcVar3 = rgszPlanetAttr[1];
    HVar11 = HVar1;
    uVar4 = _strlen(rgszPlanetAttr[1]);
    DVar9 = GetTextExtent(HVar11, (LPCSTR)CONCAT22(uVar10, pcVar3), uVar4);
    iVar5 = (int)DVar9 + 6;
    iVar6 = iVar5 * 4;
    if (iVar6 - rc.right == 0 || iVar6 < rc.right) {
        rc.left = rc.left + iVar5;
    } else {
        DVar9 = GetTextExtent(HVar1, rgszPlanetAttr[1], 4);
        rc.left = rc.left + (int)DVar9 + 6;
    }
    SelectObject(HVar1, HVar2);
    ReleaseDC(hwndMine, HVar1);
    rc.top = rc.top + dyArial8 * 2 + -4;
    rcPop.top = rc.top + 2;
    rcPop.bottom = rcPop.top + dyArial8;
    rcPop.right = rc.right;
    rcPop.left = rc.right - ((int)DVar8 + 6);
    InvalidateRect(hwndMine, &rcPop, 1);
    uVar7 = ((rc.bottom - rc.top) + dyArial8 * -4 + -2) / 6 + 1U & 0xfffe;
    rc.top = rc.top + (dyArial8 * 5 >> 1) + uVar7 * 3 + 1;
    rc.bottom = uVar7 * 3 + rc.top;
    InvalidateRect(hwndMine, &rc, 0);
    return;
}

// ======================================================================
// Function: GetMineFieldCounts
// Address: 1028:05ac
// Segment: MEMORY_MINE
// ======================================================================

void GetMineFieldCounts(ushort id, short *pithm, short *pcthm)

{
    short  sVar1;
    THING *lpthMac;
    THING *lpth;
    short  ithFound;
    short  cthTotal;

    ithFound = 0;
    cthTotal = 0;
    lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
    while ((THING *)lpth < (THING *)lpThings + cThing) {
        sVar1 = ithFound;
        if (((lpth->idFull >> 0xd == 0) && ((lpth->idFull >> 9 & 0xf) == idPlayer)) && (cthTotal = cthTotal + 1, sVar1 = cthTotal, lpth->idFull != id)) {
            sVar1 = ithFound;
        }
        ithFound = sVar1;
        lpth = (THING *)lpth + 1;
    }
    *pithm = ithFound;
    *pcthm = cthTotal;
    return;
}

// ======================================================================
// Function: DrawMineSurvey
// Address: 1028:065a
// Segment: MEMORY_MINE
// ======================================================================

/* WARNING: Variable defined which should be unmapped: cMines */
/* WARNING: Removing unreachable block (ram,0x102825f8) */
/* WARNING: Removing unreachable block (ram,0x1028101a) */
/* WARNING: Removing unreachable block (ram,0x10281e54) */
/* WARNING: Removing unreachable block (ram,0x10283270) */
/* WARNING: Removing unreachable block (ram,0x10281e94) */
/* WARNING: Removing unreachable block (ram,0x10280be1) */

void DrawMineSurvey(HDC hdc, RECT *prc)

{
    uint       *puVar1;
    int        *piVar2;
    PLAYER     *pPVar3;
    undefined2 *puVar4;
    undefined1  uVar5;
    FLEET      *pFVar6;
    uint        uVar7;
    POINT       pt;
    HDC         HVar8;
    short       sVar9;
    short      *psVar10;
    short       sVar11;
    char       *pcVar12;
    ushort      uVar13;
    int         iVar14;
    StringId    SVar15;
    uint        uVar16;
    int         iVar17;
    int         iVar18;
    int         iVar19;
    int         iVar20;
    int         iVar21;
    int         iVar22;
    THING      *pTVar23;
    undefined2  unaff_SI;
    PLAYER     *pPVar24;
    undefined2 *puVar25;
    undefined2  unaff_DI;
    undefined2  uVar26;
    undefined2  unaff_SS;
    bool        bVar27;
    COLORREF    CVar28;
    DWORD       DVar29;
    DWORD       DVar30;
    ulong       uVar31;
    long        lVar32;
    HGDIOBJ     HVar33;
    undefined2  uVar34;
    HDC         HVar35;
    undefined2  uVar36;
    short       sVar37;
    long        cMines;
    short       ifl;
    uint        local_1da;
    undefined4  local_1d8;
    undefined4  local_1d4;
    undefined4  local_1d0;
    short       dNum;
    short       xBeg;
    short       dx;
    short       dxLabels;
    short       rgMax[3];
    short       rgCost[3];
    short       iCur;
    short       dxRLabels;
    short       xR;
    short       dxNum;
    short       dxBar;
    short       c;
    short       yCur;
    short       xEnd;
    short       iMin;
    undefined2  local_1a6[83];
    char       *local_100;
    char        local_fe[24];
    undefined4  local_e6;
    uint        local_e2;
    undefined4  local_e0;
    uint        local_dc;
    uint        local_da;
    uint        local_d8;
    uint        local_d6;
    undefined1  local_d4[4];
    HGDIOBJ     local_d0;
    RECT        rc;
    long        l;
    short       grobj;
    char        szT[80];
    RECT        rcGauge;
    short       cch;
    char       *psz;
    short       bkMode;
    HDC         hdcMem;
    COLORREF    crBack;
    FLEET      *lpfl;
    short       i;
    short       sStack_56;
    long        rgl[3];
    short       c2;
    COLORREF    crFore;
    long        l2;
    HBRUSH      hbrSav;
    PLANET      pl;

    HVar8 = CreateCompatibleDC(hdc);
    CVar28 = SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
    crFore = SetTextColor(hdc, 0xffff);
    sVar9 = SetBkMode(hdc, 2);
    grobj = sel.scan.grobj;
    if (sel.scan.grobj == grobjOther) {
        if ((sel.scan.grobjFull & grobjPlanet) == grobjNone) {
            if ((sel.scan.grobjFull & grobjFleet) == grobjNone) {
                if ((sel.scan.grobjFull & grobjThing) == grobjNone) {
                    grobj = 0;
                } else {
                    grobj = 8;
                }
            } else {
                grobj = 2;
            }
        } else {
            grobj = 1;
        }
    }
    l2 = CONCAT22(l2._2_2_, (undefined2)l2);
    local_1d8 = CONCAT22(local_1d8._2_2_, (undefined2)local_1d8);
    local_1d4 = CONCAT22(local_1d4._2_2_, (undefined2)local_1d4);
    local_1d0 = CONCAT22(local_1d0._2_2_, (HDC)local_1d0);
    if (grobj == 0)
        goto MINE_FinishUp_5;
    if (grobj == 2) {
        local_d4 = (undefined1[4])((ulong)local_d4 & 0xffff);
        local_d0 = 0;
        l2 = CONCAT22(l2._2_2_, (undefined2)l2);
        local_1d8 = CONCAT22(local_1d8._2_2_, (undefined2)local_1d8);
        local_1d4 = CONCAT22(local_1d4._2_2_, (undefined2)local_1d4);
        local_1d0 = CONCAT22(local_1d0._2_2_, (HDC)local_1d0);
        if (sel.scan.ifl != -1) {
            local_d6 = prc->left + 6;
            local_d4._2_2_ = 0;
            local_d4._0_2_ = prc->top + 6;
            hbrSav = SelectObject(hdc, hbrButtonShadow);
            PatBlt(hdc, local_d6, local_d4._0_2_, 0x46, 2, 0xf00021);
            PatBlt(hdc, local_d6, local_d4._0_2_ + 2, 2, 0x44, 0xf00021);
            PatBlt(hdc, local_d6 + 0x10, local_d4._0_2_ + 0x44, 2, 0x26, 0xf00021);
            hbrSav = SelectObject(hdc, hbrButtonHilite);
            PatBlt(hdc, local_d6 + 2, local_d4._0_2_ + 0x44, 0xf, 1, 0xf00021);
            PatBlt(hdc, local_d6 + 1, local_d4._0_2_ + 0x45, 0xf, 1, 0xf00021);
            PatBlt(hdc, local_d6 + 0x34, local_d4._0_2_ + 0x44, 0x12, 2, 0xf00021);
            PatBlt(hdc, local_d6 + 0x44, local_d4._0_2_ + 2, 2, 0x42, 0xf00021);
            PatBlt(hdc, local_d6 + 0x45, local_d4._0_2_ + 1, 1, 1, 0xf00021);
            PatBlt(hdc, local_d6 + 0x11, local_d4._0_2_ + 0x68, 0x25, 2, 0xf00021);
            PatBlt(hdc, local_d6 + 0x10, local_d4._0_2_ + 0x69, 1, 1, 0xf00021);
            PatBlt(hdc, local_d6 + 0x34, local_d4._0_2_ + 0x46, 2, 0x22, 0xf00021);
            PatBlt(hdc, local_d6 + 2, local_d4._0_2_ + 2, 0x42, 0x42, 0x42);
            PatBlt(hdc, local_d6 + 0x12, local_d4._0_2_ + 0x44, 0x22, 0x24, 0x42);
            SelectObject(hdc, hbrSav);
            /* WARNING: Load size is inaccurate */
            pFVar6 = ((FLEET **)rglpfl)[sel.scan.ifl];
            iVar18 = *(int *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
            lpfl = (FLEET *)CONCAT22(iVar18, pFVar6);
            DrawFleetBitmap((FLEET *)CONCAT22(iVar18, pFVar6), hdc, local_d6 + 2, local_d4._0_2_ + 2, 0, -1, 0, 0, -1, 0);
            local_dc = *(uint *)((int)&rgplr[0].wMdPlr + ((uint)lpfl->id >> 9 & 0xf) * 0xc0) >> 3 & 0x1f;
            SelectPalette(hdc, vhpal, 0);
            RealizePalette(hdc);
            DibBlt(hdc, local_d6 + 0x13, local_d4._0_2_ + 0x47, 0x20, 0x20, hdibRaces, (local_dc & 7) << 5, (3 - ((int)local_dc >> 3)) * 0x20, 0x20, 0x20,
                   0xcc0020);
            SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
            SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
            SelectObject(hdc, rghfontArial8[1]);
            local_da = 0;
            local_d8 = 0;
            for (i = 0; i < 0x10; i = i + 1) {
                uVar16 = pFVar6->rgcsh[i];
                bVar27 = CARRY2(local_da, uVar16);
                local_da = local_da + uVar16;
                local_d8 = local_d8 + ((int)uVar16 >> 0xf) + (uint)bVar27;
            }
            CchGetString(idsShipCountLd, szT);
            sStack_56 = _wsprintf(szWork, szT, local_da, local_d8);
            TextOut(hdc, prc->left + 0x56, local_d4._0_2_, szWork, sStack_56);
            iVar14 = local_d4._0_2_ + dyArial8 + 2;
            local_d4._0_2_ = iVar14;
            if (((pFVar6->wFlags_0x4 & 0xff) == 7) || ((pFVar6->wFlags_0x4 & 0xff) == 4)) {
                lVar32 = WtFromLpfl((FLEET *)CONCAT22(iVar18, pFVar6));
                unique0x100044b9 = lVar32;
                sStack_56 = CchGetString(idsFuel2, szT);
                DVar29 = GetTextExtent(hdc, szT, sStack_56);
                c2 = CchGetString(idsCargo, (char *)szWork);
                l2 = GetTextExtent(hdc, szWork, c2);
                if ((long)DVar29 < l2) {
                    DVar29 = l2;
                }
                l._0_2_ = (int)DVar29;
                SetRect(&rcGauge, prc->left + 0x5a + (int)l, local_d4._0_2_, prc->right + -4, local_d4._0_2_ + dyArial8);
                if (rcGauge.left < rcGauge.right) {
                    TextOut(hdc, prc->left + 0x56, local_d4._0_2_, szT, sStack_56);
                    local_d4._0_2_ = local_d4._0_2_ + dyArial8 + 2;
                    TextOut(hdc, prc->left + 0x56, local_d4._0_2_, szWork, c2);
                    DrawFleetGauge(hdc, &rcGauge, (FLEET *)CONCAT22(iVar18, pFVar6), 4);
                    OffsetRc(&rcGauge, 0, dyArial8 + 4);
                    DrawFleetGauge(hdc, &rcGauge, (FLEET *)CONCAT22(iVar18, pFVar6), 5);
                    local_d4._0_2_ = local_d4._0_2_ + dyArial8 + 2;
                }
            } else {
                unique0x10003c5d = CONCAT22(*(undefined2 *)((int)&pFVar6->u_FLEET_0x002c + 2), (&pFVar6->u_FLEET_0x002c)->rgdv[0].dp);
            }
            if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
                SVar15 = idsFleetMassLdkt;
            } else {
                SVar15 = idsMassLdkt;
            }
            sStack_56 = CchGetString(SVar15, szT);
            sStack_56 = _wsprintf(szWork, szT, local_d4._2_2_, local_d0);
            TextOut(hdc, prc->left + 0x56, local_d4._0_2_, szWork, sStack_56);
            local_d4._0_2_ = (THING *)(local_d4._0_2_ + dyArial8 + 2);
            if ((pFVar6->wFlags_0x4 & 0xff) == 7) {
                psVar10 = (short *)(*(int *)&pFVar6->lpplord + 4);
                if (1 < pFVar6->cord) {
                    psVar10 = (short *)(*(int *)&pFVar6->lpplord + 0x16);
                }
                local_e0 = (short *)CONCAT22(*(undefined2 *)((int)&pFVar6->lpplord + 2), psVar10);
                if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
                    SVar15 = idsWaypointS;
                } else {
                    SVar15 = idsWpS;
                }
                CchGetString(SVar15, local_fe);
                if (pFVar6->cord == 1) {
                    pcVar12 = PszGetCompressedString(idsNone);
                    sStack_56 = _wsprintf(szT, local_fe, pcVar12, 0x1120);
                } else {
                    uVar34 = (undefined2)((ulong)local_e0 >> 0x10);
                    psVar10 = (short *)local_e0;
                    pcVar12 = PszGetLocName((uint)psVar10[3] >> 8 & (grobjThing | grobjOther | grobjFleet | grobjPlanet), psVar10[2], *local_e0, psVar10[1]);
                    sStack_56 = _wsprintf(szT, local_fe, pcVar12, 0x1120);
                }
                TextOut(hdc, prc->left + 0x56, local_d4._0_2_, szT, sStack_56);
                if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
                    SVar15 = idsWaypointTaskS;
                } else {
                    SVar15 = idsTaskS;
                }
                local_d4._0_2_ = (int)&((POINT *)(local_d4._0_2_ + 2))->x + dyArial8;
                CchGetString(SVar15, szT);
                pcVar12 = PszGetCompressedString((((short *)local_e0)[3] & 0xfU) + idsTaskHere);
                sStack_56 = _wsprintf(szWork, szT, pcVar12, 0x1120);
                TextOut(hdc, prc->left + 0x56, local_d4._0_2_, szWork, sStack_56);
                local_d4._0_2_ = local_d4._0_2_ + dyArial8 + 2;
                if (pFVar6->cord < 2) {
                    if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
                        SVar15 = idsWarpSpeedStopped;
                    } else {
                        SVar15 = idsWarpStopped;
                    }
                    sStack_56 = CchGetString(SVar15, (char *)szWork);
                } else if (((uint)((short *)local_e0)[3] >> 4 & 0xf) == 0xb) {
                    sStack_56 = CchGetString(idsUseStargate, (char *)szWork);
                } else {
                    if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
                        SVar15 = idsWarpSpeedD;
                    } else {
                        SVar15 = idsWarpD;
                    }
                    CchGetString(SVar15, szT);
                    sStack_56 = _wsprintf(szWork, szT, (uint)((short *)local_e0)[3] >> 4 & 0xf);
                }
                TextOut(hdc, prc->left + 0x56, local_d4._0_2_, szWork, sStack_56);
                local_d4._0_2_ = (THING *)(local_d4._0_2_ + dyArial8 + 2);
                lVar32 = CMineSweepFromLpfl((FLEET *)CONCAT22(iVar18, pFVar6));
                if (0 < lVar32) {
                    local_100 = PszGetCompressedString(idsFleetCanDestroyLdMinesPerYear);
                    sStack_56 = _wsprintf(szWork, local_100, (int)lVar32, (int)((ulong)lVar32 >> 0x10));
                    TextOut(hdc, prc->left + 0x56, local_d4._0_2_, szWork, sStack_56);
                    local_d4._0_2_ = (THING *)((int)&((POINT *)(local_d4._0_2_ + 2))->x + dyArial8);
                }
            } else if ((*(uint *)((int)&pFVar6->dirLong + 2) >> 4 & 1) != 0) {
                if ((*(uint *)((int)&pFVar6->dirLong + 2) & 0xf) == 0) {
                    if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
                        SVar15 = idsWarpSpeedStopped;
                    } else {
                        SVar15 = idsWarpStopped;
                    }
                    sStack_56 = CchGetString(SVar15, (char *)szWork);
                } else {
                    if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
                        SVar15 = idsWarpSpeedD;
                    } else {
                        SVar15 = idsWarpD;
                    }
                    CchGetString(SVar15, szT);
                    sStack_56 = _wsprintf(szWork, szT, *(uint *)((int)&pFVar6->dirLong + 2) & 0xf);
                }
                TextOut(hdc, prc->left + 0x56, local_d4._0_2_, szWork, sStack_56);
                local_d4._0_2_ = (THING *)((int)&((POINT *)(local_d4._0_2_ + 2))->x + dyArial8);
            }
            local_1d8 = CONCAT22(local_1d8._2_2_, (undefined2)local_1d8);
            local_1d4 = CONCAT22(local_1d4._2_2_, (undefined2)local_1d4);
            local_1d0 = CONCAT22(local_1d0._2_2_, (HDC)local_1d0);
        }
        goto MINE_FinishUp_5;
    }
    if (grobj != 8) {
        if (sel.scan.idpl != -1) {
            sVar11 = FLookupPlanet(sel.scan.idpl, &pl);
            if (sVar11 != 0) {
                local_e2 = 0;
                pPVar24 = (PLAYER *)rgplr + idPlayer;
                puVar25 = local_1a6;
                for (iVar18 = 0x60; iVar18 != 0; iVar18 = iVar18 + -1) {
                    puVar4 = puVar25;
                    puVar25 = puVar25 + 1;
                    pPVar3 = pPVar24;
                    pPVar24 = &pPVar24->cPlanet;
                    *puVar4 = *pPVar3;
                }
                rc.left = prc->left;
                rc.top = prc->top;
                rc.right = prc->right;
                rc.bottom = prc->bottom;
                sVar11 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv);
                if (((sVar11 == raTerra) && (pl.iPlayer != -1)) && ((idPlayer == pl.iPlayer || (*(char *)(idPlayer * 0xc0 + 0x5a12 + pl.iPlayer) == '\x01')))) {
                    for (c = 0; c < 3; c = c + 1) {
                        *(undefined1 *)(idPlayer * 0xc0 + 0x59b2 + c) = *(undefined1 *)(pl.iPlayer * 0xc0 + 0x59b2 + c);
                        *(undefined1 *)(idPlayer * 0xc0 + 0x59b5 + c) = *(undefined1 *)(pl.iPlayer * 0xc0 + 0x59b5 + c);
                        uVar5 = *(undefined1 *)(pl.iPlayer * 0xc0 + 0x59b8 + c);
                        local_1d0._2_2_ = CONCAT11((char)((uint)c >> 8), uVar5);
                        *(undefined1 *)(idPlayer * 0xc0 + 0x59b8 + c) = uVar5;
                    }
                }
                SelectObject(hdc, rghfontArial8[0]);
                HVar35 = hdc;
                pcVar12 = PszGetCompressedString(idsN999mr);
                DVar29 = GetTextExtent(HVar35, pcVar12, 5);
                SelectObject(hdc, rghfontArial8[1]);
                uVar34 = 0x1120;
                pcVar12 = rgszPlanetAttr[1];
                HVar35 = hdc;
                uVar13 = _strlen(rgszPlanetAttr[1]);
                DVar30 = GetTextExtent(HVar35, (LPCSTR)CONCAT22(uVar34, pcVar12), uVar13);
                dxLabels = (int)DVar30 + 6;
                if (dxLabels * 4 - rc.right != 0 && rc.right <= dxLabels * 4) {
                    local_e2 = 1;
                    DVar30 = GetTextExtent(hdc, rgszPlanetAttr[1], 4);
                    dxLabels = (int)DVar30 + 6;
                }
                sVar11 = rc.top;
                local_d8 = rc.left + dxLabels;
                iVar14 = rc.right - ((int)DVar29 + 6);
                local_1d0._2_2_ = dyArial8 * 4;
                local_da = ((rc.bottom - rc.top) + dyArial8 * -4 + -2) / 6 + 1U & 0xfffe;
                iVar18 = rc.top + 2;
                if ((pl.wFlags_0x4 >> 9 & 1) != 0) {
                    local_1d0._0_2_ = CreateCompatibleDC(hdc);
                    local_1d0._2_2_ = SelectObject((HDC)local_1d0, hbmpMono);
                    local_1d8 = SetTextColor(hdc, 0);
                    local_1d4 = SetBkColor(hdc, 0xffffff);
                    BitBlt(hdc, rc.right + -0x16, sVar11 + 4, 0xd, 0x10, (HDC)local_1d0, 0, 0xc, 0x8800c6);
                    SetTextColor(hdc, 0xffff);
                    SetBkColor(hdc, 0);
                    BitBlt(hdc, rc.right + -0x16, sVar11 + 4, 0xd, 0x10, (HDC)local_1d0, 0, 0xc, 0xee0086);
                    SetTextColor(hdc, local_1d8);
                    SetBkColor(hdc, local_1d4);
                    SelectObject((HDC)local_1d0, local_1d0._2_2_);
                    DeleteDC((HDC)local_1d0);
                }
                if (2 < (pl.wFlags_0x4 & 0xff)) {
                    sVar11 = CchGetString((local_e2 == 0) + idsVal, (char *)szWork);
                    DVar29 = GetTextExtent(hdc, szWork, sVar11);
                    dx = (short)DVar29;
                    SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
                    TextOut(hdc, local_d8, iVar18, szWork, sVar11);
                    dNum = PctPlanetDesirability(&pl, idPlayer);
                    sVar11 = _wsprintf(szWork, PCTDPCTPCT, dNum);
                    if (dNum < 0) {
                        uVar16 = 0xff;
                    } else {
                        uVar16 = 0x7f00;
                    }
                    SetTextColor(hdc, (ulong)uVar16);
                    TextOut(hdc, local_d8 + dx, iVar18, szWork, sVar11);
                    if (local_e2 == 0) {
                        DVar29 = GetTextExtent(hdc, szWork, sVar11);
                        dx = dx + (int)DVar29;
                        local_1d0._2_2_ = PctPlanetOptValue(&pl, idPlayer);
                        if (dNum < (int)local_1d0._2_2_) {
                            if (0 < (int)local_1d0._2_2_) {
                                if ((int)local_1d0._2_2_ < 0xb) {
                                    uVar16 = 0x7f7f;
                                } else {
                                    uVar16 = 0x7f00;
                                }
                                SetTextColor(hdc, (ulong)uVar16);
                            }
                            sVar11 = _wsprintf(szWork, " (%d%%)", local_1d0._2_2_);
                            TextOut(hdc, local_d8 + dx, iVar18, szWork, sVar11);
                        }
                    }
                }
                SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
                if (pl.iPlayer != -1) {
                    pcVar12 = PszGetCompressedString((local_e2 == 0) + idsPop);
                    _strcpy(szT, pcVar12);
                }
                if ((pl.wFlags_0x4 & 0xff) == 7) {
                    uVar13 = _strlen(szT);
                    uVar31 = __aFulmul(CONCAT22(pl.rgwtMin[3]._2_2_, (undefined2)pl.rgwtMin[3]), 100);
                    sVar11 = CommaFormatLong(szT + uVar13, uVar31);
                    RightTextOut(hdc, iVar14, iVar18, szT, uVar13 + sVar11, 0);
                } else if (pl.iPlayer == -1) {
                    sVar11 = CchGetString(idsUninhabited, szT);
                    RightTextOut(hdc, iVar14, iVar18, szT, sVar11, 0);
                } else {
                    if (2 < (pl.wFlags_0x4 & 0xff)) {
                        local_1d0 = __aFlshl(CONCAT22(unaff_SI, unaff_DI), (ushort)cMines);
                        _strcpy((char *)szWork, szT);
                        uVar13 = _strlen(szT);
                        if (local_1d0 < 1) {
                            iVar19 = CchGetString(idsMsg1264, (char *)szWork + uVar13);
                        } else {
                            uVar34 = 0xb1;
                            lVar32 = local_1d0;
                            pcVar12 = PszGetCompressedString(idsCLd00);
                            iVar19 = _wsprintf((char *)szWork + uVar13, pcVar12, uVar34, (int)lVar32, (int)((ulong)lVar32 >> 0x10));
                        }
                        c = uVar13 + iVar19;
                        RightTextOut(hdc, iVar14, iVar18, (char *)szWork, c, 0);
                    }
                    SetTextColor(hdc, 0xff);
                    sVar37 = 0;
                    sVar11 = 0;
                    pcVar12 = PszPlayerName(pl.iPlayer, 0, 1, 0, 0, 0);
                    RightTextOut(hdc, iVar14, iVar18 + dyArial8 + -2, pcVar12, sVar11, sVar37);
                }
                iVar18 = iVar18 + dyArial8 + -2;
                iVar19 = game.turn - pl.turn;
                dNum = iVar19;
                if (iVar19 == 0) {
                    if (local_e2 == 0) {
                        SVar15 = idsReportCurrent;
                    } else {
                        SVar15 = idsCurrent;
                    }
                    pcVar12 = PszGetCompressedString(SVar15);
                    c = _wsprintf(szWork, pcVar12);
                } else if (local_e2 == 0) {
                    pcVar12 = PszGetCompressedString(idsReportDYear);
                    c = _wsprintf(szWork, pcVar12, iVar19);
                    if (1 < dNum) {
                        _strcat((char *)szWork, (char *)s_s_1120_0502);
                        c = c + 1;
                    }
                    sVar11 = CchGetString(idsOld, (char *)szWork + c);
                    c = c + sVar11;
                } else {
                    pcVar12 = PszGetCompressedString(idsOld2);
                    c = _wsprintf(szWork, pcVar12, iVar19);
                }
                if (dNum < 6) {
                    uVar16 = 0;
                } else {
                    uVar16 = 0xff;
                }
                SetTextColor(hdc, (ulong)uVar16);
                TextOut(hdc, local_d8, iVar18, szWork, c);
                yCur = iVar18 + dyArial8;
                hbrSav = SelectObject(hdc, hbrButtonShadow);
                PatBlt(hdc, local_d8, yCur, iVar14 - local_d8, 1, 0xf00021);
                PatBlt(hdc, local_d8 + 1, yCur + 1, (iVar14 - local_d8) + -2, local_da * 3 + -1, 0x42);
                PatBlt(hdc, local_d8, yCur, 1, local_da * 3, 0xf00021);
                PatBlt(hdc, local_d8 + 2, yCur + local_da, (iVar14 - local_d8) + -4, 1, 0xf00021);
                PatBlt(hdc, local_d8 + 2, local_da * 2 + yCur, (iVar14 - local_d8) + -4, 1, 0xf00021);
                SelectObject(hdc, hbrButtonHilite);
                PatBlt(hdc, iVar14 + -1, yCur + 1, 1, local_da * 3, 0xf00021);
                PatBlt(hdc, local_d8, local_da * 3 + yCur, iVar14 - local_d8, 1, 0xf00021);
                SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
                SetBkMode(hdc, 1);
                local_d0 = FCanTerraformLppl(&pl, &local_d6, rgMax, rgCost, 1);
                dx = (iVar14 - local_d8) + -4;
                local_e6 = (THING *)CONCAT22(local_e6._2_2_, (int)(local_da - dyArial8) >> 1);
                for (i = 0; i < 3; i = i + 1) {
                    iVar18 = (int)*(char *)(idPlayer * 0xc0 + 0x59b5 + i);
                    local_e0 = (short *)CONCAT22((int)*(char *)(idPlayer * 0xc0 + 0x59b8 + i), (short *)local_e0);
                    iVar19 = (int)pl.rgEnvVar[i];
                    if (local_e2 == 0) {
                        pcVar12 = (char *)*(undefined2 *)(i * 2 + rgszPlanetAttr);
                    } else {
                        pcVar12 = (char *)*(undefined2 *)(i * 2 + rgszPlanetAttrAbbr);
                    }
                    RightTextOut(hdc, local_d8 - 2, yCur + (int)(THING *)local_e6, pcVar12, 0, 0);
                    if (2 < (pl.wFlags_0x4 & 0xff)) {
                        pcVar12 = PszCalcEnvVar(i, iVar19);
                        uVar13 = _strlen(pcVar12);
                        SelectObject(hdc, rghfontArial8[0]);
                        TextOut(hdc, iVar14 + 2, yCur + (int)(THING *)local_e6, pcVar12, uVar13);
                    }
                    SelectObject(hdc, rghfontArial8[1]);
                    SelectObject(hdc, (*((ushort(*)[2])rghbrPlanetAttr + i))[0]);
                    HVar35 = hdc;
                    sVar11 = MulDiv(iVar18, dx, 100);
                    iVar20 = local_d8 + 2 + sVar11;
                    iVar17 = yCur + 2;
                    sVar11 = MulDiv(local_e0._2_2_ - iVar18, dx, 100);
                    PatBlt(HVar35, iVar20, iVar17, sVar11, local_da - 3, 0xf00021);
                    if (2 < (pl.wFlags_0x4 & 0xff)) {
                        SelectObject(hdc, *(HGDIOBJ *)((int)rghbrPlanetAttr[0] + 2 + i * 4));
                        sVar11 = MulDiv((int)pl.rgEnvVarOrig[i], dx, 100);
                        local_1d0._0_2_ = local_d8 + 2 + sVar11;
                        local_1d0._2_2_ = (int)local_da / 2 + yCur;
                        c = (int)local_da / 4 + -1;
                        if (c < 2) {
                            c = 2;
                        }
                        PatBlt(hdc, (HDC)local_1d0 - c, local_1d0._2_2_, c * 2 + 1, 1, 0xf00021);
                        PatBlt(hdc, (HDC)local_1d0, local_1d0._2_2_ - c, 1, c * 2 + 1, 0xf00021);
                        local_dc = yCur + 3;
                        local_e0 = (short *)CONCAT22(local_e0._2_2_, (short *)(yCur + local_da + -3));
                        c = 1;
                        sVar11 = MulDiv(iVar19, dx, 100);
                        xBeg = local_d8 + 2 + sVar11;
                        while (true) {
                            PatBlt(hdc, xBeg, local_dc, 1, 1, 0xf00021);
                            uVar16 = local_dc;
                            local_dc = local_dc + 1;
                            PatBlt(hdc, xBeg + c + -1, uVar16, 1, 1, 0xf00021);
                            if ((int)(short *)local_e0 < (int)local_dc)
                                break;
                            PatBlt(hdc, xBeg, (short)(short *)local_e0, 1, 1, 0xf00021);
                            psVar10 = (short *)local_e0;
                            local_e0 = (short *)CONCAT22(local_e0._2_2_, (short *)((int)(short *)local_e0 + -1));
                            PatBlt(hdc, xBeg + c + -1, (short)psVar10, 1, 1, 0xf00021);
                            xBeg = xBeg + -1;
                            c = c + 2;
                        }
                        if (local_d0 != 0) {
                            local_dc = local_dc - 1;
                            if (*(int *)(local_d4 + i * 2 + -2) == -1) {
                                dxBar = 0;
                            } else if ((uint)(iVar19 - *(int *)(local_d4 + i * 2 + -2)) < 0x8000) {
                                dxBar = iVar19 - *(int *)(local_d4 + i * 2 + -2);
                            } else {
                                dxBar = 0;
                            }
                            sVar11 = MulDiv(iVar19 - dxBar, dx, 100);
                            xBeg = local_d8 + 2 + sVar11;
                            if (rgMax[i] == -1) {
                                dxBar = 0;
                            } else if ((uint)(rgMax[i] - iVar19) < 0x8000) {
                                dxBar = rgMax[i] - iVar19;
                            } else {
                                dxBar = 0;
                            }
                            sVar11 = MulDiv(iVar19 + dxBar, dx, 100);
                            PatBlt(hdc, xBeg, local_dc, ((local_d8 + sVar11) - xBeg) + 3, 1, 0xf00021);
                        }
                    }
                    yCur = yCur + local_da;
                }
                yCur = yCur + (dyArial8 >> 1);
                SelectObject(hdc, hbrButtonShadow);
                PatBlt(hdc, local_d8, yCur, iVar14 - local_d8, 1, 0xf00021);
                PatBlt(hdc, local_d8 + 1, yCur + 1, (iVar14 - local_d8) + -2, local_da * 3 + 1, 0x42);
                PatBlt(hdc, local_d8, yCur, 1, local_da * 3 + 2, 0xf00021);
                SelectObject(hdc, hbrButtonHilite);
                PatBlt(hdc, iVar14 + -1, yCur + 1, 1, local_da * 3 + 2, 0xf00021);
                PatBlt(hdc, local_d8, local_da * 3 + yCur + 2, iVar14 - local_d8, 1, 0xf00021);
                SelectObject(hdc, rghfontArial7[0]);
                sVar11 = _wsprintf(szWork, PCTD, cMinGrafMax);
                DVar29 = GetTextExtent(hdc, szWork, sVar11);
                iVar18 = iVar14 - local_d8;
                iVar19 = iVar18 + -3;
                iVar17 = cMinGrafMax / (iVar19 / (((int)DVar29 >> 1) + (int)DVar29));
                if (cMinGrafMax < 500) {
                    dNum = ((iVar17 + 0x31) / 0x32) * 10;
                } else if (cMinGrafMax < 1000) {
                    dNum = ((iVar17 + 0x31) / 0x32) * 0x32;
                } else if (cMinGrafMax < 0x9c4) {
                    dNum = ((iVar17 + 99) / 100) * 100;
                } else if (cMinGrafMax < 0x1d4c) {
                    dNum = ((iVar17 + 0xf9) / 0xfa) * 0xfa;
                } else if (cMinGrafMax < 15000) {
                    dNum = ((iVar17 + 499) / 500) * 500;
                } else {
                    dNum = ((iVar17 + 999) / 1000) * 1000;
                }
                local_e6._2_2_ = cMinGrafMax / dNum;
                SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
                local_e6._0_2_ = (THING *)(local_da * 3 + yCur + 4);
                for (i = 0; i <= local_e6._2_2_; i = i + 1) {
                    iVar20 = cMinGrafMax >> 0xf;
                    iVar21 = iVar19 >> 0xf;
                    iVar17 = iVar19;
                    sVar11 = cMinGrafMax;
                    uVar31 = __aFulmul((long)i, (long)dNum);
                    uVar31 = __aFulmul(uVar31, CONCAT22(iVar21, iVar17));
                    lVar32 = __aFldiv(uVar31, CONCAT22(iVar20, sVar11));
                    xBeg = (int)lVar32 + local_d8;
                    PatBlt(hdc, xBeg, yCur + 2, 1, local_da * 3 + -1, 0xf00021);
                    sVar11 = _wsprintf(szWork, PCTD, i * dNum);
                    CtrTextOut(hdc, xBeg, (short)(THING *)local_e6, (char *)szWork, sVar11);
                }
                RightTextOut(hdc, local_d8 - 4, (short)(THING *)local_e6, (char *)s_kT_1120_0504, 2, 0);
                if (pl.iPlayer == idPlayer) {
                    EstMineralsMined(&pl, rgl, -1, 0);
                } else {
                    rgl[2]._0_2_ = 0;
                    rgl[2]._2_2_ = 0;
                    rgl[1]._0_2_ = 0;
                    rgl[1]._2_2_ = 0;
                    rgl[0]._0_2_ = 0;
                    rgl[0]._2_2_ = 0;
                    if (pl.iPlayer == -1) {
                        for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                            /* WARNING: Load size is inaccurate */
                            pFVar6 = ((FLEET **)rglpfl)[ifl];
                            iVar17 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                            if ((pFVar6 == 0) && (iVar17 == 0))
                                break;
                            if ((pFVar6->idPlanet == pl.id) && (((pFVar6->iPlayer == idPlayer && ((pFVar6->wFlags_0x4 >> 10 & 1) == 0)) &&
                                                                 ((*(uint *)&((PLORD *)pFVar6->lpplord)[2].iordMax & 0xf) == 3)))) {
                                lVar32 = CMineFromLpfl((FLEET *)CONCAT22(iVar17, pFVar6));
                                if (0 < lVar32) {
                                    EstMineralsMined(&pl, &local_1da, lVar32, 0);
                                    for (local_1d0._2_2_ = 0; (int)local_1d0._2_2_ < 3; local_1d0._2_2_ = local_1d0._2_2_ + 1) {
                                        uVar7 = (&local_1da)[local_1d0._2_2_ * 2];
                                        iVar17 = *(int *)(&local_1d8 + local_1d0._2_2_);
                                        puVar1 = (uint *)(rgl + local_1d0._2_2_);
                                        uVar16 = *puVar1;
                                        *puVar1 = *puVar1 + uVar7;
                                        piVar2 = (int *)((int)rgl + local_1d0._2_2_ * 4 + 2);
                                        *piVar2 = *piVar2 + iVar17 + (uint)CARRY2(uVar16, uVar7);
                                    }
                                }
                            }
                        }
                    }
                }
                SelectObject(hdc, rghfontArial8[1]);
                local_e6 = (THING *)CONCAT22(local_e6._2_2_, (THING *)(((int)(local_da - dyArial8) >> 1) + 2));
                for (i = 0; i < 3; i = i + 1) {
                    SetTextColor(hdc, CONCAT22(*(undefined2 *)(i * 4 + rgcrMinerals_0x2), *(undefined2 *)(i * 4 + rgcrMinerals)));
                    sVar11 = 0;
                    if (local_e2 == 0) {
                        uVar13 = _strlen((char *)*(undefined2 *)(i * 2 + rgszMinerals));
                    } else {
                        uVar13 = 4;
                    }
                    RightTextOut(hdc, local_d8 - 2, (int)&((THING *)local_e6)->idFull + yCur, (char *)*(undefined2 *)(i * 2 + rgszMinerals), uVar13, sVar11);
                    iVar17 = cMinGrafMax >> 0xf;
                    iVar20 =
                        *(int *)((int)rgl + i * 4 + 2) + *(int *)((int)pl.rgwtMin + i * 4 + 2) + (uint)CARRY2(*(uint *)(rgl + i), *(uint *)(pl.rgwtMin + i));
                    if ((iVar20 < iVar17) ||
                        ((iVar21 = cMinGrafMax, iVar22 = iVar17, iVar20 <= iVar17 && (*(uint *)(rgl + i) + *(uint *)(pl.rgwtMin + i) <= (uint)cMinGrafMax)))) {
                        iVar21 = *(uint *)(rgl + i) + *(uint *)(pl.rgwtMin + i);
                        iVar22 = *(int *)((int)rgl + i * 4 + 2) + *(int *)((int)pl.rgwtMin + i * 4 + 2) +
                                 (uint)CARRY2(*(uint *)(rgl + i), *(uint *)(pl.rgwtMin + i));
                    }
                    sVar11 = cMinGrafMax;
                    uVar31 = __aFulmul((long)iVar19, CONCAT22(iVar22, iVar21));
                    lVar32 = __aFldiv(uVar31, CONCAT22(iVar17, sVar11));
                    dx = (short)lVar32;
                    SetRect(&rcGauge, local_d8 + 1, yCur + 4, local_d8 + dx + 1, yCur + local_da + -1);
                    if (dx != 0) {
                        FillRect(hdc, &rcGauge, *(HBRUSH *)((int)rghbrMinSum[0] + 2 + i * 4));
                    }
                    local_1d0._0_2_ = *(uint *)(rgl + i) + *(uint *)(pl.rgwtMin + i);
                    local_1d0._2_2_ =
                        *(int *)((int)rgl + i * 4 + 2) + *(int *)((int)pl.rgwtMin + i * 4 + 2) + (uint)CARRY2(*(uint *)(rgl + i), *(uint *)(pl.rgwtMin + i));
                    if ((cMinGrafMax >> 0xf <= (int)local_1d0._2_2_) && ((cMinGrafMax >> 0xf < (int)local_1d0._2_2_ || ((uint)cMinGrafMax < (HDC)local_1d0)))) {
                        SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
                        TextOut(hdc, iVar14, (int)&((THING *)local_e6)->idFull + yCur, s_str_1120_0507, 1);
                    }
                    iVar20 = cMinGrafMax >> 0xf;
                    iVar17 = *(int *)((int)pl.rgwtMin + i * 4 + 2);
                    if ((iVar17 < iVar20) || ((sVar11 = cMinGrafMax, iVar21 = iVar20, iVar17 <= iVar20 && (*(uint *)(pl.rgwtMin + i) <= (uint)cMinGrafMax)))) {
                        sVar11 = (short)pl.rgwtMin[i];
                        iVar21 = *(int *)((int)pl.rgwtMin + i * 4 + 2);
                    }
                    sVar37 = cMinGrafMax;
                    uVar31 = __aFulmul((long)iVar19, CONCAT22(iVar21, sVar11));
                    lVar32 = __aFldiv(uVar31, CONCAT22(iVar20, sVar37));
                    dx = (short)lVar32;
                    SetRect(&rcGauge, local_d8 + 1, yCur + 4, local_d8 + dx + 1, yCur + local_da + -1);
                    if (dx != 0) {
                        FillRect(hdc, &rcGauge, (*((ushort(*)[2])rghbrMinSum + i))[0]);
                    }
                    if (2 < (pl.wFlags_0x4 & 0xff)) {
                        for (local_1d0._2_2_ = 0; (int)local_1d0._2_2_ < 2; local_1d0._2_2_ = local_1d0._2_2_ + 1) {
                            SelectObject(hdc, ((ushort(*)[2])rghbrMinSum)[i][local_1d0._2_2_]);
                            local_dc = yCur + 4;
                            local_e0 = (short *)CONCAT22(local_e0._2_2_, (short *)(yCur + local_da + -2));
                            c = 1;
                            if (pl.rgMinConc[i] < 0x65) {
                                uVar16 = (uint)pl.rgMinConc[i];
                            } else {
                                uVar16 = 100;
                            }
                            sVar11 = MulDiv(uVar16, iVar18 + -0xb, 100);
                            xBeg = local_d8 + 1 + local_1d0._2_2_ + sVar11;
                            while (true) {
                                uVar16 = local_dc;
                                local_dc = local_dc + 1;
                                PatBlt(hdc, xBeg, uVar16, c, 1, 0xf00021);
                                sVar11 = xBeg;
                                psVar10 = (short *)local_e0;
                                if ((int)(short *)local_e0 < (int)local_dc)
                                    break;
                                xBeg = xBeg + -1;
                                local_e0 = (short *)CONCAT22(local_e0._2_2_, (short *)((int)(short *)local_e0 + -1));
                                PatBlt(hdc, sVar11, (short)psVar10, c, 1, 0xf00021);
                                c = c + 2;
                            }
                        }
                    }
                    yCur = yCur + local_da;
                }
                SetBkMode(hdc, 2);
                SelectObject(hdc, hbrSav);
                pPVar24 = (PLAYER *)rgplr + idPlayer;
                puVar25 = local_1a6;
                for (iVar18 = 0x60; l2 = CONCAT22(l2._2_2_, (undefined2)l2), iVar18 != 0; iVar18 = iVar18 + -1) {
                    pPVar3 = pPVar24;
                    pPVar24 = &pPVar24->cPlanet;
                    puVar4 = puVar25;
                    puVar25 = puVar25 + 1;
                    uVar34 = *puVar4;
                    pPVar3->iPlayer = (char)uVar34;
                    pPVar3->cShDef = (char)((uint)uVar34 >> 8);
                }
                goto MINE_FinishUp_5;
            }
        }
        l2 = CONCAT22(l2._2_2_, (undefined2)l2);
        local_1d8 = CONCAT22(local_1d8._2_2_, (undefined2)local_1d8);
        local_1d4 = CONCAT22(local_1d4._2_2_, (undefined2)local_1d4);
        local_1d0 = CONCAT22(local_1d0._2_2_, (HDC)local_1d0);
        if (sel.scan.idpl != -1) {
            local_d0 = SelectObject(HVar8, hbmpUnknownPlanet);
            SetTextColor(hdc, 0);
            BitBlt(hdc, ((prc->right - prc->left) + -0x40 >> 1) + prc->left, ((prc->bottom - prc->top) + -0x40 >> 1) + prc->top, 0x40, 0x40, HVar8, 0, 0,
                   0xcc0020);
            SelectObject(HVar8, local_d0);
            l2 = CONCAT22(l2._2_2_, (undefined2)l2);
            local_1d8 = CONCAT22(local_1d8._2_2_, (undefined2)local_1d8);
            local_1d4 = CONCAT22(local_1d4._2_2_, (undefined2)local_1d4);
            local_1d0 = CONCAT22(local_1d0._2_2_, (HDC)local_1d0);
        }
        goto MINE_FinishUp_5;
    }
    l2 = CONCAT22(l2._2_2_, (undefined2)l2);
    local_1d8 = CONCAT22(local_1d8._2_2_, (undefined2)local_1d8);
    local_1d4 = CONCAT22(local_1d4._2_2_, (undefined2)local_1d4);
    local_1d0 = CONCAT22(local_1d0._2_2_, (HDC)local_1d0);
    if (sel.scan.ith == -1)
        goto MINE_FinishUp_5;
    local_d4._2_2_ = lpThings._2_2_;
    local_d4._0_2_ = (THING *)lpThings + sel.scan.ith;
    local_e2 = *(uint *)((int)&rgplr[0].wMdPlr + (*(ushort *)local_d4 >> 9 & 0xf) * 0xc0) >> 3 & 0x1f;
    local_e0 = (short *)CONCAT22(local_e0._2_2_, (short *)(prc->left + 6));
    local_d0 = prc->top + 6;
    hbrSav = SelectObject(hdc, hbrButtonShadow);
    PatBlt(hdc, (short)(short *)local_e0, local_d0, 0x46, 2, 0xf00021);
    PatBlt(hdc, (short)(short *)local_e0, local_d0 + 2, 2, 0x44, 0xf00021);
    if (*(ushort *)local_d4 >> 0xd == 0) {
        local_da = (uint) * (byte *)((int)&(local_d4._0_2_)->u_THING_0x0006 + 6);
    } else if (*(ushort *)local_d4 >> 0xd == 1) {
        local_da = ((((&(local_d4._0_2_)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) != 0) + 3;
    } else if (*(ushort *)local_d4 >> 0xd == 3) {
        local_da = 6;
    } else {
        local_da = 5;
    }
    SelectPalette(hdc, vhpal, 0);
    RealizePalette(hdc);
    if ((*(ushort *)local_d4 >> 0xd == 2) || (*(ushort *)local_d4 >> 0xd == 3)) {
        SelectObject(hdc, hbrButtonHilite);
        PatBlt(hdc, (short)((short *)local_e0 + 1), local_d0 + 0x44, 0x44, 1, 0xf00021);
        PatBlt(hdc, (int)(short *)local_e0 + 1, local_d0 + 0x45, 0x45, 1, 0xf00021);
        PatBlt(hdc, (short)((short *)local_e0 + 0x22), local_d0 + 2, 2, 0x42, 0xf00021);
        PatBlt(hdc, (int)(short *)local_e0 + 0x45, local_d0 + 1, 1, 1, 0xf00021);
        PatBlt(hdc, (short)((short *)local_e0 + 1), local_d0 + 2, 0x42, 0x42, 0x42);
    } else {
        PatBlt(hdc, (short)((short *)local_e0 + 8), local_d0 + 0x44, 2, 0x26, 0xf00021);
        SelectObject(hdc, hbrButtonHilite);
        PatBlt(hdc, (short)((short *)local_e0 + 1), local_d0 + 0x44, 0xf, 1, 0xf00021);
        PatBlt(hdc, (int)(short *)local_e0 + 1, local_d0 + 0x45, 0xf, 1, 0xf00021);
        PatBlt(hdc, (short)((short *)local_e0 + 0x1a), local_d0 + 0x44, 0x12, 2, 0xf00021);
        PatBlt(hdc, (short)((short *)local_e0 + 0x22), local_d0 + 2, 2, 0x42, 0xf00021);
        PatBlt(hdc, (int)(short *)local_e0 + 0x45, local_d0 + 1, 1, 1, 0xf00021);
        PatBlt(hdc, (int)(short *)local_e0 + 0x11, local_d0 + 0x68, 0x25, 2, 0xf00021);
        PatBlt(hdc, (short)((short *)local_e0 + 8), local_d0 + 0x69, 1, 1, 0xf00021);
        PatBlt(hdc, (short)((short *)local_e0 + 0x1a), local_d0 + 0x46, 2, 0x22, 0xf00021);
        PatBlt(hdc, (short)((short *)local_e0 + 1), local_d0 + 2, 0x42, 0x42, 0x42);
        PatBlt(hdc, (short)((short *)local_e0 + 9), local_d0 + 0x44, 0x22, 0x24, 0x42);
        DibBlt(hdc, (int)(short *)local_e0 + 0x13, local_d0 + 0x47, 0x20, 0x20, hdibRaces, (local_e2 & 7) << 5, (3 - ((int)local_e2 >> 3)) * 0x20, 0x20, 0x20,
               0xcc0020);
    }
    SelectObject(hdc, hbrSav);
    DibBlt(hdc, (short)((short *)local_e0 + 1), local_d0 + 2, 0x40, 0x40, hdibThings, local_da << 6, 0, 0x40, 0x40, 0xcc0020);
    if (*(ushort *)local_d4 >> 0xd == 1) {
        local_e0 = (short *)local_e0 + 0x28;
        SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
        SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
        SelectObject(hdc, rghfontArial8[1]);
        if ((((&(local_d4._0_2_)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) != 0) {
            CchGetString(idsTravelingWarpD, szT);
            sStack_56 = _wsprintf(szWork, szT, (((&(local_d4._0_2_)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) + 4);
            TextOut(hdc, (short)(short *)local_e0, local_d0, szWork, sStack_56);
            local_d0 = local_d0 + dyArial8 + 2;
            CchGetString(idsDestination, szT);
            pcVar12 = PszGetPlanetName(((&(local_d4._0_2_)->u_THING_0x0006)->thp).wFlags & 0x3ff);
            _strcat(szT, pcVar12);
            pcVar12 = szT;
            HVar33 = local_d0;
            psVar10 = (short *)local_e0;
            HVar35 = hdc;
            uVar13 = _strlen(szT);
            TextOut(HVar35, (short)psVar10, HVar33, pcVar12, uVar13);
        }
        local_d0 = local_d0 + (dyArial8 * 3) / 2;
        uVar34 = 0x1120;
        pcVar12 = rgszMinerals[2];
        HVar35 = hdc;
        uVar13 = _strlen(rgszMinerals[2]);
        DVar29 = GetTextExtent(HVar35, (LPCSTR)CONCAT22(uVar34, pcVar12), uVar13);
        local_e0 = (short *)CONCAT22(local_e0._2_2_, (short *)((int)(short *)local_e0 + (int)DVar29));
        i = 0;
        while (true) {
            l2 = CONCAT22(l2._2_2_, (undefined2)l2);
            local_1d8 = CONCAT22(local_1d8._2_2_, (undefined2)local_1d8);
            local_1d4 = CONCAT22(local_1d4._2_2_, (undefined2)local_1d4);
            local_1d0 = CONCAT22(local_1d0._2_2_, (HDC)local_1d0);
            if (2 < i)
                break;
            uVar34 = *(undefined2 *)(i * 2 + rgszMinerals);
            uVar26 = 0x1120;
            pcVar12 = PszGetCompressedString(idsS2);
            sStack_56 = _wsprintf(szWork, pcVar12, uVar34, uVar26);
            RightTextOut(hdc, (short)(short *)local_e0, local_d0, (char *)szWork, sStack_56, 0);
            sStack_56 = _wsprintf(szWork, PCTDKT, *(undefined2 *)(((u_THING_0x0006 *)(local_d4._0_2_ + 6))->rgb + i * 2 + 2));
            TextOut(hdc, (short)(short *)local_e0, local_d0, szWork, sStack_56);
            local_d0 = local_d0 + dyArial8 + 2;
            i = i + 1;
        }
        goto MINE_FinishUp_5;
    }
    if (*(ushort *)local_d4 >> 0xd != 2) {
        if (*(ushort *)local_d4 >> 0xd == 3) {
            local_e0 = (short *)local_e0 + 0x28;
            SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
            SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
            SelectObject(hdc, rghfontArial8[1]);
            SetRect(&rc, (short)(short *)local_e0, local_d0, prc->right + -8, prc->bottom + -8);
            if ((1 << ((byte)idPlayer & 0x1f) & *(uint *)((int)&(local_d4._0_2_)->u_THING_0x0006 + 6)) == 0) {
                pcVar12 = PszGetCompressedString(idsTraderRequestsInterestedPartiesSendFleetLeast);
                uVar34 = 0x1120;
                HVar35 = hdc;
                uVar13 = _strlen(pcVar12);
                sVar11 = DRAWTEXT(HVar35, (LPCSTR)CONCAT22(uVar34, pcVar12), uVar13, &rc, 0x810);
                local_d0 = local_d0 + sVar11 + 8;
            }
            uVar16 = *(uint *)((int)&(local_d4._0_2_)->u_THING_0x0006 + 4) & 0xf;
            pcVar12 = PszGetCompressedString(idsTraderTravelingWarpD);
            sVar11 = _wsprintf(szWork, pcVar12, uVar16);
            TextOut(hdc, (short)(short *)local_e0, local_d0, szWork, sVar11);
            l2 = CONCAT22(l2._2_2_, (undefined2)l2);
            local_1d8 = CONCAT22(local_1d8._2_2_, (undefined2)local_1d8);
            local_1d4 = CONCAT22(local_1d4._2_2_, (undefined2)local_1d4);
            local_1d0 = CONCAT22(local_1d0._2_2_, (HDC)local_1d0);
        } else {
            l2 = CONCAT22(l2._2_2_, (undefined2)l2);
            local_1d8 = CONCAT22(local_1d8._2_2_, (undefined2)local_1d8);
            local_1d4 = CONCAT22(local_1d4._2_2_, (undefined2)local_1d4);
            local_1d0 = CONCAT22(local_1d0._2_2_, (HDC)local_1d0);
            if (*(ushort *)local_d4 >> 0xd == 0) {
                local_e0 = (short *)local_e0 + 0x28;
                SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
                SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
                SelectObject(hdc, rghfontArial8[1]);
                CchGetString(idsLocationDD, szT);
                sStack_56 = _wsprintf(szWork, szT, (&(local_d4._0_2_)->pt)->x, ((local_d4._0_2_)->pt).y);
                TextOut(hdc, (short)(short *)local_e0, local_d0, szWork, sStack_56);
                local_d0 = local_d0 + dyArial8 + 2;
                CchGetString(idsFieldTypeS, szT);
                sStack_56 = _wsprintf(szWork, szT, *(undefined2 *)((uint) * (byte *)((int)&(local_d4._0_2_)->u_THING_0x0006 + 6) * 2 + 0x4f2), 0x1120);
                TextOut(hdc, (short)(short *)local_e0, local_d0, szWork, sStack_56);
                local_d0 = local_d0 + dyArial8 + 2;
                CchGetString(idsFieldRadiusDLYLdMines, szT);
                uVar26 = local_d4._2_2_;
                pTVar23 = local_d4._0_2_;
                uVar34 = *(undefined2 *)((int)&pTVar23->u_THING_0x0006 + 2);
                uVar13 = ((&pTVar23->u_THING_0x0006)->thp).wFlags;
                _sqrt((double)((&pTVar23->u_THING_0x0006)->thm).cMines);
                lVar32 = __ftol((double)CONCAT26(unaff_SI, CONCAT24(unaff_DI, CONCAT22(uVar34, uVar13))));
                sStack_56 = _wsprintf(szWork, szT, (int)lVar32);
                TextOut(hdc, (short)(short *)local_e0, local_d0, szWork, sStack_56);
                local_d0 = local_d0 + dyArial8 + 2;
                sVar11 = GetRaceStat((PLAYER *)rgplr + (*(ushort *)local_d4 >> 9 & 0xf), rsMajorAdv);
                local_e6 = (THING *)CONCAT22((uint)(sVar11 != raMines) * 3 + 1, (THING *)local_e6);
                uVar34 = local_d4._2_2_;
                pTVar23 = local_d4._0_2_;
                pt.y = (pTVar23->pt).y;
                pt.x = (&pTVar23->pt)->x;
                sVar11 = CPlanetsInCircle(pt, CONCAT22(*(undefined2 *)((int)&pTVar23->u_THING_0x0006 + 2), ((&pTVar23->u_THING_0x0006)->thp).wFlags));
                local_d8 = local_e6._2_2_ * sVar11 + 2;
                local_d6 = (int)local_d8 >> 0xf;
                if ((-1 < (int)local_d6) && ((0 < (int)local_d6 || (0x32 < local_d8)))) {
                    local_d8 = 0x32;
                    local_d6 = 0;
                }
                uVar34 = local_d4._2_2_;
                pTVar23 = local_d4._0_2_;
                if (*(char *)((int)&pTVar23->u_THING_0x0006 + 7) != '\0') {
                    bVar27 = 0xffe6 < local_d8;
                    local_d8 = local_d8 + 0x19;
                    local_d6 = local_d6 + bVar27;
                }
                uVar36 = 0;
                uVar26 = 100;
                uVar31 = __aFulmul(CONCAT22(*(undefined2 *)((int)&pTVar23->u_THING_0x0006 + 2), ((&pTVar23->u_THING_0x0006)->thp).wFlags),
                                   CONCAT22(local_d6, local_d8));
                lVar32 = __aFldiv(uVar31, CONCAT22(uVar36, uVar26));
                if (lVar32 < CONCAT22(local_d6, local_d8)) {
                    lVar32 = CONCAT22(local_d6, local_d8);
                }
                if ((*(char *)((int)&(local_d4._0_2_)->u_THING_0x0006 + 6) != '\x02') && (lVar32 < 10)) {
                    lVar32 = 10;
                }
                local_dc = (uint)((ulong)lVar32 >> 0x10);
                local_e0 = (short *)CONCAT22((int)lVar32, (short *)local_e0);
                CchGetString(idsDecayRateLdYear, szT);
                sStack_56 = _wsprintf(szWork, szT, local_e0._2_2_, local_dc);
                TextOut(hdc, (short)(short *)local_e0, local_d0, szWork, sStack_56);
                local_d0 = local_d0 + dyArial8 + 2;
                if ((*(ushort *)local_d4 >> 9 & 0xf) == idPlayer) {
                    GetMineFieldCounts(*(ushort *)local_d4, &i, &c2);
                    CchGetString(idsFieldDD, szT);
                    sStack_56 = _wsprintf(szWork, szT, i, c2);
                    TextOut(hdc, (short)(short *)local_e0, local_d0, szWork, sStack_56);
                    local_d0 = local_d0 + dyArial8 + 2;
                }
                l2 = CONCAT22(l2._2_2_, (undefined2)l2);
                local_1d8 = CONCAT22(local_1d8._2_2_, (undefined2)local_1d8);
                local_1d4 = CONCAT22(local_1d4._2_2_, (undefined2)local_1d4);
                local_1d0 = CONCAT22(local_1d0._2_2_, (HDC)local_1d0);
            }
        }
        goto MINE_FinishUp_5;
    }
    local_e0._0_2_ = (short *)local_e0 + 0x2f;
    SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
    SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
    SelectObject(hdc, rghfontArial8[1]);
    sVar11 = CchGetString(idsLocation, szT);
    DVar29 = GetTextExtent(hdc, szT, sVar11);
    local_e0._0_2_ = (short *)((int)(short *)local_e0 + (int)DVar29 + 0x14);
    RightTextOut(hdc, (short)((short *)local_e0 + -2), local_d0, szT, sVar11, 0);
    CchGetString(idsDD5, szT);
    sStack_56 = _wsprintf(szWork, szT, (&(local_d4._0_2_)->pt)->x, ((local_d4._0_2_)->pt).y);
    TextOut(hdc, (short)(short *)local_e0, local_d0, szWork, sStack_56);
    local_d0 = local_d0 + (dyArial8 * 3) / 2;
    sStack_56 = CchGetString(idsDestination2, (char *)szWork);
    RightTextOut(hdc, (short)((short *)local_e0 + -2), local_d0, (char *)szWork, sStack_56, 0);
    if ((1 << ((byte)idPlayer & 0x1f) & *(uint *)((int)&(local_d4._0_2_)->u_THING_0x0006 + 4)) == 0) {
    LAB_1028_19f8:
        sStack_56 = CchGetString(idsUnknown2, (char *)szWork);
    } else {
        local_e6 = LpthFromId(*(short *)((int)&(local_d4._0_2_)->u_THING_0x0006 + 6));
        uVar34 = (undefined2)((ulong)local_e6 >> 0x10);
        if (local_e6 == 0)
            goto LAB_1028_19f8;
        sStack_56 = _wsprintf(szWork, szT, (&((THING *)local_e6)->pt)->x, (((THING *)local_e6)->pt).y);
    }
    TextOut(hdc, (short)(short *)local_e0, local_d0, szWork, sStack_56);
    local_d0 = local_d0 + (dyArial8 * 3) / 2;
    sStack_56 = CchGetString(idsStability, (char *)szWork);
    RightTextOut(hdc, (short)((short *)local_e0 + -2), local_d0, (char *)szWork, sStack_56, 0);
    pcVar12 = (char *)szWork;
    sVar11 = PctWormholeMoves((THING *)local_d4);
    sStack_56 = CchGetString(sVar11 + idsRockSolid, pcVar12);
    TextOut(hdc, (short)(short *)local_e0, local_d0, szWork, sStack_56);
    l2 = CONCAT22(l2._2_2_, (undefined2)l2);
    local_1d8 = CONCAT22(local_1d8._2_2_, (undefined2)local_1d8);
    local_1d4 = CONCAT22(local_1d4._2_2_, (undefined2)local_1d4);
    local_1d0 = CONCAT22(local_1d0._2_2_, (HDC)local_1d0);
MINE_FinishUp_5:
    SetBkMode(hdc, sVar9);
    SetTextColor(hdc, crFore);
    SetBkColor(hdc, CVar28);
    DeleteDC(HVar8);
    return;
}

// ======================================================================
// Function: HtMineWindow
// Address: 1028:37ac
// Segment: MEMORY_MINE
// ======================================================================

short HtMineWindow(HWND hwnd, short x, short y)

{
    int        iVar1;
    short      sVar2;
    uint       uVar3;
    undefined2 unaff_SS;
    RECT       rc;
    short      grobj;
    short      yCur;
    short      dyRow;
    PLANET     pl;

    grobj = sel.scan.grobj;
    if (sel.scan.grobj == grobjOther) {
        if ((sel.scan.grobjFull & grobjPlanet) == grobjNone) {
            if ((sel.scan.grobjFull & grobjFleet) == grobjNone) {
                grobj = 0;
            } else {
                grobj = 2;
            }
        } else {
            grobj = 1;
        }
    }
    GetClientRect(hwnd, &rc);
    rc.top = rc.top + dyArial8 * 2;
    if ((((y < rc.top + -5) && (4 < y)) && (x < rc.right + -4)) && ((rc.right - rc.top < x && (sVar2 = FOtherStuffAtScanSel(), sVar2 != 0)))) {
        sVar2 = 9;
    } else if ((grobj == 2) ||
               (((grobj == 8 && (((THING *)lpThings + sel.scan.ith)->idFull >> 0xd != 2)) && (((THING *)lpThings + sel.scan.ith)->idFull >> 0xd != 3)))) {
        if (((x < rc.left + 0x19) || (rc.left + 0x39 <= x)) || ((y < rc.top + 0x47 || (rc.top + 0x67 <= y)))) {
            if (((grobj == 8) && (((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0)) &&
                ((rc.left + 9 <= x && (((x < rc.left + 0x49 && (rc.top + 9 <= y)) && (y < rc.top + 0x49)))))) {
                sVar2 = 0xe;
            } else if (grobj == 8) {
                sVar2 = 0;
            } else if (((x < rc.left + 9) || (rc.left + 0x49 <= x)) || ((y < rc.top + 9 || (rc.top + 0x49 <= y)))) {
                if (((x < rc.left + 0x5c) || (y < rc.top + 4)) || (rc.top + 7 + dyArial8 <= y)) {
                    sVar2 = 0;
                } else {
                    sVar2 = 0xb;
                }
            } else {
                sVar2 = 0xb;
            }
        } else {
            sVar2 = 10;
        }
    } else if ((sel.scan.idpl == -1) || (sVar2 = FLookupPlanet(sel.scan.idpl, &pl), sVar2 == 0)) {
        sVar2 = 0;
    } else {
        uVar3 = ((rc.bottom - (rc.top + -4)) + dyArial8 * -4 + -2) / 6 + 1U & 0xfffe;
        iVar1 = rc.top + dyArial8 * 2 + -4;
        if (y < iVar1) {
            if (rc.top + -4 < y) {
                if (x < rc.right + -0x18) {
                    if ((((pl.iPlayer == idPlayer) || (x <= (rc.right * 3) / 5)) || (y < iVar1 - dyArial8)) || (pl.iPlayer == -1)) {
                        sVar2 = 0xc;
                    } else {
                        sVar2 = 10;
                    }
                } else if ((pl.wFlags_0x4 >> 9 & 1) == 0) {
                    sVar2 = 0;
                } else {
                    sVar2 = 0xd;
                }
            } else {
                sVar2 = 0;
            }
        } else if (y < (int)(uVar3 * 3 + iVar1)) {
            sVar2 = (y - iVar1) / (int)uVar3 + 6;
        } else {
            iVar1 = iVar1 + uVar3 * 3 + (dyArial8 >> 1) + 1;
            if (y < (int)(uVar3 * 3 + iVar1)) {
                sVar2 = (y - iVar1) / (int)uVar3 + 1;
            } else {
                sVar2 = 5;
            }
        }
    }
    return sVar2;
}

// ======================================================================
// Function: MineClick
// Address: 1028:3b4e
// Segment: MEMORY_MINE
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10284727) */

void MineClick(short x, short y, short msg, short sks)

{
    short     *psVar1;
    SCAN      *pSVar2;
    int        iVar3;
    FLEET     *pFVar4;
    PLANET    *pPVar5;
    short      sVar6;
    undefined2 uVar7;
    int        iVar8;
    int        iVar9;
    short     *psVar10;
    SCAN      *pSVar11;
    undefined2 unaff_SS;
    bool       bVar12;
    long       cMines;
    short      ishdef;
    short      rgid[16];
    FLEET     *lpfl;
    short      c;
    char      *rgpsz[16];
    char       local_20a[382];
    char      *local_8c[9];
    short      local_7a;
    int        local_78[4];
    char      *local_70;
    undefined2 local_6e;
    undefined2 local_6c;
    char      *local_6a;
    int        local_68;
    undefined4 local_66;
    FLEET     *local_62;
    int        iStack_60;
    int        local_5e;
    uint       local_5c[4];
    uint       local_54[2];
    int        local_50;
    undefined1 local_4e[8];
    byte       abStack_46[2];
    uint       local_44;
    char       acStack_42[16];
    short      local_32[3];
    int        local_2c;
    int        local_2a;
    SCAN       local_28;
    ushort     local_18;
    PLPROD    *local_16;
    uint       local_14;
    PART       PStack_12;
    short      ht;
    PLANET    *lppl;

    ht = HtMineWindow(hwndMine, x, y);
    if (((msg == 0x204) && (ht != 9)) && (ht != 0xb)) {
        return;
    }
    switch (ht) {
    default:
        break;
    case 1:
    case 2:
    case 3:
        FLookupPlanet(sel.scan.idpl, local_4e);
        GlobalPD.grPopup = 1;
        GlobalPD.u_POPUPDATA_0x0002.rgi[0] = (long)(ht + -1);
        for (local_50 = 1; local_50 < 5; local_50 = local_50 + 1) {
            *(undefined2 *)(local_50 * 4 + GlobalPD_0x2) = 0xffff;
            *(undefined2 *)(local_50 * 4 + 0xb84) = 0xffff;
        }
        if (2 < (local_4e._4_2_ & 0xff)) {
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.iPlrMin = (short)abStack_46[ht];
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.iPlrMax = 0;
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = (uint)local_4e._4_2_ >> 10 & 1;
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = 0;
            local_66 = CONCAT22(local_66._2_2_, (short)local_66);
            if (3 < (local_4e._4_2_ & 0xff)) {
                local_6a = 0;
                local_68 = 0;
                GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = local_32[(ht + -1) * 2];
                GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary = local_32[(ht + -1) * 2 + 1];
                EstMineralsMined(local_4e, &local_16, -1, 0);
                cMines = CONCAT22(local_66._2_2_, (short)local_66);
                GlobalPD.u_POPUPDATA_0x0002.rgi[4]._0_2_ = (&local_16)[(ht + -1) * 2];
                GlobalPD.u_POPUPDATA_0x0002.rgi[4]._2_2_ = (&local_16)[(ht + -1) * 2 + 1];
                local_66 = cMines;
                if (local_4e._2_2_ == -1) {
                    for (local_5e = 0; local_66 = cMines, local_5e < cFleet; local_5e = local_5e + 1) {
                        /* WARNING: Load size is inaccurate */
                        pFVar4 = ((FLEET **)rglpfl)[local_5e];
                        iVar9 = *(int *)((int)((FLEET **)rglpfl + local_5e) + 2);
                        _local_62 = (FLEET *)CONCAT22(iVar9, pFVar4);
                        if ((pFVar4 == 0) && (iVar9 == 0))
                            break;
                        if ((pFVar4->idPlanet == local_4e._0_2_) && (((pFVar4->iPlayer == idPlayer && ((pFVar4->wFlags_0x4 >> 10 & 1) == 0)) &&
                                                                      ((*(uint *)&((PLORD *)pFVar4->lpplord)[2].iordMax & 0xf) == 3)))) {
                            cMines = CMineFromLpfl((FLEET *)CONCAT22(iVar9, pFVar4));
                            if (0 < cMines) {
                                local_66 = cMines;
                                EstMineralsMined(local_4e, local_5c, cMines, 0);
                                bVar12 = CARRY2((uint)local_6a, local_5c[(ht + -1) * 2]);
                                local_6a = (char *)((int)local_6a + local_5c[(ht + -1) * 2]);
                                local_68 = local_68 + local_5c[(ht + -1) * 2 + 1] + (uint)bVar12;
                                cMines = local_66;
                            }
                        }
                    }
                    if ((-1 < local_68) && ((0 < local_68 || (local_6a != 0)))) {
                        GlobalPD.u_POPUPDATA_0x0002.rgi[4]._0_2_ = local_6a;
                        GlobalPD.u_POPUPDATA_0x0002.rgi[4]._2_2_ = local_68;
                    }
                }
            }
        }
        Popup(hwndMine, x, y);
        break;
    case 5:
        local_7a = -1;
        local_78[0] = 100;
        local_78[1] = 500;
        local_78[2] = 1000;
        local_78[3] = 0x9c4;
        local_70 = (char *)"Stars!" + 3;
        local_6e = 0x1d4c;
        local_6c = 10000;
        local_6a = (char *)rgbCur + 0x288;
        local_68 = 30000;
        for (local_66._0_2_ = 0; (short)local_66 < 9; local_66._0_2_ = (short)local_66 + 1) {
            _wsprintf((char *)((int)&local_66 + (short)local_66 * 10 + 2), PCTDKT, local_78[(short)local_66]);
            local_8c[(short)local_66] = (char *)((int)&local_66 + (short)local_66 * 10 + 2);
            if (local_78[(short)local_66] == cMinGrafMax) {
                local_7a = (short)local_66;
            }
        }
        local_66._0_2_ = PopupMenu(hwndMine, x, y, 9, 0, local_8c, local_7a, 1);
        if (((short)local_66 != -1) && (local_78[(short)local_66] != cMinGrafMax)) {
            cMinGrafMax = local_78[(short)local_66];
            InvalidateRect(hwndMine, 0, 1);
            if ((grbitScan & 0xf) == 1) {
                InvalidateRect(hwndScanner, 0, 1);
            }
        }
        break;
    case 6:
    case 7:
    case 8:
        FLookupPlanet(sel.scan.idpl, local_4e + 6);
        GlobalPD.grPopup = 5;
        GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = ht + -6;
        GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = local_4e._6_2_;
        if ((local_44 & 0xff) < 3) {
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = -1;
        } else {
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = (short)acStack_42[ht];
        }
        if (((local_44 & 0xff) < 3) || (sVar6 = FCanTerraformLppl(local_4e + 6, &PStack_12.hs.wFlags_0x2, local_5c + 4, local_4e, 1), sVar6 == 0)) {
        MINE_NoTerra:
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = -1;
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = -1;
        } else {
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = (&PStack_12.hs.wFlags_0x2)[GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2];
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = local_5c[GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 + 4];
            if (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate == 0xffff) {
                GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur;
            }
            if (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory == 0xffff) {
                GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur;
            }
            if (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate == GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory)
                goto MINE_NoTerra;
        }
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary = (short)*(char *)(idPlayer * 0xc0 + 0x59b2 + GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2);
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.iPlrMin = (short)*(char *)(idPlayer * 0xc0 + 0x59b5 + GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2);
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.iPlrMax = (short)*(char *)(idPlayer * 0xc0 + 0x59b8 + GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2);
        Popup(hwndMine, x, y);
        break;
    case 9:
        if (msg == 0x204) {
            PopupMineralScanChoices(hwndMine, x, y);
        } else {
            psVar10 = (short *)&sel.scan;
            pSVar11 = &local_28;
            for (iVar9 = 8; iVar9 != 0; iVar9 = iVar9 + -1) {
                pSVar2 = pSVar11;
                pSVar11 = &(pSVar11->pt).y;
                psVar1 = psVar10;
                psVar10 = psVar10 + 1;
                (pSVar2->pt).x = *psVar1;
            }
            local_28.iwp = 0;
            if (local_28.grobj == grobjThing) {
                local_16 = (PLPROD *)((int)(ushort *)local_28.ith + 1);
                goto LAB_1028_4113;
            }
        LAB_1028_4192:
            if (local_28.grobj == grobjFleet) {
                local_16 = (PLPROD *)((int)(ushort *)local_28.ifl + 1);
            } else {
                local_16 = 0;
            }
            for (; (int)local_16 < cFleet; local_16 = (PLPROD *)((int)&local_16->wFlags + 1)) {
                iVar9 = *(int *)((FLEET **)rglpfl + (int)local_16);
                iVar3 = *(int *)((int)((FLEET **)rglpfl + (int)local_16) + 2);
                _local_14 = CONCAT22(iVar3, iVar9);
                if (((iVar9 == 0) && (iVar3 == 0)) || ((local_28.pt.x == *(int *)(iVar9 + 8) && (local_28.pt.y == *(int *)(iVar9 + 10)))))
                    break;
            }
            if ((int)local_16 < cFleet) {
                local_28.ifl = (short)local_16;
                local_28.grobj = grobjFleet;
                local_18 = ((FLEET **)rglpfl)[(int)local_16]->id;
                PStack_12.hs.wFlags_0x2 = (ushort)(((FLEET *)((FLEET **)rglpfl)[(int)local_16])->iPlayer == idPlayer);
            } else {
                if ((local_28.grobjFull & grobjThing) != grobjNone) {
                    local_16 = 0;
                    goto LAB_1028_4113;
                }
                if ((local_28.grobjFull & grobjPlanet) == grobjNone) {
                    do {
                        for (local_16 = 0; (int)local_16 < cFleet; local_16 = (PLPROD *)((int)&local_16->wFlags + 1)) {
                            iVar9 = *(int *)((FLEET **)rglpfl + (int)local_16);
                            iVar3 = *(int *)((int)((FLEET **)rglpfl + (int)local_16) + 2);
                            _local_14 = CONCAT22(iVar3, iVar9);
                            if (((iVar9 == 0) && (iVar3 == 0)) || ((local_28.pt.x == *(int *)(iVar9 + 8) && (local_28.pt.y == *(int *)(iVar9 + 10)))))
                                break;
                        }
                        if ((local_16 != (PLPROD *)cFleet) || ((local_28.grobjFull & grobjThing) == grobjNone)) {
                            local_28.grobj = grobjFleet;
                            local_28.ifl = (short)local_16;
                            local_18 = ((FLEET **)rglpfl)[(int)local_16]->id;
                            PStack_12.hs.wFlags_0x2 = (ushort)(((FLEET *)((FLEET **)rglpfl)[(int)local_16])->iPlayer == idPlayer);
                            goto MINE_ChangeIt;
                        }
                        local_16 = 0;
                    LAB_1028_4113:
                        for (; (int)local_16 < cThing; local_16 = (PLPROD *)((int)&local_16->wFlags + 1)) {
                            local_2c = local_28.pt.x;
                            local_2a = local_28.pt.y;
                            if (((&((THING *)lpThings)[(int)local_16].pt)->x == local_28.pt.x) && (((THING *)lpThings)[(int)local_16].pt.y == local_28.pt.y))
                                break;
                        }
                        if ((int)local_16 < cThing) {
                            local_28.ith = (short)local_16;
                            local_28.grobj = grobjThing;
                            local_18 = ((THING *)lpThings + (int)local_16)->idFull;
                            PStack_12.hs.wFlags_0x2 = 0;
                            goto MINE_ChangeIt;
                        }
                        if ((local_28.grobjFull & grobjPlanet) != grobjNone)
                            break;
                        if ((local_28.grobjFull & grobjFleet) == grobjNone) {
                            if ((local_28.grobjFull & grobjThing) == grobjNone)
                                goto LAB_1028_4192;
                            local_16 = 0;
                            goto LAB_1028_4113;
                        }
                    } while (true);
                }
                local_28.grobj = grobjPlanet;
                local_18 = local_28.idpl;
                PStack_12.u_PART_0x0004.parmor = LpplFromId(local_28.idpl);
                if (((PLANET *)PStack_12.u_PART_0x0004.parmor == 0) && (PStack_12.u_PART_0x0004._2_2_ == 0)) {
                    PStack_12.hs.wFlags_0x2 = 0;
                } else {
                    PStack_12.hs.wFlags_0x2 = (ushort)(((PLANET *)PStack_12.u_PART_0x0004.parmor)->iPlayer == idPlayer);
                }
            }
        MINE_ChangeIt:
            if ((PStack_12.hs.wFlags_0x2 == 0) || (sel.grobj != grobjFleet)) {
                local_28.iwp = sel.scan.iwp;
            }
            ChangeScanSel(&local_28, 2);
            if (PStack_12.hs.wFlags_0x2 != 0) {
                RedrawScanSel(0, 0);
                ChangeMainObjSel(local_28.grobj, local_18);
                RedrawScanSel(0, 1);
            }
        }
        break;
    case 10:
        if (sel.scan.grobj == grobjPlanet) {
            PStack_12.u_PART_0x0004.parmor = LpplFromId(sel.scan.idpl);
            GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = ((PLANET *)PStack_12.u_PART_0x0004.parmor)->iPlayer;
        } else if (sel.scan.grobj == grobjThing) {
            GlobalPD.u_POPUPDATA_0x0002.rgi[0] =
                CONCAT22(GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2, ((THING *)lpThings + sel.scan.ith)->idFull >> 9) & 0xffff000f;
        } else {
            GlobalPD.u_POPUPDATA_0x0002.rgi[0] =
                CONCAT22(GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2, (uint)((FLEET **)rglpfl)[sel.scan.ifl]->id >> 9) & 0xffff000f;
        }
        GlobalPD.grPopup = 2;
        Popup(hwndMine, x, y);
        break;
    case 0xb:
        if (msg == 0x204) {
            iVar9 = *(int *)((FLEET **)rglpfl + sel.scan.ifl);
            iVar3 = *(int *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
            c = 0;
            for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
                if (0 < *(int *)(iVar9 + 0xc + ishdef * 2)) {
                    rgid[c] = ishdef;
                    iVar8 = *(int *)(iVar9 + 2) * 4;
                    __fstrcpy(local_20a + c * 0x20,
                              (char *)CONCAT22(*(undefined2 *)(iVar8 + rglpshdef_0x2), (char *)(*(int *)(iVar8 + rglpshdef) + ishdef * 0x93 + 8)));
                    rgpsz[c] = local_20a + c * 0x20;
                    c = c + 1;
                }
            }
            if (c < 2) {
                c = 0;
            } else {
                c = PopupMenu(hwndMine, x, y, c, 0, rgpsz, -1, 1);
                if (c == -1) {
                    return;
                }
            }
            GlobalPD.grPopup = 0xb;
            iVar8 = *(int *)(iVar9 + 2) * 4;
            GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = *(undefined2 *)(iVar8 + rglpshdef_0x2);
            GlobalPD.u_POPUPDATA_0x0002.lpfl._0_2_ = (FLEET *)(*(int *)(iVar8 + rglpshdef) + rgid[c] * 0x93);
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = (short)(idPlayer != *(int *)(iVar9 + 2));
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = 0;
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = 0;
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary = 1;
        } else {
            GlobalPD.grPopup = 3;
            GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = *(undefined2 *)((FLEET **)rglpfl + sel.scan.ifl);
            GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = *(int *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = (short)((*(uint *)((int)GlobalPD.u_POPUPDATA_0x0002.lpfl._0_2_ + 4) & 0xff) == 7);
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = 0xff;
        }
        Popup(hwndMine, x, y);
        break;
    case 0xc:
        GlobalPD.grPopup = 7;
        GlobalPD.u_POPUPDATA_0x0002.dxOut = sel.scan.idpl;
        Popup(hwndMine, x, y);
        break;
    case 0xd:
        GlobalPD.grPopup = 0xb;
        lppl = LpplFromId(sel.scan.idpl);
        uVar7 = (undefined2)((ulong)lppl >> 0x10);
        pPVar5 = (PLANET *)lppl;
        iVar9 = pPVar5->iPlayer * 4;
        GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = *(undefined2 *)(iVar9 + rglpshdefSB_0x2);
        GlobalPD.u_POPUPDATA_0x0002.lpfl._0_2_ = (FLEET *)(*(int *)(iVar9 + rglpshdefSB) + (*(uint *)&pPVar5->lStarbase & 0xf) * 0x93);
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = (short)(idPlayer != pPVar5->iPlayer);
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = 1;
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = 0;
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary = 1;
        Popup(hwndMine, x, y);
        break;
    case 0xe:
        local_14 = (uint) * (byte *)(*(byte *)((int)&((THING *)lpThings)[sel.scan.ith].u_THING_0x0006 + 6) + 0x50a);
        PStack_12.hs.wFlags_0x2 = PStack_12.hs.wFlags_0x2 & 0xff00 | local_14;
        PStack_12.hs.grhst = hstMines;
        FLookupPart(&PStack_12);
        GlobalPD.grPopup = 9;
        /* WARNING: Ignoring partial resolution of indirect */
        GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = PStack_12.hs.grhst;
        /* WARNING: Ignoring partial resolution of indirect */
        GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = PStack_12.hs.wFlags_0x2;
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = (short)PStack_12.u_PART_0x0004.parmor._0_2_;
        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = PStack_12.u_PART_0x0004._2_2_;
        Popup(hwndMine, x, y);
    }
    return;
}

// ======================================================================
// Function: SetMineralTitleBar
// Address: 1028:47dc
// Segment: MEMORY_MINE
// ======================================================================

/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

void SetMineralTitleBar(HWND hwnd)

{
    bool       bVar1;
    GrobjClass GVar2;
    short      sVar3;
    uint       uVar4;
    undefined2 unaff_SS;
    bool       bVar5;
    RECT       rc;
    short      grobj;
    char      *psz;
    short      fVisCB;
    char       szSummary[40];
    char       szDeepSpace[40];

    bVar5 = false;
    CchGetString(idsDeepSpace, szDeepSpace);
    CchGetString(idsSummary, szSummary);
    GVar2 = sel.scan.grobjFull;
    if (sel.scan.grobj != grobjOther) {
        GVar2 = sel.scan.grobj;
    }
    if ((GVar2 & grobjPlanet) == grobjNone) {
        if ((GVar2 & grobjFleet) == grobjNone) {
            if ((GVar2 & grobjThing) == grobjNone) {
                psz = szDeepSpace;
            } else {
                bVar5 = sel.scan.ith != -1;
                if (bVar5) {
                    psz = PszGetThingName(((THING *)lpThings + sel.scan.ith)->idFull);
                    _strcat(psz, szSummary);
                }
            }
        } else if (sel.scan.ifl != -1) {
            psz = PszGetFleetName(((FLEET **)rglpfl)[sel.scan.ifl]->id);
            _strcat(psz, szSummary);
        }
    } else if (sel.scan.idpl != -1) {
        psz = PszGetPlanetName(sel.scan.idpl);
        _strcat(psz, szSummary);
    }
    _strcpy((char *)szMineralTitle, psz);
    InvalidateRect(hwnd, 0, 1);
    bVar1 = false;
    if (bVar5) {
        if ((((((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0) && (*(char *)((int)&((THING *)lpThings)[sel.scan.ith].u_THING_0x0006 + 6) == '\0')) &&
             ((((THING *)lpThings + sel.scan.ith)->idFull >> 9 & 0xf) == idPlayer)) &&
            (sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv), sVar3 == raMines)) {
            bVar1 = true;
        } else {
            bVar1 = false;
        }
    }
    if (bVar1) {
        SendMessage(hwndMineCB, CB_LIMITTEXT, (uint)(*(char *)((int)&((THING *)lpThings)[sel.scan.ith].u_THING_0x0006 + 7) != '\0'), 0);
    }
    GetClientRect(hwnd, &rc);
    if (bVar1) {
        uVar4 = 0x40;
    } else {
        uVar4 = 0x80;
    }
    SetWindowPos(hwndMineCB, 0, 0x50, rc.bottom + dyArial8 * -2, rc.right + -0x58, dyArial8 + 4, uVar4 | 4);
    return;
}

// ======================================================================
// Function: DrawSelectionArrow
// Address: 1028:4a68
// Segment: MEMORY_MINE
// ======================================================================

void DrawSelectionArrow(HDC hdc, RECT *prc, short fEnabled)

{
    HDC     HVar1;
    HGDIOBJ HVar2;
    int     iVar3;
    short   sVar4;
    short   sVar5;
    short   xCtr;
    HDC     hdcMem;
    HBITMAP hbmpSav;

    HVar1 = CreateCompatibleDC(hdc);
    HVar2 = SelectObject(HVar1, hbmpScanner);
    iVar3 = (prc->right - prc->left) / 2 + prc->left;
    BitBlt(hdc, iVar3 + -5, (prc->bottom - prc->top >> 1) + prc->top + -5, 0xb, 0xc, HVar1, 0x23, 0x39, 0x8800c6);
    if (fEnabled == 0) {
        sVar4 = 0;
        sVar5 = 0x2d;
    } else {
        sVar4 = 0x18;
        sVar5 = 0x39;
    }
    BitBlt(hdc, iVar3 + -5, (prc->bottom - prc->top >> 1) + prc->top + -5, 0xb, 0xc, HVar1, sVar4, sVar5, 0xee0086);
    SelectObject(HVar1, HVar2);
    DeleteDC(HVar1);
    return;
}

// ======================================================================
// Function: DrawDiamond
// Address: 1028:4b60
// Segment: MEMORY_MINE
// ======================================================================

void DrawDiamond(HDC hdc, RECT *prc, HBRUSH hbr)

{
    int     iVar1;
    int     iVar2;
    int     iVar3;
    HGDIOBJ HVar4;
    short   xCur;
    short   dx;
    short   xCtr;
    short   yBot;
    short   yTop;
    HBRUSH  hbrSav;

    iVar3 = (prc->right - prc->left) / 2 + prc->left;
    yTop = prc->top;
    iVar1 = prc->bottom;
    HVar4 = SelectObject(hdc, hbrButtonHilite);
    yBot = iVar1 + -2;
    xCur = iVar3;
    while (yTop = yTop + 1, xCur = xCur + -1, yTop <= yBot) {
        PatBlt(hdc, xCur, yTop, 2, 1, 0xf00021);
        PatBlt(hdc, xCur, yBot, 2, 1, 0xf00021);
        yBot = yBot + -1;
    }
    SelectObject(hdc, hbrButtonShadow);
    PatBlt(hdc, iVar3, prc->top, 1, 1, 0xf00021);
    PatBlt(hdc, iVar3, prc->bottom + -1, 1, 1, 0xf00021);
    yTop = prc->top;
    xCur = iVar3;
    yBot = prc->bottom + -2;
    while (yTop = yTop + 1, yTop <= yBot) {
        PatBlt(hdc, xCur, yTop, 2, 1, 0xf00021);
        PatBlt(hdc, xCur, yBot, 2, 1, 0xf00021);
        xCur = xCur + 1;
        yBot = yBot + -1;
    }
    iVar1 = prc->top;
    iVar2 = prc->bottom;
    dx = 1;
    SelectObject(hdc, hbr);
    xCur = iVar3;
    yBot = iVar2 + -5;
    yTop = iVar1 + 4;
    while (yTop <= yBot) {
        PatBlt(hdc, xCur, yTop, dx, 1, 0xf00021);
        PatBlt(hdc, xCur, yBot, dx, 1, 0xf00021);
        dx = dx + 2;
        xCur = xCur + -1;
        yBot = yBot + -1;
        yTop = yTop + 1;
    }
    SelectObject(hdc, HVar4);
    return;
}

// ======================================================================
// Function: FOtherStuffAtScanSel
// Address: 1028:4d6e
// Segment: MEMORY_MINE
// ======================================================================

short FOtherStuffAtScanSel(void)

{
    int        iVar1;
    int        iVar2;
    short      sVar3;
    undefined2 uVar4;
    bool       bVar5;
    THING     *lpthMac;
    FLEET     *lpfl;
    THING     *lpth;
    short      i;
    short      c;

    if ((sel.scan.idpl == -1) || ((sel.scan.ifl == -1 && (sel.scan.ith == -1)))) {
        if (sel.scan.ifl != -1) {
            if (sel.scan.ith != -1) {
                return 1;
            }
            c = 1;
            for (i = 0; i < cFleet; i = i + 1) {
                iVar1 = *(int *)((FLEET **)rglpfl + i);
                iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                if ((iVar1 == 0) && (iVar2 == 0))
                    break;
                if ((*(int *)(iVar1 + 8) == sel.scan.pt.x) && ((*(int *)(iVar1 + 10) == sel.scan.pt.y && (bVar5 = c == 0, c = c + -1, bVar5)))) {
                    return 1;
                }
            }
        }
        if (sel.scan.ith != -1) {
            c = 1;
            lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
            while ((THING *)lpth < (THING *)lpThings + cThing) {
                uVar4 = (undefined2)((ulong)lpth >> 0x10);
                if ((((&((THING *)lpth)->pt)->x == sel.scan.pt.x) && ((((THING *)lpth)->pt).y == sel.scan.pt.y)) && (bVar5 = c == 0, c = c + -1, bVar5)) {
                    return 1;
                }
                lpth = (THING *)CONCAT22(uVar4, (THING *)lpth + 1);
            }
        }
        sVar3 = 0;
    } else {
        sVar3 = 1;
    }
    return sVar3;
}

// ======================================================================
// Function: PopupMineralScanChoices
// Address: 1028:4ecc
// Segment: MEMORY_MINE
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10285231) */
/* WARNING: Removing unreachable block (ram,0x10285166) */

void PopupMineralScanChoices(HWND hwnd, short x, short y)

{
    short     *psVar1;
    SCAN      *pSVar2;
    int        iVar3;
    FLEET     *pFVar4;
    short      sVar5;
    int        iVar6;
    short     *psVar7;
    SCAN      *pSVar8;
    undefined2 uVar9;
    undefined2 unaff_SS;
    bool       bVar10;
    PLANET    *pPVar11;
    SCAN       scan;
    short      iChecked;
    short      idNew;
    long       rgid[100];
    THING     *lpthMac;
    FLEET     *lpfl;
    THING     *lpth;
    short      c;
    short      i;
    PLANET    *lppl;
    short      fOurs;
    short      id;
    short      fSep;

    iChecked = -1;
    if (sel.scan.idpl == -1) {
        c = 0;
    } else {
        rgid[0]._2_2_ = sel.scan.idpl >> 0xf;
        rgid[0]._0_2_ = sel.scan.idpl;
        rgid[1]._0_2_ = 0xffff;
        rgid[1]._2_2_ = 0xffff;
        c = 2;
        if (sel.scan.grobj == grobjPlanet) {
            iChecked = 0;
        }
    }
    for (i = 0; i < cFleet; i = i + 1) {
        /* WARNING: Load size is inaccurate */
        pFVar4 = ((FLEET **)rglpfl)[i];
        iVar6 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar6, pFVar4);
        if ((pFVar4 == 0) && (iVar6 == 0))
            break;
        if ((sel.scan.pt.x == (&pFVar4->pt)->x) && (sel.scan.pt.y == (pFVar4->pt).y)) {
            if ((sel.scan.grobj == grobjFleet) && (((FLEET **)rglpfl)[sel.scan.ifl]->id == lpfl->id)) {
                iChecked = c;
            }
            iVar3 = lpfl->id;
            iVar6 = c + 1;
            *(int *)(rgid + c) = iVar3;
            *(uint *)((int)rgid + c * 4 + 2) = iVar3 >> 0xf | 0x8000;
            c = iVar6;
            if (99 < iVar6)
                break;
        }
    }
    if ((c == 2) && (sel.scan.idpl != -1)) {
        c = 1;
    }
    bVar10 = c == 0;
    lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
    while ((THING *)lpth < (THING *)lpThings + cThing) {
        uVar9 = (undefined2)((ulong)lpth >> 0x10);
        if ((sel.scan.pt.x == (&((THING *)lpth)->pt)->x) && (sel.scan.pt.y == (((THING *)lpth)->pt).y)) {
            if (!bVar10) {
                *(undefined2 *)(rgid + c) = 0xffff;
                *(undefined2 *)((int)rgid + c * 4 + 2) = 0xffff;
                bVar10 = true;
                c = c + 1;
            }
            if ((sel.scan.grobj == grobjThing) && (((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12 == sel.scan.ith)) {
                iChecked = c;
            }
            *(ushort *)(rgid + c) = lpth->idFull;
            *(undefined2 *)((int)rgid + c * 4 + 2) = 0x2000;
            c = c + 1;
        }
        lpth = (THING *)CONCAT22(uVar9, (THING *)lpth + 1);
    }
    sVar5 = PopupMenu(hwnd, x, y, c, rgid, 0, iChecked, 1);
    if (-1 < sVar5) {
        psVar7 = (short *)&sel.scan;
        pSVar8 = &scan;
        for (iVar6 = 8; iVar6 != 0; iVar6 = iVar6 + -1) {
            pSVar2 = pSVar8;
            pSVar8 = &(pSVar8->pt).y;
            psVar1 = psVar7;
            psVar7 = psVar7 + 1;
            (pSVar2->pt).x = *psVar1;
        }
        if ((*(uint *)((int)rgid + sVar5 * 4 + 2) & 0x8000) == 0) {
            if ((*(uint *)((int)rgid + sVar5 * 4 + 2) & 0x2000) == 0) {
                scan.grobj = grobjPlanet;
                idNew = sel.scan.idpl;
                pPVar11 = LpplFromId(sel.scan.idpl);
                bVar10 = ((PLANET *)pPVar11)->iPlayer == idPlayer;
            } else {
                scan.grobj = grobjThing;
                lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
                while (((THING *)lpth < (THING *)lpThings + cThing && (lpth->idFull != *(ushort *)(rgid + sVar5)))) {
                    lpth = (THING *)lpth + 1;
                }
                scan.ith = ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12;
                idNew = lpth->idFull;
                bVar10 = false;
            }
        } else {
            scan.grobj = grobjFleet;
            idNew = (short)rgid[sVar5];
            for (i = 0; i < cFleet; i = i + 1) {
                /* WARNING: Load size is inaccurate */
                pFVar4 = ((FLEET **)rglpfl)[i];
                iVar6 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                lpfl = (FLEET *)CONCAT22(iVar6, pFVar4);
                if (((pFVar4 == 0) && (iVar6 == 0)) || (lpfl->id == idNew))
                    break;
            }
            scan.ifl = i;
            bVar10 = ((FLEET *)lpfl)->iPlayer == idPlayer;
        }
        ChangeScanSel(&scan, 2);
        if (bVar10) {
            RedrawScanSel(0, 0);
            ChangeMainObjSel(scan.grobj, idNew);
            RedrawScanSel(0, 1);
        }
    }
    return;
}

// ======================================================================
// Function: EstMineralsMined
// Address: 1028:5362
// Segment: MEMORY_MINE
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10285712) */
/* WARNING: Removing unreachable block (ram,0x102854bf) */
/* WARNING: Removing unreachable block (ram,0x102856b7) */
/* WARNING: Removing unreachable block (ram,0x102856ca) */
/* WARNING: Removing unreachable block (ram,0x102854c4) */
/* WARNING: Removing unreachable block (ram,0x102856cf) */
/* WARNING: Removing unreachable block (ram,0x102856ee) */
/* WARNING: Removing unreachable block (ram,0x102856f3) */
/* WARNING: Removing unreachable block (ram,0x10285717) */
/* WARNING: Removing unreachable block (ram,0x1028582c) */
/* WARNING: Removing unreachable block (ram,0x1028563d) */
/* WARNING: Removing unreachable block (ram,0x10285775) */
/* WARNING: Removing unreachable block (ram,0x10285806) */

void EstMineralsMined(PLANET *lppl, long *plQuan, long cMines, short fApply)

{
    uint      *puVar1;
    byte       bVar2;
    FLEET     *pFVar3;
    int        iVar4;
    uint       uVar5;
    uint       uVar6;
    short      sVar7;
    PLANET    *pPVar8;
    ushort     unaff_DI;
    undefined2 uVar9;
    ulong      uVar10;
    long       lVar11;
    long       lVar12;
    long       lVar13;
    undefined2 uVar14;
    undefined2 uVar15;
    uint       uVar16;
    uint       uStack_2e;
    int        local_2c;
    uint       local_2a[2];
    undefined4 local_26;
    uint       local_22;
    undefined2 local_20;
    long       lMineEff;
    long       lMine;
    short      fRemote;
    short      fMacintosh;
    long       lQuan;
    short      i;
    long       lQuanAct;
    long       lQuanRem;

    fRemote = (short)(cMines != -1);
    uVar9 = (undefined2)((ulong)lppl >> 0x10);
    pPVar8 = (PLANET *)lppl;
    if ((pPVar8->iPlayer == -1) || (sVar7 = GetRaceStat((PLAYER *)rgplr + pPVar8->iPlayer, rsMajorAdv), sVar7 != raMacintosh)) {
        fMacintosh = 0;
    } else {
        fMacintosh = 1;
    }
    if (cMines == -1) {
        if ((pPVar8->iPlayer == -1) || (((int)pPVar8->rgwtMin[3] == 0 && (*(int *)((int)pPVar8->rgwtMin + 0xe) == 0)))) {
            for (i = 0; i < 3; i = i + 1) {
                *(undefined2 *)(plQuan + i) = 0xffff;
                *(undefined2 *)((int)(plQuan + i) + 2) = 0xffff;
            }
            return;
        }
        lMine._0_2_ = CMinesOperating(lppl);
        lMine._2_2_ = (short)lMine >> 0xf;
        if (fMacintosh == 0) {
            lMineEff._0_2_ = GetRaceStat((PLAYER *)rgplr + pPVar8->iPlayer, rsMineProd);
            lMineEff._2_2_ = (short)lMineEff >> 0xf;
        } else {
            lMineEff._0_2_ = 10;
            lMineEff._2_2_ = 0;
        }
        cMines = CONCAT22(lMine._2_2_, (short)lMine);
    } else {
        lMineEff._0_2_ = 10;
        lMineEff._2_2_ = 0;
    }
    lVar11 = CONCAT22(lQuan._2_2_, (uint)lQuan);
    lVar13 = CONCAT22(local_26._2_2_, (undefined2)local_26);
    i = 0;
    do {
        if (2 < i) {
            if ((fMacintosh != 0) && (fRemote == 0)) {
                for (local_2c = 0; local_2c < cFleet; local_2c = local_2c + 1) {
                    /* WARNING: Load size is inaccurate */
                    pFVar3 = ((FLEET **)rglpfl)[local_2c];
                    iVar4 = *(int *)((int)((FLEET **)rglpfl + local_2c) + 2);
                    if ((pFVar3 == 0) && (iVar4 == 0)) {
                        return;
                    }
                    if ((((pFVar3->idPlanet == lppl->id) && (pFVar3->iPlayer == pPVar8->iPlayer)) && ((pFVar3->wFlags_0x4 >> 10 & 1) == 0)) &&
                        ((pFVar3->cord < 2 && ((*(uint *)&((PLORD *)pFVar3->lpplord)[2].iordMax & 0xf) == 3)))) {
                        local_26 = lVar13;
                        lQuan = lVar11;
                        lMine = cMines;
                        lVar12 = CMineFromLpfl((FLEET *)CONCAT22(iVar4, pFVar3));
                        lVar13 = local_26;
                        lVar11 = lQuan;
                        cMines = lMine;
                        if ((-1 < lVar12) && ((0 < (int)((ulong)lVar12 >> 0x10) || ((int)lVar12 != 0)))) {
                            EstMineralsMined(lppl, local_2a, lVar12, fApply);
                            for (i = 0; i < 3; i = i + 1) {
                                uVar5 = local_2a[i * 2];
                                uVar6 = local_2a[i * 2 + 1];
                                puVar1 = (uint *)(plQuan + i);
                                uVar16 = *puVar1;
                                *puVar1 = *puVar1 + uVar5;
                                puVar1 = (uint *)((int)(plQuan + i) + 2);
                                *puVar1 = *puVar1 + uVar6 + (uint)CARRY2(uVar16, uVar5);
                            }
                            lVar13 = local_26;
                            lVar11 = lQuan;
                            cMines = lMine;
                            if (fApply != 0) {
                                pFVar3->wFlags_0x4 = pFVar3->wFlags_0x4 & 0xdfff;
                            }
                        }
                    }
                }
            }
            return;
        }
        local_22 = (uint)pPVar8->rgMinConc[i];
        if (((local_22 < 0x1e) && ((pPVar8->wFlags_0x4 >> 10 & 1) != 0)) && ((fRemote == 0 || (fMacintosh != 0)))) {
            local_22 = 0x1e;
        }
        local_20 = 0;
        local_26 = lVar13;
        lQuan = lVar11;
        lMine = cMines;
        uVar10 = __aFulmul(cMines, (ulong)local_22);
        lQuanAct = uVar10;
        if (fRemote == 0) {
            uVar15 = 0;
            uVar14 = 10;
            uVar10 = __aFulmul(uVar10, CONCAT22(lMineEff._2_2_, (short)lMineEff));
            uVar10 = __aFldiv(uVar10, CONCAT22(uVar15, uVar14));
        }
        lQuan = uVar10;
        lVar11 = __aFlrem(uVar10, 100);
        lQuanRem = lVar11;
        lVar11 = __aFldiv(lQuan, 100);
        lVar13 = local_26;
        if ((lQuanRem != 0) && (((uint)gd.grBits >> 1 & 1) != 0)) {
            lQuan = lVar11;
            sVar7 = Random(100);
            lVar11 = lQuan;
            lVar13 = CONCAT22(sVar7, (undefined2)local_26);
            if (sVar7 < (int)lQuanRem) {
                lVar11 = lQuan + 1;
                lVar13 = CONCAT22(sVar7, (undefined2)local_26);
            }
        }
        lQuan._2_2_ = (uint)((ulong)lVar11 >> 0x10);
        lQuan._0_2_ = (uint)lVar11;
        *(uint *)(plQuan + i) = (uint)lQuan;
        *(uint *)((int)(plQuan + i) + 2) = lQuan._2_2_;
        cMines = lMine;
        if (fApply != 0) {
            puVar1 = (uint *)(pPVar8->rgwtMin + i);
            uVar16 = *puVar1;
            *puVar1 = *puVar1 + (uint)lQuan;
            puVar1 = (uint *)((int)(pPVar8->rgwtMin + i) + 2);
            *puVar1 = *puVar1 + lQuan._2_2_ + (uint)CARRY2(uVar16, (uint)lQuan);
            lQuan = lVar11;
            local_26 = lVar13;
            lVar12 = __aFldiv(lQuanAct, 100);
            lVar13 = local_26;
            while (true) {
                lVar11 = lQuan;
                lQuanAct = lVar12;
                cMines = lMine;
                if ((lVar12 < 1) || (pPVar8->rgMinConc[i] < 2))
                    goto LAB_1028_588f;
                local_2a[0] = (uint)pPVar8->rgpctMinLevel[i];
                bVar2 = pPVar8->rgMinConc[i];
                uStack_2e = (uint)bVar2;
                if (local_2a[0] == 0) {
                    local_2a[0] = 0x100;
                }
                local_2a[1] = 0;
                if (bVar2 < 0x65) {
                    if (bVar2 < 5) {
                        uStack_2e = 10;
                    } else if (bVar2 < 0x19) {
                        uStack_2e = 0x19;
                    }
                } else {
                    uStack_2e = 100;
                }
                local_2c = 0;
                uVar15 = 0;
                uVar14 = 0x100;
                uVar16 = uStack_2e;
                local_26 = lVar13;
                uVar10 = __aFulmul((ulong)local_2a[0], 0x30d4);
                lVar11 = __aFldiv(uVar10, CONCAT22(uVar15, uVar14));
                lVar13 = __aFldiv(lVar11, CONCAT22(local_2c, uVar16));
                if (lQuanAct < lVar13)
                    break;
                lVar12 = lQuanAct - lVar13;
                pPVar8->rgMinConc[i] = pPVar8->rgMinConc[i] - 1;
                pPVar8->rgpctMinLevel[i] = 0;
            }
            local_26 = lVar13;
            lVar11 = __aFldiv(0x30d4, (ulong)uStack_2e);
            lVar13 = __aFlshl(lVar11, unaff_DI);
            lVar13 = __aFldiv(lVar13, lVar11);
            if (lVar13 < 1) {
                lVar13 = 1;
            }
            if (CONCAT22(local_2a[1], local_2a[0]) <= lVar13) {
                lVar13 = CONCAT22(local_2a[1] + -1 + (uint)(local_2a[0] != 0), local_2a[0] - 1);
            }
            pPVar8->rgpctMinLevel[i] = (byte)lVar13;
            lVar11 = lQuan;
            cMines = lMine;
            if (lVar13 == 0) {
                pPVar8->rgMinConc[i] = pPVar8->rgMinConc[i] - 1;
            }
        }
    LAB_1028_588f:
        i = i + 1;
    } while (true);
}
