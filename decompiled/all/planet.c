// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: PlanetWndProc
// Address: 1048:0000
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lpfl */
/* WARNING: Variable defined which should be unmapped: rc */
/* WARNING: Variable defined which should be unmapped: pt_2 */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

long PlanetWndProc(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  int iVar1;
  int *piVar2;
  POINT pt;
  POINT pt_00;
  uint uVar3;
  short sVar4;
  HWND HVar5;
  char *pcVar6;
  HDC hdc_00;
  BOOL BVar7;
  ushort uVar8;
  undefined2 unaff_SI;
  ushort unaff_DI;
  undefined2 unaff_SS;
  fn_lpfnRealEditProc *pfVar9;
  LRESULT LVar10;
  ulong uVar11;
  char *mbType;
  ushort in_stack_0000ff3a;
  FLEET *lpfl;
  PLANET *pPVar12;
  POINT pt_2;
  RECT rc;
  long lSel;
  char *psz;
  short i;
  XFER xf;
  PAINTSTRUCT ps;
  HDC hdc;
  
  if (message == WM_CREATE) {
    SetPlanetTitleBar(hwnd);
    for (i = 0; i < 3; i = i + 1) {
      if (i == 1) {
        uVar3 = 0x210;
      }
      else {
        uVar3 = 0;
      }
      if (i == 2) {
        sVar4 = 0xa0;
      }
      else {
        sVar4 = 0x50;
      }
      HVar5 = CreateWindow((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szCombobox),
                           (LPCSTR)0x11200876,CONCAT22(0x4020,uVar3 | 3),100,100,200,sVar4,hwnd,0,
                           hInst,(void *)0x0);
      ((ushort *)rghwndOrderDD)[i] = HVar5;
      SendMessage(((ushort *)rghwndOrderDD)[i],0x30,rghfontArial8[1],0);
    }
    for (i = 99; i < 0x6d; i = i + 1) {
      pcVar6 = PszGetCompressedString(i);
      SendMessage(rghwndOrderDD[0],0x403,0,
                  (LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar6));
    }
    hwndOrderED =
         CreateWindow((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szEdit),(LPCSTR)0x0,0x40800002,
                      100,100,200,0x32,hwnd,0,hInst,(void *)0x0);
    SendMessage(hwndOrderED,0x415,4,0);
    SendMessage(hwndOrderED,0x30,rghfontArial8[1],0);
    pfVar9 = (fn_lpfnRealEditProc *)GetWindowLong(hwndOrderED,-4);
    lpfnRealEditProc = pfVar9;
    SetWindowLong(hwndOrderED,-4,
                  (long)CONCAT22(lpfnFakeEditProc._2_2_,
                                 (fn_lpfnFakeEditProc *)lpfnFakeEditProc));
    hwndBattleDD =
         CreateWindow((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szCombobox),
                      s_BattleDD_1120_087c,0x40200003,100,100,200,0x50,hwnd,0,hInst,
                      (void *)0x0);
    SendMessage(hwndBattleDD,0x30,rghfontArial8[1],0);
    hwndShipDD =
         CreateWindow((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szCombobox),(LPCSTR)0x11200885,
                      0x40200213,100,100,200,0x50,hwnd,0,hInst,(void *)0x0);
    SendMessage(hwndShipDD,0x30,rghfontArial8[1],0);
    GetClientRect(hwndShipDD,(undefined2 *)CONCAT22(unaff_SS,&rc));
    dyShipDD = rc.bottom;
    hwndShipLB =
         CreateWindow((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szListbox),(LPCSTR)0x1120088c,
                      0x40a01001,100,100,200,0x50,hwnd,0,hInst,(void *)0x0);
    SendMessage(hwndShipLB,0x30,rghfontArial8[1],0);
    hwndFleetCompLB =
         CreateWindow((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szListbox),
                      s_FleetCompLB_1120_0893,0x40a00051,100,100,200,0x50,hwnd,0,hInst,
                      (void *)0x0);
    pt_2.x = 0x30;
    pt_2.y = hwndFleetCompLB;
    SendMessage(hwndFleetCompLB,0x30,rghfontArial8[0],0);
    pt_2.y = (short)&DAT_1120_1120;
    pt_2.x = (short)_szListbox;
    hwndPlanetProdLB =
         CreateWindow((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szListbox),
                      s_PlanetProdLB_1120_089f,0x40a00051,100,100,200,0x50,hwnd,0,hInst,
                      (void *)0x0);
    rc.left = 0x30;
    pt_2.y = rghfontArial8[0];
    pt_2.x = 0;
    rc.top = hwndPlanetProdLB;
    SendMessage(hwndPlanetProdLB,0x30,rghfontArial8[0],0);
    for (i = 0; i < 0xd; i = i + 1) {
      rc.top = i + idsCargo2;
      rc.left = 0x14f8;
      pt_2.y = 0x3aa;
      pt_2.x = (short)PszGetCompressedString(rc.top);
      rc.top = (short)&DAT_1120_1120;
      rc.left = (short)_szButton;
      pt_2.y = (short)&DAT_1120_1120;
      HVar5 = CreateWindow((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szButton),
                           (LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pt_2.x),0x40000000,100,100,
                           100,dyArial8 << 1,hwnd,0,hInst,(void *)0x0);
      ((ushort *)rghwndBtn)[i] = HVar5;
      rc.bottom = ((ushort *)rghwndBtn)[i];
      rc.right = 0x30;
      rc.top = rghfontArial8[1];
      rc.left = 0;
      pt_2.y = 0;
      pt_2.x = 0x14f8;
      SendMessage(rc.bottom,0x30,rghfontArial8[1],0);
    }
    rc.top = (short)&DAT_1120_1120;
    rc.left = (short)_szButton;
    pt_2.y = 799;
    pt_2.x = 0x14f8;
    pt_2.x = (short)PszGetCompressedString(idsRepeatOrders);
    pt_2.y = (short)&DAT_1120_1120;
    hwndRepCB =
         CreateWindow((LPCSTR)CONCAT22(rc.top,rc.left),
                      (LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pt_2.x),0x40000003,100,100,0x96,
                      dyArial8,hwnd,0,hInst,(void *)0x0);
    rc.right = 0x30;
    rc.top = rghfontArial8[1];
    rc.left = 0;
    pt_2.y = 0;
    pt_2.x = 0x14f8;
    rc.bottom = hwndRepCB;
    SendMessage(hwndRepCB,0x30,rghfontArial8[1],0);
  }
  else {
    if (message != WM_PAINT) {
      if (message == WM_ERASEBKGND) {
        GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
        FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
        uVar11 = 1;
        pfVar9 = lpfnRealEditProc;
        goto LAB_1048_0d0d;
      }
      if (message == WM_CTLCOLOR) {
        if ((HWND)lParam == hwndRepCB) {
          SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace
                                    ));
          SetTextColor(wParam,CONCAT22(crButtonText._2_2_,
                                       (undefined2)crButtonText));
          uVar11 = (ulong)hbrButtonFace;
          pfVar9 = lpfnRealEditProc;
          goto LAB_1048_0d0d;
        }
      }
      else if (message == WM_SETCURSOR) {
        GetCursorPos((undefined2 *)CONCAT22(unaff_SS,&pt_2));
        ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&pt_2));
        GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&stack0xff3c));
        BVar7 = PtInRect((undefined2 *)CONCAT22(&stack0xff3c,pt_2.y),pt_2.x);
        if (BVar7 != 0) {
          pt.y = pt_2.y;
          pt.x = pt_2.x;
          uVar8 = ClickInShipOrders(pt,0,1,0);
          if (uVar8 == 0) {
            pt_00.y = pt_2.y;
            pt_00.x = pt_2.x;
            uVar8 = ClickInPlanetOrders(pt_00,0,1,0);
          }
          if (uVar8 != 0) {
            setcursor(uVar8);
            uVar11 = 1;
            pfVar9 = lpfnRealEditProc;
            goto LAB_1048_0d0d;
          }
        }
      }
      else {
        if (message != WM_GETMINMAXINFO) {
          if (message == WM_DRAWITEM) {
            pt_2 = (POINT)lParam;
            if (*(int *)((HWND)lParam + 4) == -1) {
              HandleFocusState((DRAWITEMSTRUCT *)lParam,-2);
            }
            else {
              iVar1 = *(int *)((HWND)lParam + 6);
              if (iVar1 == 1) {
                DrawCBEntireItem((DRAWITEMSTRUCT *)lParam,-4);
              }
              else if (iVar1 == 2) {
                DrawCBEntireItem((DRAWITEMSTRUCT *)lParam,-4);
              }
              else if (iVar1 == 4) {
                DrawCBEntireItem((DRAWITEMSTRUCT *)lParam,-4);
              }
            }
            uVar11 = 1;
            pfVar9 = lpfnRealEditProc;
            goto LAB_1048_0d0d;
          }
          if (message == WM_MEASUREITEM) {
            *(int *)((HWND)lParam + 8) = dyArial8 + 2;
            uVar11 = 1;
            pfVar9 = lpfnRealEditProc;
            goto LAB_1048_0d0d;
          }
          if (message == WM_CHAR) {
            if ((wParam == 0x66) || (wParam == 0x46)) {
              pt_2.x = (short)((PLANET *)lpPlanets + cPlanet);
              pt_2.y = lpPlanets._2_2_;
              for (pPVar12 = (PLANET *)lpPlanets; pPVar12 < (uint)pt_2.x;
                  pPVar12 = pPVar12 + 1) {
                if (pPVar12->iPlayer == idPlayer) {
                  if ((sel.grobj != grobjPlanet) ||
                     (sel.id != ((PLANET *)CONCAT22(lpPlanets._2_2_,pPVar12))->id))
                  {
                    SelectAdjPlanet(0,((PLANET *)CONCAT22(lpPlanets._2_2_,pPVar12))->id);
                    uVar11 = 0;
                    pfVar9 = lpfnRealEditProc;
                    goto LAB_1048_0d0d;
                  }
                  break;
                }
              }
              for (i = 0; i < cFleet; i = i + 1) {
                piVar2 = *(int **)((FLEET **)rglpfl + i);
                iVar1 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                if ((piVar2 == (int *)0x0) && (iVar1 == 0)) break;
                if (piVar2[1] == idPlayer) {
                  if ((sel.grobj != grobjFleet) ||
                     (sel.id != *(int *)CONCAT22(iVar1,piVar2))) {
                    SelectAdjFleet(0,*(int *)CONCAT22(iVar1,piVar2));
                    uVar11 = 0;
                    pfVar9 = lpfnRealEditProc;
                    goto LAB_1048_0d0d;
                  }
                  break;
                }
              }
            }
          }
          else if (message == WM_COMMAND) {
            if (sel.grobj == grobjFleet) {
              ShipCommandProc(hwnd,wParam,lParam);
            }
            else {
              if ((HWND)lParam == hwndShipDD) {
                uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                if ((int)uVar11 == 1) {
                  DrawPlanShip(0,-0x7ffc);
                }
                goto PLANET_Default_6;
              }
              if ((HWND)lParam != rghwndBtn[4]) {
LAB_1048_0950:
                if ((HWND)lParam == rghwndBtn[5]) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 0) {
                    sVar4 = GetKeyState(0x10);
                    if (sVar4 < 0) {
                      sVar4 = IdFindAdjStarbase(sel.pl.id,1);
                      SelectAdjPlanet(0,sVar4);
                    }
                    else {
                      SelectAdjPlanet(1,0);
                    }
                    goto PLANET_LRefocus;
                  }
                }
                if ((HWND)lParam == rghwndBtn[0]) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 0) {
                    LVar10 = SendMessage(hwndShipDD,0x407,0,0);
                    if (LVar10 != -1) {
                      sVar4 = FLookupOrbitingXfer(sel.pl.id,(short)LVar10,&xf,-1);
                      if (sVar4 != 0) {
                        TransferStuff(sel.pl.id,1,xf.id,xf.grobj,0);
                        goto PLANET_LRefocus;
                      }
                    }
                    goto LAB_1048_0d04;
                  }
                }
                if ((HWND)lParam == rghwndBtn[1]) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 0) {
                    LVar10 = SendMessage(hwndShipDD,0x407,0,0);
                    if (LVar10 != -1) {
                      sVar4 = FLookupOrbitingXfer(sel.pl.id,(short)LVar10,&xf,-1);
                      if ((sVar4 != 0) && (xf.grobj == grobjFleet)) {
                        SelectAdjFleet(0,xf.id);
                      }
                    }
                    goto PLANET_LRefocus;
                  }
                }
                if ((HWND)lParam == rghwndBtn[2]) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 0) {
                    pt_2.x = 0x262;
                    pt_2.y = 0x1d6;
                    ShipBuilder((POINT)0x1d60262);
                    goto PLANET_LRefocus;
                  }
                }
                if ((HWND)lParam == rghwndBtn[0xb]) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 0) {
                    ChangeProduction(0);
                    goto PLANET_LRefocus;
                  }
                }
                if ((HWND)lParam == rghwndBtn[0xc]) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 0) {
                    mbType = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
                    pcVar6 = PszFormatIds(idsSureWantDeleteEverythingPlanetsProductionQueue,
                                               (short *)0x0);
                    sVar4 = AlertSz(pcVar6,(short)mbType);
                    if (sVar4 != 6) goto LAB_1048_0d04;
                    ChangeProduction(1);
                    goto PLANET_LRefocus;
                  }
                }
                if ((HWND)lParam == hwndPlanetProdLB) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 1) {
                    DrawPlanShip(0,0x40);
                    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
                      tutor.wFlags = tutor.wFlags & 0xfbffU | 0x400;
                      AdvanceTutor();
                    }
                  }
                }
                goto PLANET_Default_6;
              }
              uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
              if ((int)uVar11 != 0) goto LAB_1048_0950;
              sVar4 = GetKeyState(0x10);
              if (sVar4 < 0) {
                sVar4 = IdFindAdjStarbase(sel.pl.id,0);
                SelectAdjPlanet(0,sVar4);
              }
              else {
                SelectAdjPlanet(-1,0);
              }
PLANET_LRefocus:
              SetFocus(hwndFrame);
            }
          }
          else if (((message == WM_LBUTTONDOWN) || (message == WM_LBUTTONDBLCLK)) ||
                  (message == WM_RBUTTONDOWN)) {
            SetFocus(hwndFrame);
            uVar3 = (uint)(message == WM_RBUTTONDOWN);
            uVar11 = __aFulshr((ulong)CONCAT12(message == WM_RBUTTONDOWN,wParam),unaff_DI);
            PlanetClick((HWND)lParam,(short)uVar11,wParam,uVar3);
          }
          else {
            if (message != WM_MDIACTIVATE) goto PLANET_Default_6;
            hwndActive = hwnd;
            if (wParam == 0) {
              hwndActive = 0;
            }
          }
          goto LAB_1048_0d04;
        }
        *(int *)((HWND)lParam + 0xc) = dxWinFrame * 2 + 0xc6;
        *(int *)((HWND)lParam + 0xe) = dyWinFrame * 2 + 0xc6 + dyTitleBar;
      }
PLANET_Default_6:
      uVar11 = DefWindowProc(hwnd,message,wParam,lParam);
      pfVar9 = lpfnRealEditProc;
      goto LAB_1048_0d0d;
    }
    hdc_00 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    DrawPlanShip(hdc_00,0xfff);
    EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
  }
LAB_1048_0d04:
  uVar11 = 0;
  pfVar9 = lpfnRealEditProc;
LAB_1048_0d0d:
  lpfnRealEditProc._2_2_ = (undefined2)((ulong)pfVar9 >> 0x10);
  lpfnRealEditProc._0_2_ = (fn_lpfnRealEditProc *)pfVar9;
  return uVar11;
}



// ======================================================================
// Function: DrawPlanShip
// Address: 1048:0d16
// Segment: MEMORY_PLANET
// ======================================================================


void DrawPlanShip(HDC hdc,short grbit)

{
  short cLen;
  HGDIOBJ HVar1;
  OBJ OVar2;
  undefined2 unaff_SS;
  bool bVar3;
  COLORREF CVar4;
  COLORREF CVar5;
  RECT rc;
  short fDC;
  TILE *ptile;
  short fErase;
  COLORREF crBack;
  short i;
  short fMin;
  OBJ obj;
  COLORREF crFore;
  short ctile;
  OBJ objNull;
  HFONT hfontSav;
  
  if (sel.id == -1) {
    for (i = 0; i < 0xd; i = i + 1) {
      ShowWindow(((ushort *)rghwndBtn)[i],0);
    }
    for (i = 0; i < 3; i = i + 1) {
      ShowWindow(((ushort *)rghwndOrderDD)[i],0);
    }
    ShowWindow(hwndOrderED,0);
    ShowWindow(hwndShipDD,0);
    ShowWindow(hwndBattleDD,0);
    ShowWindow(hwndShipLB,0);
    ShowWindow(hwndFleetCompLB,0);
    ShowWindow(hwndPlanetProdLB,0);
    ShowWindow(hwndRepCB,0);
    for (i = 0; i < 0x13; i = i + 1) {
      *(undefined2 *)((int)&rgrcRef[0].bottom + i * 8) = 0xfffa;
      *(undefined2 *)((int)&rgrcRef[0].top + i * 8) = 0xfffb;
    }
    if (((*(uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0) & 1) != 0) &&
       (hdc != 0)) {
      GetClientRect(hwndPlanet,(undefined2 *)CONCAT22(unaff_SS,&rc));
      SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      cLen = CchGetString(idsDeceased,(char *)szWork);
      DiaganolTextOut(hdc,&rc,(char *)szWork,cLen);
    }
  }
  else {
    if (sel.grobj == grobjFleet) {
      ptile = (TILE *)(TILE *)&rgtileShip;
      ctile = 7;
      obj.ppl = (PLANET *)&sel.fl;
    }
    else {
      ptile = (TILE *)(TILE *)&rgtilePlanet;
      ctile = 6;
      obj.ppl = (PLANET *)&sel.pl;
    }
    bVar3 = hdc == 0;
    if (bVar3) {
      hdc = GetDC(hwndPlanet);
    }
    HVar1 = SelectObject(hdc,rghfontArial8[0]);
    CVar4 = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace)
                      );
    CVar5 = SetTextColor(hdc,CONCAT22(crButtonText._2_2_,
                                      (undefined2)crButtonText));
    for (i = 0; i < ctile; i = i + 1) {
      if ((grbit & ptile[i].grbit) != 0) {
        ptile[i].wFlags = ptile[i].wFlags & 0xfbffU | (uint)((grbit & 0x8000U) != 0) << 10;
        ptile[i].wFlags = ptile[i].wFlags & 0xefffU | (uint)((grbit & 0x4000U) != 0) << 0xc;
        OVar2.ppl = obj.ppl;
        if (((uint)ptile[i].wFlags >> 8 & 1) != 0) {
          OVar2.ppl = (PLANET *)0x0;
        }
        (**(code **)&ptile[i].field3_0x6)(0x14f8,hdc,ptile + i,OVar2.ppl);
      }
    }
    SetTextColor(hdc,CVar5);
    SetBkColor(hdc,CVar4);
    SelectObject(hdc,HVar1);
    if (bVar3) {
      ReleaseDC(hwndPlanet,hdc);
    }
  }
  return;
}



// ======================================================================
// Function: FDrawTileNC
// Address: 1048:1086
// Segment: MEMORY_PLANET
// ======================================================================


short FDrawTileNC(HDC hdc,TILE *ptile,RECT *prc,char *pszTitle)

{
  int iVar1;
  undefined2 unaff_SS;
  RECT rcT;
  short bt;
  
  prc->left = (ptile->wFlags & 7U) * 0xc6 + 4;
  prc->right = prc->left + 0xbe;
  prc->top = ptile->yTop;
  if (((uint)ptile->wFlags >> 7 & 1) == 0) {
    iVar1 = dyArial8 + 3;
  }
  else {
    iVar1 = ptile->dyFull;
  }
  prc->bottom = iVar1 + prc->top;
  if ((((uint)ptile->wFlags >> 0xc & 1) == 0) || (((uint)ptile->wFlags >> 9 & 1) != 0)) {
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      _Draw3dFrame(hdc,prc,0);
    }
    rcT.left = prc->left;
    rcT.top = prc->top;
    rcT.right = prc->right;
    rcT.bottom = prc->bottom;
    ExpandRc(&rcT,-1,-1);
    rcT.bottom = rcT.top + dyArial8 + 2;
    SelectObject(hdc,rghfontArial8[1]);
    SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
    SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      _Draw3dFrame(hdc,&rcT,0);
    }
    RcCtrTextOut(hdc,&rcT,pszTitle,-1);
    SetRect((undefined2 *)CONCAT22(unaff_SS,&rcT),prc->right + -0x11,prc->top + 1,prc->right,
            rcT.bottom + 1);
    if (((uint)ptile->wFlags >> 7 & 1) == 0) {
      bt = 0x71;
    }
    else {
      bt = 0x70;
    }
    DrawBtn(hdc,&rcT,bt,0,(char *)0x0);
    SelectObject(hdc,hbrButtonShadow);
    PatBlt(hdc,prc->right + -0x12,prc->top + 1,1,(rcT.bottom - prc->top) + -1,0xf00021);
  }
  prc->top = prc->top + dyArial8 + 4;
  return (uint)ptile->wFlags >> 7 & 1;
}



// ======================================================================
// Function: DrawPlanetMinSum
// Address: 1048:12b2
// Segment: MEMORY_PLANET
// ======================================================================


void DrawPlanetMinSum(HDC hdc,TILE *ptile,OBJ obj)

{
  short dxErase;
  char *pcVar1;
  short sVar2;
  int iVar3;
  int x;
  short sVar4;
  HGDIOBJ HVar5;
  uint uVar6;
  ushort unaff_SI;
  undefined2 unaff_DI;
  ulong uVar7;
  undefined1 *puVar8;
  int iVar9;
  undefined2 uVar10;
  HDC HVar11;
  RECT rc;
  PLANET *ppl;
  HBRUSH hbrSav;
  short xLeft;
  short i;
  short c;
  short xRight;
  short yTop;
  short dxRight;
  
  ppl = obj.ppl;
  if (((uint)ptile->wFlags >> 0xb & 1) != 0) {
    rgrcRef[6].top = -5;
    rgrcRef[6].bottom = -6;
    rgrcRef[7].top = -5;
    rgrcRef[7].bottom = -6;
    rgrcRef[8].top = -5;
    rgrcRef[8].bottom = -6;
    rgrcRef[9].top = -5;
    rgrcRef[9].bottom = -6;
    rgrcRef[0xb].top = -5;
    rgrcRef[0xb].bottom = -6;
    rgrcRef[10].top = -5;
    rgrcRef[10].bottom = -6;
  }
  pcVar1 = PszGetCompressedString(idsMineralsHand);
  sVar2 = FDrawTileNC(hdc,ptile,&rc,pcVar1);
  dxErase = dxMaxMineralQuan;
  if (sVar2 != 0) {
    if (obj.ppl == (PLANET *)0x0) {
      ppl = (PLANET *)&sel.pl;
    }
    iVar3 = rc.left + 4;
    x = rc.right + -4;
    yTop = rc.top;
    SetRect(&rgrcRef[6].left,iVar3,rc.top,x,dyArial8 * 3 + rc.top);
    for (i = 0; i < 3; i = i + 1) {
      if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
        SelectObject(hdc,rghfontArial8[1]);
        SetTextColor(hdc,CONCAT22(*(undefined2 *)(i * 4 + 0x44a),*(undefined2 *)(i * 4 + 0x448)));
        pcVar1 = (char *)*(undefined2 *)(i * 2 + 0x4cc);
        puVar8 = (undefined1 *)&DAT_1120_1120;
        sVar2 = yTop;
        iVar9 = iVar3;
        HVar11 = hdc;
        sVar4 = lstrlen((LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,
                                         (char *)*(undefined2 *)(i * 2 + 0x4cc)));
        TextOut(HVar11,iVar9,sVar2,(LPCSTR)CONCAT22(puVar8,pcVar1),sVar4);
      }
      SelectObject(hdc,rghfontArial8[0]);
      SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      uVar10 = (undefined2)ppl->rgwtMin[i];
      pcVar1 = PszGetCompressedString(idsLdkt);
      sVar2 = _WSPRINTF((LPSTR)CONCAT22(uVar10,(char *)&DAT_1120_1120),
                        (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
      RightTextOut(hdc,x,yTop,(char *)szWork,sVar2,dxErase);
      yTop = yTop + dyArial8;
    }
    HVar5 = SelectObject(hdc,hbrButtonHilite);
    iVar9 = yTop + 1;
    PatBlt(hdc,rc.left,yTop,rc.right - rc.left,1,0xf00021);
    SelectObject(hdc,HVar5);
    SetRect(&rgrcRef[7].left,iVar3,iVar9,x,dyArial8 * 2 + iVar9);
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      sVar2 = CchGetString(idsMines4,(char *)szWork);
      TextOut(hdc,iVar3,iVar9,szWork,sVar2);
      SelectObject(hdc,rghfontArial8[0]);
    }
    sVar2 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (sVar2 == raMacintosh) {
      sVar2 = CMinesOperating((PLANET *)CONCAT22((undefined1 *)&DAT_1120_1120,ppl));
      pcVar1 = PszGetCompressedString(idsD);
      c = _WSPRINTF((LPSTR)CONCAT22(sVar2,(char *)&DAT_1120_1120),
                    (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
    }
    else {
      sVar2 = CMaxOperableMines((PLANET *)CONCAT22((undefined1 *)&DAT_1120_1120,ppl),idPlayer
                                ,0);
      uVar7 = __aFulshr(CONCAT22(unaff_DI,sVar2),unaff_SI);
      uVar6 = (uint)uVar7 & 0xfff;
      pcVar1 = PszGetCompressedString(idsDD);
      c = _WSPRINTF((LPSTR)CONCAT22(uVar6,(char *)&DAT_1120_1120),
                    (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
    }
    RightTextOut(hdc,x,iVar9,(char *)szWork,c,dxErase << 1);
    iVar9 = iVar9 + dyArial8;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      sVar2 = CchGetString(idsFactories4,(char *)szWork);
      TextOut(hdc,iVar3,iVar9,szWork,sVar2);
      SelectObject(hdc,rghfontArial8[0]);
    }
    sVar2 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (sVar2 == raMacintosh) {
      c = CchGetString(idsN,(char *)szWork);
    }
    else {
      sVar2 = CMaxOperableFactories
                        ((PLANET *)CONCAT22((undefined1 *)&DAT_1120_1120,ppl),idPlayer,0);
      uVar7 = __aFulshr(CONCAT22(unaff_DI,sVar2),unaff_SI);
      uVar6 = (uint)uVar7 & 0xfff;
      pcVar1 = PszGetCompressedString(idsDD);
      c = _WSPRINTF((LPSTR)CONCAT22(uVar6,(char *)&DAT_1120_1120),
                    (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
    }
    RightTextOut(hdc,x,iVar9,(char *)szWork,c,dxErase << 1);
  }
  return;
}



// ======================================================================
// Function: DrawPlanetStats
// Address: 1048:1716
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10481c86) */
/* WARNING: Removing unreachable block (ram,0x10481af7) */
/* WARNING: Removing unreachable block (ram,0x10481ff2) */
/* WARNING: Removing unreachable block (ram,0x1048191e) */
/* WARNING: Removing unreachable block (ram,0x1048187a) */
/* WARNING: Removing unreachable block (ram,0x104817d6) */
/* WARNING: Removing unreachable block (ram,0x10481828) */
/* WARNING: Removing unreachable block (ram,0x104818cc) */
/* WARNING: Removing unreachable block (ram,0x10481970) */

void DrawPlanetStats(HDC hdc,TILE *ptile,OBJ obj)

{
  bool bVar1;
  char *pcVar2;
  short sVar3;
  int iVar4;
  HGDIOBJ HVar5;
  uint uVar6;
  StringId SVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  DWORD DVar8;
  DWORD DVar9;
  ulong uVar10;
  long lVar11;
  ushort in_stack_0000ffb2;
  undefined2 in_stack_0000ffb4;
  PART part_2;
  RECT rc;
  long l;
  HBRUSH hbrSav;
  short xLeft;
  char *psz;
  short dRange;
  short cResAvail;
  float pct;
  short dRangeP;
  short cRes;
  short c;
  short xRight;
  short yTop;
  long l2;
  short dxRight;
  
  pcVar2 = PszGetCompressedString(idsStatus);
  sVar3 = FDrawTileNC(hdc,ptile,&rc,pcVar2);
  if (sVar3 != 0) {
    iVar4 = rc.left + 4;
    xRight = rc.right + -4;
    yTop = rc.top;
    SelectObject(hdc,rghfontArial8[1]);
    c = CchGetString(idsPopulation4,(char *)szWork);
    DVar8 = GetTextExtent(hdc,szWork,c);
    c = CchGetString(idsScannerType,(char *)szWork);
    l2 = GetTextExtent(hdc,szWork,c);
    if ((long)DVar8 < l2) {
      DVar8 = l2;
    }
    c = CchGetString(idsScannerRange,(char *)szWork);
    DVar9 = GetTextExtent(hdc,szWork,c);
    if ((long)DVar8 < (long)DVar9) {
      DVar8 = DVar9;
    }
    l2 = DVar9;
    c = CchGetString(idsDefenses4,(char *)szWork);
    DVar9 = GetTextExtent(hdc,szWork,c);
    if ((long)DVar8 < (long)DVar9) {
      DVar8 = DVar9;
    }
    l2 = DVar9;
    c = CchGetString(idsDefenseType,(char *)szWork);
    DVar9 = GetTextExtent(hdc,szWork,c);
    if ((long)DVar8 < (long)DVar9) {
      DVar8 = DVar9;
    }
    l2 = DVar9;
    c = CchGetString(idsDefCoverage,(char *)szWork);
    DVar9 = GetTextExtent(hdc,szWork,c);
    if ((long)DVar8 < (long)DVar9) {
      DVar8 = DVar9;
    }
    l2 = DVar9;
    c = CchGetString(idsResourcesYear,(char *)szWork);
    DVar9 = GetTextExtent(hdc,szWork,c);
    if ((long)DVar8 < (long)DVar9) {
      DVar8 = DVar9;
    }
    l._0_2_ = (int)DVar8;
    dxRight = (xRight - iVar4) - (int)l;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      l2 = DVar9;
      c = CchGetString(idsPopulation4,(char *)szWork);
      TextOut(hdc,iVar4,yTop,szWork,c);
      DVar9 = l2;
    }
    l2 = DVar9;
    SelectObject(hdc,rghfontArial8[0]);
    SetRect(&rgrcRef[9].left,iVar4,yTop,xRight,yTop + dyArial8);
    uVar10 = __aFulmul(CONCAT22(sel.pl.rgwtMin[3]._2_2_,
                                        (undefined2)sel.pl.rgwtMin[3]),100);
    c = CommaFormatLong((char *)szWork,uVar10);
    RightTextOut(hdc,xRight,yTop,(char *)szWork,c,dxRight);
    yTop = yTop + dyArial8;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsResourcesYear,(char *)szWork);
      TextOut(hdc,iVar4,yTop,szWork,c);
      SelectObject(hdc,rghfontArial8[0]);
    }
    SetRect(&rgrcRef[8].left,iVar4,yTop,xRight,yTop + dyArial8);
    cResAvail = CResourcesAtPlanet(&sel.pl,idPlayer);
    cRes = cResAvail;
    uVar10 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffb2);
    if ((uVar10 & 1) == 0) {
      sVar3 = MulDiv(cRes,(int)*(char *)((int)&rgplr[0].pctResearch +
                                        idPlayer * 0xc0),100);
      cResAvail = cResAvail - sVar3;
    }
    pcVar2 = PszGetCompressedString(idsDD);
    c = _WSPRINTF((LPSTR)CONCAT22(cResAvail,(char *)&DAT_1120_1120),
                  (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
    RightTextOut(hdc,xRight,yTop,(char *)szWork,c,dxRight);
    yTop = yTop + dyArial8;
    HVar5 = SelectObject(hdc,hbrButtonHilite);
    sVar3 = yTop;
    yTop = yTop + 1;
    PatBlt(hdc,rc.left,sVar3,rc.right - rc.left,1,0xf00021);
    SelectObject(hdc,HVar5);
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsScannerType,(char *)szWork);
      TextOut(hdc,iVar4,yTop,szWork,c);
      SelectObject(hdc,rghfontArial8[0]);
    }
    SetRect(&rgrcRef[0xb].left,iVar4,yTop,xRight,dyArial8 * 2 + yTop);
    sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (sVar3 == raMacintosh) {
      CchGetString(idsOrganic,(char *)szWork);
      dRange = GetPlanetScannerRange(&sel.pl,&dRangeP);
    }
    else {
      uVar10 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffb2);
      if (((uint)uVar10 & 0x1f) == 0x1f) {
        CchGetString(idsNone4,(char *)szWork);
        dRange = 0;
      }
      else {
        LookupBestPlanetaryScanner(&part_2);
        __fstrcpy(szWork,
                          (char *)CONCAT22(part_2.pcom._2_2_,((COMPART *)part_2.pcom)->szName));
        dRange = GetPlanetScannerRange(&sel.pl,&dRangeP);
      }
    }
    RightTextOut(hdc,xRight,yTop,(char *)szWork,0,dxRight);
    yTop = yTop + dyArial8;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsScannerRange,(char *)szWork);
      TextOut(hdc,iVar4,yTop,szWork,c);
      SelectObject(hdc,rghfontArial8[0]);
    }
    if (dRange < 1) {
      CchGetString(idsNone4,(char *)szWork);
      c = 0;
    }
    else if (dRangeP < 1) {
      if (dRange < 100) {
        pcVar2 = PszGetCompressedString(idsDLightYears);
        c = _WSPRINTF((LPSTR)CONCAT22(dRange,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
      }
      else {
        pcVar2 = PszGetCompressedString(idsDLY);
        c = _WSPRINTF((LPSTR)CONCAT22(dRange,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
      }
    }
    else {
      pcVar2 = PszGetCompressedString(idsDDLY);
      c = _WSPRINTF((LPSTR)CONCAT22(dRangeP,(char *)&DAT_1120_1120),
                    (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
    }
    RightTextOut(hdc,xRight,yTop,(char *)szWork,c,dxRight);
    yTop = yTop + dyArial8;
    HVar5 = SelectObject(hdc,hbrButtonHilite);
    sVar3 = yTop;
    yTop = yTop + 1;
    PatBlt(hdc,rc.left,sVar3,rc.right - rc.left,1,0xf00021);
    SelectObject(hdc,HVar5);
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsDefenses4,(char *)szWork);
      TextOut(hdc,iVar4,yTop,szWork,c);
    }
    SelectObject(hdc,rghfontArial8[0]);
    SetRect(&rgrcRef[10].left,iVar4,yTop,xRight,dyArial8 * 3 + yTop);
    sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (sVar3 == raMacintosh) {
      c = CchGetString(idsN,(char *)szWork);
    }
    else {
      CMaxOperableDefenses(&sel.pl,idPlayer,0);
      uVar6 = (uint)sel.pl.dwFlags & 0xfff;
      pcVar2 = PszGetCompressedString(idsDD);
      c = _WSPRINTF((LPSTR)CONCAT22(uVar6,(char *)&DAT_1120_1120),
                    (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
    }
    RightTextOut(hdc,xRight,yTop,(char *)szWork,c,dxRight);
    yTop = yTop + dyArial8;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsDefenseType,(char *)szWork);
      TextOut(hdc,iVar4,yTop,szWork,c);
      SelectObject(hdc,rghfontArial8[0]);
    }
    if (((uint)sel.pl.dwFlags & 0xfff) == 0) {
      pcVar2 = (char *)szWork;
      sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
      if (sVar3 == raMacintosh) {
        SVar7 = idsN;
      }
      else {
        SVar7 = idsNone4;
      }
      CchGetString(SVar7,pcVar2);
      bVar1 = false;
    }
    else {
      FGetBestDefensePart(&part_2);
      __fstrcpy(szWork,
                        (char *)CONCAT22(part_2.pcom._2_2_,((COMPART *)part_2.pcom)->szName));
      bVar1 = true;
    }
    RightTextOut(hdc,xRight,yTop,(char *)szWork,0,dxRight);
    yTop = yTop + dyArial8;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsDefCoverage,(char *)szWork);
      TextOut(hdc,iVar4,yTop,szWork,c);
      SelectObject(hdc,rghfontArial8[0]);
    }
    if (bVar1) {
      CalcPctSurvive(&sel.pl,&pct,(float *)0x0);
      pct = DAT_1120_1d22 - pct;
      part_2.hs.grhst = hstBomb|hstTorp|hstShield;
      part_2.hs.wFlags = 0;
      __ftol((double)CONCAT26(in_stack_0000ffb4,
                                      CONCAT24(in_stack_0000ffb2,CONCAT22(unaff_SI,unaff_DI))));
      lVar11 = __ftol((double)CONCAT26(in_stack_0000ffb4,
                                               CONCAT24(in_stack_0000ffb2,
                                                        CONCAT22(unaff_SI,unaff_DI))));
      lVar11 = __ftol((double)CONCAT26(100,CONCAT24(unaff_SI,CONCAT22(unaff_DI,(int)lVar11))
                                              ));
      c = _WSPRINTF((LPSTR)CONCAT22((int)lVar11,(char *)&DAT_1120_1120),
                    (LPCSTR)CONCAT22(PCTDXPCTDPCTPCT,(char *)&DAT_1120_1120),
                    (char *)szWork);
    }
    else {
      pcVar2 = (char *)szWork;
      sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
      if (sVar3 == raMacintosh) {
        SVar7 = idsN;
      }
      else {
        SVar7 = idsNone4;
      }
      c = CchGetString(SVar7,pcVar2);
    }
    RightTextOut(hdc,xRight,yTop,(char *)szWork,c,dxRight);
  }
  return;
}



// ======================================================================
// Function: FGetBestDefensePart
// Address: 1048:21f6
// Segment: MEMORY_PLANET
// ======================================================================


short FGetBestDefensePart(PART *ppart)

{
  bool bVar1;
  short sVar2;
  PART part;
  short i;
  short fRet;
  
  part.hs.grhst = hstPlanetary;
  part.hs.wFlags = part.hs.wFlags & 0xff00U | 9;
  i = 0;
  while ((i < 5 && (sVar2 = FLookupPart(&part), sVar2 == 1))) {
    i = i + 1;
    part.hs.wFlags = part.hs.wFlags & 0xff00U | part.hs.wFlags + 1U & 0xff;
  }
  bVar1 = 0 < i;
  if (bVar1) {
    i = i + -1;
  }
  fRet = (short)bVar1;
  part.hs.wFlags = part.hs.wFlags & 0xff00U | i + 9U & 0xff;
  FLookupPart(&part);
  (ppart->hs).grhst = part.hs.grhst;
  (ppart->hs).wFlags = part.hs.wFlags;
  *(COMPART **)&ppart->pcom = (COMPART *)part.pcom;
  *(undefined2 *)((int)&ppart->pcom + 2) = part.pcom._2_2_;
  return fRet;
}



// ======================================================================
// Function: DrawPlanetStarbase
// Address: 1048:22cc
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1048252c) */

void DrawPlanetStarbase(HDC hdc,TILE *ptile,OBJ obj)

{
  undefined2 uVar1;
  short sVar2;
  int iVar3;
  int x;
  char *pcVar4;
  HGDIOBJ HVar5;
  short sVar6;
  int iVar7;
  SHDEF *pSVar8;
  int dxErase;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  DWORD DVar9;
  HULDEF *pHVar10;
  long lVar11;
  COLORREF CVar12;
  int iVar13;
  RECT rc;
  long l;
  HBRUSH hbrSav;
  short xLeft;
  char *psz;
  ushort w;
  COLORREF crForeSav;
  SHDEF *lpshdef;
  short c;
  short xRight;
  short yTop;
  short bt;
  short iWarp;
  short dxRight;
  short fTwo;
  
  if (((uint)ptile->wFlags >> 0xb & 1) != 0) {
    rgrcRef[0xd].top = -5;
    rgrcRef[0xd].bottom = -6;
    rgrcRef[0xe].top = -5;
    rgrcRef[0xe].bottom = -6;
    rgrcRef[0x10].top = -5;
    rgrcRef[0x10].bottom = -6;
    rgrcRef[0xf].top = -5;
    rgrcRef[0xf].bottom = -6;
    ptile->wFlags = ptile->wFlags & 0xf7ff;
  }
  if (((uint)sel.pl.wFlags >> 9 & 1) == 0) {
    psz = PszGetCompressedString(idsStarbase2);
  }
  else {
    uVar1 = *(undefined2 *)(idPlayer * 4 + 0x14e);
    pSVar8 = (SHDEF *)(*(int *)(idPlayer * 4 + 0x14c) +
                      (sel.pl._44_2_ & 0xf) * 0x93);
    lpshdef = (SHDEF *)CONCAT22(uVar1,pSVar8);
    __fstrcpy(szWork,(char *)CONCAT22(uVar1,(pSVar8->hul).szClass));
    psz = (char *)szWork;
  }
  sVar2 = FDrawTileNC(hdc,ptile,&rc,psz);
  if (sVar2 != 0) {
    iVar3 = rc.left + 4;
    x = rc.right + -4;
    SetRect((undefined2 *)CONCAT22(unaff_SS,&rc),rc.left + 2,rc.top,rc.right + -2,rc.bottom + -2);
    FillRect(hdc,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    if (((uint)sel.pl.wFlags >> 9 & 1) == 0) {
      SetRect(&rgrcRef[0xe].left,-5,-5,-6,-6);
      rgrcRef[0xf].left = rgrcRef[0xe].left;
      rgrcRef[0xf].top = rgrcRef[0xe].top;
      rgrcRef[0xf].right = rgrcRef[0xe].right;
      rgrcRef[0xf].bottom = rgrcRef[0xe].bottom;
      rgrcRef[0x10].left = rgrcRef[0xe].left;
      rgrcRef[0x10].top = rgrcRef[0xe].top;
      rgrcRef[0x10].right = rgrcRef[0xe].right;
      rgrcRef[0x10].bottom = rgrcRef[0xe].bottom;
    }
    else {
      SetRect(&rgrcRef[0xe].left,iVar3,rc.top,x,dyArial8 * 4 + rc.top);
      SelectObject(hdc,rghfontArial8[1]);
      sVar2 = CchGetString(idsDockCapacity,(char *)szWork);
      DVar9 = GetTextExtent(hdc,szWork,sVar2);
      dxErase = (x - iVar3) - (int)DVar9;
      TextOut(hdc,iVar3,rc.top,szWork,sVar2);
      SelectObject(hdc,rghfontArial8[0]);
      pHVar10 = LphuldefFromId((lpshdef->hul).ihuldef);
      iVar7 = (((HULDEF *)pHVar10)->hul).wtCargoMax;
      if (iVar7 == 0) {
        c = CchGetString(idsNone4,(char *)szWork);
      }
      else if (iVar7 == -1) {
        c = CchGetString(idsUnlimited,(char *)szWork);
      }
      else {
        c = _WSPRINTF((LPSTR)CONCAT22(iVar7,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(PCTDKT,(char *)&DAT_1120_1120),
                      (char *)szWork);
      }
      RightTextOut(hdc,x,rc.top,(char *)szWork,c,dxErase);
      iVar7 = rc.top + dyArial8;
      SelectObject(hdc,rghfontArial8[1]);
      sVar2 = CchGetString(idsArmor2,(char *)szWork);
      TextOut(hdc,iVar3,iVar7,szWork,sVar2);
      iVar13 = (((SHDEF *)lpshdef)->hul).dp;
      if (iVar13 == 0) {
        c = CchGetString(idsNone4,(char *)szWork);
      }
      else {
        pcVar4 = PszGetCompressedString(idsLddp);
        c = _WSPRINTF((LPSTR)CONCAT22(iVar13,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar4,(char *)&DAT_1120_1120),(char *)szWork);
      }
      SelectObject(hdc,rghfontArial8[0]);
      RightTextOut(hdc,x,iVar7,(char *)szWork,c,dxErase);
      iVar7 = iVar7 + dyArial8;
      SelectObject(hdc,rghfontArial8[1]);
      sVar2 = CchGetString(idsShields2,(char *)szWork);
      TextOut(hdc,iVar3,iVar7,szWork,sVar2);
      lVar11 = DpShieldOfShdef(lpshdef,idPlayer);
      if (lVar11 == 0) {
        c = CchGetString(idsNone4,(char *)szWork);
      }
      else {
        pcVar4 = PszGetCompressedString(idsLddp);
        c = _WSPRINTF((LPSTR)CONCAT22((int)lVar11,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar4,(char *)&DAT_1120_1120),(char *)szWork);
      }
      SelectObject(hdc,rghfontArial8[0]);
      RightTextOut(hdc,x,iVar7,(char *)szWork,c,dxErase);
      iVar7 = iVar7 + dyArial8;
      SelectObject(hdc,rghfontArial8[1]);
      sVar2 = CchGetString(idsDamage2,(char *)szWork);
      TextOut(hdc,iVar3,iVar7,szWork,sVar2);
      SelectObject(hdc,rghfontArial8[0]);
      w = (uint)sel.pl._44_2_ >> 4;
      if (w == 0) {
        c = CchGetString(idsNone4,(char *)szWork);
        CVar12 = CONCAT22(crForeSav._2_2_,(undefined2)crForeSav);
      }
      else {
        if (w < 5) {
          w = 5;
        }
        c = _WSPRINTF((LPSTR)CONCAT22(w / 5,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(PCTDPCTPCT,(char *)&DAT_1120_1120),
                      (char *)szWork);
        CVar12 = SetTextColor(hdc,0x7f);
      }
      RightTextOut(hdc,x,iVar7,(char *)szWork,c,dxErase);
      iVar7 = iVar7 + dyArial8;
      if (w != 0) {
        SetTextColor(hdc,CVar12);
      }
      HVar5 = SelectObject(hdc,hbrButtonHilite);
      iVar13 = iVar7 + 1;
      PatBlt(hdc,rc.left,iVar7,rc.right - rc.left,1,0xf00021);
      SelectObject(hdc,HVar5);
      SelectObject(hdc,rghfontArial8[1]);
      SetRect(&rgrcRef[0x10].left,iVar3,iVar13,x,iVar13 + dyArial8);
      sVar2 = CchGetString(idsMassDriver,(char *)szWork);
      TextOut(hdc,iVar3,iVar13,szWork,sVar2);
      sVar2 = IWarpMAFromLppl(&sel.pl,&fTwo);
      if (sVar2 < 1) {
        pcVar4 = PszGetCompressedString(idsNone4);
        c = _WSPRINTF((LPSTR)CONCAT22(unaff_DI,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar4,(char *)&DAT_1120_1120),(char *)szWork);
      }
      else {
        sVar6 = sVar2;
        pcVar4 = PszGetCompressedString(idsWarpD);
        c = _WSPRINTF((LPSTR)CONCAT22(sVar6,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar4,(char *)&DAT_1120_1120),(char *)szWork);
        if (fTwo != 0) {
          ((char *)szWork)[c] = '+';
          c = c + 1;
        }
      }
      SelectObject(hdc,rghfontArial8[0]);
      RightTextOut(hdc,x,iVar13,(char *)szWork,c,dxErase);
      iVar13 = iVar13 + dyArial8;
      SelectObject(hdc,rghfontArial8[1]);
      sVar6 = CchGetString(idsDestination3,(char *)szWork);
      TextOut(hdc,iVar3,iVar13,szWork,sVar6);
      if ((sel.pl.wFlags & 0x3ffU) == 0) {
        c = CchGetString(idsNone4,(char *)szWork);
      }
      else {
        pcVar4 = PszGetCompressedPlanet
                           (((short *)rgidPlan)[(sel.pl.wFlags & 0x3ffU) - 1]);
        c = 0;
        _strcpy((char *)szWork,pcVar4);
      }
      SelectObject(hdc,rghfontArial8[0]);
      RightTextOut(hdc,x,iVar13,(char *)szWork,c,dxErase);
      iVar13 = iVar13 + dyArial8;
      iVar7 = (x - iVar3) / 3;
      SetRect(&rgrcRef[0xd].left,iVar3,iVar13,iVar3 + iVar7,
              iVar13 + dyArial8 + 6);
      bt = 8;
      if (sVar2 == 0) {
        bt = 0xc;
      }
      pcVar4 = PszGetCompressedString(idsSetDest);
      DrawBtn(hdc,(RECT *)(rgrcRef + 0xd),bt,(uint)gd.wFlags >> 8 & 1,
                       pcVar4);
      if (sVar2 < 1) {
        SetRect(&rgrcRef[0xf].left,-5,-5,-6,-6);
        rgrcRef[0x10].left = rgrcRef[0xf].left;
        rgrcRef[0x10].top = rgrcRef[0xf].top;
        rgrcRef[0x10].right = rgrcRef[0xf].right;
        rgrcRef[0x10].bottom = rgrcRef[0xf].bottom;
      }
      else {
        SetRect(&rgrcRef[0xf].left,iVar3 + iVar7 + 4,iVar13 + 3,x,
                iVar13 + dyArial8 + 3);
        if (fTwo != 0) {
          sVar2 = -sVar2;
        }
        DrawMassWarpGauge(hdc,(RECT *)(rgrcRef + 0xf),sVar2,
                          ((uint)sel.pl.wFlags >> 10 & 0xf) + 4);
      }
    }
  }
  return;
}



// ======================================================================
// Function: DrawMassWarpGauge
// Address: 1048:2afa
// Segment: MEMORY_PLANET
// ======================================================================


void DrawMassWarpGauge(HDC hdc,RECT *prc,short iBest,short iCur)

{
  undefined2 uVar1;
  char *pcVar2;
  long lVar3;
  long l;
  long lCur;
  HBRUSH hbr;
  short iMode;
  short fTwoMAs;
  short c;
  long lMax;
  
  fTwoMAs = (short)(iBest < 0);
  SelectObject(hdc,rghfontArial8[1]);
  if (iCur < 5) {
    iCur = 5;
  }
  if (iBest < 0) {
    iBest = -iBest;
  }
  lMax._0_2_ = iBest + -1;
  lMax._2_2_ = (int)lMax >> 0xf;
  if (iBest + fTwoMAs < iCur) {
    if (iCur < iBest + fTwoMAs + 3) {
      hbr = hbrYellow;
    }
    else {
      hbr = hbrRed;
    }
  }
  else {
    hbr = hbrPurple;
  }
  lCur._0_2_ = iCur + -4;
  lCur._2_2_ = (int)lCur >> 0xf;
  lVar3 = LDrawGauge(hdc,prc,1,&lCur,&hbr,(long)(int)lMax);
  iMode = SetBkMode(hdc,1);
  uVar1 = (undefined2)(lVar3 + 4);
  pcVar2 = PszGetCompressedString(idsWarpLd);
  c = _WSPRINTF((LPSTR)CONCAT22(uVar1,(char *)&DAT_1120_1120),
                (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
  GetTextExtent(hdc,szWork,c);
  RcCtrTextOut(hdc,prc,(char *)szWork,c);
  SetBkMode(hdc,iMode);
  return;
}



// ======================================================================
// Function: DrawPlanetProduction
// Address: 1048:2c38
// Segment: MEMORY_PLANET
// ======================================================================


void DrawPlanetProduction(HDC hdc,TILE *ptile,OBJ obj)

{
  char *pcVar1;
  short sVar2;
  int iVar3;
  int iVar4;
  BOOL BVar5;
  undefined2 unaff_SS;
  LRESULT LVar6;
  DWORD DVar7;
  RECT rc;
  PLANET *ppl;
  RECT rcT;
  short xLeft;
  short cch;
  short iSel;
  char *psz;
  short dyWrong;
  short c;
  short i;
  char szT [40];
  short xRight;
  short xStart;
  short yTop;
  short dxRight;
  short swp;
  
  if (((uint)ptile->wFlags >> 0xb & 1) != 0) {
    ShowWindow(hwndPlanetProdLB,0);
    ShowWindow(rghwndBtn[0xb],0);
    ShowWindow(rghwndBtn[0xc],0);
    rgrcRef[0x11].top = -5;
    rgrcRef[0x11].bottom = -6;
    ptile->wFlags = ptile->wFlags & 0xf7ff;
  }
  pcVar1 = PszGetCompressedString(idsProduction);
  sVar2 = FDrawTileNC(hdc,ptile,&rc,pcVar1);
  if (sVar2 == 0) {
    ShowWindow(hwndPlanetProdLB,0);
    ShowWindow(rghwndBtn[0xb],0);
    ShowWindow(rghwndBtn[0xc],0);
  }
  else {
    xStart = rc.left + 4;
    iVar3 = rc.right + -4;
    GetClientRect(hwndPlanetProdLB,(undefined2 *)CONCAT22(unaff_SS,&rcT));
    swp = 0x14;
    if (((uint)gd.wFlags >> 3 & 1) == 0) {
      iVar4 = 5;
    }
    else {
      iVar4 = 3;
    }
    dyPlanetProdLB = (dyArial8 + 2) * iVar4;
    iVar4 = dyPlanetProdLB - (rcT.bottom - rcT.top);
    if (((dxPlanetProdLB == iVar3 - xStart) && (-1 < iVar4)) && (iVar4 < dyArial8))
    {
      swp = 0x15;
    }
    else {
      dxPlanetProdLB = iVar3 - xStart;
    }
    SetWindowPos(hwndPlanetProdLB,0,xStart,rc.top + 4,iVar3 - xStart,dyPlanetProdLB
                 ,swp);
    ShowWindow(hwndPlanetProdLB,5);
    GetClientRect(hwndPlanetProdLB,(undefined2 *)CONCAT22(unaff_SS,&rcT));
    dyPlanetProdLB = rcT.bottom - rcT.top;
    iVar4 = rc.top + 4 + dyPlanetProdLB + 4;
    LVar6 = SendMessage(hwndPlanetProdLB,0x409,0,0);
    iSel = (short)LVar6;
    if (iSel < 0) {
      iSel = 0;
    }
    if (((*(int *)&(obj.ppl)->lpplprod == 0) && (*(int *)((int)&(obj.ppl)->lpplprod + 2) == 0)) ||
       (((PLPROD *)(obj.ppl)->lpplprod)->iprodMac == 0)) {
      c = 0;
      szWork[0] = '\0';
    }
    else {
      pcVar1 = PszProductionETA((PLANET *)CONCAT22((undefined1 *)&DAT_1120_1120,obj.ppl),
                                (PLPROD *)0x0,iSel,(short *)0x0,(short *)0x0);
      c = _strlen(pcVar1);
    }
    if (c == 0) {
      RightTextOut(hdc,iVar3,iVar4,(char *)szWork,0,iVar3 - xStart);
    }
    else {
      SelectObject(hdc,rghfontArial8[1]);
      sVar2 = CchGetString(idsCompletion,szT);
      TextOut(hdc,xStart,iVar4,(LPCSTR)CONCAT22(unaff_SS,szT),sVar2);
      DVar7 = GetTextExtent(hdc,(LPCSTR)CONCAT22(unaff_SS,szT),sVar2);
      SelectObject(hdc,rghfontArial8[0]);
      RightTextOut
                (hdc,iVar3,iVar4,(char *)szWork,c,(iVar3 - xStart) - (int)DVar7);
    }
    iVar4 = iVar4 + dyArial8;
    SelectObject(hdc,rghfontArial8[1]);
    sVar2 = CchGetString(idsRoute3,szT);
    TextOut(hdc,xStart,iVar4,(LPCSTR)CONCAT22(unaff_SS,szT),sVar2);
    DVar7 = GetTextExtent(hdc,(LPCSTR)CONCAT22(unaff_SS,szT),sVar2);
    if ((sel.pl.wRouting & 0x3ffU) == 0) {
      c = CchGetString(idsNone4,(char *)szWork);
    }
    else {
      pcVar1 = PszGetCompressedPlanet
                         (((short *)rgidPlan)[(sel.pl.wRouting & 0x3ffU) - 1]);
      c = 0;
      _strcpy((char *)szWork,pcVar1);
    }
    SelectObject(hdc,rghfontArial8[0]);
    RightTextOut(hdc,iVar3,iVar4,(char *)szWork,c,(iVar3 - xStart) - (int)DVar7);
    iVar4 = iVar4 + dyArial8;
    iVar3 = ((iVar3 - xStart) + -0x10) / 3;
    for (i = 0xb; i < 0xd; i = i + 1) {
      SetWindowPos(((ushort *)rghwndBtn)[i],0,xStart,iVar4,iVar3,
                   (dyArial8 >> 1) + dyArial8,0x14);
      ShowWindow(((ushort *)rghwndBtn)[i],5);
      xStart = xStart + iVar3 + 8;
    }
    if ((((PLPROD *)sel.pl.lpplprod == (PLPROD *)0x0) &&
        (sel.pl.lpplprod._2_2_ == 0)) ||
       (((PLPROD *)sel.pl.lpplprod)->iprodMac == 0)) {
      BVar5 = 0;
    }
    else {
      BVar5 = 1;
    }
    EnableWindow(rghwndBtn[0xc],BVar5);
    SetRect(&rgrcRef[0x11].left,xStart,iVar4,xStart + iVar3,
            iVar4 + dyArial8 + (dyArial8 >> 1));
    pcVar1 = PszGetCompressedString(idsRoute2);
    DrawBtn(hdc,(RECT *)(rgrcRef + 0x11),8,(uint)gd.wFlags >> 0xd & 1,
                     pcVar1);
  }
  return;
}



// ======================================================================
// Function: PszProductionETA
// Address: 1048:310c
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104831ef) */
/* WARNING: Removing unreachable block (ram,0x104831f4) */
/* WARNING: Removing unreachable block (ram,0x104831bc) */
/* WARNING: Variable defined which should be unmapped: ids */

char * PszProductionETA(PLANET *lppl,PLPROD *lpplprod,short iItem,short *etaFirst,short *etaLast)

{
  int iVar1;
  char *pcVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar3;
  ulong uVar4;
  short sVar5;
  short ids;
  short c;
  short iTurnBegin;
  short iTurnEnd;
  
  uVar4 = CONCAT22(unaff_SI,unaff_DI);
  if (((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) {
                    /* WARNING: Load size is inaccurate */
    lpplprod = (PLPROD *)
               CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                        ((PLANET *)lppl)->lpplprod);
  }
  EstimateItemProdSched(lppl,lpplprod,iItem,&iTurnBegin,&iTurnEnd);
  if (iTurnBegin == 100) {
    if (((((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) ||
        ((int)(uint)((PLPROD *)lpplprod)->iprodMac <= iItem)) ||
       ((uVar3 = __aFulshr(uVar4,ids), ((uint)uVar3 & 7) != 1 ||
        (uVar4 = __aFulshr(uVar4,ids), 6 < ((uint)uVar4 & 0x7f))))) {
      ids = 0x332;
    }
    else {
      ids = 0x254;
    }
    CchGetString(ids,(char *)szWork);
  }
  else if (iTurnEnd == 100) {
    sVar5 = iTurnBegin;
    pcVar2 = PszGetCompressedString(idsDYears);
    _WSPRINTF((LPSTR)CONCAT22(sVar5,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
  }
  else if (iTurnBegin == iTurnEnd) {
    if (iTurnBegin == 0) {
      CchGetString(idsSkipped,(char *)szWork);
    }
    else if (iTurnBegin == -1) {
      CchGetString(idsNeeded,(char *)szWork);
    }
    else {
      sVar5 = iTurnBegin;
      pcVar2 = PszGetCompressedString(idsDYear);
      iVar1 = _WSPRINTF((LPSTR)CONCAT22(sVar5,(char *)&DAT_1120_1120),
                        (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
      if (iTurnBegin != 1) {
        ((char *)szWork)[iVar1] = 's';
        ((char *)szWork + 1)[iVar1] = '\0';
      }
    }
  }
  else {
    sVar5 = iTurnBegin;
    pcVar2 = PszGetCompressedString(idsDDYears);
    _WSPRINTF((LPSTR)CONCAT22(sVar5,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
  }
  if (etaFirst != (short *)0x0) {
    *etaFirst = iTurnBegin;
  }
  if (etaLast != (short *)0x0) {
    *etaLast = iTurnEnd;
  }
  return (char *)szWork;
}



// ======================================================================
// Function: DrawPlanShipBitmap
// Address: 1048:3336
// Segment: MEMORY_PLANET
// ======================================================================


void DrawPlanShipBitmap(HDC hdc,TILE *ptile,OBJ obj)

{
  short sVar1;
  int iVar2;
  int iVar3;
  HGDIOBJ HVar4;
  int iVar5;
  RECT rc;
  short iOffset;
  HBRUSH hbrSav;
  short xLeft;
  short dx;
  char *psz;
  short i;
  short xRight;
  short dy;
  short yTop;
  
  if (sel.grobj == grobjPlanet) {
    psz = PszGetPlanetName((obj.ppl)->id);
    iOffset = ((obj.ppl)->id + 8) % 0x1c;
  }
  else {
    psz = PszGetFleetName((obj.ppl)->id);
  }
  if (((uint)ptile->wFlags >> 0xb & 1) != 0) {
    for (i = 4; i < 7; i = i + 1) {
      ShowWindow(((ushort *)rghwndBtn)[i],0);
    }
    ptile->wFlags = ptile->wFlags & 0xf7ff;
  }
  sVar1 = FDrawTileNC(hdc,ptile,&rc,psz);
  if (sVar1 == 0) {
    for (i = 4; i < 7; i = i + 1) {
      ShowWindow(((ushort *)rghwndBtn)[i],0);
    }
  }
  else {
    iVar2 = rc.left + 0xc;
    if (((uint)gd.wFlags >> 3 & 1) == 0) {
      iVar3 = 6;
    }
    else {
      iVar3 = 2;
    }
    iVar3 = iVar3 + rc.top;
    if (sel.grobj == grobjFleet) {
      DrawFleetBitmap(&sel.fl,hdc,iVar2,iVar3,1,-1,0,0,-1,0);
    }
    else {
      HVar4 = SelectObject(hdc,hbrButtonShadow);
      PatBlt(hdc,iVar2,iVar3,0x46,2,0xf00021);
      PatBlt(hdc,iVar2,iVar3 + 2,2,0x44,0xf00021);
      SelectObject(hdc,hbrButtonHilite);
      PatBlt(hdc,rc.left + 0xe,iVar3 + 0x44,0x44,2,0xf00021);
      PatBlt(hdc,rc.left + 0x50,iVar3 + 2,2,0x42,0xf00021);
      PatBlt(hdc,rc.left + 0xd,iVar3 + 0x45,1,1,0xf00021);
      PatBlt(hdc,rc.left + 0x51,iVar3 + 1,1,1,0xf00021);
      PatBlt(hdc,rc.left + 0xe,iVar3 + 2,0x42,1,0x42);
      PatBlt(hdc,rc.left + 0xe,iVar3 + 3,1,0x41,0x42);
      PatBlt(hdc,rc.left + 0xf,iVar3 + 0x43,0x41,1,0x42);
      PatBlt(hdc,rc.left + 0x4f,iVar3 + 3,1,0x40,0x42);
      SelectObject(hdc,HVar4);
      SelectPalette(hdc,vhpal,0);
      RealizePalette(hdc);
      DibBlt(hdc,rc.left + 0xf,iVar3 + 3,0x40,0x40,hdibPlanets,iOffset % 7 << 6,
                      iOffset / 7 << 6,0x40,0x40,0xcc0020);
    }
    iVar2 = ((rc.right + -0xc) - iVar2) + -0x5f;
    dy = dyArial8 * 3 >> 1;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      if (((uint)gd.wFlags >> 3 & 1) == 0) {
        yTop = iVar3 + -4;
      }
      else {
        yTop = iVar3 + -2;
        dy = dy + -2;
      }
      if (sel.grobj == grobjFleet) {
        iVar3 = 6;
      }
      else {
        iVar3 = 5;
      }
      i = 4;
      while (i <= iVar3) {
        SetWindowPos(((ushort *)rghwndBtn)[i],0,(rc.right + -0xc) - iVar2,yTop,iVar2,dy,
                     0x14);
        ShowWindow(((ushort *)rghwndBtn)[i],5);
        i = i + 1;
        if (((uint)gd.wFlags >> 3 & 1) == 0) {
          iVar5 = 3;
        }
        else {
          iVar5 = 2;
        }
        yTop = yTop + iVar5 + dy;
      }
    }
  }
  return;
}



// ======================================================================
// Function: DrawPlanetShipList
// Address: 1048:377e
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10483b12) */

void DrawPlanetShipList(HDC hdc,TILE *ptile,OBJ obj)

{
  bool bVar1;
  StringId ids;
  char *pszTitle;
  short sVar2;
  int iVar3;
  BOOL BVar4;
  uint uVar5;
  undefined2 unaff_SS;
  bool bVar6;
  LRESULT LVar7;
  DWORD DVar8;
  DWORD DVar9;
  RECT rc;
  long l;
  short xLeft;
  long lSel;
  FLEET *pfl;
  XFER xf;
  RECT rcGauge;
  short c;
  short i;
  short xRight;
  short xStart;
  short idSkip;
  short fUnknown;
  short fObjIsThing;
  short yTop;
  long l2;
  short fDoneDrawing;
  short swp;
  
  DVar8 = CONCAT22(l._2_2_,(int)l);
  bVar6 = false;
  if (((uint)ptile->wFlags >> 0xb & 1) != 0) {
    for (i = 0; i < 3; i = i + 1) {
      ShowWindow(((ushort *)rghwndBtn)[i],0);
    }
    ShowWindow(hwndShipDD,0);
    ptile->wFlags = ptile->wFlags & 0xf7ff;
    rgrcRef[1].top = -5;
    rgrcRef[1].bottom = -6;
    rgrcRef[4].top = -5;
    rgrcRef[4].bottom = -6;
  }
  if (obj.ppl == (PLANET *)0x0) {
    ids = idsFleetsOrbit;
  }
  else {
    ids = idsOtherFleetsHere;
  }
  pszTitle = PszGetCompressedString(ids);
  sVar2 = FDrawTileNC(hdc,ptile,&rc,pszTitle);
  if (sVar2 == 0) {
    for (i = 0; i < 3; i = i + 1) {
      ShowWindow(((ushort *)rghwndBtn)[i],0);
    }
    ShowWindow(hwndShipDD,0);
  }
  else {
    xStart = rc.left + 4;
    iVar3 = rc.right + -4;
    swp = 0x14;
    if (dxShipDD == iVar3 - xStart) {
      swp = 0x15;
    }
    else {
      dxShipDD = iVar3 - xStart;
    }
    SetWindowPos(hwndShipDD,0,xStart,rc.top + 2,iVar3 - xStart,dyShipDD * 5,swp)
    ;
    ShowWindow(hwndShipDD,5);
    yTop = rc.top + 2 + dyShipDD + 3;
    LVar7 = SendMessage(hwndShipDD,0x407,0,0);
    EnableWindow(rghwndBtn[0],(uint)(LVar7 != -1));
    bVar1 = LVar7 == -1;
    if (obj.ppl == (PLANET *)0x0) {
      idSkip = -1;
    }
    else {
      idSkip = (obj.ppl)->id;
    }
    if (!bVar1) {
      sVar2 = sel.pl.id;
      if (idSkip != -1) {
        sVar2 = *(short *)(obj.ppl)->rgpctMinLevel;
      }
      sVar2 = FLookupOrbitingXfer(sVar2,(short)LVar7,&xf,idSkip);
      if (sVar2 == 0) {
        bVar1 = true;
      }
    }
    if (bVar1) {
      EnableWindow(rghwndBtn[1],0);
    }
    else {
      bVar6 = xf.grobj == grobjThing;
      if ((bVar6) || (xf.fl.iPlayer != idPlayer)) {
        BVar4 = 0;
      }
      else {
        BVar4 = 1;
      }
      EnableWindow(rghwndBtn[1],BVar4);
    }
    rgrcRef[1].top = -5;
    rgrcRef[1].bottom = -6;
    rgrcRef[4].top = -5;
    rgrcRef[4].bottom = -6;
    if ((bVar6) || ((xf.fl.wFlags & 0xffU) == 7)) {
      uVar5 = 0;
    }
    else {
      uVar5 = 1;
    }
    if (((uint)gd.wFlags >> 3 & 1) == 0) {
      if ((!bVar1) && (DVar8 = CONCAT22(l._2_2_,(int)l), uVar5 == 0)) {
        SelectObject(hdc,rghfontArial8[1]);
        sVar2 = CchGetString(idsCargo3,(char *)szWork);
        DVar8 = GetTextExtent(hdc,szWork,sVar2);
      }
      if (((bVar1) || (uVar5 != 0)) || (bVar6)) {
        if ((((uint)ptile->wFlags >> 0xc & 1) != 0) || (uVar5 != (gd._0_2_ & 1))) {
          SetRect((undefined2 *)CONCAT22(unaff_SS,&rcGauge),xStart,yTop,iVar3,
                  dyArial8 * 2 + yTop + 8);
          FillRect(hdc,(undefined2 *)CONCAT22(unaff_SS,&rcGauge),hbrButtonFace);
        }
      }
      else {
        sVar2 = CchGetString(idsFuel3,(char *)szWork);
        DVar9 = GetTextExtent(hdc,szWork,sVar2);
        if ((long)DVar8 < (long)DVar9) {
          DVar8 = DVar9;
        }
        TextOut(hdc,xStart,yTop,szWork,sVar2);
        l._0_2_ = (int)DVar8;
        SetRect((undefined2 *)CONCAT22(unaff_SS,&rcGauge),xStart + (int)l,yTop,iVar3,
                yTop + dyArial8);
        if (idSkip != -1) {
          rgrcRef[1].left = rcGauge.left;
          rgrcRef[1].top = rcGauge.top;
          rgrcRef[1].right = rcGauge.right;
          rgrcRef[1].bottom = rcGauge.bottom;
        }
        DrawFleetGauge(hdc,&rcGauge,(FLEET *)CONCAT22(unaff_SS,&xf.fl),4);
      }
      gd._0_2_ = gd._0_2_ & 0xfffe | uVar5;
      if (!bVar6) {
        yTop = yTop + dyArial8 + 4;
      }
      if ((!bVar1) && (uVar5 == 0)) {
        sVar2 = CchGetString(idsCargo3,(char *)szWork);
        TextOut(hdc,xStart,yTop,szWork,sVar2);
        l._0_2_ = (int)DVar8;
        SetRect((undefined2 *)CONCAT22(unaff_SS,&rcGauge),xStart + (int)l,yTop,iVar3,
                yTop + dyArial8);
        rgrcRef[4].left = rcGauge.left;
        rgrcRef[4].top = rcGauge.top;
        rgrcRef[4].right = rcGauge.right;
        rgrcRef[4].bottom = rcGauge.bottom;
        if (bVar6) {
          DrawThingGauge(hdc,&rcGauge,(THING *)CONCAT22(unaff_SS,&xf.fl),5);
          OffsetRect((undefined2 *)CONCAT22(unaff_SS,&rcGauge),0,dyArial8 + 4);
          FillRect(hdc,(undefined2 *)CONCAT22(unaff_SS,&rcGauge),hbrButtonFace);
          yTop = yTop + dyArial8 + 4;
        }
        else {
          DrawFleetGauge(hdc,&rcGauge,(FLEET *)CONCAT22(unaff_SS,&xf.fl),5);
        }
      }
      yTop = yTop + dyArial8 + 4;
    }
    iVar3 = ((iVar3 - xStart) + -10) / 3;
    for (i = 0; i < 3; i = i + 1) {
      SetWindowPos(((ushort *)rghwndBtn)[(i + 1) % 3],0,xStart,yTop,iVar3,
                   (dyArial8 >> 1) + dyArial8,0x14);
      if ((i != 2) || (obj.ppl != (PLANET *)0x0)) {
        ShowWindow(((ushort *)rghwndBtn)[i],5);
      }
      xStart = xStart + iVar3 + 6;
    }
    if (((idSkip != -1) && (uVar5 != 0)) || (bVar6)) {
      BVar4 = 0;
    }
    else {
      BVar4 = 1;
    }
    EnableWindow(rghwndBtn[2],BVar4);
  }
  return;
}



// ======================================================================
// Function: SetPlanetTitleBar
// Address: 1048:3dec
// Segment: MEMORY_PLANET
// ======================================================================


void SetPlanetTitleBar(HWND hwnd)

{
  char *pcVar1;
  undefined2 unaff_SS;
  char *psz;
  char szTitle [30];
  
  if (sel.grobj == grobjPlanet) {
    pcVar1 = PszGetPlanetName(sel.pl.id);
    CchGetString(idsPlanet2,szTitle);
    lstrcat((LPSTR)CONCAT22(unaff_SS,szTitle),(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar1))
    ;
    psz = szTitle;
  }
  else if (sel.grobj == grobjFleet) {
    psz = PszGetFleetName(sel.fl.id);
  }
  else {
    psz = PszGetCompressedString(idsPlanetView);
  }
  SetWindowText(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,psz));
  return;
}



// ======================================================================
// Function: ChangeMainObjSel
// Address: 1048:3e7a
// Segment: MEMORY_PLANET
// ======================================================================


void ChangeMainObjSel(short grobjNew,short iObjSel)

{
  FLEET *pFVar1;
  int iVar2;
  short sVar3;
  bool bVar4;
  FLEET *lpfl;
  short i;
  short idSkip;
  short fSameType;
  
  idSkip = -1;
  bVar4 = grobjNew == sel.grobj;
  if (((fAi == 0) || (!bVar4)) || (iObjSel != sel.id)) {
    InvalidateReport((uint)(sel.grobj != grobjPlanet),0);
    if (grobjNew == 1) {
      InvalidateReport(0,0);
      sVar3 = FLookupPlanet(iObjSel,(PLANET *)&sel.pl);
      if (sVar3 == 0) {
        return;
      }
      sel.pt.x = ((POINT *)rgptPlan + iObjSel)->x;
      sel.pt.y = *(short *)((int)&rgptPlan[0].y + iObjSel * 4);
      sel.scan.iwp = -1;
      sel.iwpAct = -1;
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar1 = ((FLEET **)rglpfl)[i];
        iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
        if (((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) ||
           ((pFVar1->idPlanet == iObjSel && (pFVar1->iPlayer == idPlayer)))) break;
      }
      if (i == cFleet) {
        sel.fl.id = -1;
        sel.grobjFull = grobjPlanet;
      }
      else {
        FDupFleet(lpfl,(FLEET *)&sel.fl);
        sel.grobjFull = grobjFleet|grobjPlanet;
      }
      if (fAi == 0) {
        FillPlanetProdLB(0,(PLPROD *)0x0,(PLANET *)0x0);
        SendMessage(hwndPlanetProdLB,0x407,0,0);
      }
    }
    else {
      InvalidateReport(1,0);
      sVar3 = FLookupFleet(iObjSel,(FLEET *)&sel.fl);
      if (sVar3 == 0) {
        return;
      }
      sel.pt.x = sel.fl.pt.x;
      sel.pt.y = sel.fl.pt.y;
      if ((sel.fl.idPlanet == -1) ||
         ((sel.fl.idPlanet != sel.pl.id &&
          (sVar3 = FLookupPlanet(sel.fl.idPlanet,(PLANET *)&sel.pl),
          sVar3 == 0)))) {
        sel.pl.id = -1;
      }
      sel.grobjFull = sel.pl.id != -1 | grobjFleet;
      sel.iwpAct = 0;
      if (fAi == 0) {
        FillOrdersLB();
        FillFleetCompLB();
        FillBattleDD(sel.fl.iplan + 1);
        idSkip = iObjSel;
        SendMessage(rghwndOrderDD[0],0x40e,
                    *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xf,0);
      }
    }
    sel.grobj = grobjNew;
    sel.id = iObjSel;
    gd.wFlags = gd.wFlags & 0xdeff;
    if (fAi == 0) {
      if (!bVar4) {
        for (i = 0; i < 0xd; i = i + 1) {
          ShowWindow(((ushort *)rghwndBtn)[i],0);
        }
        for (i = 0; i < 3; i = i + 1) {
          ShowWindow(((ushort *)rghwndOrderDD)[i],0);
        }
        ShowWindow(hwndOrderED,0);
        ShowWindow(hwndShipDD,0);
        ShowWindow(hwndBattleDD,0);
        ShowWindow(hwndShipLB,0);
        ShowWindow(hwndFleetCompLB,0);
        ShowWindow(hwndPlanetProdLB,0);
        ShowWindow(hwndRepCB,0);
        for (i = 0; i < 0x13; i = i + 1) {
          *(undefined2 *)((int)&rgrcRef[0].bottom + i * 8) = 0xfffa;
          *(undefined2 *)((int)&rgrcRef[0].top + i * 8) = 0xfffb;
        }
      }
      FillShipDD(idSkip);
      if (bVar4) {
        DrawPlanShip(0,0x4fff);
      }
      else {
        InvalidateRect(hwndPlanet,(undefined2 *)0x0,1);
        if (((grbitScan & 0x10) != 0) && (sel.grobj == grobjPlanet)) {
          grbitScan = grbitScan & 0xffef;
          InvalidateRect(hwndTb,(undefined2 *)0x0,1);
        }
      }
      SetPlanetTitleBar(hwndPlanet);
      if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
        AdvanceTutor();
      }
    }
  }
  return;
}



// ======================================================================
// Function: FillShipDD
// Address: 1048:42a0
// Segment: MEMORY_PLANET
// ======================================================================


void FillShipDD(short idSkip)

{
  FLEET *pFVar1;
  int iVar2;
  THING *pTVar3;
  undefined2 uVar4;
  POINT ptSel;
  FLEET *lpfl;
  THING *lpth;
  short i;
  THING *lpthMac;
  
  SendMessage(hwndShipDD,0x40b,0,0);
  if (sel.grobj == grobjPlanet) {
    ptSel.x = ((POINT *)rgptPlan + sel.id)->x;
    ptSel.y = *(short *)((int)&rgptPlan[0].y + sel.id * 4);
  }
  else {
    ptSel.x = sel.fl.pt.x;
    ptSel.y = sel.fl.pt.y;
  }
  for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[i];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    if (((idSkip == -1) && (sel.id == pFVar1->idPlanet)) ||
       (((idSkip != -1 && ((lpfl->id != idSkip && ((&pFVar1->pt)->x == sel.fl.pt.x)))) &&
        ((pFVar1->pt).y == sel.fl.pt.y)))) {
      PszGetFleetName(lpfl->id);
      _memmove((char *)szWork + 1,(char *)szWork,0x32);
      if (pFVar1->iPlayer == idPlayer) {
        szWork[0] = ' ';
      }
      else {
        szWork[0] = 'x';
      }
      SendMessage(hwndShipDD,0x403,0,0x112057a4);
    }
  }
  pTVar3 = (THING *)lpThings + cThing;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < pTVar3) {
    uVar4 = (undefined2)((ulong)lpth >> 0x10);
    if ((((uint)lpth->idFull >> 0xd == 1) && ((&((THING *)lpth)->pt)->x == ptSel.x)) &&
       ((((THING *)lpth)->pt).y == ptSel.y)) {
      PszGetThingName(lpth->idFull);
      _memmove((char *)szWork + 1,(char *)szWork,0x32);
      if (((uint)lpth->idFull >> 9 & 0xf) == idPlayer) {
        szWork[0] = ' ';
      }
      else {
        szWork[0] = 'x';
      }
      SendMessage(hwndShipDD,0x403,0,0x112057a4);
    }
    lpth = (THING *)CONCAT22(uVar4,(THING *)lpth + 1);
  }
  SendMessage(hwndShipDD,0x40e,0,0);
  return;
}



// ======================================================================
// Function: SelectAdjPlanet
// Address: 1048:44da
// Segment: MEMORY_PLANET
// ======================================================================


void SelectAdjPlanet(short dInc,short idPlanet)

{
  POINT pt;
  short fWrap;
  SCAN scan;
  PLANET *lpPl;
  short i;
  PLANET *lpPlT;
  
  if ((0 < cPlanet) && (idPlanet != -1)) {
    if (dInc != 0) {
      idPlanet = sel.pl.id;
    }
    if (vrptPlanet.fCached == 0) {
      InvalidateReport(0,1);
    }
    lpPl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    i = 0;
    while( true ) {
      if ((cPlanet <= i) || (lpPl->id == idPlanet)) break;
      i = i + 1;
      lpPl = (PLANET *)CONCAT22(lpPl._2_2_,(PLANET *)lpPl + 1);
    }
    if ((i == cPlanet) || ((((PLANET *)lpPl)->wFlags & 0xffU) != 7)) {
      scan.pt.x = ((POINT *)rgptPlan + idPlanet)->x;
      scan.pt.y = *(short *)((int)&rgptPlan[0].y + idPlanet * 4);
      scan.grobj = 0x81;
      ChangeScanSel(&scan,0);
    }
    else {
      if (dInc != 0) {
        i = 0;
        while ((i < *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) &&
               (((PLANET *)lpPlanets + ((ushort *)vlprgidPlanet)[i])->id != idPlanet))
              ) {
          i = i + 1;
        }
        i = i + dInc;
        if (i < *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0)) {
          if (i < 0) {
            i = *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) + -1;
          }
        }
        else {
          i = 0;
        }
        i = ((ushort *)vlprgidPlanet)[i];
      }
      lpPlT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets + i);
      idPlanet = lpPlT->id;
      if (((PLANET *)lpPlanets)[i].iPlayer != idPlayer) {
        return;
      }
      scan.pt.x = ((POINT *)rgptPlan + idPlanet)->x;
      scan.pt.y = *(short *)((int)&rgptPlan[0].y + idPlanet * 4);
      scan.grobj = 0x81;
      ChangeScanSel(&scan,0);
      RedrawScanSel(0,0);
      ChangeMainObjSel(1,idPlanet);
      RedrawScanSel(0,1);
    }
    pt.y = *(short *)((int)&rgptPlan[0].y + idPlanet * 4);
    pt.x = ((POINT *)rgptPlan + idPlanet)->x;
    CtrPointScan(pt,1);
    DrawScannerSBar(0,(RECT *)0x0,(SBAR *)0x0,0);
    InvalidateRect(hwndMine,(undefined2 *)0x0,1);
    SetMineralTitleBar(hwndMine);
  }
  return;
}



// ======================================================================
// Function: IdFindAdjStarbase
// Address: 1048:474e
// Segment: MEMORY_PLANET
// ======================================================================


short IdFindAdjStarbase(short idPlanet,short fNext)

{
  PLANET *pPVar1;
  undefined2 uVar2;
  HULDEF *pHVar3;
  short idBefore;
  short idAfter;
  PLANET *lppl;
  short idFirst;
  short idLast;
  PLANET *lpplMac;
  
  idLast = -1;
  idFirst = -1;
  idAfter = -1;
  idBefore = -1;
  pPVar1 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < pPVar1) {
    uVar2 = (undefined2)((ulong)lppl >> 0x10);
    if (((((PLANET *)lppl)->iPlayer == idPlayer) &&
        (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)) &&
       (pHVar3 = LphuldefFromId
                           (*(HullDef *)
                             (*(int *)(idPlayer * 4 + 0x14c) +
                             (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) * 0x93)),
       (((HULDEF *)pHVar3)->hul).wtCargoMax != 0)) {
      if (idPlanet < lppl->id) {
        if (idAfter == -1) {
          idAfter = lppl->id;
        }
      }
      else if (lppl->id < idPlanet) {
        idBefore = lppl->id;
      }
      if (idFirst == -1) {
        idFirst = lppl->id;
      }
      idLast = lppl->id;
    }
    lppl = (PLANET *)CONCAT22(uVar2,(PLANET *)lppl + 1);
  }
  if (fNext == 0) {
    idFirst = idLast;
    if (idBefore != -1) {
      idFirst = idBefore;
    }
  }
  else if (idAfter != -1) {
    idFirst = idAfter;
  }
  return idFirst;
}



// ======================================================================
// Function: PlanetClick
// Address: 1048:489e
// Segment: MEMORY_PLANET
// ======================================================================


void PlanetClick(short x,short y,short sks,short fRightBtn)

{
  TILE *pTVar1;
  short *psVar2;
  uint uVar3;
  uint uVar4;
  int iVar5;
  BOOL BVar6;
  short sVar7;
  short sVar8;
  TILE *pTVar9;
  short *psVar10;
  undefined2 unaff_SS;
  POINT pt_00;
  POINT pt_01;
  ulong uVar11;
  HDC hdc;
  POINT ptNew;
  short asStack_3a [5];
  char *pcStack_30;
  uint uStack_2a;
  RECT rc;
  TILE *prgtile;
  short iCur;
  ushort iCol;
  short xRel;
  short i;
  RECT rcTitle;
  short dy;
  short ctile;
  POINT pt;
  short bt;
  
  if (sel.grobj == grobjPlanet) {
    prgtile = (TILE *)(TILE *)&rgtilePlanet;
    ctile = 6;
  }
  else {
    if (sel.grobj != grobjFleet) {
      return;
    }
    prgtile = (TILE *)(TILE *)&rgtileShip;
    ctile = 7;
  }
  uVar4 = (uint)x / 0xc6;
  if ((3 < (uint)x % 0xc6) && ((uint)x % 0xc6 < 0xc2)) {
    for (i = 0; sVar7 = i, i < ctile; i = i + 1) {
      if (uVar4 <= (prgtile[i].wFlags & 7U)) {
        if (uVar4 < (prgtile[i].wFlags & 7U)) {
          return;
        }
        if ((prgtile + i)->yTop <= y) {
          if (((uint)prgtile[i].wFlags >> 7 & 1) == 0) {
            iVar5 = dyArial8 + 3;
          }
          else {
            iVar5 = prgtile[i].dyFull;
          }
          if (y < iVar5 + (prgtile + i)->yTop) break;
        }
      }
    }
    if (i != ctile) {
      pt.x = x;
      pt.y = y;
      rcTitle.top = (prgtile + i)->yTop;
      rcTitle.bottom = dyArial8 + rcTitle.top + 4;
      rcTitle.left = uVar4 * 0xc6 + 4;
      rcTitle.right = uVar4 * 0xc6 + 0xc3;
      BVar6 = PtInRect((undefined2 *)CONCAT22(&rcTitle,y),x);
      if ((BVar6 == 0) || (fRightBtn != 0)) {
        if (((sel.grobj == grobjFleet) &&
            ((((prgtile[i].grbit == 0x20 || (prgtile[i].grbit == 0x100)) || (prgtile[i].grbit == 1))
             || (prgtile[i].grbit == 0x10)))) || (prgtile[i].grbit == 4)) {
          pt_00.y = y;
          pt_00.x = x;
          ClickInShipOrders(pt_00,sks,0,fRightBtn);
        }
        else if ((sel.grobj == grobjPlanet) &&
                (((prgtile[i].grbit == 1 || (prgtile[i].grbit == 0x100)) ||
                 ((prgtile[i].grbit == 0x40 || (prgtile[i].grbit == 8)))))) {
          pt_01.y = y;
          pt_01.x = x;
          ClickInPlanetOrders(pt_01,sks,0,fRightBtn);
        }
      }
      else {
        rc.right = rcTitle.right;
        rc.bottom = rcTitle.bottom;
        rc.top = rcTitle.top + 1;
        rc.left = rcTitle.right + -0x11;
        BVar6 = PtInRect((undefined2 *)CONCAT22(&rc,y),x);
        if (BVar6 == 0) {
          if (((uint)prgtile[i].wFlags >> 7 & 1) != 0) {
            rcTitle.bottom = rcTitle.top + prgtile[i].dyFull + 1;
          }
          uStack_2a = GetDC(hwndPlanet);
          DrawFuzzyBorder(uStack_2a,&rcTitle);
          SetCapture(hwndPlanet);
          ptNew.x = x;
          ptNew.y = y;
          while (sVar8 = FGetMouseMove(&ptNew), sVar8 != 0) {
            if ((pt.x != ptNew.x) || (pt.y != ptNew.y)) {
              DrawFuzzyBorder(uStack_2a,&rcTitle);
              OffsetRc(&rcTitle,ptNew.x - pt.x,ptNew.y - pt.y);
              pt.x = ptNew.x;
              pt.y = ptNew.y;
              DrawFuzzyBorder(uStack_2a,&rcTitle);
            }
          }
          DrawFuzzyBorder(uStack_2a,&rcTitle);
          ReleaseCapture();
          ReleaseDC(hwndPlanet,uStack_2a);
          iVar5 = (rcTitle.right - rcTitle.left >> 1) + rcTitle.left;
          if (iVar5 / 0xc6 < 2) {
            uVar4 = iVar5 / 0xc6;
          }
          else {
            uVar4 = 1;
          }
          if (uVar4 < 0x8000) {
            if (iVar5 / 0xc6 < 2) {
              uVar4 = iVar5 / 0xc6;
            }
            else {
              uVar4 = 1;
            }
          }
          else {
            uVar4 = 0;
          }
          iCur = i;
          i = 0;
          while ((i < ctile && ((prgtile[i].wFlags & 7U) < uVar4))) {
            i = i + 1;
          }
          while ((i < ctile && ((prgtile[i].wFlags & 7U) == uVar4))) {
            if (((uint)prgtile[i].wFlags >> 7 & 1) == 0) {
              iVar5 = dyArial8 + 3;
            }
            else {
              iVar5 = prgtile[i].dyFull;
            }
            if ((rcTitle.bottom - rcTitle.top >> 1) + rcTitle.top <
                (iVar5 >> 1) + (prgtile + i)->yTop) break;
            i = i + 1;
          }
          if ((i == sVar7) || (i == sVar7 + 1)) {
            uVar3 = prgtile[sVar7].wFlags;
            if (uVar4 != (uVar3 & 7)) {
              prgtile[sVar7].wFlags = prgtile[sVar7].wFlags & 0xfff8U | uVar4 & 7;
              ReflowColumn(uVar4,sVar7,1);
              if ((int)uVar4 < (int)(uVar3 & 7)) {
                uVar11 = CONCAT22(sVar7 + 1,uVar3) & 0xffff0007;
                ReflowColumn((short)uVar11,(short)(uVar11 >> 0x10),1);
              }
              else {
                uVar11 = CONCAT22(sVar7,uVar3) & 0xffff0007;
                ReflowColumn((short)uVar11,(short)(uVar11 >> 0x10),1);
              }
            }
          }
          else {
            pTVar9 = prgtile + sVar7;
            psVar10 = asStack_3a;
            for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
              psVar2 = psVar10;
              psVar10 = psVar10 + 1;
              pTVar1 = pTVar9;
              pTVar9 = (TILE *)&pTVar9->dyFull;
              *psVar2 = pTVar1->yTop;
            }
            if (i < sVar7) {
              _memmove(prgtile + i + 1,prgtile + i,(sVar7 - i) * 0x10);
              iCur = sVar7 + 1;
            }
            else {
              _memmove(prgtile + sVar7,prgtile + sVar7 + 1,((i - sVar7) + -1) * 0x10);
              i = i + -1;
            }
            pTVar9 = prgtile + i;
            psVar10 = asStack_3a;
            for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
              pTVar1 = pTVar9;
              pTVar9 = (TILE *)&pTVar9->dyFull;
              psVar2 = psVar10;
              psVar10 = psVar10 + 1;
              pTVar1->yTop = *psVar2;
            }
            prgtile[i].wFlags = prgtile[i].wFlags & 0xfff8U | uVar4 & 7;
            if (((uint)pcStack_30 & 7) == uVar4) {
              if (iCur <= i) {
                i = iCur;
              }
              ReflowColumn(uVar4,i,1);
            }
            else {
              ReflowColumn(uVar4,i,1);
              uVar11 = (ulong)CONCAT22(iCur,pcStack_30) & 0xffff0007;
              ReflowColumn((short)uVar11,(short)(uVar11 >> 0x10),1);
            }
          }
        }
        else {
          OffsetRc(&rc,-1,0);
          if (((uint)prgtile[i].wFlags >> 7 & 1) == 0) {
            bt = 0x71;
          }
          else {
            bt = 0x70;
          }
          InitBtnTrack((BTNT *)&hdc,hwndPlanet,0,&rc,bt,0,0,0,(char *)0x0);
          do {
            sVar7 = FTrackBtn((BTNT *)&hdc);
          } while (sVar7 != 0);
          if ((uStack_2a >> 1 & 1) != 0) {
            prgtile[i].wFlags =
                 prgtile[i].wFlags & 0xff7fU | (uint)(((uint)prgtile[i].wFlags >> 7 & 1) == 0) << 7;
            uVar11 = CONCAT22(i,prgtile[i].wFlags) & 0xffff0007;
            ReflowColumn((short)uVar11,(short)(uVar11 >> 0x10),1);
          }
        }
      }
    }
  }
  return;
}



// ======================================================================
// Function: ClickInPlanetOrders
// Address: 1048:515c
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1048548a) */
/* WARNING: Removing unreachable block (ram,0x10485505) */
/* WARNING: Removing unreachable block (ram,0x104853d2) */

ushort ClickInPlanetOrders(POINT pt,short sks,short fCursor,short fRightBtn)

{
  BOOL BVar1;
  int iVar2;
  char *pcVar3;
  short sVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar5;
  ushort in_stack_0000ffd2;
  BTNT btnt;
  uint uStack_14;
  long rglQuan [3];
  short i;
  
  uVar5 = CONCAT22(unaff_SI,unaff_DI);
  if ((sel.grobj == grobjPlanet) && (fRightBtn == 0)) {
    BVar1 = PtInRect((undefined2 *)CONCAT22(0x48e0,pt.y),pt.x);
    if (BVar1 == 0) {
      BVar1 = PtInRect((undefined2 *)CONCAT22(0x48e8,pt.y),pt.x);
      if (BVar1 == 0) {
        BVar1 = PtInRect((undefined2 *)CONCAT22(0x48f0,pt.y),pt.x);
        if (BVar1 == 0) {
          BVar1 = PtInRect((undefined2 *)CONCAT22(0x48f8,pt.y),pt.x);
          if (BVar1 == 0) {
            BVar1 = PtInRect((undefined2 *)CONCAT22(0x4900,pt.y),pt.x);
            if (BVar1 == 0) {
              BVar1 = PtInRect((undefined2 *)CONCAT22(0x4908,pt.y),pt.x);
              if (BVar1 == 0) {
                BVar1 = PtInRect((undefined2 *)CONCAT22(0x4918,pt.y),pt.x);
                if (BVar1 == 0) {
                  BVar1 = PtInRect((undefined2 *)CONCAT22(0x4920,pt.y),pt.x);
                  if (BVar1 == 0) {
                    BVar1 = PtInRect((undefined2 *)CONCAT22(0x4930,pt.y),pt.x);
                    if (BVar1 == 0) {
                      BVar1 = PtInRect((undefined2 *)CONCAT22(0x4928,pt.y),pt.x);
                      if (BVar1 == 0) {
                        BVar1 = PtInRect((undefined2 *)CONCAT22(0x4938,pt.y),pt.x);
                        if (BVar1 != 0) {
                          if (fCursor != 0) {
                            return hcurHand;
                          }
                          pcVar3 = PszGetCompressedString(idsRoute2);
                          InitBtnTrack
                                    ((BTNT *)&btnt.hdc,hwndPlanet,0,
                                     (RECT *)(rgrcRef + 0x11),8,0x50,
                                     (uint)gd.wFlags >> 0xd & 1,1,pcVar3);
                          do {
                            sVar4 = FTrackBtn((BTNT *)&btnt.hdc);
                          } while (sVar4 != 0);
                          gd.wFlags =
                               gd.wFlags & 0xdfffU |
                               ((uStack_14 >> 1 & 1) << 0xd ^ gd.wFlags) & 0x2000;
                        }
                      }
                      else {
                        ClickInShipOrders(pt,sks,0,0);
                      }
                    }
                    else {
                      sVar4 = IWarpMAFromLppl(&sel.pl,(short *)0x0);
                      if (sVar4 == 0) {
                        return 0;
                      }
                      if (fCursor != 0) {
                        return hcurArrowHelp;
                      }
                      GlobalPD.field1_0x2 = 0;
                      GlobalPD.field2_0x3 = 2;
                      btnt.wFlags = sVar4 + 2;
                      GlobalPD.psz =
                           (char *)((uint)GlobalPD.psz & 0xff00 | btnt.wFlags & 0xffU);
                      FLookupPart((PART *)&GlobalPD.field1_0x2);
                      GlobalPD.grPopup = 9;
                      Popup(hwndPlanet,pt.x,pt.y);
                    }
                  }
                  else {
                    if (fCursor != 0) {
                      return hcurArrowHelp;
                    }
                    GlobalPD.grPopup = 0xb;
                    GlobalPD.psz = (char *)*(undefined2 *)(idPlayer * 4 + 0x14e);
                    GlobalPD._2_2_ =
                         *(int *)(idPlayer * 4 + 0x14c) +
                         (sel.pl._44_2_ & 0xf) * 0x93;
                    GlobalPD.iPlanMin = 0;
                    GlobalPD.iPlanVal = 1;
                    GlobalPD.iPlanMax = 0;
                    GlobalPD.iPlrVal = 0;
                    Popup(hwndPlanet,pt.x,pt.y);
                  }
                }
                else {
                  sVar4 = IWarpMAFromLppl(&sel.pl,(short *)0x0);
                  if (sVar4 == 0) {
                    return 0;
                  }
                  if (fCursor != 0) {
                    return hcurHand;
                  }
                  pcVar3 = PszGetCompressedString(idsSetDest);
                  InitBtnTrack
                            (&btnt,hwndPlanet,0,(RECT *)(rgrcRef + 0xd),8,0x50,
                             (uint)gd.wFlags >> 8 & 1,1,pcVar3);
                  do {
                    sVar4 = FTrackBtn(&btnt);
                  } while (sVar4 != 0);
                  gd.wFlags =
                       gd.wFlags & 0xfeffU |
                       (((uint)btnt.wFlags >> 1 & 1) << 8 ^ gd.wFlags) & 0x100;
                }
              }
              else {
                uVar5 = __aFulshr(uVar5,in_stack_0000ffd2);
                if ((((uint)uVar5 & 0x1f) == 0x1f) &&
                   (sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv
                                             ), sVar4 != raMacintosh)) {
                  return 0;
                }
                if (fCursor != 0) {
                  return hcurArrowHelp;
                }
                sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
                if (sVar4 == raMacintosh) {
                  GlobalPD.grPopup = 10;
                  GlobalPD.field1_0x2 = 0xb4;
                  GlobalPD.field2_0x3 = 0;
                  GlobalPD.psz = (char *)szPopupBuffer;
                  CchGetString
                            (idsRaceCannotBuildPlanetaryScannersStarbasesHave,
                             (char *)szPopupBuffer);
                }
                else {
                  LookupBestPlanetaryScanner((PART *)&GlobalPD.field1_0x2);
                  GlobalPD.grPopup = 9;
                }
                Popup(hwndPlanet,pt.x,pt.y);
              }
            }
            else {
              if (((uint)sel.pl.dwFlags & 0xfff) == 0) {
                return 0;
              }
              if (fCursor != 0) {
                return hcurArrowHelp;
              }
              FGetBestDefensePart((PART *)&GlobalPD.field1_0x2);
              GlobalPD.grPopup = 9;
              Popup(hwndPlanet,pt.x,pt.y);
            }
          }
          else {
            if (fCursor != 0) {
              return hcurArrowHelp;
            }
            GlobalPD.grPopup = 7;
            GlobalPD.field1_0x2 = (undefined1)sel.pl.id;
            GlobalPD.field2_0x3 = sel.pl.id._1_1_;
            Popup(hwndPlanet,pt.x,pt.y);
          }
        }
        else {
          if (fCursor != 0) {
            return hcurArrowHelp;
          }
          GlobalPD.grPopup = 0xc;
          GlobalPD.field1_0x2 = (undefined1)sel.pl.id;
          GlobalPD.field2_0x3 = sel.pl.id._1_1_;
          GlobalPD.psz = (char *)CResourcesAtPlanet(&sel.pl,idPlayer);
          GlobalPD.iPlanVal = (short)GlobalPD.psz;
          uVar5 = __aFulshr(uVar5,in_stack_0000ffd2);
          if ((uVar5 & 1) == 0) {
            sVar4 = MulDiv((short)GlobalPD.psz,
                           (int)*(char *)((int)&rgplr[0].pctResearch +
                                         idPlayer * 0xc0),100);
            GlobalPD.iPlanVal = GlobalPD.iPlanVal - sVar4;
          }
          Popup(hwndPlanet,pt.x,pt.y);
        }
      }
      else {
        if (fCursor != 0) {
          return hcurArrowHelp;
        }
        GlobalPD.grPopup = 8;
        GlobalPD.field1_0x2 = (undefined1)sel.pl.id;
        GlobalPD.field2_0x3 = sel.pl.id._1_1_;
        GlobalPD.iPlanMax = (short)(rgrcRef[7].top + dyArial8 <= pt.y);
        if (GlobalPD.iPlanMax == 0) {
          GlobalPD.psz = (char *)CMaxMines(&sel.pl,idPlayer);
          uVar5 = __aFulshr(uVar5,in_stack_0000ffd2);
          GlobalPD.iPlanVal = (uint)uVar5 & 0xfff;
          GlobalPD.iPlanMin = CMaxOperableMines(&sel.pl,idPlayer,0);
        }
        else {
          GlobalPD.psz = (char *)CMaxFactories(&sel.pl,idPlayer);
          uVar5 = __aFulshr(uVar5,in_stack_0000ffd2);
          GlobalPD.iPlanVal = (uint)uVar5 & 0xfff;
          GlobalPD.iPlanMin = CMaxOperableFactories(&sel.pl,idPlayer,0);
        }
        Popup(hwndPlanet,pt.x,pt.y);
      }
    }
    else {
      if (fCursor != 0) {
        return hcurArrowHelp;
      }
      iVar2 = (pt.y - rgrcRef[6].top) / dyArial8;
      GlobalPD.grPopup = 1;
      GlobalPD.psz = (char *)(iVar2 >> 0xf);
      GlobalPD.iPlanMax = *(short *)((int)&sel.pl + 0x1c + iVar2 * 4);
      GlobalPD.iPlrVal = *(short *)((int)&sel.pl + 0x1e + iVar2 * 4);
      GlobalPD.iPlrMin = (short)*(byte *)((int)&sel.pl + 9 + iVar2);
      GlobalPD.iPlrMax = 0;
      GlobalPD._2_2_ = iVar2;
      EstMineralsMined(&sel.pl,rglQuan,-1,0);
      GlobalPD._18_2_ = *(undefined2 *)(rglQuan + iVar2);
      GlobalPD._20_2_ = *(undefined2 *)((int)rglQuan + iVar2 * 4 + 2);
      GlobalPD.iPlanVal = (uint)sel.pl.wFlags >> 10 & 1;
      GlobalPD.iPlanMin = 0;
      Popup(hwndPlanet,pt.x,pt.y);
    }
  }
  return 0;
}



// ======================================================================
// Function: EnsureTileSize
// Address: 1048:587e
// Segment: MEMORY_PLANET
// ======================================================================


void EnsureTileSize(short fSmallTiles)

{
  int *piVar1;
  GrobjClass GVar2;
  int iVar3;
  short grobjSav;
  short i;
  short iMul;
  
  GVar2 = sel.grobj;
  if (fSmallTiles != ((uint)gd.wFlags >> 3 & 1)) {
    gd.wFlags = gd.wFlags & 0xfff7U | (fSmallTiles & 1U) << 3;
    if (fSmallTiles == 0) {
      iVar3 = 1;
    }
    else {
      iVar3 = -1;
    }
    for (i = 0; i < 6; i = i + 1) {
      if (*(int *)(i * 0x10 + 0x800) == 0x40) {
        piVar1 = (int *)(i * 0x10 + 0x7fe);
        *piVar1 = *piVar1 + (dyArial8 + 2) * 2 * iVar3;
      }
      if (*(int *)(i * 0x10 + 0x800) == 4) {
        piVar1 = (int *)(i * 0x10 + 0x7fe);
        *piVar1 = *piVar1 + (dyArial8 + 4) * 2 * iVar3;
      }
      if (*(int *)(i * 0x10 + 0x800) == 0x80) {
        piVar1 = (int *)(i * 0x10 + 0x7fe);
        *piVar1 = *piVar1 + iVar3 * 10;
      }
    }
    for (i = 0; GVar2 = sel.grobj, i < 7; i = i + 1) {
      if (*(int *)(i * 0x10 + 0x912) == 1) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + (dyArial8 * 4 + 2) * iVar3;
      }
      if (*(int *)(i * 0x10 + 0x912) == 0x200) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + (dyArial8 * 3 + 8) * iVar3;
      }
      if (*(int *)(i * 0x10 + 0x912) == 0x20) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + (dyArial8 + 9) * iVar3;
      }
      if (*(int *)(i * 0x10 + 0x912) == 4) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + (dyArial8 + 4) * 2 * iVar3;
      }
      if (*(int *)(i * 0x10 + 0x912) == 0x80) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + iVar3 * 10;
      }
      if (*(int *)(i * 0x10 + 0x912) == 0x100) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + iVar3 * 2;
      }
      if (*(int *)(i * 0x10 + 0x912) == 0x40) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + iVar3 * 6;
      }
    }
    sel.grobj = grobjPlanet;
    for (i = 0; i < 4; i = i + 1) {
      ReflowColumn(i,-1,0);
    }
    sel.grobj = grobjFleet;
    for (i = 0; i < 4; i = i + 1) {
      ReflowColumn(i,-1,0);
    }
  }
  sel.grobj = GVar2;
  return;
}



// ======================================================================
// Function: ReflowColumn
// Address: 1048:5b80
// Segment: MEMORY_PLANET
// ======================================================================


void ReflowColumn(short iCol,short iTile,short fRedraw)

{
  int iVar1;
  undefined2 unaff_SS;
  RECT rc;
  TILE *ptile;
  short grbit;
  short i;
  short ctile;
  short yTop;
  HDC hdc;
  
  grbit = 0;
  if (sel.grobj == grobjFleet) {
    ptile = (TILE *)(TILE *)&rgtileShip;
    ctile = 7;
  }
  else {
    ptile = (TILE *)(TILE *)&rgtilePlanet;
    ctile = 6;
  }
  yTop = 4;
  if (iTile == -1) {
    i = 0;
    while ((i < ctile && ((ptile[i].wFlags & 7U) != iCol))) {
      i = i + 1;
    }
    if (i == ctile) {
      return;
    }
    iTile = i;
  }
  else {
    for (i = 0; i < iTile; i = i + 1) {
      if ((ptile[i].wFlags & 7U) == iCol) {
        if (((uint)ptile[i].wFlags >> 7 & 1) == 0) {
          iVar1 = dyArial8 + 3;
        }
        else {
          iVar1 = ptile[i].dyFull;
        }
        yTop = yTop + iVar1 + 4;
      }
    }
  }
  if (fRedraw != 0) {
    GetClientRect(hwndPlanet,(undefined2 *)CONCAT22(unaff_SS,&rc));
    rc.top = yTop;
    rc.left = iCol * 0xc6 + 4;
    rc.right = iCol * 0xc6 + 0xc3;
    hdc = GetDC(hwndPlanet);
    FillRect(hdc,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
  }
  while ((iTile < ctile && ((ptile[iTile].wFlags & 7U) == iCol))) {
    (ptile + iTile)->yTop = yTop;
    ptile[iTile].wFlags = ptile[iTile].wFlags & 0xf7ffU | 0x800;
    grbit = grbit | ptile[iTile].grbit;
    if (((uint)ptile[iTile].wFlags >> 7 & 1) == 0) {
      iVar1 = dyArial8 + 3;
    }
    else {
      iVar1 = ptile[iTile].dyFull;
    }
    yTop = yTop + iVar1 + 4;
    iTile = iTile + 1;
  }
  if (fRedraw != 0) {
    DrawPlanShip(hdc,grbit);
    ReleaseDC(hwndPlanet,hdc);
  }
  return;
}



// ======================================================================
// Function: IBestTerraform
// Address: 1048:5dd2
// Segment: MEMORY_PLANET
// ======================================================================


short IBestTerraform(PLANET *lppl,short fHelp)

{
  char cVar1;
  int iPlr_00;
  short sVar2;
  short sVar3;
  short sVar4;
  PLANET *pPVar5;
  undefined2 uVar6;
  short iPlrSav;
  short rgCost [3];
  short rgpctBest [3];
  short rgMin [3];
  short pctCur;
  short iEnv;
  short iPlr;
  short i;
  short pctT;
  short rgMax [3];
  short iBest;
  short iSave;
  
  sVar2 = idPlayer;
  uVar6 = (undefined2)((ulong)lppl >> 0x10);
  pPVar5 = (PLANET *)lppl;
  iPlr_00 = pPVar5->iPlayer;
  if (iPlr_00 == -1) {
    sVar3 = 0;
  }
  else {
    idPlayer = iPlr_00;
    sVar3 = FCanTerraformLppl(lppl,rgMin,rgMax,rgCost,fHelp);
    if (sVar3 == 0) {
      sVar3 = 0;
    }
    else {
      sVar3 = PctPlanetDesirability(lppl,iPlr_00);
      for (i = 0; i < 3; i = i + 1) {
        if (rgMin[i] == -1) {
          if (rgMax[i] != -1) {
            iEnv = rgMax[i];
            goto LAB_1048_5ea6;
          }
          rgpctBest[i] = 0;
        }
        else {
          iEnv = rgMin[i];
LAB_1048_5ea6:
          cVar1 = pPVar5->rgEnvVar[i];
          pPVar5->rgEnvVar[i] = (char)iEnv;
          sVar4 = PctPlanetDesirability(lppl,iPlr_00);
          pctT = sVar4 - sVar3;
          if (pctT < 0) {
            pctT = -pctT;
          }
          sVar4 = _abs(cVar1 - iEnv);
          rgpctBest[i] = (pctT * 100) / sVar4 + 1;
          pPVar5->rgEnvVar[i] = cVar1;
        }
      }
      iSave = 0;
      for (i = 1; i < 3; i = i + 1) {
        if (rgpctBest[iSave] < rgpctBest[i]) {
          iSave = i;
        }
      }
      if (rgMin[iSave] == -1) {
        sVar3 = iSave + 1;
      }
      else {
        sVar3 = -(iSave + 1);
      }
    }
  }
  idPlayer = sVar2;
  return sVar3;
}



// ======================================================================
// Function: PszCalcEnvVar
// Address: 1048:5fcc
// Segment: MEMORY_PLANET
// ======================================================================


char * PszCalcEnvVar(short iEnv,short iVar)

{
  char *pcVar1;
  
  if (iEnv == 0) {
LAB_1048_5fdb:
    pcVar1 = PszCalcGravity(iVar);
  }
  else {
    if (iEnv == 1) {
      _WSPRINTF((LPSTR)CONCAT22(iVar * 4 + -200,(char *)&DAT_1120_1120),(LPCSTR)0x8b01120,
                (char *)szWork);
    }
    else {
      if (iEnv != 2) goto LAB_1048_5fdb;
      _WSPRINTF((LPSTR)CONCAT22(iVar,(char *)&DAT_1120_1120),(LPCSTR)0x8b61120,
                (char *)szWork);
    }
    pcVar1 = (char *)szWork;
  }
  return pcVar1;
}



// ======================================================================
// Function: PszCalcGravity
// Address: 1048:6058
// Segment: MEMORY_PLANET
// ======================================================================


char * PszCalcGravity(short iGravity)

{
  short sVar1;
  short iVal;
  short d;
  
  sVar1 = _abs(iGravity + -0x32);
  if (sVar1 < 0x1a) {
    iVal = sVar1 * 4 + 100;
  }
  else {
    iVal = (sVar1 + -0x19) * 0x18 + 200;
  }
  if (iGravity < 0x32) {
    iVal = (short)(10000 / (long)iVal);
  }
  _WSPRINTF((LPSTR)CONCAT22(iVal / 100,(char *)&DAT_1120_1120),(LPCSTR)0x8bb1120,
            (char *)szWork);
  return (char *)szWork;
}



// ======================================================================
// Function: HandleFocusState
// Address: 1048:60e6
// Segment: MEMORY_PLANET
// ======================================================================


void HandleFocusState(DRAWITEMSTRUCT *lpdis,short inflate)

{
  DRAWITEMSTRUCT *pDVar1;
  undefined2 uVar2;
  
  uVar2 = (undefined2)((ulong)lpdis >> 0x10);
  pDVar1 = (DRAWITEMSTRUCT *)lpdis;
  if ((pDVar1->itemState & 0x10U) != 0) {
    FrameRect(pDVar1->hDC,(undefined2 *)CONCAT22(uVar2,&pDVar1->rcItem),hbr50Screen);
  }
  return;
}



// ======================================================================
// Function: DrawCBEntireItem
// Address: 1048:6128
// Segment: MEMORY_PLANET
// ======================================================================


void DrawCBEntireItem(DRAWITEMSTRUCT *lpdis,short inflate)

{
  uint uVar1;
  int fListbox_00;
  UINT UVar2;
  DRAWITEMSTRUCT *pDVar3;
  undefined2 uVar4;
  RECT rc;
  short fSelected;
  short fListbox;
  
  uVar4 = (undefined2)((ulong)lpdis >> 0x10);
  pDVar3 = (DRAWITEMSTRUCT *)lpdis;
  uVar1 = pDVar3->itemState;
  rc.left = (&pDVar3->rcItem)->left;
  rc.top = (pDVar3->rcItem).top;
  rc.right = (pDVar3->rcItem).right;
  rc.bottom = (pDVar3->rcItem).bottom;
  if (((pDVar3->hwndItem == hwndFleetCompLB) ||
      (pDVar3->hwndItem == hwndPlanetProdLB)) || (0 < inflate)) {
    fListbox_00 = 1;
  }
  else {
    fListbox_00 = 0;
  }
  if (0 < inflate) {
    inflate = -inflate;
  }
  if (fListbox_00 == 0) {
    UVar2 = 0x408;
  }
  else {
    UVar2 = 0x40a;
  }
  SendMessage(pDVar3->hwndItem,UVar2,pDVar3->itemID,0x112057a4);
  DrawProductionItem(pDVar3->hDC,&rc,(char *)szWork,inflate,uVar1 & 1,fListbox_00);
  HandleFocusState(lpdis,inflate + 2);
  return;
}



// ======================================================================
// Function: DrawProductionItem
// Address: 1048:6208
// Segment: MEMORY_PLANET
// ======================================================================


void DrawProductionItem(HDC hdc,RECT *prc,char *psz,short inflate,short fSelected,short fListbox)

{
  char cVar1;
  bool bVar2;
  short sVar3;
  ushort uVar4;
  char *pcVar5;
  undefined2 unaff_SS;
  COLORREF CVar6;
  DWORD DVar7;
  RECT rc;
  short bkSav;
  short cch;
  short fItalic;
  HBRUSH hbr;
  short dx;
  RECT rcDraw;
  short fFleet;
  COLORREF crForeSav;
  short fDoubleDraw;
  short ich;
  RECT rcIn;
  char szT [20];
  short pctDmg;
  COLORREF cr;
  short ichT;
  char *pch;
  ushort hfntSav;
  
  bVar2 = false;
  fDoubleDraw = 0;
  fFleet = 0;
  rcIn.left = prc->left;
  rcIn.top = prc->top;
  rcIn.right = prc->right;
  rcIn.bottom = prc->bottom;
  if (fSelected == 0) {
    hbr = hbrWindow;
    cVar1 = *psz;
    if (cVar1 == ' ') {
PLANET_LDefCase:
      if (((int)crWindow == 0) && (crWindow._2_2_ == 0)) {
        cr._0_2_ = -1;
        cr._2_2_ = 0xff;
      }
      else {
        cr._0_2_ = 0;
        cr._2_2_ = 0;
      }
    }
    else if (cVar1 == '#') {
      cr._0_2_ = 0;
      cr._2_2_ = 0x7f;
    }
    else if (cVar1 == '&') {
      cr._0_2_ = 0x7f7f;
      cr._2_2_ = 0x7f;
    }
    else {
      if (cVar1 != '*') {
        if (cVar1 == 'I') {
          bVar2 = true;
          goto PLANET_LDefCase;
        }
        if (cVar1 == 'P') {
          fDoubleDraw = 1;
          pctDmg = (short)psz[1];
        }
        else if (cVar1 != 'Q') {
          cr._0_2_ = 0xff;
          cr._2_2_ = 0;
          goto LAB_1048_63d9;
        }
        fFleet = 1;
        goto PLANET_LDefCase;
      }
      cr._0_2_ = 0x7f00;
      cr._2_2_ = 0;
    }
  }
  else {
    cr._0_2_ = (int)crWindow;
    cr._2_2_ = crWindow._2_2_;
    cVar1 = *psz;
    if (cVar1 == ' ') {
PLANET_LDefCaseSel:
      if (((int)crWindow == 0) && (crWindow._2_2_ == 0)) {
        hbr = GetStockObject(0);
      }
      else {
        hbr = GetStockObject(4);
      }
    }
    else if (cVar1 == '#') {
      hbr = hbrBlue;
    }
    else if (cVar1 == '&') {
      hbr = hbrGray;
    }
    else {
      if (cVar1 != '*') {
        if (cVar1 == 'I') {
          bVar2 = true;
          goto PLANET_LDefCaseSel;
        }
        if (cVar1 == 'P') {
          fDoubleDraw = 1;
          pctDmg = (short)psz[1];
        }
        else if (cVar1 != 'Q') {
          hbr = hbrRed;
          goto LAB_1048_63d9;
        }
        fFleet = 1;
        goto PLANET_LDefCaseSel;
      }
      hbr = hbrGreen;
    }
  }
LAB_1048_63d9:
  if (fListbox == 2) {
    hbr = hbrButtonFace;
  }
  FillRect(hdc,(undefined2 *)CONCAT22(unaff_SS,&rcIn),hbr);
  if (fDoubleDraw != 0) {
    rcDraw.left = rcIn.left;
    rcDraw.top = rcIn.top;
    rcDraw.bottom = rcIn.bottom;
    rcDraw.right = rcIn.left + ((rcIn.right - rcIn.left) * pctDmg) / 100;
    FillRect(hdc,(undefined2 *)CONCAT22(unaff_SS,&rcDraw),hbrRed);
  }
  if (inflate != 0) {
    InflateRect((undefined2 *)CONCAT22(unaff_SS,&rcIn),-2,-1);
  }
  if (fListbox == 0) {
    ich = 1;
  }
  else if (fFleet == 0) {
    ich = 6;
    if (((int)psz[1] - 0x20U & 2) != 0) {
      bVar2 = true;
    }
  }
  else {
    ich = 7;
  }
  CVar6 = SetTextColor(hdc,CONCAT22(cr._2_2_,(int)cr));
  sVar3 = SetBkMode(hdc,1);
  if (bVar2) {
    hfntSav = SelectObject(hdc,rghfontArial8[3]);
  }
  pcVar5 = psz + ich;
  uVar4 = _strlen(pcVar5);
  cch = uVar4 + 1;
  do {
    cch = cch + -1;
    DVar7 = GetTextExtent(hdc,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar5),cch);
  } while (rcIn.right - rcIn.left < (int)DVar7);
  TextOut(hdc,rcIn.left,rcIn.top,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar5),cch);
  if (bVar2) {
    SelectObject(hdc,hfntSav);
  }
  if ((uint)ich < 6) goto LAB_1048_6673;
  if (((int)psz[ich + -5] - 0x20U & 2) == 0) {
    szT[0] = '\0';
LAB_1048_65b6:
    uVar4 = _strlen(szT);
    ichT = 2 - fFleet;
    while ((ichT < 6 && (psz[ichT + fFleet] == ' '))) {
      ichT = ichT + 1;
    }
    _strncpy(szT + uVar4,psz + fFleet + ichT,6 - ichT);
    ich = uVar4 + (6 - ichT);
    if ((fFleet == 0) && (((int)psz[fDoubleDraw + 1] - 0x20U & 1) != 0)) {
      szT[ich] = '%';
      ich = ich + 1;
    }
  }
  else {
    if (psz[ich + -1] != '*') {
      CchGetString(idsUpTo,szT);
      goto LAB_1048_65b6;
    }
    ich = CchGetString(idsNeeded,szT);
  }
  RightTextOut(hdc,rcIn.right,rcIn.top,szT,ich,0);
LAB_1048_6673:
  SetTextColor(hdc,CVar6);
  SetBkMode(hdc,sVar3);
  return;
}



// ======================================================================
// Function: FillPlanetProdLB
// Address: 1048:6692
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104869b9) */
/* WARNING: Removing unreachable block (ram,0x10486a6e) */
/* WARNING: Removing unreachable block (ram,0x104868d8) */
/* WARNING: Removing unreachable block (ram,0x10486999) */
/* WARNING: Removing unreachable block (ram,0x104869be) */
/* WARNING: Variable defined which should be unmapped: etaFirst */
/* WARNING: Removing unreachable block (ram,0x104868f8) */
/* WARNING: Removing unreachable block (ram,0x104868fd) */
/* WARNING: Removing unreachable block (ram,0x104869f2) */

void FillPlanetProdLB(HWND hwnd,PLPROD *lpplprod,PLANET *lppl)

{
  bool bVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar2;
  char *unaff_SS;
  ulong uVar3;
  ulong uVar4;
  short etaFirst;
  short etaLast;
  PROD *lpprod;
  char ch;
  char *psz;
  long resCost;
  char szTemp [80];
  short cItem;
  short i;
  long rgwtMin [4];
  short fMinimal;
  
  uVar4 = CONCAT22(unaff_SI,unaff_DI);
  if (((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) {
    bVar1 = false;
  }
  else {
    bVar1 = true;
  }
  if (!bVar1) {
    lppl = &sel.pl;
    if (hwnd == 0) {
      hwnd = hwndPlanetProdLB;
    }
    SendMessage(hwnd,0x405,0,0);
  }
  uVar2 = (undefined2)((ulong)lppl >> 0x10);
  if (((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) {
                    /* WARNING: Load size is inaccurate */
    lpplprod = (PLPROD *)
               CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                        ((PLANET *)lppl)->lpplprod);
  }
  if ((((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) ||
     (((PLPROD *)lpplprod)->iprodMac == 0)) {
    psz = PszGetCompressedString(idsQueueEmpty);
  }
  else {
    if (hwndProdDlg == 0) goto PLANET_NoMsg;
    psz = PszGetCompressedString(idsTopQueue);
  }
  if (bVar1) {
    if (psz != (char *)szWork) {
      _strcpy((char *)szWork,psz);
    }
  }
  else {
    SendMessage(hwnd,0x401,0,(LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,psz));
  }
PLANET_NoMsg:
  if (((PLPROD *)lpplprod != (PLPROD *)0x0) || (lpplprod._2_2_ != 0)) {
    resCost._0_2_ = 0;
    resCost._2_2_ = 0;
    for (i = 0; i < 4; i = i + 1) {
      *(undefined2 *)(rgwtMin + i) = 0;
      *(undefined2 *)((int)rgwtMin + i * 4 + 2) = 0;
    }
    lpprod = (PROD *)CONCAT22(lpplprod._2_2_,(PLPROD *)lpplprod + 1);
    for (i = 0; i < (int)(uint)((PLPROD *)lpplprod)->iprodMac; i = i + 1) {
      psz = PszNameProdItem(lpprod);
      EstimateItemProdSched(lppl,lpplprod,i,&etaFirst,&etaLast);
      if (((etaFirst == 0) && (etaLast == 0)) || ((etaFirst == -1 && (etaLast == -1)))) {
        if (!bVar1) {
          ch = '&';
          goto LAB_1048_693c;
        }
      }
      else {
        if (((etaFirst < 2) || (99 < etaFirst)) &&
           ((etaFirst != 100 ||
            ((uVar3 = __aFulshr(uVar4,100), ((uint)uVar3 & 7) != 1 ||
             (uVar3 = __aFulshr(uVar4,etaFirst), 6 < ((uint)uVar3 & 0x7f))))))) {
          if ((etaFirst == 1) && (etaLast == 1)) {
            ch = '*';
          }
          else if (etaFirst < 100) {
            ch = '#';
          }
          else {
            ch = '!';
          }
        }
        else {
          ch = ' ';
        }
LAB_1048_693c:
        _WSPRINTF((LPSTR)CONCAT22((int)ch,(char *)&DAT_1120_1120),(LPCSTR)CONCAT22(0x8c4,unaff_SS),
                  szTemp);
        uVar3 = __aFulshr(uVar4,etaFirst);
        if (((uint)uVar3 & 7) == 1) {
          uVar3 = __aFulshr(uVar4,etaFirst);
          if (((uint)uVar3 & 0x7f) < 7) {
            szTemp[1] = szTemp[1] + '\x02';
            uVar3 = __aFulshr(uVar4,etaFirst);
            if (((uint)uVar3 & 0x7f) == 3) {
              szTemp[5] = '*';
            }
          }
          uVar3 = __aFulshr(uVar4,etaFirst);
          if (((((uint)uVar3 & 0x7f) == 0xc) ||
              (uVar3 = __aFulshr(uVar4,etaFirst), ((uint)uVar3 & 0x7f) == 4)) ||
             (uVar3 = __aFulshr(uVar4,etaFirst), ((uint)uVar3 & 0x7f) == 5)) {
            szTemp[1] = szTemp[1] + '\x01';
          }
        }
        if (bVar1) {
          _strcpy((char *)szWork,szTemp);
          return;
        }
        SendMessage(hwnd,0x401,0,(LPARAM)CONCAT22(unaff_SS,szTemp));
      }
      lpprod = (PROD *)CONCAT22(lpprod._2_2_,(PROD *)lpprod + 1);
    }
    if (bVar1) {
      CchGetString(idsQueueEmpty,(char *)szWork);
    }
  }
  return;
}



// ======================================================================
// Function: PctPlanetCapacity
// Address: 1048:6aca
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10486af9) */
/* WARNING: Removing unreachable block (ram,0x10486b64) */

short PctPlanetCapacity(PLANET *lppl)

{
  undefined2 uVar1;
  long lVar2;
  long lVar3;
  ulong uVar4;
  long lPopMax;
  long pctCap;
  
  lVar2 = CalcPlanetMaxPop(lppl->id,idPlayer);
  if (lVar2 < 1) {
    pctCap._0_2_ = 0;
  }
  else {
    lVar3 = __aFldiv(lVar2,2);
    uVar1 = (undefined2)((ulong)lppl >> 0x10);
    uVar4 = __aFulmul(CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                                       (int)((PLANET *)lppl)->rgwtMin[3]),100);
    lVar2 = __aFldiv(uVar4 + lVar3,lVar2);
    pctCap._0_2_ = (short)lVar2;
    if (999 < lVar2) {
      pctCap._0_2_ = 999;
    }
  }
  return (short)pctCap;
}



// ======================================================================
// Function: PctPlanetOptValue
// Address: 1048:6b88
// Segment: MEMORY_PLANET
// ======================================================================


short PctPlanetOptValue(PLANET *lppl,short iPlr)

{
  short sVar1;
  short iNewVal;
  short rgiValSav [3];
  short rgCost [3];
  short pctDesire;
  short rgMin [3];
  short i;
  short rgMax [3];
  
  sVar1 = FCanTerraformLppl(lppl,rgMin,rgMax,rgCost,1);
  if (sVar1 == 0) {
    sVar1 = PctPlanetDesirability(lppl,iPlr);
  }
  else {
    for (i = 0; i < 3; i = i + 1) {
      rgiValSav[i] = (int)((PLANET *)lppl)->rgEnvVar[i];
      if ((*(char *)(iPlr * 0xc0 + 0x59b5 + i) != -1) &&
         (((PLANET *)lppl)->rgEnvVar[i] != *(char *)(iPlr * 0xc0 + 0x59b2 + i))) {
        iNewVal = -1;
        if (((PLANET *)lppl)->rgEnvVar[i] < *(char *)(iPlr * 0xc0 + 0x59b2 + i)) {
          if ((int)((PLANET *)lppl)->rgEnvVar[i] < rgMax[i]) {
            if ((int)*(char *)(iPlr * 0xc0 + 0x59b2 + i) < rgMax[i]) {
              iNewVal = (short)*(char *)(iPlr * 0xc0 + 0x59b2 + i);
            }
            else {
              iNewVal = rgMax[i];
            }
          }
        }
        else if ((rgMin[i] != -1) && (rgMin[i] < (int)((PLANET *)lppl)->rgEnvVar[i])) {
          if (rgMin[i] < (int)*(char *)(iPlr * 0xc0 + 0x59b2 + i)) {
            iNewVal = (short)*(char *)(iPlr * 0xc0 + 0x59b2 + i);
          }
          else {
            iNewVal = rgMin[i];
          }
        }
        if (iNewVal != -1) {
          ((PLANET *)lppl)->rgEnvVar[i] = (char)iNewVal;
        }
      }
    }
    sVar1 = PctPlanetDesirability(lppl,idPlayer);
    for (i = 0; i < 3; i = i + 1) {
      ((PLANET *)lppl)->rgEnvVar[i] = (char)rgiValSav[i];
    }
  }
  return sVar1;
}



// ======================================================================
// Function: PctPlanetDesirability
// Address: 1048:6e1e
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Variable defined which should be unmapped: pctMod */

short PctPlanetDesirability(PLANET *lppl,short iPlr)

{
  int iVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  short sVar5;
  uint uVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  bool bVar7;
  ulong uVar8;
  undefined1 *b;
  long lVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  long pctMod;
  short iPlanet;
  short pctVar;
  long pctPos;
  short dPenalty;
  short i;
  short iPref;
  long pctNeg;
  short iMax;
  short d;
  short iMin;
  
  pctPos = 0;
  pctNeg._0_2_ = 0;
  pctNeg._2_2_ = 0;
  b = &DAT_0000_2710;
  i = 0;
  while( true ) {
    pctMod._2_2_ = (undefined2)((ulong)b >> 0x10);
    pctMod._0_2_ = (undefined1 *)b;
    if (2 < i) break;
    iVar1 = (int)((PLANET *)lppl)->rgEnvVar[i];
    iVar2 = (int)*(char *)(iPlr * 0xc0 + 0x59b2 + i);
    iVar3 = (int)*(char *)(iPlr * 0xc0 + 0x59b5 + i);
    iVar4 = (int)*(char *)(iPlr * 0xc0 + 0x59b8 + i);
    if (iVar4 < 0) {
      pctPos = CONCAT22(pctPos._2_2_ + (uint)(0xd8ef < (uint)pctPos),(uint)pctPos + 10000);
    }
    else if ((iVar1 < iVar3) || (iVar4 < iVar1)) {
      if (iVar1 < iVar3) {
        if (iVar3 - iVar1 < 0x10) {
          uVar6 = iVar3 - iVar1;
          iVar1 = (int)uVar6 >> 0xf;
        }
        else {
          uVar6 = 0xf;
          iVar1 = 0;
        }
        bVar7 = CARRY2((uint)pctNeg,uVar6);
        pctNeg._0_2_ = (uint)pctNeg + uVar6;
        pctNeg._2_2_ = pctNeg._2_2_ + iVar1 + (uint)bVar7;
      }
      else {
        if (iVar1 - iVar4 < 0x10) {
          uVar6 = iVar1 - iVar4;
          iVar1 = (int)uVar6 >> 0xf;
        }
        else {
          uVar6 = 0xf;
          iVar1 = 0;
        }
        bVar7 = CARRY2((uint)pctNeg,uVar6);
        pctNeg._0_2_ = (uint)pctNeg + uVar6;
        pctNeg._2_2_ = pctNeg._2_2_ + iVar1 + (uint)bVar7;
      }
    }
    else {
      sVar5 = _abs(iVar1 - iVar2);
      if (iVar1 < iVar2) {
        d = iVar2 - iVar3;
        dPenalty = (iVar2 - iVar1) * 2 - d;
      }
      else {
        d = iVar4 - iVar2;
        dPenalty = (iVar1 - iVar2) * 2 - d;
      }
      pctVar = (sVar5 * 100) / d;
      uVar8 = __aFulmul((long)(100 - pctVar),(long)(100 - pctVar));
      pctPos = uVar8 + pctPos;
      if (0 < dPenalty) {
        uVar8 = __aFulmul((ulong)b,(long)(d * 2 - dPenalty));
        b = (undefined1 *)__aFldiv(uVar8,(long)(d << 1));
      }
    }
    i = i + 1;
  }
  if (((uint)pctNeg == 0) && (pctNeg._2_2_ == 0)) {
    _sqrt(SUB84((double)pctPos / DOUBLE_3_0__1120_1d2e,0),
                  (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)((double)pctPos /
                                                                            DOUBLE_3_0__1120_1d2e)
                                                                    >> 0x20))));
    uVar8 = __ftol((double)CONCAT26(pctMod._2_2_,
                                            CONCAT24((undefined1 *)pctMod,
                                                     CONCAT22(unaff_SI,unaff_DI))));
    uVar11 = 0;
    uVar10 = 10000;
    uVar8 = __aFulmul(uVar8,(ulong)b);
    lVar9 = __aFldiv(uVar8,CONCAT22(uVar11,uVar10));
    sVar5 = (short)lVar9;
  }
  else {
    sVar5 = -(uint)pctNeg;
  }
  return sVar5;
}



// ======================================================================
// Function: CalcPlanetMaxPop
// Address: 1048:7096
// Segment: MEMORY_PLANET
// ======================================================================


long CalcPlanetMaxPop(short idpl,short iplr)

{
  short sVar1;
  uint uVar2;
  int iVar3;
  undefined2 unaff_SS;
  ulong num;
  long lVar4;
  short ihuldef;
  long pctDesire;
  long lMaxPop;
  PLANET pl;
  
  FLookupPlanet(idpl,&pl);
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  if (sVar1 == raMacintosh) {
    if ((pl.iPlayer != iplr) || (((uint)pl.wFlags >> 9 & 1) == 0)) {
      return 0;
    }
    iVar3 = (*(int *)(*(int *)(iplr * 4 + 0x14c) + (pl._44_2_ & 0xf) * 0x93) + -0x20) * 4;
    num = CONCAT22(*(undefined2 *)(iVar3 + 0x8ce),*(undefined2 *)(iVar3 + 0x8cc));
  }
  else {
    uVar2 = PctPlanetDesirability((PLANET *)CONCAT22(unaff_SS,&pl),iplr);
    if (((int)uVar2 >> 0xf < 1) && (((int)uVar2 >> 0xf < 0 || (uVar2 < 5)))) {
      num = 500;
    }
    else {
      num = __aFulmul((long)(int)uVar2,100);
    }
    sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
    if (sVar1 == raCheapCol) {
      lVar4 = __aFldiv(num,2);
      num = num - lVar4;
    }
    else {
      sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
      if (sVar1 == raNone) {
        lVar4 = __aFldiv(num,5);
        num = lVar4 + num;
      }
    }
  }
  sVar1 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceOBRM);
  if (sVar1 != 0) {
    lVar4 = __aFldiv(num,10);
    num = lVar4 + num;
  }
  return num;
}



// ======================================================================
// Function: CMaxMines
// Address: 1048:7248
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104872b7) */

short CMaxMines(PLANET *lppl,short iplr)

{
  short sVar1;
  ulong uVar2;
  long lVar3;
  short iEff;
  long lPopMax;
  long cMax;
  
  uVar2 = CalcPlanetMaxPop(lppl->id,iplr);
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMineOperate);
  lVar3 = 100;
  uVar2 = __aFulmul(uVar2,(long)sVar1);
  lVar3 = __aFldiv(uVar2,lVar3);
  if (lVar3 < 10) {
    lVar3 = 10;
  }
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  cMax._0_2_ = (short)lVar3;
  if (sVar1 == raMacintosh) {
    cMax._0_2_ = 0;
  }
  return (short)cMax;
}



// ======================================================================
// Function: CMaxOperableMines
// Address: 1048:7304
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104873a5) */

short CMaxOperableMines(PLANET *lppl,short iplr,short fNextYear)

{
  short sVar1;
  short sVar2;
  ulong uVar3;
  long lVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  short iEff;
  long lPop;
  long cCur;
  short cMax;
  
  sVar1 = CMaxMines(lppl,iplr);
  sVar2 = GetRaceStat((PLAYER *)rgplr + iplr,rsMineOperate);
  uVar3 = CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                   (int)((PLANET *)lppl)->rgwtMin[3]);
  if (fNextYear != 0) {
    lVar4 = ChgPopFromPlanet(lppl,0);
    uVar3 = lVar4 + uVar3;
  }
  uVar6 = 0;
  uVar5 = 100;
  uVar3 = __aFulmul(uVar3,(long)sVar2);
  lVar4 = __aFldiv(uVar3,CONCAT22(uVar6,uVar5));
  cMax = (short)lVar4;
  if (sVar1 < lVar4) {
    cMax = sVar1;
  }
  if (cMax < 1) {
    cMax = 1;
  }
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  if (sVar1 == raMacintosh) {
    cMax = 0;
  }
  return cMax;
}



// ======================================================================
// Function: CMinesOperating
// Address: 1048:73fc
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Variable defined which should be unmapped: cMines */

short CMinesOperating(PLANET *lppl)

{
  short sVar1;
  uint uVar2;
  uint uVar3;
  PLANET *pPVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  long lVar6;
  ulong uVar7;
  short cMines;
  short cMinesOp;
  short iplr;
  
  uVar5 = (undefined2)((ulong)lppl >> 0x10);
  pPVar4 = (PLANET *)lppl;
  if (pPVar4->iPlayer == -1) {
    uVar3 = 0;
  }
  else {
    sVar1 = GetRaceStat((PLAYER *)rgplr + pPVar4->iPlayer,rsMajorAdv);
    if (sVar1 == raMacintosh) {
      _sqrt(SUB84((double)pPVar4->rgwtMin[3],0),
                    (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)pPVar4->
                                                  rgwtMin[3] >> 0x20))));
      lVar6 = __ftol((double)CONCAT26(cMinesOp,CONCAT24(cMines,CONCAT22(unaff_SI,unaff_DI)))
                            );
      uVar3 = (uint)lVar6;
    }
    else {
      uVar7 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),cMines);
      uVar2 = (uint)uVar7 & 0xfff;
      uVar3 = CMaxOperableMines(lppl,pPVar4->iPlayer,0);
      if ((int)uVar2 <= (int)uVar3) {
        uVar3 = uVar2;
      }
    }
  }
  return uVar3;
}



// ======================================================================
// Function: CFactoriesOperating
// Address: 1048:74be
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Variable defined which should be unmapped: cFactsOp */

short CFactoriesOperating(PLANET *lppl)

{
  int iVar1;
  short sVar2;
  uint uVar3;
  uint uVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  ulong uVar6;
  short cFactsOp;
  short cFacts;
  short iplr;
  
  uVar6 = CONCAT22(unaff_SI,unaff_DI);
  uVar5 = (undefined2)((ulong)lppl >> 0x10);
  iVar1 = ((PLANET *)lppl)->iPlayer;
  if (iVar1 == -1) {
    uVar4 = 0;
  }
  else {
    sVar2 = GetRaceStat((PLAYER *)rgplr + iVar1,rsMajorAdv);
    if (sVar2 == raMacintosh) {
      uVar4 = 0;
    }
    else {
      uVar6 = __aFulshr(uVar6,cFactsOp);
      uVar3 = (uint)uVar6 & 0xfff;
      uVar4 = CMaxOperableFactories(lppl,((PLANET *)lppl)->iPlayer,0);
      if ((int)uVar3 <= (int)uVar4) {
        uVar4 = uVar3;
      }
    }
  }
  return uVar4;
}



// ======================================================================
// Function: CMaxFactories
// Address: 1048:755c
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104875cb) */

short CMaxFactories(PLANET *lppl,short iplr)

{
  short sVar1;
  ulong uVar2;
  long lVar3;
  short iEff;
  long lPopMax;
  long cMax;
  
  uVar2 = CalcPlanetMaxPop(lppl->id,iplr);
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsFactOperate);
  lVar3 = 100;
  uVar2 = __aFulmul(uVar2,(long)sVar1);
  lVar3 = __aFldiv(uVar2,lVar3);
  if (lVar3 < 10) {
    lVar3 = 10;
  }
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  cMax._0_2_ = (short)lVar3;
  if (sVar1 == raMacintosh) {
    cMax._0_2_ = 0;
  }
  return (short)cMax;
}



// ======================================================================
// Function: CMaxOperableFactories
// Address: 1048:7618
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104876b9) */

short CMaxOperableFactories(PLANET *lppl,short iplr,short fNextYear)

{
  short sVar1;
  short sVar2;
  ulong uVar3;
  long lVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  short iEff;
  long lPop;
  long cCur;
  short cMax;
  
  sVar1 = CMaxFactories(lppl,iplr);
  sVar2 = GetRaceStat((PLAYER *)rgplr + iplr,rsFactOperate);
  uVar3 = CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                   (int)((PLANET *)lppl)->rgwtMin[3]);
  if (fNextYear != 0) {
    lVar4 = ChgPopFromPlanet(lppl,0);
    uVar3 = lVar4 + uVar3;
  }
  uVar6 = 0;
  uVar5 = 100;
  uVar3 = __aFulmul(uVar3,(long)sVar2);
  lVar4 = __aFldiv(uVar3,CONCAT22(uVar6,uVar5));
  cMax = (short)lVar4;
  if (sVar1 < lVar4) {
    cMax = sVar1;
  }
  if (cMax < 1) {
    cMax = 1;
  }
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  if (sVar1 == raMacintosh) {
    cMax = 0;
  }
  return cMax;
}



// ======================================================================
// Function: CMaxDefenses
// Address: 1048:7710
// Segment: MEMORY_PLANET
// ======================================================================


short CMaxDefenses(PLANET *lppl,short iplr)

{
  short sVar1;
  int iVar2;
  short pctDesire;
  short cMax;
  
  sVar1 = PctPlanetDesirability(lppl,iplr);
  if (sVar1 * 4 < 10) {
    iVar2 = 10;
  }
  else {
    iVar2 = sVar1 << 2;
  }
  if (iVar2 < 0x65) {
    if (sVar1 * 4 < 10) {
      cMax = 10;
    }
    else {
      cMax = sVar1 << 2;
    }
  }
  else {
    cMax = 100;
  }
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  if (sVar1 == raMacintosh) {
    cMax = 0;
  }
  return cMax;
}



// ======================================================================
// Function: CMaxOperableDefenses
// Address: 1048:77ae
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1048782c) */

short CMaxOperableDefenses(PLANET *lppl,short iplr,short fNextYear)

{
  short sVar1;
  long lVar2;
  long lVar3;
  long lPop;
  long cCur;
  short cMax;
  
  cMax = CMaxDefenses(lppl,iplr);
  lVar3 = CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                   (int)((PLANET *)lppl)->rgwtMin[3]);
  if (fNextYear != 0) {
    lVar2 = ChgPopFromPlanet(lppl,0);
    lVar3 = lVar2 + lVar3;
  }
  lVar3 = __aFldiv(lVar3 + 0x18,0x19);
  if (1000 < lVar3) {
    lVar3 = 1000;
  }
  cCur._0_2_ = (int)lVar3;
  if ((int)cCur <= cMax) {
    cMax = (int)cCur;
  }
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  if (sVar1 == raMacintosh) {
    cMax = 0;
  }
  return cMax;
}



// ======================================================================
// Function: CResourcesAtPlanet
// Address: 1048:788e
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1048790a) */
/* WARNING: Removing unreachable block (ram,0x10487954) */

short CResourcesAtPlanet(PLANET *lppl,short iplr)

{
  uint uVar1;
  int iVar2;
  double dVar3;
  short sVar4;
  short sVar5;
  PLANET *pPVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar7;
  long lVar8;
  ulong uVar9;
  long lVar10;
  undefined2 uVar11;
  ushort in_stack_0000ffca;
  long local_26;
  long local_1e;
  short iEnergy;
  short pctVal;
  short iEff;
  long lPopMax;
  short cFact;
  long lPop;
  short cRes;
  
  uVar7 = (undefined2)((ulong)lppl >> 0x10);
  pPVar6 = (PLANET *)lppl;
  if (((int)pPVar6->rgwtMin[3] == 0) && (*(int *)((int)pPVar6->rgwtMin + 0xe) == 0)) {
    cRes = 0;
  }
  else {
    sVar4 = GetRaceStat((PLAYER *)rgplr + iplr,rsResGen);
    uVar1 = *(uint *)(pPVar6->rgwtMin + 3);
    iVar2 = *(int *)((int)pPVar6->rgwtMin + 0xe);
    lPop = CONCAT22(iVar2,uVar1);
    lVar8 = CalcPlanetMaxPop(lppl->id,iplr);
    if (lVar8 < lPop) {
      lVar10 = __aFldiv(CONCAT22((iVar2 - (int)((ulong)lVar8 >> 0x10)) -
                                         (uint)(uVar1 < (uint)lVar8),uVar1 - (uint)lVar8),2);
      lPop = lVar8 + lVar10;
      lVar8 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffca);
      if (lVar8 < lPop) {
        lPop = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffca);
      }
    }
    sVar5 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
    if (sVar5 == raMacintosh) {
      iEnergy = (short)*(char *)((int)rgplr[0].rgTech + iplr * 0xc0);
      PctPlanetDesirability(lppl,iplr);
      if (iEnergy < 1) {
        iEnergy = 1;
      }
      local_1e = (long)iEnergy;
      local_26 = (long)sVar4;
      dVar3 = ((double)local_1e * (double)lPop) / (double)local_26;
      _sqrt(SUB84(dVar3,0),
                    (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar3 >> 0x20))));
      lVar8 = __ftol((double)(qword)CONCAT24(10,CONCAT22(unaff_SI,unaff_DI)));
      cRes = (short)lVar8;
    }
    else {
      lVar8 = __aFldiv(lPop,(long)sVar4);
      cFact = CMaxOperableFactories(lppl,iplr,0);
      uVar9 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffca);
      if ((int)((uint)uVar9 & 0xfff) < cFact) {
        uVar9 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffca);
        cFact = (uint)uVar9 & 0xfff;
      }
      sVar4 = GetRaceStat((PLAYER *)rgplr + iplr,rsFactProd);
      uVar11 = 0;
      uVar7 = 10;
      uVar9 = __aFulmul((long)cFact,(long)sVar4);
      lVar10 = __aFldiv(uVar9 + 9,CONCAT22(uVar11,uVar7));
      cRes = (int)lVar8 + (int)lVar10;
    }
    if (cRes == 0) {
      cRes = 1;
    }
  }
  return cRes;
}



// ======================================================================
// Function: IWarpMAFromLppl
// Address: 1048:7b10
// Segment: MEMORY_PLANET
// ======================================================================


short IWarpMAFromLppl(PLANET *lppl,short *pfTwo)

{
  undefined2 uVar1;
  int iVar2;
  PLANET *pPVar3;
  int iVar4;
  undefined2 uVar5;
  short iNew;
  HUL *lphul;
  short i;
  short iWarp;
  short fTwo;
  
  iWarp = 0;
  fTwo = 0;
  if (pfTwo != (short *)0x0) {
    *pfTwo = 0;
  }
  uVar5 = (undefined2)((ulong)lppl >> 0x10);
  pPVar3 = (PLANET *)lppl;
  if ((pPVar3->iPlayer == -1) || (((uint)pPVar3->wFlags >> 9 & 1) == 0)) {
    iWarp = 0;
  }
  else if ((pPVar3->iPlayer == idPlayer) ||
          ((idPlayer == -1 ||
           (iVar4 = pPVar3->iPlayer * 4,
           (*(uint *)(*(int *)(iVar4 + 0x14c) + (*(uint *)&pPVar3->field11_0x2c & 0xf) * 0x93 + 0x7b
                     ) & 0xff) == 7)))) {
    iVar4 = pPVar3->iPlayer * 4;
    uVar1 = *(undefined2 *)(iVar4 + 0x14e);
    iVar4 = *(int *)(iVar4 + 0x14c) + (*(uint *)&pPVar3->field11_0x2c & 0xf) * 0x93;
    for (i = 0; i < (int)(uint)*(byte *)(iVar4 + 0x7a); i = i + 1) {
      if ((((*(int *)(iVar4 + 0x3a + i * 4) == 0x200) && (*(uint *)(iVar4 + i * 4 + 0x3c) >> 8 != 0)
           ) && (6 < (*(uint *)(iVar4 + i * 4 + 0x3c) & 0xff))) &&
         ((*(uint *)(iVar4 + i * 4 + 0x3c) & 0xff) < 0x10)) {
        iVar2 = (*(uint *)(iVar4 + i * 4 + 0x3c) & 0xff) - 2;
        if (iWarp < iVar2) {
          fTwo = 0;
          iWarp = iVar2;
        }
        else if (iVar2 == iWarp) {
          fTwo = 1;
        }
      }
    }
    if (pfTwo != (short *)0x0) {
      *pfTwo = fTwo;
    }
  }
  else {
    iWarp = 0;
  }
  return iWarp;
}



// ======================================================================
// Function: StargateRangeFromLppl
// Address: 1048:7cfa
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10487e13) */

short StargateRangeFromLppl(PLANET *lppl,short iplr,short ish)

{
  int iVar1;
  HUL *pHVar2;
  undefined2 uVar3;
  PART part;
  HUL *lphul;
  short i;
  
  if (lppl == (PLANET *)0x0) {
    lphul = (HUL *)CONCAT22(*(undefined2 *)(iplr * 4 + 0x14e),
                            (HUL *)(*(int *)(iplr * 4 + 0x14c) + ish * 0x93));
  }
  else {
    if ((((PLANET *)lppl)->iPlayer == -1) || (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) == 0)) {
      return 0;
    }
    iVar1 = ((PLANET *)lppl)->iPlayer * 4;
    lphul = (HUL *)CONCAT22(*(undefined2 *)(iVar1 + 0x14e),
                            (HUL *)(*(int *)(iVar1 + 0x14c) +
                                   (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) * 0x93));
  }
  i = 0;
  while( true ) {
    uVar3 = (undefined2)((ulong)lphul >> 0x10);
    pHVar2 = (HUL *)lphul;
    if ((int)(uint)pHVar2->chs <= i) {
      return 0;
    }
    if ((((pHVar2->rghs + i)->grhst == hstSpecialSB) && ((uint)pHVar2->rghs[i].wFlags >> 8 != 0)) &&
       ((pHVar2->rghs[i].wFlags & 0xffU) < 7)) break;
    i = i + 1;
  }
  part.hs.grhst = (pHVar2->rghs + i)->grhst;
  part.hs.wFlags = pHVar2->rghs[i].wFlags;
  FLookupPart(&part);
  uVar3 = (undefined2)((ulong)part.pcom >> 0x10);
  if (*(int *)((COMPART *)part.pcom)[1].rgTech != -1) {
    return *(short *)((COMPART *)part.pcom)[1].rgTech;
  }
  return 10000;
}



// ======================================================================
// Function: FProdIsTerra
// Address: 1048:7e9a
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10487f40) */
/* WARNING: Removing unreachable block (ram,0x10487ec8) */

short FProdIsTerra(PROD *lpprod)

{
  short sVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar2;
  ulong uVar3;
  ushort in_stack_0000fffc;
  
  uVar3 = CONCAT22(unaff_SI,unaff_DI);
  uVar2 = __aFulshr(uVar3,in_stack_0000fffc);
  if ((((uint)uVar2 & 7) == 1) &&
     (((uVar2 = __aFulshr(uVar3,in_stack_0000fffc), ((uint)uVar2 & 0x7f) == 0xc ||
       (uVar2 = __aFulshr(uVar3,in_stack_0000fffc), ((uint)uVar2 & 0x7f) == 4)) ||
      (uVar2 = __aFulshr(uVar3,in_stack_0000fffc), ((uint)uVar2 & 0x7f) == 5)))) {
    sVar1 = 1;
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: IpctCanTerraformLppl
// Address: 1048:7f56
// Segment: MEMORY_PLANET
// ======================================================================


short IpctCanTerraformLppl(PLANET *lppl)

{
  short sVar1;
  short ipct;
  short rgCost [3];
  short rgMin [3];
  short i;
  short rgMax [3];
  
  sVar1 = FCanTerraformLppl(lppl,rgMin,rgMax,rgCost,1);
  if (sVar1 == 0) {
    ipct = 0;
  }
  else {
    ipct = 0;
    for (i = 0; i < 3; i = i + 1) {
      if (rgMin[i] != -1) {
        ipct = ipct + ((int)((PLANET *)lppl)->rgEnvVar[i] - rgMin[i]);
      }
      if (rgMax[i] != -1) {
        ipct = ipct + (rgMax[i] - (int)((PLANET *)lppl)->rgEnvVar[i]);
      }
    }
  }
  return ipct;
}



// ======================================================================
// Function: FCanTerraformLppl
// Address: 1048:8022
// Segment: MEMORY_PLANET
// ======================================================================


short FCanTerraformLppl(PLANET *lppl,short *rgEnvMin,short *rgEnvMax,short *rgEnvCost,short fHelp)

{
  bool bVar1;
  short sVar2;
  short sVar3;
  uint uVar4;
  int iVar5;
  PLANET *pPVar6;
  COMPART *pCVar7;
  undefined2 uVar8;
  undefined2 uVar9;
  short ienvIdeal;
  short dCur;
  short dMax;
  short dMin;
  PART part;
  short iPlrSav;
  short rgMove [3];
  short i;
  short fRet;
  
  sVar2 = idPlayer;
  pPVar6 = (PLANET *)lppl;
  uVar8 = (undefined2)((ulong)lppl >> 0x10);
  if (idPlayer == -1) {
    idPlayer = pPVar6->iPlayer;
  }
  part.hs.grhst = hstTerra;
  for (i = 7; -1 < i; i = i + -1) {
    part.hs.wFlags = part.hs.wFlags & 0xff00U | i & 0xffU;
    sVar3 = FLookupPart(&part);
    if (sVar3 == 1) break;
  }
  if (i < 0) {
    bVar1 = false;
    for (i = 0; i < 3; i = i + 1) {
      rgMove[i] = 0;
    }
  }
  else {
    bVar1 = true;
    for (i = 0; i < 3; i = i + 1) {
      uVar9 = (undefined2)((ulong)part.pcom >> 0x10);
      rgMove[i] = ((COMPART *)part.pcom + 1)->id;
      rgEnvCost[i] = ((COMPART *)part.pcom)->resCost;
    }
  }
  for (i = 3; -1 < i; i = i + -1) {
    part.hs.wFlags = part.hs.wFlags & 0xff00U | i + 8U & 0xff;
    sVar3 = FLookupPart(&part);
    if (sVar3 == 1) break;
  }
  if (-1 < i) {
    uVar9 = (undefined2)((ulong)part.pcom >> 0x10);
    pCVar7 = (COMPART *)part.pcom;
    if (rgMove[0] < (pCVar7 + 1)->id) {
      bVar1 = true;
      rgMove[0] = (pCVar7 + 1)->id;
      *rgEnvCost = pCVar7->resCost;
    }
  }
  for (i = 3; -1 < i; i = i + -1) {
    part.hs.wFlags = part.hs.wFlags & 0xff00U | i + 0xcU & 0xff;
    sVar3 = FLookupPart(&part);
    if (sVar3 == 1) break;
  }
  if (-1 < i) {
    uVar9 = (undefined2)((ulong)part.pcom >> 0x10);
    pCVar7 = (COMPART *)part.pcom;
    if (rgMove[1] < (pCVar7 + 1)->id) {
      bVar1 = true;
      rgMove[1] = (pCVar7 + 1)->id;
      rgEnvCost[1] = pCVar7->resCost;
    }
  }
  for (i = 3; -1 < i; i = i + -1) {
    part.hs.wFlags = part.hs.wFlags & 0xff00U | i + 0x10U & 0xff;
    sVar3 = FLookupPart(&part);
    if (sVar3 == 1) break;
  }
  if (-1 < i) {
    uVar9 = (undefined2)((ulong)part.pcom >> 0x10);
    pCVar7 = (COMPART *)part.pcom;
    if (rgMove[2] < (pCVar7 + 1)->id) {
      bVar1 = true;
      rgMove[2] = (pCVar7 + 1)->id;
      rgEnvCost[2] = pCVar7->resCost;
    }
  }
  if (bVar1) {
    for (i = 0; i < 3; i = i + 1) {
      if ((rgMove[i] == 0) || (*(char *)(idPlayer * 0xc0 + 0x59b5 + i) == -1)) {
        rgEnvMax[i] = -1;
        rgEnvMin[i] = -1;
      }
      else {
        rgEnvMin[i] = (int)pPVar6->rgEnvVarOrig[i] - rgMove[i];
        rgEnvMax[i] = (int)pPVar6->rgEnvVarOrig[i] + rgMove[i];
        if (rgEnvMin[i] < (int)pPVar6->rgEnvVar[i]) {
          if (rgEnvMin[i] < 1) {
            sVar3 = 1;
          }
          else {
            sVar3 = rgEnvMin[i];
          }
          rgEnvMin[i] = sVar3;
        }
        else {
          rgEnvMin[i] = -1;
        }
        if ((int)pPVar6->rgEnvVar[i] < rgEnvMax[i]) {
          if (rgEnvMax[i] < 100) {
            sVar3 = rgEnvMax[i];
          }
          else {
            sVar3 = 99;
          }
          rgEnvMax[i] = sVar3;
        }
        else {
          rgEnvMax[i] = -1;
        }
        if (fHelp == 0) {
          iVar5 = (int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
          sVar3 = _abs(pPVar6->rgEnvVar[i] - iVar5);
          if (rgEnvMin[i] == -1) {
            dMin = 0;
          }
          else {
            dMin = _abs(rgEnvMin[i] - iVar5);
          }
          if (rgEnvMax[i] == -1) {
            dMax = 0;
          }
          else {
            dMax = _abs(rgEnvMax[i] - iVar5);
          }
          if ((sVar3 < dMin) || (sVar3 < dMax)) {
            if (dMin < dMax) {
              rgEnvMin[i] = -1;
            }
            else {
              rgEnvMax[i] = -1;
            }
          }
          else {
            rgEnvMax[i] = -1;
            rgEnvMin[i] = -1;
          }
        }
        else if (pPVar6->rgEnvVar[i] == *(char *)(idPlayer * 0xc0 + 0x59b2 + i)) {
          rgEnvMax[i] = -1;
          rgEnvMin[i] = -1;
        }
        else if (*(char *)(idPlayer * 0xc0 + 0x59b2 + i) < pPVar6->rgEnvVar[i]) {
          rgEnvMax[i] = -1;
          if (rgEnvMin[i] != -1) {
            if ((int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i) < rgEnvMin[i]) {
              iVar5 = rgEnvMin[i];
            }
            else {
              iVar5 = (int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
            }
            rgEnvMin[i] = iVar5;
          }
        }
        else {
          rgEnvMin[i] = -1;
          if (rgEnvMax[i] != -1) {
            if (rgEnvMax[i] < (int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i)) {
              iVar5 = rgEnvMax[i];
            }
            else {
              iVar5 = (int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
            }
            rgEnvMax[i] = iVar5;
          }
        }
      }
    }
    for (i = 0; ((i < 3 && (rgEnvMax[i] == -1)) && (rgEnvMin[i] == -1)); i = i + 1) {
    }
    uVar4 = (uint)(i != 3);
  }
  else {
    uVar4 = 0;
  }
  idPlayer = sVar2;
  return uVar4;
}



// ======================================================================
// Function: UninhabitPlanet
// Address: 1048:8732
// Segment: MEMORY_PLANET
// ======================================================================


void UninhabitPlanet(PLANET *lppl)

{
  int iVar1;
  uint uVar2;
  undefined2 uVar3;
  PLANET *pPVar4;
  short sVar5;
  PLANET *pPVar6;
  undefined2 uVar7;
  short i;
  
  uVar7 = (undefined2)((ulong)lppl >> 0x10);
  pPVar6 = (PLANET *)lppl;
  if ((-1 < pPVar6->iPlayer) &&
     (sVar5 = GetRaceStat((PLAYER *)rgplr + pPVar6->iPlayer,rsMajorAdv),
     sVar5 == raTerra)) {
    for (i = 0; i < 3; i = i + 1) {
      pPVar6->rgEnvVar[i] = pPVar6->rgEnvVarOrig[i];
    }
  }
  pPVar6->iPlayer = -1;
  *(undefined2 *)(pPVar6->rgwtMin + 3) = 0;
  *(undefined2 *)((int)pPVar6->rgwtMin + 0xe) = 0;
  if ((*(int *)&pPVar6->lpplprod != 0) || (*(int *)((int)&pPVar6->lpplprod + 2) != 0)) {
    FreePl((PL *)CONCAT22(*(undefined2 *)
                                   ((int)&((PLANET *)lpPlanets)[lppl->id].lpplprod + 2),
                                  *(PL **)&((PLANET *)lpPlanets)[lppl->id].lpplprod));
    uVar3 = lpPlanets._2_2_;
    pPVar4 = (PLANET *)lpPlanets;
    iVar1 = lppl->id;
    *(undefined2 *)&((PLANET *)lpPlanets)[iVar1].lpplprod = 0;
    *(undefined2 *)((int)&pPVar4[iVar1].lpplprod + 2) = 0;
    *(undefined2 *)&pPVar6->lpplprod = 0;
    *(undefined2 *)((int)&pPVar6->lpplprod + 2) = 0;
  }
  uVar2 = *(uint *)((int)&pPVar6->dwFlags + 2);
  *(int *)&pPVar6->dwFlags = (int)pPVar6->dwFlags;
  *(uint *)((int)&pPVar6->dwFlags + 2) = uVar2 & 0xff7f;
  pPVar6->wFlags = pPVar6->wFlags & 0xfdff;
  uVar3 = *(undefined2 *)((int)&pPVar6->dwFlags + 2);
  *(uint *)&pPVar6->dwFlags = *(uint *)&pPVar6->dwFlags & 0xf000;
  *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar3;
  uVar2 = *(uint *)((int)&pPVar6->dwFlags + 2);
  *(uint *)&pPVar6->dwFlags = *(uint *)&pPVar6->dwFlags & 0xfff | 0xf000;
  *(uint *)((int)&pPVar6->dwFlags + 2) = uVar2 & 0xfffe | 1;
  *(undefined2 *)&pPVar6->field11_0x2c = 0;
  pPVar6->wFlags = 0;
  return;
}



// ======================================================================
// Function: PctCloakFromHuldef
// Address: 1048:88c0
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10488a4b) */

short PctCloakFromHuldef(HUL *lphul,short iplr,short *ppctSteal)

{
  int iVar1;
  byte bVar2;
  uint uVar3;
  short sVar4;
  undefined2 uVar5;
  bool bVar6;
  short j;
  short cScore;
  long cPts;
  HS *lphs;
  short chs;
  
  uVar5 = (undefined2)((ulong)lphul >> 0x10);
  bVar2 = ((HUL *)lphul)->chs;
  if (((iplr == -1) || ((int)lphul->ihuldef < 0x20)) ||
     (sVar4 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceISB), sVar4 == 0)) {
    cPts._0_2_ = 0;
  }
  else {
    cPts._0_2_ = 0x28;
  }
  cPts._2_2_ = 0;
  if ((iplr != -1) &&
     (sVar4 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv), sVar4 == raStealth)) {
    bVar6 = 0xfed3 < (uint)cPts;
    cPts._0_2_ = (uint)cPts + 300;
    cPts._2_2_ = (uint)bVar6;
  }
  if (ppctSteal != (short *)0x0) {
    *ppctSteal = 0;
  }
  lphs = (HS *)CONCAT22(uVar5,((HUL *)lphul)->rghs);
  for (j = 0; j < (int)(uint)bVar2; j = j + 1) {
    uVar3 = CPtsCloakFromLphs(lphs);
    bVar6 = CARRY2((uint)cPts,uVar3);
    cPts._0_2_ = (uint)cPts + uVar3;
    cPts._2_2_ = cPts._2_2_ + ((int)uVar3 >> 0xf) + (uint)bVar6;
    if ((lphs->grhst == hstScanner) && (ppctSteal != (short *)0x0)) {
      if ((((HS *)lphs)->wFlags & 0xffU) == 5) {
        if (*ppctSteal < 0x46) {
          *ppctSteal = 0x46;
        }
      }
      else if (((((HS *)lphs)->wFlags & 0xffU) == 0xe) && (*ppctSteal < 0x50)) {
        *ppctSteal = 0x50;
      }
    }
    lphs = (HS *)CONCAT22(lphs._2_2_,(HS *)lphs + 1);
  }
  if (((uint)cPts == 0) && (cPts._2_2_ == 0)) {
    sVar4 = 0;
  }
  else if (((int)cPts._2_2_ < 0) ||
          ((-1 < (int)cPts._2_2_ && ((0 < (int)cPts._2_2_ || (25000 < (uint)cPts)))))) {
    sVar4 = 0;
  }
  else if ((int)(uint)cPts < 0x65) {
    sVar4 = (int)(uint)cPts >> 1;
  }
  else if ((int)((uint)cPts - 100) < 0xc9) {
    sVar4 = ((int)((uint)cPts - 100) >> 3) + 0x32;
  }
  else if ((int)((uint)cPts - 300) < 0x139) {
    sVar4 = (int)((uint)cPts - 300) / 0x18 + 0x4b;
  }
  else {
    iVar1 = (uint)cPts - 0x264;
    if (iVar1 < 0x201) {
      sVar4 = (iVar1 >> 6) + 0x58;
    }
    else if (iVar1 < 1000) {
      sVar4 = (0x2ff < iVar1) + 0x60;
    }
    else {
      sVar4 = 0x62;
    }
  }
  return sVar4;
}



// ======================================================================
// Function: LogSplitFleet
// Address: 1048:8b0e
// Segment: MEMORY_PLANET
// ======================================================================


void LogSplitFleet(short id)

{
  FLEET *pFVar1;
  short *local_8;
  undefined2 uStack_6;
  
  if (((uint)gd._0_2_ >> 1 & 1) == 0) {
    WriteMemRt(0x18,2,&id);
  }
  else {
    pFVar1 = LpflFromId(id);
    _local_8 = (uint *)CONCAT22((int)((ulong)pFVar1 >> 0x10),&((FLEET *)pFVar1)->wFlags);
    *_local_8 = *_local_8 & 0xffdf | 0x20;
  }
  return;
}



// ======================================================================
// Function: LogMergeFleet
// Address: 1048:8b6c
// Segment: MEMORY_PLANET
// ======================================================================


void LogMergeFleet(short id)

{
  short j;
  ushort rgid [512];
  short i;
  ushort idCur;
  
  if (((uint)gd._0_2_ >> 1 & 1) == 0) {
    i = 0;
    while (i < vcflMerge) {
      rgid[0] = id;
      j = 1;
      for (; (j < 0x1ff && (i < vcflMerge)); i = i + 1) {
        if ((vrgiflMerge[i] != -1) && (vrgiflMerge[i] != id)) {
          rgid[j] = vrgiflMerge[i];
          j = j + 1;
        }
      }
      WriteMemRt(0x25,j << 1,rgid);
    }
  }
  return;
}



// ======================================================================
// Function: LogChangeShDef
// Address: 1048:8c28
// Segment: MEMORY_PLANET
// ======================================================================


void LogChangeShDef(SHDEF *lpshdefNew)

{
  uint uVar1;
  uint uVar2;
  SHDEF *pSVar3;
  undefined2 uVar4;
  byte *pb;
  byte rgb [149];
  
  if (((uint)gd._0_2_ >> 1 & 1) == 0) {
    uVar4 = (undefined2)((ulong)lpshdefNew >> 0x10);
    pSVar3 = (SHDEF *)lpshdefNew;
    uVar1 = ((uint)pSVar3->wFlags >> 10 & 0x1f) << 8;
    uVar2 = (idPlayer & 0xfU) << 4;
    if (((uint)pSVar3->wFlags >> 9 & 1) == 0) {
      rgb._0_2_ = rgb._0_2_ & 0xe000 | uVar1 | uVar2 | 1;
      pSVar3->wFlags = pSVar3->wFlags & 0xff00U | 7;
      pb = rgb + 2;
      WriteRtShDef(lpshdefNew,&pb);
      WriteMemRt(0x1b,(int)pb - (int)rgb,rgb);
    }
    else {
      rgb._0_2_ = rgb._0_2_ & 0xe000 | uVar1 | uVar2;
      WriteMemRt(0x1b,2,rgb);
    }
    if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
      tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
      AdvanceTutor();
    }
  }
  return;
}



// ======================================================================
// Function: LogChangeName
// Address: 1048:8d5a
// Segment: MEMORY_PLANET
// ======================================================================


void LogChangeName(GrobjClass grobj,short id,char *szName)

{
  ushort uVar1;
  short sVar2;
  int iVar3;
  FLEET *pFVar4;
  undefined2 uVar5;
  undefined2 unaff_SS;
  void *pvVar6;
  HeapType ht;
  RTCHGNAME rtchgname;
  short cOut;
  FLEET *lpfl;
  
  lpfl = LpflFromId(id);
  iVar3 = (int)((ulong)lpfl >> 0x10);
  pFVar4 = (FLEET *)lpfl;
  if ((pFVar4 != (FLEET *)0x0) || (iVar3 != 0)) {
    if ((*(int *)&pFVar4->lpszName != 0) || (*(int *)((int)&pFVar4->lpszName + 2) != 0)) {
                    /* WARNING: Load size is inaccurate */
      FreeLp((void *)CONCAT22(*(undefined2 *)((int)&pFVar4->lpszName + 2),pFVar4->lpszName),
                     htString);
    }
    if ((szName == (char *)0x0) || (*szName == '\0')) {
      rtchgname.rgb[0] = 0;
      rtchgname.rgb[1] = 0;
      cOut = 1;
      uVar5 = (undefined2)((ulong)lpfl >> 0x10);
      *(undefined2 *)&((FLEET *)lpfl)->lpszName = 0;
      *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = 0;
    }
    else {
      cOut = _strlen(szName);
      ht = htString;
      uVar1 = _strlen(szName);
      pvVar6 = LpAlloc(uVar1 + 1,ht);
      uVar5 = (undefined2)((ulong)lpfl >> 0x10);
      pFVar4 = (FLEET *)lpfl;
      *(void **)&pFVar4->lpszName = (void *)pvVar6;
      *(undefined2 *)((int)&pFVar4->lpszName + 2) = (int)((ulong)pvVar6 >> 0x10);
                    /* WARNING: Load size is inaccurate */
      __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&pFVar4->lpszName + 2),
                                         pFVar4->lpszName),
                        (char *)CONCAT22((undefined1 *)&DAT_1120_1120,szName));
      sVar2 = FCompressUserString
                        ((char *)CONCAT22((undefined1 *)&DAT_1120_1120,szName),
                         (char *)CONCAT22(unaff_SS,rtchgname.rgb + 1),&cOut);
      if (sVar2 == 0) {
        rtchgname.rgb[0] = 0;
        _strcpy((char *)(rtchgname.rgb + 1),szName);
        cOut = cOut + 1;
      }
      else {
        rtchgname.rgb[0] = (byte)cOut;
      }
    }
    rtchgname.grobj = grobj;
    rtchgname.id = id;
    WriteMemRt(0x2c,cOut + 5,&rtchgname);
    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
  }
  return;
}



// ======================================================================
// Function: LogChangeFleet
// Address: 1048:8ebe
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Type propagation algorithm not settling */

void LogChangeFleet(FLEET *pfl,FLEET *pflNew)

{
  uint *puVar1;
  char **ppcVar2;
  RTWAYPT *pRVar3;
  short *psVar4;
  LOGXFERF *pLVar5;
  LOGXFER *pLVar6;
  short *psVar7;
  uint uVar8;
  undefined2 uVar9;
  bool bVar10;
  int iVar11;
  int iVar12;
  short sVar13;
  int iVar14;
  char **ppcVar15;
  RTWAYPT *pRVar16;
  short *psVar17;
  LOGXFERF *pLVar18;
  LOGXFER *pLVar19;
  short *psVar20;
  undefined2 unaff_SS;
  char *pbWp_2;
  HDR hdr;
  short cbWp_2;
  short iordOld;
  short iordNew;
  short sStack_24;
  RTWAYPT rtwp;
  short fChg;
  short i;
  short d;
  
  bVar10 = false;
  if (((uint)gd._0_2_ >> 1 & 1) == 0) {
    pbWp_2 = (char *)pfl->id;
    hdr.wFlags = 2;
    i = 0;
    while( true ) {
      if (0xf < i) break;
      iVar11 = pflNew->rgcsh[i] - ((FLEET *)pfl)->rgcsh[i];
      (&cbWp_2)[i] = iVar11;
      if (iVar11 != 0) {
        bVar10 = true;
      }
      i = i + 1;
    }
    if (bVar10) {
      if (fValidLxf == 0) {
        ppcVar15 = &pbWp_2;
        pLVar18 = (LOGXFERF *)&lxf;
        for (iVar11 = 0x12; iVar11 != 0; iVar11 = iVar11 + -1) {
          pLVar5 = pLVar18;
          pLVar18 = (LOGXFERF *)&pLVar18->grobj;
          ppcVar2 = ppcVar15;
          ppcVar15 = ppcVar15 + 1;
          pLVar5->id = (short)*ppcVar2;
        }
        fValidLxf = 1;
      }
      else {
        LogMakeValidXferf((LOGXFERF *)&lxf,(LOGXFERF *)&pbWp_2);
        fValidLxf = 0;
      }
    }
    else {
      rtwp.id = pfl->id;
      rtwp.iWaypt = 2;
      bVar10 = false;
      for (i = 0; i < 5; i = i + 1) {
        uVar8 = *(uint *)(pflNew->rgwtMin + i);
        puVar1 = (uint *)(((FLEET *)pfl)->rgwtMin + i);
        iVar11 = uVar8 - *puVar1;
        iVar14 = (*(uint *)((int)(pflNew->rgwtMin + i) + 2) -
                 *(uint *)((int)(((FLEET *)pfl)->rgwtMin + i) + 2)) - (uint)(uVar8 < *puVar1);
        (rtwp.order.txp.rgia + i * 2 + -4)->wFlags = iVar11;
        (rtwp.order.txp.rgia + i * 2 + -3)->wFlags = iVar14;
        if ((iVar11 != 0) || (iVar14 != 0)) {
          bVar10 = true;
        }
      }
      if (bVar10) {
        if (fValidLx == 0) {
          pRVar16 = &rtwp;
          pLVar19 = (LOGXFER *)&lx;
          for (iVar11 = 0xc; iVar11 != 0; iVar11 = iVar11 + -1) {
            pLVar6 = pLVar19;
            pLVar19 = (LOGXFER *)&pLVar19->grobj;
            pRVar3 = pRVar16;
            pRVar16 = (RTWAYPT *)&pRVar16->iWaypt;
            pLVar6->id = pRVar3->id;
          }
          fValidLx = 1;
        }
        else {
          LogMakeValidXfer((LOGXFER *)&lx,(LOGXFER *)&rtwp);
          fValidLx = 0;
        }
      }
      else {
        cbWp_2 = (short)((FLEET *)pfl)->iplan;
        if (cbWp_2 != (uint)pflNew->iplan) {
          sStack_24 = pflNew->id;
          rtwp.id = (short)pflNew->iplan;
          WriteMemRt(0x2a,4,&sStack_24);
        }
        if (((uint)((FLEET *)pfl)->wFlags >> 9 & 1) != ((uint)pflNew->wFlags >> 9 & 1)) {
          sStack_24 = pflNew->id;
          rtwp.id = (uint)pflNew->wFlags >> 9 & 1;
          WriteMemRt(10,4,&sStack_24);
        }
        iVar11 = pflNew->cord;
        iVar14 = ((FLEET *)pfl)->cord;
        iVar12 = iVar11 - iVar14;
        for (iordOld = 0; (iordOld < ((FLEET *)pfl)->cord && (iordOld < pflNew->cord));
            iordOld = iordOld + 1) {
          cbWp_2 = *(short *)((int)&pflNew->lpplord + 2);
          hdr.wFlags = *(int *)&pflNew->lpplord + 4;
          pbWp_2 = (char *)*(undefined2 *)((int)&((FLEET *)pfl)->lpplord + 2);
          sVar13 = __fmemcmp((void *)CONCAT22(pbWp_2,(void *)(*(int *)&((FLEET *)pfl)->
                                                                               lpplord + 4 +
                                                                     iordOld * 0x12)),
                                     (void *)CONCAT22(cbWp_2,(void *)(hdr.wFlags + iordOld * 0x12)),
                                     0x12);
          if (sVar13 != 0) break;
        }
        iordNew = iordOld;
        if ((iordOld != ((FLEET *)pfl)->cord) || (iVar11 != iVar14)) {
          if (iVar12 < 0) {
            sStack_24 = pflNew->id;
            rtwp.id = iordOld;
            if (iVar12 == -2) {
              rtwp.id = iordOld | 0x8000;
            }
            WriteMemRt(3,4,&sStack_24);
          }
          else if (iVar12 < 1) {
            cbWp_2 = 0x16;
            sVar13 = FGetPrevLogRt(&hdr,(byte *)rgbCur);
            if ((((sVar13 != 0) && ((uint)hdr.wFlags >> 10 == 5)) &&
                (rgbCur._0_2_ == pflNew->id)) && (rgbCur._2_2_ == iordNew)) {
              imemLogCur = imemLogPrev;
            }
            rtwp.iWaypt = pflNew->id;
            rtwp.order.pt.x = iordNew;
            uVar9 = *(undefined2 *)((int)&pflNew->lpplord + 2);
            psVar17 = (short *)(*(int *)&pflNew->lpplord + 4 + iordNew * 0x12);
            psVar20 = &rtwp.order.pt.y;
            for (iVar11 = 9; iVar11 != 0; iVar11 = iVar11 + -1) {
              psVar7 = psVar20;
              psVar20 = psVar20 + 1;
              psVar4 = psVar17;
              psVar17 = psVar17 + 1;
              *psVar7 = *psVar4;
            }
            pbWp_2 = (char *)&rtwp.iWaypt;
            sVar13 = cbWp_2;
            do {
              cbWp_2 = sVar13;
              if (cbWp_2 < 1) break;
              sVar13 = cbWp_2 + -1;
            } while (*(char *)((int)pbWp_2 + cbWp_2 + -1) == '\0');
            WriteMemRt(5,cbWp_2,&rtwp.iWaypt);
          }
          else {
            cbWp_2 = 0x16;
            rtwp.iWaypt = pflNew->id;
            rtwp.order.pt.x = iordOld;
            uVar9 = *(undefined2 *)((int)&pflNew->lpplord + 2);
            psVar17 = (short *)(*(int *)&pflNew->lpplord + 4 + iordOld * 0x12);
            psVar20 = &rtwp.order.pt.y;
            for (iVar11 = 9; iVar11 != 0; iVar11 = iVar11 + -1) {
              psVar7 = psVar20;
              psVar20 = psVar20 + 1;
              psVar4 = psVar17;
              psVar17 = psVar17 + 1;
              *psVar7 = *psVar4;
            }
            hdr.wFlags = (short)&rtwp.iWaypt;
            sVar13 = cbWp_2;
            do {
              cbWp_2 = sVar13;
              if (cbWp_2 < 1) break;
              sVar13 = cbWp_2 + -1;
            } while (*(char *)(hdr.wFlags + cbWp_2 + -1) == '\0');
            WriteMemRt(4,cbWp_2,&rtwp.iWaypt);
          }
        }
      }
    }
  }
  return;
}



// ======================================================================
// Function: LogChangeRelations
// Address: 1048:9340
// Segment: MEMORY_PLANET
// ======================================================================


void LogChangeRelations(void)

{
  short sVar1;
  HDR hdr;
  
  sVar1 = FGetPrevLogRt(&hdr,(byte *)rgbCur);
  if ((sVar1 != 0) && ((uint)hdr.wFlags >> 10 == 0x26)) {
    imemLogCur = imemLogPrev;
  }
  WriteMemRt(0x26,game.cPlayer,
             (void *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0));
  if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
    tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
    AdvanceTutor();
  }
  return;
}



// ======================================================================
// Function: LogChangeBtlplan
// Address: 1048:93d0
// Segment: MEMORY_PLANET
// ======================================================================


void LogChangeBtlplan(BTLPLAN *pbtlplan)

{
  WriteBattlePlan((BTLPLAN *)CONCAT22((undefined1 *)&DAT_1120_1120,pbtlplan),1);
  if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
    tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
    AdvanceTutor();
  }
  return;
}



// ======================================================================
// Function: LogChangePlanet
// Address: 1048:9420
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10489758) */

void LogChangePlanet(PLANET *ppl,PLANET *pplNew)

{
  uint *puVar1;
  LOGXFER *pLVar2;
  LOGXFER *pLVar3;
  bool bVar4;
  int iVar5;
  short sVar6;
  uint uVar7;
  int iVar8;
  undefined2 unaff_SI;
  LOGXFER *pLVar9;
  undefined2 unaff_DI;
  LOGXFER *pLVar10;
  ulong uVar11;
  long lVar12;
  ulong uVar13;
  ushort in_stack_0000ffd6;
  LOGXFER lxNew;
  HDR hdr;
  short fChg;
  short i;
  
  uVar13 = CONCAT22(unaff_SI,unaff_DI);
  bVar4 = false;
  if (((uint)gd._0_2_ >> 1 & 1) != 0) {
    return;
  }
  if (ppl == (PLANET *)0x0) {
    if (fValidLx == 0) {
      return;
    }
    lxNew.id = -1;
    lxNew.grobj = grobjOther;
    for (i = 0; i < 5; i = i + 1) {
      iVar5 = *(int *)((int)lx.rgdItem + i * 4);
      iVar8 = *(int *)((int)lx.rgdItem + 2 + i * 4);
      *(int *)(lxNew.rgdItem + i) = -iVar5;
      *(int *)((int)lxNew.rgdItem + i * 4 + 2) = -(iVar8 + (uint)(iVar5 != 0));
    }
  }
  else {
    lxNew.id = ppl->id;
    lxNew.grobj = grobjPlanet;
    for (i = 0; i < 4; i = i + 1) {
      uVar7 = *(uint *)(pplNew->rgwtMin + i);
      puVar1 = (uint *)(((PLANET *)ppl)->rgwtMin + i);
      iVar5 = uVar7 - *puVar1;
      iVar8 = (*(uint *)((int)(pplNew->rgwtMin + i) + 2) -
              *(uint *)((int)(((PLANET *)ppl)->rgwtMin + i) + 2)) - (uint)(uVar7 < *puVar1);
      *(int *)(lxNew.rgdItem + i) = iVar5;
      *(int *)((int)lxNew.rgdItem + i * 4 + 2) = iVar8;
      if ((iVar5 != 0) || (iVar8 != 0)) {
        bVar4 = true;
      }
    }
    lxNew.rgdItem[4]._0_2_ = 0;
    lxNew.rgdItem[4]._2_2_ = 0;
    if (!bVar4) goto LAB_1048_9573;
  }
  if (fValidLx == 0) {
    pLVar9 = &lxNew;
    pLVar10 = (LOGXFER *)&lx;
    for (iVar5 = 0xc; iVar5 != 0; iVar5 = iVar5 + -1) {
      pLVar3 = pLVar10;
      pLVar10 = (LOGXFER *)&pLVar10->grobj;
      pLVar2 = pLVar9;
      pLVar9 = (LOGXFER *)&pLVar9->grobj;
      pLVar3->id = pLVar2->id;
    }
    fValidLx = 1;
  }
  else {
    LogMakeValidXfer((LOGXFER *)&lx,&lxNew);
    fValidLx = 0;
  }
LAB_1048_9573:
  if (ppl != (PLANET *)0x0) {
    if (((*(int *)&pplNew->lpplprod == 0) && (*(int *)((int)&pplNew->lpplprod + 2) == 0)) &&
       ((*(int *)&((PLANET *)ppl)->lpplprod != 0 ||
        (*(int *)((int)&((PLANET *)ppl)->lpplprod + 2) != 0)))) {
      WriteMemRt(0x1d,2,&lxNew);
    }
    else if (((*(int *)&pplNew->lpplprod != 0) || (*(int *)((int)&pplNew->lpplprod + 2) != 0)) &&
            (((*(int *)&((PLANET *)ppl)->lpplprod == 0 &&
              (*(int *)((int)&((PLANET *)ppl)->lpplprod + 2) == 0)) ||
             ((((PLPROD *)((PLANET *)ppl)->lpplprod)->iprodMac !=
               ((PLPROD *)pplNew->lpplprod)->iprodMac ||
              (sVar6 = __fmemcmp((void *)CONCAT22(*(undefined2 *)
                                                           ((int)&((PLANET *)ppl)->lpplprod + 2),
                                                          (void *)(*(int *)&((PLANET *)ppl)->
                                                                            lpplprod + 4)),
                                         (void *)CONCAT22(*(undefined2 *)
                                                           ((int)&pplNew->lpplprod + 2),
                                                          (void *)(*(int *)&pplNew->lpplprod + 4)),
                                         (uint)((PLPROD *)((PLANET *)ppl)->lpplprod)->iprodMac << 2)
              , sVar6 != 0)))))) {
      sVar6 = FGetPrevLogRt(&hdr,(byte *)rgbCur);
      if ((sVar6 != 0) && (((uint)hdr.wFlags >> 10 == 0x1d && (rgbCur._0_2_ == ppl->id))))
      {
        imemLogCur = imemLogPrev;
      }
      rgbCur._0_2_ = ppl->id;
      __fmemmove(rgbCur + 2,
                         (void *)CONCAT22(*(undefined2 *)((int)&pplNew->lpplprod + 2),
                                          (void *)(*(int *)&pplNew->lpplprod + 4)),
                         (uint)((PLPROD *)pplNew->lpplprod)->iprodMac << 2);
      WriteMemRt(0x1d,(uint)((PLPROD *)pplNew->lpplprod)->iprodMac * 4 + 2,(char *)rgbCur)
      ;
    }
    uVar11 = __aFulshr(uVar13,in_stack_0000ffd6);
    uVar7 = (uint)uVar11 & 1;
    uVar11 = __aFulshr(uVar13,uVar7);
    if ((((uVar7 != ((uint)uVar11 & 1)) ||
         ((((PLANET *)ppl)->wFlags & 0x3ffU) != (pplNew->wFlags & 0x3ffU))) ||
        (((uint)((PLANET *)ppl)->wFlags >> 10 & 0xf) != ((uint)pplNew->wFlags >> 10 & 0xf))) ||
       ((((PLANET *)ppl)->wRouting & 0x3ffU) != (pplNew->wRouting & 0x3ffU))) {
      rgbCur._0_2_ = pplNew->id;
      rgbCur[2] = '\0';
      rgbCur[3] = '\0';
      rgbCur[4] = '\0';
      rgbCur[5] = '\0';
      __aFulshr(uVar13,uVar7);
      lVar12 = __aFlshl(uVar13,uVar7);
      rgbCur._2_2_ = rgbCur._2_2_ & 0xfffe | (uint)lVar12;
      rgbCur._4_2_ = rgbCur._4_2_ | (uint)((ulong)lVar12 >> 0x10);
      lVar12 = __aFlshl(uVar13,uVar7);
      rgbCur._2_2_ = rgbCur._2_2_ & 0xf801 | (uint)lVar12;
      rgbCur._4_2_ = rgbCur._4_2_ | (uint)((ulong)lVar12 >> 0x10);
      lVar12 = __aFlshl(uVar13,uVar7);
      rgbCur._2_2_ = rgbCur._2_2_ & 0x87ff | (uint)lVar12;
      rgbCur._4_2_ = rgbCur._4_2_ | (uint)((ulong)lVar12 >> 0x10);
      lVar12 = __aFlshl(uVar13,uVar7);
      rgbCur._2_2_ = rgbCur._2_2_ & 0x7fff | (uint)lVar12;
      rgbCur._4_2_ = rgbCur._4_2_ & 0xfe00 | (uint)((ulong)lVar12 >> 0x10);
      WriteMemRt(0x23,6,(char *)rgbCur);
    }
  }
  return;
}



// ======================================================================
// Function: LogChangeThing
// Address: 1048:9908
// Segment: MEMORY_PLANET
// ======================================================================


void LogChangeThing(THING *lpth,THING *pthNew)

{
  LOGXFER *pLVar1;
  LOGXFER *pLVar2;
  bool bVar3;
  int iVar4;
  LOGXFER *pLVar5;
  LOGXFER *pLVar6;
  LOGXFER lxNew;
  short fChg;
  short i;
  
  bVar3 = false;
  if (((uint)gd._0_2_ >> 1 & 1) == 0) {
    _memset(&lxNew,0,0x18);
    lxNew.id = pthNew->idFull;
    lxNew.grobj = grobjThing;
    for (i = 0; i < 3; i = i + 1) {
      iVar4 = *(int *)(pthNew->rgb + i * 2 + 2) - *(int *)(((THING *)lpth)->rgb + i * 2 + 2);
      *(int *)(lxNew.rgdItem + i) = iVar4;
      *(int *)((int)lxNew.rgdItem + i * 4 + 2) = iVar4 >> 0xf;
      if (iVar4 != 0) {
        bVar3 = true;
      }
    }
    if (bVar3) {
      if (fValidLx == 0) {
        pLVar5 = &lxNew;
        pLVar6 = (LOGXFER *)&lx;
        for (iVar4 = 0xc; iVar4 != 0; iVar4 = iVar4 + -1) {
          pLVar2 = pLVar6;
          pLVar6 = (LOGXFER *)&pLVar6->grobj;
          pLVar1 = pLVar5;
          pLVar5 = (LOGXFER *)&pLVar5->grobj;
          pLVar2->id = pLVar1->id;
        }
        fValidLx = 1;
      }
      else {
        LogMakeValidXfer((LOGXFER *)&lx,&lxNew);
        fValidLx = 0;
      }
    }
  }
  return;
}



// ======================================================================
// Function: LogMakeValidXfer
// Address: 1048:99f6
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Variable defined which should be unmapped: prt */
/* WARNING: Variable defined which should be unmapped: prtx */
/* WARNING: Variable defined which should be unmapped: prtl */
/* WARNING: Removing unreachable block (ram,0x10489e18) */
/* WARNING: Removing unreachable block (ram,0x10489d0a) */
/* WARNING: Removing unreachable block (ram,0x10489e97) */

void LogMakeValidXfer(LOGXFER *plx1,LOGXFER *plx2)

{
  uint *puVar1;
  int *piVar2;
  char cVar3;
  int iVar4;
  uint uVar5;
  undefined2 uVar6;
  uint uVar7;
  uint uVar8;
  undefined2 unaff_SS;
  long lVar9;
  long lVar10;
  short cb;
  long iBiggest;
  short grFlag;
  RTXFERX *prtx;
  short grbit;
  char rgbuf [28];
  short i;
  short rt;
  RTXFERL *prtl;
  short iOff;
  RTXFER *prt;
  long rgQuan [5];
  
  lVar10 = 0;
  grFlag = 1;
  rgQuan[0]._0_2_ = 0;
  rgQuan[0]._2_2_ = 0;
  rgQuan[1]._0_2_ = 0;
  rgQuan[1]._2_2_ = 0;
  rgQuan[2]._0_2_ = 0;
  rgQuan[2]._2_2_ = 0;
  rgQuan[3]._0_2_ = 0;
  rgQuan[3]._2_2_ = 0;
  rgQuan[4]._0_2_ = 0;
  rgQuan[4]._2_2_ = 0;
  uVar7 = (uint)hdrPrev.wFlags >> 10;
  if (((uVar7 == 1) || (uVar7 == 2)) || (uVar7 == 0x19)) {
    prt = (RTXFER *)
          CONCAT22(lpLog._2_2_,
                   (RTXFER *)
                   ((byte *)lpLog + (imemLogCur - (hdrPrev.wFlags & 0x3ffU))
                   ));
  }
  else {
    prt = (RTXFER *)0x0;
  }
  if (((((RTXFER *)prt != (RTXFER *)0x0) || (prt._2_2_ != 0)) &&
      ((((byte)((RTXFER *)prt)->field2_0x4 & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) ==
        (plx1->grobj & 0xff) &&
       (((int)(uint)(byte)((RTXFER *)prt)->field2_0x4 >> 4 == (plx2->grobj & 0xff) &&
        (prt->id1 == plx1->id)))))) && (((RTXFER *)prt)->id2 == plx2->id)) {
    uVar7 = (uint)((RTXFER *)prt)->grbitItems;
    iOff = 0;
    uVar8 = (uint)hdrPrev.wFlags >> 10;
    if (uVar8 == 1) {
      for (i = 0; i < 5; i = i + 1) {
        if ((1 << ((byte)i & 0x1f) & uVar7) != 0) {
          cVar3 = ((RTXFER *)prt)->rgcQuan[iOff];
          *(int *)(rgQuan + i) = (int)cVar3;
          *(int *)((int)rgQuan + i * 4 + 2) = (int)cVar3 >> 0xf;
          iOff = iOff + 1;
        }
      }
    }
    else if (uVar8 == 2) {
      for (i = 0; i < 5; i = i + 1) {
        if ((1 << ((byte)i & 0x1f) & uVar7) != 0) {
          iVar4 = *(int *)(((RTXFER *)prt)->rgcQuan + iOff * 2);
          *(int *)(rgQuan + i) = iVar4;
          *(int *)((int)rgQuan + i * 4 + 2) = iVar4 >> 0xf;
          iOff = iOff + 1;
        }
      }
    }
    else if (uVar8 == 0x19) {
      for (i = 0; i < 5; i = i + 1) {
        if ((1 << ((byte)i & 0x1f) & uVar7) != 0) {
          uVar6 = *(undefined2 *)(((RTXFER *)prt)->rgcQuan + iOff * 4 + 2);
          *(undefined2 *)(rgQuan + i) = *(undefined2 *)(((RTXFER *)prt)->rgcQuan + iOff * 4);
          *(undefined2 *)((int)rgQuan + i * 4 + 2) = uVar6;
          iOff = iOff + 1;
        }
      }
    }
    CancelMemRt((uint)hdrPrev.wFlags >> 10);
  }
  grbit = 0;
  for (i = 0; i < 5; i = i + 1) {
    uVar8 = *(uint *)(plx1->rgdItem + i);
    uVar5 = *(uint *)((int)(plx1->rgdItem + i) + 2);
    puVar1 = (uint *)(rgQuan + i);
    uVar7 = *puVar1;
    *puVar1 = *puVar1 + uVar8;
    piVar2 = (int *)((int)rgQuan + i * 4 + 2);
    *piVar2 = *piVar2 + uVar5 + (uint)CARRY2(uVar7,uVar8);
    lVar9 = _labs(CONCAT22(*(undefined2 *)((int)rgQuan + i * 4 + 2),(int)rgQuan[i]));
    if (lVar10 <= lVar9) {
      lVar10 = _labs(CONCAT22(*(undefined2 *)((int)rgQuan + i * 4 + 2),(int)rgQuan[i]));
    }
    if (((int)rgQuan[i] != 0) || (*(int *)((int)rgQuan + i * 4 + 2) != 0)) {
      grbit = grbit | grFlag;
    }
    grFlag = grFlag << 1;
  }
  if (grbit != 0) {
    prt = (RTXFER *)CONCAT22(unaff_SS,(RTXFER *)rgbuf);
    rgbuf[4] = (byte)plx1->grobj & 0xf |
               (byte)((plx2->grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 4);
    prt->id1 = plx1->id;
    rgbuf._2_2_ = plx2->id;
    rgbuf[5] = (char)grbit;
    cb = 6;
    iOff = 0;
    if (lVar10 < 0x80) {
      rt = 1;
      for (i = 0; i < 5; i = i + 1) {
        if (((int)rgQuan[i] != 0) || (*(int *)((int)rgQuan + i * 4 + 2) != 0)) {
          rgbuf[iOff + 6] = (char)(int)rgQuan[i];
          cb = cb + 1;
          iOff = iOff + 1;
        }
      }
    }
    else if (lVar10 < 0x8000) {
      rt = 2;
      for (i = 0; i < 5; i = i + 1) {
        if (((int)rgQuan[i] != 0) || (*(int *)((int)rgQuan + i * 4 + 2) != 0)) {
          *(int *)(rgbuf + iOff * 2 + 6) = (int)rgQuan[i];
          cb = cb + 2;
          iOff = iOff + 1;
        }
      }
    }
    else {
      rt = 0x19;
      for (i = 0; i < 5; i = i + 1) {
        if (((int)rgQuan[i] != 0) || (*(int *)((int)rgQuan + i * 4 + 2) != 0)) {
          uVar6 = *(undefined2 *)((int)rgQuan + i * 4 + 2);
          *(int *)(rgbuf + iOff * 4 + 6) = (int)rgQuan[i];
          *(undefined2 *)(rgbuf + iOff * 4 + 8) = uVar6;
          cb = cb + 4;
          iOff = iOff + 1;
        }
      }
    }
    WriteMemRt(rt,cb,rgbuf);
  }
  return;
}



// ======================================================================
// Function: LogMakeValidXferf
// Address: 1048:9fa6
// Segment: MEMORY_PLANET
// ======================================================================


void LogMakeValidXferf(LOGXFERF *plxf1,LOGXFERF *plxf2)

{
  short cb;
  short grFlag;
  ushort grbit;
  char rgbuf [41];
  short i;
  short iOff;
  RTXFERF *prt;
  
  grbit = 0;
  grFlag = 1;
  for (i = 0; i < 0x10; i = i + 1) {
    if (plxf1->rgdItem[i] != 0) {
      grbit = grbit | grFlag;
    }
    grFlag = grFlag << 1;
  }
  if (grbit != 0) {
    rgbuf[4] = (byte)plxf1->grobj & 0xf |
               (byte)((plxf2->grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 4);
    rgbuf._0_2_ = plxf1->id;
    rgbuf._2_2_ = plxf2->id;
    rgbuf[5] = (undefined1)grbit;
    rgbuf[6] = grbit._1_1_;
    cb = 7;
    iOff = 0;
    for (i = 0; i < 0x10; i = i + 1) {
      if (plxf1->rgdItem[i] != 0) {
        *(short *)(rgbuf + iOff * 2 + 7) = plxf1->rgdItem[i];
        cb = cb + 2;
        iOff = iOff + 1;
      }
    }
    WriteMemRt(0x17,cb,rgbuf);
  }
  return;
}



// ======================================================================
// Function: CancelMemRt
// Address: 1048:a108
// Segment: MEMORY_PLANET
// ======================================================================


void CancelMemRt(short rt)

{
  imemLogCur = imemLogCur - ((hdrPrev.wFlags & 0x3ffU) + 2);
  hdrPrev.wFlags = hdrPrev.wFlags & 0x3ff;
  return;
}



// ======================================================================
// Function: WriteMemRt
// Address: 1048:a130
// Segment: MEMORY_PLANET
// ======================================================================


void WriteMemRt(short rt,short cb,void *rg)

{
  byte *pbVar1;
  undefined2 uVar2;
  char *sz;
  HDR HVar3;
  short mbType;
  byte *lpv;
  HDR hdr;
  
  HVar3.wFlags = hdrPrev.wFlags;
  if (fLogOff == 0) {
    if (32000 < imemLogCur + cb + 2) {
      mbType = 0x10;
      sz = PszFormatIds(idsLogFileHasReachedMaximumAllowableSize,(short *)0x0);
      AlertSz(sz,mbType);
    }
    DirtyGame(1);
    uVar2 = lpLog._2_2_;
    imemLogPrev = imemLogCur;
    HVar3.wFlags = cb & 0x3ffU | rt << 10;
    pbVar1 = (byte *)lpLog + imemLogCur;
    lpv = (byte *)CONCAT22(lpLog._2_2_,pbVar1);
    *(short *)lpv = HVar3.wFlags;
    if (0 < cb) {
      __fmemcpy((byte *)CONCAT22(uVar2,pbVar1 + 2),
                        (void *)CONCAT22((undefined1 *)&DAT_1120_1120,rg),cb);
    }
    imemLogCur = imemLogCur + cb + 2;
    if (rt == 0) {
      HVar3.wFlags = hdrPrev.wFlags;
    }
  }
  hdrPrev.wFlags = HVar3.wFlags;
  return;
}



// ======================================================================
// Function: DirtyGame
// Address: 1048:a228
// Segment: MEMORY_PLANET
// ======================================================================


void DirtyGame(short fDirty)

{
  if ((fDirty != game.fDirty) && (game.fDirty = fDirty, fAi == 0)) {
    SetMsgTitle(hwndMessage);
  }
  return;
}



// ======================================================================
// Function: FGetPrevLogRt
// Address: 1048:a25e
// Segment: MEMORY_PLANET
// ======================================================================


short FGetPrevLogRt(HDR *phdr,byte *pb)

{
  undefined2 uVar1;
  short sVar2;
  byte *pbVar3;
  byte *lpv;
  
  uVar1 = lpLog._2_2_;
  if (imemLogPrev == -1) {
    sVar2 = 0;
  }
  else {
    pbVar3 = (byte *)lpLog + imemLogPrev;
    lpv = (byte *)CONCAT22(lpLog._2_2_,pbVar3);
    phdr->wFlags = *(short *)lpv;
    if ((phdr->wFlags & 0x3ffU) != 0) {
      __fmemcpy((byte *)CONCAT22((undefined1 *)&DAT_1120_1120,pb),
                        (byte *)CONCAT22(uVar1,pbVar3 + 2),phdr->wFlags & 0x3ff);
    }
    sVar2 = 1;
  }
  return sVar2;
}



// ======================================================================
// Function: FRunLogFile
// Address: 1048:a2d6
// Segment: MEMORY_PLANET
// ======================================================================


short FRunLogFile(void)

{
  short sVar1;
  uint uVar2;
  HDR *lprts;
  short iCur;
  short fRet;
  short fLogOld;
  
  sVar1 = fLogOff;
  iCur = 0;
  fRet = 1;
  if (imemLogCur == 0) {
    fRet = 1;
  }
  else {
    fLogOff = 1;
    for (; iCur < imemLogCur; iCur = iCur + (lprts->wFlags & 0x3ffU) + 2) {
      lprts = (HDR *)CONCAT22(lpLog._2_2_,(HDR *)((byte *)lpLog + iCur));
      uVar2 = FRunLogRecord((uint)lprts->wFlags >> 10,lprts->wFlags & 0x3ff,
                            (byte *)CONCAT22(lpLog._2_2_,(byte *)lpLog + iCur + 2));
      fRet = fRet & uVar2;
    }
    gd._4_2_ = gd._4_2_ & 0xfbff;
  }
  fLogOff = sVar1;
  return fRet;
}



// ======================================================================
// Function: FRunLogRecord
// Address: 1048:a38c
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1048bb20) */
/* WARNING: Removing unreachable block (ram,0x1048af75) */
/* WARNING: Removing unreachable block (ram,0x1048af96) */
/* WARNING: Removing unreachable block (ram,0x1048bb41) */
/* WARNING: Variable defined which should be unmapped: cOut */
/* WARNING: Type propagation algorithm not settling */

short FRunLogRecord(short rt,short cb,byte *lpb)

{
  uint *puVar1;
  char *pcVar2;
  int *piVar3;
  byte *pbVar4;
  byte bVar5;
  undefined2 uVar6;
  PLANET *pPVar7;
  XFERFULL *pXVar8;
  FLEET *pFVar9;
  short sVar10;
  ushort uVar11;
  uint uVar12;
  uint uVar13;
  int iVar14;
  uint uVar15;
  undefined2 *puVar16;
  undefined2 *puVar17;
  SHDEF *pSVar18;
  int iVar19;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar20;
  undefined2 unaff_SS;
  bool bVar21;
  PL *pPVar22;
  FLEET *pFVar23;
  void *pvVar24;
  THING *pTVar25;
  PLANET *pPVar26;
  long lVar27;
  ulong uVar28;
  ulong uVar29;
  HeapType HVar30;
  short cOut;
  char acStack_564 [26];
  uint uStack_54a;
  COLDROP *pCStack_548;
  PLANET *pPStack_546;
  short id_2;
  long l;
  char ch;
  PLANET *lpplMac;
  short iLook;
  short iPass;
  SHDEF *lpshdef;
  short rgifl [512];
  ushort grbit;
  short i;
  short ifl;
  FLEET *lpfl;
  XFER rgxf [2];
  long rgcXfer [5];
  PLANET *lppl;
  XFERFULL *lpxfCur;
  long cXfer;
  short fExtra;
  
  uVar29 = CONCAT22(unaff_SI,unaff_DI);
  lpxfCur = (XFERFULL *)0x0;
  switch(rt) {
  case 0:
    break;
  case 1:
  case 2:
  case 0x19:
    sVar10 = FLookupObject(((byte *)lpb)[4] & (grobjThing|grobjOther|grobjFleet|grobjPlanet),
                                 *(short *)lpb,&rgxf[0].fl);
    if (sVar10 == 0) {
      return 0;
    }
    rgxf[1].fl.id = -1;
    if (((int)(uint)((byte *)lpb)[4] >> 4 == 4) ||
       (sVar10 = FLookupObject((int)(uint)((byte *)lpb)[4] >> 4,*(short *)((byte *)lpb + 2),
                                     &rgxf[1].fl), sVar10 != 0)) {
      lVar27 = CONCAT22(l._2_2_,(undefined2)l);
      grbit = (ushort)((byte *)lpb)[5];
      iLook = 0;
      for (i = 0; i < 5; i = i + 1) {
        if ((grbit & 1) == 0) {
          *(undefined2 *)(rgcXfer + i) = 0;
          *(undefined2 *)((int)rgcXfer + i * 4 + 2) = 0;
        }
        else {
          if (rt == 1) {
            bVar5 = ((byte *)lpb)[iLook + 6];
            *(int *)(rgcXfer + i) = (int)(char)bVar5;
            *(int *)((int)rgcXfer + i * 4 + 2) = (int)(char)bVar5 >> 0xf;
          }
          else if (rt == 2) {
            iVar14 = *(int *)((byte *)lpb + iLook * 2 + 6);
            *(int *)(rgcXfer + i) = iVar14;
            *(int *)((int)rgcXfer + i * 4 + 2) = iVar14 >> 0xf;
          }
          else {
            uVar20 = *(undefined2 *)((byte *)lpb + iLook * 4 + 6 + 2);
            *(undefined2 *)(rgcXfer + i) = *(undefined2 *)((byte *)lpb + iLook * 4 + 6);
            *(undefined2 *)((int)rgcXfer + i * 4 + 2) = uVar20;
          }
          iLook = iLook + 1;
        }
        grbit = grbit >> 1;
      }
      for (iPass = 0; iPass < 2; iPass = iPass + 1) {
        for (i = 0; i < 5; i = i + 1) {
          if (((int)rgcXfer[i] != 0) || (*(int *)((int)rgcXfer + i * 4 + 2) != 0)) {
            cXfer._0_2_ = *(uint *)(rgcXfer + i);
            cXfer._2_2_ = *(uint *)((int)rgcXfer + i * 4 + 2);
            if (((iPass == 0) && ((int)cXfer._2_2_ < 0)) ||
               ((iPass == 1 && (-1 < (int)cXfer._2_2_)))) {
              l = lVar27;
              lVar27 = ChgCargo(((byte *)lpb)[4] &
                                      (grobjThing|grobjOther|grobjFleet|grobjPlanet),*(short *)lpb,i
                                      ,CONCAT22(cXfer._2_2_,(uint)cXfer),&rgxf[0].fl);
              if (lVar27 != CONCAT22(cXfer._2_2_,(uint)cXfer)) {
                if ((((byte *)lpb)[4] & 0xf) == 2) {
                  uVar13 = 0x8000;
                }
                else {
                  uVar13 = 0;
                }
                id_2 = uVar13 | rgxf[0].fl.id;
                l = lVar27;
                FSendPlrMsg(rgxf[0].fl.iPlayer,idmUnableTransferKtKtRequest,id_2,id_2,
                                 (uint)cXfer - (int)lVar27,i,(uint)cXfer,0,0,0);
                *(undefined2 *)(rgcXfer + i) = (undefined2)l;
                *(undefined2 *)((int)rgcXfer + i * 4 + 2) = l._2_2_;
                lVar27 = l;
              }
            }
            pXVar8 = lpcd._2_2_;
            if ((((iPass == 0) && ((0 < (int)cXfer._2_2_ || (-1 < (int)cXfer._2_2_)))) ||
                ((iPass == 1 && (((int)cXfer._2_2_ < 1 && ((int)cXfer._2_2_ < 0)))))) &&
               ((int)(uint)((byte *)lpb)[4] >> 4 != 4)) {
              if (((i == 3) &&
                  (((((uint)cXfer != 0 || (cXfer._2_2_ != 0)) &&
                    (((uint)gd._0_2_ >> 1 & 1) != 0)) &&
                   (((int)(uint)((byte *)lpb)[4] >> 4 == 1 && ((((byte *)lpb)[4] & 0xf) == 2))))))
                 && (rgxf[0].fl.iPlayer != rgxf[1].fl.iPlayer)) {
                pCStack_548 = (COLDROP *)lpcd;
                pPStack_546 = (PLANET *)lpcd._2_2_;
                id_2 = 0;
                if (((int)cXfer._2_2_ < 0) || (((int)cXfer._2_2_ < 1 && ((uint)cXfer == 0)))) {
                  for (; (id_2 < cColDrop &&
                         ((((COLDROP *)CONCAT22(lpcd._2_2_,pCStack_548))->idFleetSrc !=
                           rgxf[0].fl.id || (pCStack_548->idPlanetDst != rgxf[1].fl.id))));
                      pCStack_548 = pCStack_548 + 1) {
                    id_2 = id_2 + 1;
                  }
                  if (id_2 == cColDrop) {
                    ((COLDROP *)CONCAT22(lpcd._2_2_,pCStack_548))->idFleetSrc = rgxf[0].fl.id
                    ;
                    pCStack_548->idPlr = rgxf[0].fl.iPlayer;
                    pCStack_548->idPlanetDst = rgxf[1].fl.id;
                    *(undefined2 *)&pCStack_548->cColonist = 0;
                    *(undefined2 *)((int)&pCStack_548->cColonist + 2) = 0;
                    uStack_54a = (uint)(rgxf[1].fl.iPlayer != -1);
                    pCStack_548->wFlags = pCStack_548->wFlags & 0xfffeU | uStack_54a;
                    cColDrop = cColDrop + 1;
                  }
                  puVar1 = (uint *)&pCStack_548->cColonist;
                  uVar13 = *puVar1;
                  *puVar1 = *puVar1 - (uint)cXfer;
                  piVar3 = (int *)((int)&pCStack_548->cColonist + 2);
                  *piVar3 = (*piVar3 - cXfer._2_2_) - (uint)(uVar13 < (uint)cXfer);
                }
                else {
                  while (((id_2 < cColDrop && (-1 < (int)cXfer._2_2_)) &&
                         ((0 < (int)cXfer._2_2_ || ((uint)cXfer != 0))))) {
                    if ((pCStack_548->idPlanetDst == rgxf[1].fl.id) &&
                       (pCStack_548->idPlr == rgxf[0].fl.iPlayer)) {
                      iVar14 = *(int *)((int)&pCStack_548->cColonist + 2);
                      if ((iVar14 < (int)cXfer._2_2_) ||
                         ((uVar13 = (uint)cXfer, uVar12 = cXfer._2_2_, iVar14 <= (int)cXfer._2_2_ &&
                          (*(uint *)&pCStack_548->cColonist <= (uint)cXfer)))) {
                        uVar13 = *(uint *)&pCStack_548->cColonist;
                        uVar12 = *(uint *)((int)&pCStack_548->cColonist + 2);
                      }
                      lVar27 = CONCAT22(uVar12,uVar13);
                      bVar21 = (uint)cXfer < uVar13;
                      cXfer._0_2_ = (uint)cXfer - uVar13;
                      cXfer._2_2_ = (cXfer._2_2_ - uVar12) - (uint)bVar21;
                      puVar1 = (uint *)&pCStack_548->cColonist;
                      uVar15 = *puVar1;
                      *puVar1 = *puVar1 - uVar13;
                      piVar3 = (int *)((int)&pCStack_548->cColonist + 2);
                      *piVar3 = (*piVar3 - uVar12) - (uint)(uVar15 < uVar13);
                    }
                    pCStack_548 = pCStack_548 + 1;
                    id_2 = id_2 + 1;
                  }
                }
              }
              else if ((((uint)cXfer == 0) && (cXfer._2_2_ == 0)) ||
                      ((((uint)gd._0_2_ >> 1 & 1) == 0 ||
                       ((rgxf[1].fl.iPlayer == rgxf[0].fl.iPlayer ||
                        ((int)(uint)((byte *)lpb)[4] >> 4 == 8)))))) {
PLANET_StealCargo:
                l = lVar27;
                lVar27 = ChgCargo((int)(uint)((byte *)lpb)[4] >> 4,*(short *)((byte *)lpb + 2)
                                        ,i,CONCAT22(-(cXfer._2_2_ + ((uint)cXfer != 0)),-(uint)cXfer
                                                   ),&rgxf[1].fl);
                iVar14 = (int)lVar27;
                if (lVar27 != CONCAT22(-(cXfer._2_2_ + ((uint)cXfer != 0)),-(uint)cXfer)) {
                  *(int *)(rgcXfer + i) = -iVar14;
                  *(int *)((int)rgcXfer + i * 4 + 2) =
                       -((int)((ulong)lVar27 >> 0x10) + (uint)(iVar14 != 0));
                  l = lVar27;
                  if ((int)(uint)((byte *)lpb)[4] >> 4 == 8) {
                    id_2 = 0xdb;
                    if (lVar27 == 0) {
                      id_2 = 0xdc;
                    }
                    FSendPlrMsg(rgxf[0].fl.iPlayer,id_2,rgxf[0].fl.id | 0x8000,rgxf[0].fl.id,i,
                                     -iVar14,i,0,0,0);
                    lVar27 = l;
                  }
                  else {
                    if ((((byte *)lpb)[4] & 0xf) == 2) {
                      uVar13 = 0x8000;
                    }
                    else {
                      uVar13 = 0;
                    }
                    id_2 = uVar13 | rgxf[0].fl.id;
                    FSendPlrMsg(rgxf[0].fl.iPlayer,idmUnableTransferKtKtRequest,id_2,id_2,
                                     -(uint)cXfer - iVar14,i,-(uint)cXfer,0,0,0);
                    lVar27 = l;
                  }
                }
              }
              else {
                pPStack_546 = (PLANET *)((XFERFULL *)lpxf + cXferFull);
                id_2 = lpxf._2_2_;
                if (((int)cXfer._2_2_ < 0) || (((int)cXfer._2_2_ < 1 && ((uint)cXfer == 0)))) {
                  if (iPass == 1) goto PLANET_StealCargo;
                  if (((XFERFULL *)lpxfCur == (XFERFULL *)0x0) && (lpxfCur._2_2_ == 0)) {
                    lpxfCur = (XFERFULL *)CONCAT22(lpxf._2_2_,(XFERFULL *)lpxf);
                    l = lVar27;
                    while( true ) {
                      if (pPStack_546 <= (XFERFULL *)lpxfCur) break;
                      sVar10 = __fmemcmp(lpxfCur,lpb,5);
                      if (sVar10 == 0) break;
                      lpxfCur = (XFERFULL *)CONCAT22(lpxfCur._2_2_,(XFERFULL *)lpxfCur + 1);
                    }
                    lVar27 = l;
                    if (((PLANET *)(XFERFULL *)lpxfCur == pPStack_546) && (lpxfCur._2_2_ == id_2)) {
                      cXferFull = cXferFull + 1;
                      __fmemset(lpxfCur,0,0x19);
                      sVar10 = *(short *)((byte *)lpb + 2);
                      lpxfCur->id1 = *(short *)lpb;
                      ((XFERFULL *)lpxfCur)->id2 = sVar10;
                      lVar27 = l;
                    }
                  }
                  puVar1 = (uint *)(((XFERFULL *)lpxfCur)->rgcQuan + i);
                  uVar13 = *puVar1;
                  *puVar1 = *puVar1 - (uint)cXfer;
                  puVar1 = (uint *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                  *puVar1 = (*puVar1 - cXfer._2_2_) - (uint)(uVar13 < (uint)cXfer);
                }
                else {
                  lpxfCur = (XFERFULL *)CONCAT22(lpxf._2_2_,(XFERFULL *)lpxf);
                  while ((((XFERFULL *)lpxfCur < pPStack_546 && (-1 < (int)cXfer._2_2_)) &&
                         ((0 < (int)cXfer._2_2_ || ((uint)cXfer != 0))))) {
                    uVar20 = (undefined2)((ulong)lpxfCur >> 0x10);
                    pCStack_548 = (COLDROP *)
                                  ((int)(uint)(byte)((XFERFULL *)lpxfCur)->field2_0x4 >> 4);
                    if ((((pCStack_548 == (COLDROP *)((int)(uint)((byte *)lpb)[4] >> 4)) &&
                         (((XFERFULL *)lpxfCur)->id2 == *(int *)((byte *)lpb + 2))) &&
                        ((((XFERFULL *)lpxfCur)->field2_0x4 & 0xf) == 2)) &&
                       ((lpxfCur->id1 & 0xfe00U) == (*(uint *)lpb & 0xfe00))) {
                      uVar13 = *(uint *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                      if (((int)uVar13 < (int)cXfer._2_2_) ||
                         ((uVar12 = (uint)cXfer, uVar15 = cXfer._2_2_,
                          (int)uVar13 <= (int)cXfer._2_2_ &&
                          (*(uint *)(((XFERFULL *)lpxfCur)->rgcQuan + i) <= (uint)cXfer)))) {
                        uVar12 = *(uint *)(((XFERFULL *)lpxfCur)->rgcQuan + i);
                        uVar15 = *(uint *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                      }
                      lVar27 = CONCAT22(uVar15,uVar12);
                      bVar21 = (uint)cXfer < uVar12;
                      cXfer._0_2_ = (uint)cXfer - uVar12;
                      cXfer._2_2_ = (cXfer._2_2_ - uVar15) - (uint)bVar21;
                      puVar1 = (uint *)(((XFERFULL *)lpxfCur)->rgcQuan + i);
                      uVar13 = *puVar1;
                      *puVar1 = *puVar1 - uVar12;
                      puVar1 = (uint *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                      *puVar1 = (*puVar1 - uVar15) - (uint)(uVar13 < uVar12);
                    }
                    lpxfCur = (XFERFULL *)CONCAT22(uVar20,(XFERFULL *)lpxfCur + 1);
                  }
                  lpxfCur = (XFERFULL *)0x0;
                  if ((-1 < (int)cXfer._2_2_) && ((0 < (int)cXfer._2_2_ || ((uint)cXfer != 0))))
                  goto PLANET_StealCargo;
                }
              }
            }
          }
        }
      }
      l = lVar27;
      if ((((byte *)lpb)[4] & 0xf) == 2) {
        FLookupFleet(-1,&rgxf[0].fl);
      }
      else {
        FLookupPlanet(-1,(PLANET *)&rgxf[0].fl);
      }
      if ((int)(uint)((byte *)lpb)[4] >> 4 == 2) {
        FLookupFleet(-1,&rgxf[1].fl);
      }
      else if (((int)(uint)((byte *)lpb)[4] >> 4 == 1) || ((int)(uint)((byte *)lpb)[4] >> 4 == 4)) {
        FLookupPlanet(-1,(PLANET *)&rgxf[1].fl);
      }
      else if ((int)(uint)((byte *)lpb)[4] >> 4 == 8) {
        FLookupThing(-1,(THING *)&rgxf[1].fl);
      }
    }
    else if (((int)(uint)((byte *)lpb)[4] >> 4 != 2) ||
            ((*(uint *)((byte *)lpb + 2) >> 9 & 0xf) == idPlayer)) {
      return 0;
    }
    break;
  case 3:
    pFVar23 = LpflFromId(*(short *)lpb);
    uVar20 = (undefined2)((ulong)pFVar23 >> 0x10);
    pFVar9 = (FLEET *)pFVar23;
    if (((pFVar23 == (FLEET *)0x0) || (pFVar9->cord < 1)) ||
       (iLook = *(uint *)((byte *)lpb + 2) & 0x7fff, pFVar9->cord <= iLook)) {
      return 0;
    }
    bVar21 = (*(uint *)((byte *)lpb + 2) & 0x8000) != 0;
    uVar13 = (uint)bVar21;
    if ((uVar13 != 0) && (pFVar9->cord <= (int)(iLook + 1U))) {
      return 0;
    }
    id_2 = *(short *)((int)&pFVar9->lpplord + 2);
    pPStack_546 = (PLANET *)(*(int *)&pFVar9->lpplord + 4);
    pCStack_548 = (COLDROP *)*(undefined2 *)((int)&pFVar9->lpplord + 2);
    uStack_54a = *(int *)&pFVar9->lpplord + 4;
    __fmemmove((void *)CONCAT22(pCStack_548,(void *)(uStack_54a + iLook * 0x12)),
                       (void *)CONCAT22(id_2,(void *)((int)pPStack_546 + (iLook + uVar13 + 1) * 0x12
                                                     )),
                       (((pFVar9->cord - iLook) - uVar13) + -1) * 0x12);
    pFVar9->cord = pFVar9->cord - (uVar13 + 1);
    pbVar4 = &((PLORD *)pFVar9->lpplord)->iordMac;
    *pbVar4 = *pbVar4 - (bVar21 + '\x01');
    break;
  case 4:
    pFVar23 = LpflFromId(*(short *)lpb);
    uVar20 = (undefined2)((ulong)pFVar23 >> 0x10);
    pFVar9 = (FLEET *)pFVar23;
    if (((pFVar23 == (FLEET *)0x0) || (*(int *)((byte *)lpb + 2) < 0)) ||
       (pFVar9->cord < *(int *)((byte *)lpb + 2))) {
      return 0;
    }
    if (pFVar9->cord == (uint)((PLORD *)pFVar9->lpplord)->iordMax) {
      pPVar22 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&pFVar9->lpplord + 2),
                                                   *(PL **)&pFVar9->lpplord),pFVar9->cord + 3);
      *(PL **)&pFVar9->lpplord = (PL *)pPVar22;
      *(undefined2 *)((int)&pFVar9->lpplord + 2) = (int)((ulong)pPVar22 >> 0x10);
    }
    id_2 = *(short *)((int)&pFVar9->lpplord + 2);
    pPStack_546 = (PLANET *)(*(int *)&pFVar9->lpplord + 4);
    pCStack_548 = (COLDROP *)*(undefined2 *)((int)&pFVar9->lpplord + 2);
    uStack_54a = *(int *)&pFVar9->lpplord + 4;
    __fmemmove((void *)CONCAT22(pCStack_548,
                                        (void *)(uStack_54a + (*(int *)((byte *)lpb + 2) + 1) * 0x12
                                                )),
                       (void *)CONCAT22(id_2,(void *)((int)pPStack_546 +
                                                     *(int *)((byte *)lpb + 2) * 0x12)),
                       (pFVar9->cord - *(int *)((byte *)lpb + 2)) * 0x12);
    if ((uint)cb < 0x16) {
      id_2 = *(short *)((int)&pFVar9->lpplord + 2);
      pPStack_546 = (PLANET *)(*(int *)&pFVar9->lpplord + 4);
      __fmemset((void *)CONCAT22(id_2,(void *)((int)pPStack_546 +
                                                      *(int *)((byte *)lpb + 2) * 0x12)),0,0x12);
    }
    id_2 = *(short *)((int)&pFVar9->lpplord + 2);
    pPStack_546 = (PLANET *)(*(int *)&pFVar9->lpplord + 4);
    __fmemmove((void *)CONCAT22(id_2,(void *)((int)pPStack_546 +
                                                     *(int *)((byte *)lpb + 2) * 0x12)),
                       (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 4),cb - 4);
    *(uint *)(*(int *)&pFVar9->lpplord + *(int *)((byte *)lpb + 2) * 0x12 + 10) =
         *(uint *)(*(int *)&pFVar9->lpplord + *(int *)((byte *)lpb + 2) * 0x12 + 10) & 0xdfff;
    pFVar9->cord = pFVar9->cord + 1;
    pbVar4 = &((PLORD *)pFVar9->lpplord)->iordMac;
    *pbVar4 = *pbVar4 + 1;
    break;
  case 5:
    pFVar23 = LpflFromId(*(short *)lpb);
    uVar20 = (undefined2)((ulong)pFVar23 >> 0x10);
    pFVar9 = (FLEET *)pFVar23;
    if (((pFVar23 == (FLEET *)0x0) || (pFVar9->cord < 0)) ||
       (iLook = *(short *)((byte *)lpb + 2), pFVar9->cord <= iLook)) {
      return 0;
    }
    if ((uint)cb < 0x16) {
      id_2 = *(short *)((int)&pFVar9->lpplord + 2);
      pPStack_546 = (PLANET *)(*(int *)&pFVar9->lpplord + 4);
      __fmemset((void *)CONCAT22(id_2,(void *)((int)pPStack_546 + iLook * 0x12)),0,0x12);
    }
    id_2 = *(short *)((int)&pFVar9->lpplord + 2);
    pPStack_546 = (PLANET *)(*(int *)&pFVar9->lpplord + 4);
    __fmemmove((void *)CONCAT22(id_2,(void *)((int)pPStack_546 + iLook * 0x12)),
                       (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 4),cb - 4);
    *(uint *)(*(int *)&pFVar9->lpplord + iLook * 0x12 + 10) =
         *(uint *)(*(int *)&pFVar9->lpplord + iLook * 0x12 + 10) & 0xdfff;
    break;
  default:
    break;
  case 10:
  case 0xb:
    pFVar23 = LpflFromId(*(short *)lpb);
    uVar20 = (undefined2)((ulong)pFVar23 >> 0x10);
    pFVar9 = (FLEET *)pFVar23;
    if (pFVar23 == (FLEET *)0x0) {
      return 0;
    }
    if (rt == 10) {
      pFVar9->wFlags = pFVar9->wFlags & 0xfdffU | (*(uint *)((byte *)lpb + 2) & 1) << 9;
    }
    else {
      if (pFVar9->cord <= *(int *)((byte *)lpb + 2)) {
        return 0;
      }
      if (9 < *(int *)((byte *)lpb + 4)) {
        return 0;
      }
      *(uint *)(*(int *)&pFVar9->lpplord + *(int *)((byte *)lpb + 2) * 0x12 + 10) =
           *(uint *)(*(int *)&pFVar9->lpplord + *(int *)((byte *)lpb + 2) * 0x12 + 10) & 0xfff0 |
           *(uint *)((byte *)lpb + 4) & 0xf;
    }
    break;
  case 0x17:
    sVar10 = FLookupObject(grobjFleet,*(short *)lpb,&rgxf[0].fl);
    if (sVar10 == 0) {
      return 0;
    }
    sVar10 = FLookupObject(grobjFleet,*(short *)((byte *)lpb + 2),&rgxf[1].fl);
    if (sVar10 == 0) {
      return 0;
    }
    if (rgxf[1].fl.iPlayer != rgxf[0].fl.iPlayer) {
      return 0;
    }
    for (iPass = 0; iPass < 2; iPass = iPass + 1) {
      grbit = *(ushort *)((byte *)lpb + 5);
      iLook = 0;
      for (i = 0; i < 0x10; i = i + 1) {
        if ((grbit & 1) != 0) {
          cXfer._0_2_ = *(uint *)((byte *)lpb + iLook * 2 + 7);
          cXfer._2_2_ = (int)(uint)cXfer >> 0xf;
          if (((iPass == 0) && ((int)cXfer._2_2_ < 0)) || ((iPass == 1 && (-1 < (int)cXfer._2_2_))))
          {
            uVar13 = rgxf[0].fl.rgcsh[i];
            iVar14 = ((int)uVar13 >> 0xf) + cXfer._2_2_ + (uint)CARRY2(uVar13,(uint)cXfer);
            if ((iVar14 < 1) && (iVar14 < 0)) {
              cXfer._0_2_ = -rgxf[0].fl.rgcsh[i];
              cXfer._2_2_ = (int)(uint)cXfer >> 0xf;
            }
            else {
              uVar13 = 0x7ffe - rgxf[0].fl.rgcsh[i];
              iVar14 = (int)uVar13 >> 0xf;
              if ((iVar14 <= (int)cXfer._2_2_) &&
                 ((iVar14 < (int)cXfer._2_2_ || (uVar13 <= (uint)cXfer)))) {
                cXfer._0_2_ = 0x7ffd - rgxf[0].fl.rgcsh[i];
                cXfer._2_2_ = (int)(uint)cXfer >> 0xf;
              }
            }
            piVar3 = rgxf[0].fl.rgcsh + i;
            *piVar3 = *piVar3 + (uint)cXfer;
          }
          if (((iPass == 0) && ((0 < (int)cXfer._2_2_ || (-1 < (int)cXfer._2_2_)))) ||
             ((iPass == 1 && (((int)cXfer._2_2_ < 1 && ((int)cXfer._2_2_ < 0)))))) {
            uVar13 = *(uint *)((int)rgcXfer + i * 2 + -0x70);
            iVar14 = (((int)uVar13 >> 0xf) - cXfer._2_2_) - (uint)(uVar13 < (uint)cXfer);
            if ((iVar14 < 1) && (iVar14 < 0)) {
              cXfer._0_2_ = *(uint *)((int)rgcXfer + i * 2 + -0x70);
            }
            else {
              uVar13 = 0x7ffe - *(int *)((int)rgcXfer + i * 2 + -0x70);
              iVar14 = (int)uVar13 >> 0xf;
              iVar19 = -(cXfer._2_2_ + ((uint)cXfer != 0));
              if ((iVar14 <= iVar19) && ((iVar14 < iVar19 || (uVar13 <= -(uint)cXfer)))) {
                cXfer._0_2_ = -(0x7ffd - *(int *)((int)rgcXfer + i * 2 + -0x70));
              }
            }
            piVar3 = (int *)((int)rgcXfer + i * 2 + -0x70);
            *piVar3 = *piVar3 - (uint)cXfer;
          }
          iLook = iLook + 1;
        }
        grbit = grbit >> 1;
      }
    }
    FleetTransferCargoBalance(&rgxf[0].fl,&rgxf[1].fl);
    for (iPass = 0; iPass < 2; iPass = iPass + 1) {
      FLookupFleet(-1,&rgxf[iPass].fl);
      pFVar23 = LpflFromId((&rgxf[iPass].fl)->id);
      iVar14 = (int)((ulong)pFVar23 >> 0x10);
      pFVar9 = (FLEET *)pFVar23;
      if ((pFVar9 != (FLEET *)0x0) || (iVar14 != 0)) {
        pFVar9->wFlags = pFVar9->wFlags & 0xffdfU | 0x20;
      }
      for (i = 0; (i < 0x10 && (rgxf[iPass].fl.rgcsh[i] == 0)); i = i + 1) {
      }
      if (i == 0x10) {
        FDeleteFleet((&rgxf[iPass].fl)->id,0,0);
      }
    }
    break;
  case 0x18:
  case 0x25:
    sVar10 = FLookupObject(grobjFleet,*(short *)lpb,&rgxf[0].fl);
    if (sVar10 == 0) {
      return 0;
    }
    if (rt == 0x18) {
      pFVar23 = LpflNewSplit(&rgxf[0].fl);
      if (pFVar23 == (FLEET *)0x0) {
        return 0;
      }
    }
    else {
      vrgiflMerge = rgifl;
      vcflMerge = 0;
      if (cb == 2) {
        for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar9 = ((FLEET **)rglpfl)[ifl];
          iVar14 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
          lpfl = (FLEET *)CONCAT22(iVar14,pFVar9);
          if ((pFVar9 == (FLEET *)0x0) && (iVar14 == 0)) break;
          if (((pFVar9->iPlayer == idPlayer) &&
              ((((uint)pFVar9->wFlags >> 10 & 1) == 0 && ((&pFVar9->pt)->x == rgxf[0].fl.pt.x)))) &&
             ((pFVar9->pt).y == rgxf[0].fl.pt.y)) {
            rgifl[vcflMerge] = lpfl->id;
            vcflMerge = vcflMerge + 1;
            pFVar9->wFlags = pFVar9->wFlags & 0xffdfU | 0x20;
          }
        }
      }
      else {
        for (i = 0; i < (int)((uint)cb / 2); i = i + 1) {
          for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
            pFVar9 = ((FLEET **)rglpfl)[ifl];
            iVar14 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
            lpfl = (FLEET *)CONCAT22(iVar14,pFVar9);
            if ((pFVar9 == (FLEET *)0x0) && (iVar14 == 0)) break;
            if (lpfl->id == *(int *)lpb) {
              rgifl[vcflMerge] = lpfl->id;
              vcflMerge = vcflMerge + 1;
              pFVar9->wFlags = pFVar9->wFlags & 0xffdfU | 0x20;
              break;
            }
          }
          lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 2);
        }
      }
      sVar10 = FFleetMergeAll(&rgxf[0].fl);
      if (sVar10 == 0) {
        return 0;
      }
    }
    break;
  case 0x1b:
    uVar13 = *(uint *)lpb >> 8 & 0x1f;
    iLook = *(uint *)lpb >> 4 & 0xf;
    if ((game.cPlayer <= iLook) || (iLook != idPlayer)) {
      return 0;
    }
    if (uVar13 < 0x10) {
      lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iLook * 4 + 0x100),
                                  (SHDEF *)(*(int *)(iLook * 4 + 0xfe) + uVar13 * 0x93));
    }
    else {
      if (0x19 < uVar13) {
        return 0;
      }
      lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iLook * 4 + 0x14e),
                                  (SHDEF *)(*(int *)(iLook * 4 + 0x14c) + (uVar13 - 0x10) * 0x93));
    }
    uVar20 = (undefined2)((ulong)lpshdef >> 0x10);
    pSVar18 = (SHDEF *)lpshdef;
    if ((((uint)pSVar18->wFlags >> 9 & 1) == 0) &&
       ((((int)pSVar18->cExist != 0 || (*(int *)((int)&pSVar18->cExist + 2) != 0)) &&
        ((*(uint *)lpb & 0xf) != 0)))) {
      return 0;
    }
    if ((*(uint *)lpb & 0xf) == 0) {
      if (((uint)pSVar18->wFlags >> 9 & 1) == 0) {
        DestroyAllIshdef(uVar13,idPlayer);
        uVar20 = (undefined2)((ulong)lpshdef >> 0x10);
        ((SHDEF *)lpshdef)->wFlags = ((SHDEF *)lpshdef)->wFlags & 0xfdffU | 0x200;
        if (uVar13 < 0x10) {
          pcVar2 = (char *)((int)&rgplr[0].cShDef + iLook * 0xc0);
          *pcVar2 = *pcVar2 + -1;
        }
        else {
          iVar14 = *(int *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          puVar1 = (uint *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          *puVar1 = *puVar1 & 0xfff;
          puVar1 = (uint *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          *puVar1 = *puVar1 | iVar14 - 0x1000U & 0xf000;
        }
      }
    }
    else if ((*(uint *)lpb & 0xf) == 1) {
      if (((uint)pSVar18->wFlags >> 9 & 1) != 0) {
        if (uVar13 < 0x10) {
          pcVar2 = (char *)((int)&rgplr[0].cShDef + iLook * 0xc0);
          *pcVar2 = *pcVar2 + '\x01';
        }
        else {
          id_2 = *(int *)((int)&rgplr[0].wFlags + iLook * 0xc0) + 0x1000U & 0xf000;
          puVar1 = (uint *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          *puVar1 = *puVar1 & 0xfff;
          puVar1 = (uint *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          *puVar1 = *puVar1 | id_2;
        }
      }
      if (uVar13 < 0x10) {
        sVar10 = FReadShDef((RTSHDEF *)CONCAT22(lpb._2_2_,(RTSHDEF *)((byte *)lpb + 2)),
                                (SHDEF *)CONCAT22(*(undefined2 *)(iLook * 4 + 0x100),
                                                  (SHDEF *)*(undefined2 *)(iLook * 4 + 0xfe)),
                                idPlayer);
        if (sVar10 == 0) {
          pcVar2 = (char *)((int)&rgplr[0].cShDef + iLook * 0xc0);
          *pcVar2 = *pcVar2 + -1;
          return 0;
        }
      }
      else {
        sVar10 = FReadShDef((RTSHDEF *)CONCAT22(lpb._2_2_,(RTSHDEF *)((byte *)lpb + 2)),
                                (SHDEF *)CONCAT22(*(undefined2 *)(iLook * 4 + 0x14e),
                                                  (SHDEF *)*(undefined2 *)(iLook * 4 + 0x14c)),
                                idPlayer);
        if (sVar10 == 0) {
          iVar14 = *(int *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          puVar1 = (uint *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          *puVar1 = *puVar1 & 0xfff;
          puVar1 = (uint *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          *puVar1 = *puVar1 | iVar14 - 0x1000U & 0xf000;
          return 0;
        }
      }
    }
    break;
  case 0x1d:
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    pPStack_546 = (PLANET *)lpPlanets;
    id_2 = lpPlanets._2_2_;
    lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
    lpplMac._2_2_ = lpPlanets._2_2_;
    while( true ) {
      if (((PLANET *)lpplMac <= (PLANET *)lppl) || (lppl->id == *(int *)lpb)) break;
      lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
    }
    if ((((PLANET *)lppl == (PLANET *)lpplMac) && (lppl._2_2_ == lpPlanets._2_2_)) ||
       (((PLANET *)lppl)->iPlayer != idPlayer)) {
      return 0;
    }
    uVar13 = (cb - 2U) / 4;
    if (uVar13 == 0) {
      if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) &&
         (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
        return 1;
      }
                    /* WARNING: Load size is inaccurate */
      FreeLp((void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                      ((PLANET *)lppl)->lpplprod),htOrd);
      *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
      *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
    }
    else {
      if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) &&
         (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
        pPVar22 = LpplAlloc(4,uVar13 + 2,htOrd);
        *(PL **)&((PLANET *)lppl)->lpplprod = (PL *)pPVar22;
        *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = (int)((ulong)pPVar22 >> 0x10);
      }
      else if (((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMax < uVar13) {
        pPVar22 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)
                                                      ((int)&((PLANET *)lppl)->lpplprod + 2),
                                                     *(PL **)&((PLANET *)lppl)->lpplprod),uVar13 + 2
                                     );
        *(PL **)&((PLANET *)lppl)->lpplprod = (PL *)pPVar22;
        *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = (int)((ulong)pPVar22 >> 0x10);
      }
      for (iPass = 0; iPass < (int)uVar13; iPass = iPass + 1) {
        uVar28 = __aFulshr(uVar29,cOut);
        if ((uVar28 & 0x7f) != 0) {
          for (iLook = 0; iLook < (int)(uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac;
              iLook = iLook + 1) {
            uVar28 = __aFulshr(uVar29,cOut);
            if ((uVar28 & 0x7f) != 0) {
              uVar28 = __aFulshr(uVar29,cOut);
              uStack_54a = (uint)uVar28 & 0x7f;
              pPStack_546 = *(PLANET **)((byte *)lpb + iPass * 4 + 2);
              id_2 = *(short *)((byte *)lpb + iPass * 4 + 2 + 2);
              pCStack_548 = (COLDROP *)0x0;
              uVar28 = __aFulshr(uVar29,cOut);
              if ((uStack_54a == ((uint)uVar28 & 0x7f)) && (pCStack_548 == (COLDROP *)0x0)) {
                uVar28 = __aFulshr(uVar29,cOut);
                uStack_54a = (uint)uVar28 & 7;
                pPStack_546 = *(PLANET **)((byte *)lpb + iPass * 4 + 2);
                id_2 = *(short *)((byte *)lpb + iPass * 4 + 2 + 2);
                pCStack_548 = (COLDROP *)0x0;
                uVar28 = __aFulshr(uVar29,cOut);
                if ((uStack_54a == ((uint)uVar28 & 7)) && (pCStack_548 == (COLDROP *)0x0)) {
                  uVar20 = *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2);
                  puVar16 = (undefined2 *)(*(int *)&((PLANET *)lppl)->lpplprod + 4 + iLook * 4);
                  uVar12 = puVar16[1];
                  uVar6 = *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2);
                  puVar17 = (undefined2 *)(*(int *)&((PLANET *)lppl)->lpplprod + 4 + iLook * 4);
                  *puVar17 = *puVar16;
                  puVar17[1] = uVar12 & 0xf80f;
                  break;
                }
              }
            }
          }
          if (iLook == (uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac) {
            uVar12 = *(uint *)((byte *)lpb + iPass * 4 + 2 + 2);
            *(undefined2 *)((byte *)lpb + iPass * 4 + 2) =
                 *(undefined2 *)((byte *)lpb + iPass * 4 + 2);
            *(uint *)((byte *)lpb + iPass * 4 + 2 + 2) = uVar12 & 0xf80f;
          }
        }
      }
      __fmemmove((void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                          (void *)(*(int *)&((PLANET *)lppl)->lpplprod + 4)),
                         (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 2),uVar13 << 2);
      ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac = (byte)uVar13;
    }
    break;
  case 0x1e:
    uVar13 = *(uint *)lpb >> 4 & 0xf;
    if (((*(uint *)lpb & 0xf) == idPlayer) &&
       (uVar13 <= ((byte *)rgcbtlplan)[idPlayer])) {
      if ((*(uint *)lpb >> 0xe & 1) == 0) {
        if (6 < (*(uint *)lpb >> 8 & 0xf)) {
          return 0;
        }
        if (8 < (*(uint *)((byte *)lpb + 2) & 0xf)) {
          return 0;
        }
        if (8 < (*(uint *)((byte *)lpb + 2) >> 4 & 0xf)) {
          return 0;
        }
        if (uVar13 == ((byte *)rgcbtlplan)[idPlayer]) {
          if (0xf < uVar13) {
            return 0;
          }
          ((byte *)rgcbtlplan)[idPlayer] =
               ((byte *)rgcbtlplan)[idPlayer] + 1;
        }
        UnpackBattlePlan
                  (lpb,(BTLPLAN *)
                       CONCAT22(((undefined2 *)&DAT_1120_593a)[idPlayer * 2],
                                ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + uVar13),
                   uVar13);
      }
      else {
        FDeleteBattlePlan(uVar13,0);
      }
    }
    else if ((*(uint *)lpb >> 0xe & 1) == 0) {
      return 0;
    }
    break;
  case 0x22:
    bVar5 = *lpb;
    if ((-1 < (char)bVar5) && ((char)bVar5 < 'e')) {
      *(byte *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) = bVar5;
      bVar5 = ((byte *)lpb)[1];
      if (((bVar5 & 0xf) < 6) && (((char)bVar5 >> 4 & 0xfU) < 8)) {
        *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) = bVar5;
        return 1;
      }
    }
    return 0;
  case 0x23:
    pPVar26 = LpplFromId(*(short *)lpb);
    iVar14 = (int)((ulong)pPVar26 >> 0x10);
    pPVar7 = (PLANET *)pPVar26;
    if ((pPVar7 == (PLANET *)0x0) && (iVar14 == 0)) {
      return 0;
    }
    if (pPVar7->iPlayer != idPlayer) {
      return 0;
    }
    pPStack_546 = (PLANET *)(*(uint *)((byte *)lpb + 2) & 1);
    id_2 = 0;
    lVar27 = __aFlshl(uVar29,cOut);
    uStack_54a = *(uint *)&pPVar7->dwFlags | (uint)lVar27;
    pCStack_548 = (COLDROP *)
                  (*(uint *)((int)&pPVar7->dwFlags + 2) & 0xff7f | (uint)((ulong)lVar27 >> 0x10));
    *(uint *)&pPVar7->dwFlags = uStack_54a;
    *(uint *)((int)&pPVar7->dwFlags + 2) = (uint)pCStack_548;
    uVar28 = __aFulshr(uVar29,cOut);
    id_2 = (uint)uVar28 & 0x3ff;
    pPVar7->wFlags = pPVar7->wFlags & 0xfc00U | id_2;
    uVar28 = __aFulshr(uVar29,cOut);
    id_2 = (uint)uVar28 & 0xf;
    pPVar7->wFlags = pPVar7->wFlags & 0xc3ffU | id_2 << 10;
    uVar29 = __aFulshr(uVar29,cOut);
    pPVar7->wRouting = pPVar7->wRouting & 0xfc00U | (uint)uVar29 & 0x3ff;
    break;
  case 0x24:
    if (((uint)gd._0_2_ >> 1 & 1) != 0) {
      uVar20 = *(undefined2 *)((byte *)lpb + 2);
      iVar14 = idPlayer * 0xc0;
      *(undefined2 *)((int)&rgplr[0].lSalt + iVar14) = *(undefined2 *)lpb;
      *(undefined2 *)((int)&rgplr[0].lSalt + 2 + iVar14) = uVar20;
    }
    break;
  case 0x26:
    __fmemcpy((void *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                       (void *)((int)rgplr[0].rgmdRelation +
                                               idPlayer * 0xc0)),lpb,game.cPlayer);
    break;
  case 0x2a:
    pFVar23 = LpflFromId(*(short *)lpb);
    if (pFVar23 == (FLEET *)0x0) {
      return 0;
    }
    ((FLEET *)pFVar23)->iplan = (byte)*(undefined2 *)((byte *)lpb + 2);
    break;
  case 0x2b:
    pTVar25 = LpthFromId(*(short *)lpb);
    if ((pTVar25 == (THING *)0x0) || ((uint)pTVar25->idFull >> 0xd != 0)) {
      return 0;
    }
    ((THING *)pTVar25)->rgb[7] = (byte)*(undefined2 *)((byte *)lpb + 2);
    break;
  case 0x2c:
    cOut = 0x20;
    pFVar23 = LpflFromId(*(short *)lpb);
    uVar20 = (undefined2)((ulong)pFVar23 >> 0x10);
    pFVar9 = (FLEET *)pFVar23;
    if (pFVar23 == (FLEET *)0x0) {
      return 0;
    }
    if ((*(int *)&pFVar9->lpszName != 0) || (*(int *)((int)&pFVar9->lpszName + 2) != 0)) {
                    /* WARNING: Load size is inaccurate */
      FreeLp((void *)CONCAT22(*(undefined2 *)((int)&pFVar9->lpszName + 2),pFVar9->lpszName),
                     htString);
    }
    if ((((byte *)lpb)[4] == 0) ||
       (sVar10 = FDecompressUserString
                           ((char *)CONCAT22(lpb._2_2_,(byte *)lpb + 5),(uint)((byte *)lpb)[4],
                            (char *)CONCAT22(unaff_SS,acStack_564),&cOut), sVar10 == 0)) {
      if (((byte *)lpb)[5] == 0) {
        *(undefined2 *)&pFVar9->lpszName = 0;
        *(undefined2 *)((int)&pFVar9->lpszName + 2) = 0;
      }
      else {
        HVar30 = htString;
        uVar11 = __fstrlen((char *)CONCAT22(lpb._2_2_,(byte *)lpb + 5));
        pvVar24 = LpAlloc(uVar11 + 1,HVar30);
        *(void **)&pFVar9->lpszName = (void *)pvVar24;
        *(undefined2 *)((int)&pFVar9->lpszName + 2) = (int)((ulong)pvVar24 >> 0x10);
                    /* WARNING: Load size is inaccurate */
        __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&pFVar9->lpszName + 2),
                                           pFVar9->lpszName),
                          (char *)CONCAT22(lpb._2_2_,(byte *)lpb + 5));
      }
    }
    else {
      HVar30 = htString;
      uVar11 = _strlen(acStack_564);
      pvVar24 = LpAlloc(uVar11 + 1,HVar30);
      *(void **)&pFVar9->lpszName = (void *)pvVar24;
      *(undefined2 *)((int)&pFVar9->lpszName + 2) = (int)((ulong)pvVar24 >> 0x10);
                    /* WARNING: Load size is inaccurate */
      __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&pFVar9->lpszName + 2),
                                         pFVar9->lpszName),(char *)CONCAT22(unaff_SS,acStack_564));
    }
    break;
  case 0x2e:
    if (((uint)gd._0_2_ >> 1 & 1) != 0) {
      if (0x1a < (uint)cb) {
        return 0;
      }
      __fmemcpy((void *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                         (void *)((int)&rgplr[0].zpq1 +
                                                 idPlayer * 0xc0)),lpb,cb);
    }
  }
  return 1;
}



// ======================================================================
// Function: FLoadLogFile
// Address: 1048:c7a2
// Segment: MEMORY_PLANET
// ======================================================================


short FLoadLogFile(char *pszLog)

{
  MSGPLR *pMVar1;
  undefined2 uVar2;
  undefined2 uVar3;
  short sVar4;
  HRSRC HVar5;
  int iVar6;
  TURNSERIAL *pTVar7;
  undefined2 uVar8;
  bool bVar9;
  void *pvVar10;
  short cSkip;
  ushort hrsrc;
  MSGPLR *lpmp;
  short iCur;
  short cbLog;
  short fRet;
  short env [9];
  short (*penvMemSav) [9];
  ushort hres;
  
  uVar2 = penvMem;
  imemLogCur = 0;
  imemLogPrev = -1;
  penvMem = env;
  sVar4 = __setjmp(env);
  if (sVar4 != 0) {
    if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
      if (hf != -1) {
        penvMem = (short *)uVar2;
        StreamClose();
        return 0;
      }
      penvMem = (short *)uVar2;
      return 1;
    }
    penvMem = (short *)uVar2;
    GlobalUnlock(hres);
    FreeResource(hres);
    return 0;
  }
  if (((((uint)game.wCrap >> 3 & 1) == 0) || (idPlayer != 0)) ||
     (((uint)gd._0_2_ >> 1 & 1) == 0)) {
PLANET_StrOpen:
    StreamOpen(pszLog,0x4020);
LAB_1048_c944:
    ReadRt();
    if ((((int)game.lid == rgbCur._4_2_) &&
        (game.lid._2_2_ == rgbCur._6_2_)) &&
       ((uint)game.turn <= (uint)rgbCur._10_2_)) {
      if (rgbCur._10_2_ == game.turn) {
        if ((uint)rgbCur._14_2_ >> 0xd == ((uint)game.wCrap >> 9 & 7)) {
          wVersFile._0_1_ = rgbCur[8];
          wVersFile._1_1_ = rgbCur[9];
          gd.wFlags =
               gd.wFlags & 0xfffbU | ((uint)rgbCur._14_2_ >> 0xc & 1) << 2;
          if (((uint)gd._0_2_ >> 1 & 1) != 0) {
            *(uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0) =
                 *(uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0) & 0xfffd |
                 ((uint)rgbCur._14_2_ >> 0xc & 1) << 1;
          }
          ReadRt();
          uVar3 = rgbCur._0_2_;
          if ((((uint)gd._0_2_ >> 1 & 1) != 0) &&
             ((((TURNSERIAL *)vrgts != (TURNSERIAL *)0x0 || (vrgts._2_2_ != 0)) &&
              (__fmemset((TURNSERIAL *)
                                 CONCAT22(vrgts._2_2_,
                                          (TURNSERIAL *)vrgts + idPlayer),0,0x10),
              uVar8 = rgbCur._4_2_, iVar6 = vrgts._2_2_,
              (hdrCur.wFlags & 0x3ffU) == 0x11)))) {
            pTVar7 = (TURNSERIAL *)vrgts + idPlayer;
            *(undefined2 *)&pTVar7->lSerialNumber = rgbCur._2_2_;
            *(undefined2 *)(char *)((int)&pTVar7->lSerialNumber + 2) = uVar8;
            __fmemcpy((byte *)CONCAT22(vrgts._2_2_,
                                               ((TURNSERIAL *)vrgts)[idPlayer].
                                               rgbConfig),rgbCur + 6,0xb);
          }
          for (iCur = 0; iCur < (int)uVar3; iCur = iCur + (hdrCur.wFlags & 0x3ffU) + 2) {
            ReadRt();
            __fmemmove((byte *)CONCAT22(lpLog._2_2_,(byte *)lpLog + iCur),
                               &hdrCur,2);
            __fmemmove((byte *)CONCAT22(lpLog._2_2_,(byte *)lpLog + iCur + 2),
                               rgbCur,hdrCur.wFlags & 0x3ff);
          }
          ReadRt();
          lpmp = (MSGPLR *)&vlpmsgplrOut;
          while( true ) {
            uVar8 = (undefined2)((ulong)lpmp >> 0x10);
            if ((*(int *)&lpmp->lpmsgplrNext == 0) &&
               (*(int *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2) == 0)) break;
                    /* WARNING: Load size is inaccurate */
            lpmp = (MSGPLR *)
                   CONCAT22(*(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2),
                            lpmp->lpmsgplrNext);
          }
          while (uVar8 = rgbCur._0_2_, (uint)hdrCur.wFlags >> 10 == 0x28) {
            pvVar10 = LpAlloc(hdrCur.wFlags & 0x3ff,htPlrMsg);
            uVar8 = (undefined2)((ulong)lpmp >> 0x10);
            *(void **)&lpmp->lpmsgplrNext = (void *)pvVar10;
            *(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2) =
                 (int)((ulong)pvVar10 >> 0x10);
                    /* WARNING: Load size is inaccurate */
            pMVar1 = lpmp->lpmsgplrNext;
            uVar8 = *(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2);
            lpmp = (MSGPLR *)CONCAT22(uVar8,pMVar1);
            __fmemcpy((MSGPLR *)CONCAT22(uVar8,pMVar1),rgbCur,
                              hdrCur.wFlags & 0x3ff);
            *(undefined2 *)&lpmp->lpmsgplrNext = 0;
            *(undefined2 *)((int)&pMVar1->lpmsgplrNext + 2) = 0;
            vcmsgplrOut = vcmsgplrOut + 1;
            ReadRt();
          }
          bVar9 = (uint)hdrCur.wFlags >> 10 == 0;
          if (bVar9) {
            rgbCur[0] = (char)uVar3;
            rgbCur[1] = SUB21(uVar3,1);
            imemLogCur._0_1_ = rgbCur[0];
            imemLogCur._1_1_ = rgbCur[1];
          }
          fRet = (short)bVar9;
          rgbCur._0_2_ = uVar8;
          if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
            StreamClose();
          }
          else {
            GlobalUnlock(hres);
            FreeResource(hres);
            vlpMemStream = (byte *)0x0;
          }
          penvMem = (short *)uVar2;
          DirtyGame(0);
          return fRet;
        }
        FileError(idsFileGame);
      }
      else {
        FileError(idsLogFileRecentGameTryingLoadIgnoring);
      }
    }
    if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
      StreamClose();
    }
    else {
      vlpMemStream = (byte *)0x0;
      GlobalUnlock(hres);
      FreeResource(hres);
    }
    sVar4 = 1;
  }
  else {
    cSkip = game.turn;
    HVar5 = FindResource(hInst,&DAT_0000_2711,&DAT_0000_2710);
    hres = LoadResource(hInst,HVar5);
    if (hres != 0) {
      vlpMemStream = (byte *)LockResource(hres);
      iVar6 = (int)((ulong)vlpMemStream >> 0x10);
      if (((byte *)vlpMemStream != (byte *)0x0) || (iVar6 != 0)) {
        if ((uint)*vlpMemStream <= (uint)game.turn) {
          vlpMemStream = (byte *)0x0;
          GlobalUnlock(hres);
          FreeResource(hres);
          goto PLANET_StrOpen;
        }
        vlpMemStream = (byte *)CONCAT22(iVar6,(byte *)vlpMemStream + 1);
        while (iVar6 = cSkip + -1, cSkip != 0) {
          do {
            vlpMemStream =
                 (byte *)CONCAT22(vlpMemStream._2_2_,
                                  (byte *)vlpMemStream +
                                  (*(uint *)vlpMemStream & 0x3ff) + 2);
            cSkip = iVar6;
          } while (*(uint *)vlpMemStream >> 10 != 8);
        }
        goto LAB_1048_c944;
      }
    }
    sVar4 = 0;
  }
  penvMem = (short *)uVar2;
  return sVar4;
}



// ======================================================================
// Function: FCheckLogFile
// Address: 1048:cccc
// Segment: MEMORY_PLANET
// ======================================================================


short FCheckLogFile(short iplr,short *pfError)

{
  short *psVar1;
  undefined2 uVar2;
  undefined2 uVar3;
  short sVar4;
  bool bVar5;
  short iCur;
  short cbLog;
  short fRet;
  short env [9];
  short (*penvMemSav) [9];
  
  psVar1 = penvMem;
  imemLogCur = 0;
  imemLogPrev = -1;
  penvMem = env;
  sVar4 = __setjmp(env);
  if (sVar4 == 0) {
    idsFileError = 0;
    sVar4 = FOpenFile(dtLog,iplr,0x20);
    if (sVar4 == 0) {
      if (idsFileError != 4) {
        *pfError = idsFileError;
      }
      fRet = 0;
    }
    else {
      ReadRt();
      uVar2 = rgbCur._0_2_;
      for (iCur = 0; iCur < (int)uVar2; iCur = iCur + (hdrCur.wFlags & 0x3ffU) + 2) {
        ReadRt();
      }
      ReadRt();
      while (uVar3 = rgbCur._0_2_, (uint)hdrCur.wFlags >> 10 == 0x28) {
        ReadRt();
      }
      bVar5 = (uint)hdrCur.wFlags >> 10 != 0;
      if (bVar5) {
        *pfError = 3;
      }
      else {
        rgbCur[0] = (char)uVar2;
        rgbCur[1] = SUB21(uVar2,1);
        imemLogCur._0_1_ = rgbCur[0];
        imemLogCur._1_1_ = rgbCur[1];
        rgbCur._0_2_ = uVar3;
      }
      fRet = (short)!bVar5;
      StreamClose();
      penvMem = psVar1;
    }
  }
  else if (hf == -1) {
    fRet = 1;
    penvMem = psVar1;
  }
  else {
    penvMem = psVar1;
    StreamClose();
    *pfError = 3;
    fRet = 0;
  }
  return fRet;
}



// ======================================================================
// Function: FWriteLogFile
// Address: 1048:cdf6
// Segment: MEMORY_PLANET
// ======================================================================


short FWriteLogFile(char *pszFileBase,short iPlayer)

{
  undefined2 uVar1;
  ushort cb_00;
  short sVar2;
  char *sz;
  undefined2 unaff_SS;
  MSGPLR *pMVar3;
  undefined2 uVar4;
  short cb;
  MSGPLR *lpmp;
  RTLOGHDR rtlh;
  HDR *lprts;
  short iCur;
  short env [9];
  short (*penvMemSav) [9];
  
  iCur = 0;
  if (((iPlayer == idPlayer) &&
      ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0)) &&
     ((uint)hdrPrev.wFlags >> 10 != 0x2e)) {
    cb_00 = (0xc - (uint)vrgZipProd[0].cpq) * -2 + 0x1a;
    sVar2 = _memcmp((void *)((int)&rgplr[0].zpq1 + iPlayer * 0xc0),
                            (void *)&vrgZipProd[0].field2_0xe,cb_00);
    if (sVar2 != 0) {
      WriteMemRt(0x2e,cb_00,(void *)&vrgZipProd[0].field2_0xe);
    }
  }
  _strcpy((char *)szBase,pszFileBase);
  sVar2 = FCreateFile(dtLog,iPlayer,(char *)0x0);
  uVar1 = penvMem;
  if (sVar2 == 0) {
    sVar2 = 0x10;
    sz = PszFormatIds(idsUnableCreateLogFile,(short *)0x0);
    AlertSz(sz,sVar2);
    sVar2 = 0;
  }
  else {
    penvMem = env;
    sVar2 = __setjmp(env);
    if (sVar2 == 0) {
      rtlh.cbLog = imemLogCur;
      rtlh.lSerialNumber._0_2_ = (undefined2)vSerialNumber;
      rtlh.lSerialNumber._2_2_ = vSerialNumber._2_2_;
      _memcpy(rtlh.rgbConfig,(undefined *)&vrgbEnvCur,0xb);
      WriteRt(9,0x11,(RTLOGHDR *)CONCAT22(unaff_SS,&rtlh));
      for (; iCur < imemLogCur; iCur = iCur + (lprts->wFlags & 0x3ffU) + 2) {
        lprts = (HDR *)CONCAT22(lpLog._2_2_,(HDR *)((byte *)lpLog + iCur));
        WriteRt((uint)lprts->wFlags >> 10,lprts->wFlags & 0x3ff,
                    (byte *)CONCAT22(lpLog._2_2_,(byte *)lpLog + iCur + 2));
      }
      iCur = vcmsgplrOut;
      lpmp = (MSGPLR *)CONCAT22(vlpmsgplrOut._2_2_,(MSGPLR *)vlpmsgplrOut);
      while (iCur != 0) {
        pMVar3 = (MSGPLR *)lpmp;
        uVar4 = lpmp._2_2_;
        sVar2 = _abs(((MSGPLR *)lpmp)->cLen);
        WriteRt(0x28,sVar2 + 0xc,(MSGPLR *)CONCAT22(uVar4,pMVar3));
                    /* WARNING: Load size is inaccurate */
        lpmp = (MSGPLR *)
               CONCAT22(*(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2),lpmp->lpmsgplrNext
                       );
        iCur = iCur + -1;
      }
      WriteRt(0,0,(void *)0x0);
      StreamClose();
      penvMem = (short *)uVar1;
      DirtyGame(0);
      gd._4_2_ = gd._4_2_ & 0xfeff | 0x100;
      sVar2 = 1;
    }
    else {
      penvMem = (short *)uVar1;
      StreamClose();
      sVar2 = 0;
    }
  }
  return sVar2;
}



// ======================================================================
// Function: FWriteTutorialMFile
// Address: 1048:d058
// Segment: MEMORY_PLANET
// ======================================================================


short FWriteTutorialMFile(short iTurn)

{
  undefined2 uVar1;
  short sVar2;
  HGLOBAL HVar3;
  char *pcVar4;
  int iVar5;
  short cSkip;
  short cch;
  short env [9];
  short (*penvMemSav) [9];
  ushort hres;
  char szT [30];
  ushort hrsrc;
  
  uVar1 = penvMem;
  cSkip = iTurn;
  penvMem = env;
  sVar2 = __setjmp(env);
  if (sVar2 == 0) {
    if (iTurn < 0x20) {
      hrsrc = FindResource(hInst,&DAT_0000_2713,&DAT_0000_2712);
    }
    else {
      hrsrc = FindResource(hInst,&DAT_0000_2715,&DAT_0000_2714);
      cSkip = iTurn + -0x20;
    }
    HVar3 = LoadResource(hInst,hrsrc);
    if (HVar3 != 0) {
      vlpMemStream = (byte *)LockResource(HVar3);
      iVar5 = (int)((ulong)vlpMemStream >> 0x10);
      if (((byte *)vlpMemStream != (byte *)0x0) || (iVar5 != 0)) {
        if (cSkip < (int)(uint)*vlpMemStream) {
          vlpMemStream = (byte *)CONCAT22(iVar5,(byte *)vlpMemStream + 1);
          while (iVar5 = cSkip + -1, cSkip != 0) {
            do {
              vlpMemStream =
                   (byte *)CONCAT22(vlpMemStream._2_2_,
                                    (byte *)vlpMemStream +
                                    (*(uint *)vlpMemStream & 0x3ff) + 2);
              cSkip = iVar5;
            } while (*(uint *)vlpMemStream >> 10 != 8);
          }
          sVar2 = CchGetString(idsTutorial,szT);
          if (iTurn == 0x25) {
            pcVar4 = (char *)0x9aa;
          }
          else {
            pcVar4 = (char *)0x9af;
          }
          _strcpy(szT + sVar2,pcVar4);
          StreamOpen(szT,0x1012);
          do {
            RgToStream(vlpMemStream,(*(uint *)vlpMemStream & 0x3ff) + 2);
            vlpMemStream =
                 (byte *)CONCAT22(vlpMemStream._2_2_,
                                  (byte *)vlpMemStream +
                                  (*(uint *)vlpMemStream & 0x3ff) + 2);
          } while (*(uint *)vlpMemStream >> 10 != 8);
          StreamClose();
          vlpMemStream = (byte *)0x0;
          GlobalUnlock(HVar3);
          FreeResource(HVar3);
          penvMem = (short *)uVar1;
          return 1;
        }
        vlpMemStream = (byte *)0x0;
        GlobalUnlock(HVar3);
        FreeResource(HVar3);
        penvMem = (short *)uVar1;
        return 2;
      }
    }
    sVar2 = 0;
    penvMem = (short *)uVar1;
  }
  else if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
    if (hf == -1) {
      sVar2 = 1;
      penvMem = (short *)uVar1;
    }
    else {
      penvMem = (short *)uVar1;
      StreamClose();
      sVar2 = 0;
    }
  }
  else {
    penvMem = (short *)uVar1;
    GlobalUnlock(hres);
    FreeResource(hres);
    sVar2 = 0;
  }
  return sVar2;
}



// ======================================================================
// Function: FWriteHistFile
// Address: 1048:d29e
// Segment: MEMORY_PLANET
// ======================================================================


short FWriteHistFile(short iPlayer)

{
  int iVar1;
  undefined2 uVar2;
  short sVar3;
  char *sz;
  undefined2 uVar4;
  undefined2 unaff_SS;
  byte *lpb;
  RTHISTHDR rthh;
  short j;
  SHDEF *lpshdef;
  ushort cTurnBase;
  short env [9];
  short (*penvMemSav) [9];
  short i;
  PLANET *lppl;
  
  sVar3 = FCreateFile(dtHist,iPlayer,(char *)0x0);
  uVar2 = penvMem;
  if (sVar3 == 0) {
    sVar3 = 0x10;
    sz = PszFormatIds(idsUnableCreateHistoryFile,(short *)0x0);
    AlertSz(sz,sVar3);
    sVar3 = 0;
  }
  else {
    penvMem = env;
    sVar3 = __setjmp(env);
    if (sVar3 == 0) {
      rthh.cPlanet = cPlanet;
      rthh.cPlanetExtra = *(uint *)((int)&rgplr[0].wFlags + iPlayer * 0xc0) & 0xfff;
      WriteRt(0x20,4,(RTHISTHDR *)CONCAT22(unaff_SS,&rthh));
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      for (i = 0; i < cPlanet; i = i + 1) {
        uVar4 = (undefined2)((ulong)lppl >> 0x10);
        if ((((PLANET *)lppl)->wFlags & 0xffU) < 3) {
          sVar3 = 0xf;
        }
        else {
          sVar3 = 0xe;
        }
        WritePlanet(lppl,sVar3,1);
        lppl = (PLANET *)CONCAT22(uVar4,(PLANET *)lppl + 1);
      }
      WriteRt(0x21,cbbitfMsg,bitfMsgFiltered);
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if ((i != iPlayer) && ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 7) != 0)) {
          WriteRtPlr((PLAYER *)rgplr + i,(byte *)0x0);
        }
      }
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) &&
           (i != iPlayer)) {
          iVar1 = *(int *)(i * 4 + 0xfe);
          uVar4 = *(undefined2 *)(i * 4 + 0x100);
          for (j = 0; j < 0x10; j = j + 1) {
            if ((*(uint *)(iVar1 + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
              WriteRtShDef((SHDEF *)CONCAT22(uVar4,(SHDEF *)(iVar1 + j * 0x93)),(byte **)0x0);
            }
          }
        }
      }
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) &&
           (i != iPlayer)) {
          iVar1 = *(int *)(i * 4 + 0x14c);
          uVar4 = *(undefined2 *)(i * 4 + 0x14e);
          for (j = 0; j < 10; j = j + 1) {
            if ((*(uint *)(iVar1 + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
              WriteRtShDef((SHDEF *)CONCAT22(uVar4,(SHDEF *)(iVar1 + j * 0x93)),(byte **)0x0);
            }
          }
        }
      }
      if ((uint)game.turn < 0x65) {
        cTurnBase = 0;
      }
      else {
        cTurnBase = game.turn - 100;
      }
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if ((((SCOREX **)rgsxPlr)[i * 2] != (SCOREX *)0x0) ||
           (*(int *)((undefined *)&DAT_1120_156e + i * 4) != 0)) {
          for (j = 0; j < ((short *)rgcsxPlr)[i]; j = j + 1) {
            if (cTurnBase <= (uint)((SCOREX **)rgsxPlr)[i * 2][j].iRank) {
              WriteRt(0x2d,0x18,
                          (SCOREX *)
                          CONCAT22(*(undefined2 *)((undefined *)&DAT_1120_156e + i * 4),
                                   ((SCOREX **)rgsxPlr)[i * 2] + j));
            }
          }
        }
      }
      iVar1 = vlpbAiData._2_2_;
      if ((((byte *)vlpbAiData != (byte *)0x0) || (vlpbAiData._2_2_ != 0)) &&
         (2 < *(uint *)vlpbAiData)) {
        i = *(short *)vlpbAiData;
        lpb._0_2_ = (byte *)vlpbAiData;
        for (; 0x3ff < i; i = i + -0x3ff) {
          WriteRt(0x29,0x3ff,(byte *)CONCAT22(iVar1,(byte *)lpb));
          lpb._0_2_ = (byte *)lpb + 0x3ff;
        }
        WriteRt(0x29,i,(byte *)CONCAT22(iVar1,(byte *)lpb));
      }
      WriteRt(0,0,(void *)0x0);
      StreamClose();
      sVar3 = 1;
      penvMem = (short *)uVar2;
    }
    else {
      penvMem = (short *)uVar2;
      StreamClose();
      sVar3 = 0;
    }
  }
  return sVar3;
}



// ======================================================================
// Function: EnumLogRts
// Address: 1048:d6e0
// Segment: MEMORY_PLANET
// ======================================================================


void EnumLogRts(void *pfn,void *lpPass,short iPass)

{
  int iVar1;
  HDR *lprts;
  short iCur;
  short fRet;
  short fLogOld;
  
  iCur = 0;
  if (imemLogCur != 0) {
    for (; iCur < imemLogCur; iCur = iCur + (lprts->wFlags & 0x3ffU) + 2) {
      lprts = (HDR *)CONCAT22(lpLog._2_2_,(HDR *)((byte *)lpLog + iCur));
      iVar1 = (*(void *)pfn)((undefined *)&DAT_1120_1048,(byte *)lpLog + iCur + 2,
                             lpLog._2_2_,(uint)lprts->wFlags >> 10,lprts->wFlags & 0x3ff,
                             (void *)lpPass,lpPass._2_2_,iPass);
      if (iVar1 == 0) {
        return;
      }
    }
  }
  return;
}



