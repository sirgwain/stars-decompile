// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: PlanetWndProc
// Address: 1048:0000
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lpfl */
/* WARNING: Variable defined which should be unmapped: pt */
/* WARNING: Variable defined which should be unmapped: lppl */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

long PlanetWndProc(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  int iVar1;
  int *piVar2;
  POINT pt_00;
  POINT pt_01;
  POINT PVar3;
  uint uVar4;
  short sVar5;
  HWND HVar6;
  char *pcVar7;
  BOOL BVar8;
  undefined2 unaff_SI;
  ushort unaff_DI;
  undefined2 unaff_SS;
  fn_lpfnRealEditProc *pfVar9;
  LRESULT LVar10;
  ulong uVar11;
  char *mbType;
  ushort in_stack_0000ff3a;
  FLEET *lpfl;
  PLANET *lppl;
  POINT pt;
  short in_stack_0000ff50;
  short i;
  XFER xf;
  PAINTSTRUCT ps;
  HDC hdc;
  
  if (message == WM_CREATE) {
    SetPlanetTitleBar(hwnd);
    for (i = 0; i < 3; i = i + 1) {
      if (i == 1) {
        uVar4 = 0x210;
      }
      else {
        uVar4 = 0;
      }
      if (i == 2) {
        sVar5 = 0xa0;
      }
      else {
        sVar5 = 0x50;
      }
      HVar6 = CreateWindow((LPCSTR)_szCombobox,(LPCSTR)0x11200876,CONCAT22(0x4020,uVar4 | 3),100,100
                           ,200,sVar5,hwnd,0,hInst,(void *)0x0);
      ((ushort *)rghwndOrderDD)[i] = HVar6;
      SendMessage(((ushort *)rghwndOrderDD)[i],0x30,rghfontArial8[1],0);
    }
    for (i = 99; i < 0x6d; i = i + 1) {
      pcVar7 = PszGetCompressedString(i);
      SendMessage(rghwndOrderDD[0],0x403,0,(LPARAM)pcVar7);
    }
    hwndOrderED =
         CreateWindow((LPCSTR)_szEdit,(LPCSTR)0x0,0x40800002,100,100,200,0x32,hwnd,0,hInst
                      ,(void *)0x0);
    SendMessage(hwndOrderED,0x415,4,0);
    SendMessage(hwndOrderED,0x30,rghfontArial8[1],0);
    pfVar9 = (fn_lpfnRealEditProc *)GetWindowLong(hwndOrderED,-4);
    lpfnRealEditProc = pfVar9;
    SetWindowLong(hwndOrderED,-4,
                  (long)CONCAT22(lpfnFakeEditProc._2_2_,
                                 (fn_lpfnFakeEditProc *)lpfnFakeEditProc));
    hwndBattleDD =
         CreateWindow((LPCSTR)_szCombobox,s_BattleDD_1120_087c,0x40200003,100,100,200,0x50,hwnd,0,
                      hInst,(void *)0x0);
    SendMessage(hwndBattleDD,0x30,rghfontArial8[1],0);
    hwndShipDD =
         CreateWindow((LPCSTR)_szCombobox,(LPCSTR)0x11200885,0x40200213,100,100,200,0x50,hwnd,0,
                      hInst,(void *)0x0);
    SendMessage(hwndShipDD,0x30,rghfontArial8[1],0);
    GetClientRect(hwndShipDD,(RECT *)(RECT *)&stack0xff4a);
    dyShipDD = in_stack_0000ff50;
    hwndShipLB =
         CreateWindow((LPCSTR)_szListbox,(LPCSTR)0x1120088c,0x40a01001,100,100,200,0x50,hwnd,0,
                      hInst,(void *)0x0);
    SendMessage(hwndShipLB,0x30,rghfontArial8[1],0);
    hwndFleetCompLB =
         CreateWindow((LPCSTR)_szListbox,s_FleetCompLB_1120_0893,0x40a00051,100,100,200,0x50,hwnd,0,
                      hInst,(void *)0x0);
    pt.x = 0x30;
    pt.y = hwndFleetCompLB;
    SendMessage(hwndFleetCompLB,0x30,rghfontArial8[0],0);
    pt.y = 0x1120;
    pt.x = (short)_szListbox;
    hwndPlanetProdLB =
         CreateWindow((LPCSTR)_szListbox,s_PlanetProdLB_1120_089f,0x40a00051,100,100,200,0x50,hwnd,0
                      ,hInst,(void *)0x0);
    pt.y = rghfontArial8[0];
    pt.x = 0;
    SendMessage(hwndPlanetProdLB,0x30,rghfontArial8[0],0);
    for (i = 0; i < 0xd; i = i + 1) {
      pt.y = 0x3aa;
      pt.x = (short)PszGetCompressedString(i + idsCargo2);
      pt.y = 0x1120;
      HVar6 = CreateWindow((LPCSTR)_szButton,(LPCSTR)pt.x,0x40000000,100,100,100,
                           dyArial8 << 1,hwnd,0,hInst,(void *)0x0);
      ((ushort *)rghwndBtn)[i] = HVar6;
      pt.y = 0;
      pt.x = 0x14f8;
      SendMessage(((ushort *)rghwndBtn)[i],0x30,rghfontArial8[1],0);
    }
    sVar5 = 0x1120;
    pt.y = 799;
    pt.x = 0x14f8;
    pcVar7 = _szButton;
    pt.x = (short)PszGetCompressedString(idsRepeatOrders);
    pt.y = 0x1120;
    hwndRepCB =
         CreateWindow((LPCSTR)CONCAT22(sVar5,pcVar7),(LPCSTR)pt.x,0x40000003,100,100,0x96,
                      dyArial8,hwnd,0,hInst,(void *)0x0);
    pt.y = 0;
    pt.x = 0x14f8;
    SendMessage(hwndRepCB,0x30,rghfontArial8[1],0);
  }
  else {
    if (message != WM_PAINT) {
      if (message == WM_ERASEBKGND) {
        GetClientRect(hwnd,(RECT *)(RECT *)&stack0xff4a);
        FillRect(wParam,(RECT *)(RECT *)&stack0xff4a,hbrButtonFace);
        uVar11 = 1;
        pfVar9 = lpfnRealEditProc;
        goto LAB_1048_0d0d;
      }
      if (message == WM_CTLCOLOR) {
        if ((HWND)lParam == hwndRepCB) {
          SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace
                                    ));
          SetTextColor(wParam,CONCAT22(crButtonText._2_2_,
                                       (undefined2)crButtonText));
          uVar11 = (ulong)hbrButtonFace;
          pfVar9 = lpfnRealEditProc;
          goto LAB_1048_0d0d;
        }
      }
      else if (message == WM_SETCURSOR) {
        GetCursorPos((POINT *)(POINT *)&pt);
        ScreenToClient(hwnd,(POINT *)(POINT *)&pt);
        GetClientRect(hwnd,(RECT *)(RECT *)&stack0xff3c);
        PVar3.y = pt.y;
        PVar3.x = pt.x;
        BVar8 = PtInRect((RECT *)(RECT *)&stack0xff3c,PVar3);
        if (BVar8 != 0) {
          pt_00.y = pt.y;
          pt_00.x = pt.x;
          lppl._2_2_ = ClickInShipOrders(pt_00,0,1,0);
          if (lppl._2_2_ == 0) {
            pt_01.y = pt.y;
            pt_01.x = pt.x;
            lppl._2_2_ = ClickInPlanetOrders(pt_01,0,1,0);
          }
          if (lppl._2_2_ != 0) {
            setcursor(lppl._2_2_);
            uVar11 = 1;
            pfVar9 = lpfnRealEditProc;
            goto LAB_1048_0d0d;
          }
        }
      }
      else {
        if (message != WM_GETMINMAXINFO) {
          if (message == WM_DRAWITEM) {
            pt = (POINT)lParam;
            if (*(int *)((HWND)lParam + 4) == -1) {
              HandleFocusState((DRAWITEMSTRUCT *)lParam,-2);
            }
            else {
              iVar1 = *(int *)((HWND)lParam + 6);
              if (iVar1 == 1) {
                DrawCBEntireItem((DRAWITEMSTRUCT *)lParam,-4);
              }
              else if (iVar1 == 2) {
                DrawCBEntireItem((DRAWITEMSTRUCT *)lParam,-4);
              }
              else if (iVar1 == 4) {
                DrawCBEntireItem((DRAWITEMSTRUCT *)lParam,-4);
              }
            }
            uVar11 = 1;
            pfVar9 = lpfnRealEditProc;
            goto LAB_1048_0d0d;
          }
          if (message == WM_MEASUREITEM) {
            *(int *)((HWND)lParam + 8) = dyArial8 + 2;
            uVar11 = 1;
            pfVar9 = lpfnRealEditProc;
            goto LAB_1048_0d0d;
          }
          if (message == WM_CHAR) {
            if ((wParam == 0x66) || (wParam == 0x46)) {
              pt.x = (short)((PLANET *)lpPlanets + cPlanet);
              pt.y = lpPlanets._2_2_;
              for (lppl._0_2_ = (PLANET *)lpPlanets; (PLANET *)lppl < (uint)pt.x;
                  lppl._0_2_ = (PLANET *)lppl + 1) {
                if (((PLANET *)lppl)->iPlayer == idPlayer) {
                  if ((sel.grobj != grobjPlanet) ||
                     (sel.id !=
                      ((PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lppl))->id)) {
                    SelectAdjPlanet(0,((PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lppl))->
                                      id);
                    uVar11 = 0;
                    pfVar9 = lpfnRealEditProc;
                    goto LAB_1048_0d0d;
                  }
                  break;
                }
              }
              for (i = 0; i < cFleet; i = i + 1) {
                piVar2 = *(int **)((FLEET **)rglpfl + i);
                iVar1 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                if ((piVar2 == (int *)0x0) && (iVar1 == 0)) break;
                if (piVar2[1] == idPlayer) {
                  if ((sel.grobj != grobjFleet) ||
                     (sel.id != *(int *)CONCAT22(iVar1,piVar2))) {
                    SelectAdjFleet(0,*(int *)CONCAT22(iVar1,piVar2));
                    uVar11 = 0;
                    pfVar9 = lpfnRealEditProc;
                    goto LAB_1048_0d0d;
                  }
                  break;
                }
              }
            }
          }
          else if (message == WM_COMMAND) {
            if (sel.grobj == grobjFleet) {
              ShipCommandProc(hwnd,wParam,lParam);
            }
            else {
              if ((HWND)lParam == hwndShipDD) {
                uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                if ((int)uVar11 == 1) {
                  DrawPlanShip(0,-0x7ffc);
                }
                goto PLANET_Default_6;
              }
              if ((HWND)lParam != rghwndBtn[4]) {
LAB_1048_0950:
                if ((HWND)lParam == rghwndBtn[5]) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 0) {
                    sVar5 = GetKeyState(0x10);
                    if (sVar5 < 0) {
                      sVar5 = IdFindAdjStarbase(sel.pl.id,1);
                      SelectAdjPlanet(0,sVar5);
                    }
                    else {
                      SelectAdjPlanet(1,0);
                    }
                    goto PLANET_LRefocus;
                  }
                }
                if ((HWND)lParam == rghwndBtn[0]) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 0) {
                    LVar10 = SendMessage(hwndShipDD,0x407,0,0);
                    if (LVar10 != -1) {
                      sVar5 = FLookupOrbitingXfer(sel.pl.id,(short)LVar10,&xf,-1);
                      if (sVar5 != 0) {
                        TransferStuff(sel.pl.id,1,xf.id,xf.grobj,0);
                        goto PLANET_LRefocus;
                      }
                    }
                    goto LAB_1048_0d04;
                  }
                }
                if ((HWND)lParam == rghwndBtn[1]) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 0) {
                    LVar10 = SendMessage(hwndShipDD,0x407,0,0);
                    if (LVar10 != -1) {
                      sVar5 = FLookupOrbitingXfer(sel.pl.id,(short)LVar10,&xf,-1);
                      if ((sVar5 != 0) && (xf.grobj == grobjFleet)) {
                        SelectAdjFleet(0,xf.id);
                      }
                    }
                    goto PLANET_LRefocus;
                  }
                }
                if ((HWND)lParam == rghwndBtn[2]) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 0) {
                    pt.x = 0x262;
                    pt.y = 0x1d6;
                    ShipBuilder((POINT)0x1d60262);
                    goto PLANET_LRefocus;
                  }
                }
                if ((HWND)lParam == rghwndBtn[0xb]) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 0) {
                    ChangeProduction(0);
                    goto PLANET_LRefocus;
                  }
                }
                if ((HWND)lParam == rghwndBtn[0xc]) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 0) {
                    mbType = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
                    pcVar7 = PszFormatIds(idsSureWantDeleteEverythingPlanetsProductionQueue,
                                               (short *)0x0);
                    sVar5 = AlertSz(pcVar7,(short)mbType);
                    if (sVar5 != 6) goto LAB_1048_0d04;
                    ChangeProduction(1);
                    goto PLANET_LRefocus;
                  }
                }
                if ((HWND)lParam == hwndPlanetProdLB) {
                  uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
                  if ((int)uVar11 == 1) {
                    DrawPlanShip(0,0x40);
                    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
                      tutor.wFlags = tutor.wFlags & 0xfbffU | 0x400;
                      AdvanceTutor();
                    }
                  }
                }
                goto PLANET_Default_6;
              }
              uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff3a);
              if ((int)uVar11 != 0) goto LAB_1048_0950;
              sVar5 = GetKeyState(0x10);
              if (sVar5 < 0) {
                sVar5 = IdFindAdjStarbase(sel.pl.id,0);
                SelectAdjPlanet(0,sVar5);
              }
              else {
                SelectAdjPlanet(-1,0);
              }
PLANET_LRefocus:
              SetFocus(hwndFrame);
            }
          }
          else if (((message == WM_LBUTTONDOWN) || (message == WM_LBUTTONDBLCLK)) ||
                  (message == WM_RBUTTONDOWN)) {
            SetFocus(hwndFrame);
            uVar4 = (uint)(message == WM_RBUTTONDOWN);
            uVar11 = __aFulshr((ulong)CONCAT12(message == WM_RBUTTONDOWN,wParam),unaff_DI);
            PlanetClick((HWND)lParam,(short)uVar11,wParam,uVar4);
          }
          else {
            if (message != WM_MDIACTIVATE) goto PLANET_Default_6;
            hwndActive = hwnd;
            if (wParam == 0) {
              hwndActive = 0;
            }
          }
          goto LAB_1048_0d04;
        }
        *(int *)((HWND)lParam + 0xc) = dxWinFrame * 2 + 0xc6;
        *(int *)((HWND)lParam + 0xe) = dyWinFrame * 2 + 0xc6 + dyTitleBar;
      }
PLANET_Default_6:
      uVar11 = DefWindowProc(hwnd,message,wParam,lParam);
      pfVar9 = lpfnRealEditProc;
      goto LAB_1048_0d0d;
    }
    hdc = BeginPaint(hwnd,(PAINTSTRUCT *)&ps);
    DrawPlanShip(hdc,0xfff);
    EndPaint(hwnd,(PAINTSTRUCT *)&ps);
  }
LAB_1048_0d04:
  uVar11 = 0;
  pfVar9 = lpfnRealEditProc;
LAB_1048_0d0d:
  lpfnRealEditProc._2_2_ = (undefined2)((ulong)pfVar9 >> 0x10);
  lpfnRealEditProc._0_2_ = (fn_lpfnRealEditProc *)pfVar9;
  return uVar11;
}



// ======================================================================
// Function: DrawPlanShip
// Address: 1048:0d16
// Segment: MEMORY_PLANET
// ======================================================================


void DrawPlanShip(HDC hdc,short grbit)

{
  undefined2 *puVar1;
  HGDIOBJ HVar2;
  OBJ OVar3;
  undefined2 unaff_SS;
  COLORREF CVar4;
  RECT rc;
  short fDC;
  int ptile;
  short fErase;
  COLORREF crBack;
  short i;
  short fMin;
  OBJ obj;
  short ctile;
  OBJ objNull;
  HFONT hfontSav;
  
  fDC = 0;
  if (sel.id == -1) {
    for (i = 0; i < 0xd; i = i + 1) {
      ShowWindow(((ushort *)rghwndBtn)[i],0);
    }
    for (i = 0; i < 3; i = i + 1) {
      ShowWindow(((ushort *)rghwndOrderDD)[i],0);
    }
    ShowWindow(hwndOrderED,0);
    ShowWindow(hwndShipDD,0);
    ShowWindow(hwndBattleDD,0);
    ShowWindow(hwndShipLB,0);
    ShowWindow(hwndFleetCompLB,0);
    ShowWindow(hwndPlanetProdLB,0);
    ShowWindow(hwndRepCB,0);
    for (i = 0; i < 0x13; i = i + 1) {
      *(undefined2 *)((int)&rgrcRef[0].bottom + i * 8) = 0xfffa;
      *(undefined2 *)((int)&rgrcRef[0].top + i * 8) = 0xfffb;
    }
    if (((*(uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0) & 1) != 0) &&
       (hdc != 0)) {
      GetClientRect(hwndPlanet,(RECT *)&rc);
      SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      i = CchGetString(idsDeceased,(char *)szWork);
      DiaganolTextOut(hdc,&rc,(char *)szWork,i);
    }
  }
  else {
    if (sel.grobj == grobjFleet) {
      ptile = 0x90e;
      ctile = 7;
      obj.ppl = (PLANET *)&sel.fl;
    }
    else {
      ptile = 0x7fc;
      ctile = 6;
      obj.ppl = (PLANET *)&sel.pl;
    }
    if (hdc == 0) {
      fDC = 1;
      hdc = GetDC(hwndPlanet);
    }
    HVar2 = SelectObject(hdc,rghfontArial8[0]);
    crBack = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace
                                    ));
    CVar4 = SetTextColor(hdc,CONCAT22(crButtonText._2_2_,
                                      (undefined2)crButtonText));
    fErase = (short)((grbit & 0x8000U) != 0);
    fMin = (short)((grbit & 0x4000U) != 0);
    for (i = 0; i < ctile; i = i + 1) {
      if ((grbit & *(uint *)(ptile + i * 0x10 + 4)) != 0) {
        *(uint *)(ptile + i * 0x10 + 10) =
             *(uint *)(ptile + i * 0x10 + 10) & 0xfbff | (fErase & 1U) << 10;
        *(uint *)(ptile + i * 0x10 + 10) =
             *(uint *)(ptile + i * 0x10 + 10) & 0xefff | (fMin & 1U) << 0xc;
        OVar3.ppl = obj.ppl;
        if ((*(uint *)(ptile + i * 0x10 + 10) >> 8 & 1) != 0) {
          OVar3.ppl = (PLANET *)0x0;
        }
        puVar1 = (undefined2 *)(ptile + i * 0x10 + 6);
        (*(code *)*puVar1)(0x14f8,hdc,ptile + i * 0x10,OVar3.ppl);
      }
    }
    SetTextColor(hdc,CVar4);
    SetBkColor(hdc,crBack);
    SelectObject(hdc,HVar2);
    if (fDC != 0) {
      ReleaseDC(hwndPlanet,hdc);
    }
  }
  return;
}



// ======================================================================
// Function: FDrawTileNC
// Address: 1048:1086
// Segment: MEMORY_PLANET
// ======================================================================


short FDrawTileNC(HDC hdc,TILE *ptile,RECT *prc,char *pszTitle)

{
  int iVar1;
  undefined2 unaff_SS;
  RECT rcT;
  short bt;
  
  bt = 0x70;
  prc->left = (ptile->wFlags & 7U) * 0xc6 + 4;
  prc->right = prc->left + 0xbe;
  prc->top = ptile->yTop;
  if (((uint)ptile->wFlags >> 7 & 1) == 0) {
    iVar1 = dyArial8 + 3;
  }
  else {
    iVar1 = ptile->dyFull;
  }
  prc->bottom = iVar1 + prc->top;
  if ((((uint)ptile->wFlags >> 0xc & 1) == 0) || (((uint)ptile->wFlags >> 9 & 1) != 0)) {
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      _Draw3dFrame();
    }
    rcT.left = prc->left;
    rcT.top = prc->top;
    rcT.right = prc->right;
    rcT.bottom = prc->bottom;
    ExpandRc(&rcT,-1,-1);
    rcT.bottom = rcT.top + dyArial8 + 2;
    SelectObject(hdc,rghfontArial8[1]);
    SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
    SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      _Draw3dFrame();
    }
    RcCtrTextOut(hdc,&rcT,pszTitle,-1);
    SetRect((RECT *)&rcT,prc->right + -0x11,prc->top + 1,prc->right,rcT.bottom + 1);
    if (((uint)ptile->wFlags >> 7 & 1) == 0) {
      bt = bt | 1;
    }
    DrawBtn(hdc,&rcT,bt,0,(char *)0x0);
    SelectObject(hdc,hbrButtonShadow);
    PatBlt(hdc,prc->right + -0x12,prc->top + 1,1,(rcT.bottom - prc->top) + -1,0xf00021);
  }
  prc->top = prc->top + dyArial8 + 4;
  return (uint)ptile->wFlags >> 7 & 1;
}



// ======================================================================
// Function: DrawPlanetMinSum
// Address: 1048:12b2
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Variable defined which should be unmapped: hbrSav */
/* WARNING: Variable defined which should be unmapped: xLeft */
/* WARNING: Variable defined which should be unmapped: i */
/* WARNING: Variable defined which should be unmapped: c */
/* WARNING: Variable defined which should be unmapped: xRight */

void DrawPlanetMinSum(HDC hdc,TILE *ptile,OBJ obj)

{
  short dxErase;
  char *pcVar1;
  short sVar2;
  int iVar3;
  ushort x;
  short sVar4;
  HGDIOBJ HVar5;
  uint uVar6;
  ushort unaff_SI;
  HDC unaff_DI;
  ulong uVar7;
  undefined2 uVar8;
  int iVar9;
  undefined2 uVar10;
  HDC HVar11;
  short in_stack_0000ffe4;
  int in_stack_0000ffe6;
  short in_stack_0000ffe8;
  HBRUSH hbrSav;
  short xLeft;
  short i;
  short c;
  short xRight;
  short yTop;
  short dxRight;
  
  if (((uint)ptile->wFlags >> 0xb & 1) != 0) {
    rgrcRef[6].top = -5;
    rgrcRef[6].bottom = -6;
    rgrcRef[7].top = -5;
    rgrcRef[7].bottom = -6;
    rgrcRef[8].top = -5;
    rgrcRef[8].bottom = -6;
    rgrcRef[9].top = -5;
    rgrcRef[9].bottom = -6;
    rgrcRef[0xb].top = -5;
    rgrcRef[0xb].bottom = -6;
    rgrcRef[10].top = -5;
    rgrcRef[10].bottom = -6;
  }
  pcVar1 = PszGetCompressedString(idsMineralsHand);
  sVar2 = FDrawTileNC(hdc,ptile,(RECT *)&stack0xffe4,pcVar1);
  dxErase = dxMaxMineralQuan;
  if (sVar2 != 0) {
    if (obj.ppl == (PLANET *)0x0) {
      obj.ppl = (PLANET *)&sel.pl;
    }
    iVar3 = in_stack_0000ffe4 + 4;
    x = in_stack_0000ffe8 - 4;
    SetRect(rgrcRef + 6,iVar3,in_stack_0000ffe6,x,
            dyArial8 * 3 + in_stack_0000ffe6);
    yTop = in_stack_0000ffe6;
    for (i = 0; i < 3; i = i + 1) {
      if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
        SelectObject(hdc,rghfontArial8[1]);
        SetTextColor(hdc,CONCAT22(*(undefined2 *)(i * 4 + 0x44a),*(undefined2 *)(i * 4 + 0x448)));
        pcVar1 = (char *)*(undefined2 *)(i * 2 + 0x4cc);
        uVar8 = 0x1120;
        sVar2 = yTop;
        iVar9 = iVar3;
        HVar11 = hdc;
        sVar4 = lstrlen((LPCSTR)(char *)*(undefined2 *)(i * 2 + 0x4cc));
        TextOut(HVar11,iVar9,sVar2,(LPCSTR)CONCAT22(uVar8,pcVar1),sVar4);
      }
      SelectObject(hdc,rghfontArial8[0]);
      SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
      uVar8 = *(undefined2 *)((int)((obj.ppl)->rgwtMin + i) + 2);
      uVar10 = (undefined2)(obj.ppl)->rgwtMin[i];
      pcVar1 = PszGetCompressedString(idsLdkt);
      in_stack_0000ffe8 = wsprintf(szWork,(char *)pcVar1,uVar10,uVar8);
      unaff_DI = hdc;
      unaff_SI = x;
      in_stack_0000ffe4 = yTop;
      RightTextOut(hdc,x,yTop,(char *)szWork,in_stack_0000ffe8,dxErase);
      yTop = yTop + dyArial8;
    }
    HVar5 = SelectObject(hdc,hbrButtonHilite);
    iVar9 = yTop + 1;
    PatBlt(hdc,in_stack_0000ffe4,yTop,in_stack_0000ffe8 - in_stack_0000ffe4,1,0xf00021);
    SelectObject(hdc,HVar5);
    SetRect(rgrcRef + 7,iVar3,iVar9,x,dyArial8 * 2 + iVar9);
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      sVar2 = CchGetString(idsMines4,(char *)szWork);
      TextOut(hdc,iVar3,iVar9,szWork,sVar2);
      SelectObject(hdc,rghfontArial8[0]);
    }
    sVar2 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (sVar2 == raMacintosh) {
      sVar2 = CMinesOperating((PLANET *)obj.ppl);
      pcVar1 = PszGetCompressedString(idsD);
      c = wsprintf(szWork,(char *)pcVar1,sVar2);
    }
    else {
      sVar2 = CMaxOperableMines((PLANET *)obj.ppl,idPlayer,0);
      uVar7 = __aFulshr(CONCAT22(unaff_DI,sVar2),unaff_SI);
      uVar6 = (uint)uVar7 & 0xfff;
      pcVar1 = PszGetCompressedString(idsDD);
      c = wsprintf(szWork,(char *)pcVar1,uVar6);
    }
    RightTextOut(hdc,x,iVar9,(char *)szWork,c,dxErase << 1);
    iVar9 = iVar9 + dyArial8;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      sVar2 = CchGetString(idsFactories4,(char *)szWork);
      TextOut(hdc,iVar3,iVar9,szWork,sVar2);
      SelectObject(hdc,rghfontArial8[0]);
    }
    sVar2 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (sVar2 == raMacintosh) {
      c = CchGetString(idsN,(char *)szWork);
    }
    else {
      sVar2 = CMaxOperableFactories((PLANET *)obj.ppl,idPlayer,0);
      __aFulshr(CONCAT22(obj.ppl,sVar2),HVar5);
      pcVar1 = PszGetCompressedString(idsDD);
      c = wsprintf(szWork,(char *)pcVar1);
    }
    RightTextOut(hdc,dxErase << 1,iVar9,(char *)szWork,c,dxErase << 1);
  }
  return;
}



// ======================================================================
// Function: DrawPlanetStats
// Address: 1048:1716
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10481c86) */
/* WARNING: Removing unreachable block (ram,0x10481af7) */
/* WARNING: Removing unreachable block (ram,0x10481ff2) */
/* WARNING: Removing unreachable block (ram,0x1048191e) */
/* WARNING: Removing unreachable block (ram,0x1048187a) */
/* WARNING: Removing unreachable block (ram,0x104817d6) */
/* WARNING: Removing unreachable block (ram,0x10481828) */
/* WARNING: Removing unreachable block (ram,0x104818cc) */
/* WARNING: Removing unreachable block (ram,0x10481970) */

void DrawPlanetStats(HDC hdc,TILE *ptile,OBJ obj)

{
  char *pcVar1;
  short sVar2;
  uint uVar3;
  StringId SVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  DWORD DVar5;
  ulong uVar6;
  long lVar7;
  short sVar8;
  ushort in_stack_0000ffb2;
  undefined2 in_stack_0000ffba;
  undefined2 in_stack_0000ffbc;
  ushort in_stack_0000ffbe;
  undefined4 in_stack_0000ffc6;
  HullSlotType HVar9;
  COMPART *local_32;
  undefined2 local_30;
  RECT rc;
  DWORD l;
  HBRUSH hbrSav;
  short xLeft;
  char *psz;
  short dRange;
  short cResAvail;
  float pct;
  short dRangeP;
  short cRes;
  short c;
  short xRight;
  short yTop;
  DWORD l2;
  short dxRight;
  
  pcVar1 = PszGetCompressedString(idsStatus);
  sVar2 = FDrawTileNC(hdc,ptile,&rc,pcVar1);
  if (sVar2 != 0) {
    xLeft = rc.left + 4;
    xRight = rc.right + -4;
    yTop = rc.top;
    SelectObject(hdc,rghfontArial8[1]);
    c = CchGetString(idsPopulation4,(char *)szWork);
    l = GetTextExtent(hdc,szWork,c);
    c = CchGetString(idsScannerType,(char *)szWork);
    l2 = GetTextExtent(hdc,szWork,c);
    if ((long)l < (long)l2) {
      l = l2;
    }
    c = CchGetString(idsScannerRange,(char *)szWork);
    DVar5 = GetTextExtent(hdc,szWork,c);
    if ((long)l < (long)DVar5) {
      l = DVar5;
    }
    l2 = DVar5;
    c = CchGetString(idsDefenses4,(char *)szWork);
    DVar5 = GetTextExtent(hdc,szWork,c);
    if ((long)l < (long)DVar5) {
      l = DVar5;
    }
    l2 = DVar5;
    c = CchGetString(idsDefenseType,(char *)szWork);
    DVar5 = GetTextExtent(hdc,szWork,c);
    if ((long)l < (long)DVar5) {
      l = DVar5;
    }
    l2 = DVar5;
    c = CchGetString(idsDefCoverage,(char *)szWork);
    DVar5 = GetTextExtent(hdc,szWork,c);
    if ((long)l < (long)DVar5) {
      l = DVar5;
    }
    l2 = DVar5;
    c = CchGetString(idsResourcesYear,(char *)szWork);
    DVar5 = GetTextExtent(hdc,szWork,c);
    if ((long)l < (long)DVar5) {
      l = DVar5;
    }
    dxRight = (xRight - xLeft) - (int)l;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      l2 = DVar5;
      c = CchGetString(idsPopulation4,(char *)szWork);
      TextOut(hdc,xLeft,yTop,szWork,c);
      DVar5 = l2;
    }
    l2 = DVar5;
    SelectObject(hdc,rghfontArial8[0]);
    SetRect(rgrcRef + 9,xLeft,yTop,xRight,yTop + dyArial8);
    uVar6 = __aFulmul(CONCAT22(sel.pl.rgwtMin[3]._2_2_,
                                       (undefined2)sel.pl.rgwtMin[3]),100);
    c = CommaFormatLong((char *)szWork,uVar6);
    RightTextOut(hdc,xRight,yTop,(char *)szWork,c,dxRight);
    yTop = yTop + dyArial8;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsResourcesYear,(char *)szWork);
      TextOut(hdc,xLeft,yTop,szWork,c);
      SelectObject(hdc,rghfontArial8[0]);
    }
    SetRect(rgrcRef + 8,xLeft,yTop,xRight,yTop + dyArial8);
    cResAvail = CResourcesAtPlanet(&sel.pl,idPlayer);
    cRes = cResAvail;
    uVar6 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffb2);
    if ((uVar6 & 1) == 0) {
      sVar2 = MulDiv(cRes,(int)*(char *)((int)&rgplr[0].pctResearch +
                                        idPlayer * 0xc0),100);
      cResAvail = cResAvail - sVar2;
    }
    sVar2 = cResAvail;
    sVar8 = cRes;
    pcVar1 = PszGetCompressedString(idsDD);
    c = wsprintf(szWork,(char *)pcVar1,sVar2,sVar8);
    RightTextOut(hdc,xRight,yTop,(char *)szWork,c,dxRight);
    yTop = yTop + dyArial8;
    hbrSav = SelectObject(hdc,hbrButtonHilite);
    sVar2 = yTop;
    yTop = yTop + 1;
    PatBlt(hdc,rc.left,sVar2,rc.right - rc.left,1,0xf00021);
    SelectObject(hdc,hbrSav);
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsScannerType,(char *)szWork);
      TextOut(hdc,xLeft,yTop,szWork,c);
      SelectObject(hdc,rghfontArial8[0]);
    }
    SetRect(rgrcRef + 0xb,xLeft,yTop,xRight,dyArial8 * 2 + yTop);
    sVar2 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (sVar2 == raMacintosh) {
      CchGetString(idsOrganic,(char *)szWork);
      dRange = GetPlanetScannerRange(&sel.pl,&dRangeP);
    }
    else {
      uVar6 = __aFulshr(CONCAT22(in_stack_0000ffbc,in_stack_0000ffba),in_stack_0000ffbe);
      if (((uint)uVar6 & 0x1f) == 0x1f) {
        CchGetString(idsNone4,(char *)szWork);
        dRange = 0;
      }
      else {
        LookupBestPlanetaryScanner((PART *)&stack0xffca);
        __fstrcpy(szWork,(char *)CONCAT22(local_30,local_32->szName));
        dRange = GetPlanetScannerRange(&sel.pl,&dRangeP);
      }
    }
    RightTextOut(hdc,xRight,yTop,(char *)szWork,0,dxRight);
    yTop = yTop + dyArial8;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsScannerRange,(char *)szWork);
      TextOut(hdc,xLeft,yTop,szWork,c);
      SelectObject(hdc,rghfontArial8[0]);
    }
    if (dRange < 1) {
      CchGetString(idsNone4,(char *)szWork);
      c = 0;
    }
    else if (dRangeP < 1) {
      if (dRange < 100) {
        sVar2 = dRange;
        pcVar1 = PszGetCompressedString(idsDLightYears);
        c = wsprintf(szWork,(char *)pcVar1,sVar2);
      }
      else {
        sVar2 = dRange;
        pcVar1 = PszGetCompressedString(idsDLY);
        c = wsprintf(szWork,(char *)pcVar1,sVar2);
      }
    }
    else {
      sVar2 = dRange;
      pcVar1 = PszGetCompressedString(idsDDLY);
      c = wsprintf(szWork,(char *)pcVar1,dRangeP,sVar2);
    }
    RightTextOut(hdc,xRight,yTop,(char *)szWork,c,dxRight);
    yTop = yTop + dyArial8;
    hbrSav = SelectObject(hdc,hbrButtonHilite);
    sVar2 = yTop;
    yTop = yTop + 1;
    PatBlt(hdc,rc.left,sVar2,rc.right - rc.left,1,0xf00021);
    SelectObject(hdc,hbrSav);
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsDefenses4,(char *)szWork);
      TextOut(hdc,xLeft,yTop,szWork,c);
    }
    SelectObject(hdc,rghfontArial8[0]);
    SetRect(rgrcRef + 10,xLeft,yTop,xRight,dyArial8 * 3 + yTop);
    sVar2 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (sVar2 == raMacintosh) {
      c = CchGetString(idsN,(char *)szWork);
    }
    else {
      sVar2 = CMaxOperableDefenses(&sel.pl,idPlayer,0);
      uVar3 = (uint)sel.pl.dwFlags & 0xfff;
      pcVar1 = PszGetCompressedString(idsDD);
      c = wsprintf(szWork,(char *)pcVar1,uVar3,sVar2);
    }
    RightTextOut(hdc,xRight,yTop,(char *)szWork,c,dxRight);
    yTop = yTop + dyArial8;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsDefenseType,(char *)szWork);
      TextOut(hdc,xLeft,yTop,szWork,c);
      SelectObject(hdc,rghfontArial8[0]);
    }
    if (((uint)sel.pl.dwFlags & 0xfff) == 0) {
      pcVar1 = (char *)szWork;
      sVar2 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
      if (sVar2 == raMacintosh) {
        SVar4 = idsN;
      }
      else {
        SVar4 = idsNone4;
      }
      CchGetString(SVar4,pcVar1);
      dRange = 0;
    }
    else {
      FGetBestDefensePart((PART *)&stack0xffca);
      __fstrcpy(szWork,(char *)CONCAT22(local_30,local_32->szName));
      dRange = 1;
    }
    RightTextOut(hdc,xRight,yTop,(char *)szWork,0,dxRight);
    yTop = yTop + dyArial8;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      SelectObject(hdc,rghfontArial8[1]);
      c = CchGetString(idsDefCoverage,(char *)szWork);
      TextOut(hdc,xLeft,yTop,szWork,c);
      SelectObject(hdc,rghfontArial8[0]);
    }
    if (dRange == 0) {
      pcVar1 = (char *)szWork;
      sVar2 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
      if (sVar2 == raMacintosh) {
        SVar4 = idsN;
      }
      else {
        SVar4 = idsNone4;
      }
      c = CchGetString(SVar4,pcVar1);
      psz = (char *)szWork;
    }
    else {
      CalcPctSurvive(&sel.pl,&pct,(float *)0x0);
      pct = DAT_1120_1d22 - pct;
      HVar9 = hstBomb|hstTorp|hstShield;
      sVar2 = 0;
      __ftol((double)(qword)CONCAT24(100,in_stack_0000ffc6));
      lVar7 = __ftol((double)CONCAT26(sVar2,CONCAT24(HVar9,in_stack_0000ffc6)));
      lVar7 = __ftol((double)CONCAT26(HVar9,CONCAT42(in_stack_0000ffc6,(int)lVar7)));
      c = wsprintf(szWork,(char *)PCTDXPCTDPCTPCT,(int)lVar7);
    }
    RightTextOut(hdc,xRight,yTop,(char *)szWork,c,dxRight);
  }
  return;
}



// ======================================================================
// Function: FGetBestDefensePart
// Address: 1048:21f6
// Segment: MEMORY_PLANET
// ======================================================================


short FGetBestDefensePart(PART *ppart)

{
  short sVar1;
  PART part;
  short i;
  short fRet;
  
  fRet = 1;
  part.hs.grhst = hstPlanetary;
  part.hs.wFlags = part.hs.wFlags & 0xff00U | 9;
  i = 0;
  while ((i < 5 && (sVar1 = FLookupPart(&part), sVar1 == 1))) {
    i = i + 1;
    part.hs.wFlags = part.hs.wFlags & 0xff00U | part.hs.wFlags + 1U & 0xff;
  }
  if (i < 1) {
    fRet = 0;
  }
  else {
    i = i + -1;
  }
  part.hs.wFlags = part.hs.wFlags & 0xff00U | i + 9U & 0xff;
  FLookupPart(&part);
  (ppart->hs).grhst = part.hs.grhst;
  (ppart->hs).wFlags = part.hs.wFlags;
  *(COMPART **)&ppart->pcom = (COMPART *)part.pcom;
  *(undefined2 *)((int)&ppart->pcom + 2) = part.pcom._2_2_;
  return fRet;
}



// ======================================================================
// Function: DrawPlanetStarbase
// Address: 1048:22cc
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1048252c) */
/* WARNING: Variable defined which should be unmapped: w */
/* WARNING: Variable defined which should be unmapped: xLeft */
/* WARNING: Variable defined which should be unmapped: hbrSav */

void DrawPlanetStarbase(HDC hdc,TILE *ptile,OBJ obj)

{
  undefined2 uVar1;
  int iVar2;
  char *pcVar3;
  short sVar4;
  int x;
  HGDIOBJ HVar5;
  short sVar6;
  SHDEF *pSVar7;
  int iVar8;
  undefined2 unaff_SS;
  DWORD DVar9;
  HULDEF *pHVar10;
  long lVar11;
  COLORREF CVar12;
  int in_stack_0000ffd2;
  int in_stack_0000ffd4;
  int in_stack_0000ffd6;
  int in_stack_0000ffd8;
  HBRUSH hbrSav;
  short xLeft;
  ushort w;
  undefined2 crForeSav;
  undefined2 local_18;
  SHDEF *lpshdef;
  short c;
  short xRight;
  short yTop;
  short bt;
  short iWarp;
  short dxRight;
  short fTwo;
  
  if (((uint)ptile->wFlags >> 0xb & 1) != 0) {
    rgrcRef[0xd].top = -5;
    rgrcRef[0xd].bottom = -6;
    rgrcRef[0xe].top = -5;
    rgrcRef[0xe].bottom = -6;
    rgrcRef[0x10].top = -5;
    rgrcRef[0x10].bottom = -6;
    rgrcRef[0xf].top = -5;
    rgrcRef[0xf].bottom = -6;
    ptile->wFlags = ptile->wFlags & 0xf7ff;
  }
  if (((uint)sel.pl.wFlags >> 9 & 1) == 0) {
    pcVar3 = PszGetCompressedString(idsStarbase2);
  }
  else {
    uVar1 = *(undefined2 *)(idPlayer * 4 + 0x14e);
    pSVar7 = (SHDEF *)(*(int *)(idPlayer * 4 + 0x14c) +
                      (sel.pl._44_2_ & 0xf) * 0x93);
    lpshdef = (SHDEF *)CONCAT22(uVar1,pSVar7);
    __fstrcpy(szWork,(char *)CONCAT22(uVar1,(pSVar7->hul).szClass));
    pcVar3 = (char *)szWork;
  }
  sVar4 = FDrawTileNC(hdc,ptile,(RECT *)&stack0xffd2,pcVar3);
  if (sVar4 != 0) {
    xLeft = in_stack_0000ffd2 + 4;
    x = in_stack_0000ffd6 + -4;
    SetRect((RECT *)(RECT *)&stack0xffd2,in_stack_0000ffd2 + 2,in_stack_0000ffd4,
            in_stack_0000ffd6 + -2,in_stack_0000ffd8 + -2);
    FillRect(hdc,(RECT *)(RECT *)&stack0xffd2,hbrButtonFace);
    if (((uint)sel.pl.wFlags >> 9 & 1) == 0) {
      SetRect(rgrcRef + 0xe,-5,-5,-6,-6);
      rgrcRef[0xf].left = rgrcRef[0xe].left;
      rgrcRef[0xf].top = rgrcRef[0xe].top;
      rgrcRef[0xf].right = rgrcRef[0xe].right;
      rgrcRef[0xf].bottom = rgrcRef[0xe].bottom;
      rgrcRef[0x10].left = rgrcRef[0xe].left;
      rgrcRef[0x10].top = rgrcRef[0xe].top;
      rgrcRef[0x10].right = rgrcRef[0xe].right;
      rgrcRef[0x10].bottom = rgrcRef[0xe].bottom;
    }
    else {
      SetRect(rgrcRef + 0xe,xLeft,in_stack_0000ffd4,x,
              dyArial8 * 4 + in_stack_0000ffd4);
      SelectObject(hdc,rghfontArial8[1]);
      sVar4 = CchGetString(idsDockCapacity,(char *)szWork);
      DVar9 = GetTextExtent(hdc,szWork,sVar4);
      iVar8 = (x - xLeft) - (int)DVar9;
      TextOut(hdc,xLeft,in_stack_0000ffd4,szWork,sVar4);
      SelectObject(hdc,rghfontArial8[0]);
      pHVar10 = LphuldefFromId((lpshdef->hul).ihuldef);
      iVar2 = (((HULDEF *)pHVar10)->hul).wtCargoMax;
      if (iVar2 == 0) {
        c = CchGetString(idsNone4,(char *)szWork);
      }
      else if (iVar2 == -1) {
        c = CchGetString(idsUnlimited,(char *)szWork);
      }
      else {
        c = wsprintf(szWork,(char *)PCTDKT,iVar2);
      }
      RightTextOut(hdc,x,in_stack_0000ffd4,(char *)szWork,c,iVar8);
      in_stack_0000ffd4 = in_stack_0000ffd4 + dyArial8;
      SelectObject(hdc,rghfontArial8[1]);
      sVar4 = CchGetString(idsArmor2,(char *)szWork);
      TextOut(hdc,xLeft,in_stack_0000ffd4,szWork,sVar4);
      if ((((SHDEF *)lpshdef)->hul).dp == 0) {
        c = CchGetString(idsNone4,(char *)szWork);
      }
      else {
        pcVar3 = PszGetCompressedString(idsLddp);
        c = wsprintf(szWork,(char *)pcVar3);
      }
      SelectObject(hdc,rghfontArial8[0]);
      RightTextOut(hdc,x,in_stack_0000ffd4,(char *)szWork,c,iVar8);
      in_stack_0000ffd4 = in_stack_0000ffd4 + dyArial8;
      SelectObject(hdc,rghfontArial8[1]);
      sVar4 = CchGetString(idsShields2,(char *)szWork);
      TextOut(hdc,xLeft,in_stack_0000ffd4,szWork,sVar4);
      lVar11 = DpShieldOfShdef(lpshdef,idPlayer);
      if (lVar11 == 0) {
        c = CchGetString(idsNone4,(char *)szWork);
      }
      else {
        pcVar3 = PszGetCompressedString(idsLddp);
        c = wsprintf(szWork,(char *)pcVar3);
      }
      SelectObject(hdc,rghfontArial8[0]);
      RightTextOut(hdc,x,in_stack_0000ffd4,(char *)szWork,c,iVar8);
      in_stack_0000ffd4 = in_stack_0000ffd4 + dyArial8;
      SelectObject(hdc,rghfontArial8[1]);
      sVar4 = CchGetString(idsDamage2,(char *)szWork);
      TextOut(hdc,xLeft,in_stack_0000ffd4,szWork,sVar4);
      SelectObject(hdc,rghfontArial8[0]);
      if ((uint)sel.pl._44_2_ >> 4 == 0) {
        c = CchGetString(idsNone4,(char *)szWork);
        CVar12 = CONCAT22(local_18,crForeSav);
        w = 0;
      }
      else {
        c = wsprintf(szWork,(char *)PCTDPCTPCT);
        w = hdc;
        xLeft = 0x7f;
        CVar12 = SetTextColor(hdc,0x7f);
      }
      RightTextOut(hdc,x,in_stack_0000ffd4,(char *)szWork,c,iVar8);
      in_stack_0000ffd4 = in_stack_0000ffd4 + dyArial8;
      if (w != 0) {
        SetTextColor(hdc,CVar12);
      }
      sVar4 = 0x2804;
      HVar5 = SelectObject(hdc,hbrButtonHilite);
      iVar2 = in_stack_0000ffd4 + 1;
      PatBlt(hdc,sVar4,in_stack_0000ffd4,0,1,0xf00021);
      SelectObject(hdc,HVar5);
      SelectObject(hdc,rghfontArial8[1]);
      SetRect(rgrcRef + 0x10,xLeft,iVar2,x,iVar2 + dyArial8);
      sVar4 = CchGetString(idsMassDriver,(char *)szWork);
      TextOut(hdc,xLeft,iVar2,szWork,sVar4);
      sVar4 = IWarpMAFromLppl(&sel.pl,&fTwo);
      if (sVar4 < 1) {
        pcVar3 = PszGetCompressedString(idsNone4);
        c = wsprintf(szWork,(char *)pcVar3);
      }
      else {
        pcVar3 = PszGetCompressedString(idsWarpD);
        c = wsprintf(szWork,(char *)pcVar3);
        if (fTwo != 0) {
          ((char *)szWork)[c] = '+';
          c = c + 1;
        }
      }
      SelectObject(hdc,rghfontArial8[0]);
      RightTextOut(hdc,x,iVar2,(char *)szWork,c,iVar8);
      iVar2 = iVar2 + dyArial8;
      SelectObject(hdc,rghfontArial8[1]);
      sVar6 = CchGetString(idsDestination3,(char *)szWork);
      TextOut(hdc,0x14f8,iVar2,szWork,sVar6);
      if ((sel.pl.wFlags & 0x3ffU) == 0) {
        c = CchGetString(idsNone4,(char *)szWork);
      }
      else {
        pcVar3 = PszGetCompressedPlanet
                           (((short *)rgidPlan)[(sel.pl.wFlags & 0x3ffU) - 1]);
        c = 0;
        _strcpy((char *)szWork,pcVar3);
      }
      SelectObject(hdc,rghfontArial8[0]);
      RightTextOut(hdc,x,iVar2,(char *)szWork,c,iVar8);
      iVar2 = iVar2 + dyArial8;
      iVar8 = (in_stack_0000ffd6 + -0x57a8) / 3;
      SetRect(rgrcRef + 0xd,0x57a4,iVar2,(short)((char *)szWork + iVar8),
              iVar2 + dyArial8 + 6);
      bt = 8;
      if (sVar4 == 0) {
        bt = 0xc;
      }
      pcVar3 = PszGetCompressedString(idsSetDest);
      DrawBtn(hdc,(RECT *)(rgrcRef + 0xd),bt,(uint)gd.wFlags >> 8 & 1,
                       pcVar3);
      if (sVar4 < 1) {
        SetRect(rgrcRef + 0xf,-5,-5,-6,-6);
        rgrcRef[0x10].left = rgrcRef[0xf].left;
        rgrcRef[0x10].top = rgrcRef[0xf].top;
        rgrcRef[0x10].right = rgrcRef[0xf].right;
        rgrcRef[0x10].bottom = rgrcRef[0xf].bottom;
      }
      else {
        SetRect(rgrcRef + 0xf,bt + iVar8 + 4,iVar2 + 3,x,iVar2 + dyArial8 + 3);
        if (fTwo != 0) {
          sVar4 = -sVar4;
        }
        DrawMassWarpGauge(hdc,(RECT *)(rgrcRef + 0xf),sVar4,
                          ((uint)sel.pl.wFlags >> 10 & 0xf) + 4);
      }
    }
  }
  return;
}



// ======================================================================
// Function: DrawMassWarpGauge
// Address: 1048:2afa
// Segment: MEMORY_PLANET
// ======================================================================


void DrawMassWarpGauge(HDC hdc,RECT *prc,short iBest,short iCur)

{
  uint uVar1;
  char *pcVar2;
  long lVar3;
  undefined4 uVar4;
  int iVar5;
  HBRUSH hbr;
  short iMode;
  short fTwoMAs;
  short c;
  int lMax;
  int local_6;
  
  fTwoMAs = (short)(iBest < 0);
  SelectObject(hdc,rghfontArial8[1]);
  if (iCur < 5) {
    iCur = 5;
  }
  if (iBest < 0) {
    iBest = -iBest;
  }
  lMax = iBest + -1;
  local_6 = lMax >> 0xf;
  if (iBest + fTwoMAs < iCur) {
    if (iCur < iBest + fTwoMAs + 3) {
      hbr = hbrYellow;
    }
    else {
      hbr = hbrRed;
    }
  }
  else {
    hbr = hbrPurple;
  }
  lVar3 = LDrawGauge(hdc,prc,1,(long *)&stack0xffec,&hbr,(long)lMax);
  uVar1 = (uint)lVar3;
  iVar5 = (int)((ulong)lVar3 >> 0x10);
  iMode = SetBkMode(hdc,1);
  uVar4 = CONCAT22(iVar5 + (uint)(0xfffb < uVar1),uVar1 + 4);
  pcVar2 = PszGetCompressedString(idsWarpLd);
  c = wsprintf(szWork,(char *)pcVar2,uVar4);
  GetTextExtent(hdc,szWork,c);
  RcCtrTextOut(hdc,prc,(char *)szWork,c);
  SetBkMode(hdc,iMode);
  return;
}



// ======================================================================
// Function: DrawPlanetProduction
// Address: 1048:2c38
// Segment: MEMORY_PLANET
// ======================================================================


void DrawPlanetProduction(HDC hdc,TILE *ptile,OBJ obj)

{
  char *pcVar1;
  short sVar2;
  int iVar3;
  BOOL BVar4;
  undefined2 unaff_SS;
  LRESULT LVar5;
  DWORD DVar6;
  RECT rc;
  PLANET *ppl;
  RECT rcT;
  short xLeft;
  short cch;
  short iSel;
  char *psz;
  short dyWrong;
  short c;
  short i;
  char szT [40];
  short xRight;
  short xStart;
  short yTop;
  short dxRight;
  short swp;
  
  ppl = obj.ppl;
  if (((uint)ptile->wFlags >> 0xb & 1) != 0) {
    ShowWindow(hwndPlanetProdLB,0);
    ShowWindow(rghwndBtn[0xb],0);
    ShowWindow(rghwndBtn[0xc],0);
    rgrcRef[0x11].top = -5;
    rgrcRef[0x11].bottom = -6;
    ptile->wFlags = ptile->wFlags & 0xf7ff;
  }
  pcVar1 = PszGetCompressedString(idsProduction);
  sVar2 = FDrawTileNC(hdc,ptile,&rc,pcVar1);
  if (sVar2 == 0) {
    ShowWindow(hwndPlanetProdLB,0);
    ShowWindow(rghwndBtn[0xb],0);
    ShowWindow(rghwndBtn[0xc],0);
  }
  else {
    xLeft = rc.left + 4;
    xRight = rc.right + -4;
    yTop = rc.top + 4;
    GetClientRect(hwndPlanetProdLB,(RECT *)&rcT);
    swp = 0x14;
    if (((uint)gd.wFlags >> 3 & 1) == 0) {
      iVar3 = 5;
    }
    else {
      iVar3 = 3;
    }
    dyPlanetProdLB = (dyArial8 + 2) * iVar3;
    dyWrong = dyPlanetProdLB - (rcT.bottom - rcT.top);
    if (((dxPlanetProdLB == xRight - xLeft) && (-1 < dyWrong)) &&
       (dyWrong < dyArial8)) {
      swp = 0x15;
    }
    else {
      dxPlanetProdLB = xRight - xLeft;
    }
    SetWindowPos(hwndPlanetProdLB,0,xLeft,yTop,xRight - xLeft,dyPlanetProdLB,swp);
    ShowWindow(hwndPlanetProdLB,5);
    GetClientRect(hwndPlanetProdLB,(RECT *)&rcT);
    dyPlanetProdLB = rcT.bottom - rcT.top;
    yTop = yTop + dyPlanetProdLB + 4;
    LVar5 = SendMessage(hwndPlanetProdLB,0x409,0,0);
    iSel = (short)LVar5;
    if (iSel < 0) {
      iSel = 0;
    }
    if (((*(int *)&ppl->lpplprod == 0) && (*(int *)((int)&ppl->lpplprod + 2) == 0)) ||
       (((PLPROD *)ppl->lpplprod)->iprodMac == 0)) {
      c = 0;
      szWork[0] = '\0';
    }
    else {
      psz = PszProductionETA((PLANET *)ppl,(PLPROD *)0x0,iSel,(short *)0x0,(short *)0x0);
      c = _strlen(psz);
    }
    if (c == 0) {
      RightTextOut(hdc,xRight,yTop,(char *)szWork,0,xRight - xLeft);
    }
    else {
      SelectObject(hdc,rghfontArial8[1]);
      cch = CchGetString(idsCompletion,szT);
      TextOut(hdc,xLeft,yTop,(LPCSTR)szT,cch);
      DVar6 = GetTextExtent(hdc,(LPCSTR)szT,cch);
      dxRight = (xRight - xLeft) - (int)DVar6;
      SelectObject(hdc,rghfontArial8[0]);
      RightTextOut(hdc,xRight,yTop,(char *)szWork,c,dxRight);
    }
    yTop = yTop + dyArial8;
    SelectObject(hdc,rghfontArial8[1]);
    cch = CchGetString(idsRoute3,szT);
    TextOut(hdc,xLeft,yTop,(LPCSTR)szT,cch);
    DVar6 = GetTextExtent(hdc,(LPCSTR)szT,cch);
    dxRight = (xRight - xLeft) - (int)DVar6;
    if ((sel.pl.wRouting & 0x3ffU) == 0) {
      c = CchGetString(idsNone4,(char *)szWork);
    }
    else {
      psz = PszGetCompressedPlanet
                      (((short *)rgidPlan)[(sel.pl.wRouting & 0x3ffU) - 1]);
      c = 0;
      _strcpy((char *)szWork,psz);
    }
    SelectObject(hdc,rghfontArial8[0]);
    RightTextOut(hdc,xRight,yTop,(char *)szWork,c,dxRight);
    yTop = yTop + dyArial8;
    c = ((xRight - xLeft) + -0x10) / 3;
    xStart = xLeft;
    for (i = 0xb; i < 0xd; i = i + 1) {
      SetWindowPos(((ushort *)rghwndBtn)[i],0,xStart,yTop,c,
                   (dyArial8 >> 1) + dyArial8,0x14);
      ShowWindow(((ushort *)rghwndBtn)[i],5);
      xStart = xStart + c + 8;
    }
    if ((((PLPROD *)sel.pl.lpplprod == (PLPROD *)0x0) &&
        (sel.pl.lpplprod._2_2_ == 0)) ||
       (((PLPROD *)sel.pl.lpplprod)->iprodMac == 0)) {
      BVar4 = 0;
    }
    else {
      BVar4 = 1;
    }
    EnableWindow(rghwndBtn[0xc],BVar4);
    SetRect(rgrcRef + 0x11,xStart,yTop,xStart + c,
            yTop + dyArial8 + (dyArial8 >> 1));
    pcVar1 = PszGetCompressedString(idsRoute2);
    DrawBtn(hdc,(RECT *)(rgrcRef + 0x11),8,(uint)gd.wFlags >> 0xd & 1,
                     pcVar1);
  }
  return;
}



// ======================================================================
// Function: PszProductionETA
// Address: 1048:310c
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104831ef) */
/* WARNING: Removing unreachable block (ram,0x104831f4) */
/* WARNING: Removing unreachable block (ram,0x104831bc) */
/* WARNING: Variable defined which should be unmapped: ids */

char * PszProductionETA(PLANET *lppl,PLPROD *lpplprod,short iItem,short *etaFirst,short *etaLast)

{
  short sVar1;
  char *pcVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar3;
  ulong uVar4;
  short sVar5;
  short ids;
  short c;
  short iTurnBegin;
  short iTurnEnd;
  
  uVar4 = CONCAT22(unaff_SI,unaff_DI);
  if (((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) {
                    /* WARNING: Load size is inaccurate */
    lpplprod = (PLPROD *)
               CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                        ((PLANET *)lppl)->lpplprod);
  }
  EstimateItemProdSched(lppl,lpplprod,iItem,&iTurnBegin,&iTurnEnd);
  if (iTurnBegin == 100) {
    if (((((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) ||
        ((int)(uint)((PLPROD *)lpplprod)->iprodMac <= iItem)) ||
       ((uVar3 = __aFulshr(uVar4,ids), ((uint)uVar3 & 7) != 1 ||
        (uVar4 = __aFulshr(uVar4,ids), 6 < ((uint)uVar4 & 0x7f))))) {
      ids = 0x332;
    }
    else {
      ids = 0x254;
    }
    CchGetString(ids,(char *)szWork);
  }
  else if (iTurnEnd == 100) {
    sVar1 = iTurnBegin;
    pcVar2 = PszGetCompressedString(idsDYears);
    wsprintf(szWork,(char *)pcVar2,sVar1);
  }
  else if (iTurnBegin == iTurnEnd) {
    if (iTurnBegin == 0) {
      CchGetString(idsSkipped,(char *)szWork);
    }
    else if (iTurnBegin == -1) {
      CchGetString(idsNeeded,(char *)szWork);
    }
    else {
      sVar1 = iTurnBegin;
      pcVar2 = PszGetCompressedString(idsDYear);
      sVar1 = wsprintf(szWork,(char *)pcVar2,sVar1);
      if (iTurnBegin != 1) {
        ((char *)szWork)[sVar1] = 's';
        ((char *)szWork + 1)[sVar1] = '\0';
      }
    }
  }
  else {
    sVar1 = iTurnBegin;
    sVar5 = iTurnEnd;
    pcVar2 = PszGetCompressedString(idsDDYears);
    wsprintf(szWork,(char *)pcVar2,sVar1,sVar5);
  }
  if (etaFirst != (short *)0x0) {
    *etaFirst = iTurnBegin;
  }
  if (etaLast != (short *)0x0) {
    *etaLast = iTurnEnd;
  }
  return (char *)szWork;
}



// ======================================================================
// Function: DrawPlanShipBitmap
// Address: 1048:3336
// Segment: MEMORY_PLANET
// ======================================================================


void DrawPlanShipBitmap(HDC hdc,TILE *ptile,OBJ obj)

{
  short sVar1;
  int iVar2;
  RECT rc;
  short iOffset;
  HBRUSH hbrSav;
  short xLeft;
  short dx;
  char *psz;
  short i;
  short xRight;
  short dy;
  short yTop;
  
  if (sel.grobj == grobjPlanet) {
    psz = PszGetPlanetName((obj.ppl)->id);
    i = (obj.ppl)->id + 8;
    iOffset = i % 0x1c;
  }
  else {
    psz = PszGetFleetName((obj.ppl)->id);
  }
  if (((uint)ptile->wFlags >> 0xb & 1) != 0) {
    for (i = 4; i < 7; i = i + 1) {
      ShowWindow(((ushort *)rghwndBtn)[i],0);
    }
    ptile->wFlags = ptile->wFlags & 0xf7ff;
  }
  sVar1 = FDrawTileNC(hdc,ptile,&rc,psz);
  if (sVar1 == 0) {
    for (i = 4; i < 7; i = i + 1) {
      ShowWindow(((ushort *)rghwndBtn)[i],0);
    }
  }
  else {
    xLeft = rc.left + 0xc;
    xRight = rc.right + -0xc;
    if (((uint)gd.wFlags >> 3 & 1) == 0) {
      iVar2 = 6;
    }
    else {
      iVar2 = 2;
    }
    yTop = iVar2 + rc.top;
    if (sel.grobj == grobjFleet) {
      DrawFleetBitmap(&sel.fl,hdc,xLeft,yTop,1,-1,0,0,-1,0);
    }
    else {
      hbrSav = SelectObject(hdc,hbrButtonShadow);
      PatBlt(hdc,xLeft,yTop,0x46,2,0xf00021);
      PatBlt(hdc,xLeft,yTop + 2,2,0x44,0xf00021);
      SelectObject(hdc,hbrButtonHilite);
      PatBlt(hdc,xLeft + 2,yTop + 0x44,0x44,2,0xf00021);
      PatBlt(hdc,xLeft + 0x44,yTop + 2,2,0x42,0xf00021);
      PatBlt(hdc,xLeft + 1,yTop + 0x45,1,1,0xf00021);
      PatBlt(hdc,xLeft + 0x45,yTop + 1,1,1,0xf00021);
      PatBlt(hdc,xLeft + 2,yTop + 2,0x42,1,0x42);
      PatBlt(hdc,xLeft + 2,yTop + 3,1,0x41,0x42);
      PatBlt(hdc,xLeft + 3,yTop + 0x43,0x41,1,0x42);
      PatBlt(hdc,xLeft + 0x43,yTop + 3,1,0x40,0x42);
      SelectObject(hdc,hbrSav);
      SelectPalette(hdc,vhpal,0);
      RealizePalette(hdc);
      DibBlt(hdc,xLeft + 3,yTop + 3,0x40,0x40,hdibPlanets,iOffset % 7 << 6,
                      iOffset / 7 << 6,0x40,0x40,0xcc0020);
    }
    dx = (xRight - xLeft) + -0x5f;
    dy = dyArial8 * 3 >> 1;
    xLeft = xRight - dx;
    if (((uint)ptile->wFlags >> 0xc & 1) == 0) {
      if (((uint)gd.wFlags >> 3 & 1) == 0) {
        yTop = yTop + -4;
      }
      else {
        yTop = yTop + -2;
        dy = dy + -2;
      }
      if (sel.grobj == grobjFleet) {
        iOffset = 6;
      }
      else {
        iOffset = 5;
      }
      i = 4;
      while (i <= iOffset) {
        SetWindowPos(((ushort *)rghwndBtn)[i],0,xLeft,yTop,dx,dy,0x14);
        ShowWindow(((ushort *)rghwndBtn)[i],5);
        i = i + 1;
        if (((uint)gd.wFlags >> 3 & 1) == 0) {
          iVar2 = 3;
        }
        else {
          iVar2 = 2;
        }
        yTop = yTop + iVar2 + dy;
      }
    }
  }
  return;
}



// ======================================================================
// Function: DrawPlanetShipList
// Address: 1048:377e
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10483b12) */

void DrawPlanetShipList(HDC hdc,TILE *ptile,OBJ obj)

{
  DWORD DVar1;
  StringId ids;
  char *pszTitle;
  short sVar2;
  BOOL BVar3;
  undefined2 unaff_SS;
  RECT rc;
  undefined4 l;
  short xLeft;
  long lSel;
  PLANET *pfl;
  undefined1 xf [4];
  FLEET local_a0;
  RECT rcGauge;
  short c;
  short i;
  short xRight;
  short xStart;
  short idSkip;
  short fUnknown;
  short fObjIsThing;
  short yTop;
  undefined4 l2;
  short fDoneDrawing;
  short swp;
  
  pfl = obj.ppl;
  fDoneDrawing = 0;
  fObjIsThing = 0;
  if (((uint)ptile->wFlags >> 0xb & 1) != 0) {
    for (i = 0; i < 3; i = i + 1) {
      ShowWindow(((ushort *)rghwndBtn)[i],0);
    }
    ShowWindow(hwndShipDD,0);
    ptile->wFlags = ptile->wFlags & 0xf7ff;
    rgrcRef[1].top = -5;
    rgrcRef[1].bottom = -6;
    rgrcRef[4].top = -5;
    rgrcRef[4].bottom = -6;
  }
  if (pfl == (PLANET *)0x0) {
    ids = idsFleetsOrbit;
  }
  else {
    ids = idsOtherFleetsHere;
  }
  pszTitle = PszGetCompressedString(ids);
  sVar2 = FDrawTileNC(hdc,ptile,&rc,pszTitle);
  if (sVar2 == 0) {
    for (i = 0; i < 3; i = i + 1) {
      ShowWindow(((ushort *)rghwndBtn)[i],0);
    }
    ShowWindow(hwndShipDD,0);
  }
  else {
    xLeft = rc.left + 4;
    xRight = rc.right + -4;
    yTop = rc.top + 2;
    swp = 0x14;
    if (dxShipDD == xRight - xLeft) {
      swp = 0x15;
    }
    else {
      dxShipDD = xRight - xLeft;
    }
    SetWindowPos(hwndShipDD,0,xLeft,yTop,xRight - xLeft,dyShipDD * 5,swp);
    ShowWindow(hwndShipDD,5);
    yTop = yTop + dyShipDD + 3;
    lSel = SendMessage(hwndShipDD,0x407,0,0);
    EnableWindow(rghwndBtn[0],(uint)(lSel != -1));
    if (lSel == -1) {
      fDoneDrawing = 1;
      fUnknown = 1;
    }
    if (pfl == (PLANET *)0x0) {
      idSkip = -1;
    }
    else {
      idSkip = pfl->id;
    }
    if (fDoneDrawing == 0) {
      sVar2 = sel.pl.id;
      if (idSkip != -1) {
        sVar2 = *(short *)pfl->rgpctMinLevel;
      }
      sVar2 = FLookupOrbitingXfer(sVar2,(short)lSel,(XFER *)xf,idSkip);
      if (sVar2 == 0) {
        fDoneDrawing = 1;
      }
    }
    if (fDoneDrawing == 0) {
      fObjIsThing = (short)(xf._2_2_ == grobjThing);
      if ((fObjIsThing == 0) && (local_a0.iPlayer == idPlayer)) {
        BVar3 = 1;
      }
      else {
        BVar3 = 0;
      }
      EnableWindow(rghwndBtn[1],BVar3);
    }
    else {
      EnableWindow(rghwndBtn[1],0);
    }
    DVar1 = CONCAT22(l._2_2_,(int)l);
    rgrcRef[1].top = -5;
    rgrcRef[1].bottom = -6;
    rgrcRef[4].top = -5;
    rgrcRef[4].bottom = -6;
    if ((fObjIsThing == 0) && ((local_a0.wFlags & 0xffU) != 7)) {
      fUnknown = 1;
    }
    else {
      fUnknown = 0;
    }
    if (((uint)gd.wFlags >> 3 & 1) == 0) {
      if ((fDoneDrawing == 0) && (l = DVar1, fUnknown == 0)) {
        SelectObject(hdc,rghfontArial8[1]);
        c = CchGetString(idsCargo3,(char *)szWork);
        l = GetTextExtent(hdc,szWork,c);
      }
      if (((fDoneDrawing == 0) && (fUnknown == 0)) && (fObjIsThing == 0)) {
        c = CchGetString(idsFuel3,(char *)szWork);
        l2 = GetTextExtent(hdc,szWork,c);
        if ((long)l < (long)l2) {
          l = l2;
        }
        TextOut(hdc,xLeft,yTop,szWork,c);
        SetRect((RECT *)&rcGauge,xLeft + (int)l,yTop,xRight,yTop + dyArial8);
        if (idSkip != -1) {
          rgrcRef[1].left = rcGauge.left;
          rgrcRef[1].top = rcGauge.top;
          rgrcRef[1].right = rcGauge.right;
          rgrcRef[1].bottom = rcGauge.bottom;
        }
        DrawFleetGauge(hdc,&rcGauge,(FLEET *)(FLEET *)(xf + 4),4);
      }
      else if ((((uint)ptile->wFlags >> 0xc & 1) != 0) || (fUnknown != (gd._0_2_ & 1))) {
        SetRect((RECT *)&rcGauge,xLeft,yTop,xRight,dyArial8 * 2 + yTop + 8);
        FillRect(hdc,(RECT *)&rcGauge,hbrButtonFace);
      }
      gd._0_2_ = gd._0_2_ & 0xfffe | fUnknown & 1U;
      if (fObjIsThing == 0) {
        yTop = yTop + dyArial8 + 4;
      }
      if ((fDoneDrawing == 0) && (fUnknown == 0)) {
        c = CchGetString(idsCargo3,(char *)szWork);
        TextOut(hdc,xLeft,yTop,szWork,c);
        SetRect((RECT *)&rcGauge,xLeft + (int)l,yTop,xRight,yTop + dyArial8);
        rgrcRef[4].left = rcGauge.left;
        rgrcRef[4].top = rcGauge.top;
        rgrcRef[4].right = rcGauge.right;
        rgrcRef[4].bottom = rcGauge.bottom;
        if (fObjIsThing == 0) {
          DrawFleetGauge(hdc,&rcGauge,(FLEET *)(FLEET *)(xf + 4),5);
        }
        else {
          DrawThingGauge(hdc,&rcGauge,(THING *)(THING *)(xf + 4),5);
        }
        if (fObjIsThing != 0) {
          OffsetRect((RECT *)&rcGauge,0,dyArial8 + 4);
          FillRect(hdc,(RECT *)&rcGauge,hbrButtonFace);
          yTop = yTop + dyArial8 + 4;
        }
      }
      yTop = yTop + dyArial8 + 4;
      DVar1 = l;
    }
    c = ((xRight - xLeft) + -10) / 3;
    xStart = xLeft;
    for (i = 0; l = DVar1, i < 3; i = i + 1) {
      SetWindowPos(((ushort *)rghwndBtn)[(i + 1) % 3],0,xStart,yTop,c,
                   (dyArial8 >> 1) + dyArial8,0x14);
      if ((i != 2) || (DVar1 = l, pfl != (PLANET *)0x0)) {
        ShowWindow(((ushort *)rghwndBtn)[i],5);
        DVar1 = l;
      }
      xStart = xStart + c + 6;
    }
    if (((idSkip == -1) || (fUnknown == 0)) && (fObjIsThing == 0)) {
      BVar3 = 1;
    }
    else {
      BVar3 = 0;
    }
    EnableWindow(rghwndBtn[2],BVar3);
  }
  return;
}



// ======================================================================
// Function: SetPlanetTitleBar
// Address: 1048:3dec
// Segment: MEMORY_PLANET
// ======================================================================


void SetPlanetTitleBar(HWND hwnd)

{
  char *pcVar1;
  undefined2 unaff_SS;
  char *psz;
  char szTitle [32];
  
  if (sel.grobj == grobjPlanet) {
    pcVar1 = PszGetPlanetName(sel.pl.id);
    CchGetString(idsPlanet2,szTitle);
    lstrcat((LPSTR)szTitle,(LPCSTR)pcVar1);
    psz = szTitle;
  }
  else if (sel.grobj == grobjFleet) {
    psz = PszGetFleetName(sel.fl.id);
  }
  else {
    psz = PszGetCompressedString(idsPlanetView);
  }
  SetWindowText(hwnd,(LPCSTR)psz);
  return;
}



// ======================================================================
// Function: ChangeMainObjSel
// Address: 1048:3e7a
// Segment: MEMORY_PLANET
// ======================================================================


void ChangeMainObjSel(short grobjNew,short iObjSel)

{
  FLEET *pFVar1;
  int iVar2;
  short sVar3;
  bool bVar4;
  FLEET *lpfl;
  short i;
  short idSkip;
  short fSameType;
  
  idSkip = -1;
  bVar4 = grobjNew == sel.grobj;
  if (((fAi == 0) || (!bVar4)) || (iObjSel != sel.id)) {
    InvalidateReport((uint)(sel.grobj != grobjPlanet),0);
    if (grobjNew == 1) {
      InvalidateReport(0,0);
      sVar3 = FLookupPlanet(iObjSel,(PLANET *)&sel.pl);
      if (sVar3 == 0) {
        return;
      }
      sel.pt.x = ((POINT *)rgptPlan + iObjSel)->x;
      sel.pt.y = *(short *)((int)&rgptPlan[0].y + iObjSel * 4);
      sel.scan.iwp = -1;
      sel.iwpAct = -1;
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar1 = ((FLEET **)rglpfl)[i];
        iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
        if (((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) ||
           ((pFVar1->idPlanet == iObjSel && (pFVar1->iPlayer == idPlayer)))) break;
      }
      if (i == cFleet) {
        sel.fl.id = -1;
        sel.grobjFull = grobjPlanet;
      }
      else {
        FDupFleet(lpfl,(FLEET *)&sel.fl);
        sel.grobjFull = grobjFleet|grobjPlanet;
      }
      if (fAi == 0) {
        FillPlanetProdLB(0,(PLPROD *)0x0,(PLANET *)0x0);
        SendMessage(hwndPlanetProdLB,0x407,0,0);
      }
    }
    else {
      InvalidateReport(1,0);
      sVar3 = FLookupFleet(iObjSel,(FLEET *)&sel.fl);
      if (sVar3 == 0) {
        return;
      }
      sel.pt.x = sel.fl.pt.x;
      sel.pt.y = sel.fl.pt.y;
      if ((sel.fl.idPlanet == -1) ||
         ((sel.fl.idPlanet != sel.pl.id &&
          (sVar3 = FLookupPlanet(sel.fl.idPlanet,(PLANET *)&sel.pl),
          sVar3 == 0)))) {
        sel.pl.id = -1;
      }
      sel.grobjFull = sel.pl.id != -1 | grobjFleet;
      sel.iwpAct = 0;
      if (fAi == 0) {
        FillOrdersLB();
        FillFleetCompLB();
        FillBattleDD(sel.fl.iplan + 1);
        idSkip = iObjSel;
        SendMessage(rghwndOrderDD[0],0x40e,
                    *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xf,0);
      }
    }
    sel.grobj = grobjNew;
    sel.id = iObjSel;
    gd.wFlags = gd.wFlags & 0xdeff;
    if (fAi == 0) {
      if (!bVar4) {
        for (i = 0; i < 0xd; i = i + 1) {
          ShowWindow(((ushort *)rghwndBtn)[i],0);
        }
        for (i = 0; i < 3; i = i + 1) {
          ShowWindow(((ushort *)rghwndOrderDD)[i],0);
        }
        ShowWindow(hwndOrderED,0);
        ShowWindow(hwndShipDD,0);
        ShowWindow(hwndBattleDD,0);
        ShowWindow(hwndShipLB,0);
        ShowWindow(hwndFleetCompLB,0);
        ShowWindow(hwndPlanetProdLB,0);
        ShowWindow(hwndRepCB,0);
        for (i = 0; i < 0x13; i = i + 1) {
          *(undefined2 *)((int)&rgrcRef[0].bottom + i * 8) = 0xfffa;
          *(undefined2 *)((int)&rgrcRef[0].top + i * 8) = 0xfffb;
        }
      }
      FillShipDD(idSkip);
      if (bVar4) {
        DrawPlanShip(0,0x4fff);
      }
      else {
        InvalidateRect(hwndPlanet,(RECT *)0x0,1);
        if (((grbitScan & 0x10) != 0) && (sel.grobj == grobjPlanet)) {
          grbitScan = grbitScan & 0xffef;
          InvalidateRect(hwndTb,(RECT *)0x0,1);
        }
      }
      SetPlanetTitleBar(hwndPlanet);
      if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
        AdvanceTutor();
      }
    }
  }
  return;
}



// ======================================================================
// Function: FillShipDD
// Address: 1048:42a0
// Segment: MEMORY_PLANET
// ======================================================================


void FillShipDD(short idSkip)

{
  FLEET *pFVar1;
  int iVar2;
  THING *pTVar3;
  undefined2 uVar4;
  short ptSel;
  short local_14;
  FLEET *lpfl;
  THING *lpth;
  short i;
  
  SendMessage(hwndShipDD,0x40b,0,0);
  if (sel.grobj == grobjPlanet) {
    ptSel = ((POINT *)rgptPlan + sel.id)->x;
    local_14 = *(int *)((int)&rgptPlan[0].y + sel.id * 4);
  }
  else {
    ptSel = sel.fl.pt.x;
    local_14 = sel.fl.pt.y;
  }
  for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[i];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    if (((idSkip == -1) && (sel.id == pFVar1->idPlanet)) ||
       (((idSkip != -1 && ((lpfl->id != idSkip && ((&pFVar1->pt)->x == sel.fl.pt.x)))) &&
        ((pFVar1->pt).y == sel.fl.pt.y)))) {
      PszGetFleetName(lpfl->id);
      _memmove((char *)szWork + 1,(char *)szWork,0x32);
      if (pFVar1->iPlayer == idPlayer) {
        szWork[0] = ' ';
      }
      else {
        szWork[0] = 'x';
      }
      SendMessage(hwndShipDD,0x403,0,0x112057a4);
    }
  }
  pTVar3 = (THING *)lpThings + cThing;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < pTVar3) {
    uVar4 = (undefined2)((ulong)lpth >> 0x10);
    if ((((uint)lpth->idFull >> 0xd == 1) && ((&((THING *)lpth)->pt)->x == ptSel)) &&
       ((((THING *)lpth)->pt).y == local_14)) {
      PszGetThingName(lpth->idFull);
      _memmove((char *)szWork + 1,(char *)szWork,0x32);
      if (((uint)lpth->idFull >> 9 & 0xf) == idPlayer) {
        szWork[0] = ' ';
      }
      else {
        szWork[0] = 'x';
      }
      SendMessage(hwndShipDD,0x403,0,0x112057a4);
    }
    lpth = (THING *)CONCAT22(uVar4,(THING *)lpth + 1);
  }
  SendMessage(hwndShipDD,0x40e,0,0);
  return;
}



// ======================================================================
// Function: SelectAdjPlanet
// Address: 1048:44da
// Segment: MEMORY_PLANET
// ======================================================================


void SelectAdjPlanet(short dInc,short idPlanet)

{
  POINT pt;
  short fWrap;
  SCAN scan;
  PLANET *lpPl;
  short i;
  PLANET *lpPlT;
  
  if ((0 < cPlanet) && (idPlanet != -1)) {
    if (dInc != 0) {
      idPlanet = sel.pl.id;
    }
    if (vrptPlanet.fCached == 0) {
      InvalidateReport(0,1);
    }
    lpPlT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    lpPl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    i = 0;
    while( true ) {
      if ((cPlanet <= i) || (lpPl->id == idPlanet)) break;
      i = i + 1;
      lpPl = (PLANET *)CONCAT22(lpPl._2_2_,(PLANET *)lpPl + 1);
    }
    if ((i == cPlanet) || ((((PLANET *)lpPl)->wFlags & 0xffU) != 7)) {
      scan.pt.x = ((POINT *)rgptPlan + idPlanet)->x;
      scan.pt.y = *(short *)((int)&rgptPlan[0].y + idPlanet * 4);
      scan.grobj = 0x81;
      ChangeScanSel(&scan,0);
    }
    else {
      if (dInc != 0) {
        i = 0;
        while ((i < *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) &&
               (((PLANET *)lpPlanets + ((ushort *)vlprgidPlanet)[i])->id != idPlanet))
              ) {
          i = i + 1;
        }
        i = i + dInc;
        if (i < *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0)) {
          if (i < 0) {
            i = *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) + -1;
          }
        }
        else {
          i = 0;
        }
        i = ((ushort *)vlprgidPlanet)[i];
      }
      lpPlT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets + i);
      idPlanet = lpPlT->id;
      if (((PLANET *)lpPlanets)[i].iPlayer != idPlayer) {
        return;
      }
      scan.pt.x = ((POINT *)rgptPlan + idPlanet)->x;
      scan.pt.y = *(short *)((int)&rgptPlan[0].y + idPlanet * 4);
      scan.grobj = 0x81;
      ChangeScanSel(&scan,0);
      RedrawScanSel(0,0);
      ChangeMainObjSel(1,idPlanet);
      RedrawScanSel(0,1);
    }
    pt.y = *(short *)((int)&rgptPlan[0].y + idPlanet * 4);
    pt.x = ((POINT *)rgptPlan + idPlanet)->x;
    CtrPointScan(pt,1);
    DrawScannerSBar(0,(RECT *)0x0,(SBAR *)0x0,0);
    InvalidateRect(hwndMine,(RECT *)0x0,1);
    SetMineralTitleBar(hwndMine);
  }
  return;
}



// ======================================================================
// Function: IdFindAdjStarbase
// Address: 1048:474e
// Segment: MEMORY_PLANET
// ======================================================================


short IdFindAdjStarbase(short idPlanet,short fNext)

{
  PLANET *pPVar1;
  undefined2 uVar2;
  HULDEF *pHVar3;
  short idBefore;
  short idAfter;
  PLANET *lppl;
  short idFirst;
  short idLast;
  
  idLast = -1;
  idFirst = -1;
  idAfter = -1;
  idBefore = -1;
  pPVar1 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < pPVar1) {
    uVar2 = (undefined2)((ulong)lppl >> 0x10);
    if (((((PLANET *)lppl)->iPlayer == idPlayer) &&
        (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)) &&
       (pHVar3 = LphuldefFromId
                           (*(HullDef *)
                             (*(int *)(idPlayer * 4 + 0x14c) +
                             (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) * 0x93)),
       (((HULDEF *)pHVar3)->hul).wtCargoMax != 0)) {
      if (idPlanet < lppl->id) {
        if (idAfter == -1) {
          idAfter = lppl->id;
        }
      }
      else if (lppl->id < idPlanet) {
        idBefore = lppl->id;
      }
      if (idFirst == -1) {
        idFirst = lppl->id;
      }
      idLast = lppl->id;
    }
    lppl = (PLANET *)CONCAT22(uVar2,(PLANET *)lppl + 1);
  }
  if (fNext == 0) {
    idFirst = idLast;
    if (idBefore != -1) {
      idFirst = idBefore;
    }
  }
  else if (idAfter != -1) {
    idFirst = idAfter;
  }
  return idFirst;
}



// ======================================================================
// Function: PlanetClick
// Address: 1048:489e
// Segment: MEMORY_PLANET
// ======================================================================


void PlanetClick(short x,short y,short sks,short fRightBtn)

{
  undefined2 *puVar1;
  undefined2 *puVar2;
  POINT pt_00;
  POINT pt_01;
  POINT PVar3;
  POINT PVar4;
  int iVar5;
  BOOL BVar6;
  short sVar7;
  uint uVar8;
  undefined2 *puVar9;
  undefined2 *puVar10;
  undefined2 unaff_SS;
  undefined1 btnt [4];
  short local_3c;
  undefined2 tile [5];
  char *local_30;
  HDC hdc;
  RECT rc;
  int prgtile;
  short iCur;
  ushort iCol;
  short xRel;
  short i;
  RECT rcTitle;
  short dy;
  short ctile;
  short pt;
  short local_8;
  short bt;
  
  bt = 0x70;
  if (sel.grobj == grobjPlanet) {
    prgtile = 0x7fc;
    ctile = 6;
  }
  else {
    if (sel.grobj != grobjFleet) {
      return;
    }
    prgtile = 0x90e;
    ctile = 7;
  }
  iCol = (uint)x / 0xc6;
  xRel = (uint)x % 0xc6;
  if ((3 < (uint)xRel) && ((uint)xRel < 0xc2)) {
    for (i = 0; i < ctile; i = i + 1) {
      if (iCol <= (*(uint *)(prgtile + i * 0x10 + 10) & 7)) {
        if (iCol < (*(uint *)(prgtile + i * 0x10 + 10) & 7)) {
          return;
        }
        if (*(int *)(prgtile + i * 0x10) <= y) {
          if ((*(uint *)(prgtile + i * 0x10 + 10) >> 7 & 1) == 0) {
            iVar5 = dyArial8 + 3;
          }
          else {
            iVar5 = *(int *)(prgtile + i * 0x10 + 2);
          }
          if (y < iVar5 + *(int *)(prgtile + i * 0x10)) break;
        }
      }
    }
    if (i != ctile) {
      pt = x;
      local_8 = y;
      rcTitle.top = *(int *)(prgtile + i * 0x10);
      rcTitle.bottom = dyArial8 + rcTitle.top + 4;
      rcTitle.left = iCol * 0xc6 + 4;
      rcTitle.right = iCol * 0xc6 + 0xc3;
      PVar3.y = y;
      PVar3.x = x;
      BVar6 = PtInRect((RECT *)&rcTitle,PVar3);
      if ((BVar6 == 0) || (fRightBtn != 0)) {
        if (((sel.grobj == grobjFleet) &&
            ((((*(int *)(prgtile + i * 0x10 + 4) == 0x20 ||
               (*(int *)(prgtile + i * 0x10 + 4) == 0x100)) ||
              (*(int *)(prgtile + i * 0x10 + 4) == 1)) || (*(int *)(prgtile + i * 0x10 + 4) == 0x10)
             ))) || (*(int *)(prgtile + i * 0x10 + 4) == 4)) {
          pt_00.y = local_8;
          pt_00.x = pt;
          ClickInShipOrders(pt_00,sks,0,fRightBtn);
        }
        else if ((sel.grobj == grobjPlanet) &&
                (((*(int *)(prgtile + i * 0x10 + 4) == 1 ||
                  (*(int *)(prgtile + i * 0x10 + 4) == 0x100)) ||
                 ((*(int *)(prgtile + i * 0x10 + 4) == 0x40 ||
                  (*(int *)(prgtile + i * 0x10 + 4) == 8)))))) {
          pt_01.y = local_8;
          pt_01.x = pt;
          ClickInPlanetOrders(pt_01,sks,0,fRightBtn);
        }
      }
      else {
        rc.right = rcTitle.right;
        rc.bottom = rcTitle.bottom;
        rc.top = rcTitle.top + 1;
        rc.left = rcTitle.right + -0x11;
        PVar4.y = local_8;
        PVar4.x = pt;
        BVar6 = PtInRect((RECT *)&rc,PVar4);
        if (BVar6 == 0) {
          if ((*(uint *)(prgtile + i * 0x10 + 10) >> 7 & 1) != 0) {
            rcTitle.bottom = rcTitle.top + *(int *)(prgtile + i * 0x10 + 2) + 1;
          }
          hdc = GetDC(hwndPlanet);
          DrawFuzzyBorder(hdc,&rcTitle);
          SetCapture(hwndPlanet);
          btnt._2_2_ = pt;
          local_3c = local_8;
          while (sVar7 = FGetMouseMove((POINT *)(btnt + 2)), sVar7 != 0) {
            if ((pt != btnt._2_2_) || (local_8 != local_3c)) {
              DrawFuzzyBorder(hdc,&rcTitle);
              OffsetRc(&rcTitle,btnt._2_2_ - pt,local_3c - local_8);
              pt = btnt._2_2_;
              local_8 = local_3c;
              DrawFuzzyBorder(hdc,&rcTitle);
            }
          }
          DrawFuzzyBorder(hdc,&rcTitle);
          ReleaseCapture();
          ReleaseDC(hwndPlanet,hdc);
          sVar7 = i;
          pt = (rcTitle.right - rcTitle.left >> 1) + rcTitle.left;
          local_8 = (rcTitle.bottom - rcTitle.top >> 1) + rcTitle.top;
          if (pt / 0xc6 < 2) {
            uVar8 = pt / 0xc6;
          }
          else {
            uVar8 = 1;
          }
          if (uVar8 < 0x8000) {
            if (pt / 0xc6 < 2) {
              iCol = pt / 0xc6;
            }
            else {
              iCol = 1;
            }
          }
          else {
            iCol = 0;
          }
          iCur = i;
          i = 0;
          while ((i < ctile && ((*(uint *)(prgtile + i * 0x10 + 10) & 7) < iCol))) {
            i = i + 1;
          }
          while ((i < ctile && ((*(uint *)(prgtile + i * 0x10 + 10) & 7) == iCol))) {
            if ((*(uint *)(prgtile + i * 0x10 + 10) >> 7 & 1) == 0) {
              dy = dyArial8 + 3;
            }
            else {
              dy = *(int *)(prgtile + i * 0x10 + 2);
            }
            if (local_8 < (dy >> 1) + *(int *)(prgtile + i * 0x10)) break;
            i = i + 1;
          }
          if ((i == sVar7) || (i == sVar7 + 1)) {
            i = *(uint *)(prgtile + sVar7 * 0x10 + 10) & 7;
            if (iCol != i) {
              *(uint *)(prgtile + sVar7 * 0x10 + 10) =
                   *(uint *)(prgtile + sVar7 * 0x10 + 10) & 0xfff8 | iCol & 7;
              ReflowColumn(iCol,sVar7,1);
              if ((int)iCol < i) {
                ReflowColumn(i,iCur + 1,1);
              }
              else {
                ReflowColumn(i,iCur,1);
              }
            }
          }
          else {
            puVar9 = (undefined2 *)(prgtile + sVar7 * 0x10);
            puVar10 = tile;
            for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
              puVar2 = puVar10;
              puVar10 = puVar10 + 1;
              puVar1 = puVar9;
              puVar9 = puVar9 + 1;
              *puVar2 = *puVar1;
            }
            if (i < iCur) {
              _memmove((void *)(prgtile + (i + 1) * 0x10),(void *)(prgtile + i * 0x10),
                               (iCur - i) * 0x10);
              iCur = iCur + 1;
            }
            else {
              _memmove((void *)(prgtile + iCur * 0x10),(void *)(prgtile + (iCur + 1) * 0x10)
                               ,((i - iCur) + -1) * 0x10);
              i = i + -1;
            }
            puVar9 = (undefined2 *)(prgtile + i * 0x10);
            puVar10 = tile;
            for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
              puVar2 = puVar9;
              puVar9 = puVar9 + 1;
              puVar1 = puVar10;
              puVar10 = puVar10 + 1;
              *puVar2 = *puVar1;
            }
            *(uint *)(prgtile + i * 0x10 + 10) =
                 *(uint *)(prgtile + i * 0x10 + 10) & 0xfff8 | iCol & 7;
            if (((uint)local_30 & 7) == iCol) {
              sVar7 = i;
              if (iCur <= i) {
                sVar7 = iCur;
              }
              ReflowColumn(iCol,sVar7,1);
            }
            else {
              ReflowColumn(iCol,i,1);
              ReflowColumn((uint)local_30 & 7,iCur,1);
            }
          }
        }
        else {
          OffsetRc(&rc,-1,0);
          if ((*(uint *)(prgtile + i * 0x10 + 10) >> 7 & 1) == 0) {
            bt = bt | 1;
          }
          InitBtnTrack((BTNT *)btnt,hwndPlanet,0,&rc,bt,0,0,0,(char *)0x0);
          do {
            sVar7 = FTrackBtn((BTNT *)btnt);
          } while (sVar7 != 0);
          if ((hdc >> 1 & 1) != 0) {
            *(uint *)(prgtile + i * 0x10 + 10) =
                 *(uint *)(prgtile + i * 0x10 + 10) & 0xff7f |
                 (uint)((*(uint *)(prgtile + i * 0x10 + 10) >> 7 & 1) == 0) << 7;
            ReflowColumn(*(uint *)(prgtile + i * 0x10 + 10) & 7,i,1);
          }
        }
      }
    }
  }
  return;
}



// ======================================================================
// Function: ClickInPlanetOrders
// Address: 1048:515c
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1048548a) */
/* WARNING: Removing unreachable block (ram,0x10485505) */
/* WARNING: Removing unreachable block (ram,0x104853d2) */

ushort ClickInPlanetOrders(POINT pt,short sks,short fCursor,short fRightBtn)

{
  BOOL BVar1;
  char *pcVar2;
  short sVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar4;
  ushort in_stack_0000ffd2;
  undefined1 btnt [22];
  uint local_16;
  short iWarp;
  undefined4 rglQuan;
  short i;
  
  uVar4 = CONCAT22(unaff_SI,unaff_DI);
  if ((sel.grobj == grobjPlanet) && (fRightBtn == 0)) {
    BVar1 = PtInRect(rgrcRef + 6,(POINT)pt);
    if (BVar1 == 0) {
      BVar1 = PtInRect(rgrcRef + 7,(POINT)pt);
      if (BVar1 == 0) {
        BVar1 = PtInRect(rgrcRef + 8,(POINT)pt);
        if (BVar1 == 0) {
          BVar1 = PtInRect(rgrcRef + 9,(POINT)pt);
          if (BVar1 == 0) {
            BVar1 = PtInRect(rgrcRef + 10,(POINT)pt);
            if (BVar1 == 0) {
              BVar1 = PtInRect(rgrcRef + 0xb,(POINT)pt);
              if (BVar1 == 0) {
                BVar1 = PtInRect(rgrcRef + 0xd,(POINT)pt);
                if (BVar1 == 0) {
                  BVar1 = PtInRect(rgrcRef + 0xe,(POINT)pt);
                  if (BVar1 == 0) {
                    BVar1 = PtInRect(rgrcRef + 0x10,(POINT)pt);
                    if (BVar1 == 0) {
                      BVar1 = PtInRect(rgrcRef + 0xf,(POINT)pt);
                      if (BVar1 == 0) {
                        BVar1 = PtInRect(rgrcRef + 0x11,(POINT)pt);
                        if (BVar1 != 0) {
                          if (fCursor != 0) {
                            return hcurHand;
                          }
                          pcVar2 = PszGetCompressedString(idsRoute2);
                          InitBtnTrack
                                    ((BTNT *)(btnt + 2),hwndPlanet,0,
                                     (RECT *)(rgrcRef + 0x11),8,0x50,
                                     (uint)gd.wFlags >> 0xd & 1,1,pcVar2);
                          do {
                            sVar3 = FTrackBtn((BTNT *)(btnt + 2));
                          } while (sVar3 != 0);
                          gd.wFlags =
                               gd.wFlags & 0xdfffU |
                               (((uint)iWarp >> 1 & 1) << 0xd ^ gd.wFlags) & 0x2000;
                        }
                      }
                      else {
                        ClickInShipOrders(pt,sks,0,0);
                      }
                    }
                    else {
                      iWarp = IWarpMAFromLppl(&sel.pl,(short *)0x0);
                      if (iWarp == 0) {
                        return 0;
                      }
                      if (fCursor != 0) {
                        return hcurArrowHelp;
                      }
                      GlobalPD.field1_0x2 = 0;
                      GlobalPD.field2_0x3 = 2;
                      local_16 = iWarp + 2;
                      GlobalPD.psz =
                           (char *)((uint)GlobalPD.psz & 0xff00 | local_16 & 0xff);
                      FLookupPart((PART *)&GlobalPD.field1_0x2);
                      GlobalPD.grPopup = 9;
                      Popup(hwndPlanet,pt.x,pt.y);
                    }
                  }
                  else {
                    if (fCursor != 0) {
                      return hcurArrowHelp;
                    }
                    GlobalPD.grPopup = 0xb;
                    GlobalPD.psz = (char *)*(undefined2 *)(idPlayer * 4 + 0x14e);
                    GlobalPD._2_2_ =
                         *(int *)(idPlayer * 4 + 0x14c) +
                         (sel.pl._44_2_ & 0xf) * 0x93;
                    GlobalPD.iPlanMin = 0;
                    GlobalPD.iPlanVal = 1;
                    GlobalPD.iPlanMax = 0;
                    GlobalPD.iPlrVal = 0;
                    Popup(hwndPlanet,pt.x,pt.y);
                  }
                }
                else {
                  iWarp = IWarpMAFromLppl(&sel.pl,(short *)0x0);
                  if (iWarp == 0) {
                    return 0;
                  }
                  if (fCursor != 0) {
                    return hcurHand;
                  }
                  pcVar2 = PszGetCompressedString(idsSetDest);
                  InitBtnTrack
                            ((BTNT *)btnt,hwndPlanet,0,(RECT *)(rgrcRef + 0xd),8,
                             0x50,(uint)gd.wFlags >> 8 & 1,1,pcVar2);
                  do {
                    sVar3 = FTrackBtn((BTNT *)btnt);
                  } while (sVar3 != 0);
                  gd.wFlags =
                       gd.wFlags & 0xfeffU |
                       ((local_16 >> 1 & 1) << 8 ^ gd.wFlags) & 0x100;
                }
              }
              else {
                uVar4 = __aFulshr(uVar4,in_stack_0000ffd2);
                if ((((uint)uVar4 & 0x1f) == 0x1f) &&
                   (sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv
                                             ), sVar3 != raMacintosh)) {
                  return 0;
                }
                if (fCursor != 0) {
                  return hcurArrowHelp;
                }
                sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
                if (sVar3 == raMacintosh) {
                  GlobalPD.grPopup = 10;
                  GlobalPD.field1_0x2 = 0xb4;
                  GlobalPD.field2_0x3 = 0;
                  GlobalPD.psz = (char *)szPopupBuffer;
                  CchGetString
                            (idsRaceCannotBuildPlanetaryScannersStarbasesHave,
                             (char *)szPopupBuffer);
                }
                else {
                  LookupBestPlanetaryScanner((PART *)&GlobalPD.field1_0x2);
                  GlobalPD.grPopup = 9;
                }
                Popup(hwndPlanet,pt.x,pt.y);
              }
            }
            else {
              if (((uint)sel.pl.dwFlags & 0xfff) == 0) {
                return 0;
              }
              if (fCursor != 0) {
                return hcurArrowHelp;
              }
              FGetBestDefensePart((PART *)&GlobalPD.field1_0x2);
              GlobalPD.grPopup = 9;
              Popup(hwndPlanet,pt.x,pt.y);
            }
          }
          else {
            if (fCursor != 0) {
              return hcurArrowHelp;
            }
            GlobalPD.grPopup = 7;
            GlobalPD.field1_0x2 = (undefined1)sel.pl.id;
            GlobalPD.field2_0x3 = sel.pl.id._1_1_;
            Popup(hwndPlanet,pt.x,pt.y);
          }
        }
        else {
          if (fCursor != 0) {
            return hcurArrowHelp;
          }
          GlobalPD.grPopup = 0xc;
          GlobalPD.field1_0x2 = (undefined1)sel.pl.id;
          GlobalPD.field2_0x3 = sel.pl.id._1_1_;
          GlobalPD.psz = (char *)CResourcesAtPlanet(&sel.pl,idPlayer);
          GlobalPD.iPlanVal = (short)GlobalPD.psz;
          uVar4 = __aFulshr(uVar4,in_stack_0000ffd2);
          if ((uVar4 & 1) == 0) {
            sVar3 = MulDiv((short)GlobalPD.psz,
                           (int)*(char *)((int)&rgplr[0].pctResearch +
                                         idPlayer * 0xc0),100);
            GlobalPD.iPlanVal = GlobalPD.iPlanVal - sVar3;
          }
          Popup(hwndPlanet,pt.x,pt.y);
        }
      }
      else {
        if (fCursor != 0) {
          return hcurArrowHelp;
        }
        GlobalPD.grPopup = 8;
        GlobalPD.field1_0x2 = (undefined1)sel.pl.id;
        GlobalPD.field2_0x3 = sel.pl.id._1_1_;
        GlobalPD.iPlanMax = (short)(rgrcRef[7].top + dyArial8 <= pt.y);
        if (GlobalPD.iPlanMax == 0) {
          GlobalPD.psz = (char *)CMaxMines(&sel.pl,idPlayer);
          uVar4 = __aFulshr(uVar4,in_stack_0000ffd2);
          GlobalPD.iPlanVal = (uint)uVar4 & 0xfff;
          GlobalPD.iPlanMin = CMaxOperableMines(&sel.pl,idPlayer,0);
        }
        else {
          GlobalPD.psz = (char *)CMaxFactories(&sel.pl,idPlayer);
          uVar4 = __aFulshr(uVar4,in_stack_0000ffd2);
          GlobalPD.iPlanVal = (uint)uVar4 & 0xfff;
          GlobalPD.iPlanMin = CMaxOperableFactories(&sel.pl,idPlayer,0);
        }
        Popup(hwndPlanet,pt.x,pt.y);
      }
    }
    else {
      if (fCursor != 0) {
        return hcurArrowHelp;
      }
      GlobalPD._2_2_ = (pt.y - rgrcRef[6].top) / dyArial8;
      GlobalPD.grPopup = 1;
      GlobalPD.psz = (char *)((int)GlobalPD._2_2_ >> 0xf);
      GlobalPD.iPlanMax =
           *(short *)((int)&sel.pl + 0x1c + GlobalPD._2_2_ * 4);
      GlobalPD.iPlrVal =
           *(short *)((int)&sel.pl + 0x1e + GlobalPD._2_2_ * 4);
      GlobalPD.iPlrMin = (short)*(byte *)((int)&sel.pl + 9 + GlobalPD._2_2_)
      ;
      GlobalPD.iPlrMax = 0;
      i = GlobalPD._2_2_;
      EstMineralsMined(&sel.pl,&rglQuan,-1,0);
      GlobalPD._18_2_ = *(undefined2 *)(&rglQuan + i);
      GlobalPD._20_2_ = *(undefined2 *)((int)&rglQuan + i * 4 + 2);
      GlobalPD.iPlanVal = (uint)sel.pl.wFlags >> 10 & 1;
      GlobalPD.iPlanMin = 0;
      Popup(hwndPlanet,pt.x,pt.y);
    }
  }
  return 0;
}



// ======================================================================
// Function: EnsureTileSize
// Address: 1048:587e
// Segment: MEMORY_PLANET
// ======================================================================


void EnsureTileSize(short fSmallTiles)

{
  int *piVar1;
  GrobjClass GVar2;
  int iVar3;
  short grobjSav;
  short i;
  short iMul;
  
  GVar2 = sel.grobj;
  if (fSmallTiles != ((uint)gd.wFlags >> 3 & 1)) {
    gd.wFlags = gd.wFlags & 0xfff7U | (fSmallTiles & 1U) << 3;
    if (fSmallTiles == 0) {
      iVar3 = 1;
    }
    else {
      iVar3 = -1;
    }
    for (i = 0; i < 6; i = i + 1) {
      if (*(int *)(i * 0x10 + 0x800) == 0x40) {
        piVar1 = (int *)(i * 0x10 + 0x7fe);
        *piVar1 = *piVar1 + (dyArial8 + 2) * 2 * iVar3;
      }
      if (*(int *)(i * 0x10 + 0x800) == 4) {
        piVar1 = (int *)(i * 0x10 + 0x7fe);
        *piVar1 = *piVar1 + (dyArial8 + 4) * 2 * iVar3;
      }
      if (*(int *)(i * 0x10 + 0x800) == 0x80) {
        piVar1 = (int *)(i * 0x10 + 0x7fe);
        *piVar1 = *piVar1 + iVar3 * 10;
      }
    }
    for (i = 0; GVar2 = sel.grobj, i < 7; i = i + 1) {
      if (*(int *)(i * 0x10 + 0x912) == 1) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + (dyArial8 * 4 + 2) * iVar3;
      }
      if (*(int *)(i * 0x10 + 0x912) == 0x200) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + (dyArial8 * 3 + 8) * iVar3;
      }
      if (*(int *)(i * 0x10 + 0x912) == 0x20) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + (dyArial8 + 9) * iVar3;
      }
      if (*(int *)(i * 0x10 + 0x912) == 4) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + (dyArial8 + 4) * 2 * iVar3;
      }
      if (*(int *)(i * 0x10 + 0x912) == 0x80) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + iVar3 * 10;
      }
      if (*(int *)(i * 0x10 + 0x912) == 0x100) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + iVar3 * 2;
      }
      if (*(int *)(i * 0x10 + 0x912) == 0x40) {
        piVar1 = (int *)(i * 0x10 + 0x910);
        *piVar1 = *piVar1 + iVar3 * 6;
      }
    }
    sel.grobj = grobjPlanet;
    for (i = 0; i < 4; i = i + 1) {
      ReflowColumn(i,-1,0);
    }
    sel.grobj = grobjFleet;
    for (i = 0; i < 4; i = i + 1) {
      ReflowColumn(i,-1,0);
    }
  }
  sel.grobj = GVar2;
  return;
}



// ======================================================================
// Function: ReflowColumn
// Address: 1048:5b80
// Segment: MEMORY_PLANET
// ======================================================================


void ReflowColumn(short iCol,short iTile,short fRedraw)

{
  int iVar1;
  undefined2 unaff_SS;
  RECT rc;
  int ptile;
  short grbit;
  short i;
  short ctile;
  short yTop;
  HDC hdc;
  
  grbit = 0;
  if (sel.grobj == grobjFleet) {
    ptile = 0x90e;
    ctile = 7;
  }
  else {
    ptile = 0x7fc;
    ctile = 6;
  }
  yTop = 4;
  if (iTile == -1) {
    i = 0;
    while ((i < ctile && ((*(uint *)(ptile + i * 0x10 + 10) & 7) != iCol))) {
      i = i + 1;
    }
    if (i == ctile) {
      return;
    }
    iTile = i;
  }
  else {
    for (i = 0; i < iTile; i = i + 1) {
      if ((*(uint *)(ptile + i * 0x10 + 10) & 7) == iCol) {
        if ((*(uint *)(ptile + i * 0x10 + 10) >> 7 & 1) == 0) {
          iVar1 = dyArial8 + 3;
        }
        else {
          iVar1 = *(int *)(ptile + i * 0x10 + 2);
        }
        yTop = yTop + iVar1 + 4;
      }
    }
  }
  if (fRedraw != 0) {
    GetClientRect(hwndPlanet,(RECT *)&rc);
    rc.top = yTop;
    rc.left = iCol * 0xc6 + 4;
    rc.right = iCol * 0xc6 + 0xc3;
    hdc = GetDC(hwndPlanet);
    FillRect(hdc,(RECT *)&rc,hbrButtonFace);
  }
  while ((iTile < ctile && ((*(uint *)(ptile + iTile * 0x10 + 10) & 7) == iCol))) {
    *(short *)(ptile + iTile * 0x10) = yTop;
    *(uint *)(ptile + iTile * 0x10 + 10) = *(uint *)(ptile + iTile * 0x10 + 10) & 0xf7ff | 0x800;
    grbit = grbit | *(uint *)(ptile + iTile * 0x10 + 4);
    if ((*(uint *)(ptile + iTile * 0x10 + 10) >> 7 & 1) == 0) {
      iVar1 = dyArial8 + 3;
    }
    else {
      iVar1 = *(int *)(ptile + iTile * 0x10 + 2);
    }
    yTop = yTop + iVar1 + 4;
    iTile = iTile + 1;
  }
  if (fRedraw != 0) {
    DrawPlanShip(hdc,grbit);
    ReleaseDC(hwndPlanet,hdc);
  }
  return;
}



// ======================================================================
// Function: IBestTerraform
// Address: 1048:5dd2
// Segment: MEMORY_PLANET
// ======================================================================


short IBestTerraform(PLANET *lppl,short fHelp)

{
  short sVar1;
  short sVar2;
  int iVar3;
  PLANET *pPVar4;
  undefined2 uVar5;
  short iPlrSav;
  short rgCost [3];
  int rgpctBest [3];
  short rgMin [3];
  short pctCur;
  short iEnv;
  short iPlr;
  short i;
  short pctT;
  short rgMax [3];
  short iBest;
  short iSave;
  
  sVar1 = idPlayer;
  uVar5 = (undefined2)((ulong)lppl >> 0x10);
  pPVar4 = (PLANET *)lppl;
  idPlayer = pPVar4->iPlayer;
  if (idPlayer == -1) {
    sVar2 = 0;
  }
  else {
    iPlr = idPlayer;
    sVar2 = FCanTerraformLppl(lppl,rgMin,rgMax,rgCost,fHelp);
    if (sVar2 == 0) {
      sVar2 = 0;
    }
    else {
      pctCur = PctPlanetDesirability(lppl,iPlr);
      for (i = 0; i < 3; i = i + 1) {
        if (rgMin[i] == -1) {
          if (rgMax[i] != -1) {
            iEnv = rgMax[i];
            goto LAB_1048_5ea6;
          }
          rgpctBest[i] = 0;
        }
        else {
          iEnv = rgMin[i];
LAB_1048_5ea6:
          iSave = (short)pPVar4->rgEnvVar[i];
          pPVar4->rgEnvVar[i] = (char)iEnv;
          sVar2 = PctPlanetDesirability(lppl,iPlr);
          pctT = sVar2 - pctCur;
          if (pctT < 0) {
            pctT = -pctT;
          }
          iVar3 = pctT * 100;
          sVar2 = _abs(iSave - iEnv);
          rgpctBest[i] = iVar3 / sVar2 + 1;
          pPVar4->rgEnvVar[i] = (char)iSave;
        }
      }
      iSave = 0;
      for (i = 1; i < 3; i = i + 1) {
        if (rgpctBest[iSave] < rgpctBest[i]) {
          iSave = i;
        }
      }
      if (rgMin[iSave] == -1) {
        sVar2 = iSave + 1;
      }
      else {
        sVar2 = -(iSave + 1);
      }
    }
  }
  idPlayer = sVar1;
  return sVar2;
}



// ======================================================================
// Function: PszCalcEnvVar
// Address: 1048:5fcc
// Segment: MEMORY_PLANET
// ======================================================================


char * PszCalcEnvVar(short iEnv,short iVar)

{
  char *pcVar1;
  
  if (iEnv == 0) {
LAB_1048_5fdb:
    pcVar1 = PszCalcGravity(iVar);
  }
  else {
    if (iEnv == 1) {
      wsprintf(szWork,(char *)0x112008b0,iVar * 4 + -200,0xba);
    }
    else {
      if (iEnv != 2) goto LAB_1048_5fdb;
      wsprintf(szWork,(char *)0x112008b6,iVar);
    }
    pcVar1 = (char *)szWork;
  }
  return pcVar1;
}



// ======================================================================
// Function: PszCalcGravity
// Address: 1048:6058
// Segment: MEMORY_PLANET
// ======================================================================


char * PszCalcGravity(short iGravity)

{
  short sVar1;
  short iVal;
  short d;
  
  sVar1 = _abs(iGravity + -0x32);
  if (sVar1 < 0x1a) {
    iVal = sVar1 * 4 + 100;
  }
  else {
    iVal = (sVar1 + -0x19) * 0x18 + 200;
  }
  if (iGravity < 0x32) {
    iVal = (short)(10000 / (long)iVal);
  }
  wsprintf(szWork,(char *)0x112008bb,iVal / 100,iVal % 100);
  return (char *)szWork;
}



// ======================================================================
// Function: HandleFocusState
// Address: 1048:60e6
// Segment: MEMORY_PLANET
// ======================================================================


void HandleFocusState(DRAWITEMSTRUCT *lpdis,short inflate)

{
  DRAWITEMSTRUCT *pDVar1;
  undefined2 uVar2;
  
  uVar2 = (undefined2)((ulong)lpdis >> 0x10);
  pDVar1 = (DRAWITEMSTRUCT *)lpdis;
  if ((pDVar1->itemState & 0x10U) != 0) {
    FrameRect(pDVar1->hDC,(RECT *)CONCAT22(uVar2,&pDVar1->rcItem),hbr50Screen);
  }
  return;
}



// ======================================================================
// Function: DrawCBEntireItem
// Address: 1048:6128
// Segment: MEMORY_PLANET
// ======================================================================


void DrawCBEntireItem(DRAWITEMSTRUCT *lpdis,short inflate)

{
  UINT UVar1;
  DRAWITEMSTRUCT *pDVar2;
  undefined2 uVar3;
  RECT rc;
  short fSelected;
  short fListbox;
  
  uVar3 = (undefined2)((ulong)lpdis >> 0x10);
  pDVar2 = (DRAWITEMSTRUCT *)lpdis;
  fSelected = pDVar2->itemState & 1;
  rc.left = (&pDVar2->rcItem)->left;
  rc.top = (pDVar2->rcItem).top;
  rc.right = (pDVar2->rcItem).right;
  rc.bottom = (pDVar2->rcItem).bottom;
  if (((pDVar2->hwndItem == hwndFleetCompLB) ||
      (pDVar2->hwndItem == hwndPlanetProdLB)) || (0 < inflate)) {
    fListbox = 1;
  }
  else {
    fListbox = 0;
  }
  if (0 < inflate) {
    inflate = -inflate;
  }
  if (fListbox == 0) {
    UVar1 = 0x408;
  }
  else {
    UVar1 = 0x40a;
  }
  SendMessage(pDVar2->hwndItem,UVar1,pDVar2->itemID,0x112057a4);
  DrawProductionItem(pDVar2->hDC,&rc,(char *)szWork,inflate,fSelected,fListbox);
  HandleFocusState(lpdis,inflate + 2);
  return;
}



// ======================================================================
// Function: DrawProductionItem
// Address: 1048:6208
// Segment: MEMORY_PLANET
// ======================================================================


void DrawProductionItem(HDC hdc,RECT *prc,char *psz,short inflate,short fSelected,short fListbox)

{
  char cVar1;
  bool bVar2;
  short sVar3;
  ushort uVar4;
  undefined2 unaff_SS;
  DWORD DVar5;
  short bkSav;
  short cch;
  short fItalic;
  HBRUSH hbr;
  short dx;
  RECT rcDraw;
  short fFleet;
  COLORREF crForeSav;
  short fDoubleDraw;
  short ich;
  RECT rcIn;
  char szT [6];
  undefined1 auStack_1e [14];
  short pctDmg;
  int cr;
  int local_c;
  short ichT;
  char *pch;
  ushort hfntSav;
  
  bVar2 = false;
  fDoubleDraw = 0;
  fFleet = 0;
  rcIn.left = prc->left;
  rcIn.top = prc->top;
  rcIn.right = prc->right;
  rcIn.bottom = prc->bottom;
  if (fSelected == 0) {
    hbr = hbrWindow;
    cVar1 = *psz;
    if (cVar1 == ' ') {
PLANET_LDefCase:
      if (((int)crWindow == 0) && (crWindow._2_2_ == 0)) {
        cr = -1;
        local_c = 0xff;
      }
      else {
        cr = 0;
        local_c = 0;
      }
    }
    else if (cVar1 == '#') {
      cr = 0;
      local_c = 0x7f;
    }
    else if (cVar1 == '&') {
      cr = 0x7f7f;
      local_c = 0x7f;
    }
    else {
      if (cVar1 != '*') {
        if (cVar1 == 'I') {
          bVar2 = true;
          goto PLANET_LDefCase;
        }
        if (cVar1 == 'P') {
          fDoubleDraw = 1;
          pctDmg = (short)psz[1];
        }
        else if (cVar1 != 'Q') {
          cr = 0xff;
          local_c = 0;
          goto LAB_1048_63d9;
        }
        fFleet = 1;
        goto PLANET_LDefCase;
      }
      cr = 0x7f00;
      local_c = 0;
    }
  }
  else {
    cr = (int)crWindow;
    local_c = crWindow._2_2_;
    cVar1 = *psz;
    if (cVar1 == ' ') {
PLANET_LDefCaseSel:
      if (((int)crWindow == 0) && (crWindow._2_2_ == 0)) {
        hbr = GetStockObject(0);
      }
      else {
        hbr = GetStockObject(4);
      }
    }
    else if (cVar1 == '#') {
      hbr = hbrBlue;
    }
    else if (cVar1 == '&') {
      hbr = hbrGray;
    }
    else {
      if (cVar1 != '*') {
        if (cVar1 == 'I') {
          bVar2 = true;
          goto PLANET_LDefCaseSel;
        }
        if (cVar1 == 'P') {
          fDoubleDraw = 1;
          pctDmg = (short)psz[1];
        }
        else if (cVar1 != 'Q') {
          hbr = hbrRed;
          goto LAB_1048_63d9;
        }
        fFleet = 1;
        goto PLANET_LDefCaseSel;
      }
      hbr = hbrGreen;
    }
  }
LAB_1048_63d9:
  if (fListbox == 2) {
    hbr = hbrButtonFace;
  }
  FillRect(hdc,(RECT *)&rcIn,hbr);
  if (fDoubleDraw != 0) {
    rcDraw.left = rcIn.left;
    rcDraw.top = rcIn.top;
    rcDraw.bottom = rcIn.bottom;
    rcDraw.right = rcIn.left + ((rcIn.right - rcIn.left) * pctDmg) / 100;
    FillRect(hdc,(RECT *)&rcDraw,hbrRed);
  }
  if (inflate != 0) {
    InflateRect((RECT *)&rcIn,-2,-1);
  }
  if (fListbox == 0) {
    ich = 1;
  }
  else if (fFleet == 0) {
    ich = 6;
    if (((int)psz[1] - 0x20U & 2) != 0) {
      bVar2 = true;
    }
  }
  else {
    ich = 7;
  }
  crForeSav = SetTextColor(hdc,CONCAT22(local_c,cr));
  sVar3 = SetBkMode(hdc,1);
  if (bVar2) {
    hfntSav = SelectObject(hdc,rghfontArial8[3]);
  }
  pch = psz + ich;
  uVar4 = _strlen(pch);
  cch = uVar4 + 1;
  do {
    cch = cch + -1;
    DVar5 = GetTextExtent(hdc,(LPCSTR)pch,cch);
  } while (rcIn.right - rcIn.left < (int)DVar5);
  TextOut(hdc,rcIn.left,rcIn.top,(LPCSTR)pch,cch);
  if (bVar2) {
    SelectObject(hdc,hfntSav);
  }
  if (ich < 6) goto LAB_1048_6673;
  if (((int)psz[ich + -5] - 0x20U & 2) == 0) {
    szT[0] = '\0';
LAB_1048_65b6:
    ich = _strlen(szT);
    ichT = 2 - fFleet;
    while ((ichT < 6 && (psz[ichT + fFleet] == ' '))) {
      ichT = ichT + 1;
    }
    _strncpy(szT + ich,psz + fFleet + ichT,6 - ichT);
    ich = ich + (6 - ichT);
    if ((fFleet == 0) && (((int)psz[fDoubleDraw + 1] - 0x20U & 1) != 0)) {
      auStack_1e[ich + -6] = 0x25;
      ich = ich + 1;
    }
  }
  else {
    if (psz[ich + -1] != '*') {
      CchGetString(idsUpTo,szT);
      goto LAB_1048_65b6;
    }
    ich = CchGetString(idsNeeded,szT);
  }
  RightTextOut(hdc,rcIn.right,rcIn.top,szT,ich,0);
LAB_1048_6673:
  SetTextColor(hdc,crForeSav);
  SetBkMode(hdc,sVar3);
  return;
}



// ======================================================================
// Function: FillPlanetProdLB
// Address: 1048:6692
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104869b9) */
/* WARNING: Removing unreachable block (ram,0x10486a6e) */
/* WARNING: Removing unreachable block (ram,0x104868d8) */
/* WARNING: Removing unreachable block (ram,0x10486999) */
/* WARNING: Removing unreachable block (ram,0x104869be) */
/* WARNING: Variable defined which should be unmapped: etaFirst */
/* WARNING: Variable defined which should be unmapped: ch */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Variable defined which should be unmapped: etaLast */
/* WARNING: Removing unreachable block (ram,0x104868f8) */
/* WARNING: Removing unreachable block (ram,0x104868fd) */
/* WARNING: Removing unreachable block (ram,0x104869f2) */

void FillPlanetProdLB(HWND hwnd,PLPROD *lpplprod,PLANET *lppl)

{
  char *pcVar1;
  char *unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar2;
  short unaff_SS;
  ulong uVar3;
  short etaFirst;
  short etaLast;
  PROD *lpprod;
  char ch;
  undefined3 uStack_71;
  char *pcStack_70;
  ushort uVar4;
  char szTemp;
  char local_69;
  undefined1 local_65;
  short cItem;
  short i;
  undefined2 rgwtMin [8];
  short fMinimal;
  
  if (((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) {
    fMinimal = 0;
  }
  else {
    fMinimal = 1;
  }
  if (fMinimal == 0) {
    lppl = &sel.pl;
    if (hwnd == 0) {
      hwnd = hwndPlanetProdLB;
    }
    SendMessage(hwnd,0x405,0,0);
  }
  uVar2 = (undefined2)((ulong)lppl >> 0x10);
  if (((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) {
                    /* WARNING: Load size is inaccurate */
    lpplprod = (PLPROD *)
               CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                        ((PLANET *)lppl)->lpplprod);
  }
  if ((((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) ||
     (((PLPROD *)lpplprod)->iprodMac == 0)) {
    pcVar1 = PszGetCompressedString(idsQueueEmpty);
    _ch = CONCAT22(pcVar1,_ch);
  }
  else {
    if (hwndProdDlg == 0) goto PLANET_NoMsg;
    pcVar1 = PszGetCompressedString(idsTopQueue);
    _ch = CONCAT22(pcVar1,_ch);
  }
  if (fMinimal == 0) {
    SendMessage(hwnd,0x401,0,(LPARAM)pcStack_70);
  }
  else if (pcStack_70 != (char *)szWork) {
    _strcpy((char *)szWork,pcStack_70);
  }
PLANET_NoMsg:
  if (((PLPROD *)lpplprod != (PLPROD *)0x0) || (lpplprod._2_2_ != 0)) {
    uVar4 = 0;
    for (i = 0; i < 4; i = i + 1) {
      rgwtMin[i * 2] = 0;
      rgwtMin[i * 2 + 1] = 0;
    }
    lpprod = (PROD *)CONCAT22(lpplprod._2_2_,(PLPROD *)lpplprod + 1);
    for (i = 0; i < (int)(uint)((PLPROD *)lpplprod)->iprodMac; i = i + 1) {
      pcVar1 = PszNameProdItem(lpprod);
      _ch = CONCAT22(pcVar1,_ch);
      EstimateItemProdSched(lppl,lpplprod,i,&etaFirst,&etaLast);
      if (((etaFirst == 0) && (etaLast == 0)) || ((etaFirst == -1 && (etaLast == -1)))) {
        if (fMinimal == 0) {
          _ch = CONCAT31(uStack_71,0x26);
          goto LAB_1048_693c;
        }
      }
      else {
        if (((etaFirst < 2) || (99 < etaFirst)) &&
           ((etaFirst != 100 ||
            ((uVar3 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),100), ((uint)uVar3 & 7) != 1 ||
             (uVar3 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),etaFirst),
             6 < ((uint)uVar3 & 0x7f))))))) {
          if ((etaFirst == 1) && (etaLast == 1)) {
            _ch = CONCAT31(uStack_71,0x2a);
          }
          else if (etaFirst < 100) {
            _ch = CONCAT31(uStack_71,0x23);
          }
          else {
            _ch = CONCAT31(uStack_71,0x21);
          }
        }
        else {
          _ch = CONCAT31(uStack_71,0x20);
        }
LAB_1048_693c:
        cItem = (uint)lpprod->dwFlags & 0x3ff;
        wsprintf((char *)&szTemp,(char *)0x112008c4,(int)ch,cItem,pcStack_70);
        lpprod = (PROD *)0x14f86986;
        uVar3 = __aFulshr(_ch,uVar4);
        if (((uint)uVar3 & 7) == 1) {
          lpprod = (PROD *)0x111869ae;
          uVar3 = __aFulshr(_ch,uVar4);
          if (((uint)uVar3 & 0x7f) < 7) {
            local_69 = local_69 + '\x02';
            lpprod = (PROD *)0x111869df;
            uVar3 = __aFulshr(_ch,uVar4);
            if (((uint)uVar3 & 0x7f) == 3) {
              local_65 = 0x2a;
            }
          }
          lpprod = (PROD *)0x11186a0b;
          uVar3 = __aFulshr(_ch,uVar4);
          if (((uint)uVar3 & 0x7f) != 0xc) {
            lpprod = (PROD *)0x11186a33;
            uVar3 = __aFulshr(_ch,uVar4);
            if (((uint)uVar3 & 0x7f) != 4) {
              lpprod = (PROD *)0x11186a5b;
              uVar3 = __aFulshr(_ch,uVar4);
              if (((uint)uVar3 & 0x7f) != 5) goto LAB_1048_6a75;
            }
          }
          local_69 = local_69 + '\x01';
        }
LAB_1048_6a75:
        if (fMinimal != 0) {
          lpprod = (PROD *)CONCAT22(&szTemp,(PROD *)szWork);
          etaLast = 0x1118;
          etaFirst = 0x6a8b;
          _strcpy((char *)szWork,&szTemp);
          return;
        }
        lpprod = (PROD *)CONCAT22(hwnd,(PROD *)0x401);
        etaLast = 0;
        unaff_SI = &szTemp;
        unaff_DI = 0x1118;
        etaFirst = unaff_SS;
        SendMessage(hwnd,0x401,0,(LPARAM)unaff_SI);
      }
      lpprod = (PROD *)CONCAT22(lpprod._2_2_,(PROD *)lpprod + 1);
    }
    if (fMinimal != 0) {
      CchGetString(idsQueueEmpty,(char *)szWork);
    }
  }
  return;
}



// ======================================================================
// Function: PctPlanetCapacity
// Address: 1048:6aca
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10486af9) */
/* WARNING: Removing unreachable block (ram,0x10486b64) */

short PctPlanetCapacity(PLANET *lppl)

{
  undefined2 uVar1;
  long lVar2;
  long lVar3;
  ulong uVar4;
  short pctCap;
  
  lVar2 = CalcPlanetMaxPop(lppl->id,idPlayer);
  if (lVar2 < 1) {
    pctCap = 0;
  }
  else {
    lVar3 = __aFldiv(lVar2,2);
    uVar1 = (undefined2)((ulong)lppl >> 0x10);
    uVar4 = __aFulmul(CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                                       (int)((PLANET *)lppl)->rgwtMin[3]),100);
    lVar2 = __aFldiv(uVar4 + lVar3,lVar2);
    pctCap = (short)lVar2;
    if (999 < lVar2) {
      pctCap = 999;
    }
  }
  return pctCap;
}



// ======================================================================
// Function: PctPlanetOptValue
// Address: 1048:6b88
// Segment: MEMORY_PLANET
// ======================================================================


short PctPlanetOptValue(PLANET *lppl,short iPlr)

{
  short sVar1;
  short iNewVal;
  int rgiValSav [3];
  short rgCost [3];
  short pctDesire;
  short rgMin [3];
  short i;
  short rgMax [4];
  
  sVar1 = FCanTerraformLppl(lppl,rgMin,rgMax,rgCost,1);
  if (sVar1 == 0) {
    pctDesire = PctPlanetDesirability(lppl,iPlr);
  }
  else {
    for (i = 0; i < 3; i = i + 1) {
      rgiValSav[i] = (int)((PLANET *)lppl)->rgEnvVar[i];
      if ((*(char *)(iPlr * 0xc0 + 0x59b5 + i) != -1) &&
         (((PLANET *)lppl)->rgEnvVar[i] != *(char *)(iPlr * 0xc0 + 0x59b2 + i))) {
        iNewVal = -1;
        if (((PLANET *)lppl)->rgEnvVar[i] < *(char *)(iPlr * 0xc0 + 0x59b2 + i)) {
          if ((int)((PLANET *)lppl)->rgEnvVar[i] < rgMax[i]) {
            if ((int)*(char *)(iPlr * 0xc0 + 0x59b2 + i) < rgMax[i]) {
              iNewVal = (short)*(char *)(iPlr * 0xc0 + 0x59b2 + i);
            }
            else {
              iNewVal = rgMax[i];
            }
          }
        }
        else if ((rgMin[i] != -1) && (rgMin[i] < (int)((PLANET *)lppl)->rgEnvVar[i])) {
          if (rgMin[i] < (int)*(char *)(iPlr * 0xc0 + 0x59b2 + i)) {
            iNewVal = (short)*(char *)(iPlr * 0xc0 + 0x59b2 + i);
          }
          else {
            iNewVal = rgMin[i];
          }
        }
        if (iNewVal != -1) {
          ((PLANET *)lppl)->rgEnvVar[i] = (char)iNewVal;
        }
      }
    }
    pctDesire = PctPlanetDesirability(lppl,idPlayer);
    for (i = 0; i < 3; i = i + 1) {
      ((PLANET *)lppl)->rgEnvVar[i] = (char)rgiValSav[i];
    }
  }
  return pctDesire;
}



// ======================================================================
// Function: PctPlanetDesirability
// Address: 1048:6e1e
// Segment: MEMORY_PLANET
// ======================================================================


short PctPlanetDesirability(PLANET *lppl,short iPlr)

{
  int iVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  short sVar5;
  uint uVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  bool bVar7;
  ulong uVar8;
  undefined1 *puVar9;
  long lVar10;
  undefined2 uVar11;
  undefined2 uVar12;
  short iPlanet;
  short pctVar;
  long pctPos;
  short dPenalty;
  short i;
  short iPref;
  uint pctNeg;
  int local_c;
  short iMax;
  short d;
  short iMin;
  
  pctPos = 0;
  pctNeg = 0;
  local_c = 0;
  puVar9 = &DAT_0000_2710;
  for (i = 0; i < 3; i = i + 1) {
    iVar1 = (int)((PLANET *)lppl)->rgEnvVar[i];
    iVar2 = (int)*(char *)(iPlr * 0xc0 + 0x59b2 + i);
    iVar3 = (int)*(char *)(iPlr * 0xc0 + 0x59b5 + i);
    iVar4 = (int)*(char *)(iPlr * 0xc0 + 0x59b8 + i);
    if (iVar4 < 0) {
      pctPos = CONCAT22(pctPos._2_2_ + (uint)(0xd8ef < (uint)pctPos),(uint)pctPos + 10000);
    }
    else if ((iVar1 < iVar3) || (iVar4 < iVar1)) {
      if (iVar1 < iVar3) {
        if (iVar3 - iVar1 < 0x10) {
          uVar6 = iVar3 - iVar1;
          iVar1 = (int)uVar6 >> 0xf;
        }
        else {
          uVar6 = 0xf;
          iVar1 = 0;
        }
        bVar7 = CARRY2(pctNeg,uVar6);
        pctNeg = pctNeg + uVar6;
        local_c = local_c + iVar1 + (uint)bVar7;
      }
      else {
        if (iVar1 - iVar4 < 0x10) {
          uVar6 = iVar1 - iVar4;
          iVar1 = (int)uVar6 >> 0xf;
        }
        else {
          uVar6 = 0xf;
          iVar1 = 0;
        }
        bVar7 = CARRY2(pctNeg,uVar6);
        pctNeg = pctNeg + uVar6;
        local_c = local_c + iVar1 + (uint)bVar7;
      }
    }
    else {
      sVar5 = _abs(iVar1 - iVar2);
      if (iVar1 < iVar2) {
        d = iVar2 - iVar3;
        dPenalty = (iVar2 - iVar1) * 2 - d;
      }
      else {
        d = iVar4 - iVar2;
        dPenalty = (iVar1 - iVar2) * 2 - d;
      }
      pctVar = (sVar5 * 100) / d;
      uVar8 = __aFulmul((long)(100 - pctVar),(long)(100 - pctVar));
      pctPos = uVar8 + pctPos;
      if (0 < dPenalty) {
        uVar8 = __aFulmul((ulong)puVar9,(long)(d * 2 - dPenalty));
        puVar9 = (undefined1 *)__aFldiv(uVar8,(long)(d << 1));
      }
    }
  }
  if ((pctNeg == 0) && (local_c == 0)) {
    _sqrt(SUB84((double)pctPos / DOUBLE_3_0__1120_1d2e,0),
                  (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)((double)pctPos /
                                                                            DOUBLE_3_0__1120_1d2e)
                                                                    >> 0x20))));
    uVar8 = __ftol((double)CONCAT26((int)((ulong)puVar9 >> 0x10),
                                            CONCAT24((undefined1 *)puVar9,
                                                     CONCAT22(unaff_SI,unaff_DI))));
    uVar12 = 0;
    uVar11 = 10000;
    uVar8 = __aFulmul(uVar8,(ulong)puVar9);
    lVar10 = __aFldiv(uVar8,CONCAT22(uVar12,uVar11));
    sVar5 = (short)lVar10;
  }
  else {
    sVar5 = -pctNeg;
  }
  return sVar5;
}



// ======================================================================
// Function: CalcPlanetMaxPop
// Address: 1048:7096
// Segment: MEMORY_PLANET
// ======================================================================


long CalcPlanetMaxPop(short idpl,short iplr)

{
  short sVar1;
  uint uVar2;
  int iVar3;
  undefined2 unaff_SS;
  ulong uVar4;
  long lVar5;
  short ihuldef;
  PLANET pl;
  
  FLookupPlanet(idpl,&pl);
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  if (sVar1 == raMacintosh) {
    if ((pl.iPlayer != iplr) || (((uint)pl.wFlags >> 9 & 1) == 0)) {
      return 0;
    }
    iVar3 = (*(int *)(*(int *)(iplr * 4 + 0x14c) + (pl._44_2_ & 0xf) * 0x93) + -0x20) * 4;
    uVar4 = CONCAT22(*(undefined2 *)(iVar3 + 0x8ce),*(undefined2 *)(iVar3 + 0x8cc));
  }
  else {
    uVar2 = PctPlanetDesirability((PLANET *)&pl,iplr);
    if (((int)uVar2 >> 0xf < 1) && (((int)uVar2 >> 0xf < 0 || (uVar2 < 5)))) {
      uVar4 = 500;
    }
    else {
      uVar4 = __aFulmul((long)(int)uVar2,100);
    }
    sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
    if (sVar1 == raCheapCol) {
      lVar5 = __aFldiv(uVar4,2);
      uVar4 = uVar4 - lVar5;
    }
    else {
      sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
      if (sVar1 == raNone) {
        lVar5 = __aFldiv(uVar4,5);
        uVar4 = lVar5 + uVar4;
      }
    }
  }
  sVar1 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceOBRM);
  if (sVar1 != 0) {
    lVar5 = __aFldiv(uVar4,10);
    uVar4 = lVar5 + uVar4;
  }
  return uVar4;
}



// ======================================================================
// Function: CMaxMines
// Address: 1048:7248
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104872b7) */

short CMaxMines(PLANET *lppl,short iplr)

{
  short sVar1;
  ulong uVar2;
  long lVar3;
  short iEff;
  short cMax;
  
  uVar2 = CalcPlanetMaxPop(lppl->id,iplr);
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMineOperate);
  lVar3 = 100;
  uVar2 = __aFulmul(uVar2,(long)sVar1);
  lVar3 = __aFldiv(uVar2,lVar3);
  if (lVar3 < 10) {
    lVar3 = 10;
  }
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  cMax = (short)lVar3;
  if (sVar1 == raMacintosh) {
    cMax = 0;
  }
  return cMax;
}



// ======================================================================
// Function: CMaxOperableMines
// Address: 1048:7304
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104873a5) */

short CMaxOperableMines(PLANET *lppl,short iplr,short fNextYear)

{
  short sVar1;
  short sVar2;
  ulong uVar3;
  long lVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  short iEff;
  short cMax;
  
  sVar1 = CMaxMines(lppl,iplr);
  sVar2 = GetRaceStat((PLAYER *)rgplr + iplr,rsMineOperate);
  uVar3 = CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                   (int)((PLANET *)lppl)->rgwtMin[3]);
  if (fNextYear != 0) {
    lVar4 = ChgPopFromPlanet(lppl,0);
    uVar3 = lVar4 + uVar3;
  }
  uVar6 = 0;
  uVar5 = 100;
  uVar3 = __aFulmul(uVar3,(long)sVar2);
  lVar4 = __aFldiv(uVar3,CONCAT22(uVar6,uVar5));
  cMax = (short)lVar4;
  if (sVar1 < lVar4) {
    cMax = sVar1;
  }
  if (cMax < 1) {
    cMax = 1;
  }
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  if (sVar1 == raMacintosh) {
    cMax = 0;
  }
  return cMax;
}



// ======================================================================
// Function: CMinesOperating
// Address: 1048:73fc
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Variable defined which should be unmapped: cMines */

short CMinesOperating(PLANET *lppl)

{
  short sVar1;
  uint uVar2;
  uint uVar3;
  PLANET *pPVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  long lVar6;
  ulong uVar7;
  short cMines;
  short cMinesOp;
  short iplr;
  
  uVar5 = (undefined2)((ulong)lppl >> 0x10);
  pPVar4 = (PLANET *)lppl;
  if (pPVar4->iPlayer == -1) {
    uVar3 = 0;
  }
  else {
    sVar1 = GetRaceStat((PLAYER *)rgplr + pPVar4->iPlayer,rsMajorAdv);
    if (sVar1 == raMacintosh) {
      _sqrt(SUB84((double)pPVar4->rgwtMin[3],0),
                    (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)pPVar4->
                                                  rgwtMin[3] >> 0x20))));
      lVar6 = __ftol((double)CONCAT26(cMinesOp,CONCAT24(cMines,CONCAT22(unaff_SI,unaff_DI)))
                            );
      uVar3 = (uint)lVar6;
    }
    else {
      uVar7 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),cMines);
      uVar2 = (uint)uVar7 & 0xfff;
      uVar3 = CMaxOperableMines(lppl,pPVar4->iPlayer,0);
      if ((int)uVar2 <= (int)uVar3) {
        uVar3 = uVar2;
      }
    }
  }
  return uVar3;
}



// ======================================================================
// Function: CFactoriesOperating
// Address: 1048:74be
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Variable defined which should be unmapped: cFactsOp */

short CFactoriesOperating(PLANET *lppl)

{
  int iVar1;
  short sVar2;
  uint uVar3;
  uint uVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  ulong uVar6;
  short cFactsOp;
  short cFacts;
  short iplr;
  
  uVar6 = CONCAT22(unaff_SI,unaff_DI);
  uVar5 = (undefined2)((ulong)lppl >> 0x10);
  iVar1 = ((PLANET *)lppl)->iPlayer;
  if (iVar1 == -1) {
    uVar4 = 0;
  }
  else {
    sVar2 = GetRaceStat((PLAYER *)rgplr + iVar1,rsMajorAdv);
    if (sVar2 == raMacintosh) {
      uVar4 = 0;
    }
    else {
      uVar6 = __aFulshr(uVar6,cFactsOp);
      uVar3 = (uint)uVar6 & 0xfff;
      uVar4 = CMaxOperableFactories(lppl,((PLANET *)lppl)->iPlayer,0);
      if ((int)uVar3 <= (int)uVar4) {
        uVar4 = uVar3;
      }
    }
  }
  return uVar4;
}



// ======================================================================
// Function: CMaxFactories
// Address: 1048:755c
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104875cb) */

short CMaxFactories(PLANET *lppl,short iplr)

{
  short sVar1;
  ulong uVar2;
  long lVar3;
  short iEff;
  short cMax;
  
  uVar2 = CalcPlanetMaxPop(lppl->id,iplr);
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsFactOperate);
  lVar3 = 100;
  uVar2 = __aFulmul(uVar2,(long)sVar1);
  lVar3 = __aFldiv(uVar2,lVar3);
  if (lVar3 < 10) {
    lVar3 = 10;
  }
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  cMax = (short)lVar3;
  if (sVar1 == raMacintosh) {
    cMax = 0;
  }
  return cMax;
}



// ======================================================================
// Function: CMaxOperableFactories
// Address: 1048:7618
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104876b9) */

short CMaxOperableFactories(PLANET *lppl,short iplr,short fNextYear)

{
  short sVar1;
  short sVar2;
  ulong uVar3;
  long lVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  short iEff;
  short cMax;
  
  sVar1 = CMaxFactories(lppl,iplr);
  sVar2 = GetRaceStat((PLAYER *)rgplr + iplr,rsFactOperate);
  uVar3 = CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                   (int)((PLANET *)lppl)->rgwtMin[3]);
  if (fNextYear != 0) {
    lVar4 = ChgPopFromPlanet(lppl,0);
    uVar3 = lVar4 + uVar3;
  }
  uVar6 = 0;
  uVar5 = 100;
  uVar3 = __aFulmul(uVar3,(long)sVar2);
  lVar4 = __aFldiv(uVar3,CONCAT22(uVar6,uVar5));
  cMax = (short)lVar4;
  if (sVar1 < lVar4) {
    cMax = sVar1;
  }
  if (cMax < 1) {
    cMax = 1;
  }
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  if (sVar1 == raMacintosh) {
    cMax = 0;
  }
  return cMax;
}



// ======================================================================
// Function: CMaxDefenses
// Address: 1048:7710
// Segment: MEMORY_PLANET
// ======================================================================


short CMaxDefenses(PLANET *lppl,short iplr)

{
  short sVar1;
  int iVar2;
  short pctDesire;
  short cMax;
  
  sVar1 = PctPlanetDesirability(lppl,iplr);
  if (sVar1 * 4 < 10) {
    iVar2 = 10;
  }
  else {
    iVar2 = sVar1 << 2;
  }
  if (iVar2 < 0x65) {
    if (sVar1 * 4 < 10) {
      cMax = 10;
    }
    else {
      cMax = sVar1 << 2;
    }
  }
  else {
    cMax = 100;
  }
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  if (sVar1 == raMacintosh) {
    cMax = 0;
  }
  return cMax;
}



// ======================================================================
// Function: CMaxOperableDefenses
// Address: 1048:77ae
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1048782c) */

short CMaxOperableDefenses(PLANET *lppl,short iplr,short fNextYear)

{
  short sVar1;
  long lVar2;
  long lVar3;
  int cCur;
  short cMax;
  
  cMax = CMaxDefenses(lppl,iplr);
  lVar3 = CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                   (int)((PLANET *)lppl)->rgwtMin[3]);
  if (fNextYear != 0) {
    lVar2 = ChgPopFromPlanet(lppl,0);
    lVar3 = lVar2 + lVar3;
  }
  lVar3 = __aFldiv(lVar3 + 0x18,0x19);
  if (1000 < lVar3) {
    lVar3 = 1000;
  }
  cCur = (int)lVar3;
  if (cCur <= cMax) {
    cMax = cCur;
  }
  sVar1 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
  if (sVar1 == raMacintosh) {
    cMax = 0;
  }
  return cMax;
}



// ======================================================================
// Function: CResourcesAtPlanet
// Address: 1048:788e
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1048790a) */
/* WARNING: Removing unreachable block (ram,0x10487954) */

short CResourcesAtPlanet(PLANET *lppl,short iplr)

{
  uint uVar1;
  int iVar2;
  double dVar3;
  short sVar4;
  short sVar5;
  PLANET *pPVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar7;
  long lVar8;
  ulong uVar9;
  long lVar10;
  undefined2 uVar11;
  ushort in_stack_0000ffca;
  long local_26;
  long local_1e;
  short iEnergy;
  short pctVal;
  short iEff;
  short cFact;
  long lPop;
  short cRes;
  
  uVar7 = (undefined2)((ulong)lppl >> 0x10);
  pPVar6 = (PLANET *)lppl;
  if (((int)pPVar6->rgwtMin[3] == 0) && (*(int *)((int)pPVar6->rgwtMin + 0xe) == 0)) {
    cRes = 0;
  }
  else {
    sVar4 = GetRaceStat((PLAYER *)rgplr + iplr,rsResGen);
    uVar1 = *(uint *)(pPVar6->rgwtMin + 3);
    iVar2 = *(int *)((int)pPVar6->rgwtMin + 0xe);
    lPop = CONCAT22(iVar2,uVar1);
    lVar8 = CalcPlanetMaxPop(lppl->id,iplr);
    if (lVar8 < lPop) {
      lVar10 = __aFldiv(CONCAT22((iVar2 - (int)((ulong)lVar8 >> 0x10)) -
                                         (uint)(uVar1 < (uint)lVar8),uVar1 - (uint)lVar8),2);
      lPop = lVar8 + lVar10;
      lVar8 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffca);
      if (lVar8 < lPop) {
        lPop = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffca);
      }
    }
    sVar5 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
    if (sVar5 == raMacintosh) {
      iEnergy = (short)*(char *)((int)rgplr[0].rgTech + iplr * 0xc0);
      PctPlanetDesirability(lppl,iplr);
      if (iEnergy < 1) {
        iEnergy = 1;
      }
      local_1e = (long)iEnergy;
      local_26 = (long)sVar4;
      dVar3 = ((double)local_1e * (double)lPop) / (double)local_26;
      _sqrt(SUB84(dVar3,0),
                    (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar3 >> 0x20))));
      lVar8 = __ftol((double)(qword)CONCAT24(10,CONCAT22(unaff_SI,unaff_DI)));
      cRes = (short)lVar8;
    }
    else {
      lVar8 = __aFldiv(lPop,(long)sVar4);
      cFact = CMaxOperableFactories(lppl,iplr,0);
      uVar9 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffca);
      if ((int)((uint)uVar9 & 0xfff) < cFact) {
        uVar9 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffca);
        cFact = (uint)uVar9 & 0xfff;
      }
      sVar4 = GetRaceStat((PLAYER *)rgplr + iplr,rsFactProd);
      uVar11 = 0;
      uVar7 = 10;
      uVar9 = __aFulmul((long)cFact,(long)sVar4);
      lVar10 = __aFldiv(uVar9 + 9,CONCAT22(uVar11,uVar7));
      cRes = (int)lVar8 + (int)lVar10;
    }
    if (cRes == 0) {
      cRes = 1;
    }
  }
  return cRes;
}



// ======================================================================
// Function: IWarpMAFromLppl
// Address: 1048:7b10
// Segment: MEMORY_PLANET
// ======================================================================


short IWarpMAFromLppl(PLANET *lppl,short *pfTwo)

{
  undefined2 uVar1;
  int iVar2;
  PLANET *pPVar3;
  int iVar4;
  undefined2 uVar5;
  short iNew;
  HUL *lphul;
  short i;
  short iWarp;
  short fTwo;
  
  iWarp = 0;
  fTwo = 0;
  if (pfTwo != (short *)0x0) {
    *pfTwo = 0;
  }
  uVar5 = (undefined2)((ulong)lppl >> 0x10);
  pPVar3 = (PLANET *)lppl;
  if ((pPVar3->iPlayer == -1) || (((uint)pPVar3->wFlags >> 9 & 1) == 0)) {
    iWarp = 0;
  }
  else if ((pPVar3->iPlayer == idPlayer) ||
          ((idPlayer == -1 ||
           (iVar4 = pPVar3->iPlayer * 4,
           (*(uint *)(*(int *)(iVar4 + 0x14c) + (*(uint *)&pPVar3->field11_0x2c & 0xf) * 0x93 + 0x7b
                     ) & 0xff) == 7)))) {
    iVar4 = pPVar3->iPlayer * 4;
    uVar1 = *(undefined2 *)(iVar4 + 0x14e);
    iVar4 = *(int *)(iVar4 + 0x14c) + (*(uint *)&pPVar3->field11_0x2c & 0xf) * 0x93;
    for (i = 0; i < (int)(uint)*(byte *)(iVar4 + 0x7a); i = i + 1) {
      if ((((*(int *)(iVar4 + 0x3a + i * 4) == 0x200) && (*(uint *)(iVar4 + i * 4 + 0x3c) >> 8 != 0)
           ) && (6 < (*(uint *)(iVar4 + i * 4 + 0x3c) & 0xff))) &&
         ((*(uint *)(iVar4 + i * 4 + 0x3c) & 0xff) < 0x10)) {
        iVar2 = (*(uint *)(iVar4 + i * 4 + 0x3c) & 0xff) - 2;
        if (iWarp < iVar2) {
          fTwo = 0;
          iWarp = iVar2;
        }
        else if (iVar2 == iWarp) {
          fTwo = 1;
        }
      }
    }
    if (pfTwo != (short *)0x0) {
      *pfTwo = fTwo;
    }
  }
  else {
    iWarp = 0;
  }
  return iWarp;
}



// ======================================================================
// Function: StargateRangeFromLppl
// Address: 1048:7cfa
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10487e13) */

short StargateRangeFromLppl(PLANET *lppl,short iplr,short ish)

{
  int iVar1;
  HUL *pHVar2;
  undefined2 uVar3;
  PART part;
  HUL *lphul;
  short i;
  
  if (lppl == (PLANET *)0x0) {
    lphul = (HUL *)CONCAT22(*(undefined2 *)(iplr * 4 + 0x14e),
                            (HUL *)(*(int *)(iplr * 4 + 0x14c) + ish * 0x93));
  }
  else {
    if ((((PLANET *)lppl)->iPlayer == -1) || (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) == 0)) {
      return 0;
    }
    iVar1 = ((PLANET *)lppl)->iPlayer * 4;
    lphul = (HUL *)CONCAT22(*(undefined2 *)(iVar1 + 0x14e),
                            (HUL *)(*(int *)(iVar1 + 0x14c) +
                                   (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) * 0x93));
  }
  i = 0;
  while( true ) {
    uVar3 = (undefined2)((ulong)lphul >> 0x10);
    pHVar2 = (HUL *)lphul;
    if ((int)(uint)pHVar2->chs <= i) {
      return 0;
    }
    if ((((pHVar2->rghs + i)->grhst == hstSpecialSB) && ((uint)pHVar2->rghs[i].wFlags >> 8 != 0)) &&
       ((pHVar2->rghs[i].wFlags & 0xffU) < 7)) break;
    i = i + 1;
  }
  part.hs.grhst = (pHVar2->rghs + i)->grhst;
  part.hs.wFlags = pHVar2->rghs[i].wFlags;
  FLookupPart(&part);
  uVar3 = (undefined2)((ulong)part.pcom >> 0x10);
  if (*(int *)((COMPART *)part.pcom)[1].rgTech != -1) {
    return *(short *)((COMPART *)part.pcom)[1].rgTech;
  }
  return 10000;
}



// ======================================================================
// Function: FProdIsTerra
// Address: 1048:7e9a
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10487f40) */
/* WARNING: Removing unreachable block (ram,0x10487ec8) */

short FProdIsTerra(PROD *lpprod)

{
  short sVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar2;
  ulong uVar3;
  ushort in_stack_0000fffc;
  
  uVar3 = CONCAT22(unaff_SI,unaff_DI);
  uVar2 = __aFulshr(uVar3,in_stack_0000fffc);
  if ((((uint)uVar2 & 7) == 1) &&
     (((uVar2 = __aFulshr(uVar3,in_stack_0000fffc), ((uint)uVar2 & 0x7f) == 0xc ||
       (uVar2 = __aFulshr(uVar3,in_stack_0000fffc), ((uint)uVar2 & 0x7f) == 4)) ||
      (uVar2 = __aFulshr(uVar3,in_stack_0000fffc), ((uint)uVar2 & 0x7f) == 5)))) {
    sVar1 = 1;
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: IpctCanTerraformLppl
// Address: 1048:7f56
// Segment: MEMORY_PLANET
// ======================================================================


short IpctCanTerraformLppl(PLANET *lppl)

{
  short sVar1;
  short ipct;
  short rgCost [3];
  short rgMin [3];
  short i;
  short rgMax [4];
  
  sVar1 = FCanTerraformLppl(lppl,rgMin,rgMax,rgCost,1);
  if (sVar1 == 0) {
    ipct = 0;
  }
  else {
    ipct = 0;
    for (i = 0; i < 3; i = i + 1) {
      if (rgMin[i] != -1) {
        ipct = ipct + ((int)((PLANET *)lppl)->rgEnvVar[i] - rgMin[i]);
      }
      if (rgMax[i] != -1) {
        ipct = ipct + (rgMax[i] - (int)((PLANET *)lppl)->rgEnvVar[i]);
      }
    }
  }
  return ipct;
}



// ======================================================================
// Function: FCanTerraformLppl
// Address: 1048:8022
// Segment: MEMORY_PLANET
// ======================================================================


short FCanTerraformLppl(PLANET *lppl,short *rgEnvMin,short *rgEnvMax,short *rgEnvCost,short fHelp)

{
  short sVar1;
  uint uVar2;
  int iVar3;
  PLANET *pPVar4;
  COMPART *pCVar5;
  undefined2 uVar6;
  undefined2 uVar7;
  short ienvIdeal;
  short dCur;
  short dMax;
  short dMin;
  PART part;
  short iPlrSav;
  int rgMove [3];
  short i;
  short fRet;
  
  iPlrSav = idPlayer;
  pPVar4 = (PLANET *)lppl;
  uVar6 = (undefined2)((ulong)lppl >> 0x10);
  if (idPlayer == -1) {
    idPlayer = pPVar4->iPlayer;
  }
  part.hs.grhst = hstTerra;
  for (i = 7; -1 < i; i = i + -1) {
    part.hs.wFlags = part.hs.wFlags & 0xff00U | i & 0xffU;
    sVar1 = FLookupPart(&part);
    if (sVar1 == 1) break;
  }
  if (i < 0) {
    fRet = 0;
    for (i = 0; i < 3; i = i + 1) {
      rgMove[i] = 0;
    }
  }
  else {
    fRet = 1;
    for (i = 0; i < 3; i = i + 1) {
      uVar7 = (undefined2)((ulong)part.pcom >> 0x10);
      rgMove[i] = ((COMPART *)part.pcom + 1)->id;
      rgEnvCost[i] = ((COMPART *)part.pcom)->resCost;
    }
  }
  for (i = 3; -1 < i; i = i + -1) {
    part.hs.wFlags = part.hs.wFlags & 0xff00U | i + 8U & 0xff;
    sVar1 = FLookupPart(&part);
    if (sVar1 == 1) break;
  }
  if (-1 < i) {
    uVar7 = (undefined2)((ulong)part.pcom >> 0x10);
    pCVar5 = (COMPART *)part.pcom;
    if (rgMove[0] < (pCVar5 + 1)->id) {
      fRet = 1;
      rgMove[0] = (pCVar5 + 1)->id;
      *rgEnvCost = pCVar5->resCost;
    }
  }
  for (i = 3; -1 < i; i = i + -1) {
    part.hs.wFlags = part.hs.wFlags & 0xff00U | i + 0xcU & 0xff;
    sVar1 = FLookupPart(&part);
    if (sVar1 == 1) break;
  }
  if (-1 < i) {
    uVar7 = (undefined2)((ulong)part.pcom >> 0x10);
    pCVar5 = (COMPART *)part.pcom;
    if (rgMove[1] < (pCVar5 + 1)->id) {
      fRet = 1;
      rgMove[1] = (pCVar5 + 1)->id;
      rgEnvCost[1] = pCVar5->resCost;
    }
  }
  for (i = 3; -1 < i; i = i + -1) {
    part.hs.wFlags = part.hs.wFlags & 0xff00U | i + 0x10U & 0xff;
    sVar1 = FLookupPart(&part);
    if (sVar1 == 1) break;
  }
  if (-1 < i) {
    uVar7 = (undefined2)((ulong)part.pcom >> 0x10);
    pCVar5 = (COMPART *)part.pcom;
    if (rgMove[2] < (pCVar5 + 1)->id) {
      fRet = 1;
      rgMove[2] = (pCVar5 + 1)->id;
      rgEnvCost[2] = pCVar5->resCost;
    }
  }
  if (fRet == 0) {
    idPlayer = iPlrSav;
    uVar2 = 0;
  }
  else {
    for (i = 0; i < 3; i = i + 1) {
      if ((rgMove[i] == 0) || (*(char *)(idPlayer * 0xc0 + 0x59b5 + i) == -1)) {
        rgEnvMax[i] = -1;
        rgEnvMin[i] = -1;
      }
      else {
        rgEnvMin[i] = (int)pPVar4->rgEnvVarOrig[i] - rgMove[i];
        rgEnvMax[i] = (int)pPVar4->rgEnvVarOrig[i] + rgMove[i];
        if (rgEnvMin[i] < (int)pPVar4->rgEnvVar[i]) {
          if (rgEnvMin[i] < 1) {
            sVar1 = 1;
          }
          else {
            sVar1 = rgEnvMin[i];
          }
          rgEnvMin[i] = sVar1;
        }
        else {
          rgEnvMin[i] = -1;
        }
        if ((int)pPVar4->rgEnvVar[i] < rgEnvMax[i]) {
          if (rgEnvMax[i] < 100) {
            sVar1 = rgEnvMax[i];
          }
          else {
            sVar1 = 99;
          }
          rgEnvMax[i] = sVar1;
        }
        else {
          rgEnvMax[i] = -1;
        }
        if (fHelp == 0) {
          iVar3 = (int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
          sVar1 = _abs(pPVar4->rgEnvVar[i] - iVar3);
          if (rgEnvMin[i] == -1) {
            dMin = 0;
          }
          else {
            dMin = _abs(rgEnvMin[i] - iVar3);
          }
          if (rgEnvMax[i] == -1) {
            dMax = 0;
          }
          else {
            dMax = _abs(rgEnvMax[i] - iVar3);
          }
          if ((sVar1 < dMin) || (sVar1 < dMax)) {
            if (dMin < dMax) {
              rgEnvMin[i] = -1;
            }
            else {
              rgEnvMax[i] = -1;
            }
          }
          else {
            rgEnvMax[i] = -1;
            rgEnvMin[i] = -1;
          }
        }
        else if (pPVar4->rgEnvVar[i] == *(char *)(idPlayer * 0xc0 + 0x59b2 + i)) {
          rgEnvMax[i] = -1;
          rgEnvMin[i] = -1;
        }
        else if (*(char *)(idPlayer * 0xc0 + 0x59b2 + i) < pPVar4->rgEnvVar[i]) {
          rgEnvMax[i] = -1;
          if (rgEnvMin[i] != -1) {
            if ((int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i) < rgEnvMin[i]) {
              iVar3 = rgEnvMin[i];
            }
            else {
              iVar3 = (int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
            }
            rgEnvMin[i] = iVar3;
          }
        }
        else {
          rgEnvMin[i] = -1;
          if (rgEnvMax[i] != -1) {
            if (rgEnvMax[i] < (int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i)) {
              iVar3 = rgEnvMax[i];
            }
            else {
              iVar3 = (int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
            }
            rgEnvMax[i] = iVar3;
          }
        }
      }
    }
    for (i = 0; ((i < 3 && (rgEnvMax[i] == -1)) && (rgEnvMin[i] == -1)); i = i + 1) {
    }
    idPlayer = iPlrSav;
    uVar2 = (uint)(i != 3);
  }
  return uVar2;
}



// ======================================================================
// Function: UninhabitPlanet
// Address: 1048:8732
// Segment: MEMORY_PLANET
// ======================================================================


void UninhabitPlanet(PLANET *lppl)

{
  int iVar1;
  uint uVar2;
  undefined2 uVar3;
  PLANET *pPVar4;
  short sVar5;
  PLANET *pPVar6;
  undefined2 uVar7;
  short i;
  
  uVar7 = (undefined2)((ulong)lppl >> 0x10);
  pPVar6 = (PLANET *)lppl;
  if ((-1 < pPVar6->iPlayer) &&
     (sVar5 = GetRaceStat((PLAYER *)rgplr + pPVar6->iPlayer,rsMajorAdv),
     sVar5 == raTerra)) {
    for (i = 0; i < 3; i = i + 1) {
      pPVar6->rgEnvVar[i] = pPVar6->rgEnvVarOrig[i];
    }
  }
  pPVar6->iPlayer = -1;
  *(undefined2 *)(pPVar6->rgwtMin + 3) = 0;
  *(undefined2 *)((int)pPVar6->rgwtMin + 0xe) = 0;
  if ((*(int *)&pPVar6->lpplprod != 0) || (*(int *)((int)&pPVar6->lpplprod + 2) != 0)) {
    FreePl((PL *)CONCAT22(*(undefined2 *)
                                   ((int)&((PLANET *)lpPlanets)[lppl->id].lpplprod + 2),
                                  *(PL **)&((PLANET *)lpPlanets)[lppl->id].lpplprod));
    uVar3 = lpPlanets._2_2_;
    pPVar4 = (PLANET *)lpPlanets;
    iVar1 = lppl->id;
    *(undefined2 *)&((PLANET *)lpPlanets)[iVar1].lpplprod = 0;
    *(undefined2 *)((int)&pPVar4[iVar1].lpplprod + 2) = 0;
    *(undefined2 *)&pPVar6->lpplprod = 0;
    *(undefined2 *)((int)&pPVar6->lpplprod + 2) = 0;
  }
  uVar2 = *(uint *)((int)&pPVar6->dwFlags + 2);
  *(int *)&pPVar6->dwFlags = (int)pPVar6->dwFlags;
  *(uint *)((int)&pPVar6->dwFlags + 2) = uVar2 & 0xff7f;
  pPVar6->wFlags = pPVar6->wFlags & 0xfdff;
  uVar3 = *(undefined2 *)((int)&pPVar6->dwFlags + 2);
  *(uint *)&pPVar6->dwFlags = *(uint *)&pPVar6->dwFlags & 0xf000;
  *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar3;
  uVar2 = *(uint *)((int)&pPVar6->dwFlags + 2);
  *(uint *)&pPVar6->dwFlags = *(uint *)&pPVar6->dwFlags & 0xfff | 0xf000;
  *(uint *)((int)&pPVar6->dwFlags + 2) = uVar2 & 0xfffe | 1;
  *(undefined2 *)&pPVar6->field11_0x2c = 0;
  pPVar6->wFlags = 0;
  return;
}



// ======================================================================
// Function: PctCloakFromHuldef
// Address: 1048:88c0
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10488a4b) */

short PctCloakFromHuldef(HUL *lphul,short iplr,short *ppctSteal)

{
  int iVar1;
  byte bVar2;
  uint uVar3;
  short sVar4;
  undefined2 uVar5;
  bool bVar6;
  short j;
  short cScore;
  uint cPts;
  uint local_c;
  HS *lphs;
  short chs;
  
  uVar5 = (undefined2)((ulong)lphul >> 0x10);
  bVar2 = ((HUL *)lphul)->chs;
  if (((iplr == -1) || ((int)lphul->ihuldef < 0x20)) ||
     (sVar4 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceISB), sVar4 == 0)) {
    cPts = 0;
  }
  else {
    cPts = 0x28;
  }
  local_c = 0;
  if ((iplr != -1) &&
     (sVar4 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv), sVar4 == raStealth)) {
    bVar6 = 0xfed3 < cPts;
    cPts = cPts + 300;
    local_c = (uint)bVar6;
  }
  if (ppctSteal != (short *)0x0) {
    *ppctSteal = 0;
  }
  lphs = (HS *)CONCAT22(uVar5,((HUL *)lphul)->rghs);
  for (j = 0; j < (int)(uint)bVar2; j = j + 1) {
    uVar3 = CPtsCloakFromLphs(lphs);
    bVar6 = CARRY2(cPts,uVar3);
    cPts = cPts + uVar3;
    local_c = local_c + ((int)uVar3 >> 0xf) + (uint)bVar6;
    if ((lphs->grhst == hstScanner) && (ppctSteal != (short *)0x0)) {
      if ((((HS *)lphs)->wFlags & 0xffU) == 5) {
        if (*ppctSteal < 0x46) {
          *ppctSteal = 0x46;
        }
      }
      else if (((((HS *)lphs)->wFlags & 0xffU) == 0xe) && (*ppctSteal < 0x50)) {
        *ppctSteal = 0x50;
      }
    }
    lphs = (HS *)CONCAT22(lphs._2_2_,(HS *)lphs + 1);
  }
  if ((cPts == 0) && (local_c == 0)) {
    sVar4 = 0;
  }
  else if (((int)local_c < 0) || ((-1 < (int)local_c && ((0 < (int)local_c || (25000 < cPts)))))) {
    sVar4 = 0;
  }
  else if ((int)cPts < 0x65) {
    sVar4 = (int)cPts >> 1;
  }
  else if ((int)(cPts - 100) < 0xc9) {
    sVar4 = ((int)(cPts - 100) >> 3) + 0x32;
  }
  else if ((int)(cPts - 300) < 0x139) {
    sVar4 = (int)(cPts - 300) / 0x18 + 0x4b;
  }
  else {
    iVar1 = cPts - 0x264;
    if (iVar1 < 0x201) {
      sVar4 = (iVar1 >> 6) + 0x58;
    }
    else if (iVar1 < 1000) {
      sVar4 = (0x2ff < iVar1) + 0x60;
    }
    else {
      sVar4 = 0x62;
    }
  }
  return sVar4;
}



// ======================================================================
// Function: LogSplitFleet
// Address: 1048:8b0e
// Segment: MEMORY_PLANET
// ======================================================================


void LogSplitFleet(short id)

{
  FLEET *pFVar1;
  short *local_8;
  undefined2 uStack_6;
  
  if (((uint)gd._0_2_ >> 1 & 1) == 0) {
    WriteMemRt(0x18,2,&id);
  }
  else {
    pFVar1 = LpflFromId(id);
    _local_8 = (uint *)CONCAT22((int)((ulong)pFVar1 >> 0x10),&((FLEET *)pFVar1)->wFlags);
    *_local_8 = *_local_8 & 0xffdf | 0x20;
  }
  return;
}



// ======================================================================
// Function: LogMergeFleet
// Address: 1048:8b6c
// Segment: MEMORY_PLANET
// ======================================================================


void LogMergeFleet(short id)

{
  short j;
  ushort rgid [512];
  short i;
  ushort idCur;
  
  if (((uint)gd._0_2_ >> 1 & 1) == 0) {
    i = 0;
    while (i < vcflMerge) {
      rgid[0] = id;
      j = 1;
      for (; (j < 0x1ff && (i < vcflMerge)); i = i + 1) {
        if ((vrgiflMerge[i] != -1) && (idCur = vrgiflMerge[i], idCur != id)) {
          rgid[j] = idCur;
          j = j + 1;
        }
      }
      WriteMemRt(0x25,j << 1,rgid);
    }
  }
  return;
}



// ======================================================================
// Function: LogChangeShDef
// Address: 1048:8c28
// Segment: MEMORY_PLANET
// ======================================================================


void LogChangeShDef(SHDEF *lpshdefNew)

{
  uint uVar1;
  uint uVar2;
  SHDEF *pSVar3;
  undefined2 uVar4;
  byte *pb;
  uint rgb;
  byte local_98 [150];
  
  if (((uint)gd._0_2_ >> 1 & 1) == 0) {
    uVar4 = (undefined2)((ulong)lpshdefNew >> 0x10);
    pSVar3 = (SHDEF *)lpshdefNew;
    uVar1 = ((uint)pSVar3->wFlags >> 10 & 0x1f) << 8;
    uVar2 = (idPlayer & 0xfU) << 4;
    if (((uint)pSVar3->wFlags >> 9 & 1) == 0) {
      rgb = rgb & 0xe000 | uVar1 | uVar2 | 1;
      pSVar3->wFlags = pSVar3->wFlags & 0xff00U | 7;
      pb = local_98;
      WriteRtShDef(lpshdefNew,&pb);
      WriteMemRt(0x1b,(int)pb - (int)&rgb,&rgb);
    }
    else {
      rgb = rgb & 0xe000 | uVar1 | uVar2;
      WriteMemRt(0x1b,2,&rgb);
    }
    if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
      tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
      AdvanceTutor();
    }
  }
  return;
}



// ======================================================================
// Function: LogChangeName
// Address: 1048:8d5a
// Segment: MEMORY_PLANET
// ======================================================================


void LogChangeName(GrobjClass grobj,short id,char *szName)

{
  ushort uVar1;
  short sVar2;
  int iVar3;
  FLEET *pFVar4;
  undefined2 uVar5;
  undefined2 unaff_SS;
  void *pvVar6;
  HeapType ht;
  short rtchgname;
  GrobjClass local_2e;
  undefined1 local_2c;
  char local_2b [33];
  short cOut;
  FLEET *lpfl;
  
  lpfl = LpflFromId(id);
  iVar3 = (int)((ulong)lpfl >> 0x10);
  pFVar4 = (FLEET *)lpfl;
  if ((pFVar4 != (FLEET *)0x0) || (iVar3 != 0)) {
    if ((*(int *)&pFVar4->lpszName != 0) || (*(int *)((int)&pFVar4->lpszName + 2) != 0)) {
                    /* WARNING: Load size is inaccurate */
      FreeLp((void *)CONCAT22(*(undefined2 *)((int)&pFVar4->lpszName + 2),pFVar4->lpszName),
                     htString);
    }
    if ((szName == (char *)0x0) || (*szName == '\0')) {
      local_2c = 0;
      local_2b[0] = '\0';
      cOut = 1;
      uVar5 = (undefined2)((ulong)lpfl >> 0x10);
      *(undefined2 *)&((FLEET *)lpfl)->lpszName = 0;
      *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = 0;
    }
    else {
      cOut = _strlen(szName);
      ht = htString;
      uVar1 = _strlen(szName);
      pvVar6 = LpAlloc(uVar1 + 1,ht);
      uVar5 = (undefined2)((ulong)lpfl >> 0x10);
      pFVar4 = (FLEET *)lpfl;
      *(void **)&pFVar4->lpszName = (void *)pvVar6;
      *(undefined2 *)((int)&pFVar4->lpszName + 2) = (int)((ulong)pvVar6 >> 0x10);
                    /* WARNING: Load size is inaccurate */
      __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&pFVar4->lpszName + 2),
                                         pFVar4->lpszName),(char *)szName);
      sVar2 = FCompressUserString((char *)szName,(char *)local_2b,&cOut);
      if (sVar2 == 0) {
        local_2c = 0;
        _strcpy(local_2b,szName);
        cOut = cOut + 1;
      }
      else {
        local_2c = (undefined1)cOut;
      }
    }
    local_2e = grobj;
    rtchgname = id;
    WriteMemRt(0x2c,cOut + 5,&rtchgname);
    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
  }
  return;
}



// ======================================================================
// Function: LogChangeFleet
// Address: 1048:8ebe
// Segment: MEMORY_PLANET
// ======================================================================


void LogChangeFleet(FLEET *pfl,FLEET *pflNew)

{
  uint *puVar1;
  short *psVar2;
  GrobjClass *pGVar3;
  LOGXFERF *pLVar4;
  LOGXFER *pLVar5;
  GrobjClass *pGVar6;
  uint uVar7;
  undefined2 uVar8;
  int iVar9;
  GrobjClass GVar10;
  short sVar11;
  GrobjClass GVar12;
  short *psVar13;
  GrobjClass *pGVar14;
  LOGXFERF *pLVar15;
  LOGXFER *pLVar16;
  GrobjClass *pGVar17;
  undefined2 unaff_SS;
  undefined1 lxfNew [2];
  HDR hdr;
  short cbWp;
  short iordOld;
  short iordNew;
  short rtsi;
  uint lxNew;
  char cStack_21;
  GrobjClass rtwp [11];
  short fChg;
  short i;
  short d;
  
  fChg = 0;
  if (((uint)gd._0_2_ >> 1 & 1) == 0) {
    lxfNew = (undefined1  [2])pfl->id;
    hdr.wFlags = 2;
    i = 0;
    while( true ) {
      if (0xf < i) break;
      iVar9 = pflNew->rgcsh[i] - ((FLEET *)pfl)->rgcsh[i];
      (&cbWp)[i] = iVar9;
      if (iVar9 != 0) {
        fChg = 1;
      }
      i = i + 1;
    }
    if (fChg == 0) {
      lxNew = pfl->id;
      rtwp[0] = grobjFleet;
      for (i = 0; sVar11 = i, i < 5; i = i + 1) {
        uVar7 = *(uint *)(pflNew->rgwtMin + i);
        puVar1 = (uint *)(((FLEET *)pfl)->rgwtMin + i);
        GVar10 = uVar7 - *puVar1;
        GVar12 = (*(uint *)((int)(pflNew->rgwtMin + i) + 2) -
                 *(uint *)((int)(((FLEET *)pfl)->rgwtMin + i) + 2)) - (uint)(uVar7 < *puVar1);
        rtwp[i * 2 + 1] = GVar10;
        rtwp[sVar11 * 2 + 2] = GVar12;
        if ((GVar10 != grobjNone) || (GVar12 != grobjNone)) {
          fChg = 1;
        }
      }
      if (fChg == 0) {
        cbWp = (short)((FLEET *)pfl)->iplan;
        if (cbWp != (uint)pflNew->iplan) {
          rtsi = pflNew->id;
          lxNew = (uint)pflNew->iplan;
          WriteMemRt(0x2a,4,&stack0xffdc);
        }
        if (((uint)((FLEET *)pfl)->wFlags >> 9 & 1) != ((uint)pflNew->wFlags >> 9 & 1)) {
          rtsi = pflNew->id;
          lxNew = (uint)pflNew->wFlags >> 9 & 1;
          WriteMemRt(10,4,&stack0xffdc);
        }
        d = pflNew->cord - ((FLEET *)pfl)->cord;
        for (iordOld = 0; (iordOld < ((FLEET *)pfl)->cord && (iordOld < pflNew->cord));
            iordOld = iordOld + 1) {
          cbWp = *(short *)((int)&pflNew->lpplord + 2);
          hdr.wFlags = *(int *)&pflNew->lpplord + 4;
          lxfNew = (undefined1  [2])*(short *)((int)&((FLEET *)pfl)->lpplord + 2);
          sVar11 = __fmemcmp((void *)CONCAT22(lxfNew,(void *)(*(int *)&((FLEET *)pfl)->
                                                                               lpplord + 4 +
                                                                     iordOld * 0x12)),
                                     (void *)CONCAT22(cbWp,(void *)(hdr.wFlags + iordOld * 0x12)),
                                     0x12);
          if (sVar11 != 0) break;
        }
        iordNew = iordOld;
        if ((iordOld != ((FLEET *)pfl)->cord) || (d != 0)) {
          if (d < 0) {
            rtsi = pflNew->id;
            lxNew = iordOld;
            if (d == -2) {
              lxNew = iordOld | 0x8000;
            }
            WriteMemRt(3,4,&stack0xffdc);
          }
          else if (d < 1) {
            cbWp = 0x16;
            sVar11 = FGetPrevLogRt(&hdr,(byte *)rgbCur);
            if ((((sVar11 != 0) && ((uint)hdr.wFlags >> 10 == 5)) &&
                (rgbCur._0_2_ == pflNew->id)) && (rgbCur._2_2_ == iordNew)) {
              imemLogCur = imemLogPrev;
            }
            rtwp[0] = pflNew->id;
            rtwp[1] = iordNew;
            uVar8 = *(undefined2 *)((int)&pflNew->lpplord + 2);
            pGVar14 = (GrobjClass *)(*(int *)&pflNew->lpplord + 4 + iordNew * 0x12);
            pGVar17 = rtwp + 2;
            for (iVar9 = 9; iVar9 != 0; iVar9 = iVar9 + -1) {
              pGVar6 = pGVar17;
              pGVar17 = pGVar17 + 1;
              pGVar3 = pGVar14;
              pGVar14 = pGVar14 + 1;
              *pGVar6 = *pGVar3;
            }
            lxfNew = (undefined1  [2])rtwp;
            sVar11 = cbWp;
            do {
              cbWp = sVar11;
              if (cbWp < 1) break;
              sVar11 = cbWp + -1;
            } while (*(char *)((int)lxfNew + cbWp + -1) == '\0');
            WriteMemRt(5,cbWp,rtwp);
          }
          else {
            cbWp = 0x16;
            rtwp[0] = pflNew->id;
            rtwp[1] = iordOld;
            uVar8 = *(undefined2 *)((int)&pflNew->lpplord + 2);
            pGVar14 = (GrobjClass *)(*(int *)&pflNew->lpplord + 4 + iordOld * 0x12);
            pGVar17 = rtwp + 2;
            for (iVar9 = 9; iVar9 != 0; iVar9 = iVar9 + -1) {
              pGVar6 = pGVar17;
              pGVar17 = pGVar17 + 1;
              pGVar3 = pGVar14;
              pGVar14 = pGVar14 + 1;
              *pGVar6 = *pGVar3;
            }
            hdr.wFlags = (short)rtwp;
            sVar11 = cbWp;
            do {
              cbWp = sVar11;
              if (cbWp < 1) break;
              sVar11 = cbWp + -1;
            } while (*(char *)(hdr.wFlags + cbWp + -1) == '\0');
            WriteMemRt(4,cbWp,rtwp);
          }
        }
      }
      else if (fValidLx == 0) {
        psVar13 = (short *)&stack0xffde;
        pLVar16 = (LOGXFER *)&lx;
        for (iVar9 = 0xc; iVar9 != 0; iVar9 = iVar9 + -1) {
          pLVar5 = pLVar16;
          pLVar16 = (LOGXFER *)&pLVar16->grobj;
          psVar2 = psVar13;
          psVar13 = psVar13 + 1;
          pLVar5->id = *psVar2;
        }
        fValidLx = 1;
      }
      else {
        LogMakeValidXfer((LOGXFER *)&lx,(LOGXFER *)&stack0xffde);
        fValidLx = 0;
      }
    }
    else if (fValidLxf == 0) {
      psVar13 = (short *)lxfNew;
      pLVar15 = (LOGXFERF *)&lxf;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pLVar4 = pLVar15;
        pLVar15 = (LOGXFERF *)&pLVar15->grobj;
        psVar2 = psVar13;
        psVar13 = psVar13 + 1;
        pLVar4->id = *psVar2;
      }
      fValidLxf = 1;
    }
    else {
      LogMakeValidXferf((LOGXFERF *)&lxf,(LOGXFERF *)lxfNew);
      fValidLxf = 0;
    }
  }
  return;
}



// ======================================================================
// Function: LogChangeRelations
// Address: 1048:9340
// Segment: MEMORY_PLANET
// ======================================================================


void LogChangeRelations(void)

{
  short sVar1;
  HDR hdr;
  
  sVar1 = FGetPrevLogRt(&hdr,(byte *)rgbCur);
  if ((sVar1 != 0) && ((uint)hdr.wFlags >> 10 == 0x26)) {
    imemLogCur = imemLogPrev;
  }
  WriteMemRt(0x26,game.cPlayer,
             (void *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0));
  if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
    tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
    AdvanceTutor();
  }
  return;
}



// ======================================================================
// Function: LogChangeBtlplan
// Address: 1048:93d0
// Segment: MEMORY_PLANET
// ======================================================================


void LogChangeBtlplan(BTLPLAN *pbtlplan)

{
  WriteBattlePlan((BTLPLAN *)pbtlplan,1);
  if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
    tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
    AdvanceTutor();
  }
  return;
}



// ======================================================================
// Function: LogChangePlanet
// Address: 1048:9420
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10489758) */

void LogChangePlanet(PLANET *ppl,PLANET *pplNew)

{
  uint *puVar1;
  LOGXFER *pLVar2;
  LOGXFER *pLVar3;
  bool bVar4;
  int iVar5;
  short sVar6;
  uint uVar7;
  int iVar8;
  undefined2 unaff_SI;
  LOGXFER *pLVar9;
  undefined2 unaff_DI;
  LOGXFER *pLVar10;
  ulong uVar11;
  long lVar12;
  ulong uVar13;
  ushort in_stack_0000ffd6;
  LOGXFER lxNew;
  HDR hdr;
  short fChg;
  short i;
  
  uVar13 = CONCAT22(unaff_SI,unaff_DI);
  bVar4 = false;
  if (((uint)gd._0_2_ >> 1 & 1) != 0) {
    return;
  }
  if (ppl == (PLANET *)0x0) {
    if (fValidLx == 0) {
      return;
    }
    lxNew.id = -1;
    lxNew.grobj = grobjOther;
    for (i = 0; i < 5; i = i + 1) {
      iVar5 = *(int *)((int)lx.rgdItem + i * 4);
      iVar8 = *(int *)((int)lx.rgdItem + 2 + i * 4);
      *(int *)(lxNew.rgdItem + i) = -iVar5;
      *(int *)((int)lxNew.rgdItem + i * 4 + 2) = -(iVar8 + (uint)(iVar5 != 0));
    }
  }
  else {
    lxNew.id = ppl->id;
    lxNew.grobj = grobjPlanet;
    for (i = 0; i < 4; i = i + 1) {
      uVar7 = *(uint *)(pplNew->rgwtMin + i);
      puVar1 = (uint *)(((PLANET *)ppl)->rgwtMin + i);
      iVar5 = uVar7 - *puVar1;
      iVar8 = (*(uint *)((int)(pplNew->rgwtMin + i) + 2) -
              *(uint *)((int)(((PLANET *)ppl)->rgwtMin + i) + 2)) - (uint)(uVar7 < *puVar1);
      *(int *)(lxNew.rgdItem + i) = iVar5;
      *(int *)((int)lxNew.rgdItem + i * 4 + 2) = iVar8;
      if ((iVar5 != 0) || (iVar8 != 0)) {
        bVar4 = true;
      }
    }
    lxNew.rgdItem[4]._0_2_ = 0;
    lxNew.rgdItem[4]._2_2_ = 0;
    if (!bVar4) goto LAB_1048_9573;
  }
  if (fValidLx == 0) {
    pLVar9 = &lxNew;
    pLVar10 = (LOGXFER *)&lx;
    for (iVar5 = 0xc; iVar5 != 0; iVar5 = iVar5 + -1) {
      pLVar3 = pLVar10;
      pLVar10 = (LOGXFER *)&pLVar10->grobj;
      pLVar2 = pLVar9;
      pLVar9 = (LOGXFER *)&pLVar9->grobj;
      pLVar3->id = pLVar2->id;
    }
    fValidLx = 1;
  }
  else {
    LogMakeValidXfer((LOGXFER *)&lx,&lxNew);
    fValidLx = 0;
  }
LAB_1048_9573:
  if (ppl != (PLANET *)0x0) {
    if (((*(int *)&pplNew->lpplprod == 0) && (*(int *)((int)&pplNew->lpplprod + 2) == 0)) &&
       ((*(int *)&((PLANET *)ppl)->lpplprod != 0 ||
        (*(int *)((int)&((PLANET *)ppl)->lpplprod + 2) != 0)))) {
      WriteMemRt(0x1d,2,&lxNew);
    }
    else if (((*(int *)&pplNew->lpplprod != 0) || (*(int *)((int)&pplNew->lpplprod + 2) != 0)) &&
            (((*(int *)&((PLANET *)ppl)->lpplprod == 0 &&
              (*(int *)((int)&((PLANET *)ppl)->lpplprod + 2) == 0)) ||
             ((((PLPROD *)((PLANET *)ppl)->lpplprod)->iprodMac !=
               ((PLPROD *)pplNew->lpplprod)->iprodMac ||
              (sVar6 = __fmemcmp((void *)CONCAT22(*(undefined2 *)
                                                           ((int)&((PLANET *)ppl)->lpplprod + 2),
                                                          (void *)(*(int *)&((PLANET *)ppl)->
                                                                            lpplprod + 4)),
                                         (void *)CONCAT22(*(undefined2 *)
                                                           ((int)&pplNew->lpplprod + 2),
                                                          (void *)(*(int *)&pplNew->lpplprod + 4)),
                                         (uint)((PLPROD *)((PLANET *)ppl)->lpplprod)->iprodMac << 2)
              , sVar6 != 0)))))) {
      sVar6 = FGetPrevLogRt(&hdr,(byte *)rgbCur);
      if ((sVar6 != 0) && (((uint)hdr.wFlags >> 10 == 0x1d && (rgbCur._0_2_ == ppl->id))))
      {
        imemLogCur = imemLogPrev;
      }
      rgbCur._0_2_ = ppl->id;
      __fmemmove(rgbCur + 2,
                         (void *)CONCAT22(*(undefined2 *)((int)&pplNew->lpplprod + 2),
                                          (void *)(*(int *)&pplNew->lpplprod + 4)),
                         (uint)((PLPROD *)pplNew->lpplprod)->iprodMac << 2);
      WriteMemRt(0x1d,(uint)((PLPROD *)pplNew->lpplprod)->iprodMac * 4 + 2,(char *)rgbCur)
      ;
    }
    uVar11 = __aFulshr(uVar13,in_stack_0000ffd6);
    uVar7 = (uint)uVar11 & 1;
    uVar11 = __aFulshr(uVar13,uVar7);
    if ((((uVar7 != ((uint)uVar11 & 1)) ||
         ((((PLANET *)ppl)->wFlags & 0x3ffU) != (pplNew->wFlags & 0x3ffU))) ||
        (((uint)((PLANET *)ppl)->wFlags >> 10 & 0xf) != ((uint)pplNew->wFlags >> 10 & 0xf))) ||
       ((((PLANET *)ppl)->wRouting & 0x3ffU) != (pplNew->wRouting & 0x3ffU))) {
      rgbCur._0_2_ = pplNew->id;
      rgbCur[2] = '\0';
      rgbCur[3] = '\0';
      rgbCur[4] = '\0';
      rgbCur[5] = '\0';
      __aFulshr(uVar13,uVar7);
      lVar12 = __aFlshl(uVar13,uVar7);
      rgbCur._2_2_ = rgbCur._2_2_ & 0xfffe | (uint)lVar12;
      rgbCur._4_2_ = rgbCur._4_2_ | (uint)((ulong)lVar12 >> 0x10);
      lVar12 = __aFlshl(uVar13,uVar7);
      rgbCur._2_2_ = rgbCur._2_2_ & 0xf801 | (uint)lVar12;
      rgbCur._4_2_ = rgbCur._4_2_ | (uint)((ulong)lVar12 >> 0x10);
      lVar12 = __aFlshl(uVar13,uVar7);
      rgbCur._2_2_ = rgbCur._2_2_ & 0x87ff | (uint)lVar12;
      rgbCur._4_2_ = rgbCur._4_2_ | (uint)((ulong)lVar12 >> 0x10);
      lVar12 = __aFlshl(uVar13,uVar7);
      rgbCur._2_2_ = rgbCur._2_2_ & 0x7fff | (uint)lVar12;
      rgbCur._4_2_ = rgbCur._4_2_ & 0xfe00 | (uint)((ulong)lVar12 >> 0x10);
      WriteMemRt(0x23,6,(char *)rgbCur);
    }
  }
  return;
}



// ======================================================================
// Function: LogChangeThing
// Address: 1048:9908
// Segment: MEMORY_PLANET
// ======================================================================


void LogChangeThing(THING *lpth,THING *pthNew)

{
  LOGXFER *pLVar1;
  LOGXFER *pLVar2;
  int iVar3;
  int iVar4;
  LOGXFER *pLVar5;
  LOGXFER *pLVar6;
  LOGXFER lxNew;
  short fChg;
  short i;
  
  fChg = 0;
  if (((uint)gd._0_2_ >> 1 & 1) == 0) {
    _memset(&lxNew,0,0x18);
    lxNew.id = pthNew->idFull;
    lxNew.grobj = grobjThing;
    for (i = 0; i < 3; i = i + 1) {
      iVar3 = *(int *)(pthNew->rgb + i * 2 + 2) - *(int *)(((THING *)lpth)->rgb + i * 2 + 2);
      iVar4 = i * 4;
      *(int *)(lxNew.rgdItem + i) = iVar3;
      *(int *)((int)lxNew.rgdItem + iVar4 + 2) = iVar3 >> 0xf;
      if (iVar3 != 0) {
        fChg = 1;
      }
    }
    if (fChg != 0) {
      if (fValidLx == 0) {
        pLVar5 = &lxNew;
        pLVar6 = (LOGXFER *)&lx;
        for (iVar3 = 0xc; iVar3 != 0; iVar3 = iVar3 + -1) {
          pLVar2 = pLVar6;
          pLVar6 = (LOGXFER *)&pLVar6->grobj;
          pLVar1 = pLVar5;
          pLVar5 = (LOGXFER *)&pLVar5->grobj;
          pLVar2->id = pLVar1->id;
        }
        fValidLx = 1;
      }
      else {
        LogMakeValidXfer((LOGXFER *)&lx,&lxNew);
        fValidLx = 0;
      }
    }
  }
  return;
}



// ======================================================================
// Function: LogMakeValidXfer
// Address: 1048:99f6
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Variable defined which should be unmapped: prt */
/* WARNING: Removing unreachable block (ram,0x10489e18) */
/* WARNING: Removing unreachable block (ram,0x10489d0a) */
/* WARNING: Removing unreachable block (ram,0x10489e97) */

void LogMakeValidXfer(LOGXFER *plx1,LOGXFER *plx2)

{
  uint *puVar1;
  char cVar2;
  uint uVar3;
  uint uVar4;
  uint uVar5;
  undefined2 unaff_SS;
  long lVar6;
  long lVar7;
  short cb;
  short grFlag;
  short grbit;
  RTXFER rgbuf;
  uint auStack_3a [10];
  short i;
  short rt;
  RTXFER *prtl;
  short iOff;
  RTXFER *prt;
  uint rgQuan [11];
  
  lVar7 = 0;
  grFlag = 1;
  rgQuan[0] = 0;
  rgQuan[1] = 0;
  rgQuan[2] = 0;
  rgQuan[3] = 0;
  rgQuan[4] = 0;
  rgQuan[5] = 0;
  rgQuan[6] = 0;
  rgQuan[7] = 0;
  rgQuan[8] = 0;
  rgQuan[9] = 0;
  uVar4 = (uint)hdrPrev.wFlags >> 10;
  if (((uVar4 == 1) || (uVar4 == 2)) || (uVar4 == 0x19)) {
    prt = (RTXFER *)
          CONCAT22(lpLog._2_2_,
                   (RTXFER *)
                   ((byte *)lpLog + (imemLogCur - (hdrPrev.wFlags & 0x3ffU))
                   ));
  }
  else {
    prt = (RTXFER *)0x0;
  }
  if (((((RTXFER *)prt != (RTXFER *)0x0) || (prt._2_2_ != 0)) &&
      ((((byte)((RTXFER *)prt)->field2_0x4 & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) ==
        (plx1->grobj & 0xff) &&
       (((int)(uint)(byte)((RTXFER *)prt)->field2_0x4 >> 4 == (plx2->grobj & 0xff) &&
        (prt->id1 == plx1->id)))))) && (((RTXFER *)prt)->id2 == plx2->id)) {
    uVar4 = (uint)((RTXFER *)prt)->grbitItems;
    iOff = 0;
    uVar5 = (uint)hdrPrev.wFlags >> 10;
    if (uVar5 == 1) {
      for (i = 0; i < 5; i = i + 1) {
        if ((1 << ((byte)i & 0x1f) & uVar4) != 0) {
          cVar2 = ((RTXFER *)prt)->rgcQuan[iOff];
          rgQuan[i * 2] = (int)cVar2;
          rgQuan[i * 2 + 1] = (int)cVar2 >> 0xf;
          iOff = iOff + 1;
        }
      }
    }
    else if (uVar5 == 2) {
      for (i = 0; i < 5; i = i + 1) {
        if ((1 << ((byte)i & 0x1f) & uVar4) != 0) {
          uVar5 = *(uint *)(((RTXFER *)prt)->rgcQuan + iOff * 2);
          rgQuan[i * 2] = uVar5;
          rgQuan[i * 2 + 1] = (int)uVar5 >> 0xf;
          iOff = iOff + 1;
        }
      }
    }
    else if (uVar5 == 0x19) {
      prtl = (RTXFER *)prt;
      for (i = 0; i < 5; i = i + 1) {
        if ((1 << ((byte)i & 0x1f) & uVar4) != 0) {
          uVar5 = *(uint *)(((RTXFER *)prt)->rgcQuan + iOff * 4 + 2);
          rgQuan[i * 2] = *(uint *)(((RTXFER *)prt)->rgcQuan + iOff * 4);
          rgQuan[i * 2 + 1] = uVar5;
          iOff = iOff + 1;
        }
      }
    }
    CancelMemRt((uint)hdrPrev.wFlags >> 10);
  }
  grbit = 0;
  for (i = 0; i < 5; i = i + 1) {
    uVar5 = *(uint *)(plx1->rgdItem + i);
    uVar3 = *(uint *)((int)(plx1->rgdItem + i) + 2);
    puVar1 = rgQuan + i * 2;
    uVar4 = *puVar1;
    *puVar1 = *puVar1 + uVar5;
    rgQuan[i * 2 + 1] = rgQuan[i * 2 + 1] + uVar3 + (uint)CARRY2(uVar4,uVar5);
    lVar6 = _labs(CONCAT22(rgQuan[i * 2 + 1],rgQuan[i * 2]));
    if (lVar7 <= lVar6) {
      lVar7 = _labs(CONCAT22(rgQuan[i * 2 + 1],rgQuan[i * 2]));
    }
    if ((rgQuan[i * 2] != 0) || (rgQuan[i * 2 + 1] != 0)) {
      grbit = grbit | grFlag;
    }
    grFlag = grFlag << 1;
  }
  if (grbit != 0) {
    prt = (RTXFER *)&rgbuf;
    rgbuf.field2_0x4 =
         (byte)plx1->grobj & 0xf |
         (byte)((plx2->grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 4);
    prt->id1 = plx1->id;
    rgbuf.id2 = plx2->id;
    rgbuf.grbitItems = (byte)grbit;
    cb = 6;
    iOff = 0;
    if (lVar7 < 0x80) {
      rt = 1;
      for (i = 0; i < 5; i = i + 1) {
        if ((rgQuan[i * 2] != 0) || (rgQuan[i * 2 + 1] != 0)) {
          *(undefined1 *)((int)auStack_3a + iOff + -2) = (char)rgQuan[i * 2];
          cb = cb + 1;
          iOff = iOff + 1;
        }
      }
    }
    else if (lVar7 < 0x8000) {
      rt = 2;
      for (i = 0; i < 5; i = i + 1) {
        if ((rgQuan[i * 2] != 0) || (rgQuan[i * 2 + 1] != 0)) {
          auStack_3a[iOff + -1] = rgQuan[i * 2];
          cb = cb + 2;
          iOff = iOff + 1;
        }
      }
    }
    else {
      rt = 0x19;
      for (i = 0; prtl = &rgbuf, i < 5; i = i + 1) {
        if ((rgQuan[i * 2] != 0) || (rgQuan[i * 2 + 1] != 0)) {
          uVar4 = rgQuan[i * 2 + 1];
          auStack_3a[iOff * 2 + -1] = rgQuan[i * 2];
          auStack_3a[iOff * 2] = uVar4;
          cb = cb + 4;
          iOff = iOff + 1;
        }
      }
    }
    WriteMemRt(rt,cb,&rgbuf);
  }
  return;
}



// ======================================================================
// Function: LogMakeValidXferf
// Address: 1048:9fa6
// Segment: MEMORY_PLANET
// ======================================================================


void LogMakeValidXferf(LOGXFERF *plxf1,LOGXFERF *plxf2)

{
  short cb;
  short grFlag;
  ushort grbit;
  short rgbuf;
  short local_32;
  byte local_30;
  ushort local_2f;
  short asStack_2d [17];
  short i;
  short iOff;
  short *prt;
  
  grbit = 0;
  grFlag = 1;
  for (i = 0; i < 0x10; i = i + 1) {
    if (plxf1->rgdItem[i] != 0) {
      grbit = grbit | grFlag;
    }
    grFlag = grFlag << 1;
  }
  if (grbit != 0) {
    prt = &rgbuf;
    local_30 = (byte)plxf1->grobj & 0xf |
               (byte)((plxf2->grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 4);
    rgbuf = plxf1->id;
    local_32 = plxf2->id;
    local_2f = grbit;
    cb = 7;
    iOff = 0;
    for (i = 0; i < 0x10; i = i + 1) {
      if (plxf1->rgdItem[i] != 0) {
        asStack_2d[iOff] = plxf1->rgdItem[i];
        cb = cb + 2;
        iOff = iOff + 1;
      }
    }
    WriteMemRt(0x17,cb,&rgbuf);
  }
  return;
}



// ======================================================================
// Function: CancelMemRt
// Address: 1048:a108
// Segment: MEMORY_PLANET
// ======================================================================


void CancelMemRt(short rt)

{
  imemLogCur = imemLogCur - ((hdrPrev.wFlags & 0x3ffU) + 2);
  hdrPrev.wFlags = hdrPrev.wFlags & 0x3ff;
  return;
}



// ======================================================================
// Function: WriteMemRt
// Address: 1048:a130
// Segment: MEMORY_PLANET
// ======================================================================


void WriteMemRt(short rt,short cb,void *rg)

{
  byte *pbVar1;
  undefined2 uVar2;
  char *sz;
  HDR HVar3;
  short mbType;
  byte *lpv;
  HDR hdr;
  
  HVar3.wFlags = hdrPrev.wFlags;
  if (fLogOff == 0) {
    if (32000 < imemLogCur + cb + 2) {
      mbType = 0x10;
      sz = PszFormatIds(idsLogFileHasReachedMaximumAllowableSize,(short *)0x0);
      AlertSz(sz,mbType);
    }
    DirtyGame(1);
    uVar2 = lpLog._2_2_;
    imemLogPrev = imemLogCur;
    HVar3.wFlags = cb & 0x3ffU | rt << 10;
    pbVar1 = (byte *)lpLog + imemLogCur;
    lpv = (byte *)CONCAT22(lpLog._2_2_,pbVar1);
    *(short *)lpv = HVar3.wFlags;
    if (0 < cb) {
      __fmemcpy((byte *)CONCAT22(uVar2,pbVar1 + 2),(void *)rg,cb);
    }
    imemLogCur = imemLogCur + cb + 2;
    if (rt == 0) {
      HVar3.wFlags = hdrPrev.wFlags;
    }
  }
  hdrPrev.wFlags = HVar3.wFlags;
  return;
}



// ======================================================================
// Function: DirtyGame
// Address: 1048:a228
// Segment: MEMORY_PLANET
// ======================================================================


void DirtyGame(short fDirty)

{
  if ((fDirty != game.fDirty) && (game.fDirty = fDirty, fAi == 0)) {
    SetMsgTitle(hwndMessage);
  }
  return;
}



// ======================================================================
// Function: FGetPrevLogRt
// Address: 1048:a25e
// Segment: MEMORY_PLANET
// ======================================================================


short FGetPrevLogRt(HDR *phdr,byte *pb)

{
  undefined2 uVar1;
  short sVar2;
  byte *pbVar3;
  byte *lpv;
  
  uVar1 = lpLog._2_2_;
  if (imemLogPrev == -1) {
    sVar2 = 0;
  }
  else {
    pbVar3 = (byte *)lpLog + imemLogPrev;
    lpv = (byte *)CONCAT22(lpLog._2_2_,pbVar3);
    phdr->wFlags = *(short *)lpv;
    if ((phdr->wFlags & 0x3ffU) != 0) {
      __fmemcpy((byte *)pb,(byte *)CONCAT22(uVar1,pbVar3 + 2),phdr->wFlags & 0x3ff);
    }
    sVar2 = 1;
  }
  return sVar2;
}



// ======================================================================
// Function: FRunLogFile
// Address: 1048:a2d6
// Segment: MEMORY_PLANET
// ======================================================================


short FRunLogFile(void)

{
  short sVar1;
  uint uVar2;
  HDR *lprts;
  short iCur;
  short fRet;
  short fLogOld;
  
  sVar1 = fLogOff;
  iCur = 0;
  fRet = 1;
  if (imemLogCur == 0) {
    fRet = 1;
  }
  else {
    fLogOff = 1;
    for (; iCur < imemLogCur; iCur = iCur + (lprts->wFlags & 0x3ffU) + 2) {
      lprts = (HDR *)CONCAT22(lpLog._2_2_,(HDR *)((byte *)lpLog + iCur));
      uVar2 = FRunLogRecord((uint)lprts->wFlags >> 10,lprts->wFlags & 0x3ff,
                            (byte *)CONCAT22(lpLog._2_2_,(byte *)lpLog + iCur + 2));
      fRet = fRet & uVar2;
    }
    gd._4_2_ = gd._4_2_ & 0xfbff;
  }
  fLogOff = sVar1;
  return fRet;
}



// ======================================================================
// Function: FRunLogRecord
// Address: 1048:a38c
// Segment: MEMORY_PLANET
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1048bb20) */
/* WARNING: Removing unreachable block (ram,0x1048af75) */
/* WARNING: Removing unreachable block (ram,0x1048af96) */
/* WARNING: Removing unreachable block (ram,0x1048bb41) */
/* WARNING: Variable defined which should be unmapped: cOut */
/* WARNING: Type propagation algorithm not settling */

short FRunLogRecord(short rt,short cb,byte *lpb)

{
  uint *puVar1;
  char *pcVar2;
  MessageId *pMVar3;
  int *piVar4;
  byte *pbVar5;
  byte bVar6;
  undefined2 uVar7;
  PLPROD *pPVar8;
  PLORD *pPVar9;
  XFERFULL *pXVar10;
  short sVar11;
  ushort uVar12;
  uint uVar13;
  uint uVar14;
  int iVar15;
  uint uVar16;
  undefined2 *puVar17;
  undefined2 *puVar18;
  FLEET *pFVar19;
  SHDEF *pSVar20;
  int iVar21;
  PLANET *pPVar22;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar23;
  undefined2 uVar24;
  undefined2 unaff_SS;
  bool bVar25;
  PL *pPVar26;
  void *pvVar27;
  THING *pTVar28;
  FLEET *pFVar29;
  long lVar30;
  ulong uVar31;
  ulong uVar32;
  HeapType HVar33;
  short cOut;
  char szT [26];
  uint local_54a;
  COLDROP *lpcdT;
  PLANET *pPStack_546;
  MessageId MStack_544;
  undefined4 l;
  char ch;
  PLANET *lpplMac;
  int local_53a;
  short iLook;
  short iPass;
  SHDEF *lpshdef;
  short rgifl [512];
  ushort grbit;
  short i;
  short ifl;
  FLEET *lpfl;
  FLEET local_122;
  FLEET local_a2;
  uint rgcXfer [10];
  PLANET *lppl;
  XFERFULL *lpxfCur;
  uint cXfer;
  uint local_8;
  short fExtra;
  
  uVar32 = CONCAT22(unaff_SI,unaff_DI);
  lpxfCur = (XFERFULL *)0x0;
  switch(rt) {
  case 0:
    break;
  case 1:
  case 2:
  case 0x19:
    sVar11 = FLookupObject(((byte *)lpb)[4] & (grobjThing|grobjOther|grobjFleet|grobjPlanet),
                                 *(short *)lpb,&local_122);
    if (sVar11 == 0) {
      return 0;
    }
    local_a2.id = -1;
    if (((int)(uint)((byte *)lpb)[4] >> 4 == 4) ||
       (sVar11 = FLookupObject((int)(uint)((byte *)lpb)[4] >> 4,*(short *)((byte *)lpb + 2),
                                     &local_a2), sVar11 != 0)) {
      lVar30 = CONCAT22(l._2_2_,(uint)l);
      grbit = (ushort)((byte *)lpb)[5];
      iLook = 0;
      for (i = 0; i < 5; i = i + 1) {
        if ((grbit & 1) == 0) {
          rgcXfer[i * 2] = 0;
          rgcXfer[i * 2 + 1] = 0;
        }
        else {
          if (rt == 1) {
            bVar6 = ((byte *)lpb)[iLook + 6];
            rgcXfer[i * 2] = (int)(char)bVar6;
            rgcXfer[i * 2 + 1] = (int)(char)bVar6 >> 0xf;
          }
          else if (rt == 2) {
            uVar14 = *(uint *)((byte *)lpb + iLook * 2 + 6);
            rgcXfer[i * 2] = uVar14;
            rgcXfer[i * 2 + 1] = (int)uVar14 >> 0xf;
          }
          else {
            uVar14 = *(uint *)((int)((byte *)lpb + iLook * 4 + 6) + 2);
            rgcXfer[i * 2] = *(uint *)((byte *)lpb + iLook * 4 + 6);
            rgcXfer[i * 2 + 1] = uVar14;
          }
          iLook = iLook + 1;
        }
        grbit = grbit >> 1;
      }
      for (iPass = 0; iPass < 2; iPass = iPass + 1) {
        for (i = 0; i < 5; i = i + 1) {
          if ((rgcXfer[i * 2] != 0) || (rgcXfer[i * 2 + 1] != 0)) {
            local_8 = rgcXfer[i * 2 + 1];
            cXfer = rgcXfer[i * 2];
            if (((iPass == 0) && ((int)local_8 < 0)) || ((iPass == 1 && (-1 < (int)local_8)))) {
              l = lVar30;
              lVar30 = ChgCargo(((byte *)lpb)[4] &
                                      (grobjThing|grobjOther|grobjFleet|grobjPlanet),*(short *)lpb,i
                                      ,CONCAT22(local_8,rgcXfer[i * 2]),&local_122);
              if (lVar30 != CONCAT22(local_8,cXfer)) {
                if ((((byte *)lpb)[4] & 0xf) == 2) {
                  MStack_544 = 0x8000;
                }
                else {
                  MStack_544 = idmColonistsDroppedMassacredGroundTroops;
                }
                MStack_544 = MStack_544 | local_122.id;
                l = lVar30;
                FSendPlrMsg(local_122.iPlayer,idmUnableTransferKtKtRequest,MStack_544,
                                 MStack_544,cXfer - (int)lVar30,i,cXfer,0,0,0);
                rgcXfer[i * 2] = (uint)l;
                rgcXfer[i * 2 + 1] = l._2_2_;
                lVar30 = l;
              }
            }
            pXVar10 = lpcd._2_2_;
            if ((((iPass == 0) && ((0 < (int)local_8 || (-1 < (int)local_8)))) ||
                ((iPass == 1 && (((int)local_8 < 1 && ((int)local_8 < 0)))))) &&
               ((int)(uint)((byte *)lpb)[4] >> 4 != 4)) {
              if (((i == 3) &&
                  ((((cXfer != 0 || (local_8 != 0)) && (((uint)gd._0_2_ >> 1 & 1) != 0)) &&
                   (((int)(uint)((byte *)lpb)[4] >> 4 == 1 && ((((byte *)lpb)[4] & 0xf) == 2))))))
                 && (local_122.iPlayer != local_a2.iPlayer)) {
                lpcdT = (COLDROP *)lpcd;
                pPStack_546 = (PLANET *)lpcd._2_2_;
                MStack_544 = idmColonistsDroppedMassacredGroundTroops;
                if (((int)local_8 < 0) || (((int)local_8 < 1 && (cXfer == 0)))) {
                  for (; ((int)MStack_544 < cColDrop &&
                         ((((COLDROP *)CONCAT22(lpcd._2_2_,lpcdT))->idFleetSrc !=
                           local_122.id || (lpcdT->idPlanetDst != local_a2.id)))); lpcdT = lpcdT + 1
                      ) {
                    MStack_544 = MStack_544 + idmColonistsDroppedDestroyedPlanetaryDefensesRestMa;
                  }
                  if (MStack_544 == cColDrop) {
                    ((COLDROP *)CONCAT22(lpcd._2_2_,lpcdT))->idFleetSrc = local_122.id;
                    lpcdT->idPlr = local_122.iPlayer;
                    lpcdT->idPlanetDst = local_a2.id;
                    *(undefined2 *)&lpcdT->cColonist = 0;
                    *(undefined2 *)((int)&lpcdT->cColonist + 2) = 0;
                    local_54a = (uint)(local_a2.iPlayer != -1);
                    lpcdT->wFlags = lpcdT->wFlags & 0xfffeU | local_54a;
                    cColDrop = cColDrop + 1;
                  }
                  puVar1 = (uint *)&lpcdT->cColonist;
                  uVar14 = *puVar1;
                  *puVar1 = *puVar1 - cXfer;
                  piVar4 = (int *)((int)&lpcdT->cColonist + 2);
                  *piVar4 = (*piVar4 - local_8) - (uint)(uVar14 < cXfer);
                }
                else {
                  while ((((int)MStack_544 < cColDrop && (-1 < (int)local_8)) &&
                         ((0 < (int)local_8 || (cXfer != 0))))) {
                    if ((lpcdT->idPlanetDst == local_a2.id) && (lpcdT->idPlr == local_122.iPlayer))
                    {
                      iVar15 = *(int *)((int)&lpcdT->cColonist + 2);
                      if ((iVar15 < (int)local_8) ||
                         ((uVar14 = cXfer, uVar13 = local_8, iVar15 <= (int)local_8 &&
                          (*(uint *)&lpcdT->cColonist <= cXfer)))) {
                        uVar14 = *(uint *)&lpcdT->cColonist;
                        uVar13 = *(uint *)((int)&lpcdT->cColonist + 2);
                      }
                      lVar30 = CONCAT22(uVar13,uVar14);
                      bVar25 = cXfer < uVar14;
                      cXfer = cXfer - uVar14;
                      local_8 = (local_8 - uVar13) - (uint)bVar25;
                      puVar1 = (uint *)&lpcdT->cColonist;
                      uVar16 = *puVar1;
                      *puVar1 = *puVar1 - uVar14;
                      piVar4 = (int *)((int)&lpcdT->cColonist + 2);
                      *piVar4 = (*piVar4 - uVar13) - (uint)(uVar16 < uVar14);
                    }
                    lpcdT = lpcdT + 1;
                    MStack_544 = MStack_544 + idmColonistsDroppedDestroyedPlanetaryDefensesRestMa;
                  }
                }
              }
              else if (((cXfer == 0) && (local_8 == 0)) ||
                      ((((uint)gd._0_2_ >> 1 & 1) == 0 ||
                       ((local_a2.iPlayer == local_122.iPlayer ||
                        ((int)(uint)((byte *)lpb)[4] >> 4 == 8)))))) {
PLANET_StealCargo:
                l = lVar30;
                lVar30 = ChgCargo((int)(uint)((byte *)lpb)[4] >> 4,*(short *)((byte *)lpb + 2)
                                        ,i,CONCAT22(-(local_8 + (cXfer != 0)),-cXfer),&local_a2);
                iVar15 = (int)lVar30;
                if (lVar30 != CONCAT22(-(local_8 + (cXfer != 0)),-cXfer)) {
                  rgcXfer[i * 2] = -iVar15;
                  rgcXfer[i * 2 + 1] = -((int)((ulong)lVar30 >> 0x10) + (uint)(iVar15 != 0));
                  l = lVar30;
                  if ((int)(uint)((byte *)lpb)[4] >> 4 == 8) {
                    MStack_544 = idmDidntGetAttemptedTransferMineralPacketAnother;
                    if (lVar30 == 0) {
                      MStack_544 = idmDidntGetAnyAttemptedTransferMineralPacket;
                    }
                    FSendPlrMsg(local_122.iPlayer,MStack_544,local_122.id | 0x8000,local_122.id
                                     ,i,-iVar15,i,0,0,0);
                    lVar30 = l;
                  }
                  else {
                    if ((((byte *)lpb)[4] & 0xf) == 2) {
                      MStack_544 = 0x8000;
                    }
                    else {
                      MStack_544 = idmColonistsDroppedMassacredGroundTroops;
                    }
                    MStack_544 = MStack_544 | local_122.id;
                    FSendPlrMsg(local_122.iPlayer,idmUnableTransferKtKtRequest,MStack_544,
                                     MStack_544,-cXfer - iVar15,i,-cXfer,0,0,0);
                    lVar30 = l;
                  }
                }
              }
              else {
                pPStack_546 = (PLANET *)((XFERFULL *)lpxf + cXferFull);
                MStack_544 = lpxf._2_2_;
                if (((int)local_8 < 0) || (((int)local_8 < 1 && (cXfer == 0)))) {
                  if (iPass == 1) goto PLANET_StealCargo;
                  if (((XFERFULL *)lpxfCur == (XFERFULL *)0x0) && (lpxfCur._2_2_ == 0)) {
                    lpxfCur = (XFERFULL *)CONCAT22(lpxf._2_2_,(XFERFULL *)lpxf);
                    l = lVar30;
                    while ((XFERFULL *)lpxfCur < pPStack_546) {
                      sVar11 = __fmemcmp(lpxfCur,lpb,5);
                      if (sVar11 == 0) break;
                      lpxfCur = (XFERFULL *)CONCAT22(lpxfCur._2_2_,(XFERFULL *)lpxfCur + 1);
                    }
                    lVar30 = l;
                    if (((PLANET *)(XFERFULL *)lpxfCur == pPStack_546) &&
                       (lpxfCur._2_2_ == MStack_544)) {
                      cXferFull = cXferFull + 1;
                      __fmemset(lpxfCur,0,0x19);
                      sVar11 = *(short *)((byte *)lpb + 2);
                      lpxfCur->id1 = *(short *)lpb;
                      ((XFERFULL *)lpxfCur)->id2 = sVar11;
                      lVar30 = l;
                    }
                  }
                  puVar1 = (uint *)(((XFERFULL *)lpxfCur)->rgcQuan + i);
                  uVar14 = *puVar1;
                  *puVar1 = *puVar1 - cXfer;
                  puVar1 = (uint *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                  *puVar1 = (*puVar1 - local_8) - (uint)(uVar14 < cXfer);
                }
                else {
                  lpxfCur = (XFERFULL *)CONCAT22(lpxf._2_2_,(XFERFULL *)lpxf);
                  while ((((XFERFULL *)lpxfCur < pPStack_546 && (-1 < (int)local_8)) &&
                         ((0 < (int)local_8 || (cXfer != 0))))) {
                    uVar24 = (undefined2)((ulong)lpxfCur >> 0x10);
                    lpcdT = (COLDROP *)((int)(uint)(byte)((XFERFULL *)lpxfCur)->field2_0x4 >> 4);
                    if ((((lpcdT == (COLDROP *)((int)(uint)((byte *)lpb)[4] >> 4)) &&
                         (((XFERFULL *)lpxfCur)->id2 == *(int *)((byte *)lpb + 2))) &&
                        ((((XFERFULL *)lpxfCur)->field2_0x4 & 0xf) == 2)) &&
                       ((lpxfCur->id1 & 0xfe00U) == (*(uint *)lpb & 0xfe00))) {
                      uVar14 = *(uint *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                      if (((int)uVar14 < (int)local_8) ||
                         ((uVar13 = cXfer, uVar16 = local_8, (int)uVar14 <= (int)local_8 &&
                          (*(uint *)(((XFERFULL *)lpxfCur)->rgcQuan + i) <= cXfer)))) {
                        uVar13 = *(uint *)(((XFERFULL *)lpxfCur)->rgcQuan + i);
                        uVar16 = *(uint *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                      }
                      lVar30 = CONCAT22(uVar16,uVar13);
                      bVar25 = cXfer < uVar13;
                      cXfer = cXfer - uVar13;
                      local_8 = (local_8 - uVar16) - (uint)bVar25;
                      puVar1 = (uint *)(((XFERFULL *)lpxfCur)->rgcQuan + i);
                      uVar14 = *puVar1;
                      *puVar1 = *puVar1 - uVar13;
                      puVar1 = (uint *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                      *puVar1 = (*puVar1 - uVar16) - (uint)(uVar14 < uVar13);
                    }
                    lpxfCur = (XFERFULL *)CONCAT22(uVar24,(XFERFULL *)lpxfCur + 1);
                  }
                  lpxfCur = (XFERFULL *)0x0;
                  if ((-1 < (int)local_8) && ((0 < (int)local_8 || (cXfer != 0))))
                  goto PLANET_StealCargo;
                }
              }
            }
          }
          grbit = grbit >> 1;
        }
      }
      l = lVar30;
      if ((((byte *)lpb)[4] & 0xf) == 2) {
        FLookupFleet(-1,&local_122);
      }
      else {
        FLookupPlanet(-1,(PLANET *)&local_122);
      }
      if ((int)(uint)((byte *)lpb)[4] >> 4 == 2) {
        FLookupFleet(-1,&local_a2);
      }
      else if (((int)(uint)((byte *)lpb)[4] >> 4 == 1) || ((int)(uint)((byte *)lpb)[4] >> 4 == 4)) {
        FLookupPlanet(-1,(PLANET *)&local_a2);
      }
      else if ((int)(uint)((byte *)lpb)[4] >> 4 == 8) {
        FLookupThing(-1,(THING *)&local_a2);
      }
    }
    else if (((int)(uint)((byte *)lpb)[4] >> 4 != 2) ||
            ((*(uint *)((byte *)lpb + 2) >> 9 & 0xf) == idPlayer)) {
      return 0;
    }
    break;
  case 3:
    lpfl = LpflFromId(*(short *)lpb);
    uVar24 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar19 = (FLEET *)lpfl;
    if (((lpfl == (FLEET *)0x0) || (pFVar19->cord < 1)) ||
       (iLook = *(uint *)((byte *)lpb + 2) & 0x7fff, pFVar19->cord <= iLook)) {
      return 0;
    }
    fExtra = (short)((*(uint *)((byte *)lpb + 2) & 0x8000) != 0);
    if ((fExtra != 0) && (pFVar19->cord <= (int)(iLook + 1U))) {
      return 0;
    }
    MStack_544 = *(undefined2 *)((int)&pFVar19->lpplord + 2);
    pPStack_546 = (PLANET *)(*(int *)&pFVar19->lpplord + 4);
    lpcdT = (COLDROP *)*(undefined2 *)((int)&pFVar19->lpplord + 2);
    local_54a = *(int *)&pFVar19->lpplord + 4;
    __fmemmove((void *)CONCAT22(lpcdT,(void *)(local_54a + iLook * 0x12)),
                       (void *)CONCAT22(MStack_544,
                                        (void *)((int)pPStack_546 + (iLook + fExtra + 1) * 0x12)),
                       (((pFVar19->cord - iLook) - fExtra) + -1) * 0x12);
    uVar24 = (undefined2)((ulong)lpfl >> 0x10);
    piVar4 = &((FLEET *)lpfl)->cord;
    *piVar4 = *piVar4 - (fExtra + 1);
    pPVar9 = ((FLEET *)lpfl)->lpplord;
    pbVar5 = &((PLORD *)pPVar9)->iordMac;
    *pbVar5 = *pbVar5 - ((char)fExtra + '\x01');
    break;
  case 4:
    lpfl = LpflFromId(*(short *)lpb);
    uVar24 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar19 = (FLEET *)lpfl;
    if (((lpfl == (FLEET *)0x0) || (*(int *)((byte *)lpb + 2) < 0)) ||
       (pFVar19->cord < *(int *)((byte *)lpb + 2))) {
      return 0;
    }
    if (pFVar19->cord == (uint)((PLORD *)pFVar19->lpplord)->iordMax) {
      pPVar26 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&pFVar19->lpplord + 2),
                                                   *(PL **)&pFVar19->lpplord),pFVar19->cord + 3);
      uVar24 = (undefined2)((ulong)lpfl >> 0x10);
      *(PL **)&((FLEET *)lpfl)->lpplord = (PL *)pPVar26;
      *(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2) = (int)((ulong)pPVar26 >> 0x10);
    }
    uVar24 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar19 = (FLEET *)lpfl;
    MStack_544 = *(undefined2 *)((int)&pFVar19->lpplord + 2);
    pPStack_546 = (PLANET *)(*(int *)&pFVar19->lpplord + 4);
    lpcdT = (COLDROP *)*(undefined2 *)((int)&pFVar19->lpplord + 2);
    local_54a = *(int *)&pFVar19->lpplord + 4;
    __fmemmove((void *)CONCAT22(lpcdT,(void *)(local_54a +
                                                      (*(int *)((byte *)lpb + 2) + 1) * 0x12)),
                       (void *)CONCAT22(MStack_544,
                                        (void *)((int)pPStack_546 + *(int *)((byte *)lpb + 2) * 0x12
                                                )),
                       (pFVar19->cord - *(int *)((byte *)lpb + 2)) * 0x12);
    if ((uint)cb < 0x16) {
      uVar24 = (undefined2)((ulong)lpfl >> 0x10);
      MStack_544 = *(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2);
      pPStack_546 = (PLANET *)(*(int *)&((FLEET *)lpfl)->lpplord + 4);
      __fmemset((void *)CONCAT22(MStack_544,
                                         (void *)((int)pPStack_546 +
                                                 *(int *)((byte *)lpb + 2) * 0x12)),0,0x12);
    }
    uVar24 = (undefined2)((ulong)lpfl >> 0x10);
    MStack_544 = *(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2);
    pPStack_546 = (PLANET *)(*(int *)&((FLEET *)lpfl)->lpplord + 4);
    __fmemmove((void *)CONCAT22(MStack_544,
                                        (void *)((int)pPStack_546 + *(int *)((byte *)lpb + 2) * 0x12
                                                )),(byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 4),
                       cb - 4);
    uVar24 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar19 = (FLEET *)lpfl;
    *(uint *)(*(int *)&pFVar19->lpplord + *(int *)((byte *)lpb + 2) * 0x12 + 10) =
         *(uint *)(*(int *)&pFVar19->lpplord + *(int *)((byte *)lpb + 2) * 0x12 + 10) & 0xdfff;
    pFVar19->cord = pFVar19->cord + 1;
    pbVar5 = &((PLORD *)pFVar19->lpplord)->iordMac;
    *pbVar5 = *pbVar5 + 1;
    break;
  case 5:
    lpfl = LpflFromId(*(short *)lpb);
    uVar24 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar19 = (FLEET *)lpfl;
    if (((lpfl == (FLEET *)0x0) || (pFVar19->cord < 0)) ||
       (iLook = *(short *)((byte *)lpb + 2), pFVar19->cord <= iLook)) {
      return 0;
    }
    if ((uint)cb < 0x16) {
      MStack_544 = *(undefined2 *)((int)&pFVar19->lpplord + 2);
      pPStack_546 = (PLANET *)(*(int *)&pFVar19->lpplord + 4);
      __fmemset((void *)CONCAT22(MStack_544,(void *)((int)pPStack_546 + iLook * 0x12)),0,
                        0x12);
    }
    uVar24 = (undefined2)((ulong)lpfl >> 0x10);
    MStack_544 = *(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2);
    pPStack_546 = (PLANET *)(*(int *)&((FLEET *)lpfl)->lpplord + 4);
    __fmemmove((void *)CONCAT22(MStack_544,(void *)((int)pPStack_546 + iLook * 0x12)),
                       (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 4),cb - 4);
    uVar24 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar19 = (FLEET *)lpfl;
    *(uint *)(*(int *)&pFVar19->lpplord + iLook * 0x12 + 10) =
         *(uint *)(*(int *)&pFVar19->lpplord + iLook * 0x12 + 10) & 0xdfff;
    break;
  default:
    break;
  case 10:
  case 0xb:
    pFVar29 = LpflFromId(*(short *)lpb);
    uVar24 = (undefined2)((ulong)pFVar29 >> 0x10);
    pFVar19 = (FLEET *)pFVar29;
    if (pFVar29 == (FLEET *)0x0) {
      return 0;
    }
    if (rt == 10) {
      pFVar19->wFlags = pFVar19->wFlags & 0xfdffU | (*(uint *)((byte *)lpb + 2) & 1) << 9;
    }
    else {
      if (pFVar19->cord <= *(int *)((byte *)lpb + 2)) {
        return 0;
      }
      if (9 < *(int *)((byte *)lpb + 4)) {
        return 0;
      }
      *(uint *)(*(int *)&pFVar19->lpplord + *(int *)((byte *)lpb + 2) * 0x12 + 10) =
           *(uint *)(*(int *)&pFVar19->lpplord + *(int *)((byte *)lpb + 2) * 0x12 + 10) & 0xfff0 |
           *(uint *)((byte *)lpb + 4) & 0xf;
    }
    break;
  case 0x17:
    sVar11 = FLookupObject(grobjFleet,*(short *)lpb,&local_122);
    if (sVar11 == 0) {
      return 0;
    }
    sVar11 = FLookupObject(grobjFleet,*(short *)((byte *)lpb + 2),&local_a2);
    if (sVar11 == 0) {
      return 0;
    }
    if (local_a2.iPlayer != local_122.iPlayer) {
      return 0;
    }
    for (iPass = 0; iPass < 2; iPass = iPass + 1) {
      grbit = *(ushort *)((byte *)lpb + 5);
      iLook = 0;
      for (i = 0; i < 0x10; i = i + 1) {
        if ((grbit & 1) != 0) {
          cXfer = *(uint *)((byte *)lpb + iLook * 2 + 7);
          local_8 = (int)cXfer >> 0xf;
          if (((iPass == 0) && ((int)local_8 < 0)) || ((iPass == 1 && (-1 < (int)local_8)))) {
            iVar15 = (local_122.rgcsh[i] >> 0xf) + local_8 + (uint)CARRY2(local_122.rgcsh[i],cXfer);
            if ((iVar15 < 1) && (iVar15 < 0)) {
              cXfer = -local_122.rgcsh[i];
              local_8 = -local_122.rgcsh[i] >> 0xf;
            }
            else {
              uVar14 = 0x7ffe - local_122.rgcsh[i];
              iVar15 = (int)uVar14 >> 0xf;
              if ((iVar15 <= (int)local_8) && ((iVar15 < (int)local_8 || (uVar14 <= cXfer)))) {
                cXfer = 0x7ffd - local_122.rgcsh[i];
                local_8 = (int)cXfer >> 0xf;
              }
            }
            local_122.rgcsh[i] = local_122.rgcsh[i] + cXfer;
          }
          if (((iPass == 0) && ((0 < (int)local_8 || (-1 < (int)local_8)))) ||
             ((iPass == 1 && (((int)local_8 < 1 && ((int)local_8 < 0)))))) {
            iVar15 = ((local_a2.rgcsh[i] >> 0xf) - local_8) -
                     (uint)((uint)local_a2.rgcsh[i] < cXfer);
            if ((iVar15 < 1) && (iVar15 < 0)) {
              cXfer = local_a2.rgcsh[i];
              local_8 = local_a2.rgcsh[i] >> 0xf;
            }
            else {
              uVar14 = 0x7ffe - local_a2.rgcsh[i];
              iVar15 = (int)uVar14 >> 0xf;
              iVar21 = -(local_8 + (cXfer != 0));
              if ((iVar15 <= iVar21) && ((iVar15 < iVar21 || (uVar14 <= -cXfer)))) {
                cXfer = -(0x7ffd - local_a2.rgcsh[i]);
                local_8 = (int)cXfer >> 0xf;
              }
            }
            local_a2.rgcsh[i] = local_a2.rgcsh[i] - cXfer;
          }
          iLook = iLook + 1;
        }
        grbit = grbit >> 1;
      }
    }
    FleetTransferCargoBalance(&local_122,&local_a2);
    for (iPass = 0; iPass < 2; iPass = iPass + 1) {
      FLookupFleet(-1,(FLEET *)((int)&local_122 + iPass * 0x80));
      lpfl = LpflFromId(*(short *)((int)&local_122 + iPass * 0x80));
      iVar15 = (int)((ulong)lpfl >> 0x10);
      pFVar19 = (FLEET *)lpfl;
      if ((pFVar19 != (FLEET *)0x0) || (iVar15 != 0)) {
        pFVar19->wFlags = pFVar19->wFlags & 0xffdfU | 0x20;
      }
      i = 0;
      while ((i < 0x10 && (*(int *)((int)&local_122 + i * 2 + iPass * 0x80 + 0xc) == 0))) {
        i = i + 1;
      }
      if (i == 0x10) {
        FDeleteFleet(*(short *)((int)&local_122 + iPass * 0x80),0,0);
      }
    }
    break;
  case 0x18:
  case 0x25:
    sVar11 = FLookupObject(grobjFleet,*(short *)lpb,&local_122);
    if (sVar11 == 0) {
      return 0;
    }
    if (rt == 0x18) {
      pFVar29 = LpflNewSplit(&local_122);
      if (pFVar29 == (FLEET *)0x0) {
        return 0;
      }
    }
    else {
      vrgiflMerge = rgifl;
      vcflMerge = 0;
      if (cb == 2) {
        for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar19 = ((FLEET **)rglpfl)[ifl];
          iVar15 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
          lpfl = (FLEET *)CONCAT22(iVar15,pFVar19);
          if ((pFVar19 == (FLEET *)0x0) && (iVar15 == 0)) break;
          if (((pFVar19->iPlayer == idPlayer) &&
              ((((uint)pFVar19->wFlags >> 10 & 1) == 0 && ((&pFVar19->pt)->x == local_122.pt.x))))
             && ((pFVar19->pt).y == local_122.pt.y)) {
            rgifl[vcflMerge] = lpfl->id;
            uVar24 = (undefined2)((ulong)lpfl >> 0x10);
            vcflMerge = vcflMerge + 1;
            ((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0xffdfU | 0x20;
          }
        }
      }
      else {
        for (i = 0; i < (int)((uint)cb / 2); i = i + 1) {
          for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
            pFVar19 = ((FLEET **)rglpfl)[ifl];
            iVar15 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
            lpfl = (FLEET *)CONCAT22(iVar15,pFVar19);
            if ((pFVar19 == (FLEET *)0x0) && (iVar15 == 0)) break;
            if (lpfl->id == *(int *)lpb) {
              rgifl[vcflMerge] = lpfl->id;
              uVar24 = (undefined2)((ulong)lpfl >> 0x10);
              vcflMerge = vcflMerge + 1;
              ((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0xffdfU | 0x20;
              break;
            }
          }
          lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 2);
        }
      }
      sVar11 = FFleetMergeAll(&local_122);
      if (sVar11 == 0) {
        return 0;
      }
    }
    break;
  case 0x1b:
    i = *(uint *)lpb >> 8 & 0x1f;
    iLook = *(uint *)lpb >> 4 & 0xf;
    if ((game.cPlayer <= iLook) || (iLook != idPlayer)) {
      return 0;
    }
    if ((uint)i < 0x10) {
      lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iLook * 4 + 0x100),
                                  (SHDEF *)(*(int *)(iLook * 4 + 0xfe) + i * 0x93));
    }
    else {
      if (0x19 < (uint)i) {
        return 0;
      }
      lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iLook * 4 + 0x14e),
                                  (SHDEF *)(*(int *)(iLook * 4 + 0x14c) + (i - 0x10U) * 0x93));
    }
    uVar24 = (undefined2)((ulong)lpshdef >> 0x10);
    pSVar20 = (SHDEF *)lpshdef;
    if ((((uint)pSVar20->wFlags >> 9 & 1) == 0) &&
       ((((int)pSVar20->cExist != 0 || (*(int *)((int)&pSVar20->cExist + 2) != 0)) &&
        ((*(uint *)lpb & 0xf) != 0)))) {
      return 0;
    }
    if ((*(uint *)lpb & 0xf) == 0) {
      if (((uint)pSVar20->wFlags >> 9 & 1) == 0) {
        DestroyAllIshdef(i,idPlayer);
        uVar24 = (undefined2)((ulong)lpshdef >> 0x10);
        ((SHDEF *)lpshdef)->wFlags = ((SHDEF *)lpshdef)->wFlags & 0xfdffU | 0x200;
        if (i < 0x10) {
          pcVar2 = (char *)((int)&rgplr[0].cShDef + iLook * 0xc0);
          *pcVar2 = *pcVar2 + -1;
        }
        else {
          iVar15 = *(int *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          puVar1 = (uint *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          *puVar1 = *puVar1 & 0xfff;
          puVar1 = (uint *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          *puVar1 = *puVar1 | iVar15 - 0x1000U & 0xf000;
        }
      }
    }
    else if ((*(uint *)lpb & 0xf) == 1) {
      if (((uint)pSVar20->wFlags >> 9 & 1) != 0) {
        if ((uint)i < 0x10) {
          pcVar2 = (char *)((int)&rgplr[0].cShDef + iLook * 0xc0);
          *pcVar2 = *pcVar2 + '\x01';
        }
        else {
          MStack_544 = *(int *)((int)&rgplr[0].wFlags + iLook * 0xc0) + 0x1000 & 0xf000;
          puVar1 = (uint *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          *puVar1 = *puVar1 & 0xfff;
          pMVar3 = (MessageId *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          *pMVar3 = *pMVar3 | MStack_544;
        }
      }
      if ((uint)i < 0x10) {
        sVar11 = FReadShDef((RTSHDEF *)CONCAT22(lpb._2_2_,(RTSHDEF *)((byte *)lpb + 2)),
                                (SHDEF *)CONCAT22(*(undefined2 *)(iLook * 4 + 0x100),
                                                  (SHDEF *)*(undefined2 *)(iLook * 4 + 0xfe)),
                                idPlayer);
        if (sVar11 == 0) {
          pcVar2 = (char *)((int)&rgplr[0].cShDef + iLook * 0xc0);
          *pcVar2 = *pcVar2 + -1;
          return 0;
        }
      }
      else {
        sVar11 = FReadShDef((RTSHDEF *)CONCAT22(lpb._2_2_,(RTSHDEF *)((byte *)lpb + 2)),
                                (SHDEF *)CONCAT22(*(undefined2 *)(iLook * 4 + 0x14e),
                                                  (SHDEF *)*(undefined2 *)(iLook * 4 + 0x14c)),
                                idPlayer);
        if (sVar11 == 0) {
          iVar15 = *(int *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          puVar1 = (uint *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          *puVar1 = *puVar1 & 0xfff;
          puVar1 = (uint *)((int)&rgplr[0].wFlags + iLook * 0xc0);
          *puVar1 = *puVar1 | iVar15 - 0x1000U & 0xf000;
          return 0;
        }
      }
    }
    break;
  case 0x1d:
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    pPStack_546 = (PLANET *)lpPlanets;
    MStack_544 = lpPlanets._2_2_;
    lpplMac = (PLANET *)lpPlanets + cPlanet;
    local_53a = lpPlanets._2_2_;
    while( true ) {
      if ((lpplMac <= (PLANET *)lppl) || (lppl->id == *(int *)lpb)) break;
      lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
    }
    if ((((PLANET *)lppl == lpplMac) && (lppl._2_2_ == lpPlanets._2_2_)) ||
       (((PLANET *)lppl)->iPlayer != idPlayer)) {
      return 0;
    }
    i = (cb - 2U) / 4;
    if (i == 0) {
      if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) &&
         (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
        return 1;
      }
                    /* WARNING: Load size is inaccurate */
      FreeLp((void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                      ((PLANET *)lppl)->lpplprod),htOrd);
      uVar24 = (undefined2)((ulong)lppl >> 0x10);
      *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
      *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
    }
    else {
      if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) &&
         (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
        pPVar26 = LpplAlloc(4,i + 2,htOrd);
        uVar24 = (undefined2)((ulong)lppl >> 0x10);
        *(PL **)&((PLANET *)lppl)->lpplprod = (PL *)pPVar26;
        *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = (int)((ulong)pPVar26 >> 0x10);
      }
      else if ((uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMax < (uint)i) {
        pPVar26 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)
                                                      ((int)&((PLANET *)lppl)->lpplprod + 2),
                                                     *(PL **)&((PLANET *)lppl)->lpplprod),i + 2);
        uVar24 = (undefined2)((ulong)lppl >> 0x10);
        *(PL **)&((PLANET *)lppl)->lpplprod = (PL *)pPVar26;
        *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = (int)((ulong)pPVar26 >> 0x10);
      }
      for (iPass = 0; iPass < i; iPass = iPass + 1) {
        uVar31 = __aFulshr(uVar32,cOut);
        if ((uVar31 & 0x7f) != 0) {
          for (iLook = 0; pPVar8 = ((PLANET *)lppl)->lpplprod,
              iLook < (int)(uint)((PLPROD *)pPVar8)->iprodMac; iLook = iLook + 1) {
            uVar31 = __aFulshr(uVar32,cOut);
            if ((uVar31 & 0x7f) != 0) {
              uVar31 = __aFulshr(uVar32,cOut);
              local_54a = (uint)uVar31 & 0x7f;
              pPStack_546 = *(PLANET **)((byte *)lpb + iPass * 4 + 2);
              MStack_544 = *(MessageId *)((byte *)lpb + iPass * 4 + 2 + 2);
              lpcdT = (COLDROP *)0x0;
              uVar31 = __aFulshr(uVar32,cOut);
              if ((local_54a == ((uint)uVar31 & 0x7f)) && (lpcdT == (COLDROP *)0x0)) {
                uVar31 = __aFulshr(uVar32,cOut);
                local_54a = (uint)uVar31 & 7;
                pPStack_546 = *(PLANET **)((byte *)lpb + iPass * 4 + 2);
                MStack_544 = *(MessageId *)((byte *)lpb + iPass * 4 + 2 + 2);
                lpcdT = (COLDROP *)0x0;
                uVar31 = __aFulshr(uVar32,cOut);
                if ((local_54a == ((uint)uVar31 & 7)) && (lpcdT == (COLDROP *)0x0)) {
                  uVar23 = (undefined2)((ulong)lppl >> 0x10);
                  pPVar22 = (PLANET *)lppl;
                  uVar24 = *(undefined2 *)((int)&pPVar22->lpplprod + 2);
                  puVar17 = (undefined2 *)(*(int *)&pPVar22->lpplprod + 4 + iLook * 4);
                  uVar14 = puVar17[1];
                  uVar7 = *(undefined2 *)((int)&pPVar22->lpplprod + 2);
                  puVar18 = (undefined2 *)(*(int *)&pPVar22->lpplprod + 4 + iLook * 4);
                  *puVar18 = *puVar17;
                  puVar18[1] = uVar14 & 0xf80f;
                  break;
                }
              }
            }
          }
          pPVar8 = ((PLANET *)lppl)->lpplprod;
          if (iLook == (uint)((PLPROD *)pPVar8)->iprodMac) {
            uVar14 = *(uint *)((byte *)lpb + iPass * 4 + 2 + 2);
            *(undefined2 *)((byte *)lpb + iPass * 4 + 2) =
                 *(undefined2 *)((byte *)lpb + iPass * 4 + 2);
            *(uint *)((byte *)lpb + iPass * 4 + 2 + 2) = uVar14 & 0xf80f;
          }
        }
      }
      uVar24 = (undefined2)((ulong)lppl >> 0x10);
      __fmemmove((void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                          (void *)(*(int *)&((PLANET *)lppl)->lpplprod + 4)),
                         (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 2),i << 2);
      pPVar8 = ((PLANET *)lppl)->lpplprod;
      ((PLPROD *)pPVar8)->iprodMac = (byte)i;
    }
    break;
  case 0x1e:
    i = *(uint *)lpb >> 4 & 0xf;
    if (((*(uint *)lpb & 0xf) == idPlayer) &&
       ((uint)i <= (uint)((byte *)rgcbtlplan)[idPlayer])) {
      if ((*(uint *)lpb >> 0xe & 1) == 0) {
        if (6 < (*(uint *)lpb >> 8 & 0xf)) {
          return 0;
        }
        if (8 < (*(uint *)((byte *)lpb + 2) & 0xf)) {
          return 0;
        }
        if (8 < (*(uint *)((byte *)lpb + 2) >> 4 & 0xf)) {
          return 0;
        }
        if (i == (uint)((byte *)rgcbtlplan)[idPlayer]) {
          if (0xf < (uint)i) {
            return 0;
          }
          ((byte *)rgcbtlplan)[idPlayer] =
               ((byte *)rgcbtlplan)[idPlayer] + 1;
        }
        UnpackBattlePlan
                  (lpb,(BTLPLAN *)
                       CONCAT22(((undefined2 *)&DAT_1120_593a)[idPlayer * 2],
                                ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i),i);
      }
      else {
        FDeleteBattlePlan(i,0);
      }
    }
    else if ((*(uint *)lpb >> 0xe & 1) == 0) {
      return 0;
    }
    break;
  case 0x22:
    bVar6 = *lpb;
    if ((-1 < (char)bVar6) && ((char)bVar6 < 'e')) {
      *(byte *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) = bVar6;
      bVar6 = ((byte *)lpb)[1];
      if (((bVar6 & 0xf) < 6) && (((char)bVar6 >> 4 & 0xfU) < 8)) {
        *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) = bVar6;
        return 1;
      }
    }
    return 0;
  case 0x23:
    lppl = LpplFromId(*(short *)lpb);
    iVar15 = (int)((ulong)lppl >> 0x10);
    if (((PLANET *)lppl == (PLANET *)0x0) && (iVar15 == 0)) {
      return 0;
    }
    if (((PLANET *)lppl)->iPlayer != idPlayer) {
      return 0;
    }
    pPStack_546 = (PLANET *)(*(uint *)((byte *)lpb + 2) & 1);
    MStack_544 = 0;
    lVar30 = __aFlshl(uVar32,cOut);
    uVar24 = (undefined2)((ulong)lppl >> 0x10);
    pPVar22 = (PLANET *)lppl;
    local_54a = *(uint *)&pPVar22->dwFlags | (uint)lVar30;
    lpcdT = (COLDROP *)
            (*(uint *)((int)&pPVar22->dwFlags + 2) & 0xff7f | (uint)((ulong)lVar30 >> 0x10));
    *(uint *)&pPVar22->dwFlags = local_54a;
    *(uint *)((int)&pPVar22->dwFlags + 2) = (uint)lpcdT;
    uVar31 = __aFulshr(uVar32,cOut);
    MStack_544 = (uint)uVar31 & 0x3ff;
    uVar24 = (undefined2)((ulong)lppl >> 0x10);
    ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xfc00U | MStack_544;
    uVar31 = __aFulshr(uVar32,cOut);
    MStack_544 = (uint)uVar31 & 0xf;
    uVar24 = (undefined2)((ulong)lppl >> 0x10);
    ((PLANET *)lppl)->wFlags = ((PLANET *)lppl)->wFlags & 0xc3ffU | MStack_544 << 10;
    uVar32 = __aFulshr(uVar32,cOut);
    uVar24 = (undefined2)((ulong)lppl >> 0x10);
    ((PLANET *)lppl)->wRouting = ((PLANET *)lppl)->wRouting & 0xfc00U | (uint)uVar32 & 0x3ff;
    break;
  case 0x24:
    if (((uint)gd._0_2_ >> 1 & 1) != 0) {
      uVar24 = *(undefined2 *)((byte *)lpb + 2);
      iVar15 = idPlayer * 0xc0;
      *(undefined2 *)((int)&rgplr[0].lSalt + iVar15) = *(undefined2 *)lpb;
      *(undefined2 *)((int)&rgplr[0].lSalt + 2 + iVar15) = uVar24;
    }
    break;
  case 0x26:
    __fmemcpy((void *)(void *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0
                                      ),lpb,game.cPlayer);
    break;
  case 0x2a:
    pFVar29 = LpflFromId(*(short *)lpb);
    if (pFVar29 == (FLEET *)0x0) {
      return 0;
    }
    ((FLEET *)pFVar29)->iplan = (byte)*(undefined2 *)((byte *)lpb + 2);
    break;
  case 0x2b:
    pTVar28 = LpthFromId(*(short *)lpb);
    if ((pTVar28 == (THING *)0x0) || ((uint)pTVar28->idFull >> 0xd != 0)) {
      return 0;
    }
    ((THING *)pTVar28)->rgb[7] = (byte)*(undefined2 *)((byte *)lpb + 2);
    break;
  case 0x2c:
    cOut = 0x20;
    lpfl = LpflFromId(*(short *)lpb);
    uVar24 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar19 = (FLEET *)lpfl;
    if (lpfl == (FLEET *)0x0) {
      return 0;
    }
    if ((*(int *)&pFVar19->lpszName != 0) || (*(int *)((int)&pFVar19->lpszName + 2) != 0)) {
                    /* WARNING: Load size is inaccurate */
      FreeLp((void *)CONCAT22(*(undefined2 *)((int)&pFVar19->lpszName + 2),pFVar19->lpszName
                                     ),htString);
    }
    i = (short)((byte *)lpb)[4];
    if ((i == 0) ||
       (sVar11 = FDecompressUserString
                           ((char *)CONCAT22(lpb._2_2_,(byte *)lpb + 5),i,(char *)szT,&cOut),
       sVar11 == 0)) {
      if (((byte *)lpb)[5] == 0) {
        uVar24 = (undefined2)((ulong)lpfl >> 0x10);
        *(undefined2 *)&((FLEET *)lpfl)->lpszName = 0;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = 0;
      }
      else {
        HVar33 = htString;
        uVar12 = __fstrlen((char *)CONCAT22(lpb._2_2_,(byte *)lpb + 5));
        pvVar27 = LpAlloc(uVar12 + 1,HVar33);
        uVar24 = (undefined2)((ulong)lpfl >> 0x10);
        pFVar19 = (FLEET *)lpfl;
        *(void **)&pFVar19->lpszName = (void *)pvVar27;
        *(undefined2 *)((int)&pFVar19->lpszName + 2) = (int)((ulong)pvVar27 >> 0x10);
                    /* WARNING: Load size is inaccurate */
        __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&pFVar19->lpszName + 2),
                                           pFVar19->lpszName),
                          (char *)CONCAT22(lpb._2_2_,(byte *)lpb + 5));
      }
    }
    else {
      HVar33 = htString;
      uVar12 = _strlen(szT);
      pvVar27 = LpAlloc(uVar12 + 1,HVar33);
      uVar24 = (undefined2)((ulong)lpfl >> 0x10);
      pFVar19 = (FLEET *)lpfl;
      *(void **)&pFVar19->lpszName = (void *)pvVar27;
      *(undefined2 *)((int)&pFVar19->lpszName + 2) = (int)((ulong)pvVar27 >> 0x10);
                    /* WARNING: Load size is inaccurate */
      __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&pFVar19->lpszName + 2),
                                         pFVar19->lpszName),(char *)szT);
    }
    break;
  case 0x2e:
    if (((uint)gd._0_2_ >> 1 & 1) != 0) {
      if (0x1a < (uint)cb) {
        return 0;
      }
      __fmemcpy((void *)(void *)((int)&rgplr[0].zpq1 + idPlayer * 0xc0),lpb
                        ,cb);
    }
  }
  return 1;
}



// ======================================================================
// Function: FLoadLogFile
// Address: 1048:c7a2
// Segment: MEMORY_PLANET
// ======================================================================


short FLoadLogFile(char *pszLog)

{
  MSGPLR *pMVar1;
  undefined2 uVar2;
  short sVar3;
  HRSRC HVar4;
  int iVar5;
  TURNSERIAL *pTVar6;
  undefined2 uVar7;
  bool bVar8;
  void *pvVar9;
  short cSkip;
  ushort hrsrc;
  MSGPLR *lpmp;
  short iCur;
  short cbLog;
  short fRet;
  undefined1 env [18];
  undefined2 penvMemSav;
  ushort hres;
  
  imemLogCur = 0;
  imemLogPrev = -1;
  penvMemSav = penvMem;
  penvMem = env;
  sVar3 = __setjmp(env);
  if (sVar3 != 0) {
    penvMem = (undefined1 *)penvMemSav;
    if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
      if (hf != -1) {
        StreamClose();
        return 0;
      }
      return 1;
    }
    GlobalUnlock(hres);
    FreeResource(hres);
    return 0;
  }
  if (((((uint)game.wCrap >> 3 & 1) == 0) || (idPlayer != 0)) ||
     (((uint)gd._0_2_ >> 1 & 1) == 0)) {
PLANET_StrOpen:
    StreamOpen(pszLog,0x4020);
LAB_1048_c944:
    ReadRt();
    if ((((int)game.lid == rgbCur._4_2_) &&
        (game.lid._2_2_ == rgbCur._6_2_)) &&
       ((uint)game.turn <= (uint)rgbCur._10_2_)) {
      if (rgbCur._10_2_ == game.turn) {
        if ((uint)rgbCur._14_2_ >> 0xd == ((uint)game.wCrap >> 9 & 7)) {
          wVersFile._0_1_ = rgbCur[8];
          wVersFile._1_1_ = rgbCur[9];
          gd.wFlags =
               gd.wFlags & 0xfffbU | ((uint)rgbCur._14_2_ >> 0xc & 1) << 2;
          if (((uint)gd._0_2_ >> 1 & 1) != 0) {
            *(uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0) =
                 *(uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0) & 0xfffd |
                 ((uint)rgbCur._14_2_ >> 0xc & 1) << 1;
          }
          ReadRt();
          uVar2 = rgbCur._0_2_;
          if ((((uint)gd._0_2_ >> 1 & 1) != 0) &&
             ((((TURNSERIAL *)vrgts != (TURNSERIAL *)0x0 || (vrgts._2_2_ != 0)) &&
              (__fmemset((TURNSERIAL *)
                                 CONCAT22(vrgts._2_2_,
                                          (TURNSERIAL *)vrgts + idPlayer),0,0x10),
              uVar7 = rgbCur._4_2_, iVar5 = vrgts._2_2_,
              (hdrCur.wFlags & 0x3ffU) == 0x11)))) {
            pTVar6 = (TURNSERIAL *)vrgts + idPlayer;
            *(undefined2 *)&pTVar6->lSerialNumber = rgbCur._2_2_;
            *(undefined2 *)(char *)((int)&pTVar6->lSerialNumber + 2) = uVar7;
            __fmemcpy((byte *)CONCAT22(vrgts._2_2_,
                                               ((TURNSERIAL *)vrgts)[idPlayer].
                                               rgbConfig),rgbCur + 6,0xb);
          }
          for (iCur = 0; iCur < (int)uVar2; iCur = iCur + (hdrCur.wFlags & 0x3ffU) + 2) {
            ReadRt();
            __fmemmove((byte *)CONCAT22(lpLog._2_2_,(byte *)lpLog + iCur),
                               &hdrCur,2);
            __fmemmove((byte *)CONCAT22(lpLog._2_2_,(byte *)lpLog + iCur + 2),
                               rgbCur,hdrCur.wFlags & 0x3ff);
          }
          ReadRt();
          lpmp = (MSGPLR *)&vlpmsgplrOut;
          while( true ) {
            uVar7 = (undefined2)((ulong)lpmp >> 0x10);
            if ((*(int *)&lpmp->lpmsgplrNext == 0) &&
               (*(int *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2) == 0)) break;
                    /* WARNING: Load size is inaccurate */
            lpmp = (MSGPLR *)
                   CONCAT22(*(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2),
                            lpmp->lpmsgplrNext);
          }
          while (uVar7 = rgbCur._0_2_, (uint)hdrCur.wFlags >> 10 == 0x28) {
            pvVar9 = LpAlloc(hdrCur.wFlags & 0x3ff,htPlrMsg);
            uVar7 = (undefined2)((ulong)lpmp >> 0x10);
            *(void **)&lpmp->lpmsgplrNext = (void *)pvVar9;
            *(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2) = (int)((ulong)pvVar9 >> 0x10)
            ;
                    /* WARNING: Load size is inaccurate */
            pMVar1 = lpmp->lpmsgplrNext;
            uVar7 = *(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2);
            lpmp = (MSGPLR *)CONCAT22(uVar7,pMVar1);
            __fmemcpy((MSGPLR *)CONCAT22(uVar7,pMVar1),rgbCur,
                              hdrCur.wFlags & 0x3ff);
            *(undefined2 *)&lpmp->lpmsgplrNext = 0;
            *(undefined2 *)((int)&pMVar1->lpmsgplrNext + 2) = 0;
            vcmsgplrOut = vcmsgplrOut + 1;
            ReadRt();
          }
          bVar8 = (uint)hdrCur.wFlags >> 10 == 0;
          if (bVar8) {
            rgbCur[0] = (char)uVar2;
            rgbCur[1] = SUB21(uVar2,1);
            imemLogCur._0_1_ = rgbCur[0];
            imemLogCur._1_1_ = rgbCur[1];
          }
          fRet = (short)bVar8;
          rgbCur._0_2_ = uVar7;
          if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
            StreamClose();
          }
          else {
            GlobalUnlock(hres);
            FreeResource(hres);
            vlpMemStream = (byte *)0x0;
          }
          penvMem = (undefined1 *)penvMemSav;
          DirtyGame(0);
          return fRet;
        }
        FileError(idsFileGame);
      }
      else {
        FileError(idsLogFileRecentGameTryingLoadIgnoring);
      }
    }
    if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
      StreamClose();
    }
    else {
      vlpMemStream = (byte *)0x0;
      GlobalUnlock(hres);
      FreeResource(hres);
    }
    penvMem = (undefined1 *)penvMemSav;
    sVar3 = 1;
  }
  else {
    cSkip = game.turn;
    HVar4 = FindResource(hInst,&DAT_0000_2711,&DAT_0000_2710);
    hres = LoadResource(hInst,HVar4);
    if (hres != 0) {
      vlpMemStream = (byte *)LockResource(hres);
      iVar5 = (int)((ulong)vlpMemStream >> 0x10);
      if (((byte *)vlpMemStream != (byte *)0x0) || (iVar5 != 0)) {
        if ((uint)*vlpMemStream <= (uint)game.turn) {
          vlpMemStream = (byte *)0x0;
          GlobalUnlock(hres);
          FreeResource(hres);
          goto PLANET_StrOpen;
        }
        vlpMemStream = (byte *)CONCAT22(iVar5,(byte *)vlpMemStream + 1);
        while (iVar5 = cSkip + -1, cSkip != 0) {
          do {
            vlpMemStream =
                 (byte *)CONCAT22(vlpMemStream._2_2_,
                                  (byte *)vlpMemStream +
                                  (*(uint *)vlpMemStream & 0x3ff) + 2);
            cSkip = iVar5;
          } while (*(uint *)vlpMemStream >> 10 != 8);
        }
        goto LAB_1048_c944;
      }
    }
    penvMem = (undefined1 *)penvMemSav;
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: FCheckLogFile
// Address: 1048:cccc
// Segment: MEMORY_PLANET
// ======================================================================


short FCheckLogFile(short iplr,short *pfError)

{
  undefined2 uVar1;
  undefined2 uVar2;
  short sVar3;
  bool bVar4;
  short iCur;
  short cbLog;
  short fRet;
  undefined1 env [18];
  undefined1 *penvMemSav;
  
  imemLogCur = 0;
  imemLogPrev = -1;
  penvMemSav = penvMem;
  penvMem = env;
  sVar3 = __setjmp(env);
  if (sVar3 == 0) {
    idsFileError = 0;
    sVar3 = FOpenFile(dtLog,iplr,0x20);
    if (sVar3 == 0) {
      if (idsFileError != 4) {
        *pfError = idsFileError;
      }
      fRet = 0;
    }
    else {
      ReadRt();
      uVar1 = rgbCur._0_2_;
      for (iCur = 0; iCur < (int)uVar1; iCur = iCur + (hdrCur.wFlags & 0x3ffU) + 2) {
        ReadRt();
      }
      ReadRt();
      while (uVar2 = rgbCur._0_2_, (uint)hdrCur.wFlags >> 10 == 0x28) {
        ReadRt();
      }
      bVar4 = (uint)hdrCur.wFlags >> 10 != 0;
      if (bVar4) {
        *pfError = 3;
      }
      else {
        rgbCur[0] = (char)uVar1;
        rgbCur[1] = SUB21(uVar1,1);
        imemLogCur._0_1_ = rgbCur[0];
        imemLogCur._1_1_ = rgbCur[1];
        rgbCur._0_2_ = uVar2;
      }
      fRet = (short)!bVar4;
      StreamClose();
      penvMem = penvMemSav;
    }
  }
  else {
    penvMem = penvMemSav;
    if (hf == -1) {
      fRet = 1;
    }
    else {
      StreamClose();
      *pfError = 3;
      fRet = 0;
    }
  }
  return fRet;
}



// ======================================================================
// Function: FWriteLogFile
// Address: 1048:cdf6
// Segment: MEMORY_PLANET
// ======================================================================


short FWriteLogFile(char *pszFileBase,short iPlayer)

{
  ushort cb_00;
  short sVar1;
  char *sz;
  undefined2 unaff_SS;
  MSGPLR *pMVar2;
  undefined2 uVar3;
  short cb;
  MSGPLR *lpmp;
  short rtlh;
  undefined2 local_2e;
  undefined2 local_2c;
  undefined1 local_2a [12];
  HDR *lprts;
  short iCur;
  undefined1 env [18];
  undefined2 penvMemSav;
  
  iCur = 0;
  if (((iPlayer == idPlayer) &&
      ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0)) &&
     ((uint)hdrPrev.wFlags >> 10 != 0x2e)) {
    cb_00 = (0xc - (uint)vrgZipProd[0].cpq) * -2 + 0x1a;
    sVar1 = _memcmp((void *)((int)&rgplr[0].zpq1 + iPlayer * 0xc0),
                            (void *)&vrgZipProd[0].field2_0xe,cb_00);
    if (sVar1 != 0) {
      WriteMemRt(0x2e,cb_00,(void *)&vrgZipProd[0].field2_0xe);
    }
  }
  _strcpy((char *)szBase,pszFileBase);
  sVar1 = FCreateFile(dtLog,iPlayer,(char *)0x0);
  if (sVar1 == 0) {
    sVar1 = 0x10;
    sz = PszFormatIds(idsUnableCreateLogFile,(short *)0x0);
    AlertSz(sz,sVar1);
    sVar1 = 0;
  }
  else {
    penvMemSav = penvMem;
    penvMem = env;
    sVar1 = __setjmp(env);
    if (sVar1 == 0) {
      rtlh = imemLogCur;
      local_2e = (undefined2)vSerialNumber;
      local_2c = vSerialNumber._2_2_;
      _memcpy(local_2a,(undefined *)&vrgbEnvCur,0xb);
      WriteRt(9,0x11,(short *)&rtlh);
      for (; iCur < imemLogCur; iCur = iCur + (lprts->wFlags & 0x3ffU) + 2) {
        lprts = (HDR *)CONCAT22(lpLog._2_2_,(HDR *)((byte *)lpLog + iCur));
        WriteRt((uint)lprts->wFlags >> 10,lprts->wFlags & 0x3ff,
                    (byte *)CONCAT22(lpLog._2_2_,(byte *)lpLog + iCur + 2));
      }
      iCur = vcmsgplrOut;
      lpmp = (MSGPLR *)CONCAT22(vlpmsgplrOut._2_2_,(MSGPLR *)vlpmsgplrOut);
      while (iCur != 0) {
        pMVar2 = (MSGPLR *)lpmp;
        uVar3 = lpmp._2_2_;
        iCur = iCur + -1;
        sVar1 = _abs(((MSGPLR *)lpmp)->cLen);
        WriteRt(0x28,sVar1 + 0xc,(MSGPLR *)CONCAT22(uVar3,pMVar2));
                    /* WARNING: Load size is inaccurate */
        lpmp = (MSGPLR *)
               CONCAT22(*(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2),lpmp->lpmsgplrNext
                       );
      }
      iCur = iCur + -1;
      WriteRt(0,0,(void *)0x0);
      StreamClose();
      penvMem = (undefined1 *)penvMemSav;
      DirtyGame(0);
      gd._4_2_ = gd._4_2_ & 0xfeff | 0x100;
      sVar1 = 1;
    }
    else {
      penvMem = (undefined1 *)penvMemSav;
      StreamClose();
      sVar1 = 0;
    }
  }
  return sVar1;
}



// ======================================================================
// Function: FWriteTutorialMFile
// Address: 1048:d058
// Segment: MEMORY_PLANET
// ======================================================================


short FWriteTutorialMFile(short iTurn)

{
  short sVar1;
  char *pcVar2;
  int iVar3;
  short cSkip;
  short cch;
  undefined1 env [18];
  undefined2 penvMemSav;
  ushort hres;
  char szT [30];
  ushort hrsrc;
  
  cSkip = iTurn;
  penvMemSav = penvMem;
  penvMem = env;
  sVar1 = __setjmp(env);
  if (sVar1 == 0) {
    if (iTurn < 0x20) {
      hrsrc = FindResource(hInst,&DAT_0000_2713,&DAT_0000_2712);
    }
    else {
      hrsrc = FindResource(hInst,&DAT_0000_2715,&DAT_0000_2714);
      cSkip = iTurn + -0x20;
    }
    hres = LoadResource(hInst,hrsrc);
    if (hres != 0) {
      vlpMemStream = (byte *)LockResource(hres);
      iVar3 = (int)((ulong)vlpMemStream >> 0x10);
      if (((byte *)vlpMemStream != (byte *)0x0) || (iVar3 != 0)) {
        if (cSkip < (int)(uint)*vlpMemStream) {
          vlpMemStream = (byte *)CONCAT22(iVar3,(byte *)vlpMemStream + 1);
          while (iVar3 = cSkip + -1, cSkip != 0) {
            do {
              vlpMemStream =
                   (byte *)CONCAT22(vlpMemStream._2_2_,
                                    (byte *)vlpMemStream +
                                    (*(uint *)vlpMemStream & 0x3ff) + 2);
              cSkip = iVar3;
            } while (*(uint *)vlpMemStream >> 10 != 8);
          }
          sVar1 = CchGetString(idsTutorial,szT);
          if (iTurn == 0x25) {
            pcVar2 = (char *)0x9aa;
          }
          else {
            pcVar2 = (char *)0x9af;
          }
          _strcpy(szT + sVar1,pcVar2);
          StreamOpen(szT,0x1012);
          do {
            RgToStream(vlpMemStream,(*(uint *)vlpMemStream & 0x3ff) + 2);
            vlpMemStream =
                 (byte *)CONCAT22(vlpMemStream._2_2_,
                                  (byte *)vlpMemStream +
                                  (*(uint *)vlpMemStream & 0x3ff) + 2);
          } while (*(uint *)vlpMemStream >> 10 != 8);
          StreamClose();
          vlpMemStream = (byte *)0x0;
          GlobalUnlock(hres);
          FreeResource(hres);
          penvMem = (undefined1 *)penvMemSav;
          return 1;
        }
        vlpMemStream = (byte *)0x0;
        GlobalUnlock(hres);
        FreeResource(hres);
        penvMem = (undefined1 *)penvMemSav;
        return 2;
      }
    }
    penvMem = (undefined1 *)penvMemSav;
    sVar1 = 0;
  }
  else {
    penvMem = (undefined1 *)penvMemSav;
    if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
      if (hf == -1) {
        sVar1 = 1;
      }
      else {
        StreamClose();
        sVar1 = 0;
      }
    }
    else {
      GlobalUnlock(hres);
      FreeResource(hres);
      sVar1 = 0;
    }
  }
  return sVar1;
}



// ======================================================================
// Function: FWriteHistFile
// Address: 1048:d29e
// Segment: MEMORY_PLANET
// ======================================================================


short FWriteHistFile(short iPlayer)

{
  int iVar1;
  short sVar2;
  char *sz;
  undefined2 unaff_SS;
  byte *lpb;
  short rthh;
  uint local_28;
  short j;
  int lpshdef;
  undefined2 local_22;
  ushort cTurnBase;
  undefined1 env [18];
  undefined2 penvMemSav;
  short i;
  PLANET *lppl;
  
  sVar2 = FCreateFile(dtHist,iPlayer,(char *)0x0);
  if (sVar2 == 0) {
    sVar2 = 0x10;
    sz = PszFormatIds(idsUnableCreateHistoryFile,(short *)0x0);
    AlertSz(sz,sVar2);
    sVar2 = 0;
  }
  else {
    penvMemSav = penvMem;
    penvMem = env;
    sVar2 = __setjmp(env);
    if (sVar2 == 0) {
      rthh = cPlanet;
      local_28 = *(uint *)((int)&rgplr[0].wFlags + iPlayer * 0xc0) & 0xfff;
      WriteRt(0x20,4,(short *)&rthh);
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      for (i = 0; i < cPlanet; i = i + 1) {
        if ((((PLANET *)lppl)->wFlags & 0xffU) < 3) {
          sVar2 = 0xf;
        }
        else {
          sVar2 = 0xe;
        }
        WritePlanet(lppl,sVar2,1);
        lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
      }
      WriteRt(0x21,cbbitfMsg,bitfMsgFiltered);
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if ((i != iPlayer) && ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 7) != 0)) {
          WriteRtPlr((PLAYER *)rgplr + i,(byte *)0x0);
        }
      }
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) &&
           (i != iPlayer)) {
          lpshdef = *(int *)(i * 4 + 0xfe);
          local_22 = *(undefined2 *)(i * 4 + 0x100);
          for (j = 0; j < 0x10; j = j + 1) {
            if ((*(uint *)(lpshdef + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
              WriteRtShDef((SHDEF *)CONCAT22(local_22,(SHDEF *)(lpshdef + j * 0x93)),
                               (byte **)0x0);
            }
          }
        }
      }
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) &&
           (i != iPlayer)) {
          lpshdef = *(int *)(i * 4 + 0x14c);
          local_22 = *(undefined2 *)(i * 4 + 0x14e);
          for (j = 0; j < 10; j = j + 1) {
            if ((*(uint *)(lpshdef + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
              WriteRtShDef((SHDEF *)CONCAT22(local_22,(SHDEF *)(lpshdef + j * 0x93)),
                               (byte **)0x0);
            }
          }
        }
      }
      if ((uint)game.turn < 0x65) {
        cTurnBase = 0;
      }
      else {
        cTurnBase = game.turn - 100;
      }
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if ((((SCOREX **)rgsxPlr)[i * 2] != (SCOREX *)0x0) ||
           (*(int *)((undefined *)&DAT_1120_156e + i * 4) != 0)) {
          for (j = 0; j < ((short *)rgcsxPlr)[i]; j = j + 1) {
            if (cTurnBase <= (uint)((SCOREX **)rgsxPlr)[i * 2][j].iRank) {
              WriteRt(0x2d,0x18,
                          (SCOREX *)
                          CONCAT22(*(undefined2 *)((undefined *)&DAT_1120_156e + i * 4),
                                   ((SCOREX **)rgsxPlr)[i * 2] + j));
            }
          }
        }
      }
      iVar1 = vlpbAiData._2_2_;
      if ((((byte *)vlpbAiData != (byte *)0x0) || (vlpbAiData._2_2_ != 0)) &&
         (2 < *(uint *)vlpbAiData)) {
        i = *(short *)vlpbAiData;
        lpb = (byte *)vlpbAiData;
        for (; 0x3ff < i; i = i + -0x3ff) {
          WriteRt(0x29,0x3ff,(byte *)CONCAT22(iVar1,lpb));
          lpb = lpb + 0x3ff;
        }
        WriteRt(0x29,i,(byte *)CONCAT22(iVar1,lpb));
      }
      WriteRt(0,0,(void *)0x0);
      StreamClose();
      penvMem = (undefined1 *)penvMemSav;
      sVar2 = 1;
    }
    else {
      penvMem = (undefined1 *)penvMemSav;
      StreamClose();
      sVar2 = 0;
    }
  }
  return sVar2;
}



// ======================================================================
// Function: EnumLogRts
// Address: 1048:d6e0
// Segment: MEMORY_PLANET
// ======================================================================


void EnumLogRts(void *pfn,void *lpPass,short iPass)

{
  int iVar1;
  HDR *lprts;
  short iCur;
  short fRet;
  short fLogOld;
  
  iCur = 0;
  if (imemLogCur != 0) {
    for (; iCur < imemLogCur; iCur = iCur + (lprts->wFlags & 0x3ffU) + 2) {
      lprts = (HDR *)CONCAT22(lpLog._2_2_,(HDR *)((byte *)lpLog + iCur));
      iVar1 = (*(void *)pfn)((undefined *)&DAT_1120_1048,(byte *)lpLog + iCur + 2,
                             lpLog._2_2_,(uint)lprts->wFlags >> 10,lprts->wFlags & 0x3ff,
                             (void *)lpPass,lpPass._2_2_,iPass);
      if (iVar1 == 0) {
        return;
      }
    }
  }
  return;
}



