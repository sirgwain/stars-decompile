// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
//

// ======================================================================
// Function: PlanetWndProc
// Address: 1048:0000
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

long PlanetWndProc(HWND hwnd, WMType message, ushort wParam, long lParam)

{
    int                  iVar1;
    uint                 uVar2;
    undefined2           uVar3;
    HWND                 HVar4;
    char                *pcVar5;
    HDC                  hdc_00;
    BOOL                 BVar6;
    ushort               uVar7;
    short                sVar8;
    WMType              *pWVar9;
    WMType              *pWVar10;
    undefined1          *puVar11;
    undefined1          *puVar12;
    undefined2           unaff_SI;
    undefined2           unaff_DI;
    undefined2           uVar13;
    undefined2           unaff_SS;
    fn_lpfnRealEditProc *pfVar14;
    LRESULT              LVar15;
    ulong                uVar16;
    ulong                uVar17;
    char                *mbType;
    ushort               in_stack_0000ff3a;
    undefined1           local_c4[8];
    ushort               uStack_bc;
    POINT                local_ba;
    RECT                 rc;
    long                 lSel;
    char                *psz;
    short                i;
    XFER                 xf;
    PAINTSTRUCT          ps;
    HDC                  hdc;

    /* Segment:    10
       Offset:     0003d380
       Length:     d783
       Min Alloc:  d783
       Flags:      1d50
           Code
           Discardable
           Moveable
           Preload
           Impure (Non-shareable)
        */
    uVar13 = 0x1048;
    puVar12 = &stack0xff36;
    uVar17 = CONCAT22(unaff_SI, unaff_DI);
    if (message == WM_CREATE) {
        uVar13 = 0x1048;
        SetPlanetTitleBar(hwnd);
        pWVar9 = &stack0xff36;
        for (i = 0; i < 3; i = i + 1) {
            pWVar9[-1] = 0x1120;
            pWVar9[-2] = (WMType)szCombobox;
            pWVar9[-3] = 0x1120;
            pWVar9[-4] = 0x876;
            if (i == 1) {
                uVar2 = 0x210;
            } else {
                uVar2 = 0;
            }
            pWVar9[-5] = 0x4020;
            pWVar9[-6] = uVar2 | 3;
            pWVar9[-7] = 100;
            pWVar9[-8] = 100;
            pWVar9[-9] = 200;
            if (i == 2) {
                uVar3 = 0xa0;
            } else {
                uVar3 = 0x50;
            }
            pWVar9[-10] = uVar3;
            pWVar9[-0xb] = hwnd;
            pWVar9[-0xc] = 0;
            pWVar9[-0xd] = hInst;
            pWVar9[-0xe] = 0;
            pWVar9[-0xf] = 0;
            pWVar9[-0x10] = uVar13;
            pWVar9[-0x11] = 0xa3;
            HVar4 = CreateWindow(*(LPCSTR *)(pWVar9 + -2), *(LPCSTR *)(pWVar9 + -4), *(undefined4 *)(pWVar9 + -6), pWVar9[-7], pWVar9[-8], pWVar9[-9],
                                 pWVar9[-10], pWVar9[-0xb], pWVar9[-0xc], pWVar9[-0xd], *(void **)(pWVar9 + -0xf));
            ((ushort *)rghwndOrderDD)[i] = HVar4;
            pWVar9[1] = ((ushort *)rghwndOrderDD)[i];
            *pWVar9 = 0x30;
            pWVar9[-1] = rghfontArial8[1];
            pWVar9[-2] = 0;
            pWVar9[-3] = 0;
            pWVar9[-4] = 0x14f8;
            uVar13 = 0x14f8;
            pWVar9[-5] = 0xcc;
            SendMessage(pWVar9[1], *pWVar9, pWVar9[-1], *(undefined4 *)(pWVar9 + -3));
            pWVar9 = pWVar9 + 2;
        }
        for (i = 99; i < 0x6d; i = i + 1) {
            pWVar9[-1] = i;
            pWVar9[-2] = uVar13;
            pWVar9[-3] = 0xed;
            pcVar5 = PszGetCompressedString(pWVar9[-1]);
            pWVar9[-1] = rghwndOrderDD[0];
            pWVar9[-2] = 0x403;
            pWVar9[-3] = 0;
            pWVar9[-4] = 0x1120;
            pWVar9[-5] = (WMType)pcVar5;
            pWVar9[-6] = 0x1010;
            uVar13 = 0x14f8;
            pWVar9[-7] = 0x10d;
            SendMessage(pWVar9[-1], pWVar9[-2], pWVar9[-3], *(undefined4 *)(pWVar9 + -5));
        }
        pWVar9[-1] = 0x1120;
        pWVar9[-2] = (WMType)szEdit;
        pWVar9[-3] = 0;
        pWVar9[-4] = 0;
        pWVar9[-5] = 0x4080;
        pWVar9[-6] = 2;
        pWVar9[-7] = 100;
        pWVar9[-8] = 100;
        pWVar9[-9] = 200;
        pWVar9[-10] = 0x32;
        pWVar9[-0xb] = hwnd;
        pWVar9[-0xc] = 0;
        pWVar9[-0xd] = hInst;
        pWVar9[-0xe] = 0;
        pWVar9[-0xf] = 0;
        pWVar9[-0x10] = uVar13;
        pWVar9[-0x11] = 0x15b;
        hwndOrderED = CreateWindow(*(LPCSTR *)(pWVar9 + -2), *(LPCSTR *)(pWVar9 + -4), *(undefined4 *)(pWVar9 + -6), pWVar9[-7], pWVar9[-8], pWVar9[-9],
                                   pWVar9[-10], pWVar9[-0xb], pWVar9[-0xc], pWVar9[-0xd], *(void **)(pWVar9 + -0xf));
        pWVar9[1] = hwndOrderED;
        *pWVar9 = 0x415;
        pWVar9[-1] = 4;
        pWVar9[-2] = 0;
        pWVar9[-3] = 0;
        pWVar9[-4] = 0x14f8;
        pWVar9[-5] = 0x177;
        SendMessage(pWVar9[1], *pWVar9, pWVar9[-1], *(undefined4 *)(pWVar9 + -3));
        pWVar9[1] = hwndOrderED;
        *pWVar9 = 0x30;
        pWVar9[-1] = rghfontArial8[1];
        pWVar9[-2] = 0;
        pWVar9[-3] = 0;
        pWVar9[-4] = 0x14f8;
        pWVar9[-5] = 400;
        SendMessage(pWVar9[1], *pWVar9, pWVar9[-1], *(undefined4 *)(pWVar9 + -3));
        pWVar9[1] = hwndOrderED;
        *pWVar9 = 0xfffc;
        pWVar9[-1] = 0x14f8;
        pWVar9[-2] = 0x19d;
        pfVar14 = (fn_lpfnRealEditProc *)GetWindowLong(pWVar9[1], *pWVar9);
        pWVar9[1] = hwndOrderED;
        *pWVar9 = 0xfffc;
        pWVar9[-1] = lpfnFakeEditProc._2_2_;
        pWVar9[-2] = (WMType)(fn_lpfnFakeEditProc *)lpfnFakeEditProc;
        pWVar9[-3] = 0x14f8;
        pWVar9[-4] = 0x1ba;
        lpfnRealEditProc = pfVar14;
        SetWindowLong(pWVar9[1], *pWVar9, *(undefined4 *)(pWVar9 + -2));
        pWVar9[1] = 0x1120;
        *pWVar9 = (WMType)szCombobox;
        pWVar9[-1] = 0x1120;
        pWVar9[-2] = 0x87c;
        pWVar9[-3] = 0x4020;
        pWVar9[-4] = 3;
        pWVar9[-5] = 100;
        pWVar9[-6] = 100;
        pWVar9[-7] = 200;
        pWVar9[-8] = 0x50;
        pWVar9[-9] = hwnd;
        pWVar9[-10] = 0;
        pWVar9[-0xb] = hInst;
        pWVar9[-0xc] = 0;
        pWVar9[-0xd] = 0;
        pWVar9[-0xe] = 0x14f8;
        pWVar9[-0xf] = 0x1f8;
        hwndBattleDD = CreateWindow(*(LPCSTR *)pWVar9, *(LPCSTR *)(pWVar9 + -2), *(undefined4 *)(pWVar9 + -4), pWVar9[-5], pWVar9[-6], pWVar9[-7], pWVar9[-8],
                                    pWVar9[-9], pWVar9[-10], pWVar9[-0xb], *(void **)(pWVar9 + -0xd));
        pWVar9[3] = hwndBattleDD;
        pWVar9[2] = 0x30;
        pWVar9[1] = rghfontArial8[1];
        *pWVar9 = 0;
        pWVar9[-1] = 0;
        pWVar9[-2] = 0x14f8;
        pWVar9[-3] = 0x214;
        SendMessage(pWVar9[3], pWVar9[2], pWVar9[1], *(undefined4 *)(pWVar9 + -1));
        pWVar9[3] = 0x1120;
        pWVar9[2] = (WMType)szCombobox;
        pWVar9[1] = 0x1120;
        *pWVar9 = 0x885;
        pWVar9[-1] = 0x4020;
        pWVar9[-2] = 0x213;
        pWVar9[-3] = 100;
        pWVar9[-4] = 100;
        pWVar9[-5] = 200;
        pWVar9[-6] = 0x50;
        pWVar9[-7] = hwnd;
        pWVar9[-8] = 0;
        pWVar9[-9] = hInst;
        pWVar9[-10] = 0;
        pWVar9[-0xb] = 0;
        pWVar9[-0xc] = 0x14f8;
        pWVar9[-0xd] = 0x252;
        hwndShipDD = CreateWindow(*(LPCSTR *)(pWVar9 + 2), *(LPCSTR *)pWVar9, *(undefined4 *)(pWVar9 + -2), pWVar9[-3], pWVar9[-4], pWVar9[-5], pWVar9[-6],
                                  pWVar9[-7], pWVar9[-8], pWVar9[-9], *(void **)(pWVar9 + -0xb));
        pWVar9[5] = hwndShipDD;
        pWVar9[4] = 0x30;
        pWVar9[3] = rghfontArial8[1];
        pWVar9[2] = 0;
        pWVar9[1] = 0;
        *pWVar9 = 0x14f8;
        pWVar9[-1] = 0x26e;
        SendMessage(pWVar9[5], pWVar9[4], pWVar9[3], *(undefined4 *)(pWVar9 + 1));
        pWVar9[5] = hwndShipDD;
        pWVar9[4] = unaff_SS;
        pWVar9[3] = (WMType)&rc;
        pWVar9[2] = 0x14f8;
        pWVar9[1] = 0x27f;
        GetClientRect(pWVar9[5], *(RECT **)(pWVar9 + 3));
        dyShipDD = rc.bottom;
        pWVar9[5] = 0x1120;
        pWVar9[4] = (WMType)szListbox;
        pWVar9[3] = 0x1120;
        pWVar9[2] = 0x88c;
        pWVar9[1] = 0x40a0;
        *pWVar9 = 0x1001;
        pWVar9[-1] = 100;
        pWVar9[-2] = 100;
        pWVar9[-3] = 200;
        pWVar9[-4] = 0x50;
        pWVar9[-5] = hwnd;
        pWVar9[-6] = 0;
        pWVar9[-7] = hInst;
        pWVar9[-8] = 0;
        pWVar9[-9] = 0;
        pWVar9[-10] = 0x14f8;
        pWVar9[-0xb] = 0x2c4;
        hwndShipLB = CreateWindow(*(LPCSTR *)(pWVar9 + 4), *(LPCSTR *)(pWVar9 + 2), *(DWORD *)pWVar9, pWVar9[-1], pWVar9[-2], pWVar9[-3], pWVar9[-4],
                                  pWVar9[-5], pWVar9[-6], pWVar9[-7], *(void **)(pWVar9 + -9));
        pWVar9[7] = hwndShipLB;
        pWVar9[6] = 0x30;
        pWVar9[5] = rghfontArial8[1];
        pWVar9[4] = 0;
        pWVar9[3] = 0;
        pWVar9[2] = 0x14f8;
        pWVar9[1] = 0x2e0;
        SendMessage(pWVar9[7], pWVar9[6], pWVar9[5], *(undefined4 *)(pWVar9 + 3));
        pWVar9[7] = 0x1120;
        pWVar9[6] = (WMType)szListbox;
        pWVar9[5] = 0x1120;
        pWVar9[4] = 0x893;
        pWVar9[3] = 0x40a0;
        pWVar9[2] = 0x51;
        pWVar9[1] = 100;
        *pWVar9 = 100;
        pWVar9[-1] = 200;
        pWVar9[-2] = 0x50;
        pWVar9[-3] = hwnd;
        pWVar9[-4] = 0;
        pWVar9[-5] = hInst;
        pWVar9[-6] = 0;
        pWVar9[-7] = 0;
        pWVar9[-8] = 0x14f8;
        pWVar9[-9] = 0x31e;
        hwndFleetCompLB = CreateWindow(*(LPCSTR *)(pWVar9 + 6), *(LPCSTR *)(pWVar9 + 4), *(undefined4 *)(pWVar9 + 2), pWVar9[1], *pWVar9, pWVar9[-1],
                                       pWVar9[-2], pWVar9[-3], pWVar9[-4], pWVar9[-5], *(void **)(pWVar9 + -7));
        pWVar9[9] = hwndFleetCompLB;
        pWVar9[8] = 0x30;
        pWVar9[7] = rghfontArial8[0];
        pWVar9[6] = 0;
        pWVar9[5] = 0;
        pWVar9[4] = 0x14f8;
        pWVar9[3] = 0x33a;
        SendMessage(pWVar9[9], pWVar9[8], pWVar9[7], *(undefined4 *)(pWVar9 + 5));
        pWVar9[9] = 0x1120;
        pWVar9[8] = (WMType)szListbox;
        pWVar9[7] = 0x1120;
        pWVar9[6] = 0x89f;
        pWVar9[5] = 0x40a0;
        pWVar9[4] = 0x51;
        pWVar9[3] = 100;
        pWVar9[2] = 100;
        pWVar9[1] = 200;
        *pWVar9 = 0x50;
        pWVar9[-1] = hwnd;
        pWVar9[-2] = 0;
        pWVar9[-3] = hInst;
        pWVar9[-4] = 0;
        pWVar9[-5] = 0;
        pWVar9[-6] = 0x14f8;
        pWVar9[-7] = 0x378;
        hwndPlanetProdLB = CreateWindow(*(LPCSTR *)(pWVar9 + 8), *(LPCSTR *)(pWVar9 + 6), *(undefined4 *)(pWVar9 + 4), pWVar9[3], pWVar9[2], pWVar9[1], *pWVar9,
                                        pWVar9[-1], pWVar9[-2], pWVar9[-3], *(void **)(pWVar9 + -5));
        pWVar9[0xb] = hwndPlanetProdLB;
        pWVar9[10] = 0x30;
        pWVar9[9] = rghfontArial8[0];
        pWVar9[8] = 0;
        pWVar9[7] = 0;
        pWVar9[6] = 0x14f8;
        pWVar9[5] = 0x394;
        SendMessage(pWVar9[0xb], pWVar9[10], pWVar9[9], *(undefined4 *)(pWVar9 + 7));
        pWVar10 = pWVar9 + 0xc;
        for (i = 0; i < 0xd; i = i + 1) {
            pWVar10[-1] = i + 0x19f;
            pWVar10[-2] = 0x14f8;
            pWVar10[-3] = 0x3aa;
            pcVar5 = PszGetCompressedString(pWVar10[-1]);
            pWVar10[-1] = 0x1120;
            pWVar10[-2] = (WMType)szButton;
            pWVar10[-3] = 0x1120;
            pWVar10[-4] = (WMType)pcVar5;
            pWVar10[-5] = 0x4000;
            pWVar10[-6] = 0;
            pWVar10[-7] = 100;
            pWVar10[-8] = 100;
            pWVar10[-9] = 100;
            pWVar10[-10] = dyArial8 << 1;
            pWVar10[-0xb] = hwnd;
            pWVar10[-0xc] = 0;
            pWVar10[-0xd] = hInst;
            pWVar10[-0xe] = 0;
            pWVar10[-0xf] = 0;
            pWVar10[-0x10] = 0x1010;
            pWVar10[-0x11] = 0x3f2;
            HVar4 = CreateWindow(*(LPCSTR *)(pWVar10 + -2), *(LPCSTR *)(pWVar10 + -4), *(undefined4 *)(pWVar10 + -6), pWVar10[-7], pWVar10[-8], pWVar10[-9],
                                 pWVar10[-10], pWVar10[-0xb], pWVar10[-0xc], pWVar10[-0xd], *(void **)(pWVar10 + -0xf));
            ((ushort *)rghwndBtn)[i] = HVar4;
            pWVar10[1] = ((ushort *)rghwndBtn)[i];
            *pWVar10 = 0x30;
            pWVar10[-1] = rghfontArial8[1];
            pWVar10[-2] = 0;
            pWVar10[-3] = 0;
            pWVar10[-4] = 0x14f8;
            pWVar10[-5] = 0x41b;
            SendMessage(pWVar10[1], *pWVar10, pWVar10[-1], *(undefined4 *)(pWVar10 + -3));
            pWVar10 = pWVar10 + 2;
        }
        pWVar10[-1] = 0x1120;
        pWVar10[-2] = (WMType)szButton;
        pWVar10[-3] = 799;
        pWVar10[-4] = 0x14f8;
        pWVar10[-5] = 0x43a;
        pcVar5 = PszGetCompressedString(pWVar10[-3]);
        pWVar10[-3] = 0x1120;
        pWVar10[-4] = (WMType)pcVar5;
        pWVar10[-5] = 0x4000;
        pWVar10[-6] = 3;
        pWVar10[-7] = 100;
        pWVar10[-8] = 100;
        pWVar10[-9] = 0x96;
        pWVar10[-10] = dyArial8;
        pWVar10[-0xb] = hwnd;
        pWVar10[-0xc] = 0;
        pWVar10[-0xd] = hInst;
        pWVar10[-0xe] = 0;
        pWVar10[-0xf] = 0;
        pWVar10[-0x10] = 0x1010;
        pWVar10[-0x11] = 0x471;
        hwndRepCB = CreateWindow(*(LPCSTR *)(pWVar10 + -2), *(LPCSTR *)(pWVar10 + -4), *(undefined4 *)(pWVar10 + -6), pWVar10[-7], pWVar10[-8], pWVar10[-9],
                                 pWVar10[-10], pWVar10[-0xb], pWVar10[-0xc], pWVar10[-0xd], *(void **)(pWVar10 + -0xf));
        pWVar10[1] = hwndRepCB;
        *pWVar10 = 0x30;
        pWVar10[-1] = rghfontArial8[1];
        pWVar10[-2] = 0;
        pWVar10[-3] = 0;
        pWVar10[-4] = 0x14f8;
        pWVar10[-5] = 0x48d;
        SendMessage(pWVar10[1], *pWVar10, pWVar10[-1], *(undefined4 *)(pWVar10 + -3));
    } else {
        if (message != WM_PAINT) {
            if (message == WM_ERASEBKGND) {
                GetClientRect(hwnd, &rc);
                FillRect(wParam, &rc, hbrButtonFace);
                uVar17 = 1;
                pfVar14 = lpfnRealEditProc;
                goto LAB_1048_0d0d;
            }
            if (message == WM_CTLCOLOR) {
                if ((HWND)lParam == hwndRepCB) {
                    SetBkColor(wParam, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
                    SetTextColor(wParam, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
                    uVar17 = (ulong)hbrButtonFace;
                    pfVar14 = lpfnRealEditProc;
                    goto LAB_1048_0d0d;
                }
            } else if (message == WM_SETCURSOR) {
                stack0xff42 = (PLANET *)((ulong)stack0xff42 & 0xffff);
                GetCursorPos(&local_ba);
                ScreenToClient(hwnd, &local_ba);
                GetClientRect(hwnd, local_c4);
                uVar13 = 0x14f8;
                BVar6 = PtInRect(local_c4, local_ba);
                if (BVar6 != 0) {
                    uVar13 = 0x1050;
                    uVar7 = ClickInShipOrders(local_ba, 0, 1, 0);
                    stack0xff42 = (PLANET *)CONCAT22(uVar7, local_c4._6_2_);
                    if (uVar7 == 0) {
                        uVar13 = 0x1048;
                        uVar7 = ClickInPlanetOrders(local_ba, 0, 1, 0);
                        stack0xff42 = (PLANET *)CONCAT22(uVar7, local_c4._6_2_);
                    }
                    if (uStack_bc != 0) {
                        SetCursor(uStack_bc);
                        uVar17 = 1;
                        pfVar14 = lpfnRealEditProc;
                        goto LAB_1048_0d0d;
                    }
                }
                puVar12 = &stack0xff32;
            } else {
                if (message != WM_GETMINMAXINFO) {
                    if (message == WM_DRAWITEM) {
                        local_ba = (POINT)lParam;
                        if (*(int *)((HWND)lParam + 4) == -1) {
                            HandleFocusState((DRAWITEMSTRUCT *)lParam, -2);
                        } else {
                            iVar1 = *(int *)((HWND)lParam + 6);
                            if (iVar1 == 1) {
                                DrawCBEntireItem((DRAWITEMSTRUCT *)lParam, -4);
                            } else if (iVar1 == 2) {
                                DrawCBEntireItem((DRAWITEMSTRUCT *)lParam, -4);
                            } else if (iVar1 == 4) {
                                DrawCBEntireItem((DRAWITEMSTRUCT *)lParam, -4);
                            }
                        }
                        uVar17 = 1;
                        pfVar14 = lpfnRealEditProc;
                        goto LAB_1048_0d0d;
                    }
                    if (message == WM_MEASUREITEM) {
                        *(int *)((HWND)lParam + 8) = dyArial8 + 2;
                        uVar17 = 1;
                        pfVar14 = lpfnRealEditProc;
                        goto LAB_1048_0d0d;
                    }
                    if (message == WM_CHAR) {
                        if ((wParam == 0x66) || (wParam == 0x46)) {
                            local_c4._0_2_ = lpPlanets._2_2_;
                            local_ba.y = lpPlanets._2_2_;
                            local_ba.x = (short)((PLANET *)lpPlanets + cPlanet);
                            stack0xff42 = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
                            while ((uint)local_c4._6_2_ < (PLANET *)lpPlanets + cPlanet) {
                                uVar13 = (undefined2)((ulong)stack0xff42 >> 0x10);
                                if (*(short *)(local_c4._6_2_ + 2) == idPlayer) {
                                    if ((sel.grobj != grobjPlanet) || (sel.id != stack0xff42->id)) {
                                        SelectAdjPlanet(0, stack0xff42->id);
                                        uVar17 = 0;
                                        pfVar14 = lpfnRealEditProc;
                                        goto LAB_1048_0d0d;
                                    }
                                    break;
                                }
                                stack0xff42 = (PLANET *)CONCAT22(uVar13, (PLANET *)(local_c4._6_2_ + 0x38));
                            }
                            for (i = 0; i < cFleet; i = i + 1) {
                                local_c4._2_2_ = *(undefined2 *)((FLEET **)rglpfl + i);
                                local_c4._4_2_ = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                                if (((int *)local_c4._2_2_ == (int *)0x0) && (local_c4._4_2_ == 0))
                                    break;
                                if (*(int *)(local_c4._2_2_ + 2) == idPlayer) {
                                    if ((sel.grobj != grobjFleet) || (sel.id != *(int *)local_c4._2_4_)) {
                                        SelectAdjFleet(0, *(short *)local_c4._2_4_);
                                        uVar17 = 0;
                                        pfVar14 = lpfnRealEditProc;
                                        goto LAB_1048_0d0d;
                                    }
                                    break;
                                }
                            }
                        }
                    } else if (message == WM_COMMAND) {
                        if (sel.grobj == grobjFleet) {
                            ShipCommandProc(hwnd, wParam, lParam);
                        } else {
                            if ((HWND)lParam == hwndShipDD) {
                                uVar13 = 0x1118;
                                uVar17 = __aFulshr(uVar17, in_stack_0000ff3a);
                                if ((int)uVar17 == 1) {
                                    uVar13 = 0x1048;
                                    DrawPlanShip(0, -0x7ffc);
                                }
                                puVar12 = &stack0xff36;
                                goto PLANET_Default_6;
                            }
                            if ((HWND)lParam != rghwndBtn[4]) {
                            LAB_1048_0950:
                                if ((HWND)lParam == rghwndBtn[5]) {
                                    uVar13 = 0x1118;
                                    uVar16 = __aFulshr(uVar17, in_stack_0000ff3a);
                                    if ((int)uVar16 == 0) {
                                        sVar8 = GetKeyState(0x10);
                                        if (sVar8 < 0) {
                                            sVar8 = IdFindAdjStarbase(sel.pl.id, 1);
                                            SelectAdjPlanet(0, sVar8);
                                        } else {
                                            SelectAdjPlanet(1, 0);
                                        }
                                        puVar11 = &stack0xff34;
                                        uVar13 = 0x1048;
                                        goto PLANET_LRefocus;
                                    }
                                }
                                if ((HWND)lParam == rghwndBtn[0]) {
                                    uVar13 = 0x1118;
                                    uVar16 = __aFulshr(uVar17, in_stack_0000ff3a);
                                    if ((int)uVar16 == 0) {
                                        LVar15 = SendMessage(hwndShipDD, CB_GETCURSEL, 0, 0);
                                        if (LVar15 != -1) {
                                            sVar8 = FLookupOrbitingXfer(sel.pl.id, (short)LVar15, &xf, -1);
                                            if (sVar8 != 0) {
                                                uVar13 = 0x1050;
                                                TransferStuff(sel.pl.id, 1, xf.id, xf.grobj, 0);
                                                puVar11 = &stack0xff36;
                                                goto PLANET_LRefocus;
                                            }
                                        }
                                        goto LAB_1048_0d04;
                                    }
                                }
                                if ((HWND)lParam == rghwndBtn[1]) {
                                    uVar13 = 0x1118;
                                    uVar16 = __aFulshr(uVar17, in_stack_0000ff3a);
                                    if ((int)uVar16 == 0) {
                                        uVar13 = 0x14f8;
                                        LVar15 = SendMessage(hwndShipDD, CB_GETCURSEL, 0, 0);
                                        puVar11 = &stack0xff36;
                                        if (LVar15 != -1) {
                                            uVar13 = 0x1038;
                                            sVar8 = FLookupOrbitingXfer(sel.pl.id, (short)LVar15, &xf, -1);
                                            if ((sVar8 != 0) && (xf.grobj == grobjFleet)) {
                                                uVar13 = 0x1050;
                                                SelectAdjFleet(0, xf.id);
                                            }
                                            puVar11 = &stack0xff36;
                                        }
                                        goto PLANET_LRefocus;
                                    }
                                }
                                if ((HWND)lParam == rghwndBtn[2]) {
                                    uVar13 = 0x1118;
                                    uVar16 = __aFulshr(uVar17, in_stack_0000ff3a);
                                    if ((int)uVar16 == 0) {
                                        local_ba.x = 0x262;
                                        local_ba.y = 0x1d6;
                                        uVar13 = 0x10c8;
                                        ShipBuilder((POINT)0x1d60262);
                                        puVar11 = &stack0xff36;
                                        goto PLANET_LRefocus;
                                    }
                                }
                                if ((HWND)lParam == rghwndBtn[0xb]) {
                                    uVar13 = 0x1118;
                                    uVar16 = __aFulshr(uVar17, in_stack_0000ff3a);
                                    if ((int)uVar16 == 0) {
                                        uVar13 = 0x10d0;
                                        ChangeProduction(0);
                                        puVar11 = &stack0xff36;
                                        goto PLANET_LRefocus;
                                    }
                                }
                                if ((HWND)lParam == rghwndBtn[0xc]) {
                                    uVar13 = 0x1118;
                                    uVar16 = __aFulshr(uVar17, in_stack_0000ff3a);
                                    if ((int)uVar16 == 0) {
                                        mbType = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
                                        pcVar5 = PszFormatIds(idsSureWantDeleteEverythingPlanetsProductionQueue, (short *)0x0);
                                        sVar8 = AlertSz(pcVar5, (short)mbType);
                                        if (sVar8 != 6)
                                            goto LAB_1048_0d04;
                                        uVar13 = 0x10d0;
                                        ChangeProduction(1);
                                        puVar11 = &stack0xff36;
                                        goto PLANET_LRefocus;
                                    }
                                }
                                puVar12 = &stack0xff36;
                                if ((HWND)lParam == hwndPlanetProdLB) {
                                    uVar13 = 0x1118;
                                    uVar17 = __aFulshr(uVar17, in_stack_0000ff3a);
                                    puVar12 = &stack0xff36;
                                    if ((int)uVar17 == 1) {
                                        uVar13 = 0x1048;
                                        DrawPlanShip(0, 0x40);
                                        if (((uint)gd.grBits >> 0xb & 1) != 0) {
                                            tutor.wFlags = tutor.wFlags & 0xfbffU | 0x400;
                                            uVar13 = 0x10f8;
                                            AdvanceTutor();
                                        }
                                        puVar12 = &stack0xff36;
                                    }
                                }
                                goto PLANET_Default_6;
                            }
                            uVar13 = 0x1118;
                            uVar16 = __aFulshr(uVar17, in_stack_0000ff3a);
                            if ((int)uVar16 != 0)
                                goto LAB_1048_0950;
                            sVar8 = GetKeyState(0x10);
                            if (sVar8 < 0) {
                                sVar8 = IdFindAdjStarbase(sel.pl.id, 0);
                                uVar13 = 0x1048;
                                SelectAdjPlanet(0, sVar8);
                                puVar11 = &stack0xff34;
                            } else {
                                uVar13 = 0x1048;
                                SelectAdjPlanet(-1, 0);
                                puVar11 = &stack0xff34;
                            }
                        PLANET_LRefocus:
                            *(HWND *)(puVar11 + -2) = hwndFrame;
                            *(undefined2 *)(puVar11 + -4) = uVar13;
                            *(undefined2 *)(puVar11 + -6) = 0x94a;
                            SetFocus(*(HWND *)(puVar11 + -2));
                        }
                    } else if (((message == WM_LBUTTONDOWN) || (message == WM_LBUTTONDBLCLK)) || (message == WM_RBUTTONDOWN)) {
                        SetFocus(hwndFrame);
                        uVar2 = (uint)(message == WM_RBUTTONDOWN);
                        uVar17 = __aFulshr((ulong)CONCAT12(message == WM_RBUTTONDOWN, wParam), (ushort)uVar17);
                        PlanetClick((HWND)lParam, (short)uVar17, wParam, uVar2);
                    } else {
                        puVar12 = &stack0xff36;
                        if (message != WM_MDIACTIVATE)
                            goto PLANET_Default_6;
                        hwndActive = hwnd;
                        if (wParam == 0) {
                            hwndActive = 0;
                        }
                    }
                    goto LAB_1048_0d04;
                }
                *(int *)((HWND)lParam + 0xc) = dxWinFrame * 2 + 0xc6;
                *(int *)((HWND)lParam + 0xe) = dyWinFrame * 2 + 0xc6 + dyTitleBar;
                puVar12 = &stack0xff36;
            }
        PLANET_Default_6:
            *(HWND *)(puVar12 + -2) = hwnd;
            *(WMType *)(puVar12 + -4) = message;
            *(ushort *)(puVar12 + -6) = wParam;
            *(undefined2 *)(puVar12 + -8) = lParam._2_2_;
            *(HWND *)(puVar12 + -10) = (HWND)lParam;
            *(undefined2 *)(puVar12 + -0xc) = uVar13;
            *(undefined2 *)(puVar12 + -0xe) = 0xc8b;
            uVar17 = DefWindowProc(*(HWND *)(puVar12 + -2), *(UINT *)(puVar12 + -4), *(WPARAM *)(puVar12 + -6), *(LPARAM *)(puVar12 + -10));
            pfVar14 = lpfnRealEditProc;
            goto LAB_1048_0d0d;
        }
        hdc_00 = BeginPaint(hwnd, &ps);
        DrawPlanShip(hdc_00, 0xfff);
        EndPaint(hwnd, &ps);
    }
LAB_1048_0d04:
    uVar17 = 0;
    pfVar14 = lpfnRealEditProc;
LAB_1048_0d0d:
    lpfnRealEditProc._2_2_ = (undefined2)((ulong)pfVar14 >> 0x10);
    lpfnRealEditProc._0_2_ = (fn_lpfnRealEditProc *)pfVar14;
    return uVar17;
}

// ======================================================================
// Function: DrawPlanShip
// Address: 1048:0d16
// Segment: MEMORY_PLANET
// ======================================================================

void DrawPlanShip(HDC hdc, short grbit)

{
    short        cLen;
    HGDIOBJ      HVar1;
    u_OBJ_0x0000 uVar2;
    undefined2   unaff_SS;
    bool         bVar3;
    COLORREF     CVar4;
    COLORREF     CVar5;
    RECT         rc;
    short        fDC;
    TILE        *ptile;
    short        fErase;
    COLORREF     crBack;
    short        i;
    short        fMin;
    OBJ          obj;
    COLORREF     crFore;
    short        ctile;
    OBJ          objNull;
    HFONT        hfontSav;

    if (sel.id == -1) {
        for (i = 0; i < 0xd; i = i + 1) {
            ShowWindow(((ushort *)rghwndBtn)[i], 0);
        }
        for (i = 0; i < 3; i = i + 1) {
            ShowWindow(((ushort *)rghwndOrderDD)[i], 0);
        }
        ShowWindow(hwndOrderED, 0);
        ShowWindow(hwndShipDD, 0);
        ShowWindow(hwndBattleDD, 0);
        ShowWindow(hwndShipLB, 0);
        ShowWindow(hwndFleetCompLB, 0);
        ShowWindow(hwndPlanetProdLB, 0);
        ShowWindow(hwndRepCB, 0);
        for (i = 0; i < 0x13; i = i + 1) {
            *(undefined2 *)((int)&rgrcRef[0].bottom + i * 8) = 0xfffa;
            *(undefined2 *)((int)&rgrcRef[0].top + i * 8) = 0xfffb;
        }
        if (((*(uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0) & 1) != 0) && (hdc != 0)) {
            GetClientRect(hwndPlanet, &rc);
            SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
            SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
            cLen = CchGetString(idsDeceased, (char *)szWork);
            DiaganolTextOut(hdc, &rc, (char *)szWork, cLen);
        }
    } else {
        if (sel.grobj == grobjFleet) {
            ptile = (TILE *)&rgtileShip;
            ctile = 7;
            obj.u_OBJ_0x0000 = (u_OBJ_0x0000)0x4972;
        } else {
            ptile = (TILE *)&rgtilePlanet;
            ctile = 6;
            obj.u_OBJ_0x0000 = (u_OBJ_0x0000)0x49ee;
        }
        bVar3 = hdc == 0;
        if (bVar3) {
            hdc = GetDC(hwndPlanet);
        }
        HVar1 = SelectObject(hdc, rghfontArial8[0]);
        CVar4 = SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
        CVar5 = SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
        for (i = 0; i < ctile; i = i + 1) {
            if ((grbit & ptile[i].grbit) != 0) {
                ptile[i].wFlags_0xa = ptile[i].wFlags_0xa & 0xfbff | (uint)((grbit & 0x8000U) != 0) << 10;
                ptile[i].wFlags_0xa = ptile[i].wFlags_0xa & 0xefff | (uint)((grbit & 0x4000U) != 0) << 0xc;
                uVar2 = obj.u_OBJ_0x0000;
                if ((ptile[i].wFlags_0xa >> 8 & 1) != 0) {
                    uVar2.pfl = (FLEET *)0x0;
                }
                /* WARNING: Load size is inaccurate */
                (*ptile[i].pfn)(hdc, ptile + i, uVar2.pfl);
            }
        }
        SetTextColor(hdc, CVar5);
        SetBkColor(hdc, CVar4);
        SelectObject(hdc, HVar1);
        if (bVar3) {
            ReleaseDC(hwndPlanet, hdc);
        }
    }
    return;
}

// ======================================================================
// Function: FDrawTileNC
// Address: 1048:1086
// Segment: MEMORY_PLANET
// ======================================================================

short FDrawTileNC(HDC hdc, TILE *ptile, RECT *prc, char *pszTitle)

{
    int        iVar1;
    undefined2 unaff_SS;
    RECT       rcT;
    short      bt;

    prc->left = (ptile->wFlags_0xa & 7) * 0xc6 + 4;
    prc->right = prc->left + 0xbe;
    prc->top = ptile->yTop;
    if ((ptile->wFlags_0xa >> 7 & 1) == 0) {
        iVar1 = dyArial8 + 3;
    } else {
        iVar1 = ptile->dyFull;
    }
    prc->bottom = iVar1 + prc->top;
    if (((ptile->wFlags_0xa >> 0xc & 1) == 0) || ((ptile->wFlags_0xa >> 9 & 1) != 0)) {
        if ((ptile->wFlags_0xa >> 0xc & 1) == 0) {
            _Draw3dFrame(hdc, prc, 0);
        }
        rcT.left = prc->left;
        rcT.top = prc->top;
        rcT.right = prc->right;
        rcT.bottom = prc->bottom;
        ExpandRc(&rcT, -1, -1);
        rcT.bottom = rcT.top + dyArial8 + 2;
        SelectObject(hdc, rghfontArial8[1]);
        SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
        SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
        if ((ptile->wFlags_0xa >> 0xc & 1) == 0) {
            _Draw3dFrame(hdc, &rcT, 0);
        }
        RcCtrTextOut(hdc, &rcT, pszTitle, -1);
        SetRect(&rcT, prc->right + -0x11, prc->top + 1, prc->right, rcT.bottom + 1);
        if ((ptile->wFlags_0xa >> 7 & 1) == 0) {
            bt = 0x71;
        } else {
            bt = 0x70;
        }
        DrawBtn(hdc, &rcT, bt, 0, (char *)0x0);
        SelectObject(hdc, hbrButtonShadow);
        PatBlt(hdc, prc->right + -0x12, prc->top + 1, 1, (rcT.bottom - prc->top) + -1, 0xf00021);
    }
    prc->top = prc->top + dyArial8 + 4;
    return ptile->wFlags_0xa >> 7 & 1;
}

// ======================================================================
// Function: DrawPlanetMinSum
// Address: 1048:12b2
// Segment: MEMORY_PLANET
// ======================================================================

// Decompilation failed: Exception while decompiling 1048:12b2: Decompiler process died

// ======================================================================
// Function: DrawPlanetStats
// Address: 1048:1716
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10481c86) */
/* WARNING: Removing unreachable block (ram,0x10481af7) */
/* WARNING: Removing unreachable block (ram,0x10481ff2) */
/* WARNING: Removing unreachable block (ram,0x1048191e) */
/* WARNING: Removing unreachable block (ram,0x1048187a) */
/* WARNING: Removing unreachable block (ram,0x104817d6) */
/* WARNING: Removing unreachable block (ram,0x10481828) */
/* WARNING: Removing unreachable block (ram,0x104818cc) */
/* WARNING: Removing unreachable block (ram,0x10481970) */

void DrawPlanetStats(HDC hdc, TILE *ptile, OBJ obj)

{
    bool       bVar1;
    char      *pcVar2;
    short      sVar3;
    int        iVar4;
    HGDIOBJ    HVar5;
    uint       uVar6;
    StringId   SVar7;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    DWORD      DVar8;
    DWORD      DVar9;
    ulong      uVar10;
    long       lVar11;
    ushort     in_stack_0000ffb2;
    undefined2 in_stack_0000ffb4;
    PART       local_36;
    RECT       rc;
    long       l;
    HBRUSH     hbrSav;
    short      xLeft;
    char      *psz;
    short      dRange;
    short      cResAvail;
    float      pct;
    short      dRangeP;
    short      cRes;
    short      c;
    short      xRight;
    short      yTop;
    long       l2;
    short      dxRight;

    pcVar2 = PszGetCompressedString(idsStatus);
    sVar3 = FDrawTileNC(hdc, ptile, &rc, pcVar2);
    if (sVar3 != 0) {
        iVar4 = rc.left + 4;
        xRight = rc.right + -4;
        yTop = rc.top;
        SelectObject(hdc, rghfontArial8[1]);
        c = CchGetString(idsPopulation4, (char *)szWork);
        DVar8 = GetTextExtent(hdc, szWork, c);
        c = CchGetString(idsScannerType, (char *)szWork);
        l2 = GetTextExtent(hdc, szWork, c);
        if ((long)DVar8 < l2) {
            DVar8 = l2;
        }
        c = CchGetString(idsScannerRange, (char *)szWork);
        DVar9 = GetTextExtent(hdc, szWork, c);
        if ((long)DVar8 < (long)DVar9) {
            DVar8 = DVar9;
        }
        l2 = DVar9;
        c = CchGetString(idsDefenses4, (char *)szWork);
        DVar9 = GetTextExtent(hdc, szWork, c);
        if ((long)DVar8 < (long)DVar9) {
            DVar8 = DVar9;
        }
        l2 = DVar9;
        c = CchGetString(idsDefenseType, (char *)szWork);
        DVar9 = GetTextExtent(hdc, szWork, c);
        if ((long)DVar8 < (long)DVar9) {
            DVar8 = DVar9;
        }
        l2 = DVar9;
        c = CchGetString(idsDefCoverage, (char *)szWork);
        DVar9 = GetTextExtent(hdc, szWork, c);
        if ((long)DVar8 < (long)DVar9) {
            DVar8 = DVar9;
        }
        l2 = DVar9;
        c = CchGetString(idsResourcesYear, (char *)szWork);
        DVar9 = GetTextExtent(hdc, szWork, c);
        if ((long)DVar8 < (long)DVar9) {
            DVar8 = DVar9;
        }
        l._0_2_ = (int)DVar8;
        dxRight = (xRight - iVar4) - (int)l;
        if ((ptile->wFlags_0xa >> 0xc & 1) == 0) {
            l2 = DVar9;
            c = CchGetString(idsPopulation4, (char *)szWork);
            TextOut(hdc, iVar4, yTop, szWork, c);
            DVar9 = l2;
        }
        l2 = DVar9;
        SelectObject(hdc, rghfontArial8[0]);
        SetRect(rgrcRef + 9, iVar4, yTop, xRight, yTop + dyArial8);
        uVar10 = __aFulmul(CONCAT22(sel.pl.rgwtMin[3]._2_2_, (undefined2)sel.pl.rgwtMin[3]), 100);
        c = CommaFormatLong((char *)szWork, uVar10);
        RightTextOut(hdc, xRight, yTop, (char *)szWork, c, dxRight);
        yTop = yTop + dyArial8;
        if ((ptile->wFlags_0xa >> 0xc & 1) == 0) {
            SelectObject(hdc, rghfontArial8[1]);
            c = CchGetString(idsResourcesYear, (char *)szWork);
            TextOut(hdc, iVar4, yTop, szWork, c);
            SelectObject(hdc, rghfontArial8[0]);
        }
        SetRect(rgrcRef + 8, iVar4, yTop, xRight, yTop + dyArial8);
        cResAvail = CResourcesAtPlanet(&sel.pl, idPlayer);
        cRes = cResAvail;
        uVar10 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), in_stack_0000ffb2);
        if ((uVar10 & 1) == 0) {
            sVar3 = MulDiv(cRes, (int)*(char *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0), 100);
            cResAvail = cResAvail - sVar3;
        }
        sVar3 = cRes;
        pcVar2 = PszGetCompressedString(idsDD);
        c = _wsprintf(szWork, pcVar2, cResAvail, sVar3);
        RightTextOut(hdc, xRight, yTop, (char *)szWork, c, dxRight);
        yTop = yTop + dyArial8;
        HVar5 = SelectObject(hdc, hbrButtonHilite);
        sVar3 = yTop;
        yTop = yTop + 1;
        PatBlt(hdc, rc.left, sVar3, rc.right - rc.left, 1, 0xf00021);
        SelectObject(hdc, HVar5);
        if ((ptile->wFlags_0xa >> 0xc & 1) == 0) {
            SelectObject(hdc, rghfontArial8[1]);
            c = CchGetString(idsScannerType, (char *)szWork);
            TextOut(hdc, iVar4, yTop, szWork, c);
            SelectObject(hdc, rghfontArial8[0]);
        }
        SetRect(rgrcRef + 0xb, iVar4, yTop, xRight, dyArial8 * 2 + yTop);
        sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv);
        if (sVar3 == raMacintosh) {
            CchGetString(idsOrganic, (char *)szWork);
            dRange = GetPlanetScannerRange(&sel.pl, &dRangeP);
        } else {
            uVar10 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), in_stack_0000ffb2);
            if (((uint)uVar10 & 0x1f) == 0x1f) {
                CchGetString(idsNone4, (char *)szWork);
                dRange = 0;
            } else {
                LookupBestPlanetaryScanner(&local_36);
                __fstrcpy(szWork, (char *)CONCAT22(local_36.u_PART_0x0004._2_2_, (local_36.u_PART_0x0004.parmor._0_2_)->szName));
                dRange = GetPlanetScannerRange(&sel.pl, &dRangeP);
            }
        }
        RightTextOut(hdc, xRight, yTop, (char *)szWork, 0, dxRight);
        yTop = yTop + dyArial8;
        if ((ptile->wFlags_0xa >> 0xc & 1) == 0) {
            SelectObject(hdc, rghfontArial8[1]);
            c = CchGetString(idsScannerRange, (char *)szWork);
            TextOut(hdc, iVar4, yTop, szWork, c);
            SelectObject(hdc, rghfontArial8[0]);
        }
        if (dRange < 1) {
            CchGetString(idsNone4, (char *)szWork);
            c = 0;
        } else if (dRangeP < 1) {
            if (dRange < 100) {
                pcVar2 = PszGetCompressedString(idsDLightYears);
                c = _wsprintf(szWork, pcVar2, dRange);
            } else {
                pcVar2 = PszGetCompressedString(idsDLY);
                c = _wsprintf(szWork, pcVar2, dRange);
            }
        } else {
            pcVar2 = PszGetCompressedString(idsDDLY);
            c = _wsprintf(szWork, pcVar2, dRangeP, dRange);
        }
        RightTextOut(hdc, xRight, yTop, (char *)szWork, c, dxRight);
        yTop = yTop + dyArial8;
        HVar5 = SelectObject(hdc, hbrButtonHilite);
        sVar3 = yTop;
        yTop = yTop + 1;
        PatBlt(hdc, rc.left, sVar3, rc.right - rc.left, 1, 0xf00021);
        SelectObject(hdc, HVar5);
        if ((ptile->wFlags_0xa >> 0xc & 1) == 0) {
            SelectObject(hdc, rghfontArial8[1]);
            c = CchGetString(idsDefenses4, (char *)szWork);
            TextOut(hdc, iVar4, yTop, szWork, c);
        }
        SelectObject(hdc, rghfontArial8[0]);
        SetRect(rgrcRef + 10, iVar4, yTop, xRight, dyArial8 * 3 + yTop);
        sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv);
        if (sVar3 == raMacintosh) {
            c = CchGetString(idsN, (char *)szWork);
        } else {
            sVar3 = CMaxOperableDefenses(&sel.pl, idPlayer, 0);
            uVar6 = sel.pl.rgbImp._4_2_ & 0xfff;
            pcVar2 = PszGetCompressedString(idsDD);
            c = _wsprintf(szWork, pcVar2, uVar6, sVar3);
        }
        RightTextOut(hdc, xRight, yTop, (char *)szWork, c, dxRight);
        yTop = yTop + dyArial8;
        if ((ptile->wFlags_0xa >> 0xc & 1) == 0) {
            SelectObject(hdc, rghfontArial8[1]);
            c = CchGetString(idsDefenseType, (char *)szWork);
            TextOut(hdc, iVar4, yTop, szWork, c);
            SelectObject(hdc, rghfontArial8[0]);
        }
        if ((sel.pl.rgbImp._4_2_ & 0xfff) == 0) {
            pcVar2 = (char *)szWork;
            sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv);
            if (sVar3 == raMacintosh) {
                SVar7 = idsN;
            } else {
                SVar7 = idsNone4;
            }
            CchGetString(SVar7, pcVar2);
            bVar1 = false;
        } else {
            FGetBestDefensePart(&local_36);
            __fstrcpy(szWork, (char *)CONCAT22(local_36.u_PART_0x0004._2_2_, (local_36.u_PART_0x0004.parmor._0_2_)->szName));
            bVar1 = true;
        }
        RightTextOut(hdc, xRight, yTop, (char *)szWork, 0, dxRight);
        yTop = yTop + dyArial8;
        if ((ptile->wFlags_0xa >> 0xc & 1) == 0) {
            SelectObject(hdc, rghfontArial8[1]);
            c = CchGetString(idsDefCoverage, (char *)szWork);
            TextOut(hdc, iVar4, yTop, szWork, c);
            SelectObject(hdc, rghfontArial8[0]);
        }
        if (bVar1) {
            CalcPctSurvive(&sel.pl, &pct, (float *)0x0);
            pct = fRam11201d22 - pct;
            local_36.hs.grhst = hstBomb | hstTorp | hstShield;
            local_36.hs.wFlags_0x2 = 0;
            __ftol((double)CONCAT26(in_stack_0000ffb4, CONCAT24(in_stack_0000ffb2, CONCAT22(unaff_SI, unaff_DI))));
            lVar11 = __ftol((double)CONCAT26(in_stack_0000ffb4, CONCAT24(in_stack_0000ffb2, CONCAT22(unaff_SI, unaff_DI))));
            lVar11 = __ftol((double)CONCAT26(100, CONCAT24(unaff_SI, CONCAT22(unaff_DI, (int)lVar11))));
            c = _wsprintf(szWork, PCTDXPCTDPCTPCT, (int)lVar11);
        } else {
            pcVar2 = (char *)szWork;
            sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv);
            if (sVar3 == raMacintosh) {
                SVar7 = idsN;
            } else {
                SVar7 = idsNone4;
            }
            c = CchGetString(SVar7, pcVar2);
        }
        RightTextOut(hdc, xRight, yTop, (char *)szWork, c, dxRight);
    }
    return;
}

// ======================================================================
// Function: FGetBestDefensePart
// Address: 1048:21f6
// Segment: MEMORY_PLANET
// ======================================================================

short FGetBestDefensePart(PART *ppart)

{
    bool  bVar1;
    short sVar2;
    PART  part;
    short i;
    short fRet;

    part.hs.grhst = hstPlanetary;
    part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | 9;
    i = 0;
    while ((i < 5 && (sVar2 = FLookupPart(&part), sVar2 == 1))) {
        i = i + 1;
        part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | part.hs.wFlags_0x2 + 1 & 0xff;
    }
    bVar1 = 0 < i;
    if (bVar1) {
        i = i + -1;
    }
    fRet = (short)bVar1;
    part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | i + 9U & 0xff;
    FLookupPart(&part);
    (ppart->hs).grhst = part.hs.grhst;
    (ppart->hs).wFlags_0x2 = part.hs.wFlags_0x2;
    *&(&ppart->u_PART_0x0004)->parmor = part.u_PART_0x0004.parmor._0_2_;
    *(undefined2 *)((int)&ppart->u_PART_0x0004 + 2) = part.u_PART_0x0004._2_2_;
    return fRet;
}

// ======================================================================
// Function: DrawPlanetStarbase
// Address: 1048:22cc
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x1048252c) */

void DrawPlanetStarbase(HDC hdc, TILE *ptile, OBJ obj)

{
    int        iVar1;
    int        iVar2;
    short      sVar3;
    int        iVar4;
    int        x;
    char      *pcVar5;
    HGDIOBJ    HVar6;
    short      sVar7;
    SHDEF     *pSVar8;
    int        iVar9;
    undefined2 unaff_SS;
    DWORD      DVar10;
    HULDEF    *pHVar11;
    long       lVar12;
    COLORREF   CVar13;
    ushort     uVar14;
    undefined2 uVar15;
    RECT       rc;
    long       l;
    HBRUSH     hbrSav;
    short      xLeft;
    char      *psz;
    ushort     w;
    COLORREF   crForeSav;
    SHDEF     *lpshdef;
    short      c;
    short      xRight;
    short      yTop;
    short      bt;
    short      iWarp;
    short      dxRight;
    short      fTwo;

    if ((ptile->wFlags_0xa >> 0xb & 1) != 0) {
        rgrcRef[0xd].top = -5;
        rgrcRef[0xd].bottom = -6;
        rgrcRef[0xe].top = -5;
        rgrcRef[0xe].bottom = -6;
        rgrcRef[0x10].top = -5;
        rgrcRef[0x10].bottom = -6;
        rgrcRef[0xf].top = -5;
        rgrcRef[0xf].bottom = -6;
        ptile->wFlags_0xa = ptile->wFlags_0xa & 0xf7ff;
    }
    if ((sel.pl.wFlags_0x4 >> 9 & 1) == 0) {
        psz = PszGetCompressedString(idsStarbase2);
    } else {
        uVar15 = *(undefined2 *)(idPlayer * 4 + rglpshdefSB_0x2);
        pSVar8 = (SHDEF *)(*(int *)(idPlayer * 4 + rglpshdefSB) + ((uint)sel.pl.lStarbase & 0xf) * 0x93);
        lpshdef = (SHDEF *)CONCAT22(uVar15, pSVar8);
        __fstrcpy(szWork, (char *)CONCAT22(uVar15, (pSVar8->hul).szClass));
        psz = (char *)szWork;
    }
    sVar3 = FDrawTileNC(hdc, ptile, &rc, psz);
    if (sVar3 != 0) {
        iVar4 = rc.left + 4;
        x = rc.right + -4;
        SetRect(&rc, rc.left + 2, rc.top, rc.right + -2, rc.bottom + -2);
        FillRect(hdc, &rc, hbrButtonFace);
        if ((sel.pl.wFlags_0x4 >> 9 & 1) == 0) {
            SetRect(rgrcRef + 0xe, -5, -5, -6, -6);
            rgrcRef[0xf].left = rgrcRef[0xe].left;
            rgrcRef[0xf].top = rgrcRef[0xe].top;
            rgrcRef[0xf].right = rgrcRef[0xe].right;
            rgrcRef[0xf].bottom = rgrcRef[0xe].bottom;
            rgrcRef[0x10].left = rgrcRef[0xe].left;
            rgrcRef[0x10].top = rgrcRef[0xe].top;
            rgrcRef[0x10].right = rgrcRef[0xe].right;
            rgrcRef[0x10].bottom = rgrcRef[0xe].bottom;
        } else {
            SetRect(rgrcRef + 0xe, iVar4, rc.top, x, dyArial8 * 4 + rc.top);
            SelectObject(hdc, rghfontArial8[1]);
            sVar3 = CchGetString(idsDockCapacity, (char *)szWork);
            DVar10 = GetTextExtent(hdc, szWork, sVar3);
            iVar9 = (x - iVar4) - (int)DVar10;
            TextOut(hdc, iVar4, rc.top, szWork, sVar3);
            SelectObject(hdc, rghfontArial8[0]);
            pHVar11 = LphuldefFromId((lpshdef->hul).ihuldef);
            uVar14 = (((HULDEF *)pHVar11)->hul).wtCargoMax;
            if (uVar14 == 0) {
                c = CchGetString(idsNone4, (char *)szWork);
            } else if (uVar14 == 0xffff) {
                c = CchGetString(idsUnlimited, (char *)szWork);
            } else {
                c = _wsprintf(szWork, PCTDKT, uVar14);
            }
            RightTextOut(hdc, x, rc.top, (char *)szWork, c, iVar9);
            iVar1 = rc.top + dyArial8;
            SelectObject(hdc, rghfontArial8[1]);
            sVar3 = CchGetString(idsArmor2, (char *)szWork);
            TextOut(hdc, iVar4, iVar1, szWork, sVar3);
            uVar14 = (((SHDEF *)lpshdef)->hul).dp;
            if (uVar14 == 0) {
                c = CchGetString(idsNone4, (char *)szWork);
            } else {
                uVar15 = 0;
                pcVar5 = PszGetCompressedString(idsLddp);
                c = _wsprintf(szWork, pcVar5, uVar14, uVar15);
            }
            SelectObject(hdc, rghfontArial8[0]);
            RightTextOut(hdc, x, iVar1, (char *)szWork, c, iVar9);
            iVar1 = iVar1 + dyArial8;
            SelectObject(hdc, rghfontArial8[1]);
            sVar3 = CchGetString(idsShields2, (char *)szWork);
            TextOut(hdc, iVar4, iVar1, szWork, sVar3);
            lVar12 = DpShieldOfShdef(lpshdef, idPlayer);
            if (lVar12 == 0) {
                c = CchGetString(idsNone4, (char *)szWork);
            } else {
                pcVar5 = PszGetCompressedString(idsLddp);
                c = _wsprintf(szWork, pcVar5, (int)lVar12, (int)((ulong)lVar12 >> 0x10));
            }
            SelectObject(hdc, rghfontArial8[0]);
            RightTextOut(hdc, x, iVar1, (char *)szWork, c, iVar9);
            iVar1 = iVar1 + dyArial8;
            SelectObject(hdc, rghfontArial8[1]);
            sVar3 = CchGetString(idsDamage2, (char *)szWork);
            TextOut(hdc, iVar4, iVar1, szWork, sVar3);
            SelectObject(hdc, rghfontArial8[0]);
            w = (uint)sel.pl.lStarbase >> 4;
            if (w == 0) {
                c = CchGetString(idsNone4, (char *)szWork);
                CVar13 = CONCAT22(crForeSav._2_2_, (undefined2)crForeSav);
            } else {
                if (w < 5) {
                    w = 5;
                }
                c = _wsprintf(szWork, PCTDPCTPCT, w / 5);
                CVar13 = SetTextColor(hdc, 0x7f);
            }
            RightTextOut(hdc, x, iVar1, (char *)szWork, c, iVar9);
            iVar1 = iVar1 + dyArial8;
            if (w != 0) {
                SetTextColor(hdc, CVar13);
            }
            HVar6 = SelectObject(hdc, hbrButtonHilite);
            iVar2 = iVar1 + 1;
            PatBlt(hdc, rc.left, iVar1, rc.right - rc.left, 1, 0xf00021);
            SelectObject(hdc, HVar6);
            SelectObject(hdc, rghfontArial8[1]);
            SetRect(rgrcRef + 0x10, iVar4, iVar2, x, iVar2 + dyArial8);
            sVar3 = CchGetString(idsMassDriver, (char *)szWork);
            TextOut(hdc, iVar4, iVar2, szWork, sVar3);
            sVar3 = IWarpMAFromLppl(&sel.pl, &fTwo);
            if (sVar3 < 1) {
                pcVar5 = PszGetCompressedString(idsNone4);
                c = _wsprintf(szWork, pcVar5);
            } else {
                sVar7 = sVar3;
                pcVar5 = PszGetCompressedString(idsWarpD);
                c = _wsprintf(szWork, pcVar5, sVar7);
                if (fTwo != 0) {
                    ((char *)szWork)[c] = '+';
                    c = c + 1;
                }
            }
            SelectObject(hdc, rghfontArial8[0]);
            RightTextOut(hdc, x, iVar2, (char *)szWork, c, iVar9);
            iVar2 = iVar2 + dyArial8;
            SelectObject(hdc, rghfontArial8[1]);
            sVar7 = CchGetString(idsDestination3, (char *)szWork);
            TextOut(hdc, iVar4, iVar2, szWork, sVar7);
            if ((sel.pl.lStarbase._2_2_ & 0x3ff) == 0) {
                c = CchGetString(idsNone4, (char *)szWork);
            } else {
                pcVar5 = PszGetCompressedPlanet(((short *)rgidPlan)[(sel.pl.lStarbase._2_2_ & 0x3ff) - 1]);
                c = 0;
                _strcpy((char *)szWork, pcVar5);
            }
            SelectObject(hdc, rghfontArial8[0]);
            RightTextOut(hdc, x, iVar2, (char *)szWork, c, iVar9);
            iVar2 = iVar2 + dyArial8;
            iVar9 = (x - iVar4) / 3;
            SetRect(rgrcRef + 0xd, iVar4, iVar2, iVar4 + iVar9, iVar2 + dyArial8 + 6);
            bt = 8;
            if (sVar3 == 0) {
                bt = 0xc;
            }
            pcVar5 = PszGetCompressedString(idsSetDest);
            DrawBtn(hdc, (RECT *)(rgrcRef + 0xd), bt, gd.grBits._2_2_ >> 8 & 1, pcVar5);
            if (sVar3 < 1) {
                SetRect(rgrcRef + 0xf, -5, -5, -6, -6);
                rgrcRef[0x10].left = rgrcRef[0xf].left;
                rgrcRef[0x10].top = rgrcRef[0xf].top;
                rgrcRef[0x10].right = rgrcRef[0xf].right;
                rgrcRef[0x10].bottom = rgrcRef[0xf].bottom;
            } else {
                SetRect(rgrcRef + 0xf, iVar4 + iVar9 + 4, iVar2 + 3, x, iVar2 + dyArial8 + 3);
                if (fTwo != 0) {
                    sVar3 = -sVar3;
                }
                DrawMassWarpGauge(hdc, (RECT *)(rgrcRef + 0xf), sVar3, (sel.pl.lStarbase._2_2_ >> 10 & 0xf) + 4);
            }
        }
    }
    return;
}

// ======================================================================
// Function: DrawMassWarpGauge
// Address: 1048:2afa
// Segment: MEMORY_PLANET
// ======================================================================

void DrawMassWarpGauge(HDC hdc, RECT *prc, short iBest, short iCur)

{
    char  *pcVar1;
    long   lVar2;
    long   l;
    long   lCur;
    HBRUSH hbr;
    short  iMode;
    short  fTwoMAs;
    short  c;
    long   lMax;

    fTwoMAs = (short)(iBest < 0);
    SelectObject(hdc, rghfontArial8[1]);
    if (iCur < 5) {
        iCur = 5;
    }
    if (iBest < 0) {
        iBest = -iBest;
    }
    lMax._0_2_ = iBest + -1;
    lMax._2_2_ = (int)lMax >> 0xf;
    if (iBest + fTwoMAs < iCur) {
        if (iCur < iBest + fTwoMAs + 3) {
            hbr = hbrYellow;
        } else {
            hbr = hbrRed;
        }
    } else {
        hbr = hbrPurple;
    }
    lCur._0_2_ = iCur + -4;
    lCur._2_2_ = (int)lCur >> 0xf;
    lVar2 = LDrawGauge(hdc, prc, 1, &lCur, &hbr, (long)(int)lMax);
    iMode = SetBkMode(hdc, 1);
    lVar2 = lVar2 + 4;
    pcVar1 = PszGetCompressedString(idsWarpLd);
    c = _wsprintf(szWork, pcVar1, (int)lVar2, (int)((ulong)lVar2 >> 0x10));
    GetTextExtent(hdc, szWork, c);
    RcCtrTextOut(hdc, prc, (char *)szWork, c);
    SetBkMode(hdc, iMode);
    return;
}

// ======================================================================
// Function: DrawPlanetProduction
// Address: 1048:2c38
// Segment: MEMORY_PLANET
// ======================================================================

// Decompilation failed: Exception while decompiling 1048:2c38: Decompiler process died

// ======================================================================
// Function: PszProductionETA
// Address: 1048:310c
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x104831ef) */
/* WARNING: Removing unreachable block (ram,0x104831f4) */
/* WARNING: Removing unreachable block (ram,0x104831bc) */
/* WARNING: Variable defined which should be unmapped: ids */

char *PszProductionETA(PLANET *lppl, PLPROD *lpplprod, short iItem, short *etaFirst, short *etaLast)

{
    short      sVar1;
    char      *pcVar2;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    ulong      uVar3;
    ulong      uVar4;
    short      sVar5;
    short      ids;
    short      c;
    short      iTurnBegin;
    short      iTurnEnd;

    uVar4 = CONCAT22(unaff_SI, unaff_DI);
    if (((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) {
        /* WARNING: Load size is inaccurate */
        lpplprod = (PLPROD *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2), ((PLANET *)lppl)->lpplprod);
    }
    EstimateItemProdSched(lppl, lpplprod, iItem, &iTurnBegin, &iTurnEnd);
    if (iTurnBegin == 100) {
        if (((((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) || ((int)(uint)((PLPROD *)lpplprod)->iprodMac <= iItem)) ||
            ((uVar3 = __aFulshr(uVar4, ids), ((uint)uVar3 & 7) != 1 || (uVar4 = __aFulshr(uVar4, ids), 6 < ((uint)uVar4 & 0x7f))))) {
            ids = 0x332;
        } else {
            ids = 0x254;
        }
        CchGetString(ids, (char *)szWork);
    } else if (iTurnEnd == 100) {
        sVar1 = iTurnBegin;
        pcVar2 = PszGetCompressedString(idsDYears);
        _wsprintf(szWork, pcVar2, sVar1);
    } else if (iTurnBegin == iTurnEnd) {
        if (iTurnBegin == 0) {
            CchGetString(idsSkipped, (char *)szWork);
        } else if (iTurnBegin == -1) {
            CchGetString(idsNeeded, (char *)szWork);
        } else {
            sVar1 = iTurnBegin;
            pcVar2 = PszGetCompressedString(idsDYear);
            sVar1 = _wsprintf(szWork, pcVar2, sVar1);
            if (iTurnBegin != 1) {
                ((char *)szWork)[sVar1] = 's';
                ((char *)szWork + 1)[sVar1] = '\0';
            }
        }
    } else {
        sVar1 = iTurnBegin;
        sVar5 = iTurnEnd;
        pcVar2 = PszGetCompressedString(idsDDYears);
        _wsprintf(szWork, pcVar2, sVar1, sVar5);
    }
    if (etaFirst != (short *)0x0) {
        *etaFirst = iTurnBegin;
    }
    if (etaLast != (short *)0x0) {
        *etaLast = iTurnEnd;
    }
    return (char *)szWork;
}

// ======================================================================
// Function: DrawPlanShipBitmap
// Address: 1048:3336
// Segment: MEMORY_PLANET
// ======================================================================

void DrawPlanShipBitmap(HDC hdc, TILE *ptile, OBJ obj)

{
    short   sVar1;
    int     iVar2;
    int     iVar3;
    HGDIOBJ HVar4;
    int     iVar5;
    RECT    rc;
    short   iOffset;
    HBRUSH  hbrSav;
    short   xLeft;
    short   dx;
    char   *psz;
    short   i;
    short   xRight;
    short   dy;
    short   yTop;

    if (sel.grobj == grobjPlanet) {
        psz = PszGetPlanetName(*(short *)obj.u_OBJ_0x0000);
        iOffset = (*(int *)obj.u_OBJ_0x0000 + 8) % 0x1c;
    } else {
        psz = PszGetFleetName(*(short *)obj.u_OBJ_0x0000);
    }
    if ((ptile->wFlags_0xa >> 0xb & 1) != 0) {
        for (i = 4; i < 7; i = i + 1) {
            ShowWindow(((ushort *)rghwndBtn)[i], 0);
        }
        ptile->wFlags_0xa = ptile->wFlags_0xa & 0xf7ff;
    }
    sVar1 = FDrawTileNC(hdc, ptile, &rc, psz);
    if (sVar1 == 0) {
        for (i = 4; i < 7; i = i + 1) {
            ShowWindow(((ushort *)rghwndBtn)[i], 0);
        }
    } else {
        iVar2 = rc.left + 0xc;
        if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
            iVar3 = 6;
        } else {
            iVar3 = 2;
        }
        iVar3 = iVar3 + rc.top;
        if (sel.grobj == grobjFleet) {
            DrawFleetBitmap(&sel.fl, hdc, iVar2, iVar3, 1, -1, 0, 0, -1, 0);
        } else {
            HVar4 = SelectObject(hdc, hbrButtonShadow);
            PatBlt(hdc, iVar2, iVar3, 0x46, 2, 0xf00021);
            PatBlt(hdc, iVar2, iVar3 + 2, 2, 0x44, 0xf00021);
            SelectObject(hdc, hbrButtonHilite);
            PatBlt(hdc, rc.left + 0xe, iVar3 + 0x44, 0x44, 2, 0xf00021);
            PatBlt(hdc, rc.left + 0x50, iVar3 + 2, 2, 0x42, 0xf00021);
            PatBlt(hdc, rc.left + 0xd, iVar3 + 0x45, 1, 1, 0xf00021);
            PatBlt(hdc, rc.left + 0x51, iVar3 + 1, 1, 1, 0xf00021);
            PatBlt(hdc, rc.left + 0xe, iVar3 + 2, 0x42, 1, 0x42);
            PatBlt(hdc, rc.left + 0xe, iVar3 + 3, 1, 0x41, 0x42);
            PatBlt(hdc, rc.left + 0xf, iVar3 + 0x43, 0x41, 1, 0x42);
            PatBlt(hdc, rc.left + 0x4f, iVar3 + 3, 1, 0x40, 0x42);
            SelectObject(hdc, HVar4);
            SelectPalette(hdc, vhpal, 0);
            RealizePalette(hdc);
            DibBlt(hdc, rc.left + 0xf, iVar3 + 3, 0x40, 0x40, hdibPlanets, iOffset % 7 << 6, iOffset / 7 << 6, 0x40, 0x40, 0xcc0020);
        }
        iVar2 = ((rc.right + -0xc) - iVar2) + -0x5f;
        dy = dyArial8 * 3 >> 1;
        if ((ptile->wFlags_0xa >> 0xc & 1) == 0) {
            if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
                yTop = iVar3 + -4;
            } else {
                yTop = iVar3 + -2;
                dy = dy + -2;
            }
            if (sel.grobj == grobjFleet) {
                iVar3 = 6;
            } else {
                iVar3 = 5;
            }
            i = 4;
            while (i <= iVar3) {
                SetWindowPos(((ushort *)rghwndBtn)[i], 0, (rc.right + -0xc) - iVar2, yTop, iVar2, dy, 0x14);
                ShowWindow(((ushort *)rghwndBtn)[i], 5);
                i = i + 1;
                if ((gd.grBits._2_2_ >> 3 & 1) == 0) {
                    iVar5 = 3;
                } else {
                    iVar5 = 2;
                }
                yTop = yTop + iVar5 + dy;
            }
        }
    }
    return;
}

// ======================================================================
// Function: DrawPlanetShipList
// Address: 1048:377e
// Segment: MEMORY_PLANET
// ======================================================================

// Decompilation failed: Exception while decompiling 1048:377e: Decompiler process died

// ======================================================================
// Function: SetPlanetTitleBar
// Address: 1048:3dec
// Segment: MEMORY_PLANET
// ======================================================================

void SetPlanetTitleBar(HWND hwnd)

{
    char      *pcVar1;
    undefined2 unaff_SS;
    char      *psz;
    char       szTitle[30];

    if (sel.grobj == grobjPlanet) {
        pcVar1 = PszGetPlanetName(sel.pl.id);
        CchGetString(idsPlanet2, szTitle);
        lstrcat(szTitle, pcVar1);
        psz = szTitle;
    } else if (sel.grobj == grobjFleet) {
        psz = PszGetFleetName(sel.fl.id);
    } else {
        psz = PszGetCompressedString(idsPlanetView);
    }
    SetWindowText(hwnd, psz);
    return;
}

// ======================================================================
// Function: ChangeMainObjSel
// Address: 1048:3e7a
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

void ChangeMainObjSel(short grobjNew, short iObjSel)

{
    FLEET     *pFVar1;
    int        iVar2;
    short      sVar3;
    FLEET    **ppFVar4;
    undefined2 uVar5;
    undefined2 unaff_SS;
    FLEET     *lpfl;
    short      i;
    short      idSkip;
    short      fSameType;

    idSkip = -1;
    fSameType = (short)(grobjNew == sel.grobj);
    if (((fAi == 0) || (fSameType == 0)) || (iObjSel != sel.id)) {
        InvalidateReport((uint)(sel.grobj != grobjPlanet), 0);
        if (grobjNew == 1) {
            InvalidateReport(0, 0);
            sVar3 = FLookupPlanet(iObjSel, (PLANET *)&sel.pl);
            if (sVar3 == 0) {
                return;
            }
            sel.pt.x = ((POINT *)rgptPlan + iObjSel)->x;
            sel.pt.y = *(short *)((int)&rgptPlan[0].y + iObjSel * 4);
            sel.scan.iwp = -1;
            sel.iwpAct = -1;
            for (i = 0; i < cFleet; i = i + 1) {
                /* WARNING: Load size is inaccurate */
                pFVar1 = ((FLEET **)rglpfl)[i];
                iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                lpfl = (FLEET *)CONCAT22(iVar2, pFVar1);
                if (((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) || ((pFVar1->idPlanet == iObjSel && (pFVar1->iPlayer == idPlayer))))
                    break;
            }
            if (i == cFleet) {
                sel.fl.id = -1;
                sel.grobjFull = grobjPlanet;
            } else {
                FDupFleet(lpfl, (FLEET *)&sel.fl);
                sel.grobjFull = grobjFleet | grobjPlanet;
            }
            if (fAi == 0) {
                FillPlanetProdLB(0, (PLPROD *)0x0, (PLANET *)0x0);
                SendMessage(hwndPlanetProdLB, CB_GETCURSEL, 0, 0);
            }
        } else {
            InvalidateReport(1, 0);
            sVar3 = FLookupFleet(iObjSel, (FLEET *)&sel.fl);
            if (sVar3 == 0) {
                return;
            }
            sel.pt.x = sel.fl.pt.x;
            sel.pt.y = sel.fl.pt.y;
            if ((sel.fl.idPlanet == -1) || ((sel.fl.idPlanet != sel.pl.id && (sVar3 = FLookupPlanet(sel.fl.idPlanet, (PLANET *)&sel.pl), sVar3 == 0)))) {
                sel.pl.id = -1;
            }
            sel.grobjFull = sel.pl.id != -1 | grobjFleet;
            sel.iwpAct = 0;
            if (fAi == 0) {
                FillOrdersLB();
                FillFleetCompLB();
                FillBattleDD(sel.fl.iplan + 1);
                idSkip = iObjSel;
                SendMessage(rghwndOrderDD[0], CB_SETCURSEL, *(WParamMessageId *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xf, 0);
            }
        }
        sel.grobj = grobjNew;
        sel.id = iObjSel;
        gd.grBits._2_2_ = gd.grBits._2_2_ & 0xdeff;
        if (fAi == 0) {
            if (fSameType == 0) {
                for (i = 0; i < 0xd; i = i + 1) {
                    ShowWindow(((ushort *)rghwndBtn)[i], 0);
                }
                for (i = 0; i < 3; i = i + 1) {
                    ShowWindow(((ushort *)rghwndOrderDD)[i], 0);
                }
                ShowWindow(hwndOrderED, 0);
                ShowWindow(hwndShipDD, 0);
                ShowWindow(hwndBattleDD, 0);
                ShowWindow(hwndShipLB, 0);
                ShowWindow(hwndFleetCompLB, 0);
                ShowWindow(hwndPlanetProdLB, 0);
                ShowWindow(hwndRepCB, 0);
                for (i = 0; i < 0x13; i = i + 1) {
                    *(undefined2 *)((int)&rgrcRef[0].bottom + i * 8) = 0xfffa;
                    *(undefined2 *)((int)&rgrcRef[0].top + i * 8) = 0xfffb;
                }
            }
            FillShipDD(idSkip);
            if (fSameType == 0) {
                uVar5 = 0x14f8;
                InvalidateRect(hwndPlanet, (RECT *)0x0, 1);
                ppFVar4 = &stack0xfff0;
                if (((grbitScan & 0x10) != 0) && (ppFVar4 = &stack0xfff0, sel.grobj == grobjPlanet)) {
                    grbitScan = grbitScan & 0xffef;
                    uVar5 = 0x14f8;
                    InvalidateRect(hwndTb, (RECT *)0x0, 1);
                    ppFVar4 = &lpfl;
                }
            } else {
                uVar5 = 0x1048;
                DrawPlanShip(0, 0x4fff);
                ppFVar4 = &stack0xffee;
            }
            *(HWND *)((int)ppFVar4 + -2) = hwndPlanet;
            *(undefined2 *)((int)ppFVar4 + -4) = uVar5;
            *(undefined2 *)((int)ppFVar4 + -6) = 0x427e;
            SetPlanetTitleBar(*(HWND *)((int)ppFVar4 + -2));
            if (((uint)gd.grBits >> 0xb & 1) != 0) {
                *(undefined2 *)((int)ppFVar4 + -2) = 0x1048;
                *(undefined2 *)((int)ppFVar4 + -4) = 0x4299;
                AdvanceTutor();
            }
        }
    }
    return;
}

// ======================================================================
// Function: FillShipDD
// Address: 1048:42a0
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

void FillShipDD(short idSkip)

{
    FLEET     *pFVar1;
    int        iVar2;
    THING     *pTVar3;
    undefined2 uVar4;
    POINT      ptSel;
    FLEET     *lpfl;
    THING     *lpth;
    short      i;
    THING     *lpthMac;

    SendMessage(hwndShipDD, CB_RESETCONTENT, 0, 0);
    if (sel.grobj == grobjPlanet) {
        ptSel.x = ((POINT *)rgptPlan + sel.id)->x;
        ptSel.y = *(short *)((int)&rgptPlan[0].y + sel.id * 4);
    } else {
        ptSel.x = sel.fl.pt.x;
        ptSel.y = sel.fl.pt.y;
    }
    for (i = 0; i < cFleet; i = i + 1) {
        /* WARNING: Load size is inaccurate */
        pFVar1 = ((FLEET **)rglpfl)[i];
        iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar2, pFVar1);
        if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0))
            break;
        if (((idSkip == -1) && (sel.id == pFVar1->idPlanet)) ||
            (((idSkip != -1 && ((lpfl->id != idSkip && ((&pFVar1->pt)->x == sel.fl.pt.x)))) && ((pFVar1->pt).y == sel.fl.pt.y)))) {
            PszGetFleetName(lpfl->id);
            _memmove((char *)szWork + 1, (char *)szWork, 0x32);
            if (pFVar1->iPlayer == idPlayer) {
                szWork[0] = ' ';
            } else {
                szWork[0] = 'x';
            }
            SendMessage(hwndShipDD, CB_ADDSTRING, 0, 0x112057a4);
        }
    }
    pTVar3 = (THING *)lpThings + cThing;
    lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
    while ((THING *)lpth < pTVar3) {
        uVar4 = (undefined2)((ulong)lpth >> 0x10);
        if (((lpth->idFull >> 0xd == 1) && ((&((THING *)lpth)->pt)->x == ptSel.x)) && ((((THING *)lpth)->pt).y == ptSel.y)) {
            PszGetThingName(lpth->idFull);
            _memmove((char *)szWork + 1, (char *)szWork, 0x32);
            if ((lpth->idFull >> 9 & 0xf) == idPlayer) {
                szWork[0] = ' ';
            } else {
                szWork[0] = 'x';
            }
            SendMessage(hwndShipDD, CB_ADDSTRING, 0, 0x112057a4);
        }
        lpth = (THING *)CONCAT22(uVar4, (THING *)lpth + 1);
    }
    SendMessage(hwndShipDD, CB_SETCURSEL, 0, 0);
    return;
}

// ======================================================================
// Function: SelectAdjPlanet
// Address: 1048:44da
// Segment: MEMORY_PLANET
// ======================================================================

void SelectAdjPlanet(short dInc, short idPlanet)

{
    POINT   pt;
    short   fWrap;
    SCAN    scan;
    PLANET *lpPl;
    short   i;
    PLANET *lpPlT;

    if ((0 < cPlanet) && (idPlanet != -1)) {
        if (dInc != 0) {
            idPlanet = sel.pl.id;
        }
        if (vrptPlanet.fCached == 0) {
            InvalidateReport(0, 1);
        }
        lpPl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
        i = 0;
        while (true) {
            if ((cPlanet <= i) || (lpPl->id == idPlanet))
                break;
            i = i + 1;
            lpPl = (PLANET *)lpPl + 1;
        }
        if ((i == cPlanet) || ((((PLANET *)lpPl)->wFlags_0x4 & 0xff) != 7)) {
            scan.pt.x = ((POINT *)rgptPlan + idPlanet)->x;
            scan.pt.y = *(short *)((int)&rgptPlan[0].y + idPlanet * 4);
            scan.grobj = 0x81;
            ChangeScanSel(&scan, 0);
        } else {
            if (dInc != 0) {
                i = 0;
                while ((i < *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) && (((PLANET *)lpPlanets + ((ushort *)vlprgidPlanet)[i])->id != idPlanet))) {
                    i = i + 1;
                }
                i = i + dInc;
                if (i < *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0)) {
                    if (i < 0) {
                        i = *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) + -1;
                    }
                } else {
                    i = 0;
                }
                i = ((ushort *)vlprgidPlanet)[i];
            }
            lpPlT = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets + i);
            idPlanet = lpPlT->id;
            if (((PLANET *)lpPlanets)[i].iPlayer != idPlayer) {
                return;
            }
            scan.pt.x = ((POINT *)rgptPlan + idPlanet)->x;
            scan.pt.y = *(short *)((int)&rgptPlan[0].y + idPlanet * 4);
            scan.grobj = 0x81;
            ChangeScanSel(&scan, 0);
            RedrawScanSel(0, 0);
            ChangeMainObjSel(1, idPlanet);
            RedrawScanSel(0, 1);
        }
        pt.y = *(short *)((int)&rgptPlan[0].y + idPlanet * 4);
        pt.x = ((POINT *)rgptPlan + idPlanet)->x;
        CtrPointScan(pt, 1);
        DrawScannerSBar(0, (RECT *)0x0, (SBAR *)0x0, 0);
        InvalidateRect(hwndMine, (RECT *)0x0, 1);
        SetMineralTitleBar(hwndMine);
    }
    return;
}

// ======================================================================
// Function: IdFindAdjStarbase
// Address: 1048:474e
// Segment: MEMORY_PLANET
// ======================================================================

short IdFindAdjStarbase(short idPlanet, short fNext)

{
    PLANET    *pPVar1;
    undefined2 uVar2;
    HULDEF    *pHVar3;
    short      idBefore;
    short      idAfter;
    PLANET    *lppl;
    short      idFirst;
    short      idLast;
    PLANET    *lpplMac;

    idLast = -1;
    idFirst = -1;
    idAfter = -1;
    idBefore = -1;
    pPVar1 = (PLANET *)lpPlanets + cPlanet;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
    while ((PLANET *)lppl < pPVar1) {
        uVar2 = (undefined2)((ulong)lppl >> 0x10);
        if (((((PLANET *)lppl)->iPlayer == idPlayer) && ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0)) &&
            (pHVar3 = LphuldefFromId(*(HullDef *)(*(int *)(idPlayer * 4 + rglpshdefSB) + (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93)),
             (((HULDEF *)pHVar3)->hul).wtCargoMax != 0)) {
            if (idPlanet < lppl->id) {
                if (idAfter == -1) {
                    idAfter = lppl->id;
                }
            } else if (lppl->id < idPlanet) {
                idBefore = lppl->id;
            }
            if (idFirst == -1) {
                idFirst = lppl->id;
            }
            idLast = lppl->id;
        }
        lppl = (PLANET *)CONCAT22(uVar2, (PLANET *)lppl + 1);
    }
    if (fNext == 0) {
        idFirst = idLast;
        if (idBefore != -1) {
            idFirst = idBefore;
        }
    } else if (idAfter != -1) {
        idFirst = idAfter;
    }
    return idFirst;
}

// ======================================================================
// Function: PlanetClick
// Address: 1048:489e
// Segment: MEMORY_PLANET
// ======================================================================

void PlanetClick(short x, short y, short sks, short fRightBtn)

{
    TILE      *pTVar1;
    short     *psVar2;
    POINT      pt_00;
    POINT      pt_01;
    POINT      PVar3;
    POINT      PVar4;
    uint       uVar5;
    int        iVar6;
    BOOL       BVar7;
    short      sVar8;
    short      sVar9;
    uint       iCol_00;
    TILE      *pTVar10;
    short     *psVar11;
    undefined2 unaff_SS;
    undefined1 local_40[4];
    short      local_3c;
    short      local_3a[5];
    char      *local_30;
    uint       local_2a;
    RECT       rc;
    TILE      *prgtile;
    short      iCur;
    ushort     iCol;
    short      xRel;
    short      i;
    RECT       rcTitle;
    short      dy;
    short      ctile;
    POINT      pt;
    short      bt;

    if (sel.grobj == grobjPlanet) {
        prgtile = (TILE *)&rgtilePlanet;
        ctile = 6;
    } else {
        if (sel.grobj != grobjFleet) {
            return;
        }
        prgtile = (TILE *)&rgtileShip;
        ctile = 7;
    }
    uVar5 = (uint)x / 0xc6;
    if ((3 < (uint)x % 0xc6) && ((uint)x % 0xc6 < 0xc2)) {
        for (i = 0; sVar8 = i, i < ctile; i = i + 1) {
            if (uVar5 <= (prgtile[i].wFlags_0xa & 7)) {
                if (uVar5 < (prgtile[i].wFlags_0xa & 7)) {
                    return;
                }
                if ((prgtile + i)->yTop <= y) {
                    if ((prgtile[i].wFlags_0xa >> 7 & 1) == 0) {
                        iVar6 = dyArial8 + 3;
                    } else {
                        iVar6 = prgtile[i].dyFull;
                    }
                    if (y < iVar6 + (prgtile + i)->yTop)
                        break;
                }
            }
        }
        if (i != ctile) {
            pt.x = x;
            pt.y = y;
            rcTitle.top = (prgtile + i)->yTop;
            rcTitle.bottom = dyArial8 + rcTitle.top + 4;
            rcTitle.left = uVar5 * 0xc6 + 4;
            rcTitle.right = uVar5 * 0xc6 + 0xc3;
            PVar3.y = y;
            PVar3.x = x;
            BVar7 = PtInRect(&rcTitle, PVar3);
            if ((BVar7 == 0) || (fRightBtn != 0)) {
                if (((sel.grobj == grobjFleet) &&
                     ((((prgtile[i].grbit == 0x20 || (prgtile[i].grbit == 0x100)) || (prgtile[i].grbit == 1)) || (prgtile[i].grbit == 0x10)))) ||
                    (prgtile[i].grbit == 4)) {
                    pt_00.y = y;
                    pt_00.x = x;
                    ClickInShipOrders(pt_00, sks, 0, fRightBtn);
                } else if ((sel.grobj == grobjPlanet) &&
                           (((prgtile[i].grbit == 1 || (prgtile[i].grbit == 0x100)) || ((prgtile[i].grbit == 0x40 || (prgtile[i].grbit == 8)))))) {
                    pt_01.y = y;
                    pt_01.x = x;
                    ClickInPlanetOrders(pt_01, sks, 0, fRightBtn);
                }
            } else {
                rc.right = rcTitle.right;
                rc.bottom = rcTitle.bottom;
                rc.top = rcTitle.top + 1;
                rc.left = rcTitle.right + -0x11;
                PVar4.y = y;
                PVar4.x = x;
                BVar7 = PtInRect(&rc, PVar4);
                if (BVar7 == 0) {
                    if ((prgtile[i].wFlags_0xa >> 7 & 1) != 0) {
                        rcTitle.bottom = rcTitle.top + prgtile[i].dyFull + 1;
                    }
                    local_2a = GetDC(hwndPlanet);
                    DrawFuzzyBorder(local_2a, &rcTitle);
                    SetCapture(hwndPlanet);
                    local_40._2_2_ = x;
                    local_3c = y;
                    while (sVar9 = FGetMouseMove(local_40 + 2), sVar9 != 0) {
                        if ((pt.x != local_40._2_2_) || (pt.y != local_3c)) {
                            DrawFuzzyBorder(local_2a, &rcTitle);
                            OffsetRc(&rcTitle, local_40._2_2_ - pt.x, local_3c - pt.y);
                            pt.x = local_40._2_2_;
                            pt.y = local_3c;
                            DrawFuzzyBorder(local_2a, &rcTitle);
                        }
                    }
                    DrawFuzzyBorder(local_2a, &rcTitle);
                    ReleaseCapture();
                    ReleaseDC(hwndPlanet, local_2a);
                    iVar6 = (rcTitle.right - rcTitle.left >> 1) + rcTitle.left;
                    if (iVar6 / 0xc6 < 2) {
                        uVar5 = iVar6 / 0xc6;
                    } else {
                        uVar5 = 1;
                    }
                    if (uVar5 < 0x8000) {
                        if (iVar6 / 0xc6 < 2) {
                            uVar5 = iVar6 / 0xc6;
                        } else {
                            uVar5 = 1;
                        }
                    } else {
                        uVar5 = 0;
                    }
                    iCur = i;
                    i = 0;
                    while ((i < ctile && ((prgtile[i].wFlags_0xa & 7) < uVar5))) {
                        i = i + 1;
                    }
                    while ((i < ctile && ((prgtile[i].wFlags_0xa & 7) == uVar5))) {
                        if ((prgtile[i].wFlags_0xa >> 7 & 1) == 0) {
                            iVar6 = dyArial8 + 3;
                        } else {
                            iVar6 = prgtile[i].dyFull;
                        }
                        if ((rcTitle.bottom - rcTitle.top >> 1) + rcTitle.top < (iVar6 >> 1) + (prgtile + i)->yTop)
                            break;
                        i = i + 1;
                    }
                    if ((i == sVar8) || (i == sVar8 + 1)) {
                        iCol_00 = prgtile[sVar8].wFlags_0xa & 7;
                        if (uVar5 != iCol_00) {
                            prgtile[sVar8].wFlags_0xa = prgtile[sVar8].wFlags_0xa & 0xfff8 | uVar5 & 7;
                            ReflowColumn(uVar5, sVar8, 1);
                            if ((int)uVar5 < (int)iCol_00) {
                                ReflowColumn(iCol_00, sVar8 + 1, 1);
                            } else {
                                ReflowColumn(iCol_00, sVar8, 1);
                            }
                        }
                    } else {
                        pTVar10 = prgtile + sVar8;
                        psVar11 = local_3a;
                        for (iVar6 = 8; iVar6 != 0; iVar6 = iVar6 + -1) {
                            psVar2 = psVar11;
                            psVar11 = psVar11 + 1;
                            pTVar1 = pTVar10;
                            pTVar10 = &pTVar10->dyFull;
                            *psVar2 = pTVar1->yTop;
                        }
                        if (i < sVar8) {
                            _memmove(prgtile + i + 1, prgtile + i, (sVar8 - i) * 0x10);
                            iCur = sVar8 + 1;
                        } else {
                            _memmove(prgtile + sVar8, prgtile + sVar8 + 1, ((i - sVar8) + -1) * 0x10);
                            i = i + -1;
                        }
                        pTVar10 = prgtile + i;
                        psVar11 = local_3a;
                        for (iVar6 = 8; iVar6 != 0; iVar6 = iVar6 + -1) {
                            pTVar1 = pTVar10;
                            pTVar10 = &pTVar10->dyFull;
                            psVar2 = psVar11;
                            psVar11 = psVar11 + 1;
                            pTVar1->yTop = *psVar2;
                        }
                        prgtile[i].wFlags_0xa = prgtile[i].wFlags_0xa & 0xfff8 | uVar5 & 7;
                        if (((uint)local_30 & 7) == uVar5) {
                            if (iCur <= i) {
                                i = iCur;
                            }
                            ReflowColumn(uVar5, i, 1);
                        } else {
                            ReflowColumn(uVar5, i, 1);
                            ReflowColumn((uint)local_30 & 7, iCur, 1);
                        }
                    }
                } else {
                    OffsetRc(&rc, -1, 0);
                    if ((prgtile[i].wFlags_0xa >> 7 & 1) == 0) {
                        bt = 0x71;
                    } else {
                        bt = 0x70;
                    }
                    InitBtnTrack(local_40, hwndPlanet, 0, &rc, bt, 0, 0, 0, (char *)0x0);
                    do {
                        sVar8 = FTrackBtn(local_40);
                    } while (sVar8 != 0);
                    if ((local_2a >> 1 & 1) != 0) {
                        prgtile[i].wFlags_0xa = prgtile[i].wFlags_0xa & 0xff7f | (uint)((prgtile[i].wFlags_0xa >> 7 & 1) == 0) << 7;
                        ReflowColumn(prgtile[i].wFlags_0xa & 7, i, 1);
                    }
                }
            }
        }
    }
    return;
}

// ======================================================================
// Function: ClickInPlanetOrders
// Address: 1048:515c
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x1048548a) */
/* WARNING: Removing unreachable block (ram,0x10485505) */
/* WARNING: Removing unreachable block (ram,0x104853d2) */

ushort ClickInPlanetOrders(POINT pt, short sks, short fCursor, short fRightBtn)

{
    BOOL       BVar1;
    int        iVar2;
    char      *pcVar3;
    short      sVar4;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    ulong      uVar5;
    ushort     in_stack_0000ffd2;
    undefined1 local_2c[22];
    uint       local_16;
    uint       local_14;
    long       rglQuan[3];
    short      i;

    uVar5 = CONCAT22(unaff_SI, unaff_DI);
    if ((sel.grobj == grobjPlanet) && (fRightBtn == 0)) {
        BVar1 = PtInRect(rgrcRef + 6, pt);
        if (BVar1 == 0) {
            BVar1 = PtInRect(rgrcRef + 7, pt);
            if (BVar1 == 0) {
                BVar1 = PtInRect(rgrcRef + 8, pt);
                if (BVar1 == 0) {
                    BVar1 = PtInRect(rgrcRef + 9, pt);
                    if (BVar1 == 0) {
                        BVar1 = PtInRect(rgrcRef + 10, pt);
                        if (BVar1 == 0) {
                            BVar1 = PtInRect(rgrcRef + 0xb, pt);
                            if (BVar1 == 0) {
                                BVar1 = PtInRect(rgrcRef + 0xd, pt);
                                if (BVar1 == 0) {
                                    BVar1 = PtInRect(rgrcRef + 0xe, pt);
                                    if (BVar1 == 0) {
                                        BVar1 = PtInRect(rgrcRef + 0x10, pt);
                                        if (BVar1 == 0) {
                                            BVar1 = PtInRect(rgrcRef + 0xf, pt);
                                            if (BVar1 == 0) {
                                                BVar1 = PtInRect(rgrcRef + 0x11, pt);
                                                if (BVar1 != 0) {
                                                    if (fCursor != 0) {
                                                        return hcurHand;
                                                    }
                                                    pcVar3 = PszGetCompressedString(idsRoute2);
                                                    InitBtnTrack(local_2c + 2, hwndPlanet, 0, (RECT *)(rgrcRef + 0x11), 8, 0x50, gd.grBits._2_2_ >> 0xd & 1, 1,
                                                                 pcVar3);
                                                    do {
                                                        sVar4 = FTrackBtn(local_2c + 2);
                                                    } while (sVar4 != 0);
                                                    gd.grBits._2_2_ = gd.grBits._2_2_ & 0xdfff | ((local_14 >> 1 & 1) << 0xd ^ gd.grBits._2_2_) & 0x2000;
                                                }
                                            } else {
                                                ClickInShipOrders(pt, sks, 0, 0);
                                            }
                                        } else {
                                            local_14 = IWarpMAFromLppl(&sel.pl, (short *)0x0);
                                            if (local_14 == 0) {
                                                return 0;
                                            }
                                            if (fCursor != 0) {
                                                return hcurArrowHelp;
                                            }
                                            GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = hstSpecialSB;
                                            local_16 = local_14 + 2;
                                            GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 =
                                                GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 & 0xff00 | local_16 & 0xff;
                                            FLookupPart((PART *)&GlobalPD.u_POPUPDATA_0x0002.part);
                                            GlobalPD.grPopup = 9;
                                            Popup(hwndPlanet, pt.x, pt.y);
                                        }
                                    } else {
                                        if (fCursor != 0) {
                                            return hcurArrowHelp;
                                        }
                                        GlobalPD.grPopup = 0xb;
                                        GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = *(ushort *)(idPlayer * 4 + rglpshdefSB_0x2);
                                        GlobalPD.u_POPUPDATA_0x0002.lpfl._0_2_ =
                                            (FLEET *)(*(int *)(idPlayer * 4 + rglpshdefSB) + ((uint)sel.pl.lStarbase & 0xf) * 0x93);
                                        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = 0;
                                        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = 1;
                                        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = 0;
                                        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary = 0;
                                        Popup(hwndPlanet, pt.x, pt.y);
                                    }
                                } else {
                                    local_14 = IWarpMAFromLppl(&sel.pl, (short *)0x0);
                                    if (local_14 == 0) {
                                        return 0;
                                    }
                                    if (fCursor != 0) {
                                        return hcurHand;
                                    }
                                    pcVar3 = PszGetCompressedString(idsSetDest);
                                    InitBtnTrack(local_2c, hwndPlanet, 0, (RECT *)(rgrcRef + 0xd), 8, 0x50, gd.grBits._2_2_ >> 8 & 1, 1, pcVar3);
                                    do {
                                        sVar4 = FTrackBtn(local_2c);
                                    } while (sVar4 != 0);
                                    gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfeff | ((local_16 >> 1 & 1) << 8 ^ gd.grBits._2_2_) & 0x100;
                                }
                            } else {
                                uVar5 = __aFulshr(uVar5, in_stack_0000ffd2);
                                if ((((uint)uVar5 & 0x1f) == 0x1f) && (sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv), sVar4 != raMacintosh)) {
                                    return 0;
                                }
                                if (fCursor != 0) {
                                    return hcurArrowHelp;
                                }
                                sVar4 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv);
                                if (sVar4 == raMacintosh) {
                                    GlobalPD.grPopup = 10;
                                    GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = hstMining | hstTorp | hstBeam | hstShield;
                                    GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = (ushort)szPopupBuffer;
                                    CchGetString(idsRaceCannotBuildPlanetaryScannersStarbasesHave, (char *)szPopupBuffer);
                                } else {
                                    LookupBestPlanetaryScanner((PART *)&GlobalPD.u_POPUPDATA_0x0002.part);
                                    GlobalPD.grPopup = 9;
                                }
                                Popup(hwndPlanet, pt.x, pt.y);
                            }
                        } else {
                            if ((sel.pl.rgbImp._4_2_ & 0xfff) == 0) {
                                return 0;
                            }
                            if (fCursor != 0) {
                                return hcurArrowHelp;
                            }
                            FGetBestDefensePart((PART *)&GlobalPD.u_POPUPDATA_0x0002.part);
                            GlobalPD.grPopup = 9;
                            Popup(hwndPlanet, pt.x, pt.y);
                        }
                    } else {
                        if (fCursor != 0) {
                            return hcurArrowHelp;
                        }
                        GlobalPD.grPopup = 7;
                        GlobalPD.u_POPUPDATA_0x0002.dxOut = sel.pl.id;
                        Popup(hwndPlanet, pt.x, pt.y);
                    }
                } else {
                    if (fCursor != 0) {
                        return hcurArrowHelp;
                    }
                    GlobalPD.grPopup = 0xc;
                    GlobalPD.u_POPUPDATA_0x0002.dxOut = sel.pl.id;
                    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cMax = CResourcesAtPlanet(&sel.pl, idPlayer);
                    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2;
                    uVar5 = __aFulshr(uVar5, in_stack_0000ffd2);
                    if ((uVar5 & 1) == 0) {
                        sVar4 = MulDiv(GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cMax, (int)*(char *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0), 100);
                        GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur - sVar4;
                    }
                    Popup(hwndPlanet, pt.x, pt.y);
                }
            } else {
                if (fCursor != 0) {
                    return hcurArrowHelp;
                }
                GlobalPD.grPopup = 8;
                GlobalPD.u_POPUPDATA_0x0002.dxOut = sel.pl.id;
                GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = (short)(rgrcRef[7].top + dyArial8 <= pt.y);
                if (GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory == 0) {
                    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cMax = CMaxMines(&sel.pl, idPlayer);
                    uVar5 = __aFulshr(uVar5, in_stack_0000ffd2);
                    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = (uint)uVar5 & 0xfff;
                    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = CMaxOperableMines(&sel.pl, idPlayer, 0);
                } else {
                    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cMax = CMaxFactories(&sel.pl, idPlayer);
                    uVar5 = __aFulshr(uVar5, in_stack_0000ffd2);
                    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = (uint)uVar5 & 0xfff;
                    GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = CMaxOperableFactories(&sel.pl, idPlayer, 0);
                }
                Popup(hwndPlanet, pt.x, pt.y);
            }
        } else {
            if (fCursor != 0) {
                return hcurArrowHelp;
            }
            iVar2 = (pt.y - rgrcRef[6].top) / dyArial8;
            GlobalPD.grPopup = 1;
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cMax = iVar2 >> 0xf;
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fFactory = *(short *)((int)&sel.pl + 0x1c + iVar2 * 4);
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.fSummary = *(short *)((int)&sel.pl + 0x1e + iVar2 * 4);
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.iPlrMin = (short)*(byte *)((int)&sel.pl + 9 + iVar2);
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.iPlrMax = 0;
            GlobalPD.u_POPUPDATA_0x0002.dxOut = iVar2;
            EstMineralsMined(&sel.pl, rglQuan, -1, 0);
            GlobalPD.u_POPUPDATA_0x0002.rgi[4]._0_2_ = (undefined2)rglQuan[iVar2];
            GlobalPD.u_POPUPDATA_0x0002.rgi[4]._2_2_ = *(undefined2 *)((int)rglQuan + iVar2 * 4 + 2);
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cCur = sel.pl.wFlags_0x4 >> 10 & 1;
            GlobalPD.u_POPUPDATA_0x0002.s_POPUPDATA_0x0002.cOperate = 0;
            Popup(hwndPlanet, pt.x, pt.y);
        }
    }
    return 0;
}

// ======================================================================
// Function: EnsureTileSize
// Address: 1048:587e
// Segment: MEMORY_PLANET
// ======================================================================

void EnsureTileSize(short fSmallTiles)

{
    int       *piVar1;
    GrobjClass GVar2;
    int        iVar3;
    short      grobjSav;
    short      i;
    short      iMul;

    GVar2 = sel.grobj;
    if (fSmallTiles != (gd.grBits._2_2_ >> 3 & 1)) {
        gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfff7 | (fSmallTiles & 1U) << 3;
        if (fSmallTiles == 0) {
            iVar3 = 1;
        } else {
            iVar3 = -1;
        }
        for (i = 0; i < 6; i = i + 1) {
            if (*(int *)(i * 0x10 + 0x800) == 0x40) {
                piVar1 = (int *)(i * 0x10 + 0x7fe);
                *piVar1 = *piVar1 + (dyArial8 + 2) * 2 * iVar3;
            }
            if (*(int *)(i * 0x10 + 0x800) == 4) {
                piVar1 = (int *)(i * 0x10 + 0x7fe);
                *piVar1 = *piVar1 + (dyArial8 + 4) * 2 * iVar3;
            }
            if (*(int *)(i * 0x10 + 0x800) == 0x80) {
                piVar1 = (int *)(i * 0x10 + 0x7fe);
                *piVar1 = *piVar1 + iVar3 * 10;
            }
        }
        for (i = 0; GVar2 = sel.grobj, i < 7; i = i + 1) {
            if (*(int *)(i * 0x10 + 0x912) == 1) {
                piVar1 = (int *)(i * 0x10 + 0x910);
                *piVar1 = *piVar1 + (dyArial8 * 4 + 2) * iVar3;
            }
            if (*(int *)(i * 0x10 + 0x912) == 0x200) {
                piVar1 = (int *)(i * 0x10 + 0x910);
                *piVar1 = *piVar1 + (dyArial8 * 3 + 8) * iVar3;
            }
            if (*(int *)(i * 0x10 + 0x912) == 0x20) {
                piVar1 = (int *)(i * 0x10 + 0x910);
                *piVar1 = *piVar1 + (dyArial8 + 9) * iVar3;
            }
            if (*(int *)(i * 0x10 + 0x912) == 4) {
                piVar1 = (int *)(i * 0x10 + 0x910);
                *piVar1 = *piVar1 + (dyArial8 + 4) * 2 * iVar3;
            }
            if (*(int *)(i * 0x10 + 0x912) == 0x80) {
                piVar1 = (int *)(i * 0x10 + 0x910);
                *piVar1 = *piVar1 + iVar3 * 10;
            }
            if (*(int *)(i * 0x10 + 0x912) == 0x100) {
                piVar1 = (int *)(i * 0x10 + 0x910);
                *piVar1 = *piVar1 + iVar3 * 2;
            }
            if (*(int *)(i * 0x10 + 0x912) == 0x40) {
                piVar1 = (int *)(i * 0x10 + 0x910);
                *piVar1 = *piVar1 + iVar3 * 6;
            }
        }
        sel.grobj = grobjPlanet;
        for (i = 0; i < 4; i = i + 1) {
            ReflowColumn(i, -1, 0);
        }
        sel.grobj = grobjFleet;
        for (i = 0; i < 4; i = i + 1) {
            ReflowColumn(i, -1, 0);
        }
    }
    sel.grobj = GVar2;
    return;
}

// ======================================================================
// Function: ReflowColumn
// Address: 1048:5b80
// Segment: MEMORY_PLANET
// ======================================================================

void ReflowColumn(short iCol, short iTile, short fRedraw)

{
    int        iVar1;
    undefined2 unaff_SS;
    RECT       rc;
    TILE      *ptile;
    short      grbit;
    short      i;
    short      ctile;
    short      yTop;
    HDC        hdc;

    grbit = 0;
    if (sel.grobj == grobjFleet) {
        ptile = (TILE *)&rgtileShip;
        ctile = 7;
    } else {
        ptile = (TILE *)&rgtilePlanet;
        ctile = 6;
    }
    yTop = 4;
    if (iTile == -1) {
        i = 0;
        while ((i < ctile && ((ptile[i].wFlags_0xa & 7) != iCol))) {
            i = i + 1;
        }
        if (i == ctile) {
            return;
        }
        iTile = i;
    } else {
        for (i = 0; i < iTile; i = i + 1) {
            if ((ptile[i].wFlags_0xa & 7) == iCol) {
                if ((ptile[i].wFlags_0xa >> 7 & 1) == 0) {
                    iVar1 = dyArial8 + 3;
                } else {
                    iVar1 = ptile[i].dyFull;
                }
                yTop = yTop + iVar1 + 4;
            }
        }
    }
    if (fRedraw != 0) {
        GetClientRect(hwndPlanet, &rc);
        rc.top = yTop;
        rc.left = iCol * 0xc6 + 4;
        rc.right = iCol * 0xc6 + 0xc3;
        hdc = GetDC(hwndPlanet);
        FillRect(hdc, &rc, hbrButtonFace);
    }
    while ((iTile < ctile && ((ptile[iTile].wFlags_0xa & 7) == iCol))) {
        (ptile + iTile)->yTop = yTop;
        ptile[iTile].wFlags_0xa = ptile[iTile].wFlags_0xa & 0xf7ff | 0x800;
        grbit = grbit | ptile[iTile].grbit;
        if ((ptile[iTile].wFlags_0xa >> 7 & 1) == 0) {
            iVar1 = dyArial8 + 3;
        } else {
            iVar1 = ptile[iTile].dyFull;
        }
        yTop = yTop + iVar1 + 4;
        iTile = iTile + 1;
    }
    if (fRedraw != 0) {
        DrawPlanShip(hdc, grbit);
        ReleaseDC(hwndPlanet, hdc);
    }
    return;
}

// ======================================================================
// Function: IBestTerraform
// Address: 1048:5dd2
// Segment: MEMORY_PLANET
// ======================================================================

short IBestTerraform(PLANET *lppl, short fHelp)

{
    char       cVar1;
    int        iPlr_00;
    short      sVar2;
    short      sVar3;
    short      sVar4;
    PLANET    *pPVar5;
    undefined2 uVar6;
    short      iPlrSav;
    short      rgCost[3];
    short      rgpctBest[3];
    short      rgMin[3];
    short      pctCur;
    short      iEnv;
    short      iPlr;
    short      i;
    short      pctT;
    short      rgMax[3];
    short      iBest;
    short      iSave;

    sVar2 = idPlayer;
    uVar6 = (undefined2)((ulong)lppl >> 0x10);
    pPVar5 = (PLANET *)lppl;
    iPlr_00 = pPVar5->iPlayer;
    if (iPlr_00 == -1) {
        sVar3 = 0;
    } else {
        idPlayer = iPlr_00;
        sVar3 = FCanTerraformLppl(lppl, rgMin, rgMax, rgCost, fHelp);
        if (sVar3 == 0) {
            sVar3 = 0;
        } else {
            sVar3 = PctPlanetDesirability(lppl, iPlr_00);
            for (i = 0; i < 3; i = i + 1) {
                if (rgMin[i] == -1) {
                    if (rgMax[i] != -1) {
                        iEnv = rgMax[i];
                        goto LAB_1048_5ea6;
                    }
                    rgpctBest[i] = 0;
                } else {
                    iEnv = rgMin[i];
                LAB_1048_5ea6:
                    cVar1 = pPVar5->rgEnvVar[i];
                    pPVar5->rgEnvVar[i] = (char)iEnv;
                    sVar4 = PctPlanetDesirability(lppl, iPlr_00);
                    pctT = sVar4 - sVar3;
                    if (pctT < 0) {
                        pctT = -pctT;
                    }
                    sVar4 = _abs(cVar1 - iEnv);
                    rgpctBest[i] = (pctT * 100) / sVar4 + 1;
                    pPVar5->rgEnvVar[i] = cVar1;
                }
            }
            iSave = 0;
            for (i = 1; i < 3; i = i + 1) {
                if (rgpctBest[iSave] < rgpctBest[i]) {
                    iSave = i;
                }
            }
            if (rgMin[iSave] == -1) {
                sVar3 = iSave + 1;
            } else {
                sVar3 = -(iSave + 1);
            }
        }
    }
    idPlayer = sVar2;
    return sVar3;
}

// ======================================================================
// Function: PszCalcEnvVar
// Address: 1048:5fcc
// Segment: MEMORY_PLANET
// ======================================================================

char *PszCalcEnvVar(short iEnv, short iVar)

{
    char *pcVar1;

    if (iEnv == 0) {
    LAB_1048_5fdb:
        pcVar1 = PszCalcGravity(iVar);
    } else {
        if (iEnv == 1) {
            _wsprintf(szWork, s_d_cC_1120_08b0, iVar * 4 + -200, 0xba);
        } else {
            if (iEnv != 2)
                goto LAB_1048_5fdb;
            _wsprintf(szWork, s_dmR_1120_08b6, iVar);
        }
        pcVar1 = (char *)szWork;
    }
    return pcVar1;
}

// ======================================================================
// Function: PszCalcGravity
// Address: 1048:6058
// Segment: MEMORY_PLANET
// ======================================================================

char *PszCalcGravity(short iGravity)

{
    short sVar1;
    short iVal;
    short d;

    sVar1 = _abs(iGravity + -0x32);
    if (sVar1 < 0x1a) {
        iVal = sVar1 * 4 + 100;
    } else {
        iVal = (sVar1 + -0x19) * 0x18 + 200;
    }
    if (iGravity < 0x32) {
        iVal = (short)(10000 / (long)iVal);
    }
    _wsprintf(szWork, s_d_02dg_1120_08bb, iVal / 100, iVal % 100);
    return (char *)szWork;
}

// ======================================================================
// Function: HandleFocusState
// Address: 1048:60e6
// Segment: MEMORY_PLANET
// ======================================================================

void HandleFocusState(DRAWITEMSTRUCT *lpdis, short inflate)

{
    DRAWITEMSTRUCT *pDVar1;
    undefined2      uVar2;

    uVar2 = (undefined2)((ulong)lpdis >> 0x10);
    pDVar1 = (DRAWITEMSTRUCT *)lpdis;
    if ((pDVar1->itemState & 0x10) != 0) {
        FrameRect(pDVar1->hDC, (RECT *)CONCAT22(uVar2, &pDVar1->rcItem), hbr50Screen);
    }
    return;
}

// ======================================================================
// Function: DrawCBEntireItem
// Address: 1048:6128
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

void DrawCBEntireItem(DRAWITEMSTRUCT *lpdis, short inflate)

{
    uint            uVar1;
    int             fListbox_00;
    WMType          WVar2;
    DRAWITEMSTRUCT *pDVar3;
    undefined2      uVar4;
    RECT            rc;
    short           fSelected;
    short           fListbox;

    uVar4 = (undefined2)((ulong)lpdis >> 0x10);
    pDVar3 = (DRAWITEMSTRUCT *)lpdis;
    uVar1 = pDVar3->itemState;
    rc.left = (&pDVar3->rcItem)->left;
    rc.top = (pDVar3->rcItem).top;
    rc.right = (pDVar3->rcItem).right;
    rc.bottom = (pDVar3->rcItem).bottom;
    if (((pDVar3->hwndItem == hwndFleetCompLB) || (pDVar3->hwndItem == hwndPlanetProdLB)) || (0 < inflate)) {
        fListbox_00 = 1;
    } else {
        fListbox_00 = 0;
    }
    if (0 < inflate) {
        inflate = -inflate;
    }
    if (fListbox_00 == 0) {
        WVar2 = CB_GETLBTEXT;
    } else {
        WVar2 = CB_INSERTSTRING;
    }
    SendMessage(pDVar3->hwndItem, WVar2, pDVar3->itemID, 0x112057a4);
    DrawProductionItem(pDVar3->hDC, &rc, (char *)szWork, inflate, uVar1 & 1, fListbox_00);
    HandleFocusState(lpdis, inflate + 2);
    return;
}

// ======================================================================
// Function: DrawProductionItem
// Address: 1048:6208
// Segment: MEMORY_PLANET
// ======================================================================

void DrawProductionItem(HDC hdc, RECT *prc, char *psz, short inflate, short fSelected, short fListbox)

{
    char       cVar1;
    bool       bVar2;
    short      sVar3;
    ushort     uVar4;
    char      *pcVar5;
    undefined2 unaff_SS;
    COLORREF   CVar6;
    DWORD      DVar7;
    RECT       rc;
    short      bkSav;
    short      cch;
    short      fItalic;
    HBRUSH     hbr;
    short      dx;
    RECT       rcDraw;
    short      fFleet;
    COLORREF   crForeSav;
    short      fDoubleDraw;
    short      ich;
    RECT       rcIn;
    char       szT[20];
    short      pctDmg;
    COLORREF   cr;
    short      ichT;
    char      *pch;
    ushort     hfntSav;

    bVar2 = false;
    fDoubleDraw = 0;
    fFleet = 0;
    rcIn.left = prc->left;
    rcIn.top = prc->top;
    rcIn.right = prc->right;
    rcIn.bottom = prc->bottom;
    if (fSelected == 0) {
        hbr = hbrWindow;
        cVar1 = *psz;
        if (cVar1 == ' ') {
        PLANET_LDefCase:
            if (((int)crWindow == 0) && (crWindow._2_2_ == 0)) {
                cr._0_2_ = -1;
                cr._2_2_ = 0xff;
            } else {
                cr._0_2_ = 0;
                cr._2_2_ = 0;
            }
        } else if (cVar1 == '#') {
            cr._0_2_ = 0;
            cr._2_2_ = 0x7f;
        } else if (cVar1 == '&') {
            cr._0_2_ = 0x7f7f;
            cr._2_2_ = 0x7f;
        } else {
            if (cVar1 != '*') {
                if (cVar1 == 'I') {
                    bVar2 = true;
                    goto PLANET_LDefCase;
                }
                if (cVar1 == 'P') {
                    fDoubleDraw = 1;
                    pctDmg = (short)psz[1];
                } else if (cVar1 != 'Q') {
                    cr._0_2_ = 0xff;
                    cr._2_2_ = 0;
                    goto LAB_1048_63d9;
                }
                fFleet = 1;
                goto PLANET_LDefCase;
            }
            cr._0_2_ = 0x7f00;
            cr._2_2_ = 0;
        }
    } else {
        cr._0_2_ = (int)crWindow;
        cr._2_2_ = crWindow._2_2_;
        cVar1 = *psz;
        if (cVar1 == ' ') {
        PLANET_LDefCaseSel:
            if (((int)crWindow == 0) && (crWindow._2_2_ == 0)) {
                hbr = GetStockObject(0);
            } else {
                hbr = GetStockObject(4);
            }
        } else if (cVar1 == '#') {
            hbr = hbrBlue;
        } else if (cVar1 == '&') {
            hbr = hbrGray;
        } else {
            if (cVar1 != '*') {
                if (cVar1 == 'I') {
                    bVar2 = true;
                    goto PLANET_LDefCaseSel;
                }
                if (cVar1 == 'P') {
                    fDoubleDraw = 1;
                    pctDmg = (short)psz[1];
                } else if (cVar1 != 'Q') {
                    hbr = hbrRed;
                    goto LAB_1048_63d9;
                }
                fFleet = 1;
                goto PLANET_LDefCaseSel;
            }
            hbr = hbrGreen;
        }
    }
LAB_1048_63d9:
    if (fListbox == 2) {
        hbr = hbrButtonFace;
    }
    FillRect(hdc, &rcIn, hbr);
    if (fDoubleDraw != 0) {
        rcDraw.left = rcIn.left;
        rcDraw.top = rcIn.top;
        rcDraw.bottom = rcIn.bottom;
        rcDraw.right = rcIn.left + ((rcIn.right - rcIn.left) * pctDmg) / 100;
        FillRect(hdc, &rcDraw, hbrRed);
    }
    if (inflate != 0) {
        InflateRect(&rcIn, -2, -1);
    }
    if (fListbox == 0) {
        ich = 1;
    } else if (fFleet == 0) {
        ich = 6;
        if (((int)psz[1] - 0x20U & 2) != 0) {
            bVar2 = true;
        }
    } else {
        ich = 7;
    }
    CVar6 = SetTextColor(hdc, CONCAT22(cr._2_2_, (int)cr));
    sVar3 = SetBkMode(hdc, 1);
    if (bVar2) {
        hfntSav = SelectObject(hdc, rghfontArial8[3]);
    }
    pcVar5 = psz + ich;
    uVar4 = _strlen(pcVar5);
    cch = uVar4 + 1;
    do {
        cch = cch + -1;
        DVar7 = GetTextExtent(hdc, pcVar5, cch);
    } while (rcIn.right - rcIn.left < (int)DVar7);
    TextOut(hdc, rcIn.left, rcIn.top, pcVar5, cch);
    if (bVar2) {
        SelectObject(hdc, hfntSav);
    }
    if ((uint)ich < 6)
        goto LAB_1048_6673;
    if (((int)psz[ich + -5] - 0x20U & 2) == 0) {
        szT[0] = '\0';
    LAB_1048_65b6:
        uVar4 = _strlen(szT);
        ichT = 2 - fFleet;
        while ((ichT < 6 && (psz[ichT + fFleet] == ' '))) {
            ichT = ichT + 1;
        }
        _strncpy(szT + uVar4, psz + fFleet + ichT, 6 - ichT);
        ich = uVar4 + (6 - ichT);
        if ((fFleet == 0) && (((int)psz[fDoubleDraw + 1] - 0x20U & 1) != 0)) {
            szT[ich] = '%';
            ich = ich + 1;
        }
    } else {
        if (psz[ich + -1] != '*') {
            CchGetString(idsUpTo, szT);
            goto LAB_1048_65b6;
        }
        ich = CchGetString(idsNeeded, szT);
    }
    RightTextOut(hdc, rcIn.right, rcIn.top, szT, ich, 0);
LAB_1048_6673:
    SetTextColor(hdc, CVar6);
    SetBkMode(hdc, sVar3);
    return;
}

// ======================================================================
// Function: FillPlanetProdLB
// Address: 1048:6692
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x104869b9) */
/* WARNING: Removing unreachable block (ram,0x10486a6e) */
/* WARNING: Removing unreachable block (ram,0x104868d8) */
/* WARNING: Removing unreachable block (ram,0x10486999) */
/* WARNING: Removing unreachable block (ram,0x104869be) */
/* WARNING: Variable defined which should be unmapped: etaFirst */
/* WARNING: Removing unreachable block (ram,0x104868f8) */
/* WARNING: Removing unreachable block (ram,0x104868fd) */
/* WARNING: Removing unreachable block (ram,0x104869f2) */
/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

void FillPlanetProdLB(HWND hwnd, PLPROD *lpplprod, PLANET *lppl)

{
    bool       bVar1;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar2;
    undefined2 unaff_SS;
    ulong      uVar3;
    ulong      uVar4;
    short      etaFirst;
    short      etaLast;
    PROD      *lpprod;
    char       ch;
    char      *psz;
    long       resCost;
    char       szTemp[80];
    short      cItem;
    short      i;
    long       rgwtMin[4];
    short      fMinimal;

    uVar4 = CONCAT22(unaff_SI, unaff_DI);
    if (((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) {
        bVar1 = false;
    } else {
        bVar1 = true;
    }
    if (!bVar1) {
        lppl = &sel.pl;
        if (hwnd == 0) {
            hwnd = hwndPlanetProdLB;
        }
        SendMessage(hwnd, CB_DIR, 0, 0);
    }
    uVar2 = (undefined2)((ulong)lppl >> 0x10);
    if (((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) {
        /* WARNING: Load size is inaccurate */
        lpplprod = (PLPROD *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2), ((PLANET *)lppl)->lpplprod);
    }
    if ((((PLPROD *)lpplprod == (PLPROD *)0x0) && (lpplprod._2_2_ == 0)) || (((PLPROD *)lpplprod)->iprodMac == 0)) {
        psz = PszGetCompressedString(idsQueueEmpty);
    } else {
        if (hwndProdDlg == 0)
            goto PLANET_NoMsg;
        psz = PszGetCompressedString(idsTopQueue);
    }
    if (bVar1) {
        if (psz != (char *)szWork) {
            _strcpy((char *)szWork, psz);
        }
    } else {
        SendMessage(hwnd, CB_LIMITTEXT, 0, (LPARAM)psz);
    }
PLANET_NoMsg:
    if (((PLPROD *)lpplprod != (PLPROD *)0x0) || (lpplprod._2_2_ != 0)) {
        resCost._0_2_ = 0;
        resCost._2_2_ = 0;
        for (i = 0; i < 4; i = i + 1) {
            *(undefined2 *)(rgwtMin + i) = 0;
            *(undefined2 *)((int)rgwtMin + i * 4 + 2) = 0;
        }
        lpprod = (PROD *)((PLPROD *)lpplprod + 1);
        for (i = 0; i < (int)(uint)((PLPROD *)lpplprod)->iprodMac; i = i + 1) {
            psz = PszNameProdItem(lpprod);
            EstimateItemProdSched(lppl, lpplprod, i, &etaFirst, &etaLast);
            if (((etaFirst == 0) && (etaLast == 0)) || ((etaFirst == -1 && (etaLast == -1)))) {
                if (!bVar1) {
                    ch = '&';
                    goto LAB_1048_693c;
                }
            } else {
                if (((etaFirst < 2) || (99 < etaFirst)) &&
                    ((etaFirst != 100 ||
                      ((uVar3 = __aFulshr(uVar4, 100), ((uint)uVar3 & 7) != 1 || (uVar3 = __aFulshr(uVar4, etaFirst), 6 < ((uint)uVar3 & 0x7f))))))) {
                    if ((etaFirst == 1) && (etaLast == 1)) {
                        ch = '*';
                    } else if (etaFirst < 100) {
                        ch = '#';
                    } else {
                        ch = '!';
                    }
                } else {
                    ch = ' ';
                }
            LAB_1048_693c:
                _wsprintf(szTemp, s_c_5d_s_1120_08c4, (int)ch, (uint)lpprod->dwFlags & 0x3ff, psz);
                uVar3 = __aFulshr(uVar4, etaFirst);
                if (((uint)uVar3 & 7) == 1) {
                    uVar3 = __aFulshr(uVar4, etaFirst);
                    if (((uint)uVar3 & 0x7f) < 7) {
                        szTemp[1] = szTemp[1] + '\x02';
                        uVar3 = __aFulshr(uVar4, etaFirst);
                        if (((uint)uVar3 & 0x7f) == 3) {
                            szTemp[5] = '*';
                        }
                    }
                    uVar3 = __aFulshr(uVar4, etaFirst);
                    if (((((uint)uVar3 & 0x7f) == 0xc) || (uVar3 = __aFulshr(uVar4, etaFirst), ((uint)uVar3 & 0x7f) == 4)) ||
                        (uVar3 = __aFulshr(uVar4, etaFirst), ((uint)uVar3 & 0x7f) == 5)) {
                        szTemp[1] = szTemp[1] + '\x01';
                    }
                }
                if (bVar1) {
                    _strcpy((char *)szWork, szTemp);
                    return;
                }
                SendMessage(hwnd, CB_LIMITTEXT, 0, (LPARAM)szTemp);
            }
            lpprod = (PROD *)lpprod + 1;
        }
        if (bVar1) {
            CchGetString(idsQueueEmpty, (char *)szWork);
        }
    }
    return;
}

// ======================================================================
// Function: PctPlanetCapacity
// Address: 1048:6aca
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10486af9) */
/* WARNING: Removing unreachable block (ram,0x10486b64) */

short PctPlanetCapacity(PLANET *lppl)

{
    undefined2 uVar1;
    long       lVar2;
    long       lVar3;
    ulong      uVar4;
    long       lPopMax;
    long       pctCap;

    lVar2 = CalcPlanetMaxPop(lppl->id, idPlayer);
    if (lVar2 < 1) {
        pctCap._0_2_ = 0;
    } else {
        lVar3 = __aFldiv(lVar2, 2);
        uVar1 = (undefined2)((ulong)lppl >> 0x10);
        uVar4 = __aFulmul(CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe), (int)((PLANET *)lppl)->rgwtMin[3]), 100);
        lVar2 = __aFldiv(uVar4 + lVar3, lVar2);
        pctCap._0_2_ = (short)lVar2;
        if (999 < lVar2) {
            pctCap._0_2_ = 999;
        }
    }
    return (short)pctCap;
}

// ======================================================================
// Function: PctPlanetOptValue
// Address: 1048:6b88
// Segment: MEMORY_PLANET
// ======================================================================

short PctPlanetOptValue(PLANET *lppl, short iPlr)

{
    short sVar1;
    short iNewVal;
    short rgiValSav[3];
    short rgCost[3];
    short pctDesire;
    short rgMin[3];
    short i;
    short rgMax[3];

    sVar1 = FCanTerraformLppl(lppl, rgMin, rgMax, rgCost, 1);
    if (sVar1 == 0) {
        sVar1 = PctPlanetDesirability(lppl, iPlr);
    } else {
        for (i = 0; i < 3; i = i + 1) {
            rgiValSav[i] = (int)((PLANET *)lppl)->rgEnvVar[i];
            if ((*(char *)(iPlr * 0xc0 + 0x59b5 + i) != -1) && (((PLANET *)lppl)->rgEnvVar[i] != *(char *)(iPlr * 0xc0 + 0x59b2 + i))) {
                iNewVal = -1;
                if (((PLANET *)lppl)->rgEnvVar[i] < *(char *)(iPlr * 0xc0 + 0x59b2 + i)) {
                    if ((int)((PLANET *)lppl)->rgEnvVar[i] < rgMax[i]) {
                        if ((int)*(char *)(iPlr * 0xc0 + 0x59b2 + i) < rgMax[i]) {
                            iNewVal = (short)*(char *)(iPlr * 0xc0 + 0x59b2 + i);
                        } else {
                            iNewVal = rgMax[i];
                        }
                    }
                } else if ((rgMin[i] != -1) && (rgMin[i] < (int)((PLANET *)lppl)->rgEnvVar[i])) {
                    if (rgMin[i] < (int)*(char *)(iPlr * 0xc0 + 0x59b2 + i)) {
                        iNewVal = (short)*(char *)(iPlr * 0xc0 + 0x59b2 + i);
                    } else {
                        iNewVal = rgMin[i];
                    }
                }
                if (iNewVal != -1) {
                    ((PLANET *)lppl)->rgEnvVar[i] = (char)iNewVal;
                }
            }
        }
        sVar1 = PctPlanetDesirability(lppl, idPlayer);
        for (i = 0; i < 3; i = i + 1) {
            ((PLANET *)lppl)->rgEnvVar[i] = (char)rgiValSav[i];
        }
    }
    return sVar1;
}

// ======================================================================
// Function: PctPlanetDesirability
// Address: 1048:6e1e
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Variable defined which should be unmapped: pctMod */

short PctPlanetDesirability(PLANET *lppl, short iPlr)

{
    int        iVar1;
    int        iVar2;
    int        iVar3;
    int        iVar4;
    short      sVar5;
    uint       uVar6;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    bool       bVar7;
    ulong      uVar8;
    long       lVar9;
    undefined8 uVar10;
    long       pctMod;
    short      iPlanet;
    short      pctVar;
    long       pctPos;
    short      dPenalty;
    short      i;
    short      iPref;
    long       pctNeg;
    short      iMax;
    short      d;
    short      iMin;

    pctPos = 0;
    pctNeg._0_2_ = 0;
    pctNeg._2_2_ = 0;
    lVar9 = 10000;
    i = 0;
    while (true) {
        pctMod._2_2_ = (undefined2)((ulong)lVar9 >> 0x10);
        pctMod._0_2_ = (undefined2)lVar9;
        if (2 < i)
            break;
        iVar1 = (int)((PLANET *)lppl)->rgEnvVar[i];
        iVar2 = (int)*(char *)(iPlr * 0xc0 + 0x59b2 + i);
        iVar3 = (int)*(char *)(iPlr * 0xc0 + 0x59b5 + i);
        iVar4 = (int)*(char *)(iPlr * 0xc0 + 0x59b8 + i);
        if (iVar4 < 0) {
            pctPos = CONCAT22(pctPos._2_2_ + (uint)(0xd8ef < (uint)pctPos), (uint)pctPos + 10000);
        } else if ((iVar1 < iVar3) || (iVar4 < iVar1)) {
            if (iVar1 < iVar3) {
                if (iVar3 - iVar1 < 0x10) {
                    uVar6 = iVar3 - iVar1;
                    iVar1 = (int)uVar6 >> 0xf;
                } else {
                    uVar6 = 0xf;
                    iVar1 = 0;
                }
                bVar7 = CARRY2((uint)pctNeg, uVar6);
                pctNeg._0_2_ = (uint)pctNeg + uVar6;
                pctNeg._2_2_ = pctNeg._2_2_ + iVar1 + (uint)bVar7;
            } else {
                if (iVar1 - iVar4 < 0x10) {
                    uVar6 = iVar1 - iVar4;
                    iVar1 = (int)uVar6 >> 0xf;
                } else {
                    uVar6 = 0xf;
                    iVar1 = 0;
                }
                bVar7 = CARRY2((uint)pctNeg, uVar6);
                pctNeg._0_2_ = (uint)pctNeg + uVar6;
                pctNeg._2_2_ = pctNeg._2_2_ + iVar1 + (uint)bVar7;
            }
        } else {
            sVar5 = _abs(iVar1 - iVar2);
            if (iVar1 < iVar2) {
                d = iVar2 - iVar3;
                dPenalty = (iVar2 - iVar1) * 2 - d;
            } else {
                d = iVar4 - iVar2;
                dPenalty = (iVar1 - iVar2) * 2 - d;
            }
            pctVar = (sVar5 * 100) / d;
            iVar1 = 100 - pctVar;
            uVar8 = __aFulmul((ulong)CONCAT62(CONCAT42((long)iVar1, iVar1 >> 0xf), iVar1), (long)iVar1);
            pctPos = uVar8 + pctPos;
            if (0 < dPenalty) {
                uVar8 = (ulong)(d * 2 - dPenalty);
                uVar8 = __aFulmul((ulong)CONCAT62(CONCAT42(uVar8, pctMod._2_2_), (undefined2)pctMod), uVar8);
                lVar9 = __aFldiv((long)CONCAT62(CONCAT42((long)(d << 1), (int)(uVar8 >> 0x10)), (int)uVar8), (long)(d << 1));
            }
        }
        i = i + 1;
    }
    if (((uint)pctNeg == 0) && (pctNeg._2_2_ == 0)) {
        _sqrt((double)pctPos / DOUBLE_3_0__1120_1d2e);
        uVar8 = __ftol((double)CONCAT26(pctMod._2_2_, CONCAT24((undefined2)pctMod, CONCAT22(unaff_SI, unaff_DI))));
        uVar10 = CONCAT62(CONCAT42(10000, pctMod._2_2_), (undefined2)pctMod);
        uVar8 = __aFulmul(uVar8, (ulong)uVar10);
        lVar9 = (long)((ulonglong)uVar10 >> 0x20);
        lVar9 = __aFldiv((long)CONCAT62(CONCAT42(lVar9, (int)(uVar8 >> 0x10)), (int)uVar8), lVar9);
        sVar5 = (short)lVar9;
    } else {
        sVar5 = -(uint)pctNeg;
    }
    return sVar5;
}

// ======================================================================
// Function: CalcPlanetMaxPop
// Address: 1048:7096
// Segment: MEMORY_PLANET
// ======================================================================

long CalcPlanetMaxPop(short idpl, short iplr)

{
    short      sVar1;
    uint       uVar2;
    int        iVar3;
    undefined2 unaff_SS;
    ulong      uVar4;
    long       lVar5;
    short      ihuldef;
    long       pctDesire;
    long       lMaxPop;
    PLANET     pl;

    FLookupPlanet(idpl, &pl);
    sVar1 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv);
    if (sVar1 == raMacintosh) {
        if ((pl.iPlayer != iplr) || ((pl.wFlags_0x4 >> 9 & 1) == 0)) {
            return 0;
        }
        iVar3 = (*(int *)(*(int *)(iplr * 4 + rglpshdefSB) + ((uint)pl.lStarbase & 0xf) * 0x93) + -0x20) * 4;
        uVar4 = CONCAT22(*(undefined2 *)(iVar3 + rglPopMac_0x2), *(undefined2 *)(iVar3 + rglPopMac));
    } else {
        uVar2 = PctPlanetDesirability(&pl, iplr);
        if (((int)uVar2 >> 0xf < 1) && (((int)uVar2 >> 0xf < 0 || (uVar2 < 5)))) {
            uVar4 = 500;
        } else {
            uVar4 = __aFulmul((long)(int)uVar2, 100);
        }
        sVar1 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv);
        if (sVar1 == raCheapCol) {
            lVar5 = __aFldiv(uVar4, 2);
            uVar4 = uVar4 - lVar5;
        } else {
            sVar1 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv);
            if (sVar1 == raNone) {
                lVar5 = __aFldiv(uVar4, 5);
                uVar4 = lVar5 + uVar4;
            }
        }
    }
    sVar1 = GetRaceGrbit((PLAYER *)rgplr + iplr, ibitRaceOBRM);
    if (sVar1 != 0) {
        lVar5 = __aFldiv(uVar4, 10);
        uVar4 = lVar5 + uVar4;
    }
    return uVar4;
}

// ======================================================================
// Function: CMaxMines
// Address: 1048:7248
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x104872b7) */

short CMaxMines(PLANET *lppl, short iplr)

{
    short sVar1;
    ulong uVar2;
    long  lVar3;
    short iEff;
    long  lPopMax;
    long  cMax;

    uVar2 = CalcPlanetMaxPop(lppl->id, iplr);
    sVar1 = GetRaceStat((PLAYER *)rgplr + iplr, rsMineOperate);
    lVar3 = 100;
    uVar2 = __aFulmul(uVar2, (long)sVar1);
    lVar3 = __aFldiv(uVar2, lVar3);
    if (lVar3 < 10) {
        lVar3 = 10;
    }
    sVar1 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv);
    cMax._0_2_ = (short)lVar3;
    if (sVar1 == raMacintosh) {
        cMax._0_2_ = 0;
    }
    return (short)cMax;
}

// ======================================================================
// Function: CMaxOperableMines
// Address: 1048:7304
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x104873a5) */

short CMaxOperableMines(PLANET *lppl, short iplr, short fNextYear)

{
    short      sVar1;
    short      sVar2;
    ulong      uVar3;
    long       lVar4;
    undefined2 uVar5;
    undefined2 uVar6;
    short      iEff;
    long       lPop;
    long       cCur;
    short      cMax;

    sVar1 = CMaxMines(lppl, iplr);
    sVar2 = GetRaceStat((PLAYER *)rgplr + iplr, rsMineOperate);
    uVar3 = CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe), (int)((PLANET *)lppl)->rgwtMin[3]);
    if (fNextYear != 0) {
        lVar4 = ChgPopFromPlanet(lppl, 0);
        uVar3 = lVar4 + uVar3;
    }
    uVar6 = 0;
    uVar5 = 100;
    uVar3 = __aFulmul(uVar3, (long)sVar2);
    lVar4 = __aFldiv(uVar3, CONCAT22(uVar6, uVar5));
    cMax = (short)lVar4;
    if (sVar1 < lVar4) {
        cMax = sVar1;
    }
    if (cMax < 1) {
        cMax = 1;
    }
    sVar1 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv);
    if (sVar1 == raMacintosh) {
        cMax = 0;
    }
    return cMax;
}

// ======================================================================
// Function: CMinesOperating
// Address: 1048:73fc
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Variable defined which should be unmapped: cMines */

short CMinesOperating(PLANET *lppl)

{
    short      sVar1;
    uint       uVar2;
    uint       uVar3;
    PLANET    *pPVar4;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar5;
    long       lVar6;
    ulong      uVar7;
    short      cMines;
    short      cMinesOp;
    short      iplr;

    uVar5 = (undefined2)((ulong)lppl >> 0x10);
    pPVar4 = (PLANET *)lppl;
    if (pPVar4->iPlayer == -1) {
        uVar3 = 0;
    } else {
        sVar1 = GetRaceStat((PLAYER *)rgplr + pPVar4->iPlayer, rsMajorAdv);
        if (sVar1 == raMacintosh) {
            _sqrt((double)pPVar4->rgwtMin[3]);
            lVar6 = __ftol((double)CONCAT26(cMinesOp, CONCAT24(cMines, CONCAT22(unaff_SI, unaff_DI))));
            uVar3 = (uint)lVar6;
        } else {
            uVar7 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), cMines);
            uVar2 = (uint)uVar7 & 0xfff;
            uVar3 = CMaxOperableMines((PLANET *)CONCAT42(CONCAT22(pPVar4->iPlayer, uVar5), pPVar4), pPVar4->iPlayer, 0);
            if ((int)uVar2 <= (int)uVar3) {
                uVar3 = uVar2;
            }
        }
    }
    return uVar3;
}

// ======================================================================
// Function: CFactoriesOperating
// Address: 1048:74be
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Variable defined which should be unmapped: cFactsOp */

short CFactoriesOperating(PLANET *lppl)

{
    int        iVar1;
    short      sVar2;
    uint       uVar3;
    uint       uVar4;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar5;
    ulong      uVar6;
    short      cFactsOp;
    short      cFacts;
    short      iplr;

    uVar6 = CONCAT22(unaff_SI, unaff_DI);
    uVar5 = (undefined2)((ulong)lppl >> 0x10);
    iVar1 = ((PLANET *)lppl)->iPlayer;
    if (iVar1 == -1) {
        uVar4 = 0;
    } else {
        sVar2 = GetRaceStat((PLAYER *)rgplr + iVar1, rsMajorAdv);
        if (sVar2 == raMacintosh) {
            uVar4 = 0;
        } else {
            uVar6 = __aFulshr(uVar6, cFactsOp);
            uVar3 = (uint)uVar6 & 0xfff;
            uVar4 = CMaxOperableFactories(lppl, ((PLANET *)lppl)->iPlayer, 0);
            if ((int)uVar3 <= (int)uVar4) {
                uVar4 = uVar3;
            }
        }
    }
    return uVar4;
}

// ======================================================================
// Function: CMaxFactories
// Address: 1048:755c
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x104875cb) */

short CMaxFactories(PLANET *lppl, short iplr)

{
    short sVar1;
    ulong uVar2;
    long  lVar3;
    short iEff;
    long  lPopMax;
    long  cMax;

    uVar2 = CalcPlanetMaxPop(lppl->id, iplr);
    sVar1 = GetRaceStat((PLAYER *)rgplr + iplr, rsFactOperate);
    lVar3 = 100;
    uVar2 = __aFulmul(uVar2, (long)sVar1);
    lVar3 = __aFldiv(uVar2, lVar3);
    if (lVar3 < 10) {
        lVar3 = 10;
    }
    sVar1 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv);
    cMax._0_2_ = (short)lVar3;
    if (sVar1 == raMacintosh) {
        cMax._0_2_ = 0;
    }
    return (short)cMax;
}

// ======================================================================
// Function: CMaxOperableFactories
// Address: 1048:7618
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x104876b9) */

short CMaxOperableFactories(PLANET *lppl, short iplr, short fNextYear)

{
    short      sVar1;
    short      sVar2;
    ulong      uVar3;
    long       lVar4;
    undefined2 uVar5;
    undefined2 uVar6;
    short      iEff;
    long       lPop;
    long       cCur;
    short      cMax;

    sVar1 = CMaxFactories(lppl, iplr);
    sVar2 = GetRaceStat((PLAYER *)rgplr + iplr, rsFactOperate);
    uVar3 = CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe), (int)((PLANET *)lppl)->rgwtMin[3]);
    if (fNextYear != 0) {
        lVar4 = ChgPopFromPlanet(lppl, 0);
        uVar3 = lVar4 + uVar3;
    }
    uVar6 = 0;
    uVar5 = 100;
    uVar3 = __aFulmul(uVar3, (long)sVar2);
    lVar4 = __aFldiv(uVar3, CONCAT22(uVar6, uVar5));
    cMax = (short)lVar4;
    if (sVar1 < lVar4) {
        cMax = sVar1;
    }
    if (cMax < 1) {
        cMax = 1;
    }
    sVar1 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv);
    if (sVar1 == raMacintosh) {
        cMax = 0;
    }
    return cMax;
}

// ======================================================================
// Function: CMaxDefenses
// Address: 1048:7710
// Segment: MEMORY_PLANET
// ======================================================================

short CMaxDefenses(PLANET *lppl, short iplr)

{
    short sVar1;
    int   iVar2;
    short pctDesire;
    short cMax;

    sVar1 = PctPlanetDesirability(lppl, iplr);
    if (sVar1 * 4 < 10) {
        iVar2 = 10;
    } else {
        iVar2 = sVar1 << 2;
    }
    if (iVar2 < 0x65) {
        if (sVar1 * 4 < 10) {
            cMax = 10;
        } else {
            cMax = sVar1 << 2;
        }
    } else {
        cMax = 100;
    }
    sVar1 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv);
    if (sVar1 == raMacintosh) {
        cMax = 0;
    }
    return cMax;
}

// ======================================================================
// Function: CMaxOperableDefenses
// Address: 1048:77ae
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x1048782c) */

short CMaxOperableDefenses(PLANET *lppl, short iplr, short fNextYear)

{
    short sVar1;
    long  lVar2;
    long  lVar3;
    long  lPop;
    long  cCur;
    short cMax;

    cMax = CMaxDefenses(lppl, iplr);
    lVar3 = CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe), (int)((PLANET *)lppl)->rgwtMin[3]);
    if (fNextYear != 0) {
        lVar2 = ChgPopFromPlanet(lppl, 0);
        lVar3 = lVar2 + lVar3;
    }
    lVar3 = __aFldiv(lVar3 + 0x18, 0x19);
    if (1000 < lVar3) {
        lVar3 = 1000;
    }
    cCur._0_2_ = (int)lVar3;
    if ((int)cCur <= cMax) {
        cMax = (int)cCur;
    }
    sVar1 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv);
    if (sVar1 == raMacintosh) {
        cMax = 0;
    }
    return cMax;
}

// ======================================================================
// Function: CResourcesAtPlanet
// Address: 1048:788e
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x1048790a) */
/* WARNING: Removing unreachable block (ram,0x10487954) */

short CResourcesAtPlanet(PLANET *lppl, short iplr)

{
    uint       uVar1;
    int        iVar2;
    short      sVar3;
    short      sVar4;
    PLANET    *pPVar5;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar6;
    long       lVar7;
    ulong      uVar8;
    long       lVar9;
    undefined8 uVar10;
    ushort     in_stack_0000ffca;
    long       local_26;
    long       local_1e;
    short      iEnergy;
    short      pctVal;
    short      iEff;
    long       lPopMax;
    short      cFact;
    long       lPop;
    short      cRes;

    uVar6 = (undefined2)((ulong)lppl >> 0x10);
    pPVar5 = (PLANET *)lppl;
    if (((int)pPVar5->rgwtMin[3] == 0) && (*(int *)((int)pPVar5->rgwtMin + 0xe) == 0)) {
        cRes = 0;
    } else {
        sVar3 = GetRaceStat((PLAYER *)rgplr + iplr, rsResGen);
        uVar1 = *(uint *)(pPVar5->rgwtMin + 3);
        iVar2 = *(int *)((int)pPVar5->rgwtMin + 0xe);
        lPop = CONCAT22(iVar2, uVar1);
        lVar7 = CalcPlanetMaxPop(lppl->id, iplr);
        if (lVar7 < lPop) {
            lVar9 = __aFldiv((long)CONCAT62(CONCAT42(2, (iVar2 - (int)((ulong)lVar7 >> 0x10)) - (uint)(uVar1 < (uint)lVar7)), uVar1 - (uint)lVar7), 2);
            lPop = lVar7 + lVar9;
            lVar7 = __aFlshl(CONCAT22(unaff_SI, unaff_DI), in_stack_0000ffca);
            if (lVar7 < lPop) {
                lPop = __aFlshl(CONCAT22(unaff_SI, unaff_DI), in_stack_0000ffca);
            }
        }
        sVar4 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv);
        if (sVar4 == raMacintosh) {
            iEnergy = (short)*(char *)((int)rgplr[0].rgTech + iplr * 0xc0);
            PctPlanetDesirability((PLANET *)CONCAT42(CONCAT22(iplr, uVar6), pPVar5), iplr);
            if (iEnergy < 1) {
                iEnergy = 1;
            }
            local_1e = (long)iEnergy;
            local_26 = (long)sVar3;
            _sqrt(((double)local_1e * (double)lPop) / (double)local_26);
            lVar7 = __ftol((double)(ulonglong)CONCAT24(10, CONCAT22(unaff_SI, unaff_DI)));
            cRes = (short)lVar7;
        } else {
            lVar7 = __aFldiv((long)CONCAT62(CONCAT42((long)sVar3, lPop._2_2_), (undefined2)lPop), (long)sVar3);
            cFact = CMaxOperableFactories((PLANET *)CONCAT42(CONCAT22(iplr, uVar6), pPVar5), iplr, 0);
            uVar8 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), in_stack_0000ffca);
            if ((int)((uint)uVar8 & 0xfff) < cFact) {
                uVar8 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), in_stack_0000ffca);
                cFact = (uint)uVar8 & 0xfff;
            }
            sVar3 = GetRaceStat((PLAYER *)rgplr + iplr, rsFactProd);
            uVar10 = CONCAT62(CONCAT42(10, sVar3 >> 0xf), sVar3);
            uVar8 = __aFulmul((long)cFact, (ulong)uVar10);
            lVar9 = (long)((ulonglong)uVar10 >> 0x20);
            lVar9 = __aFldiv((long)CONCAT62(CONCAT42(lVar9, (int)(uVar8 + 9 >> 0x10)), (int)(uVar8 + 9)), lVar9);
            cRes = (int)lVar7 + (int)lVar9;
        }
        if (cRes == 0) {
            cRes = 1;
        }
    }
    return cRes;
}

// ======================================================================
// Function: IWarpMAFromLppl
// Address: 1048:7b10
// Segment: MEMORY_PLANET
// ======================================================================

short IWarpMAFromLppl(PLANET *lppl, short *pfTwo)

{
    undefined2 uVar1;
    int        iVar2;
    PLANET    *pPVar3;
    int        iVar4;
    undefined2 uVar5;
    short      iNew;
    HUL       *lphul;
    short      i;
    short      iWarp;
    short      fTwo;

    iWarp = 0;
    fTwo = 0;
    if (pfTwo != (short *)0x0) {
        *pfTwo = 0;
    }
    uVar5 = (undefined2)((ulong)lppl >> 0x10);
    pPVar3 = (PLANET *)lppl;
    if ((pPVar3->iPlayer == -1) || ((pPVar3->wFlags_0x4 >> 9 & 1) == 0)) {
        iWarp = 0;
    } else if ((pPVar3->iPlayer == idPlayer) ||
               ((idPlayer == -1 ||
                 (iVar4 = pPVar3->iPlayer * 4, (*(uint *)(*(int *)(iVar4 + rglpshdefSB) + (*(uint *)&pPVar3->lStarbase & 0xf) * 0x93 + 0x7b) & 0xff) == 7)))) {
        iVar4 = pPVar3->iPlayer * 4;
        uVar1 = *(undefined2 *)(iVar4 + rglpshdefSB_0x2);
        iVar4 = *(int *)(iVar4 + rglpshdefSB) + (*(uint *)&pPVar3->lStarbase & 0xf) * 0x93;
        for (i = 0; i < (int)(uint) * (byte *)(iVar4 + 0x7a); i = i + 1) {
            if ((((*(int *)(iVar4 + 0x3a + i * 4) == 0x200) && (*(uint *)(iVar4 + i * 4 + 0x3c) >> 8 != 0)) &&
                 (6 < (*(uint *)(iVar4 + i * 4 + 0x3c) & 0xff))) &&
                ((*(uint *)(iVar4 + i * 4 + 0x3c) & 0xff) < 0x10)) {
                iVar2 = (*(uint *)(iVar4 + i * 4 + 0x3c) & 0xff) - 2;
                if (iWarp < iVar2) {
                    fTwo = 0;
                    iWarp = iVar2;
                } else if (iVar2 == iWarp) {
                    fTwo = 1;
                }
            }
        }
        if (pfTwo != (short *)0x0) {
            *pfTwo = fTwo;
        }
    } else {
        iWarp = 0;
    }
    return iWarp;
}

// ======================================================================
// Function: StargateRangeFromLppl
// Address: 1048:7cfa
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10487e13) */

short StargateRangeFromLppl(PLANET *lppl, short iplr, short ish)

{
    int        iVar1;
    HUL       *pHVar2;
    undefined2 uVar3;
    PART       part;
    HUL       *lphul;
    short      i;

    if (lppl == (PLANET *)0x0) {
        lphul = (HUL *)CONCAT22(*(undefined2 *)(iplr * 4 + rglpshdefSB_0x2), (HUL *)(*(int *)(iplr * 4 + rglpshdefSB) + ish * 0x93));
    } else {
        if ((((PLANET *)lppl)->iPlayer == -1) || ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0)) {
            return 0;
        }
        iVar1 = ((PLANET *)lppl)->iPlayer * 4;
        lphul = (HUL *)CONCAT22(*(undefined2 *)(iVar1 + rglpshdefSB_0x2),
                                (HUL *)(*(int *)(iVar1 + rglpshdefSB) + (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93));
    }
    i = 0;
    while (true) {
        uVar3 = (undefined2)((ulong)lphul >> 0x10);
        pHVar2 = (HUL *)lphul;
        if ((int)(uint)pHVar2->chs <= i) {
            return 0;
        }
        if ((((pHVar2->rghs + i)->grhst == hstSpecialSB) && (pHVar2->rghs[i].wFlags_0x2 >> 8 != 0)) && ((pHVar2->rghs[i].wFlags_0x2 & 0xff) < 7))
            break;
        i = i + 1;
    }
    part.hs.grhst = (pHVar2->rghs + i)->grhst;
    part.hs.wFlags_0x2 = pHVar2->rghs[i].wFlags_0x2;
    FLookupPart(&part);
    if (((BEAM *)part.u_PART_0x0004.pbeam)->dp != -1) {
        return ((BEAM *)part.u_PART_0x0004.pbeam)->dp;
    }
    return 10000;
}

// ======================================================================
// Function: FProdIsTerra
// Address: 1048:7e9a
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10487f40) */
/* WARNING: Removing unreachable block (ram,0x10487ec8) */

short FProdIsTerra(PROD *lpprod)

{
    short      sVar1;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    ulong      uVar2;
    ulong      uVar3;
    ushort     in_stack_0000fffc;

    uVar3 = CONCAT22(unaff_SI, unaff_DI);
    uVar2 = __aFulshr(uVar3, in_stack_0000fffc);
    if ((((uint)uVar2 & 7) == 1) && (((uVar2 = __aFulshr(uVar3, in_stack_0000fffc),
                                       ((uint)uVar2 & 0x7f) == 0xc || (uVar2 = __aFulshr(uVar3, in_stack_0000fffc), ((uint)uVar2 & 0x7f) == 4)) ||
                                      (uVar2 = __aFulshr(uVar3, in_stack_0000fffc), ((uint)uVar2 & 0x7f) == 5)))) {
        sVar1 = 1;
    } else {
        sVar1 = 0;
    }
    return sVar1;
}

// ======================================================================
// Function: IpctCanTerraformLppl
// Address: 1048:7f56
// Segment: MEMORY_PLANET
// ======================================================================

short IpctCanTerraformLppl(PLANET *lppl)

{
    short sVar1;
    short ipct;
    short rgCost[3];
    short rgMin[3];
    short i;
    short rgMax[3];

    sVar1 = FCanTerraformLppl(lppl, rgMin, rgMax, rgCost, 1);
    if (sVar1 == 0) {
        ipct = 0;
    } else {
        ipct = 0;
        for (i = 0; i < 3; i = i + 1) {
            if (rgMin[i] != -1) {
                ipct = ipct + ((int)((PLANET *)lppl)->rgEnvVar[i] - rgMin[i]);
            }
            if (rgMax[i] != -1) {
                ipct = ipct + (rgMax[i] - (int)((PLANET *)lppl)->rgEnvVar[i]);
            }
        }
    }
    return ipct;
}

// ======================================================================
// Function: FCanTerraformLppl
// Address: 1048:8022
// Segment: MEMORY_PLANET
// ======================================================================

short FCanTerraformLppl(PLANET *lppl, short *rgEnvMin, short *rgEnvMax, short *rgEnvCost, short fHelp)

{
    bool       bVar1;
    short      sVar2;
    short      sVar3;
    uint       uVar4;
    int        iVar5;
    PLANET    *pPVar6;
    ARMOR     *pAVar7;
    undefined2 uVar8;
    undefined2 uVar9;
    short      ienvIdeal;
    short      dCur;
    short      dMax;
    short      dMin;
    PART       part;
    short      iPlrSav;
    short      rgMove[3];
    short      i;
    short      fRet;

    sVar2 = idPlayer;
    pPVar6 = (PLANET *)lppl;
    uVar8 = (undefined2)((ulong)lppl >> 0x10);
    if (idPlayer == -1) {
        idPlayer = pPVar6->iPlayer;
    }
    part.hs.grhst = hstTerra;
    for (i = 7; -1 < i; i = i + -1) {
        part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | i & 0xffU;
        sVar3 = FLookupPart(&part);
        if (sVar3 == 1)
            break;
    }
    if (i < 0) {
        bVar1 = false;
        for (i = 0; i < 3; i = i + 1) {
            rgMove[i] = 0;
        }
    } else {
        bVar1 = true;
        for (i = 0; i < 3; i = i + 1) {
            rgMove[i] = ((ARMOR *)part.u_PART_0x0004.parmor)->dp;
            rgEnvCost[i] = ((ARMOR *)part.u_PART_0x0004.parmor)->resCost;
        }
    }
    for (i = 3; -1 < i; i = i + -1) {
        part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | i + 8U & 0xff;
        sVar3 = FLookupPart(&part);
        if (sVar3 == 1)
            break;
    }
    if (-1 < i) {
        uVar9 = part.u_PART_0x0004._2_2_;
        pAVar7 = (ARMOR *)part.u_PART_0x0004.parmor;
        if (rgMove[0] < pAVar7->dp) {
            bVar1 = true;
            rgMove[0] = pAVar7->dp;
            *rgEnvCost = pAVar7->resCost;
        }
    }
    for (i = 3; -1 < i; i = i + -1) {
        part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | i + 0xcU & 0xff;
        sVar3 = FLookupPart(&part);
        if (sVar3 == 1)
            break;
    }
    if (-1 < i) {
        uVar9 = part.u_PART_0x0004._2_2_;
        pAVar7 = (ARMOR *)part.u_PART_0x0004.parmor;
        if (rgMove[1] < pAVar7->dp) {
            bVar1 = true;
            rgMove[1] = pAVar7->dp;
            rgEnvCost[1] = pAVar7->resCost;
        }
    }
    for (i = 3; -1 < i; i = i + -1) {
        part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | i + 0x10U & 0xff;
        sVar3 = FLookupPart(&part);
        if (sVar3 == 1)
            break;
    }
    if (-1 < i) {
        uVar9 = part.u_PART_0x0004._2_2_;
        pAVar7 = (ARMOR *)part.u_PART_0x0004.parmor;
        if (rgMove[2] < pAVar7->dp) {
            bVar1 = true;
            rgMove[2] = pAVar7->dp;
            rgEnvCost[2] = pAVar7->resCost;
        }
    }
    if (bVar1) {
        for (i = 0; i < 3; i = i + 1) {
            if ((rgMove[i] == 0) || (*(char *)(idPlayer * 0xc0 + 0x59b5 + i) == -1)) {
                rgEnvMax[i] = -1;
                rgEnvMin[i] = -1;
            } else {
                rgEnvMin[i] = (int)pPVar6->rgEnvVarOrig[i] - rgMove[i];
                rgEnvMax[i] = (int)pPVar6->rgEnvVarOrig[i] + rgMove[i];
                if (rgEnvMin[i] < (int)pPVar6->rgEnvVar[i]) {
                    if (rgEnvMin[i] < 1) {
                        sVar3 = 1;
                    } else {
                        sVar3 = rgEnvMin[i];
                    }
                    rgEnvMin[i] = sVar3;
                } else {
                    rgEnvMin[i] = -1;
                }
                if ((int)pPVar6->rgEnvVar[i] < rgEnvMax[i]) {
                    if (rgEnvMax[i] < 100) {
                        sVar3 = rgEnvMax[i];
                    } else {
                        sVar3 = 99;
                    }
                    rgEnvMax[i] = sVar3;
                } else {
                    rgEnvMax[i] = -1;
                }
                if (fHelp == 0) {
                    iVar5 = (int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
                    sVar3 = _abs(pPVar6->rgEnvVar[i] - iVar5);
                    if (rgEnvMin[i] == -1) {
                        dMin = 0;
                    } else {
                        dMin = _abs(rgEnvMin[i] - iVar5);
                    }
                    if (rgEnvMax[i] == -1) {
                        dMax = 0;
                    } else {
                        dMax = _abs(rgEnvMax[i] - iVar5);
                    }
                    if ((sVar3 < dMin) || (sVar3 < dMax)) {
                        if (dMin < dMax) {
                            rgEnvMin[i] = -1;
                        } else {
                            rgEnvMax[i] = -1;
                        }
                    } else {
                        rgEnvMax[i] = -1;
                        rgEnvMin[i] = -1;
                    }
                } else if (pPVar6->rgEnvVar[i] == *(char *)(idPlayer * 0xc0 + 0x59b2 + i)) {
                    rgEnvMax[i] = -1;
                    rgEnvMin[i] = -1;
                } else if (*(char *)(idPlayer * 0xc0 + 0x59b2 + i) < pPVar6->rgEnvVar[i]) {
                    rgEnvMax[i] = -1;
                    if (rgEnvMin[i] != -1) {
                        if ((int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i) < rgEnvMin[i]) {
                            iVar5 = rgEnvMin[i];
                        } else {
                            iVar5 = (int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
                        }
                        rgEnvMin[i] = iVar5;
                    }
                } else {
                    rgEnvMin[i] = -1;
                    if (rgEnvMax[i] != -1) {
                        if (rgEnvMax[i] < (int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i)) {
                            iVar5 = rgEnvMax[i];
                        } else {
                            iVar5 = (int)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
                        }
                        rgEnvMax[i] = iVar5;
                    }
                }
            }
        }
        for (i = 0; ((i < 3 && (rgEnvMax[i] == -1)) && (rgEnvMin[i] == -1)); i = i + 1) {
        }
        uVar4 = (uint)(i != 3);
    } else {
        uVar4 = 0;
    }
    idPlayer = sVar2;
    return uVar4;
}

// ======================================================================
// Function: UninhabitPlanet
// Address: 1048:8732
// Segment: MEMORY_PLANET
// ======================================================================

void UninhabitPlanet(PLANET *lppl)

{
    int        iVar1;
    uint       uVar2;
    undefined2 uVar3;
    PLANET    *pPVar4;
    short      sVar5;
    PLANET    *pPVar6;
    undefined2 uVar7;
    short      i;

    uVar7 = (undefined2)((ulong)lppl >> 0x10);
    pPVar6 = (PLANET *)lppl;
    if ((-1 < pPVar6->iPlayer) && (sVar5 = GetRaceStat((PLAYER *)rgplr + pPVar6->iPlayer, rsMajorAdv), sVar5 == raTerra)) {
        for (i = 0; i < 3; i = i + 1) {
            pPVar6->rgEnvVar[i] = pPVar6->rgEnvVarOrig[i];
        }
    }
    pPVar6->iPlayer = -1;
    *(undefined2 *)(pPVar6->rgwtMin + 3) = 0;
    *(undefined2 *)((int)pPVar6->rgwtMin + 0xe) = 0;
    if ((*(int *)&pPVar6->lpplprod != 0) || (*(int *)((int)&pPVar6->lpplprod + 2) != 0)) {
        FreePl((PL *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lpPlanets)[lppl->id].lpplprod + 2), *(PL **)&((PLANET *)lpPlanets)[lppl->id].lpplprod));
        uVar3 = lpPlanets._2_2_;
        pPVar4 = (PLANET *)lpPlanets;
        iVar1 = lppl->id;
        *(undefined2 *)&((PLANET *)lpPlanets)[iVar1].lpplprod = 0;
        *(undefined2 *)((int)&pPVar4[iVar1].lpplprod + 2) = 0;
        *(undefined2 *)&pPVar6->lpplprod = 0;
        *(undefined2 *)((int)&pPVar6->lpplprod + 2) = 0;
    }
    uVar2 = *(uint *)(pPVar6->rgbImp + 6);
    *(undefined2 *)(pPVar6->rgbImp + 4) = *(undefined2 *)(pPVar6->rgbImp + 4);
    *(uint *)(pPVar6->rgbImp + 6) = uVar2 & 0xff7f;
    pPVar6->wFlags_0x4 = pPVar6->wFlags_0x4 & 0xfdff;
    uVar3 = *(undefined2 *)(pPVar6->rgbImp + 6);
    *(uint *)(pPVar6->rgbImp + 4) = *(uint *)(pPVar6->rgbImp + 4) & 0xf000;
    *(undefined2 *)(pPVar6->rgbImp + 6) = uVar3;
    uVar2 = *(uint *)(pPVar6->rgbImp + 6);
    *(uint *)(pPVar6->rgbImp + 4) = *(uint *)(pPVar6->rgbImp + 4) & 0xfff | 0xf000;
    *(uint *)(pPVar6->rgbImp + 6) = uVar2 & 0xfffe | 1;
    *(undefined2 *)&pPVar6->lStarbase = 0;
    *(undefined2 *)((int)&pPVar6->lStarbase + 2) = 0;
    return;
}

// ======================================================================
// Function: PctCloakFromHuldef
// Address: 1048:88c0
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10488a4b) */

short PctCloakFromHuldef(HUL *lphul, short iplr, short *ppctSteal)

{
    int        iVar1;
    byte       bVar2;
    uint       uVar3;
    short      sVar4;
    undefined2 uVar5;
    bool       bVar6;
    short      j;
    short      cScore;
    long       cPts;
    HS        *lphs;
    short      chs;

    uVar5 = (undefined2)((ulong)lphul >> 0x10);
    bVar2 = ((HUL *)lphul)->chs;
    if (((iplr == -1) || ((int)lphul->ihuldef < 0x20)) || (sVar4 = GetRaceGrbit((PLAYER *)rgplr + iplr, ibitRaceISB), sVar4 == 0)) {
        cPts._0_2_ = 0;
    } else {
        cPts._0_2_ = 0x28;
    }
    cPts._2_2_ = 0;
    if ((iplr != -1) && (sVar4 = GetRaceStat((PLAYER *)rgplr + iplr, rsMajorAdv), sVar4 == raStealth)) {
        bVar6 = 0xfed3 < (uint)cPts;
        cPts._0_2_ = (uint)cPts + 300;
        cPts._2_2_ = (uint)bVar6;
    }
    if (ppctSteal != (short *)0x0) {
        *ppctSteal = 0;
    }
    lphs = (HS *)CONCAT22(uVar5, ((HUL *)lphul)->rghs);
    for (j = 0; j < (int)(uint)bVar2; j = j + 1) {
        uVar3 = CPtsCloakFromLphs(lphs);
        bVar6 = CARRY2((uint)cPts, uVar3);
        cPts._0_2_ = (uint)cPts + uVar3;
        cPts._2_2_ = cPts._2_2_ + ((int)uVar3 >> 0xf) + (uint)bVar6;
        if ((lphs->grhst == hstScanner) && (ppctSteal != (short *)0x0)) {
            if ((((HS *)lphs)->wFlags_0x2 & 0xff) == 5) {
                if (*ppctSteal < 0x46) {
                    *ppctSteal = 0x46;
                }
            } else if (((((HS *)lphs)->wFlags_0x2 & 0xff) == 0xe) && (*ppctSteal < 0x50)) {
                *ppctSteal = 0x50;
            }
        }
        lphs = (HS *)lphs + 1;
    }
    if (((uint)cPts == 0) && (cPts._2_2_ == 0)) {
        sVar4 = 0;
    } else if (((int)cPts._2_2_ < 0) || ((-1 < (int)cPts._2_2_ && ((0 < (int)cPts._2_2_ || (25000 < (uint)cPts)))))) {
        sVar4 = 0;
    } else if ((int)(uint)cPts < 0x65) {
        sVar4 = (int)(uint)cPts >> 1;
    } else if ((int)((uint)cPts - 100) < 0xc9) {
        sVar4 = ((int)((uint)cPts - 100) >> 3) + 0x32;
    } else if ((int)((uint)cPts - 300) < 0x139) {
        sVar4 = (int)((uint)cPts - 300) / 0x18 + 0x4b;
    } else {
        iVar1 = (uint)cPts - 0x264;
        if (iVar1 < 0x201) {
            sVar4 = (iVar1 >> 6) + 0x58;
        } else if (iVar1 < 1000) {
            sVar4 = (0x2ff < iVar1) + 0x60;
        } else {
            sVar4 = 0x62;
        }
    }
    return sVar4;
}

// ======================================================================
// Function: LogSplitFleet
// Address: 1048:8b0e
// Segment: MEMORY_PLANET
// ======================================================================

void LogSplitFleet(short id)

{
    FLEET     *pFVar1;
    undefined4 local_8;

    if (((uint)gd.grBits >> 1 & 1) == 0) {
        WriteMemRt(0x18, 2, &id);
    } else {
        pFVar1 = LpflFromId(id);
        local_8 = (uint *)CONCAT22((int)((ulong)pFVar1 >> 0x10), (uint *)((int)&((FLEET *)pFVar1)->dirLong + 2));
        *local_8 = *local_8 & 0xffdf | 0x20;
    }
    return;
}

// ======================================================================
// Function: LogMergeFleet
// Address: 1048:8b6c
// Segment: MEMORY_PLANET
// ======================================================================

void LogMergeFleet(short id)

{
    short  j;
    ushort rgid[512];
    short  i;
    ushort idCur;

    if (((uint)gd.grBits >> 1 & 1) == 0) {
        i = 0;
        while (i < vcflMerge) {
            rgid[0] = id;
            j = 1;
            for (; (j < 0x1ff && (i < vcflMerge)); i = i + 1) {
                if ((vrgiflMerge[i] != -1) && (vrgiflMerge[i] != id)) {
                    rgid[j] = vrgiflMerge[i];
                    j = j + 1;
                }
            }
            WriteMemRt(0x25, j << 1, rgid);
        }
    }
    return;
}

// ======================================================================
// Function: LogChangeShDef
// Address: 1048:8c28
// Segment: MEMORY_PLANET
// ======================================================================

void LogChangeShDef(SHDEF *lpshdefNew)

{
    uint       uVar1;
    uint       uVar2;
    SHDEF     *pSVar3;
    undefined2 uVar4;
    byte      *pb;
    byte       rgb[149];

    if (((uint)gd.grBits >> 1 & 1) == 0) {
        uVar4 = (undefined2)((ulong)lpshdefNew >> 0x10);
        pSVar3 = (SHDEF *)lpshdefNew;
        uVar1 = (pSVar3->wFlags >> 10 & 0x1f) << 8;
        uVar2 = (idPlayer & 0xfU) << 4;
        if ((pSVar3->wFlags >> 9 & 1) == 0) {
            rgb._0_2_ = rgb._0_2_ & 0xe000 | uVar1 | uVar2 | 1;
            pSVar3->wFlags = pSVar3->wFlags & 0xff00 | 7;
            pb = rgb + 2;
            WriteRtShDef(lpshdefNew, &pb);
            WriteMemRt(0x1b, (int)pb - (int)rgb, rgb);
        } else {
            rgb._0_2_ = rgb._0_2_ & 0xe000 | uVar1 | uVar2;
            WriteMemRt(0x1b, 2, rgb);
        }
        if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
            tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
            AdvanceTutor();
        }
    }
    return;
}

// ======================================================================
// Function: LogChangeName
// Address: 1048:8d5a
// Segment: MEMORY_PLANET
// ======================================================================

void LogChangeName(GrobjClass grobj, short id, char *szName)

{
    ushort     uVar1;
    short      sVar2;
    int        iVar3;
    FLEET     *pFVar4;
    undefined2 uVar5;
    undefined2 unaff_SS;
    void      *pvVar6;
    HeapType   ht;
    RTCHGNAME  rtchgname;
    short      cOut;
    FLEET     *lpfl;

    lpfl = LpflFromId(id);
    iVar3 = (int)((ulong)lpfl >> 0x10);
    pFVar4 = (FLEET *)lpfl;
    if ((pFVar4 != (FLEET *)0x0) || (iVar3 != 0)) {
        if ((*(int *)&pFVar4->lpszName != 0) || (*(int *)((int)&pFVar4->lpszName + 2) != 0)) {
            /* WARNING: Load size is inaccurate */
            FreeLp((void *)CONCAT22(*(undefined2 *)((int)&pFVar4->lpszName + 2), pFVar4->lpszName), htString);
        }
        if ((szName == (char *)0x0) || (*szName == '\0')) {
            rtchgname.rgb[0] = 0;
            rtchgname.rgb[1] = 0;
            cOut = 1;
            uVar5 = (undefined2)((ulong)lpfl >> 0x10);
            *(undefined2 *)&((FLEET *)lpfl)->lpszName = 0;
            *(undefined2 *)((int)&((FLEET *)lpfl)->lpszName + 2) = 0;
        } else {
            cOut = _strlen(szName);
            ht = htString;
            uVar1 = _strlen(szName);
            pvVar6 = LpAlloc(uVar1 + 1, ht);
            uVar5 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar4 = (FLEET *)lpfl;
            *(void **)&pFVar4->lpszName = (void *)pvVar6;
            *(undefined2 *)((int)&pFVar4->lpszName + 2) = (int)((ulong)pvVar6 >> 0x10);
            /* WARNING: Load size is inaccurate */
            __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&pFVar4->lpszName + 2), pFVar4->lpszName), szName);
            sVar2 = FCompressUserString(szName, (char *)(rtchgname.rgb + 1), &cOut);
            if (sVar2 == 0) {
                rtchgname.rgb[0] = 0;
                _strcpy(rtchgname.rgb + 1, szName);
                cOut = cOut + 1;
            } else {
                rtchgname.rgb[0] = (byte)cOut;
            }
        }
        rtchgname.grobj = grobj;
        rtchgname.id = id;
        WriteMemRt(0x2c, cOut + 5, &rtchgname);
        if (((uint)gd.grBits >> 0xb & 1) != 0) {
            AdvanceTutor();
        }
    }
    return;
}

// ======================================================================
// Function: LogChangeFleet
// Address: 1048:8ebe
// Segment: MEMORY_PLANET
// ======================================================================

void LogChangeFleet(FLEET *pfl, FLEET *pflNew)

{
    uint      *puVar1;
    short     *psVar2;
    LOGXFERF  *pLVar3;
    LOGXFER   *pLVar4;
    undefined2 uVar5;
    int        iVar6;
    uint       uVar7;
    short      sVar8;
    uint       uVar9;
    short     *psVar10;
    uint      *puVar11;
    LOGXFERF  *pLVar12;
    LOGXFER   *pLVar13;
    uint      *puVar14;
    undefined2 unaff_SS;
    undefined1 local_2e[13];
    char       cStack_21;
    GrobjClass local_20;
    uint       local_1e[10];
    short      fChg;
    short      i;
    short      d;

    fChg = 0;
    if (((uint)gd.grBits >> 1 & 1) == 0) {
        local_2e._0_2_ = pfl->id;
        local_2e._2_2_ = grobjFleet;
        i = 0;
        while (true) {
            if (0xf < i)
                break;
            iVar6 = pflNew->rgcsh[i] - ((FLEET *)pfl)->rgcsh[i];
            *(int *)(local_2e + i * 2 + 4) = iVar6;
            if (iVar6 != 0) {
                fChg = 1;
            }
            i = i + 1;
        }
        if (fChg == 0) {
            stack0xffde = pfl->id;
            local_20 = grobjFleet;
            for (i = 0; sVar8 = i, i < 5; i = i + 1) {
                uVar9 = *(uint *)(pflNew->rgwtMin + i);
                puVar1 = (uint *)(((FLEET *)pfl)->rgwtMin + i);
                uVar7 = uVar9 - *puVar1;
                uVar9 = (*(uint *)((int)(pflNew->rgwtMin + i) + 2) - *(uint *)((int)(((FLEET *)pfl)->rgwtMin + i) + 2)) - (uint)(uVar9 < *puVar1);
                local_1e[i * 2] = uVar7;
                local_1e[sVar8 * 2 + 1] = uVar9;
                if ((uVar7 != 0) || (uVar9 != 0)) {
                    fChg = 1;
                }
            }
            if (fChg == 0) {
                local_2e._4_2_ = ZEXT12(((FLEET *)pfl)->iplan);
                if (local_2e._4_2_ != (uint)pflNew->iplan) {
                    local_2e._10_2_ = pflNew->id;
                    register0x00000000 = (uint)pflNew->iplan;
                    WriteMemRt(0x2a, 4, local_2e + 10);
                }
                if ((((FLEET *)pfl)->wFlags_0x4 >> 9 & 1) != (pflNew->wFlags_0x4 >> 9 & 1)) {
                    local_2e._10_2_ = pflNew->id;
                    register0x00000000 = pflNew->wFlags_0x4 >> 9 & 1;
                    WriteMemRt(10, 4, local_2e + 10);
                }
                d = pflNew->cord - ((FLEET *)pfl)->cord;
                for (local_2e._6_2_ = 0; ((int)local_2e._6_2_ < ((FLEET *)pfl)->cord && ((int)local_2e._6_2_ < pflNew->cord));
                     local_2e._6_2_ = local_2e._6_2_ + 1) {
                    local_2e._4_2_ = *(uint *)((int)&pflNew->lpplord + 2);
                    local_2e._2_2_ = *(int *)&pflNew->lpplord + grobjOther;
                    local_2e._0_2_ = *(short *)((int)&((FLEET *)pfl)->lpplord + 2);
                    sVar8 = __fmemcmp((void *)CONCAT22(local_2e._0_2_, (void *)(*(int *)&((FLEET *)pfl)->lpplord + 4 + local_2e._6_2_ * 0x12)),
                                      (void *)CONCAT22(local_2e._4_2_, (void *)(local_2e._2_2_ + local_2e._6_2_ * 0x12)), 0x12);
                    if (sVar8 != 0)
                        break;
                }
                local_2e._8_2_ = local_2e._6_2_;
                if ((local_2e._6_2_ != ((FLEET *)pfl)->cord) || (d != 0)) {
                    if (d < 0) {
                        local_2e._10_2_ = pflNew->id;
                        stack0xffde = local_2e._6_2_;
                        if (d == -2) {
                            unique0x0000a200 = local_2e._6_2_ | 0x8000;
                        }
                        WriteMemRt(3, 4, local_2e + 10);
                    } else if (d < 1) {
                        local_2e._4_2_ = 0x16;
                        sVar8 = FGetPrevLogRt(local_2e + 2, (byte *)rgbCur);
                        if ((((sVar8 != 0) && ((uint)local_2e._2_2_ >> 10 == 5)) && (rgbCur._0_2_ == pflNew->id)) && (rgbCur._2_2_ == local_2e._8_2_)) {
                            imemLogCur = imemLogPrev;
                        }
                        local_20 = pflNew->id;
                        local_1e[0] = local_2e._8_2_;
                        uVar5 = *(undefined2 *)((int)&pflNew->lpplord + 2);
                        puVar11 = (uint *)(*(int *)&pflNew->lpplord + 4 + local_2e._8_2_ * 0x12);
                        puVar14 = local_1e;
                        for (iVar6 = 9; puVar14 = puVar14 + 1, iVar6 != 0; iVar6 = iVar6 + -1) {
                            puVar1 = puVar11;
                            puVar11 = puVar11 + 1;
                            *puVar14 = *puVar1;
                        }
                        local_2e._0_2_ = &local_20;
                        iVar6 = local_2e._4_2_;
                        do {
                            local_2e._4_2_ = iVar6;
                            if ((int)local_2e._4_2_ < 1)
                                break;
                            iVar6 = local_2e._4_2_ + -1;
                        } while (*(char *)(local_2e._0_2_ + local_2e._4_2_ + -1) == '\0');
                        WriteMemRt(5, local_2e._4_2_, &local_20);
                    } else {
                        local_2e._4_2_ = 0x16;
                        local_20 = pflNew->id;
                        local_1e[0] = local_2e._6_2_;
                        uVar5 = *(undefined2 *)((int)&pflNew->lpplord + 2);
                        puVar11 = (uint *)(*(int *)&pflNew->lpplord + 4 + local_2e._6_2_ * 0x12);
                        puVar14 = local_1e;
                        for (iVar6 = 9; puVar14 = puVar14 + 1, iVar6 != 0; iVar6 = iVar6 + -1) {
                            puVar1 = puVar11;
                            puVar11 = puVar11 + 1;
                            *puVar14 = *puVar1;
                        }
                        local_2e._2_2_ = &local_20;
                        iVar6 = local_2e._4_2_;
                        do {
                            local_2e._4_2_ = iVar6;
                            if ((int)local_2e._4_2_ < 1)
                                break;
                            iVar6 = local_2e._4_2_ + -1;
                        } while (*(char *)(local_2e._2_2_ + local_2e._4_2_ + -1) == '\0');
                        WriteMemRt(4, local_2e._4_2_, &local_20);
                    }
                }
            } else if (fValidLx == 0) {
                psVar10 = local_2e + 0xc;
                pLVar13 = (LOGXFER *)&lx;
                for (iVar6 = 0xc; iVar6 != 0; iVar6 = iVar6 + -1) {
                    pLVar4 = pLVar13;
                    pLVar13 = &pLVar13->grobj;
                    psVar2 = psVar10;
                    psVar10 = psVar10 + 1;
                    pLVar4->id = *psVar2;
                }
                fValidLx = 1;
            } else {
                LogMakeValidXfer((LOGXFER *)&lx, local_2e + 0xc);
                fValidLx = 0;
            }
        } else if (fValidLxf == 0) {
            psVar10 = local_2e;
            pLVar12 = (LOGXFERF *)&lxf;
            for (iVar6 = 0x12; iVar6 != 0; iVar6 = iVar6 + -1) {
                pLVar3 = pLVar12;
                pLVar12 = &pLVar12->grobj;
                psVar2 = psVar10;
                psVar10 = psVar10 + 1;
                pLVar3->id = *psVar2;
            }
            fValidLxf = 1;
        } else {
            LogMakeValidXferf((LOGXFERF *)&lxf, local_2e);
            fValidLxf = 0;
        }
    }
    return;
}

// ======================================================================
// Function: LogChangeRelations
// Address: 1048:9340
// Segment: MEMORY_PLANET
// ======================================================================

void LogChangeRelations(void)

{
    short sVar1;
    HDR   hdr;

    sVar1 = FGetPrevLogRt(&hdr, (byte *)rgbCur);
    if ((sVar1 != 0) && (hdr.wFlags >> 10 == 0x26)) {
        imemLogCur = imemLogPrev;
    }
    WriteMemRt(0x26, game.cPlayer, (void *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0));
    if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
        tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
        AdvanceTutor();
    }
    return;
}

// ======================================================================
// Function: LogChangeBtlplan
// Address: 1048:93d0
// Segment: MEMORY_PLANET
// ======================================================================

void LogChangeBtlplan(BTLPLAN *pbtlplan)

{
    WriteBattlePlan(pbtlplan, 1);
    if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
        tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
        AdvanceTutor();
    }
    return;
}

// ======================================================================
// Function: LogChangePlanet
// Address: 1048:9420
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10489758) */

void LogChangePlanet(PLANET *ppl, PLANET *pplNew)

{
    uint      *puVar1;
    LOGXFER   *pLVar2;
    LOGXFER   *pLVar3;
    bool       bVar4;
    int        iVar5;
    short      sVar6;
    uint       uVar7;
    int        iVar8;
    undefined2 unaff_SI;
    LOGXFER   *pLVar9;
    undefined2 unaff_DI;
    LOGXFER   *pLVar10;
    ulong      uVar11;
    long       lVar12;
    ulong      uVar13;
    ushort     in_stack_0000ffd6;
    LOGXFER    lxNew;
    HDR        hdr;
    short      fChg;
    short      i;

    uVar13 = CONCAT22(unaff_SI, unaff_DI);
    bVar4 = false;
    if (((uint)gd.grBits >> 1 & 1) != 0) {
        return;
    }
    if (ppl == (PLANET *)0x0) {
        if (fValidLx == 0) {
            return;
        }
        lxNew.id = -1;
        lxNew.grobj = grobjOther;
        for (i = 0; i < 5; i = i + 1) {
            iVar5 = *(int *)((int)lx.rgdItem + i * 4);
            iVar8 = *(int *)((int)lx.rgdItem + 2 + i * 4);
            *(int *)(lxNew.rgdItem + i) = -iVar5;
            *(int *)((int)lxNew.rgdItem + i * 4 + 2) = -(iVar8 + (uint)(iVar5 != 0));
        }
    } else {
        lxNew.id = ppl->id;
        lxNew.grobj = grobjPlanet;
        for (i = 0; i < 4; i = i + 1) {
            uVar7 = *(uint *)(pplNew->rgwtMin + i);
            puVar1 = (uint *)(((PLANET *)ppl)->rgwtMin + i);
            iVar5 = uVar7 - *puVar1;
            iVar8 = (*(uint *)((int)(pplNew->rgwtMin + i) + 2) - *(uint *)((int)(((PLANET *)ppl)->rgwtMin + i) + 2)) - (uint)(uVar7 < *puVar1);
            *(int *)(lxNew.rgdItem + i) = iVar5;
            *(int *)((int)lxNew.rgdItem + i * 4 + 2) = iVar8;
            if ((iVar5 != 0) || (iVar8 != 0)) {
                bVar4 = true;
            }
        }
        lxNew.rgdItem[4]._0_2_ = 0;
        lxNew.rgdItem[4]._2_2_ = 0;
        if (!bVar4)
            goto LAB_1048_9573;
    }
    if (fValidLx == 0) {
        pLVar9 = &lxNew;
        pLVar10 = (LOGXFER *)&lx;
        for (iVar5 = 0xc; iVar5 != 0; iVar5 = iVar5 + -1) {
            pLVar3 = pLVar10;
            pLVar10 = &pLVar10->grobj;
            pLVar2 = pLVar9;
            pLVar9 = &pLVar9->grobj;
            pLVar3->id = pLVar2->id;
        }
        fValidLx = 1;
    } else {
        LogMakeValidXfer((LOGXFER *)&lx, &lxNew);
        fValidLx = 0;
    }
LAB_1048_9573:
    if (ppl != (PLANET *)0x0) {
        if (((*(int *)&pplNew->lpplprod == 0) && (*(int *)((int)&pplNew->lpplprod + 2) == 0)) &&
            ((*(int *)&((PLANET *)ppl)->lpplprod != 0 || (*(int *)((int)&((PLANET *)ppl)->lpplprod + 2) != 0)))) {
            WriteMemRt(0x1d, 2, &lxNew);
        } else if (((*(int *)&pplNew->lpplprod != 0) || (*(int *)((int)&pplNew->lpplprod + 2) != 0)) &&
                   (((*(int *)&((PLANET *)ppl)->lpplprod == 0 && (*(int *)((int)&((PLANET *)ppl)->lpplprod + 2) == 0)) ||
                     ((((PLPROD *)((PLANET *)ppl)->lpplprod)->iprodMac != ((PLPROD *)pplNew->lpplprod)->iprodMac ||
                       (sVar6 =
                            __fmemcmp((void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)ppl)->lpplprod + 2), (void *)(*(int *)&((PLANET *)ppl)->lpplprod + 4)),
                                      (void *)CONCAT22(*(undefined2 *)((int)&pplNew->lpplprod + 2), (void *)(*(int *)&pplNew->lpplprod + 4)),
                                      (uint)((PLPROD *)((PLANET *)ppl)->lpplprod)->iprodMac << 2),
                        sVar6 != 0)))))) {
            sVar6 = FGetPrevLogRt(&hdr, (byte *)rgbCur);
            if ((sVar6 != 0) && ((hdr.wFlags >> 10 == 0x1d && (rgbCur._0_2_ == ppl->id)))) {
                imemLogCur = imemLogPrev;
            }
            rgbCur._0_2_ = ppl->id;
            __fmemmove(rgbCur + 2, (void *)CONCAT22(*(undefined2 *)((int)&pplNew->lpplprod + 2), (void *)(*(int *)&pplNew->lpplprod + 4)),
                       (uint)((PLPROD *)pplNew->lpplprod)->iprodMac << 2);
            WriteMemRt(0x1d, (uint)((PLPROD *)pplNew->lpplprod)->iprodMac * 4 + 2, (char *)rgbCur);
        }
        uVar11 = __aFulshr(uVar13, in_stack_0000ffd6);
        uVar7 = (uint)uVar11 & 1;
        uVar11 = __aFulshr(uVar13, uVar7);
        if ((((uVar7 != ((uint)uVar11 & 1)) ||
              ((*(uint *)((int)&((PLANET *)ppl)->lStarbase + 2) & 0x3ff) != (*(uint *)((int)&pplNew->lStarbase + 2) & 0x3ff))) ||
             ((*(uint *)((int)&((PLANET *)ppl)->lStarbase + 2) >> 10 & 0xf) != (*(uint *)((int)&pplNew->lStarbase + 2) >> 10 & 0xf))) ||
            ((((PLANET *)ppl)->wRouting & 0x3ff) != (pplNew->wRouting & 0x3ff))) {
            rgbCur._0_2_ = pplNew->id;
            rgbCur[2] = '\0';
            rgbCur[3] = '\0';
            rgbCur[4] = '\0';
            rgbCur[5] = '\0';
            __aFulshr(uVar13, uVar7);
            lVar12 = __aFlshl(uVar13, uVar7);
            rgbCur._2_2_ = rgbCur._2_2_ & 0xfffe | (uint)lVar12;
            rgbCur._4_2_ = rgbCur._4_2_ | (uint)((ulong)lVar12 >> 0x10);
            lVar12 = __aFlshl(uVar13, uVar7);
            rgbCur._2_2_ = rgbCur._2_2_ & 0xf801 | (uint)lVar12;
            rgbCur._4_2_ = rgbCur._4_2_ | (uint)((ulong)lVar12 >> 0x10);
            lVar12 = __aFlshl(uVar13, uVar7);
            rgbCur._2_2_ = rgbCur._2_2_ & 0x87ff | (uint)lVar12;
            rgbCur._4_2_ = rgbCur._4_2_ | (uint)((ulong)lVar12 >> 0x10);
            lVar12 = __aFlshl(uVar13, uVar7);
            rgbCur._2_2_ = rgbCur._2_2_ & 0x7fff | (uint)lVar12;
            rgbCur._4_2_ = rgbCur._4_2_ & 0xfe00 | (uint)((ulong)lVar12 >> 0x10);
            WriteMemRt(0x23, 6, (char *)rgbCur);
        }
    }
    return;
}

// ======================================================================
// Function: LogChangeThing
// Address: 1048:9908
// Segment: MEMORY_PLANET
// ======================================================================

void LogChangeThing(THING *lpth, THING *pthNew)

{
    LOGXFER *pLVar1;
    LOGXFER *pLVar2;
    bool     bVar3;
    int      iVar4;
    LOGXFER *pLVar5;
    LOGXFER *pLVar6;
    LOGXFER  lxNew;
    short    fChg;
    short    i;

    bVar3 = false;
    if (((uint)gd.grBits >> 1 & 1) == 0) {
        _memset(&lxNew, 0, 0x18);
        lxNew.id = pthNew->idFull;
        lxNew.grobj = grobjThing;
        for (i = 0; i < 3; i = i + 1) {
            iVar4 = *(int *)((pthNew->u_THING_0x0006).rgb + i * 2 + 2) - *(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2);
            *(int *)(lxNew.rgdItem + i) = iVar4;
            *(int *)((int)lxNew.rgdItem + i * 4 + 2) = iVar4 >> 0xf;
            if (iVar4 != 0) {
                bVar3 = true;
            }
        }
        if (bVar3) {
            if (fValidLx == 0) {
                pLVar5 = &lxNew;
                pLVar6 = (LOGXFER *)&lx;
                for (iVar4 = 0xc; iVar4 != 0; iVar4 = iVar4 + -1) {
                    pLVar2 = pLVar6;
                    pLVar6 = &pLVar6->grobj;
                    pLVar1 = pLVar5;
                    pLVar5 = &pLVar5->grobj;
                    pLVar2->id = pLVar1->id;
                }
                fValidLx = 1;
            } else {
                LogMakeValidXfer((LOGXFER *)&lx, &lxNew);
                fValidLx = 0;
            }
        }
    }
    return;
}

// ======================================================================
// Function: LogMakeValidXfer
// Address: 1048:99f6
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Variable defined which should be unmapped: prt */
/* WARNING: Variable defined which should be unmapped: prtx */
/* WARNING: Variable defined which should be unmapped: prtl */
/* WARNING: Removing unreachable block (ram,0x10489e18) */
/* WARNING: Removing unreachable block (ram,0x10489d0a) */
/* WARNING: Removing unreachable block (ram,0x10489e97) */

void LogMakeValidXfer(LOGXFER *plx1, LOGXFER *plx2)

{
    uint      *puVar1;
    int       *piVar2;
    char       cVar3;
    int        iVar4;
    uint       uVar5;
    undefined2 uVar6;
    uint       uVar7;
    uint       uVar8;
    undefined2 unaff_SS;
    long       lVar9;
    long       lVar10;
    short      cb;
    long       iBiggest;
    short      grFlag;
    RTXFERX   *prtx;
    short      grbit;
    char       rgbuf[28];
    short      i;
    short      rt;
    RTXFERL   *prtl;
    short      iOff;
    RTXFER    *prt;
    long       rgQuan[5];

    lVar10 = 0;
    grFlag = 1;
    rgQuan[0]._0_2_ = 0;
    rgQuan[0]._2_2_ = 0;
    rgQuan[1]._0_2_ = 0;
    rgQuan[1]._2_2_ = 0;
    rgQuan[2]._0_2_ = 0;
    rgQuan[2]._2_2_ = 0;
    rgQuan[3]._0_2_ = 0;
    rgQuan[3]._2_2_ = 0;
    rgQuan[4]._0_2_ = 0;
    rgQuan[4]._2_2_ = 0;
    uVar7 = hdrPrev.wFlags >> 10;
    if (((uVar7 == 1) || (uVar7 == 2)) || (uVar7 == 0x19)) {
        prt = (RTXFER *)CONCAT22(lpLog._2_2_, (byte *)lpLog + (imemLogCur - (hdrPrev.wFlags & 0x3ff)));
    } else {
        prt = (RTXFER *)0x0;
    }
    if (((((RTXFER *)prt != (RTXFER *)0x0) || (prt._2_2_ != 0)) &&
         (((((RTXFER *)prt)->bFlags_0x4 & (grobjThing | grobjOther | grobjFleet | grobjPlanet)) == (plx1->grobj & 0xff) &&
           (((int)(uint)((RTXFER *)prt)->bFlags_0x4 >> 4 == (plx2->grobj & 0xff) && (prt->id1 == plx1->id)))))) &&
        (((RTXFER *)prt)->id2 == plx2->id)) {
        uVar7 = (uint)((RTXFER *)prt)->grbitItems;
        iOff = 0;
        uVar8 = hdrPrev.wFlags >> 10;
        if (uVar8 == 1) {
            for (i = 0; i < 5; i = i + 1) {
                if ((1 << ((byte)i & 0x1f) & uVar7) != 0) {
                    cVar3 = ((RTXFER *)prt)->rgcQuan[iOff];
                    *(int *)(rgQuan + i) = (int)cVar3;
                    *(int *)((int)rgQuan + i * 4 + 2) = (int)cVar3 >> 0xf;
                    iOff = iOff + 1;
                }
            }
        } else if (uVar8 == 2) {
            for (i = 0; i < 5; i = i + 1) {
                if ((1 << ((byte)i & 0x1f) & uVar7) != 0) {
                    iVar4 = *(int *)(((RTXFER *)prt)->rgcQuan + iOff * 2);
                    *(int *)(rgQuan + i) = iVar4;
                    *(int *)((int)rgQuan + i * 4 + 2) = iVar4 >> 0xf;
                    iOff = iOff + 1;
                }
            }
        } else if (uVar8 == 0x19) {
            for (i = 0; i < 5; i = i + 1) {
                if ((1 << ((byte)i & 0x1f) & uVar7) != 0) {
                    uVar6 = *(undefined2 *)(((RTXFER *)prt)->rgcQuan + iOff * 4 + 2);
                    *(undefined2 *)(rgQuan + i) = *(undefined2 *)(((RTXFER *)prt)->rgcQuan + iOff * 4);
                    *(undefined2 *)((int)rgQuan + i * 4 + 2) = uVar6;
                    iOff = iOff + 1;
                }
            }
        }
        CancelMemRt(hdrPrev.wFlags >> 10);
    }
    grbit = 0;
    for (i = 0; i < 5; i = i + 1) {
        uVar8 = *(uint *)(plx1->rgdItem + i);
        uVar5 = *(uint *)((int)(plx1->rgdItem + i) + 2);
        puVar1 = (uint *)(rgQuan + i);
        uVar7 = *puVar1;
        *puVar1 = *puVar1 + uVar8;
        piVar2 = (int *)((int)rgQuan + i * 4 + 2);
        *piVar2 = *piVar2 + uVar5 + (uint)CARRY2(uVar7, uVar8);
        lVar9 = _labs(CONCAT22(*(undefined2 *)((int)rgQuan + i * 4 + 2), (int)rgQuan[i]));
        if (lVar10 <= lVar9) {
            lVar10 = _labs(CONCAT22(*(undefined2 *)((int)rgQuan + i * 4 + 2), (int)rgQuan[i]));
        }
        if (((int)rgQuan[i] != 0) || (*(int *)((int)rgQuan + i * 4 + 2) != 0)) {
            grbit = grbit | grFlag;
        }
        grFlag = grFlag << 1;
    }
    if (grbit != 0) {
        prt = rgbuf;
        rgbuf[4] = (byte)plx1->grobj & 0xf | (byte)((plx2->grobj & (grobjThing | grobjOther | grobjFleet | grobjPlanet)) << 4);
        prt->id1 = plx1->id;
        rgbuf._2_2_ = plx2->id;
        rgbuf[5] = (char)grbit;
        cb = 6;
        iOff = 0;
        if (lVar10 < 0x80) {
            rt = 1;
            for (i = 0; i < 5; i = i + 1) {
                if (((int)rgQuan[i] != 0) || (*(int *)((int)rgQuan + i * 4 + 2) != 0)) {
                    rgbuf[iOff + 6] = (char)(int)rgQuan[i];
                    cb = cb + 1;
                    iOff = iOff + 1;
                }
            }
        } else if (lVar10 < 0x8000) {
            rt = 2;
            for (i = 0; i < 5; i = i + 1) {
                if (((int)rgQuan[i] != 0) || (*(int *)((int)rgQuan + i * 4 + 2) != 0)) {
                    *(int *)(rgbuf + iOff * 2 + 6) = (int)rgQuan[i];
                    cb = cb + 2;
                    iOff = iOff + 1;
                }
            }
        } else {
            rt = 0x19;
            for (i = 0; i < 5; i = i + 1) {
                if (((int)rgQuan[i] != 0) || (*(int *)((int)rgQuan + i * 4 + 2) != 0)) {
                    uVar6 = *(undefined2 *)((int)rgQuan + i * 4 + 2);
                    *(int *)(rgbuf + iOff * 4 + 6) = (int)rgQuan[i];
                    *(undefined2 *)(rgbuf + iOff * 4 + 8) = uVar6;
                    cb = cb + 4;
                    iOff = iOff + 1;
                }
            }
        }
        WriteMemRt(rt, cb, rgbuf);
    }
    return;
}

// ======================================================================
// Function: LogMakeValidXferf
// Address: 1048:9fa6
// Segment: MEMORY_PLANET
// ======================================================================

void LogMakeValidXferf(LOGXFERF *plxf1, LOGXFERF *plxf2)

{
    short    cb;
    short    grFlag;
    ushort   grbit;
    char     rgbuf[41];
    short    i;
    short    iOff;
    RTXFERF *prt;

    grbit = 0;
    grFlag = 1;
    for (i = 0; i < 0x10; i = i + 1) {
        if (plxf1->rgdItem[i] != 0) {
            grbit = grbit | grFlag;
        }
        grFlag = grFlag << 1;
    }
    if (grbit != 0) {
        rgbuf[4] = (byte)plxf1->grobj & 0xf | (byte)((plxf2->grobj & (grobjThing | grobjOther | grobjFleet | grobjPlanet)) << 4);
        rgbuf._0_2_ = plxf1->id;
        rgbuf._2_2_ = plxf2->id;
        rgbuf[5] = (undefined1)grbit;
        rgbuf[6] = grbit._1_1_;
        cb = 7;
        iOff = 0;
        for (i = 0; i < 0x10; i = i + 1) {
            if (plxf1->rgdItem[i] != 0) {
                *(short *)(rgbuf + iOff * 2 + 7) = plxf1->rgdItem[i];
                cb = cb + 2;
                iOff = iOff + 1;
            }
        }
        WriteMemRt(0x17, cb, rgbuf);
    }
    return;
}

// ======================================================================
// Function: CancelMemRt
// Address: 1048:a108
// Segment: MEMORY_PLANET
// ======================================================================

void CancelMemRt(short rt)

{
    imemLogCur = imemLogCur - ((hdrPrev.wFlags & 0x3ff) + 2);
    hdrPrev.wFlags = hdrPrev.wFlags & 0x3ff;
    return;
}

// ======================================================================
// Function: WriteMemRt
// Address: 1048:a130
// Segment: MEMORY_PLANET
// ======================================================================

void WriteMemRt(short rt, short cb, void *rg)

{
    byte      *pbVar1;
    undefined2 uVar2;
    char      *sz;
    HDR        HVar3;
    short      mbType;
    byte      *lpv;
    HDR        hdr;

    HVar3.wFlags = hdrPrev.wFlags;
    if (fLogOff == 0) {
        if (32000 < imemLogCur + cb + 2) {
            mbType = 0x10;
            sz = PszFormatIds(idsLogFileHasReachedMaximumAllowableSize, (short *)0x0);
            AlertSz(sz, mbType);
        }
        DirtyGame(1);
        uVar2 = lpLog._2_2_;
        imemLogPrev = imemLogCur;
        HVar3.wFlags = cb & 0x3ffU | rt << 10;
        pbVar1 = (byte *)lpLog + imemLogCur;
        lpv = (byte *)CONCAT22(lpLog._2_2_, pbVar1);
        *lpv = HVar3.wFlags;
        if (0 < cb) {
            __fmemcpy((byte *)CONCAT22(uVar2, pbVar1 + 2), rg, cb);
        }
        imemLogCur = imemLogCur + cb + 2;
        if (rt == 0) {
            HVar3.wFlags = hdrPrev.wFlags;
        }
    }
    hdrPrev.wFlags = HVar3.wFlags;
    return;
}

// ======================================================================
// Function: DirtyGame
// Address: 1048:a228
// Segment: MEMORY_PLANET
// ======================================================================

void DirtyGame(short fDirty)

{
    if ((fDirty != game.fDirty) && (game.fDirty = fDirty, fAi == 0)) {
        SetMsgTitle(hwndMessage);
    }
    return;
}

// ======================================================================
// Function: FGetPrevLogRt
// Address: 1048:a25e
// Segment: MEMORY_PLANET
// ======================================================================

short FGetPrevLogRt(HDR *phdr, byte *pb)

{
    undefined2 uVar1;
    short      sVar2;
    byte      *pbVar3;
    byte      *lpv;

    uVar1 = lpLog._2_2_;
    if (imemLogPrev == -1) {
        sVar2 = 0;
    } else {
        pbVar3 = (byte *)lpLog + imemLogPrev;
        lpv = (byte *)CONCAT22(lpLog._2_2_, pbVar3);
        phdr->wFlags = *lpv;
        if ((phdr->wFlags & 0x3ff) != 0) {
            __fmemcpy(pb, (byte *)CONCAT22(uVar1, pbVar3 + 2), phdr->wFlags & 0x3ff);
        }
        sVar2 = 1;
    }
    return sVar2;
}

// ======================================================================
// Function: FRunLogFile
// Address: 1048:a2d6
// Segment: MEMORY_PLANET
// ======================================================================

short FRunLogFile(void)

{
    short sVar1;
    uint  uVar2;
    HDR  *lprts;
    short iCur;
    short fRet;
    short fLogOld;

    sVar1 = fLogOff;
    iCur = 0;
    fRet = 1;
    if (imemLogCur == 0) {
        fRet = 1;
    } else {
        fLogOff = 1;
        for (; iCur < imemLogCur; iCur = iCur + (lprts->wFlags & 0x3ff) + 2) {
            lprts = (HDR *)CONCAT22(lpLog._2_2_, (byte *)lpLog + iCur);
            uVar2 = FRunLogRecord(lprts->wFlags >> 10, lprts->wFlags & 0x3ff, (byte *)CONCAT22(lpLog._2_2_, (byte *)lpLog + iCur + 2));
            fRet = fRet & uVar2;
        }
        gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfbff;
    }
    fLogOff = sVar1;
    return fRet;
}

// ======================================================================
// Function: FRunLogRecord
// Address: 1048:a38c
// Segment: MEMORY_PLANET
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x1048bb20) */
/* WARNING: Removing unreachable block (ram,0x1048af75) */
/* WARNING: Removing unreachable block (ram,0x1048af96) */
/* WARNING: Removing unreachable block (ram,0x1048bb41) */
/* WARNING: Variable defined which should be unmapped: cOut */

short FRunLogRecord(RecordTypeLog rt, short cb, byte *lpb)

{
    uint       *puVar1;
    char       *pcVar2;
    MessageId  *pMVar3;
    int        *piVar4;
    byte       *pbVar5;
    byte        bVar6;
    undefined2  uVar7;
    PLANET     *pPVar8;
    XFERFULL   *pXVar9;
    FLEET      *pFVar10;
    short       sVar11;
    ushort      uVar12;
    uint        uVar13;
    uint        uVar14;
    int         iVar15;
    uint        uVar16;
    undefined2 *puVar17;
    undefined2 *puVar18;
    SHDEF      *pSVar19;
    int         iVar20;
    undefined2  unaff_SI;
    undefined2  unaff_DI;
    undefined2  uVar21;
    undefined2  unaff_SS;
    bool        bVar22;
    PL         *pPVar23;
    FLEET      *pFVar24;
    void       *pvVar25;
    THING      *pTVar26;
    PLANET     *pPVar27;
    long        lVar28;
    ulong       uVar29;
    ulong       uVar30;
    HeapType    HVar31;
    short       cOut;
    char        local_564[26];
    uint        local_54a;
    COLDROP    *local_548;
    PLANET     *pPStack_546;
    MessageId   MStack_544;
    long        l;
    char        ch;
    PLANET     *lpplMac;
    short       iLook;
    short       iPass;
    SHDEF      *lpshdef;
    short       rgifl[512];
    ushort      grbit;
    short       i;
    short       ifl;
    FLEET      *lpfl;
    XFER        rgxf[2];
    long        rgcXfer[5];
    PLANET     *lppl;
    XFERFULL   *lpxfCur;
    long        cXfer;
    short       fExtra;

    uVar30 = CONCAT22(unaff_SI, unaff_DI);
    lpxfCur = (XFERFULL *)0x0;
    switch (rt) {
    case rtLogNop:
        break;
    case rtLogCargoXfer8:
    case rtLogCargoXfer16:
    case rtLogCargoXfer32:
        sVar11 = FLookupObject(((byte *)lpb)[4] & (grobjThing | grobjOther | grobjFleet | grobjPlanet), *lpb, &rgxf[0].u_XFER_0x0004);
        if (sVar11 == 0) {
            return 0;
        }
        rgxf[1].u_XFER_0x0004.fl.id = -1;
        if (((int)(uint)((byte *)lpb)[4] >> 4 == 4) ||
            (sVar11 = FLookupObject((int)(uint)((byte *)lpb)[4] >> 4, *(short *)((byte *)lpb + 2), &rgxf[1].u_XFER_0x0004), sVar11 != 0)) {
            lVar28 = CONCAT22(l._2_2_, (undefined2)l);
            grbit = (ushort)((byte *)lpb)[5];
            iLook = 0;
            for (i = 0; i < 5; i = i + 1) {
                if ((grbit & 1) == 0) {
                    *(undefined2 *)(rgcXfer + i) = 0;
                    *(undefined2 *)((int)rgcXfer + i * 4 + 2) = 0;
                } else {
                    if (rt == rtLogCargoXfer8) {
                        bVar6 = ((byte *)lpb)[iLook + 6];
                        *(int *)(rgcXfer + i) = (int)(char)bVar6;
                        *(int *)((int)rgcXfer + i * 4 + 2) = (int)(char)bVar6 >> 0xf;
                    } else if (rt == rtLogCargoXfer16) {
                        iVar15 = *(int *)((byte *)lpb + iLook * 2 + 6);
                        *(int *)(rgcXfer + i) = iVar15;
                        *(int *)((int)rgcXfer + i * 4 + 2) = iVar15 >> 0xf;
                    } else {
                        uVar21 = *(undefined2 *)((byte *)lpb + iLook * 4 + 6 + 2);
                        *(undefined2 *)(rgcXfer + i) = *(undefined2 *)((byte *)lpb + iLook * 4 + 6);
                        *(undefined2 *)((int)rgcXfer + i * 4 + 2) = uVar21;
                    }
                    iLook = iLook + 1;
                }
                grbit = grbit >> 1;
            }
            for (iPass = 0; iPass < 2; iPass = iPass + 1) {
                for (i = 0; i < 5; i = i + 1) {
                    if (((int)rgcXfer[i] != 0) || (*(int *)((int)rgcXfer + i * 4 + 2) != 0)) {
                        cXfer._0_2_ = *(uint *)(rgcXfer + i);
                        cXfer._2_2_ = *(uint *)((int)rgcXfer + i * 4 + 2);
                        if (((iPass == 0) && ((int)cXfer._2_2_ < 0)) || ((iPass == 1 && (-1 < (int)cXfer._2_2_)))) {
                            l = lVar28;
                            lVar28 = ChgCargo(((byte *)lpb)[4] & (grobjThing | grobjOther | grobjFleet | grobjPlanet), *lpb, i,
                                              CONCAT22(cXfer._2_2_, (uint)cXfer), &rgxf[0].u_XFER_0x0004);
                            if (lVar28 != CONCAT22(cXfer._2_2_, (uint)cXfer)) {
                                if ((((byte *)lpb)[4] & 0xf) == 2) {
                                    MStack_544 = 0x8000;
                                } else {
                                    MStack_544 = idmColonistsDroppedMassacredGroundTroops;
                                }
                                MStack_544 = MStack_544 | rgxf[0].u_XFER_0x0004.th.idFull;
                                l = lVar28;
                                FSendPlrMsg(rgxf[0].u_XFER_0x0004.fl.iPlayer, idmUnableTransferKtKtRequest, MStack_544, MStack_544, (uint)cXfer - (int)lVar28,
                                            i, (uint)cXfer, 0, 0, 0);
                                *(undefined2 *)(rgcXfer + i) = (undefined2)l;
                                *(undefined2 *)((int)rgcXfer + i * 4 + 2) = l._2_2_;
                                lVar28 = l;
                            }
                        }
                        pXVar9 = lpcd._2_2_;
                        if ((((iPass == 0) && ((0 < (int)cXfer._2_2_ || (-1 < (int)cXfer._2_2_)))) ||
                             ((iPass == 1 && (((int)cXfer._2_2_ < 1 && ((int)cXfer._2_2_ < 0)))))) &&
                            ((int)(uint)((byte *)lpb)[4] >> 4 != 4)) {
                            if (((i == 3) && (((((uint)cXfer != 0 || (cXfer._2_2_ != 0)) && (((uint)gd.grBits >> 1 & 1) != 0)) &&
                                               (((int)(uint)((byte *)lpb)[4] >> 4 == 1 && ((((byte *)lpb)[4] & 0xf) == 2)))))) &&
                                (rgxf[0].u_XFER_0x0004.fl.iPlayer != rgxf[1].u_XFER_0x0004.fl.iPlayer)) {
                                local_548 = (COLDROP *)lpcd;
                                pPStack_546 = lpcd._2_2_;
                                MStack_544 = idmColonistsDroppedMassacredGroundTroops;
                                if (((int)cXfer._2_2_ < 0) || (((int)cXfer._2_2_ < 1 && ((uint)cXfer == 0)))) {
                                    for (; ((int)MStack_544 < cColDrop &&
                                            ((((COLDROP *)CONCAT22(lpcd._2_2_, local_548))->idFleetSrc != rgxf[0].u_XFER_0x0004.fl.id ||
                                              (local_548->idPlanetDst != rgxf[1].u_XFER_0x0004.fl.id))));
                                         local_548 = local_548 + 1) {
                                        MStack_544 = MStack_544 + idmColonistsDroppedDestroyedPlanetaryDefensesRestMa;
                                    }
                                    if (MStack_544 == cColDrop) {
                                        ((COLDROP *)CONCAT22(lpcd._2_2_, local_548))->idFleetSrc = rgxf[0].u_XFER_0x0004.fl.id;
                                        local_548->idPlr = rgxf[0].u_XFER_0x0004.fl.iPlayer;
                                        local_548->idPlanetDst = rgxf[1].u_XFER_0x0004.fl.id;
                                        *(undefined2 *)&local_548->cColonist = 0;
                                        *(undefined2 *)((int)&local_548->cColonist + 2) = 0;
                                        local_54a = (uint)(rgxf[1].u_XFER_0x0004.fl.iPlayer != -1);
                                        local_548->wFlags_0x6 = local_548->wFlags_0x6 & 0xfffe | local_54a;
                                        cColDrop = cColDrop + 1;
                                    }
                                    puVar1 = (uint *)&local_548->cColonist;
                                    uVar14 = *puVar1;
                                    *puVar1 = *puVar1 - (uint)cXfer;
                                    piVar4 = (int *)((int)&local_548->cColonist + 2);
                                    *piVar4 = (*piVar4 - cXfer._2_2_) - (uint)(uVar14 < (uint)cXfer);
                                } else {
                                    while ((((int)MStack_544 < cColDrop && (-1 < (int)cXfer._2_2_)) && ((0 < (int)cXfer._2_2_ || ((uint)cXfer != 0))))) {
                                        if ((local_548->idPlanetDst == rgxf[1].u_XFER_0x0004.fl.id) && (local_548->idPlr == rgxf[0].u_XFER_0x0004.fl.iPlayer)) {
                                            iVar15 = *(int *)((int)&local_548->cColonist + 2);
                                            if ((iVar15 < (int)cXfer._2_2_) ||
                                                ((uVar14 = (uint)cXfer, uVar13 = cXfer._2_2_,
                                                  iVar15 <= (int)cXfer._2_2_ && (*(uint *)&local_548->cColonist <= (uint)cXfer)))) {
                                                uVar14 = *(uint *)&local_548->cColonist;
                                                uVar13 = *(uint *)((int)&local_548->cColonist + 2);
                                            }
                                            lVar28 = CONCAT22(uVar13, uVar14);
                                            bVar22 = (uint)cXfer < uVar14;
                                            cXfer._0_2_ = (uint)cXfer - uVar14;
                                            cXfer._2_2_ = (cXfer._2_2_ - uVar13) - (uint)bVar22;
                                            puVar1 = (uint *)&local_548->cColonist;
                                            uVar16 = *puVar1;
                                            *puVar1 = *puVar1 - uVar14;
                                            piVar4 = (int *)((int)&local_548->cColonist + 2);
                                            *piVar4 = (*piVar4 - uVar13) - (uint)(uVar16 < uVar14);
                                        }
                                        local_548 = local_548 + 1;
                                        MStack_544 = MStack_544 + idmColonistsDroppedDestroyedPlanetaryDefensesRestMa;
                                    }
                                }
                            } else if ((((uint)cXfer == 0) && (cXfer._2_2_ == 0)) ||
                                       ((((uint)gd.grBits >> 1 & 1) == 0 || ((rgxf[1].u_XFER_0x0004.fl.iPlayer == rgxf[0].u_XFER_0x0004.fl.iPlayer ||
                                                                              ((int)(uint)((byte *)lpb)[4] >> 4 == 8)))))) {
                            PLANET_StealCargo:
                                l = lVar28;
                                lVar28 = ChgCargo((int)(uint)((byte *)lpb)[4] >> 4, *(short *)((byte *)lpb + 2), i,
                                                  CONCAT22(-(cXfer._2_2_ + ((uint)cXfer != 0)), -(uint)cXfer), &rgxf[1].u_XFER_0x0004);
                                iVar15 = (int)lVar28;
                                if (lVar28 != CONCAT22(-(cXfer._2_2_ + ((uint)cXfer != 0)), -(uint)cXfer)) {
                                    *(int *)(rgcXfer + i) = -iVar15;
                                    *(int *)((int)rgcXfer + i * 4 + 2) = -((int)((ulong)lVar28 >> 0x10) + (uint)(iVar15 != 0));
                                    l = lVar28;
                                    if ((int)(uint)((byte *)lpb)[4] >> 4 == 8) {
                                        MStack_544 = idmDidntGetAttemptedTransferMineralPacketAnother;
                                        if (lVar28 == 0) {
                                            MStack_544 = idmDidntGetAnyAttemptedTransferMineralPacket;
                                        }
                                        FSendPlrMsg(rgxf[0].u_XFER_0x0004.fl.iPlayer, MStack_544, rgxf[0].u_XFER_0x0004.th.idFull | 0x8000,
                                                    rgxf[0].u_XFER_0x0004.fl.id, i, -iVar15, i, 0, 0, 0);
                                        lVar28 = l;
                                    } else {
                                        if ((((byte *)lpb)[4] & 0xf) == 2) {
                                            MStack_544 = 0x8000;
                                        } else {
                                            MStack_544 = idmColonistsDroppedMassacredGroundTroops;
                                        }
                                        MStack_544 = MStack_544 | rgxf[0].u_XFER_0x0004.th.idFull;
                                        FSendPlrMsg(rgxf[0].u_XFER_0x0004.fl.iPlayer, idmUnableTransferKtKtRequest, MStack_544, MStack_544,
                                                    -(uint)cXfer - iVar15, i, -(uint)cXfer, 0, 0, 0);
                                        lVar28 = l;
                                    }
                                }
                            } else {
                                pPStack_546 = (XFERFULL *)lpxf + cXferFull;
                                MStack_544 = lpxf._2_2_;
                                if (((int)cXfer._2_2_ < 0) || (((int)cXfer._2_2_ < 1 && ((uint)cXfer == 0)))) {
                                    if (iPass == 1)
                                        goto PLANET_StealCargo;
                                    if (((XFERFULL *)lpxfCur == (XFERFULL *)0x0) && (lpxfCur._2_2_ == 0)) {
                                        lpxfCur = (XFERFULL *)CONCAT22(lpxf._2_2_, (XFERFULL *)lpxf);
                                        l = lVar28;
                                        while (true) {
                                            if (pPStack_546 <= (XFERFULL *)lpxfCur)
                                                break;
                                            sVar11 = __fmemcmp(lpxfCur, lpb, 5);
                                            if (sVar11 == 0)
                                                break;
                                            lpxfCur = (XFERFULL *)lpxfCur + 1;
                                        }
                                        lVar28 = l;
                                        if (((XFERFULL *)lpxfCur == pPStack_546) && (lpxfCur._2_2_ == MStack_544)) {
                                            cXferFull = cXferFull + 1;
                                            __fmemset(lpxfCur, 0, 0x19);
                                            uVar12 = *(ushort *)((byte *)lpb + 2);
                                            lpxfCur->id1 = *lpb;
                                            ((XFERFULL *)lpxfCur)->id2 = uVar12;
                                            lVar28 = l;
                                        }
                                    }
                                    puVar1 = (uint *)(((XFERFULL *)lpxfCur)->rgcQuan + i);
                                    uVar14 = *puVar1;
                                    *puVar1 = *puVar1 - (uint)cXfer;
                                    puVar1 = (uint *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                                    *puVar1 = (*puVar1 - cXfer._2_2_) - (uint)(uVar14 < (uint)cXfer);
                                } else {
                                    lpxfCur = (XFERFULL *)CONCAT22(lpxf._2_2_, (XFERFULL *)lpxf);
                                    while ((((XFERFULL *)lpxfCur < pPStack_546 && (-1 < (int)cXfer._2_2_)) && ((0 < (int)cXfer._2_2_ || ((uint)cXfer != 0))))) {
                                        uVar21 = (undefined2)((ulong)lpxfCur >> 0x10);
                                        local_548 = (COLDROP *)((int)(uint)((XFERFULL *)lpxfCur)->bFlags_0x4 >> 4);
                                        if ((((local_548 == (COLDROP *)((int)(uint)((byte *)lpb)[4] >> 4)) &&
                                              (((XFERFULL *)lpxfCur)->id2 == *(ushort *)((byte *)lpb + 2))) &&
                                             ((((XFERFULL *)lpxfCur)->bFlags_0x4 & 0xf) == 2)) &&
                                            ((lpxfCur->id1 & 0xfe00) == (*lpb & 0xfe00))) {
                                            uVar14 = *(uint *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                                            if (((int)uVar14 < (int)cXfer._2_2_) ||
                                                ((uVar13 = (uint)cXfer, uVar16 = cXfer._2_2_,
                                                  (int)uVar14 <= (int)cXfer._2_2_ && (*(uint *)(((XFERFULL *)lpxfCur)->rgcQuan + i) <= (uint)cXfer)))) {
                                                uVar13 = *(uint *)(((XFERFULL *)lpxfCur)->rgcQuan + i);
                                                uVar16 = *(uint *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                                            }
                                            lVar28 = CONCAT22(uVar16, uVar13);
                                            bVar22 = (uint)cXfer < uVar13;
                                            cXfer._0_2_ = (uint)cXfer - uVar13;
                                            cXfer._2_2_ = (cXfer._2_2_ - uVar16) - (uint)bVar22;
                                            puVar1 = (uint *)(((XFERFULL *)lpxfCur)->rgcQuan + i);
                                            uVar14 = *puVar1;
                                            *puVar1 = *puVar1 - uVar13;
                                            puVar1 = (uint *)((int)(((XFERFULL *)lpxfCur)->rgcQuan + i) + 2);
                                            *puVar1 = (*puVar1 - uVar16) - (uint)(uVar14 < uVar13);
                                        }
                                        lpxfCur = (XFERFULL *)CONCAT22(uVar21, (XFERFULL *)lpxfCur + 1);
                                    }
                                    lpxfCur = (XFERFULL *)0x0;
                                    if ((-1 < (int)cXfer._2_2_) && ((0 < (int)cXfer._2_2_ || ((uint)cXfer != 0))))
                                        goto PLANET_StealCargo;
                                }
                            }
                        }
                    }
                }
            }
            l = lVar28;
            if ((((byte *)lpb)[4] & 0xf) == 2) {
                FLookupFleet(-1, &rgxf[0].u_XFER_0x0004.fl);
            } else {
                FLookupPlanet(-1, &rgxf[0].u_XFER_0x0004.pl);
            }
            if ((int)(uint)((byte *)lpb)[4] >> 4 == 2) {
                FLookupFleet(-1, &rgxf[1].u_XFER_0x0004.fl);
            } else if (((int)(uint)((byte *)lpb)[4] >> 4 == 1) || ((int)(uint)((byte *)lpb)[4] >> 4 == 4)) {
                FLookupPlanet(-1, &rgxf[1].u_XFER_0x0004.pl);
            } else if ((int)(uint)((byte *)lpb)[4] >> 4 == 8) {
                FLookupThing(-1, &rgxf[1].u_XFER_0x0004.th);
            }
        } else if (((int)(uint)((byte *)lpb)[4] >> 4 != 2) || ((*(uint *)((byte *)lpb + 2) >> 9 & 0xf) == idPlayer)) {
            return 0;
        }
        break;
    case rtLogFleetOrderDelete:
        pFVar24 = LpflFromId(*lpb);
        uVar21 = (undefined2)((ulong)pFVar24 >> 0x10);
        pFVar10 = (FLEET *)pFVar24;
        if (((pFVar24 == (FLEET *)0x0) || (pFVar10->cord < 1)) || (iLook = *(uint *)((byte *)lpb + 2) & 0x7fff, pFVar10->cord <= iLook)) {
            return 0;
        }
        bVar22 = (*(uint *)((byte *)lpb + 2) & 0x8000) != 0;
        uVar14 = (uint)bVar22;
        if ((uVar14 != 0) && (pFVar10->cord <= (int)(iLook + 1U))) {
            return 0;
        }
        MStack_544 = *(undefined2 *)((int)&pFVar10->lpplord + 2);
        pPStack_546 = (PLANET *)(*(int *)&pFVar10->lpplord + 4);
        local_548 = (COLDROP *)*(undefined2 *)((int)&pFVar10->lpplord + 2);
        local_54a = *(int *)&pFVar10->lpplord + 4;
        __fmemmove((void *)CONCAT22(local_548, (void *)(local_54a + iLook * 0x12)),
                   (void *)CONCAT22(MStack_544, (void *)((int)pPStack_546 + (iLook + uVar14 + 1) * 0x12)), (((pFVar10->cord - iLook) - uVar14) + -1) * 0x12);
        pFVar10->cord = pFVar10->cord - (uVar14 + 1);
        pbVar5 = &((PLORD *)pFVar10->lpplord)->iordMac;
        *pbVar5 = *pbVar5 - (bVar22 + '\x01');
        break;
    case rtLogFleetOrderInsert:
        pFVar24 = LpflFromId(*lpb);
        uVar21 = (undefined2)((ulong)pFVar24 >> 0x10);
        pFVar10 = (FLEET *)pFVar24;
        if (((pFVar24 == (FLEET *)0x0) || (*(int *)((byte *)lpb + 2) < 0)) || (pFVar10->cord < *(int *)((byte *)lpb + 2))) {
            return 0;
        }
        if (pFVar10->cord == (uint)((PLORD *)pFVar10->lpplord)->iordMax) {
            pPVar23 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&pFVar10->lpplord + 2), *(PL **)&pFVar10->lpplord), pFVar10->cord + 3);
            *(PL **)&pFVar10->lpplord = (PL *)pPVar23;
            *(undefined2 *)((int)&pFVar10->lpplord + 2) = (int)((ulong)pPVar23 >> 0x10);
        }
        MStack_544 = *(undefined2 *)((int)&pFVar10->lpplord + 2);
        pPStack_546 = (PLANET *)(*(int *)&pFVar10->lpplord + 4);
        local_548 = (COLDROP *)*(undefined2 *)((int)&pFVar10->lpplord + 2);
        local_54a = *(int *)&pFVar10->lpplord + 4;
        __fmemmove((void *)CONCAT22(local_548, (void *)(local_54a + (*(int *)((byte *)lpb + 2) + 1) * 0x12)),
                   (void *)CONCAT22(MStack_544, (void *)((int)pPStack_546 + *(int *)((byte *)lpb + 2) * 0x12)),
                   (pFVar10->cord - *(int *)((byte *)lpb + 2)) * 0x12);
        if ((uint)cb < 0x16) {
            MStack_544 = *(undefined2 *)((int)&pFVar10->lpplord + 2);
            pPStack_546 = (PLANET *)(*(int *)&pFVar10->lpplord + 4);
            __fmemset((void *)CONCAT22(MStack_544, (void *)((int)pPStack_546 + *(int *)((byte *)lpb + 2) * 0x12)), 0, 0x12);
        }
        MStack_544 = *(undefined2 *)((int)&pFVar10->lpplord + 2);
        pPStack_546 = (PLANET *)(*(int *)&pFVar10->lpplord + 4);
        __fmemmove((void *)CONCAT22(MStack_544, (void *)((int)pPStack_546 + *(int *)((byte *)lpb + 2) * 0x12)), (byte *)lpb + 4, cb - 4);
        *(uint *)(*(int *)&pFVar10->lpplord + *(int *)((byte *)lpb + 2) * 0x12 + 10) =
            *(uint *)(*(int *)&pFVar10->lpplord + *(int *)((byte *)lpb + 2) * 0x12 + 10) & 0xdfff;
        pFVar10->cord = pFVar10->cord + 1;
        pbVar5 = &((PLORD *)pFVar10->lpplord)->iordMac;
        *pbVar5 = *pbVar5 + 1;
        break;
    case rtLogFleetOrderUpdate:
        pFVar24 = LpflFromId(*lpb);
        uVar21 = (undefined2)((ulong)pFVar24 >> 0x10);
        pFVar10 = (FLEET *)pFVar24;
        if (((pFVar24 == (FLEET *)0x0) || (pFVar10->cord < 0)) || (iLook = *(short *)((byte *)lpb + 2), pFVar10->cord <= iLook)) {
            return 0;
        }
        if ((uint)cb < 0x16) {
            MStack_544 = *(undefined2 *)((int)&pFVar10->lpplord + 2);
            pPStack_546 = (PLANET *)(*(int *)&pFVar10->lpplord + 4);
            __fmemset((void *)CONCAT22(MStack_544, (void *)((int)pPStack_546 + iLook * 0x12)), 0, 0x12);
        }
        MStack_544 = *(undefined2 *)((int)&pFVar10->lpplord + 2);
        pPStack_546 = (PLANET *)(*(int *)&pFVar10->lpplord + 4);
        __fmemmove((void *)CONCAT22(MStack_544, (void *)((int)pPStack_546 + iLook * 0x12)), (byte *)lpb + 4, cb - 4);
        *(uint *)(*(int *)&pFVar10->lpplord + iLook * 0x12 + 10) = *(uint *)(*(int *)&pFVar10->lpplord + iLook * 0x12 + 10) & 0xdfff;
        break;
    default:
        break;
    case rtLogFleetFlagBit9:
    case rtLogFleetOrderAttrNib:
        pFVar24 = LpflFromId(*lpb);
        uVar21 = (undefined2)((ulong)pFVar24 >> 0x10);
        pFVar10 = (FLEET *)pFVar24;
        if (pFVar24 == (FLEET *)0x0) {
            return 0;
        }
        if (rt == rtLogFleetFlagBit9) {
            pFVar10->wFlags_0x4 = pFVar10->wFlags_0x4 & 0xfdff | (*(uint *)((byte *)lpb + 2) & 1) << 9;
        } else {
            if (pFVar10->cord <= *(int *)((byte *)lpb + 2)) {
                return 0;
            }
            if (9 < *(int *)((byte *)lpb + 4)) {
                return 0;
            }
            *(uint *)(*(int *)&pFVar10->lpplord + *(int *)((byte *)lpb + 2) * 0x12 + 10) =
                *(uint *)(*(int *)&pFVar10->lpplord + *(int *)((byte *)lpb + 2) * 0x12 + 10) & 0xfff0 | *(uint *)((byte *)lpb + 4) & 0xf;
        }
        break;
    case rtLogFleetCargoXfer:
        sVar11 = FLookupObject(grobjFleet, *lpb, &rgxf[0].u_XFER_0x0004);
        if (sVar11 == 0) {
            return 0;
        }
        sVar11 = FLookupObject(grobjFleet, *(short *)((byte *)lpb + 2), &rgxf[1].u_XFER_0x0004);
        if (sVar11 == 0) {
            return 0;
        }
        if (rgxf[1].u_XFER_0x0004.fl.iPlayer != rgxf[0].u_XFER_0x0004.fl.iPlayer) {
            return 0;
        }
        for (iPass = 0; iPass < 2; iPass = iPass + 1) {
            grbit = *(ushort *)((byte *)lpb + 5);
            iLook = 0;
            for (i = 0; i < 0x10; i = i + 1) {
                if ((grbit & 1) != 0) {
                    cXfer._0_2_ = *(uint *)((byte *)lpb + iLook * 2 + 7);
                    cXfer._2_2_ = (int)(uint)cXfer >> 0xf;
                    if (((iPass == 0) && ((int)cXfer._2_2_ < 0)) || ((iPass == 1 && (-1 < (int)cXfer._2_2_)))) {
                        uVar14 = *(uint *)((int)&rgxf[0].u_XFER_0x0004 + i * 2 + 0xc);
                        iVar15 = ((int)uVar14 >> 0xf) + cXfer._2_2_ + (uint)CARRY2(uVar14, (uint)cXfer);
                        if ((iVar15 < 1) && (iVar15 < 0)) {
                            cXfer._0_2_ = -*(int *)((int)&rgxf[0].u_XFER_0x0004 + i * 2 + 0xc);
                            cXfer._2_2_ = (int)(uint)cXfer >> 0xf;
                        } else {
                            uVar14 = 0x7ffe - *(int *)((int)&rgxf[0].u_XFER_0x0004 + i * 2 + 0xc);
                            iVar15 = (int)uVar14 >> 0xf;
                            if ((iVar15 <= (int)cXfer._2_2_) && ((iVar15 < (int)cXfer._2_2_ || (uVar14 <= (uint)cXfer)))) {
                                cXfer._0_2_ = 0x7ffd - *(int *)((int)&rgxf[0].u_XFER_0x0004 + i * 2 + 0xc);
                                cXfer._2_2_ = (int)(uint)cXfer >> 0xf;
                            }
                        }
                        piVar4 = (int *)((int)&rgxf[0].u_XFER_0x0004 + i * 2 + 0xc);
                        *piVar4 = *piVar4 + (uint)cXfer;
                    }
                    if (((iPass == 0) && ((0 < (int)cXfer._2_2_ || (-1 < (int)cXfer._2_2_)))) ||
                        ((iPass == 1 && (((int)cXfer._2_2_ < 1 && ((int)cXfer._2_2_ < 0)))))) {
                        uVar14 = *(uint *)((int)rgcXfer + i * 2 + -0x70);
                        iVar15 = (((int)uVar14 >> 0xf) - cXfer._2_2_) - (uint)(uVar14 < (uint)cXfer);
                        if ((iVar15 < 1) && (iVar15 < 0)) {
                            cXfer._0_2_ = *(uint *)((int)rgcXfer + i * 2 + -0x70);
                        } else {
                            uVar14 = 0x7ffe - *(int *)((int)rgcXfer + i * 2 + -0x70);
                            iVar15 = (int)uVar14 >> 0xf;
                            iVar20 = -(cXfer._2_2_ + ((uint)cXfer != 0));
                            if ((iVar15 <= iVar20) && ((iVar15 < iVar20 || (uVar14 <= -(uint)cXfer)))) {
                                cXfer._0_2_ = -(0x7ffd - *(int *)((int)rgcXfer + i * 2 + -0x70));
                            }
                        }
                        piVar4 = (int *)((int)rgcXfer + i * 2 + -0x70);
                        *piVar4 = *piVar4 - (uint)cXfer;
                    }
                    iLook = iLook + 1;
                }
                grbit = grbit >> 1;
            }
        }
        FleetTransferCargoBalance(&rgxf[0].u_XFER_0x0004.fl, &rgxf[1].u_XFER_0x0004.fl);
        for (iPass = 0; iPass < 2; iPass = iPass + 1) {
            FLookupFleet(-1, &rgxf[iPass].u_XFER_0x0004.fl);
            pFVar24 = LpflFromId(((&rgxf[iPass].u_XFER_0x0004)->fl).id);
            iVar15 = (int)((ulong)pFVar24 >> 0x10);
            pFVar10 = (FLEET *)pFVar24;
            if ((pFVar10 != (FLEET *)0x0) || (iVar15 != 0)) {
                *(uint *)((int)&pFVar10->dirLong + 2) = *(uint *)((int)&pFVar10->dirLong + 2) & 0xffdf | 0x20;
            }
            i = 0;
            while ((i < 0x10 && (*(int *)((int)&rgxf[iPass].u_XFER_0x0004 + i * 2 + 0xc) == 0))) {
                i = i + 1;
            }
            if (i == 0x10) {
                FDeleteFleet(((&rgxf[iPass].u_XFER_0x0004)->fl).id, 0, 0);
            }
        }
        break;
    case rtLogFleetSplit:
    case rtLogFleetMerge:
        sVar11 = FLookupObject(grobjFleet, *lpb, &rgxf[0].u_XFER_0x0004);
        if (sVar11 == 0) {
            return 0;
        }
        if (rt == rtLogFleetSplit) {
            pFVar24 = LpflNewSplit(&rgxf[0].u_XFER_0x0004.fl);
            if (pFVar24 == (FLEET *)0x0) {
                return 0;
            }
        } else {
            vrgiflMerge = rgifl;
            vcflMerge = 0;
            if (cb == 2) {
                for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
                    pFVar10 = ((FLEET **)rglpfl)[ifl];
                    iVar15 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                    lpfl = (FLEET *)CONCAT22(iVar15, pFVar10);
                    if ((pFVar10 == (FLEET *)0x0) && (iVar15 == 0))
                        break;
                    if (((pFVar10->iPlayer == idPlayer) && (((pFVar10->wFlags_0x4 >> 10 & 1) == 0 && ((&pFVar10->pt)->x == rgxf[0].u_XFER_0x0004.fl.pt.x)))) &&
                        ((pFVar10->pt).y == rgxf[0].u_XFER_0x0004.fl.pt.y)) {
                        rgifl[vcflMerge] = lpfl->id;
                        vcflMerge = vcflMerge + 1;
                        *(uint *)((int)&pFVar10->dirLong + 2) = *(uint *)((int)&pFVar10->dirLong + 2) & 0xffdf | 0x20;
                    }
                }
            } else {
                for (i = 0; i < (int)((uint)cb / 2); i = i + 1) {
                    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                        /* WARNING: Load size is inaccurate */
                        pFVar10 = ((FLEET **)rglpfl)[ifl];
                        iVar15 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                        lpfl = (FLEET *)CONCAT22(iVar15, pFVar10);
                        if ((pFVar10 == (FLEET *)0x0) && (iVar15 == 0))
                            break;
                        if (lpfl->id == *lpb) {
                            rgifl[vcflMerge] = lpfl->id;
                            vcflMerge = vcflMerge + 1;
                            *(uint *)((int)&pFVar10->dirLong + 2) = *(uint *)((int)&pFVar10->dirLong + 2) & 0xffdf | 0x20;
                            break;
                        }
                    }
                    lpb = (byte *)lpb + 2;
                }
            }
            sVar11 = FFleetMergeAll(&rgxf[0].u_XFER_0x0004.fl);
            if (sVar11 == 0) {
                return 0;
            }
        }
        break;
    case rtLogShDef:
        uVar14 = *lpb >> 8 & 0x1f;
        iLook = *lpb >> 4 & 0xf;
        if ((game.cPlayer <= iLook) || (iLook != idPlayer)) {
            return 0;
        }
        if (uVar14 < 0x10) {
            lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iLook * 4 + rglpshdef_0x2), (SHDEF *)(*(int *)(iLook * 4 + rglpshdef) + uVar14 * 0x93));
        } else {
            if (0x19 < uVar14) {
                return 0;
            }
            lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iLook * 4 + rglpshdefSB_0x2), (SHDEF *)(*(int *)(iLook * 4 + rglpshdefSB) + (uVar14 - 0x10) * 0x93));
        }
        uVar21 = (undefined2)((ulong)lpshdef >> 0x10);
        pSVar19 = (SHDEF *)lpshdef;
        if (((pSVar19->wFlags >> 9 & 1) == 0) && ((((int)pSVar19->cExist != 0 || (*(int *)((int)&pSVar19->cExist + 2) != 0)) && ((*lpb & 0xf) != 0)))) {
            return 0;
        }
        if ((*lpb & 0xf) == 0) {
            if ((pSVar19->wFlags >> 9 & 1) == 0) {
                DestroyAllIshdef(uVar14, idPlayer);
                uVar21 = (undefined2)((ulong)lpshdef >> 0x10);
                ((SHDEF *)lpshdef)->wFlags = ((SHDEF *)lpshdef)->wFlags & 0xfdff | 0x200;
                if (uVar14 < 0x10) {
                    pcVar2 = (char *)((int)&rgplr[0].cShDef + iLook * 0xc0);
                    *pcVar2 = *pcVar2 + -1;
                } else {
                    iVar15 = *(int *)((int)&rgplr[0].wFlags_0x4 + iLook * 0xc0);
                    puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + iLook * 0xc0);
                    *puVar1 = *puVar1 & 0xfff;
                    puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + iLook * 0xc0);
                    *puVar1 = *puVar1 | iVar15 - 0x1000U & 0xf000;
                }
            }
        } else if ((*lpb & 0xf) == 1) {
            if ((pSVar19->wFlags >> 9 & 1) != 0) {
                if (uVar14 < 0x10) {
                    pcVar2 = (char *)((int)&rgplr[0].cShDef + iLook * 0xc0);
                    *pcVar2 = *pcVar2 + '\x01';
                } else {
                    MStack_544 = *(int *)((int)&rgplr[0].wFlags_0x4 + iLook * 0xc0) + 0x1000 & 0xf000;
                    puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + iLook * 0xc0);
                    *puVar1 = *puVar1 & 0xfff;
                    pMVar3 = (MessageId *)((int)&rgplr[0].wFlags_0x4 + iLook * 0xc0);
                    *pMVar3 = *pMVar3 | MStack_544;
                }
            }
            if (uVar14 < 0x10) {
                sVar11 = FReadShDef((RTSHDEF *)CONCAT22(lpb._2_2_, (byte *)lpb + 2),
                                    (SHDEF *)CONCAT22(*(undefined2 *)(iLook * 4 + rglpshdef_0x2), (SHDEF *)*(undefined2 *)(iLook * 4 + rglpshdef)), idPlayer);
                if (sVar11 == 0) {
                    pcVar2 = (char *)((int)&rgplr[0].cShDef + iLook * 0xc0);
                    *pcVar2 = *pcVar2 + -1;
                    return 0;
                }
            } else {
                sVar11 =
                    FReadShDef((RTSHDEF *)CONCAT22(lpb._2_2_, (byte *)lpb + 2),
                               (SHDEF *)CONCAT22(*(undefined2 *)(iLook * 4 + rglpshdefSB_0x2), (SHDEF *)*(undefined2 *)(iLook * 4 + rglpshdefSB)), idPlayer);
                if (sVar11 == 0) {
                    iVar15 = *(int *)((int)&rgplr[0].wFlags_0x4 + iLook * 0xc0);
                    puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + iLook * 0xc0);
                    *puVar1 = *puVar1 & 0xfff;
                    puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + iLook * 0xc0);
                    *puVar1 = *puVar1 | iVar15 - 0x1000U & 0xf000;
                    return 0;
                }
            }
        }
        break;
    case rtLogPlanetProdQ:
        lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
        pPStack_546 = (PLANET *)lpPlanets;
        MStack_544 = lpPlanets._2_2_;
        lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
        lpplMac._2_2_ = lpPlanets._2_2_;
        while (true) {
            if (((PLANET *)lpplMac <= (PLANET *)lppl) || (lppl->id == *lpb))
                break;
            lppl = (PLANET *)lppl + 1;
        }
        if ((((PLANET *)lppl == (PLANET *)lpplMac) && (lppl._2_2_ == lpPlanets._2_2_)) || (((PLANET *)lppl)->iPlayer != idPlayer)) {
            return 0;
        }
        uVar14 = (cb - 2U) / 4;
        if (uVar14 == 0) {
            if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) && (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
                return 1;
            }
            /* WARNING: Load size is inaccurate */
            FreeLp((void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2), ((PLANET *)lppl)->lpplprod), htOrd);
            *(undefined2 *)&((PLANET *)lppl)->lpplprod = 0;
            *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = 0;
        } else {
            if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) && (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
                pPVar23 = LpplAlloc(4, uVar14 + 2, htOrd);
                *(PL **)&((PLANET *)lppl)->lpplprod = (PL *)pPVar23;
                *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = (int)((ulong)pPVar23 >> 0x10);
            } else if (((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMax < uVar14) {
                pPVar23 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2), *(PL **)&((PLANET *)lppl)->lpplprod), uVar14 + 2);
                *(PL **)&((PLANET *)lppl)->lpplprod = (PL *)pPVar23;
                *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2) = (int)((ulong)pPVar23 >> 0x10);
            }
            for (iPass = 0; iPass < (int)uVar14; iPass = iPass + 1) {
                uVar29 = __aFulshr(uVar30, cOut);
                if ((uVar29 & 0x7f) != 0) {
                    for (iLook = 0; iLook < (int)(uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac; iLook = iLook + 1) {
                        uVar29 = __aFulshr(uVar30, cOut);
                        if ((uVar29 & 0x7f) != 0) {
                            uVar29 = __aFulshr(uVar30, cOut);
                            local_54a = (uint)uVar29 & 0x7f;
                            pPStack_546 = *(PLANET **)((byte *)lpb + iPass * 4 + 2);
                            MStack_544 = *(MessageId *)((byte *)lpb + iPass * 4 + 2 + 2);
                            local_548 = (COLDROP *)0x0;
                            uVar29 = __aFulshr(uVar30, cOut);
                            if ((local_54a == ((uint)uVar29 & 0x7f)) && (local_548 == (COLDROP *)0x0)) {
                                uVar29 = __aFulshr(uVar30, cOut);
                                local_54a = (uint)uVar29 & 7;
                                pPStack_546 = *(PLANET **)((byte *)lpb + iPass * 4 + 2);
                                MStack_544 = *(MessageId *)((byte *)lpb + iPass * 4 + 2 + 2);
                                local_548 = (COLDROP *)0x0;
                                uVar29 = __aFulshr(uVar30, cOut);
                                if ((local_54a == ((uint)uVar29 & 7)) && (local_548 == (COLDROP *)0x0)) {
                                    uVar21 = *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2);
                                    puVar17 = (undefined2 *)(*(int *)&((PLANET *)lppl)->lpplprod + 4 + iLook * 4);
                                    uVar13 = puVar17[1];
                                    uVar7 = *(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2);
                                    puVar18 = (undefined2 *)(*(int *)&((PLANET *)lppl)->lpplprod + 4 + iLook * 4);
                                    *puVar18 = *puVar17;
                                    puVar18[1] = uVar13 & 0xf80f;
                                    break;
                                }
                            }
                        }
                    }
                    if (iLook == (uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac) {
                        uVar13 = *(uint *)((byte *)lpb + iPass * 4 + 2 + 2);
                        *(undefined2 *)((byte *)lpb + iPass * 4 + 2) = *(undefined2 *)((byte *)lpb + iPass * 4 + 2);
                        *(uint *)((byte *)lpb + iPass * 4 + 2 + 2) = uVar13 & 0xf80f;
                    }
                }
            }
            __fmemmove((void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2), (void *)(*(int *)&((PLANET *)lppl)->lpplprod + 4)),
                       (byte *)lpb + 2, uVar14 << 2);
            ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac = (byte)uVar14;
        }
        break;
    case rtLogBattlePlan:
        uVar14 = *lpb >> 4 & 0xf;
        if (((*lpb & 0xf) == idPlayer) && (uVar14 <= ((byte *)rgcbtlplan)[idPlayer])) {
            if ((*lpb >> 0xe & 1) == 0) {
                if (6 < (*lpb >> 8 & 0xf)) {
                    return 0;
                }
                if (8 < (*(uint *)((byte *)lpb + 2) & 0xf)) {
                    return 0;
                }
                if (8 < (*(uint *)((byte *)lpb + 2) >> 4 & 0xf)) {
                    return 0;
                }
                if (uVar14 == ((byte *)rgcbtlplan)[idPlayer]) {
                    if (0xf < uVar14) {
                        return 0;
                    }
                    ((byte *)rgcbtlplan)[idPlayer] = ((byte *)rgcbtlplan)[idPlayer] + 1;
                }
                UnpackBattlePlan(lpb,
                                 (BTLPLAN *)CONCAT22(*(undefined2 *)((int)(BTLPLAN **)rglpbtlplan + idPlayer * 4 + 2),
                                                     (BTLPLAN *)(*(int *)((BTLPLAN **)rglpbtlplan + idPlayer) + uVar14 * 0x24)),
                                 uVar14);
            } else {
                FDeleteBattlePlan(uVar14, 0);
            }
        } else if ((*lpb >> 0xe & 1) == 0) {
            return 0;
        }
        break;
    case rtLogResearch:
        bVar6 = *lpb;
        if ((-1 < (char)bVar6) && ((char)bVar6 < 'e')) {
            *(byte *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) = bVar6;
            bVar6 = ((byte *)lpb)[1];
            if (((bVar6 & 0xf) < 6) && (((char)bVar6 >> 4 & 0xfU) < 8)) {
                *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) = bVar6;
                return 1;
            }
        }
        return 0;
    case rtLogPlanetRouting:
        pPVar27 = LpplFromId(*lpb);
        iVar15 = (int)((ulong)pPVar27 >> 0x10);
        pPVar8 = (PLANET *)pPVar27;
        if ((pPVar8 == (PLANET *)0x0) && (iVar15 == 0)) {
            return 0;
        }
        if (pPVar8->iPlayer != idPlayer) {
            return 0;
        }
        pPStack_546 = (PLANET *)(*(uint *)((byte *)lpb + 2) & 1);
        MStack_544 = 0;
        lVar28 = __aFlshl(uVar30, cOut);
        local_54a = *(uint *)(pPVar8->rgbImp + 4) | (uint)lVar28;
        local_548 = (COLDROP *)(*(uint *)(pPVar8->rgbImp + 6) & 0xff7f | (uint)((ulong)lVar28 >> 0x10));
        *(uint *)(pPVar8->rgbImp + 4) = local_54a;
        *(COLDROP **)(pPVar8->rgbImp + 6) = local_548;
        uVar29 = __aFulshr(uVar30, cOut);
        MStack_544 = (uint)uVar29 & 0x3ff;
        *(uint *)((int)&pPVar8->lStarbase + 2) = *(uint *)((int)&pPVar8->lStarbase + 2) & 0xfc00 | MStack_544;
        uVar29 = __aFulshr(uVar30, cOut);
        MStack_544 = (uint)uVar29 & 0xf;
        *(uint *)((int)&pPVar8->lStarbase + 2) = *(uint *)((int)&pPVar8->lStarbase + 2) & 0xc3ff | MStack_544 << 10;
        uVar30 = __aFulshr(uVar30, cOut);
        pPVar8->wRouting = pPVar8->wRouting & 0xfc00 | (uint)uVar30 & 0x3ff;
        break;
    case rtLogPlayerSalt:
        if (((uint)gd.grBits >> 1 & 1) != 0) {
            uVar21 = *(undefined2 *)((byte *)lpb + 2);
            iVar15 = idPlayer * 0xc0;
            *(undefined2 *)((int)&rgplr[0].lSalt + iVar15) = *lpb;
            *(undefined2 *)((int)&rgplr[0].lSalt + 2 + iVar15) = uVar21;
        }
        break;
    case rtLogRelations:
        __fmemcpy((void *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0), lpb, game.cPlayer);
        break;
    case rtLogFleetPlan:
        pFVar24 = LpflFromId(*lpb);
        if (pFVar24 == (FLEET *)0x0) {
            return 0;
        }
        ((FLEET *)pFVar24)->iplan = (byte) * (undefined2 *)((byte *)lpb + 2);
        break;
    case rtLogThingByteParam:
        pTVar26 = LpthFromId(*lpb);
        if ((pTVar26 == (THING *)0x0) || (pTVar26->idFull >> 0xd != 0)) {
            return 0;
        }
        *(undefined1 *)((int)&((THING *)pTVar26)->u_THING_0x0006 + 7) = (char)*(undefined2 *)((byte *)lpb + 2);
        break;
    case rtLogFleetName:
        cOut = 0x20;
        pFVar24 = LpflFromId(*lpb);
        uVar21 = (undefined2)((ulong)pFVar24 >> 0x10);
        pFVar10 = (FLEET *)pFVar24;
        if (pFVar24 == (FLEET *)0x0) {
            return 0;
        }
        if ((*(int *)&pFVar10->lpszName != 0) || (*(int *)((int)&pFVar10->lpszName + 2) != 0)) {
            /* WARNING: Load size is inaccurate */
            FreeLp((void *)CONCAT22(*(undefined2 *)((int)&pFVar10->lpszName + 2), pFVar10->lpszName), htString);
        }
        if ((((byte *)lpb)[4] == 0) || (sVar11 = FDecompressUserString((char *)((byte *)lpb + 5), (uint)((byte *)lpb)[4], local_564, &cOut), sVar11 == 0)) {
            if (((byte *)lpb)[5] == 0) {
                *(undefined2 *)&pFVar10->lpszName = 0;
                *(undefined2 *)((int)&pFVar10->lpszName + 2) = 0;
            } else {
                HVar31 = htString;
                uVar12 = __fstrlen((char *)((byte *)lpb + 5));
                pvVar25 = LpAlloc(uVar12 + 1, HVar31);
                *(void **)&pFVar10->lpszName = (void *)pvVar25;
                *(undefined2 *)((int)&pFVar10->lpszName + 2) = (int)((ulong)pvVar25 >> 0x10);
                /* WARNING: Load size is inaccurate */
                __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&pFVar10->lpszName + 2), pFVar10->lpszName), (char *)((byte *)lpb + 5));
            }
        } else {
            HVar31 = htString;
            uVar12 = _strlen(local_564);
            pvVar25 = LpAlloc(uVar12 + 1, HVar31);
            *(void **)&pFVar10->lpszName = (void *)pvVar25;
            *(undefined2 *)((int)&pFVar10->lpszName + 2) = (int)((ulong)pvVar25 >> 0x10);
            /* WARNING: Load size is inaccurate */
            __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)&pFVar10->lpszName + 2), pFVar10->lpszName), local_564);
        }
        break;
    case rtLogPlayerZpq1:
        if (((uint)gd.grBits >> 1 & 1) != 0) {
            if (0x1a < (uint)cb) {
                return 0;
            }
            __fmemcpy((void *)((int)&rgplr[0].zpq1 + idPlayer * 0xc0), lpb, cb);
        }
    }
    return 1;
}

// ======================================================================
// Function: FLoadLogFile
// Address: 1048:c7a2
// Segment: MEMORY_PLANET
// ======================================================================

short FLoadLogFile(char *pszLog)

{
    MSGPLR *pMVar1;
    short (*pasVar2)[9];
    undefined2  uVar3;
    short       sVar4;
    HRSRC       HVar5;
    int         iVar6;
    TURNSERIAL *pTVar7;
    undefined2  uVar8;
    bool        bVar9;
    void       *pvVar10;
    short       cSkip;
    ushort      hrsrc;
    MSGPLR     *lpmp;
    short       iCur;
    short       cbLog;
    short       fRet;
    short       env[9];
    short (*penvMemSav)[9];
    ushort hres;

    pasVar2 = penvMem;
    imemLogCur = 0;
    imemLogPrev = -1;
    penvMem = &env;
    sVar4 = __setjmp(env);
    if (sVar4 != 0) {
        if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
            if (hf != -1) {
                penvMem = pasVar2;
                StreamClose();
                return 0;
            }
            penvMem = pasVar2;
            return 1;
        }
        penvMem = pasVar2;
        GlobalUnlock(hres);
        FreeResource(hres);
        return 0;
    }
    if ((((game.wCrap >> 3 & 1) == 0) || (idPlayer != 0)) || (((uint)gd.grBits >> 1 & 1) == 0)) {
    PLANET_StrOpen:
        StreamOpen(pszLog, 0x4020);
    LAB_1048_c944:
        ReadRt();
        if ((((int)game.lid == rgbCur._4_2_) && (game.lid._2_2_ == rgbCur._6_2_)) && (game.turn <= (uint)rgbCur._10_2_)) {
            if (rgbCur._10_2_ == game.turn) {
                if ((uint)rgbCur._14_2_ >> 0xd == (game.wCrap >> 9 & 7)) {
                    wVersFile._0_1_ = rgbCur[8];
                    wVersFile._1_1_ = rgbCur[9];
                    gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffb | ((uint)rgbCur._14_2_ >> 0xc & 1) << 2;
                    if (((uint)gd.grBits >> 1 & 1) != 0) {
                        *(uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0) =
                            *(uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0) & 0xfffd | ((uint)rgbCur._14_2_ >> 0xc & 1) << 1;
                    }
                    ReadRt();
                    uVar3 = rgbCur._0_2_;
                    if ((((uint)gd.grBits >> 1 & 1) != 0) && ((((TURNSERIAL *)vrgts != (TURNSERIAL *)0x0 || (vrgts._2_2_ != 0)) &&
                                                               (__fmemset((TURNSERIAL *)CONCAT22(vrgts._2_2_, (TURNSERIAL *)vrgts + idPlayer), 0, 0x10),
                                                                uVar8 = rgbCur._4_2_, iVar6 = vrgts._2_2_, (hdrCur.wFlags & 0x3ff) == 0x11)))) {
                        pTVar7 = (TURNSERIAL *)vrgts + idPlayer;
                        *&pTVar7->lSerialNumber = rgbCur._2_2_;
                        *(undefined2 *)(char *)((int)&pTVar7->lSerialNumber + 2) = uVar8;
                        __fmemcpy((byte *)CONCAT22(vrgts._2_2_, ((TURNSERIAL *)vrgts)[idPlayer].rgbConfig), rgbCur + 6, 0xb);
                    }
                    for (iCur = 0; iCur < (int)uVar3; iCur = iCur + (hdrCur.wFlags & 0x3ff) + 2) {
                        ReadRt();
                        __fmemmove((byte *)CONCAT22(lpLog._2_2_, (byte *)lpLog + iCur), &hdrCur, 2);
                        __fmemmove((byte *)CONCAT22(lpLog._2_2_, (byte *)lpLog + iCur + 2), rgbCur, hdrCur.wFlags & 0x3ff);
                    }
                    ReadRt();
                    lpmp = &vlpmsgplrOut;
                    while (true) {
                        uVar8 = (undefined2)((ulong)lpmp >> 0x10);
                        if ((*&lpmp->lpmsgplrNext == 0) && (*(int *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2) == 0))
                            break;
                        /* WARNING: Load size is inaccurate */
                        lpmp = (MSGPLR *)CONCAT22(*(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2), lpmp->lpmsgplrNext);
                    }
                    while (uVar8 = rgbCur._0_2_, hdrCur.wFlags >> 10 == 0x28) {
                        pvVar10 = LpAlloc(hdrCur.wFlags & 0x3ff, htPlrMsg);
                        uVar8 = (undefined2)((ulong)lpmp >> 0x10);
                        *&lpmp->lpmsgplrNext = (void *)pvVar10;
                        *(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2) = (int)((ulong)pvVar10 >> 0x10);
                        /* WARNING: Load size is inaccurate */
                        pMVar1 = lpmp->lpmsgplrNext;
                        uVar8 = *(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2);
                        lpmp = (MSGPLR *)CONCAT22(uVar8, pMVar1);
                        __fmemcpy((MSGPLR *)CONCAT22(uVar8, pMVar1), rgbCur, hdrCur.wFlags & 0x3ff);
                        *&lpmp->lpmsgplrNext = 0;
                        *(undefined2 *)((int)&pMVar1->lpmsgplrNext + 2) = 0;
                        vcmsgplrOut = vcmsgplrOut + 1;
                        ReadRt();
                    }
                    bVar9 = hdrCur.wFlags >> 10 == 0;
                    if (bVar9) {
                        rgbCur[0] = (char)uVar3;
                        rgbCur[1] = SUB21(uVar3, 1);
                        imemLogCur._0_1_ = rgbCur[0];
                        imemLogCur._1_1_ = rgbCur[1];
                    }
                    fRet = (short)bVar9;
                    rgbCur._0_2_ = uVar8;
                    if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
                        StreamClose();
                    } else {
                        GlobalUnlock(hres);
                        FreeResource(hres);
                        vlpMemStream = (byte *)0x0;
                    }
                    penvMem = pasVar2;
                    DirtyGame(0);
                    return fRet;
                }
                FileError(idsFileGame);
            } else {
                FileError(idsLogFileRecentGameTryingLoadIgnoring);
            }
        }
        if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
            StreamClose();
        } else {
            vlpMemStream = (byte *)0x0;
            GlobalUnlock(hres);
            FreeResource(hres);
        }
        sVar4 = 1;
    } else {
        cSkip = game.turn;
        HVar5 = FindResource(hInst, (LPCSTR)0x2711, (LPCSTR)0x2710);
        hres = LoadResource(hInst, HVar5);
        if (hres != 0) {
            vlpMemStream = LockResource(hres);
            iVar6 = (int)((ulong)vlpMemStream >> 0x10);
            if (((byte *)vlpMemStream != (byte *)0x0) || (iVar6 != 0)) {
                if (*vlpMemStream <= game.turn) {
                    vlpMemStream = (byte *)0x0;
                    GlobalUnlock(hres);
                    FreeResource(hres);
                    goto PLANET_StrOpen;
                }
                vlpMemStream = (byte *)CONCAT22(iVar6, (byte *)vlpMemStream + 1);
                while (iVar6 = cSkip + -1, cSkip != 0) {
                    do {
                        vlpMemStream = (byte *)CONCAT22(vlpMemStream._2_2_, (byte *)vlpMemStream + (*vlpMemStream & 0x3ff) + 2);
                        cSkip = iVar6;
                    } while (*vlpMemStream >> 10 != 8);
                }
                goto LAB_1048_c944;
            }
        }
        sVar4 = 0;
    }
    penvMem = pasVar2;
    return sVar4;
}

// ======================================================================
// Function: FCheckLogFile
// Address: 1048:cccc
// Segment: MEMORY_PLANET
// ======================================================================

short FCheckLogFile(short iplr, short *pfError)

{
    short (*pasVar1)[9];
    undefined2 uVar2;
    undefined2 uVar3;
    short      sVar4;
    bool       bVar5;
    short      iCur;
    short      cbLog;
    short      fRet;
    short      env[9];
    short (*penvMemSav)[9];

    pasVar1 = penvMem;
    imemLogCur = 0;
    imemLogPrev = -1;
    penvMem = &env;
    sVar4 = __setjmp(env);
    if (sVar4 == 0) {
        idsFileError = 0;
        sVar4 = FOpenFile(dtLog, iplr, 0x20);
        if (sVar4 == 0) {
            if (idsFileError != 4) {
                *pfError = idsFileError;
            }
            fRet = 0;
        } else {
            ReadRt();
            uVar2 = rgbCur._0_2_;
            for (iCur = 0; iCur < (int)uVar2; iCur = iCur + (hdrCur.wFlags & 0x3ff) + 2) {
                ReadRt();
            }
            ReadRt();
            while (uVar3 = rgbCur._0_2_, hdrCur.wFlags >> 10 == 0x28) {
                ReadRt();
            }
            bVar5 = hdrCur.wFlags >> 10 != 0;
            if (bVar5) {
                *pfError = 3;
            } else {
                rgbCur[0] = (char)uVar2;
                rgbCur[1] = SUB21(uVar2, 1);
                imemLogCur._0_1_ = rgbCur[0];
                imemLogCur._1_1_ = rgbCur[1];
                rgbCur._0_2_ = uVar3;
            }
            fRet = (short)!bVar5;
            StreamClose();
            penvMem = pasVar1;
        }
    } else if (hf == -1) {
        fRet = 1;
        penvMem = pasVar1;
    } else {
        penvMem = pasVar1;
        StreamClose();
        *pfError = 3;
        fRet = 0;
    }
    return fRet;
}

// ======================================================================
// Function: FWriteLogFile
// Address: 1048:cdf6
// Segment: MEMORY_PLANET
// ======================================================================

short FWriteLogFile(char *pszFileBase, short iPlayer)

{
    short (*pasVar1)[9];
    ushort     cb_00;
    short      sVar2;
    char      *sz;
    undefined2 unaff_SS;
    MSGPLR    *pMVar3;
    undefined2 uVar4;
    short      cb;
    MSGPLR    *lpmp;
    RTLOGHDR   rtlh;
    HDR       *lprts;
    short      iCur;
    short      env[9];
    short (*penvMemSav)[9];

    iCur = 0;
    if (((iPlayer == idPlayer) && ((*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 9 & 1) == 0)) && (hdrPrev.wFlags >> 10 != 0x2e)) {
        cb_00 = (0xc - (uint)(byte)vrgZipProd[0].u_ZIPPRODQ_0x000e._1_1_) * -2 + 0x1a;
        sVar2 = _memcmp((void *)((int)&rgplr[0].zpq1 + iPlayer * 0xc0), (ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1, cb_00);
        if (sVar2 != 0) {
            WriteMemRt(0x2e, cb_00, (ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1);
        }
    }
    _strcpy((char *)szBase, pszFileBase);
    sVar2 = FCreateFile(dtLog, iPlayer, (char *)0x0);
    pasVar1 = penvMem;
    if (sVar2 == 0) {
        sVar2 = 0x10;
        sz = PszFormatIds(idsUnableCreateLogFile, (short *)0x0);
        AlertSz(sz, sVar2);
        sVar2 = 0;
    } else {
        penvMem = &env;
        sVar2 = __setjmp(env);
        if (sVar2 == 0) {
            rtlh.cbLog = imemLogCur;
            rtlh.lSerialNumber._0_2_ = (undefined2)vSerialNumber;
            rtlh.lSerialNumber._2_2_ = vSerialNumber._2_2_;
            _memcpy(rtlh.rgbConfig, (byte_0_ *)&vrgbEnvCur, 0xb);
            WriteRt(9, 0x11, &rtlh);
            for (; iCur < imemLogCur; iCur = iCur + (lprts->wFlags & 0x3ff) + 2) {
                lprts = (HDR *)CONCAT22(lpLog._2_2_, (byte *)lpLog + iCur);
                WriteRt(lprts->wFlags >> 10, lprts->wFlags & 0x3ff, (byte *)CONCAT22(lpLog._2_2_, (byte *)lpLog + iCur + 2));
            }
            iCur = vcmsgplrOut;
            lpmp = (MSGPLR *)CONCAT22(vlpmsgplrOut._2_2_, (MSGPLR *)vlpmsgplrOut);
            while (iCur != 0) {
                pMVar3 = (MSGPLR *)lpmp;
                uVar4 = lpmp._2_2_;
                sVar2 = _abs(((MSGPLR *)lpmp)->cLen);
                WriteRt(0x28, sVar2 + 0xc, (MSGPLR *)CONCAT22(uVar4, pMVar3));
                /* WARNING: Load size is inaccurate */
                lpmp = (MSGPLR *)CONCAT22(*(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2), lpmp->lpmsgplrNext);
                iCur = iCur + -1;
            }
            WriteRt(0, 0, (void *)0x0);
            StreamClose();
            penvMem = pasVar1;
            DirtyGame(0);
            gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfeff | 0x100;
            sVar2 = 1;
        } else {
            penvMem = pasVar1;
            StreamClose();
            sVar2 = 0;
        }
    }
    return sVar2;
}

// ======================================================================
// Function: FWriteTutorialMFile
// Address: 1048:d058
// Segment: MEMORY_PLANET
// ======================================================================

short FWriteTutorialMFile(short iTurn)

{
    short (*pasVar1)[9];
    short   sVar2;
    HGLOBAL HVar3;
    char   *pcVar4;
    int     iVar5;
    short   cSkip;
    short   cch;
    short   env[9];
    short (*penvMemSav)[9];
    ushort hres;
    char   szT[30];
    ushort hrsrc;

    pasVar1 = penvMem;
    cSkip = iTurn;
    penvMem = &env;
    sVar2 = __setjmp(env);
    if (sVar2 == 0) {
        if (iTurn < 0x20) {
            hrsrc = FindResource(hInst, (LPCSTR)0x2713, (LPCSTR)0x2712);
        } else {
            hrsrc = FindResource(hInst, (LPCSTR)0x2715, (LPCSTR)0x2714);
            cSkip = iTurn + -0x20;
        }
        HVar3 = LoadResource(hInst, hrsrc);
        if (HVar3 != 0) {
            vlpMemStream = LockResource(HVar3);
            iVar5 = (int)((ulong)vlpMemStream >> 0x10);
            if (((byte *)vlpMemStream != (byte *)0x0) || (iVar5 != 0)) {
                if (cSkip < (int)(uint)*vlpMemStream) {
                    vlpMemStream = (byte *)CONCAT22(iVar5, (byte *)vlpMemStream + 1);
                    while (iVar5 = cSkip + -1, cSkip != 0) {
                        do {
                            vlpMemStream = (byte *)CONCAT22(vlpMemStream._2_2_, (byte *)vlpMemStream + (*vlpMemStream & 0x3ff) + 2);
                            cSkip = iVar5;
                        } while (*vlpMemStream >> 10 != 8);
                    }
                    sVar2 = CchGetString(idsTutorial, szT);
                    if (iTurn == 0x25) {
                        pcVar4 = (char *)0x9aa;
                    } else {
                        pcVar4 = (char *)0x9af;
                    }
                    _strcpy(szT + sVar2, pcVar4);
                    StreamOpen(szT, 0x1012);
                    do {
                        RgToStream(vlpMemStream, (*vlpMemStream & 0x3ff) + 2);
                        vlpMemStream = (byte *)CONCAT22(vlpMemStream._2_2_, (byte *)vlpMemStream + (*vlpMemStream & 0x3ff) + 2);
                    } while (*vlpMemStream >> 10 != 8);
                    StreamClose();
                    vlpMemStream = (byte *)0x0;
                    GlobalUnlock(HVar3);
                    FreeResource(HVar3);
                    penvMem = pasVar1;
                    return 1;
                }
                vlpMemStream = (byte *)0x0;
                GlobalUnlock(HVar3);
                FreeResource(HVar3);
                penvMem = pasVar1;
                return 2;
            }
        }
        sVar2 = 0;
        penvMem = pasVar1;
    } else if (((byte *)vlpMemStream == (byte *)0x0) && (vlpMemStream._2_2_ == 0)) {
        if (hf == -1) {
            sVar2 = 1;
            penvMem = pasVar1;
        } else {
            penvMem = pasVar1;
            StreamClose();
            sVar2 = 0;
        }
    } else {
        penvMem = pasVar1;
        GlobalUnlock(hres);
        FreeResource(hres);
        sVar2 = 0;
    }
    return sVar2;
}

// ======================================================================
// Function: FWriteHistFile
// Address: 1048:d29e
// Segment: MEMORY_PLANET
// ======================================================================

short FWriteHistFile(short iPlayer)

{
    int iVar1;
    short (*pasVar2)[9];
    short      sVar3;
    char      *sz;
    undefined2 uVar4;
    undefined2 unaff_SS;
    byte      *lpb;
    RTHISTHDR  rthh;
    short      j;
    SHDEF     *lpshdef;
    ushort     cTurnBase;
    short      env[9];
    short (*penvMemSav)[9];
    short   i;
    PLANET *lppl;

    sVar3 = FCreateFile(dtHist, iPlayer, (char *)0x0);
    pasVar2 = penvMem;
    if (sVar3 == 0) {
        sVar3 = 0x10;
        sz = PszFormatIds(idsUnableCreateHistoryFile, (short *)0x0);
        AlertSz(sz, sVar3);
        sVar3 = 0;
    } else {
        penvMem = &env;
        sVar3 = __setjmp(env);
        if (sVar3 == 0) {
            rthh.cPlanet = cPlanet;
            rthh.cPlanetExtra = *(uint *)((int)&rgplr[0].wFlags_0x4 + iPlayer * 0xc0) & 0xfff;
            WriteRt(0x20, 4, &rthh);
            lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
            for (i = 0; i < cPlanet; i = i + 1) {
                uVar4 = (undefined2)((ulong)lppl >> 0x10);
                if ((((PLANET *)lppl)->wFlags_0x4 & 0xff) < 3) {
                    sVar3 = 0xf;
                } else {
                    sVar3 = 0xe;
                }
                WritePlanet(lppl, sVar3, 1);
                lppl = (PLANET *)CONCAT22(uVar4, (PLANET *)lppl + 1);
            }
            WriteRt(0x21, cbbitfMsg, bitfMsgFiltered);
            for (i = 0; i < game.cPlayer; i = i + 1) {
                if ((i != iPlayer) && ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) & 7) != 0)) {
                    WriteRtPlr((PLAYER *)rgplr + i, (byte *)0x0);
                }
            }
            for (i = 0; i < game.cPlayer; i = i + 1) {
                if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) && (i != iPlayer)) {
                    iVar1 = *(int *)(i * 4 + rglpshdef);
                    uVar4 = *(undefined2 *)(i * 4 + rglpshdef_0x2);
                    for (j = 0; j < 0x10; j = j + 1) {
                        if ((*(uint *)(iVar1 + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
                            WriteRtShDef((SHDEF *)CONCAT22(uVar4, (SHDEF *)(iVar1 + j * 0x93)), (byte **)0x0);
                        }
                    }
                }
            }
            for (i = 0; i < game.cPlayer; i = i + 1) {
                if (((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) && (i != iPlayer)) {
                    iVar1 = *(int *)(i * 4 + rglpshdefSB);
                    uVar4 = *(undefined2 *)(i * 4 + rglpshdefSB_0x2);
                    for (j = 0; j < 10; j = j + 1) {
                        if ((*(uint *)(iVar1 + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
                            WriteRtShDef((SHDEF *)CONCAT22(uVar4, (SHDEF *)(iVar1 + j * 0x93)), (byte **)0x0);
                        }
                    }
                }
            }
            if (game.turn < 0x65) {
                cTurnBase = 0;
            } else {
                cTurnBase = game.turn - 100;
            }
            for (i = 0; i < game.cPlayer; i = i + 1) {
                if ((*(int *)((SCOREX **)rgsxPlr + i) != 0) || (*(int *)((int)(SCOREX **)rgsxPlr + i * 4 + 2) != 0)) {
                    for (j = 0; j < ((short *)rgcsxPlr)[i]; j = j + 1) {
                        if (cTurnBase <= *(uint *)(*(int *)((SCOREX **)rgsxPlr + i) + j * 0x18 + 2)) {
                            WriteRt(
                                0x2d, 0x18,
                                (void *)CONCAT22(*(undefined2 *)((int)(SCOREX **)rgsxPlr + i * 4 + 2), (void *)(*(int *)((SCOREX **)rgsxPlr + i) + j * 0x18)));
                        }
                    }
                }
            }
            iVar1 = vlpbAiData._2_2_;
            if ((((byte *)vlpbAiData != (byte *)0x0) || (vlpbAiData._2_2_ != 0)) && (2 < *vlpbAiData)) {
                i = *vlpbAiData;
                lpb._0_2_ = (byte *)vlpbAiData;
                for (; 0x3ff < i; i = i + -0x3ff) {
                    WriteRt(0x29, 0x3ff, (byte *)CONCAT22(iVar1, (byte *)lpb));
                    lpb._0_2_ = (byte *)lpb + 0x3ff;
                }
                WriteRt(0x29, i, (byte *)CONCAT22(iVar1, (byte *)lpb));
            }
            WriteRt(0, 0, (void *)0x0);
            StreamClose();
            sVar3 = 1;
            penvMem = pasVar2;
        } else {
            penvMem = pasVar2;
            StreamClose();
            sVar3 = 0;
        }
    }
    return sVar3;
}

// ======================================================================
// Function: EnumLogRts
// Address: 1048:d6e0
// Segment: MEMORY_PLANET
// ======================================================================

void EnumLogRts(fn_pfn_conflict1 *pfn, void *lpPass, short iPass)

{
    short sVar1;
    HDR  *lprts;
    short iCur;
    short fRet;
    short fLogOld;

    iCur = 0;
    if (imemLogCur != 0) {
        for (; iCur < imemLogCur; iCur = iCur + (lprts->wFlags & 0x3ff) + 2) {
            lprts = (HDR *)CONCAT22(lpLog._2_2_, (byte *)lpLog + iCur);
            sVar1 = (*(fn_pfn_conflict1 *)pfn)((byte *)lpLog + iCur + 2, lpLog._2_2_, (void *)(lprts->wFlags >> 10), (void *)(lprts->wFlags & 0x3ff),
                                               (void *)lpPass);
            if (sVar1 == 0) {
                return;
            }
        }
    }
    return;
}
