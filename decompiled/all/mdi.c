// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: InitMDIApp
// Address: 1020:0000
// Segment: MEMORY_MDI
// ======================================================================


short InitMDIApp(void)

{
  ATOM AVar1;
  short sVar2;
  undefined2 unaff_SS;
  WNDCLASS wc;
  
                    /* Segment:    5
                       Offset:     00013700
                       Length:     983f
                       Min Alloc:  9840
                       Flags:      1d50
                           Code
                           Discardable
                           Moveable
                           Preload
                           Impure (Non-shareable)
                        */
  wc.style = 0xb;
  wc.field1_0x2 = 0xd6;
  wc.field2_0x3 = 6;
  wc._4_2_ = SUB42(&DAT_1120_1020,0);
  wc.cbClsExtra = 0;
  wc.cbWndExtra = 0;
  wc.hInstance = hInst;
  wc.hIcon = 0;
  wc.hCursor = LoadCursor(0,&DAT_0000_7f00);
  wc.hbrBackground = 0xd;
  wc.lpszMenuName._0_2_ = (char *)s_StarsMenu_1120_0364;
  wc.lpszMenuName._2_2_ = (undefined1 *)&DAT_1120_1120;
  wc.lpszClassName._0_2_ = (char *)szFrame;
  wc.lpszClassName._2_2_ = (undefined1 *)&DAT_1120_1120;
  AVar1 = RegisterClass((undefined2 *)CONCAT22(unaff_SS,&wc));
  if (AVar1 == 0) {
    sVar2 = 0;
  }
  else {
    wc.style = 0x20b;
    wc.field1_0x2 = 0x92;
    wc.field2_0x3 = 0x5c;
    wc._4_2_ = SUB42(&DAT_1120_1030,0);
    wc.hIcon = 0;
    wc.lpszMenuName._0_2_ = (char *)0x0;
    wc.lpszMenuName._2_2_ = (undefined1 *)0x0;
    wc.hbrBackground = GetStockObject(1);
    wc.lpszClassName._0_2_ = (char *)szMessage;
    wc.lpszClassName._2_2_ = (undefined1 *)&DAT_1120_1120;
    AVar1 = RegisterClass((undefined2 *)CONCAT22(unaff_SS,&wc));
    if (AVar1 == 0) {
      sVar2 = 0;
    }
    else {
      wc.style = 0x20b;
      wc.field1_0x2 = 0x32;
      wc.field2_0x3 = 0;
      wc._4_2_ = SUB42(&DAT_1120_1058,0);
      wc.hbrBackground = GetStockObject(4);
      wc.lpszClassName._0_2_ = (char *)szScan;
      wc.lpszClassName._2_2_ = (undefined1 *)&DAT_1120_1120;
      AVar1 = RegisterClass((undefined2 *)CONCAT22(unaff_SS,&wc));
      if (AVar1 == 0) {
        sVar2 = 0;
      }
      else {
        wc.style = 0x20b;
        wc.field1_0x2 = 0;
        wc.field2_0x3 = 0;
        wc._4_2_ = SUB42(&DAT_1120_1028,0);
        wc.hbrBackground = GetStockObject(1);
        wc.lpszClassName._0_2_ = (char *)szMine;
        wc.lpszClassName._2_2_ = (undefined1 *)&DAT_1120_1120;
        AVar1 = RegisterClass((undefined2 *)CONCAT22(unaff_SS,&wc));
        if (AVar1 == 0) {
          sVar2 = 0;
        }
        else {
          wc.style = 0x208;
          wc.field1_0x2 = 0x1e;
          wc.field2_0x3 = 0;
          wc._4_2_ = SUB42(&DAT_1120_1068,0);
          wc.hbrBackground = GetStockObject(1);
          wc.lpszClassName._0_2_ = (char *)szTb;
          wc.lpszClassName._2_2_ = (undefined1 *)&DAT_1120_1120;
          AVar1 = RegisterClass((undefined2 *)CONCAT22(unaff_SS,&wc));
          if (AVar1 == 0) {
            sVar2 = 0;
          }
          else {
            wc.style = 0x200;
            wc.field1_0x2 = 0;
            wc.field2_0x3 = 0;
            wc._4_2_ = SUB42(&DAT_1120_1048,0);
            wc.hbrBackground = GetStockObject(1);
            wc.hIcon = 0;
            wc.lpszClassName._0_2_ = (char *)szPlanet;
            wc.lpszClassName._2_2_ = (undefined1 *)&DAT_1120_1120;
            AVar1 = RegisterClass((undefined2 *)CONCAT22(unaff_SS,&wc));
            if (AVar1 == 0) {
              sVar2 = 0;
            }
            else {
              wc.style = 0xa00;
              wc.field1_0x2 = 0;
              wc.field2_0x3 = 0;
              wc._4_2_ = SUB42(&DAT_1120_10c0,0);
              wc.hbrBackground = GetStockObject(0);
              wc.hIcon = 0;
              wc.lpszClassName._0_2_ = (char *)szPopup;
              wc.lpszClassName._2_2_ = (undefined1 *)&DAT_1120_1120;
              AVar1 = RegisterClass((undefined2 *)CONCAT22(unaff_SS,&wc));
              if (AVar1 == 0) {
                sVar2 = 0;
              }
              else {
                wc.style = 0xa00;
                wc._2_2_ = SUB42(&DAT_1120_19e4,0);
                wc._4_2_ = SUB42(&DAT_1120_1068,0);
                wc.hbrBackground = GetStockObject(0);
                wc.hIcon = 0;
                wc.lpszClassName._0_2_ = (char *)szTooltip;
                wc.lpszClassName._2_2_ = (undefined1 *)&DAT_1120_1120;
                AVar1 = RegisterClass((undefined2 *)CONCAT22(unaff_SS,&wc));
                if (AVar1 == 0) {
                  sVar2 = 0;
                }
                else {
                  wc.style = 0x200;
                  wc.field1_0x2 = 0x76;
                  wc.field2_0x3 = 0x28;
                  wc._4_2_ = SUB42(&DAT_1120_10d8,0);
                  wc.hbrBackground = GetStockObject(1);
                  wc.hIcon = 0;
                  wc.lpszClassName._0_2_ = (char *)szBrowser;
                  wc.lpszClassName._2_2_ = (undefined1 *)&DAT_1120_1120;
                  AVar1 = RegisterClass((undefined2 *)CONCAT22(unaff_SS,&wc));
                  if (AVar1 == 0) {
                    sVar2 = 0;
                  }
                  else {
                    wc.style = 0;
                    wc._2_2_ = SUB42(TitleWndProc,0);
                    wc._4_2_ = SUB42(&DAT_1120_1020,0);
                    wc.cbClsExtra = 0;
                    wc.cbWndExtra = 0;
                    wc.hInstance = hInst;
                    wc.hIcon = 0;
                    wc.hCursor = LoadCursor(0,&DAT_0000_7f00);
                    wc.hbrBackground = GetStockObject(4);
                    wc.lpszMenuName._0_2_ = (char *)0x0;
                    wc.lpszMenuName._2_2_ = (undefined1 *)0x0;
                    wc.lpszClassName._0_2_ = (char *)szTitle;
                    wc.lpszClassName._2_2_ = (undefined1 *)&DAT_1120_1120;
                    AVar1 = RegisterClass((undefined2 *)CONCAT22(unaff_SS,&wc));
                    if (AVar1 == 0) {
                      sVar2 = 0;
                    }
                    else {
                      wc.style = 0xb;
                      wc.field1_0x2 = 0x18;
                      wc.field2_0x3 = 0;
                      wc._4_2_ = SUB42(&DAT_1120_1108,0);
                      wc.cbClsExtra = 0;
                      wc.cbWndExtra = 0;
                      wc.hInstance = hInst;
                      wc.hIcon = 0;
                      wc.hCursor = LoadCursor(0,&DAT_0000_7f00);
                      wc.hbrBackground = GetStockObject(1);
                      wc.lpszMenuName._0_2_ = (char *)0x0;
                      wc.lpszMenuName._2_2_ = (undefined1 *)0x0;
                      wc.lpszClassName._0_2_ = (char *)szReport;
                      wc.lpszClassName._2_2_ = (undefined1 *)&DAT_1120_1120;
                      AVar1 = RegisterClass((undefined2 *)CONCAT22(unaff_SS,&wc));
                      if (AVar1 == 0) {
                        sVar2 = 0;
                      }
                      else {
                        sVar2 = 1;
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
  return sVar2;
}



// ======================================================================
// Function: CreateChildWindows
// Address: 1020:038c
// Segment: MEMORY_MDI
// ======================================================================


void CreateChildWindows(void)

{
  ushort uVar1;
  int iVar2;
  char *unaff_SS;
  undefined2 uVar3;
  char *pcVar4;
  char szGame [15];
  char *psz;
  POINT pt;
  char szData [100];
  
  if (idPlayer == -1) {
    CchGetString(idsStarsSHostMode,(char *)szWork);
    _WSPRINTF((LPSTR)0x901120,(LPCSTR)CONCAT22((char *)szWork,unaff_SS),szData);
  }
  else {
    uVar1 = _strlen((char *)szBase);
    for (psz = (char *)((int)rghbrMinSum[3] + 3 + uVar1);
        (((char *)szBase < psz && (psz[-1] != '\\')) && (psz[-1] != ':')); psz = psz + -1)
    {
    }
    szGame[8] = '\0';
    _strncpy(szGame,psz,8);
    __strlwr(szGame);
    iVar2 = idPlayer + 1;
    pcVar4 = (char *)&DAT_1120_1120;
    uVar3 = 0x36e;
    uVar1 = _strlen(szGame);
    _WSPRINTF((LPSTR)CONCAT22(iVar2,pcVar4),(LPCSTR)CONCAT22(uVar3,unaff_SS),szGame + uVar1);
    PszPlayerName(idPlayer,0,1,0,0,(PLAYER *)0x0);
    _WSPRINTF((LPSTR)0x901120,(LPCSTR)CONCAT22(0x373,unaff_SS),szData);
  }
  SetWindowText(hwndFrame,(LPCSTR)CONCAT22(unaff_SS,szData));
  if (idPlayer != -1) {
    if (hwndScanner == 0) {
      hwndScanner =
           CreateWindow(szScan,(LPCSTR)0x0,0x50000000,-200,-200,10,10,hwndFrame,0,
                        hInst,(void *)0x0);
    }
    else {
      InvalidateRect(hwndScanner,(undefined2 *)0x0,1);
      yScanTop = 1000;
      xScanTop = 1000;
      SetScanScrollBars(hwndScanner);
    }
    if (hwndMine == 0) {
      hwndMine =
           CreateWindow(szMine,(LPCSTR)0x0,0x50000000,-500,-500,pt.x,pt.y,hwndFrame
                        ,0,hInst,(void *)0x0);
    }
    else {
      InvalidateRect(hwndMine,(undefined2 *)0x0,1);
    }
    if (hwndPlanet == 0) {
      hwndPlanet =
           CreateWindow(szPlanet,(LPCSTR)0x0,0x50000000,-500,-500,10,10,hwndFrame,0
                        ,hInst,(void *)0x0);
    }
    else {
      InvalidateRect(hwndPlanet,(undefined2 *)0x0,1);
    }
    if (hwndTb == 0) {
      hwndTb =
           CreateWindow(szTb,(LPCSTR)0x0,0x50000000,-500,-500,10,10,hwndFrame,0,
                        hInst,(void *)0x0);
    }
    else {
      InvalidateRect(hwndTb,(undefined2 *)0x0,1);
    }
    if (hwndMessage != 0) {
      DestroyWindow(hwndMessage);
    }
    hwndMessage =
         CreateWindow(szMessage,(LPCSTR)0x0,0x50000000,-500,-500,10,10,hwndFrame,0,
                      hInst,(void *)0x0);
    szGame[0] = -8;
    szGame[1] = '\x14';
    RefitFrameChildren();
  }
  return;
}



// ======================================================================
// Function: FrameWndProc
// Address: 1020:06d6
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

long FrameWndProc(ushort msg,long lParam)

{
  POINT pt;
  POINT pt_00;
  POINT dpt;
  POINT dpt_00;
  short sVar1;
  uint uVar2;
  uint uVar3;
  char *pcVar4;
  short sVar5;
  HICON HVar6;
  BOOL BVar7;
  HGDIOBJ HVar8;
  int iVar9;
  ushort uVar10;
  short sVar11;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  char *unaff_SS;
  FARPROC pvVar12;
  ulong uVar13;
  POINT PVar14;
  LRESULT LVar15;
  UINT in_stack_0000000a;
  HWND in_stack_0000000c;
  char *pcVar16;
  ushort in_stack_0000ff9e;
  HBRUSH hbrSav;
  short yOffset;
  ushort hcs;
  POINT ptChg;
  POINT ptStart;
  HBRUSH hbrSav_2;
  POINT ptD;
  POINT ptAct;
  POINT pt_3;
  ushort uStack_10;
  short grSel;
  ushort uStack_c;
  HANDLE local_a;
  short i;
  HDC hdc;
  
  if (in_stack_0000000a == 1) {
    hdc = GetDC(in_stack_0000000c);
    FCreateFonts(hdc);
    GetTextMetrics(hdc,(ushort *)CONCAT22(unaff_SS,&hcs));
    dySysFont = hcs;
    dySBar = (dyArial8 + 0xc) * 2;
    ReleaseDC(in_stack_0000000c,hdc);
    InitTiles();
    EnsureTileSize((uint)(iWindowLayout == 2));
    return 0;
  }
  if (in_stack_0000000a == 2) {
    if (uTimerId != 0) {
      KillTimer(0,uTimerId);
    }
    WriteIniSettings();
    uTimerId = 0;
    if (((uint)gd._0_2_ >> 3 & 1) != 0) {
      FMarkFile(dtHost,-1,1,0);
    }
    DestroyCurGame();
    if (((uint)gd.wFlags >> 6 & 1) == 0) {
      PostQuitMessage(vretExitValue);
      return 0;
    }
    ExitWindows((long)vretExitValue,0);
    return 0;
  }
  if (in_stack_0000000a == 5) {
    if ((msg == 2) || (msg == 0)) {
      vfs.dx = (int)lParam;
      uVar13 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff9e);
      vfs.dy = (short)uVar13;
      RefitFrameChildren();
      return 0;
    }
MDI_Default_5:
    LVar15 = DefWindowProc(in_stack_0000000c,in_stack_0000000a,msg,lParam);
    return LVar15;
  }
  if (in_stack_0000000a == 6) {
    return 0;
  }
  if (in_stack_0000000a == 0xf) {
    BVar7 = IsIconic(in_stack_0000000c);
    if (BVar7 == 0) {
      hdc = BeginPaint(in_stack_0000000c,(ushort *)CONCAT22(unaff_SS,&hcs));
      HVar8 = SelectObject(hdc,hbrButtonShadow);
      if ((iWindowLayout == 0) ||
         ((iWindowLayout != 1 && (iWindowLayout != 2)))) {
        PatBlt(hdc,vfs.xTop + 5,0,2,vfs.dy,0xf00021);
        PatBlt(hdc,0,vfs.y1 + 5,vfs.xTop + 2,2,0xf00021);
        PatBlt(hdc,0,vfs.y2 + 5,vfs.xTop + 2,2,0xf00021);
        SelectObject(hdc,hbrButtonHilite);
        PatBlt(hdc,vfs.xTop + 1,0,1,vfs.y1 + 2,0xf00021);
        PatBlt(hdc,0,vfs.y1 + 1,vfs.xTop + 1,1,0xf00021);
        PatBlt(hdc,vfs.xTop + 1,vfs.y1 + 6,1,
               (vfs.y2 - vfs.y1) + -4,0xf00021);
        PatBlt(hdc,0,vfs.y2 + 1,vfs.xTop + 1,1,0xf00021);
        PatBlt(hdc,vfs.xTop + 1,vfs.y2 + 6,1,
               (vfs.dy - vfs.y2) + -6,0xf00021);
      }
      else {
        if (gd.wFlags < 0) {
          iVar9 = 0x24;
        }
        else {
          iVar9 = 0;
        }
        PatBlt(hdc,vfs.xTop + 5,iVar9,2,(vfs.y2 + 2) - iVar9,0xf00021);
        PatBlt(hdc,0,vfs.y1 + 5,vfs.xTop + 2,2,0xf00021);
        PatBlt(hdc,vfs.xTop + 5,vfs.y2 + 5,
               (vfs.dx - vfs.xTop) + -5,2,0xf00021);
        PatBlt(hdc,vfs.xTop + 5,vfs.y2 + 6,2,
               (vfs.dy - vfs.y2) + -5,0xf00021);
        SelectObject(hdc,hbrButtonHilite);
        PatBlt(hdc,vfs.xTop + 1,iVar9,1,(vfs.y1 + 2) - iVar9,0xf00021);
        PatBlt(hdc,0,vfs.y1 + 1,vfs.xTop + 1,1,0xf00021);
        PatBlt(hdc,vfs.xTop + 1,vfs.y1 + 6,1,
               (vfs.dy - vfs.y1) + -6,0xf00021);
        PatBlt(hdc,vfs.xTop + 6,vfs.y2 + 1,
               (vfs.dx - vfs.xTop) + -6,1,0xf00021);
      }
      SelectObject(hdc,HVar8);
      EndPaint(in_stack_0000000c,(ushort *)CONCAT22(unaff_SS,&hcs));
      return 0;
    }
    hdc = BeginPaint(in_stack_0000000c,(ushort *)CONCAT22(unaff_SS,&hcs));
    if (((idPlayer != -1) ||
        ((HVar6 = hiconHost, (int)game.lid == 0 && (game.lid._2_2_ == 0)))) &&
       (HVar6 = hiconStars, uTimerId != 0)) {
      HVar6 = hiconWait;
    }
    DrawIcon(hdc,2,2,HVar6);
    EndPaint(in_stack_0000000c,(ushort *)CONCAT22(unaff_SS,&hcs));
    return 0;
  }
  if (in_stack_0000000a == 0x10) {
    DestroyWindow(in_stack_0000000c);
    return 0;
  }
  if (in_stack_0000000a == 0x14) {
    BVar7 = IsIconic(in_stack_0000000c);
    if (BVar7 != 0) {
      GetClientRect(in_stack_0000000c,(short *)CONCAT22(unaff_SS,&pt_3.y));
      FillRect(msg,(short *)CONCAT22(unaff_SS,&pt_3.y),hbrDesktop);
      return 0;
    }
    GetClientRect(in_stack_0000000c,(short *)CONCAT22(unaff_SS,&pt_3.y));
    if (hwndScanner != 0) {
      GetClientRect(hwndScanner,(short *)CONCAT22(unaff_SS,&ptD.y));
      MapWindowPoints(hwndScanner,in_stack_0000000c,(short *)CONCAT22(unaff_SS,&ptD.y),2);
      ExcludeClipRect(msg,ptD.y,ptAct.x,ptAct.y,pt_3.x);
    }
    FillRect(msg,(short *)CONCAT22(unaff_SS,&pt_3.y),hbrButtonFace);
    return 1;
  }
  if ((in_stack_0000000a == 0x15) || (in_stack_0000000a == 0x1a)) {
    FGetSystemColors();
    return 0;
  }
  if (in_stack_0000000a == 0x20) {
    uStack_c = 0;
    BVar7 = IsIconic(in_stack_0000000c);
    if (BVar7 == 0) {
      GetCursorPos((ushort *)CONCAT22(unaff_SS,&uStack_10));
      ScreenToClient(hwndFrame,(ushort *)CONCAT22(unaff_SS,&uStack_10));
      GetClientRect(in_stack_0000000c,(undefined2 *)CONCAT22(unaff_SS,&ptAct));
      BVar7 = PtInRect((undefined2 *)CONCAT22(&ptAct,grSel),uStack_10);
      if (BVar7 != 0) {
        PVar14.y = grSel;
        PVar14.x = uStack_10;
        uStack_c = HcrsFromFrameWindowPt(PVar14,(short *)0x0);
        if (uStack_c != 0) {
          setcursor(uStack_c);
          return 1;
        }
        uStack_c = 0;
      }
    }
    goto MDI_Default_5;
  }
  if (in_stack_0000000a == 0x24) {
    *(undefined2 *)((int)lParam + 0xc) = 0x208;
    *(undefined2 *)((int)lParam + 0xe) = 0x17c;
    return 0;
  }
  if (in_stack_0000000a == 0x37) {
    HVar6 = hiconHost;
    if ((idPlayer != -1) && (HVar6 = hiconStars, uTimerId != 0)) {
      HVar6 = hiconWait;
    }
    return (ulong)HVar6;
  }
  if (in_stack_0000000a == 0x102) {
    if ((hwndScanner != 0) && ((msg == 0x2d || (msg == 0x2b)))) {
      SendMessage(hwndScanner,0x102,msg,lParam);
      return 0;
    }
    if ((hwndMessage != 0) && (((msg == 0x2d || (msg == 0x2b)) || (msg == 0xd)))) {
      SendMessage(hwndMessage,0x102,msg,lParam);
      return 0;
    }
    if ((hwndPlanet != 0) && ((msg == 0x66 || (msg == 0x46)))) {
      SendMessage(hwndPlanet,0x102,msg,lParam);
      return 0;
    }
    if ((hwndPlanet != 0) &&
       ((sel.grobj == grobjPlanet && ((msg == 0x71 || (msg == 0x51)))))) {
      ChangeProduction(0);
      return 0;
    }
    if ((sel.grobj & (grobjFleet|grobjPlanet)) == grobjNone) {
      return 0;
    }
    uStack_c = 0;
    grSel = 0;
    if (msg == 0x6e) {
      uStack_c = 1;
    }
    else if ((msg == 0x4e) || (msg == 0x50)) {
      if (sel.grobj == grobjPlanet) {
        grSel = IdFindAdjStarbase(sel.pl.id,(uint)(msg == 0x4e));
      }
      else if (msg == 0x4e) {
        uStack_c = 1;
      }
      else {
        uStack_c = -1;
      }
    }
    else if (msg == 0x70) {
      uStack_c = -1;
    }
    else if (((msg == 0x72) || (msg == 0x52)) && (sel.grobj == grobjFleet)) {
      ShipCommandProc(hwndPlanet,0,(ulong)rghwndBtn[6]);
    }
    if ((uStack_c == 0) && (grSel == 0)) {
      return 0;
    }
    if (sel.grobj != grobjFleet) {
      SelectAdjPlanet(uStack_c,grSel);
      return 0;
    }
    SelectAdjFleet(uStack_c,grSel);
    return 0;
  }
  if (in_stack_0000000a == 0x111) {
    CommandHandler(in_stack_0000000c,msg);
    return 0;
  }
  if (in_stack_0000000a == 0x112) {
    if (((msg & 0xfff0) == 0xf030) || ((msg & 0xfff0) == 0xf120)) {
      uStack_c = idPlayer;
      uStack_10 = uTimerId;
      if (uTimerId != 0) {
        KillTimer(0,uTimerId);
        uTimerId = 0;
        CreateChildWindows();
      }
      if ((idPlayer == -1) || (sVar5 = FNewTurnAvail(idPlayer), sVar5 == 0)) {
        if (uStack_10 != 0) {
          if (uTimerType == 0xd) {
            PostMessage(in_stack_0000000c,0x465,0,0);
          }
          else {
            if (uTimerType == 0xe) {
              pcVar16 = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 1;
              pcVar4 = PszFormatIds(idsTurnHasSubmittedChangesMadeAfterTurn,(short *)0x0);
              grSel = AlertSz(pcVar4,(short)pcVar16);
              if ((grSel == 6) && (sVar5 = FMarkFile(dtLog,idPlayer,2,0), sVar5 == 0)) {
                sVar5 = 0x10;
                pcVar4 = PszFormatIds(idsNewTurnCurrentlyGeneratedHostNewTurn,(short *)0x0);
                AlertSz(pcVar4,sVar5);
                _WSPRINTF((LPSTR)CONCAT22(idPlayer + 1,(char *)&DAT_1120_1120),
                          (LPCSTR)CONCAT22(MPCTD,unaff_SS),&pt_3);
                DestroyCurGame();
                sVar5 = FLoadGame((char *)szBase,(char *)&pt_3);
                if (sVar5 == 0) {
                  sVar5 = 0x10;
                  pcVar4 = PszFormatIds(idsUnableOpenNewTurnFile,(short *)0x0);
                  AlertSz(pcVar4,sVar5);
                }
                else {
                  CreateChildWindows();
                }
              }
              else if (grSel == 2) {
                PostMessage(hwndFrame,0x111,0x6a,0);
                return 1;
              }
            }
            SendMessage(hwndFrame,0x111,0xfa1,0);
            if ((1000 < sel.pt.x) && (1000 < sel.pt.y)) {
              pt.y = sel.pt.y;
              pt.x = sel.pt.x;
              CtrPointScan(pt,1);
            }
          }
        }
      }
      else {
        if (uStack_10 == 0) {
          pcVar16 = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 1;
          pcVar4 = PszFormatIds(idsNewTurnAvailableWouldLikeLoad,(short *)0x0);
          grSel = AlertSz(pcVar4,(short)pcVar16);
        }
        else {
          sVar5 = 0x40;
          pcVar4 = PszFormatIds(idsNewTurnAvailable,(short *)0x0);
          AlertSz(pcVar4,sVar5);
          grSel = 6;
        }
        if (grSel == 6) {
          _WSPRINTF((LPSTR)CONCAT22(idPlayer + 1,(char *)&DAT_1120_1120),
                    (LPCSTR)CONCAT22(MPCTD,unaff_SS),&pt_3);
          DestroyCurGame();
          sVar5 = FLoadGame((char *)szBase,(char *)&pt_3);
          if (sVar5 == 0) {
            sVar5 = 0x10;
            pcVar4 = PszFormatIds(idsUnableOpenNewTurnFile,(short *)0x0);
            AlertSz(pcVar4,sVar5);
          }
          else {
            CreateChildWindows();
          }
        }
        else if (grSel == 2) {
          if (uStack_10 == 0) {
            PostMessage(hwndFrame,0x112,0xf020,0);
          }
          else {
            PostMessage(hwndFrame,0x111,0x6a,0);
          }
          return 1;
        }
        SendMessage(hwndFrame,0x111,0xfa1,0);
      }
    }
    goto MDI_Default_5;
  }
  if (in_stack_0000000a == 0x116) {
    InitializeMenu(msg);
    return 0;
  }
  if (in_stack_0000000a == 0x121) {
    if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (((uint)tutor.wFlags >> 2 & 1) != 0))
    {
      AdvanceTutor();
    }
    return 0;
  }
  if (in_stack_0000000a == 0x201) {
    pt_3.x = (int)lParam;
    uVar13 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff9e);
    pt_3.y = (short)uVar13;
    pt_00.y = pt_3.y;
    pt_00.x = pt_3.x;
    uVar10 = HcrsFromFrameWindowPt(pt_00,(short *)&uStack_10);
    if (uVar10 == 0) {
      return 0;
    }
    hdc = GetDC(in_stack_0000000c);
    HVar8 = SelectObject(hdc,hbr50Screen);
    ptD.y = 0;
    ptD.x = 0;
    InvertPaneBorder(hdc,uStack_10,(POINT)0x0,(POINT *)0x0);
    sVar1 = pt_3.y;
    sVar5 = pt_3.x;
    SetCapture(in_stack_0000000c);
    grSel = pt_3.x;
    uStack_c = pt_3.y;
    ptAct.x = 0;
    ptAct.y = 0;
    while( true ) {
      sVar11 = FGetMouseMove(&pt_3);
      if (sVar11 == 0) break;
      if ((pt_3.x != grSel) || (pt_3.y != uStack_c)) {
        ptD.x = pt_3.x - sVar5;
        ptD.y = pt_3.y - sVar1;
        ptChg.x = pt_3.x - grSel;
        ptChg.y = pt_3.y - uStack_c;
        dpt.y = ptD.y;
        dpt.x = ptD.x;
        PVar14 = InvertPaneBorder(hdc,uStack_10,dpt,&ptChg);
        grSel = pt_3.x;
        uStack_c = pt_3.y;
        ptAct = PVar14;
      }
    }
    dpt_00.y = ptD.y;
    dpt_00.x = ptD.x;
    InvertPaneBorder(hdc,uStack_10,dpt_00,(POINT *)0x0);
    ReleaseCapture();
    SelectObject(hdc,HVar8);
    ReleaseDC(in_stack_0000000c,hdc);
    if (ptAct == (POINT)0x0) {
      return 0;
    }
    if ((uStack_10 & 1) != 0) {
      if (iWindowLayout == 0) {
        vfs.dxPlanWant = vfs.xTop + ptAct.x;
      }
      else {
        vfs.dx2PlanWant = vfs.xTop + ptAct.x;
      }
    }
    if ((uStack_10 & 2) != 0) {
      if (iWindowLayout == 0) {
        vfs.dyMsgWant = ((vfs.y2 - vfs.y1) + -8) - ptAct.y;
      }
      else {
        vfs.dy2MsgWant = ((vfs.dy - vfs.y1) + -8) - ptAct.y;
      }
    }
    if ((uStack_10 & 4) != 0) {
      if (iWindowLayout == 0) {
        vfs.dyMsgWant = (vfs.y2 - vfs.y1) + -8 + ptAct.y;
        vfs.dyMinWant = ((vfs.dy - vfs.y2) + -8) - ptAct.y;
      }
      else {
        vfs.dy2MinWant = ((vfs.dy - vfs.y2) + -8) - ptAct.y;
      }
    }
    InvalidateRect(in_stack_0000000c,(undefined2 *)0x0,1);
    RefitFrameChildren();
    return 0;
  }
  if (in_stack_0000000a == 0x30f) {
MDI_MapIt_2:
    if (hwndTitle != 0) {
      LVar15 = SendMessage(hwndTitle,in_stack_0000000a,msg,lParam);
      return LVar15;
    }
    hdc = GetDC(in_stack_0000000c);
    local_a = SelectPalette(hdc,vhpal,0);
    i = RealizePalette(hdc);
    SelectPalette(hdc,local_a,0);
    ReleaseDC(in_stack_0000000c,hdc);
    if (i != 0) {
      InvalidateRect(in_stack_0000000c,(undefined2 *)0x0,1);
      return 1;
    }
    return 0;
  }
  if (in_stack_0000000a == 0x311) {
    if (msg == in_stack_0000000c) {
      return 0;
    }
    goto MDI_MapIt_2;
  }
  if (in_stack_0000000a != 0x464) {
    if (in_stack_0000000a == 0x465) {
      BringUpHostDlg();
      return 1;
    }
    if (in_stack_0000000a == 0x466) {
      ShowTutor(0);
      game.fDirty = 0;
      DestroyCurGame();
      uStack_c = fFileErrSilent;
      fFileErrSilent = 1;
      gd.wFlags = gd.wFlags & 0xfffdU | 2;
      sVar5 = FLoadGame((char *)szBase,(char *)0x3c8);
      if (sVar5 != 0) {
        gd.wFlags = gd.wFlags & 0xfffd;
        fFileErrSilent = uStack_c;
        idPlayer = 0;
        if (msg == 0x9ca) {
          gd._0_2_ = gd._0_2_ & 0xfffd | 2;
          _WSPRINTF((LPSTR)0x56a21120,(LPCSTR)0x3cb1120,(char *)szWork);
          sVar5 = FLoadLogFile((char *)szWork);
          if (sVar5 != 0) {
            FRunLogFile();
          }
          gd._0_2_ = gd._0_2_ & 0xfffd;
        }
        CreateChildWindows();
        SendMessage(hwndFrame,0x111,0xfa1,0);
        if (msg == 0x9ca) {
          SendMessage(hwndMessage,0x100,0x23,0);
        }
        tutor.idt = 0;
        grSel = (short)(msg == 0x9ca);
        tutor.wFlags = tutor.wFlags & 0xfdf7U | grSel << 9;
        AdvanceTutor();
        return 0;
      }
      fFileErrSilent = uStack_c;
      gd.wFlags = gd.wFlags & 0xfffd;
      return 0;
    }
    goto MDI_Default_5;
  }
  idPlayer = -1;
  if (((uint)ini.wFlags >> 1 & 1) != 0) {
    uVar2 = ini.wFlags & 0xfffd;
    if (((uint)ini.wFlags >> 0xe & 1) != 0) {
      fFileErrSilent = 1;
      ini.wFlags = uVar2;
      ClearFile(7);
      sVar5 = FLoadGame((char *)szBase,(char *)0x38e);
      if (sVar5 != 0) {
        VerifyTurns();
        DestroyCurGame();
        EnsureAis();
        _WSPRINTF((LPSTR)0x901120,(LPCSTR)CONCAT22(0x392,unaff_SS),&stack0xff9e);
        OutputSz(7,(char *)CONCAT22(unaff_SS,&stack0xff9e));
        for (i = 0; i < game.cPlayer; i = i + 1) {
          if (((short *)rgOut)[i] + 1 < 4) {
            uStack_c = _WSPRINTF((LPSTR)CONCAT22(i + 1,(char *)&DAT_1120_1120),
                                 (LPCSTR)CONCAT22(0x3ac,unaff_SS),&stack0xff9e);
          }
          else {
            uStack_c = _WSPRINTF((LPSTR)CONCAT22(i + 1,(char *)&DAT_1120_1120),
                                 (LPCSTR)CONCAT22(0x3a0,unaff_SS),&stack0xff9e);
          }
          if (((uint)gd.wFlags >> 6 & 1) == 0) {
            pcVar4 = PszPlayerName(i,1,1,1,0,(PLAYER *)0x0);
            iVar9 = _WSPRINTF((LPSTR)CONCAT22(pcVar4,(char *)&DAT_1120_1120),
                              (LPCSTR)CONCAT22(0x3b1,unaff_SS),&stack0xff9e + uStack_c);
            uStack_c = uStack_c + iVar9;
          }
          pcVar4 = PszGetCompressedString(((short *)rgOut)[i] + idsTurned);
          _strcat(&stack0xff9e,pcVar4);
          if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 4 & 1) != 0) {
            _strcat(&stack0xff9e,(char *)s___HACKER_1120_03b7);
          }
          OutputSz(7,(char *)CONCAT22(unaff_SS,&stack0xff9e));
        }
      }
MDI_LExit:
      if (((uint)gd.wFlags >> 6 & 1) == 0) {
        PostQuitMessage(vretExitValue);
      }
      else {
        ExitWindows((long)vretExitValue,0);
      }
      return 0;
    }
    if (((uint)ini.wFlags >> 10 & 1) != 0) {
      if (((int)vSerialNumber != 0) ||
         (ini.wFlags = uVar2, vSerialNumber._2_2_ != 0)) {
        ini.wFlags = uVar2;
        GenNewGameFromFile((char *)szBase);
      }
      goto MDI_LExit;
    }
    uVar3 = (uint)ini.wFlags >> 3;
    ini.wFlags = uVar2;
    if ((uVar3 & 1) != 0) {
      while( true ) {
        while (((((uint)ini.wFlags >> 2 & 1) == 0 &&
                (((uint)ini.wFlags >> 4 & 1) == 0)) ||
               (sVar5 = CTurnsOutSafe(), sVar5 == 0))) {
          EnsureAis();
          FGenerateTurn();
          if ((((uint)ini.wFlags >> 9 & 1) != 0) && (_lpchBatch < _lpchBatchMac))
          goto MDI_LTryNextBatch;
          if (ini.cTurnGen == 0) goto MDI_LExit;
          ini.cTurnGen = ini.cTurnGen + -1;
        }
        if (((uint)ini.wFlags >> 4 & 1) == 0) goto LAB_1020_0b67;
        if ((((uint)ini.wFlags >> 9 & 1) == 0) || (_lpchBatchMac <= _lpchBatch)) break;
MDI_LTryNextBatch:
        DestroyCurGame();
        pt_3.y = (short)szBase;
        while( true ) {
          if ((*_lpchBatch == '\n') ||
             ((_lpchBatch == _lpchBatchMac && (DAT_1120_01a0 == DAT_1120_51b2)))) break;
          *(char *)pt_3.y = *_lpchBatch;
          _lpchBatch = (char *)CONCAT22(DAT_1120_01a0,_lpchBatch + 1);
          pt_3.y = pt_3.y + 1;
        }
        _lpchBatch = (char *)CONCAT22(DAT_1120_01a0,_lpchBatch + 1);
        *(undefined1 *)(pt_3.y + -1) = 0;
        ini.wFlags = ini.wFlags & 0xfffeU | 1;
      }
      goto MDI_LExit;
    }
LAB_1020_0b67:
    CommandHandler(in_stack_0000000c,0xed9);
    if (((uint)ini.wFlags >> 4 & 1) != 0) goto MDI_LExit;
    if (((uint)ini.wFlags >> 3 & 1) != 0) goto MDI_LNop;
    if (((int)game.lid != 0) || (game.lid._2_2_ != 0)) {
      if ((idPlayer != -1) &&
         (((((uint)ini.wFlags >> 0xc & 1) != 0 ||
           (((uint)ini.wFlags >> 0xb & 1) != 0)) ||
          (((uint)ini.wFlags >> 0xd & 1) != 0)))) {
        if (((uint)ini.wFlags >> 0xd & 1) != 0) {
          PostMessage(hwndFrame,0x111,0x55,0);
        }
        if (((uint)ini.wFlags >> 0xc & 1) != 0) {
          PostMessage(hwndFrame,0x111,0x54,0);
        }
        if (((uint)ini.wFlags >> 0xb & 1) != 0) {
          PostMessage(hwndFrame,0x111,0x53,0);
        }
        goto MDI_LExit;
      }
      ShowWindow(hwndFrame,5);
      InitializeMenu(0);
      PostMessage(hwndFrame,0x111,0xfa1,0);
      if (((uint)ini.wFlags >> 2 & 1) != 0) {
        ini.wFlags = ini.wFlags & 0xfffb;
        CommandHandler(in_stack_0000000c,0x6a);
      }
      goto MDI_LNop;
    }
  }
  if (hwndTitle == 0) {
    uStack_10 = GetSystemMetrics(0);
    grSel = GetSystemMetrics(1);
    hwndTitle =
         CreateWindow(szTitle,(LPCSTR)0x112003c1,0x90000000,0,0,uStack_10,grSel,
                      hwndFrame,0,hInst,(void *)0x0);
    fFreeingTitle = 0;
  }
  ini.wFlags = ini.wFlags & 0xfffe;
  DestroyCurGame();
MDI_LNop:
  if ((((int)vSerialNumber != 0) || (vSerialNumber._2_2_ != 0)) &&
     (sVar5 = _memcmp((byte *)vrgbMachineConfig,(undefined *)&vrgbEnvCur
                              ,0xb), sVar5 == 0)) {
    return 0;
  }
  if (((int)vSerialNumber == 0) && (vSerialNumber._2_2_ == 0)) {
    szWork[200] = '\0';
  }
  else {
    szWork[200] = '\x01';
  }
  pvVar12 = MakeProcInstance(MsgDlg,hInst);
  pt_3.x = (short)((ulong)pvVar12 >> 0x10);
  ptAct.y = (short)pvVar12;
  pcVar4 = (char *)hwndTitle;
  if (hwndTitle == 0) {
    pcVar4 = (char *)hwndFrame;
  }
  ptAct.x = DialogBox(0,(LPCSTR)CONCAT22(0x56,pcVar4),pt_3.x,ptAct.y);
  FreeProcInstance((FARPROC)CONCAT22(pt_3.x,ptAct.y));
  if (ptAct.x == 0) {
    vSerialNumber._0_2_ = 0;
    vSerialNumber._2_2_ = 0;
    _memcpy((byte *)vrgbMachineConfig,(undefined *)&vrgbEnvCur,0xb);
    PostQuitMessage(vretExitValue);
  }
  else {
    sVar5 = FValidSerialNo((char *)szWork,(long *)&ptD);
    if (sVar5 == 0) {
      if (((int)vSerialNumber == 0) && (vSerialNumber._2_2_ == 0)) {
        _memcpy((byte *)vrgbMachineConfig,(undefined *)&vrgbEnvCur,0xb);
        PostQuitMessage(vretExitValue);
      }
    }
    else {
      vSerialNumber._0_2_ = ptD.x;
      vSerialNumber._2_2_ = ptD.y;
      _memcpy((byte *)vrgbMachineConfig,(undefined *)&vrgbEnvCur,0xb);
    }
  }
  WriteIniSettings();
  return 0;
}



// ======================================================================
// Function: InvertPaneBorder
// Address: 1020:1e3c
// Segment: MEMORY_MDI
// ======================================================================


POINT InvertPaneBorder(HDC hdc,short grSel,POINT dpt,POINT *pdptPrev)

{
  short sVar1;
  int iVar2;
  short sVar3;
  POINT dpt_00;
  short dyMin_4;
  short x;
  short dxScanMin;
  short dyPlanMin;
  short dyMinAboveH2;
  short dyMsgCur;
  POINT dptOld;
  short dyAboveMinCur;
  POINT dptPrev;
  POINT dptT;
  short dChg;
  short notMin;
  
  sVar3 = dpt.x;
  if ((pdptPrev != (POINT *)0x0) && (grSel != 1)) {
    dpt_00.y = dpt.y - pdptPrev->y;
    dpt_00.x = dpt.x - pdptPrev->x;
    InvertPaneBorder(hdc,grSel,dpt_00,(POINT *)0x0);
  }
  if ((iWindowLayout == 0) ||
     ((iWindowLayout != 1 && (iWindowLayout != 2)))) {
    dxScanMin = 100;
    dyPlanMin = 0x32;
    iVar2 = vfs.y2 - vfs.y1;
    dyAboveMinCur = (vfs.y2 - vfs.y1) + -8;
    notMin = 1;
    dyMinAboveH2 = (dyArial8 * 0xd >> 1) + 10;
  }
  else {
    dxScanMin = 200;
    dyPlanMin = 100;
    iVar2 = vfs.dy - vfs.y1;
    dyAboveMinCur = vfs.y2;
    notMin = -1;
    dyMinAboveH2 = 100;
  }
  dyMsgCur = iVar2 + -8;
  if (vfs.xTop + dpt.x < 0xc6) {
    dpt.x = 0xc6 - vfs.xTop;
  }
  if ((vfs.dx - vfs.xTop) - dpt.x < dxScanMin) {
    dpt.x = (vfs.dx - vfs.xTop) - dxScanMin;
  }
  if (0x18c < vfs.xTop + dpt.x) {
    dpt.x = 0x18c - vfs.xTop;
  }
  if ((grSel & 2U) != 0) {
    if (vfs.y1 + dpt.y < dyPlanMin) {
      dpt.y = dyPlanMin - vfs.y1;
    }
    else {
      iVar2 = (dyArial8 * 0xd >> 1) + 10;
      if (dyMsgCur - dpt.y < iVar2) {
        dpt.y = dyMsgCur - iVar2;
      }
    }
  }
  if ((grSel & 4U) != 0) {
    if (dyAboveMinCur + dpt.y < dyMinAboveH2) {
      dpt.y = (dyMinAboveH2 - dyAboveMinCur) * notMin;
    }
    else {
      iVar2 = dyArial8 * 0xd + -0x24;
      if (((vfs.dy - vfs.y2) + -8) - dpt.y < iVar2) {
        dpt.y = ((vfs.dy - vfs.y2) + -8) - iVar2;
      }
    }
  }
  sVar1 = dpt.x;
  if (pdptPrev != (POINT *)0x0) {
    iVar2 = sVar3 - pdptPrev->x;
    if (vfs.xTop + iVar2 < 0xc6) {
      iVar2 = 0xc6 - vfs.xTop;
    }
    if ((vfs.dx - vfs.xTop) - iVar2 < dxScanMin) {
      iVar2 = (vfs.dx - vfs.xTop) - dxScanMin;
    }
    if (0x18c < vfs.xTop + iVar2) {
      iVar2 = 0x18c - vfs.xTop;
    }
    dptPrev.x = dpt.x - iVar2;
  }
  sVar3 = dpt.y;
  switch(grSel) {
  default:
    dpt = (POINT)((ulong)dpt & 0xffff);
    if ((pdptPrev == (POINT *)0x0) || (sVar3 = _abs(dptPrev.x), 5 < sVar3)) {
      if (pdptPrev != (POINT *)0x0) {
        PatBlt(hdc,((vfs.xTop + sVar1) - dptPrev.x) + 1,0,6,vfs.dy,0x5a0049);
      }
      PatBlt(hdc,vfs.xTop + sVar1 + 1,0,6,vfs.dy,0x5a0049);
    }
    else {
      dChg = dptPrev.x;
      if (dptPrev.x != 0) {
        if (dptPrev.x < 0) {
          iVar2 = vfs.xTop + sVar1;
          dChg = -dptPrev.x;
        }
        else {
          iVar2 = (vfs.xTop + sVar1) - dptPrev.x;
        }
        x = iVar2 + 1;
        PatBlt(hdc,x,0,dChg,vfs.dy,0x5a0049);
        PatBlt(hdc,iVar2 + 7,0,dChg,vfs.dy,0x5a0049);
      }
    }
    break;
  case 2:
    dpt = (POINT)((ulong)(uint)dpt.y << 0x10);
    PatBlt(hdc,0,vfs.y1 + sVar3 + 1,vfs.xTop + 1,6,0x5a0049);
    break;
  case 3:
    PatBlt(hdc,vfs.xTop + dpt.x + 1,0,6,vfs.dy,0x5a0049);
    PatBlt(hdc,0,vfs.y1 + dpt.y + 1,vfs.xTop + dpt.x + 1,6,0x5a0049);
    break;
  case 4:
    dpt = (POINT)((ulong)(uint)dpt.y << 0x10);
    if (iWindowLayout == 0) {
      PatBlt(hdc,0,vfs.y2 + sVar3 + 1,vfs.xTop + 1,6,0x5a0049);
    }
    else {
      PatBlt(hdc,vfs.xTop + 7,vfs.y2 + sVar3 + 1,
             (vfs.dx - vfs.xTop) + -7,6,0x5a0049);
    }
    break;
  case 5:
    PatBlt(hdc,vfs.xTop + dpt.x + 1,0,6,vfs.dy,0x5a0049);
    if (iWindowLayout == 0) {
      PatBlt(hdc,0,vfs.y2 + dpt.y + 1,vfs.xTop + dpt.x + 1,6,0x5a0049);
    }
    else {
      PatBlt(hdc,vfs.xTop + dpt.x + 7,vfs.y2 + dpt.y + 1,
             ((vfs.dx - dpt.x) - vfs.xTop) + -7,6,0x5a0049);
    }
    break;
  case 7:
    PatBlt(hdc,vfs.xTop + dpt.x + 1,0,6,vfs.dy,0x5a0049);
    PatBlt(hdc,0,vfs.y1 + dpt.y + 1,vfs.xTop + dpt.x + 1,6,0x5a0049);
    PatBlt(hdc,vfs.xTop + dpt.x + 7,vfs.y2 + dpt.y + 1,
           ((vfs.dx - dpt.x) - vfs.xTop) + -7,6,0x5a0049);
  }
  return dpt;
}



// ======================================================================
// Function: HcrsFromFrameWindowPt
// Address: 1020:24b0
// Segment: MEMORY_MDI
// ======================================================================


ushort HcrsFromFrameWindowPt(POINT pt,short *pgrSel)

{
  int iVar1;
  int iVar2;
  short fInVBar;
  short fInHBar1;
  short fInHBar2;
  ushort hcs;
  
  hcs = 0;
  if ((pt.x < vfs.xTop) || (vfs.xTop + 8 <= pt.x)) {
    iVar1 = 0;
  }
  else {
    iVar1 = 1;
  }
  if (((pt.x < vfs.xTop + 8) && (vfs.y1 <= pt.y)) &&
     (pt.y < vfs.y1 + 8)) {
    iVar2 = 1;
  }
  else {
    iVar2 = 0;
  }
  if ((iWindowLayout == 0) ||
     ((iWindowLayout != 1 && (iWindowLayout != 2)))) {
    if (((pt.x < vfs.xTop + 8) && (vfs.y2 <= pt.y)) &&
       (pt.y < vfs.y2 + 8)) {
      fInHBar2 = 1;
    }
    else {
      fInHBar2 = 0;
    }
  }
  else if ((pt.x < vfs.xTop) ||
          ((pt.y < vfs.y2 || (vfs.y2 + 8 <= pt.y)))) {
    fInHBar2 = 0;
  }
  else {
    fInHBar2 = 1;
  }
  if (iVar1 == 0) {
    if ((iVar2 != 0) || (fInHBar2 != 0)) {
      hcs = hcurResizeNS;
    }
  }
  else if ((iVar2 == 0) && (fInHBar2 == 0)) {
    hcs = hcurResizeWE;
  }
  else {
    hcs = hcurResize4Way;
  }
  if (pgrSel != (short *)0x0) {
    *pgrSel = iVar2 * 2 + iVar1 + fInHBar2 * 4;
  }
  return hcs;
}



// ======================================================================
// Function: RestoreSelection
// Address: 1020:2614
// Segment: MEMORY_MDI
// ======================================================================


void RestoreSelection(void)

{
  int iVar1;
  FLEET *pFVar2;
  PLANET *pPVar3;
  PLANET *lppl;
  
  if (((ini.idPlayer == idPlayer) &&
      ((int)ini.lid == (int)game.lid)) &&
     (ini.lid._2_2_ == game.lid._2_2_)) {
    if (((uint)ini.wFlags >> 5 & 0xf) == 2) {
      pFVar2 = LpflFromId(ini.iObjSel);
      if (pFVar2 == (FLEET *)0x0) {
        ini.wFlags = ini.wFlags & 0xfe1fU | 0x20;
        ini.iObjSel =
             *(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0);
      }
      else {
        SelectAdjFleet(0,ini.iObjSel);
        ini.wFlags = ini.wFlags & 0xfe1f;
      }
    }
    else if (((uint)ini.wFlags >> 5 & 0xf) == 1) {
      pPVar3 = LpplFromId(ini.iObjSel);
      iVar1 = (int)((ulong)pPVar3 >> 0x10);
      if ((((PLANET *)pPVar3 == (PLANET *)0x0) && (iVar1 == 0)) ||
         (((PLANET *)pPVar3)->iPlayer != idPlayer)) {
        ini.iObjSel =
             *(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0);
      }
      else {
        SelectAdjPlanet(0,ini.iObjSel);
        ini.wFlags = ini.wFlags & 0xfe1f;
      }
    }
    if ((ini.turn == game.turn) && (0 < ini.iMsg)) {
      iMsgCur = ini.iMsg + -1;
      if (cMsg + vcmsgplrIn <= iMsgCur) {
        iMsgCur = -1;
      }
      iMsgCur = IMsgNext(0);
      gd._0_2_ = gd._0_2_ & 0xefff;
      SetMsgTitle(hwndMessage);
      InvalidateRect(hwndMessage,(undefined2 *)0x0,1);
      if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
        tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
        AdvanceTutor();
      }
    }
  }
  else {
    ini.wFlags = ini.wFlags & 0xfe1fU | 0x20;
    ini.iObjSel =
         *(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0);
  }
  if (((uint)ini.wFlags >> 5 & 0xf) != 0) {
    if (ini.iObjSel == -1) {
      FFindSomethingAndSelectIt();
    }
    else {
      pPVar3 = LpplFromId(ini.iObjSel);
      iVar1 = (int)((ulong)pPVar3 >> 0x10);
      if ((((PLANET *)pPVar3 == (PLANET *)0x0) && (iVar1 == 0)) ||
         (((PLANET *)pPVar3)->iPlayer != idPlayer)) {
        FFindSomethingAndSelectIt();
      }
      else {
        SelectAdjPlanet(0,ini.iObjSel);
      }
    }
    ini.wFlags = ini.wFlags & 0xfe1f;
  }
  return;
}



// ======================================================================
// Function: FormatSerialAndEnv
// Address: 1020:2886
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Variable defined which should be unmapped: b64 */

void FormatSerialAndEnv(long lSerial,byte *pbEnv,char *pszOut)

{
  bool bVar1;
  short sVar2;
  uint uVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar4;
  long lNew2;
  byte b64;
  undefined1 uStack_41;
  byte rgbRaw2 [21];
  long lTank;
  short iPass;
  short iRaw;
  short cBits;
  short i;
  byte bXor;
  short j;
  byte rgbRaw [21];
  
  lNew2 = CONCAT22(unaff_SI,unaff_DI);
  bVar1 = false;
  PushRandom(0x11000b,lNew2);
  Randomize(lSerial);
  rgbRaw._0_4_ = lSerial;
  _memcpy(rgbRaw + 4,pbEnv,0xb);
  iRaw = 0xf;
  for (i = 0; i < 0xb; i = i + 1) {
    for (j = (short)pbEnv[i]; 0 < j; j = j + -1) {
      Random(0x10);
    }
    if (bVar1) {
      uVar3 = Random(0x10);
      rgbRaw[iRaw] = rgbRaw[iRaw] | (byte)((uVar3 & 0xf) << 4);
      iRaw = iRaw + 1;
    }
    else {
      sVar2 = Random(0x10);
      rgbRaw[iRaw] = (byte)sVar2;
    }
    bVar1 = (bool)(bVar1 + 1U & 1);
  }
  bXor = 0;
  for (i = 0; i < 0xf; i = i + 1) {
    bXor = bXor ^ rgbRaw[i];
  }
  rgbRaw[iRaw] = rgbRaw[iRaw] | bXor << 4;
  PopRandom();
  for (i = 0; i < 0x15; i = i + 1) {
    rgbRaw2[i] = rgbRaw[((byte *)vrgbShuffleSerial)[i]];
  }
  iRaw = 0;
  cBits = 0;
  lVar4 = 0;
  for (i = 0; lTank._0_1_ = (byte)lVar4, i < 0x1c; i = i + 1) {
    if (cBits < 6) {
      lTank._0_1_ = (byte)lTank | rgbRaw2[iRaw] << ((byte)cBits & 0x1f);
      cBits = cBits + 8;
      iRaw = iRaw + 1;
    }
    _b64 = CONCAT11(uStack_41,(byte)lTank) & 0xff3f;
    lVar4 = __aFlshr(lNew2,_b64);
    cBits = cBits + -6;
    if (b64 < 0x1a) {
      *pszOut = b64 + 0x41;
    }
    else if (b64 < 0x34) {
      *pszOut = b64 + 0x47;
    }
    else if (b64 < 0x3e) {
      *pszOut = b64 - 4;
    }
    else if (b64 == 0x3e) {
      *pszOut = '-';
    }
    else {
      *pszOut = '*';
    }
    pszOut = pszOut + 1;
  }
  *pszOut = '\0';
  return;
}



// ======================================================================
// Function: FSerialAndEnvFromSz
// Address: 1020:2aec
// Segment: MEMORY_MDI
// ======================================================================


short FSerialAndEnvFromSz(long *plSerial,byte *pbEnv,char *pszIn)

{
  bool bVar1;
  short sVar2;
  uint uVar3;
  uint uVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar5;
  long lNew2;
  ushort in_stack_0000ffb6;
  byte b64;
  byte rgbRaw2 [21];
  long lTank;
  long lSerial;
  short iPass;
  short iRaw;
  short cBits;
  short i;
  byte bXor;
  short j;
  short fSuccess;
  byte rgbRaw [21];
  
  lNew2 = CONCAT22(unaff_SI,unaff_DI);
  bVar1 = false;
  *(undefined2 *)plSerial = 0;
  *(undefined2 *)((int)plSerial + 2) = 0;
  _memset(pbEnv,0,0xb);
  iRaw = 0;
  cBits = 0;
  uVar5 = 0;
  for (i = 0; i < 0x15; i = i + 1) {
    for (; lTank._0_2_ = (uint)uVar5, cBits < 8; cBits = cBits + 6) {
      if ((*pszIn < 'A') || ('Z' < *pszIn)) {
        if ((*pszIn < 'a') || ('z' < *pszIn)) {
          if ((*pszIn < '0') || ('9' < *pszIn)) {
            if (*pszIn == '-') {
              b64 = 0x3e;
            }
            else {
              b64 = 0x3f;
            }
          }
          else {
            b64 = *pszIn + 4;
          }
        }
        else {
          b64 = *pszIn + 0xb9;
        }
      }
      else {
        b64 = *pszIn + 0xbf;
      }
      uVar5 = (ulong)((uint)lTank | (uint)b64 << ((byte)cBits & 0x1f));
      pszIn = pszIn + 1;
    }
    rgbRaw2[iRaw] = (byte)uVar5;
    cBits = cBits + -8;
    uVar5 = __aFlshr(lNew2,in_stack_0000ffb6);
    iRaw = iRaw + 1;
  }
  for (i = 0; i < 0x15; i = i + 1) {
    rgbRaw[((byte *)vrgbShuffleSerial)[i]] = rgbRaw2[i];
  }
  sVar2 = FValidSerialLong(CONCAT22(rgbRaw._2_2_,rgbRaw._0_2_));
  if (sVar2 == 0) {
    fSuccess = 0;
  }
  else {
    fSuccess = 1;
    PushRandom(0x11000b,lNew2);
    Randomize(CONCAT22(rgbRaw._2_2_,rgbRaw._0_2_));
    iRaw = 0xf;
    for (i = 0; i < 0xb; i = i + 1) {
      for (j = (short)rgbRaw[i + 4]; 0 < j; j = j + -1) {
        Random(0x10);
      }
      if (bVar1) {
        uVar3 = (int)(uint)rgbRaw[iRaw] >> 4;
        uVar4 = Random(0x10);
        if (uVar3 != (uVar4 & 0xff)) {
          fSuccess = 0;
        }
        iRaw = iRaw + 1;
      }
      else {
        uVar3 = rgbRaw[iRaw] & 0xf;
        uVar4 = Random(0x10);
        if (uVar3 != (uVar4 & 0xff)) {
          fSuccess = 0;
        }
      }
      bVar1 = (bool)(bVar1 + 1U & 1);
    }
    bXor = 0;
    for (i = 0; i < 0xf; i = i + 1) {
      bXor = bXor ^ rgbRaw[i];
    }
    if ((int)(uint)rgbRaw[iRaw] >> 4 != (bXor & 0xf)) {
      fSuccess = 0;
    }
    PopRandom();
    if (fSuccess != 0) {
      *(undefined2 *)plSerial = rgbRaw._0_2_;
      *(undefined2 *)(byte *)((int)plSerial + 2) = rgbRaw._2_2_;
      _memcpy(pbEnv,rgbRaw + 4,0xb);
    }
  }
  return fSuccess;
}



// ======================================================================
// Function: FFindSomethingAndSelectIt
// Address: 1020:2e1c
// Segment: MEMORY_MDI
// ======================================================================


short FFindSomethingAndSelectIt(void)

{
  FLEET *pFVar1;
  short sVar2;
  int iVar3;
  FLEET *lpfl;
  short i;
  PLANET *lppl;
  PLANET *lpplMac;
  
  lppl = LpplFromId(*(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0)
                         );
  iVar3 = (int)((ulong)lppl >> 0x10);
  if ((((PLANET *)lppl == (PLANET *)0x0) && (iVar3 == 0)) ||
     (((PLANET *)lppl)->iPlayer != idPlayer)) {
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    while( true ) {
      if (((PLANET *)lpPlanets + cPlanet <= (PLANET *)lppl) ||
         (((PLANET *)lppl)->iPlayer == idPlayer)) break;
      lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
    }
    if (((PLANET *)lppl == (PLANET *)lpPlanets + cPlanet) &&
       (lppl._2_2_ == lpPlanets._2_2_)) {
      lppl = (PLANET *)0x0;
    }
  }
  if (((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) {
    for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar1 = ((FLEET **)rglpfl)[i];
      iVar3 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpfl = (FLEET *)CONCAT22(iVar3,pFVar1);
      if ((pFVar1 == (FLEET *)0x0) && (iVar3 == 0)) break;
      if (pFVar1->iPlayer == idPlayer) {
        SelectAdjFleet(0,lpfl->id);
        return 1;
      }
    }
    sVar2 = 0;
  }
  else {
    SelectAdjPlanet(0,lppl->id);
    sVar2 = 1;
  }
  return sVar2;
}



// ======================================================================
// Function: CommandHandler
// Address: 1020:2f7a
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1020350e) */
/* WARNING: Removing unreachable block (ram,0x102034bc) */
/* WARNING: Removing unreachable block (ram,0x10203499) */
/* WARNING: Removing unreachable block (ram,0x102034e8) */
/* WARNING: Removing unreachable block (ram,0x10203583) */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void CommandHandler(HWND hwnd,ushort wParam)

{
  undefined2 *puVar1;
  undefined2 uVar2;
  PLAYER *pPVar3;
  PLAYER *pPVar4;
  POINT ptDlgSize;
  POINT pt_00;
  char cVar5;
  UINT UVar6;
  short sVar7;
  short sVar8;
  ushort uVar9;
  int iVar10;
  int iVar11;
  ushort uVar12;
  int iVar13;
  short sVar14;
  HCURSOR HVar15;
  char *pcVar16;
  ushort uVar17;
  undefined *puVar18;
  HMENU HVar19;
  HWND HVar20;
  int iVar21;
  undefined2 *puVar22;
  PLAYER *pPVar23;
  PLAYER *pPVar24;
  char *unaff_SS;
  ulong uVar25;
  ulong uVar26;
  long lVar27;
  FARPROC pvVar28;
  undefined1 *puVar29;
  HDC HVar30;
  char *pcVar31;
  char acStack_124 [112];
  undefined2 uStack_b4;
  undefined2 uStack_b2;
  short sStack_b0;
  short cch_2;
  long x_2;
  long y_3;
  short xOff;
  short yOff;
  RECT rc_2;
  short dyDPI;
  long ldy;
  short cch;
  short yPage;
  char *psz_2;
  short dSize;
  HFONT hfontSav;
  short dyMax;
  short dyPrint;
  POINT ptLegendA;
  POINT ptLegendB;
  HFONT hfontPrint;
  HFONT hfontPrintTiny;
  long ldx;
  short y;
  short dMargin;
  short dyPrintTiny;
  short dxDPI;
  short dxMax;
  short xPage;
  short cPageY;
  int iStack_66;
  undefined2 uStack_64;
  undefined2 uStack_62;
  HGLOBAL HStack_5e;
  HGLOBAL HStack_5c;
  HDC HStack_5a;
  undefined2 uStack_58;
  undefined2 uStack_56;
  ulong dwTickBase;
  ulong dwTickCur;
  PLANET *pPStack_30;
  PLANET *pPStack_2e;
  PLANET *lpplMac_2;
  char *psz_3;
  PLANET *pPStack_26;
  POINT pt_3;
  RECT rc;
  short fRet;
  short dx;
  char szExt [4];
  short dy;
  void *lpProc;
  HMENU hmenu;
  POINT pt;
  
  if ((14999 < wParam) && (wParam < 0x3afc)) {
    iPopMenuSel = wParam + 0xc568;
    return;
  }
  if (wParam == 0x53) {
    DumpFleets();
    return;
  }
  if (wParam == 0x54) {
    DumpPlanets();
    return;
  }
  if (wParam == 0x55) {
    DumpUniverse();
    return;
  }
  if ((wParam == 0x5f) || (wParam == 0x60)) {
    if (idPlayer == -1) {
      return;
    }
    pvVar28 = MakeProcInstance(ScoreXDlg,hInst);
    DialogBox(0,(LPCSTR)CONCAT22(0x66,hwnd),(HWND)((ulong)pvVar28 >> 0x10),(void *)pvVar28);
    FreeProcInstance(pvVar28);
    return;
  }
  if (wParam == 99) {
    pvVar28 = MakeProcInstance(About,hInst);
    DialogBox(0,(LPCSTR)CONCAT22(0x5a,hwnd),(HWND)((ulong)pvVar28 >> 0x10),(void *)pvVar28);
    FreeProcInstance(pvVar28);
    return;
  }
  if ((wParam == 0x67) || (wParam == 0x68)) {
    if ((sel.grobj == grobjFleet) && (HVar20 = GetFocus(), HVar20 != hwndOrderED))
    {
      DeleteCurWayPoint((uint)(wParam == 0x67));
    }
MDI_Default_4:
    DefWindowProc(hwnd,0x111,wParam,0);
    return;
  }
  if (wParam == 0x69) {
    if (((uint)game.wCrap >> 2 & 1) == 0) {
      pcVar31 = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
      pcVar16 = PszFormatIds(idsGameAlreadyHostedAnotherInstanceStarsWould,(short *)0x0);
      sVar14 = AlertSz(pcVar16,(short)pcVar31);
      if (sVar14 != 6) {
        return;
      }
    }
LAB_1020_3f6e:
    pt_3.y = idPlayer;
    if (wParam == 0x5209) {
      iPassCnt = 100;
    }
    else if ((HBRUSH *)wParam == (HBRUSH *)&hbrCargo) {
      iPassCnt = 1000;
    }
    else if (wParam == 21000) {
      iPassCnt = 10;
    }
    else {
      iPassCnt = 0;
    }
    if ((((uint)game.wCrap >> 2 & 1) != 0) && (iPassCnt != 0)) {
      sVar14 = iPassCnt;
      pcVar16 = PszGetCompressedString(idsSureWantForceGenerateDTurnsRow);
      _WSPRINTF((LPSTR)CONCAT22(sVar14,(char *)&DAT_1120_1120),
                (LPCSTR)CONCAT22(pcVar16,(char *)&DAT_1120_1120),(char *)szWork);
      HVar20 = GetFocus();
      sVar14 = MessageBox(HVar20,szWork,(LPCSTR)0x112003de,0x2034);
      if (sVar14 != 6) {
        return;
      }
    }
    if (idPlayer == -1) {
      return;
    }
    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
      AdvanceTutor();
      if (((uint)tutor.wFlags >> 3 & 1) == 0) {
        sVar14 = 0x10;
        pcVar16 = PszFormatIds(idsTutorialTurnWillGeneratedHaveYetCompleted,(short *)0x0);
        AlertSz(pcVar16,sVar14);
        return;
      }
      ShowTutor(0);
      if ((uint)game.turn < 0x24) {
        Randomize(0x499602d2);
        FWriteHistFile(pt_3.y);
        sVar14 = FWriteTutorialMFile(game.turn + 1);
        if (sVar14 == 0) {
          sVar14 = 0x10;
          pcVar16 = PszFormatIds(idsFileError,(short *)0x0);
          AlertSz(pcVar16,sVar14);
          return;
        }
        if ((game.turn == 0x23) && (sVar14 = FWriteTutorialMFile(0x25), sVar14 == 0))
        {
          sVar14 = 0x10;
          pcVar16 = PszFormatIds(idsFileError,(short *)0x0);
          AlertSz(pcVar16,sVar14);
          return;
        }
        _strcpy((char *)szWork,(char *)szBase);
        _strcat((char *)szWork,(char *)0x3e5);
        _remove((char *)szWork);
        DirtyGame(0);
        ShowProgressGauge();
        pPStack_30 = (PLANET *)0xc;
        pPStack_2e = (PLANET *)0x0;
        TimerCount((undefined *)&DAT_1120_1040,&pPStack_30);
        dwTickBase._0_2_ = (PLANET *)lpplMac_2;
        dwTickBase._2_2_ = lpplMac_2._2_2_;
        do {
          UpdateProgressGauge(((int)(PLANET *)dwTickCur - (int)(PLANET *)dwTickBase) * 2);
          TimerCount((undefined *)&DAT_1120_1040,&pPStack_30);
          dwTickCur._0_2_ = (PLANET *)lpplMac_2;
          dwTickCur._2_2_ = lpplMac_2._2_2_;
          if ((lpplMac_2._2_2_ < dwTickBase._2_2_) ||
             ((lpplMac_2._2_2_ <= dwTickBase._2_2_ && ((PLANET *)lpplMac_2 < (PLANET *)dwTickBase)))
             ) break;
        } while ((lpplMac_2._2_2_ <
                  (PLANET *)
                  ((dwTickBase._2_2_)->rgpctMinLevel +
                  (((PLANET *)0xfe0b < (PLANET *)dwTickBase) - 6))) ||
                ((lpplMac_2._2_2_ <=
                  (PLANET *)
                  ((dwTickBase._2_2_)->rgpctMinLevel +
                  (((PLANET *)0xfe0b < (PLANET *)dwTickBase) - 6)) &&
                 ((PLANET *)lpplMac_2 < &((PLANET *)dwTickBase)[8].lpplprod))));
        goto MDI_LTutorialFinishUp;
      }
    }
    if (((uint)game.wCrap >> 2 & 1) != 0) {
      idsFileError = -1;
      sVar14 = FCheckFile(dtHost,-1,1);
      if (sVar14 == 0) {
        HVar15 = LoadCursor(0,&DAT_0000_7f02);
        pt_3.x = setcursor(HVar15);
        FWriteLogFile((char *)szBase,pt_3.y);
        FWriteHistFile(pt_3.y);
        do {
          ShowProgressGauge();
          EnsureAis();
          FGenerateTurn();
          if ((((wParam != 21000) && (wParam != 0x5209)) &&
              ((HBRUSH *)wParam != (HBRUSH *)&hbrCargo)) ||
             (iPassCnt = iPassCnt + -1, iPassCnt < 1)) break;
          HideProgressGauge();
          sVar14 = GetAsyncKeyState(0x10);
        } while ((-1 < sVar14) || (sVar14 = GetAsyncKeyState(0x11), -1 < sVar14));
        iPassCnt = 0;
MDI_LTutorialFinishUp:
        DestroyCurGame();
        _WSPRINTF((LPSTR)CONCAT22(pt_3.y + 1,(char *)&DAT_1120_1120),
                  (LPCSTR)CONCAT22(MPCTD,unaff_SS),szExt);
        sVar14 = FLoadGame((char *)szBase,szExt);
        if (sVar14 == 0) {
          setcursor(pt_3.x);
          HideProgressGauge();
          sVar14 = 0x10;
          pcVar16 = PszFormatIds(idsUnableOpenNewTurnFile,(short *)0x0);
          AlertSz(pcVar16,sVar14);
          return;
        }
        HideProgressGauge();
        idPlayer = pt_3.y;
        CreateChildWindows();
        SendMessage(hwndFrame,0x111,0xfa1,0);
        setcursor(pt_3.x);
        if (((uint)gd._0_2_ >> 0xb & 1) == 0) {
          return;
        }
        tutor.wFlags = tutor.wFlags & 0xfdf7;
        AdvanceTutor();
        return;
      }
      sVar14 = FBadFileError(idsFileError);
      if (sVar14 != 0) {
        sVar14 = 0x10;
        pcVar16 = PszFormatIds(idsFileError,(short *)0x0);
        AlertSz(pcVar16,sVar14);
        return;
      }
      pcVar31 = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
      pcVar16 = PszFormatIds(idsGameAlreadyHostedAnotherInstanceStarsWould,(short *)0x0);
      sVar14 = AlertSz(pcVar16,(short)pcVar31);
      if (sVar14 != 6) {
        return;
      }
    }
  }
  else if (wParam != 0x6a) {
    if (wParam != 0x6c) {
      if (wParam == 0x6d) {
LAB_1020_4a53:
        if ((((uint)gd._0_2_ >> 0xb & 1) != 0) &&
           (sVar14 = FAskKillTutor(), sVar14 == 0)) {
          return;
        }
        sVar14 = FOpenGame(hwnd,0);
        if (sVar14 < 1) {
          return;
        }
        InitializeMenu(0);
        if (uTimerId == 0) {
          PostMessage(hwnd,0x111,0xfa1,0);
        }
        if (((uint)game.wCrap >> 3 & 1) == 0) {
          return;
        }
        if (idPlayer != 0) {
          return;
        }
        StartTutor(0);
        return;
      }
      if (wParam == 0x6e) {
LAB_1020_3083:
        if ((((uint)gd._0_2_ >> 0xb & 1) != 0) &&
           (sVar14 = FAskKillTutor(), sVar14 == 0)) {
          return;
        }
        NewGameWizard(hwnd,0);
        return;
      }
      if (wParam != 0x6f) {
        if (wParam == 0x71) {
          if ((((uint)gd._0_2_ >> 0xb & 1) != 0) &&
             (sVar14 = FAskKillTutor(), sVar14 == 0)) {
            return;
          }
          WriteIniSettings();
          DestroyCurGame();
          _strcpy((char *)szBase,(char *)szWork);
          ini.wFlags = ini.wFlags & 0xfe1f;
          ini.iObjSel = 0;
          ini.idPlayer = -1;
          InitializeMenu(0);
          pt_3.x = GetSystemMetrics(0);
          pt_3.y = GetSystemMetrics(1);
          hwndTitle =
               CreateWindow(szTitle,(LPCSTR)0x112003e9,0x90000000,0,0,pt_3.x,pt_3.y,
                            hwndFrame,0,hInst,(void *)0x0);
          fFreeingTitle = 0;
          ShowWindow(hwndFrame,0);
          return;
        }
        if (wParam == 0x7d) {
LAB_1020_4df3:
          if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
            return;
          }
          if (idPlayer == -1) {
            return;
          }
          pt_3.x = 0x262;
          pt_3.y = 0x1c2;
          if (hwndPopup != 0) {
            SendMessage(hwndPopup,0x205,0,0);
          }
          ptDlgSize.y = pt_3.y;
          ptDlgSize.x = pt_3.x;
          ShipBuilder(ptDlgSize);
          return;
        }
        if (wParam == 0x7e) {
LAB_1020_4be3:
          if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
            return;
          }
          if (idPlayer == -1) {
            return;
          }
          pvVar28 = MakeProcInstance(ResearchDlg,hInst);
          sVar14 = DialogBox(0,(LPCSTR)CONCAT22(0x7f,hwndFrame),
                             (HWND)((ulong)pvVar28 >> 0x10),(void *)pvVar28);
          FreeProcInstance(pvVar28);
          if (sVar14 == 0) {
            return;
          }
          if (sel.grobj != grobjPlanet) {
            return;
          }
          if (((PLPROD *)sel.pl.lpplprod != (PLPROD *)0x0) ||
             (sel.pl.lpplprod._2_2_ != 0)) {
            FillPlanetProdLB
                      (hwndPlanetProdLB,
                       (PLPROD *)
                       CONCAT22(sel.pl.lpplprod._2_2_,(PLPROD *)sel.pl.lpplprod)
                       ,(PLANET *)0x0);
          }
          DrawPlanShip(0,0x48);
          return;
        }
        if (wParam == 0x81) {
          puVar22 = (undefined2 *)&vrgplrDef;
          pPVar23 = (PLAYER *)&vplr;
          for (iVar21 = 0x60; iVar21 != 0; iVar21 = iVar21 + -1) {
            pPVar3 = pPVar23;
            pPVar23 = (PLAYER *)&pPVar23->cPlanet;
            puVar1 = puVar22;
            puVar22 = puVar22 + 1;
            uVar2 = *puVar1;
            pPVar3->iPlayer = (char)uVar2;
            pPVar3->cShDef = (char)((uint)uVar2 >> 8);
          }
          RaceCreationWizard(hwnd,0,0);
          return;
        }
        if (((wParam == 0x82) || (wParam == 0x83)) || (wParam == 0x84)) {
          if (idPlayer == -1) {
            return;
          }
          iWindowLayout = wParam - 0x82;
          InvalidateRect(hwndFrame,(undefined2 *)0x0,1);
          EnsureTileSize((uint)(iWindowLayout == 2));
          RefitFrameChildren();
          return;
        }
        if (wParam == 0x87) goto LAB_1020_4be3;
        if (wParam == 0x88) {
LAB_1020_440c:
          if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
            return;
          }
          if (idPlayer == -1) {
            return;
          }
          if (hwndBrowser == 0) {
            pt_3.y = 8;
            CreateDialog(0,(LPCSTR)CONCAT22(0x80,hwndFrame),
                         lpfnBrowserDlgProc._2_2_,
                         (fn_lpfnBrowserDlgProc *)lpfnBrowserDlgProc);
          }
          else {
            pt_3.y = 0;
            DestroyWindow(hwndBrowser);
          }
          uVar17 = GetASubMenu(hwnd,5);
          CheckMenuItem(uVar17,0x100,pt_3.y);
          return;
        }
        if (wParam == 0x89) goto LAB_1020_4df3;
        if (wParam == 0x8a) {
LAB_1020_47b3:
          WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),3,0);
          return;
        }
        if ((wParam == 0x9c) || (wParam == 0x9d)) {
          if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
            return;
          }
          if (idPlayer == -1) {
            return;
          }
          pPVar23 = (PLAYER *)rgplr + idPlayer;
          pPVar24 = (PLAYER *)&vplr;
          for (iVar21 = 0x60; iVar21 != 0; iVar21 = iVar21 + -1) {
            pPVar4 = pPVar24;
            pPVar24 = (PLAYER *)&pPVar24->cPlanet;
            pPVar3 = pPVar23;
            pPVar23 = (PLAYER *)&pPVar23->cPlanet;
            cVar5 = pPVar3->cShDef;
            pPVar4->iPlayer = pPVar3->iPlayer;
            pPVar4->cShDef = cVar5;
          }
          RaceCreationWizard(hwnd,1,0);
          return;
        }
        if ((wParam == 0x9e) || (wParam == 0x9f)) {
          if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
            return;
          }
          if (idPlayer == -1) {
            return;
          }
          NewGameWizard(hwnd,1);
          return;
        }
        if (wParam == 0xb3) {
          uVar17 = GetASubMenu(hwnd,1);
          pt_3.y = (short)(-1 < gd.wFlags);
          gd.wFlags = gd.wFlags & 0x7fffU | pt_3.y << 0xf;
          if (pt_3.y == 0) {
            UVar6 = 0;
          }
          else {
            UVar6 = 8;
          }
          CheckMenuItem(uVar17,0xb3,UVar6);
          RefitFrameChildren();
          return;
        }
        if (wParam == 0xd5) {
          if (idPlayer == -1) {
            return;
          }
          pvVar28 = MakeProcInstance(PrintMapDlg,hInst);
          psz_3 = (char *)((ulong)pvVar28 >> 0x10);
          lpplMac_2._2_2_ = (PLANET *)pvVar28;
          iStack_66 = DialogBox(0,(LPCSTR)CONCAT22(0xd6,hwndFrame),(HWND)psz_3,
                                lpplMac_2._2_2_);
          FreeProcInstance((FARPROC)CONCAT22(psz_3,lpplMac_2._2_2_));
          if (iStack_66 == 0) {
            return;
          }
          pt_3.y = vrgcPrintMapPage[0];
          cPageY = vrgcPrintMapPage[1];
          _memset(&uStack_64,0,0x34);
          uStack_64 = 0x34;
          uStack_62 = 0;
          uStack_58 = 0x500;
          uStack_56 = 0;
          iVar21 = PrintDlg(0x1118,&uStack_64);
          if (iVar21 == 0) {
            sVar14 = 0x10;
            pcVar16 = PszFormatIds(idsUnablePrintGameMapPrinterMayOff,(short *)0x0);
            AlertSz(pcVar16,sVar14);
            return;
          }
          dxMax = GetDeviceCaps(HStack_5a,8);
          sVar7 = GetDeviceCaps(HStack_5a,10);
          dxDPI = GetDeviceCaps(HStack_5a,0x58);
          sVar8 = GetDeviceCaps(HStack_5a,0x5a);
          uVar17 = HfontPrinterCreate(HStack_5a,8,&dyPrint);
          uVar9 = HfontPrinterCreate(HStack_5a,5,&dyPrintTiny);
          SetBkMode(HStack_5a,1);
          sVar14 = pt_3.y;
          rc_2.top = 0;
          rc_2.left = 0;
          yOff = (short)(cPageY < pt_3.y);
          if (yOff == (uint)(sVar7 < dxMax)) {
            pPStack_30 = (PLANET *)pt_3.y;
            pt_3.y = cPageY;
            cPageY = sVar14;
          }
          uVar25 = __aFulmul((long)dxMax,(long)pt_3.y);
          uVar26 = __aFulmul((long)sVar7,(long)cPageY);
          if (32000 < (long)uVar25) {
            uVar25 = 32000;
          }
          if (32000 < (long)uVar26) {
            uVar26 = 32000;
          }
          if ((long)uVar25 < (long)uVar26) {
            if ((long)(uVar26 - (long)sVar8) < (long)uVar25) {
              uVar25 = uVar26 - (long)sVar8;
            }
            ldx._0_2_ = (int)uVar25;
            dSize = (int)ldx;
            ptLegendA.x = 0x20;
            ptLegendA.y = (int)ldx + 0x20;
            ptLegendB.x = (int)ldx / 2;
            ptLegendB.y = ptLegendA.y;
          }
          else {
            if ((long)(uVar25 - (long)((dxDPI * 3) / 2)) < (long)uVar26) {
              uVar26 = uVar25 - (long)((dxDPI * 3) / 2);
            }
            ldy._0_2_ = (int)uVar26;
            dSize = (int)ldy;
            ptLegendA.x = (int)ldy + 0x20;
            ptLegendA.y = 0x20;
            ptLegendB.y = (int)ldy / 2;
            ptLegendB.x = ptLegendA.x;
          }
          rc_2.bottom = dSize;
          rc_2.right = dSize;
          iVar21 = dSize + -0x40;
          for (xPage = 0; xPage < pt_3.y; xPage = xPage + 1) {
            for (yPage = 0; yPage < cPageY; yPage = yPage + 1) {
              xOff = -dxMax * xPage;
              yOff = -sVar7 * yPage;
              sVar14 = CchGetString(idsStarsUniverseMap,(char *)szWork);
              Escape(HStack_5a,10,sVar14,szWork,(void *)0x0);
              Rectangle(HStack_5a,xOff,yOff,xOff + rc_2.right,yOff + rc_2.bottom);
              if (uVar17 == 0) {
                hfontSav = 0;
              }
              else {
                hfontSav = SelectObject(HStack_5a,uVar17);
              }
              iVar10 = ptLegendA.y + yOff;
              sVar14 = CchGetString(idsStarsUniverseMap,(char *)szWork);
              TextOut(HStack_5a,ptLegendA.x + xOff,iVar10,szWork,sVar14);
              iVar10 = iVar10 + dyPrint;
              iVar11 = ptLegendA.x + xOff;
              puVar29 = (undefined1 *)&DAT_1120_1120;
              pcVar16 = (char *)game.szName;
              iVar13 = iVar10;
              HVar30 = HStack_5a;
              uVar12 = _strlen((char *)game.szName);
              TextOut(HVar30,iVar11,iVar13,(LPCSTR)CONCAT22(puVar29,pcVar16),uVar12);
              iVar10 = iVar10 + dyPrint;
              pcVar16 = PszPlayerName(idPlayer,1,1,1,0,(PLAYER *)0x0);
              iVar11 = ptLegendA.x + xOff;
              puVar29 = (undefined1 *)&DAT_1120_1120;
              iVar13 = iVar10;
              HVar30 = HStack_5a;
              uVar12 = _strlen(pcVar16);
              TextOut(HVar30,iVar11,iVar13,(LPCSTR)CONCAT22(puVar29,pcVar16),uVar12);
              iVar10 = iVar10 + dyPrint;
              iVar13 = game.turn + 0x960;
              pcVar16 = PszGetCompressedString(idsYearD);
              sVar14 = _WSPRINTF((LPSTR)CONCAT22(iVar13,(char *)&DAT_1120_1120),
                                 (LPCSTR)CONCAT22(pcVar16,(char *)&DAT_1120_1120),
                                 (char *)szWork);
              TextOut(HStack_5a,ptLegendA.x + xOff,iVar10,szWork,sVar14);
              if ((grbitScan & 0xf) != 5) {
                y = ptLegendB.y + yOff;
                for (pPStack_30 = (PLANET *)0x0; (int)pPStack_30 < 5;
                    pPStack_30 = (PLANET *)((int)&pPStack_30->id + 1)) {
                  sVar14 = CchGetString
                                     ((StringId)((int)&pPStack_30[0x17].dwFlags + 2),
                                      (char *)szWork);
                  TextOut(HStack_5a,ptLegendB.x + xOff,y,szWork,sVar14);
                  y = y + dyPrint;
                }
                iVar10 = ptLegendB.y + yOff;
                if (uVar9 != 0) {
                  SelectObject(HStack_5a,uVar9);
                }
                y_3._2_2_ = dyPrintTiny / 2;
                CtrTextOut(HStack_5a,ptLegendB.x + xOff,
                                    ((dyPrint * 3) / 2 + iVar10) - y_3._2_2_,(char *)0x3d4,1);
                y_3._2_2_ = dyPrintTiny / 2;
                CtrTextOut(HStack_5a,ptLegendB.x + xOff,
                                    ((dyPrint * 5) / 2 + iVar10) - y_3._2_2_,(char *)0x3d6,1);
                CtrTextOut(HStack_5a,ptLegendB.x + xOff,
                                    ((dyPrint * 9) / 2 + iVar10 + 8) - dyPrintTiny,(char *)0x3d8,1);
                if (uVar17 != 0) {
                  SelectObject(HStack_5a,uVar17);
                }
                DrawPlanetPrintDot(HStack_5a,ptLegendB.x + xOff,iVar10 + -4 + dyPrint / 2,1);
                DrawPlanetPrintDot
                          (HStack_5a,ptLegendB.x + xOff,iVar10 + -4 + (dyPrint * 7) / 2,0);
                DrawPlanetPrintDot
                          (HStack_5a,ptLegendB.x + xOff,(dyPrint * 9) / 2 + iVar10 + 8,0);
              }
              if ((grbitScan & 0xf) != 5) {
                if (uVar9 != 0) {
                  SelectObject(HStack_5a,uVar9);
                }
                lpplMac_2._0_2_ = lpPlanets._2_2_;
                y_3 = CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
                pPStack_26 = (PLANET *)lpPlanets + cPlanet;
                pt_3.x = (short)lpPlanets._2_2_;
                for (pPStack_2e = (PLANET *)lpPlanets; pPStack_2e < pPStack_26;
                    pPStack_2e = pPStack_2e + 1) {
                  x_2._0_2_ = ((POINT *)rgptPlan +
                              ((PLANET *)CONCAT22((PLANET *)lpplMac_2,pPStack_2e))->id)->x + -1000;
                  x_2._2_2_ = (int)x_2 >> 0xf;
                  y_3._0_2_ = (PLANET *)
                              ((dGalInv + -1000) -
                              *(int *)((int)&rgptPlan[0].y +
                                      ((PLANET *)CONCAT22((PLANET *)lpplMac_2,pPStack_2e))->id * 4))
                  ;
                  y_3._2_2_ = (int)(PLANET *)y_3 >> 0xf;
                  cch_2 = xOff >> 0xf;
                  sStack_b0 = xOff;
                  uStack_b4 = 0x20;
                  iVar10 = dGal >> 0xf;
                  sVar14 = dGal;
                  uStack_b2 = 0;
                  uVar26 = __aFulmul((long)(int)x_2,(long)iVar21);
                  lVar27 = __aFldiv(uVar26,CONCAT22(iVar10,sVar14));
                  x_2 = lVar27 + CONCAT22(uStack_b2,uStack_b4) + CONCAT22(cch_2,sStack_b0);
                  cch_2 = yOff >> 0xf;
                  sStack_b0 = yOff;
                  uStack_b4 = 0x20;
                  iVar10 = dGal >> 0xf;
                  sVar14 = dGal;
                  uStack_b2 = 0;
                  uVar26 = __aFulmul(CONCAT22(y_3._2_2_,(PLANET *)y_3),(long)iVar21);
                  lVar27 = __aFldiv(uVar26,CONCAT22(iVar10,sVar14));
                  y_3 = lVar27 + CONCAT22(uStack_b2,uStack_b4) + CONCAT22(cch_2,sStack_b0);
                  if (pPStack_2e->iPlayer == idPlayer) {
                    if (((uint)pPStack_2e->wFlags >> 9 & 1) != 0) {
                      iVar10 = pPStack_2e->iPlayer * 4;
                      if (*(int *)(*(int *)(iVar10 + 0x14c) +
                                  (*(uint *)&pPStack_2e->field11_0x2c & 0xf) * 0x93) == 0x20) {
                        pcVar16 = (char *)0x3da;
                      }
                      else {
                        pcVar16 = (char *)0x3dc;
                      }
                      CtrTextOut(HStack_5a,(int)x_2,(int)(PLANET *)y_3 + (4 - dyPrintTiny),
                                          pcVar16,1);
                    }
                    DrawPlanetPrintDot(HStack_5a,(int)x_2,(short)(PLANET *)y_3,1);
                  }
                  else if (pPStack_2e->iPlayer != -1) {
                    cch_2 = _WSPRINTF((LPSTR)CONCAT22(pPStack_2e->iPlayer + 1,(char *)&DAT_1120_1120
                                                     ),
                                      (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),
                                      (char *)szWork);
                    CtrTextOut(HStack_5a,(int)x_2,(int)(PLANET *)y_3 - dyPrintTiny,
                                        (char *)szWork,cch_2);
                  }
                }
              }
              if (uVar17 != 0) {
                SelectObject(HStack_5a,uVar17);
              }
              for (pPStack_30 = (PLANET *)0x0; (int)pPStack_30 < game.cPlanMax;
                  pPStack_30 = (PLANET *)((int)&pPStack_30->id + 1)) {
                x_2._0_2_ = ((POINT *)rgptPlan + (int)pPStack_30)->x + -1000;
                x_2._2_2_ = (int)x_2 >> 0xf;
                y_3._0_2_ = (PLANET *)
                            ((dGalInv + -1000) -
                            *(int *)((int)&rgptPlan[0].y + (int)pPStack_30 * 4));
                y_3._2_2_ = (int)(PLANET *)y_3 >> 0xf;
                cch_2 = xOff >> 0xf;
                sStack_b0 = xOff;
                uStack_b4 = 0x20;
                iVar10 = dGal >> 0xf;
                sVar14 = dGal;
                uStack_b2 = 0;
                uVar26 = __aFulmul((long)(int)x_2,(long)iVar21);
                lVar27 = __aFldiv(uVar26,CONCAT22(iVar10,sVar14));
                x_2 = lVar27 + CONCAT22(uStack_b2,uStack_b4) + CONCAT22(cch_2,sStack_b0);
                cch_2 = yOff >> 0xf;
                sStack_b0 = yOff;
                uStack_b4 = 0x20;
                iVar10 = dGal >> 0xf;
                sVar14 = dGal;
                uStack_b2 = 0;
                uVar26 = __aFulmul(CONCAT22(y_3._2_2_,(PLANET *)y_3),(long)iVar21);
                lVar27 = __aFldiv(uVar26,CONCAT22(iVar10,sVar14));
                y_3 = lVar27 + CONCAT22(uStack_b2,uStack_b4) + CONCAT22(cch_2,sStack_b0);
                DrawPlanetPrintDot(HStack_5a,(int)x_2,(short)y_3,0);
                if ((grbitScan & 0x400) != 0) {
                  sVar14 = 0;
                  pcVar16 = PszGetPlanetName((short)pPStack_30);
                  CtrTextOut(HStack_5a,(int)x_2,(int)(PLANET *)y_3 + 0xe,pcVar16,sVar14);
                }
              }
              if (hfontSav != 0) {
                SelectObject(HStack_5a,hfontSav);
              }
              Escape(HStack_5a,1,0,(LPCSTR)0x0,(void *)0x0);
            }
          }
          Escape(HStack_5a,0xb,0,(LPCSTR)0x0,(void *)0x0);
          if (uVar17 != 0) {
            DeleteObject(uVar17);
          }
          if (uVar9 != 0) {
            DeleteObject(uVar9);
          }
          DeleteDC(HStack_5a);
          if (HStack_5e != 0) {
            GlobalFree(HStack_5e);
          }
          if (HStack_5c == 0) {
            return;
          }
          GlobalFree(HStack_5c);
          return;
        }
        if ((((wParam == 0xfa) || (wParam == 0xfb)) || (wParam == 0xfc)) || (wParam == 0xfd)) {
          if (hwndTitle == 0) {
            return;
          }
          PostMessage(hwndTitle,0x111,wParam - 0xfa,0);
          return;
        }
        if (wParam == 0x100) goto LAB_1020_440c;
        if (wParam == 0x101) goto LAB_1020_47b3;
        if (wParam == 0x10e) {
          if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
            return;
          }
          if (idPlayer == -1) {
            return;
          }
          if ((((uint)game.wCrap >> 2 & 1) != 0) && (lSaltCur._2_2_ < 1)) {
            if (lSaltCur._2_2_ < 0) {
              return;
            }
            if ((int)lSaltCur == 0) {
              return;
            }
          }
          sVar14 = FCheckPassword();
          if (sVar14 == 0) {
            return;
          }
          pvVar28 = MakeProcInstance(NewPasswordDlg,hInst);
          DialogBox(0,(LPCSTR)CONCAT22(0x8d,hwndFrame),(HWND)((ulong)pvVar28 >> 0x10),
                    (void *)pvVar28);
          FreeProcInstance(pvVar28);
          return;
        }
        if (wParam == 0x428) {
          wParam = 0xedb;
        }
        else {
          if (wParam == 0x7d9) {
LAB_1020_4cfb:
            if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
              return;
            }
            if (idPlayer == -1) {
              return;
            }
            if (((uint)game.wCrap >> 2 & 1) != 0) {
              return;
            }
            pvVar28 = MakeProcInstance(RelationsDlg,hInst);
            DialogBox(0,(LPCSTR)CONCAT22(0x7d8,hwndFrame),(HWND)((ulong)pvVar28 >> 0x10),
                      (void *)pvVar28);
            FreeProcInstance(pvVar28);
            return;
          }
          if (wParam == 0x7da) goto MDI_LWaitForTurn;
          if ((wParam == 0x7db) || (wParam == 0x7dc)) {
            if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
              return;
            }
            if (idPlayer == -1) {
              return;
            }
            pvVar28 = MakeProcInstance(BattlePlansDlg,hInst);
            DialogBox(0,(LPCSTR)CONCAT22(0x7dd,hwndFrame),(HWND)((ulong)pvVar28 >> 0x10),
                      (void *)pvVar28);
            FreeProcInstance(pvVar28);
            return;
          }
          if (wParam == 0x7de) goto LAB_1020_4cfb;
          if (wParam == 0x8fd) {
LAB_1020_44cc:
            pPStack_26 = (PLANET *)0x0;
            if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
              return;
            }
            if (idPlayer == -1) {
              return;
            }
            uVar17 = GetASubMenu(hwnd,4);
            while (hwndReportDlg != 0) {
              if ((wParam == 0x901) && (vprptCur == (RPT *)&vrptBattle)) {
                pt_3.x = 0;
              }
              else {
                pt_3.x = 1;
              }
              pt_3.y = 0;
              DestroyWindow(hwndReportDlg);
              if (wParam == 0x8ff) {
                UVar6 = 0x8ff;
              }
              else {
                UVar6 = 0x8fd;
              }
              CheckMenuItem(uVar17,UVar6,pt_3.y);
              if (pt_3.x != 1) {
                return;
              }
            }
            pt_3.y = 8;
            if (wParam == 0x8ff) {
              pt_3.x = 0x49a;
              vprptCur = (RPT *)&vrptFleet;
              for (lpplMac_2._2_2_ = (PLANET *)0x0; (int)lpplMac_2._2_2_ < cFleet;
                  lpplMac_2._2_2_ = (PLANET *)((int)&(lpplMac_2._2_2_)->id + 1)) {
                pPStack_2e = *(PLANET **)((FLEET **)rglpfl + (int)lpplMac_2._2_2_);
                lpplMac_2._0_2_ =
                     (PLANET *)*(int *)((int)((FLEET **)rglpfl + (int)lpplMac_2._2_2_) + 2);
                if ((pPStack_2e == (PLANET *)0x0) && ((PLANET *)lpplMac_2 == (PLANET *)0x0)) break;
                if (pPStack_2e->iPlayer == idPlayer) {
                  pPStack_26 = (PLANET *)((int)pPStack_26 + 1);
                }
              }
            }
            else if (wParam == 0x900) {
              pt_3.x = 0x49b;
              vprptCur = (RPT *)&vrptEFleet;
              for (lpplMac_2._2_2_ = (PLANET *)0x0; (int)lpplMac_2._2_2_ < cFleet;
                  lpplMac_2._2_2_ = (PLANET *)((int)&(lpplMac_2._2_2_)->id + 1)) {
                pPStack_2e = *(PLANET **)((FLEET **)rglpfl + (int)lpplMac_2._2_2_);
                lpplMac_2._0_2_ =
                     (PLANET *)*(int *)((int)((FLEET **)rglpfl + (int)lpplMac_2._2_2_) + 2);
                if ((pPStack_2e == (PLANET *)0x0) && ((PLANET *)lpplMac_2 == (PLANET *)0x0)) break;
                if (pPStack_2e->iPlayer != idPlayer) {
                  pPStack_26 = (PLANET *)((int)pPStack_26 + 1);
                }
              }
            }
            else if (wParam == 0x901) {
              vprptCur = (RPT *)&vrptBattle;
              pt_3.x = 0x49c;
              pPStack_26 = (PLANET *)CBattles();
            }
            else {
              vprptCur = (RPT *)&vrptPlanet;
              pt_3.x = 0x499;
              pPStack_2e = lpPlanets._2_2_;
              dwTickCur._0_2_ = (PLANET *)lpPlanets;
              dwTickCur._2_2_ = lpPlanets._2_2_;
              lpplMac_2._0_2_ = (PLANET *)lpPlanets + cPlanet;
              lpplMac_2._2_2_ = lpPlanets._2_2_;
              for (pPStack_30 = (PLANET *)lpPlanets; pPStack_30 < (PLANET *)lpplMac_2;
                  pPStack_30 = pPStack_30 + 1) {
                if (pPStack_30->iPlayer == idPlayer) {
                  pPStack_26 = (PLANET *)((int)pPStack_26 + 1);
                }
              }
            }
            psz_3 = PszGetCompressedString(pt_3.x);
            _WSPRINTF((LPSTR)CONCAT22(pPStack_26,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(psz_3,(char *)&DAT_1120_1120),(char *)szWork);
            hwndReportDlg =
                 CreateWindow(szReport,szWork,0x80cf0000,0,0,100,100,
                              hwndFrame,0,hInst,(void *)0x0);
            SetWindowPos(hwndReportDlg,0,0,0,0,0,0x47);
            CheckMenuItem(uVar17,wParam,pt_3.y);
            return;
          }
          if (wParam == 0x8fe) {
            if (hwndReportDlg == 0) {
              wParam = 0x8fd;
            }
            else if (vprptCur == (RPT *)&vrptPlanet) {
              wParam = 0x8ff;
            }
            else if (vprptCur == (RPT *)&vrptFleet) {
              wParam = 0x900;
            }
            else {
              wParam = 0x901;
            }
            goto LAB_1020_44cc;
          }
          if (((wParam == 0x8ff) || (wParam == 0x900)) || (wParam == 0x901)) goto LAB_1020_44cc;
          if (wParam == 0x98d) {
            uVar17 = GetASubMenu(hwnd,1);
            grbitScan = grbitScan ^ 0x2000;
            if ((grbitScan & 0x2000) == 0) {
              UVar6 = 0;
            }
            else {
              UVar6 = 8;
            }
            CheckMenuItem(uVar17,0x98d,UVar6);
            gd._4_2_ = gd._4_2_ & 0xffbf | 0x40;
            if ((grbitScan & 0x1400) == 0) {
              gd.field3_0x4 = (char)gd._4_2_;
              gd.field4_0x5 = (char)((uint)gd._4_2_ >> 8);
              return;
            }
            InvalidateRect(hwndScanner,(undefined2 *)0x0,0);
            return;
          }
          if ((wParam == 0x9c1) || (wParam == 0x9c2)) {
            if (wParam == 0x9c2) {
              puVar18 = (undefined *)&DAT_1120_1195;
            }
            else {
              puVar18 = (undefined *)0x32ca;
            }
            WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,
                    ZEXT24(puVar18));
            return;
          }
          if ((wParam == 0x9c4) || (wParam == 0x9c5)) {
            if (((uint)gd._0_2_ >> 0xb & 1) == 0) {
              StartTutor(0);
              return;
            }
            ShowTutor(1);
            return;
          }
          if (wParam == 0xed8) goto LAB_1020_3083;
          if (wParam == 0xed9) goto LAB_1020_4a53;
          if ((wParam != 0xeda) && (wParam != 0xedb)) {
            if (wParam == 0xee2) {
              SendMessage(hwnd,0x10,0,0);
              return;
            }
            if (((((wParam == 0xf3d) || (wParam == 0xf3e)) || (wParam == 0xf3f)) ||
                (((wParam == 0xf40 || (wParam == 0xf41)) ||
                 ((wParam == 0xf42 || ((wParam == 0xf43 || (wParam == 0xf44)))))))) ||
               (wParam == 0xf45)) {
              if (hwndScanner != 0) {
                uVar17 = GetASubMenu(hwnd,1);
                HVar19 = GetSubMenu(uVar17,3);
                CheckMenuItem(HVar19,iScanZoom + 4,0x400);
                GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
                sVar14 = ScanToPt(rc.right);
                rc.right = sVar14 >> 1;
                sVar7 = ScanToPt(rc.bottom);
                sVar14 = xScanTop;
                rc.bottom = sVar7 >> 1;
                iVar21 = dGalInv - yScanTop;
                iScanZoom = wParam - 0xf41;
                CheckMenuItem(HVar19,wParam - 0xf3d,0x408);
                DrawMenuBar(hwnd);
                SetScanScrollBars(hwndScanner);
                InvalidateRect(hwndScanner,(undefined2 *)0x0,1);
                if (sel.scan.grobj == grobjNone) {
                  pt.x = sVar14 + rc.right;
                  pt.y = iVar21 - rc.bottom;
                }
                else {
                  pt.x = sel.scan.pt.x;
                  pt.y = sel.scan.pt.y;
                }
                pt_00.y = pt.y;
                pt_00.x = pt.x;
                CtrPointScan(pt_00,0);
                return;
              }
              sVar14 = 0x10;
              pcVar16 = PszFormatIds(idsCantChangeZoomFactorUntilGameOpen,(short *)0x0);
              AlertSz(pcVar16,sVar14);
              return;
            }
            if (wParam == 0xfa1) {
              if (hwndScanner == 0) {
                return;
              }
              gd._4_2_ = gd._4_2_ & 0xfffe | 1;
              RestoreSelection();
              RefitFrameChildren();
              gd._4_2_ = gd._4_2_ & 0xfffe;
              InvalidateRect(hwndScanner,(undefined2 *)0x0,1);
              UpdateWindow(hwndScanner);
              return;
            }
            if (((undefined *)wParam == (undefined *)&DAT_1120_1068) ||
               ((undefined *)wParam == (undefined *)&DAT_1120_1069)) {
              if (idPlayer == -1) {
                return;
              }
              pvVar28 = MakeProcInstance(FindDlg,hInst);
              DialogBox(0,(LPCSTR)CONCAT22((undefined *)&DAT_1120_106a,hwnd),
                        (HWND)((ulong)pvVar28 >> 0x10),(void *)pvVar28);
              FreeProcInstance(pvVar28);
              return;
            }
            if (((((((undefined *)wParam == (undefined *)&DAT_1120_10cc) ||
                   ((undefined *)wParam == (undefined *)&DAT_1120_10cd)) ||
                  ((undefined *)wParam == (undefined *)&DAT_1120_10ce)) ||
                 (((undefined *)wParam == (undefined *)&DAT_1120_10cf ||
                  ((undefined *)wParam == (undefined *)&DAT_1120_10d0)))) ||
                ((undefined *)wParam == (undefined *)&DAT_1120_10d1)) ||
               ((((undefined *)wParam == (undefined *)&DAT_1120_10d2 ||
                 ((undefined *)wParam == (undefined *)&DAT_1120_10d3)) ||
                ((undefined *)wParam == (undefined *)&DAT_1120_10d4)))) {
              if ((((uint)gd._0_2_ >> 0xb & 1) != 0) &&
                 (sVar14 = FAskKillTutor(), sVar14 == 0)) {
                return;
              }
              if (((char *)vrgszMRU == (char *)0x0) && (vrgszMRU._2_2_ == 0)) {
                return;
              }
              if (((char *)vrgszMRU)[(wParam + 0xef34) * 0x100] == '\0') {
                return;
              }
              pt_3.y = idPlayer;
              __fstrcpy((char *)CONCAT22(unaff_SS,acStack_124),
                                (char *)CONCAT22(vrgszMRU._2_2_,
                                                 (char *)vrgszMRU + (wParam + 0xef34) * 0x100
                                                ));
              pt_3.x = (short)_strrchr(acStack_124,0x2e);
              if (((char *)pt_3.x == (char *)0x0) ||
                 (sVar14 = __access(acStack_124,0), sVar14 == -1)) {
                _strcpy((char *)szWork,acStack_124);
                sVar14 = 0x10;
                pcVar16 = PszFormatIds(idsCantOpenFile,(short *)0x0);
                AlertSz(pcVar16,sVar14);
                return;
              }
              ini.wFlags = ini.wFlags & 0xfffeU | 1;
              DestroyCurGame();
              _strcpy((char *)szBase,acStack_124);
              sVar14 = FOpenGame(hwnd,0);
              if (sVar14 < 1) {
                return;
              }
              InitializeMenu(0);
              CreateChildWindows();
              if (uTimerId == 0) {
                PostMessage(hwnd,0x111,0xfa1,0);
              }
              if (((uint)game.wCrap >> 3 & 1) == 0) {
                return;
              }
              if (idPlayer != 0) {
                return;
              }
              StartTutor(0);
              return;
            }
            if (((wParam != 21000) && (wParam != 0x5209)) &&
               ((HBRUSH *)wParam != (HBRUSH *)&hbrCargo)) goto MDI_Default_4;
            goto LAB_1020_3f6e;
          }
        }
      }
      if (hwndScanner == 0) {
        sVar14 = 0x10;
        pcVar16 = PszFormatIds(idsGameCurrentlyLoaded,(short *)0x0);
        AlertSz(pcVar16,sVar14);
        return;
      }
      if (idPlayer == -1) {
        FWriteDataFile((char *)szBase,-1,0);
        return;
      }
      sVar14 = FNewTurnAvail(idPlayer);
      if (sVar14 == 0) {
        pt_3.y = (short)(wParam == 0xedb);
        gd._0_2_ = gd._0_2_ & 0xffef | pt_3.y << 4;
        FWriteLogFile((char *)szBase,idPlayer);
        FWriteHistFile(idPlayer);
        return;
      }
      goto MDI_LNewTurnAvail;
    }
    goto LAB_1020_3f6e;
  }
MDI_LWaitForTurn:
  if (((PLANET *)lpPlanets == (PLANET *)0x0) && (lpPlanets._2_2_ == (PLANET *)0x0)) {
    return;
  }
  if (idPlayer == -1) {
    return;
  }
  if (((uint)game.wCrap >> 2 & 1) != 0) {
    return;
  }
  sVar14 = FNewTurnAvail(idPlayer);
  if (sVar14 == 0) {
    gd._0_2_ = gd._0_2_ & 0xffef | 0x10;
    FWriteLogFile((char *)szBase,idPlayer);
    FWriteHistFile(idPlayer);
    HVar20 = hwndFrame;
    pcVar16 = PszGetCompressedString(idsWaitingNewTurn);
    SetWindowText(HVar20,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar16));
    ShowWindow(hwndFrame,2);
    uTimerId =
         SetTimer(0xe,10000,lpfnHostTimerProc._2_2_,
                  (fn_lpfnHostTimerProc *)lpfnHostTimerProc);
    uTimerType = 0xe;
    HostTimerProc(0,0,uTimerId,0);
    return;
  }
MDI_LNewTurnAvail:
  FWriteHistFile(idPlayer);
  if (game.fDirty == 0) {
    sVar14 = 0x40;
    pcVar16 = PszFormatIds(idsNewTurnAvailable,(short *)0x0);
    AlertSz(pcVar16,sVar14);
  }
  else {
    sVar14 = 0x31;
    pcVar16 = PszFormatIds(idsSorryTurnHasAlreadyGeneratedAnyChanges,(short *)0x0);
    pt_3.y = AlertSz(pcVar16,sVar14);
    if (pt_3.y == 2) {
      return;
    }
  }
  _WSPRINTF((LPSTR)CONCAT22(idPlayer + 1,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(MPCTD,unaff_SS),szExt);
  game.fDirty = 0;
  DestroyCurGame();
  sVar14 = FLoadGame((char *)szBase,szExt);
  if (sVar14 == 0) {
    sVar14 = 0x10;
    pcVar16 = PszFormatIds(idsUnableOpenNewTurnFile,(short *)0x0);
    AlertSz(pcVar16,sVar14);
  }
  else {
    CreateChildWindows();
    SendMessage(hwndFrame,0x111,0xfa1,0);
  }
  return;
}



// ======================================================================
// Function: InitializeMenu
// Address: 1020:5376
// Segment: MEMORY_MDI
// ======================================================================


void InitializeMenu(HMENU hmenu)

{
  ushort uVar1;
  UINT UVar2;
  HMENU HVar3;
  short sVar4;
  HMENU hmenuSub;
  short i;
  short cMenu;
  
  if (hmenu == 0) {
    hmenu = GetMenu(hwndFrame);
  }
  uVar1 = GetASubMenu(hwndFrame,0);
  for (i = (short)&DAT_1120_10cc; i < 0x10d5; i = i + 1) {
    DeleteMenu(uVar1,i,0);
  }
  i = 0;
  while ((i < 9 && (((char *)vrgszMRU)[i * 0x100] != '\0'))) {
    szWork[0] = '&';
    szWork[1] = (char)i + '1';
    szWork[2] = ' ';
    __fstrcpy(szWork + 3,
                      (char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU + i * 0x100));
    InsertMenu(uVar1,i + 9,0x400,(UINT)((undefined *)&DAT_1120_10cc + i),szWork);
    i = i + 1;
  }
  if ((szBase[0] == '\0') || (((uint)game.wCrap >> 2 & 1) != 0)) {
    UVar2 = 3;
  }
  else {
    UVar2 = 0;
  }
  EnableMenuItem(hmenu,0x6a,UVar2);
  if (szBase[0] == '\0') {
    UVar2 = 3;
  }
  else {
    UVar2 = 0;
  }
  EnableMenuItem(hmenu,0x69,UVar2);
  if ((szBase[0] == '\0') ||
     ((((uint)game.wCrap >> 2 & 1) != 0 &&
      ((lSaltCur._2_2_ < 0 || ((lSaltCur._2_2_ < 1 && ((int)lSaltCur == 0))))))
     )) {
    UVar2 = 3;
  }
  else {
    UVar2 = 0;
  }
  EnableMenuItem(hmenu,0x10e,UVar2);
  if ((szBase[0] == '\0') || (((uint)game.wCrap >> 2 & 1) != 0)) {
    UVar2 = 3;
  }
  else {
    UVar2 = 0;
  }
  EnableMenuItem(hmenu,0x7de,UVar2);
  if ((szBase[0] == '\0') || (((uint)game.wCrap >> 2 & 1) != 0)) {
    UVar2 = 3;
  }
  else {
    UVar2 = 0;
  }
  EnableMenuItem(hmenu,0xedb,UVar2);
  uVar1 = GetASubMenu(hwndFrame,1);
  if (gd.wFlags < 0) {
    UVar2 = 8;
  }
  else {
    UVar2 = 0;
  }
  CheckMenuItem(uVar1,0xb3,UVar2);
  if ((grbitScan & 0x2000) == 0) {
    UVar2 = 0;
  }
  else {
    UVar2 = 8;
  }
  CheckMenuItem(uVar1,0x98d,UVar2);
  if (hwndScanner == 0) {
    HVar3 = GetMenu(hwndFrame);
    EnableMenuItem(HVar3,1,0x403);
  }
  else {
    HVar3 = GetMenu(hwndFrame);
    EnableMenuItem(HVar3,1,0x400);
    uVar1 = GetASubMenu(hwndFrame,1);
    HVar3 = GetSubMenu(uVar1,3);
    CheckMenuItem(HVar3,iScanZoom + 4,0x408);
    sVar4 = GetMenuItemCount(HVar3);
    for (i = 0; i < sVar4; i = i + 1) {
      EnableMenuItem(HVar3,i,0x400);
    }
    uVar1 = GetASubMenu(hwndFrame,1);
    HVar3 = GetSubMenu(uVar1,4);
    CheckMenuItem(HVar3,iWindowLayout,0x408);
  }
  DrawMenuBar(hwndFrame);
  return;
}



// ======================================================================
// Function: EnsureAis
// Address: 1020:56bc
// Segment: MEMORY_MDI
// ======================================================================


void EnsureAis(void)

{
  bool bVar1;
  short sVar2;
  uint uVar3;
  uint uVar4;
  short sVar5;
  MDPLR rgmdplr [16];
  short iPlayer;
  short fSubmitSav;
  short fWorkDone;
  short fOpened;
  short fErrSav;
  short fHostSav;
  
  uVar3 = (uint)gd._0_2_ >> 4;
  bVar1 = false;
  if (((uint)gd._0_2_ >> 10 & 1) == 0) {
    uVar4 = (uint)gd._0_2_ >> 3;
    if (((uint)gd._0_2_ >> 3 & 1) == 0) {
      DestroyCurGame();
      FLoadGame((char *)szBase,(char *)0x3f0);
    }
    sVar2 = fFileErrSilent;
    for (iPlayer = 0; iPlayer < game.cPlayer; iPlayer = iPlayer + 1) {
      (rgmdplr + iPlayer)->wFlags = *(short *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0);
    }
    gd._0_2_ = gd._0_2_ & 0xffef | 0x10;
    fFileErrSilent = 1;
    for (iPlayer = 0; iPlayer < game.cPlayer; iPlayer = iPlayer + 1) {
      sVar5 = MulDiv(0x154,iPlayer + 1,game.cPlayer);
      UpdateProgressGauge(sVar5);
      if (((uint)(rgmdplr + iPlayer)->wFlags >> 9 & 1) != 0) {
        bVar1 = true;
        gd._0_2_ = gd._0_2_ & 0xfff5 | 10;
        sVar5 = FOpenFile(dtLog,iPlayer,0x20);
        gd._0_2_ = gd._0_2_ & 0xfff5 | (uVar4 & 1) << 3;
        if (sVar5 == 0) {
          DoAiTurn(iPlayer,(rgmdplr + iPlayer)->wFlags);
        }
        else {
          StreamClose();
        }
      }
    }
    gd._0_2_ = gd._0_2_ & 0xffef | (uVar3 & 1) << 4;
    if (bVar1) {
      DestroyCurGame();
      FLoadGame((char *)szBase,(char *)0x3f4);
    }
    gd._0_2_ = gd._0_2_ & 0xfbff | 0x400;
    fFileErrSilent = sVar2;
  }
  return;
}



// ======================================================================
// Function: GetASubMenu
// Address: 1020:589a
// Segment: MEMORY_MDI
// ======================================================================


ushort GetASubMenu(HWND hwnd,short iMenu)

{
  BOOL BVar1;
  int iVar2;
  HMENU HVar3;
  HMENU hmenu;
  short fChildMenu;
  
  if ((hwndActive == 0) || (BVar1 = IsZoomed(hwndActive), BVar1 == 0)) {
    iVar2 = 0;
  }
  else {
    iVar2 = 1;
  }
  HVar3 = GetMenu(hwnd);
  HVar3 = GetSubMenu(HVar3,iMenu + iVar2);
  return HVar3;
}



// ======================================================================
// Function: FOpenGame
// Address: 1020:58f4
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Variable defined which should be unmapped: ofn */
/* WARNING: Removing unreachable block (ram,0x10205d80) */

short FOpenGame(HWND hwnd,short fRaceOnly)

{
  char *pcVar1;
  StringId ids;
  int iVar2;
  short sVar3;
  uint uVar4;
  ushort uVar5;
  short grobjIni;
  short fRet;
  char szFilter [256];
  char szFileTitle [256];
  char *pch;
  char szFile [256];
  ushort i;
  OFN ofn;
  
  if ((ini.wFlags & 1U) == 0) {
    szFile[0] = '\0';
    if (fRaceOnly == 0) {
      ids = idsStarsGameFilesMHstRStars;
    }
    else {
      ids = idsStarsGameFilesRFiles;
    }
    CchGetString(ids,szFilter);
    for (i = 0; szFilter[i] != '\0'; i = i + 1) {
      if (szFilter[i] == '|') {
        szFilter[i] = '\0';
      }
    }
    _memset(&ofn,0,0x48);
    ofn.lStructSize._0_2_ = 0x48;
    ofn.lStructSize._2_2_ = 0;
    ofn.hwndOwner = hwnd;
    ofn.lpstrFilter._0_2_ = szFilter;
    ofn.nFilterIndex._0_2_ = 1;
    ofn.nFilterIndex._2_2_ = 0;
    ofn.lpstrFile._0_2_ = szFile;
    ofn.nMaxFile._0_2_ = 0x100;
    ofn.nMaxFile._2_2_ = 0;
    ofn.lpstrFileTitle._0_2_ = szFileTitle;
    ofn.nMaxFileTitle._0_2_ = 0x100;
    ofn.nMaxFileTitle._2_2_ = 0;
    ofn.lpstrInitialDir._0_2_ = (char *)szDirName;
    ofn.lpstrInitialDir._2_2_ = (undefined1 *)&DAT_1120_1120;
    ofn.Flags._0_2_ = (undefined *)&DAT_1120_1804;
    ofn.Flags._2_2_ = 0;
    iVar2 = GetOpenFileName(0x1118,&ofn);
    if (iVar2 == 0) {
      return 0;
    }
  }
  else {
    _strcpy(szFile,(char *)szBase);
    pcVar1 = _strrchr((char *)szBase,0x5c);
    *pcVar1 = '\0';
    pch = _strrchr(szFile,0x2e);
    if (pch == (char *)0x0) {
      SetSzWorkFromDt(dtHost,-1);
      _strcpy(szFile,(char *)szWork);
      pch = _strrchr(szFile,0x2e);
    }
    ofn.nFileExtension = (short)(pch + (1 - (int)szFile));
    ofn.nFileOffset = 0;
    fFileErrSilent = 1;
  }
  szDirName[0] = '\0';
  fRet = FWasRaceFile(szFile + ofn.nFileOffset,(uint)(fRaceOnly == 0));
  if (fRaceOnly == 0) {
    if (fRet == 0) {
      szFile[ofn.nFileExtension + -1] = '\0';
      DestroyCurGame();
      _strcpy((char *)szBase,szFile);
      sVar3 = FLoadGame(szFile,szFile + ofn.nFileExtension);
      if (sVar3 == 0) {
        if ((ini.wFlags & 1U) != 0) {
          ini.wFlags = 0;
          fFileErrSilent = 0;
        }
        fRet = 0;
      }
      else {
        if ((ini.wFlags & 1U) != 0) {
          fFileErrSilent = 0;
          ini.wFlags = ini.wFlags & 0xfffe;
          pch = _strrchr(szFile,0x5c);
          if (pch != (char *)0x0) {
            uVar5 = (int)pch - (int)szFile;
            _strncpy((char *)szDirName,szFile,uVar5);
            *(undefined1 *)(uVar5 + 0x252) = 0;
          }
          if ((idPlayer == -1) && (((uint)ini.wFlags >> 3 & 1) == 0)) {
            gd._4_2_ = gd._4_2_ & 0xfffb | 4;
          }
          if ((((int)game.lid != (int)ini.lid) ||
              (game.lid._2_2_ != ini.lid._2_2_)) ||
             ((uint)ini.turn < (uint)game.turn)) {
            ini.wFlags = ini.wFlags & 0xffef;
          }
        }
        sel.grobjFull = grobjNone;
        sel.grobj = grobjNone;
        sel.iwpAct = -1;
        sel.id = -1;
        sel.scan.grobjFull = grobjNone;
        sel.scan.grobj = grobjNone;
        sel.scan.iwp = -1;
        sel.scan.ifl = -1;
        sel.scan.idpl = -1;
        fOrdersVis = 0;
        CreateChildWindows();
        if (idPlayer == -1) {
          if ((hwndTitle != 0) && (fFreeingTitle == 0)) {
            fFreeingTitle = 1;
            DestroyWindow(hwndTitle);
            hwndTitle = 0;
          }
          BringUpHostDlg();
          fRet = 0;
        }
        else {
          uVar4 = (uint)ini.wFlags >> 5;
          SendMessage(hwndFrame,0x111,0xfa1,0);
          if (((uVar4 & 0xf) == 0) || (((uint)ini.wFlags >> 5 & 0xf) != 0)) {
            ini.wFlags = ini.wFlags & 0xfe1f;
            if (cPlanet != 0) {
              FFindSomethingAndSelectIt();
            }
            fRet = 1;
          }
          else {
            fRet = 1;
          }
        }
      }
    }
    else {
      if ((((ini.wFlags & 1U) != 0) && ((int)vSerialNumber == 0)) &&
         (vSerialNumber._2_2_ == 0)) {
        fRet = -1;
      }
      fFileErrSilent = 0;
      ini.wFlags = ini.wFlags & 0xfffe;
      if (fRet == -1) {
        fRet = -1;
      }
      else {
        RaceCreationWizard(hwnd,0,0);
        fRet = 0;
      }
    }
  }
  else if (0 < fRet) {
    _strcpy((char *)&szRaceFile,szFile + ofn.nFileOffset);
  }
  return fRet;
}



// ======================================================================
// Function: FWasRaceFile
// Address: 1020:5da8
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Variable defined which should be unmapped: fRet */

short FWasRaceFile(char *szFile,short fChkPass)

{
  PLAYER *pPVar1;
  PLAYER *pPVar2;
  char cVar3;
  undefined2 uVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  ushort uVar7;
  short sVar8;
  char *sz;
  ushort uVar9;
  int iVar10;
  PLAYER *pPVar11;
  PLAYER *pPVar12;
  short sVar13;
  short fSav;
  short fRet;
  short env [9];
  short (*penvMemSav) [9];
  PLAYER plr;
  long lSaltSav;
  short idsError;
  
  sVar13 = fFileErrSilent;
  uVar4 = penvMem;
  idsError = -1;
  fRet = 0;
  fFileErrSilent = 1;
  penvMem = env;
  sVar8 = __setjmp(env);
  uVar7 = wVersFile;
  if (sVar8 == 0) {
    StreamOpen(szFile,0x20);
    ReadRt();
    if (((((uint)hdrCur.wFlags >> 10 == 8) && ((uint)rgbCur._8_2_ >> 0xc == 2))
        && (0x30 < ((uint)rgbCur._8_2_ >> 5 & 0x7f))) &&
       (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x54)) {
      uVar7._0_1_ = rgbCur[8];
      uVar7._1_1_ = rgbCur[9];
      wVersFile._0_1_ = rgbCur[8];
      wVersFile._1_1_ = rgbCur[9];
      if (((rgbCur._14_2_ & 0xff) == 5) &&
         (ReadRt(), uVar7 = wVersFile, (uint)hdrCur.wFlags >> 10 == 6)) {
        idsError = 3;
        ReadRtPlr(&plr,(byte *)rgbCur);
        ReadRt();
        uVar7 = wVersFile;
        if (((uint)hdrCur.wFlags >> 10 == 0) &&
           (uVar9 = IRaceChecksum(&plr), uVar6 = lSaltCur._2_2_,
           uVar5 = (int)lSaltCur, lSaltCur._0_2_ = uVar5,
           lSaltCur._2_2_ = uVar6, uVar7 = wVersFile, rgbCur._0_2_ == uVar9)
           ) {
          lSaltCur._0_2_ = (int)plr.lSalt;
          lSaltCur._2_2_ = plr.lSalt._2_2_;
          if ((fChkPass == 0) || (sVar8 = FCheckPassword(), sVar8 != 0)) {
            if (((int)plr.lSalt == 0) && (plr.lSalt._2_2_ == 0)) {
              szRacePass = 0;
              lSaltCur._0_2_ = uVar5;
              lSaltCur._2_2_ = uVar6;
            }
            else {
              lSaltCur._0_2_ = uVar5;
              lSaltCur._2_2_ = uVar6;
              _strcpy((char *)&szRacePass,(char *)szPassLast);
            }
            pPVar11 = &plr;
            pPVar12 = (PLAYER *)&vplr;
            for (iVar10 = 0x60; iVar10 != 0; iVar10 = iVar10 + -1) {
              pPVar2 = pPVar12;
              pPVar12 = (PLAYER *)&pPVar12->cPlanet;
              pPVar1 = pPVar11;
              pPVar11 = (PLAYER *)&pPVar11->cPlanet;
              cVar3 = pPVar1->cShDef;
              pPVar2->iPlayer = pPVar1->iPlayer;
              pPVar2->cShDef = cVar3;
            }
            _strcpy((char *)&szRaceFile,szFile);
            StreamClose();
            penvMem = (short *)uVar4;
            fFileErrSilent = sVar13;
            return 1;
          }
          fRet = -1;
          lSaltCur._0_2_ = uVar5;
          lSaltCur._2_2_ = uVar6;
          uVar7 = wVersFile;
        }
      }
    }
    else {
      idsError = 0xd;
      fRet = -1;
      uVar7 = wVersFile;
    }
  }
  wVersFile = uVar7;
  StreamClose();
  penvMem = (short *)uVar4;
  fFileErrSilent = sVar13;
  if ((sVar13 == 0) && (idsError != -1)) {
    _strcpy((char *)szWork,szFile);
    sVar13 = 0x10;
    sz = PszFormatIds(idsError,(short *)0x0);
    AlertSz(sz,sVar13);
  }
  return fRet;
}



// ======================================================================
// Function: BringUpHostDlg
// Address: 1020:5ffc
// Segment: MEMORY_MDI
// ======================================================================


void BringUpHostDlg(void)

{
  short sVar1;
  short sVar2;
  FARPROC pvVar3;
  short fRet;
  void *lpProc;
  POINT pt;
  
  if (((uint)gd._0_2_ >> 3 & 1) == 0) {
    if (((uint)gd.wFlags >> 5 & 1) == 0) {
      FMarkFile(dtHost,-1,1,1);
    }
    gd._0_2_ = gd._0_2_ & 0xfff7 | 8;
  }
  ShowWindow(hwndFrame,0);
  if (((uint)ini.wFlags >> 2 & 1) == 0) {
    while( true ) {
      pvVar3 = MakeProcInstance(HostModeDialog,hInst);
      sVar1 = DialogBox(0,(LPCSTR)CONCAT22(0x73,hwndFrame),(HWND)((ulong)pvVar3 >> 0x10),
                        (void *)pvVar3);
      FreeProcInstance(pvVar3);
      if (sVar1 == -1) break;
      if (sVar1 == 0) {
        if (((uint)gd.wFlags >> 5 & 1) == 0) {
          FMarkFile(dtHost,-1,1,0);
        }
        gd._0_2_ = gd._0_2_ & 0xfff7;
        DestroyCurGame();
        if (((uint)ini.wFlags >> 3 & 1) != 0) {
          return;
        }
        sVar1 = GetSystemMetrics(0);
        sVar2 = GetSystemMetrics(1);
        hwndTitle =
             CreateWindow(szTitle,(LPCSTR)0x112003f8,0x90000000,0,0,sVar1,sVar2,
                          hwndFrame,0,hInst,(void *)0x0);
        fFreeingTitle = 0;
        return;
      }
      while( true ) {
        if (((uint)gd.wFlags >> 10 & 1) != 0) {
          ShowProgressGauge();
        }
        EnsureAis();
        FGenerateTurn();
        if (iPassCnt == 0) break;
        iPassCnt = iPassCnt + -1;
        sVar1 = GetAsyncKeyState(0x10);
        if ((sVar1 < 0) || (sVar1 = GetAsyncKeyState(0x11), sVar1 < 0)) break;
      }
      iPassCnt = 0;
      HideProgressGauge();
    }
  }
  else {
    ini.wFlags = ini.wFlags & 0xfffb;
  }
  ShowWindow(hwndFrame,2);
  uTimerId =
       SetTimer(0xd,10000,lpfnHostTimerProc._2_2_,
                (fn_lpfnHostTimerProc *)lpfnHostTimerProc);
  uTimerType = 0xd;
  HostTimerProc(0,0,uTimerId,0);
  return;
}



// ======================================================================
// Function: DrawHostDialog2
// Address: 1020:6240
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10206505) */

void DrawHostDialog2(HWND hwnd,HDC hdcIn)

{
  short sVar1;
  char *pcVar2;
  int iVar3;
  short cLen;
  char *pcVar4;
  HWND HVar5;
  uint uVar6;
  int x_00;
  undefined2 unaff_SS;
  COLORREF CVar7;
  DWORD DVar8;
  ulong uVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  HDC HVar12;
  char szStat [30];
  short x;
  COLORREF crBackSav;
  RECT rcDiamond;
  short cch;
  short dday;
  ushort dmin;
  short i;
  short yCur;
  short bkMode;
  ushort dhour;
  HDC hdc;
  ulong dsec;
  
  if (hdcIn == 0) {
    hdc = GetDC(hwnd);
  }
  else {
    hdc = hdcIn;
  }
  sVar1 = SetBkMode(hdc,2);
  CVar7 = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  SelectObject(hdc,rghfontArial8[1]);
  HVar12 = hdc;
  pcVar2 = PszGetCompressedString(idsN16);
  DVar8 = GetTextExtent(HVar12,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar2),4);
  x_00 = dyArial8 + 10 + (int)DVar8;
  yCur = 0x30;
  SetRect((undefined2 *)CONCAT22(unaff_SS,&rcDiamond),6,0x30,dyArial8 + 7,
          dyArial8 + 0x31);
  for (i = 0; i < game.cPlayer; i = i + 1) {
    DrawDiamond(hdc,&rcDiamond,hbrBBlue);
    iVar3 = i + 1;
    pcVar2 = PszGetCompressedString(idsD2);
    cLen = _WSPRINTF((LPSTR)CONCAT22(iVar3,(char *)&DAT_1120_1120),
                     (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
    RightTextOut(hdc,x_00,yCur,(char *)szWork,cLen,0);
    if (((short *)rgOut)[i] < 1) {
      uVar6 = 0x7f00;
    }
    else {
      uVar6 = 0x7f;
    }
    SetTextColor(hdc,(ulong)uVar6);
    CchGetString(((short *)rgOut)[i] + idsTurned,szStat);
    if (((uint)gd.wFlags >> 6 & 1) == 0) {
      pcVar2 = PszPlayerName(i,1,1,1,0,(PLAYER *)0x0);
      pcVar4 = PszGetCompressedString(idsSS);
      cch = _WSPRINTF((LPSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar4,(char *)&DAT_1120_1120),(char *)szWork);
    }
    else {
      cch = _WSPRINTF((LPSTR)CONCAT22(szStat,(char *)&DAT_1120_1120),(LPCSTR)0x3ff1120,
                      (char *)szWork);
    }
    if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 4 & 1) != 0) {
      _strcat((char *)szWork,(char *)s___HACKER_1120_0403);
      cch = cch + 9;
    }
    TextOut(hdc,x_00 + 4,yCur,szWork,cch);
    SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
    OffsetRect((undefined2 *)CONCAT22(unaff_SS,&rcDiamond),0,dyArial8 + 4);
    yCur = yCur + dyArial8 + 4;
  }
  _WSPRINTF((LPSTR)CONCAT22(game.turn + 0x961,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
  HVar5 = GetDlgItem(hwnd,0x7e0);
  SetWindowText(HVar5,szWork);
  uVar11 = 0;
  uVar10 = 1000;
  DVar8 = GetTickCount();
  uVar9 = __aFuldiv(DVar8 - CONCAT22(ctickLast._2_2_,(undefined2)ctickLast),
                            CONCAT22(uVar11,uVar10));
  uVar6 = (uint)uVar9;
  if (((int)(uVar9 >> 0x10) == 0) && (uVar6 < 0x3c)) {
    pcVar2 = PszGetCompressedString(idsDSeconds);
    _WSPRINTF((LPSTR)CONCAT22(uVar6,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
  }
  else {
    uVar9 = __aFuldiv(uVar9,0x3c);
    uVar6 = (uint)uVar9;
    if (uVar6 < 0x3c) {
      pcVar2 = PszGetCompressedString(idsD02d);
      _WSPRINTF((LPSTR)CONCAT22(uVar6,(char *)&DAT_1120_1120),
                (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
    }
    else {
      uVar6 = uVar6 / 0x3c;
      if (uVar6 < 0x18) {
        pcVar2 = PszGetCompressedString(idsD02d02d);
        _WSPRINTF((LPSTR)CONCAT22(uVar6,(char *)&DAT_1120_1120),
                  (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
      }
      else {
        uVar6 = uVar6 / 0x18;
        pcVar2 = PszGetCompressedString(idsDDaysD02d02d);
        _WSPRINTF((LPSTR)CONCAT22(uVar6,(char *)&DAT_1120_1120),
                  (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
      }
    }
  }
  HVar5 = GetDlgItem(hwnd,0x7e1);
  SetWindowText(HVar5,szWork);
  SetBkMode(hdc,sVar1);
  SetBkColor(hdc,CVar7);
  if (hdcIn == 0) {
    ReleaseDC(hwnd,hdc);
  }
  return;
}



// ======================================================================
// Function: VerifyTurns
// Address: 1020:6686
// Segment: MEMORY_MDI
// ======================================================================


void VerifyTurns(void)

{
  int iVar1;
  short sVar2;
  short sVar3;
  ulong uVar4;
  short fOut;
  short cOut;
  short i;
  short cAi;
  short idCur;
  short idsError;
  
  sVar2 = idPlayer;
  lpcd = LpAlloc(12000,htMisc);
  lpxf = LpAlloc(25000,htMisc);
  vrgPlanResExtra = LpAlloc(game.cPlanMax << 1,htMisc);
  __fmemset(vrgPlanResExtra,0,game.cPlanMax << 1);
  vrgts = LpAlloc(game.cPlayer << 4,htMisc);
  uVar4 = CONCAT22(ctickLast._2_2_,(undefined2)ctickLast);
  cColDrop = 0;
  cXferFull = 0;
  imemMsgCur = 0;
  i = 0;
  do {
    ctickLast = uVar4;
    if (game.cPlayer <= i) {
      FreeLp(vrgPlanResExtra,htMisc);
      vrgPlanResExtra._0_2_ = (ushort *)0x0;
      vrgPlanResExtra._2_2_ = 0;
      FreeLp(vrgts,htMisc);
      vrgts._0_2_ = (TURNSERIAL *)0x0;
      vrgts._2_2_ = 0;
      FreeLp(lpcd,htMisc);
      lpcd._0_2_ = (COLDROP *)0x0;
      lpcd._2_2_ = 0;
      FreeLp(lpxf,htMisc);
      lpxf._0_2_ = (XFERFULL *)0x0;
      lpxf._2_2_ = 0;
      idPlayer = sVar2;
      return;
    }
    iVar1 = ((short *)rgOut)[i];
    idsError = 0;
    if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) {
      sVar3 = FCheckLogFile(i,&idsError);
      uVar4 = ctickLast;
      if (sVar3 != 0) goto LAB_1020_678e;
      if (idsError == 0) {
        if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0) {
          if (((uint)gd.wFlags >> 7 & 1) == 0) {
            ((short *)rgOut)[i] = 1;
            uVar4 = ctickLast;
          }
          else {
            ((short *)rgOut)[i] = 2;
            uVar4 = ctickLast;
          }
        }
        else {
          ((short *)rgOut)[i] = -1;
          uVar4 = ctickLast;
        }
      }
      else if (idsError == 0x1c) {
        ((short *)rgOut)[i] = 4;
        uVar4 = ctickLast;
      }
      else if (idsError == 0x1d) {
        ((short *)rgOut)[i] = 5;
        uVar4 = ctickLast;
      }
      else {
        ((short *)rgOut)[i] = 3;
        uVar4 = ctickLast;
      }
    }
    else {
LAB_1020_678e:
      ctickLast = uVar4;
      if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) {
        _WSPRINTF((LPSTR)0x56a21120,(LPCSTR)0x40d1120,(char *)szWork);
        idPlayer = i;
        sVar3 = FLoadLogFile((char *)szWork);
        if (sVar3 != 0) {
          sVar3 = FRunLogFile();
          if (sVar3 == 0) {
            ((short *)rgOut)[i] = 3;
            uVar4 = ctickLast;
            goto LAB_1020_68d6;
          }
        }
        ((short *)rgOut)[i] = 0;
        uVar4 = ctickLast;
      }
      else {
        ((short *)rgOut)[i] = 0;
        uVar4 = ctickLast;
      }
    }
LAB_1020_68d6:
    if ((uVar4 == 0) || (((short *)rgOut)[i] != iVar1)) {
      ctickLast = uVar4;
      uVar4 = GetTickCount();
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: CTurnsOutSafe
// Address: 1020:6996
// Segment: MEMORY_MDI
// ======================================================================


short CTurnsOutSafe(void)

{
  short sVar1;
  uint uVar2;
  uint uVar3;
  short sVar4;
  short cturn;
  short fGenSav;
  short fHostModeSav;
  short idPlayerSav;
  
  sVar1 = idPlayer;
  uVar2 = (uint)gd._0_2_ >> 3;
  uVar3 = (uint)gd._0_2_ >> 1;
  idPlayer = -1;
  gd._0_2_ = gd._0_2_ & 0xfff5 | 8;
  sVar4 = CFindTurnsOutstanding();
  uVar2 = gd._0_2_ & 0xfff5 | (uVar3 & 1) << 1 | (uVar2 & 1) << 3;
  gd.field0_0x0 = (char)uVar2;
  gd.field1_0x1 = (char)(uVar2 >> 8);
  idPlayer = sVar1;
  return sVar4;
}



// ======================================================================
// Function: CFindTurnsOutstanding
// Address: 1020:6a26
// Segment: MEMORY_MDI
// ======================================================================


short CFindTurnsOutstanding(void)

{
  int iVar1;
  short sVar2;
  uint uVar3;
  ulong uVar4;
  short fOut;
  short fSav;
  short cOut;
  short i;
  short cAi;
  short idsError;
  
  cOut = 0;
  cAi = 0;
  fFileErrSilent = 1;
  gd._0_2_ = gd._0_2_ & 0xfffd | 2;
  i = 0;
  uVar4 = ctickLast;
  do {
    ctickLast._2_2_ = (undefined2)(uVar4 >> 0x10);
    ctickLast._0_2_ = (undefined2)uVar4;
    if (game.cPlayer <= i) {
      uVar3 = gd._0_2_ & 0xfffd;
      gd.field0_0x0 = (char)uVar3;
      gd.field1_0x1 = (char)(uVar3 >> 8);
      gd.wFlags = gd.wFlags & 0xffefU | (uint)(cAi == game.cPlayer) << 4;
      fFileErrSilent = 0;
      return cOut;
    }
    iVar1 = ((short *)rgOut)[i];
    idsError = 0;
    if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) {
      ctickLast = uVar4;
      sVar2 = FCheckLogFile(i,&idsError);
      uVar4 = ctickLast;
      if (sVar2 != 0) goto LAB_1020_6aae;
      if (idsError == 0) {
        if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0) {
          if (((uint)gd.wFlags >> 7 & 1) == 0) {
            ((short *)rgOut)[i] = 1;
            cOut = cOut + 1;
            uVar4 = ctickLast;
          }
          else {
            ((short *)rgOut)[i] = 2;
            cOut = cOut + 1;
            uVar4 = ctickLast;
          }
        }
        else {
          ((short *)rgOut)[i] = -1;
          uVar4 = ctickLast;
        }
      }
      else {
        if (idsError == 0x1c) {
          ((short *)rgOut)[i] = 4;
          uVar4 = ctickLast;
        }
        else if (idsError == 0x1d) {
          ((short *)rgOut)[i] = 5;
          uVar4 = ctickLast;
        }
        else {
          ((short *)rgOut)[i] = 3;
          uVar4 = ctickLast;
        }
        cOut = cOut + 1;
      }
    }
    else {
LAB_1020_6aae:
      if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) != 0) {
        cAi = cAi + 1;
      }
      ctickLast = uVar4;
      ((short *)rgOut)[i] = 0;
      uVar4 = ctickLast;
    }
    if ((uVar4 == 0) || (((short *)rgOut)[i] != iVar1)) {
      ctickLast = uVar4;
      uVar4 = GetTickCount();
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: HostModeDialog
// Address: 1020:6c16
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short HostModeDialog(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  int iVar1;
  HMENU HVar2;
  uint uVar3;
  HWND HVar4;
  BOOL BVar5;
  char *pcVar6;
  short sVar7;
  undefined2 unaff_SS;
  FARPROC pvVar8;
  undefined *mbType;
  MSG msg;
  HMENU hmenuPopup;
  short iDiamond;
  short iSel;
  short iRet;
  short i;
  short tpm;
  int iStack_18;
  int iStack_16;
  HDC hdc;
  RECT rc;
  short fRet;
  void *lpProc;
  
  if (message == WM_DESTROY) {
    KillTimer(hwnd,uTimerId);
    uTimerId = 0;
    return 0;
  }
  if (message == WM_PAINT) {
    hdc = BeginPaint(hwnd,(short *)CONCAT22(unaff_SS,&msg.message));
    if (((int)ctickLast == 0) && (ctickLast._2_2_ == 0)) {
      CFindTurnsOutstanding();
    }
    if (((uint)gd.wFlags >> 5 & 1) == 0) {
      HVar4 = GetDlgItem(hwnd,0x408);
      if ((((uint)gd.wFlags >> 4 & 1) == 0) &&
         ((vtimer.fAutoGenWhenIn != 0 || (vtimer.mdForce != 0)))) {
        BVar5 = 1;
      }
      else {
        BVar5 = 0;
      }
      EnableWindow(HVar4,BVar5);
    }
    DrawHostDialog2(hwnd,hdc);
    EndPaint(hwnd,(short *)CONCAT22(unaff_SS,&msg.message));
    return 1;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    return hbrButtonFace;
  }
  if (message == WM_SETCURSOR) {
LAB_1020_6db6:
    GetCursorPos((int *)CONCAT22(unaff_SS,&iStack_18));
    ScreenToClient(hwnd,(int *)CONCAT22(unaff_SS,&iStack_18));
    if ((((5 < iStack_18) && (iStack_18 < dyArial8 + 7)) && (0x2f < iStack_16)) &&
       ((iVar1 = (iStack_16 + -0x30) / (dyArial8 + 4), iVar1 < game.cPlayer &&
        ((iStack_16 + -0x30) % (dyArial8 + 4) < dyArial8 + 1)))) {
      if (message == WM_SETCURSOR) {
        setcursor(hcurHand);
        return 1;
      }
      if ((*(uint *)((int)&rgplr[0].wMdPlr + iVar1 * 0xc0) >> 9 & 1) == 0) {
        iSel = 0;
      }
      else if (*(uint *)((int)&rgplr[0].wMdPlr + iVar1 * 0xc0) >> 0xd == 7) {
        iSel = 2;
      }
      else {
        iSel = 1;
      }
      HVar2 = CreatePopupMenu();
      iPopMenuSel = -1;
      for (i = 0; i < 3; i = i + 1) {
        CchGetString(i + idsHumanControlled,(char *)szWork);
        if (i == 1) {
          if (((*(uint *)((int)&rgplr[0].wMdPlr + iVar1 * 0xc0) >> 9 & 1) == 0) ||
             (*(uint *)((int)&rgplr[0].wMdPlr + iVar1 * 0xc0) >> 0xd == 7)) {
            hdc = 3;
          }
          else {
            hdc = 0;
          }
        }
        else if (((*(uint *)((int)&rgplr[0].wMdPlr + iVar1 * 0xc0) >> 9 & 1) == 0) ||
                (*(uint *)((int)&rgplr[0].wMdPlr + iVar1 * 0xc0) >> 0xd == 7)) {
          hdc = 0;
        }
        else {
          hdc = 3;
        }
        if (i == iSel) {
          uVar3 = 8;
        }
        else {
          uVar3 = 0;
        }
        AppendMenu(HVar2,uVar3 | hdc,i + 15000,szWork);
      }
      ClientToScreen(hwnd,(int *)CONCAT22(unaff_SS,&iStack_18));
      if (message == WM_LBUTTONDOWN) {
        uVar3 = 0;
      }
      else {
        uVar3 = 2;
      }
      TrackPopupMenu(HVar2,uVar3 | 4,iStack_18,iStack_16,0,hwnd,(undefined2 *)0x0);
      DestroyMenu(HVar2);
      iRet = -1;
      BVar5 = PeekMessage((undefined2 *)CONCAT22(unaff_SS,&msg),hwnd,0x111,0x111,2);
      if (((BVar5 != 0) && (14999 < (uint)msg.wParam)) && ((uint)msg.wParam < 0x3afc)) {
        iRet = msg.wParam + -15000;
      }
      if ((iRet != -1) && (iSel != iRet)) {
        *(uint *)((int)&rgplr[0].wMdPlr + iVar1 * 0xc0) =
             *(uint *)((int)&rgplr[0].wMdPlr + iVar1 * 0xc0) & 0xfdff |
             (uint)(0 < iRet) << 9;
        if (iRet == 2) {
          *(uint *)((int)&rgplr[0].wMdPlr + iVar1 * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + iVar1 * 0xc0) & 0x1fff | 0xe000;
        }
        uVar3 = *(uint *)((int)&rgplr[0].lSalt + 2 + iVar1 * 0xc0);
        *(uint *)((int)&rgplr[0].lSalt + iVar1 * 0xc0) =
             ~*(uint *)((int)&rgplr[0].lSalt + iVar1 * 0xc0);
        *(uint *)((int)&rgplr[0].lSalt + 2 + iVar1 * 0xc0) = ~uVar3;
        FMarkFile(dtTurn,iVar1,8,(uint)(iRet != 0));
        FMarkFile(dtHost,iVar1,8,(uint)(iRet != 0));
        gd._0_2_ = gd._0_2_ & 0xfbff;
        fProcessingTimer = 1;
        CFindTurnsOutstanding();
        HVar4 = GetDlgItem(hwnd,0x408);
        if ((((uint)gd.wFlags >> 4 & 1) == 0) &&
           ((vtimer.fAutoGenWhenIn != 0 || (vtimer.mdForce != 0)))) {
          BVar5 = 1;
        }
        else {
          BVar5 = 0;
        }
        EnableWindow(HVar4,BVar5);
        DrawHostDialog2(hwnd,0);
        fProcessingTimer = 0;
      }
      return 0;
    }
    return 0;
  }
  if (message == WM_INITDIALOG) {
    StickyDlgPos(hwnd,(POINT *)&ptStickyHostModeDlg,1);
    HVar4 = GetDlgItem(hwnd,0x409);
    SetWindowText(HVar4,game.szName);
    HVar4 = GetDlgItem(hwnd,0x40a);
    SetWindowText(HVar4,szBase);
    HVar4 = GetDlgItem(hwnd,0x408);
    if ((((uint)gd.wFlags >> 5 & 1) == 0) &&
       ((vtimer.fAutoGenWhenIn != 0 || (vtimer.mdForce != 0)))) {
      BVar5 = 1;
    }
    else {
      BVar5 = 0;
    }
    EnableWindow(HVar4,BVar5);
    HVar4 = GetDlgItem(hwnd,0x407);
    EnableWindow(HVar4,(uint)(((uint)gd.wFlags >> 5 & 1) == 0));
    HVar4 = GetDlgItem(hwnd,0x7df);
    EnableWindow(HVar4,(uint)(((uint)gd.wFlags >> 5 & 1) == 0));
    uTimerId = SetTimer(0xd,10000,0,0);
  }
  else {
    if (message == WM_COMMAND) {
      if (((wParam == 0x407) || (wParam == 2)) || (wParam == 0x408)) {
        if (wParam == 0x407) {
          sVar7 = GetAsyncKeyState(0x10);
          if (sVar7 < 0) {
            sVar7 = GetAsyncKeyState(0x11);
            if (sVar7 < 0) {
              iPassCnt = 999;
            }
            else {
              iPassCnt = 9;
            }
          }
          else {
            sVar7 = GetAsyncKeyState(0x11);
            if (sVar7 < 0) {
              iPassCnt = 99;
            }
            else {
              iPassCnt = 0;
            }
          }
          if (iPassCnt == 0) {
            sVar7 = CFindTurnsOutstanding();
            if (sVar7 != 0) {
              mbType = (undefined *)&DAT_1120_1024;
              pcVar6 = PszFormatIds(idsSureWishGenerateOptionDoesGuaranteePlayers,(short *)0x0)
              ;
              sVar7 = AlertSz(pcVar6,(short)mbType);
              if (sVar7 != 6) {
                return 1;
              }
            }
          }
          else {
            iVar1 = iPassCnt + 1;
            pcVar6 = PszGetCompressedString(idsSureWantForceGenerateDTurnsRow);
            _WSPRINTF((LPSTR)CONCAT22(iVar1,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar6,(char *)&DAT_1120_1120),(char *)szWork);
            HVar4 = GetFocus();
            sVar7 = MessageBox(HVar4,szWork,(LPCSTR)0x1120041a,0x2034);
            if (sVar7 != 6) {
              iPassCnt = 0;
              return 1;
            }
          }
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyHostModeDlg,0);
        if (wParam == 2) {
          sVar7 = 0;
        }
        else if (wParam == 0x408) {
          sVar7 = -1;
        }
        else {
          sVar7 = 1;
        }
        EndDialog(hwnd,sVar7);
        if (wParam == 0x408) {
          EnsureAis();
        }
        else if ((wParam == 2) && (((uint)gd._4_2_ >> 2 & 1) != 0)) {
          PostQuitMessage(vretExitValue);
        }
        return 1;
      }
      if (wParam == 0x7df) {
        sVar7 = FCheckPassword();
        if (sVar7 == 0) {
          return 0;
        }
        pvVar8 = MakeProcInstance(NewPasswordDlg,hInst);
        sVar7 = DialogBox(0,(LPCSTR)CONCAT22(0x8d,hwnd),(HWND)((ulong)pvVar8 >> 0x10),(void *)pvVar8
                         );
        FreeProcInstance(pvVar8);
        SetFocus(hwnd);
        return sVar7;
      }
      if (wParam != 0x405) {
        if (wParam != 0x76) {
          return 0;
        }
        WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x440);
        return 1;
      }
      pvVar8 = MakeProcInstance(HostOptionsDialog,hInst);
      sVar7 = DialogBox(0,(LPCSTR)CONCAT22(0x402,hwnd),(HWND)((ulong)pvVar8 >> 0x10),(void *)pvVar8)
      ;
      FreeProcInstance(pvVar8);
      SetFocus(hwnd);
      if (sVar7 == 0) {
        return 0;
      }
      if (((uint)gd.wFlags >> 5 & 1) == 0) {
        HVar4 = GetDlgItem(hwnd,0x408);
        if ((((uint)gd.wFlags >> 4 & 1) == 0) &&
           ((vtimer.fAutoGenWhenIn != 0 || (vtimer.mdForce != 0)))) {
          BVar5 = 1;
        }
        else {
          BVar5 = 0;
        }
        EnableWindow(HVar4,BVar5);
        return sVar7;
      }
      return sVar7;
    }
    if (message != WM_TIMER) {
      if ((message != WM_LBUTTONDOWN) && (message != WM_RBUTTONDOWN)) {
        return 0;
      }
      goto LAB_1020_6db6;
    }
  }
  if (fProcessingTimer == 0) {
    fProcessingTimer = 1;
    CFindTurnsOutstanding();
    DrawHostDialog2(hwnd,0);
    fProcessingTimer = 0;
  }
  return (uint)(message != WM_TIMER);
}



// ======================================================================
// Function: HostOptionsDialog
// Address: 1020:75ce
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short HostOptionsDialog(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  HDC hdc_00;
  short sVar1;
  undefined2 unaff_SS;
  PAINTSTRUCT ps;
  HDC hdc;
  RECT rc;
  
  if (message == WM_DESTROY) {
LAB_1020_76f3:
    sVar1 = 0;
  }
  else {
    if (message == WM_PAINT) {
      hdc_00 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
      DrawHostOptions(hwnd,hdc_00,-1);
      EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
      return 1;
    }
    if (message != WM_ERASEBKGND) {
      if (message == WM_CTLCOLOR) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
      if (message != WM_INITDIALOG) {
        if (message == WM_COMMAND) {
          if ((wParam == 2) || (wParam == 1)) {
            EndDialog(hwnd,(uint)(wParam == 1));
            return 1;
          }
          if (wParam == 0x76) {
            WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x440);
            return 1;
          }
        }
        goto LAB_1020_76f3;
      }
    }
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar1 = 1;
  }
  return sVar1;
}



// ======================================================================
// Function: DrawHostOptions
// Address: 1020:7706
// Segment: MEMORY_MDI
// ======================================================================


void DrawHostOptions(HWND hwnd,HDC hdc,short iDraw)

{
  return;
}



// ======================================================================
// Function: HostTimerProc
// Address: 1020:7716
// Segment: MEMORY_MDI
// ======================================================================


void HostTimerProc(HWND hwnd,ushort msg,ushort idTimer,ulong dwTime)

{
  short sVar1;
  short sVar2;
  char *pcVar3;
  HWND HVar4;
  HWND HVar5;
  char *unaff_SS;
  short sVar6;
  short idCur;
  short fSav;
  short cOut;
  char szExt [4];
  HWND hwndT;
  
  sVar1 = fFileErrSilent;
  if (fProcessingTimer == 0) {
    fProcessingTimer = 1;
    if (uTimerType == 0xe) {
      sVar2 = FNewTurnAvail(idPlayer);
      sVar6 = idPlayer;
      if (sVar2 != 0) {
        KillTimer(hwnd,uTimerId);
        _WSPRINTF((LPSTR)CONCAT22(idPlayer + 1,(char *)&DAT_1120_1120),
                  (LPCSTR)CONCAT22(MPCTD,unaff_SS),szExt);
        DestroyCurGame();
        sVar2 = FLoadGame((char *)szBase,szExt);
        if (sVar2 != 0) {
          idPlayer = sVar6;
          CreateChildWindows();
          uTimerId =
               SetTimer(0xf,1000,lpfnHostTimerProc._2_2_,
                        (fn_lpfnHostTimerProc *)lpfnHostTimerProc);
          uTimerType = 0xf;
          FlashWindow(hwndFrame,1);
          HVar4 = hwndFrame;
          pcVar3 = PszGetCompressedString(idsNewTurnAvailable2);
          SetWindowText(HVar4,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar3));
          MessageBeep(0x30);
          cOut = 1;
          goto MDI_RedrawText_2;
        }
        sVar6 = 0x10;
        pcVar3 = PszFormatIds(idsUnableOpenNewTurnFile,(short *)0x0);
        AlertSz(pcVar3,sVar6);
      }
    }
    else if (uTimerType == 0xf) {
      FlashWindow(hwndFrame,1);
    }
    else {
      while (cOut = CFindTurnsOutstanding(), ((uint)gd.wFlags >> 4 & 1) == 0) {
        sVar6 = cOut;
        pcVar3 = PszGetCompressedString(idsHostModeDPlayer);
        _WSPRINTF((LPSTR)CONCAT22(sVar6,(char *)&DAT_1120_1120),
                  (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
        if (cOut != 1) {
          _strcat((char *)szWork,(char *)0x421);
        }
        pcVar3 = PszGetCompressedString(idsOut);
        _strcat((char *)szWork,pcVar3);
        SetWindowText(hwndFrame,szWork);
MDI_RedrawText_2:
        HVar4 = GetWindow(hwndFrame,3);
        HVar5 = GetWindow(HVar4,4);
        if (HVar5 == hwndFrame) {
          InvalidateRect(HVar4,(undefined2 *)0x0,1);
        }
        if (cOut != 0) goto MDI_Done_4;
        if (((uint)gd.wFlags >> 10 & 1) != 0) {
          ShowProgressGauge();
        }
        EnsureAis();
        FGenerateTurn();
        HideProgressGauge();
        if (((uint)ini.wFlags >> 3 & 1) != 0) {
          PostQuitMessage(vretExitValue);
          goto MDI_Done_4;
        }
        EnsureAis();
      }
      sVar6 = 0x10;
      pcVar3 = PszFormatIds(idsAutoGenerateDisabledBecauseHumanPlayersDead,(short *)0x0);
      AlertSz(pcVar3,sVar6);
      HVar4 = GetDlgItem(hwnd,0x408);
      EnableWindow(HVar4,0);
    }
MDI_Done_4:
    fProcessingTimer = 0;
  }
  fFileErrSilent = sVar1;
  return;
}



// ======================================================================
// Function: GetWindowRc
// Address: 1020:79ac
// Segment: MEMORY_MDI
// ======================================================================


void GetWindowRc(HWND hwnd,RECT *prc)

{
  undefined2 unaff_SS;
  WINDOWPLACEMENT wndpl;
  
  wndpl.length = 0x16;
  GetWindowPlacement(hwnd,(undefined2 *)CONCAT22(unaff_SS,&wndpl));
  prc->left = wndpl.rcNormalPosition.left;
  prc->top = wndpl.rcNormalPosition.top;
  prc->right = wndpl.rcNormalPosition.right;
  prc->bottom = wndpl.rcNormalPosition.bottom;
  prc->right = prc->right - prc->left;
  prc->bottom = prc->bottom - prc->top;
  return;
}



// ======================================================================
// Function: SetWindowIniString
// Address: 1020:79f6
// Segment: MEMORY_MDI
// ======================================================================


void SetWindowIniString(char *sz,HWND hwnd)

{
  BOOL BVar1;
  int iVar2;
  char *pcVar3;
  RECT rc;
  char ch;
  
  BVar1 = IsZoomed(hwnd);
  if (BVar1 == 0) {
    BVar1 = IsIconic(hwnd);
    if (BVar1 == 0) {
      ch = 'R';
    }
    else {
      ch = 'I';
    }
  }
  else {
    ch = 'M';
  }
  GetWindowRc(hwnd,&rc);
  iVar2 = (int)ch;
  pcVar3 = PszGetCompressedString(idsC04d04d04d04d);
  _WSPRINTF((LPSTR)CONCAT22(iVar2,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),(char *)szWork);
  return;
}



// ======================================================================
// Function: WriteIniSettings
// Address: 1020:7a76
// Segment: MEMORY_MDI
// ======================================================================


void WriteIniSettings(void)

{
  char cVar1;
  char *pcVar2;
  int iVar3;
  ushort uVar4;
  char *unaff_SS;
  undefined2 uVar5;
  char ch;
  ushort iCol;
  char szSection [16];
  char *psz;
  char szIniFile [16];
  char szEntry [16];
  short iPass;
  short i;
  TILE *rgtile;
  char szPd [3];
  short ctile;
  
  szPd[0] = '%';
  szPd[1] = 'd';
  szPd[2] = '\0';
  CchGetString(idsWindows,szSection);
  CchGetString(idsStarsIni,szIniFile);
  CchGetString(idsGlobalsettings,szEntry);
  FormatSerialAndEnv(CONCAT22(vSerialNumber._2_2_,(undefined2)vSerialNumber),
                     (byte *)vrgbMachineConfig,(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsResolution,szEntry);
  i = (short)(vcScreenColors < 5);
  if ((uint)gd._0_2_ >> 0xe == 0) {
    i = i | 2;
  }
  _WSPRINTF((LPSTR)CONCAT22(i,unaff_SS),(LPCSTR)CONCAT22(szPd,(char *)&DAT_1120_1120),
            (char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsMain,szEntry);
  SetWindowIniString((char *)szWork,hwndFrame);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsReportfleetwin,szEntry);
  uVar5 = 0x4d;
  pcVar2 = PszGetCompressedString(idsC04d04d04d04d);
  _WSPRINTF((LPSTR)CONCAT22(uVar5,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsReportefleetwin,szEntry);
  uVar5 = 0x4d;
  pcVar2 = PszGetCompressedString(idsC04d04d04d04d);
  _WSPRINTF((LPSTR)CONCAT22(uVar5,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsReportbtlwin,szEntry);
  uVar5 = 0x4d;
  pcVar2 = PszGetCompressedString(idsC04d04d04d04d);
  _WSPRINTF((LPSTR)CONCAT22(uVar5,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsReportplanwin,szEntry);
  uVar5 = 0x4d;
  pcVar2 = PszGetCompressedString(idsC04d04d04d04d);
  _WSPRINTF((LPSTR)CONCAT22(uVar5,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsLayout,szEntry);
  _WSPRINTF((LPSTR)CONCAT22(iWindowLayout,unaff_SS),
            (LPCSTR)CONCAT22(szPd,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsStyle1width,szEntry);
  _WSPRINTF((LPSTR)CONCAT22(vfs.dxPlanWant,unaff_SS),
            (LPCSTR)CONCAT22(szPd,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsStyle1height,szEntry);
  _WSPRINTF((LPSTR)CONCAT22(vfs.dyMsgWant,unaff_SS),
            (LPCSTR)CONCAT22(szPd,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsStyle1height2,szEntry);
  _WSPRINTF((LPSTR)CONCAT22(vfs.dyMinWant,unaff_SS),
            (LPCSTR)CONCAT22(szPd,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsStyle2width,szEntry);
  _WSPRINTF((LPSTR)CONCAT22(vfs.dx2PlanWant,unaff_SS),
            (LPCSTR)CONCAT22(szPd,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsStyle2height,szEntry);
  _WSPRINTF((LPSTR)CONCAT22(vfs.dy2MsgWant,unaff_SS),
            (LPCSTR)CONCAT22(szPd,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsStyle2height2,szEntry);
  _WSPRINTF((LPSTR)CONCAT22(vfs.dy2MinWant,unaff_SS),
            (LPCSTR)CONCAT22(szPd,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsToolbar,szEntry);
  _WSPRINTF((LPSTR)CONCAT22((uint)gd.wFlags >> 0xf,unaff_SS),
            (LPCSTR)CONCAT22(szPd,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  iPass = 2;
  rgtile = (TILE *)(TILE *)&rgtilePlanet;
  ctile = 6;
  CchGetString(idsPlanettiles,szEntry);
  while (iPass != 0) {
    psz = (char *)szWork;
    iCol = 0;
    for (i = 0; i < ctile; i = i + 1) {
      while (iCol < (rgtile[i].wFlags & 7U)) {
        iCol = iCol + 1;
        *psz = '*';
        psz = psz + 1;
      }
      if (((uint)rgtile[i].wFlags >> 7 & 1) == 0) {
        cVar1 = 'a';
      }
      else {
        cVar1 = 'A';
      }
      *psz = cVar1;
      *psz = *psz + ((byte)((uint)rgtile[i].wFlags >> 3) & 0xf);
      psz = psz + 1;
    }
    *psz = '\0';
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsShiptiles,szEntry);
    rgtile = (TILE *)(TILE *)&rgtileShip;
    ctile = 7;
    iPass = iPass + -1;
  }
  CchGetString(idsSelection,szEntry);
  if (sel.grobj == grobjNone) {
    ch = 'N';
  }
  else if (sel.grobj == grobjPlanet) {
    ch = 'P';
  }
  else if (sel.grobj == grobjFleet) {
    ch = 'S';
  }
  else if (sel.grobj == grobjOther) {
    ch = 'E';
  }
  iVar3 = (int)ch;
  pcVar2 = PszGetCompressedString(idsCCD);
  _WSPRINTF((LPSTR)CONCAT22(iVar3,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsMessage,szEntry);
  _WSPRINTF((LPSTR)CONCAT22(iMsgCur,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsGameid,szEntry);
  _WSPRINTF((LPSTR)CONCAT22((undefined2)game.lid,(char *)&DAT_1120_1120),(LPCSTR)0x4231120,
            (char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsScanzoom,szEntry);
  szWork[0] = (char)iScanZoom + '5';
  szWork[1] = '\0';
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  if (((uint)gd._4_2_ >> 6 & 1) != 0) {
    __itoa(grbitScan,(char *)szWork,10);
    CchGetString(idsScanmodev25,szEntry);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    __itoa(grbitScanShip,(char *)szWork,10);
    CchGetString(idsScanfilterv25,szEntry);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    __itoa(grbitScanEShip,(char *)szWork,10);
    CchGetString(idsScanefilterv25,szEntry);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    __itoa(grbitScanMines,(char *)szWork,10);
    CchGetString(idsScanmines,szEntry);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    __itoa(vpctRadarView,(char *)szWork,10);
    CchGetString(idsScanradar,szEntry);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  }
  __itoa(cMinGrafMax,(char *)szWork,10);
  CchGetString(idsMineralscale,szEntry);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  if (idPlayer != -1) {
    CchGetString(idsFiles,szSection);
    CchGetString(idsWait2,szEntry);
    szWork[0] = (uTimerId != 0) + '0';
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    if (((uint)gd._4_2_ >> 8 & 1) != 0) {
      __itoa(game.turn,(char *)szWork,10);
      CchGetString(idsTurn,szEntry);
      WritePrivateProfileString
                ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
                 szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
      gd._4_2_ = gd._4_2_ & 0xfeff;
    }
    CchGetString(idsFile1,szEntry);
    _WSPRINTF((LPSTR)0x56a21120,(LPCSTR)0x4271120,(char *)szWork);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  }
  CchGetString(idsMisc,szSection);
  if (((uint)gd._4_2_ >> 7 & 1) != 0) {
    CchGetString(idsReportplanfld,szEntry);
    _WSPRINTF((LPSTR)CONCAT22((undefined2)vrptPlanet.grbitVisible,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportplansort,szEntry);
    i = vrptPlanet.icolSort;
    if (vrptPlanet.fAscending != 0) {
      i = vrptPlanet.icolSort | 0x100;
    }
    _WSPRINTF((LPSTR)CONCAT22(i,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportfleetfld,szEntry);
    _WSPRINTF((LPSTR)CONCAT22((undefined2)vrptFleet.grbitVisible,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportfleetsort,szEntry);
    i = vrptFleet.icolSort;
    if (vrptFleet.fAscending != 0) {
      i = vrptFleet.icolSort | 0x100;
    }
    _WSPRINTF((LPSTR)CONCAT22(i,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportefleetfld,szEntry);
    _WSPRINTF((LPSTR)CONCAT22((undefined2)vrptEFleet.grbitVisible,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportefltsort,szEntry);
    i = vrptEFleet.icolSort;
    if (vrptEFleet.fAscending != 0) {
      i = vrptEFleet.icolSort | 0x100;
    }
    _WSPRINTF((LPSTR)CONCAT22(i,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportbtlfld,szEntry);
    _WSPRINTF((LPSTR)CONCAT22((undefined2)vrptBattle.grbitVisible,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportbtlsort,szEntry);
    i = vrptBattle.icolSort;
    if (vrptBattle.fAscending != 0) {
      i = vrptBattle.icolSort | 0x100;
    }
    _WSPRINTF((LPSTR)CONCAT22(i,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportdefgraph,szEntry);
    _WSPRINTF((LPSTR)((ulong)CONCAT22(gd.wFlags,(undefined1 *)&DAT_1120_1120) & 0xfffff),
              (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  }
  CchGetString(idsHistoryinfo,szEntry);
  _WSPRINTF((LPSTR)CONCAT22(uDateInstalled,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsVcrspeed,szEntry);
  _WSPRINTF((LPSTR)CONCAT22(viSpeedVCR,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(PCTD,(char *)&DAT_1120_1120),(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  if (((uint)gd._4_2_ >> 4 & 1) != 0) {
    CchGetString(idsZiporders,szSection);
    for (i = 0; i < 4; i = i + 1) {
      _strcpy(szEntry,szSection);
      uVar4 = _strlen(szEntry);
      szEntry[uVar4] = (char)i + '1';
      szEntry[uVar4 + 1] = '\0';
      if (*(char *)((int)&vrgZip[0].fValid + i * 0x18) == '\0') {
        szWork[0] = '\0';
      }
      else {
        psz = (char *)szWork;
        for (iPass = 0; iPass < 5; iPass = iPass + 1) {
          *psz = (byte)((uint)(((ZIPORDER *)vrgZip)[i].txp.rgia + iPass)->wFlags >> 0xc) +
                 0x61;
          psz[1] = ((byte)(((ZIPORDER *)vrgZip)[i].txp.rgia + iPass)->wFlags & 0xf) + 0x61
          ;
          pcVar2 = psz + 3;
          psz[2] = ((byte)(((((ZIPORDER *)vrgZip)[i].txp.rgia + iPass)->wFlags & 0xfffU)
                          >> 4) & 0xf) + 0x61;
          psz = psz + 4;
          *pcVar2 = ((byte)((uint)(((ZIPORDER *)vrgZip)[i].txp.rgia + iPass)->wFlags >> 8)
                    & 0xf) + 0x61;
        }
        _strcpy(psz,(char *)((int)vrgZip[0].szName + i * 0x18));
      }
      WritePrivateProfileString
                ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
                 szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    }
  }
  if (((uint)gd._4_2_ >> 5 & 1) != 0) {
    for (i = 0; i < 5; i = i + 1) {
      CchGetString(idsZiporders,szSection);
      _strcpy(szEntry,szSection);
      uVar4 = _strlen(szEntry);
      szEntry[uVar4] = 'P';
      szEntry[uVar4 + 1] = (char)i + '1';
      szEntry[uVar4 + 2] = '\0';
      if (*(char *)((int)&vrgZipProd[0].fValid + i * 0x28) == '\0') {
        szWork[0] = '\0';
      }
      else {
        szWork[0] = *(char *)((int)&vrgZipProd[0].field2_0xe + i * 0x28) + 'a';
        szWork[1] = *(char *)((int)&vrgZipProd[0].cpq + i * 0x28) + 'a';
        psz = (char *)szWork + 2;
        for (iPass = 0; iPass < (int)(uint)*(byte *)((int)&vrgZipProd[0].cpq + i * 0x28);
            iPass = iPass + 1) {
          *psz = ((byte)*(undefined2 *)(i * 0x28 + 0x2306 + iPass * 2) & 0xf) + 0x61;
          psz[1] = ((byte)(*(uint *)(i * 0x28 + 0x2306 + iPass * 2) >> 4) & 0xf) + 0x61;
          pcVar2 = psz + 3;
          psz[2] = ((byte)((uint)*(undefined2 *)(i * 0x28 + 0x2306 + iPass * 2) >> 8) & 0xf) + 0x61;
          psz = psz + 4;
          *pcVar2 = (byte)((uint)*(undefined2 *)(i * 0x28 + 0x2306 + iPass * 2) >> 0xc) + 0x61;
        }
        _strcpy(psz,((ZIPPRODQ *)vrgZipProd)[i].szName);
      }
      WritePrivateProfileString
                ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
                 szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    }
  }
  return;
}



// ======================================================================
// Function: RefitFrameChildren
// Address: 1020:8c88
// Segment: MEMORY_MDI
// ======================================================================


void RefitFrameChildren(void)

{
  BOOL BVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  int iVar5;
  ushort uVar6;
  HMENU HVar7;
  UINT UVar8;
  short dyTot;
  short yScanner_2;
  short dyMin;
  short dyMsgMin;
  short dyMinMin;
  short i;
  HMENU hmenu;
  short dyMsg;
  
  if ((hwndFrame != 0) && (BVar1 = IsIconic(hwndFrame), BVar1 == 0)) {
    if ((iWindowLayout == 0) ||
       ((iWindowLayout != 1 && (iWindowLayout != 2)))) {
      if (vfs.dx - vfs.dxPlanWant < 100) {
        vfs.xTop = vfs.dx + -100;
      }
      else {
        vfs.xTop = vfs.dxPlanWant;
      }
      if (vfs.xTop < 199) {
        vfs.xTop = 0xc6;
      }
      iVar2 = (dyArial8 * 0xd >> 1) + 10;
      iVar3 = dyArial8 * 0xd + -0x24;
      if (vfs.dyMsgWant <= iVar2) {
        vfs.dyMsgWant = iVar2;
      }
      dyMin = vfs.dyMinWant;
      if (vfs.dyMinWant <= iVar3) {
        dyMin = iVar3;
      }
      vfs.dyMinWant = dyMin;
      dyMsg = vfs.dyMsgWant;
      if (vfs.dy - (vfs.dyMsgWant + dyMin + 0x10) < 0x32) {
        iVar4 = vfs.dy + -0x42;
        iVar5 = vfs.dyMsgWant + dyMin;
        dyMsg = MulDiv(iVar4,vfs.dyMsgWant,iVar5);
        dyMin = MulDiv(iVar4,dyMin,iVar5);
        if (dyMsg < iVar2) {
          dyMin = dyMin - (iVar2 - dyMsg);
          dyMsg = iVar2;
        }
        else if (dyMin < iVar3) {
          iVar2 = iVar3 - dyMin;
          dyMin = iVar3;
          dyMsg = dyMsg - iVar2;
        }
      }
      vfs.y1 = ((vfs.dy - dyMin) - dyMsg) + -0x10;
      vfs.y2 = vfs.y1 + dyMsg + 8;
      if (hwndScanner != 0) {
        if (gd.wFlags < 0) {
          MoveWindow(hwndTb,vfs.xTop + 8,0,
                     (vfs.dx - vfs.xTop) + -8,0x24,1);
          yScanner_2 = 0x24;
        }
        else {
          MoveWindow(hwndTb,0,-100,0x32,0x32,1);
          yScanner_2 = 0;
        }
        MoveWindow(hwndScanner,vfs.xTop + 8,yScanner_2,
                   (vfs.dx - vfs.xTop) + -8,vfs.dy - yScanner_2,1);
        MoveWindow(hwndPlanet,0,0,vfs.xTop,vfs.y1,1);
        MoveWindow(hwndMessage,0,vfs.y1 + 8,vfs.xTop,dyMsg,1);
        MoveWindow(hwndMine,0,vfs.y2 + 8,vfs.xTop,dyMin,1);
      }
    }
    else {
      if (vfs.dx - vfs.dx2PlanWant < 200) {
        vfs.xTop = vfs.dx + -200;
      }
      else {
        vfs.xTop = vfs.dx2PlanWant;
      }
      if (vfs.xTop < 199) {
        vfs.xTop = 0xc6;
      }
      iVar2 = (dyArial8 * 0xd >> 1) + 10;
      iVar3 = dyArial8 * 0xd + -0x24;
      if (vfs.dy2MsgWant <= iVar2) {
        vfs.dy2MsgWant = iVar2;
      }
      if (vfs.dy2MinWant <= iVar3) {
        vfs.dy2MinWant = iVar3;
      }
      dyMsg = vfs.dy2MsgWant;
      if (vfs.dy - (vfs.dy2MsgWant + 8) < 100) {
        dyMsg = vfs.dy + -0x6c;
      }
      dyMin = vfs.dy2MinWant;
      if (vfs.dy - (vfs.dy2MinWant + 8) < 100) {
        dyMin = vfs.dy + -0x6c;
      }
      vfs.y1 = (vfs.dy - dyMsg) + -8;
      vfs.y2 = (vfs.dy - dyMin) + -8;
      if (hwndScanner != 0) {
        if (gd.wFlags < 0) {
          MoveWindow(hwndTb,0,0,vfs.dx,0x24,1);
          yScanner_2 = 0x24;
        }
        else {
          MoveWindow(hwndTb,0,-100,0x32,0x32,1);
          yScanner_2 = 0;
        }
        MoveWindow(hwndScanner,vfs.xTop + 8,yScanner_2,
                   (vfs.dx - vfs.xTop) + -8,vfs.y2 - yScanner_2,1);
        MoveWindow(hwndPlanet,0,yScanner_2,vfs.xTop,vfs.y1 - yScanner_2,1
                  );
        MoveWindow(hwndMessage,0,vfs.y1 + 8,vfs.xTop,dyMsg,1);
        MoveWindow(hwndMine,vfs.xTop + 8,vfs.y2 + 8,
                   (vfs.dx - vfs.xTop) + -8,dyMin,1);
      }
    }
    uVar6 = GetASubMenu(hwndFrame,1);
    HVar7 = GetSubMenu(uVar6,4);
    for (i = 0x82; i < 0x85; i = i + 1) {
      if (i + -0x82 == iWindowLayout) {
        UVar8 = 8;
      }
      else {
        UVar8 = 0;
      }
      CheckMenuItem(HVar7,i,UVar8);
    }
  }
  return;
}



// ======================================================================
// Function: TitleWndProc
// Address: 1020:9126
// Segment: MEMORY_MDI
// ======================================================================


long TitleWndProc(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  HWND HVar1;
  short sVar2;
  HANDLE HVar3;
  UINT UVar4;
  BOOL BVar5;
  int *piVar6;
  HDC HVar7;
  HGLOBAL hdib;
  HFONT HVar8;
  HGDIOBJ HVar9;
  ushort uVar10;
  int iVar11;
  undefined2 unaff_SS;
  LRESULT LVar12;
  short dy;
  short x1;
  short dxSrc;
  short dySrc;
  undefined2 uVar13;
  undefined2 uVar14;
  RECT rcT_2;
  short dx_2;
  HFONT hfontSav;
  HFONT hfont;
  LOGFONT *plf;
  RECT rcT;
  HBRUSH hbrSav;
  RECT rcWnd;
  PAINTSTRUCT ps_2;
  RECT rc;
  short i;
  HDC hdc;
  
  if (msg == 1) {
    if (((7 < vcScreenColors) &&
        (vhdibTitle = HdibLoadBigResource(0x1c1), vhpalSplash == 0)) &&
       (vhdibTitle != 0)) {
      vhpalSplash = HpalFromDib(vhdibTitle);
    }
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    ps_2.rgbReserved._10_2_ = rc.right >> 3;
    if ((int)ps_2.rgbReserved._10_2_ < 0x78) {
      ps_2.rgbReserved._10_2_ = 0x78;
    }
    if (rc.bottom < 0x28a) {
      ps_2.rgbReserved._10_2_ = ps_2.rgbReserved._10_2_ + (int)ps_2.rgbReserved._10_2_ / 6;
    }
    iVar11 = rc.right + ps_2.rgbReserved._10_2_ * -4;
    ps_2.rgbReserved._12_2_ = iVar11 >> 2;
    ps_2.rgbReserved._8_2_ = iVar11 >> 3;
    if (rc.bottom < 0x1f5) {
      ps_2.rgbReserved._14_2_ = dyArial8 << 1;
    }
    else {
      ps_2.rgbReserved._14_2_ = (dyArial8 * 5) / 2;
    }
    for (i = 0; i < 4; i = i + 1) {
      ps_2.rgbReserved._6_2_ = PszGetCompressedString(i + idsNewGame);
      HVar1 = CreateWindow(s_BUTTON_1120_043a,
                           (LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,ps_2.rgbReserved._6_2_),
                           0x50000000,ps_2.rgbReserved._8_2_,
                           (rc.bottom - ps_2.rgbReserved._14_2_) - (dyArial8 * 5) / 2,
                           ps_2.rgbReserved._10_2_,ps_2.rgbReserved._14_2_,hwnd,i,hInst,
                           (void *)0x0);
      *(HWND *)(i * 2 + 0x432) = HVar1;
      if ((i == 2) &&
         ((szBase[0] == '\0' ||
          (sVar2 = __access((char *)szBase,0), sVar2 == -1)))) {
        EnableWindow(rghwndBtnSplash[2],0);
      }
      if (rc.bottom < 500) {
        SendMessage(*(HWND *)(i * 2 + 0x432),0x30,rghfontArial8[1],0);
      }
      ps_2.rgbReserved._8_2_ =
           ps_2.rgbReserved._8_2_ + ps_2.rgbReserved._10_2_ + ps_2.rgbReserved._12_2_;
    }
  }
  else {
    if (msg == 2) {
      if (vhdibTitle != 0) {
        GlobalUnlock(vhdibTitle);
        FreeResource(vhdibTitle);
        vhdibTitle = 0;
      }
      if (fFreeingTitle == 0) {
        if (((uint)gd.wFlags >> 6 & 1) == 0) {
          WriteIniSettings();
          PostQuitMessage(vretExitValue);
        }
        else {
          ExitWindows((long)vretExitValue,0);
        }
      }
MDI_Default_3:
      LVar12 = DefWindowProc(hwnd,msg,wParam,lParam);
      return LVar12;
    }
    if (msg == 0xf) {
      BVar5 = IsIconic(hwnd);
      if (BVar5 == 0) {
        piVar6 = (int *)LocalAlloc(0x40,0x32);
        HVar7 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps_2));
        SelectObject(HVar7,hbrButtonFace);
        GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rcWnd));
        if ((vcScreenColors < 8) ||
           (SetTextColor(HVar7,0x2ff7fff), vhdibTitle == 0)) {
          rc.left = 0;
          rc.right = rcWnd.right;
          rc.bottom = 0;
          DrawABunchOfStars(HVar7,&rcWnd);
          *piVar6 = -rcWnd.bottom / 3;
          _strcpy((char *)(piVar6 + 9),*(char (*) [32])(rgszArial + 3));
          HVar8 = CreateFontIndirect((int *)CONCAT22((undefined1 *)&DAT_1120_1120,piVar6));
          SetTextColor(HVar7,0x9b009b);
          if (HVar8 != 0) {
            HVar9 = SelectObject(HVar7,HVar8);
            SetBkMode(HVar7,1);
            rcT_2.left = rcWnd.left;
            rcT_2.top = rcWnd.top;
            rcT_2.right = rcWnd.right;
            rcT_2.bottom = (rcWnd.bottom * 3) / 4;
            RcCtrTextOut(HVar7,&rcT_2,(char *)0x441,6);
            SelectObject(HVar7,HVar9);
            DeleteObject(HVar8);
          }
        }
        else {
          SelectPalette(HVar7,vhpalSplash,0);
          RealizePalette(HVar7);
          uVar14 = 600;
          uVar13 = 800;
          dySrc = 0;
          dxSrc = 0;
          x1 = 1;
          uVar10 = vhdibTitle;
          hdib = GetSystemMetrics(1);
          dy = 0;
          sVar2 = GetSystemMetrics(0);
          DibBlt(HVar7,0,0,sVar2,dy,hdib,x1,uVar10,dxSrc,dySrc,CONCAT22(uVar14,uVar13));
        }
        SelectObject(HVar7,rghfontArial10[1]);
        SetBkMode(HVar7,1);
        SzVersion();
        GetWindowRect(rghwndBtnSplash[0],(undefined2 *)CONCAT22(unaff_SS,&rcT));
        rcWnd.top = rcT.top - (dyArial8 * 9) / 2;
        rcWnd.bottom = (dyArial8 * 3) / 2 + rcWnd.top;
        uVar10 = _strlen((char *)szWork);
        RcCtrTextOut(HVar7,&rcWnd,(char *)szWork,uVar10);
        EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps_2));
        LocalFree((HLOCAL)piVar6);
      }
      else {
        HVar7 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps_2));
        DrawIcon(HVar7,2,2,hiconStars);
        EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps_2));
      }
    }
    else if (msg == 0x111) {
      if (wParam == 0) {
        NewGameWizard(hwnd,0);
        if ((((PLANET *)lpPlanets == (PLANET *)0x0) && (lpPlanets._2_2_ == 0)) &&
           (((int)game.lid == 0 && (game.lid._2_2_ == 0)))) {
          SetFocus(hwnd);
        }
        else {
          if (fFreeingTitle == 0) {
            fFreeingTitle = 1;
            DestroyWindow(hwndTitle);
            hwndTitle = 0;
          }
          ShowWindow(hwndFrame,5);
        }
      }
      else {
        if (wParam != 1) {
          if (wParam != 2) {
            if (wParam != 3) {
              return 0;
            }
            if (((uint)gd.wFlags >> 6 & 1) == 0) {
              WriteIniSettings();
              PostQuitMessage(vretExitValue);
              return 0;
            }
            ExitWindows((long)vretExitValue,0);
            return 0;
          }
          ini.wFlags = ini.wFlags & 0xfffeU | 1;
        }
        sVar2 = FOpenGame(hwnd,0);
        if (sVar2 < 1) {
          SetFocus(hwnd);
        }
        else {
          if (fFreeingTitle == 0) {
            fFreeingTitle = 1;
            DestroyWindow(hwndTitle);
            hwndTitle = 0;
          }
          if (idPlayer != -1) {
            ShowWindow(hwndFrame,5);
          }
          InitializeMenu(0);
          PostMessage(hwndFrame,0x111,0xfa1,0);
          if ((((uint)game.wCrap >> 3 & 1) != 0) && (idPlayer == 0)) {
            StartTutor(0);
          }
        }
        ini.wFlags = ini.wFlags & 0xfffe;
      }
    }
    else {
      if (msg != 0x30f) {
        if (msg != 0x311) goto MDI_Default_3;
        if (wParam == hwnd) {
          return 0;
        }
      }
      if (7 < vcScreenColors) {
        HVar7 = GetDC(hwnd);
        HVar3 = SelectPalette(HVar7,vhpalSplash,0);
        UVar4 = RealizePalette(HVar7);
        SelectPalette(HVar7,HVar3,0);
        ReleaseDC(hwnd,HVar7);
        if (UVar4 != 0) {
          InvalidateRect(hwnd,(undefined2 *)0x0,1);
          return 1;
        }
        return 0;
      }
    }
  }
  return 0;
}



