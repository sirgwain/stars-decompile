// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
//

// ======================================================================
// Function: InitMDIApp
// Address: 1020:0000
// Segment: MEMORY_MDI
// ======================================================================

short InitMDIApp(void)

{
    ATOM       AVar1;
    short      sVar2;
    undefined2 unaff_SS;
    WNDCLASS   wc;

    /* Segment:    5
       Offset:     00013700
       Length:     983f
       Min Alloc:  9840
       Flags:      1d50
           Code
           Discardable
           Moveable
           Preload
           Impure (Non-shareable)
        */
    wc.style = 0xb;
    wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)((int)rgszArial[1] + 0x10);
    wc.lpfnWndProc._2_2_ = 0x1020;
    wc.cbClsExtra = 0;
    wc.cbWndExtra = 0;
    wc.hInstance = hInst;
    wc.hIcon = 0;
    wc.hCursor = LoadCursor(0, (LPCSTR)0x7f00);
    wc.hbrBackground = 0xd;
    wc.lpszMenuName._0_2_ = (char *)s_StarsMenu_1120_0364;
    wc.lpszMenuName._2_2_ = 0x1120;
    wc.lpszClassName._0_2_ = (char *)szFrame;
    wc.lpszClassName._2_2_ = 0x1120;
    AVar1 = RegisterClass(&wc);
    if (AVar1 == 0) {
        sVar2 = 0;
    } else {
        wc.style = 0x20b;
        wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)((int)rgplr[3].szNames + 0x10);
        wc.lpfnWndProc._2_2_ = 0x1030;
        wc.hIcon = 0;
        wc.lpszMenuName._0_2_ = (char *)0x0;
        wc.lpszMenuName._2_2_ = 0;
        wc.hbrBackground = GetStockObject(1);
        wc.lpszClassName._0_2_ = (char *)szMessage;
        wc.lpszClassName._2_2_ = 0x1120;
        AVar1 = RegisterClass(&wc);
        if (AVar1 == 0) {
            sVar2 = 0;
        } else {
            wc.style = 0x20b;
            wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)(rgcrPlrHistory + 1);
            wc.lpfnWndProc._2_2_ = 0x1058;
            wc.hbrBackground = GetStockObject(4);
            wc.lpszClassName._0_2_ = (char *)szScan;
            wc.lpszClassName._2_2_ = 0x1120;
            AVar1 = RegisterClass(&wc);
            if (AVar1 == 0) {
                sVar2 = 0;
            } else {
                wc.style = 0x20b;
                wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)0x0;
                wc.lpfnWndProc._2_2_ = 0x1028;
                wc.hbrBackground = GetStockObject(1);
                wc.lpszClassName._0_2_ = (char *)szMine;
                wc.lpszClassName._2_2_ = 0x1120;
                AVar1 = RegisterClass(&wc);
                if (AVar1 == 0) {
                    sVar2 = 0;
                } else {
                    wc.style = 0x208;
                    wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)&hbrDesktop;
                    wc.lpfnWndProc._2_2_ = 0x1068;
                    wc.hbrBackground = GetStockObject(1);
                    wc.lpszClassName._0_2_ = (char *)szTb;
                    wc.lpszClassName._2_2_ = 0x1120;
                    AVar1 = RegisterClass(&wc);
                    if (AVar1 == 0) {
                        sVar2 = 0;
                    } else {
                        wc.style = 0x200;
                        wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)0x0;
                        wc.lpfnWndProc._2_2_ = 0x1048;
                        wc.hbrBackground = GetStockObject(1);
                        wc.hIcon = 0;
                        wc.lpszClassName._0_2_ = (char *)szPlanet;
                        wc.lpszClassName._2_2_ = 0x1120;
                        AVar1 = RegisterClass(&wc);
                        if (AVar1 == 0) {
                            sVar2 = 0;
                        } else {
                            wc.style = 0xa00;
                            wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)0x0;
                            wc.lpfnWndProc._2_2_ = 0x10c0;
                            wc.hbrBackground = GetStockObject(0);
                            wc.hIcon = 0;
                            wc.lpszClassName._0_2_ = (char *)szPopup;
                            wc.lpszClassName._2_2_ = 0x1120;
                            AVar1 = RegisterClass(&wc);
                            if (AVar1 == 0) {
                                sVar2 = 0;
                            } else {
                                wc.style = 0xa00;
                                wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)0x19e4;
                                wc.lpfnWndProc._2_2_ = 0x1068;
                                wc.hbrBackground = GetStockObject(0);
                                wc.hIcon = 0;
                                wc.lpszClassName._0_2_ = (char *)szTooltip;
                                wc.lpszClassName._2_2_ = 0x1120;
                                AVar1 = RegisterClass(&wc);
                                if (AVar1 == 0) {
                                    sVar2 = 0;
                                } else {
                                    wc.style = 0x200;
                                    wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)(rgidPlan + 0x84);
                                    wc.lpfnWndProc._2_2_ = 0x10d8;
                                    wc.hbrBackground = GetStockObject(1);
                                    wc.hIcon = 0;
                                    wc.lpszClassName._0_2_ = (char *)szBrowser;
                                    wc.lpszClassName._2_2_ = 0x1120;
                                    AVar1 = RegisterClass(&wc);
                                    if (AVar1 == 0) {
                                        sVar2 = 0;
                                    } else {
                                        wc.style = 0;
                                        wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)0x9126;
                                        wc.lpfnWndProc._2_2_ = 0x1020;
                                        wc.cbClsExtra = 0;
                                        wc.cbWndExtra = 0;
                                        wc.hInstance = hInst;
                                        wc.hIcon = 0;
                                        wc.hCursor = LoadCursor(0, (LPCSTR)0x7f00);
                                        wc.hbrBackground = GetStockObject(4);
                                        wc.lpszMenuName._0_2_ = (char *)0x0;
                                        wc.lpszMenuName._2_2_ = 0;
                                        wc.lpszClassName._0_2_ = (char *)szTitle;
                                        wc.lpszClassName._2_2_ = 0x1120;
                                        AVar1 = RegisterClass(&wc);
                                        if (AVar1 == 0) {
                                            sVar2 = 0;
                                        } else {
                                            wc.style = 0xb;
                                            wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)&hbrWindow;
                                            wc.lpfnWndProc._2_2_ = 0x1108;
                                            wc.cbClsExtra = 0;
                                            wc.cbWndExtra = 0;
                                            wc.hInstance = hInst;
                                            wc.hIcon = 0;
                                            wc.hCursor = LoadCursor(0, (LPCSTR)0x7f00);
                                            wc.hbrBackground = GetStockObject(1);
                                            wc.lpszMenuName._0_2_ = (char *)0x0;
                                            wc.lpszMenuName._2_2_ = 0;
                                            wc.lpszClassName._0_2_ = (char *)szReport;
                                            wc.lpszClassName._2_2_ = 0x1120;
                                            AVar1 = RegisterClass(&wc);
                                            if (AVar1 == 0) {
                                                sVar2 = 0;
                                            } else {
                                                sVar2 = 1;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    return sVar2;
}

// ======================================================================
// Function: CreateChildWindows
// Address: 1020:038c
// Segment: MEMORY_MDI
// ======================================================================

void CreateChildWindows(void)

{
    ushort      uVar1;
    undefined1 *puVar2;
    undefined1 *puVar3;
    undefined1 *puVar4;
    undefined2 *puVar5;
    undefined2  uVar6;
    undefined2  unaff_SS;
    char       *pcVar7;
    char        szGame[15];
    char       *psz;
    POINT       pt;
    char        szData[100];

    if (idPlayer == -1) {
        CchGetString(idsStarsSHostMode, (char *)szWork);
        _wsprintf(szData, szWork);
    } else {
        uVar1 = _strlen((char *)szBase);
        for (psz = (char *)((int)rghbrMinSum[3] + 3 + uVar1); (((char *)szBase < psz && (psz[-1] != '\\')) && (psz[-1] != ':')); psz = psz + -1) {
        }
        szGame[8] = '\0';
        _strncpy(szGame, psz, 8);
        __strlwr(szGame);
        uVar6 = 0x1120;
        pcVar7 = (char *)s__m_d_1120_036e;
        uVar1 = _strlen(szGame);
        _wsprintf(szGame + uVar1, (char *)CONCAT22(uVar6, pcVar7));
        pcVar7 = PszPlayerName(idPlayer, 0, 1, 0, 0, (PLAYER *)0x0);
        _wsprintf(szData, s_Stars______s_____s_____s_1120_0373, 0x90, 0x1120, pcVar7, 0x1120);
    }
    SetWindowText(hwndFrame, szData);
    if (idPlayer != -1) {
        if (hwndScanner == 0) {
            uVar6 = 0x14f8;
            hwndScanner = CreateWindow(szScan, (LPCSTR)0x0, 0x50000000, -200, -200, 10, 10, hwndFrame, 0, hInst, (void *)0x0);
            puVar2 = &stack0xff7c;
        } else {
            InvalidateRect(hwndScanner, (RECT *)0x0, 1);
            yScanTop = 1000;
            xScanTop = 1000;
            uVar6 = 0x1058;
            SetScanScrollBars(hwndScanner);
            puVar2 = &stack0xff7a;
        }
        if (hwndMine == 0) {
            *(undefined2 *)(puVar2 + -2) = 0x1120;
            *(undefined2 *)(puVar2 + -4) = 0x1ec;
            *(undefined2 *)(puVar2 + -6) = 0;
            *(undefined2 *)(puVar2 + -8) = 0;
            *(undefined2 *)(puVar2 + -10) = 0x5000;
            *(undefined2 *)(puVar2 + -0xc) = 0;
            *(undefined2 *)(puVar2 + -0xe) = 0xfe0c;
            *(undefined2 *)(puVar2 + -0x10) = 0xfe0c;
            *(short *)(puVar2 + -0x12) = pt.x;
            *(short *)(puVar2 + -0x14) = pt.y;
            *(HWND *)(puVar2 + -0x16) = hwndFrame;
            *(undefined2 *)(puVar2 + -0x18) = 0;
            *(HINSTANCE *)(puVar2 + -0x1a) = hInst;
            *(undefined2 *)(puVar2 + -0x1c) = 0;
            *(undefined2 *)(puVar2 + -0x1e) = 0;
            *(undefined2 *)(puVar2 + -0x20) = uVar6;
            *(undefined2 *)(puVar2 + -0x22) = 0x58f;
            hwndMine = CreateWindow(*(LPCSTR *)(puVar2 + -4), *(LPCSTR *)(puVar2 + -8), *(DWORD *)(puVar2 + -0xc), *(short *)(puVar2 + -0xe),
                                    *(short *)(puVar2 + -0x10), *(short *)(puVar2 + -0x12), *(short *)(puVar2 + -0x14), *(HWND *)(puVar2 + -0x16),
                                    *(HMENU *)(puVar2 + -0x18), *(HINSTANCE *)(puVar2 + -0x1a), *(void **)(puVar2 + -0x1e));
            puVar3 = puVar2 + 4;
        } else {
            *(HWND *)(puVar2 + -2) = hwndMine;
            *(undefined2 *)(puVar2 + -4) = 0;
            *(undefined2 *)(puVar2 + -6) = 0;
            *(undefined2 *)(puVar2 + -8) = 1;
            *(undefined2 *)(puVar2 + -10) = uVar6;
            *(undefined2 *)(puVar2 + -0xc) = 0x5aa;
            InvalidateRect(*(HWND *)(puVar2 + -2), *(RECT **)(puVar2 + -6), *(BOOL *)(puVar2 + -8));
            puVar3 = puVar2 + 2;
        }
        if (hwndPlanet == 0) {
            *(undefined2 *)(puVar3 + -2) = 0x1120;
            *(undefined2 *)(puVar3 + -4) = 0x1f6;
            *(undefined2 *)(puVar3 + -6) = 0;
            *(undefined2 *)(puVar3 + -8) = 0;
            *(undefined2 *)(puVar3 + -10) = 0x5000;
            *(undefined2 *)(puVar3 + -0xc) = 0;
            *(undefined2 *)(puVar3 + -0xe) = 0xfe0c;
            *(undefined2 *)(puVar3 + -0x10) = 0xfe0c;
            *(undefined2 *)(puVar3 + -0x12) = 10;
            *(undefined2 *)(puVar3 + -0x14) = 10;
            *(HWND *)(puVar3 + -0x16) = hwndFrame;
            *(undefined2 *)(puVar3 + -0x18) = 0;
            *(HINSTANCE *)(puVar3 + -0x1a) = hInst;
            *(undefined2 *)(puVar3 + -0x1c) = 0;
            *(undefined2 *)(puVar3 + -0x1e) = 0;
            *(undefined2 *)(puVar3 + -0x20) = 0x14f8;
            *(undefined2 *)(puVar3 + -0x22) = 0x5f4;
            hwndPlanet = CreateWindow(*(LPCSTR *)(puVar3 + -4), *(LPCSTR *)(puVar3 + -8), *(DWORD *)(puVar3 + -0xc), *(short *)(puVar3 + -0xe),
                                      *(short *)(puVar3 + -0x10), *(short *)(puVar3 + -0x12), *(short *)(puVar3 + -0x14), *(HWND *)(puVar3 + -0x16),
                                      *(HMENU *)(puVar3 + -0x18), *(HINSTANCE *)(puVar3 + -0x1a), *(void **)(puVar3 + -0x1e));
            puVar4 = puVar3 + 4;
        } else {
            *(HWND *)(puVar3 + -2) = hwndPlanet;
            *(undefined2 *)(puVar3 + -4) = 0;
            *(undefined2 *)(puVar3 + -6) = 0;
            *(undefined2 *)(puVar3 + -8) = 1;
            *(undefined2 *)(puVar3 + -10) = 0x14f8;
            *(undefined2 *)(puVar3 + -0xc) = 0x60f;
            InvalidateRect(*(HWND *)(puVar3 + -2), *(RECT **)(puVar3 + -6), *(BOOL *)(puVar3 + -8));
            puVar4 = puVar3 + 2;
        }
        if (hwndTb == 0) {
            *(undefined2 *)(puVar4 + -2) = 0x1120;
            *(undefined2 *)(puVar4 + -4) = 0x242;
            *(undefined2 *)(puVar4 + -6) = 0;
            *(undefined2 *)(puVar4 + -8) = 0;
            *(undefined2 *)(puVar4 + -10) = 0x5000;
            *(undefined2 *)(puVar4 + -0xc) = 0;
            *(undefined2 *)(puVar4 + -0xe) = 0xfe0c;
            *(undefined2 *)(puVar4 + -0x10) = 0xfe0c;
            *(undefined2 *)(puVar4 + -0x12) = 10;
            *(undefined2 *)(puVar4 + -0x14) = 10;
            *(HWND *)(puVar4 + -0x16) = hwndFrame;
            *(undefined2 *)(puVar4 + -0x18) = 0;
            *(HINSTANCE *)(puVar4 + -0x1a) = hInst;
            *(undefined2 *)(puVar4 + -0x1c) = 0;
            *(undefined2 *)(puVar4 + -0x1e) = 0;
            *(undefined2 *)(puVar4 + -0x20) = 0x14f8;
            *(undefined2 *)(puVar4 + -0x22) = 0x659;
            hwndTb = CreateWindow(*(LPCSTR *)(puVar4 + -4), *(LPCSTR *)(puVar4 + -8), *(DWORD *)(puVar4 + -0xc), *(short *)(puVar4 + -0xe),
                                  *(short *)(puVar4 + -0x10), *(short *)(puVar4 + -0x12), *(short *)(puVar4 + -0x14), *(HWND *)(puVar4 + -0x16),
                                  *(HMENU *)(puVar4 + -0x18), *(HINSTANCE *)(puVar4 + -0x1a), *(void **)(puVar4 + -0x1e));
            puVar5 = puVar4 + 4;
        } else {
            *(HWND *)(puVar4 + -2) = hwndTb;
            *(undefined2 *)(puVar4 + -4) = 0;
            *(undefined2 *)(puVar4 + -6) = 0;
            *(undefined2 *)(puVar4 + -8) = 1;
            *(undefined2 *)(puVar4 + -10) = 0x14f8;
            *(undefined2 *)(puVar4 + -0xc) = 0x674;
            InvalidateRect(*(HWND *)(puVar4 + -2), *(RECT **)(puVar4 + -6), *(BOOL *)(puVar4 + -8));
            puVar5 = puVar4 + 2;
        }
        if (hwndMessage != 0) {
            puVar5[-1] = hwndMessage;
            puVar5[-2] = 0x14f8;
            puVar5[-3] = 0x687;
            DestroyWindow(puVar5[-1]);
        }
        puVar5[-1] = 0x1120;
        puVar5[-2] = 0x202;
        puVar5[-3] = 0;
        puVar5[-4] = 0;
        puVar5[-5] = 0x5000;
        puVar5[-6] = 0;
        puVar5[-7] = 0xfe0c;
        puVar5[-8] = 0xfe0c;
        puVar5[-9] = 10;
        puVar5[-10] = 10;
        puVar5[-0xb] = hwndFrame;
        puVar5[-0xc] = 0;
        puVar5[-0xd] = hInst;
        puVar5[-0xe] = 0;
        puVar5[-0xf] = 0;
        puVar5[-0x10] = 0x14f8;
        puVar5[-0x11] = 0x6c7;
        hwndMessage = CreateWindow(*(LPCSTR *)(puVar5 + -2), *(LPCSTR *)(puVar5 + -4), *(DWORD *)(puVar5 + -6), puVar5[-7], puVar5[-8], puVar5[-9], puVar5[-10],
                                   puVar5[-0xb], puVar5[-0xc], puVar5[-0xd], *(void **)(puVar5 + -0xf));
        puVar5[1] = 0x14f8;
        *puVar5 = 0x6cf;
        RefitFrameChildren();
    }
    return;
}

// ======================================================================
// Function: FrameWndProc
// Address: 1020:06d6
// Segment: MEMORY_MDI
// ======================================================================

/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */
/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

long FrameWndProc(HWND hwnd, WMType msg, ushort wParam, long lParam)

{
    POINT       pt;
    POINT       pt_00;
    POINT       pt_01;
    POINT       dpt;
    POINT       dpt_00;
    uint        uVar1;
    uint        uVar2;
    HWND        hWndParent;
    char       *pcVar3;
    short       sVar4;
    HICON       HVar5;
    BOOL        BVar6;
    HGDIOBJ     HVar7;
    int         iVar8;
    ushort      uVar9;
    undefined1 *puVar10;
    undefined1 *puVar11;
    undefined2  unaff_SI;
    undefined2  unaff_DI;
    undefined2  uVar12;
    undefined2  unaff_SS;
    ulong       uVar13;
    POINT       PVar14;
    LRESULT     LVar15;
    char       *pcVar16;
    ushort      in_stack_0000ff9e;
    undefined1  local_2a[6];
    int         local_24;
    short       local_22;
    short       local_20;
    HGDIOBJ     local_1e;
    short       local_1c;
    undefined1  local_1a[4];
    undefined1  local_16[4];
    undefined8  local_12;
    HPALETTE    hpalSav;
    short       i;
    HDC         hdc;

    uVar12 = 0x1020;
    puVar11 = &stack0xff9a;
    puVar10 = &stack0xff9a;
    if (msg == WM_CREATE) {
        hdc = GetDC(hwnd);
        FCreateFonts(hdc);
        GetTextMetrics(hdc, local_2a);
        dySysFont = local_2a._0_2_;
        dySBar = (dyArial8 + 0xc) * 2;
        ReleaseDC(hwnd, hdc);
        InitTiles();
        EnsureTileSize((uint)(iWindowLayout == 2));
        return 0;
    }
    if (msg == WM_DESTROY) {
        if (uTimerId != 0) {
            KillTimer(0, uTimerId);
        }
        WriteIniSettings();
        uTimerId = 0;
        if (((uint)gd.grBits >> 3 & 1) != 0) {
            FMarkFile(dtHost, -1, 1, 0);
        }
        DestroyCurGame();
        if ((gd.grBits._2_2_ >> 6 & 1) == 0) {
            PostQuitMessage(vretExitValue);
            return 0;
        }
        ExitWindows((long)vretExitValue, 0);
        return 0;
    }
    if (msg == WM_SIZE) {
        if ((wParam == 2) || (wParam == 0)) {
            vfs.dx = (int)lParam;
            uVar13 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), in_stack_0000ff9e);
            vfs.dy = (short)uVar13;
            RefitFrameChildren();
            return 0;
        }
    MDI_Default_5:
        *(HWND *)(puVar11 + -2) = hwnd;
        *(WMType *)(puVar11 + -4) = msg;
        *(ushort *)(puVar11 + -6) = wParam;
        *(undefined2 *)(puVar11 + -8) = lParam._2_2_;
        *(int *)(puVar11 + -10) = (int)lParam;
        *(undefined2 *)(puVar11 + -0xc) = uVar12;
        *(undefined2 *)(puVar11 + -0xe) = 0x1d6a;
        LVar15 = DefWindowProc(*(HWND *)(puVar11 + -2), *(UINT *)(puVar11 + -4), *(WPARAM *)(puVar11 + -6), *(LPARAM *)(puVar11 + -10));
        return LVar15;
    }
    if (msg == WM_ACTIVATE) {
        return 0;
    }
    if (msg == WM_PAINT) {
        BVar6 = IsIconic(hwnd);
        if (BVar6 == 0) {
            hdc = BeginPaint(hwnd, local_2a);
            HVar7 = SelectObject(hdc, hbrButtonShadow);
            if ((iWindowLayout == 0) || ((iWindowLayout != 1 && (iWindowLayout != 2)))) {
                PatBlt(hdc, vfs.xTop + 5, 0, 2, vfs.dy, 0xf00021);
                PatBlt(hdc, 0, vfs.y1 + 5, vfs.xTop + 2, 2, 0xf00021);
                PatBlt(hdc, 0, vfs.y2 + 5, vfs.xTop + 2, 2, 0xf00021);
                SelectObject(hdc, hbrButtonHilite);
                PatBlt(hdc, vfs.xTop + 1, 0, 1, vfs.y1 + 2, 0xf00021);
                PatBlt(hdc, 0, vfs.y1 + 1, vfs.xTop + 1, 1, 0xf00021);
                PatBlt(hdc, vfs.xTop + 1, vfs.y1 + 6, 1, (vfs.y2 - vfs.y1) + -4, 0xf00021);
                PatBlt(hdc, 0, vfs.y2 + 1, vfs.xTop + 1, 1, 0xf00021);
                PatBlt(hdc, vfs.xTop + 1, vfs.y2 + 6, 1, (vfs.dy - vfs.y2) + -6, 0xf00021);
            } else {
                if ((int)gd.grBits._2_2_ < 0) {
                    iVar8 = 0x24;
                } else {
                    iVar8 = 0;
                }
                PatBlt(hdc, vfs.xTop + 5, iVar8, 2, (vfs.y2 + 2) - iVar8, 0xf00021);
                PatBlt(hdc, 0, vfs.y1 + 5, vfs.xTop + 2, 2, 0xf00021);
                PatBlt(hdc, vfs.xTop + 5, vfs.y2 + 5, (vfs.dx - vfs.xTop) + -5, 2, 0xf00021);
                PatBlt(hdc, vfs.xTop + 5, vfs.y2 + 6, 2, (vfs.dy - vfs.y2) + -5, 0xf00021);
                SelectObject(hdc, hbrButtonHilite);
                PatBlt(hdc, vfs.xTop + 1, iVar8, 1, (vfs.y1 + 2) - iVar8, 0xf00021);
                PatBlt(hdc, 0, vfs.y1 + 1, vfs.xTop + 1, 1, 0xf00021);
                PatBlt(hdc, vfs.xTop + 1, vfs.y1 + 6, 1, (vfs.dy - vfs.y1) + -6, 0xf00021);
                PatBlt(hdc, vfs.xTop + 6, vfs.y2 + 1, (vfs.dx - vfs.xTop) + -6, 1, 0xf00021);
            }
            SelectObject(hdc, HVar7);
            EndPaint(hwnd, local_2a);
            return 0;
        }
        hdc = BeginPaint(hwnd, local_2a);
        if (((idPlayer != -1) || ((HVar5 = hiconHost, (int)game.lid == 0 && (game.lid._2_2_ == 0)))) && (HVar5 = hiconStars, uTimerId != 0)) {
            HVar5 = hiconWait;
        }
        DrawIcon(hdc, 2, 2, HVar5);
        EndPaint(hwnd, local_2a);
        return 0;
    }
    if (msg == WM_CLOSE) {
        DestroyWindow(hwnd);
        return 0;
    }
    if (msg == WM_ERASEBKGND) {
        BVar6 = IsIconic(hwnd);
        if (BVar6 != 0) {
            GetClientRect(hwnd, &local_12);
            FillRect(wParam, &local_12, hbrDesktop);
            return 0;
        }
        GetClientRect(hwnd, &local_12);
        if (hwndScanner != 0) {
            GetClientRect(hwndScanner, local_1a);
            MapWindowPoints(hwndScanner, hwnd, local_1a, 2);
            ExcludeClipRect(wParam, local_1a._0_2_, local_1a._2_2_, local_16._0_2_, local_16._2_2_);
        }
        FillRect(wParam, &local_12, hbrButtonFace);
        return 1;
    }
    if ((msg == WM_SYSCOLORCHANGE) || (msg == WM_WININICHANGE)) {
        FGetSystemColors();
        return 0;
    }
    if (msg == WM_SETCURSOR) {
        local_12._6_2_ = 0;
        uVar12 = 0x14f8;
        BVar6 = IsIconic(hwnd);
        puVar11 = &stack0xff98;
        if (BVar6 == 0) {
            GetCursorPos((POINT *)((int)&local_12 + 2));
            ScreenToClient(hwndFrame, (POINT *)((int)&local_12 + 2));
            GetClientRect(hwnd, local_1a + 2);
            uVar12 = 0x14f8;
            PVar14.y = local_12._4_2_;
            PVar14.x = local_12._2_2_;
            BVar6 = PtInRect(local_1a + 2, PVar14);
            if (BVar6 != 0) {
                uVar12 = 0x1020;
                pt.y = local_12._4_2_;
                pt.x = local_12._2_2_;
                local_12._6_2_ = HcrsFromFrameWindowPt(pt, (short *)0x0);
                if (local_12._6_2_ != 0) {
                    SetCursor(local_12._6_2_);
                    return 1;
                }
            }
            puVar11 = &stack0xff94;
        }
        goto MDI_Default_5;
    }
    if (msg == WM_GETMINMAXINFO) {
        *(undefined2 *)((int)lParam + 0xc) = 0x208;
        *(undefined2 *)((int)lParam + 0xe) = 0x17c;
        return 0;
    }
    if (msg == WM_QUERYDRAGICON) {
        HVar5 = hiconHost;
        if ((idPlayer != -1) && (HVar5 = hiconStars, uTimerId != 0)) {
            HVar5 = hiconWait;
        }
        return (ulong)HVar5;
    }
    if (msg == WM_CHAR) {
        if ((hwndScanner != 0) && ((wParam == 0x2d || (wParam == 0x2b)))) {
            SendMessage(hwndScanner, WM_CHAR, wParam, lParam);
            return 0;
        }
        if ((hwndMessage != 0) && (((wParam == 0x2d || (wParam == 0x2b)) || (wParam == 0xd)))) {
            SendMessage(hwndMessage, WM_CHAR, wParam, lParam);
            return 0;
        }
        if ((hwndPlanet != 0) && ((wParam == 0x66 || (wParam == 0x46)))) {
            SendMessage(hwndPlanet, WM_CHAR, wParam, lParam);
            return 0;
        }
        if ((hwndPlanet != 0) && ((sel.grobj == grobjPlanet && ((wParam == 0x71 || (wParam == 0x51)))))) {
            ChangeProduction(0);
            return 0;
        }
        if ((sel.grobj & (grobjFleet | grobjPlanet)) == grobjNone) {
            return 0;
        }
        local_12._6_2_ = 0;
        local_12._4_2_ = 0;
        if (wParam == 0x6e) {
            local_12._6_2_ = 1;
        } else if ((wParam == 0x4e) || (wParam == 0x50)) {
            if (sel.grobj == grobjPlanet) {
                local_12._4_2_ = IdFindAdjStarbase(sel.pl.id, (uint)(wParam == 0x4e));
            } else if (wParam == 0x4e) {
                local_12._6_2_ = 1;
            } else {
                local_12._6_2_ = -1;
            }
        } else if (wParam == 0x70) {
            local_12._6_2_ = -1;
        } else if (((wParam == 0x72) || (wParam == 0x52)) && (sel.grobj == grobjFleet)) {
            ShipCommandProc(hwndPlanet, 0, (ulong)rghwndBtn[6]);
        }
        if ((local_12._6_2_ == 0) && (local_12._4_2_ == 0)) {
            return 0;
        }
        if (sel.grobj != grobjFleet) {
            SelectAdjPlanet(local_12._6_2_, local_12._4_2_);
            return 0;
        }
        SelectAdjFleet(local_12._6_2_, local_12._4_2_);
        return 0;
    }
    if (msg == WM_COMMAND) {
        CommandHandler(hwnd, wParam);
        return 0;
    }
    if (msg == WM_SYSCOMMAND) {
        if (((wParam & 0xfff0) == 0xf030) || ((wParam & 0xfff0) == 0xf120)) {
            local_12._6_2_ = idPlayer;
            local_12._2_2_ = uTimerId;
            if (uTimerId != 0) {
                KillTimer(0, uTimerId);
                uTimerId = 0;
                CreateChildWindows();
            }
            uVar12 = 0x1020;
            if (idPlayer != -1) {
                uVar12 = 0x1070;
                sVar4 = FNewTurnAvail(idPlayer);
                if (sVar4 != 0) {
                    if (local_12._2_2_ == 0) {
                        pcVar16 = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 1;
                        pcVar3 = PszFormatIds(idsNewTurnAvailableWouldLikeLoad, (short *)0x0);
                        local_12._4_2_ = AlertSz(pcVar3, (short)pcVar16);
                    } else {
                        sVar4 = 0x40;
                        pcVar3 = PszFormatIds(idsNewTurnAvailable, (short *)0x0);
                        AlertSz(pcVar3, sVar4);
                        local_12._4_2_ = 6;
                    }
                    if (local_12._4_2_ == 6) {
                        _wsprintf((char *)(local_16 + 2), MPCTD);
                        DestroyCurGame();
                        sVar4 = FLoadGame((char *)szBase, local_16 + 2);
                        if (sVar4 == 0) {
                            sVar4 = 0x10;
                            pcVar3 = PszFormatIds(idsUnableOpenNewTurnFile, (short *)0x0);
                            AlertSz(pcVar3, sVar4);
                        } else {
                            CreateChildWindows();
                        }
                    } else if (local_12._4_2_ == 2) {
                        if (local_12._2_2_ == 0) {
                            PostMessage(hwndFrame, WM_SYSCOMMAND, 0xf020, 0);
                        } else {
                            PostMessage(hwndFrame, WM_COMMAND, 0x6a, 0);
                        }
                        return 1;
                    }
                    uVar12 = 0x14f8;
                    SendMessage(hwndFrame, WM_COMMAND, 0xfa1, 0);
                    puVar11 = &stack0xff9a;
                    goto MDI_Default_5;
                }
            }
            if (local_12._2_2_ != 0) {
                if (uTimerType == 0xd) {
                    uVar12 = 0x14f8;
                    PostMessage(hwnd, WM_STARS_HOST, 0, 0);
                    puVar11 = &stack0xff9a;
                    goto MDI_Default_5;
                }
                if (uTimerType == 0xe) {
                    pcVar16 = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 1;
                    pcVar3 = PszFormatIds(idsTurnHasSubmittedChangesMadeAfterTurn, (short *)0x0);
                    local_12._4_2_ = AlertSz(pcVar3, (short)pcVar16);
                    if ((local_12._4_2_ == 6) && (sVar4 = FMarkFile(dtLog, idPlayer, 2, 0), sVar4 == 0)) {
                        sVar4 = 0x10;
                        pcVar3 = PszFormatIds(idsNewTurnCurrentlyGeneratedHostNewTurn, (short *)0x0);
                        AlertSz(pcVar3, sVar4);
                        _wsprintf((char *)(local_16 + 2), MPCTD);
                        DestroyCurGame();
                        sVar4 = FLoadGame((char *)szBase, local_16 + 2);
                        if (sVar4 == 0) {
                            sVar4 = 0x10;
                            pcVar3 = PszFormatIds(idsUnableOpenNewTurnFile, (short *)0x0);
                            AlertSz(pcVar3, sVar4);
                        } else {
                            CreateChildWindows();
                        }
                    } else if (local_12._4_2_ == 2) {
                        PostMessage(hwndFrame, WM_COMMAND, 0x6a, 0);
                        return 1;
                    }
                }
                uVar12 = 0x14f8;
                SendMessage(hwndFrame, WM_COMMAND, 0xfa1, 0);
                if ((1000 < sel.pt.x) && (1000 < sel.pt.y)) {
                    uVar12 = 0x1058;
                    pt_00.y = sel.pt.y;
                    pt_00.x = sel.pt.x;
                    CtrPointScan(pt_00, 1);
                }
            }
        }
        puVar11 = &stack0xff9a;
        goto MDI_Default_5;
    }
    if (msg == WM_INITMENU) {
        InitializeMenu(wParam);
        return 0;
    }
    if (msg == WM_ENTERIDLE) {
        if ((((uint)gd.grBits >> 0xb & 1) != 0) && (((uint)tutor.wFlags >> 2 & 1) != 0)) {
            AdvanceTutor();
        }
        return 0;
    }
    if (msg == WM_LBUTTONDOWN) {
        local_16._2_2_ = (int)lParam;
        uVar13 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), in_stack_0000ff9e);
        local_12._0_2_ = (char *)uVar13;
        pt_01.y = (short)(char *)local_12;
        pt_01.x = local_16._2_2_;
        uVar9 = HcrsFromFrameWindowPt(pt_01, (short *)((int)&local_12 + 2));
        if (uVar9 == 0) {
            return 0;
        }
        hdc = GetDC(hwnd);
        local_1e = SelectObject(hdc, hbr50Screen);
        local_1a._0_2_ = 0;
        local_1c = 0;
        InvertPaneBorder(hdc, local_12._2_2_, (POINT)0x0, (POINT *)0x0);
        local_22 = local_16._2_2_;
        local_20 = (short)(char *)local_12;
        SetCapture(hwnd);
        local_12._4_2_ = local_16._2_2_;
        local_12._6_2_ = (ushort)(char *)local_12;
        local_1a._2_2_ = 0;
        local_16._0_2_ = 0;
        while (true) {
            sVar4 = FGetMouseMove(local_16 + 2);
            if (sVar4 == 0)
                break;
            if ((local_16._2_2_ != local_12._4_2_) || ((char *)local_12 != (char *)local_12._6_2_)) {
                local_1c = local_16._2_2_ - local_22;
                local_1a._0_2_ = (int)(char *)local_12 - local_20;
                local_2a._4_2_ = local_16._2_2_ - local_12._4_2_;
                local_24 = (int)(char *)local_12 - local_12._6_2_;
                dpt.y = local_1a._0_2_;
                dpt.x = local_1c;
                PVar14 = InvertPaneBorder(hdc, local_12._2_2_, dpt, local_2a + 4);
                local_12._4_2_ = local_16._2_2_;
                local_12._6_2_ = (ushort)(char *)local_12;
                unique0x10001a6c = PVar14;
            }
        }
        dpt_00.y = local_1a._0_2_;
        dpt_00.x = local_1c;
        InvertPaneBorder(hdc, local_12._2_2_, dpt_00, (POINT *)0x0);
        ReleaseCapture();
        SelectObject(hdc, local_1e);
        ReleaseDC(hwnd, hdc);
        if (stack0xffe8 == (POINT)0x0) {
            return 0;
        }
        if ((local_12._2_2_ & 1) != 0) {
            if (iWindowLayout == 0) {
                vfs.dxPlanWant = vfs.xTop + local_1a._2_2_;
            } else {
                vfs.dx2PlanWant = vfs.xTop + local_1a._2_2_;
            }
        }
        if ((local_12._2_2_ & 2) != 0) {
            if (iWindowLayout == 0) {
                vfs.dyMsgWant = ((vfs.y2 - vfs.y1) + -8) - local_16._0_2_;
            } else {
                vfs.dy2MsgWant = ((vfs.dy - vfs.y1) + -8) - local_16._0_2_;
            }
        }
        if ((local_12._2_2_ & 4) != 0) {
            if (iWindowLayout == 0) {
                vfs.dyMsgWant = (vfs.y2 - vfs.y1) + -8 + local_16._0_2_;
                vfs.dyMinWant = ((vfs.dy - vfs.y2) + -8) - local_16._0_2_;
            } else {
                vfs.dy2MinWant = ((vfs.dy - vfs.y2) + -8) - local_16._0_2_;
            }
        }
        InvalidateRect(hwnd, (RECT *)0x0, 1);
        RefitFrameChildren();
        return 0;
    }
    if (msg == WM_QUERYNEWPALETTE) {
    MDI_MapIt_2:
        if (hwndTitle != 0) {
            LVar15 = SendMessage(hwndTitle, msg, wParam, lParam);
            return LVar15;
        }
        hdc = GetDC(hwnd);
        hpalSav = SelectPalette(hdc, vhpal, 0);
        i = RealizePalette(hdc);
        SelectPalette(hdc, hpalSav, 0);
        ReleaseDC(hwnd, hdc);
        if (i != 0) {
            InvalidateRect(hwnd, (RECT *)0x0, 1);
            return 1;
        }
        return 0;
    }
    if (msg == WM_PALETTECHANGED) {
        if (wParam == hwnd) {
            return 0;
        }
        goto MDI_MapIt_2;
    }
    if (msg != WM_STARS_STARTUP) {
        if (msg == WM_STARS_HOST) {
            BringUpHostDlg();
            return 1;
        }
        puVar11 = &stack0xff9a;
        if (msg == WM_STARS_CONTINUE) {
            ShowTutor(0);
            game.fDirty = 0;
            DestroyCurGame();
            local_12._6_2_ = fFileErrSilent;
            fFileErrSilent = 1;
            gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffd | 2;
            sVar4 = FLoadGame((char *)szBase, (char *)0x3c8);
            if (sVar4 != 0) {
                gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffd;
                fFileErrSilent = local_12._6_2_;
                idPlayer = 0;
                if (wParam == 0x9ca) {
                    gd.grBits._0_2_ = (uint)gd.grBits & 0xfffd | 2;
                    _wsprintf(szWork, s_s_x1_1120_03cb);
                    sVar4 = FLoadLogFile((char *)szWork);
                    if (sVar4 != 0) {
                        FRunLogFile();
                    }
                    gd.grBits._0_2_ = (uint)gd.grBits & 0xfffd;
                }
                CreateChildWindows();
                SendMessage(hwndFrame, WM_COMMAND, 0xfa1, 0);
                if (wParam == 0x9ca) {
                    SendMessage(hwndMessage, WM_KEYDOWN, 0x23, 0);
                }
                tutor.idt = 0;
                local_12._4_2_ = (uint)(wParam == 0x9ca);
                tutor.wFlags = tutor.wFlags & 0xfdf7U | local_12._4_2_ << 9;
                AdvanceTutor();
                return 0;
            }
            fFileErrSilent = local_12._6_2_;
            gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffd;
            return 0;
        }
        goto MDI_Default_5;
    }
    idPlayer = -1;
    if ((ini.wFlags >> 1 & 1) != 0) {
        uVar1 = ini.wFlags & 0xfffd;
        if ((ini.wFlags >> 0xe & 1) != 0) {
            fFileErrSilent = 1;
            ini.wFlags = uVar1;
            ClearFile(7);
            sVar4 = FLoadGame((char *)szBase, (char *)0x38e);
            if (sVar4 != 0) {
                VerifyTurns();
                DestroyCurGame();
                EnsureAis();
                _wsprintf((char *)&stack0xff9e, s___s__Year___d_1120_0392);
                OutputSz(7, (char *)&stack0xff9e);
                for (i = 0; i < game.cPlayer; i = i + 1) {
                    if (((short *)rgOut)[i] + 1 < 4) {
                        local_12._6_2_ = _wsprintf((char *)&stack0xff9e, s_d_1120_03ac);
                    } else {
                        local_12._6_2_ = _wsprintf((char *)&stack0xff9e, s_Error___d__1120_03a0);
                    }
                    if ((gd.grBits2._2_2_ >> 6 & 1) == 0) {
                        PszPlayerName(i, 1, 1, 1, 0, (PLAYER *)0x0);
                        sVar4 = _wsprintf((char *)(&stack0xff9e + local_12._6_2_), s_s_1120_03b1);
                        local_12._6_2_ = local_12._6_2_ + sVar4;
                    }
                    pcVar3 = PszGetCompressedString(((short *)rgOut)[i] + idsTurned);
                    _strcat(&stack0xff9e, pcVar3);
                    if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 4 & 1) != 0) {
                        _strcat(&stack0xff9e, (char *)s___HACKER_1120_03b7);
                    }
                    OutputSz(7, (char *)&stack0xff9e);
                }
            }
        MDI_LExit:
            if ((gd.grBits._2_2_ >> 6 & 1) == 0) {
                PostQuitMessage(vretExitValue);
            } else {
                ExitWindows((long)vretExitValue, 0);
            }
            return 0;
        }
        if ((ini.wFlags >> 10 & 1) != 0) {
            if (((int)vSerialNumber != 0) || (ini.wFlags = uVar1, vSerialNumber._2_2_ != 0)) {
                ini.wFlags = uVar1;
                GenNewGameFromFile((char *)szBase);
            }
            goto MDI_LExit;
        }
        uVar2 = ini.wFlags >> 3;
        ini.wFlags = uVar1;
        if ((uVar2 & 1) != 0) {
            while (true) {
                while ((((ini.wFlags >> 2 & 1) == 0 && ((ini.wFlags >> 4 & 1) == 0)) || (sVar4 = CTurnsOutSafe(), sVar4 == 0))) {
                    EnsureAis();
                    FGenerateTurn();
                    if (((ini.wFlags >> 9 & 1) != 0) && (_lpchBatch < _lpchBatchMac))
                        goto MDI_LTryNextBatch;
                    if (ini.cTurnGen == 0)
                        goto MDI_LExit;
                    ini.cTurnGen = ini.cTurnGen + -1;
                }
                if ((ini.wFlags >> 4 & 1) == 0)
                    goto LAB_1020_0b67;
                if (((ini.wFlags >> 9 & 1) == 0) || (_lpchBatchMac <= _lpchBatch))
                    break;
            MDI_LTryNextBatch:
                DestroyCurGame();
                local_12._0_2_ = (char *)szBase;
                while (true) {
                    if ((*_lpchBatch == '\n') || ((_lpchBatch == _lpchBatchMac && (lpchBatch_2 == iRam112051b2))))
                        break;
                    *(char *)local_12 = *_lpchBatch;
                    _lpchBatch = _lpchBatch + 1;
                    local_12._0_2_ = (char *)local_12 + 1;
                }
                _lpchBatch = _lpchBatch + 1;
                ((char *)local_12)[-1] = '\0';
                ini.wFlags = ini.wFlags & 0xfffe | 1;
            }
            goto MDI_LExit;
        }
    LAB_1020_0b67:
        CommandHandler(hwnd, IDM_TOOL_OPEN_GAME);
        if ((ini.wFlags >> 4 & 1) != 0)
            goto MDI_LExit;
        if ((ini.wFlags >> 3 & 1) != 0)
            goto MDI_LNop;
        if (((int)game.lid != 0) || (game.lid._2_2_ != 0)) {
            if ((idPlayer != -1) && ((((ini.wFlags >> 0xc & 1) != 0 || ((ini.wFlags >> 0xb & 1) != 0)) || ((ini.wFlags >> 0xd & 1) != 0)))) {
                if ((ini.wFlags >> 0xd & 1) != 0) {
                    PostMessage(hwndFrame, WM_COMMAND, 0x55, 0);
                }
                if ((ini.wFlags >> 0xc & 1) != 0) {
                    PostMessage(hwndFrame, WM_COMMAND, 0x54, 0);
                }
                if ((ini.wFlags >> 0xb & 1) != 0) {
                    PostMessage(hwndFrame, WM_COMMAND, 0x53, 0);
                }
                goto MDI_LExit;
            }
            ShowWindow(hwndFrame, 5);
            InitializeMenu(0);
            PostMessage(hwndFrame, WM_COMMAND, 0xfa1, 0);
            if ((ini.wFlags >> 2 & 1) != 0) {
                ini.wFlags = ini.wFlags & 0xfffb;
                CommandHandler(hwnd, WMX_UNKNOWN_006A);
            }
            goto MDI_LNop;
        }
    }
    if (hwndTitle == 0) {
        local_12._2_2_ = GetSystemMetrics(0);
        local_12._4_2_ = GetSystemMetrics(1);
        hwndTitle = CreateWindow(szTitle, s_Stars_1120_03c1, 0x90000000, 0, 0, local_12._2_2_, local_12._4_2_, hwndFrame, 0, hInst, (void *)0x0);
        fFreeingTitle = 0;
    }
    ini.wFlags = ini.wFlags & 0xfffe;
    DestroyCurGame();
MDI_LNop:
    if ((((int)vSerialNumber != 0) || (vSerialNumber._2_2_ != 0)) && (sVar4 = _memcmp((byte *)vrgbMachineConfig, (byte_0_ *)&vrgbEnvCur, 0xb), sVar4 == 0)) {
        return 0;
    }
    if (((int)vSerialNumber == 0) && (vSerialNumber._2_2_ == 0)) {
        szWork[200] = '\0';
    } else {
        szWork[200] = '\x01';
    }
    local_16 = (undefined1[4])MakeProcInstance(MsgDlg, hInst);
    hWndParent = hwndTitle;
    if (hwndTitle == 0) {
        hWndParent = hwndFrame;
    }
    local_1a._2_2_ = DialogBox(0, IDD_GENERIC_SMALL, hWndParent, (FARPROC)local_16);
    FreeProcInstance((FARPROC)local_16);
    if (local_1a._2_2_ == 0) {
        vSerialNumber._0_2_ = 0;
        vSerialNumber._2_2_ = 0;
        _memcpy((byte *)vrgbMachineConfig, (byte_0_ *)&vrgbEnvCur, 0xb);
        uVar12 = 0x14f8;
        PostQuitMessage(vretExitValue);
        puVar10 = &stack0xff98;
    } else {
        uVar12 = 0x1038;
        sVar4 = FValidSerialNo((char *)szWork, &local_1c);
        if (sVar4 == 0) {
            if (((int)vSerialNumber == 0) && (puVar10 = &stack0xff9a, vSerialNumber._2_2_ == 0)) {
                _memcpy((byte *)vrgbMachineConfig, (byte_0_ *)&vrgbEnvCur, 0xb);
                uVar12 = 0x14f8;
                PostQuitMessage(vretExitValue);
                puVar10 = &stack0xff98;
            }
        } else {
            vSerialNumber._0_2_ = local_1c;
            vSerialNumber._2_2_ = local_1a._0_2_;
            uVar12 = 0x1118;
            _memcpy((byte *)vrgbMachineConfig, (byte_0_ *)&vrgbEnvCur, 0xb);
            puVar10 = &stack0xff9a;
        }
    }
    *(undefined2 *)(puVar10 + -2) = uVar12;
    *(undefined2 *)(puVar10 + -4) = 0xeae;
    WriteIniSettings();
    return 0;
}

// ======================================================================
// Function: InvertPaneBorder
// Address: 1020:1e3c
// Segment: MEMORY_MDI
// ======================================================================

POINT InvertPaneBorder(HDC hdc, short grSel, POINT dpt, POINT *pdptPrev)

{
    short sVar1;
    int   iVar2;
    short sVar3;
    POINT dpt_00;
    short x;
    short dxScanMin;
    short dyPlanMin;
    short dyMinAboveH2;
    short dyMsgCur;
    POINT dptOld;
    short dyAboveMinCur;
    POINT dptPrev;
    POINT dptT;
    short dChg;
    short notMin;

    sVar3 = dpt.x;
    if ((pdptPrev != (POINT *)0x0) && (grSel != 1)) {
        dpt_00.y = dpt.y - pdptPrev->y;
        dpt_00.x = dpt.x - pdptPrev->x;
        InvertPaneBorder(hdc, grSel, dpt_00, (POINT *)0x0);
    }
    if ((iWindowLayout == 0) || ((iWindowLayout != 1 && (iWindowLayout != 2)))) {
        dxScanMin = 100;
        dyPlanMin = 0x32;
        iVar2 = vfs.y2 - vfs.y1;
        dyAboveMinCur = (vfs.y2 - vfs.y1) + -8;
        notMin = 1;
        dyMinAboveH2 = (dyArial8 * 0xd >> 1) + 10;
    } else {
        dxScanMin = 200;
        dyPlanMin = 100;
        iVar2 = vfs.dy - vfs.y1;
        dyAboveMinCur = vfs.y2;
        notMin = -1;
        dyMinAboveH2 = 100;
    }
    dyMsgCur = iVar2 + -8;
    if (vfs.xTop + dpt.x < 0xc6) {
        dpt.x = 0xc6 - vfs.xTop;
    }
    if ((vfs.dx - vfs.xTop) - dpt.x < dxScanMin) {
        dpt.x = (vfs.dx - vfs.xTop) - dxScanMin;
    }
    if (0x18c < vfs.xTop + dpt.x) {
        dpt.x = 0x18c - vfs.xTop;
    }
    if ((grSel & 2U) != 0) {
        if (vfs.y1 + dpt.y < dyPlanMin) {
            dpt.y = dyPlanMin - vfs.y1;
        } else {
            iVar2 = (dyArial8 * 0xd >> 1) + 10;
            if (dyMsgCur - dpt.y < iVar2) {
                dpt.y = dyMsgCur - iVar2;
            }
        }
    }
    if ((grSel & 4U) != 0) {
        if (dyAboveMinCur + dpt.y < dyMinAboveH2) {
            dpt.y = (dyMinAboveH2 - dyAboveMinCur) * notMin;
        } else {
            iVar2 = dyArial8 * 0xd + -0x24;
            if (((vfs.dy - vfs.y2) + -8) - dpt.y < iVar2) {
                dpt.y = ((vfs.dy - vfs.y2) + -8) - iVar2;
            }
        }
    }
    sVar1 = dpt.x;
    if (pdptPrev != (POINT *)0x0) {
        iVar2 = sVar3 - pdptPrev->x;
        if (vfs.xTop + iVar2 < 0xc6) {
            iVar2 = 0xc6 - vfs.xTop;
        }
        if ((vfs.dx - vfs.xTop) - iVar2 < dxScanMin) {
            iVar2 = (vfs.dx - vfs.xTop) - dxScanMin;
        }
        if (0x18c < vfs.xTop + iVar2) {
            iVar2 = 0x18c - vfs.xTop;
        }
        dptPrev.x = dpt.x - iVar2;
    }
    sVar3 = dpt.y;
    switch (grSel) {
    default:
        dpt = (POINT)((ulong)dpt & 0xffff);
        if ((pdptPrev == (POINT *)0x0) || (sVar3 = _abs(dptPrev.x), 5 < sVar3)) {
            if (pdptPrev != (POINT *)0x0) {
                PatBlt(hdc, ((vfs.xTop + sVar1) - dptPrev.x) + 1, 0, 6, vfs.dy, 0x5a0049);
            }
            PatBlt(hdc, vfs.xTop + sVar1 + 1, 0, 6, vfs.dy, 0x5a0049);
        } else {
            dChg = dptPrev.x;
            if (dptPrev.x != 0) {
                if (dptPrev.x < 0) {
                    iVar2 = vfs.xTop + sVar1;
                    dChg = -dptPrev.x;
                } else {
                    iVar2 = (vfs.xTop + sVar1) - dptPrev.x;
                }
                x = iVar2 + 1;
                PatBlt(hdc, x, 0, dChg, vfs.dy, 0x5a0049);
                PatBlt(hdc, iVar2 + 7, 0, dChg, vfs.dy, 0x5a0049);
            }
        }
        break;
    case 2:
        dpt = (POINT)((ulong)(uint)dpt.y << 0x10);
        PatBlt(hdc, 0, vfs.y1 + sVar3 + 1, vfs.xTop + 1, 6, 0x5a0049);
        break;
    case 3:
        PatBlt(hdc, vfs.xTop + dpt.x + 1, 0, 6, vfs.dy, 0x5a0049);
        PatBlt(hdc, 0, vfs.y1 + dpt.y + 1, vfs.xTop + dpt.x + 1, 6, 0x5a0049);
        break;
    case 4:
        dpt = (POINT)((ulong)(uint)dpt.y << 0x10);
        if (iWindowLayout == 0) {
            PatBlt(hdc, 0, vfs.y2 + sVar3 + 1, vfs.xTop + 1, 6, 0x5a0049);
        } else {
            PatBlt(hdc, vfs.xTop + 7, vfs.y2 + sVar3 + 1, (vfs.dx - vfs.xTop) + -7, 6, 0x5a0049);
        }
        break;
    case 5:
        PatBlt(hdc, vfs.xTop + dpt.x + 1, 0, 6, vfs.dy, 0x5a0049);
        if (iWindowLayout == 0) {
            PatBlt(hdc, 0, vfs.y2 + dpt.y + 1, vfs.xTop + dpt.x + 1, 6, 0x5a0049);
        } else {
            PatBlt(hdc, vfs.xTop + dpt.x + 7, vfs.y2 + dpt.y + 1, ((vfs.dx - dpt.x) - vfs.xTop) + -7, 6, 0x5a0049);
        }
        break;
    case 7:
        PatBlt(hdc, vfs.xTop + dpt.x + 1, 0, 6, vfs.dy, 0x5a0049);
        PatBlt(hdc, 0, vfs.y1 + dpt.y + 1, vfs.xTop + dpt.x + 1, 6, 0x5a0049);
        PatBlt(hdc, vfs.xTop + dpt.x + 7, vfs.y2 + dpt.y + 1, ((vfs.dx - dpt.x) - vfs.xTop) + -7, 6, 0x5a0049);
    }
    return dpt;
}

// ======================================================================
// Function: HcrsFromFrameWindowPt
// Address: 1020:24b0
// Segment: MEMORY_MDI
// ======================================================================

ushort HcrsFromFrameWindowPt(POINT pt, short *pgrSel)

{
    int    iVar1;
    int    iVar2;
    short  fInVBar;
    short  fInHBar1;
    short  fInHBar2;
    ushort hcs;

    hcs = 0;
    if ((pt.x < vfs.xTop) || (vfs.xTop + 8 <= pt.x)) {
        iVar1 = 0;
    } else {
        iVar1 = 1;
    }
    if (((pt.x < vfs.xTop + 8) && (vfs.y1 <= pt.y)) && (pt.y < vfs.y1 + 8)) {
        iVar2 = 1;
    } else {
        iVar2 = 0;
    }
    if ((iWindowLayout == 0) || ((iWindowLayout != 1 && (iWindowLayout != 2)))) {
        if (((pt.x < vfs.xTop + 8) && (vfs.y2 <= pt.y)) && (pt.y < vfs.y2 + 8)) {
            fInHBar2 = 1;
        } else {
            fInHBar2 = 0;
        }
    } else if ((pt.x < vfs.xTop) || ((pt.y < vfs.y2 || (vfs.y2 + 8 <= pt.y)))) {
        fInHBar2 = 0;
    } else {
        fInHBar2 = 1;
    }
    if (iVar1 == 0) {
        if ((iVar2 != 0) || (fInHBar2 != 0)) {
            hcs = hcurResizeNS;
        }
    } else if ((iVar2 == 0) && (fInHBar2 == 0)) {
        hcs = hcurResizeWE;
    } else {
        hcs = hcurResize4Way;
    }
    if (pgrSel != (short *)0x0) {
        *pgrSel = iVar2 * 2 + iVar1 + fInHBar2 * 4;
    }
    return hcs;
}

// ======================================================================
// Function: RestoreSelection
// Address: 1020:2614
// Segment: MEMORY_MDI
// ======================================================================

void RestoreSelection(void)

{
    int         iVar1;
    undefined1 *puVar2;
    undefined2  uVar3;
    undefined2  unaff_SS;
    FLEET      *pFVar4;
    PLANET     *pPVar5;
    PLANET     *lppl;

    uVar3 = 0x1020;
    if (((ini.idPlayer == idPlayer) && ((int)ini.lid == (int)game.lid)) && (ini.lid._2_2_ == game.lid._2_2_)) {
        if ((ini.wFlags >> 5 & 0xf) == 2) {
            uVar3 = 0x1038;
            pFVar4 = LpflFromId(ini.iObjSel);
            if (pFVar4 == (FLEET *)0x0) {
                ini.wFlags = ini.wFlags & 0xfe1f | 0x20;
                ini.iObjSel = *(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0);
            } else {
                uVar3 = 0x1050;
                SelectAdjFleet(0, ini.iObjSel);
                ini.wFlags = ini.wFlags & 0xfe1f;
            }
        } else if ((ini.wFlags >> 5 & 0xf) == 1) {
            uVar3 = 0x1038;
            pPVar5 = LpplFromId(ini.iObjSel);
            iVar1 = (int)((ulong)pPVar5 >> 0x10);
            if ((((PLANET *)pPVar5 == (PLANET *)0x0) && (iVar1 == 0)) || (((PLANET *)pPVar5)->iPlayer != idPlayer)) {
                ini.iObjSel = *(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0);
            } else {
                uVar3 = 0x1048;
                SelectAdjPlanet(0, ini.iObjSel);
                ini.wFlags = ini.wFlags & 0xfe1f;
            }
        }
        puVar2 = &stack0xfff4;
        if ((ini.turn == game.turn) && (puVar2 = &stack0xfff4, 0 < ini.iMsg)) {
            iMsgCur = ini.iMsg + -1;
            if (cMsg + vcmsgplrIn <= iMsgCur) {
                iMsgCur = -1;
            }
            iMsgCur = IMsgNext(0);
            gd.grBits._0_2_ = (uint)gd.grBits & 0xefff;
            SetMsgTitle(hwndMessage);
            uVar3 = 0x14f8;
            InvalidateRect(hwndMessage, (RECT *)0x0, 1);
            puVar2 = &stack0xfff6;
            if (((uint)gd.grBits >> 0xb & 1) != 0) {
                tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
                uVar3 = 0x10f8;
                AdvanceTutor();
                puVar2 = &stack0xfff6;
            }
        }
    } else {
        ini.wFlags = ini.wFlags & 0xfe1f | 0x20;
        ini.iObjSel = *(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0);
        puVar2 = &stack0xfff4;
    }
    if ((ini.wFlags >> 5 & 0xf) != 0) {
        if (ini.iObjSel == -1) {
            *(undefined2 *)(puVar2 + -2) = uVar3;
            *(undefined2 *)(puVar2 + -4) = 0x285d;
            FFindSomethingAndSelectIt();
        } else {
            *(short *)(puVar2 + -2) = ini.iObjSel;
            *(undefined2 *)(puVar2 + -4) = uVar3;
            *(undefined2 *)(puVar2 + -6) = 0x2813;
            pPVar5 = LpplFromId(*(short *)(puVar2 + -2));
            iVar1 = (int)((ulong)pPVar5 >> 0x10);
            if ((((PLANET *)pPVar5 == (PLANET *)0x0) && (iVar1 == 0)) || (((PLANET *)pPVar5)->iPlayer != idPlayer)) {
                *(undefined2 *)(puVar2 + -2) = 0x1038;
                *(undefined2 *)(puVar2 + -4) = 0x2842;
                FFindSomethingAndSelectIt();
            } else {
                *(short *)(puVar2 + -2) = ini.iObjSel;
                *(undefined2 *)(puVar2 + -4) = 0;
                *(undefined2 *)(puVar2 + -6) = 0x1038;
                *(undefined2 *)(puVar2 + -8) = 0x2852;
                SelectAdjPlanet(*(short *)(puVar2 + -4), *(short *)(puVar2 + -2));
            }
        }
        ini.wFlags = ini.wFlags & 0xfe1f;
    }
    return;
}

// ======================================================================
// Function: FormatSerialAndEnv
// Address: 1020:2886
// Segment: MEMORY_MDI
// ======================================================================

/* WARNING: Variable defined which should be unmapped: b64 */

void FormatSerialAndEnv(long lSerial, byte *pbEnv, char *pszOut)

{
    bool       bVar1;
    short      sVar2;
    uint       uVar3;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    long       lVar4;
    long       lNew2;
    byte       b64;
    undefined1 uStack_41;
    byte       rgbRaw2[21];
    long       lTank;
    short      iPass;
    short      iRaw;
    short      cBits;
    short      i;
    byte       bXor;
    short      j;
    byte       rgbRaw[21];

    lNew2 = CONCAT22(unaff_SI, unaff_DI);
    bVar1 = false;
    PushRandom(0x11000b, lNew2);
    Randomize(lSerial);
    rgbRaw._0_4_ = lSerial;
    _memcpy(rgbRaw + 4, pbEnv, 0xb);
    iRaw = 0xf;
    for (i = 0; i < 0xb; i = i + 1) {
        for (j = (short)pbEnv[i]; 0 < j; j = j + -1) {
            Random(0x10);
        }
        if (bVar1) {
            uVar3 = Random(0x10);
            rgbRaw[iRaw] = rgbRaw[iRaw] | (byte)((uVar3 & 0xf) << 4);
            iRaw = iRaw + 1;
        } else {
            sVar2 = Random(0x10);
            rgbRaw[iRaw] = (byte)sVar2;
        }
        bVar1 = (bool)(bVar1 + 1U & 1);
    }
    bXor = 0;
    for (i = 0; i < 0xf; i = i + 1) {
        bXor = bXor ^ rgbRaw[i];
    }
    rgbRaw[iRaw] = rgbRaw[iRaw] | bXor << 4;
    PopRandom();
    for (i = 0; i < 0x15; i = i + 1) {
        rgbRaw2[i] = rgbRaw[((byte *)vrgbShuffleSerial)[i]];
    }
    iRaw = 0;
    cBits = 0;
    lVar4 = 0;
    for (i = 0; lTank._0_1_ = (byte)lVar4, i < 0x1c; i = i + 1) {
        if (cBits < 6) {
            lTank._0_1_ = (byte)lTank | rgbRaw2[iRaw] << ((byte)cBits & 0x1f);
            cBits = cBits + 8;
            iRaw = iRaw + 1;
        }
        _b64 = CONCAT11(uStack_41, (byte)lTank) & 0xff3f;
        lVar4 = __aFlshr(lNew2, _b64);
        cBits = cBits + -6;
        if (b64 < 0x1a) {
            *pszOut = b64 + 0x41;
        } else if (b64 < 0x34) {
            *pszOut = b64 + 0x47;
        } else if (b64 < 0x3e) {
            *pszOut = b64 - 4;
        } else if (b64 == 0x3e) {
            *pszOut = '-';
        } else {
            *pszOut = '*';
        }
        pszOut = pszOut + 1;
    }
    *pszOut = '\0';
    return;
}

// ======================================================================
// Function: FSerialAndEnvFromSz
// Address: 1020:2aec
// Segment: MEMORY_MDI
// ======================================================================

short FSerialAndEnvFromSz(long *plSerial, byte *pbEnv, char *pszIn)

{
    bool       bVar1;
    short      sVar2;
    uint       uVar3;
    uint       uVar4;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    ulong      uVar5;
    long       lNew2;
    ushort     in_stack_0000ffb6;
    byte       b64;
    byte       rgbRaw2[21];
    long       lTank;
    long       lSerial;
    short      iPass;
    short      iRaw;
    short      cBits;
    short      i;
    byte       bXor;
    short      j;
    short      fSuccess;
    byte       rgbRaw[21];

    lNew2 = CONCAT22(unaff_SI, unaff_DI);
    bVar1 = false;
    *(undefined2 *)plSerial = 0;
    *(undefined2 *)((int)plSerial + 2) = 0;
    _memset(pbEnv, 0, 0xb);
    iRaw = 0;
    cBits = 0;
    uVar5 = 0;
    for (i = 0; i < 0x15; i = i + 1) {
        for (; lTank._0_2_ = (uint)uVar5, cBits < 8; cBits = cBits + 6) {
            if ((*pszIn < 'A') || ('Z' < *pszIn)) {
                if ((*pszIn < 'a') || ('z' < *pszIn)) {
                    if ((*pszIn < '0') || ('9' < *pszIn)) {
                        if (*pszIn == '-') {
                            b64 = 0x3e;
                        } else {
                            b64 = 0x3f;
                        }
                    } else {
                        b64 = *pszIn + 4;
                    }
                } else {
                    b64 = *pszIn + 0xb9;
                }
            } else {
                b64 = *pszIn + 0xbf;
            }
            uVar5 = (ulong)((uint)lTank | (uint)b64 << ((byte)cBits & 0x1f));
            pszIn = pszIn + 1;
        }
        rgbRaw2[iRaw] = (byte)uVar5;
        cBits = cBits + -8;
        uVar5 = __aFlshr(lNew2, in_stack_0000ffb6);
        iRaw = iRaw + 1;
    }
    for (i = 0; i < 0x15; i = i + 1) {
        rgbRaw[((byte *)vrgbShuffleSerial)[i]] = rgbRaw2[i];
    }
    sVar2 = FValidSerialLong(CONCAT22(rgbRaw._2_2_, rgbRaw._0_2_));
    if (sVar2 == 0) {
        fSuccess = 0;
    } else {
        fSuccess = 1;
        PushRandom(0x11000b, lNew2);
        Randomize(CONCAT22(rgbRaw._2_2_, rgbRaw._0_2_));
        iRaw = 0xf;
        for (i = 0; i < 0xb; i = i + 1) {
            for (j = (short)rgbRaw[i + 4]; 0 < j; j = j + -1) {
                Random(0x10);
            }
            if (bVar1) {
                uVar3 = (int)(uint)rgbRaw[iRaw] >> 4;
                uVar4 = Random(0x10);
                if (uVar3 != (uVar4 & 0xff)) {
                    fSuccess = 0;
                }
                iRaw = iRaw + 1;
            } else {
                uVar3 = rgbRaw[iRaw] & 0xf;
                uVar4 = Random(0x10);
                if (uVar3 != (uVar4 & 0xff)) {
                    fSuccess = 0;
                }
            }
            bVar1 = (bool)(bVar1 + 1U & 1);
        }
        bXor = 0;
        for (i = 0; i < 0xf; i = i + 1) {
            bXor = bXor ^ rgbRaw[i];
        }
        if ((int)(uint)rgbRaw[iRaw] >> 4 != (bXor & 0xf)) {
            fSuccess = 0;
        }
        PopRandom();
        if (fSuccess != 0) {
            *(undefined2 *)plSerial = rgbRaw._0_2_;
            *(undefined2 *)(byte *)((int)plSerial + 2) = rgbRaw._2_2_;
            _memcpy(pbEnv, rgbRaw + 4, 0xb);
        }
    }
    return fSuccess;
}

// ======================================================================
// Function: FFindSomethingAndSelectIt
// Address: 1020:2e1c
// Segment: MEMORY_MDI
// ======================================================================

short FFindSomethingAndSelectIt(void)

{
    FLEET  *pFVar1;
    short   sVar2;
    int     iVar3;
    FLEET  *lpfl;
    short   i;
    PLANET *lppl;
    PLANET *lpplMac;

    lppl = LpplFromId(*(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0));
    iVar3 = (int)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl == (PLANET *)0x0) && (iVar3 == 0)) || (((PLANET *)lppl)->iPlayer != idPlayer)) {
        lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
        while (true) {
            if (((PLANET *)lpPlanets + cPlanet <= (PLANET *)lppl) || (((PLANET *)lppl)->iPlayer == idPlayer))
                break;
            lppl = (PLANET *)lppl + 1;
        }
        if (((PLANET *)lppl == (PLANET *)lpPlanets + cPlanet) && (lppl._2_2_ == lpPlanets._2_2_)) {
            lppl = (PLANET *)0x0;
        }
    }
    if (((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) {
        for (i = 0; i < cFleet; i = i + 1) {
            /* WARNING: Load size is inaccurate */
            pFVar1 = ((FLEET **)rglpfl)[i];
            iVar3 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
            lpfl = (FLEET *)CONCAT22(iVar3, pFVar1);
            if ((pFVar1 == (FLEET *)0x0) && (iVar3 == 0))
                break;
            if (pFVar1->iPlayer == idPlayer) {
                SelectAdjFleet(0, lpfl->id);
                return 1;
            }
        }
        sVar2 = 0;
    } else {
        SelectAdjPlanet(0, lppl->id);
        sVar2 = 1;
    }
    return sVar2;
}

// ======================================================================
// Function: CommandHandler
// Address: 1020:2f7a
// Segment: MEMORY_MDI
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x1020350e) */
/* WARNING: Removing unreachable block (ram,0x102034bc) */
/* WARNING: Removing unreachable block (ram,0x10203499) */
/* WARNING: Removing unreachable block (ram,0x102034e8) */
/* WARNING: Removing unreachable block (ram,0x10203583) */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */
/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

void CommandHandler(HWND hwnd, WParamMessageId wParam)

{
    PLAYER     *pPVar1;
    PLAYER     *pPVar2;
    POINT       ptDlgSize;
    POINT       pt_00;
    char        cVar3;
    PLANET     *pPVar4;
    UINT        UVar5;
    int         iVar6;
    short       sVar7;
    HCURSOR     HVar8;
    char       *pcVar9;
    ushort      uVar10;
    uint        uVar11;
    HMENU       HVar12;
    short       sVar13;
    HWND        HVar14;
    int         iVar15;
    undefined1 *puVar16;
    undefined1 *puVar19;
    undefined1 *puVar20;
    undefined1 *puVar21;
    PLAYER     *pPVar22;
    PLAYER     *pPVar23;
    undefined2  uVar24;
    undefined2  unaff_SS;
    ulong       uVar25;
    long        lVar26;
    FARPROC     pvVar27;
    HDC         HVar28;
    char       *pcVar29;
    char        local_124[112];
    int         local_b4;
    int         local_b2;
    uint        local_b0;
    int         local_ae;
    undefined4  local_ac;
    undefined4  local_a8;
    int         local_a4;
    uint        local_a2;
    undefined2  local_a0;
    undefined2  local_9e;
    int         local_9c;
    int         local_9a;
    short       local_98;
    ulong       local_96;
    short       local_92;
    int         local_90;
    char       *local_8e;
    int         local_8c;
    HGDIOBJ     local_8a;
    short       local_88;
    int         local_86;
    int         local_84;
    int         local_82;
    int         local_80;
    int         local_7e;
    ushort      local_7c;
    ushort      local_7a;
    ulong       local_78;
    short       local_74;
    int         local_72;
    int         local_70;
    short       local_6e;
    short       local_6c;
    int         local_6a;
    PLANET     *local_68;
    int         local_66;
    undefined2  local_64;
    undefined2  local_62;
    HGLOBAL     local_5e;
    HGLOBAL     local_5c;
    HDC         local_5a;
    undefined2  local_58;
    undefined2  local_56;
    PLANET     *local_38;
    PLANET     *local_36;
    PLANET     *local_34;
    PLANET     *local_32;
    PLANET     *local_30;
    PLANET     *pPStack_2e;
    PLANET     *pPStack_2c;
    PLANET     *local_2a;
    char       *local_28;
    PLANET     *local_26;
    PLANET     *local_24;
    PLANET     *local_22;
    RECT        rc;
    short       fRet;
    short       dx;
    char        szExt[4];
    short       dy;
    fn_lpProc  *lpProc;
    HMENU       hmenu;
    POINT       pt;
    undefined1 *puVar17;
    undefined1 *puVar18;

    if ((14999 < wParam) && (wParam < 0x3afc)) {
        iPopMenuSel = wParam + 0xc568;
        return;
    }
    if (wParam == IDM_DEBUG_DUMP_FLEETS) {
        DumpFleets();
        return;
    }
    if (wParam == IDM_DEBUG_DUMP_PLANETS) {
        DumpPlanets();
        return;
    }
    if (wParam == IDM_DEBUG_DUMP_UNIVERSE) {
        DumpUniverse();
        return;
    }
    if ((wParam == IDM_GAME_SCORE) || (wParam == IDM_GAME_SCORE2)) {
        if (idPlayer == -1) {
            return;
        }
        pvVar27 = MakeProcInstance(ScoreXDlg, hInst);
        DialogBox(0, IDD_SCORE, hwnd, pvVar27);
        FreeProcInstance(pvVar27);
        return;
    }
    if (wParam == IDM_HELP_ABOUT) {
        pvVar27 = MakeProcInstance(About, hInst);
        DialogBox(0, IDD_ABOUT, hwnd, pvVar27);
        FreeProcInstance(pvVar27);
        return;
    }
    if ((wParam == IDM_FLEET_DELETE_WAYPOINT) || (wParam == IDM_FLEET_INSERT_WAYPOINT)) {
        if ((sel.grobj == grobjFleet) && (HVar14 = GetFocus(), HVar14 != hwndOrderED)) {
            DeleteCurWayPoint((uint)(wParam == IDM_FLEET_DELETE_WAYPOINT));
        }
    MDI_Default_4:
        DefWindowProc(hwnd, 0x111, wParam, 0);
        return;
    }
    if (wParam == IDM_FILE_HOST_GAME) {
        if ((game.wCrap >> 2 & 1) == 0) {
            pcVar29 = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
            pcVar9 = PszFormatIds(idsGameAlreadyHostedAnotherInstanceStarsWould, (short *)0x0);
            sVar7 = AlertSz(pcVar9, (short)pcVar29);
            if (sVar7 != 6) {
                return;
            }
        }
    LAB_1020_3f6e:
        local_22 = (PLANET *)idPlayer;
        if (wParam == IDM_DEBUG_GEN_100_TURNS) {
            iPassCnt = 100;
        } else if ((HBRUSH *)wParam == (HBRUSH *)&hbrCargo) {
            iPassCnt = 1000;
        } else if (wParam == IDM_DEBUG_GEN_10_TURNS) {
            iPassCnt = 10;
        } else {
            iPassCnt = 0;
        }
        if (((game.wCrap >> 2 & 1) != 0) && (iPassCnt != 0)) {
            pcVar9 = PszGetCompressedString(idsSureWantForceGenerateDTurnsRow);
            _wsprintf(szWork, pcVar9);
            HVar14 = GetFocus();
            sVar7 = MessageBox(HVar14, szWork, s_Stars_1120_03de, MB_TASKMODAL | MB_ICONEXCLAMATION | MB_YESNO);
            if (sVar7 != 6) {
                return;
            }
        }
        if (idPlayer == -1) {
            return;
        }
        if (((uint)gd.grBits >> 0xb & 1) != 0) {
            AdvanceTutor();
            if (((uint)tutor.wFlags >> 3 & 1) == 0) {
                sVar7 = 0x10;
                pcVar9 = PszFormatIds(idsTutorialTurnWillGeneratedHaveYetCompleted, (short *)0x0);
                AlertSz(pcVar9, sVar7);
                return;
            }
            ShowTutor(0);
            if (game.turn < 0x24) {
                Randomize(0x499602d2);
                FWriteHistFile((short)local_22);
                sVar7 = FWriteTutorialMFile(game.turn + 1);
                if (sVar7 == 0) {
                    sVar7 = 0x10;
                    pcVar9 = PszFormatIds(idsFileError, (short *)0x0);
                    AlertSz(pcVar9, sVar7);
                    return;
                }
                if ((game.turn == 0x23) && (sVar7 = FWriteTutorialMFile(0x25), sVar7 == 0)) {
                    sVar7 = 0x10;
                    pcVar9 = PszFormatIds(idsFileError, (short *)0x0);
                    AlertSz(pcVar9, sVar7);
                    return;
                }
                _strcpy((char *)szWork, (char *)szBase);
                _strcat((char *)szWork, (char *)0x3e5);
                _remove((char *)szWork);
                DirtyGame(0);
                ShowProgressGauge();
                local_30 = (PLANET *)0xc;
                pPStack_2e = (PLANET *)0x0;
                TimerCount();
                local_38 = pPStack_2c;
                local_36 = local_2a;
                puVar20 = &stack0xfed4;
                do {
                    *(int *)(puVar20 + -2) = ((int)local_34 - (int)local_38) * 2;
                    *(undefined2 *)(puVar20 + -4) = 0x14f8;
                    *(undefined2 *)(puVar20 + -6) = 0x419e;
                    UpdateProgressGauge(*(short *)(puVar20 + -2));
                    *(undefined2 *)(puVar20 + -2) = unaff_SS;
                    *(PLANET ***)(puVar20 + -4) = &local_30;
                    *(undefined2 *)(puVar20 + -6) = 0x1040;
                    uVar24 = 0x14f8;
                    *(undefined2 *)(puVar20 + -8) = 0x41ad;
                    TimerCount();
                    puVar16 = puVar20 + -4;
                    puVar17 = puVar20 + -4;
                    puVar18 = puVar20 + -4;
                    local_34 = pPStack_2c;
                    local_32 = local_2a;
                    puVar21 = puVar20 + -4;
                    if ((local_2a < local_36) || ((local_2a <= local_36 && (puVar21 = puVar20 + -4, pPStack_2c < local_38))))
                        break;
                    puVar20 = puVar20 + -4;
                } while ((local_2a < local_36->rgpctMinLevel + (((PLANET *)0xfe0b < local_38) - 6)) ||
                         ((puVar21 = puVar18, local_2a <= local_36->rgpctMinLevel + (((PLANET *)0xfe0b < local_38) - 6) &&
                                                  (puVar21 = puVar17, puVar20 = puVar16, pPStack_2c < &local_38[8].lpplprod))));
                goto MDI_LTutorialFinishUp;
            }
        }
        if ((game.wCrap >> 2 & 1) != 0) {
            idsFileError = -1;
            sVar7 = FCheckFile(dtHost, -1, 1);
            if (sVar7 == 0) {
                HVar8 = LoadCursor(0, (LPCSTR)0x7f02);
                local_24 = (PLANET *)SetCursor(HVar8);
                FWriteLogFile((char *)szBase, (short)local_22);
                uVar24 = 0x1048;
                FWriteHistFile((short)local_22);
                puVar20 = &stack0xfed8;
                while (true) {
                    *(undefined2 *)(puVar20 + -2) = uVar24;
                    *(undefined2 *)(puVar20 + -4) = 0x42d5;
                    ShowProgressGauge();
                    *(undefined2 *)(puVar20 + -2) = 0x1040;
                    *(undefined2 *)(puVar20 + -4) = 0x42da;
                    EnsureAis();
                    *(undefined2 *)(puVar20 + -2) = 0x1020;
                    uVar24 = 0x10b0;
                    *(undefined2 *)(puVar20 + -4) = 0x42df;
                    FGenerateTurn();
                    if ((((wParam != IDM_DEBUG_GEN_10_TURNS) && (wParam != IDM_DEBUG_GEN_100_TURNS)) && ((HBRUSH *)wParam != (HBRUSH *)&hbrCargo)) ||
                        (iPassCnt = iPassCnt + -1, iPassCnt < 1))
                        break;
                    *(undefined2 *)(puVar20 + -2) = 0x10b0;
                    *(undefined2 *)(puVar20 + -4) = 0x4312;
                    HideProgressGauge();
                    *(undefined2 *)(puVar20 + -2) = 0x10;
                    *(undefined2 *)(puVar20 + -4) = 0x1040;
                    *(undefined2 *)(puVar20 + -6) = 0x431b;
                    sVar7 = GetAsyncKeyState(*(short *)(puVar20 + -2));
                    puVar19 = puVar20 + -2;
                    if (sVar7 < 0) {
                        *(undefined2 *)(puVar20 + -4) = 0x11;
                        *(undefined2 *)(puVar20 + -6) = 0x14f8;
                        uVar24 = 0x14f8;
                        *(undefined2 *)(puVar20 + -8) = 0x432c;
                        sVar7 = GetAsyncKeyState(*(short *)(puVar20 + -4));
                        puVar19 = puVar20 + -4;
                        puVar20 = puVar20 + -4;
                        if (sVar7 < 0)
                            break;
                    }
                    uVar24 = 0x14f8;
                    puVar20 = puVar19;
                }
                iPassCnt = 0;
                puVar21 = puVar20;
            MDI_LTutorialFinishUp:
                *(undefined2 *)(puVar21 + -2) = uVar24;
                *(undefined2 *)(puVar21 + -4) = 0x4342;
                DestroyCurGame();
                *(int *)(puVar21 + -2) = (int)local_22 + 1;
                *(undefined2 *)(puVar21 + -4) = 0x1120;
                *(char **)(puVar21 + -6) = MPCTD;
                *(undefined2 *)(puVar21 + -8) = unaff_SS;
                *(char **)(puVar21 + -10) = szExt;
                *(undefined2 *)(puVar21 + -0xc) = 0x1070;
                *(undefined2 *)(puVar21 + -0xe) = 0x435c;
                _wsprintf(*(char **)(puVar21 + -10), *(char **)(puVar21 + -6));
                *(char **)(puVar21 + -2) = szExt;
                *(char **)(puVar21 + -4) = (char *)szBase;
                *(undefined2 *)(puVar21 + -6) = 0x14f8;
                *(undefined2 *)(puVar21 + -8) = 0x436c;
                sVar7 = FLoadGame(*(char **)(puVar21 + -4), *(char **)(puVar21 + -2));
                if (sVar7 == 0) {
                    *(PLANET **)(puVar21 + -2) = local_24;
                    *(undefined2 *)(puVar21 + -4) = 0x1070;
                    *(undefined2 *)(puVar21 + -6) = 0x437f;
                    SetCursor(*(HCURSOR *)(puVar21 + -2));
                    *(undefined2 *)(puVar21 + -2) = 0x14f8;
                    *(undefined2 *)(puVar21 + -4) = 0x4384;
                    HideProgressGauge();
                    *(undefined2 *)(puVar21 + -2) = 0x10;
                    *(undefined2 *)(puVar21 + -4) = 0;
                    *(undefined2 *)(puVar21 + -6) = 0;
                    *(undefined2 *)(puVar21 + -8) = 0x1b;
                    *(undefined2 *)(puVar21 + -10) = 0x1040;
                    *(undefined2 *)(puVar21 + -0xc) = 0x4399;
                    pcVar9 = PszFormatIds(*(StringId *)(puVar21 + -8), *(short **)(puVar21 + -6));
                    *(char **)(puVar21 + -4) = pcVar9;
                    *(undefined2 *)(puVar21 + -6) = 0x1030;
                    *(undefined2 *)(puVar21 + -8) = 0x43a2;
                    AlertSz(*(char **)(puVar21 + -4), *(short *)(puVar21 + -2));
                    return;
                }
                *(undefined2 *)(puVar21 + -2) = 0x1070;
                *(undefined2 *)(puVar21 + -4) = 0x43ad;
                HideProgressGauge();
                idPlayer = (short)local_22;
                *(undefined2 *)(puVar21 + -2) = 0x1040;
                *(undefined2 *)(puVar21 + -4) = 0x43b8;
                CreateChildWindows();
                *(HWND *)(puVar21 + -2) = hwndFrame;
                *(undefined2 *)(puVar21 + -4) = 0x111;
                *(undefined2 *)(puVar21 + -6) = 0xfa1;
                *(undefined2 *)(puVar21 + -8) = 0;
                *(undefined2 *)(puVar21 + -10) = 0;
                *(undefined2 *)(puVar21 + -0xc) = 0x1020;
                *(undefined2 *)(puVar21 + -0xe) = 0x43d1;
                SendMessage(*(HWND *)(puVar21 + -2), *(WMType *)(puVar21 + -4), *(WPARAM *)(puVar21 + -6), *(LPARAM *)(puVar21 + -10));
                *(PLANET **)(puVar21 + -2) = local_24;
                *(undefined2 *)(puVar21 + -4) = 0x14f8;
                *(undefined2 *)(puVar21 + -6) = 0x43d9;
                SetCursor(*(HCURSOR *)(puVar21 + -2));
                if (((uint)gd.grBits >> 0xb & 1) == 0) {
                    return;
                }
                tutor.wFlags = tutor.wFlags & 0xfdf7;
                *(undefined2 *)(puVar21 + -2) = 0x14f8;
                *(undefined2 *)(puVar21 + -4) = 0x4409;
                AdvanceTutor();
                return;
            }
            sVar7 = FBadFileError(idsFileError);
            if (sVar7 != 0) {
                sVar7 = 0x10;
                pcVar9 = PszFormatIds(idsFileError, (short *)0x0);
                AlertSz(pcVar9, sVar7);
                return;
            }
            pcVar29 = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
            pcVar9 = PszFormatIds(idsGameAlreadyHostedAnotherInstanceStarsWould, (short *)0x0);
            sVar7 = AlertSz(pcVar9, (short)pcVar29);
            if (sVar7 != 6) {
                return;
            }
        }
    } else if (wParam != WMX_UNKNOWN_006A) {
        if (wParam != WMX_UNKNOWN_006C) {
            if (wParam == IDM_FILE_OPEN_GAME) {
            LAB_1020_4a53:
                if ((((uint)gd.grBits >> 0xb & 1) != 0) && (sVar7 = FAskKillTutor(), sVar7 == 0)) {
                    return;
                }
                sVar7 = FOpenGame(hwnd, 0);
                if (sVar7 < 1) {
                    return;
                }
                InitializeMenu(0);
                if (uTimerId == 0) {
                    PostMessage(hwnd, WM_COMMAND, 0xfa1, 0);
                }
                if ((game.wCrap >> 3 & 1) == 0) {
                    return;
                }
                if (idPlayer != 0) {
                    return;
                }
                StartTutor(0);
                return;
            }
            if (wParam == IDM_FILE_NEW_GAME) {
            LAB_1020_3083:
                if ((((uint)gd.grBits >> 0xb & 1) != 0) && (sVar7 = FAskKillTutor(), sVar7 == 0)) {
                    return;
                }
                NewGameWizard(hwnd, 0);
                return;
            }
            if (wParam != WMX_UNKNOWN_006F) {
                if (wParam == IDM_FILE_RETURN_TO_TITLE) {
                    if ((((uint)gd.grBits >> 0xb & 1) != 0) && (sVar7 = FAskKillTutor(), sVar7 == 0)) {
                        return;
                    }
                    WriteIniSettings();
                    DestroyCurGame();
                    _strcpy((char *)szBase, (char *)szWork);
                    ini.wFlags = ini.wFlags & 0xfe1f;
                    ini.iObjSel = 0;
                    ini.idPlayer = -1;
                    InitializeMenu(0);
                    local_24 = (PLANET *)GetSystemMetrics(0);
                    local_22 = (PLANET *)GetSystemMetrics(1);
                    hwndTitle = CreateWindow(szTitle, s_Stars_1120_03e9, 0x90000000, 0, 0, (short)local_24, (short)local_22, hwndFrame, 0, hInst, (void *)0x0);
                    fFreeingTitle = 0;
                    ShowWindow(hwndFrame, 0);
                    return;
                }
                if (wParam == IDM_GAME_SHIP_BUILDER) {
                LAB_1020_4df3:
                    if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
                        return;
                    }
                    if (idPlayer == -1) {
                        return;
                    }
                    local_24 = (PLANET *)0x262;
                    local_22 = (PLANET *)0x1c2;
                    if (hwndPopup != 0) {
                        SendMessage(hwndPopup, WM_RBUTTONUP, 0, 0);
                    }
                    ptDlgSize.y = (short)local_22;
                    ptDlgSize.x = (short)local_24;
                    ShipBuilder(ptDlgSize);
                    return;
                }
                if (wParam == IDM_GAME_RESEARCH) {
                LAB_1020_4be3:
                    if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
                        return;
                    }
                    if (idPlayer == -1) {
                        return;
                    }
                    pvVar27 = MakeProcInstance(ResearchDlg, hInst);
                    sVar7 = DialogBox(0, IDD_RESEARCH, hwndFrame, pvVar27);
                    FreeProcInstance(pvVar27);
                    if (sVar7 == 0) {
                        return;
                    }
                    if (sel.grobj != grobjPlanet) {
                        return;
                    }
                    if (((PLPROD *)sel.pl.lpplprod != (PLPROD *)0x0) || (sel.pl.lpplprod._2_2_ != 0)) {
                        FillPlanetProdLB(hwndPlanetProdLB, (PLPROD *)CONCAT22(sel.pl.lpplprod._2_2_, (PLPROD *)sel.pl.lpplprod), (PLANET *)0x0);
                    }
                    DrawPlanShip(0, 0x48);
                    return;
                }
                if (wParam == IDM_RACE_CREATE) {
                    pPVar22 = (PLAYER *)vrgplrDef;
                    pPVar23 = (PLAYER *)&vplr;
                    for (iVar15 = 0x60; iVar15 != 0; iVar15 = iVar15 + -1) {
                        pPVar2 = pPVar23;
                        pPVar23 = &pPVar23->cPlanet;
                        pPVar1 = pPVar22;
                        pPVar22 = &pPVar22->cPlanet;
                        cVar3 = pPVar1->cShDef;
                        pPVar2->iPlayer = pPVar1->iPlayer;
                        pPVar2->cShDef = cVar3;
                    }
                    RaceCreationWizard(hwnd, 0, 0);
                    return;
                }
                if (((wParam == IDM_VIEW_LAYOUT_0) || (wParam == IDM_VIEW_LAYOUT_1)) || (wParam == IDM_VIEW_LAYOUT_2)) {
                    if (idPlayer == -1) {
                        return;
                    }
                    iWindowLayout = wParam - IDM_VIEW_LAYOUT_0;
                    InvalidateRect(hwndFrame, (RECT *)0x0, 1);
                    EnsureTileSize((uint)(iWindowLayout == 2));
                    RefitFrameChildren();
                    return;
                }
                if (wParam == IDC_UNKNOWN_0087)
                    goto LAB_1020_4be3;
                if (wParam == IDM_VIEW_BROWSER_TOGGLE) {
                LAB_1020_440c:
                    if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
                        return;
                    }
                    if (idPlayer == -1) {
                        return;
                    }
                    if (hwndBrowser == 0) {
                        local_22 = (PLANET *)0x8;
                        CreateDialog(0, IDD_BROWSER, hwndFrame,
                                     (fn_lpfnBrowserDlgProc *)CONCAT22(lpfnBrowserDlgProc._2_2_, (fn_lpfnBrowserDlgProc *)lpfnBrowserDlgProc));
                    } else {
                        local_22 = (PLANET *)0x0;
                        DestroyWindow(hwndBrowser);
                    }
                    uVar10 = GetASubMenu(hwnd, 5);
                    CheckMenuItem(uVar10, 0x100, (UINT)local_22);
                    return;
                }
                if (wParam == IDC_UNKNOWN_0089)
                    goto LAB_1020_4df3;
                if (wParam == IDM_HELP_CONTENTS) {
                LAB_1020_47b3:
                    WinHelp(hwnd, _szHelpFile, 3, 0);
                    return;
                }
                if ((wParam == IDM_RACE_EDIT1) || (wParam == IDM_RACE_EDIT2)) {
                    if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
                        return;
                    }
                    if (idPlayer == -1) {
                        return;
                    }
                    pPVar22 = (PLAYER *)rgplr + idPlayer;
                    pPVar23 = (PLAYER *)&vplr;
                    for (iVar15 = 0x60; iVar15 != 0; iVar15 = iVar15 + -1) {
                        pPVar2 = pPVar23;
                        pPVar23 = &pPVar23->cPlanet;
                        pPVar1 = pPVar22;
                        pPVar22 = &pPVar22->cPlanet;
                        cVar3 = pPVar1->cShDef;
                        pPVar2->iPlayer = pPVar1->iPlayer;
                        pPVar2->cShDef = cVar3;
                    }
                    RaceCreationWizard(hwnd, 1, 0);
                    return;
                }
                if ((wParam == IDC_UNKNOWN_009E) || (wParam == IDC_UNKNOWN_009F)) {
                    if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
                        return;
                    }
                    if (idPlayer == -1) {
                        return;
                    }
                    NewGameWizard(hwnd, 1);
                    return;
                }
                if (wParam == IDC_UNKNOWN_00B3) {
                    uVar10 = GetASubMenu(hwnd, 1);
                    local_22 = (PLANET *)(uint)(-1 < (int)gd.grBits._2_2_);
                    gd.grBits._2_2_ = gd.grBits._2_2_ & 0x7fff | (int)local_22 << 0xf;
                    if (local_22 == (PLANET *)0x0) {
                        UVar5 = 0;
                    } else {
                        UVar5 = 8;
                    }
                    CheckMenuItem(uVar10, 0xb3, UVar5);
                    RefitFrameChildren();
                    return;
                }
                if (wParam == IDC_UNKNOWN_00D5) {
                    if (idPlayer == -1) {
                        return;
                    }
                    _local_2a = MakeProcInstance(PrintMapDlg, hInst);
                    local_66 = DialogBox(0, IDD_BROWSER | IDD_GENERIC_SMALL, hwndFrame, _local_2a);
                    FreeProcInstance(_local_2a);
                    if (local_66 == 0) {
                        return;
                    }
                    local_22 = (PLANET *)vrgcPrintMapPage[0];
                    local_68 = (PLANET *)vrgcPrintMapPage[1];
                    _memset(&local_64, 0, 0x34);
                    local_64 = 0x34;
                    local_62 = 0;
                    local_58 = 0x500;
                    local_56 = 0;
                    iVar15 = PrintDlg();
                    if (iVar15 == 0) {
                        sVar7 = 0x10;
                        pcVar9 = PszFormatIds(idsUnablePrintGameMapPrinterMayOff, (short *)0x0);
                        AlertSz(pcVar9, sVar7);
                        return;
                    }
                    local_6c = GetDeviceCaps(local_5a, 8);
                    local_88 = GetDeviceCaps(local_5a, 10);
                    local_6e = GetDeviceCaps(local_5a, 0x58);
                    local_98 = GetDeviceCaps(local_5a, 0x5a);
                    local_72 = 0x20;
                    local_7c = HfontPrinterCreate(local_5a, 8, &local_86);
                    local_7a = HfontPrinterCreate(local_5a, 5, &local_70);
                    SetBkMode(local_5a, 1);
                    pPVar4 = local_22;
                    local_9e = 0;
                    local_a0 = 0;
                    local_a2 = (uint)((int)local_68 < (int)local_22);
                    if (local_a2 == local_88 < local_6c) {
                        local_30 = local_22;
                        local_22 = local_68;
                        local_68 = pPVar4;
                    }
                    local_78 = __aFulmul((long)local_6c, (long)(int)local_22);
                    local_96 = __aFulmul((long)local_88, (long)(int)local_68);
                    if (32000 < (long)local_78) {
                        local_78 = 32000;
                    }
                    if (32000 < (long)local_96) {
                        local_96 = 32000;
                    }
                    if ((long)local_78 < (long)local_96) {
                        if ((long)(local_96 - (long)local_98) < (long)local_78) {
                            local_78 = local_96 - (long)local_98;
                        }
                        local_8c = (int)local_78;
                        local_84 = local_72;
                        local_82 = (int)local_78 + local_72;
                        local_80 = (int)local_78 / 2;
                        local_7e = local_82;
                    } else {
                        if ((long)(local_78 - (long)((local_6e * 3) / 2)) < (long)local_96) {
                            local_96 = local_78 - (long)((local_6e * 3) / 2);
                        }
                        local_8c = (int)local_96;
                        local_84 = (int)local_96 + local_72;
                        local_82 = local_72;
                        local_7e = (int)local_96 / 2;
                        local_80 = local_84;
                    }
                    local_9a = local_8c;
                    local_9c = local_8c;
                    local_8c = local_8c + local_72 * -2;
                    for (local_6a = 0; local_6a < (int)local_22; local_6a = local_6a + 1) {
                        for (local_90 = 0; local_90 < (int)local_68; local_90 = local_90 + 1) {
                            local_a4 = -local_6c * local_6a;
                            local_a2 = -local_88 * local_90;
                            local_92 = CchGetString(idsStarsUniverseMap, (char *)szWork);
                            Escape(local_5a, 10, local_92, szWork, (void *)0x0);
                            Rectangle(local_5a, local_a4, local_a2, local_a4 + local_9c, local_a2 + local_9a);
                            if (local_7c == 0) {
                                local_8a = 0;
                            } else {
                                local_8a = SelectObject(local_5a, local_7c);
                            }
                            local_74 = local_82 + local_a2;
                            local_92 = CchGetString(idsStarsUniverseMap, (char *)szWork);
                            TextOut(local_5a, local_84 + local_a4, local_74, szWork, local_92);
                            iVar15 = local_74 + local_86;
                            iVar6 = local_84 + local_a4;
                            uVar24 = 0x1120;
                            pcVar9 = (char *)game.szName;
                            HVar28 = local_5a;
                            local_74 = iVar15;
                            uVar10 = _strlen((char *)game.szName);
                            TextOut(HVar28, iVar6, iVar15, (LPCSTR)CONCAT22(uVar24, pcVar9), uVar10);
                            local_74 = local_74 + local_86;
                            pcVar9 = PszPlayerName(idPlayer, 1, 1, 1, 0, (PLAYER *)0x0);
                            iVar15 = local_84 + local_a4;
                            uVar24 = 0x1120;
                            sVar7 = local_74;
                            HVar28 = local_5a;
                            local_8e = pcVar9;
                            uVar10 = _strlen(pcVar9);
                            TextOut(HVar28, iVar15, sVar7, (LPCSTR)CONCAT22(uVar24, pcVar9), uVar10);
                            local_74 = local_74 + local_86;
                            iVar15 = game.turn + 0x960;
                            pcVar9 = PszGetCompressedString(idsYearD);
                            local_92 = _wsprintf(szWork, pcVar9, iVar15);
                            TextOut(local_5a, local_84 + local_a4, local_74, szWork, local_92);
                            if ((grbitScan & 0xf) != 5) {
                                local_74 = local_7e + local_a2;
                                for (local_30 = (PLANET *)0x0; (int)local_30 < 5; local_30 = (PLANET *)((int)&local_30->id + 1)) {
                                    local_92 = CchGetString((StringId)(local_30[0x17].rgbImp + 6), (char *)szWork);
                                    TextOut(local_5a, local_80 + local_a4, local_74, szWork, local_92);
                                    local_74 = local_74 + local_86;
                                }
                                local_74 = local_7e + local_a2;
                                if (local_7a != 0) {
                                    SelectObject(local_5a, local_7a);
                                }
                                local_a8._2_2_ = local_70 / 2;
                                CtrTextOut(local_5a, local_80 + local_a4, ((local_86 * 3) / 2 + local_74) - local_a8._2_2_, (char *)0x3d4, 1);
                                local_a8._2_2_ = local_70 / 2;
                                CtrTextOut(local_5a, local_80 + local_a4, ((local_86 * 5) / 2 + local_74) - local_a8._2_2_, (char *)0x3d6, 1);
                                CtrTextOut(local_5a, local_80 + local_a4, ((local_86 * 9) / 2 + local_74 + 8) - local_70, (char *)0x3d8, 1);
                                if (local_7c != 0) {
                                    SelectObject(local_5a, local_7c);
                                }
                                DrawPlanetPrintDot(local_5a, local_80 + local_a4, local_74 + -4 + local_86 / 2, 1);
                                DrawPlanetPrintDot(local_5a, local_80 + local_a4, local_74 + -4 + (local_86 * 7) / 2, 0);
                                DrawPlanetPrintDot(local_5a, local_80 + local_a4, (local_86 * 9) / 2 + local_74 + 8, 0);
                            }
                            if ((grbitScan & 0xf) != 5) {
                                if (local_7a != 0) {
                                    SelectObject(local_5a, local_7a);
                                }
                                pPStack_2c = lpPlanets._2_2_;
                                local_a8 = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
                                local_26 = (PLANET *)lpPlanets + cPlanet;
                                local_24 = lpPlanets._2_2_;
                                for (pPStack_2e = (PLANET *)lpPlanets; pPStack_2e < local_26; pPStack_2e = pPStack_2e + 1) {
                                    local_ac._0_2_ = ((POINT *)rgptPlan + ((PLANET *)CONCAT22(pPStack_2c, pPStack_2e))->id)->x + -1000;
                                    local_ac._2_2_ = (int)local_ac >> 0xf;
                                    local_a8._0_2_ =
                                        (PLANET *)((dGalInv + -1000) - *(int *)((int)&rgptPlan[0].y + ((PLANET *)CONCAT22(pPStack_2c, pPStack_2e))->id * 4));
                                    local_a8._2_2_ = (int)(PLANET *)local_a8 >> 0xf;
                                    local_ae = local_a4 >> 0xf;
                                    local_b0 = local_a4;
                                    local_b2 = local_72 >> 0xf;
                                    local_b4 = local_72;
                                    iVar15 = dGal >> 0xf;
                                    sVar7 = dGal;
                                    uVar25 = __aFulmul((long)(int)local_ac, (long)local_8c);
                                    lVar26 = __aFldiv(uVar25, CONCAT22(iVar15, sVar7));
                                    local_ac = lVar26 + CONCAT22(local_b2, local_b4) + CONCAT22(local_ae, local_b0);
                                    local_ae = (int)local_a2 >> 0xf;
                                    local_b0 = local_a2;
                                    local_b2 = local_72 >> 0xf;
                                    local_b4 = local_72;
                                    iVar15 = dGal >> 0xf;
                                    sVar7 = dGal;
                                    uVar25 = __aFulmul(CONCAT22(local_a8._2_2_, (PLANET *)local_a8), (long)local_8c);
                                    lVar26 = __aFldiv(uVar25, CONCAT22(iVar15, sVar7));
                                    local_a8 = (PLANET *)(lVar26 + CONCAT22(local_b2, local_b4) + CONCAT22(local_ae, local_b0));
                                    if (pPStack_2e->iPlayer == idPlayer) {
                                        if ((pPStack_2e->wFlags_0x4 >> 9 & 1) != 0) {
                                            iVar15 = pPStack_2e->iPlayer * 4;
                                            if (*(int *)(*(int *)(iVar15 + rglpshdefSB) + (*(uint *)&pPStack_2e->lStarbase & 0xf) * 0x93) == 0x20) {
                                                pcVar9 = (char *)0x3da;
                                            } else {
                                                pcVar9 = (char *)0x3dc;
                                            }
                                            CtrTextOut(local_5a, (int)local_ac, (int)(PLANET *)local_a8 + (4 - local_70), pcVar9, 1);
                                        }
                                        DrawPlanetPrintDot(local_5a, (int)local_ac, (short)(PLANET *)local_a8, 1);
                                    } else if (pPStack_2e->iPlayer != -1) {
                                        local_ae = _wsprintf(szWork, PCTD, pPStack_2e->iPlayer + 1);
                                        CtrTextOut(local_5a, (int)local_ac, (int)(PLANET *)local_a8 - local_70, (char *)szWork, local_ae);
                                    }
                                }
                            }
                            if (local_7c != 0) {
                                SelectObject(local_5a, local_7c);
                            }
                            for (local_30 = (PLANET *)0x0; (int)local_30 < game.cPlanMax; local_30 = (PLANET *)((int)&local_30->id + 1)) {
                                local_ac._0_2_ = ((POINT *)rgptPlan + (int)local_30)->x + -1000;
                                local_ac._2_2_ = (int)local_ac >> 0xf;
                                local_a8._0_2_ = (PLANET *)((dGalInv + -1000) - *(int *)((int)&rgptPlan[0].y + (int)local_30 * 4));
                                local_a8._2_2_ = (int)(PLANET *)local_a8 >> 0xf;
                                local_ae = local_a4 >> 0xf;
                                local_b0 = local_a4;
                                local_b2 = local_72 >> 0xf;
                                local_b4 = local_72;
                                iVar15 = dGal >> 0xf;
                                sVar7 = dGal;
                                uVar25 = __aFulmul((long)(int)local_ac, (long)local_8c);
                                lVar26 = __aFldiv(uVar25, CONCAT22(iVar15, sVar7));
                                local_ac = lVar26 + CONCAT22(local_b2, local_b4) + CONCAT22(local_ae, local_b0);
                                local_ae = (int)local_a2 >> 0xf;
                                local_b0 = local_a2;
                                local_b2 = local_72 >> 0xf;
                                local_b4 = local_72;
                                iVar15 = dGal >> 0xf;
                                sVar7 = dGal;
                                uVar25 = __aFulmul(CONCAT22(local_a8._2_2_, (PLANET *)local_a8), (long)local_8c);
                                lVar26 = __aFldiv(uVar25, CONCAT22(iVar15, sVar7));
                                local_a8 = (PLANET *)(lVar26 + CONCAT22(local_b2, local_b4) + CONCAT22(local_ae, local_b0));
                                DrawPlanetPrintDot(local_5a, (int)local_ac, (short)(PLANET *)local_a8, 0);
                                if ((grbitScan & 0x400) != 0) {
                                    sVar7 = 0;
                                    pcVar9 = PszGetPlanetName((short)local_30);
                                    CtrTextOut(local_5a, (int)local_ac, (short)(((PLANET *)local_a8)->rgEnvVar + 2), pcVar9, sVar7);
                                }
                            }
                            if (local_8a != 0) {
                                SelectObject(local_5a, local_8a);
                            }
                            Escape(local_5a, 1, 0, (LPCSTR)0x0, (void *)0x0);
                        }
                    }
                    Escape(local_5a, 0xb, 0, (LPCSTR)0x0, (void *)0x0);
                    if (local_7c != 0) {
                        DeleteObject(local_7c);
                    }
                    if (local_7a != 0) {
                        DeleteObject(local_7a);
                    }
                    DeleteDC(local_5a);
                    if (local_5e != 0) {
                        GlobalFree(local_5e);
                    }
                    if (local_5c == 0) {
                        return;
                    }
                    GlobalFree(local_5c);
                    return;
                }
                if ((((wParam == IDC_UNKNOWN_00FA) || (wParam == IDC_UNKNOWN_00FB)) || (wParam == IDC_UNKNOWN_00FC)) || (wParam == IDC_UNKNOWN_00FD)) {
                    if (hwndTitle == 0) {
                        return;
                    }
                    PostMessage(hwndTitle, WM_COMMAND, wParam - IDC_UNKNOWN_00FA, 0);
                    return;
                }
                if (wParam == IDM_VIEW_BROWSER_TOGGLE2)
                    goto LAB_1020_440c;
                if (wParam == IDM_HELP_CONTENTS2)
                    goto LAB_1020_47b3;
                if (wParam == IDC_UNKNOWN_010E) {
                    if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
                        return;
                    }
                    if (idPlayer == -1) {
                        return;
                    }
                    if (((game.wCrap >> 2 & 1) != 0) && (lSaltCur._2_2_ < 1)) {
                        if (lSaltCur._2_2_ < 0) {
                            return;
                        }
                        if ((int)lSaltCur == 0) {
                            return;
                        }
                    }
                    sVar7 = FCheckPassword();
                    if (sVar7 == 0) {
                        return;
                    }
                    pvVar27 = MakeProcInstance(NewPasswordDlg, hInst);
                    DialogBox(0, IDD_NEW_PASSWORD, hwndFrame, pvVar27);
                    FreeProcInstance(pvVar27);
                    return;
                }
                if (wParam == IDC_UNKNOWN_0428) {
                    wParam = IDM_TURN_END_B;
                } else {
                    if (wParam == IDM_GAME_RELATIONS) {
                    LAB_1020_4cfb:
                        if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
                            return;
                        }
                        if (idPlayer == -1) {
                            return;
                        }
                        if ((game.wCrap >> 2 & 1) != 0) {
                            return;
                        }
                        pvVar27 = MakeProcInstance(RelationsDlg, hInst);
                        DialogBox(0, IDD_RELATIONS, hwndFrame, pvVar27);
                        FreeProcInstance(pvVar27);
                        return;
                    }
                    if (wParam == IDM_GAME_WAIT_FOR_TURN)
                        goto MDI_LWaitForTurn;
                    if ((wParam == IDM_GAME_BATTLE_PLANS1) || (wParam == IDM_GAME_BATTLE_PLANS2)) {
                        if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
                            return;
                        }
                        if (idPlayer == -1) {
                            return;
                        }
                        pvVar27 = MakeProcInstance(BattlePlansDlg, hInst);
                        DialogBox(0, IDD_BATTLE_PLANS, hwndFrame, pvVar27);
                        FreeProcInstance(pvVar27);
                        return;
                    }
                    if (wParam == IDM_GAME_RELATIONS2)
                        goto LAB_1020_4cfb;
                    if (wParam == IDM_REPORT_PLANET) {
                    LAB_1020_44cc:
                        local_26 = (PLANET *)0x0;
                        if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
                            return;
                        }
                        if (idPlayer == -1) {
                            return;
                        }
                        uVar10 = GetASubMenu(hwnd, 4);
                        while (hwndReportDlg != 0) {
                            if ((wParam == IDM_REPORT_BATTLE) && (vprptCur == (RPT *)&vrptBattle)) {
                                local_24 = (PLANET *)0x0;
                            } else {
                                local_24 = (PLANET *)0x1;
                            }
                            local_22 = (PLANET *)0x0;
                            DestroyWindow(hwndReportDlg);
                            if (wParam == IDM_REPORT_FLEET) {
                                UVar5 = 0x8ff;
                            } else {
                                UVar5 = 0x8fd;
                            }
                            CheckMenuItem(uVar10, UVar5, (UINT)local_22);
                            if (local_24 != (PLANET *)0x1) {
                                return;
                            }
                        }
                        local_22 = (PLANET *)0x8;
                        if (wParam == IDM_REPORT_FLEET) {
                            local_24 = (PLANET *)0x49a;
                            vprptCur = (RPT *)&vrptFleet;
                            for (local_2a = (PLANET *)0x0; (int)local_2a < cFleet; local_2a = (PLANET *)((int)&local_2a->id + 1)) {
                                pPStack_2e = *(PLANET **)((FLEET **)rglpfl + (int)local_2a);
                                pPStack_2c = (PLANET *)*(int *)((int)((FLEET **)rglpfl + (int)local_2a) + 2);
                                if ((pPStack_2e == (PLANET *)0x0) && (pPStack_2c == (PLANET *)0x0))
                                    break;
                                if (pPStack_2e->iPlayer == idPlayer) {
                                    local_26 = (PLANET *)((int)local_26 + 1);
                                }
                            }
                        } else if (wParam == IDM_REPORT_ENEMY_FLEET) {
                            local_24 = (PLANET *)0x49b;
                            vprptCur = (RPT *)&vrptEFleet;
                            for (local_2a = (PLANET *)0x0; (int)local_2a < cFleet; local_2a = (PLANET *)((int)&local_2a->id + 1)) {
                                pPStack_2e = *(PLANET **)((FLEET **)rglpfl + (int)local_2a);
                                pPStack_2c = (PLANET *)*(int *)((int)((FLEET **)rglpfl + (int)local_2a) + 2);
                                if ((pPStack_2e == (PLANET *)0x0) && (pPStack_2c == (PLANET *)0x0))
                                    break;
                                if (pPStack_2e->iPlayer != idPlayer) {
                                    local_26 = (PLANET *)((int)local_26 + 1);
                                }
                            }
                        } else if (wParam == IDM_REPORT_BATTLE) {
                            vprptCur = (RPT *)&vrptBattle;
                            local_24 = (PLANET *)0x49c;
                            local_26 = (PLANET *)CBattles();
                        } else {
                            vprptCur = (RPT *)&vrptPlanet;
                            local_24 = (PLANET *)0x499;
                            pPStack_2e = lpPlanets._2_2_;
                            local_34 = (PLANET *)lpPlanets;
                            local_32 = lpPlanets._2_2_;
                            pPStack_2c = (PLANET *)lpPlanets + cPlanet;
                            local_2a = lpPlanets._2_2_;
                            for (local_30 = (PLANET *)lpPlanets; local_30 < pPStack_2c; local_30 = local_30 + 1) {
                                if (local_30->iPlayer == idPlayer) {
                                    local_26 = (PLANET *)((int)local_26 + 1);
                                }
                            }
                        }
                        local_28 = PszGetCompressedString((StringId)local_24);
                        _wsprintf(szWork, local_28);
                        hwndReportDlg = CreateWindow(szReport, szWork, 0x80cf0000, 0, 0, 100, 100, hwndFrame, 0, hInst, (void *)0x0);
                        SetWindowPos(hwndReportDlg, 0, 0, 0, 0, 0, 0x47);
                        CheckMenuItem(uVar10, wParam, (UINT)local_22);
                        return;
                    }
                    if (wParam == IDM_REPORT_CYCLE) {
                        if (hwndReportDlg == 0) {
                            wParam = IDM_REPORT_PLANET;
                        } else if (vprptCur == (RPT *)&vrptPlanet) {
                            wParam = IDM_REPORT_FLEET;
                        } else if (vprptCur == (RPT *)&vrptFleet) {
                            wParam = IDM_REPORT_ENEMY_FLEET;
                        } else {
                            wParam = IDM_REPORT_BATTLE;
                        }
                        goto LAB_1020_44cc;
                    }
                    if (((wParam == IDM_REPORT_FLEET) || (wParam == IDM_REPORT_ENEMY_FLEET)) || (wParam == IDM_REPORT_BATTLE))
                        goto LAB_1020_44cc;
                    if (wParam == IDM_UNKNOWN_098D) {
                        uVar10 = GetASubMenu(hwnd, 1);
                        grbitScan = grbitScan ^ 0x2000;
                        if ((grbitScan & 0x2000) == 0) {
                            UVar5 = 0;
                        } else {
                            UVar5 = 8;
                        }
                        CheckMenuItem(uVar10, 0x98d, UVar5);
                        gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xffbf | 0x40;
                        if ((grbitScan & 0x1400) == 0) {
                            return;
                        }
                        InvalidateRect(hwndScanner, (RECT *)0x0, 0);
                        return;
                    }
                    if ((wParam == IDM_UNKNOWN_09C1) || (wParam == IDM_UNKNOWN_09C2)) {
                        if (wParam == IDM_UNKNOWN_09C2) {
                            uVar11 = 0x1195;
                        } else {
                            uVar11 = 0x32ca;
                        }
                        WinHelp(hwnd, _szHelpFile, 1, (ulong)uVar11);
                        return;
                    }
                    if ((wParam == IDM_UNKNOWN_09C4) || (wParam == IDM_UNKNOWN_09C5)) {
                        if (((uint)gd.grBits >> 0xb & 1) == 0) {
                            StartTutor(0);
                            return;
                        }
                        ShowTutor(1);
                        return;
                    }
                    if (wParam == IDM_TOOL_NEW_GAME)
                        goto LAB_1020_3083;
                    if (wParam == IDM_TOOL_OPEN_GAME)
                        goto LAB_1020_4a53;
                    if ((wParam != IDM_TURN_END_A) && (wParam != IDM_TURN_END_B)) {
                        if (wParam == IDM_UNKNOWN_0EE2) {
                            SendMessage(hwnd, WM_CLOSE, 0, 0);
                            return;
                        }
                        if (((((wParam == IDM_SCAN_ZOOM_0) || (wParam == IDM_SCAN_ZOOM_1)) || (wParam == IDM_SCAN_ZOOM_2)) ||
                             (((wParam == IDM_SCAN_ZOOM_3 || (wParam == IDM_SCAN_ZOOM_4)) ||
                               ((wParam == IDM_SCAN_ZOOM_5 || ((wParam == IDM_SCAN_ZOOM_6 || (wParam == IDM_SCAN_ZOOM_7)))))))) ||
                            (wParam == IDM_SCAN_ZOOM_8)) {
                            if (hwndScanner != 0) {
                                uVar10 = GetASubMenu(hwnd, 1);
                                HVar12 = GetSubMenu(uVar10, 3);
                                CheckMenuItem(HVar12, iScanZoom + 4, 0x400);
                                GetClientRect(hwndScanner, &rc);
                                sVar7 = ScanToPt(rc.right);
                                rc.right = sVar7 >> 1;
                                sVar13 = ScanToPt(rc.bottom);
                                sVar7 = xScanTop;
                                rc.bottom = sVar13 >> 1;
                                iVar15 = dGalInv - yScanTop;
                                iScanZoom = wParam - IDM_SCAN_ZOOM_4;
                                CheckMenuItem(HVar12, wParam - IDM_SCAN_ZOOM_0, 0x408);
                                DrawMenuBar(hwnd);
                                SetScanScrollBars(hwndScanner);
                                InvalidateRect(hwndScanner, (RECT *)0x0, 1);
                                if (sel.scan.grobj == grobjNone) {
                                    pt.x = sVar7 + rc.right;
                                    pt.y = iVar15 - rc.bottom;
                                } else {
                                    pt.x = sel.scan.pt.x;
                                    pt.y = sel.scan.pt.y;
                                }
                                pt_00.y = pt.y;
                                pt_00.x = pt.x;
                                CtrPointScan(pt_00, 0);
                                return;
                            }
                            sVar7 = 0x10;
                            pcVar9 = PszFormatIds(idsCantChangeZoomFactorUntilGameOpen, (short *)0x0);
                            AlertSz(pcVar9, sVar7);
                            return;
                        }
                        if (wParam == IDM_UNKNOWN_0FA1) {
                            if (hwndScanner == 0) {
                                return;
                            }
                            gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfffe | 1;
                            RestoreSelection();
                            RefitFrameChildren();
                            gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfffe;
                            InvalidateRect(hwndScanner, (RECT *)0x0, 1);
                            UpdateWindow(hwndScanner);
                            return;
                        }
                        if ((wParam == IDM_UNKNOWN_1068) || (wParam == IDM_UNKNOWN_1069)) {
                            if (idPlayer == -1) {
                                return;
                            }
                            pvVar27 = MakeProcInstance(FindDlg, hInst);
                            DialogBox(0, IDD_FIND, hwnd, pvVar27);
                            FreeProcInstance(pvVar27);
                            return;
                        }
                        if ((((((wParam == IDM_FILE_MRU1) || (wParam == IDM_FILE_MRU2)) || (wParam == IDM_FILE_MRU3)) ||
                              ((wParam == IDM_FILE_MRU4 || (wParam == IDM_FILE_MRU5)))) ||
                             (wParam == IDM_FILE_MRU6)) ||
                            (((wParam == IDM_FILE_MRU7 || (wParam == IDM_FILE_MRU8)) || (wParam == IDM_FILE_MRU9)))) {
                            if ((((uint)gd.grBits >> 0xb & 1) != 0) && (sVar7 = FAskKillTutor(), sVar7 == 0)) {
                                return;
                            }
                            if (((char *)vrgszMRU == (char *)0x0) && (vrgszMRU._2_2_ == 0)) {
                                return;
                            }
                            if (((char *)vrgszMRU)[(wParam + 0xef34) * 0x100] == '\0') {
                                return;
                            }
                            local_22 = (PLANET *)idPlayer;
                            __fstrcpy(local_124, (char *)CONCAT22(vrgszMRU._2_2_, (char *)vrgszMRU + (wParam + 0xef34) * 0x100));
                            local_24 = _strrchr(local_124, 0x2e);
                            if ((local_24 == (PLANET *)0x0) || (sVar7 = __access(local_124, 0), sVar7 == -1)) {
                                _strcpy((char *)szWork, local_124);
                                sVar7 = 0x10;
                                pcVar9 = PszFormatIds(idsCantOpenFile, (short *)0x0);
                                AlertSz(pcVar9, sVar7);
                                return;
                            }
                            ini.wFlags = ini.wFlags & 0xfffe | 1;
                            DestroyCurGame();
                            _strcpy((char *)szBase, local_124);
                            sVar7 = FOpenGame(hwnd, 0);
                            if (sVar7 < 1) {
                                return;
                            }
                            InitializeMenu(0);
                            CreateChildWindows();
                            if (uTimerId == 0) {
                                PostMessage(hwnd, WM_COMMAND, 0xfa1, 0);
                            }
                            if ((game.wCrap >> 3 & 1) == 0) {
                                return;
                            }
                            if (idPlayer != 0) {
                                return;
                            }
                            StartTutor(0);
                            return;
                        }
                        if (((wParam != IDM_DEBUG_GEN_10_TURNS) && (wParam != IDM_DEBUG_GEN_100_TURNS)) && ((HBRUSH *)wParam != (HBRUSH *)&hbrCargo))
                            goto MDI_Default_4;
                        goto LAB_1020_3f6e;
                    }
                }
            }
            if (hwndScanner == 0) {
                sVar7 = 0x10;
                pcVar9 = PszFormatIds(idsGameCurrentlyLoaded, (short *)0x0);
                AlertSz(pcVar9, sVar7);
                return;
            }
            if (idPlayer == -1) {
                FWriteDataFile((char *)szBase, -1, 0);
                return;
            }
            sVar7 = FNewTurnAvail(idPlayer);
            if (sVar7 == 0) {
                local_22 = (PLANET *)(uint)(wParam == IDM_TURN_END_B);
                gd.grBits._0_2_ = (uint)gd.grBits & 0xffef | (int)local_22 << 4;
                FWriteLogFile((char *)szBase, idPlayer);
                FWriteHistFile(idPlayer);
                return;
            }
            goto MDI_LNewTurnAvail;
        }
        goto LAB_1020_3f6e;
    }
MDI_LWaitForTurn:
    if (((PLANET *)lpPlanets == (PLANET *)0x0) && (lpPlanets._2_2_ == (PLANET *)0x0)) {
        return;
    }
    if (idPlayer == -1) {
        return;
    }
    if ((game.wCrap >> 2 & 1) != 0) {
        return;
    }
    sVar7 = FNewTurnAvail(idPlayer);
    if (sVar7 == 0) {
        gd.grBits._0_2_ = (uint)gd.grBits & 0xffef | 0x10;
        FWriteLogFile((char *)szBase, idPlayer);
        FWriteHistFile(idPlayer);
        HVar14 = hwndFrame;
        pcVar9 = PszGetCompressedString(idsWaitingNewTurn);
        SetWindowText(HVar14, pcVar9);
        ShowWindow(hwndFrame, 2);
        uTimerId = SetTimer(0xe, 10000, lpfnHostTimerProc._2_2_, (fn_lpfnHostTimerProc *)lpfnHostTimerProc);
        uTimerType = 0xe;
        HostTimerProc(0, WM_NULL, uTimerId, 0);
        return;
    }
MDI_LNewTurnAvail:
    FWriteHistFile(idPlayer);
    if (game.fDirty == 0) {
        sVar7 = 0x40;
        pcVar9 = PszFormatIds(idsNewTurnAvailable, (short *)0x0);
        AlertSz(pcVar9, sVar7);
    } else {
        sVar7 = 0x31;
        pcVar9 = PszFormatIds(idsSorryTurnHasAlreadyGeneratedAnyChanges, (short *)0x0);
        local_22 = (PLANET *)AlertSz(pcVar9, sVar7);
        if (local_22 == (PLANET *)0x2) {
            return;
        }
    }
    _wsprintf(szExt, MPCTD);
    game.fDirty = 0;
    DestroyCurGame();
    sVar7 = FLoadGame((char *)szBase, szExt);
    if (sVar7 == 0) {
        sVar7 = 0x10;
        pcVar9 = PszFormatIds(idsUnableOpenNewTurnFile, (short *)0x0);
        AlertSz(pcVar9, sVar7);
    } else {
        CreateChildWindows();
        SendMessage(hwndFrame, WM_COMMAND, 0xfa1, 0);
    }
    return;
}

// ======================================================================
// Function: InitializeMenu
// Address: 1020:5376
// Segment: MEMORY_MDI
// ======================================================================

void InitializeMenu(HMENU hmenu)

{
    ushort uVar1;
    UINT   UVar2;
    HMENU  HVar3;
    short  sVar4;
    HMENU  hmenuSub;
    short  i;
    short  cMenu;

    if (hmenu == 0) {
        hmenu = GetMenu(hwndFrame);
    }
    uVar1 = GetASubMenu(hwndFrame, 0);
    for (i = 0x10cc; i < 0x10d5; i = i + 1) {
        DeleteMenu(uVar1, i, 0);
    }
    i = 0;
    while ((i < 9 && (((char *)vrgszMRU)[i * 0x100] != '\0'))) {
        szWork[0] = '&';
        szWork[1] = (char)i + '1';
        szWork[2] = ' ';
        __fstrcpy(szWork + 3, (char *)CONCAT22(vrgszMRU._2_2_, (char *)vrgszMRU + i * 0x100));
        InsertMenu(uVar1, i + 9, 0x400, i + 0x10cc, szWork);
        i = i + 1;
    }
    if ((szBase[0] == '\0') || ((game.wCrap >> 2 & 1) != 0)) {
        UVar2 = 3;
    } else {
        UVar2 = 0;
    }
    EnableMenuItem(hmenu, 0x6a, UVar2);
    if (szBase[0] == '\0') {
        UVar2 = 3;
    } else {
        UVar2 = 0;
    }
    EnableMenuItem(hmenu, 0x69, UVar2);
    if ((szBase[0] == '\0') || (((game.wCrap >> 2 & 1) != 0 && ((lSaltCur._2_2_ < 0 || ((lSaltCur._2_2_ < 1 && ((int)lSaltCur == 0)))))))) {
        UVar2 = 3;
    } else {
        UVar2 = 0;
    }
    EnableMenuItem(hmenu, 0x10e, UVar2);
    if ((szBase[0] == '\0') || ((game.wCrap >> 2 & 1) != 0)) {
        UVar2 = 3;
    } else {
        UVar2 = 0;
    }
    EnableMenuItem(hmenu, 0x7de, UVar2);
    if ((szBase[0] == '\0') || ((game.wCrap >> 2 & 1) != 0)) {
        UVar2 = 3;
    } else {
        UVar2 = 0;
    }
    EnableMenuItem(hmenu, 0xedb, UVar2);
    uVar1 = GetASubMenu(hwndFrame, 1);
    if (gd.grBits._2_2_ < 0) {
        UVar2 = 8;
    } else {
        UVar2 = 0;
    }
    CheckMenuItem(uVar1, 0xb3, UVar2);
    if ((grbitScan & 0x2000) == 0) {
        UVar2 = 0;
    } else {
        UVar2 = 8;
    }
    CheckMenuItem(uVar1, 0x98d, UVar2);
    if (hwndScanner == 0) {
        HVar3 = GetMenu(hwndFrame);
        EnableMenuItem(HVar3, 1, 0x403);
    } else {
        HVar3 = GetMenu(hwndFrame);
        EnableMenuItem(HVar3, 1, 0x400);
        uVar1 = GetASubMenu(hwndFrame, 1);
        HVar3 = GetSubMenu(uVar1, 3);
        CheckMenuItem(HVar3, iScanZoom + 4, 0x408);
        sVar4 = GetMenuItemCount(HVar3);
        for (i = 0; i < sVar4; i = i + 1) {
            EnableMenuItem(HVar3, i, 0x400);
        }
        uVar1 = GetASubMenu(hwndFrame, 1);
        HVar3 = GetSubMenu(uVar1, 4);
        CheckMenuItem(HVar3, iWindowLayout, 0x408);
    }
    DrawMenuBar(hwndFrame);
    return;
}

// ======================================================================
// Function: EnsureAis
// Address: 1020:56bc
// Segment: MEMORY_MDI
// ======================================================================

void EnsureAis(void)

{
    bool  bVar1;
    short sVar2;
    uint  uVar3;
    uint  uVar4;
    short sVar5;
    MDPLR rgmdplr[16];
    short iPlayer;
    short fSubmitSav;
    short fWorkDone;
    short fOpened;
    short fErrSav;
    short fHostSav;

    uVar3 = (uint)gd.grBits >> 4;
    bVar1 = false;
    if (((uint)gd.grBits >> 10 & 1) == 0) {
        uVar4 = (uint)gd.grBits >> 3;
        if (((uint)gd.grBits >> 3 & 1) == 0) {
            DestroyCurGame();
            FLoadGame((char *)szBase, (char *)0x3f0);
        }
        sVar2 = fFileErrSilent;
        for (iPlayer = 0; iPlayer < game.cPlayer; iPlayer = iPlayer + 1) {
            (rgmdplr + iPlayer)->wFlags = *(ushort *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0);
        }
        gd.grBits._0_2_ = (uint)gd.grBits & 0xffef | 0x10;
        fFileErrSilent = 1;
        for (iPlayer = 0; iPlayer < game.cPlayer; iPlayer = iPlayer + 1) {
            sVar5 = MulDiv(0x154, iPlayer + 1, game.cPlayer);
            UpdateProgressGauge(sVar5);
            if (((rgmdplr + iPlayer)->wFlags >> 9 & 1) != 0) {
                bVar1 = true;
                gd.grBits._0_2_ = (uint)gd.grBits & 0xfff5 | 10;
                sVar5 = FOpenFile(dtLog, iPlayer, 0x20);
                gd.grBits._0_2_ = (uint)gd.grBits & 0xfff5 | (uVar4 & 1) << 3;
                if (sVar5 == 0) {
                    DoAiTurn(iPlayer, (rgmdplr + iPlayer)->wFlags);
                } else {
                    StreamClose();
                }
            }
        }
        gd.grBits._0_2_ = (uint)gd.grBits & 0xffef | (uVar3 & 1) << 4;
        if (bVar1) {
            DestroyCurGame();
            FLoadGame((char *)szBase, (char *)0x3f4);
        }
        gd.grBits._0_2_ = (uint)gd.grBits & 0xfbff | 0x400;
        fFileErrSilent = sVar2;
    }
    return;
}

// ======================================================================
// Function: GetASubMenu
// Address: 1020:589a
// Segment: MEMORY_MDI
// ======================================================================

ushort GetASubMenu(HWND hwnd, short iMenu)

{
    undefined1 *puVar1;
    BOOL        BVar2;
    int         iVar3;
    HMENU       HVar4;
    undefined1 *puVar5;
    undefined2  uVar6;
    undefined2  unaff_SS;
    HMENU       hmenu;
    short       fChildMenu;

    uVar6 = 0x1020;
    puVar1 = &stack0xfff4;
    if (hwndActive != 0) {
        uVar6 = 0x14f8;
        BVar2 = IsZoomed(hwndActive);
        puVar5 = &stack0xfff2;
        puVar1 = &stack0xfff2;
        if (BVar2 != 0) {
            iVar3 = 1;
            goto LAB_1020_58c7;
        }
    }
    puVar5 = puVar1;
    iVar3 = 0;
LAB_1020_58c7:
    *(HWND *)(puVar5 + -2) = hwnd;
    *(undefined2 *)(puVar5 + -4) = uVar6;
    *(char **)(puVar5 + -6) = (char *)szWork + 0x12e;
    HVar4 = GetMenu(*(HWND *)(puVar5 + -2));
    *(HMENU *)(puVar5 + -2) = HVar4;
    *(short *)(puVar5 + -4) = iMenu + iVar3;
    *(undefined2 *)(puVar5 + -6) = 0x14f8;
    *(char **)(puVar5 + -8) = (char *)szWork + 0x140;
    HVar4 = GetSubMenu(*(HMENU *)(puVar5 + -2), *(short *)(puVar5 + -4));
    return HVar4;
}

// ======================================================================
// Function: FOpenGame
// Address: 1020:58f4
// Segment: MEMORY_MDI
// ======================================================================

/* WARNING: Variable defined which should be unmapped: ofn */
/* WARNING: Removing unreachable block (ram,0x10205d80) */

short FOpenGame(HWND hwnd, short fRaceOnly)

{
    StringId    ids;
    int         iVar1;
    short       sVar2;
    char       *pcVar3;
    uint        uVar4;
    undefined1 *puVar5;
    undefined2  uVar6;
    undefined2  unaff_SS;
    short       grobjIni;
    short       fRet;
    char        szFilter[256];
    char        szFileTitle[256];
    char       *pch;
    char        szFile[256];
    ushort      i;
    OFN         ofn;

    if ((ini.wFlags & 1) == 0) {
        szFile[0] = '\0';
        if (fRaceOnly == 0) {
            ids = idsStarsGameFilesMHstRStars;
        } else {
            ids = idsStarsGameFilesRFiles;
        }
        CchGetString(ids, szFilter);
        for (i = 0; szFilter[i] != '\0'; i = i + 1) {
            if (szFilter[i] == '|') {
                szFilter[i] = '\0';
            }
        }
        _memset(&ofn, 0, 0x48);
        ofn.lStructSize._0_2_ = 0x48;
        ofn.lStructSize._2_2_ = 0;
        ofn.hwndOwner = hwnd;
        ofn.lpstrFilter._0_2_ = szFilter;
        ofn.nFilterIndex._0_2_ = 1;
        ofn.nFilterIndex._2_2_ = 0;
        ofn.lpstrFile._0_2_ = szFile;
        ofn.nMaxFile._0_2_ = 0x100;
        ofn.nMaxFile._2_2_ = 0;
        ofn.lpstrFileTitle._0_2_ = szFileTitle;
        ofn.nMaxFileTitle._0_2_ = 0x100;
        ofn.nMaxFileTitle._2_2_ = 0;
        ofn.lpstrInitialDir._0_2_ = (char *)szDirName;
        ofn.lpstrInitialDir._2_2_ = 0x1120;
        ofn.Flags._0_2_ = 0x1804;
        ofn.Flags._2_2_ = 0;
        uVar6 = 0x14f8;
        iVar1 = GetOpenFileName();
        puVar5 = &stack0xfca4;
        if (iVar1 == 0) {
            return 0;
        }
    } else {
        _strcpy(szFile, (char *)szBase);
        pcVar3 = _strrchr((char *)szBase, 0x5c);
        *pcVar3 = '\0';
        pch = _strrchr(szFile, 0x2e);
        if (pch == (char *)0x0) {
            SetSzWorkFromDt(dtHost, -1);
            _strcpy(szFile, (char *)szWork);
            pch = _strrchr(szFile, 0x2e);
        }
        puVar5 = &stack0xfca8;
        uVar6 = 0x1118;
        ofn.nFileExtension = (ushort)(pch + (1 - (int)szFile));
        ofn.nFileOffset = 0;
        fFileErrSilent = 1;
    }
    szDirName[0] = '\0';
    *(uint *)(puVar5 + -2) = (uint)(fRaceOnly == 0);
    *(char **)(puVar5 + -4) = szFile + ofn.nFileOffset;
    *(undefined2 *)(puVar5 + -6) = uVar6;
    *(undefined2 *)(puVar5 + -8) = 0x5ac0;
    fRet = FWasRaceFile(*(char **)(puVar5 + -4), *(short *)(puVar5 + -2));
    if (fRaceOnly == 0) {
        if (fRet == 0) {
            szFile[ofn.nFileExtension - 1] = '\0';
            *(undefined2 *)(puVar5 + -2) = 0x1020;
            *(undefined2 *)(puVar5 + -4) = 0x5b78;
            DestroyCurGame();
            *(char **)(puVar5 + -2) = szFile;
            *(char **)(puVar5 + -4) = (char *)szBase;
            *(undefined2 *)(puVar5 + -6) = 0x1070;
            *(undefined2 *)(puVar5 + -8) = 0x5b86;
            _strcpy(*(char **)(puVar5 + -4), *(char **)(puVar5 + -2));
            *(char **)(puVar5 + -2) = szFile + ofn.nFileExtension;
            *(char **)(puVar5 + -4) = szFile;
            *(undefined2 *)(puVar5 + -6) = 0x1118;
            uVar6 = 0x1070;
            *(undefined2 *)(puVar5 + -8) = 0x5b9d;
            sVar2 = FLoadGame(*(char **)(puVar5 + -4), *(char **)(puVar5 + -2));
            if (sVar2 == 0) {
                if ((ini.wFlags & 1) != 0) {
                    ini.wFlags = 0;
                    fFileErrSilent = 0;
                }
                fRet = 0;
            } else {
                if ((ini.wFlags & 1) != 0) {
                    fFileErrSilent = 0;
                    ini.wFlags = ini.wFlags & 0xfffe;
                    *(undefined2 *)(puVar5 + -2) = 0x5c;
                    *(char **)(puVar5 + -4) = szFile;
                    *(undefined2 *)(puVar5 + -6) = 0x1070;
                    *(undefined2 *)(puVar5 + -8) = 0x5bf6;
                    pcVar3 = _strrchr(*(char **)(puVar5 + -4), *(short *)(puVar5 + -2));
                    pch = pcVar3;
                    if (pcVar3 != (char *)0x0) {
                        *(int *)(puVar5 + -2) = (int)pcVar3 - (int)szFile;
                        *(char **)(puVar5 + -4) = szFile;
                        *(undefined2 *)(puVar5 + -6) = 0x252;
                        *(undefined2 *)(puVar5 + -8) = 0x1118;
                        *(undefined2 *)(puVar5 + -10) = 0x5c25;
                        _strncpy(*(char **)(puVar5 + -6), *(char **)(puVar5 + -4), *(ushort *)(puVar5 + -2));
                        *(undefined1 *)(((int)pcVar3 - (int)szFile) + 0x252) = 0;
                    }
                    uVar6 = 0x1118;
                    if ((idPlayer == -1) && ((ini.wFlags >> 3 & 1) == 0)) {
                        gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfffb | 4;
                    }
                    if ((((int)game.lid != (int)ini.lid) || (game.lid._2_2_ != ini.lid._2_2_)) || (ini.turn < game.turn)) {
                        ini.wFlags = ini.wFlags & 0xffef;
                    }
                }
                sel.grobjFull = grobjNone;
                sel.grobj = grobjNone;
                sel.iwpAct = -1;
                sel.id = -1;
                sel.scan.grobjFull = grobjNone;
                sel.scan.grobj = grobjNone;
                sel.scan.iwp = -1;
                sel.scan.ifl = -1;
                sel.scan.idpl = -1;
                fOrdersVis = 0;
                *(undefined2 *)(puVar5 + -2) = uVar6;
                uVar6 = 0x1020;
                *(undefined2 *)(puVar5 + -4) = 0x5cc9;
                CreateChildWindows();
                if (idPlayer == -1) {
                    if ((hwndTitle != 0) && (fFreeingTitle == 0)) {
                        fFreeingTitle = 1;
                        *(HWND *)(puVar5 + -2) = hwndTitle;
                        *(undefined2 *)(puVar5 + -4) = 0x1020;
                        uVar6 = 0x14f8;
                        *(undefined2 *)(puVar5 + -6) = 0x5d5a;
                        DestroyWindow(*(HWND *)(puVar5 + -2));
                        hwndTitle = 0;
                    }
                    *(undefined2 *)(puVar5 + -2) = uVar6;
                    *(undefined2 *)(puVar5 + -4) = 0x5d65;
                    BringUpHostDlg();
                    fRet = 0;
                } else {
                    uVar4 = ini.wFlags >> 5;
                    *(HWND *)(puVar5 + -2) = hwndFrame;
                    *(undefined2 *)(puVar5 + -4) = 0x111;
                    *(undefined2 *)(puVar5 + -6) = 0xfa1;
                    *(undefined2 *)(puVar5 + -8) = 0;
                    *(undefined2 *)(puVar5 + -10) = 0;
                    *(undefined2 *)(puVar5 + -0xc) = 0x1020;
                    *(undefined2 *)(puVar5 + -0xe) = 0x5d00;
                    SendMessage(*(HWND *)(puVar5 + -2), *(WMType *)(puVar5 + -4), *(WPARAM *)(puVar5 + -6), *(LPARAM *)(puVar5 + -10));
                    if (((uVar4 & 0xf) == 0) || ((ini.wFlags >> 5 & 0xf) != 0)) {
                        ini.wFlags = ini.wFlags & 0xfe1f;
                        if (cPlanet != 0) {
                            *(undefined2 *)(puVar5 + -2) = 0x14f8;
                            *(undefined2 *)(puVar5 + -4) = 0x5d92;
                            FFindSomethingAndSelectIt();
                        }
                        fRet = 1;
                    } else {
                        fRet = 1;
                    }
                }
            }
        } else {
            if ((((ini.wFlags & 1) != 0) && ((int)vSerialNumber == 0)) && (vSerialNumber._2_2_ == 0)) {
                fRet = -1;
            }
            fFileErrSilent = 0;
            ini.wFlags = ini.wFlags & 0xfffe;
            if (fRet == -1) {
                fRet = -1;
            } else {
                *(undefined2 *)(puVar5 + -2) = 0;
                *(undefined2 *)(puVar5 + -4) = 0;
                *(HWND *)(puVar5 + -6) = hwnd;
                *(undefined2 *)(puVar5 + -8) = 0x1020;
                *(undefined2 *)(puVar5 + -10) = 0x5b5b;
                RaceCreationWizard(*(HWND *)(puVar5 + -6), *(short *)(puVar5 + -4), *(short *)(puVar5 + -2));
                fRet = 0;
            }
        }
    } else if (0 < fRet) {
        *(char **)(puVar5 + -2) = szFile + ofn.nFileOffset;
        *(char **)(puVar5 + -4) = (char *)szRaceFile;
        *(undefined2 *)(puVar5 + -6) = 0x1020;
        *(undefined2 *)(puVar5 + -8) = 0x5aed;
        _strcpy(*(char **)(puVar5 + -4), *(char **)(puVar5 + -2));
    }
    return fRet;
}

// ======================================================================
// Function: FWasRaceFile
// Address: 1020:5da8
// Segment: MEMORY_MDI
// ======================================================================

/* WARNING: Variable defined which should be unmapped: fRet */

short FWasRaceFile(char *szFile, short fChkPass)

{
    PLAYER *pPVar1;
    PLAYER *pPVar2;
    char    cVar3;
    short (*pasVar4)[9];
    undefined2 uVar5;
    undefined2 uVar6;
    ushort     uVar7;
    short      sVar8;
    char      *sz;
    ushort     uVar9;
    int        iVar10;
    PLAYER    *pPVar11;
    PLAYER    *pPVar12;
    short      sVar13;
    short      fSav;
    short      fRet;
    short      env[9];
    short (*penvMemSav)[9];
    PLAYER plr;
    long   lSaltSav;
    short  idsError;

    sVar13 = fFileErrSilent;
    pasVar4 = penvMem;
    idsError = -1;
    fRet = 0;
    fFileErrSilent = 1;
    penvMem = &env;
    sVar8 = __setjmp(env);
    uVar7 = wVersFile;
    if (sVar8 == 0) {
        StreamOpen(szFile, 0x20);
        ReadRt();
        if ((((hdrCur.wFlags >> 10 == 8) && ((uint)rgbCur._8_2_ >> 0xc == 2)) && (0x30 < ((uint)rgbCur._8_2_ >> 5 & 0x7f))) &&
            (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x54)) {
            uVar7._0_1_ = rgbCur[8];
            uVar7._1_1_ = rgbCur[9];
            wVersFile._0_1_ = rgbCur[8];
            wVersFile._1_1_ = rgbCur[9];
            if (((rgbCur._14_2_ & 0xff) == 5) && (ReadRt(), uVar7 = wVersFile, hdrCur.wFlags >> 10 == 6)) {
                idsError = 3;
                ReadRtPlr(&plr, (byte *)rgbCur);
                ReadRt();
                uVar7 = wVersFile;
                if ((hdrCur.wFlags >> 10 == 0) && (uVar9 = IRaceChecksum(&plr), uVar6 = lSaltCur._2_2_, uVar5 = (int)lSaltCur, lSaltCur._0_2_ = uVar5,
                                                   lSaltCur._2_2_ = uVar6, uVar7 = wVersFile, rgbCur._0_2_ == uVar9)) {
                    lSaltCur._0_2_ = (int)plr.lSalt;
                    lSaltCur._2_2_ = plr.lSalt._2_2_;
                    if ((fChkPass == 0) || (sVar8 = FCheckPassword(), sVar8 != 0)) {
                        if (((int)plr.lSalt == 0) && (plr.lSalt._2_2_ == 0)) {
                            szRacePass[0] = '\0';
                            lSaltCur._0_2_ = uVar5;
                            lSaltCur._2_2_ = uVar6;
                        } else {
                            lSaltCur._0_2_ = uVar5;
                            lSaltCur._2_2_ = uVar6;
                            _strcpy((char *)szRacePass, (char *)szPassLast);
                        }
                        pPVar11 = &plr;
                        pPVar12 = (PLAYER *)&vplr;
                        for (iVar10 = 0x60; iVar10 != 0; iVar10 = iVar10 + -1) {
                            pPVar2 = pPVar12;
                            pPVar12 = &pPVar12->cPlanet;
                            pPVar1 = pPVar11;
                            pPVar11 = &pPVar11->cPlanet;
                            cVar3 = pPVar1->cShDef;
                            pPVar2->iPlayer = pPVar1->iPlayer;
                            pPVar2->cShDef = cVar3;
                        }
                        _strcpy((char *)szRaceFile, szFile);
                        StreamClose();
                        penvMem = pasVar4;
                        fFileErrSilent = sVar13;
                        return 1;
                    }
                    fRet = -1;
                    lSaltCur._0_2_ = uVar5;
                    lSaltCur._2_2_ = uVar6;
                    uVar7 = wVersFile;
                }
            }
        } else {
            idsError = 0xd;
            fRet = -1;
            uVar7 = wVersFile;
        }
    }
    wVersFile = uVar7;
    StreamClose();
    penvMem = pasVar4;
    fFileErrSilent = sVar13;
    if ((sVar13 == 0) && (idsError != -1)) {
        _strcpy((char *)szWork, szFile);
        sVar13 = 0x10;
        sz = PszFormatIds(idsError, (short *)0x0);
        AlertSz(sz, sVar13);
    }
    return fRet;
}

// ======================================================================
// Function: BringUpHostDlg
// Address: 1020:5ffc
// Segment: MEMORY_MDI
// ======================================================================

void BringUpHostDlg(void)

{
    short       sVar1;
    short       sVar2;
    undefined1 *puVar3;
    undefined1 *puVar4;
    undefined2  uVar5;
    undefined2  unaff_SS;
    fn_lpProc  *pfVar6;
    short       fRet;
    fn_lpProc  *lpProc;
    POINT       pt;

    if (((uint)gd.grBits >> 3 & 1) == 0) {
        if ((gd.grBits._2_2_ >> 5 & 1) == 0) {
            FMarkFile(dtHost, -1, 1, 1);
        }
        gd.grBits._0_2_ = (uint)gd.grBits & 0xfff7 | 8;
    }
    puVar4 = &stack0xffee;
    puVar3 = &stack0xffee;
    uVar5 = 0x14f8;
    ShowWindow(hwndFrame, 0);
    if ((ini.wFlags >> 2 & 1) == 0) {
        while (true) {
            *(undefined2 *)(puVar4 + -2) = 0x1020;
            *(undefined2 *)(puVar4 + -4) = 0x6c16;
            *(HINSTANCE *)(puVar4 + -6) = hInst;
            *(undefined2 *)(puVar4 + -8) = uVar5;
            *(undefined2 *)(puVar4 + -10) = 0x6094;
            pfVar6 = MakeProcInstance(*(FARPROC *)(puVar4 + -4), *(HINSTANCE *)(puVar4 + -6));
            *(HINSTANCE *)(puVar4 + -2) = hInst;
            *(undefined2 *)(puVar4 + -4) = 0;
            *(undefined2 *)(puVar4 + -6) = 0x73;
            *(HWND *)(puVar4 + -8) = hwndFrame;
            lpProc._2_2_ = (undefined2)((ulong)pfVar6 >> 0x10);
            *(undefined2 *)(puVar4 + -10) = lpProc._2_2_;
            lpProc._0_2_ = (fn_lpProc *)pfVar6;
            *(fn_lpProc **)(puVar4 + -0xc) = (fn_lpProc *)lpProc;
            *(undefined2 *)(puVar4 + -0xe) = 0x14f8;
            *(undefined2 *)(puVar4 + -0x10) = 0x60b5;
            sVar1 = DialogBox(*(HINSTANCE *)(puVar4 + -4), *(DialogId *)(puVar4 + -6), *(HWND *)(puVar4 + -8), *(FARPROC *)(puVar4 + -0xc));
            *(undefined2 *)(puVar4 + -2) = lpProc._2_2_;
            *(fn_lpProc **)(puVar4 + -4) = (fn_lpProc *)lpProc;
            *(undefined2 *)(puVar4 + -6) = 0x14f8;
            uVar5 = 0x14f8;
            *(undefined2 *)(puVar4 + -8) = 0x60c3;
            FreeProcInstance(*(FARPROC *)(puVar4 + -4));
            puVar3 = puVar4;
            if (sVar1 == -1)
                break;
            if (sVar1 == 0) {
                if ((gd.grBits._2_2_ >> 5 & 1) == 0) {
                    *(undefined2 *)(puVar4 + -2) = 0;
                    *(undefined2 *)(puVar4 + -4) = 1;
                    *(undefined2 *)(puVar4 + -6) = 0xffff;
                    *(undefined2 *)(puVar4 + -8) = 2;
                    *(undefined2 *)(puVar4 + -10) = 0x14f8;
                    uVar5 = 0x1070;
                    *(undefined2 *)(puVar4 + -0xc) = 0x61b1;
                    FMarkFile(*(DtFileType *)(puVar4 + -8), *(short *)(puVar4 + -6), *(short *)(puVar4 + -4), *(short *)(puVar4 + -2));
                }
                gd.grBits._0_2_ = (uint)gd.grBits & 0xfff7;
                *(undefined2 *)(puVar4 + -2) = uVar5;
                *(undefined2 *)(puVar4 + -4) = 0x61c5;
                DestroyCurGame();
                if ((ini.wFlags >> 3 & 1) != 0) {
                    return;
                }
                *(undefined2 *)(puVar4 + -2) = 0;
                *(undefined2 *)(puVar4 + -4) = 0x1070;
                *(undefined2 *)(puVar4 + -6) = 0x61e2;
                sVar1 = GetSystemMetrics(*(short *)(puVar4 + -2));
                *(undefined2 *)(puVar4 + -4) = 1;
                *(undefined2 *)(puVar4 + -6) = 0x14f8;
                *(undefined2 *)(puVar4 + -8) = 0x61ee;
                sVar2 = GetSystemMetrics(*(short *)(puVar4 + -4));
                *(undefined2 *)(puVar4 + -6) = 0x1120;
                *(undefined2 *)(puVar4 + -8) = 0x22a;
                *(undefined2 *)(puVar4 + -10) = 0x1120;
                *(undefined2 *)(puVar4 + -0xc) = 0x3f8;
                *(undefined2 *)(puVar4 + -0xe) = 0x9000;
                *(undefined2 *)(puVar4 + -0x10) = 0;
                *(undefined2 *)(puVar4 + -0x12) = 0;
                *(undefined2 *)(puVar4 + -0x14) = 0;
                *(short *)(puVar4 + -0x16) = sVar1;
                *(short *)(puVar4 + -0x18) = sVar2;
                *(HWND *)(puVar4 + -0x1a) = hwndFrame;
                *(undefined2 *)(puVar4 + -0x1c) = 0;
                *(HINSTANCE *)(puVar4 + -0x1e) = hInst;
                *(undefined2 *)(puVar4 + -0x20) = 0;
                *(undefined2 *)(puVar4 + -0x22) = 0;
                *(undefined2 *)(puVar4 + -0x24) = 0x14f8;
                *(undefined2 *)(puVar4 + -0x26) = 0x622e;
                hwndTitle = CreateWindow(*(LPCSTR *)(puVar4 + -8), *(LPCSTR *)(puVar4 + -0xc), *(DWORD *)(puVar4 + -0x10), *(short *)(puVar4 + -0x12),
                                         *(short *)(puVar4 + -0x14), *(short *)(puVar4 + -0x16), *(short *)(puVar4 + -0x18), *(HWND *)(puVar4 + -0x1a),
                                         *(HMENU *)(puVar4 + -0x1c), *(HINSTANCE *)(puVar4 + -0x1e), *(void **)(puVar4 + -0x22));
                fFreeingTitle = 0;
                return;
            }
            do {
                uVar5 = 0x14f8;
                if ((gd.grBits._2_2_ >> 10 & 1) != 0) {
                    *(undefined2 *)(puVar3 + -2) = 0x14f8;
                    uVar5 = 0x1040;
                    *(undefined2 *)(puVar3 + -4) = 0x6138;
                    ShowProgressGauge();
                }
                *(undefined2 *)(puVar3 + -2) = uVar5;
                *(undefined2 *)(puVar3 + -4) = 0x613d;
                EnsureAis();
                *(undefined2 *)(puVar3 + -2) = 0x1020;
                uVar5 = 0x10b0;
                *(undefined2 *)(puVar3 + -4) = 0x6142;
                FGenerateTurn();
                puVar4 = puVar3;
                if (iPassCnt == 0)
                    break;
                iPassCnt = iPassCnt + -1;
                *(undefined2 *)(puVar3 + -2) = 0x10;
                *(undefined2 *)(puVar3 + -4) = 0x10b0;
                uVar5 = 0x14f8;
                *(undefined2 *)(puVar3 + -6) = 0x615a;
                sVar1 = GetAsyncKeyState(*(short *)(puVar3 + -2));
                puVar4 = puVar3 + -2;
                if (sVar1 < 0)
                    break;
                *(undefined2 *)(puVar3 + -4) = 0x11;
                *(undefined2 *)(puVar3 + -6) = 0x14f8;
                uVar5 = 0x14f8;
                *(undefined2 *)(puVar3 + -8) = 0x616b;
                sVar1 = GetAsyncKeyState(*(short *)(puVar3 + -4));
                puVar4 = puVar3 + -4;
                puVar3 = puVar3 + -4;
            } while (-1 < sVar1);
            iPassCnt = 0;
            *(undefined2 *)(puVar4 + -2) = uVar5;
            uVar5 = 0x1040;
            *(undefined2 *)(puVar4 + -4) = 0x6181;
            HideProgressGauge();
        }
    } else {
        ini.wFlags = ini.wFlags & 0xfffb;
    }
    *(HWND *)(puVar3 + -2) = hwndFrame;
    *(undefined2 *)(puVar3 + -4) = 2;
    *(undefined2 *)(puVar3 + -6) = 0x14f8;
    *(undefined2 *)(puVar3 + -8) = 0x60d9;
    ShowWindow(*(HWND *)(puVar3 + -2), *(short *)(puVar3 + -4));
    *(undefined2 *)(puVar3 + -2) = 0;
    *(undefined2 *)(puVar3 + -4) = 0xd;
    *(undefined2 *)(puVar3 + -6) = 10000;
    *(undefined2 *)(puVar3 + -8) = lpfnHostTimerProc._2_2_;
    *(fn_lpfnHostTimerProc **)(puVar3 + -10) = (fn_lpfnHostTimerProc *)lpfnHostTimerProc;
    *(undefined2 *)(puVar3 + -0xc) = 0x14f8;
    *(undefined2 *)(puVar3 + -0xe) = 0x60f2;
    uTimerId = SetTimer(*(HWND *)(puVar3 + -4), *(UINT *)(puVar3 + -6), *(UINT *)(puVar3 + -8), *(undefined2 *)(puVar3 + -10));
    uTimerType = 0xd;
    *(undefined2 *)(puVar3 + -2) = 0;
    *(undefined2 *)(puVar3 + -4) = 0;
    *(ushort *)(puVar3 + -6) = uTimerId;
    *(undefined2 *)(puVar3 + -8) = 0;
    *(undefined2 *)(puVar3 + -10) = 0;
    *(undefined2 *)(puVar3 + -0xc) = 0x14f8;
    *(undefined2 *)(puVar3 + -0xe) = 0x6114;
    HostTimerProc(*(HWND *)(puVar3 + -2), *(WMType *)(puVar3 + -4), *(ushort *)(puVar3 + -6), *(ulong *)(puVar3 + -10));
    return;
}

// ======================================================================
// Function: DrawHostDialog2
// Address: 1020:6240
// Segment: MEMORY_MDI
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10206505) */

void DrawHostDialog2(HWND hwnd, HDC hdcIn)

{
    short      sVar1;
    char      *pcVar2;
    int        iVar3;
    short      cLen;
    char      *pcVar4;
    char      *pcVar5;
    HWND       HVar6;
    uint       uVar7;
    uint       uVar8;
    uint       uVar9;
    int        iVar10;
    undefined2 unaff_SS;
    COLORREF   CVar11;
    DWORD      DVar12;
    ulong      uVar13;
    undefined2 uVar14;
    undefined2 uVar15;
    HDC        HVar16;
    char       szStat[30];
    short      x;
    COLORREF   crBackSav;
    RECT       rcDiamond;
    short      cch;
    short      dday;
    ushort     dmin;
    short      i;
    short      yCur;
    short      bkMode;
    ushort     dhour;
    HDC        hdc;
    ulong      dsec;

    if (hdcIn == 0) {
        hdc = GetDC(hwnd);
    } else {
        hdc = hdcIn;
    }
    sVar1 = SetBkMode(hdc, 2);
    CVar11 = SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
    SelectObject(hdc, rghfontArial8[1]);
    HVar16 = hdc;
    pcVar2 = PszGetCompressedString(idsN16);
    DVar12 = GetTextExtent(HVar16, pcVar2, 4);
    iVar10 = dyArial8 + 10 + (int)DVar12;
    yCur = 0x30;
    SetRect(&rcDiamond, 6, 0x30, dyArial8 + 7, dyArial8 + 0x31);
    for (i = 0; i < game.cPlayer; i = i + 1) {
        DrawDiamond(hdc, &rcDiamond, hbrBBlue);
        iVar3 = i + 1;
        pcVar2 = PszGetCompressedString(idsD2);
        cLen = _wsprintf(szWork, pcVar2, iVar3);
        RightTextOut(hdc, iVar10, yCur, (char *)szWork, cLen, 0);
        if (((short *)rgOut)[i] < 1) {
            uVar8 = 0x7f00;
        } else {
            uVar8 = 0x7f;
        }
        SetTextColor(hdc, (ulong)uVar8);
        CchGetString(((short *)rgOut)[i] + idsTurned, szStat);
        if ((gd.grBits2._2_2_ >> 6 & 1) == 0) {
            pcVar2 = szStat;
            pcVar4 = PszPlayerName(i, 1, 1, 1, 0, (PLAYER *)0x0);
            uVar14 = 0x1120;
            pcVar5 = PszGetCompressedString(idsSS);
            cch = _wsprintf(szWork, pcVar5, pcVar4, uVar14, pcVar2);
        } else {
            cch = _wsprintf(szWork, s_s_1120_03ff, szStat);
        }
        if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 4 & 1) != 0) {
            _strcat((char *)szWork, (char *)s___HACKER_1120_0403);
            cch = cch + 9;
        }
        TextOut(hdc, iVar10 + 4, yCur, szWork, cch);
        SetTextColor(hdc, CONCAT22(crWindowText._2_2_, (undefined2)crWindowText));
        OffsetRect(&rcDiamond, 0, dyArial8 + 4);
        yCur = yCur + dyArial8 + 4;
    }
    _wsprintf(szWork, PCTD, game.turn + 0x961);
    HVar6 = GetDlgItem(hwnd, IDC_U16_0x07E0);
    SetWindowText(HVar6, szWork);
    uVar15 = 0;
    uVar14 = 1000;
    DVar12 = GetTickCount();
    uVar13 = __aFuldiv(DVar12 - CONCAT22(ctickLast._2_2_, (undefined2)ctickLast), CONCAT22(uVar15, uVar14));
    uVar8 = (uint)uVar13;
    if (((int)(uVar13 >> 0x10) == 0) && (uVar8 < 0x3c)) {
        pcVar2 = PszGetCompressedString(idsDSeconds);
        _wsprintf(szWork, pcVar2, uVar8);
    } else {
        uVar13 = __aFuldiv(uVar13, 0x3c);
        uVar7 = (uint)uVar13;
        iVar10 = uVar8 + uVar7 * -0x3c;
        if (uVar7 < 0x3c) {
            pcVar2 = PszGetCompressedString(idsD02d);
            _wsprintf(szWork, pcVar2, uVar7, iVar10);
        } else {
            uVar8 = uVar7 / 0x3c;
            uVar7 = uVar7 % 0x3c;
            if (uVar8 < 0x18) {
                pcVar2 = PszGetCompressedString(idsD02d02d);
                _wsprintf(szWork, pcVar2, uVar8, uVar7, iVar10);
            } else {
                uVar9 = uVar8 / 0x18;
                uVar8 = uVar8 % 0x18;
                pcVar2 = PszGetCompressedString(idsDDaysD02d02d);
                _wsprintf(szWork, pcVar2, uVar9, uVar8, uVar7, iVar10);
            }
        }
    }
    HVar6 = GetDlgItem(hwnd, IDC_U16_0x07E1);
    SetWindowText(HVar6, szWork);
    SetBkMode(hdc, sVar1);
    SetBkColor(hdc, CVar11);
    if (hdcIn == 0) {
        ReleaseDC(hwnd, hdc);
    }
    return;
}

// ======================================================================
// Function: VerifyTurns
// Address: 1020:6686
// Segment: MEMORY_MDI
// ======================================================================

void VerifyTurns(void)

{
    int   iVar1;
    short sVar2;
    short sVar3;
    ulong uVar4;
    short fOut;
    short cOut;
    short i;
    short cAi;
    short idCur;
    short idsError;

    sVar2 = idPlayer;
    lpcd = LpAlloc(12000, htMisc);
    lpxf = LpAlloc(25000, htMisc);
    vrgPlanResExtra = LpAlloc(game.cPlanMax << 1, htMisc);
    __fmemset(vrgPlanResExtra, 0, game.cPlanMax << 1);
    vrgts = LpAlloc(game.cPlayer << 4, htMisc);
    uVar4 = CONCAT22(ctickLast._2_2_, (undefined2)ctickLast);
    cColDrop = 0;
    cXferFull = 0;
    imemMsgCur = 0;
    i = 0;
    do {
        ctickLast = uVar4;
        if (game.cPlayer <= i) {
            FreeLp(vrgPlanResExtra, htMisc);
            vrgPlanResExtra._0_2_ = (ushort *)0x0;
            vrgPlanResExtra._2_2_ = 0;
            FreeLp(vrgts, htMisc);
            vrgts._0_2_ = (TURNSERIAL *)0x0;
            vrgts._2_2_ = 0;
            FreeLp(lpcd, htMisc);
            lpcd._0_2_ = (COLDROP *)0x0;
            lpcd._2_2_ = 0;
            FreeLp(lpxf, htMisc);
            lpxf._0_2_ = (XFERFULL *)0x0;
            lpxf._2_2_ = 0;
            idPlayer = sVar2;
            return;
        }
        iVar1 = ((short *)rgOut)[i];
        idsError = 0;
        if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) {
            sVar3 = FCheckLogFile(i, &idsError);
            uVar4 = ctickLast;
            if (sVar3 != 0)
                goto LAB_1020_678e;
            if (idsError == 0) {
                if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0) {
                    if ((gd.grBits._2_2_ >> 7 & 1) == 0) {
                        ((short *)rgOut)[i] = 1;
                        uVar4 = ctickLast;
                    } else {
                        ((short *)rgOut)[i] = 2;
                        uVar4 = ctickLast;
                    }
                } else {
                    ((short *)rgOut)[i] = -1;
                    uVar4 = ctickLast;
                }
            } else if (idsError == 0x1c) {
                ((short *)rgOut)[i] = 4;
                uVar4 = ctickLast;
            } else if (idsError == 0x1d) {
                ((short *)rgOut)[i] = 5;
                uVar4 = ctickLast;
            } else {
                ((short *)rgOut)[i] = 3;
                uVar4 = ctickLast;
            }
        } else {
        LAB_1020_678e:
            ctickLast = uVar4;
            if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) {
                _wsprintf(szWork, s_s_x_d_1120_040d, (char *)szBase, 0x1120, i + 1);
                idPlayer = i;
                sVar3 = FLoadLogFile((char *)szWork);
                if (sVar3 != 0) {
                    sVar3 = FRunLogFile();
                    if (sVar3 == 0) {
                        ((short *)rgOut)[i] = 3;
                        uVar4 = ctickLast;
                        goto LAB_1020_68d6;
                    }
                }
                ((short *)rgOut)[i] = 0;
                uVar4 = ctickLast;
            } else {
                ((short *)rgOut)[i] = 0;
                uVar4 = ctickLast;
            }
        }
    LAB_1020_68d6:
        if ((uVar4 == 0) || (((short *)rgOut)[i] != iVar1)) {
            ctickLast = uVar4;
            uVar4 = GetTickCount();
        }
        i = i + 1;
    } while (true);
}

// ======================================================================
// Function: CTurnsOutSafe
// Address: 1020:6996
// Segment: MEMORY_MDI
// ======================================================================

short CTurnsOutSafe(void)

{
    short sVar1;
    uint  uVar2;
    uint  uVar3;
    short sVar4;
    short cturn;
    short fGenSav;
    short fHostModeSav;
    short idPlayerSav;

    sVar1 = idPlayer;
    uVar2 = (uint)gd.grBits >> 3;
    uVar3 = (uint)gd.grBits >> 1;
    idPlayer = -1;
    gd.grBits._0_2_ = (uint)gd.grBits & 0xfff5 | 8;
    sVar4 = CFindTurnsOutstanding();
    gd.grBits._0_2_ = (uint)gd.grBits & 0xfff5 | (uVar3 & 1) << 1 | (uVar2 & 1) << 3;
    idPlayer = sVar1;
    return sVar4;
}

// ======================================================================
// Function: CFindTurnsOutstanding
// Address: 1020:6a26
// Segment: MEMORY_MDI
// ======================================================================

short CFindTurnsOutstanding(void)

{
    int   iVar1;
    short sVar2;
    ulong uVar3;
    short fOut;
    short fSav;
    short cOut;
    short i;
    short cAi;
    short idsError;

    cOut = 0;
    cAi = 0;
    fFileErrSilent = 1;
    gd.grBits._0_2_ = (uint)gd.grBits & 0xfffd | 2;
    i = 0;
    uVar3 = ctickLast;
    do {
        ctickLast._2_2_ = (undefined2)(uVar3 >> 0x10);
        ctickLast._0_2_ = (undefined2)uVar3;
        if (game.cPlayer <= i) {
            gd.grBits._0_2_ = (uint)gd.grBits & 0xfffd;
            gd.grBits._2_2_ = gd.grBits._2_2_ & 0xffef | (uint)(cAi == game.cPlayer) << 4;
            fFileErrSilent = 0;
            return cOut;
        }
        iVar1 = ((short *)rgOut)[i];
        idsError = 0;
        if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) {
            ctickLast = uVar3;
            sVar2 = FCheckLogFile(i, &idsError);
            uVar3 = ctickLast;
            if (sVar2 != 0)
                goto LAB_1020_6aae;
            if (idsError == 0) {
                if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0) {
                    if ((gd.grBits._2_2_ >> 7 & 1) == 0) {
                        ((short *)rgOut)[i] = 1;
                        cOut = cOut + 1;
                        uVar3 = ctickLast;
                    } else {
                        ((short *)rgOut)[i] = 2;
                        cOut = cOut + 1;
                        uVar3 = ctickLast;
                    }
                } else {
                    ((short *)rgOut)[i] = -1;
                    uVar3 = ctickLast;
                }
            } else {
                if (idsError == 0x1c) {
                    ((short *)rgOut)[i] = 4;
                    uVar3 = ctickLast;
                } else if (idsError == 0x1d) {
                    ((short *)rgOut)[i] = 5;
                    uVar3 = ctickLast;
                } else {
                    ((short *)rgOut)[i] = 3;
                    uVar3 = ctickLast;
                }
                cOut = cOut + 1;
            }
        } else {
        LAB_1020_6aae:
            if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) != 0) {
                cAi = cAi + 1;
            }
            ctickLast = uVar3;
            ((short *)rgOut)[i] = 0;
            uVar3 = ctickLast;
        }
        if ((uVar3 == 0) || (((short *)rgOut)[i] != iVar1)) {
            ctickLast = uVar3;
            uVar3 = GetTickCount();
        }
        i = i + 1;
    } while (true);
}

// ======================================================================
// Function: HostModeDialog
// Address: 1020:6c16
// Segment: MEMORY_MDI
// ======================================================================

/* WARNING: Type propagation algorithm not settling */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short HostModeDialog(HWND hwnd, WMType message, ushort wParam, long lParam)

{
    uint        uVar1;
    HWND        HVar2;
    BOOL        BVar3;
    short       sVar4;
    char       *pcVar5;
    undefined1 *puVar6;
    undefined1 *puVar7;
    undefined2  uVar8;
    undefined2  unaff_SS;
    FARPROC     pvVar9;
    undefined1  local_36[4];
    uint        local_32;
    HMENU       local_24;
    int         local_22;
    int         local_20;
    int         local_1e;
    int         local_1c;
    uint        local_1a;
    POINT       local_18;
    uint        local_14;
    RECT        rc;
    short       fRet;
    fn_lpProc  *lpProc;

    uVar8 = 0x1020;
    puVar6 = &stack0xffc0;
    puVar7 = &stack0xffc0;
    if (message == WM_DESTROY) {
        KillTimer(hwnd, uTimerId);
        uTimerId = 0;
        return 0;
    }
    if (message == WM_PAINT) {
        local_14 = BeginPaint(hwnd, local_36 + 2);
        if (((int)ctickLast == 0) && (ctickLast._2_2_ == 0)) {
            CFindTurnsOutstanding();
        }
        if ((gd.grBits._2_2_ >> 5 & 1) == 0) {
            HVar2 = GetDlgItem(hwnd, 0x408);
            if (((gd.grBits._2_2_ >> 4 & 1) == 0) && ((vtimer.fAutoGenWhenIn != 0 || (vtimer.mdForce != 0)))) {
                BVar3 = 1;
            } else {
                BVar3 = 0;
            }
            EnableWindow(HVar2, BVar3);
        }
        DrawHostDialog2(hwnd, local_14);
        EndPaint(hwnd, local_36 + 2);
        return 1;
    }
    if (message == WM_ERASEBKGND) {
        GetClientRect(hwnd, &rc);
        FillRect(wParam, &rc, hbrButtonFace);
        return 1;
    }
    if (message == WM_CTLCOLOR) {
        SetBkColor(wParam, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
        return hbrButtonFace;
    }
    if (message == WM_SETCURSOR) {
    LAB_1020_6db6:
        GetCursorPos(&local_18);
        ScreenToClient(hwnd, &local_18);
        if ((((5 < local_18.x) && (local_18.x < dyArial8 + 7)) && (0x2f < local_18.y)) &&
            ((local_22 = (local_18.y + -0x30) / (dyArial8 + 4), local_22 < game.cPlayer && ((local_18.y + -0x30) % (dyArial8 + 4) < dyArial8 + 1)))) {
            if (message == WM_SETCURSOR) {
                SetCursor(hcurHand);
                return 1;
            }
            if ((*(uint *)((int)&rgplr[0].wMdPlr + local_22 * 0xc0) >> 9 & 1) == 0) {
                local_20 = 0;
            } else if (*(uint *)((int)&rgplr[0].wMdPlr + local_22 * 0xc0) >> 0xd == 7) {
                local_20 = 2;
            } else {
                local_20 = 1;
            }
            local_24 = CreatePopupMenu();
            iPopMenuSel = -1;
            for (local_1c = 0; local_1c < 3; local_1c = local_1c + 1) {
                CchGetString(local_1c + idsHumanControlled, (char *)szWork);
                if (local_1c == 1) {
                    if (((*(uint *)((int)&rgplr[0].wMdPlr + local_22 * 0xc0) >> 9 & 1) == 0) ||
                        (*(uint *)((int)&rgplr[0].wMdPlr + local_22 * 0xc0) >> 0xd == 7)) {
                        local_14 = 3;
                    } else {
                        local_14 = 0;
                    }
                } else if (((*(uint *)((int)&rgplr[0].wMdPlr + local_22 * 0xc0) >> 9 & 1) == 0) ||
                           (*(uint *)((int)&rgplr[0].wMdPlr + local_22 * 0xc0) >> 0xd == 7)) {
                    local_14 = 0;
                } else {
                    local_14 = 3;
                }
                if (local_1c == local_20) {
                    uVar1 = 8;
                } else {
                    uVar1 = 0;
                }
                AppendMenu(local_24, uVar1 | local_14, local_1c + 15000, szWork);
            }
            ClientToScreen(hwnd, &local_18);
            if (message == WM_LBUTTONDOWN) {
                local_1a = 0;
            } else {
                local_1a = 2;
            }
            TrackPopupMenu(local_24, local_1a | 4, local_18.x, local_18.y, 0, hwnd, (RECT *)0x0);
            DestroyMenu(local_24);
            local_1e = -1;
            BVar3 = PeekMessage(local_36, hwnd, 0x111, 0x111, 2);
            if (((BVar3 != 0) && (14999 < local_32)) && (local_32 < 0x3afc)) {
                local_1e = local_32 + 0xc568;
            }
            if ((local_1e != -1) && (local_20 != local_1e)) {
                *(uint *)((int)&rgplr[0].wMdPlr + local_22 * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + local_22 * 0xc0) & 0xfdff | (uint)(0 < local_1e) << 9;
                if (local_1e == 2) {
                    *(uint *)((int)&rgplr[0].wMdPlr + local_22 * 0xc0) = *(uint *)((int)&rgplr[0].wMdPlr + local_22 * 0xc0) & 0x1fff | 0xe000;
                }
                uVar1 = *(uint *)((int)&rgplr[0].lSalt + 2 + local_22 * 0xc0);
                *(uint *)((int)&rgplr[0].lSalt + local_22 * 0xc0) = ~*(uint *)((int)&rgplr[0].lSalt + local_22 * 0xc0);
                *(uint *)((int)&rgplr[0].lSalt + 2 + local_22 * 0xc0) = ~uVar1;
                FMarkFile(dtTurn, local_22, 8, (uint)(local_1e != 0));
                FMarkFile(dtHost, local_22, 8, (uint)(local_1e != 0));
                gd.grBits._0_2_ = (uint)gd.grBits & 0xfbff;
                fProcessingTimer = 1;
                CFindTurnsOutstanding();
                HVar2 = GetDlgItem(hwnd, 0x408);
                if (((gd.grBits._2_2_ >> 4 & 1) == 0) && ((vtimer.fAutoGenWhenIn != 0 || (vtimer.mdForce != 0)))) {
                    BVar3 = 1;
                } else {
                    BVar3 = 0;
                }
                EnableWindow(HVar2, BVar3);
                DrawHostDialog2(hwnd, 0);
                fProcessingTimer = 0;
            }
            return 0;
        }
        return 0;
    }
    if (message == WM_INITDIALOG) {
        StickyDlgPos(hwnd, (POINT *)&ptStickyHostModeDlg, 1);
        HVar2 = GetDlgItem(hwnd, 0x409);
        SetWindowText(HVar2, game.szName);
        HVar2 = GetDlgItem(hwnd, 0x40a);
        SetWindowText(HVar2, szBase);
        HVar2 = GetDlgItem(hwnd, 0x408);
        if (((gd.grBits._2_2_ >> 5 & 1) == 0) && ((vtimer.fAutoGenWhenIn != 0 || (vtimer.mdForce != 0)))) {
            BVar3 = 1;
        } else {
            BVar3 = 0;
        }
        EnableWindow(HVar2, BVar3);
        HVar2 = GetDlgItem(hwnd, IDC_U16_0x0406 | IDOK);
        EnableWindow(HVar2, (uint)((gd.grBits._2_2_ >> 5 & 1) == 0));
        HVar2 = GetDlgItem(hwnd, IDC_U16_0x07DF);
        EnableWindow(HVar2, (uint)((gd.grBits._2_2_ >> 5 & 1) == 0));
        uVar8 = 0x14f8;
        uTimerId = SetTimer(0xd, 10000, 0, 0);
        puVar6 = &stack0xffb4;
    } else {
        if (message == WM_COMMAND) {
            if (((wParam == 0x407) || (wParam == 2)) || (wParam == 0x408)) {
                if (wParam == 0x407) {
                    sVar4 = GetAsyncKeyState(0x10);
                    if (sVar4 < 0) {
                        sVar4 = GetAsyncKeyState(0x11);
                        if (sVar4 < 0) {
                            iPassCnt = 999;
                        } else {
                            iPassCnt = 9;
                        }
                    } else {
                        sVar4 = GetAsyncKeyState(0x11);
                        if (sVar4 < 0) {
                            iPassCnt = 99;
                        } else {
                            iPassCnt = 0;
                        }
                    }
                    if (iPassCnt == 0) {
                        uVar8 = 0x1020;
                        sVar4 = CFindTurnsOutstanding();
                        puVar7 = &stack0xffbc;
                        if (sVar4 != 0) {
                            sVar4 = 0x1024;
                            pcVar5 = PszFormatIds(idsSureWishGenerateOptionDoesGuaranteePlayers, (short *)0x0);
                            uVar8 = 0x1040;
                            sVar4 = AlertSz(pcVar5, sVar4);
                            puVar7 = &stack0xffbc;
                            if (sVar4 != 6) {
                                return 1;
                            }
                        }
                    } else {
                        pcVar5 = PszGetCompressedString(idsSureWantForceGenerateDTurnsRow);
                        _wsprintf(szWork, pcVar5);
                        HVar2 = GetFocus();
                        uVar8 = 0x14f8;
                        sVar4 = MessageBox(HVar2, szWork, s_Stars_1120_041a, MB_TASKMODAL | MB_ICONEXCLAMATION | MB_YESNO);
                        puVar7 = &stack0xffbc;
                        if (sVar4 != 6) {
                            iPassCnt = 0;
                            return 1;
                        }
                    }
                }
                *(undefined2 *)(puVar7 + -2) = 0;
                *(undefined2 *)(puVar7 + -4) = 0x416;
                *(HWND *)(puVar7 + -6) = hwnd;
                *(undefined2 *)(puVar7 + -8) = uVar8;
                *(undefined2 *)(puVar7 + -10) = 0x7390;
                StickyDlgPos(*(HWND *)(puVar7 + -6), *(POINT **)(puVar7 + -4), *(short *)(puVar7 + -2));
                *(HWND *)(puVar7 + -2) = hwnd;
                if (wParam == 2) {
                    uVar8 = 0;
                } else if (wParam == 0x408) {
                    uVar8 = 0xffff;
                } else {
                    uVar8 = 1;
                }
                *(undefined2 *)(puVar7 + -4) = uVar8;
                *(undefined2 *)(puVar7 + -6) = 0x1040;
                *(undefined2 *)(puVar7 + -8) = 0x73be;
                EndDialog(*(HWND *)(puVar7 + -2), *(short *)(puVar7 + -4));
                if (wParam == 0x408) {
                    *(undefined2 *)(puVar7 + -2) = 0x14f8;
                    *(undefined2 *)(puVar7 + -4) = 0x73cd;
                    EnsureAis();
                } else if ((wParam == 2) && (((uint)gd.grBits2 >> 2 & 1) != 0)) {
                    *(short *)(puVar7 + -2) = vretExitValue;
                    *(undefined2 *)(puVar7 + -4) = 0x14f8;
                    *(undefined2 *)(puVar7 + -6) = 0x73f4;
                    PostQuitMessage(*(short *)(puVar7 + -2));
                }
                return 1;
            }
            if (wParam == 0x7df) {
                sVar4 = FCheckPassword();
                if (sVar4 == 0) {
                    return 0;
                }
                pvVar9 = MakeProcInstance(NewPasswordDlg, hInst);
                sVar4 = DialogBox(0, IDD_NEW_PASSWORD, hwnd, pvVar9);
                FreeProcInstance(pvVar9);
                SetFocus(hwnd);
                return sVar4;
            }
            if (wParam != 0x405) {
                if (wParam != 0x76) {
                    return 0;
                }
                WinHelp(hwnd, _szHelpFile, 1, 0x440);
                return 1;
            }
            pvVar9 = MakeProcInstance(HostOptionsDialog, hInst);
            sVar4 = DialogBox(0, IDD_HOST_OPTIONS, hwnd, pvVar9);
            FreeProcInstance(pvVar9);
            SetFocus(hwnd);
            if (sVar4 == 0) {
                return 0;
            }
            if ((gd.grBits._2_2_ >> 5 & 1) == 0) {
                HVar2 = GetDlgItem(hwnd, 0x408);
                if (((gd.grBits._2_2_ >> 4 & 1) == 0) && ((vtimer.fAutoGenWhenIn != 0 || (vtimer.mdForce != 0)))) {
                    BVar3 = 1;
                } else {
                    BVar3 = 0;
                }
                EnableWindow(HVar2, BVar3);
                return sVar4;
            }
            return sVar4;
        }
        if (message != WM_TIMER) {
            if ((message != WM_LBUTTONDOWN) && (message != WM_RBUTTONDOWN)) {
                return 0;
            }
            goto LAB_1020_6db6;
        }
    }
    if (fProcessingTimer == 0) {
        fProcessingTimer = 1;
        *(undefined2 *)(puVar6 + -2) = uVar8;
        *(undefined2 *)(puVar6 + -4) = 0x6d4d;
        CFindTurnsOutstanding();
        *(undefined2 *)(puVar6 + -2) = 0;
        *(HWND *)(puVar6 + -4) = hwnd;
        *(undefined2 *)(puVar6 + -6) = 0x1020;
        *(undefined2 *)(puVar6 + -8) = 0x6d59;
        DrawHostDialog2(*(HWND *)(puVar6 + -4), *(HDC *)(puVar6 + -2));
        fProcessingTimer = 0;
    }
    return (uint)(message != WM_TIMER);
}

// ======================================================================
// Function: HostOptionsDialog
// Address: 1020:75ce
// Segment: MEMORY_MDI
// ======================================================================

/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short HostOptionsDialog(HWND hwnd, WMType message, ushort wParam, long lParam)

{
    HDC         hdc_00;
    short       sVar1;
    undefined2  unaff_SS;
    PAINTSTRUCT ps;
    HDC         hdc;
    RECT        rc;

    if (message == WM_DESTROY) {
    LAB_1020_76f3:
        sVar1 = 0;
    } else {
        if (message == WM_PAINT) {
            hdc_00 = BeginPaint(hwnd, &ps);
            DrawHostOptions(hwnd, hdc_00, -1);
            EndPaint(hwnd, &ps);
            return 1;
        }
        if (message != WM_ERASEBKGND) {
            if (message == WM_CTLCOLOR) {
                SetBkColor(wParam, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
                return hbrButtonFace;
            }
            if (message != WM_INITDIALOG) {
                if (message == WM_COMMAND) {
                    if ((wParam == 2) || (wParam == 1)) {
                        EndDialog(hwnd, (uint)(wParam == 1));
                        return 1;
                    }
                    if (wParam == 0x76) {
                        WinHelp(hwnd, _szHelpFile, 1, 0x440);
                        return 1;
                    }
                }
                goto LAB_1020_76f3;
            }
        }
        GetClientRect(hwnd, &rc);
        FillRect(wParam, &rc, hbrButtonFace);
        sVar1 = 1;
    }
    return sVar1;
}

// ======================================================================
// Function: DrawHostOptions
// Address: 1020:7706
// Segment: MEMORY_MDI
// ======================================================================

void DrawHostOptions(HWND hwnd, HDC hdc, short iDraw)

{
    return;
}

// ======================================================================
// Function: HostTimerProc
// Address: 1020:7716
// Segment: MEMORY_MDI
// ======================================================================

void HostTimerProc(HWND hwnd, WMType msg, ushort idTimer, ulong dwTime)

{
    short       sVar1;
    short       sVar2;
    char       *pcVar3;
    HWND        HVar4;
    HWND        HVar5;
    undefined1 *puVar6;
    undefined2  uVar7;
    undefined2  unaff_SS;
    short       sVar8;
    short       idCur;
    short       fSav;
    short       cOut;
    char        szExt[4];
    HWND        hwndT;

    sVar1 = fFileErrSilent;
    puVar6 = &stack0xffec;
    if (fProcessingTimer == 0) {
        fProcessingTimer = 1;
        if (uTimerType == 0xe) {
            sVar2 = FNewTurnAvail(idPlayer);
            sVar8 = idPlayer;
            if (sVar2 != 0) {
                KillTimer(hwnd, uTimerId);
                _wsprintf(szExt, MPCTD);
                DestroyCurGame();
                sVar2 = FLoadGame((char *)szBase, szExt);
                if (sVar2 != 0) {
                    idPlayer = sVar8;
                    CreateChildWindows();
                    uTimerId = SetTimer(0xf, 1000, lpfnHostTimerProc._2_2_, (fn_lpfnHostTimerProc *)lpfnHostTimerProc);
                    uTimerType = 0xf;
                    FlashWindow(hwndFrame, 1);
                    HVar4 = hwndFrame;
                    pcVar3 = PszGetCompressedString(idsNewTurnAvailable2);
                    SetWindowText(HVar4, pcVar3);
                    MessageBeep(0x30);
                    puVar6 = &stack0xffe6;
                    cOut = 1;
                    goto MDI_RedrawText_2;
                }
                sVar8 = 0x10;
                pcVar3 = PszFormatIds(idsUnableOpenNewTurnFile, (short *)0x0);
                AlertSz(pcVar3, sVar8);
            }
        } else if (uTimerType == 0xf) {
            FlashWindow(hwndFrame, 1);
        } else {
            while (true) {
                *(undefined2 *)(puVar6 + -2) = 0x1020;
                *(undefined2 *)(puVar6 + -4) = 0x784f;
                cOut = CFindTurnsOutstanding();
                if ((gd.grBits._2_2_ >> 4 & 1) != 0)
                    break;
                *(short *)(puVar6 + -2) = cOut;
                *(undefined2 *)(puVar6 + -4) = 0x31b;
                *(undefined2 *)(puVar6 + -6) = 0x1020;
                *(undefined2 *)(puVar6 + -8) = 0x78ae;
                pcVar3 = PszGetCompressedString(*(StringId *)(puVar6 + -4));
                *(undefined2 *)(puVar6 + -4) = 0x1120;
                *(char **)(puVar6 + -6) = pcVar3;
                *(undefined2 *)(puVar6 + -8) = 0x1120;
                *(char **)(puVar6 + -10) = (char *)szWork;
                *(undefined2 *)(puVar6 + -0xc) = 0x1010;
                uVar7 = 0x14f8;
                *(undefined2 *)(puVar6 + -0xe) = 0x78c1;
                _wsprintf(*(char **)(puVar6 + -10), *(char **)(puVar6 + -6));
                if (cOut != 1) {
                    *(undefined2 *)(puVar6 + -2) = 0x421;
                    *(char **)(puVar6 + -4) = (char *)szWork;
                    *(undefined2 *)(puVar6 + -6) = 0x14f8;
                    uVar7 = 0x1118;
                    *(undefined2 *)(puVar6 + -8) = 0x78da;
                    _strcat(*(char **)(puVar6 + -4), *(char **)(puVar6 + -2));
                }
                *(undefined2 *)(puVar6 + -2) = 0x31c;
                *(undefined2 *)(puVar6 + -4) = uVar7;
                *(undefined2 *)(puVar6 + -6) = 0x78e6;
                pcVar3 = PszGetCompressedString(*(StringId *)(puVar6 + -2));
                *(char **)(puVar6 + -2) = pcVar3;
                *(char **)(puVar6 + -4) = (char *)szWork;
                *(undefined2 *)(puVar6 + -6) = 0x1010;
                *(undefined2 *)(puVar6 + -8) = 0x78f3;
                _strcat(*(char **)(puVar6 + -4), *(char **)(puVar6 + -2));
                *(HWND *)(puVar6 + -2) = hwndFrame;
                *(undefined2 *)(puVar6 + -4) = 0x1120;
                *(char **)(puVar6 + -6) = (char *)szWork;
                *(undefined2 *)(puVar6 + -8) = 0x1118;
                *(undefined2 *)(puVar6 + -10) = 0x7906;
                SetWindowText(*(HWND *)(puVar6 + -2), *(LPCSTR *)(puVar6 + -6));
                puVar6 = puVar6 + -6;
            MDI_RedrawText_2:
                *(HWND *)(puVar6 + -2) = hwndFrame;
                *(undefined2 *)(puVar6 + -4) = 3;
                *(undefined2 *)(puVar6 + -6) = 0x14f8;
                *(undefined2 *)(puVar6 + -8) = 0x7913;
                HVar4 = GetWindow(*(HWND *)(puVar6 + -2), *(UINT *)(puVar6 + -4));
                *(HWND *)(puVar6 + -2) = HVar4;
                *(undefined2 *)(puVar6 + -4) = 4;
                *(undefined2 *)(puVar6 + -6) = 0x14f8;
                *(undefined2 *)(puVar6 + -8) = 0x7922;
                HVar5 = GetWindow(*(HWND *)(puVar6 + -2), *(UINT *)(puVar6 + -4));
                if (HVar5 == hwndFrame) {
                    *(HWND *)(puVar6 + -2) = HVar4;
                    *(undefined2 *)(puVar6 + -4) = 0;
                    *(undefined2 *)(puVar6 + -6) = 0;
                    *(undefined2 *)(puVar6 + -8) = 1;
                    *(undefined2 *)(puVar6 + -10) = 0x14f8;
                    *(undefined2 *)(puVar6 + -0xc) = 0x793f;
                    InvalidateRect(*(HWND *)(puVar6 + -2), *(RECT **)(puVar6 + -6), *(BOOL *)(puVar6 + -8));
                    puVar6 = puVar6 + 2;
                }
                uVar7 = 0x14f8;
                if (cOut != 0)
                    goto MDI_Done_4;
                if ((gd.grBits._2_2_ >> 10 & 1) != 0) {
                    *(undefined2 *)(puVar6 + -2) = 0x14f8;
                    uVar7 = 0x1040;
                    *(undefined2 *)(puVar6 + -4) = 0x7960;
                    ShowProgressGauge();
                }
                *(undefined2 *)(puVar6 + -2) = uVar7;
                *(undefined2 *)(puVar6 + -4) = 0x7965;
                EnsureAis();
                *(undefined2 *)(puVar6 + -2) = 0x1020;
                *(undefined2 *)(puVar6 + -4) = 0x796a;
                FGenerateTurn();
                *(undefined2 *)(puVar6 + -2) = 0x10b0;
                *(undefined2 *)(puVar6 + -4) = 0x796f;
                HideProgressGauge();
                if ((ini.wFlags >> 3 & 1) != 0) {
                    *(short *)(puVar6 + -2) = vretExitValue;
                    *(undefined2 *)(puVar6 + -4) = 0x1040;
                    *(undefined2 *)(puVar6 + -6) = 0x798c;
                    PostQuitMessage(*(short *)(puVar6 + -2));
                    goto MDI_Done_4;
                }
                *(undefined2 *)(puVar6 + -2) = 0x1040;
                *(undefined2 *)(puVar6 + -4) = 0x7994;
                EnsureAis();
            }
            *(undefined2 *)(puVar6 + -2) = 0x10;
            *(undefined2 *)(puVar6 + -4) = 0;
            *(undefined2 *)(puVar6 + -6) = 0;
            *(undefined2 *)(puVar6 + -8) = 0x2c8;
            *(undefined2 *)(puVar6 + -10) = 0x1020;
            *(undefined2 *)(puVar6 + -0xc) = 0x787d;
            pcVar3 = PszFormatIds(*(StringId *)(puVar6 + -8), *(short **)(puVar6 + -6));
            *(char **)(puVar6 + -4) = pcVar3;
            *(undefined2 *)(puVar6 + -6) = 0x1030;
            *(undefined2 *)(puVar6 + -8) = 0x7886;
            AlertSz(*(char **)(puVar6 + -4), *(short *)(puVar6 + -2));
            *(HWND *)(puVar6 + -2) = hwnd;
            *(undefined2 *)(puVar6 + -4) = 0x408;
            *(undefined2 *)(puVar6 + -6) = 0x1040;
            *(undefined2 *)(puVar6 + -8) = 0x7895;
            HVar4 = GetDlgItem(*(HWND *)(puVar6 + -2), *(ControlId *)(puVar6 + -4));
            *(HWND *)(puVar6 + -2) = HVar4;
            *(undefined2 *)(puVar6 + -4) = 0;
            *(undefined2 *)(puVar6 + -6) = 0x14f8;
            *(undefined2 *)(puVar6 + -8) = 0x789f;
            EnableWindow(*(HWND *)(puVar6 + -2), *(BOOL *)(puVar6 + -4));
        }
    MDI_Done_4:
        fProcessingTimer = 0;
    }
    fFileErrSilent = sVar1;
    return;
}

// ======================================================================
// Function: GetWindowRc
// Address: 1020:79ac
// Segment: MEMORY_MDI
// ======================================================================

void GetWindowRc(HWND hwnd, RECT *prc)

{
    undefined2      unaff_SS;
    WINDOWPLACEMENT wndpl;

    wndpl.length = 0x16;
    GetWindowPlacement(hwnd, &wndpl);
    prc->left = wndpl.rcNormalPosition.left;
    prc->top = wndpl.rcNormalPosition.top;
    prc->right = wndpl.rcNormalPosition.right;
    prc->bottom = wndpl.rcNormalPosition.bottom;
    prc->right = prc->right - prc->left;
    prc->bottom = prc->bottom - prc->top;
    return;
}

// ======================================================================
// Function: SetWindowIniString
// Address: 1020:79f6
// Segment: MEMORY_MDI
// ======================================================================

void SetWindowIniString(char *sz, HWND hwnd)

{
    BOOL        BVar1;
    char       *pcVar2;
    undefined1 *puVar3;
    undefined2  unaff_SS;
    RECT        rc;
    char        ch;

    BVar1 = IsZoomed(hwnd);
    puVar3 = &stack0xffec;
    if (BVar1 == 0) {
        BVar1 = IsIconic(hwnd);
        puVar3 = &stack0xffea;
        if (BVar1 == 0) {
            ch = 'R';
            puVar3 = &stack0xffea;
        } else {
            ch = 'I';
        }
    } else {
        ch = 'M';
    }
    *(RECT **)(puVar3 + -2) = &rc;
    *(HWND *)(puVar3 + -4) = hwnd;
    *(undefined2 *)(puVar3 + -6) = 0x14f8;
    *(undefined2 *)(puVar3 + -8) = 0x7a3d;
    GetWindowRc(*(HWND *)(puVar3 + -4), *(RECT **)(puVar3 + -2));
    *(short *)(puVar3 + -2) = rc.bottom;
    *(short *)(puVar3 + -4) = rc.right;
    *(short *)(puVar3 + -6) = rc.top;
    *(short *)(puVar3 + -8) = rc.left;
    *(int *)(puVar3 + -10) = (int)ch;
    *(undefined2 *)(puVar3 + -0xc) = 0x31d;
    *(undefined2 *)(puVar3 + -0xe) = 0x1020;
    *(undefined2 *)(puVar3 + -0x10) = 0x7a5a;
    pcVar2 = PszGetCompressedString(*(StringId *)(puVar3 + -0xc));
    *(undefined2 *)(puVar3 + -0xc) = 0x1120;
    *(char **)(puVar3 + -0xe) = pcVar2;
    *(undefined2 *)(puVar3 + -0x10) = 0x1120;
    *(char **)(puVar3 + -0x12) = (char *)szWork;
    *(undefined2 *)(puVar3 + -0x14) = 0x1010;
    *(undefined2 *)(puVar3 + -0x16) = 0x7a6d;
    _wsprintf(*(char **)(puVar3 + -0x12), *(char **)(puVar3 + -0xe));
    return;
}

// ======================================================================
// Function: WriteIniSettings
// Address: 1020:7a76
// Segment: MEMORY_MDI
// ======================================================================

void WriteIniSettings(void)

{
    char       cVar1;
    int        iVar2;
    int        iVar3;
    char      *pcVar4;
    ushort     uVar5;
    undefined2 unaff_SS;
    undefined2 uVar6;
    short      sVar7;
    short      sVar8;
    char       ch;
    ushort     iCol;
    char       szSection[16];
    char      *psz;
    char       szIniFile[16];
    char       szEntry[16];
    short      iPass;
    short      i;
    TILE      *rgtile;
    char       szPd[3];
    short      ctile;

    szPd[0] = '%';
    szPd[1] = 'd';
    szPd[2] = '\0';
    CchGetString(idsWindows, szSection);
    CchGetString(idsStarsIni, szIniFile);
    CchGetString(idsGlobalsettings, szEntry);
    FormatSerialAndEnv(CONCAT22(vSerialNumber._2_2_, (undefined2)vSerialNumber), (byte *)vrgbMachineConfig, (char *)szWork);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsResolution, szEntry);
    i = (short)(vcScreenColors < 5);
    if ((uint)gd.grBits >> 0xe == 0) {
        i = i | 2;
    }
    _wsprintf(szWork, szPd, i);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsMain, szEntry);
    SetWindowIniString((char *)szWork, hwndFrame);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsReportfleetwin, szEntry);
    iVar2 = vrptFleet.ptDlg.y + vrptFleet.ptSize.y;
    iVar3 = vrptFleet.ptDlg.x + vrptFleet.ptSize.x;
    uVar6 = 0x4d;
    sVar7 = vrptFleet.ptDlg.x;
    sVar8 = vrptFleet.ptDlg.y;
    pcVar4 = PszGetCompressedString(idsC04d04d04d04d);
    _wsprintf(szWork, pcVar4, uVar6, sVar7, sVar8, iVar3, iVar2);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsReportefleetwin, szEntry);
    iVar2 = vrptEFleet.ptDlg.y + vrptEFleet.ptSize.y;
    iVar3 = vrptEFleet.ptDlg.x + vrptEFleet.ptSize.x;
    uVar6 = 0x4d;
    sVar7 = vrptEFleet.ptDlg.x;
    sVar8 = vrptEFleet.ptDlg.y;
    pcVar4 = PszGetCompressedString(idsC04d04d04d04d);
    _wsprintf(szWork, pcVar4, uVar6, sVar7, sVar8, iVar3, iVar2);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsReportbtlwin, szEntry);
    iVar2 = vrptBattle.ptDlg.y + vrptBattle.ptSize.y;
    iVar3 = vrptBattle.ptDlg.x + vrptBattle.ptSize.x;
    uVar6 = 0x4d;
    sVar7 = vrptBattle.ptDlg.x;
    sVar8 = vrptBattle.ptDlg.y;
    pcVar4 = PszGetCompressedString(idsC04d04d04d04d);
    _wsprintf(szWork, pcVar4, uVar6, sVar7, sVar8, iVar3, iVar2);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsReportplanwin, szEntry);
    iVar2 = vrptPlanet.ptDlg.y + vrptPlanet.ptSize.y;
    iVar3 = vrptPlanet.ptDlg.x + vrptPlanet.ptSize.x;
    uVar6 = 0x4d;
    sVar7 = vrptPlanet.ptDlg.x;
    sVar8 = vrptPlanet.ptDlg.y;
    pcVar4 = PszGetCompressedString(idsC04d04d04d04d);
    _wsprintf(szWork, pcVar4, uVar6, sVar7, sVar8, iVar3, iVar2);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsLayout, szEntry);
    _wsprintf(szWork, szPd, iWindowLayout);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsStyle1width, szEntry);
    _wsprintf(szWork, szPd, vfs.dxPlanWant);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsStyle1height, szEntry);
    _wsprintf(szWork, szPd, vfs.dyMsgWant);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsStyle1height2, szEntry);
    _wsprintf(szWork, szPd, vfs.dyMinWant);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsStyle2width, szEntry);
    _wsprintf(szWork, szPd, vfs.dx2PlanWant);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsStyle2height, szEntry);
    _wsprintf(szWork, szPd, vfs.dy2MsgWant);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsStyle2height2, szEntry);
    _wsprintf(szWork, szPd, vfs.dy2MinWant);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsToolbar, szEntry);
    _wsprintf(szWork, szPd, gd.grBits._2_2_ >> 0xf);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    iPass = 2;
    rgtile = (TILE *)&rgtilePlanet;
    ctile = 6;
    CchGetString(idsPlanettiles, szEntry);
    while (iPass != 0) {
        psz = (char *)szWork;
        iCol = 0;
        for (i = 0; i < ctile; i = i + 1) {
            while (iCol < (rgtile[i].wFlags_0xa & 7)) {
                iCol = iCol + 1;
                *psz = '*';
                psz = psz + 1;
            }
            if ((rgtile[i].wFlags_0xa >> 7 & 1) == 0) {
                cVar1 = 'a';
            } else {
                cVar1 = 'A';
            }
            *psz = cVar1;
            *psz = *psz + ((byte)(rgtile[i].wFlags_0xa >> 3) & 0xf);
            psz = psz + 1;
        }
        *psz = '\0';
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        CchGetString(idsShiptiles, szEntry);
        rgtile = (TILE *)&rgtileShip;
        ctile = 7;
        iPass = iPass + -1;
    }
    CchGetString(idsSelection, szEntry);
    if (sel.grobj == grobjNone) {
        ch = 'N';
    } else if (sel.grobj == grobjPlanet) {
        ch = 'P';
    } else if (sel.grobj == grobjFleet) {
        ch = 'S';
    } else if (sel.grobj == grobjOther) {
        ch = 'E';
    }
    iVar2 = (int)((char)idPlayer + 'B');
    iVar3 = (int)ch;
    sVar7 = sel.id;
    pcVar4 = PszGetCompressedString(idsCCD);
    _wsprintf(szWork, pcVar4, iVar3, iVar2, sVar7);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsMessage, szEntry);
    _wsprintf(szWork, PCTD, iMsgCur);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsGameid, szEntry);
    _wsprintf(szWork, s_lx_1120_0423, (undefined2)game.lid, game.lid._2_2_);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsScanzoom, szEntry);
    szWork[0] = (char)iScanZoom + '5';
    szWork[1] = '\0';
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    if (((uint)gd.grBits2 >> 6 & 1) != 0) {
        __itoa(grbitScan, (char *)szWork, 10);
        CchGetString(idsScanmodev25, szEntry);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        __itoa(grbitScanShip, (char *)szWork, 10);
        CchGetString(idsScanfilterv25, szEntry);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        __itoa(grbitScanEShip, (char *)szWork, 10);
        CchGetString(idsScanefilterv25, szEntry);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        __itoa(grbitScanMines, (char *)szWork, 10);
        CchGetString(idsScanmines, szEntry);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        __itoa(vpctRadarView, (char *)szWork, 10);
        CchGetString(idsScanradar, szEntry);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    }
    __itoa(cMinGrafMax, (char *)szWork, 10);
    CchGetString(idsMineralscale, szEntry);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    if (idPlayer != -1) {
        CchGetString(idsFiles, szSection);
        CchGetString(idsWait2, szEntry);
        szWork[0] = (uTimerId != 0) + '0';
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        if (((uint)gd.grBits2 >> 8 & 1) != 0) {
            __itoa(game.turn, (char *)szWork, 10);
            CchGetString(idsTurn, szEntry);
            WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
            gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfeff;
        }
        CchGetString(idsFile1, szEntry);
        _wsprintf(szWork, s_s_m_d_1120_0427, (char *)szBase, 0x1120, idPlayer + 1);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    }
    CchGetString(idsMisc, szSection);
    if (((uint)gd.grBits2 >> 7 & 1) != 0) {
        CchGetString(idsReportplanfld, szEntry);
        _wsprintf(szWork, PCTD, (undefined2)vrptPlanet.grbitVisible);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        CchGetString(idsReportplansort, szEntry);
        i = vrptPlanet.icolSort;
        if (vrptPlanet.fAscending != 0) {
            i = vrptPlanet.icolSort | 0x100;
        }
        _wsprintf(szWork, PCTD, i);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        CchGetString(idsReportfleetfld, szEntry);
        _wsprintf(szWork, PCTD, (undefined2)vrptFleet.grbitVisible);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        CchGetString(idsReportfleetsort, szEntry);
        i = vrptFleet.icolSort;
        if (vrptFleet.fAscending != 0) {
            i = vrptFleet.icolSort | 0x100;
        }
        _wsprintf(szWork, PCTD, i);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        CchGetString(idsReportefleetfld, szEntry);
        _wsprintf(szWork, PCTD, (undefined2)vrptEFleet.grbitVisible);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        CchGetString(idsReportefltsort, szEntry);
        i = vrptEFleet.icolSort;
        if (vrptEFleet.fAscending != 0) {
            i = vrptEFleet.icolSort | 0x100;
        }
        _wsprintf(szWork, PCTD, i);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        CchGetString(idsReportbtlfld, szEntry);
        _wsprintf(szWork, PCTD, (undefined2)vrptBattle.grbitVisible);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        CchGetString(idsReportbtlsort, szEntry);
        i = vrptBattle.icolSort;
        if (vrptBattle.fAscending != 0) {
            i = vrptBattle.icolSort | 0x100;
        }
        _wsprintf(szWork, PCTD, i);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        CchGetString(idsReportdefgraph, szEntry);
        _wsprintf(szWork, PCTD, gd.grBits2._2_2_ & 0xf);
        WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    }
    CchGetString(idsHistoryinfo, szEntry);
    _wsprintf(szWork, PCTD, uDateInstalled);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    CchGetString(idsVcrspeed, szEntry);
    _wsprintf(szWork, PCTD, viSpeedVCR);
    WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
    if (((uint)gd.grBits2 >> 4 & 1) != 0) {
        CchGetString(idsZiporders, szSection);
        for (i = 0; i < 4; i = i + 1) {
            _strcpy(szEntry, szSection);
            uVar5 = _strlen(szEntry);
            szEntry[uVar5] = (char)i + '1';
            szEntry[uVar5 + 1] = '\0';
            if (*(char *)((int)&vrgZip[0].fValid + i * 0x18) == '\0') {
                szWork[0] = '\0';
            } else {
                psz = (char *)szWork;
                for (iPass = 0; iPass < 5; iPass = iPass + 1) {
                    *psz = (byte)((((ZIPORDER *)vrgZip)[i].txp.rgia + iPass)->wFlags >> 0xc) + 0x61;
                    psz[1] = ((byte)(((ZIPORDER *)vrgZip)[i].txp.rgia + iPass)->wFlags & 0xf) + 0x61;
                    pcVar4 = psz + 3;
                    psz[2] = ((byte)(((((ZIPORDER *)vrgZip)[i].txp.rgia + iPass)->wFlags & 0xfff) >> 4) & 0xf) + 0x61;
                    psz = psz + 4;
                    *pcVar4 = ((byte)((((ZIPORDER *)vrgZip)[i].txp.rgia + iPass)->wFlags >> 8) & 0xf) + 0x61;
                }
                _strcpy(psz, (char *)((int)vrgZip[0].szName + i * 0x18));
            }
            WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        }
    }
    if (((uint)gd.grBits2 >> 5 & 1) != 0) {
        for (i = 0; i < 5; i = i + 1) {
            CchGetString(idsZiporders, szSection);
            _strcpy(szEntry, szSection);
            uVar5 = _strlen(szEntry);
            szEntry[uVar5] = 'P';
            szEntry[uVar5 + 1] = (char)i + '1';
            szEntry[uVar5 + 2] = '\0';
            if (*(char *)((int)&vrgZipProd[0].fValid + i * 0x28) == '\0') {
                szWork[0] = '\0';
            } else {
                szWork[0] = *(char *)((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 + i * 0x28) + 'a';
                szWork[1] = *(char *)((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 + i * 0x28 + 1) + 'a';
                psz = (char *)szWork + 2;
                for (iPass = 0; iPass < (int)(uint) * (byte *)((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 + i * 0x28 + 1); iPass = iPass + 1) {
                    *psz = ((byte) * (undefined2 *)(i * hbrBlue + 0x2306 + iPass * 2) & 0xf) + 0x61;
                    psz[1] = ((byte)(*(uint *)(i * hbrBlue + 0x2306 + iPass * 2) >> 4) & 0xf) + 0x61;
                    pcVar4 = psz + 3;
                    psz[2] = ((byte)((uint) * (undefined2 *)(i * hbrBlue + 0x2306 + iPass * 2) >> 8) & 0xf) + 0x61;
                    psz = psz + 4;
                    *pcVar4 = (byte)((uint) * (undefined2 *)(i * hbrBlue + 0x2306 + iPass * 2) >> 0xc) + 0x61;
                }
                _strcpy(psz, ((ZIPPRODQ *)vrgZipProd)[i].szName);
            }
            WritePrivateProfileString(szSection, szEntry, szWork, szIniFile);
        }
    }
    return;
}

// ======================================================================
// Function: RefitFrameChildren
// Address: 1020:8c88
// Segment: MEMORY_MDI
// ======================================================================

void RefitFrameChildren(void)

{
    BOOL   BVar1;
    int    iVar2;
    int    iVar3;
    int    iVar4;
    int    iVar5;
    ushort uVar6;
    HMENU  HVar7;
    UINT   UVar8;
    short  dyTot;
    int    local_12;
    short  dyMin;
    short  dyMsgMin;
    short  dyMinMin;
    short  i;
    HMENU  hmenu;
    short  dyMsg;

    if ((hwndFrame != 0) && (BVar1 = IsIconic(hwndFrame), BVar1 == 0)) {
        if ((iWindowLayout == 0) || ((iWindowLayout != 1 && (iWindowLayout != 2)))) {
            if (vfs.dx - vfs.dxPlanWant < 100) {
                vfs.xTop = vfs.dx + -100;
            } else {
                vfs.xTop = vfs.dxPlanWant;
            }
            if (vfs.xTop < 199) {
                vfs.xTop = 0xc6;
            }
            iVar2 = (dyArial8 * 0xd >> 1) + 10;
            iVar3 = dyArial8 * 0xd + -0x24;
            if (vfs.dyMsgWant <= iVar2) {
                vfs.dyMsgWant = iVar2;
            }
            dyMin = vfs.dyMinWant;
            if (vfs.dyMinWant <= iVar3) {
                dyMin = iVar3;
            }
            vfs.dyMinWant = dyMin;
            dyMsg = vfs.dyMsgWant;
            if (vfs.dy - (vfs.dyMsgWant + dyMin + 0x10) < 0x32) {
                iVar4 = vfs.dy + -0x42;
                iVar5 = vfs.dyMsgWant + dyMin;
                dyMsg = MulDiv(iVar4, vfs.dyMsgWant, iVar5);
                dyMin = MulDiv(iVar4, dyMin, iVar5);
                if (dyMsg < iVar2) {
                    dyMin = dyMin - (iVar2 - dyMsg);
                    dyMsg = iVar2;
                } else if (dyMin < iVar3) {
                    iVar2 = iVar3 - dyMin;
                    dyMin = iVar3;
                    dyMsg = dyMsg - iVar2;
                }
            }
            vfs.y1 = ((vfs.dy - dyMin) - dyMsg) + -0x10;
            vfs.y2 = vfs.y1 + dyMsg + 8;
            if (hwndScanner != 0) {
                if (gd.grBits._2_2_ < 0) {
                    MoveWindow(hwndTb, vfs.xTop + 8, 0, (vfs.dx - vfs.xTop) + -8, 0x24, 1);
                    local_12 = 0x24;
                } else {
                    MoveWindow(hwndTb, 0, -100, 0x32, 0x32, 1);
                    local_12 = 0;
                }
                MoveWindow(hwndScanner, vfs.xTop + 8, local_12, (vfs.dx - vfs.xTop) + -8, vfs.dy - local_12, 1);
                MoveWindow(hwndPlanet, 0, 0, vfs.xTop, vfs.y1, 1);
                MoveWindow(hwndMessage, 0, vfs.y1 + 8, vfs.xTop, dyMsg, 1);
                MoveWindow(hwndMine, 0, vfs.y2 + 8, vfs.xTop, dyMin, 1);
            }
        } else {
            if (vfs.dx - vfs.dx2PlanWant < 200) {
                vfs.xTop = vfs.dx + -200;
            } else {
                vfs.xTop = vfs.dx2PlanWant;
            }
            if (vfs.xTop < 199) {
                vfs.xTop = 0xc6;
            }
            iVar2 = (dyArial8 * 0xd >> 1) + 10;
            iVar3 = dyArial8 * 0xd + -0x24;
            if (vfs.dy2MsgWant <= iVar2) {
                vfs.dy2MsgWant = iVar2;
            }
            if (vfs.dy2MinWant <= iVar3) {
                vfs.dy2MinWant = iVar3;
            }
            dyMsg = vfs.dy2MsgWant;
            if (vfs.dy - (vfs.dy2MsgWant + 8) < 100) {
                dyMsg = vfs.dy + -0x6c;
            }
            dyMin = vfs.dy2MinWant;
            if (vfs.dy - (vfs.dy2MinWant + 8) < 100) {
                dyMin = vfs.dy + -0x6c;
            }
            vfs.y1 = (vfs.dy - dyMsg) + -8;
            vfs.y2 = (vfs.dy - dyMin) + -8;
            if (hwndScanner != 0) {
                if (gd.grBits._2_2_ < 0) {
                    MoveWindow(hwndTb, 0, 0, vfs.dx, 0x24, 1);
                    local_12 = 0x24;
                } else {
                    MoveWindow(hwndTb, 0, -100, 0x32, 0x32, 1);
                    local_12 = 0;
                }
                MoveWindow(hwndScanner, vfs.xTop + 8, local_12, (vfs.dx - vfs.xTop) + -8, vfs.y2 - local_12, 1);
                MoveWindow(hwndPlanet, 0, local_12, vfs.xTop, vfs.y1 - local_12, 1);
                MoveWindow(hwndMessage, 0, vfs.y1 + 8, vfs.xTop, dyMsg, 1);
                MoveWindow(hwndMine, vfs.xTop + 8, vfs.y2 + 8, (vfs.dx - vfs.xTop) + -8, dyMin, 1);
            }
        }
        uVar6 = GetASubMenu(hwndFrame, 1);
        HVar7 = GetSubMenu(uVar6, 4);
        for (i = 0x82; i < 0x85; i = i + 1) {
            if (i + -0x82 == iWindowLayout) {
                UVar8 = 8;
            } else {
                UVar8 = 0;
            }
            CheckMenuItem(HVar7, i, UVar8);
        }
    }
    return;
}

// ======================================================================
// Function: TitleWndProc
// Address: 1020:9126
// Segment: MEMORY_MDI
// ======================================================================

long TitleWndProc(HWND hwnd, WMType msg, ushort wParam, long lParam)

{
    HWND        HVar1;
    short       sVar2;
    HPALETTE    HVar3;
    UINT        UVar4;
    BOOL        BVar5;
    LOGFONT    *pLVar6;
    HDC         HVar7;
    HGLOBAL     hdib;
    HFONT       HVar8;
    HGDIOBJ     HVar9;
    ushort      uVar10;
    int         iVar11;
    WMType     *pWVar12;
    undefined1 *puVar13;
    undefined1 *puVar14;
    undefined2  uVar15;
    undefined2  unaff_SS;
    LRESULT     LVar16;
    short       dy;
    short       x1;
    short       dxSrc;
    short       dySrc;
    undefined2  uVar17;
    undefined2  uVar18;
    RECT        rcT;
    short       dx;
    HFONT       hfontSav;
    HFONT       hfont;
    LOGFONT    *plf;
    undefined1  auStack_44[2];
    int         iStack_42;
    HBRUSH      hbrSav;
    RECT        rcWnd;
    undefined1  local_32[24];
    int         local_1a;
    int         local_18;
    int         local_16;
    int         local_14;
    RECT        rc;
    HPALETTE    hpalSav;
    short       i;
    HDC         hdc;

    uVar15 = 0x1020;
    puVar14 = &stack0xffa8;
    if (msg == WM_CREATE) {
        if (((7 < vcScreenColors) && (vhdibTitle = HdibLoadBigResource(0x1c1), vhpalSplash == 0)) && (vhdibTitle != 0)) {
            vhpalSplash = HpalFromDib(vhdibTitle);
        }
        uVar15 = 0x14f8;
        GetClientRect(hwnd, &rc);
        local_18 = rc.right >> 3;
        if (local_18 < 0x78) {
            local_18 = 0x78;
        }
        if (rc.bottom < 0x28a) {
            local_18 = local_18 + local_18 / 6;
        }
        iVar11 = rc.right + local_18 * -4;
        local_16 = iVar11 >> 2;
        local_1a = iVar11 >> 3;
        if (rc.bottom < 0x1f5) {
            local_14 = dyArial8 << 1;
        } else {
            local_14 = (dyArial8 * 5) / 2;
        }
        pWVar12 = &stack0xffa8;
        for (i = 0; i < 4; i = i + 1) {
            pWVar12[-1] = i + 0x1df;
            pWVar12[-2] = uVar15;
            pWVar12[-3] = 0x920c;
            local_32._22_2_ = PszGetCompressedString(pWVar12[-1]);
            pWVar12[-1] = 0x1120;
            pWVar12[-2] = 0x43a;
            uVar15 = local_32._22_2_;
            pWVar12[-3] = 0x1120;
            pWVar12[-4] = uVar15;
            pWVar12[-5] = 0x5000;
            pWVar12[-6] = 0;
            pWVar12[-7] = local_1a;
            pWVar12[-8] = (rc.bottom - local_14) - (dyArial8 * 5) / 2;
            pWVar12[-9] = local_18;
            pWVar12[-10] = local_14;
            pWVar12[-0xb] = hwnd;
            pWVar12[-0xc] = i;
            pWVar12[-0xd] = hInst;
            pWVar12[-0xe] = 0;
            pWVar12[-0xf] = 0;
            pWVar12[-0x10] = 0x1010;
            uVar15 = 0x14f8;
            pWVar12[-0x11] = 0x925f;
            HVar1 = CreateWindow(*(LPCSTR *)(pWVar12 + -2), *(LPCSTR *)(pWVar12 + -4), *(undefined4 *)(pWVar12 + -6), pWVar12[-7], pWVar12[-8], pWVar12[-9],
                                 pWVar12[-10], pWVar12[-0xb], pWVar12[-0xc], pWVar12[-0xd], *(void **)(pWVar12 + -0xf));
            *(HWND *)(i * 2 + rghwndBtnSplash) = HVar1;
            if (i == 2) {
                if (szBase[0] != '\0') {
                    pWVar12[1] = 0;
                    *pWVar12 = (WMType)(char *)szBase;
                    pWVar12[-1] = 0x14f8;
                    uVar15 = 0x1118;
                    pWVar12[-2] = 0x928a;
                    sVar2 = __access((char *)*pWVar12, pWVar12[1]);
                    if (sVar2 != -1)
                        goto LAB_1020_92a2;
                }
                pWVar12[1] = rghwndBtnSplash[2];
                *pWVar12 = 0;
                pWVar12[-1] = uVar15;
                uVar15 = 0x14f8;
                pWVar12[-2] = 0x92a2;
                EnableWindow(pWVar12[1], *pWVar12);
            }
        LAB_1020_92a2:
            if (rc.bottom < 500) {
                pWVar12[1] = *(undefined2 *)(i * 2 + rghwndBtnSplash);
                *pWVar12 = 0x30;
                pWVar12[-1] = rghfontArial8[1];
                pWVar12[-2] = 0;
                pWVar12[-3] = 0;
                pWVar12[-4] = uVar15;
                uVar15 = 0x14f8;
                pWVar12[-5] = 0x92ca;
                SendMessage(pWVar12[1], *pWVar12, pWVar12[-1], *(undefined4 *)(pWVar12 + -3));
            }
            local_1a = local_1a + local_18 + local_16;
            pWVar12 = pWVar12 + 2;
        }
    } else {
        if (msg == WM_DESTROY) {
            if (vhdibTitle != 0) {
                GlobalUnlock(vhdibTitle);
                uVar15 = 0x14f8;
                FreeResource(vhdibTitle);
                vhdibTitle = 0;
            }
            puVar14 = &stack0xffa8;
            if (fFreeingTitle == 0) {
                if ((gd.grBits._2_2_ >> 6 & 1) == 0) {
                    WriteIniSettings();
                    uVar15 = 0x14f8;
                    PostQuitMessage(vretExitValue);
                    puVar14 = &stack0xffa6;
                } else {
                    uVar15 = 0x14f8;
                    ExitWindows((long)vretExitValue, 0);
                    puVar14 = &stack0xffa8;
                }
            }
        MDI_Default_3:
            *(HWND *)(puVar14 + -2) = hwnd;
            *(WMType *)(puVar14 + -4) = msg;
            *(ushort *)(puVar14 + -6) = wParam;
            *(undefined2 *)(puVar14 + -8) = lParam._2_2_;
            *(undefined2 *)(puVar14 + -10) = (undefined2)lParam;
            *(undefined2 *)(puVar14 + -0xc) = uVar15;
            *(undefined2 *)(puVar14 + -0xe) = 0x97f6;
            LVar16 = DefWindowProc(*(HWND *)(puVar14 + -2), *(UINT *)(puVar14 + -4), *(WPARAM *)(puVar14 + -6), *(LPARAM *)(puVar14 + -10));
            return LVar16;
        }
        if (msg == WM_PAINT) {
            BVar5 = IsIconic(hwnd);
            if (BVar5 == 0) {
                pLVar6 = (LOGFONT *)LocalAlloc(0x40, 0x32);
                HVar7 = BeginPaint(hwnd, local_32);
                hbrSav = SelectObject(HVar7, hbrButtonFace);
                GetClientRect(hwnd, &rcWnd);
                if ((vcScreenColors < 8) || (SetTextColor(HVar7, 0x2ff7fff), vhdibTitle == 0)) {
                    rc.left = 0;
                    rc.right = rcWnd.right;
                    rc.bottom = 0;
                    DrawABunchOfStars(HVar7, &rcWnd);
                    pLVar6->lfHeight = -rcWnd.bottom / 3;
                    _strcpy(pLVar6->lfFaceName, *(char (*)[32])(rgszArial + 3));
                    HVar8 = CreateFontIndirect(pLVar6);
                    uVar15 = 0x14f8;
                    SetTextColor(HVar7, 0x9b009b);
                    puVar13 = &stack0xffa8;
                    if (HVar8 != 0) {
                        HVar9 = SelectObject(HVar7, HVar8);
                        SetBkMode(HVar7, 1);
                        puVar13 = &stack0xffa8;
                        rcT.left = rcWnd.left;
                        rcT.top = rcWnd.top;
                        rcT.right = rcWnd.right;
                        rcT.bottom = (rcWnd.bottom * 3) / 4;
                        RcCtrTextOut(HVar7, &rcT, (char *)0x441, 6);
                        SelectObject(HVar7, HVar9);
                        uVar15 = 0x14f8;
                        DeleteObject(HVar8);
                    }
                } else {
                    SelectPalette(HVar7, vhpalSplash, 0);
                    RealizePalette(HVar7);
                    uVar18 = 600;
                    uVar17 = 800;
                    dySrc = 0;
                    dxSrc = 0;
                    x1 = 1;
                    uVar10 = vhdibTitle;
                    hdib = GetSystemMetrics(1);
                    dy = 0;
                    sVar2 = GetSystemMetrics(0);
                    uVar15 = 0x1040;
                    DibBlt(HVar7, 0, 0, sVar2, dy, hdib, x1, uVar10, dxSrc, dySrc, CONCAT22(uVar18, uVar17));
                    puVar13 = &stack0xffa4;
                }
                *(HDC *)(puVar13 + -2) = HVar7;
                *(ushort *)(puVar13 + -4) = rghfontArial10[1];
                *(undefined2 *)(puVar13 + -6) = uVar15;
                *(undefined2 *)(puVar13 + -8) = 0x975e;
                SelectObject(*(HDC *)(puVar13 + -2), *(HGDIOBJ *)(puVar13 + -4));
                *(HDC *)(puVar13 + -2) = HVar7;
                *(undefined2 *)(puVar13 + -4) = 1;
                *(undefined2 *)(puVar13 + -6) = 0x14f8;
                *(undefined2 *)(puVar13 + -8) = 0x976a;
                SetBkMode(*(HDC *)(puVar13 + -2), *(short *)(puVar13 + -4));
                *(undefined2 *)(puVar13 + -2) = 0x14f8;
                *(undefined2 *)(puVar13 + -4) = 0x976f;
                SzVersion();
                *(ushort *)(puVar13 + -2) = rghwndBtnSplash[0];
                *(undefined2 *)(puVar13 + -4) = unaff_SS;
                *(undefined1 **)(puVar13 + -6) = auStack_44;
                *(undefined2 *)(puVar13 + -8) = 0x1018;
                *(undefined2 *)(puVar13 + -10) = 0x977f;
                GetWindowRect(*(HWND *)(puVar13 + -2), *(RECT **)(puVar13 + -6));
                rcWnd.top = iStack_42 - (dyArial8 * 9) / 2;
                rcWnd.bottom = (dyArial8 * 3) / 2 + rcWnd.top;
                *(char **)(puVar13 + -2) = (char *)szWork;
                *(undefined2 *)(puVar13 + -4) = 0x14f8;
                *(undefined2 *)(puVar13 + -6) = 0x97b0;
                uVar10 = _strlen(*(char **)(puVar13 + -2));
                *(ushort *)(puVar13 + -2) = uVar10;
                *(char **)(puVar13 + -4) = (char *)szWork;
                *(RECT **)(puVar13 + -6) = &rcWnd;
                *(HDC *)(puVar13 + -8) = HVar7;
                *(undefined2 *)(puVar13 + -10) = 0x1118;
                *(undefined2 *)(puVar13 + -0xc) = 0x97c4;
                RcCtrTextOut(*(HDC *)(puVar13 + -8), *(RECT **)(puVar13 + -6), *(char **)(puVar13 + -4), *(short *)(puVar13 + -2));
                *(HWND *)(puVar13 + -2) = hwnd;
                *(undefined2 *)(puVar13 + -4) = unaff_SS;
                *(undefined1 **)(puVar13 + -6) = local_32;
                *(undefined2 *)(puVar13 + -8) = 0x1040;
                *(undefined2 *)(puVar13 + -10) = 0x97d6;
                EndPaint(*(HWND *)(puVar13 + -2), *(PAINTSTRUCT **)(puVar13 + -6));
                *(LOGFONT **)(puVar13 + -2) = pLVar6;
                *(undefined2 *)(puVar13 + -4) = 0x14f8;
                *(undefined2 *)(puVar13 + -6) = 0x97df;
                LocalFree(*(HLOCAL *)(puVar13 + -2));
            } else {
                HVar7 = BeginPaint(hwnd, local_32);
                DrawIcon(HVar7, 2, 2, hiconStars);
                EndPaint(hwnd, local_32);
            }
        } else if (msg == WM_COMMAND) {
            if (wParam == 0) {
                NewGameWizard(hwnd, 0);
                if ((((PLANET *)lpPlanets == (PLANET *)0x0) && (lpPlanets._2_2_ == 0)) && (((int)game.lid == 0 && (game.lid._2_2_ == 0)))) {
                    SetFocus(hwnd);
                } else {
                    if (fFreeingTitle == 0) {
                        fFreeingTitle = 1;
                        DestroyWindow(hwndTitle);
                        hwndTitle = 0;
                    }
                    ShowWindow(hwndFrame, 5);
                }
            } else {
                if (wParam != 1) {
                    if (wParam != 2) {
                        if (wParam != 3) {
                            return 0;
                        }
                        if ((gd.grBits._2_2_ >> 6 & 1) == 0) {
                            WriteIniSettings();
                            PostQuitMessage(vretExitValue);
                            return 0;
                        }
                        ExitWindows((long)vretExitValue, 0);
                        return 0;
                    }
                    ini.wFlags = ini.wFlags & 0xfffe | 1;
                }
                sVar2 = FOpenGame(hwnd, 0);
                if (sVar2 < 1) {
                    SetFocus(hwnd);
                } else {
                    if (fFreeingTitle == 0) {
                        fFreeingTitle = 1;
                        DestroyWindow(hwndTitle);
                        hwndTitle = 0;
                    }
                    if (idPlayer != -1) {
                        ShowWindow(hwndFrame, 5);
                    }
                    InitializeMenu(0);
                    PostMessage(hwndFrame, WM_COMMAND, 0xfa1, 0);
                    if (((game.wCrap >> 3 & 1) != 0) && (idPlayer == 0)) {
                        StartTutor(0);
                    }
                }
                ini.wFlags = ini.wFlags & 0xfffe;
            }
        } else {
            if (msg != WM_QUERYNEWPALETTE) {
                if (msg != WM_PALETTECHANGED)
                    goto MDI_Default_3;
                if (wParam == hwnd) {
                    return 0;
                }
            }
            if (7 < vcScreenColors) {
                HVar7 = GetDC(hwnd);
                HVar3 = SelectPalette(HVar7, vhpalSplash, 0);
                UVar4 = RealizePalette(HVar7);
                SelectPalette(HVar7, HVar3, 0);
                ReleaseDC(hwnd, HVar7);
                if (UVar4 != 0) {
                    InvalidateRect(hwnd, (RECT *)0x0, 1);
                    return 1;
                }
                return 0;
            }
        }
    }
    return 0;
}
