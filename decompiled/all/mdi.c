// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: InitMDIApp
// Address: 1020:0000
// Segment: MEMORY_MDI
// ======================================================================


short InitMDIApp(void)

{
  ATOM AVar1;
  short sVar2;
  undefined2 unaff_SS;
  WNDCLASS wc;
  
                    /* Segment:    5
                       Offset:     00013700
                       Length:     983f
                       Min Alloc:  9840
                       Flags:      1d50
                           Code
                           Discardable
                           Moveable
                           Preload
                           Impure (Non-shareable)
                        */
  wc.style = 0xb;
  wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)((int)rgszArial[1] + 0x10);
  wc.lpfnWndProc._2_2_ = 0x1020;
  wc.cbClsExtra = 0;
  wc.cbWndExtra = 0;
  wc.hInstance = hInst;
  wc.hIcon = 0;
  wc.hCursor = LoadCursor(0,(LPCSTR)0x7f00);
  wc.hbrBackground = 0xd;
  wc.lpszMenuName._0_2_ = (char *)s_StarsMenu_1120_0364;
  wc.lpszMenuName._2_2_ = 0x1120;
  wc.lpszClassName._0_2_ = (char *)szFrame;
  wc.lpszClassName._2_2_ = 0x1120;
  AVar1 = RegisterClass((WNDCLASS *)CONCAT22(unaff_SS,&wc));
  if (AVar1 == 0) {
    sVar2 = 0;
  }
  else {
    wc.style = 0x20b;
    wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)((int)rgplr[3].szNames + 0x10);
    wc.lpfnWndProc._2_2_ = 0x1030;
    wc.hIcon = 0;
    wc.lpszMenuName._0_2_ = (char *)0x0;
    wc.lpszMenuName._2_2_ = 0;
    wc.hbrBackground = GetStockObject(1);
    wc.lpszClassName._0_2_ = (char *)szMessage;
    wc.lpszClassName._2_2_ = 0x1120;
    AVar1 = RegisterClass((WNDCLASS *)CONCAT22(unaff_SS,&wc));
    if (AVar1 == 0) {
      sVar2 = 0;
    }
    else {
      wc.style = 0x20b;
      wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)(rgcrPlrHistory + 1);
      wc.lpfnWndProc._2_2_ = 0x1058;
      wc.hbrBackground = GetStockObject(4);
      wc.lpszClassName._0_2_ = (char *)szScan;
      wc.lpszClassName._2_2_ = 0x1120;
      AVar1 = RegisterClass((WNDCLASS *)CONCAT22(unaff_SS,&wc));
      if (AVar1 == 0) {
        sVar2 = 0;
      }
      else {
        wc.style = 0x20b;
        wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)0x0;
        wc.lpfnWndProc._2_2_ = 0x1028;
        wc.hbrBackground = GetStockObject(1);
        wc.lpszClassName._0_2_ = (char *)szMine;
        wc.lpszClassName._2_2_ = 0x1120;
        AVar1 = RegisterClass((WNDCLASS *)CONCAT22(unaff_SS,&wc));
        if (AVar1 == 0) {
          sVar2 = 0;
        }
        else {
          wc.style = 0x208;
          wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)&hbrDesktop;
          wc.lpfnWndProc._2_2_ = 0x1068;
          wc.hbrBackground = GetStockObject(1);
          wc.lpszClassName._0_2_ = (char *)szTb;
          wc.lpszClassName._2_2_ = 0x1120;
          AVar1 = RegisterClass((WNDCLASS *)CONCAT22(unaff_SS,&wc));
          if (AVar1 == 0) {
            sVar2 = 0;
          }
          else {
            wc.style = 0x200;
            wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)0x0;
            wc.lpfnWndProc._2_2_ = 0x1048;
            wc.hbrBackground = GetStockObject(1);
            wc.hIcon = 0;
            wc.lpszClassName._0_2_ = (char *)szPlanet;
            wc.lpszClassName._2_2_ = 0x1120;
            AVar1 = RegisterClass((WNDCLASS *)CONCAT22(unaff_SS,&wc));
            if (AVar1 == 0) {
              sVar2 = 0;
            }
            else {
              wc.style = 0xa00;
              wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)0x0;
              wc.lpfnWndProc._2_2_ = 0x10c0;
              wc.hbrBackground = GetStockObject(0);
              wc.hIcon = 0;
              wc.lpszClassName._0_2_ = (char *)szPopup;
              wc.lpszClassName._2_2_ = 0x1120;
              AVar1 = RegisterClass((WNDCLASS *)CONCAT22(unaff_SS,&wc));
              if (AVar1 == 0) {
                sVar2 = 0;
              }
              else {
                wc.style = 0xa00;
                wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)0x19e4;
                wc.lpfnWndProc._2_2_ = 0x1068;
                wc.hbrBackground = GetStockObject(0);
                wc.hIcon = 0;
                wc.lpszClassName._0_2_ = (char *)szTooltip;
                wc.lpszClassName._2_2_ = 0x1120;
                AVar1 = RegisterClass((WNDCLASS *)CONCAT22(unaff_SS,&wc));
                if (AVar1 == 0) {
                  sVar2 = 0;
                }
                else {
                  wc.style = 0x200;
                  wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)(rgidPlan + 0x84);
                  wc.lpfnWndProc._2_2_ = 0x10d8;
                  wc.hbrBackground = GetStockObject(1);
                  wc.hIcon = 0;
                  wc.lpszClassName._0_2_ = (char *)szBrowser;
                  wc.lpszClassName._2_2_ = 0x1120;
                  AVar1 = RegisterClass((WNDCLASS *)CONCAT22(unaff_SS,&wc));
                  if (AVar1 == 0) {
                    sVar2 = 0;
                  }
                  else {
                    wc.style = 0;
                    wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)0x9126;
                    wc.lpfnWndProc._2_2_ = 0x1020;
                    wc.cbClsExtra = 0;
                    wc.cbWndExtra = 0;
                    wc.hInstance = hInst;
                    wc.hIcon = 0;
                    wc.hCursor = LoadCursor(0,(LPCSTR)0x7f00);
                    wc.hbrBackground = GetStockObject(4);
                    wc.lpszMenuName._0_2_ = (char *)0x0;
                    wc.lpszMenuName._2_2_ = 0;
                    wc.lpszClassName._0_2_ = (char *)szTitle;
                    wc.lpszClassName._2_2_ = 0x1120;
                    AVar1 = RegisterClass((WNDCLASS *)CONCAT22(unaff_SS,&wc));
                    if (AVar1 == 0) {
                      sVar2 = 0;
                    }
                    else {
                      wc.style = 0xb;
                      wc.lpfnWndProc._0_2_ = (fn_lpfnWndProc *)&hbrWindow;
                      wc.lpfnWndProc._2_2_ = 0x1108;
                      wc.cbClsExtra = 0;
                      wc.cbWndExtra = 0;
                      wc.hInstance = hInst;
                      wc.hIcon = 0;
                      wc.hCursor = LoadCursor(0,(LPCSTR)0x7f00);
                      wc.hbrBackground = GetStockObject(1);
                      wc.lpszMenuName._0_2_ = (char *)0x0;
                      wc.lpszMenuName._2_2_ = 0;
                      wc.lpszClassName._0_2_ = (char *)szReport;
                      wc.lpszClassName._2_2_ = 0x1120;
                      AVar1 = RegisterClass((WNDCLASS *)CONCAT22(unaff_SS,&wc));
                      if (AVar1 == 0) {
                        sVar2 = 0;
                      }
                      else {
                        sVar2 = 1;
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
  return sVar2;
}



// ======================================================================
// Function: CreateChildWindows
// Address: 1020:038c
// Segment: MEMORY_MDI
// ======================================================================


void CreateChildWindows(void)

{
  ushort uVar1;
  int iVar2;
  char *pcVar3;
  undefined2 unaff_SS;
  char *pcVar4;
  undefined2 uVar5;
  char szGame [8];
  undefined1 local_76;
  char *psz;
  short pt;
  short local_6a;
  char szData [102];
  
  if (idPlayer == -1) {
    CchGetString(idsStarsSHostMode,(char *)szWork);
    _WSPRINTF((char *)CONCAT22(unaff_SS,szData),szWork,0x90,0x1120);
  }
  else {
    uVar1 = _strlen((char *)szBase);
    for (psz = (char *)((int)rghbrMinSum[3] + 3 + uVar1);
        (((char *)szBase < psz && (psz[-1] != '\\')) && (psz[-1] != ':')); psz = psz + -1)
    {
    }
    local_76 = 0;
    _strncpy(szGame,psz,8);
    __strlwr(szGame);
    iVar2 = idPlayer + 1;
    uVar5 = 0x1120;
    pcVar4 = (char *)0x36e;
    uVar1 = _strlen(szGame);
    _WSPRINTF((char *)CONCAT22(unaff_SS,szGame + uVar1),(char *)CONCAT22(uVar5,pcVar4),iVar2);
    pcVar4 = szGame;
    pcVar3 = PszPlayerName(idPlayer,0,1,0,0,(PLAYER *)0x0);
    _WSPRINTF((char *)CONCAT22(unaff_SS,szData),s_Stars______s_____s_____s_1120_0373,0x90,0x1120,
              pcVar3,0x1120,pcVar4);
  }
  SetWindowText(hwndFrame,(LPCSTR)CONCAT22(unaff_SS,szData));
  if (idPlayer != -1) {
    if (hwndScanner == 0) {
      hwndScanner =
           CreateWindow(szScan,(LPCSTR)0x0,0x50000000,-200,-200,10,10,hwndFrame,0,
                        hInst,(void *)0x0);
    }
    else {
      InvalidateRect(hwndScanner,(RECT *)0x0,1);
      yScanTop = 1000;
      xScanTop = 1000;
      SetScanScrollBars(hwndScanner);
    }
    if (hwndMine == 0) {
      hwndMine =
           CreateWindow(szMine,(LPCSTR)0x0,0x50000000,-500,-500,pt,local_6a,
                        hwndFrame,0,hInst,(void *)0x0);
    }
    else {
      InvalidateRect(hwndMine,(RECT *)0x0,1);
    }
    if (hwndPlanet == 0) {
      hwndPlanet =
           CreateWindow(szPlanet,(LPCSTR)0x0,0x50000000,-500,-500,10,10,hwndFrame,0
                        ,hInst,(void *)0x0);
    }
    else {
      InvalidateRect(hwndPlanet,(RECT *)0x0,1);
    }
    if (hwndTb == 0) {
      hwndTb =
           CreateWindow(szTb,(LPCSTR)0x0,0x50000000,-500,-500,10,10,hwndFrame,0,
                        hInst,(void *)0x0);
    }
    else {
      InvalidateRect(hwndTb,(RECT *)0x0,1);
    }
    if (hwndMessage != 0) {
      DestroyWindow(hwndMessage);
    }
    hwndMessage =
         CreateWindow(szMessage,(LPCSTR)0x0,0x50000000,-500,-500,10,10,hwndFrame,0,
                      hInst,(void *)0x0);
    szGame[0] = -8;
    szGame[1] = '\x14';
    RefitFrameChildren();
  }
  return;
}



// ======================================================================
// Function: FrameWndProc
// Address: 1020:06d6
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

long FrameWndProc(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  POINT pt_00;
  POINT pt_01;
  POINT pt_02;
  uint uVar1;
  uint uVar2;
  char *pcVar3;
  short sVar4;
  HICON HVar5;
  BOOL BVar6;
  HGDIOBJ HVar7;
  int iVar8;
  ushort uVar9;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar10;
  POINT PVar11;
  LRESULT LVar12;
  char *pcVar13;
  ushort in_stack_0000ff9e;
  POINT dpt;
  POINT dpt_00;
  HBRUSH hbrSav;
  short yOffset;
  undefined1 ps [6];
  int local_24;
  short ptStart;
  short local_20;
  HBRUSH hbrSav__30;
  int lSerial;
  undefined1 rc2 [4];
  undefined1 lpProc [4];
  char *rc__18;
  ushort pt;
  uint ptOld;
  short ich;
  HPALETTE hpalSav;
  short i;
  HDC hdc;
  
  if (message == WM_CREATE) {
    hdc = GetDC(hwnd);
    FCreateFonts(hdc);
    GetTextMetrics(hdc,(TEXTMETRIC *)CONCAT22(unaff_SS,(TEXTMETRIC *)ps));
    dySysFont = ps._0_2_;
    dySBar = (dyArial8 + 0xc) * 2;
    ReleaseDC(hwnd,hdc);
    InitTiles();
    EnsureTileSize((uint)(iWindowLayout == 2));
    return 0;
  }
  if (message == WM_DESTROY) {
    if (uTimerId != 0) {
      KillTimer(0,uTimerId);
    }
    WriteIniSettings();
    uTimerId = 0;
    if (((uint)gd.grBits >> 3 & 1) != 0) {
      FMarkFile(dtHost,-1,1,0);
    }
    DestroyCurGame();
    if ((gd.grBits._2_2_ >> 6 & 1) == 0) {
      PostQuitMessage(vretExitValue);
      return 0;
    }
    ExitWindows((long)vretExitValue,0);
    return 0;
  }
  if (message == WM_SIZE) {
    if ((wParam == 2) || (wParam == 0)) {
      vfs.dx = (int)lParam;
      uVar10 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff9e);
      vfs.dy = (short)uVar10;
      RefitFrameChildren();
      return 0;
    }
MDI_Default_5:
    LVar12 = DefWindowProc(hwnd,message,wParam,lParam);
    return LVar12;
  }
  if (message == WM_ACTIVATE) {
    return 0;
  }
  if (message == WM_PAINT) {
    BVar6 = IsIconic(hwnd);
    if (BVar6 == 0) {
      hdc = BeginPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,(PAINTSTRUCT *)ps));
      HVar7 = SelectObject(hdc,hbrButtonShadow);
      if ((iWindowLayout == 0) ||
         ((iWindowLayout != 1 && (iWindowLayout != 2)))) {
        PatBlt(hdc,vfs.xTop + 5,0,2,vfs.dy,0xf00021);
        PatBlt(hdc,0,vfs.y1 + 5,vfs.xTop + 2,2,0xf00021);
        PatBlt(hdc,0,vfs.y2 + 5,vfs.xTop + 2,2,0xf00021);
        SelectObject(hdc,hbrButtonHilite);
        PatBlt(hdc,vfs.xTop + 1,0,1,vfs.y1 + 2,0xf00021);
        PatBlt(hdc,0,vfs.y1 + 1,vfs.xTop + 1,1,0xf00021);
        PatBlt(hdc,vfs.xTop + 1,vfs.y1 + 6,1,
               (vfs.y2 - vfs.y1) + -4,0xf00021);
        PatBlt(hdc,0,vfs.y2 + 1,vfs.xTop + 1,1,0xf00021);
        PatBlt(hdc,vfs.xTop + 1,vfs.y2 + 6,1,
               (vfs.dy - vfs.y2) + -6,0xf00021);
      }
      else {
        if ((int)gd.grBits._2_2_ < 0) {
          iVar8 = 0x24;
        }
        else {
          iVar8 = 0;
        }
        PatBlt(hdc,vfs.xTop + 5,iVar8,2,(vfs.y2 + 2) - iVar8,0xf00021);
        PatBlt(hdc,0,vfs.y1 + 5,vfs.xTop + 2,2,0xf00021);
        PatBlt(hdc,vfs.xTop + 5,vfs.y2 + 5,
               (vfs.dx - vfs.xTop) + -5,2,0xf00021);
        PatBlt(hdc,vfs.xTop + 5,vfs.y2 + 6,2,
               (vfs.dy - vfs.y2) + -5,0xf00021);
        SelectObject(hdc,hbrButtonHilite);
        PatBlt(hdc,vfs.xTop + 1,iVar8,1,(vfs.y1 + 2) - iVar8,0xf00021);
        PatBlt(hdc,0,vfs.y1 + 1,vfs.xTop + 1,1,0xf00021);
        PatBlt(hdc,vfs.xTop + 1,vfs.y1 + 6,1,
               (vfs.dy - vfs.y1) + -6,0xf00021);
        PatBlt(hdc,vfs.xTop + 6,vfs.y2 + 1,
               (vfs.dx - vfs.xTop) + -6,1,0xf00021);
      }
      SelectObject(hdc,HVar7);
      EndPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,(PAINTSTRUCT *)ps));
      return 0;
    }
    hdc = BeginPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,(PAINTSTRUCT *)ps));
    if (((idPlayer != -1) ||
        ((HVar5 = hiconHost, (int)game.lid == 0 && (game.lid._2_2_ == 0)))) &&
       (HVar5 = hiconStars, uTimerId != 0)) {
      HVar5 = hiconWait;
    }
    DrawIcon(hdc,2,2,HVar5);
    EndPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,(PAINTSTRUCT *)ps));
    return 0;
  }
  if (message == WM_CLOSE) {
    DestroyWindow(hwnd);
    return 0;
  }
  if (message == WM_ERASEBKGND) {
    BVar6 = IsIconic(hwnd);
    if (BVar6 != 0) {
      GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,(RECT *)&stack0xffee));
      FillRect(wParam,(RECT *)CONCAT22(unaff_SS,(RECT *)&stack0xffee),hbrDesktop);
      return 0;
    }
    GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,(RECT *)&stack0xffee));
    if (hwndScanner != 0) {
      GetClientRect(hwndScanner,(RECT *)CONCAT22(unaff_SS,(RECT *)rc2));
      MapWindowPoints(hwndScanner,hwnd,(POINT *)CONCAT22(unaff_SS,(POINT *)rc2),2);
      ExcludeClipRect(wParam,rc2._0_2_,rc2._2_2_,lpProc._0_2_,lpProc._2_2_);
    }
    FillRect(wParam,(RECT *)CONCAT22(unaff_SS,(RECT *)&stack0xffee),hbrButtonFace);
    return 1;
  }
  if ((message == WM_SYSCOLORCHANGE) || (message == WM_WININICHANGE)) {
    FGetSystemColors();
    return 0;
  }
  if (message == WM_SETCURSOR) {
    ich = 0;
    BVar6 = IsIconic(hwnd);
    if (BVar6 == 0) {
      GetCursorPos((POINT *)CONCAT22(unaff_SS,(POINT *)&stack0xfff0));
      ScreenToClient(hwndFrame,(POINT *)CONCAT22(unaff_SS,(POINT *)&stack0xfff0));
      GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,(RECT *)(rc2 + 2)));
      PVar11.y._0_1_ = (char)ptOld;
      PVar11.x = pt;
      PVar11.y._1_1_ = (char)(ptOld >> 8);
      BVar6 = PtInRect((RECT *)CONCAT22(unaff_SS,(RECT *)(rc2 + 2)),PVar11);
      if (BVar6 != 0) {
        pt_00.y = ptOld;
        pt_00.x = pt;
        ich = HcrsFromFrameWindowPt(pt_00,(short *)0x0);
        if (ich != 0) {
          setcursor(ich);
          return 1;
        }
        ich = 0;
      }
    }
    goto MDI_Default_5;
  }
  if (message == WM_GETMINMAXINFO) {
    *(undefined2 *)((int)lParam + 0xc) = 0x208;
    *(undefined2 *)((int)lParam + 0xe) = 0x17c;
    return 0;
  }
  if (message == WM_QUERYDRAGICON) {
    HVar5 = hiconHost;
    if ((idPlayer != -1) && (HVar5 = hiconStars, uTimerId != 0)) {
      HVar5 = hiconWait;
    }
    return (ulong)HVar5;
  }
  if (message == WM_CHAR) {
    if ((hwndScanner != 0) && ((wParam == 0x2d || (wParam == 0x2b)))) {
      SendMessage(hwndScanner,0x102,wParam,lParam);
      return 0;
    }
    if ((hwndMessage != 0) && (((wParam == 0x2d || (wParam == 0x2b)) || (wParam == 0xd)))) {
      SendMessage(hwndMessage,0x102,wParam,lParam);
      return 0;
    }
    if ((hwndPlanet != 0) && ((wParam == 0x66 || (wParam == 0x46)))) {
      SendMessage(hwndPlanet,0x102,wParam,lParam);
      return 0;
    }
    if ((hwndPlanet != 0) &&
       ((sel.grobj == grobjPlanet && ((wParam == 0x71 || (wParam == 0x51)))))) {
      ChangeProduction(0);
      return 0;
    }
    if ((sel.grobj & (grobjFleet|grobjPlanet)) == grobjNone) {
      return 0;
    }
    ich = 0;
    ptOld = 0;
    if (wParam == 0x6e) {
      ich = 1;
    }
    else if ((wParam == 0x4e) || (wParam == 0x50)) {
      if (sel.grobj == grobjPlanet) {
        ptOld = IdFindAdjStarbase(sel.pl.id,(uint)(wParam == 0x4e));
      }
      else if (wParam == 0x4e) {
        ich = 1;
      }
      else {
        ich = -1;
      }
    }
    else if (wParam == 0x70) {
      ich = -1;
    }
    else if (((wParam == 0x72) || (wParam == 0x52)) && (sel.grobj == grobjFleet)) {
      ShipCommandProc(hwndPlanet,0,(ulong)rghwndBtn[6]);
    }
    if ((ich == 0) && (ptOld == 0)) {
      return 0;
    }
    if (sel.grobj != grobjFleet) {
      SelectAdjPlanet(ich,ptOld);
      return 0;
    }
    SelectAdjFleet(ich,ptOld);
    return 0;
  }
  if (message == WM_COMMAND) {
    CommandHandler(hwnd,wParam);
    return 0;
  }
  if (message == WM_SYSCOMMAND) {
    if (((wParam & 0xfff0) == 0xf030) || ((wParam & 0xfff0) == 0xf120)) {
      ich = idPlayer;
      pt = uTimerId;
      if (uTimerId != 0) {
        KillTimer(0,uTimerId);
        uTimerId = 0;
        CreateChildWindows();
      }
      if ((idPlayer == -1) || (sVar4 = FNewTurnAvail(idPlayer), sVar4 == 0)) {
        if (pt != 0) {
          if (uTimerType == 0xd) {
            PostMessage(hwnd,0x465,0,0);
          }
          else {
            if (uTimerType == 0xe) {
              pcVar13 = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 1;
              pcVar3 = PszFormatIds(idsTurnHasSubmittedChangesMadeAfterTurn,(short *)0x0);
              ptOld = AlertSz(pcVar3,(short)pcVar13);
              if ((ptOld == 6) && (sVar4 = FMarkFile(dtLog,idPlayer,2,0), sVar4 == 0)) {
                sVar4 = 0x10;
                pcVar3 = PszFormatIds(idsNewTurnCurrentlyGeneratedHostNewTurn,(short *)0x0);
                AlertSz(pcVar3,sVar4);
                _WSPRINTF((char *)CONCAT22(unaff_SS,lpProc + 2),
                          (char *)CONCAT22(0x1120,MPCTD),idPlayer + 1);
                DestroyCurGame();
                sVar4 = FLoadGame((char *)szBase,lpProc + 2);
                if (sVar4 == 0) {
                  sVar4 = 0x10;
                  pcVar3 = PszFormatIds(idsUnableOpenNewTurnFile,(short *)0x0);
                  AlertSz(pcVar3,sVar4);
                }
                else {
                  CreateChildWindows();
                }
              }
              else if (ptOld == 2) {
                PostMessage(hwndFrame,0x111,0x6a,0);
                return 1;
              }
            }
            SendMessage(hwndFrame,0x111,0xfa1,0);
            if ((1000 < sel.pt.x) && (1000 < sel.pt.y)) {
              pt_01.y = sel.pt.y;
              pt_01.x = sel.pt.x;
              CtrPointScan(pt_01,1);
            }
          }
        }
      }
      else {
        if (pt == 0) {
          pcVar13 = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 1;
          pcVar3 = PszFormatIds(idsNewTurnAvailableWouldLikeLoad,(short *)0x0);
          ptOld = AlertSz(pcVar3,(short)pcVar13);
        }
        else {
          sVar4 = 0x40;
          pcVar3 = PszFormatIds(idsNewTurnAvailable,(short *)0x0);
          AlertSz(pcVar3,sVar4);
          ptOld = 6;
        }
        if (ptOld == 6) {
          _WSPRINTF((char *)CONCAT22(unaff_SS,lpProc + 2),(char *)CONCAT22(0x1120,MPCTD),
                    idPlayer + 1);
          DestroyCurGame();
          sVar4 = FLoadGame((char *)szBase,lpProc + 2);
          if (sVar4 == 0) {
            sVar4 = 0x10;
            pcVar3 = PszFormatIds(idsUnableOpenNewTurnFile,(short *)0x0);
            AlertSz(pcVar3,sVar4);
          }
          else {
            CreateChildWindows();
          }
        }
        else if (ptOld == 2) {
          if (pt == 0) {
            PostMessage(hwndFrame,0x112,0xf020,0);
          }
          else {
            PostMessage(hwndFrame,0x111,0x6a,0);
          }
          return 1;
        }
        SendMessage(hwndFrame,0x111,0xfa1,0);
      }
    }
    goto MDI_Default_5;
  }
  if (message == WM_INITMENU) {
    InitializeMenu(wParam);
    return 0;
  }
  if (message == WM_ENTERIDLE) {
    if ((((uint)gd.grBits >> 0xb & 1) != 0) && (((uint)tutor.wFlags >> 2 & 1) != 0)
       ) {
      AdvanceTutor();
    }
    return 0;
  }
  if (message == WM_LBUTTONDOWN) {
    lpProc._2_2_ = (int)lParam;
    uVar10 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff9e);
    rc__18 = (char *)uVar10;
    pt_02.y = (short)rc__18;
    pt_02.x = lpProc._2_2_;
    uVar9 = HcrsFromFrameWindowPt(pt_02,(short *)&stack0xfff0);
    if (uVar9 == 0) {
      return 0;
    }
    hdc = GetDC(hwnd);
    hbrSav__30 = SelectObject(hdc,hbr50Screen);
    rc2._0_2_ = 0;
    lSerial = 0;
    InvertPaneBorder(hdc,pt,(POINT)0x0,(POINT *)0x0);
    ptStart = lpProc._2_2_;
    local_20 = (short)rc__18;
    SetCapture(hwnd);
    ptOld = lpProc._2_2_;
    ich = (short)rc__18;
    rc2._2_2_ = 0;
    lpProc._0_2_ = 0;
    while( true ) {
      sVar4 = FGetMouseMove((POINT *)(lpProc + 2));
      if (sVar4 == 0) break;
      if ((lpProc._2_2_ != ptOld) || (rc__18 != (char *)ich)) {
        lSerial = lpProc._2_2_ - ptStart;
        rc2._0_2_ = (int)rc__18 - local_20;
        ps._4_2_ = lpProc._2_2_ - ptOld;
        local_24 = (int)rc__18 - ich;
        dpt.y = rc2._0_2_;
        dpt.x = lSerial;
        PVar11 = InvertPaneBorder(hdc,pt,dpt,(POINT *)(ps + 4));
        ptOld = lpProc._2_2_;
        ich = (short)rc__18;
        unique0x10001b31 = PVar11;
      }
    }
    dpt_00.y = rc2._0_2_;
    dpt_00.x = lSerial;
    InvertPaneBorder(hdc,pt,dpt_00,(POINT *)0x0);
    ReleaseCapture();
    SelectObject(hdc,hbrSav__30);
    ReleaseDC(hwnd,hdc);
    if (stack0xffe8 == (POINT)0x0) {
      return 0;
    }
    if ((pt & 1) != 0) {
      if (iWindowLayout == 0) {
        vfs.dxPlanWant = vfs.xTop + rc2._2_2_;
      }
      else {
        vfs.dx2PlanWant = vfs.xTop + rc2._2_2_;
      }
    }
    if ((pt & 2) != 0) {
      if (iWindowLayout == 0) {
        vfs.dyMsgWant = ((vfs.y2 - vfs.y1) + -8) - lpProc._0_2_;
      }
      else {
        vfs.dy2MsgWant = ((vfs.dy - vfs.y1) + -8) - lpProc._0_2_;
      }
    }
    if ((pt & 4) != 0) {
      if (iWindowLayout == 0) {
        vfs.dyMsgWant = (vfs.y2 - vfs.y1) + -8 + lpProc._0_2_;
        vfs.dyMinWant = ((vfs.dy - vfs.y2) + -8) - lpProc._0_2_;
      }
      else {
        vfs.dy2MinWant = ((vfs.dy - vfs.y2) + -8) - lpProc._0_2_;
      }
    }
    InvalidateRect(hwnd,(RECT *)0x0,1);
    RefitFrameChildren();
    return 0;
  }
  if (message == WM_QUERYNEWPALETTE) {
MDI_MapIt_2:
    if (hwndTitle != 0) {
      LVar12 = SendMessage(hwndTitle,message,wParam,lParam);
      return LVar12;
    }
    hdc = GetDC(hwnd);
    hpalSav = SelectPalette(hdc,vhpal,0);
    i = RealizePalette(hdc);
    SelectPalette(hdc,hpalSav,0);
    ReleaseDC(hwnd,hdc);
    if (i != 0) {
      InvalidateRect(hwnd,(RECT *)0x0,1);
      return 1;
    }
    return 0;
  }
  if (message == WM_PALETTECHANGED) {
    if (wParam == hwnd) {
      return 0;
    }
    goto MDI_MapIt_2;
  }
  if (message != 0x464) {
    if (message == 0x465) {
      BringUpHostDlg();
      return 1;
    }
    if (message == 0x466) {
      ShowTutor(0);
      game.fDirty = 0;
      DestroyCurGame();
      ich = fFileErrSilent;
      fFileErrSilent = 1;
      gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffd | 2;
      sVar4 = FLoadGame((char *)szBase,(char *)0x3c8);
      if (sVar4 != 0) {
        gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffd;
        fFileErrSilent = ich;
        idPlayer = 0;
        if (wParam == 0x9ca) {
          gd.grBits._0_2_ = (uint)gd.grBits & 0xfffd | 2;
          _WSPRINTF(szWork,(char *)0x112003cb,(char *)szBase,0x1120);
          sVar4 = FLoadLogFile((char *)szWork);
          if (sVar4 != 0) {
            FRunLogFile();
          }
          gd.grBits._0_2_ = (uint)gd.grBits & 0xfffd;
        }
        CreateChildWindows();
        SendMessage(hwndFrame,0x111,0xfa1,0);
        if (wParam == 0x9ca) {
          SendMessage(hwndMessage,0x100,0x23,0);
        }
        tutor.idt = 0;
        ptOld = (uint)(wParam == 0x9ca);
        tutor.wFlags = tutor.wFlags & 0xfdf7U | ptOld << 9;
        AdvanceTutor();
        return 0;
      }
      fFileErrSilent = ich;
      gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfffd;
      return 0;
    }
    goto MDI_Default_5;
  }
  idPlayer = -1;
  if ((ini.wFlags >> 1 & 1) != 0) {
    uVar1 = ini.wFlags & 0xfffd;
    if ((ini.wFlags >> 0xe & 1) != 0) {
      fFileErrSilent = 1;
      ini.wFlags = uVar1;
      ClearFile(7);
      sVar4 = FLoadGame((char *)szBase,(char *)0x38e);
      if (sVar4 != 0) {
        VerifyTurns();
        DestroyCurGame();
        EnsureAis();
        _WSPRINTF((char *)CONCAT13((char)((uint)unaff_SS >> 8),CONCAT12((char)unaff_SS,&stack0xff9e)
                                  ),s___s__Year___d_1120_0392,0x90,0x1120,game.turn + 0x960);
        OutputSz(7,(char *)CONCAT22(unaff_SS,&stack0xff9e));
        for (i = 0; i < game.cPlayer; i = i + 1) {
          if (((short *)rgOut)[i] + 1 < 4) {
            ich = _WSPRINTF((char *)CONCAT22(unaff_SS,&stack0xff9e),(char *)0x112003ac,i + 1);
          }
          else {
            ich = _WSPRINTF((char *)CONCAT22(unaff_SS,&stack0xff9e),s_Error___d__1120_03a0,i + 1);
          }
          if ((gd.grBits2._2_2_ >> 6 & 1) == 0) {
            pcVar3 = PszPlayerName(i,1,1,1,0,(PLAYER *)0x0);
            sVar4 = _WSPRINTF((char *)CONCAT22(unaff_SS,&stack0xff9e + ich),(char *)0x112003b1,
                              pcVar3,0x1120);
            ich = ich + sVar4;
          }
          pcVar3 = PszGetCompressedString(((short *)rgOut)[i] + idsTurned);
          _strcat(&stack0xff9e,pcVar3);
          if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 4 & 1) != 0) {
            _strcat(&stack0xff9e,(char *)s___HACKER_1120_03b7);
          }
          OutputSz(7,(char *)CONCAT22(unaff_SS,&stack0xff9e));
        }
      }
MDI_LExit:
      if ((gd.grBits._2_2_ >> 6 & 1) == 0) {
        PostQuitMessage(vretExitValue);
      }
      else {
        ExitWindows((long)vretExitValue,0);
      }
      return 0;
    }
    if ((ini.wFlags >> 10 & 1) != 0) {
      if (((int)vSerialNumber != 0) ||
         (ini.wFlags = uVar1, vSerialNumber._2_2_ != 0)) {
        ini.wFlags = uVar1;
        GenNewGameFromFile((char *)szBase);
      }
      goto MDI_LExit;
    }
    uVar2 = ini.wFlags >> 3;
    ini.wFlags = uVar1;
    if ((uVar2 & 1) != 0) {
      while( true ) {
        while ((((ini.wFlags >> 2 & 1) == 0 && ((ini.wFlags >> 4 & 1) == 0)) ||
               (sVar4 = CTurnsOutSafe(), sVar4 == 0))) {
          EnsureAis();
          FGenerateTurn();
          if (((ini.wFlags >> 9 & 1) != 0) && (_lpchBatch < _lpchBatchMac))
          goto MDI_LTryNextBatch;
          if (ini.cTurnGen == 0) goto MDI_LExit;
          ini.cTurnGen = ini.cTurnGen + -1;
        }
        if ((ini.wFlags >> 4 & 1) == 0) goto LAB_1020_0b67;
        if (((ini.wFlags >> 9 & 1) == 0) || (_lpchBatchMac <= _lpchBatch)) break;
MDI_LTryNextBatch:
        DestroyCurGame();
        rc__18 = (char *)szBase;
        while( true ) {
          if ((*_lpchBatch == '\n') ||
             ((_lpchBatch == _lpchBatchMac && (lpchBatch_2 == iRam112051b2)))) break;
          *rc__18 = *_lpchBatch;
          _lpchBatch = (char *)CONCAT22(lpchBatch_2,_lpchBatch + 1);
          rc__18 = rc__18 + 1;
        }
        _lpchBatch = (char *)CONCAT22(lpchBatch_2,_lpchBatch + 1);
        rc__18[-1] = '\0';
        ini.wFlags = ini.wFlags & 0xfffe | 1;
      }
      goto MDI_LExit;
    }
LAB_1020_0b67:
    CommandHandler(hwnd,0xed9);
    if ((ini.wFlags >> 4 & 1) != 0) goto MDI_LExit;
    if ((ini.wFlags >> 3 & 1) != 0) goto MDI_LNop;
    if (((int)game.lid != 0) || (game.lid._2_2_ != 0)) {
      if ((idPlayer != -1) &&
         ((((ini.wFlags >> 0xc & 1) != 0 || ((ini.wFlags >> 0xb & 1) != 0)) ||
          ((ini.wFlags >> 0xd & 1) != 0)))) {
        if ((ini.wFlags >> 0xd & 1) != 0) {
          PostMessage(hwndFrame,0x111,0x55,0);
        }
        if ((ini.wFlags >> 0xc & 1) != 0) {
          PostMessage(hwndFrame,0x111,0x54,0);
        }
        if ((ini.wFlags >> 0xb & 1) != 0) {
          PostMessage(hwndFrame,0x111,0x53,0);
        }
        goto MDI_LExit;
      }
      ShowWindow(hwndFrame,5);
      InitializeMenu(0);
      PostMessage(hwndFrame,0x111,0xfa1,0);
      if ((ini.wFlags >> 2 & 1) != 0) {
        ini.wFlags = ini.wFlags & 0xfffb;
        CommandHandler(hwnd,0x6a);
      }
      goto MDI_LNop;
    }
  }
  if (hwndTitle == 0) {
    pt = GetSystemMetrics(0);
    ptOld = GetSystemMetrics(1);
    hwndTitle =
         CreateWindow(szTitle,(LPCSTR)0x112003c1,0x90000000,0,0,pt,ptOld,hwndFrame,
                      0,hInst,(void *)0x0);
    fFreeingTitle = 0;
  }
  ini.wFlags = ini.wFlags & 0xfffe;
  DestroyCurGame();
MDI_LNop:
  if ((((int)vSerialNumber != 0) || (vSerialNumber._2_2_ != 0)) &&
     (sVar4 = _memcmp((byte *)vrgbMachineConfig,(byte_0_ *)&vrgbEnvCur,
                              0xb), sVar4 == 0)) {
    return 0;
  }
  if (((int)vSerialNumber == 0) && (vSerialNumber._2_2_ == 0)) {
    szWork[200] = '\0';
  }
  else {
    szWork[200] = '\x01';
  }
  lpProc = (undefined1  [4])MakeProcInstance(MsgDlg,hInst);
  pcVar3 = (char *)hwndTitle;
  if (hwndTitle == 0) {
    pcVar3 = (char *)hwndFrame;
  }
  rc2._2_2_ = DialogBox(0,(LPCSTR)CONCAT22(0x56,pcVar3),(HWND)((ulong)lpProc >> 0x10),
                        SUB41(lpProc,0));
  FreeProcInstance((FARPROC)lpProc);
  if (rc2._2_2_ == 0) {
    vSerialNumber._0_2_ = 0;
    vSerialNumber._2_2_ = 0;
    _memcpy((byte *)vrgbMachineConfig,(byte_0_ *)&vrgbEnvCur,0xb);
    PostQuitMessage(vretExitValue);
  }
  else {
    sVar4 = FValidSerialNo((char *)szWork,(long *)&lSerial);
    if (sVar4 == 0) {
      if (((int)vSerialNumber == 0) && (vSerialNumber._2_2_ == 0)) {
        _memcpy((byte *)vrgbMachineConfig,(byte_0_ *)&vrgbEnvCur,0xb);
        PostQuitMessage(vretExitValue);
      }
    }
    else {
      vSerialNumber._0_2_ = lSerial;
      vSerialNumber._2_2_ = rc2._0_2_;
      _memcpy((byte *)vrgbMachineConfig,(byte_0_ *)&vrgbEnvCur,0xb);
    }
  }
  WriteIniSettings();
  return 0;
}



// ======================================================================
// Function: InvertPaneBorder
// Address: 1020:1e3c
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Variable defined which should be unmapped: x */
/* WARNING: Variable defined which should be unmapped: dyMin */

POINT InvertPaneBorder(HDC hdc,short grSel,POINT dpt,POINT *pdptPrev)

{
  POINT dpt_00;
  short sVar1;
  int iVar2;
  short sVar3;
  short dyMin;
  short x;
  short dxScanMin;
  short dyPlanMin;
  short dyMinAboveH2;
  short dyMsgCur;
  short dyAboveMinCur;
  int dptPrev;
  short dChg;
  short notMin;
  
  sVar3 = dpt.x;
  if ((pdptPrev != (POINT *)0x0) && (grSel != 1)) {
    dpt_00.y = dpt.y - pdptPrev->y;
    dpt_00.x = dpt.x - pdptPrev->x;
    InvertPaneBorder(hdc,grSel,dpt_00,(POINT *)0x0);
  }
  if ((iWindowLayout == 0) ||
     ((iWindowLayout != 1 && (iWindowLayout != 2)))) {
    dxScanMin = 100;
    dyPlanMin = 0x32;
    iVar2 = vfs.y2 - vfs.y1;
    dyAboveMinCur = (vfs.y2 - vfs.y1) + -8;
    notMin = 1;
    dyMinAboveH2 = (dyArial8 * 0xd >> 1) + 10;
  }
  else {
    dxScanMin = 200;
    dyPlanMin = 100;
    iVar2 = vfs.dy - vfs.y1;
    dyAboveMinCur = vfs.y2;
    notMin = -1;
    dyMinAboveH2 = 100;
  }
  dyMsgCur = iVar2 + -8;
  if (vfs.xTop + dpt.x < 0xc6) {
    dpt.x = 0xc6 - vfs.xTop;
  }
  if ((vfs.dx - vfs.xTop) - dpt.x < dxScanMin) {
    dpt.x = (vfs.dx - vfs.xTop) - dxScanMin;
  }
  if (0x18c < vfs.xTop + dpt.x) {
    dpt.x = 0x18c - vfs.xTop;
  }
  if ((grSel & 2U) != 0) {
    if (vfs.y1 + dpt.y < dyPlanMin) {
      dpt.y = dyPlanMin - vfs.y1;
    }
    else {
      iVar2 = (dyArial8 * 0xd >> 1) + 10;
      if (dyMsgCur - dpt.y < iVar2) {
        dpt.y = dyMsgCur - iVar2;
      }
    }
  }
  if ((grSel & 4U) != 0) {
    if (dyAboveMinCur + dpt.y < dyMinAboveH2) {
      dpt.y = (dyMinAboveH2 - dyAboveMinCur) * notMin;
    }
    else {
      iVar2 = dyArial8 * 0xd + -0x24;
      if (((vfs.dy - vfs.y2) + -8) - dpt.y < iVar2) {
        dpt.y = ((vfs.dy - vfs.y2) + -8) - iVar2;
      }
    }
  }
  sVar1 = dpt.x;
  if (pdptPrev != (POINT *)0x0) {
    iVar2 = sVar3 - pdptPrev->x;
    if (vfs.xTop + iVar2 < 0xc6) {
      iVar2 = 0xc6 - vfs.xTop;
    }
    if ((vfs.dx - vfs.xTop) - iVar2 < dxScanMin) {
      iVar2 = (vfs.dx - vfs.xTop) - dxScanMin;
    }
    if (0x18c < vfs.xTop + iVar2) {
      iVar2 = 0x18c - vfs.xTop;
    }
    dptPrev = dpt.x - iVar2;
  }
  sVar3 = dpt.y;
  switch(grSel) {
  default:
    dpt = (POINT)((ulong)dpt & 0xffff);
    if ((pdptPrev == (POINT *)0x0) || (sVar3 = _abs(dptPrev), 5 < sVar3)) {
      if (pdptPrev != (POINT *)0x0) {
        PatBlt(hdc,((vfs.xTop + sVar1) - dptPrev) + 1,0,6,vfs.dy,0x5a0049);
      }
      PatBlt(hdc,vfs.xTop + sVar1 + 1,0,6,vfs.dy,0x5a0049);
    }
    else {
      dChg = dptPrev;
      if (dptPrev != 0) {
        if (dptPrev < 0) {
          dChg = -dptPrev;
        }
        PatBlt(hdc,hdc,0,dChg,vfs.dy,0x5a0049);
        PatBlt(hdc,hdc + 6,0,dChg,vfs.dy,0x5a0049);
      }
    }
    break;
  case 2:
    dpt = (POINT)((ulong)(uint)dpt.y << 0x10);
    PatBlt(hdc,0,vfs.y1 + sVar3 + 1,vfs.xTop + 1,6,0x5a0049);
    break;
  case 3:
    PatBlt(hdc,vfs.xTop + dpt.x + 1,0,6,vfs.dy,0x5a0049);
    PatBlt(hdc,0,vfs.y1 + dpt.y + 1,vfs.xTop + dpt.x + 1,6,0x5a0049);
    break;
  case 4:
    dpt = (POINT)((ulong)(uint)dpt.y << 0x10);
    if (iWindowLayout == 0) {
      PatBlt(hdc,0,vfs.y2 + sVar3 + 1,vfs.xTop + 1,6,0x5a0049);
    }
    else {
      PatBlt(hdc,vfs.xTop + 7,vfs.y2 + sVar3 + 1,
             (vfs.dx - vfs.xTop) + -7,6,0x5a0049);
    }
    break;
  case 5:
    PatBlt(hdc,vfs.xTop + dpt.x + 1,0,6,vfs.dy,0x5a0049);
    if (iWindowLayout == 0) {
      PatBlt(hdc,0,vfs.y2 + dpt.y + 1,vfs.xTop + dpt.x + 1,6,0x5a0049);
    }
    else {
      PatBlt(hdc,vfs.xTop + dpt.x + 7,vfs.y2 + dpt.y + 1,
             ((vfs.dx - dpt.x) - vfs.xTop) + -7,6,0x5a0049);
    }
    break;
  case 7:
    PatBlt(hdc,vfs.xTop + dpt.x + 1,0,6,vfs.dy,0x5a0049);
    PatBlt(hdc,0,vfs.y1 + dpt.y + 1,vfs.xTop + dpt.x + 1,6,0x5a0049);
    PatBlt(hdc,vfs.xTop + dpt.x + 7,vfs.y2 + dpt.y + 1,
           ((vfs.dx - dpt.x) - vfs.xTop) + -7,6,0x5a0049);
  }
  return dpt;
}



// ======================================================================
// Function: HcrsFromFrameWindowPt
// Address: 1020:24b0
// Segment: MEMORY_MDI
// ======================================================================


ushort HcrsFromFrameWindowPt(POINT pt,short *pgrSel)

{
  int iVar1;
  int iVar2;
  short fInVBar;
  short fInHBar1;
  short fInHBar2;
  ushort hcs;
  
  hcs = 0;
  if ((pt.x < vfs.xTop) || (vfs.xTop + 8 <= pt.x)) {
    iVar1 = 0;
  }
  else {
    iVar1 = 1;
  }
  if (((pt.x < vfs.xTop + 8) && (vfs.y1 <= pt.y)) &&
     (pt.y < vfs.y1 + 8)) {
    iVar2 = 1;
  }
  else {
    iVar2 = 0;
  }
  if ((iWindowLayout == 0) ||
     ((iWindowLayout != 1 && (iWindowLayout != 2)))) {
    if (((pt.x < vfs.xTop + 8) && (vfs.y2 <= pt.y)) &&
       (pt.y < vfs.y2 + 8)) {
      fInHBar2 = 1;
    }
    else {
      fInHBar2 = 0;
    }
  }
  else if ((pt.x < vfs.xTop) ||
          ((pt.y < vfs.y2 || (vfs.y2 + 8 <= pt.y)))) {
    fInHBar2 = 0;
  }
  else {
    fInHBar2 = 1;
  }
  if (iVar1 == 0) {
    if ((iVar2 != 0) || (fInHBar2 != 0)) {
      hcs = hcurResizeNS;
    }
  }
  else if ((iVar2 == 0) && (fInHBar2 == 0)) {
    hcs = hcurResizeWE;
  }
  else {
    hcs = hcurResize4Way;
  }
  if (pgrSel != (short *)0x0) {
    *pgrSel = iVar2 * 2 + iVar1 + fInHBar2 * 4;
  }
  return hcs;
}



// ======================================================================
// Function: RestoreSelection
// Address: 1020:2614
// Segment: MEMORY_MDI
// ======================================================================


void RestoreSelection(void)

{
  int iVar1;
  FLEET *pFVar2;
  PLANET *pPVar3;
  PLANET *lppl;
  
  if (((ini.idPlayer == idPlayer) &&
      ((int)ini.lid == (int)game.lid)) &&
     (ini.lid._2_2_ == game.lid._2_2_)) {
    if ((ini.wFlags >> 5 & 0xf) == 2) {
      pFVar2 = LpflFromId(ini.iObjSel);
      if (pFVar2 == (FLEET *)0x0) {
        ini.wFlags = ini.wFlags & 0xfe1f | 0x20;
        ini.iObjSel =
             *(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0);
      }
      else {
        SelectAdjFleet(0,ini.iObjSel);
        ini.wFlags = ini.wFlags & 0xfe1f;
      }
    }
    else if ((ini.wFlags >> 5 & 0xf) == 1) {
      pPVar3 = LpplFromId(ini.iObjSel);
      iVar1 = (int)((ulong)pPVar3 >> 0x10);
      if ((((PLANET *)pPVar3 == (PLANET *)0x0) && (iVar1 == 0)) ||
         (((PLANET *)pPVar3)->iPlayer != idPlayer)) {
        ini.iObjSel =
             *(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0);
      }
      else {
        SelectAdjPlanet(0,ini.iObjSel);
        ini.wFlags = ini.wFlags & 0xfe1f;
      }
    }
    if ((ini.turn == game.turn) && (0 < ini.iMsg)) {
      iMsgCur = ini.iMsg + -1;
      if (cMsg + vcmsgplrIn <= iMsgCur) {
        iMsgCur = -1;
      }
      iMsgCur = IMsgNext(0);
      gd.grBits._0_2_ = (uint)gd.grBits & 0xefff;
      SetMsgTitle(hwndMessage);
      InvalidateRect(hwndMessage,(RECT *)0x0,1);
      if (((uint)gd.grBits >> 0xb & 1) != 0) {
        tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
        AdvanceTutor();
      }
    }
  }
  else {
    ini.wFlags = ini.wFlags & 0xfe1f | 0x20;
    ini.iObjSel =
         *(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0);
  }
  if ((ini.wFlags >> 5 & 0xf) != 0) {
    if (ini.iObjSel == -1) {
      FFindSomethingAndSelectIt();
    }
    else {
      pPVar3 = LpplFromId(ini.iObjSel);
      iVar1 = (int)((ulong)pPVar3 >> 0x10);
      if ((((PLANET *)pPVar3 == (PLANET *)0x0) && (iVar1 == 0)) ||
         (((PLANET *)pPVar3)->iPlayer != idPlayer)) {
        FFindSomethingAndSelectIt();
      }
      else {
        SelectAdjPlanet(0,ini.iObjSel);
      }
    }
    ini.wFlags = ini.wFlags & 0xfe1f;
  }
  return;
}



// ======================================================================
// Function: FormatSerialAndEnv
// Address: 1020:2886
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Variable defined which should be unmapped: b64 */

void FormatSerialAndEnv(long lSerial,byte *pbEnv,char *pszOut)

{
  short sVar1;
  uint uVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar3;
  long lNew2;
  byte b64;
  undefined1 uStack_41;
  byte rgbRaw2 [22];
  undefined4 lTank;
  short iPass;
  short iRaw;
  short cBits;
  short i;
  byte bXor;
  short j;
  long rgbRaw;
  undefined1 local_16 [20];
  
  lNew2 = CONCAT22(unaff_SI,unaff_DI);
  iPass = 0;
  PushRandom(0x11000b,lNew2);
  Randomize(lSerial);
  rgbRaw = lSerial;
  _memcpy(local_16,pbEnv,0xb);
  iRaw = 0xf;
  for (i = 0; sVar1 = iRaw, i < 0xb; i = i + 1) {
    for (j = (short)pbEnv[i]; 0 < j; j = j + -1) {
      Random(0x10);
    }
    if (iPass == 0) {
      sVar1 = Random(0x10);
      local_16[iRaw + -4] = (char)sVar1;
    }
    else {
      uVar2 = Random(0x10);
      sVar1 = iRaw;
      iRaw = iRaw + 1;
      local_16[sVar1 + -4] = local_16[sVar1 + -4] | (byte)((uVar2 & 0xf) << 4);
    }
    iPass = iPass + 1U & 1;
  }
  bXor = 0;
  for (i = 0; i < 0xf; i = i + 1) {
    bXor = bXor ^ local_16[i + -4];
  }
  iRaw = iRaw + 1;
  local_16[sVar1 + -4] = local_16[sVar1 + -4] | bXor << 4;
  PopRandom();
  for (i = 0; i < 0x15; i = i + 1) {
    rgbRaw2[i] = local_16[*(byte *)((int)(short *)(rgidPlan + 0x81) + i) - 4];
  }
  iRaw = 0;
  cBits = 0;
  lTank._0_2_ = 0;
  lTank._2_2_ = 0;
  lVar3 = 0;
  i = 0;
  while( true ) {
    sVar1 = iRaw;
    lTank._2_2_ = (uint)((ulong)lVar3 >> 0x10);
    lTank._0_2_ = (uint)lVar3;
    if (0x1b < i) break;
    if (cBits < 6) {
      iRaw = iRaw + 1;
      uVar2 = (uint)rgbRaw2[sVar1] << ((byte)cBits & 0x1f);
      lVar3 = CONCAT22(lTank._2_2_ | (int)uVar2 >> 0xf,(uint)lTank | uVar2);
      cBits = cBits + 8;
    }
    _b64 = CONCAT11(uStack_41,(char)lVar3) & 0xff3f;
    lTank = lVar3;
    lVar3 = __aFlshr(lNew2,_b64);
    lTank = lVar3;
    cBits = cBits + -6;
    if (b64 < 0x1a) {
      *pszOut = b64 + 0x41;
    }
    else if (b64 < 0x34) {
      *pszOut = b64 + 0x47;
    }
    else if (b64 < 0x3e) {
      *pszOut = b64 - 4;
    }
    else if (b64 == 0x3e) {
      *pszOut = '-';
    }
    else {
      *pszOut = '*';
    }
    pszOut = pszOut + 1;
    i = i + 1;
  }
  *pszOut = '\0';
  return;
}



// ======================================================================
// Function: FSerialAndEnvFromSz
// Address: 1020:2aec
// Segment: MEMORY_MDI
// ======================================================================


short FSerialAndEnvFromSz(long *plSerial,byte *pbEnv,char *pszIn)

{
  uint uVar1;
  short sVar2;
  uint uVar3;
  undefined1 *puVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar5;
  long lNew2;
  ushort in_stack_0000ffb6;
  byte b64;
  undefined1 rgbRaw2 [22];
  undefined4 lTank;
  undefined2 lSerial;
  undefined2 local_2a;
  short iPass;
  short iRaw;
  short cBits;
  short i;
  byte bXor;
  short j;
  short fSuccess;
  undefined2 rgbRaw;
  undefined2 local_18;
  byte local_16 [20];
  
  lNew2 = CONCAT22(unaff_SI,unaff_DI);
  iPass = 0;
  *(undefined2 *)plSerial = 0;
  *(undefined2 *)((int)plSerial + 2) = 0;
  _memset(pbEnv,0,0xb);
  iRaw = 0;
  cBits = 0;
  lTank._0_2_ = 0;
  lTank._2_2_ = 0;
  lVar5 = 0;
  for (i = 0; i < 0x15; i = i + 1) {
    while( true ) {
      lTank._2_2_ = (uint)((ulong)lVar5 >> 0x10);
      lTank._0_2_ = (uint)lVar5;
      if (7 < cBits) break;
      if ((*pszIn < 'A') || ('Z' < *pszIn)) {
        if ((*pszIn < 'a') || ('z' < *pszIn)) {
          if ((*pszIn < '0') || ('9' < *pszIn)) {
            if (*pszIn == '-') {
              b64 = 0x3e;
            }
            else {
              b64 = 0x3f;
            }
          }
          else {
            b64 = *pszIn + 4;
          }
        }
        else {
          b64 = *pszIn + 0xb9;
        }
      }
      else {
        b64 = *pszIn + 0xbf;
      }
      uVar1 = (uint)b64 << ((byte)cBits & 0x1f);
      lVar5 = CONCAT22(lTank._2_2_ | (int)uVar1 >> 0xf,(uint)lTank | uVar1);
      cBits = cBits + 6;
      pszIn = pszIn + 1;
    }
    puVar4 = rgbRaw2 + iRaw;
    iRaw = iRaw + 1;
    lTank = lVar5;
    *puVar4 = (char)lVar5;
    cBits = cBits + -8;
    lVar5 = __aFlshr(lNew2,in_stack_0000ffb6);
    lTank = lVar5;
  }
  for (i = 0; i < 0x15; i = i + 1) {
    *(undefined1 *)((int)&rgbRaw + (uint)*(byte *)((int)(short *)(rgidPlan + 0x81) + i)) =
         rgbRaw2[i];
  }
  lSerial = rgbRaw;
  local_2a = local_18;
  lTank = lVar5;
  sVar2 = FValidSerialLong(CONCAT22(local_18,rgbRaw));
  if (sVar2 == 0) {
    fSuccess = 0;
  }
  else {
    fSuccess = 1;
    PushRandom(0x11000b,lNew2);
    Randomize(CONCAT22(local_2a,lSerial));
    iRaw = 0xf;
    for (i = 0; i < 0xb; i = i + 1) {
      for (j = (uint)local_16[i]; 0 < j; j = j + -1) {
        Random(0x10);
      }
      if (iPass == 0) {
        uVar1 = *(byte *)((int)&rgbRaw + iRaw) & 0xf;
        uVar3 = Random(0x10);
        if (uVar1 != (uVar3 & 0xff)) {
          fSuccess = 0;
        }
      }
      else {
        uVar1 = (int)(uint)*(byte *)((int)&rgbRaw + iRaw) >> 4;
        uVar3 = Random(0x10);
        if (uVar1 != (uVar3 & 0xff)) {
          fSuccess = 0;
        }
        iRaw = iRaw + 1;
      }
      iPass = iPass + 1U & 1;
    }
    bXor = 0;
    for (i = 0; i < 0xf; i = i + 1) {
      bXor = bXor ^ *(byte *)((int)&rgbRaw + i);
    }
    if ((int)(uint)*(byte *)((int)&rgbRaw + iRaw) >> 4 != (bXor & 0xf)) {
      fSuccess = 0;
    }
    PopRandom();
    if (fSuccess != 0) {
      *(undefined2 *)plSerial = lSerial;
      *(undefined2 *)((int)plSerial + 2) = local_2a;
      _memcpy(pbEnv,local_16,0xb);
    }
  }
  return fSuccess;
}



// ======================================================================
// Function: FFindSomethingAndSelectIt
// Address: 1020:2e1c
// Segment: MEMORY_MDI
// ======================================================================


short FFindSomethingAndSelectIt(void)

{
  FLEET *pFVar1;
  short sVar2;
  int iVar3;
  FLEET *lpfl;
  short i;
  PLANET *lppl;
  
  lppl = LpplFromId(*(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0)
                         );
  iVar3 = (int)((ulong)lppl >> 0x10);
  if ((((PLANET *)lppl == (PLANET *)0x0) && (iVar3 == 0)) ||
     (((PLANET *)lppl)->iPlayer != idPlayer)) {
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    while( true ) {
      if (((PLANET *)lpPlanets + cPlanet <= (PLANET *)lppl) ||
         (((PLANET *)lppl)->iPlayer == idPlayer)) break;
      lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
    }
    if (((PLANET *)lppl == (PLANET *)lpPlanets + cPlanet) &&
       (lppl._2_2_ == lpPlanets._2_2_)) {
      lppl = (PLANET *)0x0;
    }
  }
  if (((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) {
    for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar1 = ((FLEET **)rglpfl)[i];
      iVar3 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpfl = (FLEET *)CONCAT22(iVar3,pFVar1);
      if ((pFVar1 == (FLEET *)0x0) && (iVar3 == 0)) break;
      if (pFVar1->iPlayer == idPlayer) {
        SelectAdjFleet(0,lpfl->id);
        return 1;
      }
    }
    sVar2 = 0;
  }
  else {
    SelectAdjPlanet(0,lppl->id);
    sVar2 = 1;
  }
  return sVar2;
}



// ======================================================================
// Function: CommandHandler
// Address: 1020:2f7a
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1020350e) */
/* WARNING: Removing unreachable block (ram,0x102034bc) */
/* WARNING: Removing unreachable block (ram,0x10203499) */
/* WARNING: Removing unreachable block (ram,0x102034e8) */
/* WARNING: Removing unreachable block (ram,0x10203583) */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void CommandHandler(HWND hwnd,ushort wParam)

{
  undefined2 *puVar1;
  PLAYER *pPVar2;
  PLAYER *pPVar3;
  POINT ptDlgSize;
  POINT pt_00;
  UINT UVar4;
  int iVar5;
  ushort uVar6;
  short sVar7;
  HCURSOR HVar8;
  char *pcVar9;
  HWND HVar10;
  int iVar11;
  uint uVar12;
  undefined2 *puVar13;
  PLAYER *pPVar14;
  PLAYER *pPVar15;
  undefined2 unaff_SS;
  FARPROC pvVar16;
  ulong uVar17;
  long lVar18;
  undefined1 uVar19;
  char cVar20;
  undefined1 uVar21;
  undefined2 uVar22;
  HDC HVar23;
  char *pcVar24;
  char szT [112];
  short local_b4;
  int local_b2;
  short local_b0;
  short cch;
  undefined4 x;
  undefined4 y;
  short xOff;
  short yOff;
  undefined2 rc;
  undefined2 local_9e;
  int local_9c;
  int local_9a;
  short dyDPI;
  ulong ldy;
  short cch__146;
  short yPage;
  char *psz;
  short dSize;
  HFONT hfontSav;
  short dyMax;
  short dyPrint;
  int ptLegendA;
  int local_82;
  int ptLegendB;
  int local_7e;
  HFONT hfontPrint;
  HFONT hfontPrintTiny;
  ulong ldx;
  short y__116;
  short dMargin;
  short dyPrintTiny;
  short dxDPI;
  short dxMax;
  short xPage;
  short cPageY;
  short fRet;
  undefined2 pd;
  undefined2 local_62;
  HGLOBAL local_5e;
  HGLOBAL local_5c;
  HDC local_5a;
  undefined2 local_58;
  undefined2 local_56;
  PLANET *dwTickBase;
  uint local_36;
  PLANET *dwTickCur;
  PLANET *local_32;
  PLANET *ti;
  PLANET *pPStack_2e;
  PLANET *pPStack_2c;
  short ifl;
  char *psz__40;
  short cObj;
  PLANET *pt;
  short iplrOld;
  RECT rc__32;
  short fRet__24;
  short dx;
  char szExt [4];
  short dy;
  FARPROC lpProc;
  HMENU hmenu;
  short pt__8;
  short local_6;
  
  if ((14999 < wParam) && (wParam < 0x3afc)) {
    iPopMenuSel = wParam + 0xc568;
    return;
  }
  if (wParam == 0x53) {
    DumpFleets();
    return;
  }
  if (wParam == 0x54) {
    DumpPlanets();
    return;
  }
  if (wParam == 0x55) {
    DumpUniverse();
    return;
  }
  if ((wParam == 0x5f) || (wParam == 0x60)) {
    if (idPlayer == -1) {
      return;
    }
    lpProc = MakeProcInstance(ScoreXDlg,hInst);
    fRet__24 = DialogBox(0,(LPCSTR)CONCAT22(0x66,hwnd),(HWND)((ulong)lpProc >> 0x10),(char)lpProc);
    FreeProcInstance(lpProc);
    return;
  }
  if (wParam == 99) {
    lpProc = MakeProcInstance(About,hInst);
    DialogBox(0,(LPCSTR)CONCAT22(0x5a,hwnd),(HWND)((ulong)lpProc >> 0x10),(char)lpProc);
    FreeProcInstance(lpProc);
    return;
  }
  if ((wParam == 0x67) || (wParam == 0x68)) {
    if ((sel.grobj == grobjFleet) && (HVar10 = GetFocus(), HVar10 != hwndOrderED))
    {
      DeleteCurWayPoint((uint)(wParam == 0x67));
    }
MDI_Default_4:
    DefWindowProc(hwnd,0x111,wParam,0);
    return;
  }
  if (wParam == 0x69) {
    if ((game.wCrap >> 2 & 1) == 0) {
      pcVar24 = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
      pcVar9 = PszFormatIds(idsGameAlreadyHostedAnotherInstanceStarsWould,(short *)0x0);
      sVar7 = AlertSz(pcVar9,(short)pcVar24);
      if (sVar7 != 6) {
        return;
      }
    }
LAB_1020_3f6e:
    iplrOld = idPlayer;
    if (wParam == 0x5209) {
      iPassCnt = 100;
    }
    else if ((HBRUSH *)wParam == (HBRUSH *)&hbrCargo) {
      iPassCnt = 1000;
    }
    else if (wParam == 21000) {
      iPassCnt = 10;
    }
    else {
      iPassCnt = 0;
    }
    if (((game.wCrap >> 2 & 1) != 0) && (iPassCnt != 0)) {
      sVar7 = iPassCnt;
      pcVar9 = PszGetCompressedString(idsSureWantForceGenerateDTurnsRow);
      _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar9),sVar7);
      HVar10 = GetFocus();
      sVar7 = MessageBox(HVar10,szWork,(LPCSTR)0x112003de,0x2034);
      if (sVar7 != 6) {
        return;
      }
    }
    if (idPlayer == -1) {
      return;
    }
    if (((uint)gd.grBits >> 0xb & 1) != 0) {
      AdvanceTutor();
      if (((uint)tutor.wFlags >> 3 & 1) == 0) {
        sVar7 = 0x10;
        pcVar9 = PszFormatIds(idsTutorialTurnWillGeneratedHaveYetCompleted,(short *)0x0);
        AlertSz(pcVar9,sVar7);
        return;
      }
      ShowTutor(0);
      if (game.turn < 0x24) {
        Randomize(0x499602d2);
        FWriteHistFile(iplrOld);
        sVar7 = FWriteTutorialMFile(game.turn + 1);
        if (sVar7 == 0) {
          sVar7 = 0x10;
          pcVar9 = PszFormatIds(idsFileError,(short *)0x0);
          AlertSz(pcVar9,sVar7);
          return;
        }
        if ((game.turn == 0x23) && (sVar7 = FWriteTutorialMFile(0x25), sVar7 == 0)) {
          sVar7 = 0x10;
          pcVar9 = PszFormatIds(idsFileError,(short *)0x0);
          AlertSz(pcVar9,sVar7);
          return;
        }
        _strcpy((char *)szWork,(char *)szBase);
        _strcat((char *)szWork,(char *)0x3e5);
        _remove((char *)szWork);
        DirtyGame(0);
        ShowProgressGauge();
        ti = (PLANET *)0xc;
        pPStack_2e = (PLANET *)0x0;
        TimerCount(0x1040,&ti);
        dwTickBase = pPStack_2c;
        local_36 = ifl;
        do {
          UpdateProgressGauge(((int)dwTickCur - (int)dwTickBase) * 2);
          TimerCount(0x1040,&ti);
          dwTickCur = pPStack_2c;
          local_32 = (PLANET *)ifl;
          if (((uint)ifl < local_36) || (((uint)ifl <= local_36 && (pPStack_2c < dwTickBase))))
          break;
          uVar12 = local_36 + ((PLANET *)0xfe0b < dwTickBase);
        } while (((uint)ifl < uVar12) ||
                (((uint)ifl <= uVar12 && (pPStack_2c < &dwTickBase[8].lpplprod))));
        goto MDI_LTutorialFinishUp;
      }
    }
    if ((game.wCrap >> 2 & 1) != 0) {
      idsFileError = -1;
      sVar7 = FCheckFile(dtHost,-1,1);
      if (sVar7 == 0) {
        HVar8 = LoadCursor(0,(LPCSTR)0x7f02);
        pt = (PLANET *)setcursor(HVar8);
        FWriteLogFile((char *)szBase,iplrOld);
        FWriteHistFile(iplrOld);
        do {
          ShowProgressGauge();
          EnsureAis();
          FGenerateTurn();
          if ((((wParam != 21000) && (wParam != 0x5209)) &&
              ((HBRUSH *)wParam != (HBRUSH *)&hbrCargo)) ||
             (iPassCnt = iPassCnt + -1, iPassCnt < 1)) break;
          HideProgressGauge();
          sVar7 = GetAsyncKeyState(0x10);
        } while ((-1 < sVar7) || (sVar7 = GetAsyncKeyState(0x11), -1 < sVar7));
        iPassCnt = 0;
MDI_LTutorialFinishUp:
        DestroyCurGame();
        _WSPRINTF((char *)CONCAT22(unaff_SS,szExt),(char *)CONCAT22(0x1120,MPCTD),iplrOld + 1
                 );
        sVar7 = FLoadGame((char *)szBase,szExt);
        if (sVar7 == 0) {
          setcursor((HCURSOR)pt);
          HideProgressGauge();
          sVar7 = 0x10;
          pcVar9 = PszFormatIds(idsUnableOpenNewTurnFile,(short *)0x0);
          AlertSz(pcVar9,sVar7);
          return;
        }
        HideProgressGauge();
        idPlayer = iplrOld;
        CreateChildWindows();
        SendMessage(hwndFrame,0x111,0xfa1,0);
        setcursor((HCURSOR)pt);
        if (((uint)gd.grBits >> 0xb & 1) == 0) {
          return;
        }
        tutor.wFlags = tutor.wFlags & 0xfdf7;
        AdvanceTutor();
        return;
      }
      sVar7 = FBadFileError(idsFileError);
      if (sVar7 != 0) {
        sVar7 = 0x10;
        pcVar9 = PszFormatIds(idsFileError,(short *)0x0);
        AlertSz(pcVar9,sVar7);
        return;
      }
      pcVar24 = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
      pcVar9 = PszFormatIds(idsGameAlreadyHostedAnotherInstanceStarsWould,(short *)0x0);
      sVar7 = AlertSz(pcVar9,(short)pcVar24);
      if (sVar7 != 6) {
        return;
      }
    }
  }
  else if (wParam != 0x6a) {
    if (wParam != 0x6c) {
      if (wParam == 0x6d) {
LAB_1020_4a53:
        if ((((uint)gd.grBits >> 0xb & 1) != 0) &&
           (sVar7 = FAskKillTutor(), sVar7 == 0)) {
          return;
        }
        sVar7 = FOpenGame(hwnd,0);
        if (sVar7 < 1) {
          return;
        }
        InitializeMenu(0);
        if (uTimerId == 0) {
          PostMessage(hwnd,0x111,0xfa1,0);
        }
        if ((game.wCrap >> 3 & 1) == 0) {
          return;
        }
        if (idPlayer != 0) {
          return;
        }
        StartTutor(0);
        return;
      }
      if (wParam == 0x6e) {
LAB_1020_3083:
        if ((((uint)gd.grBits >> 0xb & 1) != 0) &&
           (sVar7 = FAskKillTutor(), sVar7 == 0)) {
          return;
        }
        NewGameWizard(hwnd,0);
        return;
      }
      if (wParam != 0x6f) {
        if (wParam == 0x71) {
          if ((((uint)gd.grBits >> 0xb & 1) != 0) &&
             (sVar7 = FAskKillTutor(), sVar7 == 0)) {
            return;
          }
          WriteIniSettings();
          DestroyCurGame();
          _strcpy((char *)szBase,(char *)szWork);
          ini.wFlags = ini.wFlags & 0xfe1f;
          ini.iObjSel = 0;
          ini.idPlayer = -1;
          InitializeMenu(0);
          pt = (PLANET *)GetSystemMetrics(0);
          iplrOld = GetSystemMetrics(1);
          hwndTitle =
               CreateWindow(szTitle,(LPCSTR)0x112003e9,0x90000000,0,0,(short)pt,iplrOld,
                            hwndFrame,0,hInst,(void *)0x0);
          fFreeingTitle = 0;
          ShowWindow(hwndFrame,0);
          return;
        }
        if (wParam == 0x7d) {
LAB_1020_4df3:
          if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
            return;
          }
          if (idPlayer == -1) {
            return;
          }
          pt = (PLANET *)0x262;
          iplrOld = 0x1c2;
          if (hwndPopup != 0) {
            SendMessage(hwndPopup,0x205,0,0);
          }
          ptDlgSize.y = iplrOld;
          ptDlgSize.x = (short)pt;
          ShipBuilder(ptDlgSize);
          return;
        }
        if (wParam == 0x7e) {
LAB_1020_4be3:
          if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
            return;
          }
          if (idPlayer == -1) {
            return;
          }
          lpProc = MakeProcInstance(ResearchDlg,hInst);
          fRet__24 = DialogBox(0,(LPCSTR)CONCAT22(0x7f,hwndFrame),
                               (HWND)((ulong)lpProc >> 0x10),(char)lpProc);
          FreeProcInstance(lpProc);
          if (fRet__24 == 0) {
            return;
          }
          if (sel.grobj != grobjPlanet) {
            return;
          }
          if (((PLPROD *)sel.pl.lpplprod != (PLPROD *)0x0) ||
             (sel.pl.lpplprod._2_2_ != 0)) {
            FillPlanetProdLB
                      (hwndPlanetProdLB,
                       (PLPROD *)
                       CONCAT22(sel.pl.lpplprod._2_2_,(PLPROD *)sel.pl.lpplprod)
                       ,(PLANET *)0x0);
          }
          DrawPlanShip(0,0x48);
          return;
        }
        if (wParam == 0x81) {
          puVar13 = (undefined2 *)&vrgplrDef;
          pPVar14 = (PLAYER *)&vplr;
          for (iVar11 = 0x60; iVar11 != 0; iVar11 = iVar11 + -1) {
            pPVar2 = pPVar14;
            pPVar14 = (PLAYER *)&pPVar14->cPlanet;
            puVar1 = puVar13;
            puVar13 = puVar13 + 1;
            uVar22 = *puVar1;
            pPVar2->iPlayer = (char)uVar22;
            pPVar2->cShDef = (char)((uint)uVar22 >> 8);
          }
          RaceCreationWizard(hwnd,0,0);
          return;
        }
        if (((wParam == 0x82) || (wParam == 0x83)) || (wParam == 0x84)) {
          if (idPlayer == -1) {
            return;
          }
          iWindowLayout = wParam - 0x82;
          InvalidateRect(hwndFrame,(RECT *)0x0,1);
          EnsureTileSize((uint)(iWindowLayout == 2));
          RefitFrameChildren();
          return;
        }
        if (wParam == 0x87) goto LAB_1020_4be3;
        if (wParam == 0x88) {
LAB_1020_440c:
          if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
            return;
          }
          if (idPlayer == -1) {
            return;
          }
          if (hwndBrowser == 0) {
            iplrOld = 8;
            CreateDialog(0,(LPCSTR)CONCAT22(0x80,hwndFrame),
                         lpfnBrowserDlgProc._2_2_,
                         (char)(fn_lpfnBrowserDlgProc *)lpfnBrowserDlgProc);
          }
          else {
            iplrOld = 0;
            DestroyWindow(hwndBrowser);
          }
          hmenu = GetASubMenu(hwnd,5);
          CheckMenuItem(hmenu,0x100,iplrOld);
          return;
        }
        if (wParam == 0x89) goto LAB_1020_4df3;
        if (wParam == 0x8a) {
LAB_1020_47b3:
          WinHelp(hwnd,(LPCSTR)CONCAT22(0x1120,_szHelpFile),3,0);
          return;
        }
        if ((wParam == 0x9c) || (wParam == 0x9d)) {
          if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
            return;
          }
          if (idPlayer == -1) {
            return;
          }
          pPVar14 = (PLAYER *)rgplr + idPlayer;
          pPVar15 = (PLAYER *)&vplr;
          for (iVar11 = 0x60; iVar11 != 0; iVar11 = iVar11 + -1) {
            pPVar3 = pPVar15;
            pPVar15 = (PLAYER *)&pPVar15->cPlanet;
            pPVar2 = pPVar14;
            pPVar14 = (PLAYER *)&pPVar14->cPlanet;
            cVar20 = pPVar2->cShDef;
            pPVar3->iPlayer = pPVar2->iPlayer;
            pPVar3->cShDef = cVar20;
          }
          RaceCreationWizard(hwnd,1,0);
          return;
        }
        if ((wParam == 0x9e) || (wParam == 0x9f)) {
          if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
            return;
          }
          if (idPlayer == -1) {
            return;
          }
          NewGameWizard(hwnd,1);
          return;
        }
        if (wParam == 0xb3) {
          hmenu = GetASubMenu(hwnd,1);
          iplrOld = (short)(-1 < (int)gd.grBits._2_2_);
          gd.grBits._2_2_ = gd.grBits._2_2_ & 0x7fff | iplrOld << 0xf;
          if (iplrOld == 0) {
            UVar4 = 0;
          }
          else {
            UVar4 = 8;
          }
          CheckMenuItem(hmenu,0xb3,UVar4);
          RefitFrameChildren();
          return;
        }
        if (wParam == 0xd5) {
          if (idPlayer == -1) {
            return;
          }
          pvVar16 = MakeProcInstance(PrintMapDlg,hInst);
          psz__40 = (char *)((ulong)pvVar16 >> 0x10);
          ifl = (short)pvVar16;
          fRet = DialogBox(0,(LPCSTR)CONCAT22(0xd6,hwndFrame),(HWND)psz__40,(char)pvVar16)
          ;
          FreeProcInstance((FARPROC)CONCAT22(psz__40,ifl));
          if (fRet == 0) {
            return;
          }
          iplrOld = vrgcPrintMapPage[0];
          cPageY = vrgcPrintMapPage[1];
          _memset(&pd,0,0x34);
          pd = 0x34;
          local_62 = 0;
          local_58 = 0x500;
          local_56 = 0;
          iVar11 = PrintDlg(0x1118,&pd);
          if (iVar11 == 0) {
            sVar7 = 0x10;
            pcVar9 = PszFormatIds(idsUnablePrintGameMapPrinterMayOff,(short *)0x0);
            AlertSz(pcVar9,sVar7);
            return;
          }
          dxMax = GetDeviceCaps(local_5a,8);
          dyMax = GetDeviceCaps(local_5a,10);
          dxDPI = GetDeviceCaps(local_5a,0x58);
          dyDPI = GetDeviceCaps(local_5a,0x5a);
          dMargin = 0x20;
          hfontPrint = HfontPrinterCreate(local_5a,8,&dyPrint);
          hfontPrintTiny = HfontPrinterCreate(local_5a,5,&dyPrintTiny);
          SetBkMode(local_5a,1);
          sVar7 = iplrOld;
          local_9e = 0;
          rc = 0;
          yOff = (short)(cPageY < iplrOld);
          if (yOff == (uint)(dyMax < dxMax)) {
            ti = (PLANET *)iplrOld;
            iplrOld = cPageY;
            cPageY = sVar7;
          }
          ldx = __aFulmul((long)dxMax,(long)iplrOld);
          ldy = __aFulmul((long)dyMax,(long)cPageY);
          if (32000 < (long)ldx) {
            ldx = 32000;
          }
          if (32000 < (long)ldy) {
            ldy = 32000;
          }
          if ((long)ldx < (long)ldy) {
            if ((long)(ldy - (long)dyDPI) < (long)ldx) {
              ldx = ldy - (long)dyDPI;
            }
            dSize = (int)ldx;
            ptLegendA = dMargin;
            local_82 = (int)ldx + dMargin;
            ptLegendB = (int)ldx / 2;
            local_7e = local_82;
          }
          else {
            if ((long)(ldx - (long)((dxDPI * 3) / 2)) < (long)ldy) {
              ldy = ldx - (long)((dxDPI * 3) / 2);
            }
            dSize = (int)ldy;
            ptLegendA = (int)ldy + dMargin;
            local_82 = dMargin;
            local_7e = (int)ldy / 2;
            ptLegendB = ptLegendA;
          }
          local_9a = dSize;
          local_9c = dSize;
          dSize = dSize + dMargin * -2;
          for (xPage = 0; xPage < iplrOld; xPage = xPage + 1) {
            for (yPage = 0; yPage < cPageY; yPage = yPage + 1) {
              xOff = -dxMax * xPage;
              yOff = -dyMax * yPage;
              cch__146 = CchGetString(idsStarsUniverseMap,(char *)szWork);
              Escape(local_5a,10,cch__146,szWork,(void *)0x0);
              Rectangle(local_5a,xOff,yOff,xOff + local_9c,yOff + local_9a);
              if (hfontPrint == 0) {
                hfontSav = 0;
              }
              else {
                hfontSav = SelectObject(local_5a,hfontPrint);
              }
              y__116 = local_82 + yOff;
              cch__146 = CchGetString(idsStarsUniverseMap,(char *)szWork);
              TextOut(local_5a,ptLegendA + xOff,y__116,szWork,cch__146);
              iVar11 = y__116 + dyPrint;
              iVar5 = ptLegendA + xOff;
              uVar22 = 0x1120;
              uVar19 = 0x90;
              uVar21 = 0;
              HVar23 = local_5a;
              y__116 = iVar11;
              uVar6 = _strlen((char *)game.szName);
              TextOut(HVar23,iVar5,iVar11,(LPCSTR)CONCAT22(uVar22,(char *)CONCAT11(uVar21,uVar19)),
                      uVar6);
              y__116 = y__116 + dyPrint;
              psz = PszPlayerName(idPlayer,1,1,1,0,(PLAYER *)0x0);
              iVar11 = ptLegendA + xOff;
              uVar22 = 0x1120;
              uVar19 = SUB21(psz,0);
              uVar21 = (undefined1)((uint)psz >> 8);
              sVar7 = y__116;
              HVar23 = local_5a;
              uVar6 = _strlen(psz);
              TextOut(HVar23,iVar11,sVar7,(LPCSTR)CONCAT22(uVar22,(char *)CONCAT11(uVar21,uVar19)),
                      uVar6);
              y__116 = y__116 + dyPrint;
              iVar11 = game.turn + 0x960;
              pcVar9 = PszGetCompressedString(idsYearD);
              cch__146 = _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar9),iVar11);
              TextOut(local_5a,ptLegendA + xOff,y__116,szWork,cch__146);
              if ((grbitScan & 0xf) != 5) {
                y__116 = local_7e + yOff;
                for (ti = (PLANET *)0x0; (int)ti < 5; ti = (PLANET *)((int)&ti->id + 1)) {
                  cch__146 = CchGetString
                                       ((StringId)(ti[0x17].rgbImp + 6),(char *)szWork);
                  TextOut(local_5a,ptLegendB + xOff,y__116,szWork,cch__146);
                  y__116 = y__116 + dyPrint;
                }
                y__116 = local_7e + yOff;
                if (hfontPrintTiny != 0) {
                  SelectObject(local_5a,hfontPrintTiny);
                }
                y._2_2_ = dyPrintTiny / 2;
                CtrTextOut(local_5a,ptLegendB + xOff,((dyPrint * 3) / 2 + y__116) - y._2_2_
                                    ,(char *)0x3d4,1);
                y._2_2_ = dyPrintTiny / 2;
                CtrTextOut(local_5a,ptLegendB + xOff,((dyPrint * 5) / 2 + y__116) - y._2_2_
                                    ,(char *)0x3d6,1);
                CtrTextOut(local_5a,ptLegendB + xOff,
                                    ((dyPrint * 9) / 2 + y__116 + 8) - dyPrintTiny,(char *)0x3d8,1);
                if (hfontPrint != 0) {
                  SelectObject(local_5a,hfontPrint);
                }
                DrawPlanetPrintDot(local_5a,ptLegendB + xOff,y__116 + -4 + dyPrint / 2,1);
                DrawPlanetPrintDot
                          (local_5a,ptLegendB + xOff,y__116 + -4 + (dyPrint * 7) / 2,0);
                DrawPlanetPrintDot(local_5a,ptLegendB + xOff,(dyPrint * 9) / 2 + y__116 + 8,0)
                ;
              }
              if ((grbitScan & 0xf) != 5) {
                if (hfontPrintTiny != 0) {
                  SelectObject(local_5a,hfontPrintTiny);
                }
                pPStack_2c = lpPlanets._2_2_;
                y = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
                cObj = (short)((PLANET *)lpPlanets + cPlanet);
                pt = lpPlanets._2_2_;
                for (pPStack_2e = (PLANET *)lpPlanets; pPStack_2e < (uint)cObj;
                    pPStack_2e = pPStack_2e + 1) {
                  x._0_2_ = ((POINT *)rgptPlan +
                            ((PLANET *)CONCAT22(pPStack_2c,pPStack_2e))->id)->x + -1000;
                  x._2_2_ = (int)x >> 0xf;
                  y._0_2_ = (PLANET *)
                            ((dGalInv + -1000) -
                            *(int *)((int)&rgptPlan[0].y +
                                    ((PLANET *)CONCAT22(pPStack_2c,pPStack_2e))->id * 4));
                  y._2_2_ = (int)(PLANET *)y >> 0xf;
                  cch = xOff >> 0xf;
                  local_b0 = xOff;
                  local_b2 = dMargin >> 0xf;
                  local_b4 = dMargin;
                  iVar11 = dGal >> 0xf;
                  cVar20 = (char)((int)x >> 0xf);
                  sVar7 = dGal;
                  uVar17 = __aFulmul(CONCAT13(cVar20,CONCAT12(cVar20,(int)x)),(long)dSize);
                  lVar18 = __aFldiv(uVar17,CONCAT22(iVar11,sVar7));
                  x = lVar18 + CONCAT22(local_b2,local_b4) + CONCAT22(cch,local_b0);
                  cch = yOff >> 0xf;
                  local_b0 = yOff;
                  local_b2 = dMargin >> 0xf;
                  local_b4 = dMargin;
                  iVar11 = dGal >> 0xf;
                  sVar7 = dGal;
                  uVar17 = __aFulmul(CONCAT13((char)((uint)y._2_2_ >> 8),
                                                      CONCAT12((char)y._2_2_,(PLANET *)y)),
                                             (long)dSize);
                  lVar18 = __aFldiv(uVar17,CONCAT22(iVar11,sVar7));
                  y = (PLANET *)(lVar18 + CONCAT22(local_b2,local_b4) + CONCAT22(cch,local_b0));
                  if (pPStack_2e->iPlayer == idPlayer) {
                    if ((pPStack_2e->wFlags_0x4 >> 9 & 1) != 0) {
                      iVar11 = pPStack_2e->iPlayer * 4;
                      if (*(int *)(*(int *)(iVar11 + 0x14c) +
                                  (*(uint *)&pPStack_2e->lStarbase & 0xf) * 0x93) == 0x20) {
                        pcVar9 = (char *)0x3da;
                      }
                      else {
                        pcVar9 = (char *)0x3dc;
                      }
                      CtrTextOut(local_5a,(int)x,(int)(PLANET *)y + (4 - dyPrintTiny),
                                          pcVar9,1);
                    }
                    DrawPlanetPrintDot(local_5a,(int)x,(short)(PLANET *)y,1);
                  }
                  else if (pPStack_2e->iPlayer != -1) {
                    cch = _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),
                                    pPStack_2e->iPlayer + 1);
                    CtrTextOut(local_5a,(int)x,(int)(PLANET *)y - dyPrintTiny,
                                        (char *)szWork,cch);
                  }
                }
              }
              if (hfontPrint != 0) {
                SelectObject(local_5a,hfontPrint);
              }
              for (ti = (PLANET *)0x0; (int)ti < game.cPlanMax;
                  ti = (PLANET *)((int)&ti->id + 1)) {
                x._0_2_ = ((POINT *)rgptPlan + (int)ti)->x + -1000;
                x._2_2_ = (int)x >> 0xf;
                y._0_2_ = (PLANET *)
                          ((dGalInv + -1000) -
                          *(int *)((int)&rgptPlan[0].y + (int)ti * 4));
                y._2_2_ = (int)(PLANET *)y >> 0xf;
                cch = xOff >> 0xf;
                local_b0 = xOff;
                local_b2 = dMargin >> 0xf;
                local_b4 = dMargin;
                iVar11 = dGal >> 0xf;
                cVar20 = (char)((int)x >> 0xf);
                sVar7 = dGal;
                uVar17 = __aFulmul(CONCAT13(cVar20,CONCAT12(cVar20,(int)x)),(long)dSize);
                lVar18 = __aFldiv(uVar17,CONCAT22(iVar11,sVar7));
                x = lVar18 + CONCAT22(local_b2,local_b4) + CONCAT22(cch,local_b0);
                cch = yOff >> 0xf;
                local_b0 = yOff;
                local_b2 = dMargin >> 0xf;
                local_b4 = dMargin;
                iVar11 = dGal >> 0xf;
                sVar7 = dGal;
                uVar17 = __aFulmul(CONCAT13((char)((uint)y._2_2_ >> 8),
                                                    CONCAT12((char)y._2_2_,(PLANET *)y)),(long)dSize
                                          );
                lVar18 = __aFldiv(uVar17,CONCAT22(iVar11,sVar7));
                y = (PLANET *)(lVar18 + CONCAT22(local_b2,local_b4) + CONCAT22(cch,local_b0));
                DrawPlanetPrintDot(local_5a,(int)x,(short)(PLANET *)y,0);
                if ((grbitScan & 0x400) != 0) {
                  sVar7 = 0;
                  pcVar9 = PszGetPlanetName((short)ti);
                  CtrTextOut(local_5a,(int)x,(short)(((PLANET *)y)->rgEnvVar + 2),pcVar9,
                                      sVar7);
                }
              }
              if (hfontSav != 0) {
                SelectObject(local_5a,hfontSav);
              }
              Escape(local_5a,1,0,(LPCSTR)0x0,(void *)0x0);
            }
          }
          Escape(local_5a,0xb,0,(LPCSTR)0x0,(void *)0x0);
          if (hfontPrint != 0) {
            DeleteObject(hfontPrint);
          }
          if (hfontPrintTiny != 0) {
            DeleteObject(hfontPrintTiny);
          }
          DeleteDC(local_5a);
          if (local_5e != 0) {
            GlobalFree(local_5e);
          }
          if (local_5c == 0) {
            return;
          }
          GlobalFree(local_5c);
          return;
        }
        if ((((wParam == 0xfa) || (wParam == 0xfb)) || (wParam == 0xfc)) || (wParam == 0xfd)) {
          if (hwndTitle == 0) {
            return;
          }
          PostMessage(hwndTitle,0x111,wParam - 0xfa,0);
          return;
        }
        if (wParam == 0x100) goto LAB_1020_440c;
        if (wParam == 0x101) goto LAB_1020_47b3;
        if (wParam == 0x10e) {
          if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
            return;
          }
          if (idPlayer == -1) {
            return;
          }
          if (((game.wCrap >> 2 & 1) != 0) && (lSaltCur._2_2_ < 1)) {
            if (lSaltCur._2_2_ < 0) {
              return;
            }
            if ((int)lSaltCur == 0) {
              return;
            }
          }
          sVar7 = FCheckPassword();
          if (sVar7 == 0) {
            return;
          }
          lpProc = MakeProcInstance(NewPasswordDlg,hInst);
          fRet__24 = DialogBox(0,(LPCSTR)CONCAT22(0x8d,hwndFrame),
                               (HWND)((ulong)lpProc >> 0x10),(char)lpProc);
          FreeProcInstance(lpProc);
          return;
        }
        if (wParam == 0x428) {
          wParam = 0xedb;
        }
        else {
          if (wParam == 0x7d9) {
LAB_1020_4cfb:
            if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
              return;
            }
            if (idPlayer == -1) {
              return;
            }
            if ((game.wCrap >> 2 & 1) != 0) {
              return;
            }
            lpProc = MakeProcInstance(RelationsDlg,hInst);
            DialogBox(0,(LPCSTR)CONCAT22(0x7d8,hwndFrame),(HWND)((ulong)lpProc >> 0x10),
                      (char)lpProc);
            FreeProcInstance(lpProc);
            return;
          }
          if (wParam == 0x7da) goto MDI_LWaitForTurn;
          if ((wParam == 0x7db) || (wParam == 0x7dc)) {
            if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
              return;
            }
            if (idPlayer == -1) {
              return;
            }
            lpProc = MakeProcInstance(BattlePlansDlg,hInst);
            DialogBox(0,(LPCSTR)CONCAT22(0x7dd,hwndFrame),(HWND)((ulong)lpProc >> 0x10),
                      (char)lpProc);
            FreeProcInstance(lpProc);
            return;
          }
          if (wParam == 0x7de) goto LAB_1020_4cfb;
          if (wParam == 0x8fd) {
LAB_1020_44cc:
            cObj = 0;
            if (((int)game.lid == 0) && (game.lid._2_2_ == 0)) {
              return;
            }
            if (idPlayer == -1) {
              return;
            }
            hmenu = GetASubMenu(hwnd,4);
            while (hwndReportDlg != 0) {
              if ((wParam == 0x901) && (vprptCur == (RPT *)&vrptBattle)) {
                pt = (PLANET *)0x0;
              }
              else {
                pt = (PLANET *)0x1;
              }
              iplrOld = 0;
              DestroyWindow(hwndReportDlg);
              if (wParam == 0x8ff) {
                UVar4 = 0x8ff;
              }
              else {
                UVar4 = 0x8fd;
              }
              CheckMenuItem(hmenu,UVar4,iplrOld);
              if (pt != (PLANET *)0x1) {
                return;
              }
            }
            iplrOld = 8;
            if (wParam == 0x8ff) {
              pt = (PLANET *)0x49a;
              vprptCur = (RPT *)&vrptFleet;
              for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                pPStack_2e = *(PLANET **)((FLEET **)rglpfl + ifl);
                pPStack_2c = (PLANET *)*(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                if ((pPStack_2e == (PLANET *)0x0) && (pPStack_2c == (PLANET *)0x0)) break;
                if (pPStack_2e->iPlayer == idPlayer) {
                  cObj = cObj + 1;
                }
              }
            }
            else if (wParam == 0x900) {
              pt = (PLANET *)0x49b;
              vprptCur = (RPT *)&vrptEFleet;
              for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                pPStack_2e = *(PLANET **)((FLEET **)rglpfl + ifl);
                pPStack_2c = (PLANET *)*(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                if ((pPStack_2e == (PLANET *)0x0) && (pPStack_2c == (PLANET *)0x0)) break;
                if (pPStack_2e->iPlayer != idPlayer) {
                  cObj = cObj + 1;
                }
              }
            }
            else if (wParam == 0x901) {
              vprptCur = (RPT *)&vrptBattle;
              pt = (PLANET *)0x49c;
              cObj = CBattles();
            }
            else {
              vprptCur = (RPT *)&vrptPlanet;
              pt = (PLANET *)0x499;
              pPStack_2e = lpPlanets._2_2_;
              dwTickCur = (PLANET *)lpPlanets;
              local_32 = lpPlanets._2_2_;
              pPStack_2c = (PLANET *)lpPlanets + cPlanet;
              ifl = (short)lpPlanets._2_2_;
              for (ti = (PLANET *)lpPlanets; ti < pPStack_2c; ti = ti + 1) {
                if (ti->iPlayer == idPlayer) {
                  cObj = cObj + 1;
                }
              }
            }
            psz__40 = PszGetCompressedString((StringId)pt);
            if (cObj == 1) {
              uVar22 = 0x20;
            }
            else {
              uVar22 = 0x73;
            }
            _WSPRINTF(szWork,(char *)CONCAT22(0x1120,psz__40),cObj,uVar22);
            hwndReportDlg =
                 CreateWindow(szReport,szWork,0x80cf0000,0,0,100,100,
                              hwndFrame,0,hInst,(void *)0x0);
            SetWindowPos(hwndReportDlg,0,0,0,0,0,0x47);
            CheckMenuItem(hmenu,wParam,iplrOld);
            return;
          }
          if (wParam == 0x8fe) {
            if (hwndReportDlg == 0) {
              wParam = 0x8fd;
            }
            else if (vprptCur == (RPT *)&vrptPlanet) {
              wParam = 0x8ff;
            }
            else if (vprptCur == (RPT *)&vrptFleet) {
              wParam = 0x900;
            }
            else {
              wParam = 0x901;
            }
            goto LAB_1020_44cc;
          }
          if (((wParam == 0x8ff) || (wParam == 0x900)) || (wParam == 0x901)) goto LAB_1020_44cc;
          if (wParam == 0x98d) {
            hmenu = GetASubMenu(hwnd,1);
            grbitScan = grbitScan ^ 0x2000;
            if ((grbitScan & 0x2000) == 0) {
              UVar4 = 0;
            }
            else {
              UVar4 = 8;
            }
            CheckMenuItem(hmenu,0x98d,UVar4);
            gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xffbf | 0x40;
            if ((grbitScan & 0x1400) == 0) {
              return;
            }
            InvalidateRect(hwndScanner,(RECT *)0x0,0);
            return;
          }
          if ((wParam == 0x9c1) || (wParam == 0x9c2)) {
            if (wParam == 0x9c2) {
              uVar12 = 0x1195;
            }
            else {
              uVar12 = 0x32ca;
            }
            WinHelp(hwnd,(LPCSTR)CONCAT22(0x1120,_szHelpFile),1,(ulong)uVar12);
            return;
          }
          if ((wParam == 0x9c4) || (wParam == 0x9c5)) {
            if (((uint)gd.grBits >> 0xb & 1) == 0) {
              StartTutor(0);
              return;
            }
            ShowTutor(1);
            return;
          }
          if (wParam == 0xed8) goto LAB_1020_3083;
          if (wParam == 0xed9) goto LAB_1020_4a53;
          if ((wParam != 0xeda) && (wParam != 0xedb)) {
            if (wParam == 0xee2) {
              SendMessage(hwnd,0x10,0,0);
              return;
            }
            if (((((wParam == 0xf3d) || (wParam == 0xf3e)) || (wParam == 0xf3f)) ||
                (((wParam == 0xf40 || (wParam == 0xf41)) ||
                 ((wParam == 0xf42 || ((wParam == 0xf43 || (wParam == 0xf44)))))))) ||
               (wParam == 0xf45)) {
              if (hwndScanner != 0) {
                hmenu = GetASubMenu(hwnd,1);
                hmenu = GetSubMenu(hmenu,3);
                CheckMenuItem(hmenu,iScanZoom + 4,0x400);
                GetClientRect(hwndScanner,(RECT *)CONCAT22(unaff_SS,&rc__32));
                sVar7 = ScanToPt(rc__32.right);
                rc__32.right = sVar7 >> 1;
                sVar7 = ScanToPt(rc__32.bottom);
                rc__32.bottom = sVar7 >> 1;
                dx = xScanTop;
                dy = dGalInv - yScanTop;
                iScanZoom = wParam - 0xf41;
                CheckMenuItem(hmenu,wParam - 0xf3d,0x408);
                DrawMenuBar(hwnd);
                SetScanScrollBars(hwndScanner);
                InvalidateRect(hwndScanner,(RECT *)0x0,1);
                if (sel.scan.grobj == grobjNone) {
                  pt__8 = dx + rc__32.right;
                  local_6 = dy - rc__32.bottom;
                }
                else {
                  pt__8 = sel.scan.pt.x;
                  local_6 = sel.scan.pt.y;
                }
                pt_00.y = local_6;
                pt_00.x = pt__8;
                CtrPointScan(pt_00,0);
                return;
              }
              sVar7 = 0x10;
              pcVar9 = PszFormatIds(idsCantChangeZoomFactorUntilGameOpen,(short *)0x0);
              AlertSz(pcVar9,sVar7);
              return;
            }
            if (wParam == 0xfa1) {
              if (hwndScanner == 0) {
                return;
              }
              gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfffe | 1;
              RestoreSelection();
              RefitFrameChildren();
              gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfffe;
              InvalidateRect(hwndScanner,(RECT *)0x0,1);
              UpdateWindow(hwndScanner);
              return;
            }
            if ((wParam == 0x1068) || (wParam == 0x1069)) {
              if (idPlayer == -1) {
                return;
              }
              lpProc = MakeProcInstance(FindDlg,hInst);
              fRet__24 = DialogBox(0,(LPCSTR)CONCAT22(0x106a,hwnd),(HWND)((ulong)lpProc >> 0x10),
                                   (char)lpProc);
              FreeProcInstance(lpProc);
              return;
            }
            if ((((((wParam == 0x10cc) || (wParam == 0x10cd)) || (wParam == 0x10ce)) ||
                 ((wParam == 0x10cf || (wParam == 0x10d0)))) || (wParam == 0x10d1)) ||
               (((wParam == 0x10d2 || (wParam == 0x10d3)) || (wParam == 0x10d4)))) {
              if ((((uint)gd.grBits >> 0xb & 1) != 0) &&
                 (sVar7 = FAskKillTutor(), sVar7 == 0)) {
                return;
              }
              if (((char *)vrgszMRU == (char *)0x0) && (vrgszMRU._2_2_ == 0)) {
                return;
              }
              if (((char *)vrgszMRU)[(wParam + 0xef34) * 0x100] == '\0') {
                return;
              }
              iplrOld = idPlayer;
              __fstrcpy((char *)CONCAT22(unaff_SS,szT),
                                (char *)CONCAT22(vrgszMRU._2_2_,
                                                 (char *)vrgszMRU + (wParam + 0xef34) * 0x100
                                                ));
              pt = (PLANET *)_strrchr(szT,0x2e);
              if ((pt == (PLANET *)0x0) || (sVar7 = __access(szT,0), sVar7 == -1)) {
                _strcpy((char *)szWork,szT);
                sVar7 = 0x10;
                pcVar9 = PszFormatIds(idsCantOpenFile,(short *)0x0);
                AlertSz(pcVar9,sVar7);
                return;
              }
              ini.wFlags = ini.wFlags & 0xfffe | 1;
              DestroyCurGame();
              _strcpy((char *)szBase,szT);
              sVar7 = FOpenGame(hwnd,0);
              if (sVar7 < 1) {
                return;
              }
              InitializeMenu(0);
              CreateChildWindows();
              if (uTimerId == 0) {
                PostMessage(hwnd,0x111,0xfa1,0);
              }
              if ((game.wCrap >> 3 & 1) == 0) {
                return;
              }
              if (idPlayer != 0) {
                return;
              }
              StartTutor(0);
              return;
            }
            if (((wParam != 21000) && (wParam != 0x5209)) &&
               ((HBRUSH *)wParam != (HBRUSH *)&hbrCargo)) goto MDI_Default_4;
            goto LAB_1020_3f6e;
          }
        }
      }
      if (hwndScanner == 0) {
        sVar7 = 0x10;
        pcVar9 = PszFormatIds(idsGameCurrentlyLoaded,(short *)0x0);
        AlertSz(pcVar9,sVar7);
        return;
      }
      if (idPlayer == -1) {
        FWriteDataFile((char *)szBase,-1,0);
        return;
      }
      sVar7 = FNewTurnAvail(idPlayer);
      if (sVar7 == 0) {
        iplrOld = (short)(wParam == 0xedb);
        gd.grBits._0_2_ = (uint)gd.grBits & 0xffef | iplrOld << 4;
        FWriteLogFile((char *)szBase,idPlayer);
        FWriteHistFile(idPlayer);
        return;
      }
      goto MDI_LNewTurnAvail;
    }
    goto LAB_1020_3f6e;
  }
MDI_LWaitForTurn:
  if (((PLANET *)lpPlanets == (PLANET *)0x0) && (lpPlanets._2_2_ == (PLANET *)0x0)) {
    return;
  }
  if (idPlayer == -1) {
    return;
  }
  if ((game.wCrap >> 2 & 1) != 0) {
    return;
  }
  sVar7 = FNewTurnAvail(idPlayer);
  if (sVar7 == 0) {
    gd.grBits._0_2_ = (uint)gd.grBits & 0xffef | 0x10;
    FWriteLogFile((char *)szBase,idPlayer);
    FWriteHistFile(idPlayer);
    HVar10 = hwndFrame;
    pcVar9 = PszGetCompressedString(idsWaitingNewTurn);
    SetWindowText(HVar10,(LPCSTR)CONCAT22(0x1120,pcVar9));
    ShowWindow(hwndFrame,2);
    uTimerId =
         SetTimer(0xe,10000,lpfnHostTimerProc._2_2_,
                  (char)(fn_lpfnHostTimerProc *)lpfnHostTimerProc);
    uTimerType = 0xe;
    HostTimerProc(0,0,uTimerId,0);
    return;
  }
MDI_LNewTurnAvail:
  FWriteHistFile(idPlayer);
  if (game.fDirty == 0) {
    sVar7 = 0x40;
    pcVar9 = PszFormatIds(idsNewTurnAvailable,(short *)0x0);
    AlertSz(pcVar9,sVar7);
  }
  else {
    sVar7 = 0x31;
    pcVar9 = PszFormatIds(idsSorryTurnHasAlreadyGeneratedAnyChanges,(short *)0x0);
    iplrOld = AlertSz(pcVar9,sVar7);
    if (iplrOld == 2) {
      return;
    }
  }
  _WSPRINTF((char *)CONCAT22(unaff_SS,szExt),(char *)CONCAT22(0x1120,MPCTD),
            idPlayer + 1);
  game.fDirty = 0;
  DestroyCurGame();
  sVar7 = FLoadGame((char *)szBase,szExt);
  if (sVar7 == 0) {
    sVar7 = 0x10;
    pcVar9 = PszFormatIds(idsUnableOpenNewTurnFile,(short *)0x0);
    AlertSz(pcVar9,sVar7);
  }
  else {
    CreateChildWindows();
    SendMessage(hwndFrame,0x111,0xfa1,0);
  }
  return;
}



// ======================================================================
// Function: InitializeMenu
// Address: 1020:5376
// Segment: MEMORY_MDI
// ======================================================================


void InitializeMenu(HMENU hmenu)

{
  ushort uVar1;
  UINT UVar2;
  HMENU HVar3;
  short sVar4;
  HMENU hmenuSub;
  short i;
  short cMenu;
  
  if (hmenu == 0) {
    hmenu = GetMenu(hwndFrame);
  }
  uVar1 = GetASubMenu(hwndFrame,0);
  for (i = 0x10cc; i < 0x10d5; i = i + 1) {
    DeleteMenu(uVar1,i,0);
  }
  i = 0;
  while ((i < 9 && (((char *)vrgszMRU)[i * 0x100] != '\0'))) {
    szWork[0] = '&';
    szWork[1] = (char)i + '1';
    szWork[2] = ' ';
    __fstrcpy(szWork + 3,
                      (char *)CONCAT22(vrgszMRU._2_2_,(char *)vrgszMRU + i * 0x100));
    InsertMenu(uVar1,i + 9,0x400,i + 0x10cc,szWork);
    i = i + 1;
  }
  if ((szBase[0] == '\0') || ((game.wCrap >> 2 & 1) != 0)) {
    UVar2 = 3;
  }
  else {
    UVar2 = 0;
  }
  EnableMenuItem(hmenu,0x6a,UVar2);
  if (szBase[0] == '\0') {
    UVar2 = 3;
  }
  else {
    UVar2 = 0;
  }
  EnableMenuItem(hmenu,0x69,UVar2);
  if ((szBase[0] == '\0') ||
     (((game.wCrap >> 2 & 1) != 0 &&
      ((lSaltCur._2_2_ < 0 || ((lSaltCur._2_2_ < 1 && ((int)lSaltCur == 0))))))
     )) {
    UVar2 = 3;
  }
  else {
    UVar2 = 0;
  }
  EnableMenuItem(hmenu,0x10e,UVar2);
  if ((szBase[0] == '\0') || ((game.wCrap >> 2 & 1) != 0)) {
    UVar2 = 3;
  }
  else {
    UVar2 = 0;
  }
  EnableMenuItem(hmenu,0x7de,UVar2);
  if ((szBase[0] == '\0') || ((game.wCrap >> 2 & 1) != 0)) {
    UVar2 = 3;
  }
  else {
    UVar2 = 0;
  }
  EnableMenuItem(hmenu,0xedb,UVar2);
  uVar1 = GetASubMenu(hwndFrame,1);
  if (gd.grBits._2_2_ < 0) {
    UVar2 = 8;
  }
  else {
    UVar2 = 0;
  }
  CheckMenuItem(uVar1,0xb3,UVar2);
  if ((grbitScan & 0x2000) == 0) {
    UVar2 = 0;
  }
  else {
    UVar2 = 8;
  }
  CheckMenuItem(uVar1,0x98d,UVar2);
  if (hwndScanner == 0) {
    HVar3 = GetMenu(hwndFrame);
    EnableMenuItem(HVar3,1,0x403);
  }
  else {
    HVar3 = GetMenu(hwndFrame);
    EnableMenuItem(HVar3,1,0x400);
    uVar1 = GetASubMenu(hwndFrame,1);
    HVar3 = GetSubMenu(uVar1,3);
    CheckMenuItem(HVar3,iScanZoom + 4,0x408);
    sVar4 = GetMenuItemCount(HVar3);
    for (i = 0; i < sVar4; i = i + 1) {
      EnableMenuItem(HVar3,i,0x400);
    }
    uVar1 = GetASubMenu(hwndFrame,1);
    HVar3 = GetSubMenu(uVar1,4);
    CheckMenuItem(HVar3,iWindowLayout,0x408);
  }
  DrawMenuBar(hwndFrame);
  return;
}



// ======================================================================
// Function: EnsureAis
// Address: 1020:56bc
// Segment: MEMORY_MDI
// ======================================================================


void EnsureAis(void)

{
  short pctX10;
  uint rgmdplr [16];
  short iPlayer;
  short fSubmitSav;
  short fWorkDone;
  short fOpened;
  short fErrSav;
  short fHostSav;
  
  fSubmitSav = (uint)gd.grBits >> 4 & 1;
  fWorkDone = 0;
  if (((uint)gd.grBits >> 10 & 1) == 0) {
    fHostSav = (uint)gd.grBits >> 3 & 1;
    if (((uint)gd.grBits >> 3 & 1) == 0) {
      DestroyCurGame();
      FLoadGame((char *)szBase,(char *)0x3f0);
    }
    for (iPlayer = 0; iPlayer < game.cPlayer; iPlayer = iPlayer + 1) {
      rgmdplr[iPlayer] = *(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0);
    }
    gd.grBits._0_2_ = (uint)gd.grBits & 0xffef | 0x10;
    fErrSav = fFileErrSilent;
    fFileErrSilent = 1;
    for (iPlayer = 0; iPlayer < game.cPlayer; iPlayer = iPlayer + 1) {
      pctX10 = MulDiv(0x154,iPlayer + 1,game.cPlayer);
      UpdateProgressGauge(pctX10);
      if ((rgmdplr[iPlayer] >> 9 & 1) != 0) {
        fWorkDone = 1;
        gd.grBits._0_2_ = (uint)gd.grBits & 0xfff5 | 10;
        fOpened = FOpenFile(dtLog,iPlayer,0x20);
        gd.grBits._0_2_ = (uint)gd.grBits & 0xfff5 | (fHostSav & 1U) << 3;
        if (fOpened == 0) {
          DoAiTurn(iPlayer,rgmdplr[iPlayer]);
        }
        else {
          StreamClose();
        }
      }
    }
    gd.grBits._0_2_ = (uint)gd.grBits & 0xffef | (fSubmitSav & 1U) << 4;
    if (fWorkDone != 0) {
      DestroyCurGame();
      FLoadGame((char *)szBase,(char *)0x3f4);
    }
    fFileErrSilent = fErrSav;
    gd.grBits._0_2_ = (uint)gd.grBits & 0xfbff | 0x400;
  }
  return;
}



// ======================================================================
// Function: GetASubMenu
// Address: 1020:589a
// Segment: MEMORY_MDI
// ======================================================================


ushort GetASubMenu(HWND hwnd,short iMenu)

{
  BOOL BVar1;
  int iVar2;
  HMENU HVar3;
  HMENU hmenu;
  short fChildMenu;
  
  if ((hwndActive == 0) || (BVar1 = IsZoomed(hwndActive), BVar1 == 0)) {
    iVar2 = 0;
  }
  else {
    iVar2 = 1;
  }
  HVar3 = GetMenu(hwnd);
  HVar3 = GetSubMenu(HVar3,iMenu + iVar2);
  return HVar3;
}



// ======================================================================
// Function: FOpenGame
// Address: 1020:58f4
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10205d80) */

short FOpenGame(HWND hwnd,short fRaceOnly)

{
  char *pcVar1;
  StringId ids;
  int iVar2;
  short sVar3;
  uint uVar4;
  short grobjIni;
  short fRet;
  char szFilter [512];
  char *pch;
  char szFile [256];
  ushort i;
  undefined2 ofn;
  undefined2 local_4a;
  HWND local_48;
  char *local_44;
  int local_18;
  char *local_16;
  
  if ((ini.wFlags & 1) == 0) {
    szFile[0] = '\0';
    if (fRaceOnly == 0) {
      ids = idsStarsGameFilesMHstRStars;
    }
    else {
      ids = idsStarsGameFilesRFiles;
    }
    CchGetString(ids,szFilter);
    for (i = 0; szFilter[i] != '\0'; i = i + 1) {
      if (szFilter[i] == '|') {
        szFilter[i] = '\0';
      }
    }
    _memset(&ofn,0,0x48);
    ofn = 0x48;
    local_4a = 0;
    local_48 = hwnd;
    local_44 = szFilter;
    iVar2 = GetOpenFileName(0x1118,&ofn);
    if (iVar2 == 0) {
      return 0;
    }
  }
  else {
    _strcpy(szFile,(char *)szBase);
    pcVar1 = _strrchr((char *)szBase,0x5c);
    *pcVar1 = '\0';
    pch = _strrchr(szFile,0x2e);
    if (pch == (char *)0x0) {
      SetSzWorkFromDt(dtHost,-1);
      _strcpy(szFile,(char *)szWork);
      pch = _strrchr(szFile,0x2e);
    }
    local_16 = pch + (1 - (int)szFile);
    local_18 = 0;
    fFileErrSilent = 1;
  }
  szDirName[0] = '\0';
  fRet = FWasRaceFile(szFile + local_18,(uint)(fRaceOnly == 0));
  if (fRaceOnly == 0) {
    if (fRet == 0) {
      szFile[(int)(local_16 + -1)] = '\0';
      DestroyCurGame();
      _strcpy((char *)szBase,szFile);
      sVar3 = FLoadGame(szFile,szFile + (int)local_16);
      if (sVar3 == 0) {
        if ((ini.wFlags & 1) != 0) {
          ini.wFlags = 0;
          fFileErrSilent = 0;
        }
        fRet = 0;
      }
      else {
        if ((ini.wFlags & 1) != 0) {
          fFileErrSilent = 0;
          ini.wFlags = ini.wFlags & 0xfffe;
          pch = _strrchr(szFile,0x5c);
          if (pch != (char *)0x0) {
            i = (int)pch - (int)szFile;
            _strncpy((char *)szDirName,szFile,i);
            *(undefined1 *)(i + 0x252) = 0;
          }
          if ((idPlayer == -1) && ((ini.wFlags >> 3 & 1) == 0)) {
            gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfffb | 4;
          }
          if ((((int)game.lid != (int)ini.lid) ||
              (game.lid._2_2_ != ini.lid._2_2_)) ||
             (ini.turn < game.turn)) {
            ini.wFlags = ini.wFlags & 0xffef;
          }
        }
        sel.grobjFull = grobjNone;
        sel.grobj = grobjNone;
        sel.iwpAct = -1;
        sel.id = -1;
        sel.scan.grobjFull = grobjNone;
        sel.scan.grobj = grobjNone;
        sel.scan.iwp = -1;
        sel.scan.ifl = -1;
        sel.scan.idpl = -1;
        fOrdersVis = 0;
        CreateChildWindows();
        if (idPlayer == -1) {
          if ((hwndTitle != 0) && (fFreeingTitle == 0)) {
            fFreeingTitle = 1;
            DestroyWindow(hwndTitle);
            hwndTitle = 0;
          }
          BringUpHostDlg();
          fRet = 0;
        }
        else {
          uVar4 = ini.wFlags >> 5;
          SendMessage(hwndFrame,0x111,0xfa1,0);
          if (((uVar4 & 0xf) == 0) || ((ini.wFlags >> 5 & 0xf) != 0)) {
            ini.wFlags = ini.wFlags & 0xfe1f;
            if (cPlanet != 0) {
              FFindSomethingAndSelectIt();
            }
            fRet = 1;
          }
          else {
            fRet = 1;
          }
        }
      }
    }
    else {
      if ((((ini.wFlags & 1) != 0) && ((int)vSerialNumber == 0)) &&
         (vSerialNumber._2_2_ == 0)) {
        fRet = -1;
      }
      fFileErrSilent = 0;
      ini.wFlags = ini.wFlags & 0xfffe;
      if (fRet == -1) {
        fRet = -1;
      }
      else {
        RaceCreationWizard(hwnd,0,0);
        fRet = 0;
      }
    }
  }
  else if (0 < fRet) {
    _strcpy((char *)&szRaceFile,szFile + local_18);
  }
  return fRet;
}



// ======================================================================
// Function: FWasRaceFile
// Address: 1020:5da8
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Variable defined which should be unmapped: fRet */

short FWasRaceFile(char *szFile,short fChkPass)

{
  PLAYER *pPVar1;
  PLAYER *pPVar2;
  char cVar3;
  ushort uVar4;
  short sVar5;
  char *sz;
  ushort uVar6;
  int iVar7;
  PLAYER *pPVar8;
  PLAYER *pPVar9;
  short sVar10;
  short fSav;
  short fRet;
  short env [9];
  short (*penvMemSav) [9];
  PLAYER plr;
  undefined2 lSaltSav;
  undefined2 local_8;
  short idsError;
  
  sVar10 = fFileErrSilent;
  idsError = -1;
  fRet = 0;
  fFileErrSilent = 1;
  penvMemSav = penvMem;
  penvMem = &env;
  sVar5 = __setjmp(env);
  uVar4 = wVersFile;
  if (sVar5 == 0) {
    StreamOpen(szFile,0x20);
    ReadRt();
    if ((((hdrCur.wFlags >> 10 == 8) && ((uint)rgbCur._8_2_ >> 0xc == 2)) &&
        (0x30 < ((uint)rgbCur._8_2_ >> 5 & 0x7f))) &&
       (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x54)) {
      uVar4._0_1_ = rgbCur[8];
      uVar4._1_1_ = rgbCur[9];
      wVersFile._0_1_ = rgbCur[8];
      wVersFile._1_1_ = rgbCur[9];
      if (((rgbCur._14_2_ & 0xff) == 5) &&
         (ReadRt(), uVar4 = wVersFile, hdrCur.wFlags >> 10 == 6)) {
        idsError = 3;
        ReadRtPlr(&plr,(byte *)rgbCur);
        ReadRt();
        uVar4 = wVersFile;
        if ((hdrCur.wFlags >> 10 == 0) &&
           (uVar6 = IRaceChecksum(&plr), uVar4 = wVersFile,
           rgbCur._0_2_ == uVar6)) {
          lSaltSav = (int)lSaltCur;
          local_8 = lSaltCur._2_2_;
          lSaltCur._0_2_ = (int)plr.lSalt;
          lSaltCur._2_2_ = plr.lSalt._2_2_;
          if ((fChkPass == 0) || (sVar5 = FCheckPassword(), sVar5 != 0)) {
            lSaltCur._0_2_ = lSaltSav;
            lSaltCur._2_2_ = local_8;
            if (((int)plr.lSalt == 0) && (plr.lSalt._2_2_ == 0)) {
              szRacePass = 0;
            }
            else {
              _strcpy((char *)&szRacePass,(char *)szPassLast);
            }
            pPVar8 = &plr;
            pPVar9 = (PLAYER *)&vplr;
            for (iVar7 = 0x60; iVar7 != 0; iVar7 = iVar7 + -1) {
              pPVar2 = pPVar9;
              pPVar9 = (PLAYER *)&pPVar9->cPlanet;
              pPVar1 = pPVar8;
              pPVar8 = (PLAYER *)&pPVar8->cPlanet;
              cVar3 = pPVar1->cShDef;
              pPVar2->iPlayer = pPVar1->iPlayer;
              pPVar2->cShDef = cVar3;
            }
            _strcpy((char *)&szRaceFile,szFile);
            StreamClose();
            penvMem = penvMemSav;
            fFileErrSilent = sVar10;
            return 1;
          }
          lSaltCur._0_2_ = lSaltSav;
          lSaltCur._2_2_ = local_8;
          fRet = -1;
          uVar4 = wVersFile;
        }
      }
    }
    else {
      idsError = 0xd;
      fRet = -1;
      uVar4 = wVersFile;
    }
  }
  wVersFile = uVar4;
  StreamClose();
  penvMem = penvMemSav;
  fFileErrSilent = sVar10;
  if ((sVar10 == 0) && (idsError != -1)) {
    _strcpy((char *)szWork,szFile);
    sVar10 = 0x10;
    sz = PszFormatIds(idsError,(short *)0x0);
    AlertSz(sz,sVar10);
  }
  return fRet;
}



// ======================================================================
// Function: BringUpHostDlg
// Address: 1020:5ffc
// Segment: MEMORY_MDI
// ======================================================================


void BringUpHostDlg(void)

{
  short sVar1;
  short sVar2;
  FARPROC pvVar3;
  short fRet;
  
  if (((uint)gd.grBits >> 3 & 1) == 0) {
    if ((gd.grBits._2_2_ >> 5 & 1) == 0) {
      FMarkFile(dtHost,-1,1,1);
    }
    gd.grBits._0_2_ = (uint)gd.grBits & 0xfff7 | 8;
  }
  ShowWindow(hwndFrame,0);
  if ((ini.wFlags >> 2 & 1) == 0) {
    while( true ) {
      pvVar3 = MakeProcInstance(HostModeDialog,hInst);
      sVar1 = DialogBox(0,(LPCSTR)CONCAT22(0x73,hwndFrame),(HWND)((ulong)pvVar3 >> 0x10),
                        (char)pvVar3);
      FreeProcInstance(pvVar3);
      if (sVar1 == -1) break;
      if (sVar1 == 0) {
        if ((gd.grBits._2_2_ >> 5 & 1) == 0) {
          FMarkFile(dtHost,-1,1,0);
        }
        gd.grBits._0_2_ = (uint)gd.grBits & 0xfff7;
        DestroyCurGame();
        if ((ini.wFlags >> 3 & 1) != 0) {
          return;
        }
        sVar1 = GetSystemMetrics(0);
        sVar2 = GetSystemMetrics(1);
        hwndTitle =
             CreateWindow(szTitle,(LPCSTR)0x112003f8,0x90000000,0,0,sVar1,sVar2,
                          hwndFrame,0,hInst,(void *)0x0);
        fFreeingTitle = 0;
        return;
      }
      while( true ) {
        if ((gd.grBits._2_2_ >> 10 & 1) != 0) {
          ShowProgressGauge();
        }
        EnsureAis();
        FGenerateTurn();
        if (iPassCnt == 0) break;
        iPassCnt = iPassCnt + -1;
        sVar1 = GetAsyncKeyState(0x10);
        if ((sVar1 < 0) || (sVar1 = GetAsyncKeyState(0x11), sVar1 < 0)) break;
      }
      iPassCnt = 0;
      HideProgressGauge();
    }
  }
  else {
    ini.wFlags = ini.wFlags & 0xfffb;
  }
  ShowWindow(hwndFrame,2);
  uTimerId =
       SetTimer(0xd,10000,lpfnHostTimerProc._2_2_,
                (char)(fn_lpfnHostTimerProc *)lpfnHostTimerProc);
  uTimerType = 0xd;
  HostTimerProc(0,0,uTimerId,0);
  return;
}



// ======================================================================
// Function: DrawHostDialog2
// Address: 1020:6240
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10206505) */

void DrawHostDialog2(HWND hwnd,HDC hdcIn)

{
  char *pcVar1;
  int iVar2;
  uint uVar3;
  char *pcVar4;
  char *pcVar5;
  HWND HVar6;
  uint uVar7;
  uint uVar8;
  undefined2 unaff_SS;
  DWORD DVar9;
  ulong uVar10;
  undefined2 uVar11;
  undefined2 uVar12;
  HDC HVar13;
  char szStat [30];
  short x;
  COLORREF crBackSav;
  RECT rcDiamond;
  short cch;
  short dday;
  ushort dmin;
  short i;
  short yCur;
  short bkMode;
  ushort dhour;
  HDC hdc;
  undefined4 dsec;
  
  if (hdcIn == 0) {
    hdc = GetDC(hwnd);
  }
  else {
    hdc = hdcIn;
  }
  bkMode = SetBkMode(hdc,2);
  crBackSav = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,
                                      (undefined2)crButtonFace));
  SelectObject(hdc,rghfontArial8[1]);
  HVar13 = hdc;
  pcVar1 = PszGetCompressedString(idsN16);
  DVar9 = GetTextExtent(HVar13,(LPCSTR)CONCAT22(0x1120,pcVar1),4);
  x = dyArial8 + 10 + (int)DVar9;
  yCur = 0x30;
  SetRect((RECT *)CONCAT22(unaff_SS,&rcDiamond),6,0x30,dyArial8 + 7,
          dyArial8 + 0x31);
  for (i = 0; i < game.cPlayer; i = i + 1) {
    DrawDiamond(hdc,&rcDiamond,hbrBBlue);
    iVar2 = i + 1;
    pcVar1 = PszGetCompressedString(idsD2);
    cch = _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar1),iVar2);
    RightTextOut(hdc,x,yCur,(char *)szWork,cch,0);
    if (((short *)rgOut)[i] < 1) {
      uVar3 = 0x7f00;
    }
    else {
      uVar3 = 0x7f;
    }
    SetTextColor(hdc,(ulong)uVar3);
    CchGetString(((short *)rgOut)[i] + idsTurned,szStat);
    if ((gd.grBits2._2_2_ >> 6 & 1) == 0) {
      pcVar1 = szStat;
      pcVar4 = PszPlayerName(i,1,1,1,0,(PLAYER *)0x0);
      uVar11 = 0x1120;
      pcVar5 = PszGetCompressedString(idsSS);
      cch = _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar5),pcVar4,uVar11,pcVar1);
    }
    else {
      cch = _WSPRINTF(szWork,(char *)0x112003ff,szStat);
    }
    if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 4 & 1) != 0) {
      _strcat((char *)szWork,(char *)s___HACKER_1120_0403);
      cch = cch + 9;
    }
    TextOut(hdc,x + 4,yCur,szWork,cch);
    SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText));
    OffsetRect((RECT *)CONCAT22(unaff_SS,&rcDiamond),0,dyArial8 + 4);
    yCur = yCur + dyArial8 + 4;
  }
  cch = _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),game.turn + 0x961);
  HVar6 = GetDlgItem(hwnd,0x7e0);
  SetWindowText(HVar6,szWork);
  uVar12 = 0;
  uVar11 = 1000;
  DVar9 = GetTickCount();
  dsec = __aFuldiv(DVar9 - CONCAT22(ctickLast._2_2_,(undefined2)ctickLast),
                           CONCAT22(uVar12,uVar11));
  uVar3 = (uint)dsec;
  if (((int)(dsec >> 0x10) == 0) && (uVar3 < 0x3c)) {
    pcVar1 = PszGetCompressedString(idsDSeconds);
    cch = _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar1),uVar3);
  }
  else {
    uVar10 = __aFuldiv(dsec,0x3c);
    uVar3 = (uint)uVar10;
    iVar2 = (uint)dsec + uVar3 * -0x3c;
    dsec._2_2_ = dsec._2_2_ - (uint)((uint)dsec < uVar3 * 0x3c);
    dsec._0_2_ = iVar2;
    if (uVar3 < 0x3c) {
      dmin = uVar3;
      pcVar1 = PszGetCompressedString(idsD02d);
      cch = _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar1),uVar3,iVar2);
    }
    else {
      uVar7 = uVar3 / 0x3c;
      uVar3 = uVar3 % 0x3c;
      dmin = uVar3;
      if (uVar7 < 0x18) {
        dhour = uVar7;
        pcVar1 = PszGetCompressedString(idsD02d02d);
        cch = _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar1),uVar7,uVar3,iVar2);
      }
      else {
        uVar8 = uVar7 / 0x18;
        uVar7 = uVar7 % 0x18;
        dday = uVar8;
        dhour = uVar7;
        pcVar1 = PszGetCompressedString(idsDDaysD02d02d);
        cch = _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar1),uVar8,uVar7,uVar3,iVar2);
      }
    }
  }
  HVar6 = GetDlgItem(hwnd,0x7e1);
  SetWindowText(HVar6,szWork);
  SetBkMode(hdc,bkMode);
  SetBkColor(hdc,crBackSav);
  if (hdcIn == 0) {
    ReleaseDC(hwnd,hdc);
  }
  return;
}



// ======================================================================
// Function: VerifyTurns
// Address: 1020:6686
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Variable defined which should be unmapped: fOut */
/* WARNING: Variable defined which should be unmapped: cOut */
/* WARNING: Variable defined which should be unmapped: cAi */
/* WARNING: Variable defined which should be unmapped: i */
/* WARNING: Variable defined which should be unmapped: idCur */
/* WARNING: Variable defined which should be unmapped: idsError */

void VerifyTurns(void)

{
  short sVar1;
  short sVar2;
  ulong uVar3;
  short fOut;
  short cOut;
  short i;
  short cAi;
  short idCur;
  short idsError;
  
  lpcd = LpAlloc(12000,htMisc);
  lpxf = LpAlloc(25000,htMisc);
  vrgPlanResExtra = LpAlloc(game.cPlanMax << 1,htMisc);
  __fmemset(vrgPlanResExtra,0,game.cPlanMax << 1);
  sVar2 = 0x1060;
  vrgts = LpAlloc(game.cPlayer << 4,htMisc);
  uVar3 = CONCAT22(ctickLast._2_2_,(undefined2)ctickLast);
  cColDrop = 0;
  cXferFull = 0;
  imemMsgCur = 0;
  i = 0;
  do {
    sVar1 = i;
    ctickLast = uVar3;
    if (game.cPlayer <= i) {
      idsError = 6;
      FreeLp(vrgPlanResExtra,htMisc);
      vrgPlanResExtra._0_2_ = (ushort *)0x0;
      vrgPlanResExtra._2_2_ = 0;
      idsError = 6;
      FreeLp(vrgts,htMisc);
      vrgts._0_2_ = (TURNSERIAL *)0x0;
      vrgts._2_2_ = 0;
      idsError = 6;
      FreeLp(lpcd,htMisc);
      lpcd._0_2_ = (COLDROP *)0x0;
      lpcd._2_2_ = 0;
      idsError = 6;
      uVar3 = (ulong)lpxf >> 0x10;
      FreeLp(lpxf,htMisc);
      lpxf._0_2_ = (XFERFULL *)0x0;
      lpxf._2_2_ = 0;
      idPlayer = (short)uVar3;
      return;
    }
    fOut = ((short *)rgOut)[i];
    if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) {
      idsError = (short)&idsError;
      sVar2 = 0x1048;
      i = 0x6783;
      sVar1 = FCheckLogFile(sVar1,(short *)idsError);
      uVar3 = ctickLast;
      if (sVar1 != 0) goto LAB_1020_678e;
      if (idsError == 0) {
        if ((uRam1120fc36 & 1) == 0) {
          if ((gd.grBits._2_2_ >> 7 & 1) == 0) {
            rgptPlan[0x15a].y = 1;
          }
          else {
            rgptPlan[0x15a].y = 2;
          }
        }
        else {
          rgptPlan[0x15a].y = -1;
        }
      }
      else if (idsError == 0x1c) {
        rgptPlan[0x15a].y = 4;
      }
      else if (idsError == 0x1d) {
        rgptPlan[0x15a].y = 5;
      }
      else {
        rgptPlan[0x15a].y = 3;
      }
    }
    else {
LAB_1020_678e:
      ctickLast = uVar3;
      if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) {
        idsError = i + 1;
        i = 0x1120;
        fOut = 0x1120;
        _WSPRINTF(szWork,(char *)0x1120040d,(char *)szBase);
        idPlayer = 0x1120;
        idsError = (short)szWork;
        sVar2 = FLoadLogFile((char *)szWork);
        if (sVar2 != 0) {
          idsError = 0x1048;
          sVar2 = 0x1048;
          sVar1 = FRunLogFile();
          if (sVar1 == 0) {
            uRam112087e4 = 3;
            uVar3 = ctickLast;
            goto LAB_1020_68d6;
          }
        }
        sVar2 = 0x1048;
        uRam112087e4 = 0;
        uVar3 = ctickLast;
      }
      else {
        ((short *)rgOut)[i] = 0;
        uVar3 = ctickLast;
      }
    }
LAB_1020_68d6:
    if ((uVar3 == 0) || (((short *)rgOut)[i] != fOut)) {
      idsError = sVar2;
      ctickLast = uVar3;
      uVar3 = GetTickCount();
      sVar2 = 0x14f8;
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: CTurnsOutSafe
// Address: 1020:6996
// Segment: MEMORY_MDI
// ======================================================================


short CTurnsOutSafe(void)

{
  short sVar1;
  uint uVar2;
  uint uVar3;
  short sVar4;
  short cturn;
  short fGenSav;
  short fHostModeSav;
  short idPlayerSav;
  
  sVar1 = idPlayer;
  uVar2 = (uint)gd.grBits >> 3;
  uVar3 = (uint)gd.grBits >> 1;
  idPlayer = -1;
  gd.grBits._0_2_ = (uint)gd.grBits & 0xfff5 | 8;
  sVar4 = CFindTurnsOutstanding();
  gd.grBits._0_2_ = (uint)gd.grBits & 0xfff5 | (uVar3 & 1) << 1 | (uVar2 & 1) << 3;
  idPlayer = sVar1;
  return sVar4;
}



// ======================================================================
// Function: CFindTurnsOutstanding
// Address: 1020:6a26
// Segment: MEMORY_MDI
// ======================================================================


short CFindTurnsOutstanding(void)

{
  int iVar1;
  short sVar2;
  ulong uVar3;
  short fOut;
  short fSav;
  short cOut;
  short i;
  short cAi;
  short idsError;
  
  cOut = 0;
  cAi = 0;
  fFileErrSilent = 1;
  gd.grBits._0_2_ = (uint)gd.grBits & 0xfffd | 2;
  i = 0;
  uVar3 = ctickLast;
  do {
    ctickLast._2_2_ = (undefined2)(uVar3 >> 0x10);
    ctickLast._0_2_ = (undefined2)uVar3;
    if (game.cPlayer <= i) {
      gd.grBits._0_2_ = (uint)gd.grBits & 0xfffd;
      gd.grBits._2_2_ =
           gd.grBits._2_2_ & 0xffef | (uint)(cAi == game.cPlayer) << 4;
      fFileErrSilent = 0;
      return cOut;
    }
    iVar1 = ((short *)rgOut)[i];
    idsError = 0;
    if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) == 0) {
      ctickLast = uVar3;
      sVar2 = FCheckLogFile(i,&idsError);
      uVar3 = ctickLast;
      if (sVar2 != 0) goto LAB_1020_6aae;
      if (idsError == 0) {
        if ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) & 1) == 0) {
          if ((gd.grBits._2_2_ >> 7 & 1) == 0) {
            ((short *)rgOut)[i] = 1;
            cOut = cOut + 1;
            uVar3 = ctickLast;
          }
          else {
            ((short *)rgOut)[i] = 2;
            cOut = cOut + 1;
            uVar3 = ctickLast;
          }
        }
        else {
          ((short *)rgOut)[i] = -1;
          uVar3 = ctickLast;
        }
      }
      else {
        if (idsError == 0x1c) {
          ((short *)rgOut)[i] = 4;
          uVar3 = ctickLast;
        }
        else if (idsError == 0x1d) {
          ((short *)rgOut)[i] = 5;
          uVar3 = ctickLast;
        }
        else {
          ((short *)rgOut)[i] = 3;
          uVar3 = ctickLast;
        }
        cOut = cOut + 1;
      }
    }
    else {
LAB_1020_6aae:
      if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 9 & 1) != 0) {
        cAi = cAi + 1;
      }
      ctickLast = uVar3;
      ((short *)rgOut)[i] = 0;
      uVar3 = ctickLast;
    }
    if ((uVar3 == 0) || (((short *)rgOut)[i] != iVar1)) {
      ctickLast = uVar3;
      uVar3 = GetTickCount();
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: HostModeDialog
// Address: 1020:6c16
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Type propagation algorithm not settling */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short HostModeDialog(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  uint uVar1;
  HWND HVar2;
  BOOL BVar3;
  int iVar4;
  char *pcVar5;
  short sVar6;
  undefined2 unaff_SS;
  undefined1 msg [4];
  uint local_32;
  HMENU hmenuPopup;
  short iDiamond;
  short iSel;
  short iRet;
  short i;
  short tpm;
  POINT pt;
  short mf;
  RECT rc;
  short fRet;
  FARPROC lpProc;
  
  if (message == WM_DESTROY) {
    KillTimer(hwnd,uTimerId);
    uTimerId = 0;
    return 0;
  }
  if (message == WM_PAINT) {
    mf = BeginPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,(PAINTSTRUCT *)(msg + 2)));
    if (((int)ctickLast == 0) && (ctickLast._2_2_ == 0)) {
      CFindTurnsOutstanding();
    }
    if ((gd.grBits._2_2_ >> 5 & 1) == 0) {
      HVar2 = GetDlgItem(hwnd,0x408);
      if (((gd.grBits._2_2_ >> 4 & 1) == 0) &&
         ((vtimer.fAutoGenWhenIn != 0 || (vtimer.mdForce != 0)))) {
        BVar3 = 1;
      }
      else {
        BVar3 = 0;
      }
      EnableWindow(HVar2,BVar3);
    }
    DrawHostDialog2(hwnd,mf);
    EndPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,(PAINTSTRUCT *)(msg + 2)));
    return 1;
  }
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(RECT *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    return hbrButtonFace;
  }
  if (message == WM_SETCURSOR) {
LAB_1020_6db6:
    GetCursorPos((POINT *)CONCAT22(unaff_SS,&pt));
    ScreenToClient(hwnd,(POINT *)CONCAT22(unaff_SS,&pt));
    if ((((5 < pt.x) && (pt.x < dyArial8 + 7)) && (0x2f < pt.y)) &&
       ((iDiamond = (pt.y + -0x30) / (dyArial8 + 4), iDiamond < game.cPlayer &&
        ((pt.y + -0x30) % (dyArial8 + 4) < dyArial8 + 1)))) {
      if (message == WM_SETCURSOR) {
        setcursor(hcurHand);
        return 1;
      }
      if ((*(uint *)((int)&rgplr[0].wMdPlr + iDiamond * 0xc0) >> 9 & 1) == 0) {
        iSel = 0;
      }
      else if (*(uint *)((int)&rgplr[0].wMdPlr + iDiamond * 0xc0) >> 0xd == 7) {
        iSel = 2;
      }
      else {
        iSel = 1;
      }
      hmenuPopup = CreatePopupMenu();
      iPopMenuSel = -1;
      for (i = 0; i < 3; i = i + 1) {
        CchGetString(i + idsHumanControlled,(char *)szWork);
        if (i == 1) {
          if (((*(uint *)((int)&rgplr[0].wMdPlr + iDiamond * 0xc0) >> 9 & 1) == 0) ||
             (*(uint *)((int)&rgplr[0].wMdPlr + iDiamond * 0xc0) >> 0xd == 7)) {
            mf = 3;
          }
          else {
            mf = 0;
          }
        }
        else if (((*(uint *)((int)&rgplr[0].wMdPlr + iDiamond * 0xc0) >> 9 & 1) == 0) ||
                (*(uint *)((int)&rgplr[0].wMdPlr + iDiamond * 0xc0) >> 0xd == 7)) {
          mf = 0;
        }
        else {
          mf = 3;
        }
        if (i == iSel) {
          uVar1 = 8;
        }
        else {
          uVar1 = 0;
        }
        AppendMenu(hmenuPopup,uVar1 | mf,i + 15000,szWork);
      }
      ClientToScreen(hwnd,(POINT *)CONCAT22(unaff_SS,&pt));
      if (message == WM_LBUTTONDOWN) {
        tpm = 0;
      }
      else {
        tpm = 2;
      }
      TrackPopupMenu(hmenuPopup,tpm | 4,pt.x,pt.y,0,hwnd,(RECT *)0x0);
      DestroyMenu(hmenuPopup);
      iRet = -1;
      BVar3 = PeekMessage((MSG *)CONCAT22(unaff_SS,(MSG *)msg),hwnd,0x111,0x111,2);
      if (((BVar3 != 0) && (14999 < local_32)) && (local_32 < 0x3afc)) {
        iRet = local_32 + 0xc568;
      }
      if ((iRet != -1) && (iSel != iRet)) {
        *(uint *)((int)&rgplr[0].wMdPlr + iDiamond * 0xc0) =
             *(uint *)((int)&rgplr[0].wMdPlr + iDiamond * 0xc0) & 0xfdff |
             (uint)(0 < iRet) << 9;
        if (iRet == 2) {
          *(uint *)((int)&rgplr[0].wMdPlr + iDiamond * 0xc0) =
               *(uint *)((int)&rgplr[0].wMdPlr + iDiamond * 0xc0) & 0x1fff | 0xe000;
        }
        uVar1 = *(uint *)((int)&rgplr[0].lSalt + 2 + iDiamond * 0xc0);
        *(uint *)((int)&rgplr[0].lSalt + iDiamond * 0xc0) =
             ~*(uint *)((int)&rgplr[0].lSalt + iDiamond * 0xc0);
        *(uint *)((int)&rgplr[0].lSalt + 2 + iDiamond * 0xc0) = ~uVar1;
        FMarkFile(dtTurn,iDiamond,8,(uint)(iRet != 0));
        FMarkFile(dtHost,iDiamond,8,(uint)(iRet != 0));
        gd.grBits._0_2_ = (uint)gd.grBits & 0xfbff;
        fProcessingTimer = 1;
        CFindTurnsOutstanding();
        HVar2 = GetDlgItem(hwnd,0x408);
        if (((gd.grBits._2_2_ >> 4 & 1) == 0) &&
           ((vtimer.fAutoGenWhenIn != 0 || (vtimer.mdForce != 0)))) {
          BVar3 = 1;
        }
        else {
          BVar3 = 0;
        }
        EnableWindow(HVar2,BVar3);
        DrawHostDialog2(hwnd,0);
        fProcessingTimer = 0;
      }
      return 0;
    }
    return 0;
  }
  if (message == WM_INITDIALOG) {
    StickyDlgPos(hwnd,(POINT *)&ptStickyHostModeDlg,1);
    HVar2 = GetDlgItem(hwnd,0x409);
    SetWindowText(HVar2,game.szName);
    HVar2 = GetDlgItem(hwnd,0x40a);
    SetWindowText(HVar2,szBase);
    HVar2 = GetDlgItem(hwnd,0x408);
    if (((gd.grBits._2_2_ >> 5 & 1) == 0) &&
       ((vtimer.fAutoGenWhenIn != 0 || (vtimer.mdForce != 0)))) {
      BVar3 = 1;
    }
    else {
      BVar3 = 0;
    }
    EnableWindow(HVar2,BVar3);
    HVar2 = GetDlgItem(hwnd,0x407);
    EnableWindow(HVar2,(uint)((gd.grBits._2_2_ >> 5 & 1) == 0));
    HVar2 = GetDlgItem(hwnd,0x7df);
    EnableWindow(HVar2,(uint)((gd.grBits._2_2_ >> 5 & 1) == 0));
    uTimerId = SetTimer(0xd,10000,0,0);
  }
  else {
    if (message == WM_COMMAND) {
      if (((wParam == 0x407) || (wParam == 2)) || (wParam == 0x408)) {
        if (wParam == 0x407) {
          sVar6 = GetAsyncKeyState(0x10);
          if (sVar6 < 0) {
            sVar6 = GetAsyncKeyState(0x11);
            if (sVar6 < 0) {
              iPassCnt = 999;
            }
            else {
              iPassCnt = 9;
            }
          }
          else {
            sVar6 = GetAsyncKeyState(0x11);
            if (sVar6 < 0) {
              iPassCnt = 99;
            }
            else {
              iPassCnt = 0;
            }
          }
          if (iPassCnt == 0) {
            sVar6 = CFindTurnsOutstanding();
            if (sVar6 != 0) {
              sVar6 = 0x1024;
              pcVar5 = PszFormatIds(idsSureWishGenerateOptionDoesGuaranteePlayers,(short *)0x0)
              ;
              sVar6 = AlertSz(pcVar5,sVar6);
              if (sVar6 != 6) {
                return 1;
              }
            }
          }
          else {
            iVar4 = iPassCnt + 1;
            pcVar5 = PszGetCompressedString(idsSureWantForceGenerateDTurnsRow);
            _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar5),iVar4);
            HVar2 = GetFocus();
            sVar6 = MessageBox(HVar2,szWork,(LPCSTR)0x1120041a,0x2034);
            if (sVar6 != 6) {
              iPassCnt = 0;
              return 1;
            }
          }
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyHostModeDlg,0);
        if (wParam == 2) {
          sVar6 = 0;
        }
        else if (wParam == 0x408) {
          sVar6 = -1;
        }
        else {
          sVar6 = 1;
        }
        EndDialog(hwnd,sVar6);
        if (wParam == 0x408) {
          EnsureAis();
        }
        else if ((wParam == 2) && (((uint)gd.grBits2 >> 2 & 1) != 0)) {
          PostQuitMessage(vretExitValue);
        }
        return 1;
      }
      if (wParam == 0x7df) {
        sVar6 = FCheckPassword();
        if (sVar6 == 0) {
          return 0;
        }
        lpProc = MakeProcInstance(NewPasswordDlg,hInst);
        fRet = DialogBox(0,(LPCSTR)CONCAT22(0x8d,hwnd),(HWND)((ulong)lpProc >> 0x10),(char)lpProc);
        FreeProcInstance(lpProc);
        SetFocus(hwnd);
        return fRet;
      }
      if (wParam != 0x405) {
        if (wParam != 0x76) {
          return 0;
        }
        WinHelp(hwnd,(LPCSTR)CONCAT22(0x1120,_szHelpFile),1,0x440);
        return 1;
      }
      lpProc = MakeProcInstance(HostOptionsDialog,hInst);
      fRet = DialogBox(0,(LPCSTR)CONCAT22(0x402,hwnd),(HWND)((ulong)lpProc >> 0x10),(char)lpProc);
      FreeProcInstance(lpProc);
      SetFocus(hwnd);
      if (fRet == 0) {
        return 0;
      }
      if ((gd.grBits._2_2_ >> 5 & 1) == 0) {
        HVar2 = GetDlgItem(hwnd,0x408);
        if (((gd.grBits._2_2_ >> 4 & 1) == 0) &&
           ((vtimer.fAutoGenWhenIn != 0 || (vtimer.mdForce != 0)))) {
          BVar3 = 1;
        }
        else {
          BVar3 = 0;
        }
        EnableWindow(HVar2,BVar3);
        return fRet;
      }
      return fRet;
    }
    if (message != WM_TIMER) {
      if ((message != WM_LBUTTONDOWN) && (message != WM_RBUTTONDOWN)) {
        return 0;
      }
      goto LAB_1020_6db6;
    }
  }
  if (fProcessingTimer == 0) {
    fProcessingTimer = 1;
    CFindTurnsOutstanding();
    DrawHostDialog2(hwnd,0);
    fProcessingTimer = 0;
  }
  return (uint)(message != WM_TIMER);
}



// ======================================================================
// Function: HostOptionsDialog
// Address: 1020:75ce
// Segment: MEMORY_MDI
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short HostOptionsDialog(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  short sVar1;
  undefined2 unaff_SS;
  PAINTSTRUCT ps;
  HDC hdc;
  RECT rc;
  
  if (message == WM_DESTROY) {
LAB_1020_76f3:
    sVar1 = 0;
  }
  else {
    if (message == WM_PAINT) {
      hdc = BeginPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,&ps));
      DrawHostOptions(hwnd,hdc,-1);
      EndPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,&ps));
      return 1;
    }
    if (message != WM_ERASEBKGND) {
      if (message == WM_CTLCOLOR) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
      if (message != WM_INITDIALOG) {
        if (message == WM_COMMAND) {
          if ((wParam == 2) || (wParam == 1)) {
            EndDialog(hwnd,(uint)(wParam == 1));
            return 1;
          }
          if (wParam == 0x76) {
            WinHelp(hwnd,(LPCSTR)CONCAT22(0x1120,_szHelpFile),1,0x440);
            return 1;
          }
        }
        goto LAB_1020_76f3;
      }
    }
    GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(RECT *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar1 = 1;
  }
  return sVar1;
}



// ======================================================================
// Function: DrawHostOptions
// Address: 1020:7706
// Segment: MEMORY_MDI
// ======================================================================


void DrawHostOptions(HWND hwnd,HDC hdc,short iDraw)

{
  return;
}



// ======================================================================
// Function: HostTimerProc
// Address: 1020:7716
// Segment: MEMORY_MDI
// ======================================================================


void HostTimerProc(HWND hwnd,ushort msg,ushort idTimer,ulong dwTime)

{
  short sVar1;
  short sVar2;
  char *pcVar3;
  HWND HVar4;
  undefined2 unaff_SS;
  short sVar5;
  short idCur;
  short fSav;
  short cOut;
  char szExt [4];
  HWND hwndT;
  
  sVar1 = fFileErrSilent;
  if (fProcessingTimer == 0) {
    fProcessingTimer = 1;
    if (uTimerType == 0xe) {
      sVar2 = FNewTurnAvail(idPlayer);
      sVar5 = idPlayer;
      if (sVar2 != 0) {
        KillTimer(hwnd,uTimerId);
        _WSPRINTF((char *)CONCAT22(unaff_SS,szExt),(char *)CONCAT22(0x1120,MPCTD),
                  idPlayer + 1);
        DestroyCurGame();
        sVar2 = FLoadGame((char *)szBase,szExt);
        if (sVar2 != 0) {
          idPlayer = sVar5;
          CreateChildWindows();
          uTimerId =
               SetTimer(0xf,1000,lpfnHostTimerProc._2_2_,
                        (char)(fn_lpfnHostTimerProc *)lpfnHostTimerProc);
          uTimerType = 0xf;
          FlashWindow(hwndFrame,1);
          HVar4 = hwndFrame;
          pcVar3 = PszGetCompressedString(idsNewTurnAvailable2);
          SetWindowText(HVar4,(LPCSTR)CONCAT22(0x1120,pcVar3));
          MessageBeep(0x30);
          cOut = 1;
          goto MDI_RedrawText_2;
        }
        sVar5 = 0x10;
        pcVar3 = PszFormatIds(idsUnableOpenNewTurnFile,(short *)0x0);
        AlertSz(pcVar3,sVar5);
      }
    }
    else if (uTimerType == 0xf) {
      FlashWindow(hwndFrame,1);
    }
    else {
      while (cOut = CFindTurnsOutstanding(), (gd.grBits._2_2_ >> 4 & 1) == 0) {
        sVar5 = cOut;
        pcVar3 = PszGetCompressedString(idsHostModeDPlayer);
        _WSPRINTF(szWork,(char *)CONCAT13(0x11,CONCAT12(0x20,pcVar3)),0x20,sVar5);
        if (cOut != 1) {
          _strcat((char *)szWork,(char *)0x421);
        }
        pcVar3 = PszGetCompressedString(idsOut);
        _strcat((char *)szWork,pcVar3);
        SetWindowText(hwndFrame,szWork);
MDI_RedrawText_2:
        hwndT = GetWindow(hwndFrame,3);
        HVar4 = GetWindow(hwndT,4);
        if (HVar4 == hwndFrame) {
          InvalidateRect(hwndT,(RECT *)0x0,1);
        }
        if (cOut != 0) goto MDI_Done_4;
        if ((gd.grBits._2_2_ >> 10 & 1) != 0) {
          ShowProgressGauge();
        }
        EnsureAis();
        FGenerateTurn();
        HideProgressGauge();
        if ((ini.wFlags >> 3 & 1) != 0) {
          PostQuitMessage(vretExitValue);
          goto MDI_Done_4;
        }
        EnsureAis();
      }
      sVar5 = 0x10;
      pcVar3 = PszFormatIds(idsAutoGenerateDisabledBecauseHumanPlayersDead,(short *)0x0);
      AlertSz(pcVar3,sVar5);
      HVar4 = GetDlgItem(hwnd,0x408);
      EnableWindow(HVar4,0);
    }
MDI_Done_4:
    fProcessingTimer = 0;
  }
  fFileErrSilent = sVar1;
  return;
}



// ======================================================================
// Function: GetWindowRc
// Address: 1020:79ac
// Segment: MEMORY_MDI
// ======================================================================


void GetWindowRc(HWND hwnd,RECT *prc)

{
  undefined2 unaff_SS;
  WINDOWPLACEMENT wndpl;
  
  wndpl.length = 0x16;
  GetWindowPlacement(hwnd,(WINDOWPLACEMENT *)CONCAT22(unaff_SS,&wndpl));
  prc->left = wndpl.rcNormalPosition.left;
  prc->top = wndpl.rcNormalPosition.top;
  prc->right = wndpl.rcNormalPosition.right;
  prc->bottom = wndpl.rcNormalPosition.bottom;
  prc->right = prc->right - prc->left;
  prc->bottom = prc->bottom - prc->top;
  return;
}



// ======================================================================
// Function: SetWindowIniString
// Address: 1020:79f6
// Segment: MEMORY_MDI
// ======================================================================


void SetWindowIniString(char *sz,HWND hwnd)

{
  BOOL BVar1;
  int iVar2;
  char *pcVar3;
  HWND HVar4;
  RECT rc;
  char ch;
  
  HVar4 = 0x1020;
  BVar1 = IsZoomed(hwnd);
  if (BVar1 == 0) {
    HVar4 = hwnd;
    BVar1 = IsIconic(hwnd);
    if (BVar1 == 0) {
      ch = 'R';
    }
    else {
      ch = 'I';
    }
  }
  else {
    ch = 'M';
  }
  GetWindowRc(hwnd,&rc);
  iVar2 = (int)ch;
  pcVar3 = PszGetCompressedString(idsC04d04d04d04d);
  _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar3),iVar2,rc.left,rc.top,rc.right,rc.bottom
            ,HVar4);
  return;
}



// ======================================================================
// Function: WriteIniSettings
// Address: 1020:7a76
// Segment: MEMORY_MDI
// ======================================================================


void WriteIniSettings(void)

{
  char cVar1;
  int iVar2;
  int iVar3;
  char *pcVar4;
  ushort uVar5;
  undefined2 unaff_SS;
  undefined2 uVar6;
  short sVar7;
  short sVar8;
  char ch;
  ushort iCol;
  char szSection [16];
  char *psz;
  char szIniFile [16];
  char szEntry [16];
  short iPass;
  short i;
  TILE *rgtile;
  char szPd [4];
  short ctile;
  
  szPd[0] = '%';
  szPd[1] = 100;
  szPd[2] = 0;
  CchGetString(idsWindows,szSection);
  CchGetString(idsStarsIni,szIniFile);
  CchGetString(idsGlobalsettings,szEntry);
  FormatSerialAndEnv(CONCAT22(vSerialNumber._2_2_,(undefined2)vSerialNumber),
                     (byte *)vrgbMachineConfig,(char *)szWork);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsResolution,szEntry);
  i = (short)(vcScreenColors < 5);
  if ((uint)gd.grBits >> 0xe == 0) {
    i = i | 2;
  }
  _WSPRINTF(szWork,(char *)CONCAT22(unaff_SS,szPd),i);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsMain,szEntry);
  SetWindowIniString((char *)szWork,hwndFrame);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsReportfleetwin,szEntry);
  iVar2 = vrptFleet.ptDlg.y + vrptFleet.ptSize.y;
  iVar3 = vrptFleet.ptDlg.x + vrptFleet.ptSize.x;
  uVar6 = 0x4d;
  sVar7 = vrptFleet.ptDlg.x;
  sVar8 = vrptFleet.ptDlg.y;
  pcVar4 = PszGetCompressedString(idsC04d04d04d04d);
  _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar4),uVar6,sVar7,sVar8,iVar3,iVar2);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsReportefleetwin,szEntry);
  iVar2 = vrptEFleet.ptDlg.y + vrptEFleet.ptSize.y;
  iVar3 = vrptEFleet.ptDlg.x + vrptEFleet.ptSize.x;
  uVar6 = 0x4d;
  sVar7 = vrptEFleet.ptDlg.x;
  sVar8 = vrptEFleet.ptDlg.y;
  pcVar4 = PszGetCompressedString(idsC04d04d04d04d);
  _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar4),uVar6,sVar7,sVar8,iVar3,iVar2);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsReportbtlwin,szEntry);
  iVar2 = vrptBattle.ptDlg.y + vrptBattle.ptSize.y;
  iVar3 = vrptBattle.ptDlg.x + vrptBattle.ptSize.x;
  uVar6 = 0x4d;
  sVar7 = vrptBattle.ptDlg.x;
  sVar8 = vrptBattle.ptDlg.y;
  pcVar4 = PszGetCompressedString(idsC04d04d04d04d);
  _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar4),uVar6,sVar7,sVar8,iVar3,iVar2);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsReportplanwin,szEntry);
  iVar2 = vrptPlanet.ptDlg.y + vrptPlanet.ptSize.y;
  iVar3 = vrptPlanet.ptDlg.x + vrptPlanet.ptSize.x;
  uVar6 = 0x4d;
  sVar7 = vrptPlanet.ptDlg.x;
  sVar8 = vrptPlanet.ptDlg.y;
  pcVar4 = PszGetCompressedString(idsC04d04d04d04d);
  _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar4),uVar6,sVar7,sVar8,iVar3,iVar2);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsLayout,szEntry);
  _WSPRINTF(szWork,(char *)CONCAT22(unaff_SS,szPd),iWindowLayout);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsStyle1width,szEntry);
  _WSPRINTF(szWork,(char *)CONCAT22(unaff_SS,szPd),vfs.dxPlanWant);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsStyle1height,szEntry);
  _WSPRINTF(szWork,(char *)CONCAT22(unaff_SS,szPd),vfs.dyMsgWant);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsStyle1height2,szEntry);
  _WSPRINTF(szWork,(char *)CONCAT22(unaff_SS,szPd),vfs.dyMinWant);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsStyle2width,szEntry);
  _WSPRINTF(szWork,(char *)CONCAT22(unaff_SS,szPd),vfs.dx2PlanWant);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsStyle2height,szEntry);
  _WSPRINTF(szWork,(char *)CONCAT22(unaff_SS,szPd),vfs.dy2MsgWant);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsStyle2height2,szEntry);
  _WSPRINTF(szWork,(char *)CONCAT22(unaff_SS,szPd),vfs.dy2MinWant);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsToolbar,szEntry);
  _WSPRINTF(szWork,(char *)CONCAT22(unaff_SS,szPd),gd.grBits._2_2_ >> 0xf);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  iPass = 2;
  rgtile = (TILE *)(TILE *)&rgtilePlanet;
  ctile = 6;
  CchGetString(idsPlanettiles,szEntry);
  while (iPass != 0) {
    psz = (char *)szWork;
    iCol = 0;
    for (i = 0; i < ctile; i = i + 1) {
      while (iCol < (rgtile[i].wFlags_0xa & 7)) {
        iCol = iCol + 1;
        *psz = '*';
        psz = psz + 1;
      }
      if ((rgtile[i].wFlags_0xa >> 7 & 1) == 0) {
        cVar1 = 'a';
      }
      else {
        cVar1 = 'A';
      }
      *psz = cVar1;
      *psz = *psz + ((byte)(rgtile[i].wFlags_0xa >> 3) & 0xf);
      psz = psz + 1;
    }
    *psz = '\0';
    iPass = iPass + -1;
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsShiptiles,szEntry);
    rgtile = (TILE *)(TILE *)&rgtileShip;
    ctile = 7;
  }
  iPass = iPass + -1;
  CchGetString(idsSelection,szEntry);
  if (sel.grobj == grobjNone) {
    ch = 'N';
  }
  else if (sel.grobj == grobjPlanet) {
    ch = 'P';
  }
  else if (sel.grobj == grobjFleet) {
    ch = 'S';
  }
  else if (sel.grobj == grobjOther) {
    ch = 'E';
  }
  iVar2 = (int)(char)((char)idPlayer + 'B');
  iVar3 = (int)ch;
  sVar7 = sel.id;
  pcVar4 = PszGetCompressedString(idsCCD);
  _WSPRINTF(szWork,(char *)CONCAT22(0x1120,pcVar4),iVar3,iVar2,sVar7);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsMessage,szEntry);
  _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),iMsgCur);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsGameid,szEntry);
  _WSPRINTF(szWork,(char *)0x11200423,(undefined2)game.lid,game.lid._2_2_);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsScanzoom,szEntry);
  szWork[0] = (char)iScanZoom + '5';
  szWork[1] = '\0';
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  if (((uint)gd.grBits2 >> 6 & 1) != 0) {
    __itoa(grbitScan,(char *)szWork,10);
    CchGetString(idsScanmodev25,szEntry);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    __itoa(grbitScanShip,(char *)szWork,10);
    CchGetString(idsScanfilterv25,szEntry);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    __itoa(grbitScanEShip,(char *)szWork,10);
    CchGetString(idsScanefilterv25,szEntry);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    __itoa(grbitScanMines,(char *)szWork,10);
    CchGetString(idsScanmines,szEntry);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    __itoa(vpctRadarView,(char *)szWork,10);
    CchGetString(idsScanradar,szEntry);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  }
  __itoa(cMinGrafMax,(char *)szWork,10);
  CchGetString(idsMineralscale,szEntry);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  if (idPlayer != -1) {
    CchGetString(idsFiles,szSection);
    CchGetString(idsWait2,szEntry);
    szWork[0] = (uTimerId != 0) + '0';
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    if (((uint)gd.grBits2 >> 8 & 1) != 0) {
      __itoa(game.turn,(char *)szWork,10);
      CchGetString(idsTurn,szEntry);
      WritePrivateProfileString
                ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
                 szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
      gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfeff;
    }
    CchGetString(idsFile1,szEntry);
    _WSPRINTF(szWork,(char *)0x11200427,(char *)szBase,0x1120,
              idPlayer + 1);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  }
  CchGetString(idsMisc,szSection);
  if (((uint)gd.grBits2 >> 7 & 1) != 0) {
    CchGetString(idsReportplanfld,szEntry);
    _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),
              (undefined2)vrptPlanet.grbitVisible);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportplansort,szEntry);
    i = vrptPlanet.icolSort;
    if (vrptPlanet.fAscending != 0) {
      i = vrptPlanet.icolSort | 0x100;
    }
    _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),i);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportfleetfld,szEntry);
    _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),
              (undefined2)vrptFleet.grbitVisible);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportfleetsort,szEntry);
    i = vrptFleet.icolSort;
    if (vrptFleet.fAscending != 0) {
      i = vrptFleet.icolSort | 0x100;
    }
    _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),i);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportefleetfld,szEntry);
    _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),
              (undefined2)vrptEFleet.grbitVisible);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportefltsort,szEntry);
    i = vrptEFleet.icolSort;
    if (vrptEFleet.fAscending != 0) {
      i = vrptEFleet.icolSort | 0x100;
    }
    _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),i);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportbtlfld,szEntry);
    _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),
              (undefined2)vrptBattle.grbitVisible);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportbtlsort,szEntry);
    i = vrptBattle.icolSort;
    if (vrptBattle.fAscending != 0) {
      i = vrptBattle.icolSort | 0x100;
    }
    _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),i);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    CchGetString(idsReportdefgraph,szEntry);
    _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),gd.grBits2._2_2_ & 0xf);
    WritePrivateProfileString
              ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
               szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  }
  CchGetString(idsHistoryinfo,szEntry);
  _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),uDateInstalled);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  CchGetString(idsVcrspeed,szEntry);
  _WSPRINTF(szWork,(char *)CONCAT22(0x1120,PCTD),viSpeedVCR);
  WritePrivateProfileString
            ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
             szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
  if (((uint)gd.grBits2 >> 4 & 1) != 0) {
    CchGetString(idsZiporders,szSection);
    for (i = 0; i < 4; i = i + 1) {
      _strcpy(szEntry,szSection);
      uVar5 = _strlen(szEntry);
      psz = szEntry + uVar5;
      *psz = (char)i + '1';
      szEntry[uVar5 + 1] = '\0';
      if (*(char *)((int)&vrgZip[0].fValid + i * 0x18) == '\0') {
        szWork[0] = '\0';
      }
      else {
        psz = (char *)szWork;
        for (iPass = 0; iPass < 5; iPass = iPass + 1) {
          *psz = (byte)((((ZIPORDER *)vrgZip)[i].txp.rgia + iPass)->wFlags >> 0xc) + 0x61;
          psz[1] = ((byte)(((ZIPORDER *)vrgZip)[i].txp.rgia + iPass)->wFlags & 0xf) + 0x61
          ;
          pcVar4 = psz + 3;
          psz[2] = ((byte)(((((ZIPORDER *)vrgZip)[i].txp.rgia + iPass)->wFlags & 0xfff) >>
                          4) & 0xf) + 0x61;
          psz = psz + 4;
          *pcVar4 = ((byte)((((ZIPORDER *)vrgZip)[i].txp.rgia + iPass)->wFlags >> 8) & 0xf
                    ) + 0x61;
        }
        _strcpy(psz,(char *)((int)vrgZip[0].szName + i * 0x18));
      }
      WritePrivateProfileString
                ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
                 szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    }
  }
  if (((uint)gd.grBits2 >> 5 & 1) != 0) {
    for (i = 0; i < 5; i = i + 1) {
      CchGetString(idsZiporders,szSection);
      _strcpy(szEntry,szSection);
      uVar5 = _strlen(szEntry);
      psz = szEntry + uVar5 + 1;
      szEntry[uVar5] = 'P';
      *psz = (char)i + '1';
      szEntry[uVar5 + 2] = '\0';
      if (*(char *)((int)&vrgZipProd[0].fValid + i * 0x28) == '\0') {
        szWork[0] = '\0';
      }
      else {
        szWork[0] =
             *(char *)((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 + i * 0x28)
             + 'a';
        szWork[1] =
             *(char *)((int)(ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 +
                      i * 0x28 + 1) + 'a';
        psz = (char *)szWork + 2;
        for (iPass = 0;
            iPass < (int)(uint)*(byte *)((int)(ZIPPRODQ1 *)
                                              &vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1 +
                                        i * 0x28 + 1); iPass = iPass + 1) {
          *psz = ((byte)*(undefined2 *)(i * 0x28 + 0x2306 + iPass * 2) & 0xf) + 0x61;
          psz[1] = ((byte)(*(uint *)(i * 0x28 + 0x2306 + iPass * 2) >> 4) & 0xf) + 0x61;
          pcVar4 = psz + 3;
          psz[2] = ((byte)((uint)*(undefined2 *)(i * 0x28 + 0x2306 + iPass * 2) >> 8) & 0xf) + 0x61;
          psz = psz + 4;
          *pcVar4 = (byte)((uint)*(undefined2 *)(i * 0x28 + 0x2306 + iPass * 2) >> 0xc) + 0x61;
        }
        _strcpy(psz,((ZIPPRODQ *)vrgZipProd)[i].szName);
      }
      WritePrivateProfileString
                ((LPCSTR)CONCAT22(unaff_SS,szSection),(LPCSTR)CONCAT22(unaff_SS,szEntry),
                 szWork,(LPCSTR)CONCAT22(unaff_SS,szIniFile));
    }
  }
  return;
}



// ======================================================================
// Function: RefitFrameChildren
// Address: 1020:8c88
// Segment: MEMORY_MDI
// ======================================================================


void RefitFrameChildren(void)

{
  BOOL BVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  int iVar5;
  ushort uVar6;
  HMENU HVar7;
  UINT UVar8;
  short dyTot;
  short dyT;
  short dyMin;
  short dyMsgMin;
  short dyMinMin;
  short i;
  HMENU hmenu;
  short dyMsg;
  
  if ((hwndFrame != 0) && (BVar1 = IsIconic(hwndFrame), BVar1 == 0)) {
    if ((iWindowLayout == 0) ||
       ((iWindowLayout != 1 && (iWindowLayout != 2)))) {
      if (vfs.dx - vfs.dxPlanWant < 100) {
        vfs.xTop = vfs.dx + -100;
      }
      else {
        vfs.xTop = vfs.dxPlanWant;
      }
      if (vfs.xTop < 199) {
        vfs.xTop = 0xc6;
      }
      iVar2 = (dyArial8 * 0xd >> 1) + 10;
      iVar3 = dyArial8 * 0xd + -0x24;
      if (vfs.dyMsgWant <= iVar2) {
        vfs.dyMsgWant = iVar2;
      }
      dyMin = vfs.dyMinWant;
      if (vfs.dyMinWant <= iVar3) {
        dyMin = iVar3;
      }
      vfs.dyMinWant = dyMin;
      dyMsg = vfs.dyMsgWant;
      if (vfs.dy - (vfs.dyMsgWant + dyMin + 0x10) < 0x32) {
        iVar4 = vfs.dy + -0x42;
        iVar5 = vfs.dyMsgWant + dyMin;
        dyMsg = MulDiv(iVar4,vfs.dyMsgWant,iVar5);
        dyMin = MulDiv(iVar4,dyMin,iVar5);
        if (dyMsg < iVar2) {
          dyMin = dyMin - (iVar2 - dyMsg);
          dyMsg = iVar2;
        }
        else if (dyMin < iVar3) {
          iVar2 = iVar3 - dyMin;
          dyMin = iVar3;
          dyMsg = dyMsg - iVar2;
        }
      }
      vfs.y1 = ((vfs.dy - dyMin) - dyMsg) + -0x10;
      vfs.y2 = vfs.y1 + dyMsg + 8;
      if (hwndScanner != 0) {
        if (gd.grBits._2_2_ < 0) {
          MoveWindow(hwndTb,vfs.xTop + 8,0,
                     (vfs.dx - vfs.xTop) + -8,0x24,1);
          dyT = 0x24;
        }
        else {
          MoveWindow(hwndTb,0,-100,0x32,0x32,1);
          dyT = 0;
        }
        MoveWindow(hwndScanner,vfs.xTop + 8,dyT,
                   (vfs.dx - vfs.xTop) + -8,vfs.dy - dyT,1);
        MoveWindow(hwndPlanet,0,0,vfs.xTop,vfs.y1,1);
        MoveWindow(hwndMessage,0,vfs.y1 + 8,vfs.xTop,dyMsg,1);
        MoveWindow(hwndMine,0,vfs.y2 + 8,vfs.xTop,dyMin,1);
      }
    }
    else {
      if (vfs.dx - vfs.dx2PlanWant < 200) {
        vfs.xTop = vfs.dx + -200;
      }
      else {
        vfs.xTop = vfs.dx2PlanWant;
      }
      if (vfs.xTop < 199) {
        vfs.xTop = 0xc6;
      }
      iVar2 = (dyArial8 * 0xd >> 1) + 10;
      iVar3 = dyArial8 * 0xd + -0x24;
      if (vfs.dy2MsgWant <= iVar2) {
        vfs.dy2MsgWant = iVar2;
      }
      if (vfs.dy2MinWant <= iVar3) {
        vfs.dy2MinWant = iVar3;
      }
      dyMsg = vfs.dy2MsgWant;
      if (vfs.dy - (vfs.dy2MsgWant + 8) < 100) {
        dyMsg = vfs.dy + -0x6c;
      }
      dyMin = vfs.dy2MinWant;
      if (vfs.dy - (vfs.dy2MinWant + 8) < 100) {
        dyMin = vfs.dy + -0x6c;
      }
      vfs.y1 = (vfs.dy - dyMsg) + -8;
      vfs.y2 = (vfs.dy - dyMin) + -8;
      if (hwndScanner != 0) {
        if (gd.grBits._2_2_ < 0) {
          MoveWindow(hwndTb,0,0,vfs.dx,0x24,1);
          dyT = 0x24;
        }
        else {
          MoveWindow(hwndTb,0,-100,0x32,0x32,1);
          dyT = 0;
        }
        MoveWindow(hwndScanner,vfs.xTop + 8,dyT,
                   (vfs.dx - vfs.xTop) + -8,vfs.y2 - dyT,1);
        MoveWindow(hwndPlanet,0,dyT,vfs.xTop,vfs.y1 - dyT,1);
        MoveWindow(hwndMessage,0,vfs.y1 + 8,vfs.xTop,dyMsg,1);
        MoveWindow(hwndMine,vfs.xTop + 8,vfs.y2 + 8,
                   (vfs.dx - vfs.xTop) + -8,dyMin,1);
      }
    }
    uVar6 = GetASubMenu(hwndFrame,1);
    HVar7 = GetSubMenu(uVar6,4);
    for (i = 0x82; i < 0x85; i = i + 1) {
      if (i + -0x82 == iWindowLayout) {
        UVar8 = 8;
      }
      else {
        UVar8 = 0;
      }
      CheckMenuItem(HVar7,i,UVar8);
    }
  }
  return;
}



// ======================================================================
// Function: TitleWndProc
// Address: 1020:9126
// Segment: MEMORY_MDI
// ======================================================================


long TitleWndProc(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  HWND HVar1;
  short sVar2;
  BOOL BVar3;
  HGLOBAL hdib;
  ushort uVar4;
  int iVar5;
  undefined2 unaff_SS;
  LRESULT LVar6;
  short dy_00;
  short x1;
  short dxSrc;
  short dySrc;
  undefined2 uVar7;
  undefined2 uVar8;
  RECT rcT;
  short dx;
  HFONT hfontSav;
  HFONT hfont;
  LOGFONT *plf;
  RECT rcT__68;
  HBRUSH hbrSav;
  RECT rcWnd;
  undefined1 ps [22];
  char *psz;
  short xCur;
  short dx__24;
  short dxGap;
  short dy;
  RECT rc;
  HPALETTE hpalSav;
  short i;
  HDC hdc;
  
  if (msg == 1) {
    if (((7 < vcScreenColors) &&
        (vhdibTitle = HdibLoadBigResource(0x1c1), vhpalSplash == 0)) &&
       (vhdibTitle != 0)) {
      vhpalSplash = HpalFromDib(vhdibTitle);
    }
    GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,&rc));
    dx__24 = rc.right >> 3;
    if (dx__24 < 0x78) {
      dx__24 = 0x78;
    }
    if (rc.bottom < 0x28a) {
      dx__24 = dx__24 + dx__24 / 6;
    }
    iVar5 = rc.right + dx__24 * -4;
    dxGap = iVar5 >> 2;
    xCur = iVar5 >> 3;
    if (rc.bottom < 0x1f5) {
      dy = dyArial8 << 1;
    }
    else {
      dy = (dyArial8 * 5) / 2;
    }
    for (i = 0; i < 4; i = i + 1) {
      psz = PszGetCompressedString(i + idsNewGame);
      HVar1 = CreateWindow(s_BUTTON_1120_043a,(LPCSTR)CONCAT22(0x1120,psz),0x50000000,xCur,
                           (rc.bottom - dy) - (dyArial8 * 5) / 2,dx__24,dy,hwnd,i,
                           hInst,(void *)0x0);
      *(HWND *)(i * 2 + 0x432) = HVar1;
      if ((i == 2) &&
         ((szBase[0] == '\0' ||
          (sVar2 = __access((char *)szBase,0), sVar2 == -1)))) {
        EnableWindow(rghwndBtnSplash[2],0);
      }
      if (rc.bottom < 500) {
        SendMessage(*(HWND *)(i * 2 + 0x432),0x30,rghfontArial8[1],0);
      }
      xCur = xCur + dx__24 + dxGap;
    }
  }
  else {
    if (msg == 2) {
      if (vhdibTitle != 0) {
        GlobalUnlock(vhdibTitle);
        FreeResource(vhdibTitle);
        vhdibTitle = 0;
      }
      if (fFreeingTitle == 0) {
        if ((gd.grBits._2_2_ >> 6 & 1) == 0) {
          WriteIniSettings();
          PostQuitMessage(vretExitValue);
        }
        else {
          ExitWindows((long)vretExitValue,0);
        }
      }
MDI_Default_3:
      LVar6 = DefWindowProc(hwnd,msg,wParam,lParam);
      return LVar6;
    }
    if (msg == 0xf) {
      BVar3 = IsIconic(hwnd);
      if (BVar3 == 0) {
        plf = (LOGFONT *)LocalAlloc(0x40,0x32);
        hdc = BeginPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,(PAINTSTRUCT *)ps));
        hbrSav = SelectObject(hdc,hbrButtonFace);
        GetClientRect(hwnd,(RECT *)CONCAT22(unaff_SS,&rcWnd));
        if ((vcScreenColors < 8) || (SetTextColor(hdc,0x2ff7fff), vhdibTitle == 0))
        {
          rc.left = 0;
          rc.right = rcWnd.right;
          rc.bottom = 0;
          dx = rcWnd.right;
          DrawABunchOfStars(hdc,&rcWnd);
          plf->lfHeight = -rcWnd.bottom / 3;
          _strcpy(plf->lfFaceName,*(char (*) [32])(rgszArial + 3));
          hfont = CreateFontIndirect((LOGFONT *)CONCAT22(0x1120,plf));
          SetTextColor(hdc,0x9b009b);
          if (hfont != 0) {
            hfontSav = SelectObject(hdc,hfont);
            SetBkMode(hdc,1);
            rcT.left = rcWnd.left;
            rcT.top = rcWnd.top;
            rcT.right = rcWnd.right;
            rcT.bottom = (rcWnd.bottom * 3) / 4;
            RcCtrTextOut(hdc,&rcT,(char *)0x441,6);
            SelectObject(hdc,hfontSav);
            DeleteObject(hfont);
          }
        }
        else {
          SelectPalette(hdc,vhpalSplash,0);
          RealizePalette(hdc);
          uVar8 = 600;
          uVar7 = 800;
          dySrc = 0;
          dxSrc = 0;
          x1 = 1;
          uVar4 = vhdibTitle;
          hdib = GetSystemMetrics(1);
          dy_00 = 0;
          sVar2 = GetSystemMetrics(0);
          DibBlt(hdc,0,0,sVar2,dy_00,hdib,x1,uVar4,dxSrc,dySrc,CONCAT22(uVar8,uVar7));
        }
        SelectObject(hdc,rghfontArial10[1]);
        SetBkMode(hdc,1);
        SzVersion();
        GetWindowRect(rghwndBtnSplash[0],(RECT *)CONCAT22(unaff_SS,&rcT__68));
        rcWnd.top = rcT__68.top - (dyArial8 * 9) / 2;
        rcWnd.bottom = (dyArial8 * 3) / 2 + rcWnd.top;
        uVar4 = _strlen((char *)szWork);
        RcCtrTextOut(hdc,&rcWnd,(char *)szWork,uVar4);
        EndPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,(PAINTSTRUCT *)ps));
        LocalFree((HLOCAL)plf);
      }
      else {
        hdc = BeginPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,(PAINTSTRUCT *)ps));
        DrawIcon(hdc,2,2,hiconStars);
        EndPaint(hwnd,(PAINTSTRUCT *)CONCAT22(unaff_SS,(PAINTSTRUCT *)ps));
      }
    }
    else if (msg == 0x111) {
      if (wParam == 0) {
        NewGameWizard(hwnd,0);
        if ((((PLANET *)lpPlanets == (PLANET *)0x0) && (lpPlanets._2_2_ == 0)) &&
           (((int)game.lid == 0 && (game.lid._2_2_ == 0)))) {
          SetFocus(hwnd);
        }
        else {
          if (fFreeingTitle == 0) {
            fFreeingTitle = 1;
            DestroyWindow(hwndTitle);
            hwndTitle = 0;
          }
          ShowWindow(hwndFrame,5);
        }
      }
      else {
        if (wParam != 1) {
          if (wParam != 2) {
            if (wParam != 3) {
              return 0;
            }
            if ((gd.grBits._2_2_ >> 6 & 1) == 0) {
              WriteIniSettings();
              PostQuitMessage(vretExitValue);
              return 0;
            }
            ExitWindows((long)vretExitValue,0);
            return 0;
          }
          ini.wFlags = ini.wFlags & 0xfffe | 1;
        }
        sVar2 = FOpenGame(hwnd,0);
        if (sVar2 < 1) {
          SetFocus(hwnd);
        }
        else {
          if (fFreeingTitle == 0) {
            fFreeingTitle = 1;
            DestroyWindow(hwndTitle);
            hwndTitle = 0;
          }
          if (idPlayer != -1) {
            ShowWindow(hwndFrame,5);
          }
          InitializeMenu(0);
          PostMessage(hwndFrame,0x111,0xfa1,0);
          if (((game.wCrap >> 3 & 1) != 0) && (idPlayer == 0)) {
            StartTutor(0);
          }
        }
        ini.wFlags = ini.wFlags & 0xfffe;
      }
    }
    else {
      if (msg != 0x30f) {
        if (msg != 0x311) goto MDI_Default_3;
        if (wParam == hwnd) {
          return 0;
        }
      }
      if (7 < vcScreenColors) {
        hdc = GetDC(hwnd);
        hpalSav = SelectPalette(hdc,vhpalSplash,0);
        i = RealizePalette(hdc);
        SelectPalette(hdc,hpalSav,0);
        ReleaseDC(hwnd,hdc);
        if (i != 0) {
          InvalidateRect(hwnd,(RECT *)0x0,1);
          return 1;
        }
        return 0;
      }
    }
  }
  return 0;
}



