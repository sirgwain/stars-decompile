// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: PushRandom
// Address: 1040:1440
// Segment: MEMORY_UTILGEN
// ======================================================================


void PushRandom(long lNew1,long lNew2)

{
  int iVar1;
  
  iVar1 = cRandStack * 8;
  *(undefined2 *)*((long (*) [2])rglRandStack + cRandStack) =
       (undefined2)lRandSeed1;
  *(undefined2 *)((int)rglRandStack[0] + 2 + iVar1) = lRandSeed1._2_2_;
  iVar1 = cRandStack * 8;
  *(undefined2 *)((int)rglRandStack[0] + 4 + iVar1) = (undefined2)lRandSeed2;
  *(undefined2 *)((int)rglRandStack[0] + 6 + iVar1) = lRandSeed2._2_2_;
  cRandStack = cRandStack + 1;
  lRandSeed1 = lNew1;
  lRandSeed2 = lNew2;
  return;
}



// ======================================================================
// Function: PopRandom
// Address: 1040:14a2
// Segment: MEMORY_UTILGEN
// ======================================================================


void PopRandom(void)

{
  cRandStack = cRandStack + -1;
  lRandSeed1._0_2_ = (int)(*((long (*) [2])rglRandStack + cRandStack))[0];
  lRandSeed1._2_2_ =
       *(undefined2 *)((int)rglRandStack[0] + 2 + cRandStack * 8);
  lRandSeed2._0_2_ =
       *(undefined2 *)((int)rglRandStack[0] + 4 + cRandStack * 8);
  lRandSeed2._2_2_ =
       *(undefined2 *)((int)rglRandStack[0] + 6 + cRandStack * 8);
  return;
}



// ======================================================================
// Function: Randomize
// Address: 1040:15ea
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: b */

void Randomize(ulong dw)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar1;
  short b;
  short a;
  
  uVar1 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),b);
  b = (uint)uVar1 & 0x3f;
  if (((uint)dw & 0x3f) == b) {
    b = b + 1U & 0x3f;
  }
  lRandSeed1._0_2_ = ((short *)rgPrimes)[(uint)dw & 0x3f];
  lRandSeed1._2_2_ = ((short *)rgPrimes)[(uint)dw & 0x3f] >> 0xf;
  lRandSeed2._0_2_ = ((short *)rgPrimes)[b];
  lRandSeed2._2_2_ = ((short *)rgPrimes)[b] >> 0xf;
  return;
}



// ======================================================================
// Function: Randomize2
// Address: 1040:165a
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: b */

void Randomize2(ulong dw)

{
  uint uVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar2;
  short b;
  short a;
  
  uVar2 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),b);
  uVar1 = (uint)dw & 0x7f ^ 0x35;
  b = (uint)uVar2 & 0x7f ^ 0x5c;
  if (uVar1 == b) {
    b = b + 1U & 0x7f;
  }
  lRandSeed1._0_2_ = ((short *)rgPrimes)[uVar1];
  lRandSeed1._2_2_ = ((short *)rgPrimes)[uVar1] >> 0xf;
  lRandSeed2._0_2_ = ((short *)rgPrimes)[b];
  lRandSeed2._2_2_ = ((short *)rgPrimes)[b] >> 0xf;
  return;
}



// ======================================================================
// Function: Random
// Address: 1040:16d2
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10401832) */

short Random(short c)

{
  long lVar1;
  long lVar2;
  uint uVar3;
  int iVar4;
  uint uVar5;
  int iVar6;
  short sVar7;
  ulong uVar8;
  ulong uVar9;
  ulong uVar10;
  
  iVar6 = lRandSeed2._2_2_;
  uVar5 = (uint)lRandSeed2;
  iVar4 = lRandSeed1._2_2_;
  uVar3 = (uint)lRandSeed1;
  uVar8 = __aFldiv(CONCAT22(lRandSeed1._2_2_,(uint)lRandSeed1),0xd1a4);
  uVar9 = __aFulmul(uVar8,0x2fb3);
  uVar10 = 0x9c4e;
  uVar8 = __aFulmul(uVar8,0xd1a4);
  uVar8 = __aFulmul(CONCAT22((iVar4 - (int)(uVar8 >> 0x10)) - (uint)(uVar3 < (uint)uVar8),
                                     uVar3 - (uint)uVar8),uVar10);
  lVar1 = uVar8 - uVar9;
  if ((lVar1 < 0x10000) && (lVar1 < 0)) {
    lVar1 = lVar1 + 0x7fffffab;
  }
  uVar8 = __aFldiv(CONCAT22(iVar6,uVar5),0xce26);
  uVar9 = __aFulmul(uVar8,0xecf);
  uVar10 = 0x9ef4;
  uVar8 = __aFulmul(uVar8,0xce26);
  uVar8 = __aFulmul(CONCAT22((iVar6 - (int)(uVar8 >> 0x10)) - (uint)(uVar5 < (uint)uVar8),
                                     uVar5 - (uint)uVar8),uVar10);
  lVar2 = uVar8 - uVar9;
  if ((lVar2 < 0x10000) && (lVar2 < 0)) {
    lVar2 = lVar2 + 0x7fffff07;
  }
  uVar8 = lVar1 - lVar2;
  if ((long)uVar8 < 1) {
    uVar8 = uVar8 + 0x7fffffaa;
  }
  if (c < 1) {
    sVar7 = 0;
  }
  else {
    lRandSeed2 = lVar2;
    lRandSeed1 = lVar1;
    uVar8 = __aFulrem(uVar8,(long)c);
    sVar7 = (short)uVar8;
    lVar1 = lRandSeed1;
    lVar2 = lRandSeed2;
  }
  lRandSeed2._2_2_ = (int)((ulong)lVar2 >> 0x10);
  lRandSeed2._0_2_ = (uint)lVar2;
  lRandSeed1._2_2_ = (int)((ulong)lVar1 >> 0x10);
  lRandSeed1._0_2_ = (uint)lVar1;
  return sVar7;
}



// ======================================================================
// Function: RandomSeedDlg
// Address: 1040:188a
// Segment: MEMORY_UTILGEN
// ======================================================================


short RandomSeedDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  int iVar1;
  int iVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar3;
  ushort in_stack_0000ffc8;
  RECT rc;
  undefined4 dw;
  char *pch;
  char szValue [36];
  
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(RECT *)&rc);
    FillRect(wParam,(RECT *)&rc,hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    uVar3 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffc8);
    if ((int)uVar3 == 6) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return hbrButtonFace;
    }
  }
  else {
    if (message == WM_INITDIALOG) {
      SetWindowPos(hwnd,0,0x100,0x100,0,0,0x15);
      SendDlgItemMessage(hwnd,0x10c,0x415,0x1f,0);
      return 1;
    }
    if ((message == WM_COMMAND) && ((wParam == 1 || (wParam == 2)))) {
      if (wParam == 1) {
        GetDlgItemText(hwnd,0x10c,(LPSTR)szValue,0x20);
        pch = szValue;
        dw = 0;
        while ((((undefined *)&DAT_1120_175f)[*pch] & 4) != 0) {
          iVar1 = *pch + -0x30;
          iVar2 = iVar1 >> 0xf;
          uVar3 = __aFulmul(dw,10);
          dw = uVar3 + CONCAT22(iVar2,iVar1);
          pch = pch + 1;
        }
        if (dw == 0) {
          return 1;
        }
        Randomize(dw);
      }
      EndDialog(hwnd,(uint)(wParam == 1));
      return 1;
    }
  }
  return 0;
}



// ======================================================================
// Function: GetFileSeeds
// Address: 1040:1a4e
// Segment: MEMORY_UTILGEN
// ======================================================================


void GetFileSeeds(long *pl1,long *pl2)

{
  undefined2 uVar1;
  
  uVar1 = lFileSeed1._2_2_;
  *(undefined2 *)pl1 = (undefined2)lFileSeed1;
  *(undefined2 *)((int)pl1 + 2) = uVar1;
  uVar1 = lFileSeed2._2_2_;
  *(undefined2 *)pl2 = (undefined2)lFileSeed2;
  *(undefined2 *)((int)pl2 + 2) = uVar1;
  return;
}



// ======================================================================
// Function: SetFileSeeds
// Address: 1040:1a7c
// Segment: MEMORY_UTILGEN
// ======================================================================


void SetFileSeeds(long l1,long l2)

{
  lFileSeed1 = l1;
  lFileSeed2 = l2;
  return;
}



// ======================================================================
// Function: SetFileXorStream
// Address: 1040:1aa6
// Segment: MEMORY_UTILGEN
// ======================================================================


void SetFileXorStream(long lid,short lSalt,short turn,short iPlayer,short fCrippled)

{
  short b;
  short a;
  
  a = lSalt & 0x1f;
  b = lSalt >> 5 & 0x1f;
  if ((lSalt & 0x400U) == 0) {
    b = b + 0x20;
  }
  else {
    a = a + 0x20;
  }
  lFileSeed1._0_2_ = ((short *)rgPrimes)[a];
  lFileSeed1._2_2_ = (int)lFileSeed1 >> 0xf;
  lFileSeed2._0_2_ = ((short *)rgPrimes)[b];
  lFileSeed2._2_2_ = (int)lFileSeed2 >> 0xf;
  a = (((uint)lid & 3) + 1) * ((turn & 3U) + 1) * ((iPlayer & 3U) + 1) + fCrippled;
  while (0 < a) {
    LGetNextFileXor();
    a = a + -1;
  }
  return;
}



// ======================================================================
// Function: LGetNextFileXor
// Address: 1040:1b54
// Segment: MEMORY_UTILGEN
// ======================================================================


long LGetNextFileXor(void)

{
  long lVar1;
  uint uVar2;
  int iVar3;
  uint uVar4;
  int iVar5;
  ulong uVar6;
  ulong uVar7;
  ulong uVar8;
  
  iVar5 = lFileSeed2._2_2_;
  uVar4 = (uint)lFileSeed2;
  iVar3 = lFileSeed1._2_2_;
  uVar2 = (uint)lFileSeed1;
  uVar6 = __aFldiv(CONCAT22(lFileSeed1._2_2_,(uint)lFileSeed1),0xd1a4);
  uVar7 = __aFulmul(uVar6,0x2fb3);
  uVar8 = 0x9c4e;
  uVar6 = __aFulmul(uVar6,0xd1a4);
  uVar6 = __aFulmul(CONCAT22((iVar3 - (int)(uVar6 >> 0x10)) - (uint)(uVar2 < (uint)uVar6),
                                     uVar2 - (uint)uVar6),uVar8);
  lVar1 = uVar6 - uVar7;
  if ((lVar1 < 0x10000) && (lVar1 < 0)) {
    lVar1 = lVar1 + 0x7fffffab;
  }
  uVar6 = __aFldiv(CONCAT22(iVar5,uVar4),0xce26);
  uVar7 = __aFulmul(uVar6,0xecf);
  uVar8 = 0x9ef4;
  uVar6 = __aFulmul(uVar6,0xce26);
  uVar6 = __aFulmul(CONCAT22((iVar5 - (int)(uVar6 >> 0x10)) - (uint)(uVar4 < (uint)uVar6),
                                     uVar4 - (uint)uVar6),uVar8);
  lFileSeed2 = uVar6 - uVar7;
  if ((lFileSeed2 < 0x10000) && (lFileSeed2 < 0)) {
    lFileSeed2 = lFileSeed2 + 0x7fffff07;
  }
  lFileSeed1 = lVar1;
  return lVar1 - lFileSeed2;
}



// ======================================================================
// Function: XorFileBuf
// Address: 1040:1cc4
// Segment: MEMORY_UTILGEN
// ======================================================================


void XorFileBuf(char *rgb,short cb)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar1;
  long lVar2;
  uint *pl;
  
  lVar2 = CONCAT22(unaff_SI,unaff_DI);
  for (pl = (uint *)rgb; pl < rgb + (cb >> 2) * 4; pl = pl + 2) {
    lVar1 = LGetNextFileXor();
    *pl = *pl ^ (uint)lVar1;
    pl[1] = pl[1] ^ (uint)((ulong)lVar1 >> 0x10);
  }
  if ((cb & 3U) != 0) {
    lVar1 = LGetNextFileXor();
    cb = cb & 3U;
    while (cb != 0) {
      *(byte *)pl = (byte)*pl ^ (byte)lVar1;
      lVar1 = __aFlshr(lVar2,(ushort)pl);
      pl = (uint *)((int)pl + 1);
      cb = cb + -1;
    }
  }
  return;
}



// ======================================================================
// Function: ICompLong
// Address: 1040:1d74
// Segment: MEMORY_UTILGEN
// ======================================================================


short ICompLong(void *arg1,void *arg2)

{
  return *(int *)arg1 - *(int *)arg2;
}



// ======================================================================
// Function: PszGetCompressedPlanet
// Address: 1040:1d96
// Segment: MEMORY_UTILGEN
// ======================================================================


char * PszGetCompressedPlanet(short id)

{
  int iVar1;
  bool bVar2;
  byte *pbVar3;
  bool bVar4;
  short iLen;
  byte *pch;
  char *pszOut;
  byte *pchLen;
  short iNibble;
  short iBuild;
  short i;
  short iChunk;
  short fHigh;
  short iOffset;
  short fCap;
  
  iNibble = 0;
  if (0x3e6 < id) {
    id = id % 999;
  }
  if (id != iLastGet) {
    pchLen = (byte *)CONCAT22((undefined *)&DAT_1120_1040,
                              (undefined *)&DAT_1120_1004 + (id >> 6) * 0x40);
    for (i = 0; i < (int)(id & 0x3fU); i = i + 1) {
      iNibble = iNibble + (uint)*pchLen;
      pchLen = (byte *)CONCAT22(pchLen._2_2_,(byte *)pchLen + 1);
    }
    pch = (byte *)CONCAT22((undefined *)&DAT_1120_1040,
                           (byte *)(((short *)aiPNChunkOffset)[id >> 6] + (iNibble >> 1)));
    bVar4 = (iNibble & 1U) == 0;
    pszOut = (char *)szLastGet;
    iBuild = 0;
    bVar2 = true;
    iLen = (uint)*pchLen;
    while (pbVar3 = pch, iVar1 = iLen + -1, iLen != 0) {
      if (bVar4) {
        i = (int)(uint)*pch >> 4;
      }
      else {
        pch = (byte *)CONCAT22(pch._2_2_,(byte *)pch + 1);
        i = *pbVar3 & 0xf;
      }
      bVar4 = !bVar4;
      iBuild = iBuild + i;
      iLen = iVar1;
      if (i != 0xf) {
        *pszOut = ((char *)rgPNLookupTable)[iBuild];
        if (((bVar2) && ('`' < *pszOut)) && (*pszOut < '{')) {
          *pszOut = *pszOut + -0x20;
        }
        if ((*pszOut == ' ') || (*pszOut == '-')) {
          bVar2 = true;
        }
        else {
          bVar2 = false;
        }
        pszOut = pszOut + 1;
        iBuild = 0;
      }
    }
    *pszOut = '\0';
  }
  return (char *)szLastGet;
}



// ======================================================================
// Function: OutputFileString
// Address: 1040:1f64
// Segment: MEMORY_UTILGEN
// ======================================================================


void OutputFileString(char *szFile,char *sz)

{
  short sVar1;
  HFILE HVar2;
  ushort uVar3;
  undefined2 unaff_SS;
  undefined2 uVar4;
  HFILE HVar5;
  short hf;
  ushort w;
  undefined2 of [69];
  
  w = 2;
  sVar1 = __access(szFile,0);
  if (sVar1 == -1) {
    w = 0x1002;
  }
  HVar2 = OpenFile((LPCSTR)szFile,(undefined2 *)of,w);
  if (HVar2 != 0xffff) {
    __lseek(HVar2,0,2);
    uVar4 = 0x1120;
    HVar5 = HVar2;
    uVar3 = _strlen(sz);
    _lwrite(uVar3,(char *)CONCAT22(uVar4,sz),HVar5);
    _lclose(HVar2);
  }
  return;
}



// ======================================================================
// Function: CopyFile
// Address: 1040:1ffa
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104020de) */

void CopyFile(char *szSrc,char *szDst)

{
  undefined2 uVar1;
  short sVar2;
  ushort uVar3;
  undefined2 unaff_SS;
  long lVar4;
  uint cb;
  int local_8a4;
  short hfDst;
  undefined1 env [18];
  undefined2 of [68];
  short fFileErrSav;
  undefined1 rgb [2050];
  
  uVar1 = penvMem;
  fFileErrSav = fFileErrSilent;
  hfDst = -1;
  fFileErrSilent = 1;
  penvMem = env;
  sVar2 = __setjmp(env);
  if (sVar2 == 0) {
    StreamOpen(szSrc,0x20);
    hfDst = OpenFile((LPCSTR)szDst,(undefined2 *)of,0x1012);
    if (hfDst == 0xffff) {
      StreamClose();
      return;
    }
    lVar4 = __filelength(hf);
    while( true ) {
      local_8a4 = (int)((ulong)lVar4 >> 0x10);
      cb = (uint)lVar4;
      if (lVar4 < 0x801) break;
      RgFromStream((undefined1 *)rgb,0x800);
      uVar3 = _lwrite(0x800,(undefined1 *)rgb,hfDst);
      if (uVar3 != 0x800) goto UTILGEN_LStreamError;
      lVar4 = CONCAT22(local_8a4 - (uint)(cb < 0x800),cb - 0x800);
    }
    if (lVar4 != 0) {
      RgFromStream((undefined1 *)rgb,cb);
      _lwrite(cb,(undefined1 *)rgb,hfDst);
    }
  }
UTILGEN_LStreamError:
  StreamClose();
  if (hfDst != -1) {
    _lclose(hf);
  }
  fFileErrSilent = fFileErrSav;
  penvMem = (undefined1 *)uVar1;
  return;
}



// ======================================================================
// Function: AlertSz
// Address: 1040:2160
// Segment: MEMORY_UTILGEN
// ======================================================================


short AlertSz(char *sz,short mbType)

{
  short sVar1;
  HWND HVar2;
  undefined2 unaff_SS;
  char szT [2];
  
  if ((((uint)ini.wFlags >> 0xe & 1) == 0) &&
     ((-1 < ini.wFlags || (((uint)ini.wFlags >> 3 & 1) == 0)))) {
    HVar2 = GetFocus();
    sVar1 = MessageBox(HVar2,(LPCSTR)sz,&DAT_1120_1385,mbType);
  }
  else {
    wsprintf((char *)szT,s_Error___s_1120_137b,sz,0x1120);
    if (((uint)ini.wFlags >> 0xe & 1) == 0) {
      sVar1 = 6;
    }
    else {
      sVar1 = 7;
    }
    szT[0] = -8;
    szT[1] = '\x14';
    OutputSz(sVar1,(char *)szT);
    sVar1 = 6;
  }
  return sVar1;
}



// ======================================================================
// Function: CchGetString
// Address: 1040:221e
// Segment: MEMORY_UTILGEN
// ======================================================================


short CchGetString(StringId ids,char *psz)

{
  char *pcVar1;
  char *pszT;
  
  pcVar1 = psz;
  pszT = PszGetCompressedString(ids);
  while (*pszT != '\0') {
    *psz = *pszT;
    psz = psz + 1;
    pszT = pszT + 1;
  }
  *psz = '\0';
  return (int)psz - (int)pcVar1;
}



// ======================================================================
// Function: PszFromInt
// Address: 1040:2274
// Segment: MEMORY_UTILGEN
// ======================================================================


char * PszFromInt(short i,short *pcch)

{
  short sVar1;
  short cch;
  
  sVar1 = wsprintf(szFormatNumber,(char *)PCTD,i);
  if (pcch != (short *)0x0) {
    *pcch = sVar1;
  }
  return (char *)szFormatNumber;
}



// ======================================================================
// Function: PszFromLong
// Address: 1040:22b6
// Segment: MEMORY_UTILGEN
// ======================================================================


char * PszFromLong(long l,short *pcch)

{
  short sVar1;
  short cch;
  
  sVar1 = wsprintf(szFormatNumber,(char *)PCTLD,(undefined2)l,l._2_2_);
  if (*pcch != 0) {
    *pcch = sVar1;
  }
  return (char *)szFormatNumber;
}



// ======================================================================
// Function: PszFromLongK
// Address: 1040:22fe
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10402315) */
/* WARNING: Removing unreachable block (ram,0x10402339) */

char * PszFromLongK(long l,short *pcch)

{
  int iVar1;
  bool bVar2;
  bool bVar3;
  char *pcVar4;
  short fLarge;
  short fExtraLarge;
  
  bVar2 = 9999 < l;
  bVar3 = 999999 < l;
  if (bVar3) {
    l = __aFldiv(l + 500000,1000000);
    if ((-1 < l) && ((0 < (int)((ulong)l >> 0x10) || (999 < (uint)l)))) {
      l = 999;
    }
  }
  else if (bVar2) {
    l = __aFldiv(l + 500,1000);
    if ((-1 < l) && ((0 < (int)((ulong)l >> 0x10) || (999 < (uint)l)))) {
      l = 999;
    }
  }
  pcVar4 = PszFromInt((short)l,pcch);
  if (bVar3) {
    iVar1 = *pcch;
    *pcch = *pcch + 1;
    pcVar4[iVar1] = 'M';
  }
  else if (bVar2) {
    iVar1 = *pcch;
    *pcch = *pcch + 1;
    pcVar4[iVar1] = 'k';
  }
  return pcVar4;
}



// ======================================================================
// Function: CommaFormatLong
// Address: 1040:2440
// Segment: MEMORY_UTILGEN
// ======================================================================


short CommaFormatLong(char *psz,long l)

{
  short sVar1;
  undefined2 unaff_SS;
  char *pch;
  char *pchOut;
  short cSkip;
  short c;
  char rgch [18];
  
  sVar1 = wsprintf((char *)rgch,(char *)PCTLD,(undefined2)l,l._2_2_);
  pch = rgch;
  pchOut = psz;
  cSkip = sVar1 % 3;
  if (cSkip == 0) {
    cSkip = 3;
  }
  else if (((cSkip == 1) && (l < 0x10000)) && (l < 0)) {
    cSkip = 4;
  }
  while (0 < cSkip) {
    *pchOut = *pch;
    pch = pch + 1;
    pchOut = pchOut + 1;
    cSkip = cSkip + -1;
  }
  while (*pch != '\0') {
    cSkip = 3;
    *pchOut = ',';
    while( true ) {
      pchOut = pchOut + 1;
      if (cSkip < 1) break;
      *pchOut = *pch;
      pch = pch + 1;
      cSkip = cSkip + -1;
    }
  }
  *pchOut = '\0';
  return (int)pchOut - (int)psz;
}



// ======================================================================
// Function: CtrTextOut
// Address: 1040:2534
// Segment: MEMORY_UTILGEN
// ======================================================================


void CtrTextOut(HDC hdc,short x,short y,char *psz,short cLen)

{
  DWORD DVar1;
  short dx;
  
  if (cLen == 0) {
    cLen = lstrlen((LPCSTR)psz);
  }
  DVar1 = GetTextExtent(hdc,(LPCSTR)psz,cLen);
  TextOut(hdc,x - ((int)DVar1 >> 1),y,(LPCSTR)psz,cLen);
  return;
}



// ======================================================================
// Function: DxStreamTextOut
// Address: 1040:2590
// Segment: MEMORY_UTILGEN
// ======================================================================


short DxStreamTextOut(HDC hdc,short *px,short y,char *psz,short cLen,short fPrint)

{
  DWORD DVar1;
  short dx;
  
  if (cLen == 0) {
    cLen = lstrlen((LPCSTR)psz);
  }
  DVar1 = GetTextExtent(hdc,(LPCSTR)psz,cLen);
  if (fPrint != 0) {
    TextOut(hdc,*px,y,(LPCSTR)psz,cLen);
  }
  *px = *px + (int)DVar1;
  return (int)DVar1;
}



// ======================================================================
// Function: WrapTextOut
// Address: 1040:25fe
// Segment: MEMORY_UTILGEN
// ======================================================================


void WrapTextOut
          (HDC hdc,short *px,short *py,char *psz,short cLen,short xLeft,short dxWidth,short *pxMax,
          short fNewLine,short fPrint)

{
  bool bVar1;
  DWORD DVar2;
  char *pchStart;
  short dx;
  short xRight;
  short fItFit;
  char *pchEnd;
  short dxRemain;
  
  dxRemain = dxWidth - (*px - xLeft);
  if (cLen == 0) {
    cLen = _strlen(psz);
  }
  if (fNewLine != 0) {
    *py = *py + dyArial8;
    *px = xLeft;
  }
  pchStart = psz;
  do {
    pchEnd = pchStart + cLen;
    ChopTrailingSpaces(pchStart,&pchEnd);
    DVar2 = GetTextExtent(hdc,(LPCSTR)pchStart,(int)pchEnd - (int)pchStart);
    bVar1 = true;
    dx = (short)DVar2;
    while (((dxRemain < dx && (pchStart < pchEnd)) && (0 < dx))) {
      bVar1 = false;
      ChopLastWord(pchStart,&pchEnd);
      DVar2 = GetTextExtent(hdc,(LPCSTR)pchStart,(int)pchEnd - (int)pchStart);
      dx = (short)DVar2;
    }
    if (bVar1) {
      AddBackTrailingSpaces(&pchEnd,pchStart + cLen);
      DVar2 = GetTextExtent(hdc,(LPCSTR)pchStart,(int)pchEnd - (int)pchStart);
      dx = (short)DVar2;
    }
    if (pchStart == pchEnd) {
      if (*px == xLeft) {
        pchEnd = pchStart + cLen;
        DVar2 = GetTextExtent(hdc,(LPCSTR)pchStart,(int)pchEnd - (int)pchStart);
        dx = (short)DVar2;
        goto LAB_1040_275f;
      }
    }
    else {
LAB_1040_275f:
      if (fPrint != 0) {
        TextOut(hdc,*px,*py,(LPCSTR)pchStart,(int)pchEnd - (int)pchStart);
      }
      *px = *px + dx;
      if ((pxMax != (short *)0x0) && (*pxMax < *px)) {
        *pxMax = *px;
      }
      if (pchEnd == pchStart + cLen) {
        return;
      }
    }
    AddBackTrailingSpaces(&pchEnd,pchStart + cLen);
    cLen = cLen - ((int)pchEnd - (int)pchStart);
    pchStart = pchEnd;
    *py = *py + dyArial8;
    *px = xLeft;
    dxRemain = dxWidth;
  } while( true );
}



// ======================================================================
// Function: AddBackTrailingSpaces
// Address: 1040:280c
// Segment: MEMORY_UTILGEN
// ======================================================================


void AddBackTrailingSpaces(char **ppch,char *pchEnd)

{
  while ((*ppch < pchEnd && (**ppch == ' '))) {
    *ppch = *ppch + 1;
  }
  return;
}



// ======================================================================
// Function: ChopLastWord
// Address: 1040:2842
// Segment: MEMORY_UTILGEN
// ======================================================================


void ChopLastWord(char *pBeg,char **ppEnd)

{
  while ((pBeg < *ppEnd && ((*ppEnd)[-1] == ' '))) {
    *ppEnd = *ppEnd + -1;
  }
  while ((pBeg < *ppEnd && ((*ppEnd)[-1] != ' '))) {
    *ppEnd = *ppEnd + -1;
  }
  while ((pBeg < *ppEnd && ((*ppEnd)[-1] == ' '))) {
    *ppEnd = *ppEnd + -1;
  }
  return;
}



// ======================================================================
// Function: ChopTrailingSpaces
// Address: 1040:28c6
// Segment: MEMORY_UTILGEN
// ======================================================================


void ChopTrailingSpaces(char *pBeg,char **ppEnd)

{
  while ((pBeg < *ppEnd && ((*ppEnd)[-1] == ' '))) {
    *ppEnd = *ppEnd + -1;
  }
  return;
}



// ======================================================================
// Function: RcCtrTextOut
// Address: 1040:28fc
// Segment: MEMORY_UTILGEN
// ======================================================================


void RcCtrTextOut(HDC hdc,RECT *prc,char *psz,short cLen)

{
  int iVar1;
  int iVar2;
  int iVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  DWORD DVar4;
  ulong uVar5;
  short x;
  short y;
  
  uVar5 = CONCAT22(unaff_SI,unaff_DI);
  if (cLen == -1) {
    FillRect(hdc,(RECT *)prc,hbrButtonFace);
    cLen = 0;
  }
  if (cLen == 0) {
    cLen = lstrlen((LPCSTR)psz);
  }
  DVar4 = GetTextExtent(hdc,(LPCSTR)psz,cLen);
  iVar1 = prc->right;
  iVar2 = prc->left;
  iVar3 = prc->left;
  uVar5 = __aFulshr(uVar5,(ushort)DVar4);
  TextOut(hdc,(int)((iVar1 - iVar2) - (ushort)DVar4) / 2 + iVar3,
          ((prc->bottom - prc->top) - (int)uVar5) / 2 + prc->top,(LPCSTR)psz,cLen);
  return;
}



// ======================================================================
// Function: RightTextOut
// Address: 1040:29d6
// Segment: MEMORY_UTILGEN
// ======================================================================


void RightTextOut(HDC hdc,short x,short y,char *psz,short cLen,short dxErase)

{
  undefined2 unaff_SS;
  DWORD DVar1;
  RECT rc;
  short dx;
  
  if (cLen == -1) {
    cLen = CchGetString(idsNone2,psz);
  }
  else if (cLen == 0) {
    cLen = lstrlen((LPCSTR)psz);
  }
  DVar1 = GetTextExtent(hdc,(LPCSTR)psz,cLen);
  dx = (short)DVar1;
  if (dx < dxErase) {
    SetRect((RECT *)&rc,x - dxErase,y,x - dx,y + dyArial8);
    FillRect(hdc,(RECT *)&rc,hbrButtonFace);
  }
  else if ((0 < dxErase) && (dxErase < dx)) {
    SetRect((RECT *)&rc,x - dxErase,y,x,y + dyArial8);
    ExtTextOut(hdc,x - dx,y,6,(RECT *)&rc,(LPCSTR)psz,cLen,(short *)0x0);
    return;
  }
  TextOut(hdc,x - dx,y,(LPCSTR)psz,cLen);
  return;
}



// ======================================================================
// Function: DiaganolTextOut
// Address: 1040:2afa
// Segment: MEMORY_UTILGEN
// ======================================================================


void DiaganolTextOut(HDC hdc,RECT *prc,char *psz,short cLen)

{
  double dVar1;
  int iVar2;
  undefined4 uVar3;
  int iVar4;
  int iVar5;
  int *piVar6;
  short sVar7;
  ushort uVar8;
  HFONT HVar9;
  HGDIOBJ HVar10;
  int iVar11;
  int iVar12;
  int iVar13;
  int iVar14;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  double *pdVar15;
  long lVar16;
  ulong uVar17;
  long local_48;
  short dHtY;
  short dHtX;
  short dyFlat;
  short dx;
  HFONT hfontSav;
  short dxText;
  short dyEstFont;
  short xStart;
  short dyText;
  short dy;
  short yStart;
  short dxFlat;
  HFONT hfont;
  
  if (cLen == 0) {
    cLen = _strlen(psz);
  }
  iVar4 = prc->right - prc->left;
  iVar5 = prc->bottom - prc->top;
  if ((9 < iVar4) && (9 < iVar5)) {
    piVar6 = (int *)LocalAlloc(0x40,0x32);
    piVar6[4] = 900;
    _strcpy((char *)(piVar6 + 9),*(char (*) [32])(rgszArial + 1));
    iVar13 = iVar4;
    if (iVar4 <= iVar5) {
      iVar13 = iVar5;
    }
    *piVar6 = -iVar13;
    while (*piVar6 < -4) {
      sVar7 = MulDiv(0x6f,-*piVar6,100);
      if (iVar5 < sVar7) {
        if ((sVar7 - iVar5) / 2 < 2) {
          iVar13 = 2;
        }
        else {
          iVar13 = (sVar7 - iVar5) / 2;
        }
        *piVar6 = *piVar6 + iVar13;
      }
      else {
        local_48 = (long)iVar4;
        dVar1 = (double)local_48;
        uVar8 = iVar5 - sVar7;
        iVar13 = (int)uVar8 >> 0xf;
        pdVar15 = _atan2(SUB84((double)(long)(int)uVar8,0),
                                 (double)CONCAT26((int)((qword)dVar1 >> 0x10),
                                                  CONCAT24(SUB82(dVar1,0),
                                                           (long)((qword)(double)(long)(int)uVar8 >>
                                                                 0x20))),
                                 (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >>
                                                                                   0x20))));
        dVar1 = *(double *)pdVar15;
        lVar16 = __ftol((double)CONCAT26(iVar13,CONCAT24(uVar8,CONCAT22(unaff_SI,unaff_DI)))
                               );
        piVar6[2] = (int)lVar16;
        HVar9 = CreateFontIndirect((int *)piVar6);
        HVar10 = SelectObject(hdc,HVar9);
        GetTextExtent(hdc,(LPCSTR)psz,cLen);
        uVar17 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),uVar8);
        iVar13 = (int)uVar17;
        pdVar15 = SUB84(dVar1,0);
        uVar3 = (undefined4)((qword)dVar1 >> 0x20);
        _sin(pdVar15,(double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,uVar3)));
        _cos(pdVar15,(double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,uVar3)));
        iVar14 = iVar13 >> 0xf;
        lVar16 = __ftol((double)CONCAT26(iVar14,CONCAT24(iVar13,CONCAT22(unaff_SI,unaff_DI))
                                                ));
        iVar11 = (int)lVar16;
        lVar16 = __ftol((double)CONCAT26(iVar14,CONCAT24(iVar13,CONCAT22(unaff_SI,unaff_DI))
                                                ));
        iVar12 = (int)lVar16;
        if ((iVar11 + 8 <= iVar4) && (iVar12 + 8 <= iVar5)) {
          iVar2 = prc->left;
          lVar16 = __ftol((double)CONCAT26(iVar14,CONCAT24(iVar13,CONCAT22(unaff_SI,unaff_DI
                                                                                  ))));
          TextOut(hdc,(iVar4 - iVar11) / 2 + iVar2,
                  (prc->bottom - (iVar5 - iVar12) / 2) - (int)lVar16,(LPCSTR)psz,cLen);
          SelectObject(hdc,HVar10);
          DeleteObject(HVar9);
          break;
        }
        SelectObject(hdc,HVar10);
        DeleteObject(HVar9);
        if (iVar4 < iVar11 + 8) {
          sVar7 = MulDiv(*piVar6,iVar4,iVar11 + 8);
          dHtX = MulDiv(sVar7,100,0x6f);
        }
        else {
          dHtX = -1000;
        }
        if (iVar5 < iVar12 + 8) {
          sVar7 = MulDiv(*piVar6,iVar5,iVar12 + 8);
          dHtY = MulDiv(sVar7,100,0x6f);
        }
        else {
          dHtY = -1000;
        }
        sVar7 = dHtX;
        if (dHtX <= dHtY) {
          sVar7 = dHtY;
        }
        if (sVar7 - *piVar6 < 2) {
          iVar13 = 2;
        }
        else {
          if (dHtX <= dHtY) {
            dHtX = dHtY;
          }
          iVar13 = dHtX - *piVar6;
        }
        *piVar6 = *piVar6 + iVar13 + 1;
      }
    }
    LocalFree((HLOCAL)piVar6);
  }
  return;
}



// ======================================================================
// Function: ExpandRc
// Address: 1040:2f0c
// Segment: MEMORY_UTILGEN
// ======================================================================


void ExpandRc(RECT *prc,short dx,short dy)

{
  prc->left = prc->left - dx;
  prc->right = prc->right + dx;
  prc->top = prc->top - dy;
  prc->bottom = prc->bottom + dy;
  return;
}



// ======================================================================
// Function: OffsetRc
// Address: 1040:2f3e
// Segment: MEMORY_UTILGEN
// ======================================================================


void OffsetRc(RECT *prc,short dx,short dy)

{
  prc->left = prc->left + dx;
  prc->right = prc->right + dx;
  prc->top = prc->top + dy;
  prc->bottom = prc->bottom + dy;
  return;
}



// ======================================================================
// Function: BoundPoints
// Address: 1040:2f70
// Segment: MEMORY_UTILGEN
// ======================================================================


void BoundPoints(RECT *prc,POINT *rgpt,short cpt)

{
  short yMin;
  short xMin;
  short yMax;
  short xMax;
  short ipt;
  
  xMin = rgpt->x;
  yMin = rgpt->y;
  yMax = yMin;
  xMax = xMin;
  for (ipt = 1; ipt < cpt; ipt = ipt + 1) {
    if ((rgpt + ipt)->x <= xMin) {
      xMin = (rgpt + ipt)->x;
    }
    if (xMax <= (rgpt + ipt)->x) {
      xMax = (rgpt + ipt)->x;
    }
    if (rgpt[ipt].y <= yMin) {
      yMin = rgpt[ipt].y;
    }
    if (yMax <= rgpt[ipt].y) {
      yMax = rgpt[ipt].y;
    }
  }
  prc->top = yMin + -1;
  prc->bottom = yMax + 1;
  prc->left = xMin + -1;
  prc->right = xMax + 1;
  return;
}



// ======================================================================
// Function: StickyDlgPos
// Address: 1040:3094
// Segment: MEMORY_UTILGEN
// ======================================================================


void StickyDlgPos(HWND hwnd,POINT *ppt,short fInit)

{
  undefined2 unaff_SS;
  RECT rc;
  int ptScreenMax;
  int local_6;
  
  GetWindowRect(hwnd,(RECT *)&rc);
  if (fInit == 0) {
    ppt->x = rc.left;
    ppt->y = rc.top;
  }
  else {
    ptScreenMax = GetSystemMetrics(0);
    local_6 = GetSystemMetrics(1);
    if ((ppt->x == -1) && (ppt->y == -1)) {
      rc.left = ptScreenMax - (rc.right - rc.left) >> 1;
      rc.top = local_6 - (rc.bottom - rc.top) >> 1;
    }
    else {
      OffsetRect((RECT *)&rc,ppt->x - rc.left,ppt->y - rc.top);
      if (ptScreenMax < rc.right) {
        rc.left = rc.left + (ptScreenMax - rc.right);
      }
      if (local_6 < rc.bottom) {
        rc.top = rc.top + (local_6 - rc.bottom);
      }
      if (rc.left < 0) {
        rc.left = 0;
      }
      if (rc.top < 0) {
        rc.top = 0;
      }
    }
    SetWindowPos(hwnd,0,rc.left,rc.top,0,0,0x15);
  }
  return;
}



// ======================================================================
// Function: LDrawGauge
// Address: 1040:31a2
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104031f9) */
/* WARNING: Removing unreachable block (ram,0x10403214) */

long LDrawGauge(HDC hdc,RECT *prc,short cSegs,long *rgSize,ushort *rghbr,long cTot)

{
  undefined2 unaff_SS;
  long lVar1;
  ulong uVar2;
  undefined2 uVar3;
  undefined2 uVar4;
  RECT rc;
  int dx;
  int local_e;
  undefined4 lSum;
  short i;
  short fHuge;
  
  lSum._0_2_ = 0;
  lSum._2_2_ = 0;
  rc.left = prc->left;
  rc.top = prc->top;
  rc.right = prc->right;
  rc.bottom = prc->bottom;
  FrameRect(hdc,(RECT *)&rc,hbrWindowText);
  ExpandRc(&rc,-1,-1);
  if (0 < cTot) {
    fHuge = (short)(9999999 < cTot);
    if (fHuge != 0) {
      cTot = __aFldiv(cTot,1000);
    }
    dx = rc.right - rc.left;
    local_e = dx >> 0xf;
    for (i = 0; i < cSegs; i = i + 1) {
      if (fHuge == 0) {
        lSum = lSum + CONCAT22(*(undefined2 *)((int)(rgSize + i) + 2),(int)rgSize[i]);
      }
      else {
        lVar1 = __aFldiv(CONCAT22(*(undefined2 *)((int)(rgSize + i) + 2),(int)rgSize[i]),
                                 1000);
        lSum = lVar1 + lSum;
      }
      uVar3 = (undefined2)cTot;
      uVar4 = cTot._2_2_;
      uVar2 = __aFulmul(CONCAT22(local_e,dx),lSum);
      lVar1 = __aFldiv(uVar2,CONCAT22(uVar4,uVar3));
      rc.right = prc->left + 1 + (int)lVar1;
      if (rc.left < rc.right) {
        FillRect(hdc,(RECT *)&rc,rghbr[i]);
      }
      rc.left = rc.right;
    }
  }
  rc.right = prc->right + -1;
  uVar2 = lSum;
  if (rc.left < rc.right) {
    FillRect(hdc,(RECT *)&rc,hbrButtonFace);
    uVar2 = lSum;
  }
  if (fHuge != 0) {
    lSum = uVar2;
    uVar2 = __aFulmul(uVar2,1000);
  }
  return uVar2;
}



// ======================================================================
// Function: InitBtnTrack
// Address: 1040:354c
// Segment: MEMORY_UTILGEN
// ======================================================================


void InitBtnTrack
          (BTNT *pbtnt,HWND hwnd,HDC hdc,RECT *prc,short btf,short dTimer,short fInitDown,
          short fNoEndRedraw,char *szText)

{
  pbtnt->hwnd = hwnd;
  pbtnt->wFlags = pbtnt->wFlags & 0xfff7U | (uint)(hdc == 0) << 3;
  if (hdc == 0) {
    hdc = GetDC(hwnd);
  }
  pbtnt->hdc = hdc;
  (&pbtnt->rc)->left = prc->left;
  (pbtnt->rc).top = prc->top;
  (pbtnt->rc).right = prc->right;
  (pbtnt->rc).bottom = prc->bottom;
  pbtnt->btf = btf;
  pbtnt->dTimer = dTimer;
  pbtnt->wFlags = pbtnt->wFlags & 0xfffeU | 1;
  pbtnt->wFlags = pbtnt->wFlags & 0xfffbU | (fInitDown & 1U) << 2;
  pbtnt->wFlags = pbtnt->wFlags & 0xffefU | (fNoEndRedraw & 1U) << 4;
  pbtnt->wFlags = pbtnt->wFlags & 0xfffdU | 2;
  pbtnt->szText = szText;
  return;
}



// ======================================================================
// Function: FTrackBtn
// Address: 1040:364a
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104037b7) */

short FTrackBtn(BTNT *pbtnt)

{
  int iVar1;
  long lVar2;
  short sVar3;
  uint uVar4;
  DWORD DVar5;
  POINT PVar6;
  short fInBtn;
  POINT pt;
  
  if ((pbtnt->wFlags & 1U) == 0) {
    pt.x = (&pbtnt->rc)->left;
    pt.y = (pbtnt->rc).top;
    do {
      sVar3 = FGetMouseMove(&pt);
      if (sVar3 == 0) {
        if ((((uint)pbtnt->wFlags >> 1 & 1) != 0) && (((uint)pbtnt->wFlags >> 4 & 1) == 0)) {
          pbtnt->wFlags = pbtnt->wFlags & 0xfffd;
          DrawBtn(pbtnt->hdc,&pbtnt->rc,pbtnt->btf,
                  (uint)pbtnt->wFlags >> 1 & 1 ^ (uint)pbtnt->wFlags >> 2 & 1,pbtnt->szText);
          pbtnt->wFlags = pbtnt->wFlags & 0xfffdU | 2;
        }
        ReleaseCapture();
        if (((uint)pbtnt->wFlags >> 3 & 1) != 0) {
          ReleaseDC(pbtnt->hwnd,pbtnt->hdc);
        }
        return 0;
      }
      PVar6.y = pt.y;
      PVar6.x = pt.x;
      uVar4 = PtInRect((RECT *)&pbtnt->rc,PVar6);
      if (uVar4 != ((uint)pbtnt->wFlags >> 1 & 1)) {
        pbtnt->wFlags = pbtnt->wFlags & 0xfffdU | (uVar4 & 1) << 1;
        DrawBtn(pbtnt->hdc,&pbtnt->rc,pbtnt->btf,
                (uint)pbtnt->wFlags >> 1 & 1 ^ (uint)pbtnt->wFlags >> 2 & 1,pbtnt->szText);
      }
      DVar5 = GetCurrentTime();
    } while (((long)DVar5 < CONCAT22(*(undefined2 *)((int)&pbtnt->lTicks + 2),(int)pbtnt->lTicks))
            || (((uint)pbtnt->wFlags >> 1 & 1) == 0));
    lVar2 = DVar5 + (long)pbtnt->dTimer;
    *(int *)&pbtnt->lTicks = (int)lVar2;
    *(undefined2 *)((int)&pbtnt->lTicks + 2) = (int)((ulong)lVar2 >> 0x10);
  }
  else {
    SetCapture(pbtnt->hwnd);
    DrawBtn(pbtnt->hdc,&pbtnt->rc,pbtnt->btf,
            (uint)pbtnt->wFlags >> 1 & 1 ^ (uint)pbtnt->wFlags >> 2 & 1,pbtnt->szText);
    iVar1 = pbtnt->dTimer;
    DVar5 = GetCurrentTime();
    lVar2 = DVar5 + (long)(iVar1 * 3);
    *(int *)&pbtnt->lTicks = (int)lVar2;
    *(undefined2 *)((int)&pbtnt->lTicks + 2) = (int)((ulong)lVar2 >> 0x10);
    pbtnt->wFlags = pbtnt->wFlags & 0xfffe;
  }
  return 1;
}



// ======================================================================
// Function: DrawBtn
// Address: 1040:38b8
// Segment: MEMORY_UTILGEN
// ======================================================================


void DrawBtn(HDC hdc,RECT *prc,short bt,short fDown,char *szText)

{
  uint uVar1;
  HBRUSH HVar2;
  int iVar3;
  int iVar4;
  int iVar5;
  int iVar6;
  HGDIOBJ HVar7;
  short sVar8;
  undefined2 unaff_SS;
  ulong uVar9;
  long lVar10;
  undefined2 uVar11;
  undefined2 uVar12;
  HFONT hfontSav;
  short dxyT;
  RECT rc;
  short x;
  short cpt;
  HBRUSH hbrSav;
  short dx;
  COLORREF crSav;
  HBRUSH hbrCur;
  int rgptDraw [4];
  int local_2a;
  int local_28;
  int local_26;
  int local_24;
  int local_22;
  int local_20;
  short y;
  short fNoShaft;
  short dy;
  short dxOffset;
  short fDisabled;
  short fBar;
  short d;
  short dyOffset;
  short ipt;
  int dxFace;
  int local_6;
  
  fDisabled = bt & 4;
  rc.left = prc->left;
  rc.top = prc->top;
  rc.right = prc->right;
  rc.bottom = prc->bottom;
  hbrSav = SelectObject(hdc,hbrWindowFrame);
  if ((bt & 0x40U) == 0) {
    FrameRect(hdc,(RECT *)&rc,hbrWindowFrame);
    ExpandRc(&rc,-1,-1);
  }
  dx = (rc.right - rc.left) + -1;
  dy = (rc.bottom - rc.top) + -1;
  uVar1 = prc->right - prc->left;
  dxFace = uVar1 - 5;
  local_6 = ((int)uVar1 >> 0xf) + -1 + (uint)(4 < uVar1);
  HVar2 = hbrButtonShadow;
  if (fDown == 0) {
    HVar2 = hbrButtonHilite;
  }
  SelectObject(hdc,HVar2);
  PatBlt(hdc,rc.left,rc.top,dx,1,0xf00021);
  PatBlt(hdc,rc.left,rc.top,1,dy,0xf00021);
  HVar2 = hbrButtonFace;
  if (fDown == 0) {
    HVar2 = hbrButtonShadow;
  }
  SelectObject(hdc,HVar2);
  PatBlt(hdc,rc.left,rc.bottom + -1,dx + 1,1,0xf00021);
  PatBlt(hdc,rc.right + -1,rc.top,1,dy,0xf00021);
  if (((dx < 0xe) || (dy < 0xe)) || ((bt & 0xc0U) != 0)) {
    ExpandRc(&rc,-1,-1);
  }
  else {
    PatBlt(hdc,rc.left + 1,rc.bottom + -2,dx + -1,1,0xf00021);
    PatBlt(hdc,rc.right + -2,rc.top + 1,1,dy + -2,0xf00021);
    SetRect((RECT *)&rc,rc.left + 1,rc.top + 1,rc.right + -2,rc.bottom + -2);
  }
  SelectObject(hdc,hbrButtonFace);
  FillRect(hdc,(RECT *)&rc,hbrButtonFace);
  if ((bt & 8U) == 0) {
    fBar = bt & 0x10;
    fNoShaft = bt & 0x20;
    uVar1 = bt & 3;
    if (fNoShaft == 0) {
      cpt = 5;
      _memcpy(rgptDraw,(POINT *)rgptArrow,0x14);
      dx = 6;
      dy = 6;
    }
    else {
      cpt = 3;
      _memcpy(rgptDraw,(POINT *)rgptTriangle,0xc);
      dx = 8;
      dy = 4;
    }
    if (fBar != 0) {
      for (ipt = 0; ipt < cpt; ipt = ipt + 1) {
        rgptDraw[ipt * 2 + 1] = rgptDraw[ipt * 2 + 1] + 1;
      }
      dy = dy + 2;
      rgptDraw[cpt * 2 + 1] = 0;
      rgptDraw[cpt * 2] = 0;
      cpt = cpt + 1;
    }
    for (ipt = 0; ipt < cpt; ipt = ipt + 1) {
      if (rgptDraw[ipt * 2] < 0) {
        rgptDraw[ipt * 2] = rgptDraw[0] * 2 - rgptDraw[rgptDraw[ipt * 2] * -2];
      }
      else {
        uVar12 = 0;
        uVar11 = 0xb;
        uVar9 = __aFulmul((long)rgptDraw[ipt * 2],CONCAT22(local_6,dxFace));
        lVar10 = __aFldiv(uVar9,CONCAT22(uVar12,uVar11));
        rgptDraw[ipt * 2] = (int)lVar10;
      }
      uVar12 = 0;
      uVar11 = 0xb;
      uVar9 = __aFulmul((long)rgptDraw[ipt * 2 + 1],CONCAT22(local_6,dxFace));
      lVar10 = __aFldiv(uVar9,CONCAT22(uVar12,uVar11));
      rgptDraw[ipt * 2 + 1] = (int)lVar10;
    }
    uVar12 = 0;
    uVar11 = 0xb;
    uVar9 = __aFulmul((long)dx,CONCAT22(local_6,dxFace));
    lVar10 = __aFldiv(uVar9,CONCAT22(uVar12,uVar11));
    dx = (short)lVar10;
    uVar12 = 0;
    uVar11 = 0xb;
    uVar9 = __aFulmul((long)dy,CONCAT22(local_6,dxFace));
    lVar10 = __aFldiv(uVar9,CONCAT22(uVar12,uVar11));
    dy = (int)lVar10;
    iVar3 = ((prc->right - prc->left) - dx >> 1) + fDown;
    dxOffset = iVar3;
    dyOffset = ((prc->bottom - prc->top) - (int)lVar10 >> 1) + fDown;
    if ((uVar1 == 2) || (uVar1 == 3)) {
      dxOffset = dyOffset;
      dyOffset = iVar3;
    }
    for (ipt = 0; ipt < cpt; ipt = ipt + 1) {
      if (uVar1 == 1) {
        rgptDraw[ipt * 2 + 1] = dy - rgptDraw[ipt * 2 + 1];
      }
      if ((uVar1 == 2) || (uVar1 == 3)) {
        d = dx - rgptDraw[ipt * 2];
        rgptDraw[ipt * 2] = rgptDraw[ipt * 2 + 1];
        rgptDraw[ipt * 2 + 1] = d;
        if (uVar1 == 3) {
          rgptDraw[ipt * 2] = dy - rgptDraw[ipt * 2];
        }
      }
      rgptDraw[ipt * 2] = rgptDraw[ipt * 2] + prc->left + dxOffset;
      rgptDraw[ipt * 2 + 1] = rgptDraw[ipt * 2 + 1] + prc->top + dyOffset;
    }
    hbrCur = hbrButtonHilite;
    if (fDisabled == 0) {
      hbrCur = hbrButtonText;
    }
    SelectObject(hdc,hbrCur);
    while( true ) {
      if ((uVar1 == 0) || (uVar1 == 1)) {
        if (uVar1 == 0) {
          dy = -1;
        }
        else {
          dy = 1;
        }
        x = rgptDraw[2];
        dx = (local_2a - rgptDraw[2]) + 1;
        y = rgptDraw[3];
        if (fBar != 0) {
          PatBlt(hdc,rgptDraw[2],rgptDraw[(cpt + -1) * 2 + 1],dx,1,0xf00021);
        }
        for (; 0 < dx; dx = dx + -2) {
          PatBlt(hdc,x,y,dx,1,0xf00021);
          x = x + 1;
          y = y + dy;
        }
      }
      else {
        if (uVar1 == 2) {
          dx = -1;
        }
        else {
          dx = 1;
        }
        y = local_28;
        dy = (rgptDraw[3] - local_28) + 1;
        x = rgptDraw[2];
        if (fBar != 0) {
          PatBlt(hdc,rgptDraw[(cpt + -1) * 2],local_28,1,dy,0xf00021);
        }
        for (; 0 < dy; dy = dy + -2) {
          PatBlt(hdc,x,y,1,dy,0xf00021);
          y = y + 1;
          x = x + dx;
        }
      }
      if (fNoShaft == 0) {
        iVar3 = local_26;
        if (local_22 <= local_26) {
          iVar3 = local_22;
        }
        iVar4 = local_24;
        if (local_20 <= local_24) {
          iVar4 = local_20;
        }
        iVar5 = local_26;
        if (local_26 <= local_22) {
          iVar5 = local_22;
        }
        iVar6 = local_24;
        if (local_24 <= local_20) {
          iVar6 = local_20;
        }
        SetRect((RECT *)&rc,iVar3,iVar4,iVar5 + 1,iVar6 + 1);
        FillRect(hdc,(RECT *)&rc,hbrCur);
      }
      if (fDisabled == 0) break;
      for (ipt = 0; ipt < cpt; ipt = ipt + 1) {
        rgptDraw[ipt * 2] = rgptDraw[ipt * 2] + -1;
        rgptDraw[ipt * 2 + 1] = rgptDraw[ipt * 2 + 1] + -1;
      }
      fDisabled = 0;
      hbrCur = hbrButtonShadow;
      SelectObject(hdc,hbrButtonShadow);
    }
  }
  SelectObject(hdc,hbrSav);
  if (szText != (char *)0x0) {
    HVar7 = SelectObject(hdc,rghfontArial8[1]);
    sVar8 = SetBkMode(hdc,1);
    uVar11 = (undefined2)crButtonHilite;
    uVar12 = crButtonHilite._2_2_;
    if (fDisabled == 0) {
      uVar11 = (undefined2)crButtonText;
      uVar12 = crButtonText._2_2_;
    }
    crSav = SetTextColor(hdc,CONCAT22(uVar12,uVar11));
    rc.left = prc->left;
    rc.top = prc->top;
    rc.right = prc->right;
    rc.bottom = prc->bottom;
    if (fDown != 0) {
      OffsetRc(&rc,1,1);
    }
    RcCtrTextOut(hdc,&rc,szText,0);
    if (fDisabled != 0) {
      OffsetRc(&rc,-1,-1);
      SetTextColor(hdc,CONCAT22(crButtonShadow._2_2_,(undefined2)crButtonShadow)
                  );
      RcCtrTextOut(hdc,&rc,szText,0);
    }
    SetTextColor(hdc,crSav);
    SetBkMode(hdc,sVar8);
    SelectObject(hdc,HVar7);
  }
  return;
}



// ======================================================================
// Function: FGetMouseMove
// Address: 1040:4146
// Segment: MEMORY_UTILGEN
// ======================================================================


short FGetMouseMove(POINT *ppt)

{
  BOOL BVar1;
  undefined2 unaff_SI;
  undefined2 unaff_SS;
  ulong uVar2;
  undefined4 in_stack_0000ffe8;
  ushort in_stack_0000ffec;
  short local_10;
  
  uVar2 = CONCAT22((int)((ulong)in_stack_0000ffe8 >> 0x10),unaff_SI);
  do {
    BVar1 = PeekMessage((undefined2 *)&stack0xffea,0,0,0,1);
    if (BVar1 == 0) {
      return 1;
    }
  } while ((in_stack_0000ffec != 0x200) && (in_stack_0000ffec != 0x202));
  ppt->x = local_10;
  uVar2 = __aFulshr(uVar2,in_stack_0000ffec);
  ppt->y = (short)uVar2;
  return (uint)(in_stack_0000ffec != 0x202);
}



// ======================================================================
// Function: FGetRMouseMove
// Address: 1040:41e0
// Segment: MEMORY_UTILGEN
// ======================================================================


short FGetRMouseMove(POINT *ppt)

{
  BOOL BVar1;
  undefined2 unaff_SI;
  undefined2 unaff_SS;
  ulong uVar2;
  undefined4 in_stack_0000ffe8;
  ushort in_stack_0000ffec;
  short local_10;
  
  uVar2 = CONCAT22((int)((ulong)in_stack_0000ffe8 >> 0x10),unaff_SI);
  do {
    BVar1 = PeekMessage((undefined2 *)&stack0xffea,0,0,0,1);
    if (BVar1 == 0) {
      return 1;
    }
  } while ((in_stack_0000ffec != 0x200) && (in_stack_0000ffec != 0x205));
  ppt->x = local_10;
  uVar2 = __aFulshr(uVar2,in_stack_0000ffec);
  ppt->y = (short)uVar2;
  return (uint)(in_stack_0000ffec != 0x205);
}



// ======================================================================
// Function: DrawFuzzyBorder
// Address: 1040:427a
// Segment: MEMORY_UTILGEN
// ======================================================================


void DrawFuzzyBorder(HDC hdc,RECT *prc)

{
  HGDIOBJ HVar1;
  int iVar2;
  int iVar3;
  COLORREF CVar4;
  COLORREF CVar5;
  HBRUSH hbrSav;
  short dx;
  short dy;
  
  CVar4 = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
  CVar5 = SetTextColor(hdc,CONCAT22(crWindowText._2_2_,(undefined2)crWindowText)
                      );
  HVar1 = SelectObject(hdc,hbr50Screen);
  iVar2 = prc->right - prc->left;
  iVar3 = prc->bottom - prc->top;
  PatBlt(hdc,prc->left,prc->top,iVar2,2,0x5a0049);
  PatBlt(hdc,prc->left,prc->bottom + -2,iVar2,2,0x5a0049);
  PatBlt(hdc,prc->left,prc->top + 2,2,iVar3 + -4,0x5a0049);
  PatBlt(hdc,prc->right + -2,prc->top + 2,2,iVar3 + -4,0x5a0049);
  SelectObject(hdc,HVar1);
  SetTextColor(hdc,CVar5);
  SetBkColor(hdc,CVar4);
  return;
}



// ======================================================================
// Function: FStringFitsScreen
// Address: 1040:43aa
// Segment: MEMORY_UTILGEN
// ======================================================================


short FStringFitsScreen(char *lpsz,short dxMax)

{
  HDC HVar1;
  HGDIOBJ HVar2;
  DWORD DVar3;
  HFONT hfontSav;
  short fFit;
  short c;
  HDC hdc;
  
  fFit = 1;
  HVar1 = GetDC(hwndFrame);
  c = __fstrlen(lpsz);
  HVar2 = SelectObject(HVar1,rghfontArial8[0]);
  while ((0 < c && (DVar3 = GetTextExtent(HVar1,lpsz,c), (uint)dxMax < (uint)DVar3))) {
    fFit = 0;
    c = c + -1;
    ((char *)lpsz)[c] = '\0';
  }
  SelectObject(HVar1,HVar2);
  ReleaseDC(hwndFrame,HVar1);
  return fFit;
}



// ======================================================================
// Function: HbrGet
// Address: 1040:4448
// Segment: MEMORY_UTILGEN
// ======================================================================


ushort HbrGet(COLORREF cr)

{
  ushort uVar1;
  HBRUSH hbr;
  short i;
  short iFree;
  
  iFree = -1;
  i = 0;
  do {
    if (chbrCache <= i) {
      uVar1 = CreateSolidBrush(cr);
      if (uVar1 == 0) {
        uVar1 = 0;
      }
      else {
        if (iFree == -1) {
          if (0x1f < chbrCache) {
            return uVar1;
          }
          iFree = chbrCache;
          chbrCache = chbrCache + 1;
        }
        ((byte *)rghbrCacheUse)[iFree] = 1;
        ((ushort *)rghbrCache)[iFree] = uVar1;
        *(int *)((ulong *)rgcrCache + iFree) = (int)cr;
        *(int *)((int)(ulong *)rgcrCache + iFree * 4 + 2) = cr._2_2_;
      }
      return uVar1;
    }
    if (((byte *)rghbrCacheUse)[i] == 0) {
      iFree = i;
    }
    else if (((int)((ulong *)rgcrCache)[i] == (int)cr) &&
            (*(int *)((int)(ulong *)rgcrCache + i * 4 + 2) == cr._2_2_)) {
      ((byte *)rghbrCacheUse)[i] = ((byte *)rghbrCacheUse)[i] + 1;
      return ((ushort *)rghbrCache)[i];
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FreeHbr
// Address: 1040:4532
// Segment: MEMORY_UTILGEN
// ======================================================================


void FreeHbr(HBRUSH hbr)

{
  short i;
  
  i = 0;
  do {
    if (chbrCache <= i) {
UTILGEN_DeleteBrush:
      DeleteObject(hbr);
      return;
    }
    if ((((byte *)rghbrCacheUse)[i] != 0) && (hbr == ((ushort *)rghbrCache)[i]))
    {
      ((byte *)rghbrCacheUse)[i] = ((byte *)rghbrCacheUse)[i] - 1;
      if (((byte *)rghbrCacheUse)[i] != 0) {
        return;
      }
      goto UTILGEN_DeleteBrush;
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FCompressUserString
// Address: 1040:45a0
// Segment: MEMORY_UTILGEN
// ======================================================================


short FCompressUserString(char *szIn,char *szOut,short *pcOut)

{
  bool bVar1;
  undefined2 unaff_SS;
  short cNyb;
  byte *pchOut;
  short iNyb;
  byte szWork [1024];
  short fHalf;
  
  fHalf = 0;
  pchOut = szWork;
  do {
    if (*szIn == '\0') {
      if (fHalf != 0) {
        *pchOut = *pchOut | 0xf;
        pchOut = pchOut + 1;
      }
      bVar1 = (int)pchOut - (int)szWork <= *pcOut;
      if (bVar1) {
        *pcOut = (int)pchOut - (int)szWork;
        __fmemcpy(szOut,(byte *)szWork,*pcOut);
      }
      return (uint)bVar1;
    }
    iNyb = NybbleFromCh(*szIn);
    if (iNyb < 0xb) {
      cNyb = 1;
    }
    else if ((iNyb & 0xfU) == 0xf) {
      cNyb = 3;
    }
    else {
      cNyb = 2;
    }
    while (cNyb != 0) {
      if (fHalf == 0) {
        *pchOut = (byte)((iNyb & 0xfU) << 4);
        fHalf = 1;
      }
      else {
        *pchOut = *pchOut | (byte)iNyb & 0xf;
        pchOut = pchOut + 1;
        fHalf = 0;
        if (0x3ff < (int)pchOut - (int)szWork) {
          return 0;
        }
      }
      iNyb = iNyb >> 4;
      cNyb = cNyb + -1;
    }
    szIn = (char *)CONCAT22(szIn._2_2_,(char *)szIn + 1);
  } while( true );
}



// ======================================================================
// Function: FDecompressUserString
// Address: 1040:46e8
// Segment: MEMORY_UTILGEN
// ======================================================================


short FDecompressUserString(char *szIn,short cIn,char *szOut,short *pcOut)

{
  short sVar1;
  char cVar2;
  uint uVar3;
  undefined2 unaff_SS;
  char *pchOut;
  short iNyb;
  char szWork [1024];
  short fHalf;
  
  fHalf = 0;
  pchOut = szWork;
  while (0 < cIn) {
    if (fHalf == 0) {
      iNyb = (int)*szIn >> 4 & 0xf;
    }
    else {
      iNyb = (int)*szIn & 0xf;
      cIn = cIn + -1;
      szIn = (char *)CONCAT22(szIn._2_2_,(char *)szIn + 1);
      if ((iNyb == 0xf) && (cIn == 0)) break;
    }
    sVar1 = iNyb;
    fHalf = (short)(fHalf == 0);
    if (10 < (uint)iNyb) {
      if (fHalf == 0) {
        uVar3 = (int)*szIn & 0xf0;
      }
      else {
        uVar3 = ((int)*szIn & 0xfU) << 4;
        cIn = cIn + -1;
        szIn = (char *)CONCAT22(szIn._2_2_,(char *)szIn + 1);
      }
      iNyb = iNyb | uVar3;
      fHalf = (short)(fHalf == 0);
      if (sVar1 == 0xf) {
        if (fHalf == 0) {
          uVar3 = ((int)*szIn & 0xf0U) << 4;
        }
        else {
          uVar3 = ((int)*szIn & 0xfU) << 8;
          cIn = cIn + -1;
          szIn = (char *)CONCAT22(szIn._2_2_,(char *)szIn + 1);
        }
        iNyb = iNyb | uVar3;
        fHalf = (short)(fHalf == 0);
      }
    }
    cVar2 = ChFromNybble(iNyb);
    *pchOut = cVar2;
    pchOut = pchOut + 1;
    if (*pcOut < (int)pchOut - (int)szWork) {
      return 0;
    }
  }
  *pchOut = '\0';
  __fstrcpy(szOut,(char *)szWork);
  return 1;
}



// ======================================================================
// Function: NybbleFromCh
// Address: 1040:4880
// Segment: MEMORY_UTILGEN
// ======================================================================


short NybbleFromCh(byte ch)

{
  char *pcVar1;
  uint uVar2;
  
  if ((ch < 0x61) || (0x7a < ch)) {
    if (ch == 0x20) {
      uVar2 = 0;
    }
    else if ((ch < 0x41) || (0x50 < ch)) {
      if ((ch < 0x51) || (0x5a < ch)) {
        if ((ch < 0x30) || (0x35 < ch)) {
          if ((ch < 0x36) || (0x39 < ch)) {
            pcVar1 = _strchr((char *)rgchcomp,(uint)ch);
            if (pcVar1 == (char *)0x0) {
              uVar2 = (uint)ch << 4 | 0xf;
            }
            else {
              uVar2 = (int)(pcVar1 + -0x13fc) * 0x10 | 0xe;
            }
          }
          else {
            uVar2 = (ch - 0x36) * 0x10 | 0xd;
          }
        }
        else {
          uVar2 = (ch - 0x26) * 0x10 | 0xc;
        }
      }
      else {
        uVar2 = (ch - 0x51) * 0x10 | 0xc;
      }
    }
    else {
      uVar2 = (ch - 0x41) * 0x10 | 0xb;
    }
  }
  else {
    uVar2 = ((short *)rgcompstrlower)[ch - 0x61];
  }
  return uVar2;
}



// ======================================================================
// Function: ChFromNybble
// Address: 1040:49ea
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

char ChFromNybble(short nyb)

{
  char cVar1;
  int iVar2;
  short iVal;
  short iPage;
  
  if (nyb < 0xb) {
    cVar1 = *(char *)(_rgchcompstrlower + nyb);
  }
  else if ((nyb & 0xfU) == 0xf) {
    cVar1 = (char)(nyb >> 4);
  }
  else {
    iVar2 = ((nyb & 0xfU) - 0xb) * 0x10 + (nyb >> 4);
    if (iVar2 < 0x1a) {
      cVar1 = (char)iVar2 + 'A';
    }
    else if (iVar2 < 0x24) {
      cVar1 = (char)iVar2 + '\x16';
    }
    else if (iVar2 < 0x34) {
      cVar1 = *(char *)(_rgchcompstrlower + iVar2 + -0x19);
    }
    else {
      cVar1 = *(char *)((int)(short *)(rgcompstrlower + 0xf) + iVar2);
    }
  }
  return cVar1;
}



// ======================================================================
// Function: DibNumColors
// Address: 1040:4a9a
// Segment: MEMORY_UTILGEN
// ======================================================================


ushort DibNumColors(void *pv)

{
  void *pvVar1;
  ushort uVar2;
  BITMAPINFOHEADER *lpbi;
  BITMAPCOREHEADER *lpbc;
  short bits;
  
  pvVar1 = (void *)pv;
  if ((*(int *)pv == 0xc) && (*(int *)((int)pvVar1 + 2) == 0)) {
    bits = *(short *)((int)pvVar1 + 10);
  }
  else {
    if ((*(int *)((int)pvVar1 + 0x20) != 0) || (*(int *)((int)pvVar1 + 0x22) != 0)) {
      return *(ushort *)((int)pvVar1 + 0x20);
    }
    bits = *(short *)((int)pvVar1 + 0xe);
  }
  if (bits == 1) {
    uVar2 = 2;
  }
  else if (bits == 4) {
    uVar2 = 0x10;
  }
  else if (bits == 8) {
    uVar2 = 0x100;
  }
  else {
    uVar2 = 0;
  }
  return uVar2;
}



// ======================================================================
// Function: HpalFromDib
// Address: 1040:4b50
// Segment: MEMORY_UTILGEN
// ======================================================================


ushort HpalFromDib(HGLOBAL hdib)

{
  undefined1 uVar1;
  ushort uVar2;
  undefined2 *puVar3;
  char *pv;
  byte bT;
  short i;
  short cColors;
  
  pv = LockResource(hdib);
  if (pv == (char *)0x0) {
    uVar2 = 0;
  }
  else {
    uVar2 = DibNumColors(pv);
    if ((int)uVar2 < 0x101) {
      puVar3 = (undefined2 *)LocalAlloc(0x40,uVar2 * 4 + 8);
      puVar3[1] = uVar2;
      *puVar3 = 0x300;
      __fmemcpy((undefined2 *)(puVar3 + 2),
                        (char *)CONCAT22((int)((ulong)pv >> 0x10),(char *)pv + 0x28),uVar2 << 2);
      for (i = 0; i < (int)uVar2; i = i + 1) {
        uVar1 = *(undefined1 *)(puVar3 + i * 2 + 2);
        *(undefined1 *)(puVar3 + i * 2 + 2) = *(undefined1 *)(puVar3 + i * 2 + 3);
        *(undefined1 *)(puVar3 + i * 2 + 3) = uVar1;
      }
      uVar2 = CreatePalette((undefined2 *)puVar3);
      LocalFree((HLOCAL)puVar3);
      GlobalUnlock(hdib);
    }
    else {
      GlobalUnlock(hdib);
      uVar2 = 0;
    }
  }
  return uVar2;
}



// ======================================================================
// Function: HpalBlackReserved
// Address: 1040:4c9c
// Segment: MEMORY_UTILGEN
// ======================================================================


ushort HpalBlackReserved(void)

{
  undefined2 *puVar1;
  HANDLE HVar2;
  short i;
  short cColors;
  
  puVar1 = (undefined2 *)LocalAlloc(0x40,0x408);
  puVar1[1] = 0x100;
  *puVar1 = 0x300;
  for (i = 0; i < 0x100; i = i + 1) {
    *(undefined1 *)(puVar1 + i * 2 + 3) = 0;
    *(undefined1 *)((int)puVar1 + i * 4 + 5) = 0;
    *(undefined1 *)(puVar1 + i * 2 + 2) = 0;
    *(undefined1 *)((int)puVar1 + i * 4 + 7) = 1;
  }
  HVar2 = CreatePalette((undefined2 *)puVar1);
  LocalFree((HLOCAL)puVar1);
  return HVar2;
}



// ======================================================================
// Function: PaletteSize
// Address: 1040:4d60
// Segment: MEMORY_UTILGEN
// ======================================================================


ushort PaletteSize(void *pv)

{
  ushort uVar1;
  BITMAPINFOHEADER *lpbi;
  ushort NumColors;
  
  uVar1 = DibNumColors(pv);
  if ((*(int *)pv == 0xc) && (*(int *)((int)(void *)pv + 2) == 0)) {
    uVar1 = uVar1 * 3;
  }
  else {
    uVar1 = uVar1 << 2;
  }
  return uVar1;
}



// ======================================================================
// Function: DibBlt
// Address: 1040:4db8
// Segment: MEMORY_UTILGEN
// ======================================================================


short DibBlt(HDC hdc,short x0,short y0,short dx,short dy,HGLOBAL hdib,short x1,short y1,
               short dxSrc,short dySrc,long rop)

{
  int iVar1;
  ushort uVar2;
  short sVar3;
  int iVar4;
  int *pv;
  BITMAPINFOHEADER *lpbi;
  
  if (hdib == 0) {
    sVar3 = PatBlt(hdc,x0,y0,dx,dy,rop);
  }
  else {
    pv = (int *)GlobalLock(hdib);
    iVar4 = (int)((ulong)pv >> 0x10);
    if (((int *)pv == (int *)0x0) && (iVar4 == 0)) {
      sVar3 = 0;
    }
    else {
      iVar1 = *pv;
      uVar2 = PaletteSize(pv);
      StretchDIBits(hdc,x0,y0,dx,dy,x1,y1,dxSrc,dySrc,
                    (void *)CONCAT22(iVar4,(void *)((int)(int *)pv + uVar2 + iVar1)),
                    (undefined1 *)pv,0,rop);
      GlobalUnlock(hdib);
      sVar3 = 1;
    }
  }
  return sVar3;
}



// ======================================================================
// Function: DibFromBitmap
// Address: 1040:4e90
// Segment: MEMORY_UTILGEN
// ======================================================================


ushort DibFromBitmap(HBITMAP hbm,ulong biStyle,ushort biBits,HGDIOBJ hpal)

{
  uint *puVar1;
  uint *puVar2;
  uint uVar3;
  ushort uVar4;
  HANDLE HVar5;
  HGLOBAL HVar6;
  ushort uVar7;
  short sVar8;
  int iVar9;
  uint *puVar10;
  uint *puVar11;
  ushort unaff_DI;
  uint *puVar12;
  undefined2 unaff_SS;
  uint *puVar13;
  ulong uVar14;
  undefined2 uVar15;
  UINT UVar16;
  undefined2 uVar17;
  UINT UVar18;
  HDC HVar19;
  BITMAPINFOHEADER *lpbi;
  HGLOBAL hdib;
  uint bi;
  int local_40;
  int local_3e;
  int local_3c;
  UINT local_3a;
  int local_38;
  undefined2 local_36;
  ushort local_34;
  ulong local_32;
  undefined4 local_2e;
  undefined2 local_2a;
  undefined2 local_28;
  undefined2 local_26;
  undefined2 local_24;
  undefined2 local_22;
  undefined2 local_20;
  undefined2 local_1e;
  undefined2 local_1c;
  undefined1 bm [2];
  int local_18;
  UINT local_16;
  byte local_12;
  byte local_11;
  undefined4 dwLen;
  ushort h;
  HDC hdc;
  
  if (hbm == 0) {
    uVar4 = 0;
  }
  else {
    if (hpal == 0) {
      hpal = GetStockObject(0xf);
    }
    GetObject(hbm,0xe,(undefined1 *)bm);
    if (biBits == 0) {
      biBits = (uint)local_12 * (uint)local_11;
    }
    bi = 0x28;
    local_40 = 0;
    local_3c = local_18 >> 0xf;
    local_3e = local_18;
    local_38 = (int)local_16 >> 0xf;
    local_3a = local_16;
    local_36 = 1;
    local_34 = biBits;
    local_2e._0_2_ = 0;
    local_2e._2_2_ = 0;
    local_2a = 0;
    local_28 = 0;
    local_26 = 0;
    local_24 = 0;
    local_22 = 0;
    local_20 = 0;
    local_1e = 0;
    local_1c = 0;
    local_32 = biStyle;
    uVar4 = PaletteSize((uint *)&bi);
    dwLen._0_2_ = uVar4 + bi;
    dwLen._2_2_ = local_40 + (uint)CARRY2(uVar4,bi);
    hdc = GetDC(0);
    HVar5 = SelectPalette(hdc,hpal,0);
    RealizePalette(hdc);
    HVar6 = GlobalAlloc(0x42,CONCAT22(dwLen._2_2_,(int)dwLen));
    if (HVar6 == 0) {
      SelectPalette(hdc,HVar5,0);
      ReleaseDC(0,hdc);
      uVar4 = 0;
    }
    else {
      puVar13 = (uint *)GlobalLock(HVar6);
      uVar15 = (undefined2)((ulong)puVar13 >> 0x10);
      puVar10 = (uint *)puVar13;
      puVar11 = &bi;
      puVar12 = puVar10;
      for (iVar9 = 0x14; iVar9 != 0; iVar9 = iVar9 + -1) {
        puVar2 = puVar12;
        puVar12 = puVar12 + 1;
        puVar1 = puVar11;
        puVar11 = puVar11 + 1;
        *puVar2 = *puVar1;
      }
      GetDIBits(hdc,hbm,0,local_3a,(void *)0x0,puVar13,0);
      puVar11 = &bi;
      for (iVar9 = 0x14; iVar9 != 0; iVar9 = iVar9 + -1) {
        puVar1 = puVar11;
        puVar11 = puVar11 + 1;
        puVar13 = puVar10;
        puVar10 = puVar10 + 1;
        *puVar1 = *puVar13;
      }
      GlobalUnlock(HVar6);
      if (((int)local_2e == 0) &&
         (local_2e = CONCAT22(local_2e._2_2_,(int)local_2e), local_2e._2_2_ == 0)) {
        iVar9 = (int)local_16 >> 0xf;
        uVar17 = 0;
        uVar15 = 0x20;
        uVar14 = __aFulmul((long)local_18,(ulong)biBits);
        __aFuldiv(uVar14 + 0x1f,CONCAT22(uVar17,uVar15));
        uVar14 = __aFlshl(CONCAT22(iVar9,local_16),unaff_DI);
        local_2e = __aFulmul(uVar14,CONCAT22(iVar9,local_16));
        if (biStyle != 0) {
          uVar17 = 0;
          uVar15 = 2;
          uVar14 = __aFulmul(local_2e,3);
          uVar14 = __aFuldiv(uVar14,CONCAT22(uVar17,uVar15));
          local_2e = uVar14;
        }
      }
      uVar4 = PaletteSize((uint *)&bi);
      dwLen = local_2e + CONCAT22(local_40 + (uint)CARRY2(uVar4,bi),uVar4 + bi);
      uVar4 = GlobalReAlloc(HVar6,dwLen,0);
      h = uVar4;
      if (uVar4 == 0) {
        GlobalFree(HVar6);
        SelectPalette(hdc,HVar5,0);
        ReleaseDC(0,hdc);
        uVar4 = 0;
      }
      else {
        puVar13 = (uint *)GlobalLock(uVar4);
        uVar15 = (undefined2)((ulong)puVar13 >> 0x10);
        puVar11 = (uint *)puVar13;
        UVar18 = 0;
        uVar3 = *puVar13;
        UVar16 = local_3a;
        HVar19 = hdc;
        uVar7 = PaletteSize(puVar13);
        sVar8 = GetDIBits(HVar19,hbm,UVar18,UVar16,
                          (void *)CONCAT22(uVar15,(void *)((int)puVar11 + uVar7 + uVar3)),puVar13,0)
        ;
        if (sVar8 == 0) {
          GlobalUnlock(uVar4);
          SelectPalette(hdc,HVar5,0);
          ReleaseDC(0,hdc);
          uVar4 = 0;
        }
        else {
          puVar10 = &bi;
          for (iVar9 = 0x14; iVar9 != 0; iVar9 = iVar9 + -1) {
            puVar1 = puVar10;
            puVar10 = puVar10 + 1;
            puVar13 = puVar11;
            puVar11 = puVar11 + 1;
            *puVar1 = *puVar13;
          }
          GlobalUnlock(uVar4);
          SelectPalette(hdc,HVar5,0);
          ReleaseDC(0,hdc);
        }
      }
    }
  }
  return uVar4;
}



// ======================================================================
// Function: HdibLoadBigResource
// Address: 1040:5220
// Segment: MEMORY_UTILGEN
// ======================================================================


ushort HdibLoadBigResource(short idb)

{
  HRSRC HVar1;
  HGLOBAL HVar2;
  short hFile;
  short sVar3;
  char *lpBuffer;
  DWORD dwSize;
  HGLOBAL hdib;
  short hfile;
  ushort hrsrc;
  
  HVar1 = FindResource(hInst,(LPCSTR)(ulong)(uint)idb,(LPCSTR)0x2);
  if ((HVar1 != 0) && (HVar2 = AllocResource(hInst,HVar1,0), HVar2 != 0)) {
    hFile = AccessResource(hInst,HVar1);
    if (hFile != -1) {
      lpBuffer = LockResource(HVar2);
      if (lpBuffer != (char *)0x0) {
        dwSize = SizeofResource(hInst,HVar1);
        sVar3 = ReadBigBlock(hFile,lpBuffer,dwSize);
        if (sVar3 != 0) {
          _lclose(hFile);
          return HVar2;
        }
      }
      _lclose(hFile);
    }
    FreeResource(HVar2);
  }
  return 0;
}



// ======================================================================
// Function: ReadBigBlock
// Address: 1040:5310
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1040532e) */

short ReadBigBlock(short hFile,char *lpBuffer,ulong dwSize)

{
  uint uVar1;
  ushort uVar2;
  char *lpInBuf;
  undefined2 local_8;
  short nBytes;
  
  while( true ) {
    local_8 = (undefined2)((ulong)lpBuffer >> 0x10);
    lpInBuf = (char *)lpBuffer;
    if (((uint)dwSize == 0) && (dwSize._2_2_ == 0)) {
      return 1;
    }
    if ((dwSize._2_2_ != 0) || (uVar1 = (uint)dwSize, 30000 < (uint)dwSize)) {
      uVar1 = 30000;
    }
    uVar2 = _lread(uVar1,lpBuffer,hFile);
    if (uVar2 != uVar1) break;
    dwSize = CONCAT22((dwSize._2_2_ - ((int)uVar1 >> 0xf)) - (uint)((uint)dwSize < uVar1),
                      (uint)dwSize - uVar1);
    lpBuffer = (char *)CONCAT22(local_8,lpInBuf + uVar1);
  }
  return 0;
}



// ======================================================================
// Function: FIntersectCircleLine
// Address: 1040:53b4
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10405762) */
/* WARNING: Removing unreachable block (ram,0x104057b5) */
/* WARNING: Removing unreachable block (ram,0x1040562c) */
/* WARNING: Removing unreachable block (ram,0x10405791) */
/* WARNING: Removing unreachable block (ram,0x10405733) */

short FIntersectCircleLine
          (POINT ptL1,POINT ptL2,POINT ptC,long r2,short dMax,short *pdStart,short *pdEnd)

{
  uint uVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  short sVar5;
  int iVar6;
  int iVar7;
  int iVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar9;
  ulong uVar10;
  ulong uVar11;
  long lVar12;
  long lVar13;
  long lVar14;
  long lVar15;
  int in_stack_0000ff9c;
  int in_stack_0000ff9e;
  short dOff;
  long dx2;
  long lT;
  long dy2;
  short dCtr;
  long dxdy;
  
  iVar2 = ptL2.x - ptL1.x;
  iVar6 = iVar2 >> 0xf;
  iVar3 = ptL2.y - ptL1.y;
  uVar9 = __aFulmul((long)iVar2,(long)iVar3);
  uVar10 = __aFulmul((long)iVar2,(long)iVar2);
  iVar8 = (int)(uVar10 >> 0x10);
  uVar11 = __aFulmul((long)iVar3,(long)iVar3);
  iVar7 = (int)(uVar11 >> 0x10);
  uVar1 = (uint)uVar11;
  dx2._0_2_ = (uint)uVar10;
  if ((((long)uVar9 < 0x80000) &&
      (((((int)(uVar9 >> 0x10) < 7 || ((uint)uVar9 < 0xa121)) && (iVar8 < 8)) &&
       ((iVar8 < 7 || ((uint)dx2 < 0xa121)))))) &&
     ((iVar7 < 7 || ((iVar7 < 8 && (uVar1 < 0xa121)))))) {
    iVar4 = (uint)dx2 + uVar1;
    iVar8 = iVar8 + iVar7 + (uint)CARRY2((uint)dx2,uVar1);
    uVar11 = __aFulmul(uVar11,(long)ptL1.x);
    uVar10 = __aFulmul(uVar10,(long)ptC.x);
    uVar9 = __aFulmul(uVar9,(long)(ptC.y - ptL1.y));
    lVar12 = __aFldiv(uVar9 + uVar10 + uVar11,CONCAT22(iVar8,iVar4));
  }
  else {
    in_stack_0000ff9c = (uint)dx2 + uVar1;
    in_stack_0000ff9e = iVar8 + iVar7 + (uint)CARRY2((uint)dx2,uVar1);
    lVar12 = __ftol((double)CONCAT26(in_stack_0000ff9e,
                                             CONCAT24(in_stack_0000ff9c,CONCAT22(unaff_SI,unaff_DI))
                                            ));
  }
  if (iVar2 == 0) {
    lVar13 = (long)ptL1.y;
  }
  else {
    uVar9 = __aFulmul(lVar12 - ptL1.x,(long)iVar3);
    lVar13 = __aFldiv(uVar9,CONCAT22(iVar6,iVar2));
    lVar13 = lVar13 + ptL1.y;
  }
  uVar9 = __aFulmul(lVar13 - ptC.y,lVar13 - ptC.y);
  uVar10 = __aFulmul(lVar12 - ptC.x,lVar12 - ptC.x);
  lVar15 = uVar10 + uVar9;
  if (lVar15 < r2) {
    uVar9 = __aFulmul(lVar13 - ptL1.y,lVar13 - ptL1.y);
    uVar10 = __aFulmul(lVar12 - ptL1.x,lVar12 - ptL1.x);
    _sqrt(SUB84((double)(long)(uVar10 + uVar9),0),
                  (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)(long)(uVar10 + 
                                                  uVar9) >> 0x20))));
    lVar14 = __ftol((double)CONCAT26(in_stack_0000ff9e,
                                             CONCAT24(in_stack_0000ff9c,CONCAT22(unaff_SI,unaff_DI))
                                            ));
    dCtr = (short)lVar14;
    lT = r2 - lVar15;
    if (((int)((ulong)(r2 - lVar15) >> 0x10) < 1) && ((r2 - lVar15 < 0 || ((int)r2 == (int)lVar15)))
       ) {
      sVar5 = 0;
    }
    else {
      _sqrt(SUB84((double)lT,0),
                    (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)lT >> 0x20))))
      ;
      lVar15 = __ftol((double)CONCAT26(in_stack_0000ff9e,
                                               CONCAT24(in_stack_0000ff9c,
                                                        CONCAT22(unaff_SI,unaff_DI))));
      iVar2 = (int)lVar15;
      if (ptL1.x < ptL2.x) {
        if (lVar12 < ptL1.x) {
          dCtr = -dCtr;
        }
      }
      else if (ptL2.x < ptL1.x) {
        if (ptL1.x < lVar12) {
          dCtr = -dCtr;
        }
      }
      else if (ptL1.y < ptL2.y) {
        if (lVar13 < ptL1.y) {
          dCtr = -dCtr;
        }
      }
      else if (ptL1.y < lVar13) {
        dCtr = -dCtr;
      }
      if ((uint)(dCtr - iVar2) < 0x8000) {
        iVar3 = dCtr - iVar2;
      }
      else {
        iVar3 = 0;
      }
      *pdStart = iVar3;
      iVar3 = dMax;
      if (dCtr + iVar2 <= dMax) {
        iVar3 = dCtr + iVar2;
      }
      *pdEnd = iVar3;
      if ((*pdEnd < 1) || (dMax <= *pdStart)) {
        sVar5 = 0;
      }
      else {
        sVar5 = 1;
      }
    }
  }
  else {
    sVar5 = 0;
  }
  return sVar5;
}



// ======================================================================
// Function: IntToRoman
// Address: 1040:5830
// Segment: MEMORY_UTILGEN
// ======================================================================


void IntToRoman(short i,char *pszOut)

{
  char *pcVar1;
  
  if (i < 1) {
    *pszOut = '\0';
  }
  else {
    for (; 9 < i; i = i + -10) {
      *pszOut = 'X';
      pszOut = pszOut + 1;
    }
    if (i == 9) {
      pcVar1 = pszOut + 1;
      *pszOut = 'I';
      pszOut = pszOut + 2;
      *pcVar1 = 'X';
    }
    else {
      if (3 < i) {
        if (i == 4) {
          *pszOut = 'I';
          pszOut = pszOut + 1;
        }
        *pszOut = 'V';
        i = i + -5;
        pszOut = pszOut + 1;
      }
      while (0 < i) {
        *pszOut = 'I';
        i = i + -1;
        pszOut = pszOut + 1;
      }
    }
    *pszOut = '\0';
  }
  return;
}



// ======================================================================
// Function: FCheckPassword
// Address: 1040:58d8
// Segment: MEMORY_UTILGEN
// ======================================================================


short FCheckPassword(void)

{
  char *pcVar1;
  short sVar2;
  long lVar3;
  FARPROC pvVar4;
  short fRet;
  
  if (((((int)lSaltCur == 0) && (lSaltCur._2_2_ == 0)) ||
      (((int)lSaltLast == (int)lSaltCur &&
       (lSaltLast._2_2_ == lSaltCur._2_2_)))) || (fAi != 0)) {
    sVar2 = 1;
  }
  else if ((vszDefPass[0] == '\0') ||
          (lVar3 = LSaltFromSz((char *)vszDefPass),
          lVar3 != CONCAT22(lSaltCur._2_2_,(int)lSaltCur))) {
    if (((uint)ini.wFlags >> 0xe & 1) == 0) {
      pvVar4 = MakeProcInstance(PasswordDlg,hInst);
      pcVar1 = (char *)hwndTitle;
      if (hwndTitle == 0) {
        pcVar1 = (char *)hwndFrame;
      }
      sVar2 = DialogBox(0,(LPCSTR)CONCAT22(0x8c,pcVar1),(HWND)((ulong)pvVar4 >> 0x10),(void *)pvVar4
                       );
      FreeProcInstance(pvVar4);
    }
    else {
      sVar2 = 0;
    }
  }
  else {
    sVar2 = 1;
  }
  return sVar2;
}



// ======================================================================
// Function: LSaltFromSz
// Address: 1040:59ce
// Segment: MEMORY_UTILGEN
// ======================================================================


long LSaltFromSz(char *psz)

{
  char *pcVar1;
  ulong uVar2;
  
  uVar2 = 0;
  pcVar1 = psz;
  if (*psz == '\0') {
    uVar2 = 0;
  }
  else {
    while (psz = pcVar1, *psz != '\0') {
      uVar2 = uVar2 + (long)(int)*psz;
      pcVar1 = psz + 1;
      if (*pcVar1 != '\0') {
        uVar2 = __aFulmul(uVar2,(long)(int)*pcVar1);
        pcVar1 = psz + 2;
      }
    }
    if (uVar2 == 0) {
      uVar2 = 1;
    }
  }
  return uVar2;
}



// ======================================================================
// Function: PasswordDlg
// Address: 1040:5a72
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short PasswordDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  HWND HVar1;
  char *pcVar2;
  undefined *ctick;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar3;
  long lVar4;
  short mbType;
  ushort in_stack_0000ffb4;
  RECT rc;
  char szPass [62];
  
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(RECT *)&rc);
    FillRect(wParam,(RECT *)&rc,hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    uVar3 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffb4);
    if ((int)uVar3 == 6) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return hbrButtonFace;
    }
  }
  else {
    if (message == WM_INITDIALOG) {
      SendDlgItemMessage(hwnd,0x10c,0x415,0xf,0);
      HVar1 = GetDlgItem(hwnd,0x7e2);
      pcVar2 = PszGetCompressedString(idsEnterPassword);
      SetWindowText(HVar1,(LPCSTR)pcVar2);
      return 1;
    }
    if (message == WM_COMMAND) {
      if ((wParam == 1) || (wParam == 2)) {
        if (wParam == 1) {
          GetDlgItemText(hwnd,0x10c,(LPSTR)szPass,0x3c);
          lVar4 = LSaltFromSz(szPass);
          if (lVar4 != CONCAT22(lSaltCur._2_2_,(undefined2)lSaltCur)) {
            vcPasswordFailures = vcPasswordFailures + 1;
            if (vcPasswordFailures < 10) {
              ctick = (undefined *)0x3e8;
            }
            else if (vcPasswordFailures < 100) {
              ctick = (undefined *)&DAT_1120_1388;
            }
            else {
              ctick = (undefined *)0x2710;
            }
            Delay((short)ctick);
            mbType = 0x10;
            pcVar2 = PszFormatIds(idsPasswordHaveEnteredIncorrectPleaseTry,(short *)0x0);
            AlertSz(pcVar2,mbType);
            HVar1 = GetDlgItem(hwnd,0x10c);
            SetFocus(HVar1);
            SendDlgItemMessage(hwnd,0x10c,0x401,0,-0x10000);
            return 0;
          }
          if (((uint)gd._4_2_ >> 9 & 1) == 0) {
            lSaltLast._0_2_ = (undefined2)lSaltCur;
            lSaltLast._2_2_ = lSaltCur._2_2_;
            _strcpy((char *)szPassLast,szPass);
          }
        }
        EndDialog(hwnd,(uint)(wParam == 1));
        return 1;
      }
      if (wParam == 0x76) {
        WinHelp(hwnd,(LPCSTR)_szHelpFile,1,0x441);
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: NewPasswordDlg
// Address: 1040:5cba
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short NewPasswordDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  HWND HVar1;
  char *pcVar2;
  undefined2 uVar3;
  undefined2 uVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar5;
  long lVar6;
  short sVar7;
  ushort in_stack_0000ffd8;
  RECT rc;
  char szPass [22];
  
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(RECT *)&rc);
    FillRect(wParam,(RECT *)&rc,hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    uVar5 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffd8);
    if ((int)uVar5 == 6) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return hbrButtonFace;
    }
  }
  else {
    if (message == WM_INITDIALOG) {
      SendDlgItemMessage(hwnd,0x10c,0x415,0x10,0);
      SendDlgItemMessage(hwnd,0x10d,0x415,0x10,0);
      if (idPlayer == -1) {
        HVar1 = GetDlgItem(hwnd,0x7e2);
        pcVar2 = PszGetCompressedString(idsNotePasswordEffectiveImmediately);
        SetWindowText(HVar1,(LPCSTR)pcVar2);
        pcVar2 = PszGetCompressedString(idsChangeHostPassword);
        SetWindowText(hwnd,(LPCSTR)pcVar2);
      }
      else {
        HVar1 = GetDlgItem(hwnd,0x7e2);
        pcVar2 = PszGetCompressedString(idsNoteNewPasswordWillTakeEffectUntil);
        SetWindowText(HVar1,(LPCSTR)pcVar2);
      }
      return 1;
    }
    if (message == WM_COMMAND) {
      if ((wParam == 1) || (wParam == 2)) {
        uVar3 = (undefined2)lSaltLast;
        uVar4 = lSaltLast._2_2_;
        if (wParam == 1) {
          HVar1 = GetDlgItem(hwnd,0x10c);
          GetWindowText(HVar1,(LPSTR)szPass,0x12);
          lVar6 = LSaltFromSz(szPass);
          uVar4 = (undefined2)((ulong)lVar6 >> 0x10);
          uVar3 = (undefined2)lVar6;
          HVar1 = GetDlgItem(hwnd,0x10d);
          GetWindowText(HVar1,(LPSTR)szPass,0x12);
          lVar6 = LSaltFromSz(szPass);
          if (lVar6 != CONCAT22(uVar4,uVar3)) {
            sVar7 = 0x10;
            pcVar2 = PszFormatIds(idsPasswordsTypedTwoFieldsSamePleaseReenter,(short *)0x0);
            AlertSz(pcVar2,sVar7);
            HVar1 = GetDlgItem(hwnd,0x10c);
            SetFocus(HVar1);
            SendDlgItemMessage(hwnd,0x10c,0x401,0,-0x10000);
            return 0;
          }
          if (idPlayer == -1) {
            lSaltCur._0_2_ = uVar3;
            lSaltCur._2_2_ = uVar4;
            sVar7 = FWriteDataFile((char *)szBase,-1,0);
            if (sVar7 == 0) {
              sVar7 = 0x10;
              pcVar2 = PszFormatIds(idsUnableCreateHostFile,(short *)0x0);
              AlertSz(pcVar2,sVar7);
              lSaltCur._0_2_ = (undefined2)lSaltLast;
              lSaltCur._2_2_ = lSaltLast._2_2_;
              uVar3 = (undefined2)lSaltLast;
              uVar4 = lSaltLast._2_2_;
            }
          }
          else {
            WriteMemRt(0x24,4,&stack0xffd8);
            uVar3 = (undefined2)lSaltLast;
            uVar4 = lSaltLast._2_2_;
          }
        }
        lSaltLast._2_2_ = uVar4;
        lSaltLast._0_2_ = uVar3;
        EndDialog(hwnd,(uint)(wParam == 1));
        return 1;
      }
      if (wParam == 0x76) {
        WinHelp(hwnd,(LPCSTR)_szHelpFile,1,0x43c);
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: GetDiskSerialNumber
// Address: 1040:5fc0
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x104062b2) */
/* WARNING: Removing unreachable block (ram,0x1040631f) */

ulong GetDiskSerialNumber(void)

{
  int iVar1;
  UINT UVar2;
  ushort uVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar4;
  ulong uVar5;
  long lVar6;
  uint in_stack_0000ffa6;
  uint df [2];
  uint local_52;
  uint local_50;
  undefined4 l;
  ushort uDate;
  byte uDefault;
  short iWork;
  short i;
  find_t fi [22];
  uint local_2c;
  uint local_2a;
  char local_24 [14];
  char fn [14];
  short drive;
  short j;
  
  lVar6 = CONCAT22(unaff_SI,unaff_DI);
  iWork = 0;
  _memset((undefined *)&vrgbEnvCur,0,0xb);
  CchGetString(idsC,fn);
  for (i = 0; uVar5 = CONCAT22(l._2_2_,(ushort)l), i < 2; i = i + 1) {
    drive = i + 2;
    fn[0] = (char)drive + 'A';
    l._0_2_ = 0;
    l._2_2_ = 0;
    uDate = 0;
    UVar2 = GetDriveType(i + 2);
    if ((UVar2 == 3) && (uVar3 = __dos_findfirst(fn,8,fi), uVar3 == 0)) {
      for (j = 0; (j < 8 && (local_24[j] != '\0')); j = j + 1) {
        if (i == 0) {
          in_stack_0000ffa6 = (int)local_24[j] & 0xf;
          lVar4 = __aFlshl(lVar6,in_stack_0000ffa6);
          l._2_2_ = (undefined2)((ulong)lVar4 >> 0x10);
          l._0_2_ = (uint)lVar4 | in_stack_0000ffa6;
        }
        else {
          in_stack_0000ffa6 = (int)local_24[j] & 7;
          lVar4 = __aFlshl(lVar6,in_stack_0000ffa6);
          l._2_2_ = (undefined2)((ulong)lVar4 >> 0x10);
          l._0_2_ = (uint)lVar4 | in_stack_0000ffa6;
        }
      }
      if (i == 0) {
        uDate = local_2a << 0xc | (local_2a >> 5 & 7) << 9 | (local_2c & 0xf) << 5 |
                (local_2c >> 5 & 0xf) << 1 | local_2c >> 0xb & 1;
      }
      else {
        uDate = (local_2a & 3) << 6 | (local_2c & 7) << 3 | local_2c >> 5 & 7;
      }
    }
    else {
      uDate = 0xc57a;
      l._0_2_ = 0xdca5;
      l._2_2_ = 0x59a6;
    }
    ((undefined *)&vrgbEnvCur)[iWork] = (char)(ushort)l;
    iWork = iWork + 1;
    lVar4 = __aFlshr(lVar6,in_stack_0000ffa6);
    ((undefined *)&vrgbEnvCur)[iWork] = (char)lVar4;
    iWork = iWork + 1;
    lVar4 = __aFlshr(lVar6,in_stack_0000ffa6);
    iVar1 = iWork + 1;
    ((undefined *)&vrgbEnvCur)[iWork] = (char)lVar4;
    iWork = iVar1;
    if (i == 0) {
      lVar4 = __aFlshr(lVar6,in_stack_0000ffa6);
      ((undefined *)&vrgbEnvCur)[iWork] = (char)lVar4;
      iWork = iWork + 1;
    }
    ((undefined *)&vrgbEnvCur)[iWork] = (char)uDate;
    iVar1 = iWork + 1;
    if (i == 0) {
      *(undefined1 *)(iWork + 0x5469) = (char)(uDate >> 8);
      iVar1 = iWork + 2;
    }
    iWork = iVar1;
  }
  uDefault = 0;
  for (i = 0; i < 2; i = i + 1) {
    uDefault = uDefault << 4;
    l = uVar5;
    UVar2 = GetDriveType(i + 2);
    if (UVar2 == 3) {
      uVar3 = __dos_getdiskfree(i + 3,(diskfree_t *)df);
      l._0_2_ = uVar3;
    }
    else {
      l._0_2_ = 1;
    }
    l._2_2_ = 0;
    uVar5 = (ulong)(ushort)l;
    if ((ushort)l == 0) {
      lVar6 = 0x200;
      uVar5 = __aFulmul((ulong)df[0],(ulong)local_50);
      l = __aFldiv(uVar5,lVar6);
      uVar5 = __aFulmul(l,(ulong)local_52);
      l = uVar5;
      uVar5 = __aFldiv(uVar5,0x2faf0);
      if (0xf < (long)uVar5) {
        uVar5 = 0xf;
      }
      uDefault = uDefault + ((byte)uVar5 & 0xf);
    }
  }
  ((undefined *)&vrgbEnvCur)[iWork] = uDefault;
  return (ulong)(iWork + 1);
}



// ======================================================================
// Function: ShowProgressGauge
// Address: 1040:636c
// Segment: MEMORY_UTILGEN
// ======================================================================


void ShowProgressGauge(void)

{
  if (hwndProgressGauge == 0) {
    CreateDialog(0,(LPCSTR)CONCAT22(0x189,hwndFrame),lpfnGaugeDlgProc._2_2_,
                 (fn_lpfnGaugeDlgProc *)lpfnGaugeDlgProc);
  }
  else {
    UpdateProgressGauge(0);
  }
  return;
}



// ======================================================================
// Function: HideProgressGauge
// Address: 1040:63b2
// Segment: MEMORY_UTILGEN
// ======================================================================


void HideProgressGauge(void)

{
  if (hwndProgressGauge != 0) {
    DestroyWindow(hwndProgressGauge);
    hwndProgressGauge = 0;
  }
  return;
}



// ======================================================================
// Function: UpdateProgressGauge
// Address: 1040:63da
// Segment: MEMORY_UTILGEN
// ======================================================================


void UpdateProgressGauge(short pctX10)

{
  short iNum;
  
  if (hwndProgressGauge != 0) {
    iNum = 0;
    if (pctX10 == -0x39e) {
      pctX10 = vpctProgressGauge + 4;
    }
    else if (pctX10 == -0x39f) {
      pctX10 = vpctProgressGauge + 1;
    }
    else if (pctX10 < 0) {
      pctX10 = 0;
    }
    else if (1000 < pctX10) {
      if (((uint)gd.wFlags >> 10 & 1) == 0) {
        return;
      }
      iNum = pctX10;
      pctX10 = vpctProgressGauge;
    }
    vpctProgressGauge = pctX10;
    DrawProgressGauge(0,0,iNum);
  }
  return;
}



// ======================================================================
// Function: ProgressGaugeDlg
// Address: 1040:647e
// Segment: MEMORY_UTILGEN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: dx */

short ProgressGaugeDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  short sVar1;
  char *pcVar2;
  HWND HVar3;
  HBRUSH HVar4;
  undefined2 unaff_SS;
  short dx;
  short dy;
  RECT rc;
  PAINTSTRUCT ps;
  HDC hdc;
  
  if (message == WM_PAINT) {
    hdc = BeginPaint(hwnd,(PAINTSTRUCT *)&ps);
    DrawProgressGauge(hdc,1,0);
    EndPaint(hwnd,(PAINTSTRUCT *)&ps);
    HVar4 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(RECT *)&rc);
    FillRect(wParam,(RECT *)&rc,hbrButtonFace);
    HVar4 = 1;
  }
  else if (message == WM_CTLCOLOR) {
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    HVar4 = hbrButtonFace;
  }
  else if (message == WM_INITDIALOG) {
    vpctProgressGauge = 0;
    hwndProgressGauge = hwnd;
    GetSystemMetrics(0);
    sVar1 = GetSystemMetrics(1);
    pcVar2 = PszGetCompressedString(idsGeneratingDataYearD);
    wsprintf(szWork,(char *)pcVar2,game.turn + 0x961);
    HVar3 = GetDlgItem(hwnd,0x42f);
    SetWindowText(HVar3,szWork);
    GetWindowRect(hwnd,(RECT *)&rc);
    rc.left = 0x1120 - (rc.right - rc.left) >> 1;
    rc.top = sVar1 - (rc.bottom - rc.top) >> 1;
    SetWindowPos(hwnd,0,rc.left,rc.top,0,0,5);
    HVar4 = 1;
  }
  else {
    HVar4 = 0;
  }
  return HVar4;
}



// ======================================================================
// Function: DrawProgressGauge
// Address: 1040:65f6
// Segment: MEMORY_UTILGEN
// ======================================================================


void DrawProgressGauge(HDC hdcOrig,short fFull,short iNumOnly)

{
  short cLen;
  undefined2 unaff_SS;
  short c;
  RECT rc;
  short dx;
  short dx2;
  short fNumOnly;
  short dy;
  HDC hdc;
  
  fNumOnly = (short)(0 < iNumOnly);
  if (hwndProgressGauge != 0) {
    if (hdcOrig == 0) {
      hdc = GetDC(hwndProgressGauge);
    }
    else {
      hdc = hdcOrig;
    }
    GetClientRect(hwndProgressGauge,(RECT *)&rc);
    rc.top = rc.bottom >> 1;
    InflateRect((RECT *)&rc,-8,-8);
    dx = rc.right - rc.left;
    dy = rc.bottom - rc.top;
    if (fFull != 0) {
      SelectObject(hdc,hbrButtonShadow);
      PatBlt(hdc,rc.left + -1,rc.top + -1,dx + 2,1,0xf00021);
      PatBlt(hdc,rc.left + -1,rc.top + -1,1,dy + 2,0xf00021);
      SelectObject(hdc,hbrButtonHilite);
      PatBlt(hdc,rc.left,rc.bottom,dx + 1,1,0xf00021);
      PatBlt(hdc,rc.right,rc.top,1,dy,0xf00021);
    }
    InflateRect((RECT *)&rc,-2,-2);
    dx = dx + -4;
    dy = dy + -4;
    if (((uint)gd.wFlags >> 10 & 1) != 0) {
      SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SelectObject(hdc,rghfontArial7[0]);
      if (iNumOnly < 1) {
        iNumOnly = vpctProgressGauge;
      }
      cLen = wsprintf((char *)&stack0xffe0,(char *)PCTD,iNumOnly);
      RightTextOut(hdc,rc.right + -2,1,&stack0xffe0,cLen,0x50);
    }
    if (fNumOnly == 0) {
      SelectObject(hdc,hbrBlue);
      for (dx = MulDiv(dx,vpctProgressGauge,1000); 0 < dx; dx = dx - dy) {
        if (dx < dy) {
          dx2 = dx;
        }
        else {
          dx2 = dy + -1;
        }
        PatBlt(hdc,rc.left,rc.top,dx2,dy,0xf00021);
        rc.left = rc.left + dy;
      }
    }
    if (hdcOrig == 0) {
      ReleaseDC(hwndProgressGauge,hdc);
    }
  }
  return;
}



// ======================================================================
// Function: LDistance2
// Address: 1040:685c
// Segment: MEMORY_UTILGEN
// ======================================================================


long LDistance2(POINT pt1,POINT pt2)

{
  ulong uVar1;
  ulong uVar2;
  
  uVar1 = __aFulmul((long)(pt1.y - pt2.y),(long)(pt1.y - pt2.y));
  uVar2 = __aFulmul((long)(pt1.x - pt2.x),(long)(pt1.x - pt2.x));
  return uVar2 + uVar1;
}



// ======================================================================
// Function: PszGetLine
// Address: 1040:68ba
// Segment: MEMORY_UTILGEN
// ======================================================================


char * PszGetLine(char **ppszBeg)

{
  char *pcVar1;
  char *psz;
  
                    /* WARNING: Load size is inaccurate */
  psz = (char *)CONCAT22(*(undefined2 *)((int)ppszBeg + 2),*ppszBeg);
  while( true ) {
    pcVar1 = psz;
    if (*psz != ' ') break;
    psz = (char *)CONCAT22(psz._2_2_,(char *)psz + 1);
  }
  while( true ) {
    if (((*psz == '\0') || (*psz == '\n')) || (*psz == '\r')) break;
    psz = (char *)CONCAT22(psz._2_2_,(char *)psz + 1);
  }
  if ((*psz == '\r') && (((char *)psz)[1] == '\n')) {
    *(char **)ppszBeg = (char *)psz + 2;
    *(undefined2 *)((int)ppszBeg + 2) = psz._2_2_;
  }
  else {
    *(char **)ppszBeg = (char *)psz + 1;
    *(undefined2 *)((int)ppszBeg + 2) = psz._2_2_;
  }
  *psz = '\0';
  return pcVar1;
}



// ======================================================================
// Function: CParseNumbers
// Address: 1040:6986
// Segment: MEMORY_UTILGEN
// ======================================================================


short CParseNumbers(char *psz,long *pl,short cMax)

{
  char cVar1;
  bool bVar2;
  ulong uVar3;
  undefined2 lNum;
  undefined2 local_a;
  short fValid;
  short iRead;
  
  iRead = 0;
  uVar3 = 0;
  bVar2 = false;
  while( true ) {
    local_a = (undefined2)(uVar3 >> 0x10);
    lNum = (undefined2)uVar3;
    if ((cMax <= iRead) || (*psz == '\0')) {
      if (bVar2) {
        *(undefined2 *)(pl + iRead) = lNum;
        *(undefined2 *)((int)(pl + iRead) + 2) = local_a;
        iRead = iRead + 1;
      }
      return iRead;
    }
    if ((*psz != ' ') && ((*psz < '0' || ('9' < *psz)))) break;
    if (*psz == ' ') {
      if (bVar2) {
        *(undefined2 *)(pl + iRead) = lNum;
        *(undefined2 *)((int)(pl + iRead) + 2) = local_a;
        uVar3 = 0;
        bVar2 = false;
        iRead = iRead + 1;
      }
    }
    else {
      bVar2 = true;
      cVar1 = *psz;
      uVar3 = __aFulmul(uVar3,10);
      uVar3 = uVar3 + (long)(cVar1 + -0x30);
    }
    psz = (char *)CONCAT22(psz._2_2_,(char *)psz + 1);
  }
  return -1;
}



// ======================================================================
// Function: HfontPrinterCreate
// Address: 1040:6aa6
// Segment: MEMORY_UTILGEN
// ======================================================================


ushort HfontPrinterCreate(HDC hdc,short iSize,short *pdyFont)

{
  short sVar1;
  HGDIOBJ HVar2;
  undefined2 unaff_SS;
  HFONT hfontSav;
  int tm [4];
  int local_20;
  int *plf;
  HFONT hfontNew;
  
  plf = (int *)LocalAlloc(0x40,0x32);
  _memset(plf,0,0x32);
  sVar1 = GetDeviceCaps(hdc,0x5a);
  sVar1 = MulDiv(iSize,sVar1,0x48);
  *plf = -sVar1;
  _strcpy((char *)(plf + 9),*(char (*) [32])(rgszArial + 1));
  hfontNew = CreateFontIndirect((int *)plf);
  if ((pdyFont != (short *)0x0) && (hfontNew != 0)) {
    HVar2 = SelectObject(hdc,hfontNew);
    GetTextMetrics(hdc,(int *)tm);
    *pdyFont = tm[0] + local_20;
    SelectObject(hdc,HVar2);
  }
  LocalFree((HLOCAL)plf);
  return hfontNew;
}



