// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: FLookupSelPlanet
// Address: 1038:0000
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupSelPlanet(PLANET *ppl)

{
  short sVar1;
  
                    /* Segment:    8
                       Offset:     0002d9c0
                       Length:     8126
                       Min Alloc:  8126
                       Flags:      1d50
                           Code
                           Discardable
                           Moveable
                           Preload
                           Impure (Non-shareable)
                        */
  if (sel.scan.grobj == grobjPlanet) {
    sVar1 = FLookupPlanet(sel.scan.idpl,ppl);
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: FDupPlanet
// Address: 1038:0032
// Segment: MEMORY_UTIL
// ======================================================================


short FDupPlanet(PLANET *lppl,PLANET *ppl)

{
  PLANET *pPVar1;
  PLANET *pPVar2;
  undefined2 uVar3;
  undefined2 uVar4;
  int iVar5;
  PLANET *pPVar6;
  PLANET *pPVar7;
  PL *pPVar8;
  
  uVar3 = *(undefined2 *)&ppl->lpplprod;
  uVar4 = *(undefined2 *)((int)&ppl->lpplprod + 2);
  pPVar6 = (PLANET *)lppl;
  pPVar7 = ppl;
  for (iVar5 = 0x1c; iVar5 != 0; iVar5 = iVar5 + -1) {
    pPVar2 = pPVar7;
    pPVar7 = (PLANET *)&pPVar7->iPlayer;
    pPVar1 = pPVar6;
    pPVar6 = (PLANET *)&pPVar6->iPlayer;
    pPVar2->id = pPVar1->id;
  }
  *(undefined2 *)&ppl->lpplprod = uVar3;
  *(undefined2 *)((int)&ppl->lpplprod + 2) = uVar4;
  if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) &&
     (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
    if ((*(int *)&ppl->lpplprod != 0) || (*(int *)((int)&ppl->lpplprod + 2) != 0)) {
      FreePl((PL *)CONCAT22(*(undefined2 *)((int)&ppl->lpplprod + 2),*(PL **)&ppl->lpplprod)
                    );
      *(undefined2 *)&ppl->lpplprod = 0;
      *(undefined2 *)((int)&ppl->lpplprod + 2) = 0;
    }
  }
  else {
    if ((*(int *)&ppl->lpplprod == 0) && (*(int *)((int)&ppl->lpplprod + 2) == 0)) {
      pPVar8 = LpplAlloc(4,(uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMax,htOrd);
      *(PL **)&ppl->lpplprod = (PL *)pPVar8;
      *(undefined2 *)((int)&ppl->lpplprod + 2) = (int)((ulong)pPVar8 >> 0x10);
    }
    else if (((PLPROD *)ppl->lpplprod)->iprodMax < ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac)
    {
      pPVar8 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&ppl->lpplprod + 2),
                                                  *(PL **)&ppl->lpplprod),
                                   (uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMax);
      *(PL **)&ppl->lpplprod = (PL *)pPVar8;
      *(undefined2 *)((int)&ppl->lpplprod + 2) = (int)((ulong)pPVar8 >> 0x10);
    }
    __fmemcpy((void *)CONCAT22(*(undefined2 *)((int)&ppl->lpplprod + 2),
                                       (void *)(*(int *)&ppl->lpplprod + 4)),
                      (void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                       (void *)(*(int *)&((PLANET *)lppl)->lpplprod + 4)),
                      (uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac << 2);
    ((PLPROD *)ppl->lpplprod)->iprodMac = ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac;
  }
  return 1;
}



// ======================================================================
// Function: LpthFromId
// Address: 1038:01b2
// Segment: MEMORY_UTIL
// ======================================================================


THING * LpthFromId(short idth)

{
  THING *lpth;
  
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < (THING *)lpThings + cThing) {
    if (lpth->idFull == idth) goto LAB_1038_0218;
    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
  }
  lpth._0_2_ = (THING *)0x0;
  lpth._2_2_ = 0;
LAB_1038_0218:
  return (THING *)CONCAT22(lpth._2_2_,(THING *)lpth);
}



// ======================================================================
// Function: LpplFromId
// Address: 1038:021e
// Segment: MEMORY_UTIL
// ======================================================================


PLANET * LpplFromId(short idPlanet)

{
  PLANET *pPVar1;
  short sVar2;
  undefined2 uVar3;
  short iHi;
  short iGuess;
  short iLo;
  short idGuess;
  
  if ((idPlanet < 0) || (game.cPlanMax <= idPlanet)) {
    pPVar1 = (PLANET *)0x0;
    uVar3 = 0;
  }
  else {
    uVar3 = lpPlanets._2_2_;
    if (cPlanet == game.cPlanMax) {
      pPVar1 = (PLANET *)lpPlanets + idPlanet;
    }
    else {
      iLo = -1;
      iHi = cPlanet;
      sVar2 = iLo;
      do {
        iLo = sVar2;
        if (iHi <= iLo + 1) {
          pPVar1 = (PLANET *)0x0;
          uVar3 = 0;
          break;
        }
        sVar2 = iLo + iHi >> 1;
        pPVar1 = (PLANET *)lpPlanets + sVar2;
      } while ((pPVar1->id < idPlanet) || (iHi = sVar2, sVar2 = iLo, idPlanet < pPVar1->id));
    }
  }
  return (PLANET *)CONCAT22(uVar3,pPVar1);
}



// ======================================================================
// Function: CalcPctSurvive
// Address: 1038:02f6
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: cMax */
/* WARNING: Variable defined which should be unmapped: pct */

void CalcPctSurvive(PLANET *lppl,float *ppct,float *ppctSmart)

{
  double dVar1;
  double dVar2;
  short sVar3;
  uint uVar4;
  PLANET *pPVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar6;
  double *pdVar7;
  undefined4 uStack_1c;
  short cMax;
  PART part;
  float pct;
  long cDefenses;
  short iPlrSav;
  
  if (ppctSmart != (float *)0x0) {
    *ppctSmart = fRam11201c9e;
  }
  uVar6 = (undefined2)((ulong)lppl >> 0x10);
  pPVar5 = (PLANET *)lppl;
  pct = fRam11201c9e;
  if ((pPVar5->iPlayer != -1) && ((*(uint *)(pPVar5->rgbImp + 4) & 0xfff) != 0)) {
    iPlrSav = idPlayer;
    idPlayer = pPVar5->iPlayer;
    sVar3 = FGetBestDefensePart(&part);
    pct = fRam11201c9e;
    if (sVar3 != 0) {
      cDefenses = (long)(*(uint *)(pPVar5->rgbImp + 4) & 0xfff);
      uVar4 = CMaxOperableDefenses(lppl,pPVar5->iPlayer,0);
      if (((int)uVar4 >> 0xf <= cDefenses._2_2_) &&
         (((int)uVar4 >> 0xf < cDefenses._2_2_ || (uVar4 < (uint)cDefenses)))) {
        cDefenses = (long)(int)uVar4;
      }
      dVar1 = (double)cDefenses;
      dVar2 = DOUBLE_1_0__1120_1caa -
              (double)(long)(part.u_PART_0x0004.parmor._0_2_)->dp / DOUBLE_1000_0__1120_1ca2;
      pdVar7 = _pow(SUB84(dVar2,0),
                            (double)CONCAT26((int)((qword)dVar1 >> 0x10),
                                             CONCAT24(SUB82(dVar1,0),(long)((qword)dVar2 >> 0x20))),
                            (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20)
                                                              )));
      pct = (float)*(double *)pdVar7;
      if (ppctSmart != (float *)0x0) {
        dVar1 = (double)cDefenses;
        cMax = SUB82(dVar1,0);
        part.hs.grhst = (HullSlotType)((qword)dVar1 >> 0x10);
        part.hs.wFlags_0x2 = (ushort)((qword)dVar1 >> 0x20);
        part.u_PART_0x0004.parmor._0_2_ = (ARMOR *)((qword)dVar1 >> 0x30);
        dVar2 = DOUBLE_1_0__1120_1caa -
                (double)(long)(part.u_PART_0x0004.parmor._0_2_)->dp / DOUBLE_2000_0__1120_1cb2;
        uStack_1c = (undefined4)((qword)dVar2 >> 0x20);
        pdVar7 = _pow(SUB84(dVar2,0),
                              (double)CONCAT26(part.hs.grhst,CONCAT24(cMax,uStack_1c)),
                              (double)CONCAT26(pct._0_2_,
                                               CONCAT24(part.u_PART_0x0004._2_2_,
                                                        (long)((qword)dVar1 >> 0x20))));
        *ppctSmart = (float)*(double *)pdVar7;
      }
    }
    idPlayer = iPlrSav;
  }
  *ppct = pct;
  return;
}



// ======================================================================
// Function: FLookupPlanet
// Address: 1038:04a6
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupPlanet(short iPlanet,PLANET *ppl)

{
  PLANET *pPVar1;
  PLANET *pPVar2;
  bool bVar3;
  short sVar4;
  int iVar5;
  int iVar6;
  PLANET *pPVar7;
  PLANET *pPVar8;
  PL *pPVar9;
  short fWrite;
  PLANET *lpPl;
  
  bVar3 = false;
  if (cPlanet < 1) {
    return 0;
  }
  if (iPlanet < 0) {
    iPlanet = ppl->id;
    if (iPlanet == -1) {
      LogChangePlanet((PLANET *)0x0,ppl);
      return 1;
    }
    bVar3 = true;
  }
  pPVar8 = LpplFromId(iPlanet);
  iVar6 = (int)((ulong)pPVar8 >> 0x10);
  pPVar2 = (PLANET *)pPVar8;
  if (((pPVar2 == (PLANET *)0x0) && (iVar6 == 0)) || (ppl == (PLANET *)0x0)) goto LAB_1038_0722;
  if (!bVar3) {
    if (ppl == (PLANET *)&sel.pl) {
      FDupPlanet(pPVar8,(PLANET *)&sel.pl);
    }
    else {
      pPVar7 = pPVar2;
      for (iVar5 = 0x1c; iVar5 != 0; iVar5 = iVar5 + -1) {
        pPVar1 = ppl;
        ppl = (PLANET *)&ppl->iPlayer;
        pPVar8 = pPVar7;
        pPVar7 = (PLANET *)&pPVar7->iPlayer;
        pPVar1->id = pPVar8->id;
      }
    }
    goto LAB_1038_0722;
  }
  InvalidateReport(0,0);
  LogChangePlanet(pPVar8,ppl);
  if ((*(int *)&pPVar2->lpplprod != *(int *)&ppl->lpplprod) ||
     (*(int *)((int)&pPVar2->lpplprod + 2) != *(int *)((int)&ppl->lpplprod + 2))) {
    if ((*(int *)&pPVar2->lpplprod == 0) && (*(int *)((int)&pPVar2->lpplprod + 2) == 0)) {
      if ((*(int *)&ppl->lpplprod != 0) || (*(int *)((int)&ppl->lpplprod + 2) != 0)) {
        pPVar9 = LpplAlloc(4,(uint)((PLPROD *)ppl->lpplprod)->iprodMac,htOrd);
        *(PL **)&pPVar2->lpplprod = (PL *)pPVar9;
        *(undefined2 *)((int)&pPVar2->lpplprod + 2) = (int)((ulong)pPVar9 >> 0x10);
      }
    }
    else if ((*(int *)&ppl->lpplprod == 0) && (*(int *)((int)&ppl->lpplprod + 2) == 0)) {
      FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pPVar2->lpplprod + 2),
                                    *(PL **)&pPVar2->lpplprod));
      *(undefined2 *)&pPVar2->lpplprod = 0;
      *(undefined2 *)((int)&pPVar2->lpplprod + 2) = 0;
      goto UTIL_FinishCopy;
    }
    if (((PLPROD *)pPVar2->lpplprod)->iprodMax < ((PLPROD *)ppl->lpplprod)->iprodMac) {
      pPVar9 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&pPVar2->lpplprod + 2),
                                                  *(PL **)&pPVar2->lpplprod),
                                   ((PLPROD *)ppl->lpplprod)->iprodMac + 2);
      *(PL **)&pPVar2->lpplprod = (PL *)pPVar9;
      *(undefined2 *)((int)&pPVar2->lpplprod + 2) = (int)((ulong)pPVar9 >> 0x10);
    }
    __fmemcpy((void *)CONCAT22(*(undefined2 *)((int)&pPVar2->lpplprod + 2),
                                       (void *)(*(int *)&pPVar2->lpplprod + 4)),
                      (void *)CONCAT22(*(undefined2 *)((int)&ppl->lpplprod + 2),
                                       (void *)(*(int *)&ppl->lpplprod + 4)),
                      (uint)((PLPROD *)ppl->lpplprod)->iprodMac << 2);
    ((PLPROD *)pPVar2->lpplprod)->iprodMac = ((PLPROD *)ppl->lpplprod)->iprodMac;
  }
UTIL_FinishCopy:
  __fmemcpy(pPVar8,(PLANET *)CONCAT22(0x1120,ppl),0x34);
  if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
    AdvanceTutor();
  }
LAB_1038_0722:
  if ((pPVar2 == (PLANET *)0x0) && (iVar6 == 0)) {
    sVar4 = 0;
  }
  else {
    sVar4 = 1;
  }
  return sVar4;
}



// ======================================================================
// Function: DpOfLpflIshdef
// Address: 1038:0746
// Segment: MEMORY_UTIL
// ======================================================================


long DpOfLpflIshdef(FLEET *lpfl,short ishdef)

{
  FLEET *pFVar1;
  int iVar2;
  undefined2 uVar3;
  ulong uVar4;
  long lVar5;
  short dpShdef;
  
  uVar3 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar1 = (FLEET *)lpfl;
  iVar2 = pFVar1->iPlayer * 4;
  lVar5 = 5000;
  uVar4 = __aFulmul((long)pFVar1->rgcsh[ishdef],
                            (long)(int)(((int)((pFVar1->rgcsh[ishdef + 0x10] & 0x7fU) *
                                              *(int *)(*(int *)(iVar2 + 0xfe) + ishdef * 0x93 + 0x38
                                                      )) / 10) *
                                       ((uint)pFVar1->rgcsh[ishdef + 0x10] >> 7)));
  lVar5 = __aFldiv(uVar4,lVar5);
  return lVar5;
}



// ======================================================================
// Function: FLookupThing
// Address: 1038:07fe
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupThing(short idth,THING *pth)

{
  THING *pTVar1;
  THING *pTVar2;
  THING *pTVar3;
  short sVar4;
  int iVar5;
  bool bVar6;
  THING *lpth;
  short fWrite;
  
  if (cThing < 1) {
    sVar4 = 0;
  }
  else {
    bVar6 = idth < 0;
    if (bVar6) {
      idth = pth->idFull;
    }
    lpth = LpthFromId(idth);
    pTVar3 = (THING *)lpth;
    if ((lpth != (THING *)0x0) && (pth != (THING *)0x0)) {
      if (bVar6) {
        LogChangeThing(lpth,pth);
        __fmemcpy(lpth,(THING *)CONCAT22(0x1120,pth),0x12);
        if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
          AdvanceTutor();
        }
      }
      else {
        for (iVar5 = 9; iVar5 != 0; iVar5 = iVar5 + -1) {
          pTVar2 = pth;
          pth = (THING *)&pth->pt;
          pTVar1 = pTVar3;
          pTVar3 = (THING *)&pTVar3->pt;
          pTVar2->idFull = pTVar1->idFull;
        }
      }
    }
    if (lpth == (THING *)0x0) {
      sVar4 = 0;
    }
    else {
      sVar4 = 1;
    }
  }
  return sVar4;
}



// ======================================================================
// Function: SelectOursAtObject
// Address: 1038:08f2
// Segment: MEMORY_UTIL
// ======================================================================


void SelectOursAtObject(POINT *ppt)

{
  FLEET *pFVar1;
  int iVar2;
  POINT pt_00;
  POINT pt_01;
  short sVar3;
  SCAN scan;
  FLEET *lpfl;
  short i;
  short ish;
  int pt;
  int local_8;
  short id;
  
  if (ppt->x == -1) {
    if ((ppt->y & 0x8000U) != 0) {
      SelectAdjFleet(0,ppt->y & 0x7fff);
      return;
    }
    pt = ((POINT *)rgptPlan + ppt->y)->x;
    local_8 = *(int *)((int)&rgptPlan[0].y + ppt->y * 4);
  }
  else {
    pt = ppt->x;
    local_8 = ppt->y;
  }
  id = -1;
  for (ish = 0; ish < cFleet; ish = ish + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[ish];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + ish) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    if ((pt == (&pFVar1->pt)->x) && (local_8 == (pFVar1->pt).y)) {
      if (pFVar1->iPlayer == idPlayer) {
        SelectAdjFleet(0,lpfl->id);
        return;
      }
      if (id == -1) {
        id = lpfl->id;
      }
    }
  }
  i = 0;
  while( true ) {
    if (game.cPlanMax <= i) {
      scan.iwp = -1;
      pt_00.y = local_8;
      pt_00.x = pt;
      sVar3 = FFindNearestObject(pt_00,grobjThing,&scan);
      if ((((sVar3 == 0) || (scan.grobj != grobjThing)) || (scan.ith == -1)) ||
         ((((THING *)lpThings + scan.ith)->idFull >> 0xd != 1 ||
          ((((&((THING *)lpThings)[scan.ith].u_THING_0x0006)->thp).wFlags >> 10 & 0xf) != 0))
         )) {
        if (id != -1) {
          SelectAdjFleet(0,id);
        }
      }
      else {
        ChangeScanSel(&scan,1);
        pt_01.y = scan.pt.y;
        pt_01.x = scan.pt.x;
        FEnsurePointOnScreen(pt_01,1);
        UpdateWindow(hwndScanner);
        SendMessage(hwndScanner,0x102,0x76,0);
      }
      return;
    }
    if ((((POINT *)rgptPlan + i)->x == pt) &&
       (*(int *)((int)&rgptPlan[0].y + i * 4) == local_8)) break;
    i = i + 1;
  }
  SelectAdjPlanet(0,i);
  return;
}



// ======================================================================
// Function: LComputePower
// Address: 1038:0b32
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10380da6) */

long LComputePower(SHDEF *lpshdef)

{
  short sVar1;
  int iVar2;
  uint uVar3;
  int iVar4;
  HS *pHVar5;
  BEAM *pBVar6;
  undefined2 uVar7;
  bool bVar8;
  ulong uVar9;
  long lVar10;
  PART part;
  undefined4 dp;
  uint dpBombs;
  int local_1a;
  ulong dpBeams;
  ulong pctCap;
  short i;
  long dpTorps;
  short ihs;
  short dxRange;
  short dSpeed;
  
  dpBombs = 0;
  local_1a = 0;
  dpTorps = 0;
  dxRange = 999;
  pctCap = 1000;
  ihs = 0;
  uVar9 = 0;
  while( true ) {
    uVar7 = (undefined2)((ulong)lpshdef >> 0x10);
    dpBeams = uVar9;
    if ((int)(uint)(((SHDEF *)lpshdef)->hul).chs <= ihs) break;
    pHVar5 = (((SHDEF *)lpshdef)->hul).rghs + ihs;
    part.hs.grhst = pHVar5->grhst;
    part.hs.wFlags_0x2 = pHVar5->wFlags_0x2;
    if (part.hs.wFlags_0x2 >> 8 != 0) {
      sVar1 = FLookupPart(&part);
      if (sVar1 != 0) {
        pBVar6 = (BEAM *)part.u_PART_0x0004.pbeam;
        uVar7 = part.u_PART_0x0004._2_2_;
        if (part.hs.grhst == hstBeam) {
          lVar10 = 4;
          iVar2 = pBVar6->dRangeMax + 3;
          iVar4 = iVar2 >> 0xf;
          uVar9 = __aFulmul((long)pBVar6->dp,(ulong)(part.hs.wFlags_0x2 >> 8));
          uVar9 = __aFulmul(uVar9,CONCAT22(iVar4,iVar2));
          lVar10 = __aFldiv(uVar9,lVar10);
          if ((((BEAM *)part.u_PART_0x0004.pbeam)->grfAbilities & 1U) != 0) {
            dp = lVar10;
            lVar10 = __aFldiv(lVar10,3);
          }
          dpBeams = lVar10 + dpBeams;
          dp = lVar10;
        }
        else if (part.hs.grhst == hstTorp) {
          lVar10 = 2;
          iVar2 = pBVar6->dRangeMax + -2;
          iVar4 = iVar2 >> 0xf;
          uVar9 = __aFulmul((long)pBVar6->dp,(ulong)(part.hs.wFlags_0x2 >> 8));
          uVar9 = __aFulmul(uVar9,CONCAT22(iVar4,iVar2));
          lVar10 = __aFldiv(uVar9,lVar10);
          dpTorps = lVar10 + dpTorps;
        }
        else if (part.hs.grhst == hstBomb) {
          uVar3 = (pBVar6->dp + pBVar6->init) * (part.hs.wFlags_0x2 >> 8) * 2;
          bVar8 = CARRY2(dpBombs,uVar3);
          dpBombs = dpBombs + uVar3;
          local_1a = local_1a + (uint)bVar8;
        }
        else if ((part.hs.grhst == hstSpecialE) &&
                (((part.hs.wFlags_0x2 & 0xff) == 0xc || ((part.hs.wFlags_0x2 & 0xff) == 0xd)))) {
          uVar9 = pctCap;
          for (i = part.hs.wFlags_0x2 >> 8; pctCap = uVar9, 0 < i; i = i + -1) {
            lVar10 = 100;
            uVar3 = ((ARMOR *)part.u_PART_0x0004.parmor)->dp;
            uVar9 = __aFulmul(uVar9,CONCAT22(((int)uVar3 >> 0xf) + (uint)(0xff9b < uVar3),
                                                     uVar3 + 100));
            uVar9 = __aFldiv(uVar9,lVar10);
          }
        }
      }
    }
    ihs = ihs + 1;
    uVar9 = dpBeams;
  }
  if (pctCap == 1000) {
    pctCap = 1000;
  }
  else {
    uVar9 = __aFldiv(pctCap,10);
    if (0xff < (long)uVar9) {
      uVar9 = 0xff;
    }
    lVar10 = 100;
    pctCap = uVar9;
    uVar9 = __aFulmul(dpBeams,uVar9);
    uVar9 = __aFldiv(uVar9,lVar10);
  }
  dpBeams = uVar9;
  dSpeed = SpdOfShip((FLEET *)0x0,0,(TOK *)0x0,0,lpshdef);
  lVar10 = 10;
  uVar9 = __aFulmul(dpBeams,(long)(dSpeed + -4));
  lVar10 = __aFldiv(uVar9,lVar10);
  return lVar10 + dpBeams + CONCAT22(local_1a,dpBombs) + dpTorps;
}



// ======================================================================
// Function: ComputeShdefPowers
// Address: 1038:0e4e
// Segment: MEMORY_UTIL
// ======================================================================


void ComputeShdefPowers(void)

{
  undefined2 uVar1;
  int iVar2;
  long lVar3;
  short ishdef;
  short iplr;
  
  for (iplr = 0; iplr < game.cPlayer; iplr = iplr + 1) {
    if ((*(int *)(iplr * 4 + 0xfe) != 0) || (*(int *)(iplr * 4 + 0x100) != 0)) {
      for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
        if ((*(uint *)(*(int *)(iplr * 4 + 0xfe) + ishdef * 0x93 + 0x7b) >> 9 & 1) == 0) {
          lVar3 = LComputePower((SHDEF *)CONCAT22(*(undefined2 *)(iplr * 4 + 0x100),
                                                  (SHDEF *)(*(int *)(iplr * 4 + 0xfe) +
                                                           ishdef * 0x93)));
          uVar1 = *(undefined2 *)(iplr * 4 + 0x100);
          iVar2 = *(int *)(iplr * 4 + 0xfe) + ishdef * 0x93;
          *(undefined2 *)(iVar2 + 0x87) = (int)lVar3;
          *(undefined2 *)(iVar2 + 0x89) = (int)((ulong)lVar3 >> 0x10);
        }
      }
    }
  }
  return;
}



// ======================================================================
// Function: DpShieldOfShdef
// Address: 1038:0f24
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x103810d2) */

long DpShieldOfShdef(SHDEF *lpshdef,short iplr)

{
  uint uVar1;
  short sVar2;
  HS *pHVar3;
  ushort unaff_DI;
  undefined2 uVar4;
  bool bVar5;
  long lVar6;
  long lVar7;
  PART part;
  HUL *lphul;
  uint dpShdef;
  int local_e;
  short ihs;
  HS *lphs;
  short chs;
  
  dpShdef = 0;
  local_e = 0;
  lphul = &lpshdef->hul;
  lphs = (HS *)CONCAT22(lpshdef._2_2_,(((SHDEF *)lpshdef)->hul).rghs);
  chs = (short)(((SHDEF *)lpshdef)->hul).chs;
  for (ihs = 0; ihs < chs; ihs = ihs + 1) {
    pHVar3 = (HS *)lphs;
    uVar4 = (undefined2)((ulong)lphs >> 0x10);
    if ((lphs->grhst == hstShield) && (pHVar3->wFlags_0x2 >> 8 != 0)) {
      part.hs.grhst = lphs->grhst;
      part.hs.wFlags_0x2 = pHVar3->wFlags_0x2;
      FLookupPart(&part);
      uVar1 = ((ARMOR *)part.u_PART_0x0004.parmor)->dp * (((HS *)lphs)->wFlags_0x2 >> 8);
      bVar5 = CARRY2(dpShdef,uVar1);
      dpShdef = dpShdef + uVar1;
      local_e = local_e + (uint)bVar5;
    }
    else if (((lphs->grhst == hstArmor) && (pHVar3->wFlags_0x2 >> 8 != 0)) &&
            ((pHVar3->wFlags_0x2 & 0xff) == 6)) {
      uVar1 = (pHVar3->wFlags_0x2 >> 8) * 0x32;
      bVar5 = CARRY2(dpShdef,uVar1);
      dpShdef = dpShdef + uVar1;
      local_e = local_e + (uint)bVar5;
    }
    else if ((lphs->grhst == hstArmor) && ((pHVar3->wFlags_0x2 & 0xff) == 9)) {
      uVar1 = (pHVar3->wFlags_0x2 >> 8) * 100;
      bVar5 = CARRY2(dpShdef,uVar1);
      dpShdef = dpShdef + uVar1;
      local_e = local_e + (uint)bVar5;
    }
    lphs = (HS *)CONCAT22(lphs._2_2_,(HS *)lphs + 1);
  }
  sVar2 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceRegeneratingShields);
  lVar6 = CONCAT22(local_e,dpShdef);
  if (sVar2 != 0) {
    lVar7 = 5;
    lVar6 = __aFlshl(5,unaff_DI);
    lVar6 = __aFldiv(lVar6,lVar7);
    lVar6 = lVar6 + CONCAT22(local_e,dpShdef);
  }
  local_e = (int)((ulong)lVar6 >> 0x10);
  dpShdef = (uint)lVar6;
  if (local_e != 0) {
    dpShdef = 0xffff;
  }
  return (long)dpShdef;
}



// ======================================================================
// Function: IStargateFromLppl
// Address: 1038:10fa
// Segment: MEMORY_UTIL
// ======================================================================


short IStargateFromLppl(PLANET *lppl)

{
  undefined2 uVar1;
  int iVar2;
  HUL *lphul;
  short ihs;
  HS *lphs;
  short chs;
  
  if ((lppl != (PLANET *)0x0) && ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0)) {
    iVar2 = ((PLANET *)lppl)->iPlayer * 4;
    uVar1 = *(undefined2 *)(iVar2 + 0x14e);
    iVar2 = *(int *)(iVar2 + 0x14c) + (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93;
    lphs = (HS *)CONCAT22(uVar1,(HS *)(iVar2 + 0x3a));
    for (ihs = 0; ihs < (int)(uint)*(byte *)(iVar2 + 0x7a); ihs = ihs + 1) {
      if (((lphs->grhst == hstSpecialSB) && (((HS *)lphs)->wFlags_0x2 >> 8 != 0)) &&
         ((((HS *)lphs)->wFlags_0x2 & 0xff) < 7)) {
        return ((HS *)lphs)->wFlags_0x2 & 0xff;
      }
      lphs = (HS *)CONCAT22(lphs._2_2_,(HS *)lphs + 1);
    }
  }
  return -1;
}



// ======================================================================
// Function: PszPlayerName
// Address: 1038:11f2
// Segment: MEMORY_UTIL
// ======================================================================


char * PszPlayerName(short iPlayer,short fCapital,short fPlural,short fThe,short grWord,PLAYER *pplr)

{
  int iVar1;
  char *pcVar2;
  ushort uVar3;
  undefined2 unaff_SS;
  char szName [50];
  char *pchEnd;
  
  if (pplr == (PLAYER *)0x0) {
    pplr = (PLAYER *)rgplr + iPlayer;
  }
  if (pplr->szName[0] == '\0') {
    iVar1 = iPlayer + 1;
    pcVar2 = PszGetCompressedString(idsPlayerD2);
    _wsprintf((char *)CONCAT22(unaff_SS,szName),(char *)CONCAT22(0x1120,pcVar2),iVar1);
    if (fPlural == 0) {
      _strcat(szName,(char *)0x515);
    }
    if (grWord == 1) {
      uVar3 = _strlen(szName);
      CchGetString(idsHas,szName + uVar3);
    }
    else if (grWord == 2) {
      uVar3 = _strlen(szName);
      CchGetString(idsIs2,szName + uVar3);
    }
  }
  else {
    if (fThe == 0) {
      szName[0] = '\0';
    }
    else {
      _strcpy(szName,(char *)0x50e);
      if (fCapital != 0) {
        szName[0] = 'T';
      }
    }
    if ((fPlural == 0) || (pplr->szNames[0] == '\0')) {
      _strcat(szName,pplr->szName);
    }
    else {
      _strcat(szName,pplr->szNames);
    }
    uVar3 = _strlen(szName);
    pchEnd = szName + (uVar3 - 1);
    while ((*pchEnd == ' ' && (szName <= pchEnd))) {
      *pchEnd = '\0';
      pchEnd = pchEnd + -1;
    }
    if (pchEnd < szName) {
      CchGetString(idsName,szName);
    }
    if ((fPlural != 0) && (pplr->szNames[0] == '\0')) {
      uVar3 = _strlen(szName);
      pchEnd = szName + (uVar3 - 1);
      if ((*pchEnd != 's') && ((*pchEnd != 'e' || (szName[uVar3 - 2] != 's')))) {
        _strcat(szName,(char *)0x513);
      }
    }
    if (grWord == 1) {
      uVar3 = _strlen(szName);
      CchGetString(idsHave2,szName + uVar3);
    }
    else if (grWord == 2) {
      uVar3 = _strlen(szName);
      CchGetString(idsAre,szName + uVar3);
    }
  }
  _strcpy((char *)szWork,szName);
  return (char *)szWork;
}



// ======================================================================
// Function: FCalcFleetBombDamage
// Address: 1038:145c
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10381747) */
/* WARNING: Removing unreachable block (ram,0x10381690) */

short FCalcFleetBombDamage
          (FLEET *lpfl,long *pdmgPeople,long *pdmgPeopleMin,long *pdmgPeopleSmart,long *pdmgBldg,
          long *ppctTerra,short *pfMulti)

{
  uint *puVar1;
  uint uVar2;
  undefined2 uVar3;
  short sVar4;
  HullSlotType *pHVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar6;
  long lVar7;
  ulong uVar8;
  int in_stack_0000ffc4;
  int in_stack_0000ffc6;
  double dmgT;
  int cIter;
  int local_2a;
  PART part;
  short ishdef;
  short j;
  short fBomber;
  double dmgSmart;
  FLEET *lpflHead;
  short dmgFloor;
  FLEET *lpflNext;
  short cfl;
  short iplr;
  
  iplr = ((FLEET *)lpfl)->iPlayer;
  cfl = 0;
  dmgSmart = DOUBLE_1_0__1120_1caa;
  *(undefined2 *)ppctTerra = 0;
  *(undefined2 *)((int)ppctTerra + 2) = 0;
  *(undefined2 *)pdmgPeopleMin = 0;
  *(undefined2 *)((int)pdmgPeopleMin + 2) = 0;
  *(undefined2 *)pdmgBldg = 0;
  *(undefined2 *)((int)pdmgBldg + 2) = 0;
  *(undefined2 *)pdmgPeopleSmart = 0;
  *(undefined2 *)((int)pdmgPeopleSmart + 2) = 0;
  *(undefined2 *)pdmgPeople = 0;
  *(undefined2 *)((int)pdmgPeople + 2) = 0;
  lpflHead = lpfl;
  while( true ) {
    if (((FLEET *)lpfl == (FLEET *)0x0) && (lpfl._2_2_ == 0)) break;
    fBomber = 0;
    ((FLEET *)lpfl)->wFlags_0x4 = ((FLEET *)lpfl)->wFlags_0x4 & 0xefff | 0x1000;
    for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[ishdef]) {
        for (j = 0; j < (int)(uint)*(byte *)(*(int *)(iplr * 4 + 0xfe) + ishdef * 0x93 + 0x7a);
            j = j + 1) {
          if (*(int *)(*(int *)(iplr * 4 + 0xfe) + ishdef * 0x93 + 0x3a + j * 4) == 0x40) {
            uVar3 = *(undefined2 *)(iplr * 4 + 0x100);
            pHVar5 = (HullSlotType *)(*(int *)(iplr * 4 + 0xfe) + ishdef * 0x93 + 0x3a + j * 4);
            part.hs.grhst = *pHVar5;
            part.hs.wFlags_0x2 = pHVar5[1];
            FLookupPart(&part);
            fBomber = 1;
            if ((part.hs.wFlags_0x2 &
                (hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) ==
                (hstArmor|hstEngine)) {
              uVar6 = __aFulmul((ulong)(part.hs.wFlags_0x2 >> 8),
                                        (long)((FLEET *)lpfl)->rgcsh[ishdef]);
              puVar1 = (uint *)ppctTerra;
              uVar2 = *puVar1;
              *puVar1 = *puVar1 + (uint)uVar6;
              *(int *)((int)ppctTerra + 2) =
                   *(int *)((int)ppctTerra + 2) + (int)(uVar6 >> 0x10) +
                   (uint)CARRY2(uVar2,(uint)uVar6);
            }
            else if (part.hs.wFlags_0x2 >> 8 != 0) {
              if (((BEAM *)part.u_PART_0x0004.pbeam)->init == 0) {
                uVar6 = __aFulmul((ulong)(part.hs.wFlags_0x2 >> 8),
                                          (long)((FLEET *)lpfl)->rgcsh[ishdef]);
                in_stack_0000ffc4 = ((BEAM *)part.u_PART_0x0004.pbeam)->dp;
                in_stack_0000ffc6 = in_stack_0000ffc4 >> 0xf;
                while( true ) {
                  local_2a = (int)(uVar6 >> 0x10);
                  cIter = (int)uVar6;
                  if ((long)uVar6 < 1) break;
                  dmgSmart = dmgSmart *
                             (DOUBLE_1_0__1120_1caa -
                             (double)(long)in_stack_0000ffc4 / DOUBLE_1000_0__1120_1ca2);
                  uVar6 = CONCAT22(local_2a - (uint)(cIter == 0),cIter + -1);
                }
              }
              else {
                uVar8 = (ulong)((BEAM *)part.u_PART_0x0004.pbeam)->dp;
                uVar6 = __aFulmul((ulong)(part.hs.wFlags_0x2 >> 8),
                                          (long)((FLEET *)lpfl)->rgcsh[ishdef]);
                uVar6 = __aFulmul(uVar6,uVar8);
                puVar1 = (uint *)pdmgPeople;
                uVar2 = *puVar1;
                *puVar1 = *puVar1 + (uint)uVar6;
                *(int *)((int)pdmgPeople + 2) =
                     *(int *)((int)pdmgPeople + 2) + (int)(uVar6 >> 0x10) +
                     (uint)CARRY2(uVar2,(uint)uVar6);
                uVar8 = (ulong)((BEAM *)part.u_PART_0x0004.pbeam)->init;
                uVar6 = __aFulmul((ulong)(part.hs.wFlags_0x2 >> 8),
                                          (long)((FLEET *)lpfl)->rgcsh[ishdef]);
                uVar6 = __aFulmul(uVar6,uVar8);
                puVar1 = (uint *)pdmgBldg;
                uVar2 = *puVar1;
                *puVar1 = *puVar1 + (uint)uVar6;
                *(int *)((int)pdmgBldg + 2) =
                     *(int *)((int)pdmgBldg + 2) + (int)(uVar6 >> 0x10) +
                     (uint)CARRY2(uVar2,(uint)uVar6);
                if ((part.hs.wFlags_0x2 &
                    (hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) <
                    (hstShield|hstEngine)) {
                  dmgFloor = 3;
                  uVar8 = 3;
                  uVar6 = __aFulmul((ulong)(part.hs.wFlags_0x2 >> 8),
                                            (long)((FLEET *)lpfl)->rgcsh[ishdef]);
                  uVar6 = __aFulmul(uVar6,uVar8);
                  puVar1 = (uint *)pdmgPeopleMin;
                  uVar2 = *puVar1;
                  *puVar1 = *puVar1 + (uint)uVar6;
                  *(int *)((int)pdmgPeopleMin + 2) =
                       *(int *)((int)pdmgPeopleMin + 2) + (int)(uVar6 >> 0x10) +
                       (uint)CARRY2(uVar2,(uint)uVar6);
                }
              }
            }
          }
          else if ((*(int *)(*(int *)(iplr * 4 + 0xfe) + ishdef * 0x93 + 0x3a + j * 4) == 0x10) &&
                  ((*(uint *)(*(int *)(iplr * 4 + 0xfe) + ishdef * 0x93 + j * 4 + 0x3c) & 0xff) ==
                   0x12)) {
            uVar3 = *(undefined2 *)(iplr * 4 + 0x100);
            pHVar5 = (HullSlotType *)(*(int *)(iplr * 4 + 0xfe) + ishdef * 0x93 + 0x3a + j * 4);
            part.hs.grhst = *pHVar5;
            part.hs.wFlags_0x2 = pHVar5[1];
            fBomber = 1;
            uVar8 = 0x14;
            uVar6 = __aFulmul((ulong)(part.hs.wFlags_0x2 >> 8),
                                      (long)((FLEET *)lpfl)->rgcsh[ishdef]);
            uVar6 = __aFulmul(uVar6,uVar8);
            puVar1 = (uint *)pdmgPeople;
            uVar2 = *puVar1;
            *puVar1 = *puVar1 + (uint)uVar6;
            *(int *)((int)pdmgPeople + 2) =
                 *(int *)((int)pdmgPeople + 2) + (int)(uVar6 >> 0x10) +
                 (uint)CARRY2(uVar2,(uint)uVar6);
            uVar8 = 5;
            uVar6 = __aFulmul((ulong)(part.hs.wFlags_0x2 >> 8),
                                      (long)((FLEET *)lpfl)->rgcsh[ishdef]);
            uVar6 = __aFulmul(uVar6,uVar8);
            puVar1 = (uint *)pdmgBldg;
            uVar2 = *puVar1;
            *puVar1 = *puVar1 + (uint)uVar6;
            *(int *)((int)pdmgBldg + 2) =
                 *(int *)((int)pdmgBldg + 2) + (int)(uVar6 >> 0x10) +
                 (uint)CARRY2(uVar2,(uint)uVar6);
            uVar8 = 3;
            uVar6 = __aFulmul((ulong)(part.hs.wFlags_0x2 >> 8),
                                      (long)((FLEET *)lpfl)->rgcsh[ishdef]);
            uVar6 = __aFulmul(uVar6,uVar8);
            puVar1 = (uint *)pdmgPeopleMin;
            uVar2 = *puVar1;
            *puVar1 = *puVar1 + (uint)uVar6;
            *(int *)((int)pdmgPeopleMin + 2) =
                 *(int *)((int)pdmgPeopleMin + 2) + (int)(uVar6 >> 0x10) +
                 (uint)CARRY2(uVar2,(uint)uVar6);
          }
          else if ((*(int *)(*(int *)(iplr * 4 + 0xfe) + ishdef * 0x93 + 0x3a + j * 4) == 0x1000) &&
                  ((*(uint *)(*(int *)(iplr * 4 + 0xfe) + ishdef * 0x93 + j * 4 + 0x3c) & 0xff) == 1
                  )) {
            uVar3 = *(undefined2 *)(iplr * 4 + 0x100);
            pHVar5 = (HullSlotType *)(*(int *)(iplr * 4 + 0xfe) + ishdef * 0x93 + 0x3a + j * 4);
            part.hs.grhst = *pHVar5;
            part.hs.wFlags_0x2 = pHVar5[1];
            fBomber = 1;
            uVar8 = 0x14;
            uVar6 = __aFulmul((ulong)(part.hs.wFlags_0x2 >> 8),
                                      (long)((FLEET *)lpfl)->rgcsh[ishdef]);
            uVar6 = __aFulmul(uVar6,uVar8);
            puVar1 = (uint *)pdmgPeopleMin;
            uVar2 = *puVar1;
            *puVar1 = *puVar1 + (uint)uVar6;
            *(int *)((int)pdmgPeopleMin + 2) =
                 *(int *)((int)pdmgPeopleMin + 2) + (int)(uVar6 >> 0x10) +
                 (uint)CARRY2(uVar2,(uint)uVar6);
          }
        }
      }
    }
    cfl = cfl + 1;
                    /* WARNING: Load size is inaccurate */
    lpflNext = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpflNext + 2),
                                 ((FLEET *)lpfl)->lpflNext);
    while( true ) {
      if ((lpflNext == (FLEET *)0x0) ||
         (((((FLEET *)lpflNext)->wFlags_0x4 >> 10 & 1) == 0 &&
          (((FLEET *)lpflNext)->iPlayer == iplr)))) break;
                    /* WARNING: Load size is inaccurate */
      lpflNext = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflNext)->lpflNext + 2),
                                   ((FLEET *)lpflNext)->lpflNext);
    }
    if ((lpflNext == (FLEET *)0x0) ||
       ((lpflHead == lpflNext || (((FLEET *)lpflNext)->idPlanet != ((FLEET *)lpfl)->idPlanet)))) {
      lpfl = (FLEET *)0x0;
    }
    else {
      lpfl = lpflNext;
    }
  }
  lVar7 = __ftol((double)CONCAT26(in_stack_0000ffc6,
                                          CONCAT24(in_stack_0000ffc4,CONCAT22(unaff_SI,unaff_DI))));
  *(int *)pdmgPeopleSmart = (int)lVar7;
  *(undefined2 *)((int)pdmgPeopleSmart + 2) = (int)((ulong)lVar7 >> 0x10);
  if ((-1 < *(int *)((int)pdmgPeopleSmart + 2)) &&
     ((0 < *(int *)((int)pdmgPeopleSmart + 2) || (999 < *(uint *)pdmgPeopleSmart)))) {
    *(undefined2 *)pdmgPeopleSmart = 1000;
    *(undefined2 *)((int)pdmgPeopleSmart + 2) = 0;
  }
  *pfMulti = (uint)(1 < cfl);
  if ((((((((int)*pdmgPeople == 0) && (*(int *)((int)pdmgPeople + 2) == 0)) &&
         ((int)*pdmgPeopleMin == 0)) &&
        ((*(int *)((int)pdmgPeopleMin + 2) == 0 && ((int)*pdmgPeopleSmart == 0)))) &&
       ((*(int *)((int)pdmgPeopleSmart + 2) == 0 &&
        (((int)*pdmgBldg == 0 && (*(int *)((int)pdmgBldg + 2) == 0)))))) && ((int)*ppctTerra == 0))
     && (*(int *)((int)ppctTerra + 2) == 0)) {
    sVar4 = 0;
  }
  else {
    sVar4 = 1;
  }
  return sVar4;
}



// ======================================================================
// Function: LinkFleets
// Address: 1038:1bb4
// Segment: MEMORY_UTIL
// ======================================================================


void LinkFleets(short fUnused)

{
  int iVar1;
  int iVar2;
  FLEET *pFVar3;
  FLEET *pFVar4;
  int iVar5;
  int iVar6;
  undefined2 uVar7;
  undefined2 uVar8;
  short cSrc;
  short iflHead;
  short iflTail;
  short i;
  FLEET *lpflHead;
  FLEET *lpflTail;
  int rglpflSrc [126];
  undefined2 pt;
  undefined2 local_8;
  FLEET **pSearch;
  
  for (iflHead = 0; iflHead < cFleet; iflHead = iflHead + 1) {
    iVar1 = *(int *)((FLEET **)rglpfl + iflHead);
    iVar2 = *(int *)((int)((FLEET **)rglpfl + iflHead) + 2);
    if ((iVar1 == 0) && (iVar2 == 0)) break;
    *(undefined2 *)(iVar1 + 0x68) = 0;
    *(undefined2 *)(iVar1 + 0x6a) = 0;
    *(uint *)(iVar1 + 4) = *(uint *)(iVar1 + 4) & 0xf7ff;
  }
  cSrc = 0;
  iflHead = 0;
  do {
    if (cFleet <= iflHead) {
      gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfbff | 0x400;
      return;
    }
    iVar1 = *(int *)((FLEET **)rglpfl + iflHead);
    iVar2 = *(int *)((int)((FLEET **)rglpfl + iflHead) + 2);
    if ((((*(uint *)(iVar1 + 4) >> 10 & 1) == 0) && (*(int *)(iVar1 + 0x68) == 0)) &&
       (*(int *)(iVar1 + 0x6a) == 0)) {
      for (i = 0; i < cSrc; i = i + 1) {
        uVar7 = (undefined2)((ulong)*(undefined4 *)(rglpflSrc + i * 2) >> 0x10);
        iVar5 = (int)*(undefined4 *)(rglpflSrc + i * 2);
        iVar6 = *(int *)(iVar5 + 10);
        if ((*(int *)(iVar1 + 10) <= iVar6) &&
           ((*(int *)(iVar1 + 10) < iVar6 || (*(uint *)(iVar1 + 8) <= *(uint *)(iVar5 + 8))))) {
          uVar7 = (undefined2)((ulong)*(undefined4 *)(rglpflSrc + i * 2) >> 0x10);
          iVar6 = (int)*(undefined4 *)(rglpflSrc + i * 2);
          if ((*(int *)(iVar1 + 8) == *(int *)(iVar6 + 8)) &&
             (*(int *)(iVar1 + 10) == *(int *)(iVar6 + 10))) {
            uVar8 = (undefined2)((ulong)*(undefined4 *)(rglpflSrc + i * 2) >> 0x10);
            iVar6 = (int)*(undefined4 *)(rglpflSrc + i * 2);
            uVar7 = *(undefined2 *)(iVar6 + 0x6a);
            *(undefined2 *)(iVar1 + 0x68) = *(undefined2 *)(iVar6 + 0x68);
            *(undefined2 *)(iVar1 + 0x6a) = uVar7;
            uVar7 = (undefined2)((ulong)*(undefined4 *)(rglpflSrc + i * 2) >> 0x10);
            iVar6 = (int)*(undefined4 *)(rglpflSrc + i * 2);
            *(int *)(iVar6 + 0x68) = iVar1;
            *(int *)(iVar6 + 0x6a) = iVar2;
            i = -1;
          }
          break;
        }
      }
      if (i != -1) {
        *(int *)(iVar1 + 0x68) = iVar1;
        *(int *)(iVar1 + 0x6a) = iVar2;
        if (i < cSrc) {
          _memmove(rglpflSrc + (i + 1) * 2,rglpflSrc + i * 2,(cSrc - i) * 4);
        }
        rglpflSrc[i * 2] = iVar1;
        rglpflSrc[i * 2 + 1] = iVar2;
        cSrc = cSrc + 1;
        iflTail = iflHead;
        if (0x3e < cSrc) {
          while (iflTail = iflTail + 1, iflTail < cFleet) {
            iVar1 = *(int *)((FLEET **)rglpfl + iflTail);
            iVar2 = *(int *)((int)((FLEET **)rglpfl + iflTail) + 2);
            if ((((*(uint *)(iVar1 + 4) >> 10 & 1) == 0) && (*(int *)(iVar1 + 0x68) == 0)) &&
               (*(int *)(iVar1 + 0x6a) == 0)) {
              pt = *(undefined2 *)(iVar1 + 8);
              local_8 = *(undefined2 *)(iVar1 + 10);
              pSearch = _bsearch(&pt,rglpflSrc,cSrc,4,
                                         (char *)s_R6002___floating_point_support_n_1120_1f8f + 0x13
                                        );
              if (pSearch != (FLEET **)0x0) {
                pFVar3 = *pSearch;
                pFVar4 = pSearch[1];
                uVar7 = *(undefined2 *)((int)&pFVar3->lpflNext + 2);
                *(undefined2 *)(iVar1 + 0x68) = *(undefined2 *)&pFVar3->lpflNext;
                *(undefined2 *)(iVar1 + 0x6a) = uVar7;
                *(int *)&pFVar3->lpflNext = iVar1;
                *(int *)((int)&pFVar3->lpflNext + 2) = iVar2;
              }
            }
          }
          cSrc = 0;
        }
      }
    }
    iflHead = iflHead + 1;
  } while( true );
}



// ======================================================================
// Function: ICompFleetPoint
// Address: 1038:1f0c
// Segment: MEMORY_UTIL
// ======================================================================


short ICompFleetPoint(void *arg1,void *arg2)

{
  uint uVar1;
  uint uVar2;
  int iVar3;
  int iVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  int l1;
  
  uVar5 = (undefined2)((ulong)*(undefined4 *)arg1 >> 0x10);
  iVar3 = (int)*(undefined4 *)arg1;
  uVar1 = *(uint *)(iVar3 + 8);
  uVar6 = (undefined2)((ulong)*(undefined4 *)arg2 >> 0x10);
  iVar4 = (int)*(undefined4 *)arg2;
  uVar2 = *(uint *)(iVar4 + 8);
  l1 = uVar1 - uVar2;
  iVar3 = (*(int *)(iVar3 + 10) - *(int *)(iVar4 + 10)) - (uint)(uVar1 < uVar2);
  if ((iVar3 < 1) && (iVar3 < 0)) {
    l1 = -1;
  }
  else if ((-1 < iVar3) && ((0 < iVar3 || (l1 != 0)))) {
    l1 = 1;
  }
  return l1;
}



// ======================================================================
// Function: ICompFleetPoint2
// Address: 1038:1fa2
// Segment: MEMORY_UTIL
// ======================================================================


short ICompFleetPoint2(void *arg1,void *arg2)

{
  uint uVar1;
  int iVar2;
  undefined2 uVar3;
  int l1;
  
  uVar3 = (undefined2)((ulong)*(undefined4 *)arg2 >> 0x10);
  iVar2 = (int)*(undefined4 *)arg2;
  uVar1 = *(uint *)(iVar2 + 8);
  l1 = *(uint *)arg1 - uVar1;
  iVar2 = (*(int *)((int)arg1 + 2) - *(int *)(iVar2 + 10)) - (uint)(*(uint *)arg1 < uVar1);
  if ((iVar2 < 1) && (iVar2 < 0)) {
    l1 = -1;
  }
  else if ((-1 < iVar2) && ((0 < iVar2 || (l1 != 0)))) {
    l1 = 1;
  }
  return l1;
}



// ======================================================================
// Function: FLookupSelShip
// Address: 1038:2032
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupSelShip(FLEET *pfl)

{
  short sVar1;
  
  if (sel.scan.grobj == grobjFleet) {
    sVar1 = FLookupFleet(((FLEET **)rglpfl)[sel.scan.ifl]->id,pfl);
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: LpflFromId
// Address: 1038:2078
// Segment: MEMORY_UTIL
// ======================================================================


FLEET * LpflFromId(short idFleet)

{
  int iVar1;
  FLEET *pFVar2;
  undefined2 uVar3;
  short iHi;
  short iplrCur;
  short i;
  short iGuess;
  short iLo;
  short idGuess;
  short iplr;
  
  i = 0;
  for (iplrCur = 0; iplrCur < (int)((uint)idFleet >> 9 & 0xf); iplrCur = iplrCur + 1) {
    i = i + (*(uint *)((int)&rgplr[0].wFlags_0x4 + iplrCur * 0xc0) & 0xfff);
  }
  iHi = cFleet;
  iVar1 = i + -1;
  do {
    iLo = iVar1;
    if (iHi <= iLo + 1) {
      pFVar2 = (FLEET *)0x0;
      uVar3 = 0;
      break;
    }
    iVar1 = iLo + iHi >> 1;
                    /* WARNING: Load size is inaccurate */
    pFVar2 = ((FLEET **)rglpfl)[iVar1];
    uVar3 = *(undefined2 *)((int)((FLEET **)rglpfl + iVar1) + 2);
  } while ((pFVar2->id < (int)(idFleet & 0x1fffU)) ||
          (iHi = iVar1, iVar1 = iLo, (int)(idFleet & 0x1fffU) < pFVar2->id));
  return (FLEET *)CONCAT22(uVar3,pFVar2);
}



// ======================================================================
// Function: FLookupFleet
// Address: 1038:2160
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: fWrite */
/* WARNING: Variable defined which should be unmapped: lpfl */

short FLookupFleet(short idFleet,FLEET *pfl)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  FLEET *pFVar3;
  short sVar4;
  int iVar5;
  int iVar6;
  bool bVar7;
  PL *pPVar8;
  FLEET *pFStack_c;
  short fWrite;
  FLEET *lpfl;
  
  if (cFleet < 1) {
    sVar4 = 0;
  }
  else {
    bVar7 = idFleet < 0;
    if (bVar7) {
      idFleet = pfl->id;
    }
    lpfl = LpflFromId(idFleet);
    iVar6 = (int)((ulong)lpfl >> 0x10);
    pFVar3 = (FLEET *)lpfl;
    if (((pFVar3 != (FLEET *)0x0) || (iVar6 != 0)) && (pfl != (FLEET *)0x0)) {
      if (bVar7) {
        InvalidateReport(1,0);
        LogChangeFleet(lpfl,pfl);
        if ((*(int *)&pFVar3->lpplord != *(int *)&pfl->lpplord) ||
           (*(int *)((int)&pFVar3->lpplord + 2) != *(int *)((int)&pfl->lpplord + 2))) {
          if ((int)(uint)((PLORD *)pFVar3->lpplord)->iordMax < pfl->cord) {
            pPVar8 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&pFVar3->lpplord + 2),
                                                        *(PL **)&pFVar3->lpplord),pfl->cord + 3);
            *(PL **)&pFVar3->lpplord = (PL *)pPVar8;
            *(undefined2 *)((int)&pFVar3->lpplord + 2) = (int)((ulong)pPVar8 >> 0x10);
          }
          pFVar3 = (FLEET *)((uint)((PLORD *)pfl->lpplord)->iordMac * 0x12);
          lpfl = (FLEET *)CONCAT22(iVar6,pFVar3);
          pFStack_c = (FLEET *)CONCAT22(*(undefined2 *)((int)&pfl->lpplord + 2),
                                        (void *)(*(int *)&pfl->lpplord + 4));
          __fmemcpy((void *)CONCAT22(*(undefined2 *)((int)&pFVar3->lpplord + 2),
                                             (void *)(*(int *)&pFVar3->lpplord + 4)),pFStack_c,
                            (ushort)pFVar3);
          ((PLORD *)pFVar3->lpplord)->iordMac = ((PLORD *)pfl->lpplord)->iordMac;
        }
        lpfl = (FLEET *)CONCAT22(lpfl._2_2_,(FLEET *)((int)(ulong *)rgcrPlrHistory + 0x36));
        pFStack_c = (FLEET *)CONCAT22(0x1120,pfl);
        __fmemcpy((void *)CONCAT22(lpfl._2_2_,
                                           (void *)((int)(ulong *)rgcrPlrHistory + 0x36)),
                          pFStack_c,100);
        if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
          lpfl = (FLEET *)CONCAT22(lpfl._2_2_,(FLEET *)0x1118);
          AdvanceTutor();
        }
      }
      else if (pfl == (FLEET *)&sel.fl) {
        FDupFleet(lpfl,(FLEET *)&sel.fl);
      }
      else {
        for (iVar5 = 0x3e; iVar5 != 0; iVar5 = iVar5 + -1) {
          pFVar2 = pfl;
          pfl = (FLEET *)&pfl->iPlayer;
          pFVar1 = pFVar3;
          pFVar3 = (FLEET *)&pFVar3->iPlayer;
          pFVar2->id = pFVar1->id;
        }
      }
    }
    if (((FLEET *)lpfl == (FLEET *)0x0) && (lpfl._2_2_ == 0)) {
      sVar4 = 0;
    }
    else {
      sVar4 = 1;
    }
  }
  return sVar4;
}



// ======================================================================
// Function: FDupFleet
// Address: 1038:2332
// Segment: MEMORY_UTIL
// ======================================================================


short FDupFleet(FLEET *lpfl,FLEET *pfl)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  PL *pPVar3;
  int iVar4;
  int iVar5;
  FLEET *pFVar6;
  FLEET *pFVar7;
  PL *pPVar8;
  
  pPVar3 = *(PL **)&pfl->lpplord;
  iVar4 = *(int *)((int)&pfl->lpplord + 2);
  pFVar6 = (FLEET *)lpfl;
  pFVar7 = pfl;
  for (iVar5 = 0x3e; iVar5 != 0; iVar5 = iVar5 + -1) {
    pFVar2 = pFVar7;
    pFVar7 = (FLEET *)&pFVar7->iPlayer;
    pFVar1 = pFVar6;
    pFVar6 = (FLEET *)&pFVar6->iPlayer;
    pFVar2->id = pFVar1->id;
  }
  if ((*(int *)&((FLEET *)lpfl)->lpplord == 0) &&
     (*(int *)((int)&((FLEET *)lpfl)->lpplord + 2) == 0)) {
    if ((pPVar3 != (PL *)0x0) || (iVar4 != 0)) {
      FreePl((PL *)CONCAT22(iVar4,pPVar3));
    }
  }
  else {
    *(PL **)&pfl->lpplord = pPVar3;
    *(int *)((int)&pfl->lpplord + 2) = iVar4;
    if ((*(int *)&pfl->lpplord == 0) && (*(int *)((int)&pfl->lpplord + 2) == 0)) {
      pPVar8 = LpplAlloc(0x12,(uint)((PLORD *)((FLEET *)lpfl)->lpplord)->iordMax,htOrd);
      *(PL **)&pfl->lpplord = (PL *)pPVar8;
      *(undefined2 *)((int)&pfl->lpplord + 2) = (int)((ulong)pPVar8 >> 0x10);
    }
    else if (((PLORD *)pfl->lpplord)->iordMax < ((PLORD *)((FLEET *)lpfl)->lpplord)->iordMac) {
      pPVar8 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&pfl->lpplord + 2),
                                                  *(PL **)&pfl->lpplord),
                                   (uint)((PLORD *)((FLEET *)lpfl)->lpplord)->iordMax);
      *(PL **)&pfl->lpplord = (PL *)pPVar8;
      *(undefined2 *)((int)&pfl->lpplord + 2) = (int)((ulong)pPVar8 >> 0x10);
    }
    __fmemcpy((void *)CONCAT22(*(undefined2 *)((int)&pfl->lpplord + 2),
                                       (void *)(*(int *)&pfl->lpplord + 4)),
                      (void *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2),
                                       (void *)(*(int *)&((FLEET *)lpfl)->lpplord + 4)),
                      (uint)((PLORD *)((FLEET *)lpfl)->lpplord)->iordMac * 0x12);
    ((PLORD *)pfl->lpplord)->iordMac = ((PLORD *)((FLEET *)lpfl)->lpplord)->iordMac;
  }
  return 1;
}



// ======================================================================
// Function: FLookupObject
// Address: 1038:24a0
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupObject(GrobjClass grobj,short id,void *pobj)

{
  short sVar1;
  
  if (grobj == grobjFleet) {
    sVar1 = FLookupFleet(id,pobj);
  }
  else if (grobj == grobjPlanet) {
    sVar1 = FLookupPlanet(id,pobj);
  }
  else {
    sVar1 = FLookupThing(id,pobj);
  }
  return sVar1;
}



// ======================================================================
// Function: FLookupOrbitingXfer
// Address: 1038:24fa
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupOrbitingXfer(short idPlanet,short iNth,XFER *pxf,short idSkip)

{
  FLEET *pFVar1;
  THING *pTVar2;
  u_XFER_0x0004 *puVar3;
  int iVar4;
  int iVar5;
  FLEET *pFVar6;
  THING *pTVar7;
  u_XFER_0x0004 *puVar8;
  bool bVar9;
  FLEET *lpfl;
  THING *lpth;
  short i;
  
  if (0 < cFleet) {
    if (cFleet != 0) {
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar6 = ((FLEET **)rglpfl)[i];
        iVar5 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar5,pFVar6);
        if ((pFVar6 == (FLEET *)0x0) && (iVar5 == 0)) break;
        if ((((pFVar6->idPlanet == idPlanet) && (lpfl->id != idSkip)) &&
            ((idSkip == -1 ||
             (((&pFVar6->pt)->x == sel.pt.x && ((pFVar6->pt).y == sel.pt.y))))))
           && (bVar9 = iNth == 0, iNth = iNth + -1, bVar9)) {
          if (pxf != (XFER *)0x0) {
            puVar8 = &pxf->u_XFER_0x0004;
            for (iVar4 = 0x3e; iVar4 != 0; iVar4 = iVar4 + -1) {
              puVar3 = puVar8;
              puVar8 = (u_XFER_0x0004 *)&(puVar8->fl).iPlayer;
              pFVar1 = pFVar6;
              pFVar6 = (FLEET *)&pFVar6->iPlayer;
              *(short *)puVar3 = pFVar1->id;
            }
            pxf->grobj = grobjFleet;
            pxf->id = lpfl->id;
          }
          return 1;
        }
      }
    }
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < (THING *)lpThings + cThing) {
      if ((((lpth->idFull >> 0xd == 1) && ((&((THING *)lpth)->pt)->x == sel.pt.x)) &&
          ((((THING *)lpth)->pt).y == sel.pt.y)) &&
         (bVar9 = iNth == 0, iNth = iNth + -1, bVar9)) {
        if (pxf != (XFER *)0x0) {
          puVar8 = &pxf->u_XFER_0x0004;
          pTVar7 = (THING *)lpth;
          for (iVar5 = 9; iVar5 != 0; iVar5 = iVar5 + -1) {
            puVar3 = puVar8;
            puVar8 = (u_XFER_0x0004 *)&(puVar8->fl).iPlayer;
            pTVar2 = pTVar7;
            pTVar7 = (THING *)&pTVar7->pt;
            *(ushort *)puVar3 = pTVar2->idFull;
          }
          pxf->grobj = grobjThing;
          pxf->id = lpth->idFull;
        }
        return 1;
      }
      lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
    }
  }
  return 0;
}



// ======================================================================
// Function: PszGetThingName
// Address: 1038:26de
// Segment: MEMORY_UTIL
// ======================================================================


char * PszGetThingName(short id)

{
  char *pcVar1;
  char *pcVar2;
  int iVar3;
  undefined2 unaff_SS;
  char *pcVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  char szPlr [54];
  THING *lpth;
  
  lpth = LpthFromId(id);
  iVar3 = (int)((ulong)lpth >> 0x10);
  if (((THING *)lpth == (THING *)0x0) && (iVar3 == 0)) {
    szWork[0] = '\0';
  }
  else if (lpth->idFull >> 0xd == 0) {
    if ((lpth->idFull >> 9 & 0xf) == idPlayer) {
      szPlr[0] = '\0';
    }
    else {
      pcVar2 = PszPlayerName(lpth->idFull >> 9 & 0xf,0,0,0,0,(PLAYER *)0x0);
      _wsprintf((char *)CONCAT22(unaff_SS,szPlr),(char *)0x11200518,pcVar2,0x1120);
    }
    uVar5 = *(undefined2 *)((uint)*(byte *)((int)&((THING *)lpth)->u_THING_0x0006 + 6) * 2 + 0x4f2);
    uVar6 = 0x1120;
    pcVar4 = (char *)CONCAT22(unaff_SS,szPlr);
    pcVar2 = PszGetCompressedString(idsSSMineField);
    _wsprintf(szWork,(char *)CONCAT22(0x1120,pcVar2),pcVar4,uVar5,uVar6);
  }
  else if (lpth->idFull >> 0xd == 1) {
    if ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) == 0) {
      CchGetString(idsSalvage,(char *)szWork);
    }
    else {
      if ((lpth->idFull >> 9 & 0xf) == idPlayer) {
        szPlr[0] = '\0';
      }
      else {
        pcVar2 = PszPlayerName(lpth->idFull >> 9 & 0xf,0,0,0,0,(PLAYER *)0x0);
        _wsprintf((char *)CONCAT22(unaff_SS,szPlr),(char *)0x1120051c,pcVar2,0x1120);
      }
      pcVar2 = szPlr;
      pcVar1 = PszGetCompressedString(idsSmineralPacket);
      _wsprintf(szWork,(char *)CONCAT22(0x1120,pcVar1),pcVar2);
    }
  }
  else if (lpth->idFull >> 0xd == 2) {
    pcVar2 = PszGetCompressedString(idsWormhole);
    _strcpy((char *)szWork,pcVar2);
  }
  else if (lpth->idFull >> 0xd == 3) {
    pcVar2 = PszGetCompressedString(idsMysteryTrader);
    _strcpy((char *)szWork,pcVar2);
  }
  else {
    pcVar2 = PszGetCompressedString(idsMysteryObject);
    _strcpy((char *)szWork,pcVar2);
  }
  return (char *)szWork;
}



// ======================================================================
// Function: PszGetFleetName
// Address: 1038:292c
// Segment: MEMORY_UTIL
// ======================================================================


char * PszGetFleetName(short id)

{
  uint iPlayer;
  char *pcVar1;
  short sVar2;
  undefined2 unaff_SS;
  short cch;
  short ishdef;
  char szPlr [34];
  FLEET *lpfl;
  short ifl;
  char szShdef [34];
  char *lpsz;
  short iplr;
  short cshdef;
  
  lpfl = LpflFromId(id & 0x7fff);
  iPlayer = (id & 0x7fffU) >> 9 & 0xf;
  ifl = id & 0x1ff;
  if (iPlayer == idPlayer) {
    szPlr[0] = '\0';
  }
  else {
    pcVar1 = PszPlayerName(iPlayer,0,0,0,0,(PLAYER *)0x0);
    _wsprintf((char *)CONCAT22(unaff_SS,szPlr),(char *)0x11200520,pcVar1,0x1120);
  }
  if ((((FLEET *)lpfl == (FLEET *)0x0) && (lpfl._2_2_ == 0)) ||
     ((*(int *)&((FLEET *)lpfl)->lpszName == 0 &&
      (*(int *)((int)&((FLEET *)lpfl)->lpszName + 2) == 0)))) {
    if (((FLEET *)lpfl == (FLEET *)0x0) && (lpfl._2_2_ == 0)) {
      lpsz = PszGetCompressedString(idsFleet);
    }
    else {
      sVar2 = IshdefPrimaryFromLpfl(lpfl,&cshdef);
      if (sVar2 == 0x10) {
        lpsz = PszGetCompressedString(idsFleet);
      }
      else {
        __fstrcpy((char *)CONCAT22(unaff_SS,szShdef),
                          (char *)CONCAT22(*(undefined2 *)(iPlayer * 4 + 0x100),
                                           (char *)(*(int *)(iPlayer * 4 + 0xfe) + sVar2 * 0x93 + 8)
                                          ));
        cch = _strlen(szShdef);
        if (0x1c < cch) {
          cch = 0x1c;
        }
        if (1 < cshdef) {
          szShdef[cch] = '+';
          szShdef[cch + 1] = '\0';
        }
        lpsz = szShdef;
      }
    }
    _wsprintf(szWork,s__s_s___d_1120_0529,szPlr);
  }
  else {
    _wsprintf(szWork,(char *)0x11200524,szPlr);
  }
  return (char *)szWork;
}



// ======================================================================
// Function: WFromLpfl
// Address: 1038:2b10
// Segment: MEMORY_UTIL
// ======================================================================


ushort WFromLpfl(FLEET *lpfl)

{
  short sVar1;
  short ishdef;
  ushort w;
  short cshdef;
  
  sVar1 = IshdefPrimaryFromLpfl(lpfl,&cshdef);
  w = sVar1 << 9 | lpfl->id & 0x1ffU;
  if (1 < cshdef) {
    w = w | 0x2000;
  }
  return w;
}



// ======================================================================
// Function: PszFleetNameFromWord
// Address: 1038:2b5e
// Segment: MEMORY_UTIL
// ======================================================================


char * PszFleetNameFromWord(ushort w)

{
  uint uVar1;
  undefined2 unaff_SS;
  short cch;
  short ishdef;
  char szShdef [34];
  char *lpsz;
  
  uVar1 = w >> 9 & 0xf;
  if ((*(uint *)(*(int *)(idPlayer * 4 + 0xfe) + uVar1 * 0x93 + 0x7b) >> 9 & 1) == 0) {
    __fstrcpy((char *)CONCAT22(unaff_SS,szShdef),
                      (char *)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x100),
                                       (char *)(*(int *)(idPlayer * 4 + 0xfe) + uVar1 * 0x93
                                               + 8)));
    cch = _strlen(szShdef);
    if (0x1c < cch) {
      cch = 0x1c;
    }
    if ((w & 0x2000) != 0) {
      szShdef[cch] = '+';
      szShdef[cch + 1] = '\0';
    }
    lpsz = szShdef;
  }
  else {
    lpsz = PszGetCompressedString(idsFleet);
    unaff_SS = 0x1120;
  }
  _wsprintf(szWork,(char *)0x11200532,lpsz,unaff_SS,(w & 0x1ff) + 1);
  return (char *)szWork;
}



// ======================================================================
// Function: PszGetPlanetName
// Address: 1038:2c6a
// Segment: MEMORY_UTIL
// ======================================================================


char * PszGetPlanetName(short id)

{
  char *pcVar1;
  char *pcVar2;
  undefined2 uVar3;
  char *psz;
  short fInOrbit;
  
  pcVar1 = PszGetCompressedPlanet(((short *)rgidPlan)[id]);
  if ((id & 0x8000U) == 0) {
    _strcpy((char *)szWork,pcVar1);
  }
  else {
    uVar3 = 0x1120;
    pcVar2 = PszGetCompressedString(idsOrbitingS);
    _wsprintf(szWork,(char *)CONCAT22(0x1120,pcVar2),pcVar1,uVar3);
  }
  return (char *)szWork;
}



// ======================================================================
// Function: IflFromLpfl
// Address: 1038:2ce8
// Segment: MEMORY_UTIL
// ======================================================================


short IflFromLpfl(FLEET *lpfl)

{
  short i;
  
  i = 0;
  while( true ) {
    if (cFleet <= i) {
      return -1;
    }
                    /* WARNING: Load size is inaccurate */
    if ((((FLEET **)rglpfl)[i] == (FLEET *)lpfl) &&
       (*(int *)((int)((FLEET **)rglpfl + i) + 2) == lpfl._2_2_)) break;
    i = i + 1;
  }
  return i;
}



// ======================================================================
// Function: FDeleteFleet
// Address: 1038:2d44
// Segment: MEMORY_UTIL
// ======================================================================


short FDeleteFleet(short idFleet,short grobjSel,short idSel)

{
  uint *puVar1;
  int iVar2;
  short sVar3;
  int iVar4;
  FLEET *pFVar5;
  undefined2 uVar6;
  PLANET *pPVar7;
  PLANET *lppl;
  short idDel;
  short iPlr;
  FLEET *lpfl;
  short i;
  
  for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar5 = ((FLEET **)rglpfl)[i];
    iVar4 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    lpfl = (FLEET *)CONCAT22(iVar4,pFVar5);
    if (((pFVar5 == (FLEET *)0x0) && (iVar4 == 0)) || (lpfl->id == idFleet)) break;
    if (idFleet < lpfl->id) {
      return 0;
    }
  }
  if (i == cFleet) {
    sVar3 = 0;
  }
  else {
    if (idFleet == sel.fl.id) {
      RedrawScanSel(0,0);
    }
    uVar6 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar5 = (FLEET *)lpfl;
    pFVar5->wFlags_0x4 = pFVar5->wFlags_0x4 & 0xfbff | 0x400;
    FleetOrdersChangeTarget(lpfl);
    FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pFVar5->lpplord + 2),
                                  *(PL **)&pFVar5->lpplord));
    if ((*(int *)&pFVar5->lpszName != 0) || (*(int *)((int)&pFVar5->lpszName + 2) != 0)) {
                    /* WARNING: Load size is inaccurate */
      FreeLp((void *)CONCAT22(*(undefined2 *)((int)&pFVar5->lpszName + 2),pFVar5->lpszName),
                     htString);
    }
    cFleet = cFleet + -1;
    iVar4 = pFVar5->iPlayer;
    iVar2 = lpfl->id;
    lppl._2_2_ = *(int *)((int)&rgplr[0].wFlags_0x4 + iVar4 * 0xc0) - 1U & 0xfff;
    puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + iVar4 * 0xc0);
    *puVar1 = *puVar1 & 0xf000;
    puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + iVar4 * 0xc0);
    *puVar1 = *puVar1 | lppl._2_2_;
    if ((grobjSel == 0) && (pFVar5->idPlanet != -1)) {
      pPVar7 = LpplFromId(pFVar5->idPlanet);
      iVar4 = (int)((ulong)pPVar7 >> 0x10);
      if ((((PLANET *)pPVar7 != (PLANET *)0x0) || (iVar4 != 0)) &&
         (((PLANET *)pPVar7)->iPlayer == idPlayer)) {
        grobjSel = 1;
        idSel = pFVar5->idPlanet;
      }
    }
    if (cFleet != i) {
      __fmemmove((FLEET **)CONCAT22(rglpfl._2_2_,(FLEET **)rglpfl + i),
                         (FLEET **)CONCAT22(rglpfl._2_2_,(FLEET **)rglpfl + i + 1),
                         (cFleet - i) * 4);
    }
    FreeLp(lpfl,htFleets);
    gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfbff;
    if (sel.fl.id != -1) {
      if (i < sel.scan.ifl) {
        sel.scan.ifl = sel.scan.ifl + -1;
      }
      else if (iVar2 == sel.fl.id) {
        if (grobjSel == 0) {
          sel.grobj = grobjNone;
          sel.scan.grobj = grobjNone;
          FFindSomethingAndSelectIt();
          return 1;
        }
        sel.grobj = grobjNone;
        if (grobjSel == 2) {
          SelectAdjFleet(0,idSel);
        }
        else {
          SelectAdjPlanet(0,idSel);
        }
      }
    }
    if ((((uint)gd.grBits >> 1 & 1) == 0) && (hwndMessage != 0)) {
      SetMsgTitle(hwndMessage);
    }
    sVar3 = 1;
  }
  return sVar3;
}



// ======================================================================
// Function: LpflNew
// Address: 1038:300c
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: iflPrev */
/* WARNING: Variable defined which should be unmapped: lpfl */

FLEET * LpflNew(short iPlr,short idPl)

{
  uint *puVar1;
  FLEET *pFVar2;
  PL *pPVar3;
  undefined2 uVar4;
  int iVar5;
  undefined2 uVar6;
  FLEET **ppFVar7;
  void *pvVar8;
  PL *pPVar9;
  short iflPrev;
  FLEET *lpfl;
  ORDER *lpord;
  short i;
  
  iflPrev = -1;
  for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar2 = ((FLEET **)rglpfl)[i];
    iVar5 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    lpfl = (FLEET *)CONCAT22(iVar5,pFVar2);
    if ((pFVar2 == (FLEET *)0x0) && (iVar5 == 0)) break;
    if (iPlr <= pFVar2->iPlayer) {
      if ((iPlr < pFVar2->iPlayer) || ((lpfl->id & 0x1ffU) != iflPrev + 1U)) break;
      iflPrev = lpfl->id & 0x1ff;
    }
  }
  rglpfl =
       LpReAlloc((FLEET **)CONCAT22(rglpfl._2_2_,(FLEET **)rglpfl),
                         (cFleet + 1) * 4,htMisc);
  uVar6 = (undefined2)((ulong)rglpfl >> 0x10);
  if (cFleet != i) {
    __fmemmove((FLEET **)CONCAT22(uVar6,(FLEET **)rglpfl + i + 1),
                       (FLEET **)CONCAT22(uVar6,(FLEET **)rglpfl + i),
                       (cFleet - i) * 4);
  }
  pvVar8 = LpAlloc(0x7c,htFleets);
  uVar6 = rglpfl._2_2_;
  ppFVar7 = (FLEET **)rglpfl + i;
  *(void **)ppFVar7 = (void *)pvVar8;
  *(undefined2 *)((int)ppFVar7 + 2) = (int)((ulong)pvVar8 >> 0x10);
  cFleet = cFleet + 1;
  iVar5 = *(int *)((int)&rgplr[0].wFlags_0x4 + iPlr * 0xc0);
  puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + iPlr * 0xc0);
  *puVar1 = *puVar1 & 0xf000;
  puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + iPlr * 0xc0);
  *puVar1 = *puVar1 | iVar5 + 1U & 0xfff;
  __fmemset((void *)0x7c0000,0,0x7c);
  sRam007c0002 = iPlr;
  uRam007c0000 = uRam007c0000 & 0xe000 | 0x7d | (iPlr & 0xfU) << 9;
  sRam007c0006 = idPl;
  if (idPl != -1) {
    sRam007c0008 = ((POINT *)rgptPlan + idPl)->x;
    uRam007c000a = *(undefined2 *)((int)&rgptPlan[0].y + idPl * 4);
  }
  uRam007c0062 = 1;
  uRam007c0004 = uRam007c0004 & 0xfd00 | 7;
  pPVar9 = LpplAlloc(0x12,3,htOrd);
  uRam00000067._2_2_ = (undefined2)((ulong)pPVar9 >> 0x10);
  uRam00000067._0_2_ = (PL *)pPVar9;
  ((PL *)uRam00000067)->iMac = 1;
  uVar4 = uRam00000067._2_2_;
  pPVar3 = (PL *)uRam00000067;
  uVar6 = uRam0000000d;
  uRam00000079 = uRam00000079 & 0xffef;
  lpord = (ORDER *)CONCAT22(uRam00000067._2_2_,(ORDER *)((PL *)uRam00000067 + 1));
  (lpord->pt).x = sRam0000000b;
  *(undefined2 *)&pPVar3[1].iMax = uVar6;
  (pPVar3 + 2)->wFlags = uRam00000009;
  if (uRam00000009 == 0xffff) {
    iVar5 = 4;
  }
  else {
    iVar5 = 1;
  }
  *(uint *)&pPVar3[2].iMax = *(uint *)&pPVar3[2].iMax & 0xf0ff | iVar5 << 8;
  *(uint *)&pPVar3[2].iMax = *(uint *)&pPVar3[2].iMax & 0xff0f;
  *(uint *)&pPVar3[2].iMax = *(uint *)&pPVar3[2].iMax & 0xefff | 0x1000;
  *(uint *)&pPVar3[2].iMax = *(uint *)&pPVar3[2].iMax & 0xfff0;
  if ((sel.scan.ifl != -1) && (i <= sel.scan.ifl)) {
    sel.scan.ifl = sel.scan.ifl + 1;
  }
  gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfbff;
  return (FLEET *)0x3;
}



// ======================================================================
// Function: LpflNewSplit
// Address: 1038:3372
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lpflNew */

FLEET * LpflNewSplit(FLEET *pfl)

{
  byte bVar1;
  int iVar2;
  short sVar3;
  FLEET *pFVar4;
  ushort uVar5;
  undefined2 uVar6;
  FLEET *pFVar7;
  PL *pPVar8;
  FLEET *lpflNew;
  short iordMac;
  
  pFVar7 = LpflNew(pfl->iPlayer,pfl->idPlanet);
  uVar6 = (undefined2)((ulong)pFVar7 >> 0x10);
  pFVar4 = (FLEET *)pFVar7;
  if (pfl->idPlanet == -1) {
    sVar3 = (pfl->pt).y;
    (&pFVar4->pt)->x = (&pfl->pt)->x;
    (pFVar4->pt).y = sVar3;
  }
  pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xfdff | (pfl->wFlags_0x4 >> 9 & 1) << 9;
  pFVar4->wFlags_0x4 = pFVar4->wFlags_0x4 & 0xff00 | pfl->wFlags_0x4 & 0xff;
  pFVar4->iplan = pfl->iplan;
  bVar1 = ((PLORD *)pfl->lpplord)->iordMac;
  if ((uint)((PLORD *)pFVar4->lpplord)->iordMax < (uint)bVar1) {
    pPVar8 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&pFVar4->lpplord + 2),
                                                *(PL **)&pFVar4->lpplord),
                                 (uint)((PLORD *)pfl->lpplord)->iordMax);
    *(PL **)&pFVar4->lpplord = (PL *)pPVar8;
    *(undefined2 *)((int)&pFVar4->lpplord + 2) = (int)((ulong)pPVar8 >> 0x10);
  }
  uVar5 = (uint)bVar1 * 0x12;
  iVar2 = *(int *)((int)&pfl->lpplord + 2);
  __fmemcpy((void *)CONCAT22(*(undefined2 *)(iVar2 + 0x66),
                                     (void *)(*(int *)(iVar2 + 100) + 4)),
                    (void *)CONCAT22(iVar2,(void *)(*(int *)&pfl->lpplord + 4)),uVar5);
  *(byte *)((int)*(undefined4 *)(iVar2 + 100) + 3) = bVar1;
  *(short *)(iVar2 + 0x62) = pfl->cord;
  sVar3 = pfl->id;
  LogSplitFleet(sVar3);
  return (FLEET *)CONCAT22(sVar3,(FLEET *)0x1118);
}



// ======================================================================
// Function: FFleetMergeAll
// Address: 1038:34d8
// Segment: MEMORY_UTIL
// ======================================================================


short FFleetMergeAll(FLEET *pfl)

{
  uint *puVar1;
  uint uVar2;
  uint uVar3;
  uint uVar4;
  int iVar5;
  int iVar6;
  ulong uVar7;
  long lVar8;
  int iVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  short j;
  uint rgdp [32];
  FLEET *lpflMerge;
  undefined2 local_3c;
  int lpshdef;
  undefined2 local_38;
  short cshT;
  FLEET *lpfl;
  short i;
  short cflMerge;
  int rgcshDamaged [16];
  short fCshOverflow;
  undefined4 dpT;
  short iplr;
  
  lpflMerge = (FLEET *)0x0;
  local_3c = 0;
  cflMerge = 0;
  fCshOverflow = 0;
  _memset(rgdp,0,0x40);
  _memset(rgcshDamaged,0,0x20);
  iplr = pfl->iPlayer;
  for (i = 0; i < vcflMerge; i = i + 1) {
    if (vrgiflMerge[i] != -1) {
      lpfl = LpflFromId(vrgiflMerge[i]);
      if (((FLEET *)lpfl != (FLEET *)0x0) || ((int)((ulong)lpfl >> 0x10) != 0)) {
        lpshdef = *(int *)(iplr * 4 + 0xfe);
        local_38 = *(undefined2 *)(iplr * 4 + 0x100);
        j = 0;
        while( true ) {
          if (0xf < j) break;
          if (((FLEET *)lpfl)->rgcsh[j] != 0) {
            if (((FLEET *)lpfl)->rgcsh[j + 0x10] != 0) {
              uVar11 = 0;
              uVar10 = 100;
              uVar7 = __aFulmul((long)((FLEET *)lpfl)->rgcsh[j],
                                        (ulong)(((FLEET *)lpfl)->rgcsh[j + 0x10] & 0x7f));
              lVar8 = __aFldiv(uVar7,CONCAT22(uVar11,uVar10));
              cshT = (int)lVar8;
              if ((int)lVar8 == 0) {
                cshT = 1;
              }
              rgcshDamaged[j] = rgcshDamaged[j] + cshT;
              uVar7 = __aFulmul((ulong)((uint)((FLEET *)lpfl)->rgcsh[j + 0x10] >> 7),
                                        (long)cshT);
              dpT = uVar7;
              puVar1 = rgdp + j * 2;
              uVar2 = *puVar1;
              *puVar1 = *puVar1 + (uint)uVar7;
              rgdp[j * 2 + 1] =
                   rgdp[j * 2 + 1] + (int)(uVar7 >> 0x10) + (uint)CARRY2(uVar2,(uint)uVar7);
            }
            if ((lpfl->id & 0x1ffU) != (pfl->id & 0x1ffU)) {
              pfl->rgcsh[j] = pfl->rgcsh[j] + ((FLEET *)lpfl)->rgcsh[j];
              if (pfl->rgcsh[j] < 0) {
                pfl->rgcsh[j] = 0x7ffe;
              }
              ((FLEET *)lpfl)->rgcsh[j] = 0;
            }
          }
          j = j + 1;
          lpshdef = lpshdef + 0x93;
        }
        if ((lpfl->id & 0x1ffU) == (pfl->id & 0x1ffU)) {
          lpflMerge = (FLEET *)lpfl;
          local_3c = lpfl._2_2_;
        }
        else {
          for (j = 0; j < 5; j = j + 1) {
            uVar3 = *(uint *)(((FLEET *)lpfl)->rgwtMin + j);
            uVar4 = *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + j) + 2);
            puVar1 = (uint *)(pfl->rgwtMin + j);
            uVar2 = *puVar1;
            *puVar1 = *puVar1 + uVar3;
            puVar1 = (uint *)((int)(pfl->rgwtMin + j) + 2);
            *puVar1 = *puVar1 + uVar4 + (uint)CARRY2(uVar2,uVar3);
          }
          FDeleteFleet(lpfl->id,0,-1);
          cflMerge = cflMerge + 1;
        }
      }
    }
  }
  lpshdef = *(int *)(iplr * 4 + 0xfe);
  local_38 = *(undefined2 *)(iplr * 4 + 0x100);
  for (j = 0; j < 0x10; j = j + 1) {
    lpflMerge->rgcsh[j] = pfl->rgcsh[j];
    if ((rgcshDamaged[j] == 0) || (lpflMerge->rgcsh[j] == 0)) {
      lpflMerge->rgcsh[j + 0x10] = 0;
    }
    else {
      iVar9 = lpflMerge->rgcsh[j];
      iVar6 = iVar9 >> 0xf;
      iVar5 = lpflMerge->rgcsh[j];
      uVar7 = __aFulmul((long)rgcshDamaged[j],100);
      lVar8 = __aFldiv(uVar7 + (long)(iVar5 + -1),CONCAT22(iVar6,iVar9));
      lpflMerge->rgcsh[j + 0x10] = lpflMerge->rgcsh[j + 0x10] & 0xff80U | (uint)lVar8 & 0x7f;
      lVar8 = __aFldiv(CONCAT22(rgdp[j * 2 + 1],rgdp[j * 2]),(long)rgcshDamaged[j]);
      lpflMerge->rgcsh[j + 0x10] = lpflMerge->rgcsh[j + 0x10] & 0x7fU | (int)lVar8 << 7;
    }
    lpshdef = lpshdef + 0x93;
  }
  for (j = 0; j < 5; j = j + 1) {
    uVar10 = *(undefined2 *)((int)(pfl->rgwtMin + j) + 2);
    *(int *)(lpflMerge->rgwtMin + j) = (int)pfl->rgwtMin[j];
    *(undefined2 *)((int)(lpflMerge->rgwtMin + j) + 2) = uVar10;
  }
  LogMergeFleet(pfl->id);
  InvalidateReport(1,2);
  return (uint)(cflMerge != 0);
}



// ======================================================================
// Function: FFleetSplitAll
// Address: 1038:3a00
// Segment: MEMORY_UTIL
// ======================================================================


short FFleetSplitAll(FLEET *pfl)

{
  int iVar1;
  FLEET *pFVar2;
  FLEET *pFVar3;
  FLEET *pFVar4;
  int iVar5;
  FLEET *pFVar6;
  undefined2 unaff_SS;
  bool bVar7;
  FLEET *pFVar8;
  short i;
  short c;
  short cSplit;
  FLEET flNew;
  
  cSplit = 0;
  for (i = 0; i < 0x10; i = i + 1) {
    c = pfl->rgcsh[i];
    while (iVar5 = c + -1, c != 0) {
      iVar1 = cSplit + 1;
      bVar7 = cSplit != 0;
      c = iVar5;
      cSplit = iVar1;
      if (bVar7) {
        pFVar8 = LpflNewSplit(pfl);
        pFVar4 = (FLEET *)pFVar8;
        pFVar6 = &flNew;
        for (iVar5 = 0x3e; iVar5 != 0; iVar5 = iVar5 + -1) {
          pFVar3 = pFVar6;
          pFVar6 = (FLEET *)&pFVar6->iPlayer;
          pFVar2 = pFVar4;
          pFVar4 = (FLEET *)&pFVar4->iPlayer;
          pFVar3->id = pFVar2->id;
        }
        pfl->rgcsh[i] = pfl->rgcsh[i] + -1;
        flNew.rgcsh[i] = flNew.rgcsh[i] + 1;
        FleetTransferCargoBalance(pfl,&flNew);
        FLookupFleet(-1,pfl);
        FLookupFleet(-1,&flNew);
      }
    }
  }
  InvalidateReport(1,2);
  return (uint)(1 < cSplit);
}



// ======================================================================
// Function: PszGetLocName
// Address: 1038:3b08
// Segment: MEMORY_UTIL
// ======================================================================


char * PszGetLocName(GrobjClass grobj,short id,short x,short y)

{
  char *pcVar1;
  
  if (id != -1) {
    if (grobj == grobjPlanet) {
      pcVar1 = PszGetPlanetName(id);
      return pcVar1;
    }
    if (grobj == grobjFleet) {
      pcVar1 = PszGetFleetName(id);
      return pcVar1;
    }
    if (grobj == grobjThing) {
      pcVar1 = PszGetThingName(id);
      return pcVar1;
    }
  }
  if ((x == -1) && (y == -1)) {
    pcVar1 = PszGetCompressedString(idsDeepSpace);
    _strcpy((char *)szWork,pcVar1);
  }
  else {
    pcVar1 = PszGetCompressedString(idsSpaceDD);
    _wsprintf(szWork,(char *)CONCAT22(0x1120,pcVar1),x,y);
  }
  return (char *)szWork;
}



// ======================================================================
// Function: CchGetETA
// Address: 1038:3bc8
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: ids */

short CchGetETA(HDC hdc,FLEET *lpfl,char *sz,short iwp,short fSmall)

{
  POINT ptSrc;
  POINT ptDst;
  uint uVar1;
  short sVar2;
  StringId ids_00;
  char *pcVar3;
  int iVar4;
  ORDER *pOVar5;
  short unaff_SI;
  short unaff_DI;
  undefined2 uVar6;
  long lVar7;
  short ids;
  short cYears;
  short j;
  short iSpeed;
  short c;
  short i;
  ORDER *lpord;
  double dbl;
  short iWarp;
  
  cYears = 0;
  uVar6 = (undefined2)((ulong)lpfl >> 0x10);
  lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2),
                            (ORDER *)(*(int *)&((FLEET *)lpfl)->lpplord + 4));
  i = 0;
  while( true ) {
    if (iwp <= i) {
      if (fSmall == 0) {
        ids_00 = idsDYear;
      }
      else {
        ids_00 = idsDy;
      }
      sVar2 = cYears;
      pcVar3 = PszGetCompressedString(ids_00);
      iVar4 = _wsprintf((char *)CONCAT22(0x1120,sz),(char *)CONCAT22(0x1120,pcVar3),sVar2);
      if ((cYears != 1) && (fSmall == 0)) {
        sz[iVar4] = 's';
        iVar4 = iVar4 + 1;
      }
      return iVar4;
    }
    uVar6 = (undefined2)((ulong)lpord >> 0x10);
    pOVar5 = (ORDER *)lpord;
    DGetDistance((double *)CONCAT22((pOVar5->pt).y,(double *)(lpord->pt).x),((pOVar5 + 1)->pt).x,
                 pOVar5[1].pt.y,unaff_DI,unaff_SI);
    uVar1 = pOVar5[1].wFlags_0x6 >> 4 & 0xf;
    if (uVar1 < 0xb) {
      iSpeed = uVar1 * uVar1;
    }
    else {
      ptSrc.y = (pOVar5->pt).y;
      ptSrc.x = (lpord->pt).x;
      ptDst.y = pOVar5[1].pt.y;
      ptDst.x = ((pOVar5 + 1)->pt).x;
      uVar1 = FCanFleetUseStargates(lpfl,ptSrc,ptDst);
      if (uVar1 == 0xffff) {
        iSpeed = -3;
      }
      else if (uVar1 == 0) {
        iSpeed = 0;
      }
      else if (uVar1 == 1) {
        iSpeed = (int)(char *)s_R6008___not_enough_space_for_arg_1120_1f2d + 0x13;
      }
      else if ((uVar1 & 2) == 0) {
        iSpeed = -2;
      }
      else {
        iSpeed = -1;
      }
    }
    if (iSpeed == 0) break;
    if (iSpeed < 0) {
      if (hdc != 0) {
        SetTextColor(hdc,0x7f7f);
      }
      if (iSpeed == -1) {
        ids = 0x335;
      }
      else if (iSpeed == -2) {
        ids = 0x336;
      }
      else {
        ids = 0x337;
      }
      sVar2 = CchGetString(ids,sz);
      return sVar2;
    }
    lVar7 = __ftol((double)CONCAT26(cYears,CONCAT24(ids,CONCAT22(unaff_SI,unaff_DI))));
    if (iSpeed < (int)lVar7) {
      lVar7 = __ftol((double)CONCAT26(cYears,CONCAT24(ids,CONCAT22(unaff_SI,unaff_DI))));
      iSpeed = ((int)lVar7 + iSpeed + -1) / iSpeed;
    }
    else {
      iSpeed = 1;
    }
    cYears = cYears + iSpeed;
    i = i + 1;
    lpord = (ORDER *)CONCAT22(uVar6,pOVar5 + 1);
  }
  if (hdc != 0) {
    SetTextColor(hdc,0xff);
  }
  sVar2 = CchGetString(idsNever,sz);
  return sVar2;
}



// ======================================================================
// Function: IshdefPrimaryFromLpfl
// Address: 1038:3e1c
// Segment: MEMORY_UTIL
// ======================================================================


short IshdefPrimaryFromLpfl(FLEET *lpfl,short *pcDiff)

{
  int iVar1;
  short ihul;
  short csh;
  short i;
  short ish;
  short cDiff;
  
  cDiff = 0;
  csh = 0;
  ish = 0x10;
  for (i = 0; i < 0x10; i = i + 1) {
    if ((0 < ((FLEET *)lpfl)->rgcsh[i]) && (cDiff = cDiff + 1, csh < ((FLEET *)lpfl)->rgcsh[i])) {
      ish = i;
      csh = ((FLEET *)lpfl)->rgcsh[i];
      iVar1 = ((FLEET *)lpfl)->iPlayer * 4;
      iVar1 = *(int *)(*(int *)(iVar1 + 0xfe) + i * 0x93);
      if ((iVar1 == 0x19) || (iVar1 == 0x1a)) {
        csh = csh + -1;
      }
    }
  }
  if (pcDiff != (short *)0x0) {
    *pcDiff = cDiff;
  }
  return ish;
}



// ======================================================================
// Function: PszGetDistance
// Address: 1038:3f00
// Segment: MEMORY_UTIL
// ======================================================================


char * PszGetDistance(short x1,short y1,short x2,short y2)

{
  char *pcVar1;
  short unaff_SI;
  short unaff_DI;
  long lVar2;
  ulong uVar3;
  ulong uVar4;
  undefined2 in_stack_0000fff2;
  undefined2 in_stack_0000fff4;
  short fStarted;
  
  DGetDistance((double *)CONCAT22(y1,x1),x2,y2,unaff_DI,unaff_SI);
  lVar2 = __ftol((double)CONCAT26(in_stack_0000fff4,
                                          CONCAT24(in_stack_0000fff2,CONCAT22(unaff_SI,unaff_DI))));
  uVar3 = __aFldiv(lVar2,100);
  uVar4 = __aFulmul(uVar3,100);
  lVar2 = lVar2 - uVar4;
  if (dyArial8 < 0xf) {
    pcVar1 = PszGetCompressedString(idsLdLdLightYears);
    _wsprintf(szWork,(char *)CONCAT22(0x1120,pcVar1),uVar3,lVar2);
  }
  else {
    pcVar1 = PszGetCompressedString(idsLdLdLY);
    _wsprintf(szWork,(char *)CONCAT22(0x1120,pcVar1),uVar3,lVar2);
  }
  return (char *)szWork;
}



// ======================================================================
// Function: DGetDistance
// Address: 1038:3fe4
// Segment: MEMORY_UTIL
// ======================================================================


double * DGetDistance(double *__return_storage_ptr__,short x1,short y1,short x2,short y2)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar1;
  ulong uVar2;
  double *pdVar3;
  long l;
  
  uVar1 = __aFulmul((long)(y1 - __return_storage_ptr__._2_2_),
                            (long)(y1 - __return_storage_ptr__._2_2_));
  uVar2 = __aFulmul((long)(x1 - (int)(double *)__return_storage_ptr__),
                            (long)(x1 - (int)(double *)__return_storage_ptr__));
  pdVar3 = _sqrt(SUB84((double)(long)(uVar2 + uVar1),0),
                         (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)(long)(
                                                  uVar2 + uVar1) >> 0x20))));
  DOUBLE_0_0__1120_1706 = *(double *)pdVar3;
  return (double *)CONCAT22((int)((ulong)pdVar3 >> 0x10),(double *)&DOUBLE_0_0__1120_1706);
}



// ======================================================================
// Function: FFindNearestObject
// Address: 1038:4070
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10384625) */
/* WARNING: Removing unreachable block (ram,0x103845f3) */
/* WARNING: Removing unreachable block (ram,0x10384470) */
/* WARNING: Removing unreachable block (ram,0x1038443e) */
/* WARNING: Removing unreachable block (ram,0x103842cc) */
/* WARNING: Removing unreachable block (ram,0x1038429a) */
/* WARNING: Removing unreachable block (ram,0x10384171) */
/* WARNING: Removing unreachable block (ram,0x103841a3) */
/* WARNING: Removing unreachable block (ram,0x10384389) */
/* WARNING: Removing unreachable block (ram,0x1038450f) */
/* WARNING: Removing unreachable block (ram,0x103846af) */

short FFindNearestObject(POINT pt,GrobjClass grobj,SCAN *pscan)

{
  short *psVar1;
  SCAN *pSVar2;
  ulong uVar3;
  short sVar4;
  int iVar5;
  FLEET *pFVar6;
  int *piVar7;
  short *psVar8;
  undefined2 uVar9;
  ulong uVar10;
  POINT pt_00;
  short scan;
  short local_44;
  uint local_42;
  uint local_40;
  short local_3e;
  int local_3c;
  short local_3a;
  int local_38;
  short dx;
  short iNearest;
  undefined1 scanT [6];
  uint local_2c;
  int local_2a;
  int local_28;
  int local_26;
  int local_24;
  undefined4 lSquare;
  THING *lpthMac;
  undefined2 local_1c;
  short i;
  FLEET *lpfl;
  THING *lpth;
  undefined4 lTry;
  short dy;
  POINT *ppt;
  int ptWp;
  int local_6;
  
  iNearest = -1;
  lSquare._0_2_ = 0xca00;
  lSquare._2_2_ = 0x3b9a;
  lSquare = 1000000000;
  ppt = (POINT *)rgptPlan;
  local_40 = 0;
  local_42 = 0;
  local_44 = 0;
  scan = 0;
  local_38 = -1;
  local_3a = -1;
  local_3c = -1;
  local_3e = -1;
  if ((grobj & 0x40) == grobjNone) {
    if ((grobj & 0x80) != grobjNone) {
      lSquare._0_2_ = 0;
      lSquare._2_2_ = 0;
      lSquare = 0;
    }
  }
  else {
    lSquare._0_2_ = ScanToPt(0x14);
    lSquare._2_2_ = (short)lSquare >> 0xf;
    lSquare = __aFulmul((long)(short)lSquare,(long)(short)lSquare);
  }
  uVar10 = CONCAT22(lTry._2_2_,(undefined2)lTry);
  if ((grobj & grobjPlanet) != grobjNone) {
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      dx = pt.x - ppt->x;
      dy = pt.y - ppt->y;
      lTry = uVar10;
      uVar10 = __aFulmul((long)dx,(long)dx);
      lTry = uVar10;
      if ((long)uVar10 <= (long)lSquare) {
        uVar10 = __aFulmul((long)dy,(long)dy);
        uVar10 = uVar10 + lTry;
        lTry = uVar10;
        if (((long)uVar10 <= (long)lSquare) && ((lSquare != uVar10 || (lSquare == 0)))) {
          lSquare = uVar10;
          scan = ppt->x;
          local_44 = ppt->y;
          local_3e = i;
          local_40 = 1;
          local_42 = 1;
        }
      }
      ppt = ppt + 1;
    }
  }
  if ((grobj & grobjFleet) != grobjNone) {
    for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar6 = ((FLEET **)rglpfl)[i];
      iVar5 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpfl = (FLEET *)CONCAT22(iVar5,pFVar6);
      if ((pFVar6 == (FLEET *)0x0) && (iVar5 == 0)) break;
      dx = pt.x - (&pFVar6->pt)->x;
      dy = pt.y - (pFVar6->pt).y;
      lTry = uVar10;
      uVar10 = __aFulmul((long)dx,(long)dx);
      lTry = uVar10;
      if ((long)uVar10 <= (long)lSquare) {
        uVar10 = __aFulmul((long)dy,(long)dy);
        uVar10 = uVar10 + lTry;
        lTry = uVar10;
        if ((long)uVar10 <= (long)lSquare) {
          pFVar6 = (FLEET *)lpfl;
          uVar9 = (undefined2)((ulong)lpfl >> 0x10);
          if (((lSquare == uVar10) && ((local_42 & 1) == 0)) ||
             (((&pFVar6->pt)->x == scan && ((pFVar6->pt).y == local_44)))) {
            if (((local_40 & 2) == 0) ||
               ((((FLEET *)((FLEET **)rglpfl)[local_3c])->iPlayer != idPlayer &&
                (pFVar6->iPlayer == idPlayer)))) {
              local_3c = i;
              local_40 = local_40 | 2;
              if (local_42 == 0) goto UTIL_SelectShip;
            }
          }
          else if ((long)uVar10 < (long)lSquare) {
            lSquare = uVar10;
UTIL_SelectShip:
            scan = (&pFVar6->pt)->x;
            local_44 = (pFVar6->pt).y;
            local_3c = i;
            local_3e = -1;
            local_40 = 2;
            local_42 = 2;
          }
        }
      }
    }
  }
  if ((grobj & grobjThing) != grobjNone) {
    lpthMac = (THING *)lpThings + cThing;
    local_1c = lpThings._2_2_;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < lpthMac) {
      uVar9 = (undefined2)((ulong)lpth >> 0x10);
      dx = pt.x - (&((THING *)lpth)->pt)->x;
      dy = pt.y - (((THING *)lpth)->pt).y;
      lTry = uVar10;
      uVar10 = __aFulmul((long)dx,(long)dx);
      lTry = uVar10;
      if ((long)uVar10 <= (long)lSquare) {
        uVar10 = __aFulmul((long)dy,(long)dy);
        uVar10 = uVar10 + lTry;
        lTry = uVar10;
        if ((long)uVar10 <= (long)lSquare) {
          uVar9 = (undefined2)((ulong)lpth >> 0x10);
          if (((lSquare == uVar10) && ((local_42 & 3) == 0)) ||
             (((&((THING *)lpth)->pt)->x == scan && ((((THING *)lpth)->pt).y == local_44)))) {
            if ((local_40 & 8) == 0) {
              local_38 = ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12;
              local_40 = local_40 | 8;
              if (local_42 == 0) goto UTIL_SelectThing;
            }
          }
          else if ((long)uVar10 < (long)lSquare) {
            lSquare = uVar10;
UTIL_SelectThing:
            scan = (&((THING *)lpth)->pt)->x;
            local_44 = (((THING *)lpth)->pt).y;
            local_38 = ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12;
            local_3e = -1;
            local_3c = -1;
            local_40 = 8;
            local_42 = 8;
          }
        }
      }
      lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
    }
  }
  if (((grobj & grobjOther) != grobjNone) && (sel.grobj == grobjFleet)) {
    for (i = sel.fl.cord + -1; -1 < i; i = i + -1) {
      piVar7 = (int *)((int)(PLORD *)sel.fl.lpplord + i * 0x12 + 4);
      ptWp = *piVar7;
      local_6 = piVar7[1];
      dx = pt.x - ptWp;
      dy = pt.y - local_6;
      lTry = uVar10;
      uVar10 = __aFulmul((long)dx,(long)dx);
      lTry = uVar10;
      if ((long)uVar10 <= (long)lSquare) {
        uVar10 = __aFulmul((long)dy,(long)dy);
        uVar10 = uVar10 + lTry;
        lTry = uVar10;
        if ((long)uVar10 <= (long)lSquare) {
          if (((lSquare == uVar10) && ((local_42 & 0xb) == 0)) ||
             ((ptWp == scan && (local_6 == local_44)))) {
            if (((local_40 & 4) == 0) || (i == sel.scan.iwp)) {
              local_3a = i;
              local_40 = local_40 | 4;
              if (local_42 == 0) goto UTIL_SelectSpace;
            }
          }
          else if ((long)uVar10 < (long)lSquare) {
            lSquare = uVar10;
UTIL_SelectSpace:
            scan = ptWp;
            local_44 = local_6;
            local_3a = i;
            local_38 = -1;
            local_3e = -1;
            local_3c = -1;
            local_40 = 4;
            local_42 = 4;
          }
        }
      }
    }
  }
  if (((grobj & 0x20) == grobjNone) && (local_42 != 0)) {
    uVar3 = CONCAT22(scanT,grobj) & 0xffff000f;
    pt_00.y = local_44;
    pt_00.x = scan;
    lTry = uVar10;
    sVar4 = FFindNearestObject(pt_00,(GrobjClass)uVar3 ^
                                     (grobjThing|grobjOther|grobjFleet|grobjPlanet) | 0xa0,
                               (SCAN *)(uVar3 >> 0x10));
    if (sVar4 != 0) {
      if (local_2a != -1) {
        local_3e = local_2a;
      }
      if (local_28 != -1) {
        local_3c = local_28;
      }
      if (local_26 != -1) {
        local_3a = local_26;
      }
      if (local_24 != -1) {
        local_38 = local_24;
      }
      local_40 = local_40 | local_2c;
    }
  }
  if (pscan != (SCAN *)0x0) {
    psVar8 = &scan;
    for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
      pSVar2 = pscan;
      pscan = (SCAN *)&(pscan->pt).y;
      psVar1 = psVar8;
      psVar8 = psVar8 + 1;
      (pSVar2->pt).x = *psVar1;
    }
  }
  return (uint)(local_42 != 0);
}



// ======================================================================
// Function: UpdateShdefCost
// Address: 1038:47b0
// Segment: MEMORY_UTIL
// ======================================================================


void UpdateShdefCost(SHDEF *lpshdef)

{
  uint *puVar1;
  HullSlotType HVar2;
  short sVar3;
  uint uVar4;
  uint uVar5;
  SHDEF *pSVar6;
  HUL *pHVar7;
  undefined2 uVar8;
  undefined2 uVar9;
  bool bVar10;
  PART part;
  ushort rgMin [6];
  uint resCost;
  int local_1e;
  HUL *lphul;
  short fWeakArmor;
  ushort rgCosts [3];
  uint local_10;
  short c;
  short k;
  ushort wt;
  int local_8;
  short dpT;
  
  uVar8 = (undefined2)((ulong)lpshdef >> 0x10);
  pSVar6 = (SHDEF *)lpshdef;
  if ((pSVar6->wFlags & 0xff) == 7) {
    sVar3 = GetRaceGrbit((PLAYER *)rgplr + idPlayer,
                               ibitRaceRegeneratingShields);
    fWeakArmor = (short)(sVar3 != 0);
  }
  else {
    fWeakArmor = 0;
  }
  part.u_PART_0x0004.parmor = (ARMOR *)LphuldefFromId((lpshdef->hul).ihuldef);
  part.hs.grhst =
       ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
         hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine);
  lphul = (HUL *)part.u_PART_0x0004.parmor;
  GetTruePartCost(idPlayer,&part,rgCosts);
  for (c = 0; sVar3 = c, c < 3; c = c + 1) {
    rgMin[c * 2] = rgCosts[c];
    rgMin[sVar3 * 2 + 1] = 0;
  }
  resCost = local_10;
  local_1e = 0;
  uVar9 = (undefined2)((ulong)lphul >> 0x10);
  wt = ((HUL *)lphul)->wtEmpty;
  local_8 = 0;
  (pSVar6->hul).dp = ((HUL *)lphul)->dp;
  lphul = &lpshdef->hul;
  c = 0;
  while( true ) {
    uVar9 = (undefined2)((ulong)lphul >> 0x10);
    pHVar7 = (HUL *)lphul;
    if ((int)(uint)pHVar7->chs <= c) break;
    if (pHVar7->rghs[c].wFlags_0x2 >> 8 != 0) {
      part.hs.grhst = (pHVar7->rghs + c)->grhst;
      part.hs.wFlags_0x2 = pHVar7->rghs[c].wFlags_0x2;
      FLookupPart(&part);
      GetTruePartCost(idPlayer,&part,rgCosts);
      k = 0;
      while( true ) {
        sVar3 = k;
        if (2 < k) break;
        uVar4 = (((HUL *)lphul)->rghs[c].wFlags_0x2 >> 8) * rgCosts[k];
        puVar1 = rgMin + k * 2;
        uVar5 = *puVar1;
        *puVar1 = *puVar1 + uVar4;
        rgMin[sVar3 * 2 + 1] = rgMin[sVar3 * 2 + 1] + (uint)CARRY2(uVar5,uVar4);
        k = k + 1;
      }
      uVar5 = (((HUL *)lphul)->rghs[c].wFlags_0x2 >> 8) * local_10;
      bVar10 = CARRY2(resCost,uVar5);
      resCost = resCost + uVar5;
      local_1e = local_1e + (uint)bVar10;
      uVar5 = (((HUL *)lphul)->rghs[c].wFlags_0x2 >> 8) *
              (((HULDEF *)part.u_PART_0x0004.parmor)->hul).wtEmpty;
      bVar10 = CARRY2(wt,uVar5);
      wt = wt + uVar5;
      local_8 = local_8 + (uint)bVar10;
      HVar2 = (((HUL *)lphul)->rghs + c)->grhst;
      if (HVar2 == hstShield) {
        if (((((HUL *)lphul)->rghs[c].wFlags_0x2 & 0xff) == 3) ||
           ((((HUL *)lphul)->rghs[c].wFlags_0x2 & 0xff) == 6)) {
          ((HUL *)lphul)->dp = ((HUL *)lphul)->dp + (((HUL *)lphul)->rghs[c].wFlags_0x2 >> 8) * 0x41
          ;
        }
      }
      else if (HVar2 == hstArmor) {
        dpT = (((HUL *)lphul)->rghs[c].wFlags_0x2 >> 8) *
              (((HULDEF *)part.u_PART_0x0004.parmor)->hul).wtCargoMax;
        if (fWeakArmor != 0) {
          dpT = dpT >> 1;
        }
        ((HUL *)lphul)->dp = ((HUL *)lphul)->dp + dpT;
      }
      else if ((HVar2 == hstSpecialM) && ((((HUL *)lphul)->rghs[c].wFlags_0x2 & 0xff) == 4)) {
        ((HUL *)lphul)->dp = ((HUL *)lphul)->dp + (((HUL *)lphul)->rghs[c].wFlags_0x2 >> 8) * 0x32;
      }
    }
    c = c + 1;
  }
  for (c = 0; c < 3; c = c + 1) {
    pHVar7->rgwtOreCost[c] = rgMin[c * 2];
  }
  pHVar7->resCost = resCost;
  pHVar7->wtEmpty = wt;
  *(undefined2 *)&pSVar6->u_SHDEF_0x0087 = 0xffff;
  *(undefined2 *)((int)&pSVar6->u_SHDEF_0x0087 + 2) = 0xffff;
  return;
}



// ======================================================================
// Function: WPackLong
// Address: 1038:4ba2
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: exp */

ushort WPackLong(long l)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar1;
  ushort exp;
  
  uVar1 = CONCAT22(unaff_SI,unaff_DI);
  exp = 0;
  while( true ) {
    if (((l & 0xe000U) == 0) && (l._2_2_ == 0)) break;
    l = __aFulshr(uVar1,exp);
    exp = exp + 1;
  }
  return exp << 0xd | (uint)l;
}



// ======================================================================
// Function: GetPlanetScannerRange
// Address: 1038:4c02
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10384d73) */

short GetPlanetScannerRange(PLANET *lppl,short *pDeep)

{
  short sVar1;
  short sVar2;
  short sVar3;
  PLANET *pPVar4;
  int iVar5;
  ARMOR *pAVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar7;
  long lVar8;
  ulong uVar9;
  ushort in_stack_0000ffe8;
  HS in_stack_0000fff0;
  u_PART_0x0004 in_stack_0000fff4;
  short dRange;
  short iPlrSav;
  
  sVar1 = idPlayer;
  uVar7 = (undefined2)((ulong)lppl >> 0x10);
  pPVar4 = (PLANET *)lppl;
  idPlayer = pPVar4->iPlayer;
  if (pDeep != (short *)0x0) {
    *pDeep = 0;
  }
  sVar2 = GetRaceStat((PLAYER *)rgplr + pPVar4->iPlayer,rsMajorAdv);
  if (sVar2 == raMacintosh) {
    uVar9 = __aFulmul(CONCAT22(*(undefined2 *)((int)pPVar4->rgwtMin + 0xe),
                                       (int)pPVar4->rgwtMin[3]),10);
    _sqrt(SUB84((double)(long)uVar9,0),
                  (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)(long)uVar9 >>
                                                                    0x20))));
    lVar8 = __ftol((double)CONCAT44(in_stack_0000fff4.parmor,in_stack_0000fff0));
    sVar3 = (short)lVar8;
    sVar2 = GetRaceGrbit((PLAYER *)rgplr + idPlayer,ibitRaceNoAdvScanner);
    if (sVar2 == 0) {
      if (((pDeep != (short *)0x0) && ((pPVar4->wFlags_0x4 >> 9 & 1) != 0)) &&
         (iVar5 = pPVar4->iPlayer * 4,
         0x22 < *(int *)(*(int *)(iVar5 + 0x14c) + (*(uint *)&pPVar4->lStarbase & 0xf) * 0x93))) {
        *pDeep = sVar3 / 2;
      }
    }
    else {
      lVar8 = 1000;
      uVar9 = __aFulmul((long)sVar3,0x584);
      lVar8 = __aFldiv(uVar9,lVar8);
      sVar3 = (short)lVar8;
      if (pDeep != (short *)0x0) {
        *pDeep = 0;
      }
    }
  }
  else {
    uVar9 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffe8);
    if (((uint)uVar9 & 0x1f) == 0x1f) {
      sVar3 = 0;
    }
    else {
      LookupBestPlanetaryScanner((PART *)&stack0xfff0);
      pAVar6 = (ARMOR *)in_stack_0000fff4.parmor;
      uVar7 = in_stack_0000fff4._2_2_;
      if ((pDeep != (short *)0x0) && (pAVar6->dp < 0)) {
        *pDeep = -pAVar6->dp >> 1;
      }
      sVar3 = _abs(pAVar6->dp);
      sVar2 = GetRaceGrbit((PLAYER *)rgplr + idPlayer,ibitRaceNoAdvScanner);
      if (sVar2 != 0) {
        sVar3 = sVar3 << 1;
      }
    }
  }
  idPlayer = sVar1;
  return sVar3;
}



// ======================================================================
// Function: GetCachedFleetScannerRange
// Address: 1038:4e02
// Segment: MEMORY_UTIL
// ======================================================================


short GetCachedFleetScannerRange(FLEET *lpfl,short *pdPlanRange,short *ppctDetect,short *piSteal)

{
  int iVar1;
  int iVar2;
  short sVar3;
  undefined2 uVar4;
  short pctDetect;
  short iSteal;
  short dRange;
  short iPlr;
  short i;
  short dPlanRange;
  short dT;
  
  uVar4 = (undefined2)((ulong)lpfl >> 0x10);
  iVar1 = ((FLEET *)lpfl)->iPlayer;
  dRange = -1;
  dPlanRange = 0;
  iSteal = 0;
  pctDetect = 100;
  if (((uint)gd.grBits >> 1 & 1) == 0) {
    dRange = GetFleetScannerRange(lpfl,pdPlanRange,ppctDetect,piSteal);
  }
  else {
    for (i = 0; i < 0x10; i = i + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
        iVar2 = *(int *)(*(int *)(iVar1 * 4 + 0xfe) + i * 0x93 + 0x8d);
        sVar3 = dRange;
        if ((iVar2 != 0x7ff) && (sVar3 = iVar2, iVar2 <= dRange)) {
          sVar3 = dRange;
        }
        dRange = sVar3;
        if (dPlanRange < *(int *)(*(int *)(iVar1 * 4 + 0xfe) + i * 0x93 + 0x8f)) {
          dPlanRange = *(short *)(*(int *)(iVar1 * 4 + 0xfe) + i * 0x93 + 0x8f);
        }
        if ((uint)*(byte *)(*(int *)(iVar1 * 4 + 0xfe) + i * 0x93 + 0x91) < (uint)pctDetect) {
          pctDetect = (short)*(byte *)(*(int *)(iVar1 * 4 + 0xfe) + i * 0x93 + 0x91);
        }
        iSteal = iSteal | (uint)*(byte *)(*(int *)(iVar1 * 4 + 0xfe) + i * 0x93 + 0x92);
      }
    }
    if (pdPlanRange != (short *)0x0) {
      *pdPlanRange = dPlanRange;
    }
    if (ppctDetect != (short *)0x0) {
      *ppctDetect = pctDetect;
    }
    if (piSteal != (short *)0x0) {
      *piSteal = iSteal;
    }
  }
  return dRange;
}



// ======================================================================
// Function: GetFleetScannerRange
// Address: 1038:4fb8
// Segment: MEMORY_UTIL
// ======================================================================


short GetFleetScannerRange(FLEET *lpfl,short *pdPlanRange,short *ppctDetect,short *piSteal)

{
  short sVar1;
  undefined2 uVar2;
  short pctDetect;
  short dRangeBest;
  short dPlanRangeBest;
  short iSteal;
  short dRange;
  short i;
  short dPlanRange;
  short iplr;
  
  uVar2 = (undefined2)((ulong)lpfl >> 0x10);
  iplr = ((FLEET *)lpfl)->iPlayer;
  dRange = -1;
  dPlanRange = 0;
  iSteal = 0;
  if (ppctDetect != (short *)0x0) {
    *ppctDetect = 100;
  }
  for (i = 0; i < 0x10; i = i + 1) {
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      dRangeBest = GetShdefScannerRange
                             ((SHDEF *)CONCAT22(*(undefined2 *)(iplr * 4 + 0x100),
                                                (SHDEF *)(*(int *)(iplr * 4 + 0xfe) + i * 0x93)),
                              iplr,&dPlanRangeBest,&pctDetect,&iSteal);
      if ((ppctDetect != (short *)0x0) && (pctDetect < *ppctDetect)) {
        *ppctDetect = pctDetect;
      }
      if (piSteal != (short *)0x0) {
        *piSteal = *piSteal | iSteal;
      }
      sVar1 = dRangeBest;
      if (dRangeBest <= dRange) {
        sVar1 = dRange;
      }
      dRange = sVar1;
      if (dPlanRange < dPlanRangeBest) {
        dPlanRange = dPlanRangeBest;
      }
    }
  }
  if (pdPlanRange != (short *)0x0) {
    *pdPlanRange = dPlanRange;
  }
  return dRange;
}



// ======================================================================
// Function: GetShdefScannerRange
// Address: 1038:50d0
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lRange4 */
/* WARNING: Variable defined which should be unmapped: lBIPR4 */

short GetShdefScannerRange
          (SHDEF *lpshdef,short iplr,short *pdPlanRange,short *ppctDetect,short *piSteal)

{
  HullDef HVar1;
  int iVar2;
  double dVar3;
  double dVar4;
  bool bVar5;
  uint uVar6;
  uint id;
  short sVar7;
  HS *pHVar8;
  undefined2 uVar9;
  bool bVar10;
  bool bVar11;
  SCANNER *pSVar12;
  double *pdVar13;
  long lVar14;
  char *in_stack_0000ffa8;
  undefined2 in_stack_0000ffaa;
  undefined4 uStack_48;
  double lRange4;
  double lBIPR4;
  short j;
  short iSteal;
  double lT;
  short dRange;
  double lPlanRange4;
  short cDetectors;
  short fBuiltIn;
  short iScanner;
  short fHasScanner;
  short dRangeT;
  double lBIR4;
  short dRangeT2;
  HS *lphs;
  short chs;
  
  lRange4._0_2_ = (double *)0x0;
  lRange4._2_2_ = 0;
  lRange4._4_2_ = 0;
  lRange4._6_2_ = 0;
  lPlanRange4 = 0.0;
  bVar5 = false;
  iSteal = 0;
  cDetectors = 0;
  if (iplr == -1) {
LAB_1038_513f:
    bVar10 = false;
  }
  else {
    in_stack_0000ffaa = 0x1038;
    in_stack_0000ffa8 = (char *)szLastMsgGet + 0xd2;
    sVar7 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
    if (sVar7 != raNone) goto LAB_1038_513f;
    bVar10 = true;
  }
  lBIR4 = DOUBLE_m1_0__1120_1cca;
  lBIPR4._0_2_ = SUB82(DOUBLE_m1_0__1120_1cca,0);
  lBIPR4._2_2_ = (undefined2)((qword)DOUBLE_m1_0__1120_1cca >> 0x10);
  lBIPR4._4_4_ = (undefined4)((qword)DOUBLE_m1_0__1120_1cca >> 0x20);
  if (ppctDetect != (short *)0x0) {
    *ppctDetect = 100;
  }
  if (bVar10) {
    if ((lpshdef->hul).ihuldef == ihuldefScout) {
      bVar10 = false;
    }
    else if ((lpshdef->hul).ihuldef == ihuldefDestroyer) {
      bVar10 = false;
    }
    else {
      HVar1 = (lpshdef->hul).ihuldef;
      bVar10 = HVar1 < ihuldefFrigate;
      if (HVar1 != ihuldefFrigate) goto LAB_1038_5272;
    }
    __aFfcompp();
    if (bVar10) {
      if ((game.wCrap >> 3 & 1) == 0) {
        dVar3 = (double)(long)(*(char *)((int)rgplr[0].rgTech + 4 + iplr * 0xc0) * 10);
        dVar4 = dVar3 * dVar3 * dVar3 * dVar3;
        lBIPR4._0_2_ = SUB82(dVar4,0);
        lBIPR4._2_2_ = (undefined2)((qword)dVar4 >> 0x10);
        lBIPR4._4_4_ = (undefined4)((qword)dVar4 >> 0x20);
        dVar3 = dVar3 * 2.0 * dVar3 * 2.0;
        lBIR4 = dVar3 * dVar3;
      }
      else {
        lBIR4 = DOUBLE_2560000_0__1120_1cd2;
        lBIPR4._0_2_ = SUB82(DOUBLE_160000_0__1120_1cda,0);
        lBIPR4._2_2_ = (undefined2)((qword)DOUBLE_160000_0__1120_1cda >> 0x10);
        lBIPR4._4_4_ = (undefined4)((qword)DOUBLE_160000_0__1120_1cda >> 0x20);
      }
    }
    lRange4._0_2_ = SUB82(lBIR4,0);
    lRange4._2_2_ = (undefined2)((qword)lBIR4 >> 0x10);
    lRange4._4_2_ = (undefined2)((qword)lBIR4 >> 0x20);
    lRange4._6_2_ = (undefined2)((qword)lBIR4 >> 0x30);
    lPlanRange4 = (double)CONCAT44(lBIPR4._4_4_,CONCAT22(lBIPR4._2_2_,lBIPR4._0_2_));
  }
LAB_1038_5272:
  lphs = (HS *)CONCAT22(lpshdef._2_2_,(((SHDEF *)lpshdef)->hul).rghs);
  uVar6 = (uint)(((SHDEF *)lpshdef)->hul).chs;
  j = 0;
  do {
    bVar10 = (uint)j < uVar6;
    bVar11 = j == uVar6;
    if ((int)uVar6 <= j) {
      __aFfcompp();
      if ((!bVar10 && !bVar11) || (bVar5)) {
        pdVar13 = _sqrt((double *)CONCAT22(lRange4._2_2_,lRange4._0_2_),
                                (double)CONCAT26(in_stack_0000ffaa,
                                                 CONCAT24(in_stack_0000ffa8,
                                                          CONCAT22(lRange4._6_2_,lRange4._4_2_))));
        uStack_48 = (undefined4)((qword)*(double *)pdVar13 >> 0x20);
        _sqrt(SUB84(*(double *)pdVar13,0),
                      (double)CONCAT26(lRange4._2_2_,CONCAT24(lRange4._0_2_,uStack_48)));
        lVar14 = __ftol((double)CONCAT26(iSteal,CONCAT24(j,lBIPR4._4_4_)));
        dRange = (short)lVar14;
        if ((iplr != -1) &&
           (sVar7 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceNoAdvScanner),
           sVar7 != 0)) {
          dRange = dRange << 1;
        }
      }
      else {
        dRange = -1;
      }
      if (pdPlanRange != (short *)0x0) {
        pdVar13 = _sqrt(SUB84(lPlanRange4,0),
                                (double)CONCAT26(in_stack_0000ffaa,
                                                 CONCAT24(in_stack_0000ffa8,
                                                          (long)((qword)lPlanRange4 >> 0x20))));
        uStack_48 = (undefined4)((qword)*(double *)pdVar13 >> 0x20);
        _sqrt(SUB84(*(double *)pdVar13,0),
                      (double)CONCAT26(lRange4._2_2_,CONCAT24(lRange4._0_2_,uStack_48)));
        lVar14 = __ftol((double)CONCAT26(iSteal,CONCAT24(j,lBIPR4._4_4_)));
        *pdPlanRange = (short)lVar14;
      }
      if (piSteal != (short *)0x0) {
        *piSteal = iSteal;
      }
      if (ppctDetect != (short *)0x0) {
        if (0x11 < cDetectors) {
          cDetectors = 0x11;
        }
        *ppctDetect = (uint)((byte *)vrgbTachyon)[cDetectors];
      }
      return dRange;
    }
    uVar9 = (undefined2)((ulong)lphs >> 0x10);
    pHVar8 = (HS *)lphs;
    if (pHVar8->wFlags_0x2 >> 8 != 0) {
      if (lphs->grhst == hstScanner) {
        bVar5 = true;
        id = pHVar8->wFlags_0x2 & 0xff;
        in_stack_0000ffaa = 0x52f1;
        pSVar12 = LpscannerFromId(id);
        dVar3 = (double)(long)((SCANNER *)pSVar12)->dRange;
        dVar3 = dVar3 * dVar3;
        dVar3 = (double)CONCAT26(lRange4._6_2_,
                                 CONCAT24(lRange4._4_2_,
                                          (double *)CONCAT22(lRange4._2_2_,lRange4._0_2_))) +
                (double)(pHVar8->wFlags_0x2 >> 8) * dVar3 * dVar3;
        lRange4._0_2_ = SUB82(dVar3,0);
        lRange4._2_2_ = (undefined2)((qword)dVar3 >> 0x10);
        lRange4._4_2_ = (undefined2)((qword)dVar3 >> 0x20);
        lRange4._6_2_ = (undefined2)((qword)dVar3 >> 0x30);
        pSVar12 = LpscannerFromId(id);
        iVar2 = ((SCANNER *)pSVar12)->grfAbilities;
        if (id == 6) {
          dRangeT = 0x2d;
        }
        else if (id == 5) {
          dRangeT = 0;
          iSteal = iSteal | 1;
        }
        else if (id == 0xe) {
          dRangeT = 0x78;
          iSteal = 3;
        }
        else {
          if (iVar2 < 1) goto LAB_1038_5298;
          if (iVar2 == 1) {
            dRangeT = 0x32;
          }
          else if (iVar2 == 2) {
            dRangeT = 100;
          }
          else {
            dRangeT = 200;
          }
        }
      }
      else {
        if ((lphs->grhst == hstArmor) && ((pHVar8->wFlags_0x2 & 0xff) == 9)) {
          dRangeT = 0x50;
          dRangeT2 = 0x28;
        }
        else if ((lphs->grhst == hstBeam) && ((pHVar8->wFlags_0x2 & 0xff) == 0x12)) {
          dRangeT = 0x96;
          dRangeT2 = 0x4b;
        }
        else {
          if ((lphs->grhst != hstShield) || ((pHVar8->wFlags_0x2 & 0xff) != 6)) {
            if (((ppctDetect != (short *)0x0) && (lphs->grhst == hstSpecialE)) &&
               ((pHVar8->wFlags_0x2 & 0xff) == 0xf)) {
              cDetectors = cDetectors + (pHVar8->wFlags_0x2 >> 8);
            }
            goto LAB_1038_5298;
          }
          dRangeT = 0x32;
          dRangeT2 = 0x19;
        }
        dVar3 = (double)(long)dRangeT * (double)(long)dRangeT;
        dVar3 = (double)CONCAT26(lRange4._6_2_,
                                 CONCAT24(lRange4._4_2_,
                                          (double *)CONCAT22(lRange4._2_2_,lRange4._0_2_))) +
                (double)(pHVar8->wFlags_0x2 >> 8) * dVar3 * dVar3;
        lRange4._0_2_ = SUB82(dVar3,0);
        lRange4._2_2_ = (undefined2)((qword)dVar3 >> 0x10);
        lRange4._4_2_ = (undefined2)((qword)dVar3 >> 0x20);
        lRange4._6_2_ = (undefined2)((qword)dVar3 >> 0x30);
        dRangeT = dRangeT2;
      }
      dVar3 = (double)(long)dRangeT * (double)(long)dRangeT;
      lPlanRange4 = lPlanRange4 + (double)(pHVar8->wFlags_0x2 >> 8) * dVar3 * dVar3;
    }
LAB_1038_5298:
    j = j + 1;
    lphs = (HS *)CONCAT22(uVar9,pHVar8 + 1);
  } while( true );
}



// ======================================================================
// Function: LCalcFuelGainFromRamScoops
// Address: 1038:56b8
// Segment: MEMORY_UTIL
// ======================================================================


long LCalcFuelGainFromRamScoops(FLEET *lpfl,short iWarp,long dTravel)

{
  ENGINE *pEVar1;
  uint uVar2;
  undefined2 uVar3;
  FLEET *pFVar4;
  int iVar5;
  SHDEF *pSVar6;
  undefined2 uVar7;
  undefined2 uVar8;
  bool bVar9;
  ENGINE *pEVar10;
  ulong uVar11;
  ulong uVar12;
  uint pctShip10;
  uint local_14;
  SHDEF *lpshdef;
  short i;
  
  uVar12 = 0;
  if (iWarp < 0xb) {
    i = 0;
    uVar7 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar4 = (FLEET *)lpfl;
    iVar5 = pFVar4->iPlayer * 4;
    lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iVar5 + 0x100),
                                (SHDEF *)*(undefined2 *)(iVar5 + 0xfe));
    for (; i < 0x10; i = i + 1) {
      pSVar6 = (SHDEF *)lpshdef;
      uVar8 = (undefined2)((ulong)lpshdef >> 0x10);
      if (pFVar4->rgcsh[i] != 0) {
        pEVar10 = LpengineFromId((pSVar6->hul).rghs[0].wFlags_0x2 & 0xff);
        uVar3 = (undefined2)((ulong)pEVar10 >> 0x10);
        pEVar1 = (ENGINE *)pEVar10;
        pctShip10 = 0;
        local_14 = 0;
        if (iWarp < 10) {
          if (pEVar1->rgcFuelUsed[iWarp] == 0) {
            pctShip10 = (pSVar6->hul).rghs[0].wFlags_0x2 >> 8;
            local_14 = 0;
            if (pEVar1->rgcFuelUsed[iWarp + 1] == 0) {
              uVar2 = ((pSVar6->hul).rghs[0].wFlags_0x2 >> 8) * 2;
              bVar9 = CARRY2(pctShip10,uVar2);
              pctShip10 = pctShip10 + uVar2;
              local_14 = (uint)bVar9;
              if ((iWarp < 9) && (pEVar1->rgcFuelUsed[iWarp + 2] == 0)) {
                uVar2 = ((pSVar6->hul).rghs[0].wFlags_0x2 >> 8) * 3;
                bVar9 = CARRY2(pctShip10,uVar2);
                pctShip10 = pctShip10 + uVar2;
                local_14 = local_14 + bVar9;
                if ((iWarp < 8) && (pEVar1->rgcFuelUsed[iWarp + 3] == 0)) {
                  uVar2 = ((pSVar6->hul).rghs[0].wFlags_0x2 >> 8) * 4;
                  bVar9 = CARRY2(pctShip10,uVar2);
                  pctShip10 = pctShip10 + uVar2;
                  local_14 = local_14 + bVar9;
                }
              }
            }
          }
          uVar11 = __aFulmul(CONCAT22(local_14,pctShip10),(long)pFVar4->rgcsh[i]);
          uVar12 = uVar11 + uVar12;
        }
      }
      lpshdef = (SHDEF *)CONCAT22(uVar8,pSVar6 + 1);
    }
    uVar12 = __aFulmul(uVar12,dTravel);
  }
  else {
    uVar12 = 0;
  }
  return uVar12;
}



// ======================================================================
// Function: CalcPlayerScore
// Address: 1038:58a6
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10385b22) */
/* WARNING: Removing unreachable block (ram,0x10385938) */
/* WARNING: Removing unreachable block (ram,0x10385b4a) */

long CalcPlayerScore(short iPlr,SCORE *pscore)

{
  uint *puVar1;
  undefined4 *puVar2;
  SCORE *pSVar3;
  FLEET *pFVar4;
  uint uVar5;
  uint uVar6;
  ushort uVar7;
  int iVar8;
  int iVar9;
  undefined2 unaff_SI;
  undefined4 *puVar10;
  undefined2 unaff_DI;
  undefined2 uVar11;
  bool bVar12;
  long lVar13;
  HULDEF *pHVar14;
  long lVar15;
  ulong uVar16;
  PLANET *pPVar17;
  int rgType [16];
  undefined4 lPower;
  short iTech;
  FLEET *lpfl;
  short ifl;
  short i;
  PLANET *lppl;
  PLANET *lpplMac;
  undefined2 local_2a;
  undefined4 score;
  uint local_24;
  int local_22;
  uint local_20;
  int local_1e;
  ushort local_1c [4];
  undefined4 lTemp;
  uint rgcsh [4];
  uint local_8;
  int local_6;
  
  lVar15 = CONCAT22(unaff_SI,unaff_DI);
  _memset(&score,0,0x14);
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_2a = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  pPVar17 = (PLANET *)lpPlanets;
  while ((PLANET *)lppl < lpplMac) {
    uVar11 = (undefined2)((ulong)lppl >> 0x10);
    if (((PLANET *)lppl)->iPlayer == iPlr) {
      local_20 = local_20 + 1;
      lVar13 = __aFldiv(CONCAT22(*(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe) +
                                         (uint)(0xfc18 < *(uint *)(((PLANET *)lppl)->rgwtMin + 3)),
                                         *(uint *)(((PLANET *)lppl)->rgwtMin + 3) + 999),1000);
      if (6 < lVar13) {
        lVar13 = 6;
      }
      score = lVar13 + score;
      uVar11 = (undefined2)((ulong)lppl >> 0x10);
      if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) {
        lTemp = lVar13;
        pHVar14 = LphuldefFromId
                            (*(HullDef *)
                              (*(int *)(iPlr * 4 + 0x14c) +
                              (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) * 0x93));
        lVar13 = lTemp;
        if ((((HULDEF *)pHVar14)->hul).wtCargoMax != 0) {
          local_1e = local_1e + 1;
        }
      }
      lTemp = lVar13;
      uVar6 = CResourcesAtPlanet(lppl,iPlr);
      bVar12 = CARRY2(local_24,uVar6);
      local_24 = local_24 + uVar6;
      local_22 = local_22 + ((int)uVar6 >> 0xf) + (uint)bVar12;
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  lVar13 = __aFldiv(CONCAT22(local_22,local_24),0x1e);
  lVar13 = lVar13 + score + (long)(local_1e * 3);
  score = lVar13;
  if ((*(uint *)((int)&rgplr[0].wFlags + iPlr * 0xc0) & 1) == 0) {
    for (i = 0; i < 6; i = i + 1) {
      iTech = (short)*(char *)(iPlr * 0xc0 + 0x59bc + i);
      local_1c[3] = local_1c[3] + iTech;
      if (iTech < 4) {
        lVar13 = lVar13 + iTech;
        score = lVar13;
      }
      else if (iTech < 7) {
        lVar13 = lVar13 + (iTech * 2 + -3);
        score = lVar13;
      }
      else if (iTech < 10) {
        iVar8 = iTech * 3 + -9;
        score = lVar13 + iVar8;
        lVar13 = lVar13 + iVar8;
      }
      else {
        iVar8 = iTech * 4 + -0x12;
        score = lVar13 + iVar8;
        lVar13 = lVar13 + iVar8;
      }
    }
  }
  for (i = 0; score = lVar13, i < 0x10; i = i + 1) {
    if ((*(uint *)(*(int *)(iPlr * 4 + 0xfe) + i * 0x93 + 0x7b) >> 9 & 1) == 0) {
      lVar13 = LComputePower((SHDEF *)CONCAT22(*(undefined2 *)(iPlr * 4 + 0x100),
                                               (SHDEF *)(*(int *)(iPlr * 4 + 0xfe) + i * 0x93)));
      lPower = lVar13;
      if (lVar13 < 1) {
        rgType[i] = 0;
        lVar13 = score;
      }
      else if (lVar13 < 2000) {
        rgType[i] = 1;
        lVar13 = score;
      }
      else {
        rgType[i] = 2;
        lVar13 = score;
      }
    }
    else {
      rgType[i] = -1;
      lVar13 = score;
    }
  }
  for (i = 0; i < 3; i = i + 1) {
    rgcsh[i * 2] = 0;
    rgcsh[i * 2 + 1] = 0;
  }
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar4 = ((FLEET **)rglpfl)[ifl];
    iVar8 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar8,pFVar4);
    if ((pFVar4 == (FLEET *)0x0) && (iVar8 == 0)) break;
    if ((pFVar4->iPlayer == iPlr) && ((pFVar4->wFlags_0x4 >> 10 & 1) == 0)) {
      for (i = 0; i < 0x10; i = i + 1) {
        if ((0 < pFVar4->rgcsh[i]) && (rgType[i] != -1)) {
          uVar5 = pFVar4->rgcsh[i];
          iVar9 = rgType[i];
          puVar1 = rgcsh + iVar9 * 2;
          uVar6 = *puVar1;
          *puVar1 = *puVar1 + uVar5;
          rgcsh[iVar9 * 2 + 1] =
               rgcsh[iVar9 * 2 + 1] + ((int)uVar5 >> 0xf) + (uint)CARRY2(uVar6,uVar5);
        }
      }
    }
  }
  lVar15 = __aFlshl(lVar15,(ushort)pPVar17);
  uVar11 = (undefined2)lVar15;
  iVar8 = (int)local_20 >> 0xf;
  if ((iVar8 < (int)rgcsh[1]) || ((iVar8 <= (int)rgcsh[1] && (local_20 <= rgcsh[0])))) {
    rgcsh[0] = local_20;
    rgcsh[1] = iVar8;
  }
  lVar13 = __aFldiv(CONCAT22(rgcsh[1],rgcsh[0]),2);
  score = lVar13 + CONCAT22((int)((ulong)lVar15 >> 0x10),uVar11) + score;
  if ((-1 < local_6) && ((0 < local_6 || (local_8 != 0)))) {
    iVar8 = (int)local_20 >> 0xf;
    uVar7 = local_20 + local_8;
    iVar9 = iVar8 + local_6 + (uint)CARRY2(local_20,local_8);
    uVar6 = local_20;
    uVar16 = __aFlshl((long)(int)local_20,uVar7);
    uVar16 = __aFulmul(uVar16,CONCAT22(iVar8,uVar6));
    lVar15 = __aFldiv(uVar16,CONCAT22(iVar9,uVar7));
    score = lVar15 + score;
  }
  for (i = 0; i < 3; i = i + 1) {
    uVar7 = WPackLong(CONCAT22(rgcsh[i * 2 + 1],rgcsh[i * 2]));
    local_1c[i] = uVar7;
  }
  if (pscore != (SCORE *)0x0) {
    puVar10 = &score;
    for (iVar8 = 10; iVar8 != 0; iVar8 = iVar8 + -1) {
      pSVar3 = pscore;
      pscore = (SCORE *)((int)&pscore->lScore + 2);
      puVar2 = puVar10;
      puVar10 = (undefined4 *)((int)puVar10 + 2);
      *(undefined2 *)&pSVar3->lScore = *(undefined2 *)puVar2;
    }
  }
  return score;
}



// ======================================================================
// Function: GetTrueHullCost
// Address: 1038:5dba
// Segment: MEMORY_UTIL
// ======================================================================


void GetTrueHullCost(short iPlayer,HUL *lphul,ushort *rgCost)

{
  short i;
  
  for (i = 0; i < 3; i = i + 1) {
    rgCost[i] = ((HUL *)lphul)->rgwtOreCost[i];
  }
  rgCost[3] = ((HUL *)lphul)->resCost;
  return;
}



// ======================================================================
// Function: DecorateHullName
// Address: 1038:5e0e
// Segment: MEMORY_UTIL
// ======================================================================


void DecorateHullName(short iplr,short ish,char *psz)

{
  undefined2 uVar1;
  short sVar2;
  ushort uVar3;
  int iVar4;
  short iVal;
  SHDEF *lpshdef;
  short c;
  short i;
  
  uVar1 = *(undefined2 *)(iplr * 4 + 0x100);
  iVar4 = *(int *)(iplr * 4 + 0xfe) + ish * 0x93;
  if ((*(uint *)(iVar4 + 0x7b) >> 9 & 1) == 0) {
    __fstrcpy((char *)CONCAT22(0x1120,psz),(char *)CONCAT22(uVar1,(char *)(iVar4 + 8)));
    if (iplr != idPlayer) {
      c = 0;
      iVal = 1;
      for (i = 0; i < 0x10; i = i + 1) {
        if ((((i != ish) && ((*(uint *)(*(int *)(iplr * 4 + 0xfe) + i * 0x93 + 0x7b) >> 9 & 1) == 0)
             ) && (sVar2 = __fstrcmp((char *)CONCAT22(0x1120,psz),
                                             (char *)CONCAT22(*(undefined2 *)(iplr * 4 + 0x100),
                                                              (char *)(*(int *)(iplr * 4 + 0xfe) +
                                                                       i * 0x93 + 8))), sVar2 == 0))
           && (c = c + 1, i < ish)) {
          iVal = iVal + 1;
        }
      }
      if (c != 0) {
        uVar3 = _strlen(psz);
        psz[uVar3] = ' ';
        psz[uVar3 + 1] = '(';
        IntToRoman(iVal,psz + uVar3 + 2);
        _strcat(psz,(char *)0x539);
      }
    }
  }
  else {
    *psz = '\0';
  }
  return;
}



// ======================================================================
// Function: DrawABunchOfStars
// Address: 1038:5fe2
// Segment: MEMORY_UTIL
// ======================================================================


void DrawABunchOfStars(HDC hdc,RECT *prc)

{
  short sVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  long lVar2;
  RECT rc;
  RECT rcOut;
  short dx;
  short iClr;
  short i;
  short dy;
  short iMax;
  ulong lPixTot;
  
  rc.left = prc->left;
  rc.top = prc->top;
  rc.right = prc->right;
  rc.bottom = prc->bottom;
  PushRandom(0xb0011,CONCAT22(unaff_SI,unaff_DI));
  InflateRect((RECT *)CONCAT22(unaff_SS,&rc),-3,-3);
  dx = rc.right - rc.left;
  dy = rc.bottom - rc.top;
  lPixTot = __aFulmul((long)dx,(long)dy);
  for (iClr = 0; iClr < 5; iClr = iClr + 1) {
    lVar2 = __aFldiv(lPixTot,CONCAT22(*(undefined2 *)
                                               ((int)(long *)rgDSDivCnt + iClr * 4 + 2),
                                              (int)((long *)rgDSDivCnt)[iClr]));
    iMax = (short)lVar2;
    for (i = 0; i < iMax; i = i + 1) {
      sVar1 = Random(dx);
      rcOut.left = sVar1 + rc.left;
      sVar1 = Random(dy);
      rcOut.top = sVar1 + rc.top;
      rcOut.right = rcOut.left + 1;
      rcOut.bottom = rcOut.top + 1;
      SetBkColor(hdc,CONCAT22(*(undefined2 *)((int)(ulong *)rgcrDrawStars + iClr * 4 + 2),
                              (int)((ulong *)rgcrDrawStars)[iClr]));
      ExtTextOut(hdc,0,0,2,(RECT *)CONCAT22(unaff_SS,&rcOut),(LPCSTR)0x0,0,(short *)0x0);
    }
  }
  for (iClr = 0; iClr < 4; iClr = iClr + 1) {
    lVar2 = __aFldiv(lPixTot,CONCAT22(*(undefined2 *)
                                               ((int)(long *)rgDSDivCnt2 + iClr * 4 + 2),
                                              (int)((long *)rgDSDivCnt2)[iClr]));
    iMax = (int)lVar2 + 1;
    for (i = 0; i < iMax; i = i + 1) {
      sVar1 = Random(dx);
      rcOut.left = sVar1 + rc.left;
      sVar1 = Random(dy);
      rcOut.top = sVar1 + rc.top;
      rcOut.right = rcOut.left + 3;
      rcOut.bottom = rcOut.top + 3;
      SetBkColor(hdc,CONCAT22(*(undefined2 *)((int)(ulong *)rgcrDrawStars2b + iClr * 4 + 2),
                              (int)((ulong *)rgcrDrawStars2b)[iClr]));
      ExtTextOut(hdc,0,0,2,(RECT *)CONCAT22(unaff_SS,&rcOut),(LPCSTR)0x0,0,(short *)0x0);
      SetBkColor(hdc,CONCAT22(*(undefined2 *)((int)(ulong *)rgcrDrawStars2a + iClr * 4 + 2),
                              (int)((ulong *)rgcrDrawStars2a)[iClr]));
      InflateRect((RECT *)CONCAT22(unaff_SS,&rcOut),-1,0);
      ExtTextOut(hdc,0,0,2,(RECT *)CONCAT22(unaff_SS,&rcOut),(LPCSTR)0x0,0,(short *)0x0);
      InflateRect((RECT *)CONCAT22(unaff_SS,&rcOut),1,-1);
      ExtTextOut(hdc,0,0,2,(RECT *)CONCAT22(unaff_SS,&rcOut),(LPCSTR)0x0,0,(short *)0x0);
    }
  }
  PopRandom();
  return;
}



// ======================================================================
// Function: LongFromSerialCh
// Address: 1038:6280
// Segment: MEMORY_UTIL
// ======================================================================


long LongFromSerialCh(char ch)

{
  uint l;
  int local_6;
  
  if ((ch < 'A') || ('Z' < ch)) {
    l = (int)ch - 0x16;
  }
  else {
    l = (int)ch - 0x41;
  }
  local_6 = (int)l >> 0xf;
  if ((local_6 < 0) || ((local_6 < 1 && (l < 0x20)))) {
    l = l ^ 0x15;
  }
  return CONCAT22(local_6,l);
}



// ======================================================================
// Function: FValidSerialNo
// Address: 1038:62f8
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10386324) */

short FValidSerialNo(char *psz,long *plSerial)

{
  short sVar1;
  undefined2 uVar2;
  ushort uVar3;
  long lVar4;
  ulong uVar5;
  long lVar6;
  undefined1 uVar7;
  undefined1 uVar8;
  undefined1 uVar9;
  undefined1 uVar10;
  undefined1 uVar11;
  undefined1 uVar12;
  undefined1 in_stack_0000ffec;
  undefined1 in_stack_0000ffed;
  int iVar13;
  byte bVar14;
  short i;
  
  lVar4 = LongFromSerialCh(*psz);
  uVar2 = (undefined2)((ulong)lVar4 >> 0x10);
  bVar14 = (byte)lVar4;
  uVar8 = (undefined1)((ulong)lVar4 >> 8);
  if (lVar4 < 0x20) {
    bVar14 = bVar14 ^ 0x15;
  }
  lVar4 = LongFromSerialCh(psz[1]);
  uVar7 = (undefined1)lVar4;
  uVar9 = (undefined1)((ulong)lVar4 >> 8);
  uVar10 = (undefined1)((ulong)lVar4 >> 0x10);
  uVar11 = (undefined1)((ulong)lVar4 >> 0x18);
  uVar5 = __aFulmul(CONCAT13((char)((uint)uVar2 >> 8),
                                     CONCAT12((char)uVar2,CONCAT11(uVar8,bVar14))),0x24);
  lVar4 = uVar5 + CONCAT22(CONCAT11(uVar11,uVar10),CONCAT11(uVar9,uVar7));
  uVar2 = (undefined2)((ulong)lVar4 >> 0x10);
  uVar11 = (undefined1)lVar4;
  uVar12 = (undefined1)((ulong)lVar4 >> 8);
  lVar4 = LongFromSerialCh(psz[4]);
  uVar8 = (undefined1)lVar4;
  uVar7 = (undefined1)((ulong)lVar4 >> 8);
  uVar9 = (undefined1)((ulong)lVar4 >> 0x10);
  uVar10 = (undefined1)((ulong)lVar4 >> 0x18);
  uVar5 = __aFulmul(CONCAT13((char)((uint)uVar2 >> 8),
                                     CONCAT12((char)uVar2,CONCAT11(uVar12,uVar11))),
                            CONCAT13(uVar7,CONCAT12(uVar8,0x24)));
  lVar4 = uVar5 + CONCAT22(CONCAT11(uVar10,uVar9),CONCAT11(uVar7,uVar8));
  uVar2 = (undefined2)((ulong)lVar4 >> 0x10);
  uVar9 = (undefined1)lVar4;
  uVar10 = (undefined1)((ulong)lVar4 >> 8);
  uVar5 = LongFromSerialCh(psz[7]);
  uVar8 = (undefined1)uVar5;
  uVar7 = (undefined1)(uVar5 >> 8);
  uVar5 = __aFulmul(CONCAT13((char)((uint)uVar2 >> 8),
                                     CONCAT12((char)uVar2,CONCAT11(uVar10,uVar9))),uVar5);
  lVar4 = uVar5 + CONCAT11(uVar7,uVar8);
  uVar11 = (undefined1)lVar4;
  uVar12 = (undefined1)((ulong)lVar4 >> 8);
  uVar5 = LongFromSerialCh(psz[3]);
  uVar8 = (undefined1)uVar5;
  uVar7 = (undefined1)(uVar5 >> 8);
  uVar9 = (undefined1)(uVar5 >> 0x10);
  uVar10 = (undefined1)(uVar5 >> 0x18);
  uVar5 = __aFulmul(CONCAT13(uVar7,CONCAT12(uVar8,CONCAT11(uVar12,uVar11))),uVar5 >> 0x10);
  lVar4 = uVar5 + CONCAT22(CONCAT11(uVar10,uVar9),CONCAT11(uVar7,uVar8));
  uVar3 = (ushort)((ulong)lVar4 >> 0x10);
  uVar8 = (undefined1)lVar4;
  uVar7 = (undefined1)((ulong)lVar4 >> 8);
  if (plSerial != (long *)0x0) {
    *(int *)plSerial = (int)lVar4;
    *(ushort *)((int)plSerial + 2) = uVar3;
  }
  PushRandom(0x11000b,CONCAT13(uVar7,CONCAT12(uVar8,CONCAT11(in_stack_0000ffed,
                                                                      in_stack_0000ffec))));
  Randomize2(CONCAT13((char)(uVar3 >> 8),CONCAT12((char)uVar3,CONCAT11(uVar7,uVar8))));
  __aFlshr(CONCAT13(uVar7,CONCAT12(uVar8,CONCAT11(in_stack_0000ffed,in_stack_0000ffec))),
                   uVar3);
  lVar4 = 0;
  for (i = 0; i < 3; i = i + 1) {
    for (iVar13 = 0; (0 < iVar13 || (-1 < iVar13));
        iVar13 = iVar13 - (uint)(CONCAT11(uVar10,uVar9) == 0)) {
      uVar9 = 0;
      uVar10 = 1;
      Random(0x100);
    }
    sVar1 = Random(0x100);
    uVar9 = (undefined1)sVar1;
    uVar10 = (undefined1)((uint)sVar1 >> 8);
    uVar11 = 0xe1;
    uVar12 = 100;
    lVar4 = __aFlshl(CONCAT13(uVar7,CONCAT12(uVar8,iVar13)),uVar3);
    lVar4 = lVar4 + CONCAT22(CONCAT11(uVar12,uVar11),CONCAT11(uVar10,uVar9));
    __aFlshr(CONCAT13(uVar7,CONCAT12(uVar8,iVar13)),uVar3);
  }
  PopRandom();
  LongFromSerialCh(psz[2]);
  uVar9 = 0;
  uVar10 = 0;
  uVar8 = 0x24;
  uVar7 = 0;
  lVar6 = __aFlrem(lVar4,0x24);
  if ((CONCAT11(uVar7,uVar8) == (int)lVar6) &&
     (CONCAT11(uVar10,uVar9) == (int)((ulong)lVar6 >> 0x10))) {
    lVar4 = __aFldiv(lVar4,0x24);
    LongFromSerialCh(psz[5]);
    uVar9 = 0x24;
    uVar10 = 0;
    uVar8 = (undefined1)((ulong)lVar4 >> 0x10);
    uVar7 = (undefined1)((ulong)lVar4 >> 0x18);
    lVar6 = __aFlrem(lVar4,0x24);
    if ((CONCAT11(uVar7,uVar8) == (int)lVar6) &&
       (CONCAT11(uVar10,uVar9) == (int)((ulong)lVar6 >> 0x10))) {
      lVar4 = __aFldiv(lVar4,0x24);
      LongFromSerialCh(psz[6]);
      uVar9 = (undefined1)((ulong)lVar4 >> 0x10);
      uVar10 = (undefined1)((ulong)lVar4 >> 0x18);
      uVar8 = (undefined1)lVar4;
      uVar7 = (undefined1)((ulong)lVar4 >> 8);
      lVar4 = __aFlrem(lVar4,0x24);
      if ((CONCAT11(uVar7,uVar8) == (int)lVar4) &&
         (CONCAT11(uVar10,uVar9) == (int)((ulong)lVar4 >> 0x10))) {
        sVar1 = 1;
      }
      else {
        sVar1 = 0;
      }
    }
    else {
      sVar1 = 0;
    }
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: FMatchTarget
// Address: 1038:6612
// Segment: MEMORY_UTIL
// ======================================================================


short FMatchTarget(FLEET *lpflTarget,short mdTarget,short fExact)

{
  uint uVar1;
  int iVar2;
  HULDEF *pHVar3;
  short ish;
  short imd;
  
  if (mdTarget != 3) {
    if (mdTarget == 4) {
      for (ish = 0; ish < 0x10; ish = ish + 1) {
        if (((FLEET *)lpflTarget)->rgcsh[ish] != 0) {
          iVar2 = ((FLEET *)lpflTarget)->iPlayer * 4;
          pHVar3 = LphuldefFromId(*(HullDef *)(*(int *)(iVar2 + 0xfe) + ish * 0x93));
          uVar1 = ((HULDEF *)pHVar3)->wFlags_0x7b >> 10 & 0xf;
          if ((uVar1 == 1) || (uVar1 == 5)) break;
        }
      }
      if (ish != 0x10) {
        return 1;
      }
      return 0;
    }
    if (mdTarget != 5) {
      if (mdTarget == 6) {
        ish = 0;
        while ((ish < 0x10 &&
               ((((FLEET *)lpflTarget)->rgcsh[ish] == 0 ||
                (iVar2 = ((FLEET *)lpflTarget)->iPlayer * 4,
                pHVar3 = LphuldefFromId(*(HullDef *)(*(int *)(iVar2 + 0xfe) + ish * 0x93)),
                (((HULDEF *)pHVar3)->wFlags_0x7b >> 10 & 0xf) != 7))))) {
          ish = ish + 1;
        }
        if (ish != 0x10) {
          return 1;
        }
        return 0;
      }
      if (mdTarget != 7) {
        if (fExact == 0) {
          return 1;
        }
        return 0;
      }
      ish = 0;
      while ((ish < 0x10 &&
             ((((FLEET *)lpflTarget)->rgcsh[ish] == 0 ||
              (iVar2 = ((FLEET *)lpflTarget)->iPlayer * 4,
              pHVar3 = LphuldefFromId(*(HullDef *)(*(int *)(iVar2 + 0xfe) + ish * 0x93)),
              (((HULDEF *)pHVar3)->wFlags_0x7b >> 10 & 0xf) != 1))))) {
        ish = ish + 1;
      }
      if (ish != 0x10) {
        return 1;
      }
      return 0;
    }
  }
  for (ish = 0; ish < 0x10; ish = ish + 1) {
    if (((FLEET *)lpflTarget)->rgcsh[ish] != 0) {
      iVar2 = ((FLEET *)lpflTarget)->iPlayer * 4;
      pHVar3 = LphuldefFromId(*(HullDef *)(*(int *)(iVar2 + 0xfe) + ish * 0x93));
      uVar1 = ((HULDEF *)pHVar3)->wFlags_0x7b >> 10 & 0xf;
      if ((1 < uVar1) && (uVar1 < 5)) break;
    }
  }
  if (mdTarget == 3) {
    if (ish == 0x10) {
      return 0;
    }
  }
  else if (ish != 0x10) {
    return 0;
  }
  return 1;
}



// ======================================================================
// Function: ValidateWaypoints
// Address: 1038:68c6
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10386e28) */
/* WARNING: Removing unreachable block (ram,0x10386f42) */

void ValidateWaypoints(void)

{
  byte *pbVar1;
  FLEET *pFVar2;
  int iVar3;
  FLEET *pFVar4;
  THING *pTVar5;
  long lVar6;
  uint uVar7;
  uint mdTarget_00;
  short sVar8;
  int iVar9;
  ORDER *pOVar10;
  undefined2 uVar11;
  THING *pTVar12;
  FLEET *pFVar13;
  long lVar14;
  short iplrHi;
  FLEET *lpfl2;
  short iord;
  short cFound;
  FLEET *lpfl;
  THING *lpth;
  short ifl;
  ORDER *lpord;
  FLEET *lpflMatch;
  int local_12;
  short ifl2;
  FLEET *lpflTarget;
  short mdTarget;
  
  ifl = 0;
  do {
    if (cFleet <= ifl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pFVar2 = ((FLEET **)rglpfl)[ifl];
    iVar3 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar3,pFVar2);
    if ((pFVar2 == (FLEET *)0x0) && (iVar3 == 0)) {
      return;
    }
    if (((((*(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax >> 8 & 0xf) != 1) &&
         ((*(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax & 0xf) != 1)) &&
        ((*(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax & 0xf) != 4)) &&
       (-1 < (int)pFVar2->wFlags_0x4)) {
      if (pFVar2->idPlanet == -1) {
        *(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax =
             *(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax & 0xf0ff | 0x400;
        ((PLORD *)pFVar2->lpplord + 2)->wFlags = 0;
      }
      else {
        *(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax =
             *(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax & 0xf0ff | 0x100;
        ((PLORD *)pFVar2->lpplord + 2)->wFlags = pFVar2->idPlanet;
      }
    }
    if ((pFVar2->wFlags_0x4 >> 10 & 1) == 0) {
      if ((&pFVar2->pt)->x < 1000) {
        (&pFVar2->pt)->x = 1000;
        ((PLORD *)pFVar2->lpplord + 1)->wFlags = 1000;
      }
      else if (dGal + 1000 < (&pFVar2->pt)->x) {
        (&pFVar2->pt)->x = dGal + 1000;
        ((PLORD *)pFVar2->lpplord + 1)->wFlags = dGal + 1000;
      }
      if ((pFVar2->pt).y < 1000) {
        (pFVar2->pt).y = 1000;
        pbVar1 = &((PLORD *)pFVar2->lpplord)[1].iordMax;
        pbVar1[0] = 0xe8;
        pbVar1[1] = 3;
      }
      else if (dGal + 1000 < (pFVar2->pt).y) {
        (pFVar2->pt).y = dGal + 1000;
        *(short *)&((PLORD *)pFVar2->lpplord)[1].iordMax = dGal + 1000;
      }
      if ((1 < pFVar2->cord) || ((int)pFVar2->wFlags_0x4 < 0)) {
        iord = (short)(-1 < (int)pFVar2->wFlags_0x4);
        lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar2->lpplord + 2),
                                  (ORDER *)(*(int *)&pFVar2->lpplord + 4 + iord * 0x12));
        for (; iord < pFVar2->cord; iord = iord + 1) {
          uVar11 = (undefined2)((ulong)lpord >> 0x10);
          pOVar10 = (ORDER *)lpord;
          if ((pOVar10->wFlags_0x6 >> 8 & 0xf) == 8) {
            pTVar12 = LpthFromId(pOVar10->id);
            iVar9 = (int)((ulong)pTVar12 >> 0x10);
            pTVar5 = (THING *)pTVar12;
            if (((pTVar5 == (THING *)0x0) && (iVar9 == 0)) ||
               (((pTVar12->idFull >> 0xd == 2 &&
                 ((1 << ((byte)pFVar2->iPlayer & 0x1f) & *(uint *)((int)&pTVar5->u_THING_0x0006 + 2)
                  ) == 0)) &&
                (((&pTVar5->pt)->x != (lpord->pt).x || ((pTVar5->pt).y != (pOVar10->pt).y)))))) {
              if ((pTVar5 != (THING *)0x0) || (iVar9 != 0)) {
                FSendPlrMsg(pFVar2->iPlayer,idmWormholeHeadingHasVanishedOrdersHaveChanged,
                                 lpfl->id | 0x8000,lpfl->id,0,0,0,0,0,0);
              }
              pOVar10->wFlags_0x6 = pOVar10->wFlags_0x6 & 0xf0ff | 0x400;
              pOVar10->id = iord;
            }
            else {
              sVar8 = (pTVar5->pt).y;
              (lpord->pt).x = (&pTVar5->pt)->x;
              (pOVar10->pt).y = sVar8;
            }
          }
          else if (((pOVar10->wFlags_0x6 >> 8 & 0xf) == 2) &&
                  ((pOVar10->wFlags_0x6 >> 0xd & 1) == 0)) {
            pFVar13 = LpflFromId(pOVar10->id);
            iVar9 = (int)((ulong)pFVar13 >> 0x10);
            pFVar4 = (FLEET *)pFVar13;
            if (((pFVar4 == (FLEET *)0x0) && (iVar9 == 0)) ||
               ((((&pFVar4->pt)->x != (lpord->pt).x || ((pFVar4->pt).y != (pOVar10->pt).y)) ||
                (((*(uint *)((int)&pFVar4->dirLong + 2) >> 5 & 1) != 0 &&
                 (pFVar4->iPlayer != pFVar2->iPlayer)))))) {
              lpflTarget = (FLEET *)0x0;
              uVar7 = pOVar10->id & 0xfe00;
              cFound = 0;
              mdTarget_00 = ((BTLPLAN **)rglpbtlplan)[pFVar2->iPlayer * 2][pFVar2->iplan].
                            wFlags_0x2 & 0xf;
              lVar6 = 0;
              lpflMatch = (FLEET *)0x0;
              local_12 = 0;
              for (ifl2 = 0; ifl2 < cFleet; ifl2 = ifl2 + 1) {
                    /* WARNING: Load size is inaccurate */
                pFVar4 = ((FLEET **)rglpfl)[ifl2];
                iVar9 = *(int *)((int)((FLEET **)rglpfl + ifl2) + 2);
                lpfl2 = (FLEET *)CONCAT22(iVar9,pFVar4);
                if ((pFVar4 == (FLEET *)0x0) && (iVar9 == 0)) break;
                if ((((&pFVar4->pt)->x == (lpord->pt).x) &&
                    ((((pFVar4->pt).y == (pOVar10->pt).y && (uVar7 == (lpfl2->id & 0xfe00U))) &&
                     (sVar8 = FMatchTarget((FLEET *)CONCAT22(iVar9,pFVar4),mdTarget_00,1),
                     sVar8 != 0)))) &&
                   ((lVar14 = WtFromLpfl((FLEET *)CONCAT22(iVar9,pFVar4)),
                    (*(uint *)((int)&pFVar4->dirLong + 2) >> 6 & 1) == 0 &&
                    ((lVar6 < lVar14 ||
                     ((lVar6 == lVar14 && (sVar8 = Random(2), sVar8 == 0)))))))) {
                  lpflMatch = pFVar4;
                  local_12 = iVar9;
                  lVar6 = lVar14;
                }
              }
              if ((lpflMatch == (FLEET *)0x0) && (local_12 == 0)) {
                for (ifl2 = 0; ifl2 < cFleet; ifl2 = ifl2 + 1) {
                    /* WARNING: Load size is inaccurate */
                  pFVar4 = ((FLEET **)rglpfl)[ifl2];
                  iVar9 = *(int *)((int)((FLEET **)rglpfl + ifl2) + 2);
                  lpfl2 = (FLEET *)CONCAT22(iVar9,pFVar4);
                  if ((pFVar4 == (FLEET *)0x0) && (iVar9 == 0)) break;
                  if (((&pFVar4->pt)->x == (lpord->pt).x) &&
                     (((pFVar4->pt).y == (pOVar10->pt).y && (uVar7 == (lpfl2->id & 0xfe00U))))) {
                    sVar8 = FMatchTarget((FLEET *)CONCAT22(iVar9,pFVar4),mdTarget_00,1);
                    if ((sVar8 != 0) &&
                       ((lVar14 = WtFromLpfl((FLEET *)CONCAT22(iVar9,pFVar4)), lVar6 < lVar14 ||
                        ((lVar6 == lVar14 && (sVar8 = Random(2), sVar8 == 0)))))) {
                      lpflMatch = pFVar4;
                      local_12 = iVar9;
                      lVar6 = lVar14;
                    }
                    cFound = cFound + 1;
                    sVar8 = Random(cFound);
                    if ((sVar8 == 0) &&
                       (((cFound == 1 || ((*(uint *)((int)&pFVar4->dirLong + 2) >> 6 & 1) == 0)) ||
                        (sVar8 = Random(2), sVar8 != 0)))) {
                      lpflTarget = (FLEET *)CONCAT22(iVar9,pFVar4);
                    }
                  }
                }
              }
              if ((lpflMatch != (FLEET *)0x0) || (local_12 != 0)) {
                lpflTarget = (FLEET *)CONCAT22(local_12,lpflMatch);
              }
              if (((FLEET *)lpflTarget != (FLEET *)0x0) || (lpflTarget._2_2_ != 0)) {
                pOVar10->id = lpflTarget->id;
                sVar8 = (((FLEET *)lpflTarget)->pt).y;
                (lpord->pt).x = (&((FLEET *)lpflTarget)->pt)->x;
                (pOVar10->pt).y = sVar8;
                *(uint *)((int)&((FLEET *)lpflTarget)->dirLong + 2) =
                     *(uint *)((int)&((FLEET *)lpflTarget)->dirLong + 2) & 0xffbf | 0x40;
              }
            }
            else if ((pFVar4 != (FLEET *)0x0) || (iVar9 != 0)) {
              *(uint *)((int)&pFVar4->dirLong + 2) =
                   *(uint *)((int)&pFVar4->dirLong + 2) & 0xffbf | 0x40;
            }
          }
          lpord = (ORDER *)CONCAT22(uVar11,pOVar10 + 1);
        }
      }
    }
    ifl = ifl + 1;
  } while( true );
}



// ======================================================================
// Function: ChgPopFromPlanet
// Address: 1038:7082
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10387497) */
/* WARNING: Removing unreachable block (ram,0x103873eb) */
/* WARNING: Removing unreachable block (ram,0x103872a9) */
/* WARNING: Removing unreachable block (ram,0x103872ea) */
/* WARNING: Removing unreachable block (ram,0x1038730b) */
/* WARNING: Removing unreachable block (ram,0x10387136) */

long ChgPopFromPlanet(PLANET *lppl,short fUpdate)

{
  uint *puVar1;
  int *piVar2;
  undefined2 uVar3;
  undefined2 uVar4;
  uint uVar5;
  short sVar6;
  short sVar7;
  int iVar8;
  int iVar9;
  PLANET *pPVar10;
  undefined2 uVar11;
  long lVar12;
  long lVar13;
  ulong uVar14;
  ulong uVar15;
  long lVar16;
  undefined2 uVar17;
  undefined2 uVar18;
  ulong uVar19;
  long in_stack_0000ffce;
  ushort in_stack_0000ffd2;
  uint lPopInc;
  int local_1c;
  short pctDesire;
  short DeltaCur;
  int lPopIncDelta;
  short fPopDied;
  
  uVar11 = (undefined2)((ulong)lppl >> 0x10);
  pPVar10 = (PLANET *)lppl;
  if ((pPVar10->iPlayer == -1) ||
     (((int)pPVar10->rgwtMin[3] == 0 && (*(int *)((int)pPVar10->rgwtMin + 0xe) == 0)))) {
    lVar16 = 0;
  }
  else {
    sVar6 = PctPlanetDesirability(lppl,pPVar10->iPlayer);
    uVar3 = (undefined2)pPVar10->rgwtMin[3];
    uVar4 = *(undefined2 *)((int)pPVar10->rgwtMin + 0xe);
    lVar16 = CONCAT22(uVar4,uVar3);
    if (sVar6 < 0) {
      uVar18 = 0;
      uVar17 = 10;
      uVar15 = __aFulmul(CONCAT22(uVar4,uVar3),(long)-sVar6);
      lVar16 = __aFldiv(uVar15,CONCAT22(uVar18,uVar17));
      if (lVar16 < 1) {
        lVar16 = 1;
      }
      else {
        uVar18 = 0;
        uVar17 = 10;
        uVar15 = __aFulmul(CONCAT22(uVar4,uVar3),(long)-sVar6);
        lVar16 = __aFldiv(uVar15,CONCAT22(uVar18,uVar17));
      }
      lVar12 = __aFldiv(lVar16,100);
      lVar16 = __aFlrem(lVar16,100);
      if ((lVar12 == 0) && (lVar16 == 0)) {
        lVar16 = 1;
      }
      lPopIncDelta = (int)lVar16;
      if ((int)((*(uint *)pPVar10->rgbImp & 0xff) - lPopIncDelta) < 0) {
        lVar12 = lVar12 + 1;
      }
      local_1c = (int)((ulong)lVar12 >> 0x10);
      lPopInc = (uint)lVar12;
      lVar16 = CONCAT22(-(local_1c + (uint)(lPopInc != 0)),-lPopInc);
    }
    else {
      lVar12 = CalcPlanetMaxPop(lppl->id,pPVar10->iPlayer);
      sVar7 = PctTrueMaxGrowth(pPVar10->iPlayer);
      uVar15 = (ulong)(sVar7 * sVar6);
      if ((((uint)gd.grBits >> 1 & 1) != 0) &&
         (uVar15 = (long)(sVar7 * sVar6),
         (*(uint *)((int)&rgplr[0].wFlags + pPVar10->iPlayer * 0xc0) >> 2 & 1) != 0)) {
        uVar15 = __aFlshr(in_stack_0000ffce,in_stack_0000ffd2);
      }
      lVar13 = __aFldiv(lVar12,4);
      if (lVar13 < lVar16) {
        lVar13 = lVar12;
        uVar14 = __aFulmul(CONCAT22(uVar4,uVar3),1000);
        lVar13 = __aFldiv(uVar14,lVar13);
        if (lVar16 < lVar12) {
          iVar8 = 1000 - (uint)lVar13;
          iVar9 = -(uint)(1000 < (uint)lVar13) - (int)((ulong)lVar13 >> 0x10);
          uVar14 = __aFulmul(CONCAT22(iVar9,iVar8),CONCAT22(iVar9,iVar8));
          if ((long)uVar15 < 1000) {
            lVar16 = 0x89544;
            uVar15 = __aFulmul(uVar15,uVar14);
            uVar15 = __aFldiv(uVar15,lVar16);
          }
          else {
            uVar19 = 10;
            uVar18 = 8;
            uVar17 = 0x9544;
            uVar15 = __aFldiv(uVar15,10);
            uVar15 = __aFulmul(uVar15,uVar14);
            uVar15 = __aFldiv(uVar15,CONCAT22(uVar18,uVar17));
            uVar15 = __aFulmul(uVar15,uVar19);
          }
        }
        else {
          if (lVar16 < lVar12 + 10) {
            return 0;
          }
          in_stack_0000ffd2 = 0xfed4;
          lVar16 = __aFldiv(lVar13,10);
          iVar8 = -(uint)(99 < (uint)lVar16) - (int)((ulong)lVar16 >> 0x10);
          if ((-1 < iVar8) || ((-2 < iVar8 && (in_stack_0000ffd2 <= 99 - (uint)lVar16)))) {
            in_stack_0000ffce = __aFldiv(lVar13,10);
          }
          uVar15 = __aFlshl(in_stack_0000ffce,in_stack_0000ffd2);
        }
      }
      uVar14 = __aFldiv(uVar15,100);
      uVar14 = __aFulmul(CONCAT22(uVar4,uVar3),uVar14);
      if ((long)uVar14 < 10000000) {
        lVar16 = 100;
        uVar15 = __aFulmul(CONCAT22(uVar4,uVar3),uVar15);
        uVar14 = __aFldiv(uVar15,lVar16);
      }
      lVar16 = __aFldiv(uVar14,100);
      lVar12 = __aFlrem(uVar14,100);
      local_1c = (int)((ulong)lVar16 >> 0x10);
      lPopInc = (uint)lVar16;
      if ((lVar16 == 0) && (lVar12 == 0)) {
        lVar12 = 1;
      }
      lPopIncDelta = (int)lVar12;
      lPopIncDelta = (*(uint *)pPVar10->rgbImp & 0xff) + lPopIncDelta;
      if (lPopIncDelta < 100) {
        if (lPopIncDelta < 0) {
          lVar16 = CONCAT22(local_1c - (uint)(lPopInc == 0),lPopInc + -1);
        }
      }
      else {
        lVar16 = lVar16 + 1;
      }
    }
    if (fUpdate != 0) {
      lVar12 = __aFlshl(in_stack_0000ffce,in_stack_0000ffd2);
      local_1c = (int)((ulong)lVar16 >> 0x10);
      lPopInc = (uint)lVar16;
      uVar5 = *(uint *)(pPVar10->rgbImp + 2);
      *(uint *)pPVar10->rgbImp = *(uint *)pPVar10->rgbImp & 0xff00 | (uint)lVar12;
      *(uint *)(pPVar10->rgbImp + 2) = uVar5 | (uint)((ulong)lVar12 >> 0x10);
      puVar1 = (uint *)(pPVar10->rgwtMin + 3);
      uVar5 = *puVar1;
      *puVar1 = *puVar1 + lPopInc;
      piVar2 = (int *)((int)pPVar10->rgwtMin + 0xe);
      *piVar2 = *piVar2 + local_1c + (uint)CARRY2(uVar5,lPopInc);
    }
  }
  return lVar16;
}



// ======================================================================
// Function: FCanFleetUseStargates
// Address: 1038:75e2
// Segment: MEMORY_UTIL
// ======================================================================


short FCanFleetUseStargates(FLEET *lpfl,POINT ptSrc,POINT ptDst)

{
  PLANET *pPVar1;
  bool bVar2;
  bool bVar3;
  short sVar4;
  int iVar5;
  FLEET *pFVar6;
  int iVar7;
  undefined2 uVar8;
  long lVar9;
  short in_stack_0000ffce;
  short in_stack_0000ffd0;
  undefined4 in_stack_0000ffd2;
  short local_28;
  short isbsSrc;
  short ishdef;
  short fCargo;
  short isbsDst;
  PLANET *lpplSrc;
  short fDanger;
  short i;
  short fUncertain;
  short fSrcPlanet;
  short pctDmg;
  PLANET *lpplDst;
  short dTravel;
  
  bVar2 = false;
  sVar4 = FFindNearestObject(ptDst,0x81,(SCAN *)&stack0xffd0);
  if (sVar4 == 0) {
    return 0;
  }
  lpplDst = LpplFromId(local_28);
  iVar7 = (int)((ulong)lpplDst >> 0x10);
  pPVar1 = (PLANET *)lpplDst;
  pFVar6 = (FLEET *)lpfl;
  uVar8 = (undefined2)((ulong)lpfl >> 0x10);
  if (((pPVar1 == (PLANET *)0x0) && (iVar7 == 0)) || (pFVar6->iPlayer != pPVar1->iPlayer)) {
    if (((pPVar1 != (PLANET *)0x0) || (iVar7 != 0)) &&
       ((pPVar1->iPlayer == -1 && (pPVar1->turn == game.turn)))) {
      return 0;
    }
    bVar2 = true;
  }
  else {
    isbsDst = IStargateFromLppl(lpplDst);
    if (isbsDst < 0) {
      return 0;
    }
  }
  lpplSrc = (PLANET *)0x0;
  bVar3 = false;
  sVar4 = FFindNearestObject(ptSrc,0x81,(SCAN *)&stack0xffd0);
  if (sVar4 != 0) {
    bVar3 = true;
    lpplSrc = LpplFromId(local_28);
    iVar7 = (int)((ulong)lpplSrc >> 0x10);
    if ((((PLANET *)lpplSrc != (PLANET *)0x0) || (iVar7 != 0)) &&
       ((pFVar6->iPlayer == ((PLANET *)lpplSrc)->iPlayer &&
        (isbsSrc = IStargateFromLppl(lpplSrc), -1 < isbsSrc)))) {
      if (bVar2) {
        return -1;
      }
      goto LAB_1038_77e5;
    }
  }
  sVar4 = FFleetCanJumpgate(lpfl);
  if (sVar4 == 0) {
    if (bVar3) {
      if (((((PLANET *)lpplSrc == (PLANET *)0x0) && (lpplSrc._2_2_ == 0)) ||
          (((PLANET *)lpplSrc)->iPlayer != -1)) || (((PLANET *)lpplSrc)->turn != game.turn))
      {
        if ((((PLANET *)lpplSrc != (PLANET *)0x0) || (lpplSrc._2_2_ != 0)) &&
           (((PLANET *)lpplSrc)->iPlayer == pFVar6->iPlayer)) {
          return 0;
        }
        return -1;
      }
    }
    return 0;
  }
  if (bVar2) {
    return -1;
  }
  isbsSrc = isbsDst;
LAB_1038_77e5:
  bVar2 = false;
  sVar4 = GetRaceStat((PLAYER *)rgplr + pFVar6->iPlayer,rsMajorAdv);
  if (sVar4 != raStargate) {
    for (i = 0; i < 4; i = i + 1) {
      iVar7 = *(int *)((int)(pFVar6->rgwtMin + i) + 2);
      if ((-1 < iVar7) && ((0 < iVar7 || ((int)pFVar6->rgwtMin[i] != 0)))) {
        bVar2 = true;
      }
    }
  }
  DGetDistance((double *)ptSrc,ptDst.x,ptDst.y,in_stack_0000ffce,in_stack_0000ffd0);
  lVar9 = __ftol((double)CONCAT44(in_stack_0000ffd2,
                                          CONCAT22(in_stack_0000ffd0,in_stack_0000ffce)));
  dTravel = (short)lVar9;
  bVar3 = false;
  ishdef = 0;
  do {
    if (0xf < ishdef) {
      if (bVar3) {
        iVar7 = 2;
      }
      else {
        iVar7 = 0;
      }
      if (bVar2) {
        iVar5 = 4;
      }
      else {
        iVar5 = 0;
      }
      return iVar7 + 1 + iVar5;
    }
    if (pFVar6->rgcsh[ishdef] != 0) {
      iVar7 = pFVar6->iPlayer * 4;
      sVar4 = MdCalcStargateDamage
                        (isbsSrc,isbsDst,dTravel,
                         *(short *)(*(int *)(iVar7 + 0xfe) + ishdef * 0x93 + 0x28),&pctDmg);
      if (((sVar4 == -2) || (sVar4 == -1)) || (sVar4 == 0)) {
        return 0;
      }
      if ((sVar4 == 1) && (0 < pctDmg)) {
        bVar3 = true;
      }
    }
    ishdef = ishdef + 1;
  } while( true );
}



// ======================================================================
// Function: FFleetCanJumpgate
// Address: 1038:7960
// Segment: MEMORY_UTIL
// ======================================================================


short FFleetCanJumpgate(FLEET *lpfl)

{
  uint uVar1;
  int iVar2;
  HS *pHVar3;
  undefined2 uVar4;
  short j;
  short i;
  short chs;
  HS *lphs;
  
  i = 0;
  do {
    if (0xf < i) {
      return 1;
    }
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      iVar2 = ((FLEET *)lpfl)->iPlayer * 4;
      lphs = (HS *)CONCAT22(*(undefined2 *)(iVar2 + 0x100),
                            (HS *)(*(int *)(iVar2 + 0xfe) + i * 0x93 + 0x3a));
      iVar2 = ((FLEET *)lpfl)->iPlayer * 4;
      uVar1 = (uint)*(byte *)(*(int *)(iVar2 + 0xfe) + i * 0x93 + 0x7a);
      for (j = 0; j < (int)uVar1; j = j + 1) {
        uVar4 = (undefined2)((ulong)lphs >> 0x10);
        pHVar3 = (HS *)lphs;
        if (((pHVar3->wFlags_0x2 >> 8 != 0) && (lphs->grhst == hstSpecialM)) &&
           ((pHVar3->wFlags_0x2 & 0xff) == 9)) break;
        lphs = (HS *)CONCAT22(uVar4,pHVar3 + 1);
      }
      if (j == uVar1) {
        return 0;
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: WtFromLpfl
// Address: 1038:7a68
// Segment: MEMORY_UTIL
// ======================================================================


long WtFromLpfl(FLEET *lpfl)

{
  long lVar1;
  int iVar2;
  ulong uVar3;
  short i;
  
  lVar1 = 0;
  i = 0;
  while( true ) {
    if (0xf < i) break;
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      iVar2 = ((FLEET *)lpfl)->iPlayer * 4;
      uVar3 = __aFulmul((long)((FLEET *)lpfl)->rgcsh[i],
                                (ulong)*(uint *)(*(int *)(iVar2 + 0xfe) + i * 0x93 + 0x28));
      lVar1 = uVar3 + lVar1;
    }
    i = i + 1;
  }
  for (i = 0; i < 4; i = i + 1) {
    lVar1 = lVar1 + CONCAT22(*(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2),
                             (int)((FLEET *)lpfl)->rgwtMin[i]);
  }
  return lVar1;
}



// ======================================================================
// Function: FCanBuildShdef
// Address: 1038:7b40
// Segment: MEMORY_UTIL
// ======================================================================


short FCanBuildShdef(SHDEF *lpshdef,short iplr)

{
  short sVar1;
  SHDEF *pSVar2;
  HS *pHVar3;
  undefined2 uVar4;
  PART part;
  short iplrSav;
  short j;
  
  iplrSav = idPlayer;
  if ((int)(lpshdef->hul).ihuldef < 0x20) {
    part.hs.grhst = hstHull;
    part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | (lpshdef->hul).ihuldef & 0xff;
  }
  else {
    part.hs.grhst = hstSBHull;
    part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | (lpshdef->hul).ihuldef - ihuldefCount & 0xff;
  }
  idPlayer = iplr;
  sVar1 = FLookupPart(&part);
  if (sVar1 == 1) {
    j = 0;
    while( true ) {
      uVar4 = (undefined2)((ulong)lpshdef >> 0x10);
      pSVar2 = (SHDEF *)lpshdef;
      if ((int)(uint)(pSVar2->hul).chs <= j) break;
      if ((pSVar2->hul).rghs[j].wFlags_0x2 >> 8 != 0) {
        pHVar3 = (pSVar2->hul).rghs + j;
        part.hs.grhst = pHVar3->grhst;
        part.hs.wFlags_0x2 = pHVar3->wFlags_0x2;
        sVar1 = FLookupPart(&part);
        if (sVar1 != 1) goto UTIL_LFail;
      }
      j = j + 1;
    }
    idPlayer = iplrSav;
    sVar1 = 1;
  }
  else {
UTIL_LFail:
    idPlayer = iplrSav;
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: IshFindSimilarDesign
// Address: 1038:7c5e
// Segment: MEMORY_UTIL
// ======================================================================


short IshFindSimilarDesign(HUL *lphul,short iPlrDst)

{
  SHDEF *pSVar1;
  HUL *pHVar2;
  undefined2 uVar3;
  undefined2 uVar4;
  short j;
  short i;
  SHDEF *lpshdefDest;
  
  lpshdefDest = (SHDEF *)CONCAT22(*(undefined2 *)(iPlrDst * 4 + 0x100),
                                  (SHDEF *)*(undefined2 *)(iPlrDst * 4 + 0xfe));
  i = 0;
  do {
    if (0xf < i) {
      return -1;
    }
    uVar3 = (undefined2)((ulong)lpshdefDest >> 0x10);
    pSVar1 = (SHDEF *)lpshdefDest;
    if ((((pSVar1->wFlags >> 9 & 1) == 0) && ((int)pSVar1->wFlags < 0)) &&
       ((lpshdefDest->hul).ihuldef == lphul->ihuldef)) {
      uVar4 = (undefined2)((ulong)lphul >> 0x10);
      pHVar2 = (HUL *)lphul;
      if ((pSVar1->hul).chs == pHVar2->chs) {
        j = 0;
        while (((j < (int)(uint)pHVar2->chs &&
                (pHVar2->rghs[j].wFlags_0x2 >> 8 == (pSVar1->hul).rghs[j].wFlags_0x2 >> 8)) &&
               ((pHVar2->rghs[j].wFlags_0x2 >> 8 == 0 ||
                (((pHVar2->rghs[j].wFlags_0x2 & 0xff) == ((pSVar1->hul).rghs[j].wFlags_0x2 & 0xff)
                 && ((pHVar2->rghs + j)->grhst == ((pSVar1->hul).rghs + j)->grhst))))))) {
          j = j + 1;
        }
        if (j == (uint)pHVar2->chs) {
          return i;
        }
      }
    }
    i = i + 1;
    lpshdefDest = (SHDEF *)CONCAT22(uVar3,pSVar1 + 1);
  } while( true );
}



// ======================================================================
// Function: DrawPlanetPrintDot
// Address: 1038:7e44
// Segment: MEMORY_UTIL
// ======================================================================


void DrawPlanetPrintDot(HDC hdc,short x,short y,short iSize)

{
  if (iSize == 0) {
    PatBlt(hdc,x + -3,y + -1,7,3,0x42);
    PatBlt(hdc,x + -1,y + -3,3,7,0x42);
    PatBlt(hdc,x + -2,y + -2,5,5,0x42);
  }
  else {
    PatBlt(hdc,x + -5,y + -2,0xb,5,0x42);
    PatBlt(hdc,x + -2,y + -5,5,0xb,0x42);
    PatBlt(hdc,x + -4,y + -3,9,7,0x42);
    PatBlt(hdc,x + -3,y + -4,7,9,0x42);
  }
  return;
}



// ======================================================================
// Function: ClearFile
// Address: 1038:7f6a
// Segment: MEMORY_UTIL
// ======================================================================


void ClearFile(short dt)

{
  char szFile [256];
  char *pch;
  
  _strcpy(szFile,(char *)szBase);
  pch = _strrchr(szFile,0x2e);
  if (pch == (char *)0x0) {
    _strcat(szFile,(char *)0x562);
  }
  else {
    pch[1] = '\0';
  }
  _strcat(szFile,(char *)*(undefined2 *)(dt * 2 + 0x552));
  _remove(szFile);
  return;
}



// ======================================================================
// Function: OutputSz
// Address: 1038:7fe6
// Segment: MEMORY_UTIL
// ======================================================================


void OutputSz(short dt,char *sz)

{
  short sVar1;
  char *pcVar2;
  undefined2 unaff_SS;
  char szTemp [256];
  char szDate [100];
  char szFile [256];
  char szTime [102];
  
  _wsprintf((char *)CONCAT22(unaff_SS,szFile),(char *)0x11200564,(char *)szBase,0x1120,
            *(undefined2 *)(dt * 2 + 0x552),0x1120);
  sVar1 = __access(szFile,0);
  if (sVar1 == -1) {
    pcVar2 = SzVersion();
    _wsprintf((char *)CONCAT22(unaff_SS,szTemp),s_Stars___s_1120_056a,pcVar2,0x1120);
    OutputFileString(szFile,szTemp);
  }
  __strdate(szDate);
  __strtime(szTime);
  _wsprintf((char *)CONCAT22(unaff_SS,szTemp),s__s__s____s_1120_0578,szDate);
  OutputFileString(szFile,szTemp);
  return;
}



// ======================================================================
// Function: TurnLog
// Address: 1038:80c2
// Segment: MEMORY_UTIL
// ======================================================================


void TurnLog(StringId ids)

{
  int iVar1;
  char *pcVar2;
  undefined2 unaff_SS;
  char szTemp [258];
  
  if ((int)ini.wFlags < 0) {
    iVar1 = game.turn + 0x961;
    pcVar2 = PszFormatIds(ids,(short *)0x0);
    _wsprintf((char *)CONCAT22(unaff_SS,szTemp),(char *)CONCAT22(0x1120,pcVar2),iVar1);
    OutputSz(6,(char *)CONCAT22(unaff_SS,szTemp));
  }
  return;
}



