// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: FLookupSelPlanet
// Address: 1038:0000
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupSelPlanet(PLANET *param_1)

{
  short sVar1;
  
                    /* Segment:    8
                       Offset:     0002d9c0
                       Length:     8126
                       Min Alloc:  8126
                       Flags:      1d50
                           Code
                           Discardable
                           Moveable
                           Preload
                           Impure (Non-shareable)
                        */
  if (sel.scan.grobj == grobjPlanet) {
    sVar1 = FLookupPlanet(sel.scan.idpl,param_1);
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: FDupPlanet
// Address: 1038:0032
// Segment: MEMORY_UTIL
// ======================================================================


short FDupPlanet(PLANET *lppl,PLANET *ppl)

{
  PLANET *pPVar1;
  PLANET *pPVar2;
  undefined2 uVar3;
  undefined2 uVar4;
  int iVar5;
  PLANET *pPVar6;
  PLANET *pPVar7;
  PL *pPVar8;
  PLPROD *lpplprodT;
  
  uVar3 = *(undefined2 *)&ppl->lpplprod;
  uVar4 = *(undefined2 *)((int)&ppl->lpplprod + 2);
  pPVar6 = (PLANET *)lppl;
  pPVar7 = ppl;
  for (iVar5 = 0x1c; iVar5 != 0; iVar5 = iVar5 + -1) {
    pPVar2 = pPVar7;
    pPVar7 = (PLANET *)&pPVar7->iPlayer;
    pPVar1 = pPVar6;
    pPVar6 = (PLANET *)&pPVar6->iPlayer;
    pPVar2->id = pPVar1->id;
  }
  *(undefined2 *)&ppl->lpplprod = uVar3;
  *(undefined2 *)((int)&ppl->lpplprod + 2) = uVar4;
  if ((*(int *)&((PLANET *)lppl)->lpplprod == 0) &&
     (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) == 0)) {
    if ((*(int *)&ppl->lpplprod != 0) || (*(int *)((int)&ppl->lpplprod + 2) != 0)) {
      FreePl((PL *)CONCAT22(*(undefined2 *)((int)&ppl->lpplprod + 2),*(PL **)&ppl->lpplprod)
                    );
      *(undefined2 *)&ppl->lpplprod = 0;
      *(undefined2 *)((int)&ppl->lpplprod + 2) = 0;
    }
  }
  else {
    if ((*(int *)&ppl->lpplprod == 0) && (*(int *)((int)&ppl->lpplprod + 2) == 0)) {
      pPVar8 = LpplAlloc(4,(uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMax,htOrd);
      *(PL **)&ppl->lpplprod = (PL *)pPVar8;
      *(undefined2 *)((int)&ppl->lpplprod + 2) = (int)((ulong)pPVar8 >> 0x10);
    }
    else if (((PLPROD *)ppl->lpplprod)->iprodMax < ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac)
    {
      pPVar8 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&ppl->lpplprod + 2),
                                                  *(PL **)&ppl->lpplprod),
                                   (uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMax);
      *(PL **)&ppl->lpplprod = (PL *)pPVar8;
      *(undefined2 *)((int)&ppl->lpplprod + 2) = (int)((ulong)pPVar8 >> 0x10);
    }
    __fmemcpy((void *)CONCAT22(*(undefined2 *)((int)&ppl->lpplprod + 2),
                                       (void *)(*(int *)&ppl->lpplprod + 4)),
                      (void *)CONCAT22(*(undefined2 *)((int)&((PLANET *)lppl)->lpplprod + 2),
                                       (void *)(*(int *)&((PLANET *)lppl)->lpplprod + 4)),
                      (uint)((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac << 2);
    ((PLPROD *)ppl->lpplprod)->iprodMac = ((PLPROD *)((PLANET *)lppl)->lpplprod)->iprodMac;
  }
  return 1;
}



// ======================================================================
// Function: LpthFromId
// Address: 1038:01b2
// Segment: MEMORY_UTIL
// ======================================================================


THING * LpthFromId(short idth)

{
  THING *lpthMac;
  THING *lpth;
  
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < (THING *)lpThings + cThing) {
    if (lpth->idFull == idth) goto LAB_1038_0218;
    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
  }
  lpth._0_2_ = (THING *)0x0;
  lpth._2_2_ = 0;
LAB_1038_0218:
  return (THING *)CONCAT22(lpth._2_2_,(THING *)lpth);
}



// ======================================================================
// Function: LpplFromId
// Address: 1038:021e
// Segment: MEMORY_UTIL
// ======================================================================


PLANET * LpplFromId(short idPlanet)

{
  PLANET *pPVar1;
  short sVar2;
  undefined2 uVar3;
  short iHi;
  short iGuess;
  PLANET *lppl;
  short iLo;
  short idGuess;
  
  if ((idPlanet < 0) || (game.cPlanMax <= idPlanet)) {
    pPVar1 = (PLANET *)0x0;
    uVar3 = 0;
  }
  else {
    uVar3 = lpPlanets._2_2_;
    if (cPlanet == game.cPlanMax) {
      pPVar1 = (PLANET *)lpPlanets + idPlanet;
    }
    else {
      iLo = -1;
      iHi = cPlanet;
      sVar2 = iLo;
      do {
        iLo = sVar2;
        if (iHi <= iLo + 1) {
          pPVar1 = (PLANET *)0x0;
          uVar3 = 0;
          break;
        }
        sVar2 = iLo + iHi >> 1;
        pPVar1 = (PLANET *)lpPlanets + sVar2;
      } while ((pPVar1->id < idPlanet) || (iHi = sVar2, sVar2 = iLo, idPlanet < pPVar1->id));
    }
  }
  return (PLANET *)CONCAT22(uVar3,pPVar1);
}



// ======================================================================
// Function: CalcPctSurvive
// Address: 1038:02f6
// Segment: MEMORY_UTIL
// ======================================================================


void CalcPctSurvive(PLANET *lppl,float *ppct,float *ppctSmart)

{
  double dVar1;
  double dVar2;
  short sVar3;
  short sVar4;
  uint uVar5;
  uint uVar6;
  PLANET *pPVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar8;
  double *pdVar9;
  long local_20;
  short cMax;
  PART part;
  float pct;
  long cDefenses;
  short iPlrSav;
  
  if (ppctSmart != (float *)0x0) {
    *ppctSmart = DAT_1120_1c9e;
  }
  sVar3 = idPlayer;
  uVar8 = (undefined2)((ulong)lppl >> 0x10);
  pPVar7 = (PLANET *)lppl;
  if ((pPVar7->iPlayer == -1) || ((*(uint *)&pPVar7->dwFlags & 0xfff) == 0)) {
    pct = DAT_1120_1c9e;
  }
  else {
    idPlayer = pPVar7->iPlayer;
    sVar4 = FGetBestDefensePart(&part);
    if (sVar4 == 0) {
      pct = DAT_1120_1c9e;
    }
    else {
      uVar5 = *(uint *)&pPVar7->dwFlags & 0xfff;
      cDefenses = (long)uVar5;
      uVar6 = CMaxOperableDefenses(lppl,pPVar7->iPlayer,0);
      if (((int)uVar6 >> 0xf < 1) && (((int)uVar6 >> 0xf < 0 || (uVar6 < uVar5)))) {
        cDefenses = (long)(int)uVar6;
      }
      dVar1 = (double)cDefenses;
      local_20 = (long)((COMPART *)part.pcom + 1)->id;
      dVar2 = DOUBLE_1_0__1120_1caa - (double)local_20 / DOUBLE_1000_0__1120_1ca2;
      pdVar9 = _pow(SUB84(dVar2,0),
                            (double)CONCAT26((int)((qword)dVar1 >> 0x10),
                                             CONCAT24(SUB82(dVar1,0),(long)((qword)dVar2 >> 0x20))),
                            (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20)
                                                              )));
      pct = (float)*(double *)pdVar9;
      if (ppctSmart != (float *)0x0) {
        dVar1 = (double)cDefenses;
        local_20 = (long)((COMPART *)part.pcom + 1)->id;
        dVar2 = DOUBLE_1_0__1120_1caa - (double)local_20 / DOUBLE_2000_0__1120_1cb2;
        pdVar9 = _pow(SUB84(dVar2,0),
                              (double)CONCAT26((int)((qword)dVar1 >> 0x10),
                                               CONCAT24(SUB82(dVar1,0),(long)((qword)dVar2 >> 0x20))
                                              ),
                              (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >>
                                                                                0x20))));
        *ppctSmart = (float)*(double *)pdVar9;
      }
    }
  }
  idPlayer = sVar3;
  *ppct = pct;
  return;
}



// ======================================================================
// Function: FLookupPlanet
// Address: 1038:04a6
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupPlanet(short iPlanet,PLANET *ppl)

{
  PLANET *pPVar1;
  PLANET *pPVar2;
  bool bVar3;
  short sVar4;
  int iVar5;
  int iVar6;
  PLANET *pPVar7;
  PLANET *pPVar8;
  PL *pPVar9;
  short fWrite;
  PLANET *lpPl;
  
  bVar3 = false;
  if (cPlanet < 1) {
    return 0;
  }
  if (iPlanet < 0) {
    iPlanet = ppl->id;
    if (iPlanet == -1) {
      LogChangePlanet((PLANET *)0x0,ppl);
      return 1;
    }
    bVar3 = true;
  }
  pPVar8 = LpplFromId(iPlanet);
  iVar6 = (int)((ulong)pPVar8 >> 0x10);
  pPVar2 = (PLANET *)pPVar8;
  if (((pPVar2 == (PLANET *)0x0) && (iVar6 == 0)) || (ppl == (PLANET *)0x0)) goto LAB_1038_0722;
  if (!bVar3) {
    if (ppl == (PLANET *)&sel.pl) {
      FDupPlanet(pPVar8,(PLANET *)&sel.pl);
    }
    else {
      pPVar7 = pPVar2;
      for (iVar5 = 0x1c; iVar5 != 0; iVar5 = iVar5 + -1) {
        pPVar1 = ppl;
        ppl = (PLANET *)&ppl->iPlayer;
        pPVar8 = pPVar7;
        pPVar7 = (PLANET *)&pPVar7->iPlayer;
        pPVar1->id = pPVar8->id;
      }
    }
    goto LAB_1038_0722;
  }
  InvalidateReport(0,0);
  LogChangePlanet(pPVar8,ppl);
  if ((*(int *)&pPVar2->lpplprod != *(int *)&ppl->lpplprod) ||
     (*(int *)((int)&pPVar2->lpplprod + 2) != *(int *)((int)&ppl->lpplprod + 2))) {
    if ((*(int *)&pPVar2->lpplprod == 0) && (*(int *)((int)&pPVar2->lpplprod + 2) == 0)) {
      if ((*(int *)&ppl->lpplprod != 0) || (*(int *)((int)&ppl->lpplprod + 2) != 0)) {
        pPVar9 = LpplAlloc(4,(uint)((PLPROD *)ppl->lpplprod)->iprodMac,htOrd);
        *(PL **)&pPVar2->lpplprod = (PL *)pPVar9;
        *(undefined2 *)((int)&pPVar2->lpplprod + 2) = (int)((ulong)pPVar9 >> 0x10);
      }
    }
    else if ((*(int *)&ppl->lpplprod == 0) && (*(int *)((int)&ppl->lpplprod + 2) == 0)) {
      FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pPVar2->lpplprod + 2),
                                    *(PL **)&pPVar2->lpplprod));
      *(undefined2 *)&pPVar2->lpplprod = 0;
      *(undefined2 *)((int)&pPVar2->lpplprod + 2) = 0;
      goto UTIL_FinishCopy;
    }
    if (((PLPROD *)pPVar2->lpplprod)->iprodMax < ((PLPROD *)ppl->lpplprod)->iprodMac) {
      pPVar9 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&pPVar2->lpplprod + 2),
                                                  *(PL **)&pPVar2->lpplprod),
                                   ((PLPROD *)ppl->lpplprod)->iprodMac + 2);
      *(PL **)&pPVar2->lpplprod = (PL *)pPVar9;
      *(undefined2 *)((int)&pPVar2->lpplprod + 2) = (int)((ulong)pPVar9 >> 0x10);
    }
    __fmemcpy((void *)CONCAT22(*(undefined2 *)((int)&pPVar2->lpplprod + 2),
                                       (void *)(*(int *)&pPVar2->lpplprod + 4)),
                      (void *)CONCAT22(*(undefined2 *)((int)&ppl->lpplprod + 2),
                                       (void *)(*(int *)&ppl->lpplprod + 4)),
                      (uint)((PLPROD *)ppl->lpplprod)->iprodMac << 2);
    ((PLPROD *)pPVar2->lpplprod)->iprodMac = ((PLPROD *)ppl->lpplprod)->iprodMac;
  }
UTIL_FinishCopy:
  __fmemcpy(pPVar8,(PLANET *)CONCAT22((undefined1 *)&DAT_1120_1120,ppl),0x34);
  if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
    AdvanceTutor();
  }
LAB_1038_0722:
  if ((pPVar2 == (PLANET *)0x0) && (iVar6 == 0)) {
    sVar4 = 0;
  }
  else {
    sVar4 = 1;
  }
  return sVar4;
}



// ======================================================================
// Function: DpOfLpflIshdef
// Address: 1038:0746
// Segment: MEMORY_UTIL
// ======================================================================


long DpOfLpflIshdef(FLEET *lpfl,short ishdef)

{
  FLEET *pFVar1;
  int iVar2;
  undefined2 uVar3;
  ulong uVar4;
  long lVar5;
  long dp;
  short dpShdef;
  
  uVar3 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar1 = (FLEET *)lpfl;
  iVar2 = pFVar1->iPlayer * 4;
  lVar5 = 5000;
  uVar4 = __aFulmul((long)pFVar1->rgcsh[ishdef],
                            (long)(int)(((int)(((pFVar1->rgdv + ishdef)->dp & 0x7fU) *
                                              *(int *)(*(int *)(iVar2 + 0xfe) + ishdef * 0x93 + 0x38
                                                      )) / 10) *
                                       ((uint)(pFVar1->rgdv + ishdef)->dp >> 7)));
  lVar5 = __aFldiv(uVar4,lVar5);
  return lVar5;
}



// ======================================================================
// Function: FLookupThing
// Address: 1038:07fe
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupThing(short idth,THING *pth)

{
  THING *pTVar1;
  THING *pTVar2;
  THING *pTVar3;
  short sVar4;
  int iVar5;
  bool bVar6;
  THING *lpth_00;
  short fWrite;
  THING *lpth;
  
  if (cThing < 1) {
    sVar4 = 0;
  }
  else {
    bVar6 = idth < 0;
    if (bVar6) {
      idth = pth->idFull;
    }
    lpth_00 = LpthFromId(idth);
    pTVar3 = (THING *)lpth_00;
    if ((lpth_00 != (THING *)0x0) && (pth != (THING *)0x0)) {
      if (bVar6) {
        LogChangeThing(lpth_00,pth);
        __fmemcpy(lpth_00,(THING *)CONCAT22((undefined1 *)&DAT_1120_1120,pth),0x12);
        if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
          AdvanceTutor();
        }
      }
      else {
        for (iVar5 = 9; iVar5 != 0; iVar5 = iVar5 + -1) {
          pTVar2 = pth;
          pth = (THING *)&pth->pt;
          pTVar1 = pTVar3;
          pTVar3 = (THING *)&pTVar3->pt;
          pTVar2->idFull = pTVar1->idFull;
        }
      }
    }
    if (lpth_00 == (THING *)0x0) {
      sVar4 = 0;
    }
    else {
      sVar4 = 1;
    }
  }
  return sVar4;
}



// ======================================================================
// Function: SelectOursAtObject
// Address: 1038:08f2
// Segment: MEMORY_UTIL
// ======================================================================


void SelectOursAtObject(POINT *ppt)

{
  FLEET *pFVar1;
  int iVar2;
  POINT pt_00;
  POINT pt_01;
  short sVar3;
  SCAN scan;
  FLEET *lpfl;
  short i;
  short ish;
  POINT pt;
  short id;
  
  if (ppt->x == -1) {
    if ((ppt->y & 0x8000U) != 0) {
      SelectAdjFleet(0,ppt->y & 0x7fff);
      return;
    }
    pt.x = ((POINT *)rgptPlan + ppt->y)->x;
    pt.y = *(short *)((int)&rgptPlan[0].y + ppt->y * 4);
  }
  else {
    pt.x = ppt->x;
    pt.y = ppt->y;
  }
  id = -1;
  for (ish = 0; ish < cFleet; ish = ish + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[ish];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + ish) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    if ((pt.x == (&pFVar1->pt)->x) && (pt.y == (pFVar1->pt).y)) {
      if (pFVar1->iPlayer == idPlayer) {
        SelectAdjFleet(0,lpfl->id);
        return;
      }
      if (id == -1) {
        id = lpfl->id;
      }
    }
  }
  i = 0;
  while( true ) {
    if (game.cPlanMax <= i) {
      scan.iwp = -1;
      pt_00.y = pt.y;
      pt_00.x = pt.x;
      sVar3 = FFindNearestObject(pt_00,grobjThing,&scan);
      if ((((sVar3 == 0) || (scan.grobj != grobjThing)) || (scan.ith == -1)) ||
         (((uint)((THING *)lpThings + scan.ith)->idFull >> 0xd != 1 ||
          ((*(uint *)((THING *)lpThings)[scan.ith].rgb >> 10 & 0xf) != 0)))) {
        if (id != -1) {
          SelectAdjFleet(0,id);
        }
      }
      else {
        ChangeScanSel(&scan,1);
        pt_01.y = scan.pt.y;
        pt_01.x = scan.pt.x;
        FEnsurePointOnScreen(pt_01,1);
        UpdateWindow(hwndScanner);
        SendMessage(hwndScanner,0x102,0x76,0);
      }
      return;
    }
    if ((((POINT *)rgptPlan + i)->x == pt.x) &&
       (*(int *)((int)&rgptPlan[0].y + i * 4) == pt.y)) break;
    i = i + 1;
  }
  SelectAdjPlanet(0,i);
  return;
}



// ======================================================================
// Function: LComputePower
// Address: 1038:0b32
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10380da6) */

long LComputePower(SHDEF *lpshdef)

{
  long lVar1;
  int iVar2;
  uint uVar3;
  short sVar4;
  int iVar5;
  HS *pHVar6;
  COMPART *pCVar7;
  undefined2 uVar8;
  bool bVar9;
  ulong uVar10;
  ulong uVar11;
  ulong uVar12;
  long lVar13;
  PART part;
  long dp;
  long dpBombs;
  long dpBeams;
  long pctCap;
  short i;
  long dpTorps;
  short ihs;
  short dxRange;
  short dSpeed;
  
  dpBombs._0_2_ = 0;
  dpBombs._2_2_ = 0;
  uVar12 = 0;
  lVar1 = 0;
  uVar11 = 1000;
  ihs = 0;
  while( true ) {
    uVar8 = (undefined2)((ulong)lpshdef >> 0x10);
    if ((int)(uint)(((SHDEF *)lpshdef)->hul).chs <= ihs) break;
    pHVar6 = (((SHDEF *)lpshdef)->hul).rghs + ihs;
    part.hs.grhst = pHVar6->grhst;
    part.hs.wFlags = pHVar6->wFlags;
    if (((uint)part.hs.wFlags >> 8 != 0) && (sVar4 = FLookupPart(&part), sVar4 != 0)) {
      pCVar7 = (COMPART *)part.pcom;
      uVar8 = (undefined2)((ulong)part.pcom >> 0x10);
      if (part.hs.grhst == hstBeam) {
        lVar13 = 4;
        iVar2 = (pCVar7 + 1)->id + 3;
        iVar5 = iVar2 >> 0xf;
        uVar10 = __aFulmul((long)*(int *)pCVar7[1].rgTech,(ulong)((uint)part.hs.wFlags >> 8)
                                  );
        uVar10 = __aFulmul(uVar10,CONCAT22(iVar5,iVar2));
        lVar13 = __aFldiv(uVar10,lVar13);
        if ((*(uint *)(((COMPART *)part.pcom)[1].rgTech + 4) & 1) != 0) {
          lVar13 = __aFldiv(lVar13,3);
        }
        uVar12 = lVar13 + uVar12;
      }
      else if (part.hs.grhst == hstTorp) {
        lVar13 = 2;
        iVar2 = (pCVar7 + 1)->id + -2;
        iVar5 = iVar2 >> 0xf;
        uVar10 = __aFulmul((long)*(int *)pCVar7[1].rgTech,(ulong)((uint)part.hs.wFlags >> 8)
                                  );
        uVar10 = __aFulmul(uVar10,CONCAT22(iVar5,iVar2));
        lVar13 = __aFldiv(uVar10,lVar13);
        lVar1 = lVar13 + lVar1;
      }
      else if (part.hs.grhst == hstBomb) {
        uVar3 = (*(int *)pCVar7[1].rgTech + *(int *)(pCVar7[1].rgTech + 2)) *
                ((uint)part.hs.wFlags >> 8) * 2;
        bVar9 = CARRY2((uint)dpBombs,uVar3);
        dpBombs._0_2_ = (uint)dpBombs + uVar3;
        dpBombs._2_2_ = dpBombs._2_2_ + (uint)bVar9;
      }
      else if ((part.hs.grhst == hstSpecialE) &&
              (((part.hs.wFlags & 0xffU) == 0xc || ((part.hs.wFlags & 0xffU) == 0xd)))) {
        for (i = (uint)part.hs.wFlags >> 8; 0 < i; i = i + -1) {
          lVar13 = 100;
          uVar3 = ((COMPART *)part.pcom + 1)->id;
          uVar11 = __aFulmul(uVar11,CONCAT22(((int)uVar3 >> 0xf) + (uint)(0xff9b < uVar3),
                                                     uVar3 + 100));
          uVar11 = __aFldiv(uVar11,lVar13);
        }
      }
    }
    ihs = ihs + 1;
  }
  if (uVar11 != 1000) {
    uVar11 = __aFldiv(uVar11,10);
    if (0xff < (long)uVar11) {
      uVar11 = 0xff;
    }
    lVar13 = 100;
    uVar11 = __aFulmul(uVar12,uVar11);
    uVar12 = __aFldiv(uVar11,lVar13);
  }
  sVar4 = SpdOfShip((FLEET *)0x0,0,(TOK *)0x0,0,lpshdef);
  lVar13 = 10;
  uVar11 = __aFulmul(uVar12,(long)(sVar4 + -4));
  lVar13 = __aFldiv(uVar11,lVar13);
  return lVar1 + uVar12 + lVar13 + CONCAT22(dpBombs._2_2_,(uint)dpBombs);
}



// ======================================================================
// Function: ComputeShdefPowers
// Address: 1038:0e4e
// Segment: MEMORY_UTIL
// ======================================================================


void ComputeShdefPowers(void)

{
  undefined2 uVar1;
  int iVar2;
  long lVar3;
  short ishdef;
  short iplr;
  
  for (iplr = 0; iplr < game.cPlayer; iplr = iplr + 1) {
    if ((*(int *)(iplr * 4 + 0xfe) != 0) || (*(int *)(iplr * 4 + 0x100) != 0)) {
      for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
        if ((*(uint *)(*(int *)(iplr * 4 + 0xfe) + ishdef * 0x93 + 0x7b) >> 9 & 1) == 0) {
          lVar3 = LComputePower((SHDEF *)CONCAT22(*(undefined2 *)(iplr * 4 + 0x100),
                                                  (SHDEF *)(*(int *)(iplr * 4 + 0xfe) +
                                                           ishdef * 0x93)));
          uVar1 = *(undefined2 *)(iplr * 4 + 0x100);
          iVar2 = *(int *)(iplr * 4 + 0xfe) + ishdef * 0x93;
          *(undefined2 *)(iVar2 + 0x87) = (int)lVar3;
          *(undefined2 *)(iVar2 + 0x89) = (int)((ulong)lVar3 >> 0x10);
        }
      }
    }
  }
  return;
}



// ======================================================================
// Function: DpShieldOfShdef
// Address: 1038:0f24
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x103810d2) */

long DpShieldOfShdef(SHDEF *lpshdef,short iplr)

{
  byte bVar1;
  long lVar2;
  uint uVar3;
  short sVar4;
  HS *pHVar5;
  ushort unaff_DI;
  undefined2 uVar6;
  bool bVar7;
  long lVar8;
  long lVar9;
  PART part;
  HUL *lphul;
  long dpShdef;
  short ihs;
  HS *lphs;
  short chs;
  
  dpShdef._0_2_ = 0;
  dpShdef._2_2_ = 0;
  lphs = (HS *)CONCAT22(lpshdef._2_2_,(((SHDEF *)lpshdef)->hul).rghs);
  bVar1 = (((SHDEF *)lpshdef)->hul).chs;
  for (ihs = 0; lVar2 = CONCAT22(dpShdef._2_2_,(uint)dpShdef), ihs < (int)(uint)bVar1; ihs = ihs + 1
      ) {
    pHVar5 = (HS *)lphs;
    uVar6 = (undefined2)((ulong)lphs >> 0x10);
    if ((lphs->grhst == hstShield) && ((uint)pHVar5->wFlags >> 8 != 0)) {
      part.hs.grhst = lphs->grhst;
      part.hs.wFlags = pHVar5->wFlags;
      FLookupPart(&part);
      uVar3 = ((COMPART *)part.pcom + 1)->id * ((uint)pHVar5->wFlags >> 8);
      bVar7 = CARRY2((uint)dpShdef,uVar3);
      dpShdef._0_2_ = (uint)dpShdef + uVar3;
      dpShdef._2_2_ = dpShdef._2_2_ + (uint)bVar7;
    }
    else if (((lphs->grhst == hstArmor) && ((uint)pHVar5->wFlags >> 8 != 0)) &&
            ((pHVar5->wFlags & 0xffU) == 6)) {
      uVar3 = ((uint)pHVar5->wFlags >> 8) * 0x32;
      bVar7 = CARRY2((uint)dpShdef,uVar3);
      dpShdef._0_2_ = (uint)dpShdef + uVar3;
      dpShdef._2_2_ = dpShdef._2_2_ + (uint)bVar7;
    }
    else if ((lphs->grhst == hstArmor) && ((pHVar5->wFlags & 0xffU) == 9)) {
      uVar3 = ((uint)pHVar5->wFlags >> 8) * 100;
      bVar7 = CARRY2((uint)dpShdef,uVar3);
      dpShdef._0_2_ = (uint)dpShdef + uVar3;
      dpShdef._2_2_ = dpShdef._2_2_ + (uint)bVar7;
    }
    lphs = (HS *)CONCAT22(uVar6,pHVar5 + 1);
  }
  sVar4 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceRegeneratingShields);
  if (sVar4 != 0) {
    lVar9 = 5;
    lVar8 = __aFlshl(5,unaff_DI);
    lVar8 = __aFldiv(lVar8,lVar9);
    lVar2 = lVar8 + lVar2;
  }
  dpShdef._2_2_ = (int)((ulong)lVar2 >> 0x10);
  dpShdef._0_2_ = (uint)lVar2;
  if (dpShdef._2_2_ != 0) {
    dpShdef._0_2_ = 0xffff;
  }
  return (long)(uint)dpShdef;
}



// ======================================================================
// Function: IStargateFromLppl
// Address: 1038:10fa
// Segment: MEMORY_UTIL
// ======================================================================


short IStargateFromLppl(PLANET *lppl)

{
  undefined2 uVar1;
  int iVar2;
  HUL *lphul;
  short ihs;
  HS *lphs;
  short chs;
  
  if ((lppl != (PLANET *)0x0) && (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)) {
    iVar2 = ((PLANET *)lppl)->iPlayer * 4;
    uVar1 = *(undefined2 *)(iVar2 + 0x14e);
    iVar2 = *(int *)(iVar2 + 0x14c) + (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) * 0x93;
    lphs = (HS *)CONCAT22(uVar1,(HS *)(iVar2 + 0x3a));
    for (ihs = 0; ihs < (int)(uint)*(byte *)(iVar2 + 0x7a); ihs = ihs + 1) {
      if (((lphs->grhst == hstSpecialSB) && ((uint)((HS *)lphs)->wFlags >> 8 != 0)) &&
         ((((HS *)lphs)->wFlags & 0xffU) < 7)) {
        return ((HS *)lphs)->wFlags & 0xff;
      }
      lphs = (HS *)CONCAT22(lphs._2_2_,(HS *)lphs + 1);
    }
  }
  return -1;
}



// ======================================================================
// Function: PszPlayerName
// Address: 1038:11f2
// Segment: MEMORY_UTIL
// ======================================================================


char * PszPlayerName(short iPlayer,short fCapital,short fPlural,short fThe,short grWord,PLAYER *pplr)

{
  int iVar1;
  char *pcVar2;
  ushort uVar3;
  char *unaff_SS;
  char szName [50];
  char *pchEnd;
  
  if (pplr == (PLAYER *)0x0) {
    pplr = (PLAYER *)rgplr + iPlayer;
  }
  if (pplr->szName[0] == '\0') {
    iVar1 = iPlayer + 1;
    pcVar2 = PszGetCompressedString(idsPlayerD2);
    _WSPRINTF((LPSTR)CONCAT22(iVar1,(char *)&DAT_1120_1120),(LPCSTR)CONCAT22(pcVar2,unaff_SS),szName
             );
    if (fPlural == 0) {
      _strcat(szName,(char *)0x515);
    }
    if (grWord == 1) {
      uVar3 = _strlen(szName);
      CchGetString(idsHas,szName + uVar3);
    }
    else if (grWord == 2) {
      uVar3 = _strlen(szName);
      CchGetString(idsIs2,szName + uVar3);
    }
  }
  else {
    if (fThe == 0) {
      szName[0] = '\0';
    }
    else {
      _strcpy(szName,(char *)0x50e);
      if (fCapital != 0) {
        szName[0] = 'T';
      }
    }
    if ((fPlural == 0) || (pplr->szNames[0] == '\0')) {
      _strcat(szName,pplr->szName);
    }
    else {
      _strcat(szName,pplr->szNames);
    }
    uVar3 = _strlen(szName);
    pchEnd = szName + (uVar3 - 1);
    while ((*pchEnd == ' ' && (szName <= pchEnd))) {
      *pchEnd = '\0';
      pchEnd = pchEnd + -1;
    }
    if (pchEnd < szName) {
      CchGetString(idsName,szName);
    }
    if ((fPlural != 0) && (pplr->szNames[0] == '\0')) {
      uVar3 = _strlen(szName);
      if ((szName[uVar3 - 1] != 's') && ((szName[uVar3 - 1] != 'e' || (szName[uVar3 - 2] != 's'))))
      {
        _strcat(szName,(char *)0x513);
      }
    }
    if (grWord == 1) {
      uVar3 = _strlen(szName);
      CchGetString(idsHave2,szName + uVar3);
    }
    else if (grWord == 2) {
      uVar3 = _strlen(szName);
      CchGetString(idsAre,szName + uVar3);
    }
  }
  _strcpy((char *)szWork,szName);
  return (char *)szWork;
}



// ======================================================================
// Function: FCalcFleetBombDamage
// Address: 1038:145c
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10381747) */
/* WARNING: Removing unreachable block (ram,0x10381690) */

short FCalcFleetBombDamage
          (FLEET *lpfl,long *pdmgPeople,long *pdmgPeopleMin,long *pdmgPeopleSmart,long *pdmgBldg,
          long *ppctTerra,short *pfMulti)

{
  uint *puVar1;
  uint uVar2;
  int iVar3;
  bool bVar4;
  FLEET *pFVar5;
  short sVar6;
  HullSlotType *pHVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar8;
  ulong uVar9;
  long lVar10;
  ulong uVar11;
  int in_stack_0000ffc4;
  int in_stack_0000ffc6;
  double dmgT;
  long cIter;
  PART part;
  short ishdef;
  short j;
  short fBomber;
  double dmgSmart;
  FLEET *lpflHead;
  short dmgFloor;
  FLEET *lpflNext;
  short cfl;
  short iplr;
  
  pFVar5 = lpfl;
  iVar3 = ((FLEET *)lpfl)->iPlayer;
  cfl = 0;
  *(undefined2 *)ppctTerra = 0;
  *(undefined2 *)((int)ppctTerra + 2) = 0;
  *(undefined2 *)pdmgPeopleMin = 0;
  *(undefined2 *)((int)pdmgPeopleMin + 2) = 0;
  *(undefined2 *)pdmgBldg = 0;
  *(undefined2 *)((int)pdmgBldg + 2) = 0;
  *(undefined2 *)pdmgPeopleSmart = 0;
  *(undefined2 *)((int)pdmgPeopleSmart + 2) = 0;
  *(undefined2 *)pdmgPeople = 0;
  *(undefined2 *)((int)pdmgPeople + 2) = 0;
  while( true ) {
    if (((FLEET *)lpfl == (FLEET *)0x0) && (lpfl._2_2_ == 0)) break;
    ((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0xefffU | 0x1000;
    for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[ishdef]) {
        for (j = 0; j < (int)(uint)*(byte *)(*(int *)(iVar3 * 4 + 0xfe) + ishdef * 0x93 + 0x7a);
            j = j + 1) {
          if (*(int *)(*(int *)(iVar3 * 4 + 0xfe) + ishdef * 0x93 + 0x3a + j * 4) == 0x40) {
            uVar8 = *(undefined2 *)(iVar3 * 4 + 0x100);
            pHVar7 = (HullSlotType *)(*(int *)(iVar3 * 4 + 0xfe) + ishdef * 0x93 + 0x3a + j * 4);
            part.hs.grhst = *pHVar7;
            part.hs.wFlags = pHVar7[1];
            FLookupPart(&part);
            if ((part.hs.wFlags & 0xffU) == 9) {
              uVar9 = __aFulmul((ulong)((uint)part.hs.wFlags >> 8),
                                        (long)((FLEET *)lpfl)->rgcsh[ishdef]);
              puVar1 = (uint *)ppctTerra;
              uVar2 = *puVar1;
              *puVar1 = *puVar1 + (uint)uVar9;
              *(int *)((int)ppctTerra + 2) =
                   *(int *)((int)ppctTerra + 2) + (int)(uVar9 >> 0x10) +
                   (uint)CARRY2(uVar2,(uint)uVar9);
            }
            else if ((uint)part.hs.wFlags >> 8 != 0) {
              uVar8 = (undefined2)((ulong)part.pcom >> 0x10);
              if (*(int *)(((COMPART *)part.pcom)[1].rgTech + 2) == 0) {
                uVar9 = __aFulmul((ulong)((uint)part.hs.wFlags >> 8),
                                          (long)((FLEET *)lpfl)->rgcsh[ishdef]);
                in_stack_0000ffc4 = *(int *)((COMPART *)part.pcom)[1].rgTech;
                in_stack_0000ffc6 = in_stack_0000ffc4 >> 0xf;
                do {
                  cIter._2_2_ = (int)(uVar9 >> 0x10);
                  cIter._0_2_ = (int)uVar9;
                  bVar4 = 0 < (long)uVar9;
                  uVar9 = CONCAT22(cIter._2_2_ - (uint)((int)cIter == 0),(int)cIter + -1);
                } while (bVar4);
              }
              else {
                uVar11 = (ulong)*(int *)((COMPART *)part.pcom)[1].rgTech;
                uVar9 = __aFulmul((ulong)((uint)part.hs.wFlags >> 8),
                                          (long)((FLEET *)lpfl)->rgcsh[ishdef]);
                uVar9 = __aFulmul(uVar9,uVar11);
                puVar1 = (uint *)pdmgPeople;
                uVar2 = *puVar1;
                *puVar1 = *puVar1 + (uint)uVar9;
                *(int *)((int)pdmgPeople + 2) =
                     *(int *)((int)pdmgPeople + 2) + (int)(uVar9 >> 0x10) +
                     (uint)CARRY2(uVar2,(uint)uVar9);
                uVar11 = (ulong)*(int *)(((COMPART *)part.pcom)[1].rgTech + 2);
                uVar9 = __aFulmul((ulong)((uint)part.hs.wFlags >> 8),
                                          (long)((FLEET *)lpfl)->rgcsh[ishdef]);
                uVar9 = __aFulmul(uVar9,uVar11);
                puVar1 = (uint *)pdmgBldg;
                uVar2 = *puVar1;
                *puVar1 = *puVar1 + (uint)uVar9;
                *(int *)((int)pdmgBldg + 2) =
                     *(int *)((int)pdmgBldg + 2) + (int)(uVar9 >> 0x10) +
                     (uint)CARRY2(uVar2,(uint)uVar9);
                if ((part.hs.wFlags & 0xffU) < 5) {
                  uVar11 = 3;
                  uVar9 = __aFulmul((ulong)((uint)part.hs.wFlags >> 8),
                                            (long)((FLEET *)lpfl)->rgcsh[ishdef]);
                  uVar9 = __aFulmul(uVar9,uVar11);
                  puVar1 = (uint *)pdmgPeopleMin;
                  uVar2 = *puVar1;
                  *puVar1 = *puVar1 + (uint)uVar9;
                  *(int *)((int)pdmgPeopleMin + 2) =
                       *(int *)((int)pdmgPeopleMin + 2) + (int)(uVar9 >> 0x10) +
                       (uint)CARRY2(uVar2,(uint)uVar9);
                }
              }
            }
          }
          else if ((*(int *)(*(int *)(iVar3 * 4 + 0xfe) + ishdef * 0x93 + 0x3a + j * 4) == 0x10) &&
                  ((*(uint *)(*(int *)(iVar3 * 4 + 0xfe) + ishdef * 0x93 + j * 4 + 0x3c) & 0xff) ==
                   0x12)) {
            uVar8 = *(undefined2 *)(iVar3 * 4 + 0x100);
            pHVar7 = (HullSlotType *)(*(int *)(iVar3 * 4 + 0xfe) + ishdef * 0x93 + 0x3a + j * 4);
            part.hs.grhst = *pHVar7;
            part.hs.wFlags = pHVar7[1];
            uVar11 = 0x14;
            uVar9 = __aFulmul((ulong)((uint)part.hs.wFlags >> 8),
                                      (long)((FLEET *)lpfl)->rgcsh[ishdef]);
            uVar9 = __aFulmul(uVar9,uVar11);
            puVar1 = (uint *)pdmgPeople;
            uVar2 = *puVar1;
            *puVar1 = *puVar1 + (uint)uVar9;
            *(int *)((int)pdmgPeople + 2) =
                 *(int *)((int)pdmgPeople + 2) + (int)(uVar9 >> 0x10) +
                 (uint)CARRY2(uVar2,(uint)uVar9);
            uVar11 = 5;
            uVar9 = __aFulmul((ulong)((uint)part.hs.wFlags >> 8),
                                      (long)((FLEET *)lpfl)->rgcsh[ishdef]);
            uVar9 = __aFulmul(uVar9,uVar11);
            puVar1 = (uint *)pdmgBldg;
            uVar2 = *puVar1;
            *puVar1 = *puVar1 + (uint)uVar9;
            *(int *)((int)pdmgBldg + 2) =
                 *(int *)((int)pdmgBldg + 2) + (int)(uVar9 >> 0x10) +
                 (uint)CARRY2(uVar2,(uint)uVar9);
            uVar11 = 3;
            uVar9 = __aFulmul((ulong)((uint)part.hs.wFlags >> 8),
                                      (long)((FLEET *)lpfl)->rgcsh[ishdef]);
            uVar9 = __aFulmul(uVar9,uVar11);
            puVar1 = (uint *)pdmgPeopleMin;
            uVar2 = *puVar1;
            *puVar1 = *puVar1 + (uint)uVar9;
            *(int *)((int)pdmgPeopleMin + 2) =
                 *(int *)((int)pdmgPeopleMin + 2) + (int)(uVar9 >> 0x10) +
                 (uint)CARRY2(uVar2,(uint)uVar9);
          }
          else if ((*(int *)(*(int *)(iVar3 * 4 + 0xfe) + ishdef * 0x93 + 0x3a + j * 4) == 0x1000)
                  && ((*(uint *)(*(int *)(iVar3 * 4 + 0xfe) + ishdef * 0x93 + j * 4 + 0x3c) & 0xff)
                      == 1)) {
            uVar8 = *(undefined2 *)(iVar3 * 4 + 0x100);
            pHVar7 = (HullSlotType *)(*(int *)(iVar3 * 4 + 0xfe) + ishdef * 0x93 + 0x3a + j * 4);
            part.hs.grhst = *pHVar7;
            part.hs.wFlags = pHVar7[1];
            uVar11 = 0x14;
            uVar9 = __aFulmul((ulong)((uint)part.hs.wFlags >> 8),
                                      (long)((FLEET *)lpfl)->rgcsh[ishdef]);
            uVar9 = __aFulmul(uVar9,uVar11);
            puVar1 = (uint *)pdmgPeopleMin;
            uVar2 = *puVar1;
            *puVar1 = *puVar1 + (uint)uVar9;
            *(int *)((int)pdmgPeopleMin + 2) =
                 *(int *)((int)pdmgPeopleMin + 2) + (int)(uVar9 >> 0x10) +
                 (uint)CARRY2(uVar2,(uint)uVar9);
          }
        }
      }
    }
    cfl = cfl + 1;
                    /* WARNING: Load size is inaccurate */
    lpflNext = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpflNext + 2),
                                 ((FLEET *)lpfl)->lpflNext);
    while( true ) {
      if ((lpflNext == (FLEET *)0x0) ||
         ((((uint)((FLEET *)lpflNext)->wFlags >> 10 & 1) == 0 &&
          (((FLEET *)lpflNext)->iPlayer == iVar3)))) break;
                    /* WARNING: Load size is inaccurate */
      lpflNext = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflNext)->lpflNext + 2),
                                   ((FLEET *)lpflNext)->lpflNext);
    }
    if ((lpflNext == (FLEET *)0x0) ||
       ((pFVar5 == lpflNext || (((FLEET *)lpflNext)->idPlanet != ((FLEET *)lpfl)->idPlanet)))) {
      lpfl = (FLEET *)0x0;
    }
    else {
      lpfl = lpflNext;
    }
  }
  lVar10 = __ftol((double)CONCAT26(in_stack_0000ffc6,
                                           CONCAT24(in_stack_0000ffc4,CONCAT22(unaff_SI,unaff_DI))))
  ;
  *(int *)pdmgPeopleSmart = (int)lVar10;
  *(undefined2 *)((int)pdmgPeopleSmart + 2) = (int)((ulong)lVar10 >> 0x10);
  if ((-1 < *(int *)((int)pdmgPeopleSmart + 2)) &&
     ((0 < *(int *)((int)pdmgPeopleSmart + 2) || (999 < *(uint *)pdmgPeopleSmart)))) {
    *(undefined2 *)pdmgPeopleSmart = 1000;
    *(undefined2 *)((int)pdmgPeopleSmart + 2) = 0;
  }
  *pfMulti = (uint)(1 < cfl);
  if ((((((((int)*pdmgPeople == 0) && (*(int *)((int)pdmgPeople + 2) == 0)) &&
         ((int)*pdmgPeopleMin == 0)) &&
        ((*(int *)((int)pdmgPeopleMin + 2) == 0 && ((int)*pdmgPeopleSmart == 0)))) &&
       ((*(int *)((int)pdmgPeopleSmart + 2) == 0 &&
        (((int)*pdmgBldg == 0 && (*(int *)((int)pdmgBldg + 2) == 0)))))) && ((int)*ppctTerra == 0))
     && (*(int *)((int)ppctTerra + 2) == 0)) {
    sVar6 = 0;
  }
  else {
    sVar6 = 1;
  }
  return sVar6;
}



// ======================================================================
// Function: LinkFleets
// Address: 1038:1bb4
// Segment: MEMORY_UTIL
// ======================================================================


void LinkFleets(short fUnused)

{
  int iVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  int *piVar5;
  uint uVar6;
  FLEET *pFVar7;
  undefined2 uVar8;
  undefined2 uVar9;
  short cSrc;
  short iflHead;
  short iflTail;
  short i;
  FLEET *lpflHead;
  FLEET *lpflTail;
  FLEET *rglpflSrc [1];
  POINT pt;
  FLEET **pSearch;
  
  for (iflHead = 0; iflHead < cFleet; iflHead = iflHead + 1) {
    iVar1 = *(int *)((FLEET **)rglpfl + iflHead);
    iVar2 = *(int *)((int)((FLEET **)rglpfl + iflHead) + 2);
    if ((iVar1 == 0) && (iVar2 == 0)) break;
    *(undefined2 *)(iVar1 + 0x68) = 0;
    *(undefined2 *)(iVar1 + 0x6a) = 0;
    *(uint *)(iVar1 + 4) = *(uint *)(iVar1 + 4) & 0xf7ff;
  }
  cSrc = 0;
  iflHead = 0;
  do {
    if (cFleet <= iflHead) {
      uVar6 = gd._4_2_ & 0xfbff | 0x400;
      gd.field3_0x4 = (char)uVar6;
      gd.field4_0x5 = (char)(uVar6 >> 8);
      return;
    }
    iVar1 = *(int *)((FLEET **)rglpfl + iflHead);
    iVar2 = *(int *)((int)((FLEET **)rglpfl + iflHead) + 2);
    if ((((*(uint *)(iVar1 + 4) >> 10 & 1) == 0) && (*(int *)(iVar1 + 0x68) == 0)) &&
       (*(int *)(iVar1 + 0x6a) == 0)) {
      for (i = 0; i < cSrc; i = i + 1) {
        uVar8 = (undefined2)((ulong)rglpflSrc[i] >> 0x10);
        pFVar7 = (FLEET *)rglpflSrc[i];
        iVar3 = (pFVar7->pt).y;
        if ((*(int *)(iVar1 + 10) <= iVar3) &&
           ((*(int *)(iVar1 + 10) < iVar3 || (*(uint *)(iVar1 + 8) <= (uint)(&pFVar7->pt)->x)))) {
          uVar8 = (undefined2)((ulong)rglpflSrc[i] >> 0x10);
          pFVar7 = (FLEET *)rglpflSrc[i];
          if ((*(int *)(iVar1 + 8) == (&pFVar7->pt)->x) && (*(int *)(iVar1 + 10) == (pFVar7->pt).y))
          {
            uVar9 = (undefined2)((ulong)rglpflSrc[i] >> 0x10);
            pFVar7 = (FLEET *)rglpflSrc[i];
            uVar8 = *(undefined2 *)(undefined1 *)((int)&pFVar7->lpflNext + 2);
            *(undefined2 *)(iVar1 + 0x68) = *(undefined2 *)&pFVar7->lpflNext;
            *(undefined2 *)(iVar1 + 0x6a) = uVar8;
            uVar8 = (undefined2)((ulong)rglpflSrc[i] >> 0x10);
            pFVar7 = (FLEET *)rglpflSrc[i];
            *(int *)&pFVar7->lpflNext = iVar1;
            *(int *)(undefined1 *)((int)&pFVar7->lpflNext + 2) = iVar2;
            i = -1;
          }
          break;
        }
      }
      if (i != -1) {
        *(int *)(iVar1 + 0x68) = iVar1;
        *(int *)(iVar1 + 0x6a) = iVar2;
        if (i < cSrc) {
          _memmove(rglpflSrc + i + 1,rglpflSrc + i,(cSrc - i) * 4);
        }
        *(int *)(rglpflSrc + i) = iVar1;
        *(int *)((int)rglpflSrc + i * 4 + 2) = iVar2;
        cSrc = cSrc + 1;
        iflTail = iflHead;
        if (0x3e < cSrc) {
          while (iflTail = iflTail + 1, iflTail < cFleet) {
            iVar1 = *(int *)((FLEET **)rglpfl + iflTail);
            iVar2 = *(int *)((int)((FLEET **)rglpfl + iflTail) + 2);
            if ((((*(uint *)(iVar1 + 4) >> 10 & 1) == 0) && (*(int *)(iVar1 + 0x68) == 0)) &&
               (*(int *)(iVar1 + 0x6a) == 0)) {
              pt.x = *(short *)(iVar1 + 8);
              pt.y = *(short *)(iVar1 + 10);
              piVar5 = _bsearch(&pt,rglpflSrc,cSrc,4,(code *)ICompFleetPoint2);
              if (piVar5 != (int *)0x0) {
                iVar3 = *piVar5;
                iVar4 = piVar5[1];
                uVar8 = *(undefined2 *)(iVar3 + 0x6a);
                *(undefined2 *)(iVar1 + 0x68) = *(undefined2 *)(iVar3 + 0x68);
                *(undefined2 *)(iVar1 + 0x6a) = uVar8;
                *(int *)(iVar3 + 0x68) = iVar1;
                *(int *)(iVar3 + 0x6a) = iVar2;
              }
            }
          }
          cSrc = 0;
        }
      }
    }
    iflHead = iflHead + 1;
  } while( true );
}



// ======================================================================
// Function: ICompFleetPoint
// Address: 1038:1f0c
// Segment: MEMORY_UTIL
// ======================================================================


short ICompFleetPoint(void *arg1,void *arg2)

{
  uint uVar1;
  uint uVar2;
  int iVar3;
  int iVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  long l1;
  long l2;
  
  uVar5 = (undefined2)((ulong)*(undefined4 *)arg1 >> 0x10);
  iVar3 = (int)*(undefined4 *)arg1;
  uVar1 = *(uint *)(iVar3 + 8);
  uVar6 = (undefined2)((ulong)*(undefined4 *)arg2 >> 0x10);
  iVar4 = (int)*(undefined4 *)arg2;
  uVar2 = *(uint *)(iVar4 + 8);
  l1._0_2_ = uVar1 - uVar2;
  iVar3 = (*(int *)(iVar3 + 10) - *(int *)(iVar4 + 10)) - (uint)(uVar1 < uVar2);
  if ((iVar3 < 1) && (iVar3 < 0)) {
    l1._0_2_ = -1;
  }
  else if ((-1 < iVar3) && ((0 < iVar3 || ((int)l1 != 0)))) {
    l1._0_2_ = 1;
  }
  return (int)l1;
}



// ======================================================================
// Function: ICompFleetPoint2
// Address: 1038:1fa2
// Segment: MEMORY_UTIL
// ======================================================================


short ICompFleetPoint2(void *arg1,void *arg2)

{
  uint uVar1;
  int iVar2;
  undefined2 uVar3;
  long l1;
  long l2;
  
  uVar3 = (undefined2)((ulong)*(undefined4 *)arg2 >> 0x10);
  iVar2 = (int)*(undefined4 *)arg2;
  uVar1 = *(uint *)(iVar2 + 8);
  l1._0_2_ = *(uint *)arg1 - uVar1;
  iVar2 = (*(int *)((int)arg1 + 2) - *(int *)(iVar2 + 10)) - (uint)(*(uint *)arg1 < uVar1);
  if ((iVar2 < 1) && (iVar2 < 0)) {
    l1._0_2_ = -1;
  }
  else if ((-1 < iVar2) && ((0 < iVar2 || ((int)l1 != 0)))) {
    l1._0_2_ = 1;
  }
  return (int)l1;
}



// ======================================================================
// Function: FLookupSelShip
// Address: 1038:2032
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupSelShip(FLEET *pfl)

{
  short sVar1;
  
  if (sel.scan.grobj == grobjFleet) {
    sVar1 = FLookupFleet(((FLEET **)rglpfl)[sel.scan.ifl]->id,pfl);
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: LpflFromId
// Address: 1038:2078
// Segment: MEMORY_UTIL
// ======================================================================


FLEET * LpflFromId(short idFleet)

{
  int iVar1;
  FLEET *pFVar2;
  undefined2 uVar3;
  short iHi;
  short iplrCur;
  FLEET *lpfl;
  short i;
  short iGuess;
  short iLo;
  short idGuess;
  short iplr;
  
  i = 0;
  for (iplrCur = 0; iplrCur < (int)((uint)idFleet >> 9 & 0xf); iplrCur = iplrCur + 1) {
    i = i + (*(uint *)((int)&rgplr[0].wFlags + iplrCur * 0xc0) & 0xfff);
  }
  iHi = cFleet;
  iVar1 = i + -1;
  do {
    iLo = iVar1;
    if (iHi <= iLo + 1) {
      pFVar2 = (FLEET *)0x0;
      uVar3 = 0;
      break;
    }
    iVar1 = iLo + iHi >> 1;
                    /* WARNING: Load size is inaccurate */
    pFVar2 = ((FLEET **)rglpfl)[iVar1];
    uVar3 = *(undefined2 *)((int)((FLEET **)rglpfl + iVar1) + 2);
  } while ((pFVar2->id < (int)(idFleet & 0x1fffU)) ||
          (iHi = iVar1, iVar1 = iLo, (int)(idFleet & 0x1fffU) < pFVar2->id));
  return (FLEET *)CONCAT22(uVar3,pFVar2);
}



// ======================================================================
// Function: FLookupFleet
// Address: 1038:2160
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupFleet(short idFleet,FLEET *pfl)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  short sVar3;
  int iVar4;
  int iVar5;
  FLEET *pFVar6;
  bool bVar7;
  FLEET *pFVar8;
  PL *pPVar9;
  short fWrite;
  FLEET *lpfl;
  
  if (cFleet < 1) {
    sVar3 = 0;
  }
  else {
    bVar7 = idFleet < 0;
    if (bVar7) {
      idFleet = pfl->id;
    }
    pFVar8 = LpflFromId(idFleet);
    iVar5 = (int)((ulong)pFVar8 >> 0x10);
    pFVar2 = (FLEET *)pFVar8;
    if (((pFVar2 != (FLEET *)0x0) || (iVar5 != 0)) && (pfl != (FLEET *)0x0)) {
      if (bVar7) {
        InvalidateReport(1,0);
        LogChangeFleet(pFVar8,pfl);
        if ((*(int *)&pFVar2->lpplord != *(int *)&pfl->lpplord) ||
           (*(int *)((int)&pFVar2->lpplord + 2) != *(int *)((int)&pfl->lpplord + 2))) {
          if ((int)(uint)((PLORD *)pFVar2->lpplord)->iordMax < pfl->cord) {
            pPVar9 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&pFVar2->lpplord + 2),
                                                        *(PL **)&pFVar2->lpplord),pfl->cord + 3);
            *(PL **)&pFVar2->lpplord = (PL *)pPVar9;
            *(undefined2 *)((int)&pFVar2->lpplord + 2) = (int)((ulong)pPVar9 >> 0x10);
          }
          __fmemcpy((void *)CONCAT22(*(undefined2 *)((int)&pFVar2->lpplord + 2),
                                             (void *)(*(int *)&pFVar2->lpplord + 4)),
                            (void *)CONCAT22(*(undefined2 *)((int)&pfl->lpplord + 2),
                                             (void *)(*(int *)&pfl->lpplord + 4)),
                            (uint)((PLORD *)pfl->lpplord)->iordMac * 0x12);
          ((PLORD *)pFVar2->lpplord)->iordMac = ((PLORD *)pfl->lpplord)->iordMac;
        }
        __fmemcpy(pFVar8,(FLEET *)CONCAT22((undefined1 *)&DAT_1120_1120,pfl),100);
        if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
          AdvanceTutor();
        }
      }
      else if (pfl == (FLEET *)&sel.fl) {
        FDupFleet(pFVar8,(FLEET *)&sel.fl);
      }
      else {
        pFVar6 = pFVar2;
        for (iVar4 = 0x3e; iVar4 != 0; iVar4 = iVar4 + -1) {
          pFVar1 = pfl;
          pfl = (FLEET *)&pfl->iPlayer;
          pFVar8 = pFVar6;
          pFVar6 = (FLEET *)&pFVar6->iPlayer;
          pFVar1->id = pFVar8->id;
        }
      }
    }
    if ((pFVar2 == (FLEET *)0x0) && (iVar5 == 0)) {
      sVar3 = 0;
    }
    else {
      sVar3 = 1;
    }
  }
  return sVar3;
}



// ======================================================================
// Function: FDupFleet
// Address: 1038:2332
// Segment: MEMORY_UTIL
// ======================================================================


short FDupFleet(FLEET *lpfl,FLEET *pfl)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  PL *pPVar3;
  int iVar4;
  int iVar5;
  FLEET *pFVar6;
  FLEET *pFVar7;
  PL *pPVar8;
  PLORD *lpplordT;
  
  pPVar3 = *(PL **)&pfl->lpplord;
  iVar4 = *(int *)((int)&pfl->lpplord + 2);
  pFVar6 = (FLEET *)lpfl;
  pFVar7 = pfl;
  for (iVar5 = 0x3e; iVar5 != 0; iVar5 = iVar5 + -1) {
    pFVar2 = pFVar7;
    pFVar7 = (FLEET *)&pFVar7->iPlayer;
    pFVar1 = pFVar6;
    pFVar6 = (FLEET *)&pFVar6->iPlayer;
    pFVar2->id = pFVar1->id;
  }
  if ((*(int *)&((FLEET *)lpfl)->lpplord == 0) &&
     (*(int *)((int)&((FLEET *)lpfl)->lpplord + 2) == 0)) {
    if ((pPVar3 != (PL *)0x0) || (iVar4 != 0)) {
      FreePl((PL *)CONCAT22(iVar4,pPVar3));
    }
  }
  else {
    *(PL **)&pfl->lpplord = pPVar3;
    *(int *)((int)&pfl->lpplord + 2) = iVar4;
    if ((*(int *)&pfl->lpplord == 0) && (*(int *)((int)&pfl->lpplord + 2) == 0)) {
      pPVar8 = LpplAlloc(0x12,(uint)((PLORD *)((FLEET *)lpfl)->lpplord)->iordMax,htOrd);
      *(PL **)&pfl->lpplord = (PL *)pPVar8;
      *(undefined2 *)((int)&pfl->lpplord + 2) = (int)((ulong)pPVar8 >> 0x10);
    }
    else if (((PLORD *)pfl->lpplord)->iordMax < ((PLORD *)((FLEET *)lpfl)->lpplord)->iordMac) {
      pPVar8 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&pfl->lpplord + 2),
                                                  *(PL **)&pfl->lpplord),
                                   (uint)((PLORD *)((FLEET *)lpfl)->lpplord)->iordMax);
      *(PL **)&pfl->lpplord = (PL *)pPVar8;
      *(undefined2 *)((int)&pfl->lpplord + 2) = (int)((ulong)pPVar8 >> 0x10);
    }
    __fmemcpy((void *)CONCAT22(*(undefined2 *)((int)&pfl->lpplord + 2),
                                       (void *)(*(int *)&pfl->lpplord + 4)),
                      (void *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2),
                                       (void *)(*(int *)&((FLEET *)lpfl)->lpplord + 4)),
                      (uint)((PLORD *)((FLEET *)lpfl)->lpplord)->iordMac * 0x12);
    ((PLORD *)pfl->lpplord)->iordMac = ((PLORD *)((FLEET *)lpfl)->lpplord)->iordMac;
  }
  return 1;
}



// ======================================================================
// Function: FLookupObject
// Address: 1038:24a0
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupObject(GrobjClass grobj,short id,void *pobj)

{
  short sVar1;
  
  if (grobj == grobjFleet) {
    sVar1 = FLookupFleet(id,pobj);
  }
  else if (grobj == grobjPlanet) {
    sVar1 = FLookupPlanet(id,pobj);
  }
  else {
    sVar1 = FLookupThing(id,pobj);
  }
  return sVar1;
}



// ======================================================================
// Function: FLookupOrbitingXfer
// Address: 1038:24fa
// Segment: MEMORY_UTIL
// ======================================================================


short FLookupOrbitingXfer(short idPlanet,short iNth,XFER *pxf,short idSkip)

{
  THING *pTVar1;
  FLEET *pFVar2;
  FLEET *pFVar3;
  int iVar4;
  int iVar5;
  FLEET *pFVar6;
  THING *pTVar7;
  FLEET *pFVar8;
  bool bVar9;
  THING *lpthMac;
  FLEET *lpfl;
  THING *lpth;
  short i;
  
  if (0 < cFleet) {
    if (cFleet != 0) {
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar6 = ((FLEET **)rglpfl)[i];
        iVar5 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar5,pFVar6);
        if ((pFVar6 == (FLEET *)0x0) && (iVar5 == 0)) break;
        if ((((pFVar6->idPlanet == idPlanet) && (lpfl->id != idSkip)) &&
            ((idSkip == -1 ||
             (((&pFVar6->pt)->x == sel.pt.x && ((pFVar6->pt).y == sel.pt.y))))))
           && (bVar9 = iNth == 0, iNth = iNth + -1, bVar9)) {
          if (pxf != (XFER *)0x0) {
            pFVar8 = &pxf->fl;
            for (iVar4 = 0x3e; iVar4 != 0; iVar4 = iVar4 + -1) {
              pFVar2 = pFVar8;
              pFVar8 = (FLEET *)&pFVar8->iPlayer;
              pFVar3 = pFVar6;
              pFVar6 = (FLEET *)&pFVar6->iPlayer;
              pFVar2->id = pFVar3->id;
            }
            pxf->grobj = grobjFleet;
            pxf->id = lpfl->id;
          }
          return 1;
        }
      }
    }
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < (THING *)lpThings + cThing) {
      if (((((uint)lpth->idFull >> 0xd == 1) && ((&((THING *)lpth)->pt)->x == sel.pt.x))
          && ((((THING *)lpth)->pt).y == sel.pt.y)) &&
         (bVar9 = iNth == 0, iNth = iNth + -1, bVar9)) {
        if (pxf != (XFER *)0x0) {
          pFVar6 = &pxf->fl;
          pTVar7 = (THING *)lpth;
          for (iVar5 = 9; iVar5 != 0; iVar5 = iVar5 + -1) {
            pFVar3 = pFVar6;
            pFVar6 = (FLEET *)&pFVar6->iPlayer;
            pTVar1 = pTVar7;
            pTVar7 = (THING *)&pTVar7->pt;
            pFVar3->id = pTVar1->idFull;
          }
          pxf->grobj = grobjThing;
          pxf->id = lpth->idFull;
        }
        return 1;
      }
      lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
    }
  }
  return 0;
}



// ======================================================================
// Function: PszGetThingName
// Address: 1038:26de
// Segment: MEMORY_UTIL
// ======================================================================


char * PszGetThingName(short id)

{
  char *pcVar1;
  char *pcVar2;
  int iVar3;
  char *unaff_SS;
  THING *pTVar4;
  char szPlr [54];
  THING *lpth;
  
  pTVar4 = LpthFromId(id);
  iVar3 = (int)((ulong)pTVar4 >> 0x10);
  if (((THING *)pTVar4 == (THING *)0x0) && (iVar3 == 0)) {
    szWork[0] = '\0';
  }
  else if ((uint)pTVar4->idFull >> 0xd == 0) {
    if (((uint)pTVar4->idFull >> 9 & 0xf) == idPlayer) {
      szPlr[0] = '\0';
    }
    else {
      pcVar2 = PszPlayerName((uint)pTVar4->idFull >> 9 & 0xf,0,0,0,0,(PLAYER *)0x0);
      _WSPRINTF((LPSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(LPCSTR)CONCAT22(0x518,unaff_SS),
                szPlr);
    }
    pcVar2 = szPlr;
    pcVar1 = PszGetCompressedString(idsSSMineField);
    _WSPRINTF((LPSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
  }
  else if ((uint)pTVar4->idFull >> 0xd == 1) {
    if ((*(uint *)((THING *)pTVar4)->rgb >> 10 & 0xf) == 0) {
      CchGetString(idsSalvage,(char *)szWork);
    }
    else {
      if (((uint)pTVar4->idFull >> 9 & 0xf) == idPlayer) {
        szPlr[0] = '\0';
      }
      else {
        pcVar2 = PszPlayerName((uint)pTVar4->idFull >> 9 & 0xf,0,0,0,0,(PLAYER *)0x0);
        _WSPRINTF((LPSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(LPCSTR)CONCAT22(0x51c,unaff_SS),
                  szPlr);
      }
      pcVar2 = szPlr;
      pcVar1 = PszGetCompressedString(idsSmineralPacket);
      _WSPRINTF((LPSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),
                (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
    }
  }
  else if ((uint)pTVar4->idFull >> 0xd == 2) {
    pcVar2 = PszGetCompressedString(idsWormhole);
    _strcpy((char *)szWork,pcVar2);
  }
  else if ((uint)pTVar4->idFull >> 0xd == 3) {
    pcVar2 = PszGetCompressedString(idsMysteryTrader);
    _strcpy((char *)szWork,pcVar2);
  }
  else {
    pcVar2 = PszGetCompressedString(idsMysteryObject);
    _strcpy((char *)szWork,pcVar2);
  }
  return (char *)szWork;
}



// ======================================================================
// Function: PszGetFleetName
// Address: 1038:292c
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lpsz */

char * PszGetFleetName(short id)

{
  FLEET *pFVar1;
  uint iPlayer;
  char *pcVar2;
  short sVar3;
  int iVar4;
  char *unaff_SS;
  FLEET *lpfl_00;
  short cch;
  short ishdef;
  char szPlr [34];
  FLEET *lpfl;
  short ifl;
  char szShdef [34];
  char *lpsz;
  short iplr;
  short cshdef;
  
  lpfl_00 = LpflFromId(id & 0x7fff);
  iVar4 = (int)((ulong)lpfl_00 >> 0x10);
  pFVar1 = (FLEET *)lpfl_00;
  iPlayer = (id & 0x7fffU) >> 9 & 0xf;
  if (iPlayer == idPlayer) {
    szPlr[0] = '\0';
  }
  else {
    pcVar2 = PszPlayerName(iPlayer,0,0,0,0,(PLAYER *)0x0);
    _WSPRINTF((LPSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(LPCSTR)CONCAT22(0x520,unaff_SS),szPlr)
    ;
  }
  if (((pFVar1 == (FLEET *)0x0) && (iVar4 == 0)) ||
     ((*(int *)&pFVar1->lpszName == 0 && (*(int *)((int)&pFVar1->lpszName + 2) == 0)))) {
    if ((pFVar1 == (FLEET *)0x0) && (iVar4 == 0)) {
      PszGetCompressedString(idsFleet);
    }
    else {
      sVar3 = IshdefPrimaryFromLpfl(lpfl_00,&cshdef);
      if (sVar3 == 0x10) {
        PszGetCompressedString(idsFleet);
      }
      else {
        __fstrcpy((char *)CONCAT22(unaff_SS,szShdef),
                          (char *)CONCAT22(*(undefined2 *)(iPlayer * 4 + 0x100),
                                           (char *)(*(int *)(iPlayer * 4 + 0xfe) + sVar3 * 0x93 + 8)
                                          ));
        cch = _strlen(szShdef);
        if (0x1c < cch) {
          cch = 0x1c;
        }
        if (1 < cshdef) {
          szShdef[cch] = '+';
          szShdef[cch + 1] = '\0';
        }
      }
    }
    _WSPRINTF((LPSTR)CONCAT22(szPlr,(char *)&DAT_1120_1120),(LPCSTR)0x5291120,
              (char *)szWork);
  }
  else {
    _WSPRINTF((LPSTR)CONCAT22(szPlr,(char *)&DAT_1120_1120),(LPCSTR)0x5241120,
              (char *)szWork);
  }
  return (char *)szWork;
}



// ======================================================================
// Function: WFromLpfl
// Address: 1038:2b10
// Segment: MEMORY_UTIL
// ======================================================================


ushort WFromLpfl(FLEET *lpfl)

{
  short sVar1;
  short ishdef;
  ushort w;
  short cshdef;
  
  sVar1 = IshdefPrimaryFromLpfl(lpfl,&cshdef);
  w = sVar1 << 9 | lpfl->id & 0x1ffU;
  if (1 < cshdef) {
    w = w | 0x2000;
  }
  return w;
}



// ======================================================================
// Function: PszFleetNameFromWord
// Address: 1038:2b5e
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lpsz */

char * PszFleetNameFromWord(ushort w)

{
  uint uVar1;
  undefined2 unaff_SS;
  short cch;
  short ishdef;
  char szShdef [34];
  char *lpsz;
  
  uVar1 = w >> 9 & 0xf;
  if ((*(uint *)(*(int *)(idPlayer * 4 + 0xfe) + uVar1 * 0x93 + 0x7b) >> 9 & 1) == 0) {
    __fstrcpy((char *)CONCAT22(unaff_SS,szShdef),
                      (char *)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x100),
                                       (char *)(*(int *)(idPlayer * 4 + 0xfe) + uVar1 * 0x93
                                               + 8)));
    cch = _strlen(szShdef);
    if (0x1c < cch) {
      cch = 0x1c;
    }
    if ((w & 0x2000) != 0) {
      szShdef[cch] = '+';
      szShdef[cch + 1] = '\0';
    }
    lpsz._0_2_ = szShdef;
  }
  else {
    lpsz._0_2_ = PszGetCompressedString(idsFleet);
  }
  _WSPRINTF((LPSTR)CONCAT22((char *)lpsz,(char *)&DAT_1120_1120),(LPCSTR)0x5321120,
            (char *)szWork);
  return (char *)szWork;
}



// ======================================================================
// Function: PszGetPlanetName
// Address: 1038:2c6a
// Segment: MEMORY_UTIL
// ======================================================================


char * PszGetPlanetName(short id)

{
  char *pcVar1;
  char *pcVar2;
  char *psz;
  short fInOrbit;
  
  pcVar1 = PszGetCompressedPlanet(((short *)rgidPlan)[id]);
  if ((id & 0x8000U) == 0) {
    _strcpy((char *)szWork,pcVar1);
  }
  else {
    pcVar2 = PszGetCompressedString(idsOrbitingS);
    _WSPRINTF((LPSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
  }
  return (char *)szWork;
}



// ======================================================================
// Function: IflFromLpfl
// Address: 1038:2ce8
// Segment: MEMORY_UTIL
// ======================================================================


short IflFromLpfl(FLEET *lpfl)

{
  short i;
  
  i = 0;
  while( true ) {
    if (cFleet <= i) {
      return -1;
    }
                    /* WARNING: Load size is inaccurate */
    if ((((FLEET **)rglpfl)[i] == (FLEET *)lpfl) &&
       (*(int *)((int)((FLEET **)rglpfl + i) + 2) == lpfl._2_2_)) break;
    i = i + 1;
  }
  return i;
}



// ======================================================================
// Function: FDeleteFleet
// Address: 1038:2d44
// Segment: MEMORY_UTIL
// ======================================================================


short FDeleteFleet(short idFleet,short grobjSel,short idSel)

{
  uint *puVar1;
  int iVar2;
  short sVar3;
  int iVar4;
  FLEET *pFVar5;
  undefined2 uVar6;
  PLANET *pPVar7;
  PLANET *lppl;
  short idDel;
  short iPlr;
  FLEET *lpfl;
  short i;
  
  for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar5 = ((FLEET **)rglpfl)[i];
    iVar4 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    lpfl = (FLEET *)CONCAT22(iVar4,pFVar5);
    if (((pFVar5 == (FLEET *)0x0) && (iVar4 == 0)) || (lpfl->id == idFleet)) break;
    if (idFleet < lpfl->id) {
      return 0;
    }
  }
  if (i == cFleet) {
    sVar3 = 0;
  }
  else {
    if (idFleet == sel.fl.id) {
      RedrawScanSel(0,0);
    }
    uVar6 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar5 = (FLEET *)lpfl;
    pFVar5->wFlags = pFVar5->wFlags & 0xfbffU | 0x400;
    FleetOrdersChangeTarget(lpfl);
    FreePl((PL *)CONCAT22(*(undefined2 *)((int)&pFVar5->lpplord + 2),
                                  *(PL **)&pFVar5->lpplord));
    if ((*(int *)&pFVar5->lpszName != 0) || (*(int *)((int)&pFVar5->lpszName + 2) != 0)) {
                    /* WARNING: Load size is inaccurate */
      FreeLp((void *)CONCAT22(*(undefined2 *)((int)&pFVar5->lpszName + 2),pFVar5->lpszName),
                     htString);
    }
    cFleet = cFleet + -1;
    iVar4 = pFVar5->iPlayer;
    iVar2 = lpfl->id;
    lppl._2_2_ = *(int *)((int)&rgplr[0].wFlags + iVar4 * 0xc0) - 1U & 0xfff;
    puVar1 = (uint *)((int)&rgplr[0].wFlags + iVar4 * 0xc0);
    *puVar1 = *puVar1 & 0xf000;
    puVar1 = (uint *)((int)&rgplr[0].wFlags + iVar4 * 0xc0);
    *puVar1 = *puVar1 | lppl._2_2_;
    if ((grobjSel == 0) && (pFVar5->idPlanet != -1)) {
      pPVar7 = LpplFromId(pFVar5->idPlanet);
      iVar4 = (int)((ulong)pPVar7 >> 0x10);
      if ((((PLANET *)pPVar7 != (PLANET *)0x0) || (iVar4 != 0)) &&
         (((PLANET *)pPVar7)->iPlayer == idPlayer)) {
        grobjSel = 1;
        idSel = pFVar5->idPlanet;
      }
    }
    if (cFleet != i) {
      __fmemmove((FLEET **)CONCAT22(rglpfl._2_2_,(FLEET **)rglpfl + i),
                         (FLEET **)CONCAT22(rglpfl._2_2_,(FLEET **)rglpfl + i + 1),
                         (cFleet - i) * 4);
    }
    FreeLp(lpfl,htFleets);
    gd._4_2_ = gd._4_2_ & 0xfbff;
    if (sel.fl.id != -1) {
      if (i < sel.scan.ifl) {
        sel.scan.ifl = sel.scan.ifl + -1;
      }
      else if (iVar2 == sel.fl.id) {
        if (grobjSel == 0) {
          sel.grobj = grobjNone;
          sel.scan.grobj = grobjNone;
          FFindSomethingAndSelectIt();
          return 1;
        }
        sel.grobj = grobjNone;
        if (grobjSel == 2) {
          SelectAdjFleet(0,idSel);
        }
        else {
          SelectAdjPlanet(0,idSel);
        }
      }
    }
    if ((((uint)gd._0_2_ >> 1 & 1) == 0) && (hwndMessage != 0)) {
      SetMsgTitle(hwndMessage);
    }
    sVar3 = 1;
  }
  return sVar3;
}



// ======================================================================
// Function: LpflNew
// Address: 1038:300c
// Segment: MEMORY_UTIL
// ======================================================================


FLEET * LpflNew(short iPlr,short idPl)

{
  uint *puVar1;
  int iVar2;
  short sVar3;
  FLEET *pFVar4;
  int iVar5;
  uint uVar6;
  undefined2 uVar7;
  undefined2 uVar8;
  FLEET **ppFVar9;
  FLEET *pFVar10;
  PL *pPVar11;
  short iflPrev;
  FLEET *lpfl;
  ORDER *lpord;
  short i;
  
  iflPrev = -1;
  for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar4 = ((FLEET **)rglpfl)[i];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar4);
    if ((pFVar4 == (FLEET *)0x0) && (iVar2 == 0)) break;
    if (iPlr <= pFVar4->iPlayer) {
      if ((iPlr < pFVar4->iPlayer) || ((lpfl->id & 0x1ffU) != iflPrev + 1U)) break;
      iflPrev = lpfl->id & 0x1ff;
    }
  }
  rglpfl =
       LpReAlloc((FLEET **)CONCAT22(rglpfl._2_2_,(FLEET **)rglpfl),
                         (cFleet + 1) * 4,htMisc);
  uVar7 = (undefined2)((ulong)rglpfl >> 0x10);
  if (cFleet != i) {
    __fmemmove((FLEET **)CONCAT22(uVar7,(FLEET **)rglpfl + i + 1),
                       (FLEET **)CONCAT22(uVar7,(FLEET **)rglpfl + i),
                       (cFleet - i) * 4);
  }
  pFVar10 = LpAlloc(0x7c,htFleets);
  uVar7 = rglpfl._2_2_;
  uVar8 = (undefined2)((ulong)pFVar10 >> 0x10);
  pFVar4 = (FLEET *)pFVar10;
  ppFVar9 = (FLEET **)rglpfl + i;
  *(FLEET **)ppFVar9 = pFVar4;
  *(undefined2 *)((int)ppFVar9 + 2) = uVar8;
  cFleet = cFleet + 1;
  iVar2 = *(int *)((int)&rgplr[0].wFlags + iPlr * 0xc0);
  puVar1 = (uint *)((int)&rgplr[0].wFlags + iPlr * 0xc0);
  *puVar1 = *puVar1 & 0xf000;
  puVar1 = (uint *)((int)&rgplr[0].wFlags + iPlr * 0xc0);
  *puVar1 = *puVar1 | iVar2 + 1U & 0xfff;
  __fmemset(pFVar10,0,0x7c);
  pFVar10->id = pFVar10->id & 0xfe00U | iflPrev + 1U & 0x1ff;
  pFVar4->iPlayer = iPlr;
  pFVar10->id = pFVar10->id & 0xe1ffU | (iPlr & 0xfU) << 9;
  pFVar4->wFlags = pFVar4->wFlags & 0xff00U | 7;
  pFVar4->idPlanet = idPl;
  if (idPl != -1) {
    sVar3 = *(short *)((int)&rgptPlan[0].y + idPl * 4);
    (&pFVar4->pt)->x = ((POINT *)rgptPlan + idPl)->x;
    (pFVar4->pt).y = sVar3;
  }
  pFVar4->cord = 1;
  pFVar4->wFlags = pFVar4->wFlags & 0xfdff;
  pPVar11 = LpplAlloc(0x12,3,htOrd);
  *(PL **)&pFVar4->lpplord = (PL *)pPVar11;
  *(undefined2 *)((int)&pFVar4->lpplord + 2) = (int)((ulong)pPVar11 >> 0x10);
  ((PLORD *)pFVar4->lpplord)->iordMac = 1;
  pFVar4->wFlags = pFVar4->wFlags & 0xffef;
  iVar2 = *(int *)&pFVar4->lpplord;
  uVar7 = *(undefined2 *)((int)&pFVar4->lpplord + 2);
  lpord = (ORDER *)CONCAT22(uVar7,(ORDER *)(iVar2 + 4));
  sVar3 = (pFVar4->pt).y;
  (lpord->pt).x = (&pFVar4->pt)->x;
  *(short *)(iVar2 + 6) = sVar3;
  *(short *)(iVar2 + 8) = pFVar4->idPlanet;
  if (pFVar4->idPlanet == -1) {
    iVar5 = 4;
  }
  else {
    iVar5 = 1;
  }
  *(uint *)(iVar2 + 10) = *(uint *)(iVar2 + 10) & 0xf0ff | iVar5 << 8;
  *(uint *)(iVar2 + 10) = *(uint *)(iVar2 + 10) & 0xff0f;
  *(uint *)(iVar2 + 10) = *(uint *)(iVar2 + 10) & 0xefff | 0x1000;
  *(uint *)(iVar2 + 10) = *(uint *)(iVar2 + 10) & 0xfff0;
  if ((sel.scan.ifl != -1) && (i <= sel.scan.ifl)) {
    sel.scan.ifl = sel.scan.ifl + 1;
  }
  uVar6 = gd._4_2_ & 0xfbff;
  gd.field3_0x4 = (char)uVar6;
  gd.field4_0x5 = (char)(uVar6 >> 8);
  return pFVar10;
}



// ======================================================================
// Function: LpflNewSplit
// Address: 1038:3372
// Segment: MEMORY_UTIL
// ======================================================================


FLEET * LpflNewSplit(FLEET *pfl)

{
  byte bVar1;
  short sVar2;
  FLEET *pFVar3;
  undefined2 uVar4;
  FLEET *pFVar5;
  PL *pPVar6;
  FLEET *lpflNew;
  short iordMac;
  
  pFVar5 = LpflNew(pfl->iPlayer,pfl->idPlanet);
  uVar4 = (undefined2)((ulong)pFVar5 >> 0x10);
  pFVar3 = (FLEET *)pFVar5;
  if (pfl->idPlanet == -1) {
    sVar2 = (pfl->pt).y;
    (&pFVar3->pt)->x = (&pfl->pt)->x;
    (pFVar3->pt).y = sVar2;
  }
  pFVar3->wFlags = pFVar3->wFlags & 0xfdffU | ((uint)pfl->wFlags >> 9 & 1) << 9;
  pFVar3->wFlags = pFVar3->wFlags & 0xff00U | pfl->wFlags & 0xffU;
  pFVar3->iplan = pfl->iplan;
  bVar1 = ((PLORD *)pfl->lpplord)->iordMac;
  if ((uint)((PLORD *)pFVar3->lpplord)->iordMax < (uint)bVar1) {
    pPVar6 = LpplReAlloc((PL *)CONCAT22(*(undefined2 *)((int)&pFVar3->lpplord + 2),
                                                *(PL **)&pFVar3->lpplord),
                                 (uint)((PLORD *)pfl->lpplord)->iordMax);
    *(PL **)&pFVar3->lpplord = (PL *)pPVar6;
    *(undefined2 *)((int)&pFVar3->lpplord + 2) = (int)((ulong)pPVar6 >> 0x10);
  }
  __fmemcpy((void *)CONCAT22(*(undefined2 *)((int)&pFVar3->lpplord + 2),
                                     (void *)(*(int *)&pFVar3->lpplord + 4)),
                    (void *)CONCAT22(*(undefined2 *)((int)&pfl->lpplord + 2),
                                     (void *)(*(int *)&pfl->lpplord + 4)),(uint)bVar1 * 0x12);
  ((PLORD *)pFVar3->lpplord)->iordMac = bVar1;
  pFVar3->cord = pfl->cord;
  LogSplitFleet(pfl->id);
  return pFVar5;
}



// ======================================================================
// Function: FFleetMergeAll
// Address: 1038:34d8
// Segment: MEMORY_UTIL
// ======================================================================


short FFleetMergeAll(FLEET *pfl)

{
  int *piVar1;
  uint *puVar2;
  uint uVar3;
  uint uVar4;
  uint uVar5;
  int iVar6;
  undefined2 uVar7;
  FLEET *pFVar8;
  FLEET *pFVar9;
  int iVar10;
  FLEET *pFVar11;
  ulong uVar12;
  long lVar13;
  short j;
  long rgdp [16];
  FLEET *lpflMerge;
  SHDEF *lpshdef;
  short cshT;
  FLEET *lpfl;
  short i;
  short cflMerge;
  short rgcshDamaged [16];
  short fCshOverflow;
  long dpT;
  short iplr;
  
  lpflMerge._0_2_ = (FLEET *)0x0;
  lpflMerge._2_2_ = 0;
  cflMerge = 0;
  _memset(rgdp,0,0x40);
  _memset(rgcshDamaged,0,0x20);
  for (i = 0; i < vcflMerge; i = i + 1) {
    pFVar9 = (FLEET *)lpflMerge;
    iVar6 = lpflMerge._2_2_;
    if (vrgiflMerge[i] != -1) {
      pFVar11 = LpflFromId(vrgiflMerge[i]);
      iVar10 = (int)((ulong)pFVar11 >> 0x10);
      pFVar8 = (FLEET *)pFVar11;
      if ((pFVar8 != (FLEET *)0x0) || (iVar10 != 0)) {
        for (j = 0; j < 0x10; j = j + 1) {
          if (pFVar8->rgcsh[j] != 0) {
            if ((pFVar8->rgdv + j)->dp != 0) {
              lVar13 = 100;
              uVar12 = __aFulmul((long)pFVar8->rgcsh[j],
                                         (ulong)(uint)(pFVar8->rgdv + j)->dp & 0xffff007f);
              lVar13 = __aFldiv(uVar12,lVar13);
              cshT = (short)lVar13;
              if (cshT == 0) {
                cshT = 1;
              }
              rgcshDamaged[j] = rgcshDamaged[j] + cshT;
              uVar12 = __aFulmul((ulong)((uint)(pFVar8->rgdv + j)->dp >> 7),(long)cshT);
              puVar2 = (uint *)(rgdp + j);
              uVar3 = *puVar2;
              *puVar2 = *puVar2 + (uint)uVar12;
              piVar1 = (int *)((int)rgdp + j * 4 + 2);
              *piVar1 = *piVar1 + (int)(uVar12 >> 0x10) + (uint)CARRY2(uVar3,(uint)uVar12);
            }
            if ((pFVar11->id & 0x1ffU) != (pfl->id & 0x1ffU)) {
              pfl->rgcsh[j] = pfl->rgcsh[j] + pFVar8->rgcsh[j];
              if (pfl->rgcsh[j] < 0) {
                pfl->rgcsh[j] = 0x7ffe;
              }
              pFVar8->rgcsh[j] = 0;
            }
          }
        }
        pFVar9 = pFVar8;
        iVar6 = iVar10;
        if ((pFVar11->id & 0x1ffU) != (pfl->id & 0x1ffU)) {
          for (j = 0; j < 5; j = j + 1) {
            uVar4 = *(uint *)(pFVar8->rgwtMin + j);
            uVar5 = *(uint *)((int)(pFVar8->rgwtMin + j) + 2);
            puVar2 = (uint *)(pfl->rgwtMin + j);
            uVar3 = *puVar2;
            *puVar2 = *puVar2 + uVar4;
            puVar2 = (uint *)((int)(pfl->rgwtMin + j) + 2);
            *puVar2 = *puVar2 + uVar5 + (uint)CARRY2(uVar3,uVar4);
          }
          FDeleteFleet(pFVar11->id,0,-1);
          cflMerge = cflMerge + 1;
          pFVar9 = (FLEET *)lpflMerge;
          iVar6 = lpflMerge._2_2_;
        }
      }
    }
    lpflMerge._2_2_ = iVar6;
    lpflMerge._0_2_ = pFVar9;
  }
  for (j = 0; j < 0x10; j = j + 1) {
    ((FLEET *)lpflMerge)->rgcsh[j] = pfl->rgcsh[j];
    if ((rgcshDamaged[j] == 0) || (((FLEET *)lpflMerge)->rgcsh[j] == 0)) {
      (((FLEET *)lpflMerge)->rgdv + j)->dp = 0;
    }
    else {
      lVar13 = (long)((FLEET *)lpflMerge)->rgcsh[j];
      iVar6 = ((FLEET *)lpflMerge)->rgcsh[j];
      uVar12 = __aFulmul((long)rgcshDamaged[j],100);
      lVar13 = __aFldiv(uVar12 + (long)(iVar6 + -1),lVar13);
      (((FLEET *)lpflMerge)->rgdv + j)->dp =
           (((FLEET *)lpflMerge)->rgdv + j)->dp & 0xff80U | (uint)lVar13 & 0x7f;
      lVar13 = __aFldiv(CONCAT22(*(undefined2 *)((int)rgdp + j * 4 + 2),(int)rgdp[j]),
                                (long)rgcshDamaged[j]);
      (((FLEET *)lpflMerge)->rgdv + j)->dp =
           (((FLEET *)lpflMerge)->rgdv + j)->dp & 0x7fU | (int)lVar13 << 7;
    }
  }
  for (j = 0; j < 5; j = j + 1) {
    uVar7 = *(undefined2 *)((int)(pfl->rgwtMin + j) + 2);
    *(int *)(((FLEET *)lpflMerge)->rgwtMin + j) = (int)pfl->rgwtMin[j];
    *(undefined2 *)((int)(((FLEET *)lpflMerge)->rgwtMin + j) + 2) = uVar7;
  }
  LogMergeFleet(pfl->id);
  InvalidateReport(1,2);
  return (uint)(cflMerge != 0);
}



// ======================================================================
// Function: FFleetSplitAll
// Address: 1038:3a00
// Segment: MEMORY_UTIL
// ======================================================================


short FFleetSplitAll(FLEET *pfl)

{
  int iVar1;
  FLEET *pFVar2;
  FLEET *pFVar3;
  FLEET *pFVar4;
  int iVar5;
  FLEET *pFVar6;
  undefined2 unaff_SS;
  bool bVar7;
  FLEET *pFVar8;
  FLEET *lpflNew;
  short i;
  short c;
  short cSplit;
  FLEET flNew;
  
  cSplit = 0;
  for (i = 0; i < 0x10; i = i + 1) {
    c = pfl->rgcsh[i];
    while (iVar5 = c + -1, c != 0) {
      iVar1 = cSplit + 1;
      bVar7 = cSplit != 0;
      c = iVar5;
      cSplit = iVar1;
      if (bVar7) {
        pFVar8 = LpflNewSplit(pfl);
        pFVar4 = (FLEET *)pFVar8;
        pFVar6 = &flNew;
        for (iVar5 = 0x3e; iVar5 != 0; iVar5 = iVar5 + -1) {
          pFVar3 = pFVar6;
          pFVar6 = (FLEET *)&pFVar6->iPlayer;
          pFVar2 = pFVar4;
          pFVar4 = (FLEET *)&pFVar4->iPlayer;
          pFVar3->id = pFVar2->id;
        }
        pfl->rgcsh[i] = pfl->rgcsh[i] + -1;
        flNew.rgcsh[i] = flNew.rgcsh[i] + 1;
        FleetTransferCargoBalance(pfl,&flNew);
        FLookupFleet(-1,pfl);
        FLookupFleet(-1,&flNew);
      }
    }
  }
  InvalidateReport(1,2);
  return (uint)(1 < cSplit);
}



// ======================================================================
// Function: PszGetLocName
// Address: 1038:3b08
// Segment: MEMORY_UTIL
// ======================================================================


char * PszGetLocName(GrobjClass grobj,short id,short x,short y)

{
  char *pcVar1;
  
  if (id != -1) {
    if (grobj == grobjPlanet) {
      pcVar1 = PszGetPlanetName(id);
      return pcVar1;
    }
    if (grobj == grobjFleet) {
      pcVar1 = PszGetFleetName(id);
      return pcVar1;
    }
    if (grobj == grobjThing) {
      pcVar1 = PszGetThingName(id);
      return pcVar1;
    }
  }
  if ((x == -1) && (y == -1)) {
    pcVar1 = PszGetCompressedString(idsDeepSpace);
    _strcpy((char *)szWork,pcVar1);
  }
  else {
    pcVar1 = PszGetCompressedString(idsSpaceDD);
    _WSPRINTF((LPSTR)CONCAT22(x,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
  }
  return (char *)szWork;
}



// ======================================================================
// Function: CchGetETA
// Address: 1038:3bc8
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: ids */

short CchGetETA(HDC hdc,FLEET *lpfl,char *sz,short iwp,short fSmall)

{
  POINT ptSrc;
  POINT ptDst;
  uint uVar1;
  short sVar2;
  StringId ids_00;
  char *pcVar3;
  int iVar4;
  ORDER *pOVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar6;
  long lVar7;
  short ids;
  short cYears;
  short j;
  short iSpeed;
  short c;
  short i;
  ORDER *lpord;
  double dbl;
  short iWarp;
  
  cYears = 0;
  uVar6 = (undefined2)((ulong)lpfl >> 0x10);
  lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpfl)->lpplord + 2),
                            (ORDER *)(*(int *)&((FLEET *)lpfl)->lpplord + 4));
  i = 0;
  while( true ) {
    if (iwp <= i) {
      if (fSmall == 0) {
        ids_00 = idsDYear;
      }
      else {
        ids_00 = idsDy;
      }
      sVar2 = cYears;
      pcVar3 = PszGetCompressedString(ids_00);
      iVar4 = _WSPRINTF((LPSTR)CONCAT22(sVar2,(char *)&DAT_1120_1120),
                        (LPCSTR)CONCAT22(pcVar3,(char *)&DAT_1120_1120),sz);
      if ((cYears != 1) && (fSmall == 0)) {
        sz[iVar4] = 's';
        iVar4 = iVar4 + 1;
      }
      return iVar4;
    }
    uVar6 = (undefined2)((ulong)lpord >> 0x10);
    pOVar5 = (ORDER *)lpord;
    DGetDistance((lpord->pt).x,(pOVar5->pt).y,((pOVar5 + 1)->pt).x,pOVar5[1].pt.y);
    uVar1 = (uint)pOVar5[1].wFlags >> 4 & 0xf;
    if (uVar1 < 0xb) {
      iSpeed = uVar1 * uVar1;
    }
    else {
      ptSrc.y = (pOVar5->pt).y;
      ptSrc.x = (lpord->pt).x;
      ptDst.y = pOVar5[1].pt.y;
      ptDst.x = ((pOVar5 + 1)->pt).x;
      uVar1 = FCanFleetUseStargates(lpfl,ptSrc,ptDst);
      if (uVar1 == 0xffff) {
        iSpeed = -3;
      }
      else if (uVar1 == 0) {
        iSpeed = 0;
      }
      else if (uVar1 == 1) {
        iSpeed = (int)(char *)s_R6008___not_enough_space_for_arg_1120_1f2d + 0x13;
      }
      else if ((uVar1 & 2) == 0) {
        iSpeed = -2;
      }
      else {
        iSpeed = -1;
      }
    }
    if (iSpeed == 0) break;
    if (iSpeed < 0) {
      if (hdc != 0) {
        SetTextColor(hdc,0x7f7f);
      }
      if (iSpeed == -1) {
        ids = 0x335;
      }
      else if (iSpeed == -2) {
        ids = 0x336;
      }
      else {
        ids = 0x337;
      }
      sVar2 = CchGetString(ids,sz);
      return sVar2;
    }
    lVar7 = __ftol((double)CONCAT26(cYears,CONCAT24(ids,CONCAT22(unaff_SI,unaff_DI))));
    if (iSpeed < (int)lVar7) {
      lVar7 = __ftol((double)CONCAT26(cYears,CONCAT24(ids,CONCAT22(unaff_SI,unaff_DI))));
      iSpeed = ((int)lVar7 + iSpeed + -1) / iSpeed;
    }
    else {
      iSpeed = 1;
    }
    cYears = cYears + iSpeed;
    i = i + 1;
    lpord = (ORDER *)CONCAT22(uVar6,pOVar5 + 1);
  }
  if (hdc != 0) {
    SetTextColor(hdc,0xff);
  }
  sVar2 = CchGetString(idsNever,sz);
  return sVar2;
}



// ======================================================================
// Function: IshdefPrimaryFromLpfl
// Address: 1038:3e1c
// Segment: MEMORY_UTIL
// ======================================================================


short IshdefPrimaryFromLpfl(FLEET *lpfl,short *pcDiff)

{
  int iVar1;
  short ihul;
  short csh;
  short i;
  short ish;
  short cDiff;
  
  cDiff = 0;
  csh = 0;
  ish = 0x10;
  for (i = 0; i < 0x10; i = i + 1) {
    if ((0 < ((FLEET *)lpfl)->rgcsh[i]) && (cDiff = cDiff + 1, csh < ((FLEET *)lpfl)->rgcsh[i])) {
      ish = i;
      csh = ((FLEET *)lpfl)->rgcsh[i];
      iVar1 = ((FLEET *)lpfl)->iPlayer * 4;
      iVar1 = *(int *)(*(int *)(iVar1 + 0xfe) + i * 0x93);
      if ((iVar1 == 0x19) || (iVar1 == 0x1a)) {
        csh = csh + -1;
      }
    }
  }
  if (pcDiff != (short *)0x0) {
    *pcDiff = cDiff;
  }
  return ish;
}



// ======================================================================
// Function: PszGetDistance
// Address: 1038:3f00
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: d2 */

char * PszGetDistance(short x1,short y1,short x2,short y2)

{
  undefined2 uVar1;
  char *pcVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar3;
  ulong uVar4;
  long d2;
  short fStarted;
  long d;
  
  DGetDistance(x1,y1,x2,y2);
  lVar3 = __ftol((double)CONCAT26(d2._2_2_,CONCAT24((undefined2)d2,
                                                            CONCAT22(unaff_SI,unaff_DI))));
  uVar4 = __aFldiv(lVar3,100);
  uVar1 = (undefined2)uVar4;
  __aFulmul(uVar4,100);
  if (dyArial8 < 0xf) {
    pcVar2 = PszGetCompressedString(idsLdLdLightYears);
    _WSPRINTF((LPSTR)CONCAT22((int)uVar4,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
  }
  else {
    pcVar2 = PszGetCompressedString(idsLdLdLY);
    _WSPRINTF((LPSTR)CONCAT22(uVar1,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(char *)szWork);
  }
  return (char *)szWork;
}



// ======================================================================
// Function: DGetDistance
// Address: 1038:3fe4
// Segment: MEMORY_UTIL
// ======================================================================


double DGetDistance(short x1,short y1,short x2,short y2)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar1;
  ulong uVar2;
  double *pdVar3;
  long l;
  long dx;
  long dy;
  
  uVar1 = __aFulmul((long)(y2 - y1),(long)(y2 - y1));
  uVar2 = __aFulmul((long)(x2 - x1),(long)(x2 - x1));
  pdVar3 = _sqrt(SUB84((double)(long)(uVar2 + uVar1),0),
                         (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)(long)(
                                                  uVar2 + uVar1) >> 0x20))));
  DOUBLE_0_0__1120_1706 = *(double *)pdVar3;
  return '\x06';
}



// ======================================================================
// Function: FFindNearestObject
// Address: 1038:4070
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10384625) */
/* WARNING: Removing unreachable block (ram,0x103845f3) */
/* WARNING: Removing unreachable block (ram,0x10384389) */
/* WARNING: Removing unreachable block (ram,0x103841a3) */
/* WARNING: Removing unreachable block (ram,0x10384171) */
/* WARNING: Removing unreachable block (ram,0x1038429a) */
/* WARNING: Removing unreachable block (ram,0x103842cc) */
/* WARNING: Removing unreachable block (ram,0x1038443e) */
/* WARNING: Removing unreachable block (ram,0x1038450f) */
/* WARNING: Removing unreachable block (ram,0x103846af) */
/* WARNING: Removing unreachable block (ram,0x10384470) */

short FFindNearestObject(POINT pt,GrobjClass grobj,SCAN *pscan)

{
  SCAN *pSVar1;
  SCAN *pSVar2;
  int iVar3;
  int iVar4;
  int iVar5;
  short sVar6;
  THING *pTVar7;
  int iVar8;
  int *piVar9;
  SCAN *pSVar10;
  undefined2 uVar11;
  ulong uVar12;
  ulong uVar13;
  ulong uVar14;
  POINT pt_00;
  SCAN scan;
  short dx;
  short iNearest;
  SCAN scanT;
  long lSquare;
  THING *lpthMac;
  short i;
  FLEET *lpfl;
  THING *lpth;
  long lTry;
  short dy;
  POINT *ppt;
  POINT ptWp;
  
  uVar12 = 1000000000;
  ppt = (POINT *)rgptPlan;
  scan.grobjFull = grobjNone;
  scan.grobj = grobjNone;
  scan.pt.y = 0;
  scan.pt.x = 0;
  scan.ith = -1;
  scan.iwp = -1;
  scan.ifl = -1;
  scan.idpl = -1;
  if ((grobj & 0x40) == grobjNone) {
    if ((grobj & 0x80) != grobjNone) {
      uVar12 = 0;
    }
  }
  else {
    sVar6 = ScanToPt(0x14);
    uVar12 = __aFulmul((long)sVar6,(long)sVar6);
  }
  if ((grobj & grobjPlanet) != grobjNone) {
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      iVar8 = pt.x - ppt->x;
      iVar5 = pt.y - ppt->y;
      uVar13 = __aFulmul((long)iVar8,(long)iVar8);
      if ((long)uVar13 <= (long)uVar12) {
        uVar14 = __aFulmul((long)iVar5,(long)iVar5);
        uVar14 = uVar14 + uVar13;
        if (((long)uVar14 <= (long)uVar12) && ((uVar12 != uVar14 || (uVar12 == 0)))) {
          scan.pt.x = ppt->x;
          scan.pt.y = ppt->y;
          scan.idpl = i;
          scan.grobjFull = grobjPlanet;
          scan.grobj = grobjPlanet;
          uVar12 = uVar14;
        }
      }
      ppt = ppt + 1;
    }
  }
  if ((grobj & grobjFleet) != grobjNone) {
    for (i = 0; i < cFleet; i = i + 1) {
      iVar8 = *(int *)((FLEET **)rglpfl + i);
      iVar5 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      if ((iVar8 == 0) && (iVar5 == 0)) break;
      iVar3 = pt.x - *(int *)(iVar8 + 8);
      iVar4 = pt.y - *(int *)(iVar8 + 10);
      uVar13 = __aFulmul((long)iVar3,(long)iVar3);
      if ((long)uVar13 <= (long)uVar12) {
        uVar14 = __aFulmul((long)iVar4,(long)iVar4);
        uVar14 = uVar14 + uVar13;
        if ((long)uVar14 <= (long)uVar12) {
          if (((uVar12 == uVar14) && ((scan.grobj & grobjPlanet) == grobjNone)) ||
             ((*(int *)(iVar8 + 8) == scan.pt.x && (*(int *)(iVar8 + 10) == scan.pt.y)))) {
            if (((scan.grobjFull & grobjFleet) == grobjNone) ||
               ((((FLEET *)((FLEET **)rglpfl)[scan.ifl])->iPlayer != idPlayer &&
                (*(int *)(iVar8 + 2) == idPlayer)))) {
              scan.ifl = i;
              scan.grobjFull = scan.grobjFull | grobjFleet;
              uVar14 = uVar12;
              if (scan.grobj == grobjNone) goto UTIL_SelectShip;
            }
          }
          else if ((long)uVar14 < (long)uVar12) {
UTIL_SelectShip:
            scan.pt.x = *(short *)(iVar8 + 8);
            scan.pt.y = *(short *)(iVar8 + 10);
            scan.ifl = i;
            scan.idpl = -1;
            scan.grobjFull = grobjFleet;
            scan.grobj = grobjFleet;
            uVar12 = uVar14;
          }
        }
      }
    }
  }
  if ((grobj & grobjThing) != grobjNone) {
    pTVar7 = (THING *)lpThings + cThing;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < pTVar7) {
      uVar11 = (undefined2)((ulong)lpth >> 0x10);
      iVar8 = pt.x - (&((THING *)lpth)->pt)->x;
      iVar5 = pt.y - (((THING *)lpth)->pt).y;
      uVar13 = __aFulmul((long)iVar8,(long)iVar8);
      if ((long)uVar13 <= (long)uVar12) {
        uVar14 = __aFulmul((long)iVar5,(long)iVar5);
        uVar13 = uVar13 + uVar14;
        if ((long)uVar13 <= (long)uVar12) {
          if (((uVar13 == uVar12) && ((scan.grobj & (grobjFleet|grobjPlanet)) == grobjNone)) ||
             (((&((THING *)lpth)->pt)->x == scan.pt.x && ((((THING *)lpth)->pt).y == scan.pt.y)))) {
            if ((scan.grobjFull & grobjThing) == grobjNone) {
              scan.ith = ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12;
              scan.grobjFull = scan.grobjFull | grobjThing;
              uVar13 = uVar12;
              if (scan.grobj == grobjNone) goto UTIL_SelectThing;
            }
          }
          else if ((long)uVar13 < (long)uVar12) {
UTIL_SelectThing:
            scan.pt.x = (&((THING *)lpth)->pt)->x;
            scan.pt.y = (((THING *)lpth)->pt).y;
            scan.ith = ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12;
            scan.idpl = -1;
            scan.ifl = -1;
            scan.grobjFull = grobjThing;
            scan.grobj = grobjThing;
            uVar12 = uVar13;
          }
        }
      }
      lpth = (THING *)CONCAT22(uVar11,(THING *)lpth + 1);
    }
  }
  if (((grobj & grobjOther) != grobjNone) &&
     (i = sel.fl.cord, sel.grobj == grobjFleet)) {
LAB_1038_46f2:
    i = i + -1;
    if (-1 < i) {
      piVar9 = (int *)((int)(PLORD *)sel.fl.lpplord + i * 0x12 + 4);
      iVar8 = *piVar9;
      iVar5 = piVar9[1];
      uVar13 = __aFulmul((long)(pt.x - iVar8),(long)(pt.x - iVar8));
      if ((long)uVar13 <= (long)uVar12) {
        uVar14 = __aFulmul((long)(pt.y - iVar5),(long)(pt.y - iVar5));
        uVar13 = uVar13 + uVar14;
        if ((long)uVar13 <= (long)uVar12) {
          if (((uVar13 == uVar12) &&
              ((scan.grobj & (grobjThing|grobjFleet|grobjPlanet)) == grobjNone)) ||
             ((iVar8 == scan.pt.x && (iVar5 == scan.pt.y)))) {
            if (((scan.grobjFull & grobjOther) != grobjNone) && (i != sel.scan.iwp))
            goto LAB_1038_46f2;
            scan.iwp = i;
            scan.grobjFull = scan.grobjFull | grobjOther;
            uVar13 = uVar12;
            if (scan.grobj != grobjNone) goto LAB_1038_46f2;
          }
          else if ((long)uVar12 <= (long)uVar13) goto LAB_1038_46f2;
          uVar12 = uVar13;
          scan.pt.x = iVar8;
          scan.pt.y = iVar5;
          scan.iwp = i;
          scan.ith = -1;
          scan.idpl = -1;
          scan.ifl = -1;
          scan.grobjFull = grobjOther;
          scan.grobj = grobjOther;
        }
      }
      goto LAB_1038_46f2;
    }
  }
  if ((((grobj & 0x20) == grobjNone) && (scan.grobj != grobjNone)) &&
     (uVar12 = CONCAT22(&scanT,grobj) & 0xffff000f, pt_00.y = scan.pt.y, pt_00.x = scan.pt.x,
     sVar6 = FFindNearestObject(pt_00,(GrobjClass)uVar12 ^
                                      (grobjThing|grobjOther|grobjFleet|grobjPlanet) | 0xa0,
                                (SCAN *)(uVar12 >> 0x10)), sVar6 != 0)) {
    if (scanT.idpl != -1) {
      scan.idpl = scanT.idpl;
    }
    if (scanT.ifl != -1) {
      scan.ifl = scanT.ifl;
    }
    if (scanT.iwp != -1) {
      scan.iwp = scanT.iwp;
    }
    if (scanT.ith != -1) {
      scan.ith = scanT.ith;
    }
    scan.grobjFull = scan.grobjFull | scanT.grobjFull;
  }
  if (pscan != (SCAN *)0x0) {
    pSVar10 = &scan;
    for (iVar8 = 8; iVar8 != 0; iVar8 = iVar8 + -1) {
      pSVar2 = pscan;
      pscan = (SCAN *)&(pscan->pt).y;
      pSVar1 = pSVar10;
      pSVar10 = (SCAN *)&(pSVar10->pt).y;
      (pSVar2->pt).x = (pSVar1->pt).x;
    }
  }
  return (uint)(scan.grobj != grobjNone);
}



// ======================================================================
// Function: UpdateShdefCost
// Address: 1038:47b0
// Segment: MEMORY_UTIL
// ======================================================================


void UpdateShdefCost(SHDEF *lpshdef)

{
  ulong *puVar1;
  int *piVar2;
  HullSlotType HVar3;
  HULDEF *pHVar4;
  ulong uVar5;
  short sVar6;
  uint uVar7;
  SHDEF *pSVar8;
  HS *pHVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  bool bVar12;
  PART part;
  ulong rgMin [3];
  ulong resCost;
  HUL *lphul;
  short fWeakArmor;
  ushort rgCosts [4];
  short c;
  short k;
  ulong wt;
  short dpT;
  
  uVar10 = (undefined2)((ulong)lpshdef >> 0x10);
  pSVar8 = (SHDEF *)lpshdef;
  if ((pSVar8->wFlags & 0xffU) == 7) {
    sVar6 = GetRaceGrbit((PLAYER *)rgplr + idPlayer,
                               ibitRaceRegeneratingShields);
    bVar12 = sVar6 != 0;
  }
  else {
    bVar12 = false;
  }
  part.pcom = (COMPART *)LphuldefFromId((lpshdef->hul).ihuldef);
  uVar11 = (undefined2)((ulong)part.pcom >> 0x10);
  pHVar4 = (HULDEF *)part.pcom;
  part.hs.grhst =
       ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
         hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine);
  GetTruePartCost(idPlayer,&part,rgCosts);
  for (c = 0; c < 3; c = c + 1) {
    *(ushort *)(rgMin + c) = rgCosts[c];
    *(undefined2 *)((int)rgMin + c * 4 + 2) = 0;
  }
  resCost._0_2_ = rgCosts[3];
  wt._0_2_ = (pHVar4->hul).wtEmpty;
  (pSVar8->hul).dp = (pHVar4->hul).dp;
  for (c = 0; c < (int)(uint)(pSVar8->hul).chs; c = c + 1) {
    if ((uint)(pSVar8->hul).rghs[c].wFlags >> 8 != 0) {
      pHVar9 = (pSVar8->hul).rghs + c;
      part.hs.grhst = pHVar9->grhst;
      part.hs.wFlags = pHVar9->wFlags;
      FLookupPart(&part);
      GetTruePartCost(idPlayer,&part,rgCosts);
      for (k = 0; k < 3; k = k + 1) {
        uVar7 = ((uint)(pSVar8->hul).rghs[c].wFlags >> 8) * rgCosts[k];
        puVar1 = rgMin + k;
        uVar5 = *puVar1;
        *(uint *)puVar1 = (uint)*puVar1 + uVar7;
        piVar2 = (int *)((int)rgMin + k * 4 + 2);
        *piVar2 = *piVar2 + (uint)CARRY2((uint)uVar5,uVar7);
      }
      resCost._0_2_ = (ushort)resCost + ((uint)(pSVar8->hul).rghs[c].wFlags >> 8) * rgCosts[3];
      uVar11 = (undefined2)((ulong)part.pcom >> 0x10);
      wt._0_2_ = (int)wt + ((uint)(pSVar8->hul).rghs[c].wFlags >> 8) * ((COMPART *)part.pcom)->cMass
      ;
      HVar3 = ((pSVar8->hul).rghs + c)->grhst;
      if (HVar3 == hstShield) {
        if ((((pSVar8->hul).rghs[c].wFlags & 0xffU) == 3) ||
           (((pSVar8->hul).rghs[c].wFlags & 0xffU) == 6)) {
          piVar2 = &(pSVar8->hul).dp;
          *piVar2 = *piVar2 + ((uint)(pSVar8->hul).rghs[c].wFlags >> 8) * 0x41;
        }
      }
      else if (HVar3 == hstArmor) {
        dpT = ((uint)(pSVar8->hul).rghs[c].wFlags >> 8) * ((COMPART *)part.pcom + 1)->id;
        if (bVar12) {
          dpT = dpT >> 1;
        }
        piVar2 = &(pSVar8->hul).dp;
        *piVar2 = *piVar2 + dpT;
      }
      else if ((HVar3 == hstSpecialM) && (((pSVar8->hul).rghs[c].wFlags & 0xffU) == 4)) {
        piVar2 = &(pSVar8->hul).dp;
        *piVar2 = *piVar2 + ((uint)(pSVar8->hul).rghs[c].wFlags >> 8) * 0x32;
      }
    }
  }
  for (c = 0; c < 3; c = c + 1) {
    (pSVar8->hul).rgwtOreCost[c] = (short)rgMin[c];
  }
  (pSVar8->hul).resCost = (ushort)resCost;
  (pSVar8->hul).wtEmpty = (int)wt;
  *(undefined2 *)&pSVar8->lPower = 0xffff;
  *(undefined2 *)((int)&pSVar8->lPower + 2) = 0xffff;
  return;
}



// ======================================================================
// Function: WPackLong
// Address: 1038:4ba2
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: exp */

ushort WPackLong(long l)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar1;
  ushort exp;
  
  uVar1 = CONCAT22(unaff_SI,unaff_DI);
  exp = 0;
  while( true ) {
    if (((l & 0xe000U) == 0) && (l._2_2_ == 0)) break;
    l = __aFulshr(uVar1,exp);
    exp = exp + 1;
  }
  return exp << 0xd | (uint)l;
}



// ======================================================================
// Function: GetPlanetScannerRange
// Address: 1038:4c02
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10384d73) */

short GetPlanetScannerRange(PLANET *lppl,short *pDeep)

{
  short sVar1;
  short sVar2;
  short sVar3;
  PLANET *pPVar4;
  int iVar5;
  COMPART *pCVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar7;
  long lVar8;
  ulong uVar9;
  undefined2 uVar10;
  ushort in_stack_0000ffe8;
  PART part;
  short dRange;
  short iPlrSav;
  
  sVar1 = idPlayer;
  uVar7 = (undefined2)((ulong)lppl >> 0x10);
  pPVar4 = (PLANET *)lppl;
  idPlayer = pPVar4->iPlayer;
  if (pDeep != (short *)0x0) {
    *pDeep = 0;
  }
  sVar2 = GetRaceStat((PLAYER *)rgplr + pPVar4->iPlayer,rsMajorAdv);
  if (sVar2 == 8) {
    uVar9 = __aFulmul(CONCAT22(*(undefined2 *)((int)pPVar4->rgwtMin + 0xe),
                                       (int)pPVar4->rgwtMin[3]),10);
    _sqrt(SUB84((double)(long)uVar9,0),
                  (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)(long)uVar9 >>
                                                                    0x20))));
    lVar8 = __ftol((double)CONCAT26((int)(uVar9 >> 0x10),
                                            CONCAT24((int)uVar9,CONCAT22(unaff_SI,unaff_DI))));
    sVar3 = (short)lVar8;
    sVar2 = GetRaceGrbit((PLAYER *)rgplr + idPlayer,ibitRaceNoAdvScanner);
    if (sVar2 == 0) {
      if (((pDeep != (short *)0x0) && (((uint)pPVar4->wFlags >> 9 & 1) != 0)) &&
         (iVar5 = pPVar4->iPlayer * 4,
         0x22 < *(int *)(*(int *)(iVar5 + 0x14c) + (*(uint *)&pPVar4->field11_0x2c & 0xf) * 0x93)))
      {
        *pDeep = sVar3 / 2;
      }
    }
    else {
      uVar10 = 0;
      uVar7 = 1000;
      uVar9 = __aFulmul((long)sVar3,0x584);
      lVar8 = __aFldiv(uVar9,CONCAT22(uVar10,uVar7));
      sVar3 = (short)lVar8;
      if (pDeep != (short *)0x0) {
        *pDeep = 0;
      }
    }
  }
  else {
    uVar9 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffe8);
    if (((uint)uVar9 & 0x1f) == 0x1f) {
      sVar3 = 0;
    }
    else {
      LookupBestPlanetaryScanner(&part);
      pCVar6 = (COMPART *)part.pcom;
      uVar7 = (undefined2)((ulong)part.pcom >> 0x10);
      if ((pDeep != (short *)0x0) && ((pCVar6 + 1)->id < 0)) {
        *pDeep = -(pCVar6 + 1)->id >> 1;
      }
      sVar3 = _abs((pCVar6 + 1)->id);
      sVar2 = GetRaceGrbit((PLAYER *)rgplr + idPlayer,ibitRaceNoAdvScanner);
      if (sVar2 != 0) {
        sVar3 = sVar3 << 1;
      }
    }
  }
  idPlayer = sVar1;
  return sVar3;
}



// ======================================================================
// Function: GetCachedFleetScannerRange
// Address: 1038:4e02
// Segment: MEMORY_UTIL
// ======================================================================


short GetCachedFleetScannerRange(FLEET *lpfl,short *pdPlanRange,short *ppctDetect,short *piSteal)

{
  int iVar1;
  int iVar2;
  short sVar3;
  undefined2 uVar4;
  short pctDetect;
  short iSteal;
  short dRange;
  short iPlr;
  short i;
  short dPlanRange;
  short dT;
  
  uVar4 = (undefined2)((ulong)lpfl >> 0x10);
  iVar1 = ((FLEET *)lpfl)->iPlayer;
  dRange = -1;
  dPlanRange = 0;
  iSteal = 0;
  pctDetect = 100;
  if (((uint)gd._0_2_ >> 1 & 1) == 0) {
    dRange = GetFleetScannerRange(lpfl,pdPlanRange,ppctDetect,piSteal);
  }
  else {
    for (i = 0; i < 0x10; i = i + 1) {
      if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
        iVar2 = *(int *)(*(int *)(iVar1 * 4 + 0xfe) + i * 0x93 + 0x8d);
        sVar3 = dRange;
        if ((iVar2 != 0x7ff) && (sVar3 = iVar2, iVar2 <= dRange)) {
          sVar3 = dRange;
        }
        dRange = sVar3;
        if (dPlanRange < *(int *)(*(int *)(iVar1 * 4 + 0xfe) + i * 0x93 + 0x8f)) {
          dPlanRange = *(short *)(*(int *)(iVar1 * 4 + 0xfe) + i * 0x93 + 0x8f);
        }
        if ((uint)*(byte *)(*(int *)(iVar1 * 4 + 0xfe) + i * 0x93 + 0x91) < (uint)pctDetect) {
          pctDetect = (short)*(byte *)(*(int *)(iVar1 * 4 + 0xfe) + i * 0x93 + 0x91);
        }
        iSteal = iSteal | (uint)*(byte *)(*(int *)(iVar1 * 4 + 0xfe) + i * 0x93 + 0x92);
      }
    }
    if (pdPlanRange != (short *)0x0) {
      *pdPlanRange = dPlanRange;
    }
    if (ppctDetect != (short *)0x0) {
      *ppctDetect = pctDetect;
    }
    if (piSteal != (short *)0x0) {
      *piSteal = iSteal;
    }
  }
  return dRange;
}



// ======================================================================
// Function: GetFleetScannerRange
// Address: 1038:4fb8
// Segment: MEMORY_UTIL
// ======================================================================


short GetFleetScannerRange(FLEET *lpfl,short *pdPlanRange,short *ppctDetect,short *piSteal)

{
  short sVar1;
  undefined2 uVar2;
  short pctDetect;
  short dRangeBest;
  short dPlanRangeBest;
  short iSteal;
  short dRange;
  short i;
  short dPlanRange;
  short iplr;
  
  uVar2 = (undefined2)((ulong)lpfl >> 0x10);
  iplr = ((FLEET *)lpfl)->iPlayer;
  dRange = -1;
  dPlanRange = 0;
  iSteal = 0;
  if (ppctDetect != (short *)0x0) {
    *ppctDetect = 100;
  }
  for (i = 0; i < 0x10; i = i + 1) {
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      dRangeBest = GetShdefScannerRange
                             ((SHDEF *)CONCAT22(*(undefined2 *)(iplr * 4 + 0x100),
                                                (SHDEF *)(*(int *)(iplr * 4 + 0xfe) + i * 0x93)),
                              iplr,&dPlanRangeBest,&pctDetect,&iSteal);
      if ((ppctDetect != (short *)0x0) && (pctDetect < *ppctDetect)) {
        *ppctDetect = pctDetect;
      }
      if (piSteal != (short *)0x0) {
        *piSteal = *piSteal | iSteal;
      }
      sVar1 = dRangeBest;
      if (dRangeBest <= dRange) {
        sVar1 = dRange;
      }
      dRange = sVar1;
      if (dPlanRange < dPlanRangeBest) {
        dPlanRange = dPlanRangeBest;
      }
    }
  }
  if (pdPlanRange != (short *)0x0) {
    *pdPlanRange = dPlanRange;
  }
  return dRange;
}



// ======================================================================
// Function: GetShdefScannerRange
// Address: 1038:50d0
// Segment: MEMORY_UTIL
// ======================================================================


short GetShdefScannerRange
          (SHDEF *lpshdef,short iplr,short *pdPlanRange,short *ppctDetect,short *piSteal)

{
  double dVar1;
  HullDef HVar2;
  int iVar3;
  bool bVar4;
  uint uVar5;
  uint id;
  short sVar6;
  HS *pHVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  bool bVar8;
  bool bVar9;
  SCANNER *pSVar10;
  double *pdVar11;
  long lVar12;
  char *in_stack_0000ffa8;
  char *in_stack_0000ffaa;
  undefined2 uVar13;
  undefined2 uVar14;
  double lRange4;
  double lBIPR4;
  short j;
  short iSteal;
  double lT;
  short dRange;
  double lPlanRange4;
  short cDetectors;
  short fBuiltIn;
  short iScanner;
  short fHasScanner;
  short dRangeT;
  double lBIR4;
  short dRangeT2;
  HS *lphs;
  short chs;
  
  _lRange4 = 0.0;
  _lPlanRange4 = 0.0;
  bVar4 = false;
  iSteal = 0;
  cDetectors = 0;
  if (iplr == -1) {
LAB_1038_513f:
    bVar8 = false;
  }
  else {
    in_stack_0000ffaa = (char *)&DAT_1120_1038;
    in_stack_0000ffa8 = (char *)szLastMsgGet + 0xd2;
    sVar6 = GetRaceStat((PLAYER *)rgplr + iplr,rsMajorAdv);
    if (sVar6 != 9) goto LAB_1038_513f;
    bVar8 = true;
  }
  _lBIR4 = DOUBLE_m1_0__1120_1cca;
  _lBIPR4 = DOUBLE_m1_0__1120_1cca;
  if (ppctDetect != (short *)0x0) {
    *ppctDetect = 100;
  }
  if (bVar8) {
    if ((lpshdef->hul).ihuldef == ihuldefScout) {
      bVar8 = false;
    }
    else if ((lpshdef->hul).ihuldef == ihuldefDestroyer) {
      bVar8 = false;
    }
    else {
      HVar2 = (lpshdef->hul).ihuldef;
      bVar8 = HVar2 < ihuldefFrigate;
      if (HVar2 != ihuldefFrigate) goto LAB_1038_5272;
    }
    __aFfcompp();
    if (bVar8) {
      if (((uint)game.wCrap >> 3 & 1) == 0) {
        dVar1 = (double)(long)(*(char *)((int)rgplr[0].rgTech + 4 + iplr * 0xc0) * 10);
        _lBIPR4 = dVar1 * dVar1 * dVar1 * dVar1;
        _lBIR4 = dVar1 * 2.0 * dVar1 * 2.0;
        _lBIR4 = _lBIR4 * _lBIR4;
      }
      else {
        _lBIR4 = DOUBLE_2560000_0__1120_1cd2;
        _lBIPR4 = DOUBLE_160000_0__1120_1cda;
      }
    }
    _lRange4 = _lBIR4;
    _lPlanRange4 = _lBIPR4;
  }
LAB_1038_5272:
  lphs = (HS *)CONCAT22(lpshdef._2_2_,(((SHDEF *)lpshdef)->hul).rghs);
  uVar5 = (uint)(((SHDEF *)lpshdef)->hul).chs;
  j = 0;
  do {
    bVar8 = (uint)j < uVar5;
    bVar9 = j == uVar5;
    if ((int)uVar5 <= j) {
      uVar13 = 0;
      uVar14 = 0;
      __aFfcompp();
      if ((!bVar8 && !bVar9) || (bVar4)) {
        pdVar11 = _sqrt(SUB84(_lRange4,0),
                                (double)CONCAT26(in_stack_0000ffaa,
                                                 CONCAT24(in_stack_0000ffa8,
                                                          (long)((qword)_lRange4 >> 0x20))));
        dVar1 = *(double *)pdVar11;
        in_stack_0000ffa8 = SUB82(dVar1,0);
        in_stack_0000ffaa = (char *)((qword)dVar1 >> 0x10);
        _sqrt(SUB84(dVar1,0),
                      (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20))));
        lVar12 = __ftol((double)CONCAT26(uVar14,CONCAT24(uVar13,CONCAT22(unaff_SI,unaff_DI))
                                                ));
        dRange = (short)lVar12;
        if (iplr != -1) {
          in_stack_0000ffaa = (char *)0x1118;
          in_stack_0000ffa8 = (char *)0x5612;
          sVar6 = GetRaceGrbit((PLAYER *)rgplr + iplr,ibitRaceNoAdvScanner);
          if (sVar6 != 0) {
            dRange = dRange << 1;
          }
        }
      }
      else {
        dRange = -1;
      }
      if (pdPlanRange != (short *)0x0) {
        pdVar11 = _sqrt(SUB84(_lPlanRange4,0),
                                (double)CONCAT26(in_stack_0000ffaa,
                                                 CONCAT24(in_stack_0000ffa8,
                                                          (long)((qword)_lPlanRange4 >> 0x20))));
        _sqrt(SUB84(*(double *)pdVar11,0),
                      (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)*(double *)pdVar11
                                                                        >> 0x20))));
        lVar12 = __ftol((double)CONCAT26(uVar14,CONCAT24(uVar13,CONCAT22(unaff_SI,unaff_DI))
                                                ));
        *pdPlanRange = (short)lVar12;
      }
      if (piSteal != (short *)0x0) {
        *piSteal = iSteal;
      }
      if (ppctDetect != (short *)0x0) {
        if (0x11 < cDetectors) {
          cDetectors = 0x11;
        }
        *ppctDetect = (uint)((byte *)vrgbTachyon)[cDetectors];
      }
      return dRange;
    }
    uVar13 = (undefined2)((ulong)lphs >> 0x10);
    pHVar7 = (HS *)lphs;
    if ((uint)pHVar7->wFlags >> 8 != 0) {
      if (lphs->grhst == hstScanner) {
        bVar4 = true;
        id = pHVar7->wFlags & 0xff;
        pSVar10 = LpscannerFromId(id);
        dVar1 = (double)(long)((SCANNER *)pSVar10)->dRange;
        dVar1 = dVar1 * dVar1;
        _lRange4 = _lRange4 + (double)((uint)pHVar7->wFlags >> 8) * dVar1 * dVar1;
        in_stack_0000ffaa = (char *)szMsgBuf + 0x14;
        pSVar10 = LpscannerFromId(id);
        iVar3 = ((SCANNER *)pSVar10)->grfAbilities;
        if (id == 6) {
          dRangeT = 0x2d;
        }
        else if (id == 5) {
          dRangeT = 0;
          iSteal = iSteal | 1;
        }
        else if (id == 0xe) {
          dRangeT = 0x78;
          iSteal = 3;
        }
        else {
          if (iVar3 < 1) goto LAB_1038_5298;
          if (iVar3 == 1) {
            dRangeT = 0x32;
          }
          else if (iVar3 == 2) {
            dRangeT = 100;
          }
          else {
            dRangeT = 200;
          }
        }
      }
      else {
        if ((lphs->grhst == hstArmor) && ((pHVar7->wFlags & 0xffU) == 9)) {
          dRangeT = 0x50;
          dRangeT2 = 0x28;
        }
        else if ((lphs->grhst == hstBeam) && ((pHVar7->wFlags & 0xffU) == 0x12)) {
          dRangeT = 0x96;
          dRangeT2 = 0x4b;
        }
        else {
          if ((lphs->grhst != hstShield) || ((pHVar7->wFlags & 0xffU) != 6)) {
            if (((ppctDetect != (short *)0x0) && (lphs->grhst == hstSpecialE)) &&
               ((pHVar7->wFlags & 0xffU) == 0xf)) {
              cDetectors = cDetectors + ((uint)pHVar7->wFlags >> 8);
            }
            goto LAB_1038_5298;
          }
          dRangeT = 0x32;
          dRangeT2 = 0x19;
        }
        dVar1 = (double)(long)dRangeT * (double)(long)dRangeT;
        _lRange4 = _lRange4 + (double)((uint)pHVar7->wFlags >> 8) * dVar1 * dVar1;
        dRangeT = dRangeT2;
      }
      dVar1 = (double)(long)dRangeT * (double)(long)dRangeT;
      _lPlanRange4 = _lPlanRange4 + (double)((uint)pHVar7->wFlags >> 8) * dVar1 * dVar1;
    }
LAB_1038_5298:
    j = j + 1;
    lphs = (HS *)CONCAT22(uVar13,pHVar7 + 1);
  } while( true );
}



// ======================================================================
// Function: LCalcFuelGainFromRamScoops
// Address: 1038:56b8
// Segment: MEMORY_UTIL
// ======================================================================


long LCalcFuelGainFromRamScoops(FLEET *lpfl,short iWarp,long dTravel)

{
  ENGINE *pEVar1;
  uint uVar2;
  undefined2 uVar3;
  FLEET *pFVar4;
  int iVar5;
  SHDEF *pSVar6;
  undefined2 uVar7;
  undefined2 uVar8;
  bool bVar9;
  ENGINE *pEVar10;
  ulong uVar11;
  ulong uVar12;
  long pctShip10;
  long pct10;
  SHDEF *lpshdef;
  short *rgiFuel;
  short i;
  
  uVar12 = 0;
  if (iWarp < 0xb) {
    i = 0;
    uVar7 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar4 = (FLEET *)lpfl;
    iVar5 = pFVar4->iPlayer * 4;
    lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iVar5 + 0x100),
                                (SHDEF *)*(undefined2 *)(iVar5 + 0xfe));
    for (; i < 0x10; i = i + 1) {
      pSVar6 = (SHDEF *)lpshdef;
      uVar8 = (undefined2)((ulong)lpshdef >> 0x10);
      if (pFVar4->rgcsh[i] != 0) {
        pEVar10 = LpengineFromId((pSVar6->hul).rghs[0].wFlags & 0xff);
        uVar3 = (undefined2)((ulong)pEVar10 >> 0x10);
        pEVar1 = (ENGINE *)pEVar10;
        pctShip10._0_2_ = 0;
        pctShip10._2_2_ = 0;
        if (iWarp < 10) {
          if (pEVar1->rgcFuelUsed[iWarp] == 0) {
            pctShip10._0_2_ = (uint)(pSVar6->hul).rghs[0].wFlags >> 8;
            pctShip10._2_2_ = 0;
            if (pEVar1->rgcFuelUsed[iWarp + 1] == 0) {
              uVar2 = ((uint)(pSVar6->hul).rghs[0].wFlags >> 8) * 2;
              bVar9 = CARRY2((uint)pctShip10,uVar2);
              pctShip10._0_2_ = (uint)pctShip10 + uVar2;
              pctShip10._2_2_ = (uint)bVar9;
              if ((iWarp < 9) && (pEVar1->rgcFuelUsed[iWarp + 2] == 0)) {
                uVar2 = ((uint)(pSVar6->hul).rghs[0].wFlags >> 8) * 3;
                bVar9 = CARRY2((uint)pctShip10,uVar2);
                pctShip10._0_2_ = (uint)pctShip10 + uVar2;
                pctShip10._2_2_ = pctShip10._2_2_ + bVar9;
                if ((iWarp < 8) && (pEVar1->rgcFuelUsed[iWarp + 3] == 0)) {
                  uVar2 = ((uint)(pSVar6->hul).rghs[0].wFlags >> 8) * 4;
                  bVar9 = CARRY2((uint)pctShip10,uVar2);
                  pctShip10._0_2_ = (uint)pctShip10 + uVar2;
                  pctShip10._2_2_ = pctShip10._2_2_ + bVar9;
                }
              }
            }
          }
          uVar11 = __aFulmul(CONCAT22(pctShip10._2_2_,(uint)pctShip10),
                                     (long)pFVar4->rgcsh[i]);
          uVar12 = uVar11 + uVar12;
        }
      }
      lpshdef = (SHDEF *)CONCAT22(uVar8,pSVar6 + 1);
    }
    uVar12 = __aFulmul(uVar12,dTravel);
  }
  else {
    uVar12 = 0;
  }
  return uVar12;
}



// ======================================================================
// Function: CalcPlayerScore
// Address: 1038:58a6
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10385b22) */
/* WARNING: Removing unreachable block (ram,0x10385938) */
/* WARNING: Removing unreachable block (ram,0x10385b4a) */

long CalcPlayerScore(short iPlr,SCORE *pscore)

{
  uint *puVar1;
  int *piVar2;
  SCORE *pSVar3;
  SCORE *pSVar4;
  uint uVar5;
  int iVar6;
  uint uVar7;
  ushort uVar8;
  PLANET *pPVar9;
  int iVar10;
  int iVar11;
  undefined2 unaff_SI;
  SCORE *pSVar12;
  undefined2 unaff_DI;
  undefined2 uVar13;
  bool bVar14;
  long lVar15;
  HULDEF *pHVar16;
  long lVar17;
  ulong uVar18;
  short sVar19;
  PLANET *pPVar20;
  short rgType [16];
  long lPower;
  short iTech;
  FLEET *lpfl;
  short ifl;
  short i;
  PLANET *lppl;
  PLANET *lpplMac;
  SCORE score;
  long lTemp;
  long rgcsh [3];
  
  lVar17 = CONCAT22(unaff_SI,unaff_DI);
  _memset(&score,0,0x14);
  pPVar9 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  pPVar20 = (PLANET *)lpPlanets;
  while ((PLANET *)lppl < pPVar9) {
    uVar13 = (undefined2)((ulong)lppl >> 0x10);
    if (((PLANET *)lppl)->iPlayer == iPlr) {
      score.cPlanet = score.cPlanet + 1;
      lVar15 = __aFldiv(CONCAT22(*(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe) +
                                         (uint)(0xfc18 < *(uint *)(((PLANET *)lppl)->rgwtMin + 3)),
                                         *(uint *)(((PLANET *)lppl)->rgwtMin + 3) + 999),1000);
      if (6 < lVar15) {
        lVar15 = 6;
      }
      score.lScore = lVar15 + score.lScore;
      if (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0) {
        pHVar16 = LphuldefFromId
                            (*(HullDef *)
                              (*(int *)(iPlr * 4 + 0x14c) +
                              (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) * 0x93));
        if ((((HULDEF *)pHVar16)->hul).wtCargoMax != 0) {
          score.cStarbase = score.cStarbase + 1;
        }
      }
      uVar7 = CResourcesAtPlanet(lppl,iPlr);
      bVar14 = CARRY2((uint)score.cResources,uVar7);
      score.cResources._0_2_ = (uint)score.cResources + uVar7;
      score.cResources._2_2_ = score.cResources._2_2_ + ((int)uVar7 >> 0xf) + (uint)bVar14;
    }
    lppl = (PLANET *)CONCAT22(uVar13,(PLANET *)lppl + 1);
  }
  lVar15 = __aFldiv(CONCAT22(score.cResources._2_2_,(uint)score.cResources),0x1e);
  lVar15 = lVar15 + score.lScore + (long)(score.cStarbase * 3);
  score.lScore = lVar15;
  if ((*(uint *)((int)&rgplr[0].wFlags + iPlr * 0xc0) & 1) == 0) {
    for (i = 0; i < 6; i = i + 1) {
      iVar10 = (int)*(char *)(iPlr * 0xc0 + 0x59bc + i);
      score.cTechLevels = score.cTechLevels + iVar10;
      if (iVar10 < 4) {
        lVar15 = lVar15 + iVar10;
        score.lScore = lVar15;
      }
      else if (iVar10 < 7) {
        lVar15 = lVar15 + (iVar10 * 2 + -3);
        score.lScore = lVar15;
      }
      else if (iVar10 < 10) {
        iVar10 = iVar10 * 3 + -9;
        score.lScore = lVar15 + iVar10;
        lVar15 = lVar15 + iVar10;
      }
      else {
        iVar10 = iVar10 * 4 + -0x12;
        score.lScore = lVar15 + iVar10;
        lVar15 = lVar15 + iVar10;
      }
    }
  }
  for (i = 0; score.lScore = lVar15, i < 0x10; i = i + 1) {
    if ((*(uint *)(*(int *)(iPlr * 4 + 0xfe) + i * 0x93 + 0x7b) >> 9 & 1) == 0) {
      lVar15 = LComputePower((SHDEF *)CONCAT22(*(undefined2 *)(iPlr * 4 + 0x100),
                                               (SHDEF *)(*(int *)(iPlr * 4 + 0xfe) + i * 0x93)));
      if (lVar15 < 1) {
        rgType[i] = 0;
        lVar15 = score.lScore;
      }
      else if (lVar15 < 2000) {
        rgType[i] = 1;
        lVar15 = score.lScore;
      }
      else {
        rgType[i] = 2;
        lVar15 = score.lScore;
      }
    }
    else {
      rgType[i] = -1;
      lVar15 = score.lScore;
    }
  }
  for (i = 0; i < 3; i = i + 1) {
    *(undefined2 *)(rgcsh + i) = 0;
    *(undefined2 *)((int)rgcsh + i * 4 + 2) = 0;
  }
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
    iVar10 = *(int *)((FLEET **)rglpfl + ifl);
    iVar11 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    if ((iVar10 == 0) && (iVar11 == 0)) break;
    if ((*(int *)(iVar10 + 2) == iPlr) && ((*(uint *)(iVar10 + 4) >> 10 & 1) == 0)) {
      for (i = 0; i < 0x10; i = i + 1) {
        if ((0 < *(int *)(iVar10 + 0xc + i * 2)) && (rgType[i] != -1)) {
          uVar5 = *(uint *)(iVar10 + 0xc + i * 2);
          iVar6 = rgType[i];
          puVar1 = (uint *)(rgcsh + iVar6);
          uVar7 = *puVar1;
          *puVar1 = *puVar1 + uVar5;
          piVar2 = (int *)((int)rgcsh + iVar6 * 4 + 2);
          *piVar2 = *piVar2 + ((int)uVar5 >> 0xf) + (uint)CARRY2(uVar7,uVar5);
        }
      }
    }
  }
  lVar17 = __aFlshl(lVar17,(ushort)pPVar20);
  uVar13 = (undefined2)lVar17;
  iVar10 = score.cPlanet >> 0xf;
  if ((iVar10 < rgcsh[0]._2_2_) ||
     ((iVar10 <= rgcsh[0]._2_2_ && ((uint)score.cPlanet <= (uint)rgcsh[0])))) {
    rgcsh[0]._0_2_ = score.cPlanet;
    rgcsh[0]._2_2_ = iVar10;
  }
  lVar15 = __aFldiv(CONCAT22(rgcsh[0]._2_2_,(uint)rgcsh[0]),2);
  score.lScore = lVar15 + CONCAT22((int)((ulong)lVar17 >> 0x10),uVar13) + score.lScore;
  if ((-1 < rgcsh[2]._2_2_) && ((0 < rgcsh[2]._2_2_ || ((uint)rgcsh[2] != 0)))) {
    iVar10 = score.cPlanet >> 0xf;
    uVar8 = score.cPlanet + (uint)rgcsh[2];
    iVar11 = iVar10 + rgcsh[2]._2_2_ + (uint)CARRY2(score.cPlanet,(uint)rgcsh[2]);
    sVar19 = score.cPlanet;
    uVar18 = __aFlshl((long)score.cPlanet,uVar8);
    uVar18 = __aFulmul(uVar18,CONCAT22(iVar10,sVar19));
    lVar17 = __aFldiv(uVar18,CONCAT22(iVar11,uVar8));
    score.lScore = lVar17 + score.lScore;
  }
  for (i = 0; i < 3; i = i + 1) {
    uVar8 = WPackLong(CONCAT22(*(undefined2 *)((int)rgcsh + i * 4 + 2),(int)rgcsh[i]));
    score.rgcsh[i] = uVar8;
  }
  if (pscore != (SCORE *)0x0) {
    pSVar12 = &score;
    for (iVar10 = 10; iVar10 != 0; iVar10 = iVar10 + -1) {
      pSVar4 = pscore;
      pscore = (SCORE *)((int)&pscore->lScore + 2);
      pSVar3 = pSVar12;
      pSVar12 = (SCORE *)((int)&pSVar12->lScore + 2);
      *(int *)&pSVar4->lScore = (int)pSVar3->lScore;
    }
  }
  return score.lScore;
}



// ======================================================================
// Function: GetTrueHullCost
// Address: 1038:5dba
// Segment: MEMORY_UTIL
// ======================================================================


void GetTrueHullCost(short iPlayer,HUL *lphul,ushort *rgCost)

{
  short i;
  
  for (i = 0; i < 3; i = i + 1) {
    rgCost[i] = ((HUL *)lphul)->rgwtOreCost[i];
  }
  rgCost[3] = ((HUL *)lphul)->resCost;
  return;
}



// ======================================================================
// Function: DecorateHullName
// Address: 1038:5e0e
// Segment: MEMORY_UTIL
// ======================================================================


void DecorateHullName(short iplr,short ish,char *psz)

{
  undefined2 uVar1;
  short sVar2;
  ushort uVar3;
  int iVar4;
  short iVal;
  SHDEF *lpshdef;
  short c;
  short i;
  
  uVar1 = *(undefined2 *)(iplr * 4 + 0x100);
  iVar4 = *(int *)(iplr * 4 + 0xfe) + ish * 0x93;
  if ((*(uint *)(iVar4 + 0x7b) >> 9 & 1) == 0) {
    __fstrcpy((char *)CONCAT22((undefined1 *)&DAT_1120_1120,psz),
                      (char *)CONCAT22(uVar1,(char *)(iVar4 + 8)));
    if (iplr != idPlayer) {
      c = 0;
      iVal = 1;
      for (i = 0; i < 0x10; i = i + 1) {
        if ((((i != ish) && ((*(uint *)(*(int *)(iplr * 4 + 0xfe) + i * 0x93 + 0x7b) >> 9 & 1) == 0)
             ) && (sVar2 = __fstrcmp((char *)CONCAT22((undefined1 *)&DAT_1120_1120,psz),
                                             (char *)CONCAT22(*(undefined2 *)(iplr * 4 + 0x100),
                                                              (char *)(*(int *)(iplr * 4 + 0xfe) +
                                                                       i * 0x93 + 8))), sVar2 == 0))
           && (c = c + 1, i < ish)) {
          iVal = iVal + 1;
        }
      }
      if (c != 0) {
        uVar3 = _strlen(psz);
        psz[uVar3] = ' ';
        psz[uVar3 + 1] = '(';
        IntToRoman(iVal,psz + uVar3 + 2);
        _strcat(psz,(char *)0x539);
      }
    }
  }
  else {
    *psz = '\0';
  }
  return;
}



// ======================================================================
// Function: DrawABunchOfStars
// Address: 1038:5fe2
// Segment: MEMORY_UTIL
// ======================================================================


void DrawABunchOfStars(HDC hdc,RECT *prc)

{
  int c;
  int c_00;
  short sVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar2;
  long lVar3;
  RECT rc;
  RECT rcOut;
  short dx;
  short iClr;
  short i;
  short dy;
  short iMax;
  long lPixTot;
  
  rc.left = prc->left;
  rc.top = prc->top;
  rc.right = prc->right;
  rc.bottom = prc->bottom;
  PushRandom(0xb0011,CONCAT22(unaff_SI,unaff_DI));
  InflateRect((undefined2 *)CONCAT22(unaff_SS,&rc),-3,-3);
  c = rc.right - rc.left;
  c_00 = rc.bottom - rc.top;
  uVar2 = __aFulmul((long)c,(long)c_00);
  for (iClr = 0; iClr < 5; iClr = iClr + 1) {
    lVar3 = __aFldiv(uVar2,CONCAT22(*(undefined2 *)((int)(long *)rgDSDivCnt + iClr * 4 + 2),
                                            (int)((long *)rgDSDivCnt)[iClr]));
    for (i = 0; i < (int)lVar3; i = i + 1) {
      sVar1 = Random(c);
      rcOut.left = sVar1 + rc.left;
      sVar1 = Random(c_00);
      rcOut.top = sVar1 + rc.top;
      rcOut.right = rcOut.left + 1;
      rcOut.bottom = rcOut.top + 1;
      SetBkColor(hdc,CONCAT22(*(undefined2 *)((int)(ulong *)rgcrDrawStars + iClr * 4 + 2),
                              (int)((ulong *)rgcrDrawStars)[iClr]));
      ExtTextOut(hdc,0,0,2,(undefined2 *)CONCAT22(unaff_SS,&rcOut),(LPCSTR)0x0,0,(short *)0x0);
    }
  }
  for (iClr = 0; iClr < 4; iClr = iClr + 1) {
    lVar3 = __aFldiv(uVar2,CONCAT22(*(undefined2 *)((int)(long *)rgDSDivCnt2 + iClr * 4 + 2)
                                            ,(int)((long *)rgDSDivCnt2)[iClr]));
    for (i = 0; i < (int)lVar3 + 1; i = i + 1) {
      sVar1 = Random(c);
      rcOut.left = sVar1 + rc.left;
      sVar1 = Random(c_00);
      rcOut.top = sVar1 + rc.top;
      rcOut.right = rcOut.left + 3;
      rcOut.bottom = rcOut.top + 3;
      SetBkColor(hdc,CONCAT22(*(undefined2 *)((int)(ulong *)rgcrDrawStars2b + iClr * 4 + 2),
                              (int)((ulong *)rgcrDrawStars2b)[iClr]));
      ExtTextOut(hdc,0,0,2,(undefined2 *)CONCAT22(unaff_SS,&rcOut),(LPCSTR)0x0,0,(short *)0x0);
      SetBkColor(hdc,CONCAT22(*(undefined2 *)((int)(ulong *)rgcrDrawStars2a + iClr * 4 + 2),
                              (int)((ulong *)rgcrDrawStars2a)[iClr]));
      InflateRect((undefined2 *)CONCAT22(unaff_SS,&rcOut),-1,0);
      ExtTextOut(hdc,0,0,2,(undefined2 *)CONCAT22(unaff_SS,&rcOut),(LPCSTR)0x0,0,(short *)0x0);
      InflateRect((undefined2 *)CONCAT22(unaff_SS,&rcOut),1,-1);
      ExtTextOut(hdc,0,0,2,(undefined2 *)CONCAT22(unaff_SS,&rcOut),(LPCSTR)0x0,0,(short *)0x0);
    }
  }
  PopRandom();
  return;
}



// ======================================================================
// Function: LongFromSerialCh
// Address: 1038:6280
// Segment: MEMORY_UTIL
// ======================================================================


long LongFromSerialCh(char ch)

{
  long l;
  
  if ((ch < 'A') || ('Z' < ch)) {
    l._0_2_ = (int)ch - 0x16;
  }
  else {
    l._0_2_ = (int)ch - 0x41;
  }
  l._2_2_ = (int)(uint)l >> 0xf;
  if ((l._2_2_ < 0) || ((l._2_2_ < 1 && ((uint)l < 0x20)))) {
    l._0_2_ = (uint)l ^ 0x15;
  }
  return CONCAT22(l._2_2_,(uint)l);
}



// ======================================================================
// Function: FValidSerialNo
// Address: 1038:62f8
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10386324) */

short FValidSerialNo(char *psz,long *plSerial)

{
  undefined2 uVar1;
  undefined2 uVar2;
  ushort uVar3;
  short sVar4;
  int iVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  bool bVar6;
  ulong uVar7;
  long lVar8;
  long lVar9;
  long lVar10;
  long l;
  long lSerial;
  long lCur;
  short i;
  long lBuild;
  
  lVar10 = CONCAT22(unaff_SI,unaff_DI);
  uVar7 = LongFromSerialCh(*psz);
  if ((long)uVar7 < 0x20) {
    uVar7 = uVar7 ^ 0x15;
  }
  lVar8 = LongFromSerialCh(psz[1]);
  uVar1 = (undefined2)lVar8;
  uVar7 = __aFulmul(uVar7,0x24);
  lVar9 = LongFromSerialCh(psz[4]);
  uVar2 = (undefined2)lVar9;
  uVar7 = __aFulmul(uVar7 + CONCAT22((int)((ulong)lVar8 >> 0x10),uVar1),0x24);
  lVar8 = LongFromSerialCh(psz[7]);
  uVar1 = (undefined2)lVar8;
  uVar7 = __aFulmul(uVar7 + CONCAT22((int)((ulong)lVar9 >> 0x10),uVar2),0x24);
  lVar9 = LongFromSerialCh(psz[3]);
  uVar3 = (ushort)lVar9;
  uVar7 = __aFulmul(uVar7 + CONCAT22((int)((ulong)lVar8 >> 0x10),uVar1),0x24);
  uVar7 = uVar7 + CONCAT22((int)((ulong)lVar9 >> 0x10),uVar3);
  if (plSerial != (long *)0x0) {
    *(int *)plSerial = (int)uVar7;
    *(undefined2 *)((int)plSerial + 2) = (int)(uVar7 >> 0x10);
  }
  PushRandom(0x11000b,lVar10);
  Randomize2(uVar7);
  lVar9 = __aFlshr(lVar10,uVar3);
  lVar8 = 0;
  for (i = 0; lCur._0_2_ = (uint)lVar9, i < 3; i = i + 1) {
    l._0_2_ = (uint)lCur & 0xf;
    for (l._2_2_ = 0; (0 < l._2_2_ || (-1 < l._2_2_)); l._2_2_ = l._2_2_ - (uint)bVar6) {
      Random(0x100);
      bVar6 = (uint)l == 0;
      l._0_2_ = (uint)l - 1;
    }
    uVar3 = Random(0x100);
    iVar5 = (int)uVar3 >> 0xf;
    lVar8 = __aFlshl(lVar10,uVar3);
    lVar8 = lVar8 + CONCAT22(iVar5,uVar3);
    lVar9 = __aFlshr(lVar10,uVar3);
  }
  PopRandom();
  lVar10 = LongFromSerialCh(psz[2]);
  lVar9 = __aFlrem(lVar8,0x24);
  if (lVar9 == lVar10) {
    lVar10 = __aFldiv(lVar8,0x24);
    lVar8 = LongFromSerialCh(psz[5]);
    lVar9 = __aFlrem(lVar10,0x24);
    if (lVar9 == lVar8) {
      lVar10 = __aFldiv(lVar10,0x24);
      lVar8 = LongFromSerialCh(psz[6]);
      lVar10 = __aFlrem(lVar10,0x24);
      if (lVar10 == lVar8) {
        sVar4 = 1;
      }
      else {
        sVar4 = 0;
      }
    }
    else {
      sVar4 = 0;
    }
  }
  else {
    sVar4 = 0;
  }
  return sVar4;
}



// ======================================================================
// Function: FMatchTarget
// Address: 1038:6612
// Segment: MEMORY_UTIL
// ======================================================================


short FMatchTarget(FLEET *lpflTarget,short mdTarget,short fExact)

{
  uint uVar1;
  int iVar2;
  HULDEF *pHVar3;
  short ish;
  short imd;
  
  if (mdTarget != 3) {
    if (mdTarget == 4) {
      for (ish = 0; ish < 0x10; ish = ish + 1) {
        if (((FLEET *)lpflTarget)->rgcsh[ish] != 0) {
          iVar2 = ((FLEET *)lpflTarget)->iPlayer * 4;
          pHVar3 = LphuldefFromId(*(HullDef *)(*(int *)(iVar2 + 0xfe) + ish * 0x93));
          uVar1 = (uint)((HULDEF *)pHVar3)->wFlags >> 10 & 0xf;
          if ((uVar1 == 1) || (uVar1 == 5)) break;
        }
      }
      if (ish != 0x10) {
        return 1;
      }
      return 0;
    }
    if (mdTarget != 5) {
      if (mdTarget == 6) {
        ish = 0;
        while ((ish < 0x10 &&
               ((((FLEET *)lpflTarget)->rgcsh[ish] == 0 ||
                (iVar2 = ((FLEET *)lpflTarget)->iPlayer * 4,
                pHVar3 = LphuldefFromId(*(HullDef *)(*(int *)(iVar2 + 0xfe) + ish * 0x93)),
                ((uint)((HULDEF *)pHVar3)->wFlags >> 10 & 0xf) != 7))))) {
          ish = ish + 1;
        }
        if (ish != 0x10) {
          return 1;
        }
        return 0;
      }
      if (mdTarget != 7) {
        if (fExact == 0) {
          return 1;
        }
        return 0;
      }
      ish = 0;
      while ((ish < 0x10 &&
             ((((FLEET *)lpflTarget)->rgcsh[ish] == 0 ||
              (iVar2 = ((FLEET *)lpflTarget)->iPlayer * 4,
              pHVar3 = LphuldefFromId(*(HullDef *)(*(int *)(iVar2 + 0xfe) + ish * 0x93)),
              ((uint)((HULDEF *)pHVar3)->wFlags >> 10 & 0xf) != 1))))) {
        ish = ish + 1;
      }
      if (ish != 0x10) {
        return 1;
      }
      return 0;
    }
  }
  for (ish = 0; ish < 0x10; ish = ish + 1) {
    if (((FLEET *)lpflTarget)->rgcsh[ish] != 0) {
      iVar2 = ((FLEET *)lpflTarget)->iPlayer * 4;
      pHVar3 = LphuldefFromId(*(HullDef *)(*(int *)(iVar2 + 0xfe) + ish * 0x93));
      uVar1 = (uint)((HULDEF *)pHVar3)->wFlags >> 10 & 0xf;
      if ((1 < uVar1) && (uVar1 < 5)) break;
    }
  }
  if (mdTarget == 3) {
    if (ish == 0x10) {
      return 0;
    }
  }
  else if (ish != 0x10) {
    return 0;
  }
  return 1;
}



// ======================================================================
// Function: ValidateWaypoints
// Address: 1038:68c6
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10386e28) */
/* WARNING: Removing unreachable block (ram,0x10386f42) */

void ValidateWaypoints(void)

{
  byte *pbVar1;
  FLEET *pFVar2;
  int iVar3;
  FLEET *pFVar4;
  THING *pTVar5;
  long lVar6;
  uint uVar7;
  uint mdTarget_00;
  short sVar8;
  int iVar9;
  ORDER *pOVar10;
  undefined2 uVar11;
  THING *pTVar12;
  FLEET *pFVar13;
  long lVar14;
  short iplrHi;
  FLEET *lpfl2;
  short iord;
  short cFound;
  FLEET *lpfl;
  THING *lpth;
  short ifl;
  ORDER *lpord;
  long wtMatch;
  FLEET *lpflMatch;
  long wt;
  short ifl2;
  FLEET *lpflTarget;
  short mdTarget;
  
  ifl = 0;
  do {
    if (cFleet <= ifl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pFVar2 = ((FLEET **)rglpfl)[ifl];
    iVar3 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar3,pFVar2);
    if ((pFVar2 == (FLEET *)0x0) && (iVar3 == 0)) {
      return;
    }
    if (((((*(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax >> 8 & 0xf) != 1) &&
         ((*(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax & 0xf) != 1)) &&
        ((*(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax & 0xf) != 4)) && (-1 < pFVar2->wFlags)) {
      if (pFVar2->idPlanet == -1) {
        *(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax =
             *(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax & 0xf0ff | 0x400;
        ((PLORD *)pFVar2->lpplord + 2)->wFlags = 0;
      }
      else {
        *(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax =
             *(uint *)&((PLORD *)pFVar2->lpplord)[2].iordMax & 0xf0ff | 0x100;
        ((PLORD *)pFVar2->lpplord + 2)->wFlags = pFVar2->idPlanet;
      }
    }
    if (((uint)pFVar2->wFlags >> 10 & 1) == 0) {
      if ((&pFVar2->pt)->x < 1000) {
        (&pFVar2->pt)->x = 1000;
        ((PLORD *)pFVar2->lpplord + 1)->wFlags = 1000;
      }
      else if (dGal + 1000 < (&pFVar2->pt)->x) {
        (&pFVar2->pt)->x = dGal + 1000;
        ((PLORD *)pFVar2->lpplord + 1)->wFlags = dGal + 1000;
      }
      if ((pFVar2->pt).y < 1000) {
        (pFVar2->pt).y = 1000;
        pbVar1 = &((PLORD *)pFVar2->lpplord)[1].iordMax;
        pbVar1[0] = 0xe8;
        pbVar1[1] = 3;
      }
      else if (dGal + 1000 < (pFVar2->pt).y) {
        (pFVar2->pt).y = dGal + 1000;
        *(short *)&((PLORD *)pFVar2->lpplord)[1].iordMax = dGal + 1000;
      }
      if ((1 < pFVar2->cord) || (pFVar2->wFlags < 0)) {
        iord = (short)(-1 < pFVar2->wFlags);
        lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar2->lpplord + 2),
                                  (ORDER *)(*(int *)&pFVar2->lpplord + 4 + iord * 0x12));
        for (; iord < pFVar2->cord; iord = iord + 1) {
          uVar11 = (undefined2)((ulong)lpord >> 0x10);
          pOVar10 = (ORDER *)lpord;
          if (((uint)pOVar10->wFlags >> 8 & 0xf) == 8) {
            pTVar12 = LpthFromId(pOVar10->id);
            iVar9 = (int)((ulong)pTVar12 >> 0x10);
            pTVar5 = (THING *)pTVar12;
            if (((pTVar5 == (THING *)0x0) && (iVar9 == 0)) ||
               ((((uint)pTVar12->idFull >> 0xd == 2 &&
                 ((1 << ((byte)pFVar2->iPlayer & 0x1f) & *(uint *)(pTVar5->rgb + 2)) == 0)) &&
                (((&pTVar5->pt)->x != (lpord->pt).x || ((pTVar5->pt).y != (pOVar10->pt).y)))))) {
              if ((pTVar5 != (THING *)0x0) || (iVar9 != 0)) {
                FSendPlrMsg(pFVar2->iPlayer,idmWormholeHeadingHasVanishedOrdersHaveChanged,
                                 lpfl->id | 0x8000,lpfl->id,0,0,0,0,0,0);
              }
              pOVar10->wFlags = pOVar10->wFlags & 0xf0ffU | 0x400;
              pOVar10->id = iord;
            }
            else {
              sVar8 = (pTVar5->pt).y;
              (lpord->pt).x = (&pTVar5->pt)->x;
              (pOVar10->pt).y = sVar8;
            }
          }
          else if ((((uint)pOVar10->wFlags >> 8 & 0xf) == 2) &&
                  (((uint)pOVar10->wFlags >> 0xd & 1) == 0)) {
            pFVar13 = LpflFromId(pOVar10->id);
            iVar9 = (int)((ulong)pFVar13 >> 0x10);
            pFVar4 = (FLEET *)pFVar13;
            if (((pFVar4 == (FLEET *)0x0) && (iVar9 == 0)) ||
               ((((&pFVar4->pt)->x != (lpord->pt).x || ((pFVar4->pt).y != (pOVar10->pt).y)) ||
                ((((uint)pFVar4->wFlags >> 5 & 1) != 0 && (pFVar4->iPlayer != pFVar2->iPlayer))))))
            {
              lpflTarget = (FLEET *)0x0;
              uVar7 = pOVar10->id & 0xfe00;
              cFound = 0;
              mdTarget_00 = ((BTLPLAN **)rglpbtlplan)[pFVar2->iPlayer * 2][pFVar2->iplan].
                            wFlags & 0xf;
              lVar6 = 0;
              lpflMatch._0_2_ = (FLEET *)0x0;
              lpflMatch._2_2_ = 0;
              for (ifl2 = 0; ifl2 < cFleet; ifl2 = ifl2 + 1) {
                    /* WARNING: Load size is inaccurate */
                pFVar4 = ((FLEET **)rglpfl)[ifl2];
                iVar9 = *(int *)((int)((FLEET **)rglpfl + ifl2) + 2);
                lpfl2 = (FLEET *)CONCAT22(iVar9,pFVar4);
                if ((pFVar4 == (FLEET *)0x0) && (iVar9 == 0)) break;
                if ((((&pFVar4->pt)->x == (lpord->pt).x) &&
                    ((((pFVar4->pt).y == (pOVar10->pt).y && (uVar7 == (lpfl2->id & 0xfe00U))) &&
                     (sVar8 = FMatchTarget((FLEET *)CONCAT22(iVar9,pFVar4),mdTarget_00,1),
                     sVar8 != 0)))) &&
                   ((lVar14 = WtFromLpfl((FLEET *)CONCAT22(iVar9,pFVar4)),
                    ((uint)pFVar4->wFlags >> 6 & 1) == 0 &&
                    ((lVar6 < lVar14 ||
                     ((lVar6 == lVar14 && (sVar8 = Random(2), sVar8 == 0)))))))) {
                  lpflMatch._0_2_ = pFVar4;
                  lpflMatch._2_2_ = iVar9;
                  lVar6 = lVar14;
                }
              }
              if (((FLEET *)lpflMatch == (FLEET *)0x0) && (lpflMatch._2_2_ == 0)) {
                for (ifl2 = 0; ifl2 < cFleet; ifl2 = ifl2 + 1) {
                    /* WARNING: Load size is inaccurate */
                  pFVar4 = ((FLEET **)rglpfl)[ifl2];
                  iVar9 = *(int *)((int)((FLEET **)rglpfl + ifl2) + 2);
                  lpfl2 = (FLEET *)CONCAT22(iVar9,pFVar4);
                  if ((pFVar4 == (FLEET *)0x0) && (iVar9 == 0)) break;
                  if (((&pFVar4->pt)->x == (lpord->pt).x) &&
                     (((pFVar4->pt).y == (pOVar10->pt).y && (uVar7 == (lpfl2->id & 0xfe00U))))) {
                    sVar8 = FMatchTarget((FLEET *)CONCAT22(iVar9,pFVar4),mdTarget_00,1);
                    if ((sVar8 != 0) &&
                       ((lVar14 = WtFromLpfl((FLEET *)CONCAT22(iVar9,pFVar4)), lVar6 < lVar14 ||
                        ((lVar6 == lVar14 && (sVar8 = Random(2), sVar8 == 0)))))) {
                      lpflMatch._0_2_ = pFVar4;
                      lpflMatch._2_2_ = iVar9;
                      lVar6 = lVar14;
                    }
                    cFound = cFound + 1;
                    sVar8 = Random(cFound);
                    if ((sVar8 == 0) &&
                       (((cFound == 1 || (((uint)pFVar4->wFlags >> 6 & 1) == 0)) ||
                        (sVar8 = Random(2), sVar8 != 0)))) {
                      lpflTarget = (FLEET *)CONCAT22(iVar9,pFVar4);
                    }
                  }
                }
              }
              if (((FLEET *)lpflMatch != (FLEET *)0x0) || (lpflMatch._2_2_ != 0)) {
                lpflTarget = (FLEET *)CONCAT22(lpflMatch._2_2_,(FLEET *)lpflMatch);
              }
              if (((FLEET *)lpflTarget != (FLEET *)0x0) || (lpflTarget._2_2_ != 0)) {
                pOVar10->id = lpflTarget->id;
                sVar8 = (((FLEET *)lpflTarget)->pt).y;
                (lpord->pt).x = (&((FLEET *)lpflTarget)->pt)->x;
                (pOVar10->pt).y = sVar8;
                ((FLEET *)lpflTarget)->wFlags = ((FLEET *)lpflTarget)->wFlags & 0xffbfU | 0x40;
              }
            }
            else if ((pFVar4 != (FLEET *)0x0) || (iVar9 != 0)) {
              pFVar4->wFlags = pFVar4->wFlags & 0xffbfU | 0x40;
            }
          }
          lpord = (ORDER *)CONCAT22(uVar11,pOVar10 + 1);
        }
      }
    }
    ifl = ifl + 1;
  } while( true );
}



// ======================================================================
// Function: ChgPopFromPlanet
// Address: 1038:7082
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10387497) */
/* WARNING: Removing unreachable block (ram,0x103873eb) */
/* WARNING: Removing unreachable block (ram,0x103872a9) */
/* WARNING: Removing unreachable block (ram,0x103872ea) */
/* WARNING: Removing unreachable block (ram,0x1038730b) */
/* WARNING: Removing unreachable block (ram,0x10387136) */

long ChgPopFromPlanet(PLANET *lppl,short fUpdate)

{
  uint *puVar1;
  int *piVar2;
  undefined2 uVar3;
  undefined2 uVar4;
  uint uVar5;
  short sVar6;
  short sVar7;
  int iVar8;
  int iVar9;
  PLANET *pPVar10;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar11;
  long lVar12;
  long lVar13;
  ulong uVar14;
  ulong uVar15;
  long lVar16;
  long lVar17;
  undefined2 uVar18;
  undefined2 uVar19;
  undefined2 uVar20;
  undefined2 uVar21;
  ushort in_stack_0000ffce;
  long pctFull;
  long pctRetard;
  long lPopOld;
  long lPopInc;
  long lPopInc100;
  short pctDesire;
  long pctGrow100;
  short DeltaCur;
  long lPopIncDelta;
  short fPopDied;
  long lMaxPop;
  
  lVar17 = CONCAT22(unaff_SI,unaff_DI);
  uVar11 = (undefined2)((ulong)lppl >> 0x10);
  pPVar10 = (PLANET *)lppl;
  if ((pPVar10->iPlayer == -1) ||
     (((int)pPVar10->rgwtMin[3] == 0 && (*(int *)((int)pPVar10->rgwtMin + 0xe) == 0)))) {
    lPopInc._0_2_ = 0;
    lPopInc._2_2_ = 0;
  }
  else {
    sVar6 = PctPlanetDesirability(lppl,pPVar10->iPlayer);
    uVar3 = (undefined2)pPVar10->rgwtMin[3];
    uVar4 = *(undefined2 *)((int)pPVar10->rgwtMin + 0xe);
    lVar16 = CONCAT22(uVar4,uVar3);
    if (sVar6 < 0) {
      uVar21 = 0;
      uVar19 = 10;
      uVar15 = __aFulmul(CONCAT22(uVar4,uVar3),(long)-sVar6);
      lVar16 = __aFldiv(uVar15,CONCAT22(uVar21,uVar19));
      if (lVar16 < 1) {
        lVar16 = 1;
      }
      else {
        uVar21 = 0;
        uVar19 = 10;
        uVar15 = __aFulmul(CONCAT22(uVar4,uVar3),(long)-sVar6);
        lVar16 = __aFldiv(uVar15,CONCAT22(uVar21,uVar19));
      }
      lVar12 = __aFldiv(lVar16,100);
      lVar16 = __aFlrem(lVar16,100);
      if ((lVar12 == 0) && (lVar16 == 0)) {
        lVar16 = 1;
      }
      lPopIncDelta._0_2_ = (int)lVar16;
      if ((int)((*(uint *)&pPVar10->dwFlags & 0xff) - (int)lPopIncDelta) < 0) {
        lVar12 = lVar12 + 1;
      }
      lPopInc._2_2_ = (int)((ulong)lVar12 >> 0x10);
      lPopInc._0_2_ = (uint)lVar12;
      lVar16 = CONCAT22(-(lPopInc._2_2_ + (uint)((uint)lPopInc != 0)),-(uint)lPopInc);
    }
    else {
      lVar12 = CalcPlanetMaxPop(lppl->id,pPVar10->iPlayer);
      sVar7 = PctTrueMaxGrowth(pPVar10->iPlayer);
      uVar15 = (ulong)(sVar7 * sVar6);
      if ((((uint)gd._0_2_ >> 1 & 1) != 0) &&
         (uVar15 = (long)(sVar7 * sVar6),
         (*(uint *)((int)&rgplr[0].wFlags + pPVar10->iPlayer * 0xc0) >> 2 & 1) != 0)) {
        uVar15 = __aFlshr(lVar17,in_stack_0000ffce);
      }
      lVar13 = __aFldiv(lVar12,4);
      if (lVar13 < lVar16) {
        lVar13 = lVar12;
        uVar14 = __aFulmul(CONCAT22(uVar4,uVar3),1000);
        lVar13 = __aFldiv(uVar14,lVar13);
        if (lVar16 < lVar12) {
          iVar8 = 1000 - (uint)lVar13;
          iVar9 = -(uint)(1000 < (uint)lVar13) - (int)((ulong)lVar13 >> 0x10);
          uVar14 = __aFulmul(CONCAT22(iVar9,iVar8),CONCAT22(iVar9,iVar8));
          if ((long)uVar15 < 1000) {
            uVar21 = 8;
            uVar19 = 0x9544;
            uVar15 = __aFulmul(uVar15,uVar14);
            uVar15 = __aFldiv(uVar15,CONCAT22(uVar21,uVar19));
          }
          else {
            uVar20 = 0;
            uVar18 = 10;
            uVar21 = 8;
            uVar19 = 0x9544;
            uVar15 = __aFldiv(uVar15,10);
            uVar15 = __aFulmul(uVar15,uVar14);
            uVar15 = __aFldiv(uVar15,CONCAT22(uVar21,uVar19));
            uVar15 = __aFulmul(uVar15,CONCAT22(uVar20,uVar18));
          }
        }
        else {
          if (lVar16 < lVar12 + 10) {
            lPopInc._0_2_ = 0;
            lPopInc._2_2_ = 0;
            goto LAB_1038_75db;
          }
          lVar16 = __aFldiv(lVar13,10);
          iVar8 = -(uint)(99 < (uint)lVar16) - (int)((ulong)lVar16 >> 0x10);
          if ((-1 < iVar8) || ((-2 < iVar8 && (0xfed3 < 99 - (uint)lVar16)))) {
            lVar16 = __aFldiv(lVar13,10);
            in_stack_0000ffce = (ushort)lVar16;
          }
          uVar15 = __aFlshl(lVar17,in_stack_0000ffce);
        }
      }
      uVar14 = __aFldiv(uVar15,100);
      uVar14 = __aFulmul(CONCAT22(uVar4,uVar3),uVar14);
      if ((long)uVar14 < 10000000) {
        uVar21 = 0;
        uVar19 = 100;
        uVar15 = __aFulmul(CONCAT22(uVar4,uVar3),uVar15);
        uVar14 = __aFldiv(uVar15,CONCAT22(uVar21,uVar19));
      }
      lVar16 = __aFldiv(uVar14,100);
      lVar12 = __aFlrem(uVar14,100);
      lPopInc._2_2_ = (int)((ulong)lVar16 >> 0x10);
      lPopInc._0_2_ = (uint)lVar16;
      if ((lVar16 == 0) && (lVar12 == 0)) {
        lVar12 = 1;
      }
      lPopIncDelta._0_2_ = (int)lVar12;
      iVar8 = (*(uint *)&pPVar10->dwFlags & 0xff) + (int)lPopIncDelta;
      if (iVar8 < 100) {
        if (iVar8 < 0) {
          lVar16 = CONCAT22(lPopInc._2_2_ - (uint)((uint)lPopInc == 0),(uint)lPopInc + -1);
        }
      }
      else {
        lVar16 = lVar16 + 1;
      }
    }
    lPopInc._0_2_ = (uint)lVar16;
    lPopInc._2_2_ = (int)((ulong)lVar16 >> 0x10);
    if (fUpdate != 0) {
      lVar17 = __aFlshl(lVar17,in_stack_0000ffce);
      uVar5 = *(uint *)((int)&pPVar10->dwFlags + 2);
      *(uint *)&pPVar10->dwFlags = *(uint *)&pPVar10->dwFlags & 0xff00 | (uint)lVar17;
      *(uint *)((int)&pPVar10->dwFlags + 2) = uVar5 | (uint)((ulong)lVar17 >> 0x10);
      puVar1 = (uint *)(pPVar10->rgwtMin + 3);
      uVar5 = *puVar1;
      *puVar1 = *puVar1 + (uint)lPopInc;
      piVar2 = (int *)((int)pPVar10->rgwtMin + 0xe);
      *piVar2 = *piVar2 + lPopInc._2_2_ + (uint)CARRY2(uVar5,(uint)lPopInc);
    }
  }
LAB_1038_75db:
  return CONCAT22(lPopInc._2_2_,(uint)lPopInc);
}



// ======================================================================
// Function: FCanFleetUseStargates
// Address: 1038:75e2
// Segment: MEMORY_UTIL
// ======================================================================


/* WARNING: Variable defined which should be unmapped: scan */

short FCanFleetUseStargates(FLEET *lpfl,POINT ptSrc,POINT ptDst)

{
  PLANET *pPVar1;
  bool bVar2;
  bool bVar3;
  short sVar4;
  int iVar5;
  FLEET *pFVar6;
  int iVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar8;
  long lVar9;
  undefined2 local_32;
  SCAN scan;
  short isbsSrc;
  short ishdef;
  short fCargo;
  short isbsDst;
  PLANET *lpplSrc;
  short fDanger;
  short i;
  short fUncertain;
  short fSrcPlanet;
  short pctDmg;
  PLANET *lpplDst;
  short dTravel;
  
  bVar2 = false;
  sVar4 = FFindNearestObject(ptDst,0x81,&scan);
  if (sVar4 == 0) {
    return 0;
  }
  lpplDst = LpplFromId(scan.idpl);
  iVar7 = (int)((ulong)lpplDst >> 0x10);
  pPVar1 = (PLANET *)lpplDst;
  pFVar6 = (FLEET *)lpfl;
  uVar8 = (undefined2)((ulong)lpfl >> 0x10);
  if (((pPVar1 == (PLANET *)0x0) && (iVar7 == 0)) || (pFVar6->iPlayer != pPVar1->iPlayer)) {
    if (((pPVar1 != (PLANET *)0x0) || (iVar7 != 0)) &&
       ((pPVar1->iPlayer == -1 && (pPVar1->turn == game.turn)))) {
      return 0;
    }
    bVar2 = true;
  }
  else {
    isbsDst = IStargateFromLppl(lpplDst);
    if (isbsDst < 0) {
      return 0;
    }
  }
  lpplSrc = (PLANET *)0x0;
  bVar3 = false;
  sVar4 = FFindNearestObject(ptSrc,0x81,&scan);
  if (sVar4 != 0) {
    bVar3 = true;
    lpplSrc = LpplFromId(scan.idpl);
    iVar7 = (int)((ulong)lpplSrc >> 0x10);
    if ((((PLANET *)lpplSrc != (PLANET *)0x0) || (iVar7 != 0)) &&
       ((pFVar6->iPlayer == ((PLANET *)lpplSrc)->iPlayer &&
        (isbsSrc = IStargateFromLppl(lpplSrc), -1 < isbsSrc)))) {
      if (bVar2) {
        return -1;
      }
      goto LAB_1038_77e5;
    }
  }
  sVar4 = FFleetCanJumpgate(lpfl);
  if (sVar4 == 0) {
    if (bVar3) {
      if (((((PLANET *)lpplSrc == (PLANET *)0x0) && (lpplSrc._2_2_ == 0)) ||
          (((PLANET *)lpplSrc)->iPlayer != -1)) || (((PLANET *)lpplSrc)->turn != game.turn))
      {
        if ((((PLANET *)lpplSrc != (PLANET *)0x0) || (lpplSrc._2_2_ != 0)) &&
           (((PLANET *)lpplSrc)->iPlayer == pFVar6->iPlayer)) {
          return 0;
        }
        return -1;
      }
    }
    return 0;
  }
  if (bVar2) {
    return -1;
  }
  isbsSrc = isbsDst;
LAB_1038_77e5:
  bVar2 = false;
  sVar4 = GetRaceStat((PLAYER *)rgplr + pFVar6->iPlayer,rsMajorAdv);
  if (sVar4 != 7) {
    for (i = 0; i < 4; i = i + 1) {
      iVar7 = *(int *)((int)(pFVar6->rgwtMin + i) + 2);
      if ((-1 < iVar7) && ((0 < iVar7 || ((int)pFVar6->rgwtMin[i] != 0)))) {
        bVar2 = true;
      }
    }
  }
  DGetDistance(ptSrc.x,ptSrc.y,ptDst.x,ptDst.y);
  lVar9 = __ftol((double)CONCAT26(scan.pt.x,CONCAT24(local_32,CONCAT22(unaff_SI,unaff_DI))))
  ;
  dTravel = (short)lVar9;
  bVar3 = false;
  ishdef = 0;
  do {
    if (0xf < ishdef) {
      if (bVar3) {
        iVar7 = 2;
      }
      else {
        iVar7 = 0;
      }
      if (bVar2) {
        iVar5 = 4;
      }
      else {
        iVar5 = 0;
      }
      return iVar7 + 1 + iVar5;
    }
    if (pFVar6->rgcsh[ishdef] != 0) {
      iVar7 = pFVar6->iPlayer * 4;
      sVar4 = MdCalcStargateDamage
                        (isbsSrc,isbsDst,dTravel,
                         *(short *)(*(int *)(iVar7 + 0xfe) + ishdef * 0x93 + 0x28),&pctDmg);
      if (((sVar4 == -2) || (sVar4 == -1)) || (sVar4 == 0)) {
        return 0;
      }
      if ((sVar4 == 1) && (0 < pctDmg)) {
        bVar3 = true;
      }
    }
    ishdef = ishdef + 1;
  } while( true );
}



// ======================================================================
// Function: FFleetCanJumpgate
// Address: 1038:7960
// Segment: MEMORY_UTIL
// ======================================================================


short FFleetCanJumpgate(FLEET *lpfl)

{
  uint uVar1;
  int iVar2;
  HS *pHVar3;
  undefined2 uVar4;
  short j;
  short i;
  short chs;
  HS *lphs;
  
  i = 0;
  do {
    if (0xf < i) {
      return 1;
    }
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      iVar2 = ((FLEET *)lpfl)->iPlayer * 4;
      lphs = (HS *)CONCAT22(*(undefined2 *)(iVar2 + 0x100),
                            (HS *)(*(int *)(iVar2 + 0xfe) + i * 0x93 + 0x3a));
      iVar2 = ((FLEET *)lpfl)->iPlayer * 4;
      uVar1 = (uint)*(byte *)(*(int *)(iVar2 + 0xfe) + i * 0x93 + 0x7a);
      for (j = 0; j < (int)uVar1; j = j + 1) {
        uVar4 = (undefined2)((ulong)lphs >> 0x10);
        pHVar3 = (HS *)lphs;
        if ((((uint)pHVar3->wFlags >> 8 != 0) && (lphs->grhst == hstSpecialM)) &&
           ((pHVar3->wFlags & 0xffU) == 9)) break;
        lphs = (HS *)CONCAT22(uVar4,pHVar3 + 1);
      }
      if (j == uVar1) {
        return 0;
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: WtFromLpfl
// Address: 1038:7a68
// Segment: MEMORY_UTIL
// ======================================================================


long WtFromLpfl(FLEET *lpfl)

{
  long lVar1;
  int iVar2;
  ulong uVar3;
  short i;
  long cMass;
  
  lVar1 = 0;
  i = 0;
  while( true ) {
    if (0xf < i) break;
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      iVar2 = ((FLEET *)lpfl)->iPlayer * 4;
      uVar3 = __aFulmul((long)((FLEET *)lpfl)->rgcsh[i],
                                (ulong)*(uint *)(*(int *)(iVar2 + 0xfe) + i * 0x93 + 0x28));
      lVar1 = uVar3 + lVar1;
    }
    i = i + 1;
  }
  for (i = 0; i < 4; i = i + 1) {
    lVar1 = lVar1 + CONCAT22(*(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2),
                             (int)((FLEET *)lpfl)->rgwtMin[i]);
  }
  return lVar1;
}



// ======================================================================
// Function: FCanBuildShdef
// Address: 1038:7b40
// Segment: MEMORY_UTIL
// ======================================================================


short FCanBuildShdef(SHDEF *lpshdef,short iplr)

{
  short sVar1;
  short sVar2;
  SHDEF *pSVar3;
  HS *pHVar4;
  undefined2 uVar5;
  PART part;
  short iplrSav;
  short j;
  
  sVar1 = idPlayer;
  if ((int)(lpshdef->hul).ihuldef < 0x20) {
    part.hs.grhst = hstHull;
    part.hs.wFlags = part.hs.wFlags & 0xff00 | (lpshdef->hul).ihuldef & 0xff;
  }
  else {
    part.hs.grhst = hstSBHull;
    part.hs.wFlags = part.hs.wFlags & 0xff00U | (lpshdef->hul).ihuldef - ihuldefCount & 0xff;
  }
  idPlayer = iplr;
  sVar2 = FLookupPart(&part);
  if (sVar2 == 1) {
    j = 0;
    while( true ) {
      uVar5 = (undefined2)((ulong)lpshdef >> 0x10);
      pSVar3 = (SHDEF *)lpshdef;
      if ((int)(uint)(pSVar3->hul).chs <= j) break;
      if ((uint)(pSVar3->hul).rghs[j].wFlags >> 8 != 0) {
        pHVar4 = (pSVar3->hul).rghs + j;
        part.hs.grhst = pHVar4->grhst;
        part.hs.wFlags = pHVar4->wFlags;
        sVar2 = FLookupPart(&part);
        if (sVar2 != 1) goto UTIL_LFail;
      }
      j = j + 1;
    }
    sVar2 = 1;
  }
  else {
UTIL_LFail:
    sVar2 = 0;
  }
  idPlayer = sVar1;
  return sVar2;
}



// ======================================================================
// Function: IshFindSimilarDesign
// Address: 1038:7c5e
// Segment: MEMORY_UTIL
// ======================================================================


short IshFindSimilarDesign(HUL *lphul,short iPlrDst)

{
  SHDEF *pSVar1;
  HUL *pHVar2;
  undefined2 uVar3;
  undefined2 uVar4;
  short j;
  short i;
  SHDEF *lpshdefDest;
  
  lpshdefDest = (SHDEF *)CONCAT22(*(undefined2 *)(iPlrDst * 4 + 0x100),
                                  (SHDEF *)*(undefined2 *)(iPlrDst * 4 + 0xfe));
  i = 0;
  do {
    if (0xf < i) {
      return -1;
    }
    uVar3 = (undefined2)((ulong)lpshdefDest >> 0x10);
    pSVar1 = (SHDEF *)lpshdefDest;
    if (((((uint)pSVar1->wFlags >> 9 & 1) == 0) && (pSVar1->wFlags < 0)) &&
       ((lpshdefDest->hul).ihuldef == lphul->ihuldef)) {
      uVar4 = (undefined2)((ulong)lphul >> 0x10);
      pHVar2 = (HUL *)lphul;
      if ((pSVar1->hul).chs == pHVar2->chs) {
        j = 0;
        while (((j < (int)(uint)pHVar2->chs &&
                ((uint)pHVar2->rghs[j].wFlags >> 8 == (uint)(pSVar1->hul).rghs[j].wFlags >> 8)) &&
               (((uint)pHVar2->rghs[j].wFlags >> 8 == 0 ||
                (((pHVar2->rghs[j].wFlags & 0xffU) == ((pSVar1->hul).rghs[j].wFlags & 0xffU) &&
                 ((pHVar2->rghs + j)->grhst == ((pSVar1->hul).rghs + j)->grhst))))))) {
          j = j + 1;
        }
        if (j == (uint)pHVar2->chs) {
          return i;
        }
      }
    }
    i = i + 1;
    lpshdefDest = (SHDEF *)CONCAT22(uVar3,pSVar1 + 1);
  } while( true );
}



// ======================================================================
// Function: DrawPlanetPrintDot
// Address: 1038:7e44
// Segment: MEMORY_UTIL
// ======================================================================


void DrawPlanetPrintDot(HDC hdc,short x,short y,short iSize)

{
  if (iSize == 0) {
    PatBlt(hdc,x + -3,y + -1,7,3,0x42);
    PatBlt(hdc,x + -1,y + -3,3,7,0x42);
    PatBlt(hdc,x + -2,y + -2,5,5,0x42);
  }
  else {
    PatBlt(hdc,x + -5,y + -2,0xb,5,0x42);
    PatBlt(hdc,x + -2,y + -5,5,0xb,0x42);
    PatBlt(hdc,x + -4,y + -3,9,7,0x42);
    PatBlt(hdc,x + -3,y + -4,7,9,0x42);
  }
  return;
}



// ======================================================================
// Function: ClearFile
// Address: 1038:7f6a
// Segment: MEMORY_UTIL
// ======================================================================


void ClearFile(short dt)

{
  char *pcVar1;
  char szFile [256];
  char *pch;
  
  _strcpy(szFile,(char *)szBase);
  pcVar1 = _strrchr(szFile,0x2e);
  if (pcVar1 == (char *)0x0) {
    _strcat(szFile,(char *)0x562);
  }
  else {
    pcVar1[1] = '\0';
  }
  _strcat(szFile,(char *)*(undefined2 *)(dt * 2 + 0x552));
  _remove(szFile);
  return;
}



// ======================================================================
// Function: OutputSz
// Address: 1038:7fe6
// Segment: MEMORY_UTIL
// ======================================================================


void OutputSz(short dt,char *sz)

{
  short sVar1;
  char *pcVar2;
  char *unaff_SS;
  char szTemp [256];
  char szDate [100];
  char szFile [256];
  char szTime [100];
  
  _WSPRINTF((LPSTR)0x56a21120,(LPCSTR)CONCAT22(0x564,unaff_SS),szFile);
  sVar1 = __access(szFile,0);
  if (sVar1 == -1) {
    pcVar2 = SzVersion();
    _WSPRINTF((LPSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(LPCSTR)CONCAT22(0x56a,unaff_SS),szTemp
             );
    OutputFileString(szFile,szTemp);
  }
  __strdate(szDate);
  __strtime(szTime);
  _WSPRINTF((LPSTR)CONCAT22(szDate,(char *)&DAT_1120_1120),(LPCSTR)CONCAT22(0x578,unaff_SS),szTemp);
  OutputFileString(szFile,szTemp);
  return;
}



// ======================================================================
// Function: TurnLog
// Address: 1038:80c2
// Segment: MEMORY_UTIL
// ======================================================================


void TurnLog(StringId ids)

{
  int iVar1;
  char *pcVar2;
  char *unaff_SS;
  char szTemp [256];
  
  if (ini.wFlags < 0) {
    iVar1 = game.turn + 0x961;
    pcVar2 = PszFormatIds(ids,(short *)0x0);
    _WSPRINTF((LPSTR)CONCAT22(iVar1,(char *)&DAT_1120_1120),(LPCSTR)CONCAT22(pcVar2,unaff_SS),szTemp
             );
    OutputSz(6,(char *)CONCAT22(unaff_SS,szTemp));
  }
  return;
}



