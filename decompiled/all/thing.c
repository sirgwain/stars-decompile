// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: LpthNew
// Address: 1110:0000
// Segment: MEMORY_THING
// ======================================================================


THING * LpthNew(short iplr,ThingType ith)

{
  undefined2 unaff_SS;
  THING *pTVar1;
  uint thNew [9];
  THING *lpth;
  short i;
  short iItem;
  
                    /* Segment:    35
                       Offset:     000f8f00
                       Length:     1b9f
                       Min Alloc:  1b9f
                       Flags:      1d50
                           Code
                           Discardable
                           Moveable
                           Preload
                           Impure (Non-shareable)
                        */
  if (cThing < 0xfd2) {
    _memset(thNew,0,0x12);
    thNew[0] = thNew[0] & 0x1ff | (iplr & 0xfU) << 9 | ith << 0xd;
    i = 0;
    lpth = lpThings;
    while ((i < cThing && (lpth->idFull < thNew[0]))) {
      i = i + 1;
      lpth = (THING *)lpth + 1;
    }
    if ((i < cThing) && (thNew[0] == lpth->idFull)) {
      iItem = lpth->idFull & 0x1ff;
      for (; i < cThing; i = i + 1) {
        if (0x1fe < iItem) {
          lpth._0_2_ = (THING *)0x0;
          lpth._2_2_ = 0;
          pTVar1 = lpThings;
          goto LAB_1110_021d;
        }
        if (lpth->idFull != thNew[0]) break;
        thNew[0] = thNew[0] & 0xfe00 | thNew[0] + 1 & 0x1ff;
        lpth = (THING *)lpth + 1;
        iItem = iItem + 1;
      }
    }
    if (cThingAlloc <= cThing) {
      cThingAlloc = cThingAlloc + 10;
      if (lpThings == (THING *)0x0) {
        pTVar1 = LpAlloc(cThingAlloc * 0x12,htThings);
      }
      else {
        pTVar1 = LpReAlloc(lpThings,cThingAlloc * 0x12,htThings);
      }
      lpThings._2_2_ = (undefined2)((ulong)pTVar1 >> 0x10);
      lpThings._0_2_ = (THING *)pTVar1;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings + i);
      lpThings = pTVar1;
    }
    if (i < cThing) {
      __fmemmove((THING *)lpth + 1,lpth,(cThing - i) * 0x12);
    }
    cThing = cThing + 1;
    __fmemcpy(lpth,thNew,0x12);
    pTVar1 = lpThings;
  }
  else {
    lpth._0_2_ = (THING *)0x0;
    lpth._2_2_ = 0;
    pTVar1 = lpThings;
  }
LAB_1110_021d:
  lpThings._2_2_ = (undefined2)((ulong)pTVar1 >> 0x10);
  lpThings._0_2_ = (THING *)pTVar1;
  return (THING *)CONCAT22(lpth._2_2_,(THING *)lpth);
}



// ======================================================================
// Function: FreeLpth
// Address: 1110:0224
// Segment: MEMORY_THING
// ======================================================================


void FreeLpth(THING *lpth)

{
  if ((THING *)lpth < (THING *)lpThings + cThing + -1) {
    __fmemmove(lpth,(THING *)lpth + 1,
                       ((cThing - ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12
                        ) + -1) * 0x12);
  }
  cThing = cThing + -1;
  return;
}



// ======================================================================
// Function: CPlanetsInCircle
// Address: 1110:02a0
// Segment: MEMORY_THING
// ======================================================================


/* WARNING: Variable defined which should be unmapped: cPl */
/* WARNING: Variable defined which should be unmapped: xEnd */

short CPlanetsInCircle(POINT pt,long r2)

{
  int iVar1;
  int iVar2;
  POINT *pPVar3;
  int iVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar5;
  ulong uVar6;
  ulong uVar7;
  short xEnd;
  short dx;
  short cPl;
  short r;
  short i;
  short yStart;
  POINT *pptEnd;
  short dy;
  short yEnd;
  POINT *ppt;
  short xStart;
  
  _sqrt(SUB84((double)r2,0),
                (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)r2 >> 0x20))));
  lVar5 = __ftol((double)CONCAT26(yStart,CONCAT24(i,CONCAT22(r,cPl))));
  iVar1 = (int)lVar5;
  cPl = 0;
  pPVar3 = (POINT *)rgptPlan + game.cPlanMax;
  _xEnd = (ulong)(((POINT *)rgptPlan + game.cPlanMax + -1)->x -
                 rgptPlan[0].x);
  uVar6 = __aFulmul((long)(pt.x - rgptPlan[0].x),(long)game.cPlanMax);
  lVar5 = __aFldiv(uVar6,_xEnd);
  i = (short)lVar5;
  if (game.cPlanMax <= i) {
    i = game.cPlanMax + -1;
  }
  if (i < 0) {
    i = 0;
  }
  for (ppt = (POINT *)rgptPlan + i;
      (pt.x - iVar1 <= ppt->x && ((POINT *)((int)&rgptPlan[0].x + 1U) <= ppt));
      ppt = ppt + -1) {
  }
  for (; (ppt->x <= xEnd && (ppt < pPVar3)); ppt = ppt + 1) {
    if (((pt.x - iVar1 <= ppt->x) && (pt.y - iVar1 <= ppt->y)) && (ppt->y <= pt.y + iVar1)) {
      iVar2 = ppt->y - pt.y;
      iVar4 = iVar2 >> 0xf;
      _xEnd = (ulong)iVar2;
      __aFulmul((long)iVar2,_xEnd);
      _xEnd = CONCAT22(iVar4,iVar4);
      uVar7 = CONCAT22(iVar4,iVar4);
      uVar6 = __aFulmul(uVar7,_xEnd);
      iVar2 = (int)(uVar6 + uVar7 >> 0x10);
      if ((iVar2 <= r2._2_2_) && ((iVar2 < r2._2_2_ || ((uint)(uVar6 + uVar7) <= (uint)r2)))) {
        cPl = cPl + 1;
      }
    }
  }
  return cPl;
}



// ======================================================================
// Function: DrawThingGauge
// Address: 1110:044e
// Segment: MEMORY_THING
// ======================================================================


void DrawThingGauge(HDC hdc,RECT *prc,THING *lpth,short md)

{
  ushort uVar1;
  ulong uVar2;
  short sVar3;
  THING *pTVar4;
  undefined2 uVar5;
  ulong cTot;
  long lVar6;
  DWORD DVar7;
  undefined2 uVar8;
  undefined2 uVar9;
  uint local_2a [9];
  short i;
  short c;
  ushort rghbr [5];
  short fDisabled;
  short cSections;
  short iMode;
  
  fDisabled = 0;
  SelectObject(hdc,rghfontArial8[1]);
  cSections = 1;
  uVar5 = (undefined2)((ulong)lpth >> 0x10);
  pTVar4 = (THING *)lpth;
  cTot = __aFulmul((ulong)*(uint *)((int)&pTVar4->u_THING_0x0006 + 8) & 0xffff3fff,10);
  uVar2 = (ulong)local_2a[0] << 0x10;
  if ((md < 0) || (4 < md)) {
    if (md == 5) {
      for (i = 0; sVar3 = i, i < 3; i = i + 1) {
        rghbr[i] = ((ushort *)rghbrMineral)[i];
        uVar1 = *(ushort *)((pTVar4->u_THING_0x0006).rgb + i * 2 + 2);
        rghbr[i * 2 + -0xc] = uVar1;
        local_2a[sVar3 * 2] = (int)uVar1 >> 0xf;
      }
      cSections = 3;
      uVar2 = (ulong)local_2a[0] << 0x10;
    }
  }
  else if ((md == 4) || (md == 3)) {
    rghbr[0] = hbrButtonShadow;
    fDisabled = 1;
    uVar2 = cTot;
  }
  else {
    rghbr[0] = ((ushort *)rghbrMineral)[md];
    uVar2 = (ulong)*(int *)((pTVar4->u_THING_0x0006).rgb + md * 2 + 2);
  }
  local_2a[0] = (uint)(uVar2 >> 0x10);
  lVar6 = LDrawGauge(hdc,prc,cSections,&stack0xffd4,rghbr,cTot);
  uVar5 = (undefined2)lVar6;
  uVar9 = 0x1040;
  uVar8 = 0x58c;
  iMode = SetBkMode(hdc,1);
  if (fDisabled != 0) {
    uVar5 = 0;
    uVar8 = 0;
  }
  if (cSections == 1) {
    c = _wsprintf(szWork,(char *)0x112016a0,uVar5);
  }
  else {
    c = _wsprintf(szWork,s__ld_of__ldkT_1120_16a6,uVar5,uVar8,uVar9);
  }
  DVar7 = GetTextExtent(hdc,szWork,c);
  if ((int)DVar7 < (prc->right - prc->left) + -3) {
    RcCtrTextOut(hdc,prc,(char *)szWork,c);
  }
  SetBkMode(hdc,iMode);
  return;
}



// ======================================================================
// Function: IValidateWormholePos
// Address: 1110:064c
// Segment: MEMORY_THING
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x11100a9a) */
/* WARNING: Removing unreachable block (ram,0x11100a64) */
/* WARNING: Removing unreachable block (ram,0x11100994) */
/* WARNING: Removing unreachable block (ram,0x1110095e) */
/* WARNING: Removing unreachable block (ram,0x1110091a) */
/* WARNING: Removing unreachable block (ram,0x111008e4) */
/* WARNING: Removing unreachable block (ram,0x111008fc) */
/* WARNING: Removing unreachable block (ram,0x11100938) */
/* WARNING: Removing unreachable block (ram,0x11100976) */
/* WARNING: Removing unreachable block (ram,0x111009b2) */
/* WARNING: Removing unreachable block (ram,0x11100a7c) */
/* WARNING: Removing unreachable block (ram,0x11100ab8) */

short IValidateWormholePos(THING *lpthWorm)

{
  int iVar1;
  int iVar2;
  int iVar3;
  long lVar4;
  int iVar5;
  int iVar6;
  THING *pTVar7;
  THING *pTVar8;
  undefined2 uVar9;
  undefined2 uVar10;
  ulong uVar11;
  ulong uVar12;
  short dUni;
  THING *lpth;
  short i;
  short ifl;
  FLEET *lpfl;
  short iRet;
  
  iRet = 0;
  iVar5 = game.mdSize * 400;
  uVar9 = (undefined2)((ulong)lpthWorm >> 0x10);
  pTVar8 = (THING *)lpthWorm;
  iVar1 = (&pTVar8->pt)->x;
  iVar2 = (pTVar8->pt).y;
  if ((iVar1 < 1000) || (iVar2 < 1000)) {
    iRet = 0xf;
  }
  else if ((iVar5 + 0x578 < iVar1) || (iVar5 + 0x578 < iVar2)) {
    iRet = 0xf;
  }
  else {
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < (THING *)lpThings + cThing) {
      uVar10 = (undefined2)((ulong)lpth >> 0x10);
      if (((iVar1 == (&((THING *)lpth)->pt)->x) && (iVar2 == (((THING *)lpth)->pt).y)) &&
         (lpthWorm != lpth)) {
        return 0xf;
      }
      lpth = (THING *)CONCAT22(uVar10,(THING *)lpth + 1);
    }
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      if ((iVar1 == ((POINT *)rgptPlan + i)->x) &&
         (iVar2 == *(int *)((int)&rgptPlan[0].y + i * 4))) {
        return 0xf;
      }
    }
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
      iVar6 = *(int *)((FLEET **)rglpfl + ifl);
      iVar3 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      if ((iVar6 == 0) && (iVar3 == 0)) break;
      if ((iVar1 == *(int *)(iVar6 + 8)) && (iVar2 == *(int *)(iVar6 + 10))) {
        return 0xf;
      }
    }
    if ((((iVar1 < 0x3f2) || (iVar2 < 0x3f2)) || (iVar5 + 0x56e < iVar1)) || (iVar5 + 0x56e < iVar2)
       ) {
      iRet = 4;
    }
    pTVar7 = (THING *)lpThings + cThing;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < pTVar7) {
      uVar10 = (undefined2)((ulong)lpth >> 0x10);
      if ((lpth->idFull >> 0xd == 2) && (lpthWorm != lpth)) {
        iVar5 = iVar1 - (&((THING *)lpth)->pt)->x;
        iVar6 = iVar2 - (((THING *)lpth)->pt).y;
        uVar11 = __aFulmul((long)iVar6,(long)iVar6);
        uVar12 = __aFulmul((long)iVar5,(long)iVar5);
        lVar4 = uVar12 + uVar11;
        if (lpth->idFull == *(ushort *)((int)&pTVar8->u_THING_0x0006 + 6)) {
          if (lVar4 < 0x1324) {
            if (lVar4 < 0x19) {
              iRet = iRet | 8;
            }
            else if (lVar4 < 100) {
              iRet = iRet | 4;
            }
            else if (lVar4 < 900) {
              iRet = iRet | 2;
            }
            else {
              iRet = iRet | 1;
            }
          }
        }
        else if (lVar4 < 900) {
          if (lVar4 < 0x10) {
            iRet = iRet | 8;
          }
          else if (lVar4 < 0x40) {
            iRet = iRet | 4;
          }
          else if (lVar4 < 0xe1) {
            iRet = iRet | 2;
          }
          else {
            iRet = iRet | 1;
          }
        }
      }
      lpth = (THING *)CONCAT22(uVar10,(THING *)lpth + 1);
    }
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      iVar5 = iVar1 - ((POINT *)rgptPlan + i)->x;
      iVar6 = iVar2 - *(int *)((int)&rgptPlan[0].y + i * 4);
      uVar11 = __aFulmul((long)iVar6,(long)iVar6);
      uVar12 = __aFulmul((long)iVar5,(long)iVar5);
      lVar4 = uVar12 + uVar11;
      if (lVar4 < 0x310) {
        if (lVar4 < 0x19) {
          iRet = iRet | 8;
        }
        else if (lVar4 < 100) {
          iRet = iRet | 4;
        }
        else if (lVar4 < 400) {
          iRet = iRet | 2;
        }
        else {
          iRet = iRet | 1;
        }
      }
    }
  }
  return iRet;
}



// ======================================================================
// Function: PctWormholeMoves
// Address: 1110:0adc
// Segment: MEMORY_THING
// ======================================================================


short PctWormholeMoves(THING *lpth)

{
  undefined2 uVar1;
  short pct;
  
  uVar1 = (undefined2)((ulong)lpth >> 0x10);
  pct = (((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 2 & 0x3ff) / 5 -
        (2 - (((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 3));
  if (pct < 0) {
    pct = 0;
  }
  else if (6 < pct) {
    pct = 6;
  }
  return pct;
}



// ======================================================================
// Function: DoThingInteractions
// Address: 1110:0b3a
// Segment: MEMORY_THING
// ======================================================================


/* WARNING: Variable defined which should be unmapped: cGive */
/* WARNING: Variable defined which should be unmapped: lpflNew */
/* WARNING: Removing unreachable block (ram,0x11100ed1) */
/* WARNING: Removing unreachable block (ram,0x11101776) */
/* WARNING: Removing unreachable block (ram,0x11101129) */

void DoThingInteractions(short fPostMove)

{
  ulong *puVar1;
  int *piVar2;
  uint *puVar3;
  char *pcVar4;
  HUL *pHVar5;
  uint uVar6;
  ushort uVar7;
  FLEET *pFVar8;
  short sVar9;
  int iVar10;
  SHDEF *pSVar11;
  undefined2 *puVar12;
  FLEET *pFVar13;
  PLORD *pPVar14;
  HUL *pHVar15;
  SHDEF *pSVar16;
  undefined2 uVar17;
  undefined2 uVar18;
  undefined2 uVar19;
  undefined2 unaff_SS;
  bool bVar20;
  long lVar21;
  SHDEF *pSVar22;
  FLEET *lpfl_00;
  PLANET *pPVar23;
  ulong uVar24;
  PLANET *pPVar25;
  short p4;
  short p5;
  short p6;
  short p7;
  short cGive;
  FLEET *lpflNew;
  SHDEF *lpshdefDest;
  HUL shdef;
  undefined4 local_5a;
  undefined2 lSpent;
  short ish;
  short cTechCur;
  short iLowest;
  PLANET *cTech;
  short iGoto;
  undefined4 l;
  short fMaxTech;
  uint dx;
  int local_42;
  short cPlrTrueMaxTech;
  short idm;
  THING *lpth;
  FLEET *lpfl;
  short ifl;
  short i;
  PLANET *lppl;
  PLANET *lpplMac;
  short local_2a;
  THING *lpthMac;
  short local_26;
  int dy;
  int local_22;
  undefined4 wtNext;
  char rgTech [6];
  short iplrSav;
  int pt;
  int local_12;
  uint wtMin;
  uint local_e;
  short iplr;
  ushort grbitPlrTrader;
  uint wtThreshhold;
  uint local_6;
  
  lpfl_00 = (FLEET *)CONCAT22(lpflNew._2_2_,(FLEET *)lpflNew);
  if (fPostMove != 0) {
    cTech = (THING *)lpThings;
    iGoto = lpThings._2_2_;
    lpthMac = (THING *)lpThings + cThing;
    local_26 = lpThings._2_2_;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < lpthMac) {
      if (lpth->idFull >> 0xd == 3) {
        uVar17 = (undefined2)((ulong)lpth >> 0x10);
        pt = (&((THING *)lpth)->pt)->x;
        local_12 = (((THING *)lpth)->pt).y;
        ifl = 0;
        while( true ) {
          lpflNew._2_2_ = (ushort)((ulong)lpfl_00 >> 0x10);
          lpflNew._0_2_ = (FLEET *)lpfl_00;
          if (cFleet <= ifl) break;
                    /* WARNING: Load size is inaccurate */
          pFVar8 = ((FLEET **)rglpfl)[ifl];
          iVar10 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
          lpfl = (FLEET *)CONCAT22(iVar10,pFVar8);
          if ((pFVar8 == (FLEET *)0x0) && (iVar10 == 0)) break;
          if ((((pFVar8->wFlags_0x4 >> 10 & 1) == 0) && ((&pFVar8->pt)->x == pt)) &&
             ((pFVar8->pt).y == local_12)) {
            wtMin = 0;
            local_e = 0;
            for (i = 0; i < 3; i = i + 1) {
              uVar6 = *(uint *)(pFVar8->rgwtMin + i);
              bVar20 = CARRY2(wtMin,uVar6);
              wtMin = wtMin + uVar6;
              local_e = local_e + *(uint *)((int)(pFVar8->rgwtMin + i) + 2) + (uint)bVar20;
            }
            if (((int)local_e < 1) && (((int)local_e < 0 || (wtMin < 5000)))) {
              if ((pFVar8->wFlags_0x4 >> 0xd & 1) == 0) {
                FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,
                                  idmMysteryTraderHasRefusedGiveCaptainAudience,lpfl->id | 0x8000,
                                  lpfl->id,0);
              }
            }
            else {
              if ((*(uint *)((int)&rgplr[0].wFlags + pFVar8->iPlayer * 0xc0) >> 1 & 1) ==
                  0) {
                cPlrTrueMaxTech = 0x1a;
              }
              else {
                cPlrTrueMaxTech = 10;
              }
              i = 0;
              while ((i < 6 && (cPlrTrueMaxTech <= *(char *)(pFVar8->iPlayer * 0xc0 + 0x59bc + i))))
              {
                i = i + 1;
              }
              fMaxTech = (short)(i == 6);
              grbitPlrTrader =
                   *(ushort *)((int)&rgplr[0].grbitTrader + pFVar8->iPlayer * 0xc0);
              iplr = pFVar8->iPlayer;
              uVar17 = (undefined2)((ulong)lpth >> 0x10);
              if ((1 << ((byte)iplr & 0x1f) & *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 6))
                  == 0) {
                puVar3 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
                *puVar3 = *puVar3 | 1 << ((byte)iplr & 0x1f);
                FRemovePlayerMessage(iplr,idmHasCompletedAssignedOrders,lpfl->id | 0x8000);
                uVar17 = (undefined2)((ulong)lpfl >> 0x10);
                ((FLEET *)lpfl)->wFlags_0x4 = ((FLEET *)lpfl)->wFlags_0x4 & 0xfbff | 0x400;
                uVar17 = (undefined2)((ulong)lpth >> 0x10);
                if ((*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) == 0) ||
                   ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) & grbitPlrTrader) != 0)) {
                  if (fMaxTech == 0) {
                    cTechCur = 0;
                    lVar21 = __aFldiv(CONCAT22((local_e - 1) + (uint)(4999 < wtMin),
                                                       wtMin + 0xec78),0x4b0);
                    pPVar23 = (PLANET *)(lVar21 + 6);
                    i = 0;
                    while( true ) {
                      if (5 < i) break;
                      cTechCur = cTechCur + *(char *)(((FLEET *)lpfl)->iPlayer * 0xc0 + 0x59bc + i);
                      i = i + 1;
                    }
                    if (10 < (long)pPVar23) {
                      pPVar23 = (PLANET *)0xa;
                    }
                    iGoto = (short)((ulong)pPVar23 >> 0x10);
                    cTech = (PLANET *)pPVar23;
                    if (cTechCur < 0x6c) {
                      if (cTechCur < 0x60) {
                        if (cTechCur < 0x54) {
                          if (cTechCur < 0x48) {
                            if (0x3b < cTechCur) {
                              pPVar23 = (PLANET *)
                                        CONCAT22(iGoto - (uint)(cTech == (PLANET *)0x0),
                                                 (PLANET *)((int)&cTech[-1].lpplprod + 3));
                            }
                          }
                          else {
                            pPVar23 = (PLANET *)
                                      CONCAT22(iGoto - (uint)(cTech < (PLANET *)0x2),
                                               (PLANET *)((int)&cTech[-1].lpplprod + 2));
                          }
                        }
                        else {
                          pPVar23 = (PLANET *)
                                    CONCAT22(iGoto - (uint)(cTech < (PLANET *)0x3),
                                             (PLANET *)((int)&cTech[-1].lpplprod + 1));
                        }
                      }
                      else {
                        pPVar23 = (PLANET *)0x2;
                      }
                    }
                    else {
                      pPVar23 = (PLANET *)0x1;
                    }
                    iGoto = (short)((ulong)pPVar23 >> 0x10);
                    cTech = (PLANET *)pPVar23;
                    if ((grbitPlrTrader & 0x1fff) == 0x1fff) {
                      idm = 0x10a;
                    }
                    else {
                      idm = 0x109;
                    }
                    p7 = 0;
                    p6 = 0;
                    p5 = 0;
                    p4 = 0;
                    sVar9 = 0;
                    pPVar25 = cTech;
                    uVar7 = WFromLpfl(lpfl);
                    FSendPlrMsg((uint)lpfl->id >> 9 & 0xf,idm,-1,uVar7,(short)pPVar25,sVar9,p4,
                                     p5,p6,p7);
                    while( true ) {
                      pPVar25 = (PLANET *)((int)&cTech[-1].lpplprod + 3);
                      iVar10 = iGoto - (uint)(cTech == (PLANET *)0x0);
                      if ((cTech == (PLANET *)0x0) &&
                         (bVar20 = iGoto == 0, cTech = pPVar25, iGoto = iVar10, bVar20)) break;
                      cTech = pPVar25;
                      iGoto = iVar10;
                      sVar9 = Random(4);
                      lVar21 = local_5a;
                      if (sVar9 < 3) {
                        iLowest = Random(6);
                        lVar21 = local_5a;
                        if (cPlrTrueMaxTech <= *(char *)(iplr * 0xc0 + 0x59bc + iLowest))
                        goto LAB_1110_1010;
                      }
                      else {
LAB_1110_1010:
                        local_5a._2_2_ = (int)((ulong)lVar21 >> 0x10);
                        local_5a._0_2_ = (undefined2)lVar21;
                        iLowest = 0;
                        i = 1;
                        while( true ) {
                          lVar21 = CONCAT22(local_5a._2_2_,(undefined2)local_5a);
                          if (5 < i) break;
                          local_5a._2_2_ = (int)*(char *)(iplr * 0xc0 + 0x59bc + i);
                          if (local_5a._2_2_ < *(char *)(iplr * 0xc0 + 0x59bc + iLowest)) {
                            iLowest = i;
                          }
                          i = i + 1;
                        }
                        if (cPlrTrueMaxTech <= *(char *)(iplr * 0xc0 + 0x59bc + iLowest)) break;
                      }
                      local_5a = lVar21;
                      _memcpy(rgTech,(void *)((int)rgplr[0].rgTech + iplr * 0xc0),
                                      6);
                      rgTech[iLowest] = rgTech[iLowest] + '\x01';
                      iplrSav = idPlayer;
                      idPlayer = iplr;
                      lVar21 = CostOfDevelopingItem(rgTech);
                      idPlayer = iplrSav;
                      puVar12 = (undefined2 *)(iplr * 0xc0 + 0x59c2 + iLowest * 4);
                      lSpent = *puVar12;
                      ish = puVar12[1];
                      wtNext = lVar21;
                      lVar21 = __aFlshl(CONCAT22((FLEET *)lpflNew,cGive),lpflNew._2_2_);
                      if (0 < wtNext) {
                        lVar21 = lVar21 + wtNext;
                      }
                      ish = (short)((ulong)lVar21 >> 0x10);
                      lSpent = (undefined2)lVar21;
                      puVar12 = (undefined2 *)(iplr * 0xc0 + 0x59c2 + iLowest * 4);
                      *puVar12 = lSpent;
                      puVar12[1] = ish;
                      local_5a = lVar21;
                      UpdateResearchStatus(0);
                    }
                  }
                  else {
                    sVar9 = Random(5);
                    if (sVar9 != 0) goto THING_LGivePart;
                    idm = 0x10e;
                    sVar9 = 0;
                    uVar7 = WFromLpfl(lpfl);
                    FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,idm,-1,uVar7,sVar9);
                  }
                }
                else {
THING_LGivePart:
                  iLowest = 0x19;
                  cTech = (PLANET *)*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 8);
                  if (cTech == (PLANET *)0x0) {
                    sVar9 = Random(0xd);
                    cTech = (PLANET *)(1 << ((byte)sVar9 & 0x1f));
                  }
                  while ((((uint)cTech & grbitPlrTrader) != 0 &&
                         (iVar10 = iLowest + -1, bVar20 = 0 < iLowest, iLowest = iVar10, bVar20))) {
                    sVar9 = Random(0xd);
                    cTech = (PLANET *)(1 << ((byte)sVar9 & 0x1f));
                  }
                  if (iLowest < 1) {
                    cTech = (PLANET *)0x1000;
                  }
                  puVar3 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
                  *puVar3 = *puVar3 | 1 << ((byte)iplr & 0x1f);
                  if (cTech == (PLANET *)0x1000) {
                    if ((*(uint *)((int)&rgplr[0].wMdPlr + iplr * 0xc0) >> 9 & 1) == 0) {
                      cTechCur = Random(4 - (uint)(100 < game.turn));
                      if (0 < cTechCur) {
                        sVar9 = Random(2);
                        cTechCur = sVar9 + 1;
                      }
                      pSVar22 = LpshdefT();
                      uVar17 = (undefined2)((ulong)pSVar22 >> 0x10);
                      pSVar11 = (SHDEF *)pSVar22 + cTechCur + 0x13;
                      pHVar15 = &shdef;
                      for (iVar10 = 0x49; iVar10 != 0; iVar10 = iVar10 + -1) {
                        pHVar5 = pHVar15;
                        pHVar15 = pHVar15->rgTech;
                        pSVar22 = pSVar11;
                        pSVar11 = (pSVar11->hul).rgTech;
                        pHVar5->ihuldef = (pSVar22->hul).ihuldef;
                      }
                      *&pHVar15->ihuldef = (char)(pSVar11->hul).ihuldef;
                      ish = IshFindSimilarDesign(&shdef,iplr);
                      if (ish < 0) {
                        do {
                          ish = ish + 1;
                          if (0xf < ish) break;
                        } while ((*(uint *)(*(int *)(iplr * 4 + 0xfe) + ish * 0x93 + 0x7b) >> 9 & 1)
                                 == 0);
                      }
                      if ((ish < 0x10) &&
                         ((*(uint *)((int)&rgplr[0].wFlags_0x4 +
                                    ((uint)lpfl->id >> 9 & 0xf) * 0xc0) & 0xfff) < 0x200)) {
                        sVar9 = Random(3);
                        if (sVar9 == 0) {
                          cGive = 2;
                        }
                        else {
                          cGive = 1;
                        }
                        if ((100 < game.turn) && ((game.wCrap >> 2 & 1) == 0)) {
                          sVar9 = Random(game.turn / 100 + 1);
                          cGive = cGive + sVar9;
                        }
                        if (5 < cGive) {
                          cGive = 5;
                        }
                        if (0 < cTechCur) {
                          sVar9 = Random(cGive + 1);
                          cGive = cGive + sVar9;
                        }
                        lpfl_00 = LpflNew(iplr,((FLEET *)lpfl)->idPlanet);
                        uVar17 = (undefined2)((ulong)lpfl_00 >> 0x10);
                        pFVar8 = (FLEET *)lpfl_00;
                        if (lpfl_00 != (FLEET *)0x0) {
                          sVar9 = cGive;
                          uVar7 = WFromLpfl(lpfl);
                          FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,
                                            idmHasAbsorbedMysteryTraderReturnHaveGiven3,
                                            lpfl_00->id | 0x8000,uVar7,sVar9);
                          if (lpfl_00->id < lpfl->id) {
                            ifl = ifl + 1;
                          }
                          uVar18 = (undefined2)((ulong)lpfl >> 0x10);
                          pFVar13 = (FLEET *)lpfl;
                          sVar9 = (pFVar13->pt).y;
                          (&pFVar8->pt)->x = (&pFVar13->pt)->x;
                          (pFVar8->pt).y = sVar9;
                          sVar9 = (pFVar13->pt).y;
                          uVar19 = (undefined2)((ulong)pFVar8->lpplord >> 0x10);
                          pPVar14 = (PLORD *)pFVar8->lpplord;
                          (pPVar14 + 1)->wFlags = (&pFVar13->pt)->x;
                          *(short *)&pPVar14[1].iordMax = sVar9;
                          pFVar8->wFlags_0x4 = pFVar8->wFlags_0x4 & 0xdfff | 0x2000;
                          uVar18 = *(undefined2 *)(iplr * 4 + 0x100);
                          pSVar11 = (SHDEF *)(*(int *)(iplr * 4 + 0xfe) + ish * 0x93);
                          if ((pSVar11->wFlags >> 9 & 1) != 0) {
                            pHVar15 = &shdef;
                            pSVar16 = pSVar11;
                            for (iVar10 = 0x49; iVar10 != 0; iVar10 = iVar10 + -1) {
                              pSVar22 = pSVar16;
                              pSVar16 = (pSVar16->hul).rgTech;
                              pHVar5 = pHVar15;
                              pHVar15 = pHVar15->rgTech;
                              (pSVar22->hul).ihuldef = pHVar5->ihuldef;
                            }
                            *&(pSVar16->hul).ihuldef = (char)pHVar15->ihuldef;
                            pSVar11->wFlags = pSVar11->wFlags & 0x83ff | (ish & 0x1fU) << 10;
                            pSVar11->wFlags = pSVar11->wFlags & 0x7fff | 0x8000;
                            *(undefined2 *)&pSVar11->cBuilt = 0;
                            *(undefined2 *)((int)&pSVar11->cBuilt + 2) = 0;
                            *(undefined2 *)&pSVar11->cExist = 0;
                            *(undefined2 *)((int)&pSVar11->cExist + 2) = 0;
                            pcVar4 = (char *)((int)&rgplr[0].cShDef + iplr * 0xc0);
                            *pcVar4 = *pcVar4 + '\x01';
                            idPlayer = (uint)lpfl->id >> 9 & 0xf;
                            UpdateShdefCost((SHDEF *)CONCAT22(uVar18,pSVar11));
                            idPlayer = -1;
                          }
                          puVar1 = &pSVar11->cBuilt;
                          uVar24 = *puVar1;
                          *puVar1 = (uint)*puVar1 + cGive;
                          piVar2 = (int *)((int)&pSVar11->cBuilt + 2);
                          *piVar2 = *piVar2 + (cGive >> 0xf) + (uint)CARRY2((uint)uVar24,cGive);
                          puVar1 = &pSVar11->cExist;
                          uVar24 = *puVar1;
                          *puVar1 = (uint)*puVar1 + cGive;
                          piVar2 = (int *)((int)&pSVar11->cExist + 2);
                          *piVar2 = *piVar2 + (cGive >> 0xf) + (uint)CARRY2((uint)uVar24,cGive);
                          pFVar8->rgcsh[ish] = cGive;
                          lVar21 = LGetFleetStat(lpfl_00,grStatFuel);
                          *(int *)(pFVar8->rgwtMin + 4) = (int)lVar21;
                          *(undefined2 *)((int)pFVar8->rgwtMin + 0x12) =
                               (int)((ulong)lVar21 >> 0x10);
                          goto LAB_1110_0bac;
                        }
                      }
                      sVar9 = 0;
                      uVar7 = WFromLpfl(lpfl);
                      FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,
                                        idmHasAbsorbedMysteryTraderReturnTraderTried,-1,uVar7,sVar9)
                      ;
                    }
                  }
                  else {
                    idm = IdmGiveTraderPart((ushort)cTech,iplr,&iGoto);
                    sVar9 = 0;
                    uVar7 = WFromLpfl(lpfl);
                    FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,idm,iGoto,uVar7,sVar9);
                  }
                }
              }
              else {
                FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,
                                  idmMysteryTraderEyesCaptainSuspiciouslySuggestsHe,
                                  lpfl->id | 0x8000,lpfl->id,0);
              }
            }
          }
LAB_1110_0bac:
          ifl = ifl + 1;
        }
        cTech = (PLANET *)lpPlanets;
        iGoto = lpPlanets._2_2_;
        lpplMac = (PLANET *)lpPlanets + cPlanet;
        lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
        local_2a = iGoto;
        while ((PLANET *)lppl < lpplMac) {
          uVar17 = (undefined2)((ulong)lppl >> 0x10);
          if ((((((PLANET *)lppl)->iPlayer != -1) && ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0))
              && ((*(uint *)((int)&rgplr[0].wMdPlr + ((PLANET *)lppl)->iPlayer * 0xc0) >>
                   9 & 1) != 0)) &&
             ((1 < (*(uint *)((int)&rgplr[0].wMdPlr + ((PLANET *)lppl)->iPlayer * 0xc0) >>
                    10 & 7) &&
              ((1 << ((byte)((PLANET *)lppl)->iPlayer & 0x1f) &
               *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 6)) == 0)))) {
            dx = ((POINT *)rgptPlan + lppl->id)->x - pt;
            local_42 = (int)dx >> 0xf;
            if ((-1 < local_42) && ((0 < local_42 || (100 < dx)))) break;
            dy = *(int *)((int)&rgptPlan[0].y + lppl->id * 4) - local_12;
            local_22 = dy >> 0xf;
            pPVar23 = (PLANET *)__aFulmul((long)dy,(long)dy);
            iGoto = (short)((ulong)pPVar23 >> 0x10);
            cTech = (PLANET *)pPVar23;
            uVar24 = __aFulmul(CONCAT22(local_42,dx),CONCAT22(local_42,dx));
            l = ((PLANET *)CONCAT22(iGoto,cTech))->rgpctMinLevel + (uVar24 - 6);
            if ((long)l < 0x2711) {
              wtNext._0_2_ = 0;
              wtNext._2_2_ = 0;
              i = 0;
              while( true ) {
                if (2 < i) break;
                uVar6 = *(uint *)(((PLANET *)lppl)->rgwtMin + i);
                bVar20 = CARRY2((uint)wtNext,uVar6);
                wtNext._0_2_ = (uint)wtNext + uVar6;
                wtNext._2_2_ = wtNext._2_2_ + *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) +
                               (uint)bVar20;
                i = i + 1;
              }
              iplr = ((PLANET *)lppl)->iPlayer;
              if ((*(uint *)((int)&rgplr[0].wMdPlr + iplr * 0xc0) >> 10 & 7) == 2) {
                wtThreshhold = 0xdac;
              }
              else {
                wtThreshhold = 5000;
              }
              local_6 = 0;
              if ((0 < (int)wtNext._2_2_) ||
                 ((-1 < (int)wtNext._2_2_ && (wtThreshhold <= (uint)wtNext)))) {
                uVar17 = (undefined2)((ulong)lpth >> 0x10);
                if (*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) == 0) {
THING_LAutoTech:
                  iGoto = 0;
                  for (i = 0; i < 6; i = i + 1) {
                    iGoto = iGoto + *(char *)(iplr * 0xc0 + 0x59bc + i);
                  }
                  if ((*(uint *)((int)&rgplr[0].wFlags + ((FLEET *)lpfl)->iPlayer * 0xc0)
                       >> 1 & 1) == 0) {
                    cPlrTrueMaxTech = 0x1a;
                  }
                  else {
                    cPlrTrueMaxTech = 10;
                  }
                  if (cPlrTrueMaxTech * 6 + -6 <= iGoto) goto LAB_1110_1a6b;
                  for (cTech = (PLANET *)0x0; (int)cTech < 6;
                      cTech = (PLANET *)((int)&cTech->id + 1)) {
                    iGoto = 0;
                    for (i = 1; i < 6; i = i + 1) {
                      iLowest = (short)*(char *)(iplr * 0xc0 + 0x59bc + i);
                      if (iLowest < *(char *)(iplr * 0xc0 + 0x59bc + iGoto)) {
                        iGoto = i;
                      }
                    }
                    pcVar4 = (char *)(iplr * 0xc0 + 0x59bc + iGoto);
                    *pcVar4 = *pcVar4 + '\x01';
                  }
                  wtNext._0_2_ = wtThreshhold;
                  wtNext._2_2_ = local_6;
                }
                else {
                  cTech = (PLANET *)(rgcrPlrHistory + 1);
                  iGoto = *(short *)((int)&((THING *)lpth)->u_THING_0x0006 + 8);
                  while (((iGoto & *(uint *)((int)&rgplr[0].grbitTrader + iplr * 0xc0)) !=
                          0 && (pPVar25 = (PLANET *)((int)&cTech[-1].lpplprod + 3),
                               bVar20 = 0 < (int)cTech, cTech = pPVar25, bVar20))) {
                    sVar9 = Random(0xd);
                    iGoto = 1 << ((byte)sVar9 & 0x1f);
                  }
                  if ((int)cTech < 1) goto THING_LAutoTech;
                  puVar3 = (uint *)((int)&rgplr[0].grbitTrader + iplr * 0xc0);
                  *puVar3 = *puVar3 | iGoto;
                }
                puVar3 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
                *puVar3 = *puVar3 | 1 << ((byte)iplr & 0x1f);
                for (i = 2; (-1 < (int)wtNext._2_2_ &&
                            (((0 < (int)wtNext._2_2_ || ((uint)wtNext != 0)) && (-1 < i))));
                    i = i + -1) {
                  uVar6 = *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                  if (((int)uVar6 < (int)wtNext._2_2_) ||
                     ((wtMin = (uint)wtNext, local_e = wtNext._2_2_, (int)uVar6 <= (int)wtNext._2_2_
                      && (*(uint *)(((PLANET *)lppl)->rgwtMin + i) <= (uint)wtNext)))) {
                    wtMin = *(uint *)(((PLANET *)lppl)->rgwtMin + i);
                    local_e = *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                  }
                  puVar3 = (uint *)(((PLANET *)lppl)->rgwtMin + i);
                  uVar6 = *puVar3;
                  *puVar3 = *puVar3 - wtMin;
                  puVar3 = (uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                  *puVar3 = (*puVar3 - local_e) - (uint)(uVar6 < wtMin);
                  bVar20 = (uint)wtNext < wtMin;
                  wtNext._0_2_ = (uint)wtNext - wtMin;
                  wtNext._2_2_ = (wtNext._2_2_ - local_e) - (uint)bVar20;
                }
              }
            }
          }
LAB_1110_1a6b:
          lppl = (PLANET *)lppl + 1;
        }
      }
      lpth = (THING *)lpth + 1;
    }
  }
  return;
}



// ======================================================================
// Function: IdmGiveTraderPart
// Address: 1110:1a96
// Segment: MEMORY_THING
// ======================================================================


short IdmGiveTraderPart(ushort grbitTrader,short iplr,ushort *piGoto)

{
  uint *puVar1;
  short idm;
  ushort iGoto;
  
  puVar1 = (uint *)((int)&rgplr[0].grbitTrader + iplr * 0xc0);
  *puVar1 = *puVar1 | grbitTrader;
  idm = 0x10b;
  if (grbitTrader != 1) {
    if (grbitTrader == 2) {
      iGoto = 0xcb04;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 4) {
      iGoto = 0xc206;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 8) {
      iGoto = 0xc309;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x10) {
      iGoto = 0xc706;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x20) {
      iGoto = 0xc608;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x40) {
      iGoto = 0xc507;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x80) {
      iGoto = 0xc412;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x100) {
      idm = 0x10c;
      iGoto = 0xce1e;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x200) {
      iGoto = 0xc008;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x400) {
      idm = 0x10f;
      iGoto = 0xcf0e;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x800) {
      iGoto = 0xcc09;
      goto LAB_1110_1b8b;
    }
  }
  iGoto = 0xcc04;
LAB_1110_1b8b:
  *piGoto = iGoto;
  return idm;
}



