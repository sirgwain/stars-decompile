// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: LpthNew
// Address: 1110:0000
// Segment: MEMORY_THING
// ======================================================================


THING * LpthNew(short iplr,ThingType ith)

{
  undefined2 unaff_SS;
  THING *pTVar1;
  THING thNew;
  THING *lpth;
  short i;
  short iItem;
  
                    /* Segment:    35
                       Offset:     000f8f00
                       Length:     1b9f
                       Min Alloc:  1b9f
                       Flags:      1d50
                           Code
                           Discardable
                           Moveable
                           Preload
                           Impure (Non-shareable)
                        */
  if (cThing < 0xfd2) {
    _memset(&thNew,0,0x12);
    thNew.idFull = thNew.idFull & 0x1ff | (iplr & 0xfU) << 9 | ith << 0xd;
    i = 0;
    lpth = lpThings;
    while ((i < cThing && (lpth->idFull < thNew.idFull))) {
      i = i + 1;
      lpth = (THING *)lpth + 1;
    }
    if ((i < cThing) && (thNew.idFull == lpth->idFull)) {
      iItem = lpth->idFull & 0x1ff;
      for (; i < cThing; i = i + 1) {
        if (0x1fe < iItem) {
          lpth._0_2_ = (THING *)0x0;
          lpth._2_2_ = 0;
          pTVar1 = lpThings;
          goto LAB_1110_021d;
        }
        if (lpth->idFull != thNew.idFull) break;
        thNew.idFull = thNew.idFull & 0xfe00 | thNew.idFull + 1 & 0x1ff;
        lpth = (THING *)lpth + 1;
        iItem = iItem + 1;
      }
    }
    if (cThingAlloc <= cThing) {
      cThingAlloc = cThingAlloc + 10;
      if (lpThings == (THING *)0x0) {
        pTVar1 = LpAlloc(cThingAlloc * 0x12,htThings);
      }
      else {
        pTVar1 = LpReAlloc(lpThings,cThingAlloc * 0x12,htThings);
      }
      lpThings._2_2_ = (undefined2)((ulong)pTVar1 >> 0x10);
      lpThings._0_2_ = (THING *)pTVar1;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings + i);
      lpThings = pTVar1;
    }
    if (i < cThing) {
      __fmemmove((THING *)lpth + 1,lpth,(cThing - i) * 0x12);
    }
    cThing = cThing + 1;
    __fmemcpy(lpth,&thNew,0x12);
    pTVar1 = lpThings;
  }
  else {
    lpth._0_2_ = (THING *)0x0;
    lpth._2_2_ = 0;
    pTVar1 = lpThings;
  }
LAB_1110_021d:
  lpThings._2_2_ = (undefined2)((ulong)pTVar1 >> 0x10);
  lpThings._0_2_ = (THING *)pTVar1;
  return (THING *)CONCAT22(lpth._2_2_,(THING *)lpth);
}



// ======================================================================
// Function: FreeLpth
// Address: 1110:0224
// Segment: MEMORY_THING
// ======================================================================


void FreeLpth(THING *lpth)

{
  if ((THING *)lpth < (THING *)lpThings + cThing + -1) {
    __fmemmove(lpth,(THING *)lpth + 1,
                       ((cThing - ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12
                        ) + -1) * 0x12);
  }
  cThing = cThing + -1;
  return;
}



// ======================================================================
// Function: CPlanetsInCircle
// Address: 1110:02a0
// Segment: MEMORY_THING
// ======================================================================


short CPlanetsInCircle(POINT pt,long r2)

{
  int iVar1;
  int iVar2;
  int iVar3;
  POINT *pPVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar5;
  ulong uVar6;
  ulong uVar7;
  undefined8 uVar8;
  undefined2 in_stack_0000ffe2;
  undefined2 in_stack_0000ffe4;
  short xEnd;
  short dx;
  short cPl;
  short r;
  short i;
  short yStart;
  POINT *pptEnd;
  short dy;
  short yEnd;
  POINT *ppt;
  short xStart;
  
  _sqrt((double)r2);
  lVar5 = __ftol((double)CONCAT26(in_stack_0000ffe4,
                                          CONCAT24(in_stack_0000ffe2,CONCAT22(unaff_SI,unaff_DI))));
  iVar1 = (int)lVar5;
  cPl = 0;
  pPVar4 = (POINT *)rgptPlan + game.cPlanMax;
  uVar8 = CONCAT62(CONCAT42((long)(((POINT *)rgptPlan + game.cPlanMax + -1)->x -
                                  rgptPlan[0].x),game.cPlanMax >> 0xf),
                   game.cPlanMax);
  uVar6 = __aFulmul((long)(pt.x - rgptPlan[0].x),(ulong)uVar8);
  lVar5 = (long)((ulonglong)uVar8 >> 0x20);
  lVar5 = __aFldiv((long)CONCAT62(CONCAT42(lVar5,(int)(uVar6 >> 0x10)),(int)uVar6),lVar5);
  i = (short)lVar5;
  if (game.cPlanMax <= i) {
    i = game.cPlanMax + -1;
  }
  if (i < 0) {
    i = 0;
  }
  for (ppt = (POINT *)rgptPlan + i;
      (pt.x - iVar1 <= ppt->x && ((POINT *)((int)&rgptPlan[0].x + 1U) <= ppt));
      ppt = ppt + -1) {
  }
  for (; (ppt->x <= pt.x + iVar1 && (ppt < pPVar4)); ppt = ppt + 1) {
    if (((pt.x - iVar1 <= ppt->x) && (pt.y - iVar1 <= ppt->y)) && (ppt->y <= pt.y + iVar1)) {
      iVar2 = ppt->x - pt.x;
      iVar3 = ppt->y - pt.y;
      uVar6 = __aFulmul((ulong)CONCAT62(CONCAT42((long)iVar3,iVar3 >> 0xf),iVar3),
                                (long)iVar3);
      uVar7 = __aFulmul((ulong)CONCAT62(CONCAT42((long)iVar2,iVar2 >> 0xf),iVar2),
                                (long)iVar2);
      iVar2 = (int)(uVar7 + uVar6 >> 0x10);
      if ((iVar2 <= r2._2_2_) && ((iVar2 < r2._2_2_ || ((uint)(uVar7 + uVar6) <= (uint)r2)))) {
        cPl = cPl + 1;
      }
    }
  }
  return cPl;
}



// ======================================================================
// Function: DrawThingGauge
// Address: 1110:044e
// Segment: MEMORY_THING
// ======================================================================


void DrawThingGauge(HDC hdc,RECT *prc,THING *lpth,short md)

{
  int iVar1;
  bool bVar2;
  short sVar3;
  THING *pTVar4;
  undefined2 uVar5;
  ulong cTot;
  long lVar6;
  DWORD DVar7;
  long l;
  long lMax;
  long rgSize [5];
  short i;
  short c;
  ushort rghbr [5];
  short fDisabled;
  short cSections;
  short iMode;
  
  bVar2 = false;
  SelectObject(hdc,rghfontArial8[1]);
  cSections = 1;
  uVar5 = (undefined2)((ulong)lpth >> 0x10);
  pTVar4 = (THING *)lpth;
  cTot = __aFulmul((ulong)(*(uint *)((int)&pTVar4->u_THING_0x0006 + 8) & 0x3fff),10);
  if ((md < 0) || (4 < md)) {
    if (md == 5) {
      for (i = 0; i < 3; i = i + 1) {
        rghbr[i] = ((ushort *)rghbrMineral)[i];
        iVar1 = *(int *)((pTVar4->u_THING_0x0006).rgb + i * 2 + 2);
        *(int *)(rgSize + i) = iVar1;
        *(int *)((int)rgSize + i * 4 + 2) = iVar1 >> 0xf;
      }
      cSections = 3;
      rgSize[0] = CONCAT22(rgSize[0]._2_2_,(undefined2)rgSize[0]);
    }
  }
  else if ((md == 4) || (md == 3)) {
    rghbr[0] = hbrButtonShadow;
    bVar2 = true;
    rgSize[0] = cTot;
  }
  else {
    rghbr[0] = ((ushort *)rghbrMineral)[md];
    rgSize[0] = (long)*(int *)((pTVar4->u_THING_0x0006).rgb + md * 2 + 2);
  }
  lMax._2_2_ = (undefined2)(cTot >> 0x10);
  lMax._0_2_ = (undefined2)cTot;
  lVar6 = LDrawGauge(hdc,prc,cSections,rgSize,rghbr,cTot);
  sVar3 = SetBkMode(hdc,1);
  if (bVar2) {
    lVar6 = 0;
  }
  l._2_2_ = (undefined2)((ulong)lVar6 >> 0x10);
  l._0_2_ = (undefined2)lVar6;
  if (cSections == 1) {
    c = _wsprintf(szWork,(char *)0x112016a0,(undefined2)l,l._2_2_);
  }
  else {
    c = _wsprintf(szWork,s__ld_of__ldkT_1120_16a6,(undefined2)l,l._2_2_,(undefined2)lMax,
                  lMax._2_2_);
  }
  DVar7 = GetTextExtent(hdc,szWork,c);
  if ((int)DVar7 < (prc->right - prc->left) + -3) {
    RcCtrTextOut(hdc,prc,(char *)szWork,c);
  }
  SetBkMode(hdc,sVar3);
  return;
}



// ======================================================================
// Function: IValidateWormholePos
// Address: 1110:064c
// Segment: MEMORY_THING
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x11100a9a) */
/* WARNING: Removing unreachable block (ram,0x11100a64) */
/* WARNING: Removing unreachable block (ram,0x11100994) */
/* WARNING: Removing unreachable block (ram,0x1110095e) */
/* WARNING: Removing unreachable block (ram,0x1110091a) */
/* WARNING: Removing unreachable block (ram,0x111008e4) */
/* WARNING: Removing unreachable block (ram,0x111008fc) */
/* WARNING: Removing unreachable block (ram,0x11100938) */
/* WARNING: Removing unreachable block (ram,0x11100976) */
/* WARNING: Removing unreachable block (ram,0x111009b2) */
/* WARNING: Removing unreachable block (ram,0x11100a7c) */
/* WARNING: Removing unreachable block (ram,0x11100ab8) */

short IValidateWormholePos(THING *lpthWorm)

{
  int iVar1;
  int iVar2;
  int iVar3;
  long lVar4;
  int iVar5;
  int iVar6;
  THING *pTVar7;
  THING *pTVar8;
  undefined2 uVar9;
  undefined2 uVar10;
  ulong uVar11;
  ulong uVar12;
  long l;
  long dx;
  short dUni;
  THING *lpth;
  short i;
  short ifl;
  FLEET *lpfl;
  THING *lpthMac;
  long dy;
  POINT pt;
  short iRet;
  
  iRet = 0;
  iVar5 = game.mdSize * 400;
  uVar9 = (undefined2)((ulong)lpthWorm >> 0x10);
  pTVar8 = (THING *)lpthWorm;
  iVar1 = (&pTVar8->pt)->x;
  iVar2 = (pTVar8->pt).y;
  if ((iVar1 < 1000) || (iVar2 < 1000)) {
    iRet = 0xf;
  }
  else if ((iVar5 + 0x578 < iVar1) || (iVar5 + 0x578 < iVar2)) {
    iRet = 0xf;
  }
  else {
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < (THING *)lpThings + cThing) {
      uVar10 = (undefined2)((ulong)lpth >> 0x10);
      if (((iVar1 == (&((THING *)lpth)->pt)->x) && (iVar2 == (((THING *)lpth)->pt).y)) &&
         (lpthWorm != lpth)) {
        return 0xf;
      }
      lpth = (THING *)CONCAT22(uVar10,(THING *)lpth + 1);
    }
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      if ((iVar1 == ((POINT *)rgptPlan + i)->x) &&
         (iVar2 == *(int *)((int)&rgptPlan[0].y + i * 4))) {
        return 0xf;
      }
    }
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
      iVar6 = *(int *)((FLEET **)rglpfl + ifl);
      iVar3 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      if ((iVar6 == 0) && (iVar3 == 0)) break;
      if ((iVar1 == *(int *)(iVar6 + 8)) && (iVar2 == *(int *)(iVar6 + 10))) {
        return 0xf;
      }
    }
    if ((((iVar1 < 0x3f2) || (iVar2 < 0x3f2)) || (iVar5 + 0x56e < iVar1)) || (iVar5 + 0x56e < iVar2)
       ) {
      iRet = 4;
    }
    pTVar7 = (THING *)lpThings + cThing;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < pTVar7) {
      uVar10 = (undefined2)((ulong)lpth >> 0x10);
      if ((lpth->idFull >> 0xd == 2) && (lpthWorm != lpth)) {
        iVar5 = iVar1 - (&((THING *)lpth)->pt)->x;
        iVar6 = iVar2 - (((THING *)lpth)->pt).y;
        uVar11 = __aFulmul((long)iVar6,(long)iVar6);
        uVar12 = __aFulmul((long)iVar5,(long)iVar5);
        lVar4 = uVar12 + uVar11;
        if (lpth->idFull == *(ushort *)((int)&pTVar8->u_THING_0x0006 + 6)) {
          if (lVar4 < 0x1324) {
            if (lVar4 < 0x19) {
              iRet = iRet | 8;
            }
            else if (lVar4 < 100) {
              iRet = iRet | 4;
            }
            else if (lVar4 < 900) {
              iRet = iRet | 2;
            }
            else {
              iRet = iRet | 1;
            }
          }
        }
        else if (lVar4 < 900) {
          if (lVar4 < 0x10) {
            iRet = iRet | 8;
          }
          else if (lVar4 < 0x40) {
            iRet = iRet | 4;
          }
          else if (lVar4 < 0xe1) {
            iRet = iRet | 2;
          }
          else {
            iRet = iRet | 1;
          }
        }
      }
      lpth = (THING *)CONCAT22(uVar10,(THING *)lpth + 1);
    }
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      iVar5 = iVar1 - ((POINT *)rgptPlan + i)->x;
      iVar6 = iVar2 - *(int *)((int)&rgptPlan[0].y + i * 4);
      uVar11 = __aFulmul((long)iVar6,(long)iVar6);
      uVar12 = __aFulmul((long)iVar5,(long)iVar5);
      lVar4 = uVar12 + uVar11;
      if (lVar4 < 0x310) {
        if (lVar4 < 0x19) {
          iRet = iRet | 8;
        }
        else if (lVar4 < 100) {
          iRet = iRet | 4;
        }
        else if (lVar4 < 400) {
          iRet = iRet | 2;
        }
        else {
          iRet = iRet | 1;
        }
      }
    }
  }
  return iRet;
}



// ======================================================================
// Function: PctWormholeMoves
// Address: 1110:0adc
// Segment: MEMORY_THING
// ======================================================================


short PctWormholeMoves(THING *lpth)

{
  undefined2 uVar1;
  short pct;
  
  uVar1 = (undefined2)((ulong)lpth >> 0x10);
  pct = (((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 2 & 0x3ff) / 5 -
        (2 - (((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 3));
  if (pct < 0) {
    pct = 0;
  }
  else if (6 < pct) {
    pct = 6;
  }
  return pct;
}



// ======================================================================
// Function: DoThingInteractions
// Address: 1110:0b3a
// Segment: MEMORY_THING
// ======================================================================


/* WARNING: Variable defined which should be unmapped: cGive */
/* WARNING: Removing unreachable block (ram,0x11100ed1) */
/* WARNING: Removing unreachable block (ram,0x11101776) */
/* WARNING: Removing unreachable block (ram,0x11101129) */

void DoThingInteractions(short fPostMove)

{
  ulong *puVar1;
  int *piVar2;
  uint *puVar3;
  char *pcVar4;
  HUL *pHVar5;
  int iVar6;
  int iVar7;
  FLEET *pFVar8;
  ushort uVar9;
  uint uVar10;
  short sVar11;
  uint uVar12;
  byte bVar13;
  int iVar14;
  SHDEF *pSVar15;
  int iVar16;
  uint uVar17;
  undefined2 *puVar18;
  FLEET *pFVar19;
  PLORD *pPVar20;
  undefined2 unaff_SI;
  HUL *pHVar21;
  undefined2 unaff_DI;
  SHDEF *pSVar22;
  undefined2 uVar23;
  undefined2 uVar24;
  undefined2 unaff_SS;
  bool bVar25;
  long lVar26;
  SHDEF *pSVar27;
  FLEET *lpfl_00;
  PLANET *pPVar28;
  ulong uVar29;
  PLANET *pPVar30;
  short sVar31;
  short p4;
  short p5;
  short p6;
  short p7;
  long lVar32;
  short cGive;
  FLEET *lpflNew;
  SHDEF *lpshdefDest;
  HUL local_e8;
  undefined4 local_5a;
  undefined4 local_56;
  int local_52;
  int local_50;
  undefined4 local_4e;
  long l;
  short fMaxTech;
  long dx;
  short cPlrTrueMaxTech;
  short idm;
  THING *lpth;
  FLEET *lpfl;
  short ifl;
  short i;
  PLANET *lppl;
  PLANET *lpplMac;
  THING *lpthMac;
  long dy;
  long wtNext;
  byte rgTech [6];
  short iplrSav;
  POINT pt;
  long wtMin;
  short iplr;
  ushort grbitPlrTrader;
  long wtThreshhold;
  
  lVar32 = CONCAT22(unaff_SI,unaff_DI);
  if (fPostMove != 0) {
    local_4e = (PLANET *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    lpthMac._0_2_ = (THING *)lpThings + cThing;
    lpthMac._2_2_ = lpThings._2_2_;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < (THING *)lpthMac) {
      if (lpth->idFull >> 0xd == 3) {
        uVar23 = (undefined2)((ulong)lpth >> 0x10);
        iVar6 = (&((THING *)lpth)->pt)->x;
        iVar7 = (((THING *)lpth)->pt).y;
        for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar8 = ((FLEET **)rglpfl)[ifl];
          iVar14 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
          lpfl = (FLEET *)CONCAT22(iVar14,pFVar8);
          if ((pFVar8 == (FLEET *)0x0) && (iVar14 == 0)) break;
          if (((pFVar8->wFlags_0x4 >> 10 & 1) == 0) &&
             (((&pFVar8->pt)->x == iVar6 && ((pFVar8->pt).y == iVar7)))) {
            wtMin._0_2_ = 0;
            wtMin._2_2_ = 0;
            for (i = 0; i < 3; i = i + 1) {
              uVar10 = *(uint *)(pFVar8->rgwtMin + i);
              bVar25 = CARRY2((uint)wtMin,uVar10);
              wtMin._0_2_ = (uint)wtMin + uVar10;
              wtMin._2_2_ = wtMin._2_2_ + *(uint *)((int)(pFVar8->rgwtMin + i) + 2) + (uint)bVar25;
            }
            if ((wtMin._2_2_ < 1) && ((wtMin._2_2_ < 0 || ((uint)wtMin < 5000)))) {
              if ((pFVar8->wFlags_0x4 >> 0xd & 1) == 0) {
                FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,
                                  idmMysteryTraderHasRefusedGiveCaptainAudience,lpfl->id | 0x8000,
                                  lpfl->id,0);
              }
            }
            else {
              if ((*(uint *)((int)&rgplr[0].wFlags + pFVar8->iPlayer * 0xc0) >> 1 & 1) ==
                  0) {
                cPlrTrueMaxTech = 0x1a;
              }
              else {
                cPlrTrueMaxTech = 10;
              }
              i = 0;
              while ((i < 6 && (cPlrTrueMaxTech <= *(char *)(pFVar8->iPlayer * 0xc0 + 0x59bc + i))))
              {
                i = i + 1;
              }
              fMaxTech = (short)(i == 6);
              uVar10 = *(uint *)((int)&rgplr[0].grbitTrader + pFVar8->iPlayer * 0xc0);
              sVar11 = pFVar8->iPlayer;
              bVar13 = (byte)sVar11;
              uVar23 = (undefined2)((ulong)lpth >> 0x10);
              if ((1 << (bVar13 & 0x1f) & *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 6)) == 0
                 ) {
                puVar3 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
                *puVar3 = *puVar3 | 1 << (bVar13 & 0x1f);
                FRemovePlayerMessage(sVar11,idmHasCompletedAssignedOrders,lpfl->id | 0x8000);
                uVar23 = (undefined2)((ulong)lpfl >> 0x10);
                ((FLEET *)lpfl)->wFlags_0x4 = ((FLEET *)lpfl)->wFlags_0x4 & 0xfbff | 0x400;
                uVar23 = (undefined2)((ulong)lpth >> 0x10);
                if ((*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) == 0) ||
                   ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) & uVar10) != 0)) {
                  if (fMaxTech == 0) {
                    local_52 = 0;
                    lVar26 = __aFldiv(CONCAT22(wtMin._2_2_ + -1 + (uint)(4999 < (uint)wtMin)
                                                       ,(uint)wtMin + 0xec78),0x4b0);
                    pPVar28 = (PLANET *)(lVar26 + 6);
                    i = 0;
                    while( true ) {
                      if (5 < i) break;
                      local_52 = local_52 + *(char *)(((FLEET *)lpfl)->iPlayer * 0xc0 + 0x59bc + i);
                      i = i + 1;
                    }
                    if (10 < (long)pPVar28) {
                      pPVar28 = (PLANET *)0xa;
                    }
                    local_4e._2_2_ = (uint)((ulong)pPVar28 >> 0x10);
                    local_4e._0_2_ = (PLANET *)pPVar28;
                    if (local_52 < 0x6c) {
                      if (local_52 < 0x60) {
                        if (local_52 < 0x54) {
                          if (local_52 < 0x48) {
                            if (0x3b < local_52) {
                              pPVar28 = (PLANET *)
                                        CONCAT22(local_4e._2_2_ -
                                                 ((PLANET *)local_4e == (PLANET *)0x0),
                                                 (PLANET *)
                                                 ((int)&((PLANET *)local_4e)[-1].lpplprod + 3));
                            }
                          }
                          else {
                            pPVar28 = (PLANET *)
                                      CONCAT22(local_4e._2_2_ - ((PLANET *)local_4e < (PLANET *)0x2)
                                               ,(PLANET *)
                                                ((int)&((PLANET *)local_4e)[-1].lpplprod + 2));
                          }
                        }
                        else {
                          pPVar28 = (PLANET *)
                                    CONCAT22(local_4e._2_2_ - ((PLANET *)local_4e < (PLANET *)0x3),
                                             (PLANET *)((int)&((PLANET *)local_4e)[-1].lpplprod + 1)
                                            );
                        }
                      }
                      else {
                        pPVar28 = (PLANET *)0x2;
                      }
                    }
                    else {
                      pPVar28 = (PLANET *)0x1;
                    }
                    local_4e._0_2_ = (PLANET *)pPVar28;
                    if ((uVar10 & 0x1fff) == 0x1fff) {
                      idm = 0x10a;
                    }
                    else {
                      idm = 0x109;
                    }
                    p7 = 0;
                    p6 = 0;
                    p5 = 0;
                    p4 = 0;
                    sVar31 = 0;
                    pPVar30 = (PLANET *)local_4e;
                    local_4e = pPVar28;
                    uVar9 = WFromLpfl(lpfl);
                    FSendPlrMsg((uint)lpfl->id >> 9 & 0xf,idm,-1,uVar9,(short)pPVar30,sVar31,p4
                                     ,p5,p6,p7);
                    pPVar28 = local_4e;
                    while( true ) {
                      local_4e._2_2_ = (uint)((ulong)pPVar28 >> 0x10);
                      local_4e._0_2_ = (PLANET *)pPVar28;
                      bVar25 = (PLANET *)local_4e == (PLANET *)0x0;
                      local_4e._0_2_ = (PLANET *)((int)&((PLANET *)local_4e)[-1].lpplprod + 3);
                      local_4e._2_2_ = local_4e._2_2_ - bVar25;
                      if (pPVar28 == (PLANET *)0x0) break;
                      sVar31 = Random(4);
                      lVar26 = local_5a;
                      if (sVar31 < 3) {
                        local_50 = Random(6);
                        lVar26 = local_5a;
                        if (cPlrTrueMaxTech <= *(char *)(sVar11 * 0xc0 + 0x59bc + local_50))
                        goto LAB_1110_1010;
                      }
                      else {
LAB_1110_1010:
                        local_5a._2_2_ = (int)((ulong)lVar26 >> 0x10);
                        local_5a._0_2_ = (undefined2)lVar26;
                        local_50 = 0;
                        i = 1;
                        while( true ) {
                          lVar26 = CONCAT22(local_5a._2_2_,(undefined2)local_5a);
                          if (5 < i) break;
                          local_5a._2_2_ = (int)*(char *)(sVar11 * 0xc0 + 0x59bc + i);
                          if (local_5a._2_2_ < *(char *)(sVar11 * 0xc0 + 0x59bc + local_50)) {
                            local_50 = i;
                          }
                          i = i + 1;
                        }
                        if (cPlrTrueMaxTech <= *(char *)(sVar11 * 0xc0 + 0x59bc + local_50)) break;
                      }
                      local_5a = lVar26;
                      _memcpy(rgTech,(void *)((int)rgplr[0].rgTech + sVar11 * 0xc0
                                                     ),6);
                      sVar31 = idPlayer;
                      rgTech[local_50] = rgTech[local_50] + 1;
                      idPlayer = sVar11;
                      lVar26 = CostOfDevelopingItem((char *)rgTech);
                      puVar18 = (undefined2 *)(sVar11 * 0xc0 + 0x59c2 + local_50 * 4);
                      local_56._0_2_ = *puVar18;
                      local_56._2_2_ = puVar18[1];
                      wtNext = lVar26;
                      idPlayer = sVar31;
                      lVar26 = __aFlshl(lVar32,cGive);
                      if (0 < wtNext) {
                        lVar26 = lVar26 + wtNext;
                      }
                      local_56._2_2_ = (uint)((ulong)lVar26 >> 0x10);
                      local_56._0_2_ = (undefined2)lVar26;
                      puVar18 = (undefined2 *)(sVar11 * 0xc0 + 0x59c2 + local_50 * 4);
                      *puVar18 = (undefined2)local_56;
                      puVar18[1] = local_56._2_2_;
                      local_56 = lVar26;
                      local_5a = lVar26;
                      UpdateResearchStatus(0);
                      pPVar28 = (PLANET *)CONCAT22(local_4e._2_2_,(PLANET *)local_4e);
                    }
                  }
                  else {
                    sVar31 = Random(5);
                    if (sVar31 != 0) goto THING_LGivePart;
                    idm = 0x10e;
                    sVar11 = 0;
                    uVar9 = WFromLpfl(lpfl);
                    FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,idm,-1,uVar9,sVar11);
                  }
                }
                else {
THING_LGivePart:
                  local_50 = 0x19;
                  local_4e._0_2_ = (PLANET *)*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 8);
                  if ((PLANET *)local_4e == (PLANET *)0x0) {
                    sVar31 = Random(0xd);
                    local_4e._0_2_ = (PLANET *)(1 << ((byte)sVar31 & 0x1f));
                  }
                  while ((((uint)(PLANET *)local_4e & uVar10) != 0 &&
                         (iVar14 = local_50 + -1, bVar25 = 0 < local_50, local_50 = iVar14, bVar25))
                        ) {
                    sVar31 = Random(0xd);
                    local_4e._0_2_ = (PLANET *)(1 << ((byte)sVar31 & 0x1f));
                  }
                  if (local_50 < 1) {
                    local_4e._0_2_ = (PLANET *)0x1000;
                  }
                  puVar3 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
                  *puVar3 = *puVar3 | 1 << (bVar13 & 0x1f);
                  if ((PLANET *)local_4e == (PLANET *)0x1000) {
                    if ((*(uint *)((int)&rgplr[0].wMdPlr + sVar11 * 0xc0) >> 9 & 1) == 0)
                    {
                      local_52 = Random(4 - (uint)(100 < game.turn));
                      if (0 < local_52) {
                        sVar31 = Random(2);
                        local_52 = sVar31 + 1;
                      }
                      pSVar27 = LpshdefT();
                      uVar23 = (undefined2)((ulong)pSVar27 >> 0x10);
                      pSVar15 = (SHDEF *)pSVar27 + local_52 + 0x13;
                      pHVar21 = &local_e8;
                      for (iVar14 = 0x49; iVar14 != 0; iVar14 = iVar14 + -1) {
                        pHVar5 = pHVar21;
                        pHVar21 = pHVar21->rgTech;
                        pSVar27 = pSVar15;
                        pSVar15 = (pSVar15->hul).rgTech;
                        pHVar5->ihuldef = (pSVar27->hul).ihuldef;
                      }
                      *&pHVar21->ihuldef = (char)(pSVar15->hul).ihuldef;
                      uVar10 = IshFindSimilarDesign(&local_e8,sVar11);
                      local_56._2_2_ = uVar10;
                      if ((int)uVar10 < 0) {
                        do {
                          local_56._2_2_ = local_56._2_2_ + 1;
                          if (0xf < (int)local_56._2_2_) break;
                        } while ((*(uint *)(*(int *)(sVar11 * 4 + rglpshdef) + local_56._2_2_ * 0x93
                                           + 0x7b) >> 9 & 1) == 0);
                      }
                      if (((int)local_56._2_2_ < 0x10) &&
                         ((*(uint *)((int)&rgplr[0].wFlags_0x4 +
                                    ((uint)lpfl->id >> 9 & 0xf) * 0xc0) & 0xfff) < 0x200)) {
                        sVar31 = Random(3);
                        if (sVar31 == 0) {
                          cGive = 2;
                        }
                        else {
                          cGive = 1;
                        }
                        if ((100 < game.turn) && ((game.wCrap >> 2 & 1) == 0)) {
                          sVar31 = Random(game.turn / 100 + 1);
                          cGive = cGive + sVar31;
                        }
                        if (5 < cGive) {
                          cGive = 5;
                        }
                        if (0 < local_52) {
                          sVar31 = Random(cGive + 1);
                          cGive = cGive + sVar31;
                        }
                        lpfl_00 = LpflNew(sVar11,((FLEET *)lpfl)->idPlanet);
                        iVar14 = (int)((ulong)lpfl_00 >> 0x10);
                        pFVar8 = (FLEET *)lpfl_00;
                        if ((pFVar8 != (FLEET *)0x0) || (iVar14 != 0)) {
                          sVar31 = cGive;
                          uVar9 = WFromLpfl(lpfl);
                          FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,
                                            idmHasAbsorbedMysteryTraderReturnHaveGiven3,
                                            lpfl_00->id | 0x8000,uVar9,sVar31);
                          if (lpfl_00->id < lpfl->id) {
                            ifl = ifl + 1;
                          }
                          uVar23 = (undefined2)((ulong)lpfl >> 0x10);
                          pFVar19 = (FLEET *)lpfl;
                          sVar31 = (pFVar19->pt).y;
                          (&pFVar8->pt)->x = (&pFVar19->pt)->x;
                          (pFVar8->pt).y = sVar31;
                          sVar31 = (pFVar19->pt).y;
                          uVar24 = (undefined2)((ulong)pFVar8->lpplord >> 0x10);
                          pPVar20 = (PLORD *)pFVar8->lpplord;
                          (pPVar20 + 1)->wFlags = (&pFVar19->pt)->x;
                          *(short *)&pPVar20[1].iordMax = sVar31;
                          pFVar8->wFlags_0x4 = pFVar8->wFlags_0x4 & 0xdfff | 0x2000;
                          uVar23 = *(undefined2 *)(sVar11 * 4 + rglpshdef_0x2);
                          pSVar15 = (SHDEF *)(*(int *)(sVar11 * 4 + rglpshdef) +
                                             local_56._2_2_ * 0x93);
                          if ((pSVar15->wFlags >> 9 & 1) != 0) {
                            pHVar21 = &local_e8;
                            pSVar22 = pSVar15;
                            for (iVar16 = 0x49; iVar16 != 0; iVar16 = iVar16 + -1) {
                              pSVar27 = pSVar22;
                              pSVar22 = (pSVar22->hul).rgTech;
                              pHVar5 = pHVar21;
                              pHVar21 = pHVar21->rgTech;
                              (pSVar27->hul).ihuldef = pHVar5->ihuldef;
                            }
                            *&(pSVar22->hul).ihuldef = (char)pHVar21->ihuldef;
                            pSVar15->wFlags =
                                 pSVar15->wFlags & 0x83ff | (local_56._2_2_ & 0x1f) << 10;
                            pSVar15->wFlags = pSVar15->wFlags & 0x7fff | 0x8000;
                            *(undefined2 *)&pSVar15->cBuilt = 0;
                            *(undefined2 *)((int)&pSVar15->cBuilt + 2) = 0;
                            *(undefined2 *)&pSVar15->cExist = 0;
                            *(undefined2 *)((int)&pSVar15->cExist + 2) = 0;
                            pcVar4 = (char *)((int)&rgplr[0].cShDef + sVar11 * 0xc0);
                            *pcVar4 = *pcVar4 + '\x01';
                            idPlayer = (uint)lpfl->id >> 9 & 0xf;
                            UpdateShdefCost((SHDEF *)CONCAT22(uVar23,pSVar15));
                            idPlayer = -1;
                          }
                          puVar1 = &pSVar15->cBuilt;
                          uVar29 = *puVar1;
                          *puVar1 = (uint)*puVar1 + cGive;
                          piVar2 = (int *)((int)&pSVar15->cBuilt + 2);
                          *piVar2 = *piVar2 + (cGive >> 0xf) + (uint)CARRY2((uint)uVar29,cGive);
                          puVar1 = &pSVar15->cExist;
                          uVar29 = *puVar1;
                          *puVar1 = (uint)*puVar1 + cGive;
                          piVar2 = (int *)((int)&pSVar15->cExist + 2);
                          *piVar2 = *piVar2 + (cGive >> 0xf) + (uint)CARRY2((uint)uVar29,cGive);
                          pFVar8->rgcsh[local_56._2_2_] = cGive;
                          lVar26 = LGetFleetStat(lpfl_00,grStatFuel);
                          *(int *)(pFVar8->rgwtMin + 4) = (int)lVar26;
                          *(undefined2 *)((int)pFVar8->rgwtMin + 0x12) =
                               (int)((ulong)lVar26 >> 0x10);
                          goto LAB_1110_15e6;
                        }
                      }
                      sVar11 = 0;
                      uVar9 = WFromLpfl(lpfl);
                      FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,
                                        idmHasAbsorbedMysteryTraderReturnTraderTried,-1,uVar9,sVar11
                                       );
                    }
LAB_1110_15e6:
                  }
                  else {
                    idm = IdmGiveTraderPart((ushort)(PLANET *)local_4e,sVar11,
                                            (ushort *)((int)&local_4e + 2));
                    sVar11 = 0;
                    uVar9 = WFromLpfl(lpfl);
                    FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,idm,local_4e._2_2_,uVar9,sVar11);
                  }
                }
              }
              else {
                FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,
                                  idmMysteryTraderEyesCaptainSuspiciouslySuggestsHe,
                                  lpfl->id | 0x8000,lpfl->id,0);
              }
            }
          }
        }
        lpplMac._2_2_ = lpPlanets._2_2_;
        local_4e = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
        lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
        lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
        while ((PLANET *)lppl < (PLANET *)lpplMac) {
          uVar23 = (undefined2)((ulong)lppl >> 0x10);
          if ((((((PLANET *)lppl)->iPlayer != -1) && ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0))
              && ((*(uint *)((int)&rgplr[0].wMdPlr + ((PLANET *)lppl)->iPlayer * 0xc0) >>
                   9 & 1) != 0)) &&
             ((1 < (*(uint *)((int)&rgplr[0].wMdPlr + ((PLANET *)lppl)->iPlayer * 0xc0) >>
                    10 & 7) &&
              ((1 << ((byte)((PLANET *)lppl)->iPlayer & 0x1f) &
               *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 6)) == 0)))) {
            dx._0_2_ = ((POINT *)rgptPlan + lppl->id)->x - iVar6;
            dx._2_2_ = (int)(uint)dx >> 0xf;
            if ((-1 < dx._2_2_) && ((0 < dx._2_2_ || (100 < (uint)dx)))) break;
            dy._0_2_ = *(int *)((int)&rgptPlan[0].y + lppl->id * 4) - iVar7;
            dy._2_2_ = (int)dy >> 0xf;
            pPVar28 = (PLANET *)__aFulmul((long)(int)dy,(long)(int)dy);
            local_4e = pPVar28;
            uVar29 = __aFulmul(CONCAT22(dx._2_2_,(uint)dx),CONCAT22(dx._2_2_,(uint)dx));
            l = (long)(local_4e->rgpctMinLevel + (uVar29 - 6));
            if (l < 0x2711) {
              wtNext._0_2_ = 0;
              wtNext._2_2_ = 0;
              i = 0;
              while( true ) {
                if (2 < i) break;
                uVar10 = *(uint *)(((PLANET *)lppl)->rgwtMin + i);
                bVar25 = CARRY2((uint)wtNext,uVar10);
                wtNext._0_2_ = (uint)wtNext + uVar10;
                wtNext._2_2_ = wtNext._2_2_ + *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) +
                               (uint)bVar25;
                i = i + 1;
              }
              iVar14 = ((PLANET *)lppl)->iPlayer;
              if ((*(uint *)((int)&rgplr[0].wMdPlr + iVar14 * 0xc0) >> 10 & 7) == 2) {
                uVar10 = 0xdac;
              }
              else {
                uVar10 = 5000;
              }
              if ((0 < (int)wtNext._2_2_) || ((-1 < (int)wtNext._2_2_ && (uVar10 <= (uint)wtNext))))
              {
                uVar23 = (undefined2)((ulong)lpth >> 0x10);
                if (*(int *)((int)&((THING *)lpth)->u_THING_0x0006 + 8) == 0) {
THING_LAutoTech:
                  local_4e._2_2_ = 0;
                  for (i = 0; i < 6; i = i + 1) {
                    local_4e._2_2_ = local_4e._2_2_ + (int)*(char *)(iVar14 * 0xc0 + 0x59bc + i);
                  }
                  if ((*(uint *)((int)&rgplr[0].wFlags + ((FLEET *)lpfl)->iPlayer * 0xc0)
                       >> 1 & 1) == 0) {
                    cPlrTrueMaxTech = 0x1a;
                  }
                  else {
                    cPlrTrueMaxTech = 10;
                  }
                  if (cPlrTrueMaxTech * 6 + -6 <= (int)local_4e._2_2_) goto LAB_1110_1a6b;
                  for (local_4e._0_2_ = (PLANET *)0x0; (int)(PLANET *)local_4e < 6;
                      local_4e._0_2_ = (PLANET *)((int)&((PLANET *)local_4e)->id + 1)) {
                    local_4e._2_2_ = 0;
                    for (i = 1; i < 6; i = i + 1) {
                      local_50 = (int)*(char *)(iVar14 * 0xc0 + 0x59bc + i);
                      if (local_50 < *(char *)(iVar14 * 0xc0 + 0x59bc + local_4e._2_2_)) {
                        local_4e._2_2_ = i;
                      }
                    }
                    pcVar4 = (char *)(iVar14 * 0xc0 + 0x59bc + local_4e._2_2_);
                    *pcVar4 = *pcVar4 + '\x01';
                  }
                  wtNext._2_2_ = 0;
                  wtNext._0_2_ = uVar10;
                }
                else {
                  local_4e._0_2_ = (PLANET *)(rgcrPlrHistory + 1);
                  local_4e._2_2_ = *(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 8);
                  while (((local_4e._2_2_ &
                          *(uint *)((int)&rgplr[0].grbitTrader + iVar14 * 0xc0)) != 0 &&
                         (pPVar30 = (PLANET *)((int)&((PLANET *)local_4e)[-1].lpplprod + 3),
                         bVar25 = 0 < (int)(PLANET *)local_4e, local_4e._0_2_ = pPVar30, bVar25))) {
                    sVar11 = Random(0xd);
                    local_4e._2_2_ = 1 << ((byte)sVar11 & 0x1f);
                  }
                  if ((int)(PLANET *)local_4e < 1) goto THING_LAutoTech;
                  puVar3 = (uint *)((int)&rgplr[0].grbitTrader + iVar14 * 0xc0);
                  *puVar3 = *puVar3 | local_4e._2_2_;
                }
                puVar3 = (uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
                *puVar3 = *puVar3 | 1 << ((byte)iVar14 & 0x1f);
                for (i = 2; (-1 < (int)wtNext._2_2_ &&
                            (((0 < (int)wtNext._2_2_ || ((uint)wtNext != 0)) && (-1 < i))));
                    i = i + -1) {
                  uVar10 = *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                  if (((int)uVar10 < (int)wtNext._2_2_) ||
                     ((uVar12 = (uint)wtNext, uVar17 = wtNext._2_2_,
                      (int)uVar10 <= (int)wtNext._2_2_ &&
                      (*(uint *)(((PLANET *)lppl)->rgwtMin + i) <= (uint)wtNext)))) {
                    uVar12 = *(uint *)(((PLANET *)lppl)->rgwtMin + i);
                    uVar17 = *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                  }
                  puVar3 = (uint *)(((PLANET *)lppl)->rgwtMin + i);
                  uVar10 = *puVar3;
                  *puVar3 = *puVar3 - uVar12;
                  puVar3 = (uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                  *puVar3 = (*puVar3 - uVar17) - (uint)(uVar10 < uVar12);
                  bVar25 = (uint)wtNext < uVar12;
                  wtNext._0_2_ = (uint)wtNext - uVar12;
                  wtNext._2_2_ = (wtNext._2_2_ - uVar17) - (uint)bVar25;
                }
              }
            }
          }
LAB_1110_1a6b:
          lppl = (PLANET *)lppl + 1;
        }
      }
      lpth = (THING *)lpth + 1;
    }
  }
  return;
}



// ======================================================================
// Function: IdmGiveTraderPart
// Address: 1110:1a96
// Segment: MEMORY_THING
// ======================================================================


short IdmGiveTraderPart(ushort grbitTrader,short iplr,ushort *piGoto)

{
  uint *puVar1;
  short idm;
  ushort iGoto;
  
  puVar1 = (uint *)((int)&rgplr[0].grbitTrader + iplr * 0xc0);
  *puVar1 = *puVar1 | grbitTrader;
  idm = 0x10b;
  if (grbitTrader != 1) {
    if (grbitTrader == 2) {
      iGoto = 0xcb04;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 4) {
      iGoto = 0xc206;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 8) {
      iGoto = 0xc309;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x10) {
      iGoto = 0xc706;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x20) {
      iGoto = 0xc608;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x40) {
      iGoto = 0xc507;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x80) {
      iGoto = 0xc412;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x100) {
      idm = 0x10c;
      iGoto = 0xce1e;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x200) {
      iGoto = 0xc008;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x400) {
      idm = 0x10f;
      iGoto = 0xcf0e;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x800) {
      iGoto = 0xcc09;
      goto LAB_1110_1b8b;
    }
  }
  iGoto = 0xcc04;
LAB_1110_1b8b:
  *piGoto = iGoto;
  return idm;
}



