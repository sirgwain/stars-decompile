// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: LpthNew
// Address: 1110:0000
// Segment: MEMORY_THING
// ======================================================================


THING * LpthNew(short iplr,ThingType ith)

{
  undefined2 unaff_SS;
  THING *pTVar1;
  uint thNew [9];
  THING *lpth;
  short i;
  short iItem;
  
                    /* Segment:    35
                       Offset:     000f8f00
                       Length:     1b9f
                       Min Alloc:  1b9f
                       Flags:      1d50
                           Code
                           Discardable
                           Moveable
                           Preload
                           Impure (Non-shareable)
                        */
  if (cThing < 0xfd2) {
    _memset(thNew,0,0x12);
    thNew[0] = thNew[0] & 0x1ff | (iplr & 0xfU) << 9 | ith << 0xd;
    i = 0;
    lpth = lpThings;
    while ((i < cThing && ((uint)lpth->idFull < thNew[0]))) {
      i = i + 1;
      lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
    }
    if ((i < cThing) && (thNew[0] == lpth->idFull)) {
      iItem = lpth->idFull & 0x1ff;
      for (; i < cThing; i = i + 1) {
        if (0x1fe < iItem) {
          lpth._0_2_ = (THING *)0x0;
          lpth._2_2_ = 0;
          pTVar1 = lpThings;
          goto LAB_1110_021d;
        }
        if (lpth->idFull != thNew[0]) break;
        thNew[0] = thNew[0] & 0xfe00 | thNew[0] + 1 & 0x1ff;
        lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
        iItem = iItem + 1;
      }
    }
    if (cThingAlloc <= cThing) {
      cThingAlloc = cThingAlloc + 10;
      if (lpThings == (THING *)0x0) {
        pTVar1 = LpAlloc(cThingAlloc * 0x12,htThings);
      }
      else {
        pTVar1 = LpReAlloc(lpThings,cThingAlloc * 0x12,htThings);
      }
      lpThings._2_2_ = (undefined2)((ulong)pTVar1 >> 0x10);
      lpThings._0_2_ = (THING *)pTVar1;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings + i);
      lpThings = pTVar1;
    }
    if (i < cThing) {
      __fmemmove((THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1),lpth,
                         (cThing - i) * 0x12);
    }
    cThing = cThing + 1;
    __fmemcpy(lpth,(uint *)thNew,0x12);
    pTVar1 = lpThings;
  }
  else {
    lpth._0_2_ = (THING *)0x0;
    lpth._2_2_ = 0;
    pTVar1 = lpThings;
  }
LAB_1110_021d:
  lpThings._2_2_ = (undefined2)((ulong)pTVar1 >> 0x10);
  lpThings._0_2_ = (THING *)pTVar1;
  return (THING *)CONCAT22(lpth._2_2_,(THING *)lpth);
}



// ======================================================================
// Function: FreeLpth
// Address: 1110:0224
// Segment: MEMORY_THING
// ======================================================================


void FreeLpth(THING *lpth)

{
  if ((THING *)lpth < (THING *)lpThings + cThing + -1) {
    __fmemmove(lpth,(THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1),
                       ((cThing - ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12
                        ) + -1) * 0x12);
  }
  cThing = cThing + -1;
  return;
}



// ======================================================================
// Function: CPlanetsInCircle
// Address: 1110:02a0
// Segment: MEMORY_THING
// ======================================================================


short CPlanetsInCircle(POINT pt,long r2)

{
  int iVar1;
  int iVar2;
  POINT *pPVar3;
  int iVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar5;
  ulong uVar6;
  ulong uVar7;
  undefined2 in_stack_0000ffe2;
  undefined2 in_stack_0000ffe4;
  short xEnd;
  short dx;
  short cPl;
  short r;
  short i;
  short yStart;
  short dy;
  short yEnd;
  POINT *ppt;
  short xStart;
  
  _sqrt(SUB84((double)r2,0),
                (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)r2 >> 0x20))));
  lVar5 = __ftol((double)CONCAT26(in_stack_0000ffe4,
                                          CONCAT24(in_stack_0000ffe2,CONCAT22(unaff_SI,unaff_DI))));
  iVar1 = (int)lVar5;
  cPl = 0;
  pPVar3 = (POINT *)rgptPlan + game.cPlanMax;
  iVar2 = ((POINT *)rgptPlan + game.cPlanMax + -1)->x - rgptPlan[0].x;
  iVar4 = iVar2 >> 0xf;
  uVar6 = __aFulmul((long)(pt.x - rgptPlan[0].x),(long)game.cPlanMax);
  lVar5 = __aFldiv(uVar6,CONCAT22(iVar4,iVar2));
  i = (short)lVar5;
  if (game.cPlanMax <= i) {
    i = game.cPlanMax + -1;
  }
  if (i < 0) {
    i = 0;
  }
  for (ppt = (POINT *)rgptPlan + i;
      (pt.x - iVar1 <= ppt->x && ((POINT *)((int)&rgptPlan[0].x + 1) <= ppt));
      ppt = ppt + -1) {
  }
  for (; (ppt->x <= pt.x + iVar1 && (ppt < pPVar3)); ppt = ppt + 1) {
    if (((pt.x - iVar1 <= ppt->x) && (pt.y - iVar1 <= ppt->y)) && (ppt->y <= pt.y + iVar1)) {
      iVar2 = ppt->x - pt.x;
      iVar4 = ppt->y - pt.y;
      uVar6 = __aFulmul((long)iVar4,(long)iVar4);
      uVar7 = __aFulmul((long)iVar2,(long)iVar2);
      iVar2 = (int)(uVar7 + uVar6 >> 0x10);
      if ((iVar2 <= r2._2_2_) && ((iVar2 < r2._2_2_ || ((uint)(uVar7 + uVar6) <= (uint)r2)))) {
        cPl = cPl + 1;
      }
    }
  }
  return cPl;
}



// ======================================================================
// Function: DrawThingGauge
// Address: 1110:044e
// Segment: MEMORY_THING
// ======================================================================


void DrawThingGauge(HDC hdc,RECT *prc,THING *lpth,short md)

{
  int iVar1;
  THING *pTVar2;
  int iVar3;
  undefined2 uVar4;
  ulong cTot;
  long lVar5;
  DWORD DVar6;
  undefined4 rgSize;
  short i;
  short c;
  ushort rghbr [5];
  short fDisabled;
  short cSections;
  short iMode;
  
  fDisabled = 0;
  SelectObject(hdc,rghfontArial8[1]);
  cSections = 1;
  uVar4 = (undefined2)((ulong)lpth >> 0x10);
  pTVar2 = (THING *)lpth;
  cTot = __aFulmul((ulong)*(uint *)(pTVar2->rgb + 8) & 0xffff3fff,10);
  if ((md < 0) || (4 < md)) {
    if (md == 5) {
      for (i = 0; i < 3; i = i + 1) {
        rghbr[i] = ((ushort *)rghbrMineral)[i];
        iVar1 = *(int *)(pTVar2->rgb + i * 2 + 2);
        iVar3 = i * 4;
        *(int *)(&rgSize + i) = iVar1;
        *(int *)((int)&rgSize + iVar3 + 2) = iVar1 >> 0xf;
      }
      cSections = 3;
      rgSize = CONCAT22(rgSize._2_2_,(undefined2)rgSize);
    }
  }
  else if ((md == 4) || (md == 3)) {
    rghbr[0] = hbrButtonShadow;
    fDisabled = 1;
    rgSize = cTot;
  }
  else {
    rghbr[0] = ((ushort *)rghbrMineral)[md];
    rgSize = (ulong)*(int *)(pTVar2->rgb + md * 2 + 2);
  }
  lVar5 = LDrawGauge(hdc,prc,cSections,&rgSize,rghbr,cTot);
  iMode = SetBkMode(hdc,1);
  if (fDisabled != 0) {
    lVar5 = 0;
  }
  uVar4 = (undefined2)((ulong)lVar5 >> 0x10);
  if (cSections == 1) {
    c = wsprintf(szWork,s__ldkT_1120_16a0,(int)lVar5,uVar4);
  }
  else {
    c = wsprintf(szWork,s__ld_of__ldkT_1120_16a6,(int)lVar5,uVar4,(int)cTot,
                 (int)(cTot >> 0x10));
  }
  DVar6 = GetTextExtent(hdc,szWork,c);
  if ((int)DVar6 < (prc->right - prc->left) + -3) {
    RcCtrTextOut(hdc,prc,(char *)szWork,c);
  }
  SetBkMode(hdc,iMode);
  return;
}



// ======================================================================
// Function: IValidateWormholePos
// Address: 1110:064c
// Segment: MEMORY_THING
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x11100a9a) */
/* WARNING: Removing unreachable block (ram,0x11100a64) */
/* WARNING: Removing unreachable block (ram,0x11100994) */
/* WARNING: Removing unreachable block (ram,0x1110095e) */
/* WARNING: Removing unreachable block (ram,0x1110091a) */
/* WARNING: Removing unreachable block (ram,0x111008e4) */
/* WARNING: Removing unreachable block (ram,0x111008fc) */
/* WARNING: Removing unreachable block (ram,0x11100938) */
/* WARNING: Removing unreachable block (ram,0x11100976) */
/* WARNING: Removing unreachable block (ram,0x111009b2) */
/* WARNING: Removing unreachable block (ram,0x11100a7c) */
/* WARNING: Removing unreachable block (ram,0x11100ab8) */

short IValidateWormholePos(THING *lpthWorm)

{
  int iVar1;
  int iVar2;
  int iVar3;
  long lVar4;
  int iVar5;
  int iVar6;
  THING *pTVar7;
  THING *pTVar8;
  undefined2 uVar9;
  undefined2 uVar10;
  ulong uVar11;
  ulong uVar12;
  short dUni;
  THING *lpth;
  short i;
  short ifl;
  FLEET *lpfl;
  short iRet;
  
  iRet = 0;
  iVar5 = game.mdSize * 400;
  uVar9 = (undefined2)((ulong)lpthWorm >> 0x10);
  pTVar8 = (THING *)lpthWorm;
  iVar1 = (&pTVar8->pt)->x;
  iVar2 = (pTVar8->pt).y;
  if ((iVar1 < 1000) || (iVar2 < 1000)) {
    iRet = 0xf;
  }
  else if ((iVar5 + 0x578 < iVar1) || (iVar5 + 0x578 < iVar2)) {
    iRet = 0xf;
  }
  else {
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < (THING *)lpThings + cThing) {
      uVar10 = (undefined2)((ulong)lpth >> 0x10);
      if (((iVar1 == (&((THING *)lpth)->pt)->x) && (iVar2 == (((THING *)lpth)->pt).y)) &&
         (lpthWorm != lpth)) {
        return 0xf;
      }
      lpth = (THING *)CONCAT22(uVar10,(THING *)lpth + 1);
    }
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      if ((iVar1 == ((POINT *)rgptPlan + i)->x) &&
         (iVar2 == *(int *)((int)&rgptPlan[0].y + i * 4))) {
        return 0xf;
      }
    }
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
      iVar6 = *(int *)((FLEET **)rglpfl + ifl);
      iVar3 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      if ((iVar6 == 0) && (iVar3 == 0)) break;
      if ((iVar1 == *(int *)(iVar6 + 8)) && (iVar2 == *(int *)(iVar6 + 10))) {
        return 0xf;
      }
    }
    if ((((iVar1 < 0x3f2) || (iVar2 < 0x3f2)) || (iVar5 + 0x56e < iVar1)) || (iVar5 + 0x56e < iVar2)
       ) {
      iRet = 4;
    }
    pTVar7 = (THING *)lpThings + cThing;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < pTVar7) {
      uVar10 = (undefined2)((ulong)lpth >> 0x10);
      if (((uint)lpth->idFull >> 0xd == 2) && (lpthWorm != lpth)) {
        iVar5 = iVar1 - (&((THING *)lpth)->pt)->x;
        iVar6 = iVar2 - (((THING *)lpth)->pt).y;
        uVar11 = __aFulmul((long)iVar6,(long)iVar6);
        uVar12 = __aFulmul((long)iVar5,(long)iVar5);
        lVar4 = uVar12 + uVar11;
        if (lpth->idFull == *(int *)(pTVar8->rgb + 6)) {
          if (lVar4 < 0x1324) {
            if (lVar4 < 0x19) {
              iRet = iRet | 8;
            }
            else if (lVar4 < 100) {
              iRet = iRet | 4;
            }
            else if (lVar4 < 900) {
              iRet = iRet | 2;
            }
            else {
              iRet = iRet | 1;
            }
          }
        }
        else if (lVar4 < 900) {
          if (lVar4 < 0x10) {
            iRet = iRet | 8;
          }
          else if (lVar4 < 0x40) {
            iRet = iRet | 4;
          }
          else if (lVar4 < 0xe1) {
            iRet = iRet | 2;
          }
          else {
            iRet = iRet | 1;
          }
        }
      }
      lpth = (THING *)CONCAT22(uVar10,(THING *)lpth + 1);
    }
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      iVar5 = iVar1 - ((POINT *)rgptPlan + i)->x;
      iVar6 = iVar2 - *(int *)((int)&rgptPlan[0].y + i * 4);
      uVar11 = __aFulmul((long)iVar6,(long)iVar6);
      uVar12 = __aFulmul((long)iVar5,(long)iVar5);
      lVar4 = uVar12 + uVar11;
      if (lVar4 < 0x310) {
        if (lVar4 < 0x19) {
          iRet = iRet | 8;
        }
        else if (lVar4 < 100) {
          iRet = iRet | 4;
        }
        else if (lVar4 < 400) {
          iRet = iRet | 2;
        }
        else {
          iRet = iRet | 1;
        }
      }
    }
  }
  return iRet;
}



// ======================================================================
// Function: PctWormholeMoves
// Address: 1110:0adc
// Segment: MEMORY_THING
// ======================================================================


short PctWormholeMoves(THING *lpth)

{
  undefined2 uVar1;
  short pct;
  
  uVar1 = (undefined2)((ulong)lpth >> 0x10);
  pct = (*(uint *)((THING *)lpth)->rgb >> 2 & 0x3ff) / 5 - (2 - (*(uint *)((THING *)lpth)->rgb & 3))
  ;
  if (pct < 0) {
    pct = 0;
  }
  else if (6 < pct) {
    pct = 6;
  }
  return pct;
}



// ======================================================================
// Function: DoThingInteractions
// Address: 1110:0b3a
// Segment: MEMORY_THING
// ======================================================================


/* WARNING: Variable defined which should be unmapped: cGive */
/* WARNING: Removing unreachable block (ram,0x11101776) */
/* WARNING: Removing unreachable block (ram,0x11100ed1) */
/* WARNING: Removing unreachable block (ram,0x11101129) */
/* WARNING: Type propagation algorithm not settling */

void DoThingInteractions(short fPostMove)

{
  uint *puVar1;
  long *plVar2;
  int *piVar3;
  char *pcVar4;
  undefined *puVar5;
  HUL *pHVar6;
  FLEET *pFVar7;
  uint uVar8;
  ushort uVar9;
  short sVar10;
  int iVar11;
  SHDEF *pSVar12;
  int iVar13;
  undefined2 *puVar14;
  FLEET *pFVar15;
  PLORD *pPVar16;
  undefined2 unaff_SI;
  HUL *pHVar17;
  undefined2 unaff_DI;
  SHDEF *pSVar18;
  undefined2 uVar19;
  undefined2 uVar20;
  undefined2 unaff_SS;
  bool bVar21;
  long lVar22;
  undefined *puVar23;
  SHDEF *pSVar24;
  FLEET *lpfl_00;
  PLANET *pPVar25;
  ulong uVar26;
  PLANET *pPVar27;
  short p4;
  short p5;
  short p6;
  short p7;
  long lVar28;
  short cGive;
  FLEET *lpflNew;
  SHDEF *lpshdefDest;
  HUL shdef;
  undefined4 local_5a;
  undefined2 lSpent;
  short ish;
  short cTechCur;
  short iLowest;
  PLANET *cTech;
  short iGoto;
  undefined4 l;
  short fMaxTech;
  uint dx;
  int local_42;
  short cPlrTrueMaxTech;
  short idm;
  THING *lpth;
  FLEET *lpfl;
  short ifl;
  short i;
  PLANET *lppl;
  PLANET *lpplMac;
  short local_2a;
  THING *lpthMac;
  short local_26;
  int dy;
  int local_22;
  undefined4 wtNext;
  char rgTech [6];
  short iplrSav;
  int pt;
  int local_12;
  undefined *wtMin;
  int local_e;
  short iplr;
  ushort grbitPlrTrader;
  undefined *wtThreshhold;
  int local_6;
  
  lVar28 = CONCAT22(unaff_SI,unaff_DI);
  if (fPostMove != 0) {
    cTech = (PLANET *)(THING *)lpThings;
    iGoto = lpThings._2_2_;
    lpthMac = (THING *)lpThings + cThing;
    local_26 = lpThings._2_2_;
    lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
    while ((THING *)lpth < lpthMac) {
      if ((uint)lpth->idFull >> 0xd == 3) {
        uVar19 = (undefined2)((ulong)lpth >> 0x10);
        pt = (&((THING *)lpth)->pt)->x;
        local_12 = (((THING *)lpth)->pt).y;
        for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar7 = ((FLEET **)rglpfl)[ifl];
          iVar11 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
          lpfl = (FLEET *)CONCAT22(iVar11,pFVar7);
          if ((pFVar7 == (FLEET *)0x0) && (iVar11 == 0)) break;
          if ((((uint)pFVar7->wFlags >> 10 & 1) == 0) &&
             (((&pFVar7->pt)->x == pt && ((pFVar7->pt).y == local_12)))) {
            wtMin = (undefined *)0x0;
            local_e = 0;
            for (i = 0; i < 3; i = i + 1) {
              uVar8 = *(uint *)(pFVar7->rgwtMin + i);
              bVar21 = CARRY2((uint)wtMin,uVar8);
              wtMin = wtMin + uVar8;
              local_e = local_e + *(uint *)((int)(pFVar7->rgwtMin + i) + 2) + (uint)bVar21;
            }
            if ((local_e < 1) && ((local_e < 0 || (wtMin < DAT_1120_1388)))) {
              if (((uint)pFVar7->wFlags >> 0xd & 1) == 0) {
                FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,
                                  idmMysteryTraderHasRefusedGiveCaptainAudience,lpfl->id | 0x8000,
                                  lpfl->id,0);
              }
            }
            else {
              if ((*(uint *)((int)&rgplr[0].wFlags + pFVar7->iPlayer * 0xc0) >> 1 & 1) ==
                  0) {
                cPlrTrueMaxTech = 0x1a;
              }
              else {
                cPlrTrueMaxTech = 10;
              }
              i = 0;
              while ((i < 6 && (cPlrTrueMaxTech <= *(char *)(pFVar7->iPlayer * 0xc0 + 0x59bc + i))))
              {
                i = i + 1;
              }
              fMaxTech = (short)(i == 6);
              grbitPlrTrader =
                   *(ushort *)((int)&rgplr[0].grbitTrader + pFVar7->iPlayer * 0xc0);
              iplr = pFVar7->iPlayer;
              uVar19 = (undefined2)((ulong)lpth >> 0x10);
              if ((1 << ((byte)iplr & 0x1f) & *(uint *)(((THING *)lpth)->rgb + 6)) == 0) {
                puVar1 = (uint *)(((THING *)lpth)->rgb + 6);
                *puVar1 = *puVar1 | 1 << ((byte)iplr & 0x1f);
                FRemovePlayerMessage(iplr,idmHasCompletedAssignedOrders,lpfl->id | 0x8000);
                uVar19 = (undefined2)((ulong)lpfl >> 0x10);
                ((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0xfbffU | 0x400;
                uVar19 = (undefined2)((ulong)lpth >> 0x10);
                if ((*(int *)(((THING *)lpth)->rgb + 8) == 0) ||
                   ((*(uint *)(((THING *)lpth)->rgb + 8) & grbitPlrTrader) != 0)) {
                  if (fMaxTech == 0) {
                    cTechCur = 0;
                    lVar22 = __aFldiv((long)CONCAT22(local_e + -1 +
                                                             (uint)((undefined *)0x1387 < wtMin),
                                                             wtMin + -5000),0x4b0);
                    pPVar25 = (PLANET *)(lVar22 + 6);
                    i = 0;
                    while( true ) {
                      if (5 < i) break;
                      cTechCur = cTechCur + *(char *)(((FLEET *)lpfl)->iPlayer * 0xc0 + 0x59bc + i);
                      i = i + 1;
                    }
                    if (10 < (long)pPVar25) {
                      pPVar25 = (PLANET *)0xa;
                    }
                    iGoto = (short)((ulong)pPVar25 >> 0x10);
                    cTech = (PLANET *)pPVar25;
                    if (cTechCur < 0x6c) {
                      if (cTechCur < 0x60) {
                        if (cTechCur < 0x54) {
                          if (cTechCur < 0x48) {
                            if (0x3b < cTechCur) {
                              pPVar25 = (PLANET *)
                                        CONCAT22(iGoto - (uint)(cTech == (PLANET *)0x0),
                                                 (PLANET *)((int)&cTech[-1].lpplprod + 3));
                            }
                          }
                          else {
                            pPVar25 = (PLANET *)
                                      CONCAT22(iGoto - (uint)(cTech < (PLANET *)0x2),
                                               (PLANET *)((int)&cTech[-1].lpplprod + 2));
                          }
                        }
                        else {
                          pPVar25 = (PLANET *)
                                    CONCAT22(iGoto - (uint)(cTech < (PLANET *)0x3),
                                             (PLANET *)((int)&cTech[-1].lpplprod + 1));
                        }
                      }
                      else {
                        pPVar25 = (PLANET *)0x2;
                      }
                    }
                    else {
                      pPVar25 = (PLANET *)0x1;
                    }
                    iGoto = (short)((ulong)pPVar25 >> 0x10);
                    cTech = (PLANET *)pPVar25;
                    if ((grbitPlrTrader & 0x1fff) == 0x1fff) {
                      idm = 0x10a;
                    }
                    else {
                      idm = 0x109;
                    }
                    p7 = 0;
                    p6 = 0;
                    p5 = 0;
                    p4 = 0;
                    sVar10 = 0;
                    pPVar27 = cTech;
                    uVar9 = WFromLpfl(lpfl);
                    FSendPlrMsg((uint)lpfl->id >> 9 & 0xf,idm,-1,uVar9,(short)pPVar27,sVar10,p4
                                     ,p5,p6,p7);
                    while( true ) {
                      pPVar27 = (PLANET *)((int)&cTech[-1].lpplprod + 3);
                      iVar11 = iGoto - (uint)(cTech == (PLANET *)0x0);
                      if ((cTech == (PLANET *)0x0) &&
                         (bVar21 = iGoto == 0, cTech = pPVar27, iGoto = iVar11, bVar21)) break;
                      cTech = pPVar27;
                      iGoto = iVar11;
                      sVar10 = Random(4);
                      lVar22 = local_5a;
                      if (sVar10 < 3) {
                        iLowest = Random(6);
                        lVar22 = local_5a;
                        if (cPlrTrueMaxTech <= *(char *)(iplr * 0xc0 + 0x59bc + iLowest))
                        goto LAB_1110_1010;
                      }
                      else {
LAB_1110_1010:
                        local_5a._2_2_ = (int)((ulong)lVar22 >> 0x10);
                        local_5a._0_2_ = (undefined2)lVar22;
                        iLowest = 0;
                        i = 1;
                        while( true ) {
                          lVar22 = CONCAT22(local_5a._2_2_,(undefined2)local_5a);
                          if (5 < i) break;
                          local_5a._2_2_ = (int)*(char *)(iplr * 0xc0 + 0x59bc + i);
                          if (local_5a._2_2_ < *(char *)(iplr * 0xc0 + 0x59bc + iLowest)) {
                            iLowest = i;
                          }
                          i = i + 1;
                        }
                        if (cPlrTrueMaxTech <= *(char *)(iplr * 0xc0 + 0x59bc + iLowest)) break;
                      }
                      local_5a = lVar22;
                      _memcpy(rgTech,(void *)((int)rgplr[0].rgTech + iplr * 0xc0),
                                      6);
                      rgTech[iLowest] = rgTech[iLowest] + '\x01';
                      iplrSav = idPlayer;
                      idPlayer = iplr;
                      puVar23 = (undefined *)CostOfDevelopingItem((char *)rgTech);
                      idPlayer = iplrSav;
                      puVar14 = (undefined2 *)(iplr * 0xc0 + 0x59c2 + iLowest * 4);
                      lSpent = *puVar14;
                      ish = puVar14[1];
                      wtNext = puVar23;
                      lVar22 = __aFlshl(lVar28,cGive);
                      if (0 < (long)wtNext) {
                        lVar22 = lVar22 + (long)wtNext;
                      }
                      ish = (short)((ulong)lVar22 >> 0x10);
                      lSpent = (undefined2)lVar22;
                      puVar14 = (undefined2 *)(iplr * 0xc0 + 0x59c2 + iLowest * 4);
                      *puVar14 = lSpent;
                      puVar14[1] = ish;
                      local_5a = lVar22;
                      UpdateResearchStatus(0);
                    }
                  }
                  else {
                    sVar10 = Random(5);
                    if (sVar10 != 0) goto THING_LGivePart;
                    idm = 0x10e;
                    sVar10 = 0;
                    uVar9 = WFromLpfl(lpfl);
                    FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,idm,-1,uVar9,sVar10);
                  }
                }
                else {
THING_LGivePart:
                  iLowest = 0x19;
                  cTech = *(PLANET **)(((THING *)lpth)->rgb + 8);
                  if (cTech == (PLANET *)0x0) {
                    sVar10 = Random(0xd);
                    cTech = (PLANET *)(1 << ((byte)sVar10 & 0x1f));
                  }
                  while ((((uint)cTech & grbitPlrTrader) != 0 &&
                         (iVar11 = iLowest + -1, bVar21 = 0 < iLowest, iLowest = iVar11, bVar21))) {
                    sVar10 = Random(0xd);
                    cTech = (PLANET *)(1 << ((byte)sVar10 & 0x1f));
                  }
                  if (iLowest < 1) {
                    cTech = (PLANET *)(PLANET *)&DAT_1120_1000;
                  }
                  puVar1 = (uint *)(((THING *)lpth)->rgb + 6);
                  *puVar1 = *puVar1 | 1 << ((byte)iplr & 0x1f);
                  if (cTech == (PLANET *)(PLANET *)&DAT_1120_1000) {
                    if ((*(uint *)((int)&rgplr[0].wMdPlr + iplr * 0xc0) >> 9 & 1) == 0) {
                      cTechCur = Random(4 - (uint)(100 < (uint)game.turn));
                      if (0 < cTechCur) {
                        sVar10 = Random(2);
                        cTechCur = sVar10 + 1;
                      }
                      pSVar24 = LpshdefT();
                      uVar19 = (undefined2)((ulong)pSVar24 >> 0x10);
                      pSVar12 = (SHDEF *)pSVar24 + cTechCur + 0x13;
                      pHVar17 = &shdef;
                      for (iVar11 = 0x49; iVar11 != 0; iVar11 = iVar11 + -1) {
                        pHVar6 = pHVar17;
                        pHVar17 = (HUL *)pHVar17->rgTech;
                        pSVar24 = pSVar12;
                        pSVar12 = (SHDEF *)(pSVar12->hul).rgTech;
                        pHVar6->ihuldef = (pSVar24->hul).ihuldef;
                      }
                      *(char *)&pHVar17->ihuldef = (char)(pSVar12->hul).ihuldef;
                      ish = IshFindSimilarDesign((HUL *)&shdef,iplr);
                      if (ish < 0) {
                        do {
                          ish = ish + 1;
                          if (0xf < ish) break;
                        } while ((*(uint *)(*(int *)(iplr * 4 + 0xfe) + ish * 0x93 + 0x7b) >> 9 & 1)
                                 == 0);
                      }
                      if ((ish < 0x10) &&
                         ((*(uint *)((int)&rgplr[0].wFlags +
                                    ((uint)lpfl->id >> 9 & 0xf) * 0xc0) & 0xfff) < 0x200)) {
                        sVar10 = Random(3);
                        if (sVar10 == 0) {
                          cGive = 2;
                        }
                        else {
                          cGive = 1;
                        }
                        if ((100 < (uint)game.turn) &&
                           (((uint)game.wCrap >> 2 & 1) == 0)) {
                          sVar10 = Random((uint)game.turn / 100 + 1);
                          cGive = cGive + sVar10;
                        }
                        if (5 < cGive) {
                          cGive = 5;
                        }
                        if (0 < cTechCur) {
                          sVar10 = Random(cGive + 1);
                          cGive = cGive + sVar10;
                        }
                        lpfl_00 = LpflNew(iplr,((FLEET *)lpfl)->idPlanet);
                        iVar11 = (int)((ulong)lpfl_00 >> 0x10);
                        pFVar7 = (FLEET *)lpfl_00;
                        if ((pFVar7 != (FLEET *)0x0) || (iVar11 != 0)) {
                          sVar10 = cGive;
                          uVar9 = WFromLpfl(lpfl);
                          FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,
                                            idmHasAbsorbedMysteryTraderReturnHaveGiven3,
                                            lpfl_00->id | 0x8000,uVar9,sVar10);
                          if (lpfl_00->id < lpfl->id) {
                            ifl = ifl + 1;
                          }
                          uVar19 = (undefined2)((ulong)lpfl >> 0x10);
                          pFVar15 = (FLEET *)lpfl;
                          sVar10 = (pFVar15->pt).y;
                          (&pFVar7->pt)->x = (&pFVar15->pt)->x;
                          (pFVar7->pt).y = sVar10;
                          sVar10 = (pFVar15->pt).y;
                          uVar20 = (undefined2)((ulong)pFVar7->lpplord >> 0x10);
                          pPVar16 = (PLORD *)pFVar7->lpplord;
                          (pPVar16 + 1)->wFlags = (&pFVar15->pt)->x;
                          *(short *)&pPVar16[1].iordMax = sVar10;
                          pFVar7->wFlags = pFVar7->wFlags & 0xdfffU | 0x2000;
                          uVar19 = *(undefined2 *)(iplr * 4 + 0x100);
                          pSVar12 = (SHDEF *)(*(int *)(iplr * 4 + 0xfe) + ish * 0x93);
                          if (((uint)pSVar12->wFlags >> 9 & 1) != 0) {
                            pHVar17 = &shdef;
                            pSVar18 = pSVar12;
                            for (iVar13 = 0x49; iVar13 != 0; iVar13 = iVar13 + -1) {
                              pSVar24 = pSVar18;
                              pSVar18 = (SHDEF *)(pSVar18->hul).rgTech;
                              pHVar6 = pHVar17;
                              pHVar17 = (HUL *)pHVar17->rgTech;
                              (pSVar24->hul).ihuldef = pHVar6->ihuldef;
                            }
                            *(char *)&(pSVar18->hul).ihuldef = (char)pHVar17->ihuldef;
                            pSVar12->wFlags = pSVar12->wFlags & 0x83ffU | (ish & 0x1fU) << 10;
                            pSVar12->wFlags = pSVar12->wFlags & 0x7fffU | 0x8000;
                            *(undefined2 *)&pSVar12->cBuilt = 0;
                            *(undefined2 *)((int)&pSVar12->cBuilt + 2) = 0;
                            *(undefined2 *)&pSVar12->cExist = 0;
                            *(undefined2 *)((int)&pSVar12->cExist + 2) = 0;
                            pcVar4 = (char *)((int)&rgplr[0].cShDef + iplr * 0xc0);
                            *pcVar4 = *pcVar4 + '\x01';
                            idPlayer = (uint)lpfl->id >> 9 & 0xf;
                            UpdateShdefCost((SHDEF *)CONCAT22(uVar19,pSVar12));
                            idPlayer = -1;
                          }
                          puVar1 = (uint *)&pSVar12->cBuilt;
                          uVar8 = *puVar1;
                          *puVar1 = *puVar1 + cGive;
                          piVar3 = (int *)((int)&pSVar12->cBuilt + 2);
                          *piVar3 = *piVar3 + (cGive >> 0xf) + (uint)CARRY2(uVar8,cGive);
                          puVar1 = (uint *)&pSVar12->cExist;
                          uVar8 = *puVar1;
                          *puVar1 = *puVar1 + cGive;
                          piVar3 = (int *)((int)&pSVar12->cExist + 2);
                          *piVar3 = *piVar3 + (cGive >> 0xf) + (uint)CARRY2(uVar8,cGive);
                          pFVar7->rgcsh[ish] = cGive;
                          lVar22 = LGetFleetStat(lpfl_00,1);
                          *(int *)(pFVar7->rgwtMin + 4) = (int)lVar22;
                          *(undefined2 *)((int)pFVar7->rgwtMin + 0x12) =
                               (int)((ulong)lVar22 >> 0x10);
                          goto LAB_1110_0bac;
                        }
                      }
                      sVar10 = 0;
                      uVar9 = WFromLpfl(lpfl);
                      FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,
                                        idmHasAbsorbedMysteryTraderReturnTraderTried,-1,uVar9,sVar10
                                       );
                    }
                  }
                  else {
                    idm = IdmGiveTraderPart((ushort)cTech,iplr,(ushort *)&iGoto);
                    sVar10 = 0;
                    uVar9 = WFromLpfl(lpfl);
                    FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,idm,iGoto,uVar9,sVar10);
                  }
                }
              }
              else {
                FSendPlrMsg2((uint)lpfl->id >> 9 & 0xf,
                                  idmMysteryTraderEyesCaptainSuspiciouslySuggestsHe,
                                  lpfl->id | 0x8000,lpfl->id,0);
              }
            }
          }
LAB_1110_0bac:
        }
        cTech = (PLANET *)lpPlanets;
        iGoto = lpPlanets._2_2_;
        lpplMac = (PLANET *)lpPlanets + cPlanet;
        lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
        local_2a = iGoto;
        while ((PLANET *)lppl < lpplMac) {
          uVar19 = (undefined2)((ulong)lppl >> 0x10);
          if ((((((PLANET *)lppl)->iPlayer != -1) &&
               (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)) &&
              ((*(uint *)((int)&rgplr[0].wMdPlr + ((PLANET *)lppl)->iPlayer * 0xc0) >> 9 &
               1) != 0)) &&
             ((1 < (*(uint *)((int)&rgplr[0].wMdPlr + ((PLANET *)lppl)->iPlayer * 0xc0) >>
                    10 & 7) &&
              ((1 << ((byte)((PLANET *)lppl)->iPlayer & 0x1f) & *(uint *)(((THING *)lpth)->rgb + 6))
               == 0)))) {
            dx = ((POINT *)rgptPlan + lppl->id)->x - pt;
            local_42 = (int)dx >> 0xf;
            if ((-1 < local_42) && ((0 < local_42 || (100 < dx)))) break;
            dy = *(int *)((int)&rgptPlan[0].y + lppl->id * 4) - local_12;
            local_22 = dy >> 0xf;
            pPVar25 = (PLANET *)__aFulmul((long)dy,(long)dy);
            iGoto = (short)((ulong)pPVar25 >> 0x10);
            cTech = (PLANET *)pPVar25;
            uVar26 = __aFulmul(CONCAT22(local_42,dx),CONCAT22(local_42,dx));
            l = ((PLANET *)CONCAT22(iGoto,cTech))->rgpctMinLevel + (uVar26 - 6);
            if ((long)l < 0x2711) {
              wtNext._0_2_ = (undefined *)0x0;
              wtNext._2_2_ = 0;
              i = 0;
              while( true ) {
                if (2 < i) break;
                uVar8 = *(uint *)(((PLANET *)lppl)->rgwtMin + i);
                bVar21 = CARRY2((uint)(undefined *)wtNext,uVar8);
                wtNext._0_2_ = (undefined *)wtNext + uVar8;
                wtNext._2_2_ = wtNext._2_2_ + *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) +
                               (uint)bVar21;
                i = i + 1;
              }
              iplr = ((PLANET *)lppl)->iPlayer;
              if ((*(uint *)((int)&rgplr[0].wMdPlr + iplr * 0xc0) >> 10 & 7) == 2) {
                wtThreshhold = (undefined *)0xdac;
              }
              else {
                wtThreshhold = (undefined *)&DAT_1120_1388;
              }
              local_6 = 0;
              if ((0 < wtNext._2_2_) ||
                 ((-1 < wtNext._2_2_ && (wtThreshhold <= (undefined *)wtNext)))) {
                uVar19 = (undefined2)((ulong)lpth >> 0x10);
                if (*(int *)(((THING *)lpth)->rgb + 8) == 0) {
THING_LAutoTech:
                  iGoto = 0;
                  for (i = 0; i < 6; i = i + 1) {
                    iGoto = iGoto + *(char *)(iplr * 0xc0 + 0x59bc + i);
                  }
                  if ((*(uint *)((int)&rgplr[0].wFlags + ((FLEET *)lpfl)->iPlayer * 0xc0)
                       >> 1 & 1) == 0) {
                    cPlrTrueMaxTech = 0x1a;
                  }
                  else {
                    cPlrTrueMaxTech = 10;
                  }
                  if (cPlrTrueMaxTech * 6 + -6 <= iGoto) goto LAB_1110_1a6b;
                  for (cTech = (PLANET *)0x0; (int)cTech < 6;
                      cTech = (PLANET *)((int)&cTech->id + 1)) {
                    iGoto = 0;
                    for (i = 1; i < 6; i = i + 1) {
                      iLowest = (short)*(char *)(iplr * 0xc0 + 0x59bc + i);
                      if (iLowest < *(char *)(iplr * 0xc0 + 0x59bc + iGoto)) {
                        iGoto = i;
                      }
                    }
                    pcVar4 = (char *)(iplr * 0xc0 + 0x59bc + iGoto);
                    *pcVar4 = *pcVar4 + '\x01';
                  }
                  wtNext._0_2_ = wtThreshhold;
                  wtNext._2_2_ = local_6;
                }
                else {
                  cTech = (PLANET *)(PLANET *)(rgcrPlrHistory + 1);
                  iGoto = *(short *)(((THING *)lpth)->rgb + 8);
                  while (((iGoto & *(uint *)((int)&rgplr[0].grbitTrader + iplr * 0xc0)) !=
                          0 && (pPVar27 = (PLANET *)((int)&cTech[-1].lpplprod + 3),
                               bVar21 = 0 < (int)cTech, cTech = pPVar27, bVar21))) {
                    sVar10 = Random(0xd);
                    iGoto = 1 << ((byte)sVar10 & 0x1f);
                  }
                  if ((int)cTech < 1) goto THING_LAutoTech;
                  puVar1 = (uint *)((int)&rgplr[0].grbitTrader + iplr * 0xc0);
                  *puVar1 = *puVar1 | iGoto;
                }
                puVar1 = (uint *)(((THING *)lpth)->rgb + 6);
                *puVar1 = *puVar1 | 1 << ((byte)iplr & 0x1f);
                for (i = 2; (-1 < wtNext._2_2_ &&
                            (((0 < wtNext._2_2_ || ((undefined *)wtNext != (undefined *)0x0)) &&
                             (-1 < i)))); i = i + -1) {
                  iVar11 = *(int *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                  if ((iVar11 < wtNext._2_2_) ||
                     ((wtMin = (undefined *)wtNext, local_e = wtNext._2_2_, iVar11 <= wtNext._2_2_
                      && (*(undefined **)(((PLANET *)lppl)->rgwtMin + i) <= (undefined *)wtNext))))
                  {
                    wtMin = *(undefined **)(((PLANET *)lppl)->rgwtMin + i);
                    local_e = *(int *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                  }
                  plVar2 = ((PLANET *)lppl)->rgwtMin + i;
                  puVar5 = *(undefined **)plVar2;
                  *(int *)plVar2 = (int)*plVar2 - (int)wtMin;
                  piVar3 = (int *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                  *piVar3 = (*piVar3 - local_e) - (uint)(puVar5 < wtMin);
                  bVar21 = (undefined *)wtNext < wtMin;
                  wtNext._0_2_ = (undefined *)wtNext + -(int)wtMin;
                  wtNext._2_2_ = (wtNext._2_2_ - local_e) - (uint)bVar21;
                }
              }
            }
          }
LAB_1110_1a6b:
          lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
        }
      }
      lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
    }
  }
  return;
}



// ======================================================================
// Function: IdmGiveTraderPart
// Address: 1110:1a96
// Segment: MEMORY_THING
// ======================================================================


short IdmGiveTraderPart(ushort grbitTrader,short iplr,ushort *piGoto)

{
  uint *puVar1;
  short idm;
  ushort iGoto;
  
  puVar1 = (uint *)((int)&rgplr[0].grbitTrader + iplr * 0xc0);
  *puVar1 = *puVar1 | grbitTrader;
  idm = 0x10b;
  if (grbitTrader != 1) {
    if (grbitTrader == 2) {
      iGoto = 0xcb04;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 4) {
      iGoto = 0xc206;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 8) {
      iGoto = 0xc309;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x10) {
      iGoto = 0xc706;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x20) {
      iGoto = 0xc608;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x40) {
      iGoto = 0xc507;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x80) {
      iGoto = 0xc412;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x100) {
      idm = 0x10c;
      iGoto = 0xce1e;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x200) {
      iGoto = 0xc008;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x400) {
      idm = 0x10f;
      iGoto = 0xcf0e;
      goto LAB_1110_1b8b;
    }
    if (grbitTrader == 0x800) {
      iGoto = 0xcc09;
      goto LAB_1110_1b8b;
    }
  }
  iGoto = 0xcc04;
LAB_1110_1b8b:
  *piGoto = iGoto;
  return idm;
}



