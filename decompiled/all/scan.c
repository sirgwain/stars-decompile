// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: ScannerWndProc
// Address: 1058:0032
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x105809f8) */
/* WARNING: Removing unreachable block (ram,0x1058094a) */
/* WARNING: Removing unreachable block (ram,0x1058014f) */

long ScannerWndProc(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  int iVar1;
  int iVar2;
  FLEET *pFVar3;
  POINT pt_00;
  POINT pt_01;
  POINT ptIn;
  POINT pt_02;
  POINT pt_03;
  POINT pt_04;
  HDC HVar4;
  BOOL BVar5;
  short sVar6;
  uint uVar7;
  HCURSOR HVar8;
  GrobjClass grobj;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar9;
  undefined2 unaff_SS;
  bool bVar10;
  DWORD DVar11;
  ulong uVar12;
  LRESULT LVar13;
  short dy;
  ushort in_stack_0000fdda;
  short id;
  THING *lpthMac;
  short iSel;
  short iChecked;
  long rgid [100];
  short fSep;
  FLEET *lpfl;
  THING *lpth;
  short c;
  short i_2;
  SCAN scan;
  short fChgScan;
  short d;
  int iStack_68;
  undefined4 uStack_3e;
  int iStack_3a;
  short sStack_38;
  short dx;
  uint uStack_34;
  RECT rc;
  PAINTSTRUCT ps;
  POINT pt;
  HDC hdc;
  
  uVar12 = CONCAT22(unaff_SI,unaff_DI);
  if (msg == 1) {
    yScanTop = 1000;
    xScanTop = 1000;
    return 0;
  }
  if (msg == 5) {
    SetScanScrollBars(hwnd);
    PostMessage(hwndFrame,0x111,iScanZoom + 0xf41,0);
  }
  else {
    if (msg == 0xf) {
      HVar4 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
      if ((((FLEET **)rglpfl != (FLEET **)0x0) || (rglpfl._2_2_ != 0)) &&
         ((gd._4_2_ & 1) == 0)) {
        GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
        DrawScannerSBar(HVar4,&ps.rcPaint,(SBAR *)0x0,1);
        rc.bottom = rc.bottom - dySBar;
        DrawScanner(HVar4,&ps.rcPaint);
      }
      EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
      return 0;
    }
    if (msg != 0x20) {
      if (msg == 0x102) {
        if ((wParam == 0x76) || (wParam == 0x56)) {
          HVar4 = GetDC(hwndScanner);
          pt.x = sel.scan.pt.x;
          pt.y = sel.scan.pt.y;
          LogicalToScan(&pt);
          sStack_38 = SetROP2(HVar4,7);
          dx = SelectObject(HVar4,hpenYellow);
          for (iStack_3a = 0; iStack_3a < 2; iStack_3a = iStack_3a + 1) {
            MoveTo(HVar4,pt.x + -300,pt.y + -300);
            LineTo(HVar4,pt.x + 300,pt.y + 300);
            MoveTo(HVar4,pt.x + -300,pt.y + 300);
            LineTo(HVar4,pt.x + 300,pt.y + -300);
            if (iStack_3a == 0) {
              DVar11 = GetTickCount();
              uStack_3e = DVar11;
              while( true ) {
                DVar11 = GetTickCount();
                if (uStack_3e + 0x96 <= DVar11) break;
                Yield();
              }
            }
          }
          SelectObject(HVar4,dx);
          SetROP2(HVar4,sStack_38);
          ReleaseDC(hwndScanner,HVar4);
        }
        else {
          if (wParam == 0x2d) {
            uStack_34 = iScanZoom + -1;
            if ((int)uStack_34 < -4) {
              uStack_34 = -4;
            }
          }
          else {
            uStack_34 = iScanZoom + 1;
            if (4 < (int)uStack_34) {
              uStack_34 = 4;
            }
          }
          if (uStack_34 != iScanZoom) {
            SendMessage(hwndFrame,0x111,uStack_34 + 0xf41,0);
          }
        }
      }
      else if ((msg == 0x114) || (msg == 0x115)) {
        switch(wParam) {
        case 0:
          uStack_34 = -dScanInc;
          break;
        case 1:
          uStack_34 = dScanInc;
          break;
        case 2:
          uStack_34 = -dScanPage;
          break;
        case 3:
          uStack_34 = dScanPage;
          break;
        case 4:
        case 5:
          sVar6 = yScanTop;
          if (msg != 0x115) {
            sVar6 = xScanTop;
          }
          uStack_34 = (int)lParam - sVar6 & 0xfffc;
          break;
        default:
          uStack_34 = 0;
        }
        if (uStack_34 != 0) {
          if (msg == 0x115) {
            dx = yScanTop;
            SetScrollPos(hwnd,1,yScanTop + uStack_34,1);
            yScanTop = GetScrollPos(hwnd,1);
            sVar6 = PtToScan(dx - yScanTop);
            ScrollScanner(0,sVar6);
          }
          else {
            dx = xScanTop;
            SetScrollPos(hwnd,0,xScanTop + uStack_34,1);
            xScanTop = GetScrollPos(hwnd,0);
            dy = 0;
            sVar6 = PtToScan(dx - xScanTop);
            ScrollScanner(sVar6,dy);
          }
        }
      }
      else if ((((msg == 0x201) || (msg == 0x203)) || (msg == 0x204)) || (msg == 0x207)) {
        SetFocus(hwndFrame);
        pt.x = (int)lParam;
        uVar12 = __aFulshr(uVar12,in_stack_0000fdda);
        pt.y = (short)uVar12;
        GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
        if (pt.y < rc.bottom - dySBar) {
          ScanToLogical(&pt);
          if ((((uint)gd.wFlags >> 8 & 1) == 0) && (((uint)gd.wFlags >> 0xd & 1) == 0)
             ) {
            grobj = grobjThing|grobjOther|grobjFleet|grobjPlanet;
          }
          else {
            grobj = grobjPlanet;
          }
          pt_01.y = pt.y;
          pt_01.x = pt.x;
          FFindNearestObject(pt_01,grobj,&scan);
          if (((((uint)gd.wFlags >> 8 & 1) == 0) &&
              (((sel.grobj != grobjPlanet || ((wParam & 4) == 0)) ||
               (sVar6 = IWarpMAFromLppl(&sel.pl,(short *)0x0), sVar6 < 1)))) ||
             (msg != 0x201)) {
            if (((((uint)gd.wFlags >> 0xd & 1) == 0) &&
                ((sel.grobj != grobjPlanet || ((wParam & 8) == 0)))) || (msg != 0x201)) {
              if ((msg == 0x207) || ((msg == 0x204 && ((wParam & 4) != 0)))) {
                pt_03.y = pt.y;
                pt_03.x = pt.x;
                FHandleMeasuringTape(&scan,pt_03);
              }
              else {
                if (msg == 0x204) {
                  iChecked = -1;
                  pt.x = scan.pt.x;
                  pt.y = scan.pt.y;
                  if ((scan.grobjFull & grobjPlanet) == grobjNone) {
                    c = 0;
                  }
                  else {
                    rgid[0]._2_2_ = scan.idpl >> 0xf;
                    rgid[0]._0_2_ = scan.idpl;
                    rgid[1]._0_2_ = 0xffff;
                    rgid[1]._2_2_ = 0xffff;
                    c = 2;
                    if ((sel.grobj == grobjPlanet) && (sel.id == scan.idpl)) {
                      iChecked = 0;
                    }
                  }
                  for (i_2 = 0; i_2 < cFleet; i_2 = i_2 + 1) {
                    /* WARNING: Load size is inaccurate */
                    pFVar3 = ((FLEET **)rglpfl)[i_2];
                    iVar1 = *(int *)((int)((FLEET **)rglpfl + i_2) + 2);
                    lpfl = (FLEET *)CONCAT22(iVar1,pFVar3);
                    if ((pFVar3 == (FLEET *)0x0) && (iVar1 == 0)) break;
                    if ((pt.x == (&pFVar3->pt)->x) && (pt.y == (pFVar3->pt).y)) {
                      if ((sel.grobj == grobjFleet) && (lpfl->id == sel.id)) {
                        iChecked = c;
                      }
                      iVar2 = lpfl->id;
                      iVar1 = c + 1;
                      *(int *)(rgid + c) = iVar2;
                      *(uint *)((int)rgid + c * 4 + 2) = iVar2 >> 0xf | 0x8000;
                      c = iVar1;
                      if (0x61 < iVar1) break;
                    }
                  }
                  if ((c == 2) && ((scan.grobjFull & grobjPlanet) != grobjNone)) {
                    c = 1;
                  }
                  bVar10 = c == 0;
                  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
                  while ((THING *)lpth < (THING *)lpThings + cThing) {
                    uVar9 = (undefined2)((ulong)lpth >> 0x10);
                    if ((pt.x == (&((THING *)lpth)->pt)->x) && (pt.y == (((THING *)lpth)->pt).y)) {
                      if (!bVar10) {
                        *(undefined2 *)(rgid + c) = 0xffff;
                        *(undefined2 *)((int)rgid + c * 4 + 2) = 0xffff;
                        bVar10 = true;
                        c = c + 1;
                      }
                      iVar1 = c + 1;
                      *(short *)(rgid + c) = lpth->idFull;
                      *(undefined2 *)((int)rgid + c * 4 + 2) = 0x2000;
                      c = iVar1;
                      if (99 < iVar1) break;
                    }
                    lpth = (THING *)CONCAT22(uVar9,(THING *)lpth + 1);
                  }
                  LogicalToScan(&pt);
                  sVar6 = PopupMenu(hwnd,pt.x,pt.y,c,rgid,(char **)0x0,iChecked,1);
                  if (sVar6 < 0) {
                    return 0;
                  }
                  if ((*(uint *)((int)rgid + sVar6 * 4 + 2) & 0x8000) == 0) {
                    if ((*(uint *)((int)rgid + sVar6 * 4 + 2) & 0x2000) == 0) {
                      scan.grobj = grobjPlanet;
                    }
                    else {
                      scan.grobj = grobjThing;
                      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
                      while (((THING *)lpth < (THING *)lpThings + cThing &&
                             (lpth->idFull != (int)rgid[sVar6]))) {
                        lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
                      }
                      scan.ith = ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12;
                    }
                  }
                  else {
                    scan.grobj = grobjFleet;
                    for (i_2 = 0; i_2 < cFleet; i_2 = i_2 + 1) {
                    /* WARNING: Load size is inaccurate */
                      pFVar3 = ((FLEET **)rglpfl)[i_2];
                      iVar1 = *(int *)((int)((FLEET **)rglpfl + i_2) + 2);
                      lpfl = (FLEET *)CONCAT22(iVar1,pFVar3);
                      if (((pFVar3 == (FLEET *)0x0) && (iVar1 == 0)) ||
                         (lpfl->id == (int)rgid[sVar6])) break;
                    }
                    scan.ifl = i_2;
                  }
                  ChangeScanSel(&scan,2);
                  if (scan.grobj == grobjPlanet) {
                    sVar6 = FLookupPlanet(scan.idpl,(PLANET *)&d);
                    if (sVar6 == 0) {
                      return 0;
                    }
                    if (iStack_68 != idPlayer) {
                      return 0;
                    }
                  }
                }
                else {
                  if ((sel.grobj == grobjFleet) &&
                     (((wParam & 4) != 0 || ((grbitScan & 0x10) != 0)))) {
                    ptIn.y = pt.y;
                    ptIn.x = pt.x;
                    FAddWayPoint(ptIn,&scan);
                    return 0;
                  }
                  if ((scan.pt.x == sel.scan.pt.x) &&
                     (scan.pt.y == sel.scan.pt.y)) {
                    bVar10 = true;
                  }
                  else {
                    bVar10 = false;
                  }
                  ChangeScanSel(&scan,1);
                  pt_02.y = pt.y;
                  pt_02.x = pt.x;
                  sVar6 = FNearAWayPoint(pt_02,1);
                  if ((sVar6 != 0) &&
                     (pt_04.y = pt.y, pt_04.x = pt.x, sVar6 = FHandleWayPointDrag(pt_04), sVar6 != 0
                     )) {
                    return 0;
                  }
                  if (!bVar10) {
                    return 0;
                  }
                  if ((scan.grobj != grobjFleet) && (scan.grobj != grobjPlanet)) {
                    return 0;
                  }
                  if ((scan.pt.x == sel.pt.x) && (scan.pt.y == sel.pt.y)) {
                    sVar6 = FGetNextObjHere(&scan,1);
                    if (sVar6 == 0) {
                      return 0;
                    }
                  }
                  else if (scan.grobj == grobjPlanet) {
                    sVar6 = FLookupPlanet(scan.idpl,(PLANET *)&d);
                    if (sVar6 == 0) {
                      return 0;
                    }
                    if ((iStack_68 != idPlayer) ||
                       ((((scan.grobjFull & grobjFleet) != grobjNone &&
                         (sel.grobj == grobjPlanet)) && (scan.idpl == sel.id))))
                    {
                      if ((scan.grobjFull & grobjFleet) == grobjNone) {
                        return 0;
                      }
                      scan.grobj = grobjFleet;
                    }
                  }
                }
                if (((scan.grobj != grobjFleet) ||
                    (((FLEET *)((FLEET **)rglpfl)[scan.ifl])->iPlayer == idPlayer)) &&
                   (scan.grobj != grobjThing)) {
                  if (scan.grobj == grobjFleet) {
                    scan.iwp = -1;
                  }
                  ChangeScanSel(&scan,1);
                  RedrawScanSel(0,0);
                  if (scan.grobj != grobjPlanet) {
                    scan.idpl = ((FLEET **)rglpfl)[scan.ifl]->id;
                  }
                  ChangeMainObjSel(scan.grobj,scan.idpl);
                  RedrawScanSel(0,1);
                  if ((scan.grobj == grobjFleet) && ((scan.grobjFull & grobjPlanet) != grobjNone)) {
                    scan.grobj = grobjPlanet;
                    ChangeScanSel(&scan,1);
                  }
                }
              }
            }
            else {
              DrawShipScanPath(0,0);
              if (scan.idpl == sel.pl.id) {
                sel.pl.wRouting = sel.pl.wRouting & 0xfc00;
              }
              else {
                sel.pl.wRouting =
                     sel.pl.wRouting & 0xfc00U | scan.idpl + 1U & 0x3ff;
              }
              FLookupPlanet(-1,(PLANET *)&sel.pl);
              gd.wFlags = gd.wFlags & 0xdfff;
              DrawShipScanPath(0,1);
              DrawPlanShip(0,0x4040);
            }
          }
          else {
            DrawShipScanPath(0,0);
            if (scan.idpl == sel.pl.id) {
              sel.pl.wFlags = sel.pl.wFlags & 0xfc00;
            }
            else {
              sel.pl.wFlags = sel.pl.wFlags & 0xfc00U | scan.idpl + 1U & 0x3ff;
            }
            FLookupPlanet(-1,(PLANET *)&sel.pl);
            gd.wFlags = gd.wFlags & 0xfeff;
            DrawShipScanPath(0,1);
            DrawPlanShip(0,0x4100);
          }
        }
        else if (((msg == 0x201) && (pt.y < rc.bottom - (dySBar >> 1))) &&
                ((sel.scan.grobjFull & (grobjFleet|grobjPlanet)) != grobjNone)) {
          if (sel.scan.grobj == grobjFleet) {
            GlobalPD.grPopup = 3;
            GlobalPD._2_2_ =
                 *(undefined2 *)((FLEET **)rglpfl + sel.scan.ifl);
            GlobalPD.psz =
                 (char *)*(undefined2 *)
                          ((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
          }
          else {
            GlobalPD.grPopup = 4;
          }
          Popup(hwnd,pt.x,pt.y);
        }
      }
      else {
        if (msg != 0x222) goto SCAN_Default_2;
        hwndActive = hwnd;
        if (wParam == 0) {
          hwndActive = 0;
        }
      }
      return 0;
    }
    GetCursorPos((undefined2 *)CONCAT22(unaff_SS,&pt));
    ScreenToClient(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&pt));
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    BVar5 = PtInRect((undefined2 *)CONCAT22(&rc,pt.y),pt.x);
    if (BVar5 != 0) {
      rc.bottom = rc.bottom - dySBar;
      BVar5 = PtInRect((undefined2 *)CONCAT22(&rc,pt.y),pt.x);
      if (BVar5 == 0) {
        HVar8 = LoadCursor(0,&DAT_0000_7f00);
        setcursor(HVar8);
      }
      else if ((sel.grobj == grobjFleet) &&
              ((uVar7 = GetAsyncKeyState(0x10), (uVar7 & 0xfffe) != 0 ||
               ((grbitScan & 0x10) != 0)))) {
        setcursor(hcurScanAdd);
      }
      else {
        pt_00.y = pt.y;
        pt_00.x = pt.x;
        sVar6 = FNearAWayPoint(pt_00,0);
        if (sVar6 == 0) {
          if (((((uint)gd.wFlags >> 8 & 1) == 0) &&
              (((uint)gd.wFlags >> 0xd & 1) == 0)) &&
             ((sel.grobj != grobjPlanet ||
              (((uVar7 = GetAsyncKeyState(0x10), (uVar7 & 0xfffe) == 0 ||
                (sVar6 = IWarpMAFromLppl(&sel.pl,(short *)0x0), sVar6 < 1)) &&
               (uVar7 = GetAsyncKeyState(0x11), (uVar7 & 0xfffe) == 0)))))) {
            setcursor(hcurScanner);
          }
          else {
            setcursor(hcurScanAdd);
          }
        }
        else {
          setcursor(hcurOpenGrab);
        }
      }
      return 1;
    }
  }
SCAN_Default_2:
  LVar13 = DefWindowProc(hwnd,msg,wParam,lParam);
  return LVar13;
}



// ======================================================================
// Function: PtToScan
// Address: 1058:0efc
// Segment: MEMORY_SCAN
// ======================================================================


short PtToScan(short d)

{
  if (iScanZoom != 0) {
    switch(iScanZoom) {
    default:
      break;
    case 1:
      d = d * 5 >> 2;
      break;
    case 2:
      d = d * 3 >> 1;
      break;
    case 3:
      d = d << 1;
      break;
    case 4:
      d = d << 2;
      break;
    case -4:
      d = d >> 2;
      break;
    case -3:
      d = d * 3 >> 3;
      break;
    case -2:
      d = d >> 1;
      break;
    case -1:
      d = d * 3 >> 2;
    }
  }
  return d;
}



// ======================================================================
// Function: ScanToPt
// Address: 1058:0fc2
// Segment: MEMORY_SCAN
// ======================================================================


short ScanToPt(short d)

{
  if (iScanZoom != 0) {
    switch(iScanZoom) {
    default:
      break;
    case 1:
      d = (d << 2) / 5;
      break;
    case 2:
      d = (d << 1) / 3;
      break;
    case 3:
      d = d >> 1;
      break;
    case 4:
      d = d >> 2;
      break;
    case -4:
      d = d << 2;
      break;
    case -3:
      d = (d << 3) / 3;
      break;
    case -2:
      d = d << 1;
      break;
    case -1:
      d = (d << 2) / 3;
    }
  }
  return d;
}



// ======================================================================
// Function: DrawScanner
// Address: 1058:108a
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x105838a5) */
/* WARNING: Removing unreachable block (ram,0x10583928) */
/* WARNING: Removing unreachable block (ram,0x10581d7f) */
/* WARNING: Removing unreachable block (ram,0x1058118f) */
/* WARNING: Removing unreachable block (ram,0x10582bf0) */
/* WARNING: Removing unreachable block (ram,0x105841d5) */

short DrawScanner(HDC hdc,RECT *prc)

{
  short sVar1;
  short sVar2;
  short sVar3;
  short sVar4;
  char cVar5;
  FLEET *pFVar6;
  short sVar7;
  undefined1 auVar8 [2];
  uint uVar9;
  uint uVar10;
  HGDIOBJ HVar11;
  int dx_00;
  short sVar12;
  short sVar13;
  short sVar14;
  int iVar15;
  int iVar16;
  int iVar17;
  int iVar18;
  int iVar19;
  HDC HVar20;
  short sVar21;
  int iVar22;
  HGDIOBJ HVar23;
  HBRUSH HVar24;
  HPEN HVar25;
  HGDIOBJ HVar26;
  HGDIOBJ HVar27;
  int iVar28;
  undefined2 uVar29;
  int *piVar30;
  PLANET *pPVar31;
  int iVar32;
  THING *pTVar33;
  int iVar34;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar35;
  undefined2 unaff_SS;
  bool bVar36;
  bool bVar37;
  COLORREF CVar38;
  COLORREF CVar39;
  PLANET *pPVar40;
  long lVar41;
  RECT *pRVar42;
  undefined1 *puVar43;
  HDC HVar44;
  THING *in_stack_0000f586;
  PLANET *in_stack_0000f588;
  short fDetonating;
  DRAWCIR dc_2;
  short rgrad_2 [250];
  short rgx_2 [250];
  short ropSav;
  short asStack_672 [240];
  THING *pTStack_492;
  PLANET *pPStack_490;
  THING *pTStack_48e;
  long l_2;
  long lPop;
  short dRad_2;
  undefined1 auStack_482 [2];
  COLORREF cr;
  undefined2 uStack_47c;
  long l;
  RECT rc;
  POINT ptOrigin;
  short fDoDraw;
  short xLeft;
  HBRUSH hbrSav;
  short dx;
  short yMin;
  ushort mdScanBase;
  short fStargate;
  THING *lpthMac;
  POINT ptSelMain;
  short fStarbase;
  short fMA;
  short fSelected;
  POINT ptO;
  short idP;
  short dRange;
  RECT rcDraw;
  short yOff;
  RECT rcClip;
  short iord;
  HBITMAP hbmpSav;
  short xMin;
  short i;
  FLEET *lpfl;
  THING *lpth;
  HDC hdcMem;
  char rgWhatsHere [999];
  short yMax;
  PLANET *lppl;
  HDC hdcScreen;
  short id2;
  HBITMAP hbmpScreen;
  HBITMAP hbmpXSav;
  short dy;
  short yBmp;
  PLANET *lpplMac;
  POINT ptD;
  short iBkPrev;
  COLORREF crFore;
  short id;
  POINT pt;
  short xMax;
  short yTop;
  short j;
  FLEET *lpflT;
  HPEN hpenSav;
  short dExpand;
  short xOff;
  
  sVar7 = xScanTop;
  sVar21 = yScanTop;
  uVar9 = grbitScan & 0xf;
  hdcScreen = 0;
  hbmpScreen = 0;
  if (((((FLEET **)rglpfl != (FLEET **)0x0) || (rglpfl._2_2_ != 0)) &&
      ((gd._4_2_ & 1) == 0)) && (((uint)gd._0_2_ >> 1 & 1) == 0)) {
    uVar10 = PtToScan(4000 - xScanTop);
    ptOrigin.x = uVar10 & 7;
    uVar10 = PtToScan(4000 - yScanTop);
    ptOrigin.y = uVar10 & 7;
    GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
    ExcludeClipRect(hdc,0,rc.bottom - dySBar,rc.right,rc.bottom);
    l._0_2_ = prc->right - prc->left;
    l._2_2_ = (int)l >> 0xf;
    l = __aFulmul((long)(int)l,(long)(prc->bottom - prc->top));
    if (l < 48000) {
      HVar20 = CreateCompatibleDC(hdc);
      if (HVar20 != 0) {
        hbmpScreen = CreateCompatibleBitmap
                               (hdc,prc->right - (prc->left & 0xfff8U),
                                prc->bottom - (prc->top & 0xfff8U));
        if (hbmpScreen == 0) {
          DeleteDC(HVar20);
        }
      }
      if (hbmpScreen != 0) {
        hdcScreen = hdc;
        hbmpXSav = SelectObject(HVar20,hbmpScreen);
        SetWindowOrg(HVar20,prc->left & 0xfff8,prc->top & 0xfff8);
        pt.y = 0;
        pt.x = 0;
        ClientToScreen(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&pt));
        ptOrigin.x = (ptOrigin.x + 8U) - (pt.x & 7U) & 7;
        ptOrigin.y = (ptOrigin.y + 8U) - (pt.y & 7U) & 7;
        hdc = HVar20;
      }
    }
    puVar43 = (undefined1 *)&DAT_1120_1120;
    pRVar42 = prc;
    HVar20 = hdc;
    HVar11 = GetStockObject(4);
    FillRect(HVar20,(undefined2 *)CONCAT22(puVar43,pRVar42),HVar11);
    sVar1 = prc->left;
    sVar2 = prc->top;
    sVar3 = prc->right;
    sVar4 = prc->bottom;
    if (((iScanZoom < 3) || (uVar9 != 4)) &&
       ((iScanZoom < 0 || ((uVar9 != 1 && (uVar9 != 2)))))) {
      dx_00 = 9;
    }
    else {
      dx_00 = 0x14;
    }
    ExpandRc(prc,dx_00,dx_00);
    prc->bottom = prc->bottom + 0xe;
    sVar12 = ScanToPt(prc->right - prc->left);
    sVar13 = ScanToPt(prc->bottom - prc->top);
    sVar14 = ScanToPt(prc->left);
    iVar15 = sVar14 + sVar7;
    iVar16 = iVar15 + sVar12;
    sVar12 = ScanToPt(prc->top);
    iVar28 = (dGalInv - sVar21) - sVar12;
    iVar17 = iVar28 - sVar13;
    iVar18 = -sVar7;
    iVar19 = dGalInv - sVar21;
    id = 1;
    for (i = 0; i < 0x10; i = i + 1) {
      if ((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) != 0) {
        grbitScanShip = grbitScanShip & ~(id & grbitScanShip);
      }
      id = id << 1;
    }
    HVar20 = CreateCompatibleDC(hdc);
    HVar11 = SelectObject(HVar20,hbmpScanner);
    if (sel.grobj == grobjNone) {
      ptSelMain.y = -2;
      ptSelMain.x = -2;
    }
    else {
      ptSelMain.x = sel.pt.x;
      ptSelMain.y = sel.pt.y;
    }
    if (((uint)gd._4_2_ >> 10 & 1) == 0) {
      LinkFleets(0);
    }
    else {
      for (i = 0; i < cFleet; i = i + 1) {
        iVar22 = *(int *)((FLEET **)rglpfl + i);
        iVar32 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        if ((iVar22 == 0) && (iVar32 == 0)) break;
        *(uint *)(iVar22 + 4) = *(uint *)(iVar22 + 4) & 0xf7ff;
      }
    }
    if ((grbitScan & 0x20) != 0) {
      bVar37 = false;
      dc_2.rgx = rgx_2;
      dc_2.rgy = asStack_672;
      dc_2.rgrad = rgrad_2;
      dc_2.cCur = 0;
      dc_2.cMax = 0xfa;
      dc_2.hdc = hdc;
      dc_2.rcClip.left = prc->left;
      dc_2.rcClip.top = prc->top;
      dc_2.rcClip.right = prc->right;
      dc_2.rcClip.bottom = prc->bottom;
      dc_2.fCovered = 0;
      dc_2.fHollowOut = 0;
      IntersectClipRect(hdc,sVar1,sVar2,sVar3,sVar4);
      HVar27 = SelectObject(hdc,hbrRadar);
      HVar26 = SelectObject(hdc,hpenRadar);
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      fDetonating = lpPlanets._2_2_;
      pPVar31 = (PLANET *)lpPlanets + cPlanet;
      in_stack_0000f588 = (PLANET *)lpPlanets;
      while( true ) {
        bVar36 = false;
        if (pPVar31 <= (PLANET *)lppl) break;
        uVar35 = (undefined2)((ulong)lppl >> 0x10);
        if (((PLANET *)lppl)->iPlayer == idPlayer) {
          dRange = GetPlanetScannerRange(lppl,&fDetonating);
          if (0 < fDetonating) {
            bVar37 = true;
          }
          if (vpctRadarView < 100) {
            dRange = MulDiv(dRange,vpctRadarView,100);
          }
          iVar22 = lppl->id;
          rc.left = PtToScan((iVar18 + ((POINT *)rgptPlan + iVar22)->x) - dRange);
          rc.top = PtToScan((iVar19 - *(int *)((int)&rgptPlan[0].y + iVar22 * 4)) - dRange
                           );
          rc.right = PtToScan(iVar18 + ((POINT *)rgptPlan + iVar22)->x + dRange);
          rc.bottom = PtToScan((iVar19 - *(int *)((int)&rgptPlan[0].y + iVar22 * 4)) +
                               dRange);
          DrawRadarCircle(&dc_2,&rc);
        }
        lppl = (PLANET *)CONCAT22(uVar35,(PLANET *)lppl + 1);
      }
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar6 = ((FLEET **)rglpfl)[i];
        iVar22 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        if ((pFVar6 == (FLEET *)0x0) && (iVar22 == 0)) break;
        if (pFVar6->iPlayer == idPlayer) {
          dRange = GetFleetScannerRange
                             ((FLEET *)CONCAT22(iVar22,pFVar6),&fDetonating,(short *)0x0,
                              (short *)0x0);
          if (0 < fDetonating) {
            bVar36 = true;
          }
          if (0 < dRange) {
            if (vpctRadarView < 100) {
              dRange = MulDiv(dRange,vpctRadarView,100);
            }
            rc.left = PtToScan((iVar18 + (&pFVar6->pt)->x) - dRange);
            rc.top = PtToScan((iVar19 - (pFVar6->pt).y) - dRange);
            rc.right = PtToScan(iVar18 + (&pFVar6->pt)->x + dRange);
            rc.bottom = PtToScan((iVar19 - (pFVar6->pt).y) + dRange);
            DrawRadarCircle(&dc_2,&rc);
          }
        }
      }
      DrawRadarCircle(&dc_2,(RECT *)0x0);
      if (hbrRadarNear == 0) {
        if (vcScreenColors < 9) {
          uVar10 = 0x7f7f;
        }
        else {
          uVar10 = 0x6060;
        }
        hbrRadarNear = HbrGet((ulong)uVar10);
      }
      if (hpenRadarNear == 0) {
        if (vcScreenColors < 9) {
          uVar10 = 0x7f7f;
        }
        else {
          uVar10 = 0x6060;
        }
        hpenRadarNear = CreatePen(0,1,(ulong)uVar10);
      }
      SelectObject(hdc,hbrRadarNear);
      SelectObject(hdc,hpenRadarNear);
      if (bVar37) {
        fDetonating = lpPlanets._2_2_;
        pPVar31 = (PLANET *)lpPlanets + cPlanet;
        lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
        in_stack_0000f588 = (PLANET *)lpPlanets;
        while ((PLANET *)lppl < pPVar31) {
          uVar35 = (undefined2)((ulong)lppl >> 0x10);
          if (((PLANET *)lppl)->iPlayer == idPlayer) {
            sVar21 = GetPlanetScannerRange(lppl,&fDetonating);
            if (0 < fDetonating) {
              dRange = sVar21 >> 1;
              if (vpctRadarView < 100) {
                dRange = MulDiv(dRange,vpctRadarView,100);
              }
              iVar22 = lppl->id;
              rc.left = PtToScan((iVar18 + ((POINT *)rgptPlan + iVar22)->x) - dRange);
              rc.top = PtToScan((iVar19 - *(int *)((int)&rgptPlan[0].y + iVar22 * 4)) -
                                dRange);
              rc.right = PtToScan(iVar18 + ((POINT *)rgptPlan + iVar22)->x + dRange);
              rc.bottom = PtToScan((iVar19 - *(int *)((int)&rgptPlan[0].y + iVar22 * 4)) +
                                   dRange);
              DrawRadarCircle(&dc_2,&rc);
            }
          }
          lppl = (PLANET *)CONCAT22(uVar35,(PLANET *)lppl + 1);
        }
      }
      if (bVar36) {
        for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar6 = ((FLEET **)rglpfl)[i];
          iVar22 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
          if ((pFVar6 == (FLEET *)0x0) && (iVar22 == 0)) break;
          if (pFVar6->iPlayer == idPlayer) {
            GetFleetScannerRange
                      ((FLEET *)CONCAT22(iVar22,pFVar6),&fDetonating,(short *)0x0,(short *)0x0);
            if (0 < fDetonating) {
              if (vpctRadarView < 100) {
                fDetonating = MulDiv(fDetonating,vpctRadarView,100);
              }
              rc.left = PtToScan((iVar18 + (&pFVar6->pt)->x) - fDetonating);
              rc.top = PtToScan((iVar19 - (pFVar6->pt).y) - fDetonating);
              rc.right = PtToScan(iVar18 + (&pFVar6->pt)->x + fDetonating);
              rc.bottom = PtToScan((iVar19 - (pFVar6->pt).y) + fDetonating);
              DrawRadarCircle(&dc_2,&rc);
            }
          }
        }
      }
      sVar21 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
      if (sVar21 == raMassAccel) {
        fDetonating = (short)lpThings._2_2_;
        pTVar33 = (THING *)lpThings + cThing;
        lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
        in_stack_0000f588 = (PLANET *)(THING *)lpThings;
        while ((THING *)lpth < pTVar33) {
          uVar35 = (undefined2)((ulong)lpth >> 0x10);
          if ((((uint)lpth->idFull >> 0xd == 1) &&
              (((uint)lpth->idFull >> 9 & 0xf) == idPlayer)) &&
             ((*(uint *)((THING *)lpth)->rgb >> 10 & 0xf) != 0)) {
            iVar22 = (*(uint *)((THING *)lpth)->rgb >> 10 & 0xf) + 4;
            fDetonating = iVar22 * iVar22;
            if (vpctRadarView < 100) {
              fDetonating = MulDiv(fDetonating,vpctRadarView,100);
            }
            rc.left = PtToScan((iVar18 + (&((THING *)lpth)->pt)->x) - fDetonating);
            rc.top = PtToScan((iVar19 - (((THING *)lpth)->pt).y) - fDetonating);
            rc.right = PtToScan(iVar18 + (&((THING *)lpth)->pt)->x + fDetonating);
            rc.bottom = PtToScan((iVar19 - (((THING *)lpth)->pt).y) + fDetonating);
            DrawRadarCircle(&dc_2,&rc);
          }
          lpth = (THING *)CONCAT22(uVar35,(THING *)lpth + 1);
        }
      }
      DrawRadarCircle(&dc_2,(RECT *)0x0);
      SelectObject(hdc,hbrRadar);
      SelectObject(hdc,hpenRadar);
      if (uVar9 != 5) {
        iVar22 = sel.fl.id;
        if (sel.grobj != grobjFleet) {
          iVar22 = -1;
        }
        if (sel.scan.grobj == grobjFleet) {
          sVar21 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
        }
        else {
          sVar21 = -1;
        }
        SelectObject(HVar20,hbmpScanShip);
        SetTextColor(hdc,0);
        SetBkColor(hdc,0xffffff);
        for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar6 = ((FLEET **)rglpfl)[i];
          iVar32 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
          lpfl = (FLEET *)CONCAT22(iVar32,pFVar6);
          if ((pFVar6 == (FLEET *)0x0) && (iVar32 == 0)) break;
          if (pFVar6->idPlanet == -1) {
            lVar41 = CShipsScanVis((FLEET *)CONCAT22(iVar32,pFVar6));
            if (((0 < lVar41) || (lpfl->id == iVar22)) || (lpfl->id == sVar21)) {
              pt.x = (&pFVar6->pt)->x;
              pt.y = (pFVar6->pt).y;
              if ((((iVar15 <= pt.x) && (pt.x < iVar16)) && (iVar17 <= pt.y)) && (pt.y < iVar28)) {
                pt.x = PtToScan(iVar18 + pt.x);
                pt.y = PtToScan(iVar19 - pt.y);
                if (((&pFVar6->pt)->x == ptSelMain.x) && ((pFVar6->pt).y == ptSelMain.y)) {
                  bVar37 = true;
                }
                else {
                  bVar37 = false;
                }
                if (bVar37) {
                  SelectObject(HVar20,hbmpScanner);
                  BitBlt(hdc,pt.x + -5,pt.y + -5,0xb,0xb,HVar20,0xb,0x50,0x8800c6);
                  SelectObject(HVar20,hbmpScanShip);
                }
                else {
                  GetScanFleetOrientation((FLEET *)CONCAT22(iVar32,pFVar6),&ptO,&ptD);
                  BitBlt(hdc,pt.x - ptD.x / 2,pt.y - ptD.y / 2,ptD.x,ptD.y,HVar20,ptO.x,ptO.y,
                         0x8800c6);
                }
              }
            }
          }
        }
        SelectObject(HVar20,hbmpScanner);
      }
      SelectObject(hdc,HVar26);
      SelectObject(hdc,HVar27);
    }
    if ((grbitScan & 0x40) != 0) {
      dc_2.rgx = rgx_2;
      dc_2.rgy = asStack_672;
      dc_2.rgrad = rgrad_2;
      dc_2.cCur = 0;
      dc_2.cMax = 0xfa;
      dc_2.hdc = hdc;
      dc_2.rcClip.left = prc->left;
      dc_2.rcClip.top = prc->top;
      dc_2.rcClip.right = prc->right;
      dc_2.rcClip.bottom = prc->bottom;
      dc_2.fCovered = 0;
      dc_2.fHollowOut = 1;
      for (i = 0; i < 3; i = i + 1) {
        UnrealizeObject(((ushort *)rghbrPat)[i]);
      }
      SetBrushOrg(hdc,ptOrigin.x,ptOrigin.y);
      IntersectClipRect(hdc,sVar1,sVar2,sVar3,sVar4);
      HVar27 = SelectObject(hdc,rghbrPat[0]);
      HVar44 = hdc;
      HVar26 = GetStockObject(8);
      HVar26 = SelectObject(HVar44,HVar26);
      sVar21 = GetROP2(hdc);
      SetBkColor(hdc,0);
      for (j = 0; pPVar31 = lpThings._2_2_, j < 3; j = j + 1) {
        if (((j != 0) || ((grbitScanMines & 1) != 0)) &&
           (((j != 1 || ((grbitScanMines & 2) != 0)) &&
            ((j != 2 || ((grbitScanMines & 0xc) != 0)))))) {
          for (i = 0; i < 3; i = i + 1) {
            for (fDetonating = 0; fDetonating <= (int)(uint)(i == 0); fDetonating = fDetonating + 1)
            {
              SetBrushOrg(hdc,ptOrigin.x,ptOrigin.y);
              SelectObject(hdc,((ushort *)rghbrPat)[i]);
              if (fDetonating == 0) {
                uVar35 = *(undefined2 *)(j * 4 + 0x26);
                uVar29 = *(undefined2 *)(j * 4 + 0x28);
              }
              else {
                uVar35 = 0xff;
                uVar29 = 0xff;
              }
              SetTextColor(hdc,CONCAT22(uVar29,uVar35));
              pTVar33 = (THING *)lpThings + cThing;
              lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
              in_stack_0000f586 = (THING *)lpThings;
              in_stack_0000f588 = lpThings._2_2_;
              while ((THING *)lpth < pTVar33) {
                uVar35 = (undefined2)((ulong)lpth >> 0x10);
                if ((((uint)lpth->idFull >> 0xd == 0) && ((uint)((THING *)lpth)->rgb[6] == i)) &&
                   ((j != 0 || (((uint)lpth->idFull >> 9 & 0xf) == idPlayer)))) {
                  if (j < 1) {
LAB_1058_21da:
                    if ((j == 2) && ((grbitScanMines & 0xc) != 0xc)) {
                      in_stack_0000f588 =
                           (PLANET *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0)
                      ;
                      if (in_stack_0000f588->rgpctMinLevel[((uint)lpth->idFull >> 9 & 0xf) - 6] == 0
                         ) {
                        uVar10 = grbitScanMines & 4;
                      }
                      else {
                        uVar10 = grbitScanMines & 8;
                      }
                      if (uVar10 == 0) goto LAB_1058_243c;
                    }
                    if ((uint)((THING *)lpth)->rgb[7] == fDetonating) {
                      pt.x = (&((THING *)lpth)->pt)->x;
                      pt.y = (((THING *)lpth)->pt).y;
                      _sqrt(SUB84((double)*(long *)((THING *)lpth)->rgb,0),
                                    (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(
                                                  double)*(long *)((THING *)lpth)->rgb >> 0x20))));
                      lVar41 = __ftol((double)CONCAT26(in_stack_0000f588,
                                                               CONCAT24(in_stack_0000f586,
                                                                        CONCAT22(unaff_SI,unaff_DI))
                                                              ));
                      iVar22 = (int)lVar41;
                      rc.left = PtToScan((iVar18 + pt.x) - iVar22);
                      rc.top = PtToScan((iVar19 - pt.y) - iVar22);
                      rc.right = PtToScan(iVar18 + pt.x + iVar22);
                      rc.bottom = PtToScan((iVar19 - pt.y) + iVar22);
                      DrawRadarCircle(&dc_2,&rc);
                      id = 0;
                      while ((id < game.cPlanMax &&
                             ((((POINT *)rgptPlan + id)->x != pt.x ||
                              (*(int *)((int)&rgptPlan[0].y + id * 4) != pt.y))))) {
                        id = id + 1;
                      }
                      if (id == game.cPlanMax) {
                        pt.x = PtToScan(iVar18 + pt.x);
                        pt.y = PtToScan(iVar19 - pt.y);
                        dRange = PtToScan(1);
                        if (dRange < 1) {
                          dRange = 1;
                        }
                        else if (3 < dRange) {
                          dRange = 3;
                        }
                        SetRect((undefined2 *)CONCAT22(unaff_SS,&rc),pt.x - dRange,pt.y - dRange,
                                pt.x + dRange + 1,pt.y + dRange + 1);
                        SetBkColor(hdc,CONCAT22(*(undefined2 *)(j * 4 + 0x28),
                                                *(undefined2 *)(j * 4 + 0x26)));
                        ExtTextOut(hdc,rc.left,rc.top,2,(undefined2 *)CONCAT22(unaff_SS,&rc),
                                   (LPCSTR)0x0,0,(short *)0x0);
                        SetBkColor(hdc,0);
                      }
                    }
                  }
                  else if (((uint)lpth->idFull >> 9 & 0xf) != idPlayer) {
                    in_stack_0000f588 =
                         (PLANET *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0);
                    in_stack_0000f586 =
                         (THING *)(uint)(in_stack_0000f588->rgpctMinLevel
                                         [((uint)lpth->idFull >> 9 & 0xf) - 6] == 1);
                    if (in_stack_0000f586 != (THING *)(uint)(j == 2)) goto LAB_1058_21da;
                  }
                }
LAB_1058_243c:
                lpth = (THING *)CONCAT22(uVar35,(THING *)lpth + 1);
              }
              DrawRadarCircle(&dc_2,(RECT *)0x0);
            }
          }
        }
      }
      if (sel.scan.grobj == grobjThing) {
        pTVar33 = (THING *)lpThings + sel.scan.ith;
        lpth = (THING *)CONCAT22(lpThings._2_2_,pTVar33);
        if ((uint)lpth->idFull >> 0xd == 0) {
          SetBrushOrg(hdc,ptOrigin.x,ptOrigin.y);
          SelectObject(hdc,((ushort *)rghbrPat)[pTVar33->rgb[6]]);
          SetTextColor(hdc,0xffff00);
          pt.x = (&pTVar33->pt)->x;
          pt.y = (pTVar33->pt).y;
          _sqrt(SUB84((double)*(long *)pTVar33->rgb,0),
                        (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)*(long *)
                                                  pTVar33->rgb >> 0x20))));
          lVar41 = __ftol((double)CONCAT26(in_stack_0000f588,
                                                   CONCAT24(in_stack_0000f586,
                                                            CONCAT22(unaff_SI,unaff_DI))));
          iVar22 = (int)lVar41;
          rc.left = PtToScan((iVar18 + pt.x) - iVar22);
          rc.top = PtToScan((iVar19 - pt.y) - iVar22);
          rc.right = PtToScan(iVar18 + pt.x + iVar22);
          rc.bottom = PtToScan((iVar19 - pt.y) + iVar22);
          DrawRadarCircle(&dc_2,&rc);
          DrawRadarCircle(&dc_2,(RECT *)0x0);
        }
      }
      SetROP2(hdc,sVar21);
      SelectObject(hdc,HVar26);
      SelectObject(hdc,HVar27);
    }
    if ((cThing != 0) && (uVar9 != 5)) {
      IntersectClipRect(hdc,sVar1,sVar2,sVar3,sVar4);
      HVar27 = SelectObject(hdc,hbrShip);
      HVar26 = SelectObject(hdc,hpenDkPurple);
      pTStack_492 = (THING *)lpThings;
      pPStack_490 = lpThings._2_2_;
      pTStack_48e = (THING *)lpThings + cThing;
      l_2._0_2_ = lpThings._2_2_;
      stack0xfb76 = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      while (l_2._2_2_ < pTStack_48e) {
        if ((((uint)stack0xfb76->idFull >> 0xd == 1) || ((uint)stack0xfb76->idFull >> 0xd == 2)) ||
           ((uint)stack0xfb76->idFull >> 0xd == 3)) {
          uVar35 = (undefined2)((ulong)stack0xfb76 >> 0x10);
          pt.x = (&(l_2._2_2_)->pt)->x;
          pt.y = ((l_2._2_2_)->pt).y;
          LogicalToScan(&pt);
          if ((uint)stack0xfb76->idFull >> 0xd == 2) {
            uVar35 = (undefined2)((ulong)stack0xfb76 >> 0x10);
            pTVar33 = (THING *)stack0xfb76;
            if (((uint)stack0xfb76->idFull < *(uint *)(pTVar33->rgb + 6)) &&
               ((1 << ((byte)idPlayer & 0x1f) & *(uint *)(pTVar33->rgb + 4)) != 0)) {
              join_0x00000008_0x00000000_ = LpthFromId(*(short *)(pTVar33->rgb + 6));
              if (join_0x00000008_0x00000000_ != (THING *)0x0) {
                MoveTo(hdc,pt.x,pt.y);
                uVar35 = (undefined2)((ulong)stack0xfb7a >> 0x10);
                auStack_482 = (undefined1  [2])(&((THING *)stack0xfb7a)->pt)->x;
                cr._0_2_ = (((THING *)stack0xfb7a)->pt).y;
                LogicalToScan((POINT *)auStack_482);
                LineTo(hdc,(short)auStack_482,(uint)cr);
                LineTo(hdc,(short)auStack_482,(uint)cr + 1);
              }
            }
          }
          if ((uint)stack0xfb76->idFull >> 0xd == 2) {
            BitBlt(hdc,pt.x + -4,pt.y + -4,9,9,HVar20,9,0x5c,0x8800c6);
            BitBlt(hdc,pt.x + -4,pt.y + -4,9,9,HVar20,0,0x5c,0xee0086);
          }
          else if ((uint)stack0xfb76->idFull >> 0xd == 3) {
            pPStack_490 = (PLANET *)SelectObject(HVar20,hbmpScanShip);
            CVar38 = SetTextColor(hdc,0xffff00);
            CVar39 = SetBkColor(hdc,0);
            uStack_47c = (undefined2)(CVar39 >> 0x10);
            cr._2_2_ = (undefined2)CVar39;
            uVar35 = (undefined2)((ulong)stack0xfb76 >> 0x10);
            pTVar33 = (THING *)stack0xfb76;
            GetDxDyOrientation(*(int *)pTVar33->rgb - (&pTVar33->pt)->x,
                               *(int *)(pTVar33->rgb + 2) - (pTVar33->pt).y,&ptO,&ptD);
            BitBlt(hdc,pt.x - ptD.x / 2,pt.y - ptD.y / 2,ptD.x,ptD.y,HVar20,ptO.x,ptO.y,0xee0086);
            SetTextColor(hdc,CVar38);
            SetBkColor(hdc,CONCAT22(uStack_47c,cr._2_2_));
            SelectObject(HVar20,(HGDIOBJ)pPStack_490);
          }
          else {
            if (iScanZoom < 1) {
              iVar22 = 2;
            }
            else if (iScanZoom < 3) {
              iVar22 = 3;
            }
            else {
              iVar22 = 5;
            }
            iVar32 = iVar22 * 2 + 1;
            if ((*(uint *)((THING *)stack0xfb76)->rgb >> 10 & 0xf) == 0) {
              SelectObject(hdc,hpenYellow);
              MoveTo(hdc,pt.x,(pt.y - iVar22) + -1);
              LineTo(hdc,(pt.x - iVar22) + -1,pt.y);
              LineTo(hdc,pt.x,pt.y + iVar22 + 1);
              LineTo(hdc,pt.x + iVar22 + 1,pt.y);
              LineTo(hdc,pt.x,(pt.y - iVar22) + -1);
              SelectObject(hdc,hpenDkPurple);
            }
            else {
              if (((uint)stack0xfb76->idFull >> 9 & 0xf) != idPlayer) {
                SelectObject(hdc,hbrRed);
              }
              PatBlt(hdc,pt.x - iVar22,pt.y - iVar22,iVar32,1,0xf00021);
              PatBlt(hdc,pt.x - iVar22,pt.y - iVar22,1,iVar32,0xf00021);
              PatBlt(hdc,pt.x - iVar22,pt.y + iVar22,iVar32,1,0xf00021);
              PatBlt(hdc,pt.x + iVar22,pt.y - iVar22,1,iVar32,0xf00021);
              if (((uint)stack0xfb76->idFull >> 9 & 0xf) != idPlayer) {
                SelectObject(hdc,hbrShip);
              }
            }
          }
        }
        stack0xfb76 = (THING *)CONCAT22((uint)lPop,l_2._2_2_ + 1);
      }
      SelectObject(hdc,HVar27);
      SelectObject(hdc,HVar26);
    }
    if (((grbitScan & 0x80) != 0) && (uVar9 != 5)) {
      iVar22 = sel.fl.id;
      if (sel.grobj != grobjFleet) {
        iVar22 = -1;
      }
      if (sel.scan.grobj == grobjFleet) {
        sVar21 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
      }
      else {
        sVar21 = -1;
      }
      HVar27 = SelectObject(hdc,hpenStarbase);
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar6 = ((FLEET **)rglpfl)[i];
        iVar32 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar32,pFVar6);
        if ((pFVar6 == (FLEET *)0x0) && (iVar32 == 0)) break;
        if ((((uint)pFVar6->wFlags >> 10 & 1) == 0) &&
           ((6 < (pFVar6->wFlags & 0xffU) && (1 < pFVar6->cord)))) {
          lVar41 = CShipsScanVis((FLEET *)CONCAT22(iVar32,pFVar6));
          if ((0 < lVar41) || ((lpfl->id == iVar22 || (lpfl->id == sVar21)))) {
            for (iord = 0; iord < pFVar6->cord; iord = iord + 1) {
              uVar35 = *(undefined2 *)((int)&pFVar6->lpplord + 2);
              piVar30 = (int *)(*(int *)&pFVar6->lpplord + 4 + iord * 0x12);
              pt.x = *piVar30;
              pt.y = piVar30[1];
              pt.x = PtToScan(iVar18 + pt.x);
              pt.y = PtToScan(iVar19 - pt.y);
              if (iord == 0) {
                MoveTo(hdc,pt.x,pt.y);
              }
              else {
                LineTo(hdc,pt.x,pt.y);
              }
            }
          }
        }
      }
      SelectObject(hdc,HVar27);
    }
    SelectClipRgn(hdc,hrgnHuge);
    GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
    ExcludeClipRect(hdc,0,rc.bottom - dySBar,rc.right,rc.bottom);
    _memset(rgWhatsHere,0,999);
    switch(iScanZoom) {
    case 0:
    case 1:
    case 2:
      SelectObject(hdc,rghfontArial8[0]);
      break;
    case 3:
      SelectObject(hdc,rghfontArial8[1]);
      break;
    case 4:
      SelectObject(hdc,rghfontArial10[1]);
      break;
    case -1:
      SelectObject(hdc,rghfontArial6[0]);
    }
    CVar38 = SetTextColor(hdc,0xffffff);
    CVar39 = SetBkColor(hdc,0);
    uStack_47c = (undefined2)(CVar39 >> 0x10);
    cr._2_2_ = (undefined2)CVar39;
    sVar21 = SetBkMode(hdc,1);
    if ((iScanZoom < 3) || (uVar9 != 4)) {
      iVar22 = 0;
    }
    else {
      iVar22 = 0xb;
    }
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      if ((((((POINT *)rgptPlan + i)->x < iVar15) ||
           (iVar16 <= ((POINT *)rgptPlan + i)->x)) ||
          (*(int *)((int)&rgptPlan[0].y + i * 4) < iVar17)) ||
         (iVar28 <= *(int *)((int)&rgptPlan[0].y + i * 4))) {
        if ((grbitScan & 0x400) != 0) {
          bVar37 = false;
          goto SCAN_LBailIn;
        }
      }
      else {
        bVar37 = true;
SCAN_LBailIn:
        pt.x = PtToScan(iVar18 + ((POINT *)rgptPlan + i)->x);
        pt.y = PtToScan(iVar19 - *(int *)((int)&rgptPlan[0].y + i * 4));
        if (bVar37) {
          if (((ptSelMain.x == ((POINT *)rgptPlan + i)->x) &&
              (ptSelMain.y == *(int *)((int)&rgptPlan[0].y + i * 4))) && (uVar9 < 3)) {
            BitBlt(hdc,pt.x + -5,pt.y + -5,0xb,0xb,HVar20,0,0x45,0x8800c6);
            BitBlt(hdc,pt.x + -5,pt.y + -5,0xb,0xb,HVar20,0,0x21,0xee0086);
          }
          else {
            BitBlt(hdc,pt.x + -1,pt.y + -1,3,3,HVar20,0xb,0xf,0xcc0020);
          }
        }
        if ((((grbitScan & 0x400) != 0) && (-2 < iScanZoom)) &&
           ((iVar15 + -0x32 <= ((POINT *)rgptPlan + i)->x &&
            (((((POINT *)rgptPlan + i)->x < iVar16 + 0x32 &&
              (iVar17 + -0x14 <= *(int *)((int)&rgptPlan[0].y + i * 4))) &&
             (*(int *)((int)&rgptPlan[0].y + i * 4) < iVar28 + 0x14)))))) {
          PszGetPlanetName(i);
          if ((grbitScan & 0x2000) != 0) {
            pPVar40 = LpplFromId(i);
            iVar32 = (int)((ulong)pPVar40 >> 0x10);
            pPVar31 = (PLANET *)pPVar40;
            if (((pPVar31 != (PLANET *)0x0) || (iVar32 != 0)) && (pPVar31->iPlayer != -1)) {
              if (pPVar31->iPlayer == idPlayer) {
                uVar35 = 0xffff;
                uVar29 = 0xff;
              }
              else {
                iVar32 = pPVar31->iPlayer * 4;
                uVar35 = *(undefined2 *)(iVar32 + 0x2e);
                uVar29 = *(undefined2 *)(iVar32 + 0x30);
              }
              SetTextColor(hdc,CONCAT22(uVar29,uVar35));
            }
          }
          CtrTextOut(hdc,pt.x,pt.y + 5 + iVar22,(char *)szWork,0);
          if ((grbitScan & 0x2000) != 0) {
            SetTextColor(hdc,0xffffff);
          }
        }
      }
    }
    SetBkMode(hdc,sVar21);
    SetBkColor(hdc,CONCAT22(uStack_47c,cr._2_2_));
    SetTextColor(hdc,CVar38);
    if ((iScanZoom < 3) || (uVar9 != 4)) {
      iVar22 = 0;
    }
    else {
      iVar22 = 0xb;
    }
    if (((sel.grobj == grobjNone) || (sel.pt.x != sel.scan.pt.x)) ||
       (sel.pt.y != sel.scan.pt.y)) {
      if (sel.scan.grobj != grobjNone) {
        pt.x = sel.scan.pt.x;
        pt.y = sel.scan.pt.y;
        LogicalToScan(&pt);
        BitBlt(hdc,pt.x + -3,pt.y + 7 + iVar22,7,8,HVar20,0x16,0x50,0x8800c6);
        BitBlt(hdc,pt.x + -3,pt.y + 7 + iVar22,7,8,HVar20,0x16,0x31,0xee0086);
      }
    }
    else {
      pt.x = sel.pt.x;
      pt.y = sel.pt.y;
      LogicalToScan(&pt);
      BitBlt(hdc,pt.x + -5,pt.y + 0xb + iVar22,0xb,0xc,HVar20,0,0x50,0x8800c6);
      BitBlt(hdc,pt.x + -5,pt.y + 0xb + iVar22,0xb,0xc,HVar20,0,0x39,0xee0086);
    }
    if ((cPlanet != 0) && (uVar9 != 5)) {
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      for (i = 0; i < cPlanet; i = i + 1) {
        iVar22 = lppl->id;
        uVar35 = (undefined2)((ulong)lppl >> 0x10);
        pPVar31 = (PLANET *)lppl;
        if ((((uint)pPVar31->wFlags >> 9 & 1) == 0) || (pPVar31->iPlayer == -1)) {
          fStarbase = 0;
        }
        else {
          fStarbase = 1;
        }
        if (fStarbase == 0) {
          bVar37 = false;
          bVar36 = false;
        }
        else {
          iVar32 = pPVar31->iPlayer * 4;
          if (*(int *)(*(int *)(iVar32 + 0x14c) + (*(uint *)&pPVar31->field11_0x2c & 0xf) * 0x93) ==
              0x20) {
            fStarbase = 2;
          }
          sVar21 = IWarpMAFromLppl(lppl,(short *)0x0);
          bVar37 = 0 < sVar21;
          sVar21 = IStargateFromLppl(lppl);
          bVar36 = sVar21 != -1;
        }
        if ((((iVar15 <= ((POINT *)rgptPlan + iVar22)->x) &&
             (((POINT *)rgptPlan + iVar22)->x < iVar16)) &&
            (iVar17 <= *(int *)((int)&rgptPlan[0].y + iVar22 * 4))) &&
           (*(int *)((int)&rgptPlan[0].y + iVar22 * 4) < iVar28)) {
          pt.x = PtToScan(iVar18 + ((POINT *)rgptPlan + iVar22)->x);
          pt.y = PtToScan(iVar19 - *(int *)((int)&rgptPlan[0].y + iVar22 * 4));
          if (uVar9 == 3) {
            cr._0_2_ = 0;
            if (2 < (pPVar31->wFlags & 0xffU)) {
              sVar21 = PctPlanetDesirability(lppl,idPlayer);
              stack0xfb7a = (THING *)CONCAT22(sVar21,lPop._2_2_);
              if (sVar21 < 0) {
LAB_1058_343d:
                sVar21 = PctPlanetOptValue(lppl,idPlayer);
                stack0xfb7a = (THING *)CONCAT22(sVar21,lPop._2_2_);
                if (-1 < sVar21) {
                  sVar21 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv)
                  ;
                  if (sVar21 != raTerra) {
                    cr._0_2_ = 1;
                  }
                }
              }
              else {
                sVar21 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
                if (sVar21 == raTerra) goto LAB_1058_343d;
              }
              HVar24 = hbrRadar;
              if ((-1 < (long)stack0xfb7a) && (HVar24 = hbrDkYellow, (uint)cr == 0)) {
                HVar24 = hbrGreen;
              }
              HVar27 = SelectObject(hdc,HVar24);
              HVar25 = hpenRadar;
              if ((-1 < (long)stack0xfb7a) && (HVar25 = hpenDkYellow, (uint)cr == 0)) {
                HVar25 = hpenDkGreen;
              }
              HVar26 = SelectObject(hdc,HVar25);
              if ((long)stack0xfb7a < 0) {
                iVar22 = -dRad_2 / 5;
              }
              else {
                iVar22 = dRad_2 / 0xb;
              }
              auStack_482 = (undefined1  [2])(iVar22 + 2);
              if (10 < (int)auStack_482) {
                auStack_482 = (undefined1  [2])0xa;
              }
              Ellipse(hdc,pt.x - (int)auStack_482,pt.y - (int)auStack_482,
                      pt.x + (int)auStack_482 + 1,pt.y + (int)auStack_482 + 1);
              auVar8 = (undefined1  [2])((int)auStack_482 + -2);
              if ((int)auStack_482 + -2 < 3) {
                auVar8 = (undefined1  [2])((int)auStack_482 + -1);
              }
              auStack_482 = auVar8;
              if ((int)auStack_482 < 1) {
                auStack_482 = (undefined1  [2])0x1;
              }
              HVar24 = hbrEnemy;
              if ((-1 < (long)stack0xfb7a) && (HVar24 = hbrYellow, (uint)cr == 0)) {
                HVar24 = hbrShip;
              }
              SelectObject(hdc,HVar24);
              HVar25 = hpenEnemy;
              if ((-1 < (long)stack0xfb7a) && (HVar25 = hpenYellow, (uint)cr == 0)) {
                HVar25 = hpenShip;
              }
              SelectObject(hdc,HVar25);
              Ellipse(hdc,pt.x - (int)auStack_482,pt.y - (int)auStack_482,
                      pt.x + (int)auStack_482 + 1,pt.y + (int)auStack_482 + 1);
              if (pPVar31->iPlayer != -1) {
                rc.left = pt.x + -1;
                rc.right = pt.x + 8;
                rc.top = pt.y + -0x14;
                rc.bottom = pt.y + -0xc;
                pRVar42 = &rc;
                uVar29 = unaff_SS;
                HVar44 = hdc;
                HVar23 = GetStockObject(4);
                FillRect(HVar44,(undefined2 *)CONCAT22(uVar29,pRVar42),HVar23);
                if (pPVar31->iPlayer == idPlayer) {
                  stack0xfb7a = (THING *)CONCAT22(dRad_2,hbrBBlue);
                }
                else {
                  iVar22 = idPlayer * 0xc0 + 0x5a12;
                  stack0xfb76 = (THING *)CONCAT22(iVar22,l_2._2_2_);
                  if (*(char *)(iVar22 + pPVar31->iPlayer) == '\x01') {
                    stack0xfb7a = (THING *)CONCAT22(dRad_2,hbrStarbase);
                  }
                  else {
                    iVar22 = idPlayer * 0xc0 + 0x5a12;
                    stack0xfb76 = (THING *)CONCAT22(iVar22,l_2._2_2_);
                    if (*(char *)(iVar22 + pPVar31->iPlayer) == '\0') {
                      stack0xfb7a = (THING *)CONCAT22(dRad_2,hbrRadar);
                    }
                    else {
                      stack0xfb7a = (THING *)CONCAT22(dRad_2,hbrEnemy);
                    }
                  }
                }
                SelectObject(hdc,(HGDIOBJ)lPop._2_2_);
                PatBlt(hdc,pt.x,pt.y + -0x13,1,0x15,0xf00021);
                PatBlt(hdc,pt.x,pt.y + -0x13,7,6,0xf00021);
              }
              SelectObject(hdc,HVar26);
              SelectObject(hdc,HVar27);
            }
          }
          else {
            if ((uVar9 == 1) || (uVar9 == 2)) {
              pTVar33 = (THING *)(uint)(uVar9 == 2);
              stack0xfb7a = (THING *)CONCAT22(dRad_2,pTVar33);
              cr._0_2_ = (uint)(iScanZoom < 0);
              if ((3 < (pPVar31->wFlags & 0xffU)) ||
                 ((pTVar33 != (THING *)0x0 && (2 < (pPVar31->wFlags & 0xffU))))) {
                stack0xfb7a = (THING *)CONCAT22(pt.x - *(int *)((uint)cr * 10 + 0x58c),pTVar33);
                stack0xfb76 = (THING *)CONCAT22(pt.y - *(int *)((uint)cr * 10 + 0x58e),l_2._2_2_);
                HVar27 = SelectObject(hdc,hbrButtonFace);
                PatBlt(hdc,dRad_2 + -2,(uint)lPop,*(short *)((uint)cr * 10 + 0x590),1,0xf00021);
                PatBlt(hdc,dRad_2 + -2,((uint)lPop - *(int *)((uint)cr * 10 + 0x590)) + 1,1,
                       *(short *)((uint)cr * 10 + 0x590),0xf00021);
                for (auStack_482 = (undefined1  [2])0x0; (int)auStack_482 < 3;
                    auStack_482 = (undefined1  [2])((int)auStack_482 + 1)) {
                  if (lPop._2_2_ == (THING *)0x0) {
                    l_2._0_2_ = *(PLANET **)(pPVar31->rgwtMin + (int)auStack_482);
                    l_2._2_2_ = (THING *)*(uint *)((int)(pPVar31->rgwtMin + (int)auStack_482) + 2);
                    uVar10 = cMinGrafMax / 0x28;
                    pPVar40 = (PLANET *)
                              __aFldiv(CONCAT22(((int)uVar10 >> 0xf) + (int)l_2._2_2_ +
                                                        (uint)CARRY2(uVar10,(uint)(PLANET *)l_2),
                                                        uVar10 + (int)(PLANET *)l_2),
                                               (long)(cMinGrafMax / 0x14));
                    l_2._0_2_ = (PLANET *)pPVar40;
                    stack0xfb76 = (THING *)CONCAT22((uint)lPop,(THING *)((ulong)pPVar40 >> 0x10));
                    if (0x14 < (long)pPVar40) {
                      l_2._0_2_ = (PLANET *)&hbrButtonHilite;
                      stack0xfb76 = (THING *)((ulong)(uint)lPop << 0x10);
                    }
                  }
                  else {
                    l_2._0_2_ = (PLANET *)(pPVar31->rgMinConc[(int)auStack_482] / 5);
                    if ((PLANET *)&hbrButtonHilite < (PLANET *)l_2) {
                      l_2._0_2_ = (PLANET *)&hbrButtonHilite;
                    }
                    stack0xfb76 = (THING *)((ulong)(uint)lPop << 0x10);
                  }
                  if ((uint)cr != 0) {
                    pPVar40 = (PLANET *)__aFldiv((long)CONCAT22(l_2._2_2_,(PLANET *)l_2),2);
                    l_2._0_2_ = (PLANET *)pPVar40;
                    stack0xfb76 = (THING *)CONCAT22((uint)lPop,(THING *)((ulong)pPVar40 >> 0x10));
                  }
                  if ((-1 < (int)l_2._2_2_) &&
                     ((0 < (int)l_2._2_2_ || ((PLANET *)l_2 != (PLANET *)0x0)))) {
                    SelectObject(hdc,((ushort *)rghbrMineral)[(int)auStack_482]);
                    PatBlt(hdc,dRad_2,(uint)lPop - (int)(PLANET *)l_2,
                           *(short *)((uint)cr * 10 + 0x592),(short)(PLANET *)l_2,0xf00021);
                  }
                  stack0xfb7a = (THING *)CONCAT22(dRad_2 + *(int *)((uint)cr * 10 + 0x594),
                                                  lPop._2_2_);
                }
                SelectObject(hdc,HVar27);
              }
            }
            else if (uVar9 == 4) {
              auStack_482 = (undefined1  [2])0x0;
              if (((pPVar31->wFlags & 0xffU) < 3) || (pPVar31->iPlayer == -1)) {
                if (pPVar31->iPlayer == -1) goto SCAN_LNormalScannerMode;
              }
              else {
                if (pPVar31->iPlayer == idPlayer) {
                  pTVar33 = (THING *)*(int *)((int)pPVar31->rgwtMin + 0xe);
                  stack0xfb76 = (THING *)CONCAT22((int)pPVar31->rgwtMin[3],l_2._2_2_);
                }
                else {
                  lVar41 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),(ushort)in_stack_0000f586);
                  pTVar33 = (THING *)((ulong)lVar41 >> 0x10);
                  stack0xfb76 = (THING *)CONCAT22((int)lVar41,l_2._2_2_);
                }
                for (dRad_2 = 0; dRad_2 < 0x13; dRad_2 = dRad_2 + 1) {
                  iVar22 = (int)*(uint *)(dRad_2 * 2) >> 0xf;
                  if (((int)pTVar33 <= iVar22) &&
                     (((int)pTVar33 < iVar22 || ((uint)lPop < *(uint *)(dRad_2 * 2))))) break;
                }
                stack0xfb7a = (THING *)CONCAT22(dRad_2 + 2,pTVar33);
                if (pPVar31->iPlayer == idPlayer) {
                  cr._0_2_ = 0;
                }
                else {
                  pTVar33 = (THING *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0)
                  ;
                  stack0xfb76 = (THING *)CONCAT22((uint)lPop,pTVar33);
                  if (pTVar33->rgb[pPVar31->iPlayer + -6] == 1) {
                    cr._0_2_ = 1;
                  }
                  else {
                    cr._0_2_ = 3;
                  }
                }
                HVar24 = hbrShip;
                if (((uint)cr != 0) && (HVar24 = hbrEnemy, (uint)cr != 3)) {
                  HVar24 = hbrYellow;
                }
                HVar27 = SelectObject(hdc,HVar24);
                HVar25 = hpenDkGreen;
                if (((uint)cr != 0) && (HVar25 = hpenEnemy, (uint)cr != 3)) {
                  HVar25 = hpenDkYellow;
                }
                HVar26 = SelectObject(hdc,HVar25);
                if (iScanZoom < 3) {
                  stack0xfb7a = (THING *)CONCAT22(dRad_2 + 1 >> 1,lPop._2_2_);
                }
                Ellipse(hdc,pt.x - dRad_2,pt.y - dRad_2,pt.x + dRad_2 + 1,pt.y + dRad_2 + 1);
                SelectObject(hdc,HVar26);
                SelectObject(hdc,HVar27);
              }
              goto LAB_1058_3257;
            }
SCAN_LNormalScannerMode:
            if (pPVar31->iPlayer == -1) {
              if ((((POINT *)rgptPlan + iVar22)->x != ptSelMain.x) ||
                 (*(int *)((int)&rgptPlan[0].y + iVar22 * 4) != ptSelMain.y)) {
                BitBlt(hdc,pt.x + -1,pt.y + -1,3,3,HVar20,0xb,0x12,0xcc0020);
              }
            }
            else if ((((POINT *)rgptPlan + iVar22)->x == ptSelMain.x) &&
                    (*(int *)((int)&rgptPlan[0].y + iVar22 * 4) == ptSelMain.y)) {
              if (pPVar31->iPlayer == idPlayer) {
                yBmp = 0;
              }
              else {
                cr._0_2_ = idPlayer * 0xc0 + 0x5a12;
                if (*(char *)((uint)cr + pPVar31->iPlayer) == '\x01') {
                  yBmp = 0x16;
                }
                else {
                  yBmp = 0xb;
                }
              }
              BitBlt(hdc,pt.x + -5,pt.y + -5,0xb,0xb,HVar20,0,0x45,0x8800c6);
              BitBlt(hdc,pt.x + -5,pt.y + -5,0xb,0xb,HVar20,0,yBmp,0xee0086);
              if (fStarbase != 0) {
                HVar24 = hbrBlue;
                if (fStarbase != 2) {
                  HVar24 = hbrYellow;
                }
                HVar27 = SelectObject(hdc,HVar24);
                PatBlt(hdc,pt.x + 4,pt.y + -6,5,5,0x42);
                PatBlt(hdc,pt.x + 5,pt.y + -6,3,5,0xf00021);
                PatBlt(hdc,pt.x + 4,pt.y + -5,5,3,0xf00021);
                SelectObject(hdc,HVar27);
              }
              if (bVar36) {
                HVar27 = SelectObject(hdc,hbrGreen);
                PatBlt(hdc,pt.x + -7,pt.y + -6,5,5,0x42);
                PatBlt(hdc,pt.x + -6,pt.y + -6,3,5,0xf00021);
                PatBlt(hdc,pt.x + -7,pt.y + -5,5,3,0xf00021);
                SelectObject(hdc,HVar27);
              }
              if (bVar37) {
                HVar27 = SelectObject(hdc,hbrPurple);
                PatBlt(hdc,pt.x + -2,pt.y + -9,5,5,0x42);
                PatBlt(hdc,pt.x + -1,pt.y + -9,3,5,0xf00021);
                PatBlt(hdc,pt.x + -2,pt.y + -8,5,3,0xf00021);
                SelectObject(hdc,HVar27);
              }
            }
            else {
              if (pPVar31->iPlayer == idPlayer) {
                yBmp = 0;
              }
              else {
                cr._0_2_ = idPlayer * 0xc0 + 0x5a12;
                if (*(char *)((uint)cr + pPVar31->iPlayer) == '\x01') {
                  yBmp = 10;
                }
                else {
                  yBmp = 5;
                }
              }
              BitBlt(hdc,pt.x + -2,pt.y + -2,5,5,HVar20,0xb,yBmp,0xcc0020);
              if (fStarbase != 0) {
                HVar24 = hbrBlue;
                if (fStarbase != 2) {
                  HVar24 = hbrYellow;
                }
                HVar27 = SelectObject(hdc,HVar24);
                PatBlt(hdc,pt.x + 3,pt.y + -4,3,3,0xf00021);
                SelectObject(hdc,HVar27);
              }
              if (bVar36) {
                HVar27 = SelectObject(hdc,hbrGreen);
                PatBlt(hdc,pt.x + -5,pt.y + -4,3,3,0x42);
                PatBlt(hdc,pt.x + -4,pt.y + -4,1,3,0xf00021);
                PatBlt(hdc,pt.x + -5,pt.y + -3,3,1,0xf00021);
                SelectObject(hdc,HVar27);
              }
              if (bVar37) {
                HVar27 = SelectObject(hdc,hbrPurple);
                PatBlt(hdc,pt.x + -1,pt.y + -6,3,3,0x42);
                PatBlt(hdc,pt.x,pt.y + -6,1,3,0xf00021);
                PatBlt(hdc,pt.x + -1,pt.y + -5,3,1,0xf00021);
                SelectObject(hdc,HVar27);
              }
            }
          }
        }
LAB_1058_3257:
        lppl = (PLANET *)CONCAT22(uVar35,pPVar31 + 1);
      }
    }
    if ((cFleet != 0) && (uVar9 != 5)) {
      HVar27 = SelectObject(hdc,hbrShip);
      iVar22 = sel.fl.id;
      if (sel.grobj != grobjFleet) {
        iVar22 = -1;
      }
      if (sel.scan.grobj == grobjFleet) {
        sVar21 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
      }
      else {
        sVar21 = -1;
      }
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar6 = ((FLEET **)rglpfl)[i];
        iVar32 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpflT = (FLEET *)CONCAT22(iVar32,pFVar6);
        if ((pFVar6 == (FLEET *)0x0) && (iVar32 == 0)) break;
        lVar41 = CShipsScanVis((FLEET *)CONCAT22(iVar32,pFVar6));
        if ((0 < lVar41) || ((lpflT->id == iVar22 || (lpflT->id == sVar21)))) {
          iVar34 = pFVar6->idPlanet;
          if (iVar34 == -1) {
            pt.x = (&pFVar6->pt)->x;
            pt.y = (pFVar6->pt).y;
          }
          else {
            pt.x = ((POINT *)rgptPlan + iVar34)->x;
            pt.y = *(short *)((int)&rgptPlan[0].y + iVar34 * 4);
          }
          if ((((iVar15 <= pt.x) && (pt.x < iVar16)) && (iVar17 <= pt.y)) && (pt.y < iVar28)) {
            pt.x = PtToScan(iVar18 + pt.x);
            pt.y = PtToScan(iVar19 - pt.y);
            bVar37 = pFVar6->iPlayer != idPlayer;
            uVar10 = (uint)bVar37;
            if (((&pFVar6->pt)->x == ptSelMain.x) && ((pFVar6->pt).y == ptSelMain.y)) {
              bVar36 = true;
            }
            else {
              bVar36 = false;
            }
            if (iVar34 == -1) {
              if (bVar36) {
                BitBlt(hdc,pt.x + -5,pt.y + -5,0xb,0xb,HVar20,0xb,uVar10 * 0xb + 0x24,0xee0086);
                if (((grbitScan & 0x1000) != 0) && (((uint)pFVar6->wFlags >> 0xb & 1) == 0))
                {
                  DrawScanFleetCount((FLEET *)CONCAT22(iVar32,pFVar6),pt.x,pt.y + -7,hdc,HVar20);
                }
              }
              else {
                SelectObject(HVar20,hbmpScanShip);
                if (uVar10 == 0) {
                  auStack_482 = (undefined1  [2])0x0;
                  cr._0_2_ = 0xff;
                }
                else {
                  iVar34 = idPlayer * 0xc0 + 0x5a12;
                  stack0xfb7a = (THING *)CONCAT22(iVar34,lPop._2_2_);
                  if (*(char *)(iVar34 + pFVar6->iPlayer) == '\x01') {
                    auStack_482 = (undefined1  [2])0xffff;
                    cr._0_2_ = 0;
                  }
                  else {
                    auStack_482 = (undefined1  [2])0xff;
                    cr._0_2_ = 0;
                  }
                }
                SetTextColor(hdc,CONCAT22((uint)cr,auStack_482));
                SetBkColor(hdc,0);
                GetScanFleetOrientation((FLEET *)CONCAT22(iVar32,pFVar6),&ptO,&ptD);
                BitBlt(hdc,pt.x - ptD.x / 2,pt.y - ptD.y / 2,ptD.x,ptD.y,HVar20,ptO.x,ptO.y,0xee0086
                      );
                if (((grbitScan & 0x1000) != 0) && (((uint)pFVar6->wFlags >> 0xb & 1) == 0))
                {
                  DrawScanFleetCount((FLEET *)CONCAT22(iVar32,pFVar6),pt.x,(pt.y - ptD.y / 2) + -2,
                                     hdc,HVar20);
                }
                SelectObject(HVar20,hbmpScanner);
              }
            }
            else if (((rgWhatsHere[iVar34] != '\x03') && ((int)rgWhatsHere[iVar34] != uVar10 + 1))
                    && (uVar9 < 3)) {
              rgWhatsHere[iVar34] = rgWhatsHere[iVar34] + bVar37 + '\x01';
              cVar5 = rgWhatsHere[iVar34];
              if (bVar36) {
                BitBlt(hdc,pt.x + -9,pt.y + -9,0x13,0x13,HVar20,0x1d,0x45,0x8800c6);
                BitBlt(hdc,pt.x + -9,pt.y + -9,0x13,0x13,HVar20,0x1d,(cVar5 + -1) * 0x13,0xee0086);
              }
              else {
                BitBlt(hdc,pt.x + -5,pt.y + -5,0xb,0xb,HVar20,0x10,0x45,0x8800c6);
                BitBlt(hdc,pt.x + -5,pt.y + -5,0xb,0xb,HVar20,0x10,(cVar5 + -1) * 0xb,0xee0086);
              }
              if (((grbitScan & 0x1000) != 0) && (((uint)pFVar6->wFlags >> 0xb & 1) == 0)) {
                if (bVar36) {
                  iVar34 = 9;
                }
                else {
                  iVar34 = 5;
                }
                DrawScanFleetCount((FLEET *)CONCAT22(iVar32,pFVar6),pt.x,(pt.y - iVar34) + -2,hdc,
                                   HVar20);
              }
            }
          }
        }
      }
      SelectObject(hdc,HVar27);
    }
    ExpandRc(prc,-dx_00,-dx_00);
    prc->bottom = prc->bottom + -0xe;
    CVar39 = SetTextColor(hdc,0);
    CVar38 = GetBkColor(hdc);
    uStack_47c = (undefined2)(CVar38 >> 0x10);
    cr._2_2_ = (undefined2)CVar38;
    if ((((sel.grobj == grobjFleet) || (sel.scan.grobj == grobjFleet)) ||
        (sel.scan.grobj == grobjThing)) ||
       ((sel.grobj == grobjPlanet && (((uint)sel.pl.wFlags >> 9 & 1) != 0)))) {
      IntersectClipRect(hdc,prc->left,prc->top,prc->right,prc->bottom);
      fOrdersVis = 0;
      DrawShipScanPath(hdc,1);
      SelectClipRgn(hdc,hrgnHuge);
      CVar38 = CONCAT22(uStack_47c,cr._2_2_);
    }
    uStack_47c = (undefined2)(CVar38 >> 0x10);
    cr._2_2_ = (undefined2)CVar38;
    SetBkColor(hdc,CVar38);
    SetTextColor(hdc,CVar39);
    SelectObject(HVar20,HVar11);
    DeleteDC(HVar20);
    if (hdcScreen != 0) {
      SetWindowOrg(hdc,0,0);
      BitBlt(hdcScreen,prc->left,prc->top,prc->right - prc->left,prc->bottom - prc->top,hdc,
             prc->left & 7,prc->top & 7,0xcc0020);
      SelectObject(hdc,hbmpXSav);
      DeleteObject(hbmpScreen);
      DeleteDC(hdc);
    }
  }
  return 0;
}



// ======================================================================
// Function: DrawScanFleetCount
// Address: 1058:47d2
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1058496f) */
/* WARNING: Removing unreachable block (ram,0x105848c3) */
/* WARNING: Removing unreachable block (ram,0x10584832) */
/* WARNING: Removing unreachable block (ram,0x105848e8) */
/* WARNING: Removing unreachable block (ram,0x10584a5c) */

void DrawScanFleetCount(FLEET *lpfl,short x,short y,HDC hdc,HDC hdcMem)

{
  int iVar1;
  bool bVar2;
  int iVar3;
  HGDIOBJ HVar4;
  long lVar5;
  long lVar6;
  long l;
  HBITMAP hbmpSav;
  short iPlr;
  FLEET *lpflWalk;
  COLORREF cr;
  short f999;
  long l2;
  
  lpflWalk = lpfl;
  if ((grbitScan & 0x2000) == 0) {
    iPlr = -2;
  }
  else {
    iPlr = -1;
  }
  lVar6 = 0;
  bVar2 = false;
  do {
    lVar5 = CShipsScanVis(lpflWalk);
    if (((0 < lVar5) && (lVar6 = lVar5 + lVar6, ((FLEET *)lpflWalk)->iPlayer != iPlr)) &&
       (iPlr != -2)) {
      if (iPlr == -1) {
        iPlr = ((FLEET *)lpflWalk)->iPlayer;
      }
      else {
        iPlr = -2;
      }
    }
    ((FLEET *)lpflWalk)->wFlags = ((FLEET *)lpflWalk)->wFlags & 0xf7ffU | 0x800;
                    /* WARNING: Load size is inaccurate */
    lpflWalk = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflWalk)->lpflNext + 2),
                                 ((FLEET *)lpflWalk)->lpflNext);
  } while (lpfl != lpflWalk);
  if (lVar6 < 1000) {
    if (lVar6 < 1) {
      return;
    }
  }
  else {
    lVar6 = 999;
  }
  l._0_2_ = (int)lVar6;
  HVar4 = SelectObject(hdcMem,hbmpNumbers);
  SetBkColor(hdc,0);
  SetTextColor(hdc,0xffffff);
  if ((iPlr < 0) || (iPlr == idPlayer)) {
    cr._0_2_ = -1;
    cr._2_2_ = 0xff;
  }
  else {
    cr._0_2_ = *(int *)(iPlr * 4 + 0x2e);
    cr._2_2_ = *(int *)(iPlr * 4 + 0x30);
  }
  iVar1 = y + -7;
  iVar3 = x + -1;
  if (99 < lVar6) {
    bVar2 = true;
    if (((int)cr != -1) || (cr._2_2_ != 0xff)) {
      BitBlt(hdc,x + -6,iVar1,4,7,hdcMem,(int)l / 100 << 2,0,0x220326);
      SetTextColor(hdc,CONCAT22(cr._2_2_,(int)cr));
    }
    BitBlt(hdc,x + -6,iVar1,4,7,hdcMem,(int)l / 100 << 2,0,0xee0086);
    if (((int)cr != -1) || (cr._2_2_ != 0xff)) {
      SetTextColor(hdc,0xffffff);
    }
    lVar6 = __aFlrem(lVar6,100);
    iVar3 = x + 2;
  }
  x = iVar3;
  l._0_2_ = (int)lVar6;
  if ((9 < lVar6) || (bVar2)) {
    if (((int)cr != -1) || (cr._2_2_ != 0xff)) {
      BitBlt(hdc,x + -3,iVar1,4,7,hdcMem,(int)l / 10 << 2,0,0x220326);
      SetTextColor(hdc,CONCAT22(cr._2_2_,(int)cr));
    }
    BitBlt(hdc,x + -3,iVar1,4,7,hdcMem,(int)l / 10 << 2,0,0xee0086);
    if (((int)cr != -1) || (cr._2_2_ != 0xff)) {
      SetTextColor(hdc,0xffffff);
    }
    x = x + 2;
    lVar6 = __aFlrem(lVar6,10);
  }
  l._0_2_ = (int)lVar6;
  if (((int)cr != -1) || (cr._2_2_ != 0xff)) {
    BitBlt(hdc,x,iVar1,4,7,hdcMem,(int)l << 2,0,0x220326);
    SetTextColor(hdc,CONCAT22(cr._2_2_,(int)cr));
  }
  BitBlt(hdc,x,iVar1,4,7,hdcMem,(int)l << 2,0,0xee0086);
  if (((int)cr != -1) || (cr._2_2_ != 0xff)) {
    SetTextColor(hdc,0xffffff);
  }
  SelectObject(hdcMem,HVar4);
  return;
}



// ======================================================================
// Function: CShipsScanVis
// Address: 1058:4bf4
// Segment: MEMORY_SCAN
// ======================================================================


long CShipsScanVis(FLEET *lpfl)

{
  uint uVar1;
  int iVar2;
  bool bVar3;
  HULDEF *pHVar4;
  ushort grbitSh_2;
  short k;
  long csh;
  short j;
  
  csh._0_2_ = 0;
  csh._2_2_ = 0;
  if ((grbitScan & 0x100) != 0) {
    if ((((FLEET *)lpfl)->iPlayer == idPlayer) &&
       ((((((FLEET *)lpfl)->cord != 1 ||
          ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 6)) ||
         ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 5)) ||
        (((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 3 ||
         ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 7)))))) {
      csh._0_2_ = 0;
      csh._2_2_ = 0;
      goto LAB_1058_4e75;
    }
    if ((((FLEET *)lpfl)->iPlayer != idPlayer) && ((((FLEET *)lpfl)->wFlags & 0xfU) == 0)) {
      csh._0_2_ = 0;
      csh._2_2_ = 0;
      goto LAB_1058_4e75;
    }
  }
  if (((grbitScan & 0x200) == 0) || (((FLEET *)lpfl)->iPlayer != idPlayer)) {
    if (((grbitScan & 0x800) == 0) || (((FLEET *)lpfl)->iPlayer == idPlayer)) {
      for (j = 0; j < 0x10; j = j + 1) {
        uVar1 = ((FLEET *)lpfl)->rgcsh[j];
        bVar3 = CARRY2((uint)csh,uVar1);
        csh._0_2_ = (uint)csh + uVar1;
        csh._2_2_ = csh._2_2_ + ((int)uVar1 >> 0xf) + (uint)bVar3;
      }
    }
    else {
      j = 0;
      for (grbitSh_2 = grbitScanEShip; grbitSh_2 != 0; grbitSh_2 = grbitSh_2 >> 1) {
        if ((grbitSh_2 & 1) != 0) {
          for (k = 0; k < 0x10; k = k + 1) {
            if ((0 < ((FLEET *)lpfl)->rgcsh[k]) &&
               (iVar2 = ((FLEET *)lpfl)->iPlayer * 4,
               pHVar4 = LphuldefFromId(*(HullDef *)(*(int *)(iVar2 + 0xfe) + k * 0x93)),
               ((uint)((HULDEF *)pHVar4)->wFlags >> 10 & 0xf) == j)) {
              uVar1 = ((FLEET *)lpfl)->rgcsh[k];
              bVar3 = CARRY2((uint)csh,uVar1);
              csh._0_2_ = (uint)csh + uVar1;
              csh._2_2_ = csh._2_2_ + ((int)uVar1 >> 0xf) + (uint)bVar3;
            }
          }
        }
        j = j + 1;
      }
    }
  }
  else {
    j = 0;
    for (grbitSh_2 = grbitScanShip; grbitSh_2 != 0; grbitSh_2 = grbitSh_2 >> 1) {
      if (((grbitSh_2 & 1) != 0) && (0 < ((FLEET *)lpfl)->rgcsh[j])) {
        uVar1 = ((FLEET *)lpfl)->rgcsh[j];
        bVar3 = CARRY2((uint)csh,uVar1);
        csh._0_2_ = (uint)csh + uVar1;
        csh._2_2_ = csh._2_2_ + ((int)uVar1 >> 0xf) + (uint)bVar3;
      }
      j = j + 1;
    }
  }
LAB_1058_4e75:
  return CONCAT22(csh._2_2_,(uint)csh);
}



// ======================================================================
// Function: DrawRadarCircle
// Address: 1058:4e7c
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10584f8a) */
/* WARNING: Removing unreachable block (ram,0x10584f71) */
/* WARNING: Removing unreachable block (ram,0x10584fd1) */

void DrawRadarCircle(DRAWCIR *pdc,RECT *prc)

{
  double dVar1;
  BOOL BVar2;
  int iVar3;
  int iVar4;
  int iVar5;
  int iVar6;
  int iVar7;
  int iVar8;
  int iVar9;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  bool bVar10;
  bool bVar11;
  ulong uVar12;
  ulong uVar13;
  ulong uVar14;
  COLORREF CVar15;
  RECT rc;
  short x;
  long l;
  short rad;
  short x2;
  short dx;
  short i;
  short iFree;
  short y;
  short dy;
  COLORREF crSav;
  long r2;
  short y2;
  
  CVar15 = CONCAT22(crSav._2_2_,(undefined2)crSav);
  if ((prc == (RECT *)0x0) ||
     ((pdc->fCovered == 0 &&
      (BVar2 = IntersectRect((undefined2 *)CONCAT22(unaff_SS,&rc),
                             (undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,prc),
                             (undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,&pdc->rcClip)),
      BVar2 != 0)))) {
    if (prc == (RECT *)0x0) {
      if (pdc->fHollowOut != 0) {
        SetROP2(pdc->hdc,9);
        CVar15 = SetBkColor(pdc->hdc,0xffffff);
        l = 1;
      }
      while( true ) {
        for (i = 0; i < pdc->cCur; i = i + 1) {
          if (0 < pdc->rgrad[i]) {
            iVar3 = pdc->rgrad[i];
            Ellipse(pdc->hdc,pdc->rgx[i] - iVar3,pdc->rgy[i] - iVar3,pdc->rgx[i] + iVar3 + 1,
                    pdc->rgy[i] + iVar3 + 1);
          }
        }
        if (((pdc->fHollowOut == 0) || ((int)l != 1)) || (l._2_2_ != 0)) break;
        l = 0;
        SetBkColor(pdc->hdc,CVar15);
        SetROP2(pdc->hdc,0xf);
      }
      pdc->fCovered = 0;
      pdc->cCur = 0;
    }
    else {
      iVar3 = prc->right - prc->left;
      iVar4 = iVar3 >> 1;
      iVar5 = prc->left + iVar4;
      iVar6 = prc->top + iVar4;
      iVar3 = iVar3 >> 0xf;
      uVar12 = __aFulmul(CONCAT22(iVar3,iVar4),CONCAT22(iVar3,iVar4));
      for (i = 0; i < 4; i = i + 1) {
        if (i < 2) {
          iVar3 = (&pdc->rcClip)->left;
        }
        else {
          iVar3 = (pdc->rcClip).right;
        }
        if ((i & 1U) == 0) {
          iVar7 = (pdc->rcClip).bottom;
        }
        else {
          iVar7 = (pdc->rcClip).top;
        }
        iVar3 = iVar3 - iVar5;
        iVar7 = iVar7 - iVar6;
        if (((long)uVar12 < (long)iVar3) || ((long)uVar12 < (long)iVar7)) break;
        uVar14 = __aFulmul((long)iVar7,(long)iVar7);
        uVar13 = __aFulmul((long)iVar3,(long)iVar3);
        if ((long)uVar12 < (long)(uVar13 + uVar14)) break;
      }
      if (i == 4) {
        pdc->fCovered = 1;
        pdc->cCur = 0;
      }
      else if (pdc->cCur != pdc->cMax) {
        iFree = pdc->cCur;
        i = 0;
        do {
          if (pdc->cCur <= i) {
            pdc->rgx[iFree] = iVar5;
            pdc->rgy[iFree] = iVar6;
            pdc->rgrad[iFree] = iVar4;
            if (iFree != pdc->cCur) {
              return;
            }
            pdc->cCur = pdc->cCur + 1;
            return;
          }
          if (pdc->rgrad[i] < 1) {
            iFree = i;
          }
          else {
            iVar3 = pdc->rgx[i];
            iVar7 = pdc->rgy[i];
            iVar8 = iVar5 - iVar3;
            iVar9 = iVar6 - iVar7;
            uVar12 = __aFulmul((long)iVar9,(long)iVar9);
            uVar14 = __aFulmul((long)iVar8,(long)iVar8);
            if (pdc->rgrad[i] < iVar4) {
              dVar1 = (double)(long)(uVar14 + uVar12);
              _sqrt(SUB84(dVar1,0),
                            (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20)
                                                              )));
              bVar10 = CARRY2((uint)pdc->rgrad,i * 2);
              bVar11 = pdc->rgrad + i == (short *)0x0;
              __aFfcompp();
              if (bVar10 || bVar11) {
                pdc->rgrad[i] = 0;
                iFree = i;
              }
            }
            else if (iVar4 < pdc->rgrad[i]) {
              dVar1 = (double)(long)(uVar14 + uVar12);
              _sqrt(SUB84(dVar1,0),
                            (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20)
                                                              )));
              bVar10 = (undefined1 *)0xfff7 < &stack0xffb0;
              bVar11 = &stack0x0000 == (undefined1 *)((int)(ulong *)rgcrPlrHistory + 0x1a);
              __aFfcompp();
              if (bVar10 || bVar11) {
                return;
              }
            }
            else if ((iVar3 == iVar5) && (iVar7 == iVar6)) {
              return;
            }
          }
          i = i + 1;
        } while( true );
      }
      if (pdc->fHollowOut != 0) {
        SetROP2(pdc->hdc,9);
        CVar15 = SetBkColor(pdc->hdc,0xffffff);
        Ellipse(pdc->hdc,prc->left,prc->top,prc->right,prc->bottom);
        SetBkColor(pdc->hdc,CVar15);
        SetROP2(pdc->hdc,0xf);
      }
      Ellipse(pdc->hdc,prc->left,prc->top,prc->right,prc->bottom);
    }
  }
  return;
}



// ======================================================================
// Function: DrawShipScanPath
// Address: 1058:540c
// Segment: MEMORY_SCAN
// ======================================================================


void DrawShipScanPath(HDC hdc,short fShow)

{
  double dVar1;
  undefined4 uVar2;
  bool bVar3;
  uint uVar4;
  short sVar5;
  short sVar6;
  HGDIOBJ HVar7;
  short sVar8;
  HGDIOBJ HVar9;
  THING *pTVar10;
  ORDER *pOVar11;
  short *psVar12;
  undefined2 unaff_SI;
  ushort unaff_DI;
  undefined2 uVar13;
  undefined2 unaff_SS;
  bool bVar14;
  ulong uVar15;
  long lVar16;
  double *pdVar17;
  short sVar18;
  int iVar19;
  int iVar20;
  undefined2 uVar21;
  HDC HVar22;
  undefined2 in_stack_0000fee8;
  long local_10e;
  double m;
  short dy5;
  POINT ptTick;
  short dx5;
  POINT rgptArrow [2];
  double dAngle;
  short fDoneRoute;
  RECT rc;
  short dx;
  short dRad;
  long lWarp2;
  short fHdc;
  short i;
  FLEET *lpfl;
  POINT ptCur;
  ORDER *lpord1;
  short dy;
  short iRopSav;
  POINT pt;
  POINT pt2;
  HPEN hpenSav;
  short j;
  short rgDup [87];
  ORDER *lpord2;
  
  if (((sel.grobj != grobjFleet) && (sel.scan.grobj != grobjFleet)) &&
     (sel.scan.grobj != grobjThing)) {
    if (sel.grobj != grobjPlanet) {
      return;
    }
    if (((((uint)sel.pl.wFlags >> 9 & 1) == 0) ||
        ((sel.pl.wFlags & 0x3ffU) == 0)) && ((sel.pl.wRouting & 0x3ffU) == 0)) {
      return;
    }
  }
  if (fShow == fOrdersVis) {
    return;
  }
  if ((gd._4_2_ & 1) != 0) {
    return;
  }
  fOrdersVis = fShow;
  bVar14 = hdc == 0;
  if (bVar14) {
    hdc = GetDC(hwndScanner);
  }
  if ((sel.scan.grobj == grobjThing) && (sel.scan.ith != -1)) {
    pTVar10 = (THING *)lpThings + sel.scan.ith;
    ptCur.x = (&pTVar10->pt)->x;
    ptCur.y = (pTVar10->pt).y;
    if ((uint)((THING *)CONCAT22(lpThings._2_2_,pTVar10))->idFull >> 0xd == 3) {
      dx = *(int *)pTVar10->rgb - ptCur.x;
      dy = *(int *)(pTVar10->rgb + 2) - ptCur.y;
      uVar4 = *(uint *)(pTVar10->rgb + 4) & 0xf;
    }
    else {
      if (((uint)((THING *)CONCAT22(lpThings._2_2_,pTVar10))->idFull >> 0xd != 1) ||
         ((*(uint *)pTVar10->rgb >> 10 & 0xf) == 0)) goto SCAN_LNextCheck;
      dx = ((POINT *)rgptPlan + (*(uint *)pTVar10->rgb & 0x3ff))->x - ptCur.x;
      dy = *(int *)((int)&rgptPlan[0].y + (*(uint *)pTVar10->rgb & 0x3ff) * 4) - ptCur.y;
      uVar4 = (*(uint *)pTVar10->rgb >> 10 & 0xf) + 4;
    }
    if ((dx == 0) && (dy == 0)) goto SCAN_LNextCheck;
    uVar15 = __aFulmul((ulong)uVar4,5);
    lWarp2 = __aFulmul((ulong)uVar4,uVar15);
  }
  else {
SCAN_LNextCheck:
    if (sel.scan.grobj != grobjFleet) goto SCAN_LNoObjPath;
    iVar20 = *(int *)((FLEET **)rglpfl + sel.scan.ifl);
    iVar19 = *(int *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
    ptCur.x = *(short *)(iVar20 + 8);
    ptCur.y = *(short *)(iVar20 + 10);
    if (((*(uint *)(iVar20 + 0x76) >> 4 & 1) == 0) || ((*(uint *)(iVar20 + 0x76) & 0xf) == 0))
    goto SCAN_LNoObjPath;
    dx = (*(uint *)(iVar20 + 0x74) & 0xff) - 0x7f;
    dy = (*(uint *)(iVar20 + 0x74) >> 8) - 0x7f;
    if ((dx == 0) && (dy == 0)) goto SCAN_LNoObjPath;
    lWarp2 = (long)((*(uint *)(iVar20 + 0x76) & 0xf) * (*(uint *)(iVar20 + 0x76) & 0xf) * 5);
  }
  GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
  ExcludeClipRect(hdc,rc.left,rc.bottom - dySBar,rc.right,rc.bottom);
  HVar7 = SelectObject(hdc,hpenStarbase);
  sVar8 = SetROP2(hdc,7);
  iVar20 = dy >> 0xf;
  iVar19 = dx >> 0xf;
  if (dx == 0) {
    dx5 = 0;
    dy5 = (int)lWarp2;
    if (dy < 0) {
      dy5 = -(int)lWarp2;
    }
  }
  else {
    uVar15 = __aFulmul(lWarp2,lWarp2);
    local_10e = (long)dy;
    dVar1 = (double)(long)uVar15 /
            (((double)local_10e / (double)(long)dx) * ((double)local_10e / (double)(long)dx) + 1.0);
    sVar5 = dx;
    _sqrt(SUB84(dVar1,0),
                  (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20))));
    lVar16 = __ftol((double)CONCAT26(sVar5,CONCAT24(in_stack_0000fee8,
                                                            CONCAT22(unaff_SI,unaff_DI))));
    dx5 = (short)lVar16;
    if (dx < 0) {
      dx5 = -dx5;
    }
    sVar5 = dx;
    uVar15 = __aFulmul((long)dx5,(long)dy);
    lVar16 = __aFldiv(uVar15,CONCAT22(iVar19,sVar5));
    dy5 = (short)lVar16;
  }
  LogicalToScan(&ptCur);
  sVar5 = PtToScan(dx5);
  sVar6 = PtToScan(dy5);
  MoveTo(hdc,ptCur.x - sVar5,ptCur.y + sVar6);
  LineTo(hdc,ptCur.x + sVar5,ptCur.y + -sVar6);
  if (dy == 0) {
    ptTick.x = 0;
    if (dx < 0) {
      ptTick.y = -4;
    }
    else {
      ptTick.y = 4;
    }
  }
  else {
    local_10e = (long)-dx;
    dVar1 = DOUBLE_24_0__1120_1ce2 /
            (((double)local_10e / (double)(long)dy) * ((double)local_10e / (double)(long)dy) + 1.0);
    sVar18 = dy;
    _sqrt(SUB84(dVar1,0),
                  (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20))));
    lVar16 = __ftol((double)CONCAT26(sVar18,CONCAT24(in_stack_0000fee8,
                                                             CONCAT22(unaff_SI,unaff_DI))));
    ptTick.x = (short)lVar16;
    if (ptTick.x == 0) {
      if (dy < 0) {
        ptTick.y = -4;
      }
      else {
        ptTick.y = 4;
      }
    }
    else {
      if (0 < dx) {
        ptTick.x = -ptTick.x;
      }
      sVar18 = dy;
      uVar15 = __aFulmul((long)ptTick.x,(long)dx);
      lVar16 = __aFldiv(uVar15,CONCAT22(iVar20,sVar18));
      ptTick.y = (short)lVar16;
    }
  }
  local_10e = (long)-dx;
  dVar1 = (double)local_10e;
  pdVar17 = _atan2(SUB84((double)(long)-dy,0),
                           (double)CONCAT26((int)((qword)dVar1 >> 0x10),
                                            CONCAT24(SUB82(dVar1,0),
                                                     (long)((qword)(double)(long)-dy >> 0x20))),
                           (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20))
                                           ));
  _dAngle = *(double *)pdVar17 - DOUBLE_0_7853982__1120_1cea;
  for (i = 0; i < 2; i = i + 1) {
    uVar13 = SUB102((longdouble)5,0);
    uVar21 = (undefined2)((unkuint10)(longdouble)5 >> 0x10);
    uVar2 = (undefined4)((qword)_dAngle >> 0x20);
    _cos(SUB84(_dAngle,0),(double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,uVar2)));
    lVar16 = __ftol((double)CONCAT26(uVar21,CONCAT24(uVar13,CONCAT22(unaff_SI,unaff_DI))));
    (rgptArrow + i)->x = (short)lVar16;
    uVar13 = SUB102((longdouble)5,0);
    uVar21 = (undefined2)((unkuint10)(longdouble)5 >> 0x10);
    _sin(SUB84(_dAngle,0),(double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,uVar2)));
    lVar16 = __ftol((double)CONCAT26(uVar21,CONCAT24(uVar13,CONCAT22(unaff_SI,unaff_DI))));
    rgptArrow[i].y = (short)lVar16;
    _dAngle = DOUBLE_1_5707964__1120_1cfa + _dAngle;
  }
  j = -5;
  for (i = -5; i < 6; i = i + 1) {
    if (i == 0) {
      j = 5;
    }
    else {
      uVar21 = 0;
      uVar13 = 10;
      __aFulmul((long)sVar5,(long)i);
      lVar16 = __aFlshl(CONCAT22(uVar21,uVar13),unaff_DI);
      lVar16 = __aFldiv(lVar16 + j,CONCAT22(uVar21,uVar13));
      pt.x = (int)lVar16 + ptCur.x;
      uVar21 = 0;
      uVar13 = 10;
      __aFulmul((long)-sVar6,(long)i);
      lVar16 = __aFlshl(CONCAT22(uVar21,uVar13),unaff_DI);
      lVar16 = __aFldiv(lVar16 + j,CONCAT22(uVar21,uVar13));
      pt.y = (int)lVar16 + ptCur.y;
      if (i < 1) {
        MoveTo(hdc,pt.x + ptTick.x,pt.y + ptTick.y);
        LineTo(hdc,pt.x - ptTick.x,pt.y - ptTick.y);
        LineTo(hdc,pt.x - ptTick.x,(pt.y - ptTick.y) + -1);
      }
      else {
        for (j = 0; j < 2; j = j + 1) {
          MoveTo(hdc,pt.x + (rgptArrow + j)->x,pt.y - rgptArrow[j].y);
          LineTo(hdc,pt.x,pt.y);
        }
      }
    }
  }
  SetROP2(hdc,sVar8);
  SelectObject(hdc,HVar7);
SCAN_LNoObjPath:
  if (sel.grobj == grobjPlanet) {
    bVar3 = false;
    if ((((uint)sel.pl.wFlags >> 9 & 1) != 0) && ((sel.pl.wFlags & 0x3ffU) != 0)
       ) {
      hpenSav = SelectObject(hdc,hpenDkPurple);
      bVar3 = false;
      uVar4 = sel.pl.wFlags;
      goto SCAN_LDrawPath;
    }
    while ((uVar4 = sel.pl.wRouting, (sel.pl.wRouting & 0x3ffU) != 0 && (!bVar3)
           )) {
      bVar3 = true;
      hpenSav = SelectObject(hdc,hpenDkGreen);
SCAN_LDrawPath:
      fDoneRoute = (uVar4 & 0x3ff) - 1;
      sVar8 = SetROP2(hdc,7);
      GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
      ExcludeClipRect(hdc,rc.left,rc.bottom - dySBar,rc.right,rc.bottom);
      pt.x = ((POINT *)rgptPlan + sel.pl.id)->x;
      pt.y = *(short *)((int)&rgptPlan[0].y + sel.pl.id * 4);
      LogicalToScan(&pt);
      MoveTo(hdc,pt.x,pt.y);
      pt.x = ((POINT *)rgptPlan + fDoneRoute)->x;
      pt.y = *(short *)((int)&rgptPlan[0].y + fDoneRoute * 4);
      LogicalToScan(&pt);
      LineTo(hdc,pt.x,pt.y);
      SetROP2(hdc,sVar8);
      SelectObject(hdc,hpenSav);
    }
  }
  else if ((sel.grobj == grobjFleet) && (1 < sel.fl.cord)) {
    _memset(rgDup,0,sel.fl.cord << 1);
    lpord1 = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,
                               (ORDER *)((PLORD *)sel.fl.lpplord + 1));
    pt.x = (lpord1->pt).x;
    pt.y = *(short *)&((PLORD *)sel.fl.lpplord)[1].iordMax;
    for (i = 1; i < sel.fl.cord; i = i + 1) {
      lpord2 = (ORDER *)CONCAT22(lpord1._2_2_,(ORDER *)lpord1 + 1);
      pt2.x = (lpord2->pt).x;
      pt2.y = ((ORDER *)lpord1)[1].pt.y;
      j = i;
      if (rgDup[i] == 0) {
        while (j = j + 1, j < sel.fl.cord) {
          uVar13 = (undefined2)((ulong)lpord2 >> 0x10);
          pOVar11 = (ORDER *)lpord2;
          if (((((pt.x == (lpord2->pt).x) && (pt.y == (pOVar11->pt).y)) &&
               (pt2.x == ((pOVar11 + 1)->pt).x)) && (pt2.y == pOVar11[1].pt.y)) ||
             (((pt2.x == (lpord2->pt).x && (pt2.y == (pOVar11->pt).y)) &&
              ((pt.x == ((pOVar11 + 1)->pt).x && (pt.y == pOVar11[1].pt.y)))))) {
            rgDup[i] = 1;
            rgDup[j] = 2;
          }
          lpord2 = (ORDER *)CONCAT22(uVar13,pOVar11 + 1);
        }
      }
      pt.x = pt2.x;
      pt.y = pt2.y;
      lpord1 = (ORDER *)CONCAT22(lpord1._2_2_,(ORDER *)lpord1 + 1);
    }
    GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
    ExcludeClipRect(hdc,rc.left,rc.bottom - dySBar,rc.right,rc.bottom);
    if ((fShow != 0) && ((grbitScan & 0x80) != 0)) {
      HVar7 = SelectObject(hdc,hpenStarbase);
      uVar13 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
      pt.x = ((PLORD *)sel.fl.lpplord + 1)->wFlags;
      pt.y = *(short *)&((PLORD *)sel.fl.lpplord)[1].iordMax;
      LogicalToScan(&pt);
      MoveTo(hdc,pt.x,pt.y);
      for (i = 1; i < sel.fl.cord; i = i + 1) {
        psVar12 = (short *)((int)(PLORD *)sel.fl.lpplord + i * 0x12 + 4);
        pt2.x = *psVar12;
        pt2.y = psVar12[1];
        LogicalToScan(&pt2);
        LineTo(hdc,pt2.x,pt2.y);
        pt.x = pt2.x;
        pt.y = pt2.y;
      }
      SelectObject(hdc,HVar7);
    }
    HVar7 = SelectObject(hdc,hpenShip);
    sVar8 = SetROP2(hdc,7);
    uVar13 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
    pt.x = ((PLORD *)sel.fl.lpplord + 1)->wFlags;
    pt.y = *(short *)&((PLORD *)sel.fl.lpplord)[1].iordMax;
    LogicalToScan(&pt);
    ExcludeClipRect(hdc,pt.x + -5,pt.y + -5,pt.x + 6,pt.y + 6);
    MoveTo(hdc,pt.x,pt.y);
    for (i = 1; i < sel.fl.cord; i = i + 1) {
      psVar12 = (short *)((int)(PLORD *)sel.fl.lpplord + i * 0x12 + 4);
      pt2.x = *psVar12;
      pt2.y = psVar12[1];
      LogicalToScan(&pt2);
      ExcludeClipRect(hdc,pt2.x + -5,pt2.y + -5,pt2.x + 6,pt2.y + 6);
      if (rgDup[i] == 2) {
        MoveTo(hdc,pt2.x,pt2.y);
      }
      else {
        if (rgDup[i] == 1) {
          HVar9 = hpenYellow;
          HVar22 = hdc;
          if ((grbitScan & 0x80) == 0) {
            HVar9 = GetStockObject(6);
          }
          SelectObject(HVar22,HVar9);
        }
        LineTo(hdc,pt2.x,pt2.y);
        if (rgDup[i] == 1) {
          SelectObject(hdc,hpenShip);
        }
      }
      pt.x = pt2.x;
      pt.y = pt2.y;
    }
    SetROP2(hdc,sVar8);
    SelectObject(hdc,HVar7);
    SelectClipRgn(hdc,hrgnHuge);
  }
  if (bVar14) {
    ReleaseDC(hwndScanner,hdc);
  }
  return;
}



// ======================================================================
// Function: DrawScannerSBar
// Address: 1058:62d8
// Segment: MEMORY_SCAN
// ======================================================================


void DrawScannerSBar(HDC hdc,RECT *prc,SBAR *psbar,short fFullRedraw)

{
  bool bVar1;
  BOOL BVar2;
  HGDIOBJ HVar3;
  short sVar4;
  HGDIOBJ HVar5;
  short sVar6;
  GrobjClass GVar7;
  char *pcVar8;
  ushort uVar9;
  int iVar10;
  int iVar11;
  undefined2 unaff_SS;
  bool bVar12;
  COLORREF CVar13;
  DWORD DVar14;
  DWORD DVar15;
  undefined1 *puVar16;
  RECT *pRVar17;
  undefined2 uVar18;
  UINT UVar19;
  UINT UVar20;
  HDC HVar21;
  char szBuf [100];
  RECT rc;
  RECT rcT;
  short grobj;
  long l;
  short fDoName;
  HBRUSH hbrSav;
  char *psz;
  RECT rcClip;
  HFONT hfontSav;
  short dxHole;
  COLORREF crBk;
  short c;
  short iBkPrev;
  short grReal;
  POINT pt;
  short id;
  POINT pt2;
  COLORREF crText;
  short fhdc;
  
  bVar1 = true;
  GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
  rc.top = rc.bottom - dySBar;
  if ((prc == (RECT *)0x0) ||
     (BVar2 = IntersectRect((undefined2 *)CONCAT22(unaff_SS,&rcT),
                            (undefined2 *)CONCAT22((undefined1 *)&DAT_1120_1120,prc),
                            (undefined2 *)CONCAT22(unaff_SS,&rc)), BVar2 != 0)) {
    bVar12 = hdc == 0;
    if (bVar12) {
      hdc = GetDC(hwndScanner);
    }
    HVar3 = SelectObject(hdc,rghfontArial8[1]);
    if (psbar == (SBAR *)0x0) {
      grobj = sel.scan.grobj;
    }
    else {
      grobj = psbar->grbit;
    }
    sVar4 = SetBkMode(hdc,1);
    CVar13 = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace
                                    ));
    SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
    HVar5 = SelectObject(hdc,hbrButtonFace);
    if (fFullRedraw != 0) {
      PatBlt(hdc,rc.left,rc.top,rc.right - rc.left,dySBar,0xf00021);
      SelectObject(hdc,hbrButtonHilite);
      PatBlt(hdc,rc.left,rc.top,1,dySBar,0xf00021);
      PatBlt(hdc,rc.left,rc.top,rc.right - rc.left,1,0xf00021);
    }
    rc.bottom = rc.bottom - (dySBar >> 1);
    rcT.right = rc.right;
    rcT.top = rc.top + 4;
    rcT.bottom = rc.bottom + -4;
    rcT.left = rc.left + 4;
    if (0x167 < rc.right) {
      DVar14 = GetTextExtent(hdc,(LPCSTR)0x112005a2,7);
      rcT.right = (int)DVar14 + 6 + rcT.left;
      DrawLockLight(hdc,&rcT,fFullRedraw);
      if ((grobj & 1U) == 0) {
        if (grobj == 4) {
          if (psbar == (SBAR *)0x0) {
            id = sel.scan.iwp;
          }
          else {
            id = psbar->id;
          }
          sVar6 = _WSPRINTF((LPSTR)CONCAT22(id,(char *)&DAT_1120_1120),(LPCSTR)0x5b11120,
                            (char *)szWork);
          TextOut(hdc,rcT.left + 3,rcT.top + 2,szWork,sVar6);
        }
      }
      else {
        if (psbar == (SBAR *)0x0) {
          id = sel.scan.idpl;
        }
        else {
          id = psbar->id;
        }
        if (id != -1) {
          sVar6 = _WSPRINTF((LPSTR)CONCAT22(id + 1,(char *)&DAT_1120_1120),(LPCSTR)0x5aa1120,
                            (char *)szWork);
          SetBkMode(hdc,2);
          TextOut(hdc,rcT.left + 3,rcT.top + 2,szWork,sVar6);
        }
      }
      DVar15 = GetTextExtent(hdc,(LPCSTR)0x112005b8,7);
      iVar10 = (int)DVar15;
      rcT.left = rcT.left + (int)DVar14 + 10;
      rcT.right = iVar10 + 6 + rcT.left;
      DrawLockLight(hdc,&rcT,fFullRedraw);
      if (psbar == (SBAR *)0x0) {
        if (grobj == 0) {
          pt.y = 0;
          pt.x = 0;
        }
        else {
          pt.x = sel.scan.pt.x;
          pt.y = sel.scan.pt.y;
        }
      }
      else {
        pt.x = (&psbar->pt)->x;
        pt.y = (psbar->pt).y;
      }
      if (0 < pt.x) {
        sVar6 = _WSPRINTF((LPSTR)CONCAT22(pt.x,(char *)&DAT_1120_1120),(LPCSTR)0x5c01120,
                          (char *)szWork);
        SetBkMode(hdc,2);
        TextOut(hdc,rcT.left + 3,rcT.top + 2,szWork,sVar6);
      }
      rcT.left = rcT.left + iVar10 + 10;
      rcT.right = iVar10 + 6 + rcT.left;
      DrawLockLight(hdc,&rcT,fFullRedraw);
      if (0 < pt.y) {
        sVar6 = _WSPRINTF((LPSTR)CONCAT22(pt.y,(char *)&DAT_1120_1120),(LPCSTR)0x5c61120,
                          (char *)szWork);
        SetBkMode(hdc,2);
        TextOut(hdc,rcT.left + 3,rcT.top + 2,szWork,sVar6);
      }
      rcT.left = rcT.left + iVar10 + 10;
    }
    rcT.right = rc.right + -4;
    DrawLockLight(hdc,&rcT,fFullRedraw);
    rcClip.left = rcT.left;
    rcClip.top = rcT.top;
    rcClip.right = rcT.right;
    rcClip.bottom = rcT.bottom;
    ExpandRc(&rcClip,-2,-2);
    GVar7 = sel.scan.grobjFull;
    if (grobj != 4) {
      GVar7 = grobj;
    }
    if ((psbar == (SBAR *)0x0) || (psbar->psz == (char *)0x0)) {
      if ((GVar7 & grobjPlanet) == grobjNone) {
        if ((GVar7 & grobjFleet) == grobjNone) {
          if ((GVar7 & grobjThing) == grobjNone) {
            if ((GVar7 == grobjNone) && (grobj == 4)) {
              CchGetString(idsDeepSpaceWaypoint,(char *)szWork);
            }
            else {
              bVar1 = false;
            }
          }
          else {
            if (psbar == (SBAR *)0x0) {
              sVar6 = ((THING *)lpThings + sel.scan.ith)->idFull;
            }
            else {
              sVar6 = psbar->id;
            }
            PszGetThingName(sVar6);
          }
        }
        else {
          if (psbar == (SBAR *)0x0) {
            sVar6 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
          }
          else {
            sVar6 = psbar->id;
          }
          PszGetFleetName(sVar6);
        }
      }
      else {
        sVar6 = sel.scan.idpl;
        if (psbar != (SBAR *)0x0) {
          sVar6 = psbar->id;
        }
        PszGetPlanetName(sVar6);
      }
    }
    else {
      _strcpy((char *)szWork,psbar->psz);
    }
    if (bVar1) {
      iVar10 = rcT.left + 3;
      iVar11 = rcT.top + 2;
      UVar19 = 4;
      pRVar17 = &rcClip;
      puVar16 = (undefined1 *)&DAT_1120_1120;
      pcVar8 = (char *)szWork;
      uVar18 = unaff_SS;
      HVar21 = hdc;
      UVar20 = lstrlen(szWork);
      ExtTextOut(HVar21,iVar10,iVar11,UVar19,(undefined2 *)CONCAT22(uVar18,pRVar17),
                 (LPCSTR)CONCAT22(puVar16,pcVar8),UVar20,(short *)0x0);
    }
    OffsetRc(&rc,0,dySBar >> 1);
    rcT.top = rc.top + 4;
    rcT.bottom = rc.bottom + -4;
    rcT.left = rc.left + 4;
    rcT.right = rc.right + -4;
    DrawLockLight(hdc,&rcT,fFullRedraw);
    rcClip.left = rcT.left;
    rcClip.top = rcT.top;
    rcClip.right = rcT.right;
    rcClip.bottom = rcT.bottom;
    ExpandRc(&rcClip,-2,-2);
    if (psbar == (SBAR *)0x0) {
      if (grobj == 0) {
        pt.y = 0;
        pt.x = 0;
      }
      else {
        pt.x = sel.scan.pt.x;
        pt.y = sel.scan.pt.y;
      }
    }
    else {
      pt.x = (&psbar->pt)->x;
      pt.y = (psbar->pt).y;
    }
    if ((psbar == (SBAR *)0x0) || (psbar->pscan == (SCAN *)0x0)) {
      if ((sel.grobj == grobjFleet) || (sel.grobj == grobjPlanet)) {
        pt2.x = sel.pt.x;
        pt2.y = sel.pt.y;
      }
      else {
        pt2.x = -1;
      }
    }
    else {
      pt2.x = (psbar->pscan->pt).x;
      pt2.y = (psbar->pscan->pt).y;
    }
    if (((pt.x != -1) && (pt2.x != -1)) && ((pt.x != pt2.x || (pt.y != pt2.y)))) {
      pcVar8 = PszGetDistance(pt.x,pt.y,pt2.x,pt2.y);
      _strcpy(szBuf,pcVar8);
      for (psz = szBuf; *psz != ' '; psz = psz + 1) {
      }
      CchGetString((0x15d < rc.right) + idsLy,psz + 1);
      if ((psbar == (SBAR *)0x0) || (psbar->pscan == (SCAN *)0x0)) {
        uVar9 = _strlen(psz);
        CchGetString(idsFrom,psz + uVar9);
        pcVar8 = PszGetLocName(sel.grobj,sel.id,pt2.x,pt2.y);
        _strcat(psz + 8,pcVar8);
      }
      iVar10 = rcT.left + 3;
      iVar11 = rcT.top + 2;
      UVar20 = 4;
      pRVar17 = &rcClip;
      pcVar8 = szBuf;
      uVar18 = unaff_SS;
      HVar21 = hdc;
      uVar9 = _strlen(szBuf);
      ExtTextOut(HVar21,iVar10,iVar11,UVar20,(undefined2 *)CONCAT22(uVar18,pRVar17),
                 (LPCSTR)CONCAT22(unaff_SS,pcVar8),uVar9,(short *)0x0);
    }
    SelectObject(hdc,HVar5);
    SetBkMode(hdc,sVar4);
    SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
    SetBkColor(hdc,CVar13);
    SelectObject(hdc,HVar3);
    if (bVar12) {
      ReleaseDC(hwndScanner,hdc);
    }
  }
  return;
}



// ======================================================================
// Function: DrawLockLight
// Address: 1058:6b00
// Segment: MEMORY_SCAN
// ======================================================================


void DrawLockLight(HDC hdc,RECT *prc,short fFullRedraw)

{
  int iVar1;
  int iVar2;
  undefined2 unaff_SS;
  RECT rc;
  short dx;
  short dy;
  
  iVar1 = prc->right - prc->left;
  iVar2 = prc->bottom - prc->top;
  if (fFullRedraw == 0) {
    rc.left = prc->left;
    rc.top = prc->top;
    rc.right = prc->right;
    rc.bottom = prc->bottom;
    ExpandRc(&rc,-2,-2);
    FillRect(hdc,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
  }
  else {
    SelectObject(hdc,hbrButtonShadow);
    PatBlt(hdc,prc->left,prc->top,1,iVar2,0xf00021);
    PatBlt(hdc,prc->left,prc->top,iVar1,1,0xf00021);
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,prc->right,prc->top,1,iVar2 + 1,0xf00021);
    PatBlt(hdc,prc->left,prc->bottom,iVar1,1,0xf00021);
  }
  return;
}



// ======================================================================
// Function: SetScanScrollBars
// Address: 1058:6c14
// Segment: MEMORY_SCAN
// ======================================================================


void SetScanScrollBars(HWND hwnd)

{
  short sVar1;
  short sVar2;
  int iVar3;
  int iVar4;
  undefined2 unaff_SS;
  RECT rc;
  short dx;
  short yMax;
  short dy;
  short xMax;
  
  fInScrollSet = 1;
  GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
  sVar1 = ScanToPt(rc.right);
  sVar2 = ScanToPt(rc.bottom - dySBar);
  if ((dGalInv + -1000) - sVar1 < 1000) {
    iVar3 = 1000;
  }
  else {
    iVar3 = (dGalInv + -1000) - sVar1;
  }
  if ((dGalInv + -1000) - sVar2 < 1000) {
    iVar4 = 1000;
  }
  else {
    iVar4 = (dGalInv + -1000) - sVar2;
  }
  SetScrollRange(hwnd,0,1000,iVar3 + 3U & 0xfffc,1);
  if ((fInScrollSet != 0) &&
     (SetScrollRange(hwnd,1,1000,iVar4 + 3U & 0xfffc,1), fInScrollSet != 0)) {
    if (sVar2 <= sVar1) {
      sVar1 = sVar2;
    }
    dScanPage = sVar1 / 3 & 0xfffc;
    dScanInc = dScanPage / 8 + 2U & 0xfffc;
    fInScrollSet = 0;
  }
  return;
}



// ======================================================================
// Function: ScrollScanner
// Address: 1058:6d30
// Segment: MEMORY_SCAN
// ======================================================================


void ScrollScanner(short dx,short dy)

{
  BOOL BVar1;
  HDC hdc_00;
  short sVar2;
  undefined2 unaff_SS;
  RECT rc;
  RECT rcUpd2;
  RECT rcUpd;
  HDC hdc;
  
  if ((((dx != 0) || (dy != 0)) && (BVar1 = IsWindowVisible(hwndScanner), BVar1 != 0)) &&
     ((gd._4_2_ & 1) == 0)) {
    hdc_00 = GetDC(hwndScanner);
    GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
    sVar2 = _abs(dx);
    if (((rc.right >> 1 < sVar2) || (sVar2 = _abs(dy), rc.bottom >> 1 < sVar2)) ||
       ((fDlgUp != 0 || (hwndBrowser != 0)))) {
      DrawScanner(hdc_00,&rc);
    }
    else {
      rc.bottom = rc.bottom - dySBar;
      UpdateWindow(hwndScanner);
      ScrollWindow(hwndScanner,dx,dy,(undefined2 *)CONCAT22(unaff_SS,&rc),
                   (undefined2 *)CONCAT22(unaff_SS,&rc));
      if (dy < 1) {
        if (dy < 0) {
          SetRect((undefined2 *)CONCAT22(unaff_SS,&rcUpd2),0,rc.bottom + dy,rc.right,rc.bottom);
          rc.bottom = rc.bottom + dy;
        }
      }
      else {
        SetRect((undefined2 *)CONCAT22(unaff_SS,&rcUpd2),0,0,rc.right,dy);
        rc.top = rc.top + dy;
      }
      if (dx < 1) {
        if (dx < 0) {
          rcUpd.top = rc.top;
          rcUpd.right = rc.right;
          rcUpd.bottom = rc.bottom;
          rcUpd.left = rc.right + dx;
          rc.left = rc.left - dx;
        }
      }
      else {
        SetRect((undefined2 *)CONCAT22(unaff_SS,&rcUpd),0,rc.top,dx,rc.bottom);
        rc.right = rc.right - dx;
      }
      if (dx != 0) {
        ValidateRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rcUpd));
      }
      if (dy != 0) {
        ValidateRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rcUpd2));
      }
      if (dx != 0) {
        DrawScanner(hdc_00,&rcUpd);
      }
      if (dy != 0) {
        DrawScanner(hdc_00,&rcUpd2);
      }
      UpdateWindow(hwndScanner);
    }
    ReleaseDC(hwndScanner,hdc_00);
  }
  return;
}



// ======================================================================
// Function: RedrawScanSel
// Address: 1058:6f30
// Segment: MEMORY_SCAN
// ======================================================================


void RedrawScanSel(HDC hdc,short fVis)

{
  short *psVar1;
  SCAN *pSVar2;
  GrobjClass GVar3;
  GrobjClass GVar4;
  short sVar5;
  BOOL BVar6;
  int iVar7;
  short *psVar8;
  SCAN *pSVar9;
  undefined2 unaff_SS;
  bool bVar10;
  bool bVar11;
  short sel_grobjFull;
  RECT rc;
  SCAN sel_scan;
  short fNoSelRedraw;
  short sel_id;
  POINT pt;
  short dOff;
  short fhdc;
  short sel_grobj;
  
  sVar5 = sel.id;
  GVar4 = sel.grobjFull;
  GVar3 = sel.grobj;
  psVar8 = (short *)&sel.scan;
  pSVar9 = &sel_scan;
  for (iVar7 = 8; iVar7 != 0; iVar7 = iVar7 + -1) {
    pSVar2 = pSVar9;
    pSVar9 = (SCAN *)&(pSVar9->pt).y;
    psVar1 = psVar8;
    psVar8 = psVar8 + 1;
    (pSVar2->pt).x = *psVar1;
  }
  if ((hwndScanner != 0) && (BVar6 = IsWindowVisible(hwndScanner), BVar6 != 0)) {
    bVar10 = fVis == -1;
    if (bVar10) {
      fVis = 0;
    }
    bVar11 = hdc == 0;
    if (bVar11) {
      hdc = GetDC(hwndScanner);
    }
    DrawShipScanPath(hdc,fVis);
    if (fVis == 0) {
      sel.scan.iwp = -1;
      sel.scan.ifl = -1;
      sel.scan.idpl = -1;
      sel.id = -1;
      sel.grobjFull = grobjNone;
      sel.grobj = grobjNone;
      sel.scan.grobjFull = grobjNone;
      sel.scan.grobj = grobjNone;
    }
    if ((iScanZoom < 3) || ((grbitScan & 0xf) != 4)) {
      if ((grbitScan & 0x1000) == 0) {
        iVar7 = 0;
      }
      else {
        iVar7 = 7;
      }
    }
    else {
      iVar7 = 0xb;
    }
    if ((GVar3 != grobjNone) && (!bVar10)) {
      pt.x = sel.pt.x;
      pt.y = sel.pt.y;
      LogicalToScan(&pt);
      SetRect((undefined2 *)CONCAT22(unaff_SS,&rc),(pt.x + -0xb) - iVar7,(pt.y + -0xb) - iVar7,
              pt.x + 0xc + iVar7,pt.y + 0x17 + iVar7);
      DrawScanner(hdc,&rc);
    }
    if ((sel_scan.grobj != grobjNone) &&
       ((sel_scan.pt.x != sel.pt.x || (sel_scan.pt.y != sel.pt.y)))) {
      pt.x = sel_scan.pt.x;
      pt.y = sel_scan.pt.y;
      LogicalToScan(&pt);
      SetRect((undefined2 *)CONCAT22(unaff_SS,&rc),(pt.x + -6) - iVar7,(pt.y + -6) - iVar7,
              pt.x + 7 + iVar7,pt.y + 0xf + iVar7);
      DrawScanner(hdc,&rc);
    }
    if (fVis == 0) {
      pSVar9 = &sel_scan;
      psVar8 = (short *)&sel.scan;
      sel.grobj = GVar3;
      sel.grobjFull = GVar4;
      sel.id = sVar5;
      for (iVar7 = 8; iVar7 != 0; iVar7 = iVar7 + -1) {
        psVar1 = psVar8;
        psVar8 = psVar8 + 1;
        pSVar2 = pSVar9;
        pSVar9 = (SCAN *)&(pSVar9->pt).y;
        *psVar1 = (pSVar2->pt).x;
      }
    }
    if (bVar11) {
      ReleaseDC(hwndScanner,hdc);
    }
  }
  return;
}



// ======================================================================
// Function: FEnsurePointOnScreen
// Address: 1058:715c
// Segment: MEMORY_SCAN
// ======================================================================


short FEnsurePointOnScreen(POINT pt,short fScroll)

{
  short sVar1;
  short sVar2;
  BOOL BVar3;
  undefined2 unaff_SS;
  POINT pt_00;
  RECT rc;
  POINT ptCtr;
  short cx;
  short fFix;
  short cy;
  
  GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
  rc.bottom = rc.bottom - dySBar;
  sVar1 = ScanToPt(rc.right);
  sVar2 = ScanToPt(rc.bottom);
  rc.left = xScanTop + 10;
  rc.right = xScanTop + sVar1 + -0x14;
  rc.bottom = (dGalInv - yScanTop) + -10;
  rc.top = (rc.bottom - sVar2) + 0x14;
  BVar3 = PtInRect((undefined2 *)CONCAT22(&rc,pt.y),pt.x);
  if (BVar3 == 0) {
    ptCtr.x = (sVar1 >> 1) + xScanTop;
    ptCtr.y = (dGalInv - yScanTop) - (sVar2 >> 1);
    if (pt.x < rc.left) {
      ptCtr.x = ptCtr.x - (rc.left - pt.x);
    }
    else if (rc.right < pt.x) {
      ptCtr.x = ptCtr.x + (pt.x - rc.right);
    }
    if (pt.y < rc.top) {
      ptCtr.y = ptCtr.y - (rc.top - pt.y);
    }
    else if (rc.bottom < pt.y) {
      ptCtr.y = ptCtr.y + (pt.y - rc.bottom);
    }
    pt_00.y = ptCtr.y;
    pt_00.x = ptCtr.x;
    CtrPointScan(pt_00,fScroll);
    sVar1 = 0;
  }
  else {
    sVar1 = 1;
  }
  return sVar1;
}



// ======================================================================
// Function: CtrPointScan
// Address: 1058:7278
// Segment: MEMORY_SCAN
// ======================================================================


void CtrPointScan(POINT pt,short fScroll)

{
  short sVar1;
  short sVar2;
  int iVar3;
  int iVar4;
  uint uVar5;
  uint uVar6;
  short sVar7;
  short sVar8;
  undefined2 unaff_SS;
  ulong uVar9;
  RECT rc;
  short x;
  short dyCur;
  short cx;
  short y;
  short cy;
  short dxCur;
  
  if (hwndScanner != 0) {
    GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
    rc.bottom = rc.bottom - dySBar;
    sVar1 = ScanToPt(rc.right);
    sVar2 = ScanToPt(rc.bottom);
    sVar8 = xScanTop;
    sVar7 = yScanTop;
    if (pt.x - (sVar1 >> 1) < 0x3e9) {
      iVar3 = 1000;
    }
    else {
      iVar3 = pt.x - (sVar1 >> 1);
    }
    if ((sVar2 >> 1) + pt.y < dGalInv + -1000) {
      iVar4 = (sVar2 >> 1) + pt.y;
    }
    else {
      iVar4 = dGalInv + -1000;
    }
    if ((dGalInv + -1000) - sVar1 <= iVar3) {
      iVar3 = (dGalInv + -1000) - sVar1;
    }
    if (iVar4 <= sVar2 + 1000) {
      iVar4 = sVar2 + 1000;
    }
    iVar4 = dGalInv - iVar4;
    if (iVar3 < 0x3e9) {
      iVar3 = 1000;
    }
    if (iVar4 < 0x3e9) {
      iVar4 = 1000;
    }
    uVar5 = iVar3 + 2U & 0xfffc;
    uVar6 = iVar4 + 2U & 0xfffc;
    if ((xScanTop != uVar5) || (yScanTop != uVar6)) {
      xScanTop = uVar5;
      SetScrollPos(hwndScanner,0,iVar3 + 2U & 0xfffc,1);
      uVar9 = CONCAT22(1,iVar4 + 2U) & 0xfffffffc;
      yScanTop = uVar6;
      SetScrollPos(hwndScanner,(short)(uVar9 >> 0x10),(short)uVar9,1);
      if (fScroll == 0) {
        InvalidateRect(hwndScanner,(undefined2 *)0x0,0);
      }
      else {
        sVar7 = PtToScan(sVar7 - uVar6);
        sVar8 = PtToScan(sVar8 - uVar5);
        ScrollScanner(sVar8,sVar7);
      }
    }
  }
  return;
}



// ======================================================================
// Function: LogicalToScan
// Address: 1058:744e
// Segment: MEMORY_SCAN
// ======================================================================


void LogicalToScan(POINT *ppt)

{
  short sVar1;
  
  sVar1 = PtToScan(ppt->x - xScanTop);
  ppt->x = sVar1;
  sVar1 = PtToScan((dGalInv - ppt->y) - yScanTop);
  ppt->y = sVar1;
  return;
}



// ======================================================================
// Function: ScanToLogical
// Address: 1058:7490
// Segment: MEMORY_SCAN
// ======================================================================


void ScanToLogical(POINT *ppt)

{
  short sVar1;
  
  sVar1 = ScanToPt(ppt->x);
  ppt->x = sVar1 + xScanTop;
  sVar1 = ScanToPt(ppt->y);
  ppt->y = dGalInv - (sVar1 + yScanTop);
  if (dGal + 1000 < ppt->x) {
    ppt->x = dGal + 1000;
  }
  if (ppt->y < 1000) {
    ppt->y = 1000;
  }
  return;
}



// ======================================================================
// Function: FAddWayPoint
// Address: 1058:7504
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1058763d) */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short FAddWayPoint(POINT ptIn,SCAN *pscan)

{
  byte *pbVar1;
  ORDER *pOVar2;
  ORDER *pOVar3;
  GrobjClass GVar4;
  char *pcVar5;
  int iVar6;
  int iVar7;
  short sVar8;
  HDC hdc_00;
  uint uVar9;
  ORDER *pOVar10;
  short *psVar11;
  ORDER *pOVar12;
  undefined2 unaff_SS;
  ulong uVar13;
  ulong uVar14;
  undefined2 uVar15;
  RECT rc;
  short ipt;
  short cpt;
  short dx;
  POINT rgpt [3];
  short lDist;
  ORDER *lpord;
  short dy;
  short id;
  HDC hdc;
  
  if (sel.fl.cord == 0x57) {
    MessageBeep(0x40);
    uVar15 = 0x56;
    pcVar5 = PszGetCompressedString(idsCantHaveDWaypoints);
    _WSPRINTF((LPSTR)CONCAT22(uVar15,(char *)&DAT_1120_1120),
              (LPCSTR)CONCAT22(pcVar5,(char *)&DAT_1120_1120),(char *)szWork);
    AlertSz((char *)szWork,0x10);
    sVar8 = 0;
  }
  else {
    if ((grbitScan & 0x80) != 0) {
      rgpt[0].x = ptIn.x;
      rgpt[0].y = ptIn.y;
      rgpt[1].x = (pscan->pt).x;
      rgpt[1].y = (pscan->pt).y;
      if (sel.iwpAct < sel.fl.cord + -1) {
        cpt = 3;
        psVar11 = (short *)((int)(PLORD *)sel.fl.lpplord +
                           (sel.iwpAct + 1) * 0x12 + 4);
        rgpt[2].x = *psVar11;
        rgpt[2].y = psVar11[1];
      }
      else {
        cpt = 2;
      }
    }
    iVar6 = ptIn.x - (pscan->pt).x;
    iVar7 = ptIn.y - (pscan->pt).y;
    sVar8 = ScanToPt(0x14);
    uVar13 = __aFulmul((long)iVar7,(long)iVar7);
    rc.bottom = (short)uVar13;
    uVar14 = __aFulmul((long)iVar6,(long)iVar6);
    rc._2_4_ = uVar14 + CONCAT22((int)(uVar13 >> 0x10),rc.bottom);
    if ((long)(sVar8 * sVar8) < (long)rc._2_4_) {
      pscan->grobjFull = grobjOther;
      pscan->grobj = grobjOther;
      pscan->idpl = -1;
      pscan->ifl = -1;
      pscan->iwp = sel.iwpAct + 1;
      (pscan->pt).x = ptIn.x;
      (pscan->pt).y = ptIn.y;
    }
    uVar15 = sel.fl.lpplord._2_2_;
    rc.bottom = (short)((PLORD *)sel.fl.lpplord + 1);
    pOVar10 = (ORDER *)(rc.bottom + sel.iwpAct * 0x12);
    lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,pOVar10);
    if (((pscan->pt).x == (lpord->pt).x) && ((pscan->pt).y == (pOVar10->pt).y)) {
      sVar8 = 0;
    }
    else if ((sel.iwpAct < sel.fl.cord + -1) &&
            (((pscan->pt).x == ((pOVar10 + 1)->pt).x && ((pscan->pt).y == pOVar10[1].pt.y)))) {
      sVar8 = 0;
    }
    else {
      hdc_00 = GetDC(hwndScanner);
      DrawShipScanPath(hdc_00,0);
      if ((uint)((PLORD *)sel.fl.lpplord)->iordMax == sel.fl.cord) {
        sel.fl.lpplord =
             (PLORD *)LpplReAlloc((PL *)sel.fl.lpplord,sel.fl.cord + 3);
        rc.bottom = (short)((PL *)sel.fl.lpplord + 1);
        lpord = (ORDER *)CONCAT22((int)((ulong)sel.fl.lpplord >> 0x10),
                                  (ORDER *)(rc.bottom + (sel.iwpAct + 1) * 0x12));
      }
      else {
        lpord = (ORDER *)CONCAT22(uVar15,pOVar10 + 1);
      }
      if (sel.iwpAct != sel.fl.cord + -1) {
        __fmemmove((ORDER *)CONCAT22(lpord._2_2_,(ORDER *)lpord + 1),lpord,
                           ((sel.fl.cord - sel.iwpAct) + -1) * 0x12);
      }
      pOVar10 = (ORDER *)lpord + -1;
      pOVar12 = (ORDER *)lpord;
      for (iVar6 = 9; iVar6 != 0; iVar6 = iVar6 + -1) {
        pOVar3 = pOVar12;
        pOVar12 = (ORDER *)&(pOVar12->pt).y;
        pOVar2 = pOVar10;
        pOVar10 = (ORDER *)&(pOVar10->pt).y;
        (pOVar3->pt).x = (pOVar2->pt).x;
      }
      sVar8 = (pscan->pt).y;
      (lpord->pt).x = (pscan->pt).x;
      (((ORDER *)lpord)->pt).y = sVar8;
      GVar4 = pscan->grobj;
      if (GVar4 == grobjPlanet) {
        id = pscan->idpl;
      }
      else if (GVar4 == grobjFleet) {
        id = ((FLEET **)rglpfl)[pscan->ifl]->id;
      }
      else if (GVar4 == grobjOther) {
        id = pscan->iwp;
      }
      else if (GVar4 == grobjThing) {
        id = ((THING *)lpThings + pscan->ith)->idFull;
      }
      ((ORDER *)lpord)->id = id;
      ((ORDER *)lpord)->wFlags =
           ((ORDER *)lpord)->wFlags & 0xf0ffU |
           (pscan->grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 8;
      sel.fl.cord = sel.fl.cord + 1;
      pbVar1 = &((PLORD *)sel.fl.lpplord)->iordMac;
      *pbVar1 = *pbVar1 + 1;
      uVar9 = IWarpBestForWaypoint(&sel.fl,lpord);
      ((ORDER *)lpord)->wFlags = ((ORDER *)lpord)->wFlags & 0xff0fU | (uVar9 & 0xf) << 4;
      pscan->grobj = grobjOther;
      pscan->grobjFull = pscan->grobjFull | grobjOther;
      pscan->iwp = sel.iwpAct + 1;
      RedrawScanSel(0,0);
      FLookupFleet(-1,(FLEET *)&sel.fl);
      if (((((ORDER *)lpord)[-1].wFlags & 0xfU) == 6) &&
         ((&((ORDER *)lpord)[-1].txp)->rgia[0].wFlags == 5)) {
        __fmemset((TASKXPORT *)CONCAT22(lpord._2_2_,&((ORDER *)lpord)[-1].txp),0,10);
        ((ORDER *)lpord)[-1].wFlags = ((ORDER *)lpord)[-1].wFlags & 0xfff0;
        FLookupFleet(-1,(FLEET *)&sel.fl);
      }
      ChangeScanSel(pscan,1);
      ReleaseDC(hwndScanner,hdc_00);
      if ((grbitScan & 0x80) != 0) {
        for (ipt = 0; ipt < cpt; ipt = ipt + 1) {
          LogicalToScan(rgpt + ipt);
        }
        BoundPoints(&rc,rgpt,cpt);
        InvalidateRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc),0);
      }
      sVar8 = 1;
    }
  }
  return sVar8;
}



// ======================================================================
// Function: IWarpBestForWaypoint
// Address: 1058:7a18
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10587e7e) */
/* WARNING: Removing unreachable block (ram,0x10587d6c) */
/* WARNING: Removing unreachable block (ram,0x10587f25) */

short IWarpBestForWaypoint(FLEET *lpfl,ORDER *lpord)

{
  uint uVar1;
  POINT pt;
  POINT ptSrc;
  POINT ptDst;
  bool bVar2;
  bool bVar3;
  uint uVar4;
  int iVar5;
  short sVar6;
  ORDER *pOVar7;
  FLEET *pFVar8;
  int iVar9;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar10;
  undefined2 uVar11;
  ulong uVar12;
  long lVar13;
  HULDEF *pHVar14;
  long lVar15;
  long lVar16;
  undefined2 uVar17;
  undefined2 uVar18;
  undefined2 uVar19;
  undefined2 uVar20;
  undefined2 in_stack_0000ffcc;
  undefined2 in_stack_0000ffce;
  SCAN scan;
  short iWarpOld;
  PLANET *lppl;
  short j;
  short iWarpAi;
  short fGoFlatOut;
  short fGoFlatOutAi;
  short cSpeed;
  short lDist;
  short iwp;
  short cTravel;
  short iWarp;
  long lFuel;
  
  uVar10 = (undefined2)((ulong)lpord >> 0x10);
  pOVar7 = (ORDER *)lpord;
  uVar1 = pOVar7->wFlags;
  uVar4 = IFindIdealWarp((FLEET *)0x0,0);
  if (fAi != 0) {
    iWarpAi = IFindIdealWarp((FLEET *)0x0,1);
  }
  lVar16 = CONCAT22(in_stack_0000ffce,in_stack_0000ffcc);
  uVar11 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar8 = (FLEET *)lpfl;
  iwp = pFVar8->cord;
  do {
    iwp = iwp + -1;
    if (iwp < 0) break;
  } while (lpord != (ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar8->lpplord + 2),
                                      (ORDER *)(*(int *)&pFVar8->lpplord + 4 + iwp * 0x12)));
  if (iwp < 1) {
    return uVar4;
  }
  if (((pOVar7->wFlags & 0xfU) == 2) || ((pOVar7->wFlags & 0xfU) == 5)) {
    bVar2 = true;
  }
  else {
    bVar2 = false;
    lppl = (PLANET *)0x0;
    while ((int)(PLANET *)lppl < 0x10) {
      if (0 < pFVar8->rgcsh[(int)(PLANET *)lppl]) {
        while( true ) {
          iVar9 = pFVar8->iPlayer * 4;
          if ((int)(uint)*(byte *)(*(int *)(iVar9 + 0xfe) + (int)(PLANET *)lppl * 0x93 + 0x7a) <=
              lppl._2_2_) break;
          iVar9 = pFVar8->iPlayer * 4;
          if ((*(int *)(*(int *)(iVar9 + 0xfe) + (int)(PLANET *)lppl * 0x93 + 0x3a + lppl._2_2_ * 4)
               == 0x1000) &&
             ((iVar9 = pFVar8->iPlayer * 4,
              (*(uint *)(*(int *)(iVar9 + 0xfe) + (int)(PLANET *)lppl * 0x93 + lppl._2_2_ * 4 + 0x3c
                        ) & 0xff) == 0 ||
              (iVar9 = pFVar8->iPlayer * 4,
              (*(uint *)(*(int *)(iVar9 + 0xfe) + (int)(PLANET *)lppl * 0x93 + lppl._2_2_ * 4 + 0x3c
                        ) & 0xff) == 1)))) {
            bVar2 = true;
            break;
          }
          lppl = (PLANET *)CONCAT22(lppl._2_2_ + 1,(PLANET *)lppl);
        }
      }
      lppl = (PLANET *)ZEXT24((undefined1 *)((int)&((PLANET *)lppl)->id + 1));
    }
  }
  if ((bVar2) || (fAi == 0)) {
    bVar3 = false;
  }
  else {
    bVar3 = true;
    bVar2 = true;
  }
  iWarp = uVar4;
  if ((int)uVar4 < 9) {
    pt.y = (pOVar7->pt).y;
    pt.x = (lpord->pt).x;
    sVar6 = FFindNearestObject(pt,0x81,&scan);
    if (sVar6 == 0) {
      lppl = (PLANET *)0x0;
    }
    else {
      lppl = LpplFromId(scan.idpl);
    }
    lVar16 = CONCAT22(in_stack_0000ffce,in_stack_0000ffcc);
    if ((bVar2) ||
       ((((PLANET *)lppl != (PLANET *)0x0 || (lppl._2_2_ != 0)) &&
        ((((PLANET *)lppl)->iPlayer == -1 || (((PLANET *)lppl)->iPlayer == idPlayer)))))) {
      if ((bVar3) &&
         (((((PLANET *)lppl != (PLANET *)0x0 || (lppl._2_2_ != 0)) &&
           (((PLANET *)lppl)->iPlayer == idPlayer)) &&
          (*(int *)(*(int *)(idPlayer * 4 + 0x14c) +
                   (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) * 0x93) != 0x20)))) {
        bVar3 = false;
      }
      iWarp = 9;
    }
    else {
      if (((1 < iwp) && (uVar4 < ((uint)pOVar7[-1].wFlags >> 4 & 0xf))) &&
         (((uint)pOVar7[-1].wFlags >> 4 & 0xf) < 0xb)) {
        iWarp = (uint)pOVar7[-1].wFlags >> 4 & 0xf;
      }
      lVar16 = LFuelUseToWaypoint(lpfl,iwp,1);
      uVar19 = 0;
      uVar17 = 10;
      lVar13 = LGetFleetStat(lpfl,1);
      lVar13 = __aFldiv(lVar13,CONCAT22(uVar19,uVar17));
      if (lVar13 <= lVar16) goto SCAN_LOptimizeSpeed;
      uVar20 = 0;
      uVar18 = 10;
      uVar19 = 0;
      uVar17 = 7;
      uVar12 = LGetFleetStat(lpfl,1);
      uVar12 = __aFulmul(uVar12,CONCAT22(uVar19,uVar17));
      lVar13 = __aFldiv(uVar12,CONCAT22(uVar20,uVar18));
      iVar5 = (int)((ulong)lVar13 >> 0x10);
      iVar9 = *(int *)((int)pFVar8->rgwtMin + 0x12);
      if ((iVar9 < iVar5) || ((iVar9 <= iVar5 && (*(uint *)(pFVar8->rgwtMin + 4) < (uint)lVar13))))
      goto SCAN_LOptimizeSpeed;
      iWarp = iWarp + 1;
    }
    for (; (int)uVar4 < iWarp; iWarp = iWarp + -1) {
      pOVar7->wFlags = pOVar7->wFlags & 0xff0fU | (iWarp & 0xfU) << 4;
      lVar13 = LFuelUseToWaypoint(lpfl,iwp,1);
      if ((lVar13 <= CONCAT22(*(undefined2 *)((int)pFVar8->rgwtMin + 0x12),(int)pFVar8->rgwtMin[4]))
         && ((((((PLANET *)lppl != (PLANET *)0x0 || (lppl._2_2_ != 0)) &&
               (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)) &&
              ((((PLANET *)lppl)->iPlayer == idPlayer &&
               (pHVar14 = LphuldefFromId
                                    (*(HullDef *)
                                      (*(int *)(idPlayer * 4 + 0x14c) +
                                      (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) * 0x93)),
               (((HULDEF *)pHVar14)->hul).wtCargoMax != 0)))) ||
             ((lVar15 = __aFldiv(CONCAT22(*(undefined2 *)((int)pFVar8->rgwtMin + 0x12),
                                                  (int)pFVar8->rgwtMin[4]),2), lVar13 <= lVar15 ||
              (bVar2)))))) break;
    }
    pOVar7->wFlags = pOVar7->wFlags & 0xff0fU | (uVar1 >> 4 & 0xf) << 4;
  }
  if ((bVar3) && (iWarpAi < iWarp)) {
    iWarp = iWarpAi;
  }
SCAN_LOptimizeSpeed:
  if ((1 < iWarp) && (((uint)pOVar7->wFlags >> 8 & 0xf) != 2)) {
    DGetDistance((lpord->pt).x,(pOVar7->pt).y,((pOVar7 + -1)->pt).x,pOVar7[-1].pt.y);
    lVar16 = __ftol((double)CONCAT26((int)((ulong)lVar16 >> 0x10),
                                             CONCAT24((int)lVar16,CONCAT22(unaff_SI,unaff_DI))));
    iVar5 = iWarp * iWarp;
    iVar9 = iWarp;
    do {
      iWarp = iVar9;
      iVar9 = iWarp + -1;
      if (iVar9 < 2) break;
    } while ((iVar5 + (int)lVar16 + -1) / iVar5 ==
             ((int)lVar16 + iVar9 * iVar9 + -1) / (iVar9 * iVar9));
  }
  ptSrc.y = pOVar7[-1].pt.y;
  ptSrc.x = ((pOVar7 + -1)->pt).x;
  ptDst.y = (pOVar7->pt).y;
  ptDst.x = (lpord->pt).x;
  sVar6 = FCanFleetUseStargates(lpfl,ptSrc,ptDst);
  if (sVar6 == 1) {
    iWarp = 0xb;
  }
  if (0xb < iWarp) {
    iWarp = 9;
  }
  return iWarp;
}



// ======================================================================
// Function: FNearAWayPoint
// Address: 1058:8074
// Segment: MEMORY_SCAN
// ======================================================================


short FNearAWayPoint(POINT pt,short fLogical)

{
  short sVar1;
  uint uVar2;
  undefined2 uVar3;
  SCAN scan;
  short i;
  ORDER *lpord;
  
  if (sel.grobj == grobjFleet) {
    if (fLogical == 0) {
      ScanToLogical(&pt);
    }
    sVar1 = FFindNearestObject(pt,0x4f,&scan);
    if (sVar1 == 0) {
      uVar2 = 0;
    }
    else if ((scan.grobjFull & grobjOther) == grobjNone) {
      uVar2 = 0;
    }
    else if ((scan.pt.x == sel.pt.x) && (scan.pt.y == sel.pt.y)) {
      lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,
                                &((PLORD *)sel.fl.lpplord)[5].iordMax);
      for (i = 1; i < sel.fl.cord; i = i + 1) {
        uVar3 = (undefined2)((ulong)lpord >> 0x10);
        if (((lpord->pt).x == scan.pt.x) && ((((ORDER *)lpord)->pt).y == scan.pt.y)) break;
        lpord = (ORDER *)CONCAT22(uVar3,(ORDER *)lpord + 1);
      }
      uVar2 = (uint)(i != sel.fl.cord);
    }
    else {
      uVar2 = 1;
    }
  }
  else {
    uVar2 = 0;
  }
  return uVar2;
}



// ======================================================================
// Function: FHandleWayPointDrag
// Address: 1058:8176
// Segment: MEMORY_SCAN
// ======================================================================


short FHandleWayPointDrag(POINT pt)

{
  int iVar1;
  POINT pt_00;
  POINT pt_01;
  bool bVar2;
  HDC HVar3;
  HCURSOR HVar4;
  short sVar5;
  short sVar6;
  GrobjClass grobj;
  int iVar7;
  int iVar8;
  char *sz;
  HGDIOBJ HVar9;
  uint uVar10;
  ORDER *pOVar11;
  int *piVar12;
  short *psVar13;
  undefined2 uVar14;
  undefined2 unaff_SS;
  char *mbType;
  HDC hdc_2;
  RECT rc;
  short fFirst;
  SCAN scan;
  POINT ptPrev;
  short cpt;
  POINT ptNew;
  POINT rgpt [4];
  short fDel;
  POINT ptNext;
  POINT ptLogical;
  short i;
  ORDER *lpord;
  HCURSOR hcurSav;
  short grTypeIn;
  short fDup;
  char szDeepSpace [40];
  short fMarker;
  SBAR sbar;
  HPEN hpenSav;
  HDC hdc;
  short fChg;
  
  bVar2 = true;
  LogicalToScan(&pt);
  if (sel.iwpAct == 0) {
    lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,
                              &((PLORD *)sel.fl.lpplord)[5].iordMax);
    for (i = 1; i < sel.fl.cord; i = i + 1) {
      uVar14 = (undefined2)((ulong)lpord >> 0x10);
      if ((sel.fl.pt.x == (lpord->pt).x) &&
         (sel.fl.pt.y == (((ORDER *)lpord)->pt).y)) break;
      lpord = (ORDER *)CONCAT22(uVar14,(ORDER *)lpord + 1);
    }
    SetScanWp(i);
  }
  piVar12 = (int *)((int)(PLORD *)sel.fl.lpplord + (sel.iwpAct + -1) * 0x12 + 4)
  ;
  iVar8 = *piVar12;
  iVar1 = piVar12[1];
  if (sel.iwpAct == sel.fl.cord + -1) {
    cpt = 3;
  }
  else {
    cpt = 4;
    psVar13 = (short *)((int)(PLORD *)sel.fl.lpplord +
                       (sel.iwpAct + 1) * 0x12 + 4);
    rgpt[3].x = *psVar13;
    rgpt[3].y = psVar13[1];
  }
  psVar13 = (short *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
  rgpt[0].x = *psVar13;
  rgpt[0].y = psVar13[1];
  rgpt[1].x = rgpt[0].x;
  rgpt[1].y = rgpt[0].y;
  rgpt[2].x = iVar8;
  rgpt[2].y = iVar1;
  for (i = 0; i < cpt; i = i + 1) {
    LogicalToScan(rgpt + i);
  }
  GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
  rc.bottom = rc.bottom - dySBar;
  HVar3 = GetDC(hwndScanner);
  HVar4 = setcursor(hcurCloseGrab);
  SetCapture(hwndScanner);
  ptNew.x = pt.x;
  ptNew.y = pt.y;
  while (sVar5 = FGetMouseMove(&ptNew), sVar5 != 0) {
    uVar10 = rc.right;
    if (ptNew.x <= rc.right) {
      uVar10 = ptNew.x;
    }
    if (uVar10 < 0x8000) {
      sVar5 = rc.right;
      if (ptNew.x <= rc.right) {
        sVar5 = ptNew.x;
      }
    }
    else {
      sVar5 = 0;
    }
    uVar10 = rc.bottom;
    if (ptNew.y <= rc.bottom) {
      uVar10 = ptNew.y;
    }
    if (uVar10 < 0x8000) {
      sVar6 = rc.bottom;
      if (ptNew.y <= rc.bottom) {
        sVar6 = ptNew.y;
      }
    }
    else {
      sVar6 = 0;
    }
    ptNew.x = sVar5;
    ptNew.y = sVar6;
    if ((pt.x != sVar5) || (pt.y != sVar6)) {
      if ((!bVar2) ||
         (pt_01.y = sVar6, pt_01.x = sVar5, sVar5 = FNearAWayPoint(pt_01,0), sVar5 == 0)) {
        bVar2 = false;
        ptLogical.x = ptNew.x;
        ptLogical.y = ptNew.y;
        ScanToLogical(&ptLogical);
        uVar10 = GetAsyncKeyState(0x10);
        if ((uVar10 & 0xfffe) == 0) {
          grobj = 0x4f;
        }
        else {
          grobj = 0x8f;
        }
        pt_00.y = ptLogical.y;
        pt_00.x = ptLogical.x;
        FFindNearestObject(pt_00,grobj,&scan);
        DrawScanXorLines(HVar3,rgpt,cpt);
        if (scan.grobj == grobjNone) {
          rgpt[0].x = ptLogical.x;
          rgpt[0].y = ptLogical.y;
          sbar.id = -1;
          CchGetString(idsDeepSpace,szDeepSpace);
          sbar.psz = szDeepSpace;
        }
        else {
          rgpt[0].x = scan.pt.x;
          rgpt[0].y = scan.pt.y;
          if (scan.grobj == grobjPlanet) {
            sbar.id = scan.idpl;
          }
          else if (scan.grobj == grobjFleet) {
            sbar.id = ((FLEET **)rglpfl)[scan.ifl]->id;
          }
          else if (scan.grobj == grobjThing) {
            sbar.id = ((THING *)lpThings + scan.ith)->idFull;
          }
          else {
            sbar.id = scan.iwp;
          }
          sbar.psz = (char *)0x0;
        }
        sbar.pt.x = rgpt[0].x;
        sbar.pt.y = rgpt[0].y;
        sbar.grbit = scan.grobj;
        LogicalToScan(rgpt);
        DrawScanXorLines(HVar3,rgpt,cpt);
        sbar.pscan = (SCAN *)0x0;
        DrawScannerSBar(HVar3,(RECT *)0x0,&sbar,0);
      }
      pt.y = ptNew.y;
      pt.x = ptNew.x;
    }
  }
  if ((rgpt[0].x == rgpt[1].x) && (rgpt[0].y == rgpt[1].y)) {
    iVar7 = 0;
  }
  else {
    iVar7 = 1;
  }
  if (iVar7 != 0) {
    if (scan.grobj == grobjNone) {
      scan.pt.x = ptLogical.x;
      scan.pt.y = ptLogical.y;
      scan.grobj = grobjOther;
      scan.iwp = sel.iwpAct;
    }
    if ((scan.pt.x == iVar8) && (scan.pt.y == iVar1)) {
      fDup = 1;
    }
    else {
      fDup = 0;
    }
    if ((fDup == 0) && (sel.iwpAct < sel.fl.cord + -1)) {
      piVar12 = (int *)((int)(PLORD *)sel.fl.lpplord +
                       (sel.iwpAct + 1) * 0x12 + 4);
      if ((scan.pt.x == *piVar12) && (scan.pt.y == piVar12[1])) {
        iVar8 = 1;
      }
      else {
        iVar8 = 0;
      }
      fDup = iVar8 << 1;
    }
    GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
    if (fDup != 0) {
      mbType = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
      sz = PszFormatIds(idsSureWantDeleteCurrentWaypoint,(short *)0x0);
      sVar5 = AlertSz(sz,(short)mbType);
      if ((grbitScan & 0x80) != 0) {
        HVar9 = SelectObject(HVar3,hpenStarbase);
        MoveTo(HVar3,rgpt[2].x,rgpt[2].y);
        LineTo(HVar3,rgpt[0].x,rgpt[0].y);
        if (3 < (uint)cpt) {
          ExcludeClipRect(HVar3,0,rc.bottom - dySBar,rc.right,rc.bottom);
          LineTo(HVar3,rgpt[3].x,rgpt[3].y);
        }
        SelectObject(HVar3,HVar9);
      }
      DrawScanXorLines(HVar3,rgpt,cpt);
      rgpt[0].x = rgpt[1].x;
      rgpt[0].y = rgpt[1].y;
      if ((grbitScan & 0x80) != 0) {
        HVar9 = SelectObject(HVar3,hpenStarbase);
        MoveTo(HVar3,rgpt[2].x,rgpt[2].y);
        LineTo(HVar3,rgpt[0].x,rgpt[0].y);
        if (3 < (uint)cpt) {
          ExcludeClipRect(HVar3,0,rc.bottom - dySBar,rc.right,rc.bottom);
          LineTo(HVar3,rgpt[3].x,rgpt[3].y);
        }
        SelectObject(HVar3,HVar9);
      }
      DrawScanXorLines(HVar3,rgpt,cpt);
      if (sVar5 == 6) {
        DeleteCurWayPoint((uint)(fDup == 1));
      }
      goto SCAN_Done_5;
    }
    if ((grbitScan & 0x80) != 0) {
      ExcludeClipRect(HVar3,0,rc.bottom - dySBar,rc.right,rc.bottom);
      HVar9 = SelectObject(HVar3,hpenStarbase);
      MoveTo(HVar3,rgpt[2].x,rgpt[2].y);
      LineTo(HVar3,rgpt[0].x,rgpt[0].y);
      if (3 < (uint)cpt) {
        LineTo(HVar3,rgpt[3].x,rgpt[3].y);
      }
      SelectObject(HVar3,HVar9);
    }
    DrawScanXorLines(HVar3,rgpt,cpt);
    rgpt[0].x = rgpt[1].x;
    rgpt[0].y = rgpt[1].y;
    if ((grbitScan & 0x80) != 0) {
      ExcludeClipRect(HVar3,0,rc.bottom - dySBar,rc.right,rc.bottom);
      HVar9 = SelectObject(HVar3,hpenStarbase);
      MoveTo(HVar3,rgpt[2].x,rgpt[2].y);
      LineTo(HVar3,rgpt[0].x,rgpt[0].y);
      if (3 < (uint)cpt) {
        LineTo(HVar3,rgpt[3].x,rgpt[3].y);
      }
      SelectObject(HVar3,HVar9);
    }
    DrawScanXorLines(HVar3,rgpt,cpt);
    RedrawScanSel(0,0);
    uVar14 = sel.fl.lpplord._2_2_;
    if (scan.grobj == grobjPlanet) {
      i = scan.idpl;
    }
    else if (scan.grobj == grobjFleet) {
      i = ((FLEET **)rglpfl)[scan.ifl]->id;
    }
    else if (scan.grobj == grobjThing) {
      i = ((THING *)lpThings + scan.ith)->idFull;
    }
    else {
      i = scan.iwp;
    }
    pOVar11 = (ORDER *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
    lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,pOVar11);
    pOVar11->wFlags =
         pOVar11->wFlags & 0xf0ffU |
         (scan.grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 8;
    pOVar11->id = i;
    (lpord->pt).x = scan.pt.x;
    (pOVar11->pt).y = scan.pt.y;
    uVar10 = IWarpBestForWaypoint(&sel.fl,(ORDER *)CONCAT22(uVar14,pOVar11));
    pOVar11->wFlags = pOVar11->wFlags & 0xff0fU | (uVar10 & 0xf) << 4;
    FLookupFleet(-1,(FLEET *)&sel.fl);
    scan.iwp = sel.iwpAct;
    scan.grobjFull = scan.grobjFull | grobjOther;
    sel.iwpAct = -2;
    ChangeScanSel(&scan,1);
  }
  DrawScannerSBar(HVar3,(RECT *)0x0,(SBAR *)0x0,0);
  ReleaseCapture();
  setcursor(HVar4);
  InvalidateRect(hwndMine,(undefined2 *)0x0,1);
  SetMineralTitleBar(hwndMine);
SCAN_Done_5:
  ReleaseDC(hwndScanner,HVar3);
  if ((iVar7 != 0) && ((grbitScan & 0x80) != 0)) {
    rgpt[1].x = ptNew.x;
    rgpt[1].y = ptNew.y;
    BoundPoints(&rc,rgpt,cpt);
    HVar3 = GetDC(hwndScanner);
    DrawScanner(HVar3,&rc);
    ReleaseDC(hwndScanner,HVar3);
  }
  return iVar7;
}



// ======================================================================
// Function: DrawScanXorLines
// Address: 1058:8af6
// Segment: MEMORY_SCAN
// ======================================================================


void DrawScanXorLines(HDC hdc,POINT *rgpt,short cpt)

{
  HGDIOBJ HVar1;
  short sVar2;
  undefined2 unaff_SS;
  RECT rc;
  short i;
  short iRopSav;
  HPEN hpenSav;
  
  GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
  ExcludeClipRect(hdc,0,rc.bottom - dySBar,rc.right,rc.bottom);
  if (((cpt == 4) && ((rgpt + 2)->x == (rgpt + 3)->x)) && (rgpt[2].y == rgpt[3].y)) {
    cpt = 3;
    hpenSav = GetStockObject(6);
  }
  else {
    hpenSav = hpenShip;
  }
  for (i = 1; i < cpt; i = i + 1) {
    ExcludeClipRect(hdc,(rgpt + i)->x + -5,rgpt[i].y + -5,(rgpt + i)->x + 6,rgpt[i].y + 6);
  }
  HVar1 = SelectObject(hdc,hpenSav);
  sVar2 = SetROP2(hdc,7);
  MoveTo(hdc,(rgpt + 2)->x,rgpt[2].y);
  LineTo(hdc,rgpt->x,rgpt->y);
  if (3 < cpt) {
    LineTo(hdc,(rgpt + 3)->x,rgpt[3].y);
  }
  SetROP2(hdc,sVar2);
  SelectObject(hdc,HVar1);
  SelectClipRgn(hdc,hrgnHuge);
  return;
}



// ======================================================================
// Function: SetScanWp
// Address: 1058:8c5a
// Segment: MEMORY_SCAN
// ======================================================================


short SetScanWp(short iNew)

{
  short *psVar1;
  POINT pt;
  SCAN scan;
  
  if (iNew != sel.iwpAct) {
    psVar1 = (short *)((int)(PLORD *)sel.fl.lpplord + iNew * 0x12 + 4);
    pt.y = psVar1[1];
    pt.x = *psVar1;
    FFindNearestObject(pt,grobjOther,&scan);
    scan.iwp = iNew;
    ChangeScanSel(&scan,1);
  }
  return iNew;
}



// ======================================================================
// Function: ChangeScanSel
// Address: 1058:8cc4
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: hdc_2 */

void ChangeScanSel(SCAN *pscan,short fValidScan)

{
  SCAN *pSVar1;
  short *psVar2;
  POINT pt;
  POINT pt_00;
  bool bVar3;
  short sVar4;
  int iVar5;
  int iVar6;
  HDC hdc;
  int iVar7;
  undefined2 unaff_SI;
  SCAN *pSVar8;
  undefined2 unaff_DI;
  short *psVar9;
  undefined2 unaff_SS;
  long lVar10;
  HDC hdc_2;
  short fChgWp;
  RECT rcMine;
  short fMineFieldSel;
  
  if (fValidScan == 0) {
    pt.y = (pscan->pt).y;
    pt.x = (pscan->pt).x;
    FFindNearestObject(pt,pscan->grobj,pscan);
  }
  sVar4 = _memcmp(pscan,(void *)&sel.scan,0x10);
  if (sVar4 != 0) {
    if ((pscan->iwp == -1) || (pscan->iwp == sel.iwpAct)) {
      iVar5 = 0;
    }
    else {
      iVar5 = 1;
    }
    if ((sel.scan.grobj == grobjThing) &&
       ((uint)((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0)) {
      bVar3 = true;
    }
    else {
      bVar3 = false;
    }
    if (bVar3) {
      _sqrt(SUB84((double)*(long *)((THING *)lpThings)[sel.scan.ith].rgb,0)
                    ,(double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)*(long *)((
                                                  THING *)lpThings)[sel.scan.ith].
                                                  rgb >> 0x20))));
      lVar10 = __ftol((double)CONCAT26(iVar5,CONCAT24(hdc_2,CONCAT22(unaff_SI,unaff_DI))));
      hdc_2 = (HDC)lVar10;
      iVar7 = (&((THING *)lpThings)[sel.scan.ith].pt)->x;
      iVar6 = ((THING *)lpThings)[sel.scan.ith].pt.y;
      rcMine.right = iVar7 + hdc_2;
      rcMine.bottom = iVar6 - hdc_2;
      rcMine.left = iVar7 - hdc_2;
      rcMine.top = iVar6 + hdc_2;
      LogicalToScan((POINT *)&rcMine);
      LogicalToScan((POINT *)&rcMine.right);
      InflateRect((undefined2 *)CONCAT22(unaff_SS,&rcMine),1,1);
    }
    RedrawScanSel(0,-1);
    psVar9 = (short *)&sel.scan;
    pSVar8 = pscan;
    for (iVar7 = 8; iVar7 != 0; iVar7 = iVar7 + -1) {
      psVar2 = psVar9;
      psVar9 = psVar9 + 1;
      pSVar1 = pSVar8;
      pSVar8 = (SCAN *)&(pSVar8->pt).y;
      *psVar2 = (pSVar1->pt).x;
    }
    if (((sel.scan.grobjFull & grobjPlanet) != grobjNone) && (fValidScan != 2)) {
      sel.scan.grobj = grobjPlanet;
    }
    if (iVar5 != 0) {
      sel.iwpAct = pscan->iwp;
      FillOrdersLB();
      SetOrdersLbSel(pscan->iwp);
      UpdateOrdersDDs(0);
      DrawPlanShip(0,0x122);
    }
    RedrawScanSel(0,1);
    if (iVar5 != 0) {
      pt_00.y = (pscan->pt).y;
      pt_00.x = (pscan->pt).x;
      FEnsurePointOnScreen(pt_00,1);
    }
    DrawScannerSBar(0,(RECT *)0x0,(SBAR *)0x0,0);
    InvalidateRect(hwndMine,(undefined2 *)0x0,1);
    SetMineralTitleBar(hwndMine);
    if (bVar3) {
      hdc_2 = GetDC(hwndScanner);
      DrawScanner(hdc_2,&rcMine);
      ReleaseDC(hwndScanner,hdc_2);
    }
    if ((sel.scan.grobj == grobjThing) &&
       ((uint)((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0)) {
      bVar3 = true;
    }
    else {
      bVar3 = false;
    }
    if (bVar3) {
      _sqrt(SUB84((double)*(long *)((THING *)lpThings)[sel.scan.ith].rgb,0)
                    ,(double)CONCAT26(hdc_2,CONCAT24(unaff_SI,(long)((qword)(double)*(long *)((THING
                                                                                               *)
                                                  lpThings)[sel.scan.ith].rgb >>
                                                  0x20))));
      lVar10 = __ftol((double)CONCAT26(rcMine.left,CONCAT24(iVar5,CONCAT22(hdc_2,unaff_SI)))
                             );
      iVar6 = (int)lVar10;
      iVar5 = (&((THING *)lpThings)[sel.scan.ith].pt)->x;
      iVar7 = ((THING *)lpThings)[sel.scan.ith].pt.y;
      rcMine.right = iVar5 + iVar6;
      rcMine.bottom = iVar7 - iVar6;
      rcMine.left = iVar5 - iVar6;
      rcMine.top = iVar7 + iVar6;
      LogicalToScan((POINT *)&rcMine);
      LogicalToScan((POINT *)&rcMine.right);
      InflateRect((undefined2 *)CONCAT22(unaff_SS,&rcMine),1,1);
      hdc = GetDC(hwndScanner);
      DrawScanner(hdc,&rcMine);
      ReleaseDC(hwndScanner,hdc);
    }
    if (sel.pl.id != -1) {
      DrawPlanShip(0,0x4002);
    }
    if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
      AdvanceTutor();
    }
  }
  return;
}



// ======================================================================
// Function: FGetNextObjHere
// Address: 1058:909c
// Segment: MEMORY_SCAN
// ======================================================================


short FGetNextObjHere(SCAN *pscan,short fOnlyOurs)

{
  FLEET *pFVar1;
  int iVar2;
  short sVar3;
  bool bVar4;
  short fFound;
  short i;
  FLEET *lpfl;
  
  bVar4 = sel.grobj != grobjFleet;
  for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[i];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    if (bVar4) {
      if (((sel.pt.x == (&pFVar1->pt)->x) && (sel.pt.y == (pFVar1->pt).y)) &&
         ((fOnlyOurs == 0 || (pFVar1->iPlayer == idPlayer)))) break;
    }
    else if (lpfl->id == sel.id) {
      bVar4 = true;
    }
  }
  if (bVar4) {
    if (i < cFleet) {
      pscan->ifl = i;
      pscan->grobj = grobjFleet;
    }
    else if (((sel.grobjFull & grobjPlanet) == grobjNone) ||
            (sel.pl.iPlayer != idPlayer)) {
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar1 = ((FLEET **)rglpfl)[i];
        iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
        if (((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) ||
           ((((pscan->pt).x == (&pFVar1->pt)->x && ((pscan->pt).y == (pFVar1->pt).y)) &&
            ((fOnlyOurs == 0 || (pFVar1->iPlayer == idPlayer)))))) break;
      }
      if ((cFleet <= i) || (lpfl->id == sel.id)) {
        return 0;
      }
      pscan->ifl = i;
      pscan->grobj = grobjFleet;
    }
    else {
      pscan->grobj = grobjPlanet;
      pscan->idpl = sel.pl.id;
    }
    sVar3 = 1;
  }
  else {
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: FindDlg
// Address: 1058:9286
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: rc */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short FindDlg(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  short sVar1;
  char *sz;
  HWND HVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar3;
  RECT rc;
  char szName [40];
  
  if (msg == 0x14) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    return 1;
  }
  if (msg == 0x19) {
    uVar3 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),rc.left);
    if ((int)uVar3 == 6) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return hbrButtonFace;
    }
  }
  else {
    if (msg == 0x110) {
      StickyDlgPos(hwnd,(POINT *)&ptStickyFindDlg,1);
      SendDlgItemMessage(hwnd,0x10c,0x415,0x27,0);
      return 1;
    }
    if (msg == 0x111) {
      if ((wParam == 1) || (wParam == 2)) {
        if (wParam == 1) {
          GetDlgItemText(hwnd,0x10c,(LPSTR)CONCAT22(unaff_SS,szName),0x28);
          sVar1 = FSelectSz(szName);
          if (sVar1 == 0) {
            sVar1 = 0x10;
            sz = PszFormatIds(idsSorryCantFindPlanetFleetName,(short *)0x0);
            AlertSz(sz,sVar1);
            HVar2 = GetDlgItem(hwnd,0x10c);
            SetFocus(HVar2);
            SendDlgItemMessage(hwnd,0x10c,0x401,0,-0x10000);
            return 0;
          }
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyFindDlg,0);
        EndDialog(hwnd,(uint)(wParam == 1));
        return 1;
      }
      if (wParam == 0x76) {
        WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x43d);
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: FSelectSz
// Address: 1058:945a
// Segment: MEMORY_SCAN
// ======================================================================


short FSelectSz(char *szName)

{
  FLEET *pFVar1;
  int iVar2;
  POINT pt;
  POINT pt_00;
  POINT pt_01;
  POINT pt_02;
  ushort uVar3;
  short sVar4;
  char *pcVar5;
  undefined2 uVar6;
  char *pcVar7;
  SCAN scan;
  short iplPartial;
  char szT [20];
  short cch;
  short ipl;
  FLEET *lpfl;
  short ifl;
  char *pch;
  
  iplPartial = -1;
  scan.iwp = -1;
  for (ipl = 0; ipl < game.cPlanMax; ipl = ipl + 1) {
    pcVar7 = szName;
    pcVar5 = PszGetCompressedPlanet(((short *)rgidPlan)[ipl]);
    sVar4 = __strcmpi(pcVar5,pcVar7);
    if (sVar4 == 0) break;
    if (iplPartial == -1) {
      uVar3 = _strlen(szName);
      pcVar7 = szName;
      pcVar5 = PszGetCompressedPlanet(((short *)rgidPlan)[ipl]);
      sVar4 = __strnicmp(pcVar5,pcVar7,uVar3);
      if (sVar4 == 0) {
        iplPartial = ipl;
      }
    }
  }
  do {
    if (ipl != game.cPlanMax) {
      pt.y = *(short *)((int)&rgptPlan[0].y + ipl * 4);
      pt.x = ((POINT *)rgptPlan + ipl)->x;
      FFindNearestObject(pt,grobjPlanet,&scan);
      ChangeScanSel(&scan,1);
      pt_01.y = scan.pt.y;
      pt_01.x = scan.pt.x;
      FEnsurePointOnScreen(pt_01,1);
      UpdateWindow(hwndScanner);
      SendMessage(hwndScanner,0x102,0x76,0);
      return 1;
    }
    uVar3 = CchGetString(idsFleet,szT);
    sVar4 = __strnicmp(szName,szT,uVar3);
    if (sVar4 == 0) {
      pch = szName + 6;
    }
    else {
      pch = szName;
    }
    for (; *pch == ' '; pch = pch + 1) {
    }
    if (*pch == '#') {
      pch = pch + 1;
    }
    for (; *pch == ' '; pch = pch + 1) {
    }
    if (('0' < *pch) && (*pch < ':')) {
      ifl = *pch + -0x30;
      do {
        pch = pch + 1;
        if ((((undefined *)&DAT_1120_175f)[*pch] & 4) == 0) {
          lpfl = LpflFromId(ifl - 1U | idPlayer << 9);
          if (((FLEET *)lpfl != (FLEET *)0x0) || ((int)((ulong)lpfl >> 0x10) != 0))
          goto SCAN_LFoundFleetId;
          break;
        }
        ifl = ifl * 10 + (int)*pch + -0x30;
      } while (ifl < 0x201);
    }
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar1 = ((FLEET **)rglpfl)[ifl];
      iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
      if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
      pcVar7 = szName;
      pcVar5 = PszGetFleetName(lpfl->id);
      sVar4 = __strcmpi(pcVar5,pcVar7);
      if (sVar4 == 0) {
SCAN_LFoundFleetId:
        uVar6 = (undefined2)((ulong)lpfl >> 0x10);
        pt_00.y = (((FLEET *)lpfl)->pt).y;
        pt_00.x = (&((FLEET *)lpfl)->pt)->x;
        FFindNearestObject(pt_00,grobjFleet,&scan);
        scan.ifl = IflFromLpfl(lpfl);
        ChangeScanSel(&scan,2);
        pt_02.y = scan.pt.y;
        pt_02.x = scan.pt.x;
        FEnsurePointOnScreen(pt_02,1);
        UpdateWindow(hwndScanner);
        SendMessage(hwndScanner,0x102,0x76,0);
        return 1;
      }
    }
    if (iplPartial == -1) {
      return 0;
    }
    ipl = iplPartial;
  } while( true );
}



// ======================================================================
// Function: GetScanFleetOrientation
// Address: 1058:978c
// Segment: MEMORY_SCAN
// ======================================================================


void GetScanFleetOrientation(FLEET *lpfl,POINT *ppt,POINT *pptD)

{
  FLEET *pFVar1;
  undefined2 uVar2;
  short dx;
  short dy;
  
  uVar2 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar1 = (FLEET *)lpfl;
  if (pFVar1->iPlayer == idPlayer) {
    if ((1 < pFVar1->cord) && (((uint)((PLORD *)pFVar1->lpplord + 7)->wFlags >> 4 & 0xf) != 0)) {
      dx = *(int *)&((PLORD *)pFVar1->lpplord)[5].iordMax - (&pFVar1->pt)->x;
      dy = ((PLORD *)pFVar1->lpplord + 6)->wFlags - (pFVar1->pt).y;
      goto LAB_1058_985e;
    }
  }
  else if ((((uint)pFVar1->wFlags >> 4 & 1) != 0) && ((pFVar1->wFlags & 0xfU) != 0)) {
    dx = (*(uint *)&pFVar1->field17_0x74 & 0xff) - 0x7f;
    dy = (*(uint *)&pFVar1->field17_0x74 >> 8) - 0x7f;
    goto LAB_1058_985e;
  }
  dy = 0;
  dx = 0;
LAB_1058_985e:
  GetDxDyOrientation(dx,dy,ppt,pptD);
  return;
}



// ======================================================================
// Function: GetDxDyOrientation
// Address: 1058:987c
// Segment: MEMORY_SCAN
// ======================================================================


void GetDxDyOrientation(short dx,short dy,POINT *ppt,POINT *pptD)

{
  short sVar1;
  int iVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar3;
  long local_16;
  short iBmp;
  double dbl;
  
  iBmp = 0;
  if ((dx != 0) || (dy != 0)) {
    local_16 = (long)dx;
    iVar2 = dy >> 0xf;
    _atan2(SUB84((double)(long)dy,0),
                   (double)CONCAT44(SUB84((double)local_16,0),
                                    (long)((qword)(double)(long)dy >> 0x20)),
                   (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)local_16 >>
                                                                     0x20))));
    lVar3 = __ftol((double)CONCAT26(iVar2,CONCAT24(dy,CONCAT22(unaff_SI,unaff_DI))));
    iBmp = 9 - ((uint)lVar3 & 7) & 7;
  }
  if (iScanZoom < 0) {
    sVar1 = 7;
  }
  else {
    sVar1 = 9;
  }
  pptD->y = sVar1;
  pptD->x = sVar1;
  if (iScanZoom < 0) {
    ppt->x = 0;
  }
  else {
    ppt->x = 7;
  }
  ppt->y = iBmp * pptD->y;
  return;
}



// ======================================================================
// Function: FHandleMeasuringTape
// Address: 1058:9974
// Segment: MEMORY_SCAN
// ======================================================================


short FHandleMeasuringTape(SCAN *pscan,POINT pt)

{
  bool bVar1;
  HDC hdc_00;
  HGDIOBJ HVar2;
  short sVar3;
  short sVar4;
  uint uVar5;
  GrobjClass grobj;
  undefined2 unaff_SS;
  POINT pt_00;
  RECT rc;
  SCAN scan;
  short fVirgin;
  char szT [20];
  POINT ptNew;
  short iropSav;
  POINT ptBase;
  POINT ptLogical;
  short grTypeIn;
  POINT ptLogLast;
  SBAR sbar;
  HPEN hpenSav;
  HDC hdc;
  
  bVar1 = true;
  ptLogLast.x = (pscan->pt).x;
  ptLogLast.y = (pscan->pt).y;
  ptBase.x = (pscan->pt).x;
  ptBase.y = (pscan->pt).y;
  LogicalToScan(&ptBase);
  GetClientRect(hwndScanner,(undefined2 *)CONCAT22(unaff_SS,&rc));
  rc.bottom = rc.bottom - dySBar;
  hdc_00 = GetDC(hwndScanner);
  SetCapture(hwndScanner);
  sbar.pscan = pscan;
  HVar2 = SelectObject(hdc_00,hpenShip);
  sVar3 = SetROP2(hdc_00,7);
  ptNew.x = pt.x;
  ptNew.y = pt.y;
  LogicalToScan(&ptNew);
LAB_1058_9a11:
  do {
    sVar4 = FGetRMouseMove(&ptNew);
    if (sVar4 == 0) {
      if (!bVar1) {
        MoveTo(hdc_00,ptBase.x,ptBase.y);
        LineTo(hdc_00,pt.x,pt.y);
      }
      SetROP2(hdc_00,sVar3);
      SelectObject(hdc_00,HVar2);
      DrawScannerSBar(hdc_00,(RECT *)0x0,(SBAR *)0x0,0);
      ReleaseCapture();
      ReleaseDC(hwndScanner,hdc_00);
      return (uint)!bVar1;
    }
    uVar5 = rc.right;
    if (ptNew.x <= rc.right) {
      uVar5 = ptNew.x;
    }
    if (uVar5 < 0x8000) {
      ptLogical.x = rc.right;
      if (ptNew.x <= rc.right) {
        ptLogical.x = ptNew.x;
      }
    }
    else {
      ptLogical.x = 0;
    }
    uVar5 = rc.bottom;
    if (ptNew.y <= rc.bottom) {
      uVar5 = ptNew.y;
    }
    if (uVar5 < 0x8000) {
      ptLogical.y = rc.bottom;
      if (ptNew.y <= rc.bottom) {
        ptLogical.y = ptNew.y;
      }
    }
    else {
      ptLogical.y = 0;
    }
    ptNew.x = ptLogical.x;
    ptNew.y = ptLogical.y;
    ScanToLogical(&ptLogical);
    uVar5 = GetAsyncKeyState(0x10);
    if ((uVar5 & 0xfffe) == 0) {
      grobj = 0x4f;
    }
    else {
      grobj = 0x8f;
    }
    pt_00.y = ptLogical.y;
    pt_00.x = ptLogical.x;
    sVar4 = FFindNearestObject(pt_00,grobj,&scan);
    if (sVar4 != 0) {
      ptLogical.x = scan.pt.x;
      ptLogical.y = scan.pt.y;
    }
  } while ((ptLogLast.x == ptLogical.x) && (ptLogLast.y == ptLogical.y));
  ptNew.x = ptLogical.x;
  ptNew.y = ptLogical.y;
  LogicalToScan(&ptNew);
  if (bVar1) goto LAB_1058_9b36;
  MoveTo(hdc_00,ptBase.x,ptBase.y);
  LineTo(hdc_00,pt.x,pt.y);
  goto LAB_1058_9b8b;
LAB_1058_9b36:
  sVar4 = _abs(ptLogical.x - ptLogLast.x);
  if ((2 < sVar4) || (sVar4 = _abs(ptLogical.y - ptLogLast.y), 2 < sVar4)) {
    bVar1 = false;
LAB_1058_9b8b:
    MoveTo(hdc_00,ptBase.x,ptBase.y);
    LineTo(hdc_00,ptNew.x,ptNew.y);
    if (scan.grobj == grobjNone) {
      sbar.id = -1;
      CchGetString(idsDeepSpace,szT);
      sbar.psz = szT;
    }
    else {
      if (scan.grobj == grobjPlanet) {
        sbar.id = scan.idpl;
      }
      else if (scan.grobj == grobjFleet) {
        sbar.id = ((FLEET **)rglpfl)[scan.ifl]->id;
      }
      else if (scan.grobj == grobjThing) {
        sbar.id = ((THING *)lpThings + scan.ith)->idFull;
      }
      else {
        sbar.id = scan.iwp;
      }
      sbar.psz = (char *)0x0;
    }
    sbar.pt.x = ptLogical.x;
    sbar.pt.y = ptLogical.y;
    sbar.grbit = scan.grobj;
    DrawScannerSBar(hdc_00,(RECT *)0x0,&sbar,0);
    pt.y = ptNew.y;
    pt.x = ptNew.x;
    ptLogLast.x = ptLogical.x;
    ptLogLast.y = ptLogical.y;
  }
  goto LAB_1058_9a11;
}



