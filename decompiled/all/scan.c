// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: ScannerWndProc
// Address: 1058:0032
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x105809f8) */
/* WARNING: Removing unreachable block (ram,0x1058094a) */
/* WARNING: Removing unreachable block (ram,0x1058014f) */
/* WARNING: Type propagation algorithm not settling */

long ScannerWndProc(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  ushort uVar1;
  FLEET *pFVar2;
  int iVar3;
  POINT PVar4;
  POINT PVar5;
  POINT pt_00;
  POINT pt_01;
  POINT ptIn;
  POINT pt_02;
  POINT pt_03;
  POINT pt_04;
  BOOL BVar6;
  short sVar7;
  uint uVar8;
  HCURSOR HVar9;
  GrobjClass grobj;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar10;
  undefined2 unaff_SS;
  DWORD DVar11;
  ulong uVar12;
  LRESULT LVar13;
  short dy;
  ushort in_stack_0000fdda;
  short id;
  short iSel;
  short iChecked;
  ushort rgid;
  uint local_218 [199];
  short fSep;
  FLEET *lpfl;
  THING *lpth;
  short c;
  short i;
  SCAN scan;
  short fChgScan;
  undefined1 plT [48];
  short i__58;
  short iRopSav;
  HPEN hpenSav;
  short iScanNew;
  RECT rc;
  PAINTSTRUCT ps;
  POINT pt;
  HDC hdc;
  
  uVar12 = CONCAT22(unaff_SI,unaff_DI);
  if (msg == 1) {
    yScanTop = 1000;
    xScanTop = 1000;
    return 0;
  }
  if (msg == 5) {
    SetScanScrollBars(hwnd);
    PostMessage(hwndFrame,0x111,iScanZoom + 0xf41,0);
  }
  else {
    if (msg == 0xf) {
      hdc = BeginPaint(hwnd,&ps);
      if ((((FLEET **)rglpfl != (FLEET **)0x0) || (rglpfl._2_2_ != 0)) &&
         (((uint)gd.grBits2 & 1) == 0)) {
        GetClientRect(hwnd,&rc);
        DrawScannerSBar(hdc,&ps.rcPaint,(SBAR *)0x0,1);
        rc.bottom = rc.bottom - dySBar;
        DrawScanner(hdc,&ps.rcPaint);
      }
      EndPaint(hwnd,&ps);
      return 0;
    }
    if (msg != 0x20) {
      if (msg == 0x102) {
        if ((wParam == 0x76) || (wParam == 0x56)) {
          hdc = GetDC(hwndScanner);
          pt.x = sel.scan.pt.x;
          pt.y = sel.scan.pt.y;
          LogicalToScan(&pt);
          iRopSav = SetROP2(hdc,7);
          hpenSav = SelectObject(hdc,hpenYellow);
          for (i__58 = 0; i__58 < 2; i__58 = i__58 + 1) {
            MoveTo(hdc,pt.x + -300,pt.y + -300);
            LineTo(hdc,pt.x + 300,pt.y + 300);
            MoveTo(hdc,pt.x + -300,pt.y + 300);
            LineTo(hdc,pt.x + 300,pt.y + -300);
            if (i__58 == 0) {
              DVar11 = GetTickCount();
              plT._44_4_ = DVar11;
              while( true ) {
                DVar11 = GetTickCount();
                if (plT._44_4_ + 0x96 <= DVar11) break;
                Yield();
              }
            }
          }
          SelectObject(hdc,hpenSav);
          SetROP2(hdc,iRopSav);
          ReleaseDC(hwndScanner,hdc);
        }
        else {
          if (wParam == 0x2d) {
            iScanNew = iScanZoom + -1;
            if (iScanNew < -4) {
              iScanNew = -4;
            }
          }
          else {
            iScanNew = iScanZoom + 1;
            if (4 < iScanNew) {
              iScanNew = 4;
            }
          }
          if (iScanNew != iScanZoom) {
            SendMessage(hwndFrame,0x111,iScanNew + 0xf41,0);
          }
        }
      }
      else if ((msg == 0x114) || (msg == 0x115)) {
        switch(wParam) {
        case 0:
          iScanNew = -dScanInc;
          break;
        case 1:
          iScanNew = dScanInc;
          break;
        case 2:
          iScanNew = -dScanPage;
          break;
        case 3:
          iScanNew = dScanPage;
          break;
        case 4:
        case 5:
          sVar7 = yScanTop;
          if (msg != 0x115) {
            sVar7 = xScanTop;
          }
          iScanNew = (int)lParam - sVar7 & 0xfffc;
          break;
        default:
          iScanNew = 0;
        }
        if (iScanNew != 0) {
          if (msg == 0x115) {
            hpenSav = yScanTop;
            SetScrollPos(hwnd,1,yScanTop + iScanNew,1);
            yScanTop = GetScrollPos(hwnd,1);
            sVar7 = PtToScan(hpenSav - yScanTop);
            ScrollScanner(0,sVar7);
          }
          else {
            hpenSav = xScanTop;
            SetScrollPos(hwnd,0,xScanTop + iScanNew,1);
            xScanTop = GetScrollPos(hwnd,0);
            dy = 0;
            sVar7 = PtToScan(hpenSav - xScanTop);
            ScrollScanner(sVar7,dy);
          }
        }
      }
      else if ((((msg == 0x201) || (msg == 0x203)) || (msg == 0x204)) || (msg == 0x207)) {
        SetFocus(hwndFrame);
        pt.x = (int)lParam;
        uVar12 = __aFulshr(uVar12,in_stack_0000fdda);
        pt.y = (short)uVar12;
        GetClientRect(hwnd,&rc);
        if (pt.y < rc.bottom - dySBar) {
          ScanToLogical(&pt);
          if (((gd.grBits._2_2_ >> 8 & 1) == 0) && ((gd.grBits._2_2_ >> 0xd & 1) == 0)
             ) {
            grobj = grobjThing|grobjOther|grobjFleet|grobjPlanet;
          }
          else {
            grobj = grobjPlanet;
          }
          pt_01.y = pt.y;
          pt_01.x = pt.x;
          FFindNearestObject(pt_01,grobj,&scan);
          if ((((gd.grBits._2_2_ >> 8 & 1) == 0) &&
              (((sel.grobj != grobjPlanet || ((wParam & 4) == 0)) ||
               (sVar7 = IWarpMAFromLppl(&sel.pl,(short *)0x0), sVar7 < 1)))) ||
             (msg != 0x201)) {
            if ((((gd.grBits._2_2_ >> 0xd & 1) == 0) &&
                ((sel.grobj != grobjPlanet || ((wParam & 8) == 0)))) || (msg != 0x201)) {
              if ((msg == 0x207) || ((msg == 0x204 && ((wParam & 4) != 0)))) {
                pt_03.y = pt.y;
                pt_03.x = pt.x;
                FHandleMeasuringTape(&scan,pt_03);
              }
              else {
                if (msg == 0x204) {
                  iChecked = -1;
                  pt.x = scan.pt.x;
                  pt.y = scan.pt.y;
                  if ((scan.grobjFull & grobjPlanet) == grobjNone) {
                    c = 0;
                  }
                  else {
                    local_218[0] = scan.idpl >> 0xf;
                    rgid = scan.idpl;
                    local_218[1] = 0xffff;
                    local_218[2] = 0xffff;
                    c = 2;
                    if ((sel.grobj == grobjPlanet) && (sel.id == scan.idpl)) {
                      iChecked = 0;
                    }
                  }
                  for (i = 0; sVar7 = c, i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
                    pFVar2 = ((FLEET **)rglpfl)[i];
                    iVar3 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                    lpfl = (FLEET *)CONCAT22(iVar3,pFVar2);
                    if ((pFVar2 == (FLEET *)0x0) && (iVar3 == 0)) break;
                    if ((pt.x == (&pFVar2->pt)->x) && (pt.y == (pFVar2->pt).y)) {
                      if ((sel.grobj == grobjFleet) && (lpfl->id == sel.id)) {
                        iChecked = c;
                      }
                      uVar1 = lpfl->id;
                      iVar3 = c * 2;
                      c = c + 1;
                      (&rgid)[iVar3] = uVar1;
                      local_218[sVar7 * 2] = (int)uVar1 >> 0xf | 0x8000;
                      if (0x61 < c) break;
                    }
                  }
                  if ((c == 2) && ((scan.grobjFull & grobjPlanet) != grobjNone)) {
                    c = 1;
                  }
                  fSep = (short)(c == 0);
                  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
                  while (sVar7 = c, (THING *)lpth < (THING *)lpThings + cThing) {
                    uVar10 = (undefined2)((ulong)lpth >> 0x10);
                    if ((pt.x == (&((THING *)lpth)->pt)->x) && (pt.y == (((THING *)lpth)->pt).y)) {
                      if (fSep == 0) {
                        iVar3 = c * 2;
                        c = c + 1;
                        (&rgid)[iVar3] = 0xffff;
                        local_218[sVar7 * 2] = 0xffff;
                        fSep = 1;
                      }
                      sVar7 = c;
                      iVar3 = c * 2;
                      c = c + 1;
                      (&rgid)[iVar3] = lpth->idFull;
                      local_218[sVar7 * 2] = 0x2000;
                      if (99 < c) break;
                    }
                    lpth = (THING *)lpth + 1;
                  }
                  LogicalToScan(&pt);
                  sVar7 = PopupMenu(hwnd,pt.x,pt.y,c,&rgid,(char **)0x0,iChecked,1);
                  if (sVar7 < 0) {
                    return 0;
                  }
                  if ((local_218[sVar7 * 2] & 0x8000) == 0) {
                    if ((local_218[sVar7 * 2] & 0x2000) == 0) {
                      scan.grobj = grobjPlanet;
                    }
                    else {
                      scan.grobj = grobjThing;
                      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
                      while (((THING *)lpth < (THING *)lpThings + cThing &&
                             (lpth->idFull != (&rgid)[sVar7 * 2]))) {
                        lpth = (THING *)lpth + 1;
                      }
                      scan.ith = ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12;
                    }
                  }
                  else {
                    scan.grobj = grobjFleet;
                    for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
                      pFVar2 = ((FLEET **)rglpfl)[i];
                      iVar3 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                      lpfl = (FLEET *)CONCAT22(iVar3,pFVar2);
                      if (((pFVar2 == (FLEET *)0x0) && (iVar3 == 0)) ||
                         (lpfl->id == (&rgid)[sVar7 * 2])) break;
                    }
                    scan.ifl = i;
                  }
                  ChangeScanSel(&scan,2);
                  if (scan.grobj == grobjPlanet) {
                    sVar7 = FLookupPlanet(scan.idpl,plT);
                    if (sVar7 == 0) {
                      return 0;
                    }
                    if (plT._2_2_ != idPlayer) {
                      return 0;
                    }
                  }
                }
                else {
                  if ((sel.grobj == grobjFleet) &&
                     (((wParam & 4) != 0 || ((grbitScan & 0x10) != 0)))) {
                    ptIn.y = pt.y;
                    ptIn.x = pt.x;
                    FAddWayPoint(ptIn,&scan);
                    return 0;
                  }
                  if ((scan.pt.x == sel.scan.pt.x) &&
                     (scan.pt.y == sel.scan.pt.y)) {
                    fChgScan = 1;
                  }
                  else {
                    fChgScan = 0;
                  }
                  ChangeScanSel(&scan,1);
                  pt_02.y = pt.y;
                  pt_02.x = pt.x;
                  sVar7 = FNearAWayPoint(pt_02,1);
                  if ((sVar7 != 0) &&
                     (pt_04.y = pt.y, pt_04.x = pt.x, sVar7 = FHandleWayPointDrag(pt_04), sVar7 != 0
                     )) {
                    return 0;
                  }
                  if (fChgScan == 0) {
                    return 0;
                  }
                  if ((scan.grobj != grobjFleet) && (scan.grobj != grobjPlanet)) {
                    return 0;
                  }
                  if ((scan.pt.x == sel.pt.x) && (scan.pt.y == sel.pt.y)) {
                    sVar7 = FGetNextObjHere(&scan,1);
                    if (sVar7 == 0) {
                      return 0;
                    }
                  }
                  else if (scan.grobj == grobjPlanet) {
                    sVar7 = FLookupPlanet(scan.idpl,plT);
                    if (sVar7 == 0) {
                      return 0;
                    }
                    if ((plT._2_2_ != idPlayer) ||
                       ((((scan.grobjFull & grobjFleet) != grobjNone &&
                         (sel.grobj == grobjPlanet)) && (scan.idpl == sel.id))))
                    {
                      if ((scan.grobjFull & grobjFleet) == grobjNone) {
                        return 0;
                      }
                      scan.grobj = grobjFleet;
                    }
                  }
                }
                if (((scan.grobj != grobjFleet) ||
                    (((FLEET *)((FLEET **)rglpfl)[scan.ifl])->iPlayer == idPlayer)) &&
                   (scan.grobj != grobjThing)) {
                  if (scan.grobj == grobjFleet) {
                    scan.iwp = -1;
                  }
                  ChangeScanSel(&scan,1);
                  RedrawScanSel(0,0);
                  if (scan.grobj != grobjPlanet) {
                    scan.idpl = ((FLEET **)rglpfl)[scan.ifl]->id;
                  }
                  ChangeMainObjSel(scan.grobj,scan.idpl);
                  RedrawScanSel(0,1);
                  if ((scan.grobj == grobjFleet) && ((scan.grobjFull & grobjPlanet) != grobjNone)) {
                    scan.grobj = grobjPlanet;
                    ChangeScanSel(&scan,1);
                  }
                }
              }
            }
            else {
              DrawShipScanPath(0,0);
              if (scan.idpl == sel.pl.id) {
                sel.pl.wRouting = sel.pl.wRouting & 0xfc00;
              }
              else {
                i = scan.idpl + 1;
                sel.pl.wRouting = sel.pl.wRouting & 0xfc00 | i & 0x3ffU;
              }
              FLookupPlanet(-1,(PLANET *)&sel.pl);
              gd.grBits._2_2_ = gd.grBits._2_2_ & 0xdfff;
              DrawShipScanPath(0,1);
              DrawPlanShip(0,0x4040);
            }
          }
          else {
            DrawShipScanPath(0,0);
            if (scan.idpl == sel.pl.id) {
              sel.pl.lStarbase._2_2_ = sel.pl.lStarbase._2_2_ & 0xfc00;
            }
            else {
              i = scan.idpl + 1;
              sel.pl.lStarbase._2_2_ =
                   sel.pl.lStarbase._2_2_ & 0xfc00 | i & 0x3ffU;
            }
            FLookupPlanet(-1,(PLANET *)&sel.pl);
            gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfeff;
            DrawShipScanPath(0,1);
            DrawPlanShip(0,0x4100);
          }
        }
        else if (((msg == 0x201) && (pt.y < rc.bottom - (dySBar >> 1))) &&
                ((sel.scan.grobjFull & (grobjFleet|grobjPlanet)) != grobjNone)) {
          if (sel.scan.grobj == grobjFleet) {
            GlobalPD.grPopup = 3;
            GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst =
                 *(undefined2 *)((FLEET **)rglpfl + sel.scan.ifl);
            GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 =
                 *(ushort *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
          }
          else {
            GlobalPD.grPopup = 4;
          }
          Popup(hwnd,pt.x,pt.y);
        }
      }
      else {
        if (msg != 0x222) goto SCAN_Default_2;
        hwndActive = hwnd;
        if (wParam == 0) {
          hwndActive = 0;
        }
      }
      return 0;
    }
    GetCursorPos(&pt);
    ScreenToClient(hwndScanner,&pt);
    GetClientRect(hwnd,&rc);
    PVar4.y = pt.y;
    PVar4.x = pt.x;
    BVar6 = PtInRect(&rc,PVar4);
    if (BVar6 != 0) {
      rc.bottom = rc.bottom - dySBar;
      PVar5.y = pt.y;
      PVar5.x = pt.x;
      BVar6 = PtInRect(&rc,PVar5);
      if (BVar6 == 0) {
        HVar9 = LoadCursor(0,(LPCSTR)0x7f00);
        setcursor(HVar9);
      }
      else if ((sel.grobj == grobjFleet) &&
              ((uVar8 = GetAsyncKeyState(0x10), (uVar8 & 0xfffe) != 0 ||
               ((grbitScan & 0x10) != 0)))) {
        setcursor(hcurScanAdd);
      }
      else {
        pt_00.y = pt.y;
        pt_00.x = pt.x;
        sVar7 = FNearAWayPoint(pt_00,0);
        if (sVar7 == 0) {
          if ((((gd.grBits._2_2_ >> 8 & 1) == 0) &&
              ((gd.grBits._2_2_ >> 0xd & 1) == 0)) &&
             ((sel.grobj != grobjPlanet ||
              (((uVar8 = GetAsyncKeyState(0x10), (uVar8 & 0xfffe) == 0 ||
                (sVar7 = IWarpMAFromLppl(&sel.pl,(short *)0x0), sVar7 < 1)) &&
               (uVar8 = GetAsyncKeyState(0x11), (uVar8 & 0xfffe) == 0)))))) {
            setcursor(hcurScanner);
          }
          else {
            setcursor(hcurScanAdd);
          }
        }
        else {
          setcursor(hcurOpenGrab);
        }
      }
      return 1;
    }
  }
SCAN_Default_2:
  LVar13 = DefWindowProc(hwnd,msg,wParam,lParam);
  return LVar13;
}



// ======================================================================
// Function: PtToScan
// Address: 1058:0efc
// Segment: MEMORY_SCAN
// ======================================================================


short PtToScan(short d)

{
  if (iScanZoom != 0) {
    switch(iScanZoom) {
    default:
      break;
    case 1:
      d = d * 5 >> 2;
      break;
    case 2:
      d = d * 3 >> 1;
      break;
    case 3:
      d = d << 1;
      break;
    case 4:
      d = d << 2;
      break;
    case -4:
      d = d >> 2;
      break;
    case -3:
      d = d * 3 >> 3;
      break;
    case -2:
      d = d >> 1;
      break;
    case -1:
      d = d * 3 >> 2;
    }
  }
  return d;
}



// ======================================================================
// Function: ScanToPt
// Address: 1058:0fc2
// Segment: MEMORY_SCAN
// ======================================================================


short ScanToPt(short d)

{
  if (iScanZoom != 0) {
    switch(iScanZoom) {
    default:
      break;
    case 1:
      d = (d << 2) / 5;
      break;
    case 2:
      d = (d << 1) / 3;
      break;
    case 3:
      d = d >> 1;
      break;
    case 4:
      d = d >> 2;
      break;
    case -4:
      d = d << 2;
      break;
    case -3:
      d = (d << 3) / 3;
      break;
    case -2:
      d = d << 1;
      break;
    case -1:
      d = (d << 2) / 3;
    }
  }
  return d;
}



// ======================================================================
// Function: DrawScanner
// Address: 1058:108a
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: dPlanRange */
/* WARNING: Removing unreachable block (ram,0x105838a5) */
/* WARNING: Removing unreachable block (ram,0x10583928) */
/* WARNING: Removing unreachable block (ram,0x10581d7f) */
/* WARNING: Removing unreachable block (ram,0x1058118f) */
/* WARNING: Removing unreachable block (ram,0x10582bf0) */
/* WARNING: Removing unreachable block (ram,0x105841d5) */

short DrawScanner(HDC hdc,RECT *prc)

{
  double dVar1;
  HGDIOBJ HVar2;
  short sVar3;
  uint uVar4;
  HBRUSH HVar5;
  HPEN HVar6;
  undefined2 uVar7;
  int *piVar8;
  PLANET *pPVar9;
  THING *pTVar10;
  FLEET *pFVar11;
  int iVar12;
  HDC unaff_SI;
  RECT *unaff_DI;
  undefined2 unaff_SS;
  bool bVar13;
  COLORREF CVar14;
  long lVar15;
  RECT *pRVar16;
  undefined2 uVar17;
  HDC HVar18;
  THING *in_stack_0000f586;
  short dPlanRange;
  short *psVar19;
  short *psVar20;
  short sVar21;
  short rgrad [500];
  short fPlanetScanner;
  short rgy [240];
  THING *local_492;
  HBITMAP hbmpTrSav;
  THING *lpthMac;
  uint l;
  THING *lpth;
  undefined4 hbr;
  int pt2;
  short fTerra;
  undefined4 crBack;
  undefined4 l__1146;
  RECT rc;
  uint ptOrigin;
  uint local_46c;
  short fDoDraw;
  short xLeft;
  HBRUSH hbrSav;
  short dx;
  short yMin;
  ushort mdScanBase;
  short fStargate;
  THING *lpthMac__1116;
  uint local_45a;
  short ptSelMain;
  short local_456;
  short fStarbase;
  short fMA;
  short fSelected;
  POINT ptO;
  short idP;
  short dRange;
  short rcDraw;
  short sStack_444;
  short sStack_442;
  short sStack_440;
  short yOff;
  short rcClip;
  short local_43a;
  short local_438;
  short local_436;
  short iord;
  HBITMAP hbmpSav;
  short xMin;
  short i;
  FLEET *lpfl;
  THING *lpth__1064;
  HDC hdcMem;
  char rgWhatsHere [1000];
  short yMax;
  PLANET *lppl;
  HDC hdcScreen;
  short id2;
  HBITMAP hbmpScreen;
  HBITMAP hbmpXSav;
  short dy;
  short yBmp;
  PLANET *lpplMac;
  short local_26;
  POINT ptD;
  short iBkPrev;
  undefined4 crFore;
  short id;
  POINT pt;
  short xMax;
  short yTop;
  short j;
  FLEET *lpflT;
  HPEN hpenSav;
  short dExpand;
  short xOff;
  
  mdScanBase = grbitScan & 0xf;
  hdcScreen = 0;
  hbmpScreen = 0;
  if (((((FLEET **)rglpfl != (FLEET **)0x0) || (rglpfl._2_2_ != 0)) &&
      (((uint)gd.grBits2 & 1) == 0)) && (((uint)gd.grBits >> 1 & 1) == 0)) {
    xLeft = xScanTop;
    yTop = yScanTop;
    ptOrigin = PtToScan(4000 - xScanTop);
    ptOrigin = ptOrigin & 7;
    local_46c = PtToScan(4000 - yScanTop);
    local_46c = local_46c & 7;
    GetClientRect(hwndScanner,&rc);
    ExcludeClipRect(hdc,0,rc.bottom - dySBar,rc.right,rc.bottom);
    l__1146._0_2_ = prc->right - prc->left;
    l__1146._2_2_ = (int)l__1146 >> 0xf;
    l__1146 = __aFulmul((long)(int)l__1146,(long)(prc->bottom - prc->top));
    if ((long)l__1146 < 48000) {
      hdcMem = CreateCompatibleDC(hdc);
      if (hdcMem != 0) {
        hbmpScreen = CreateCompatibleBitmap
                               (hdc,prc->right - (prc->left & 0xfff8U),
                                prc->bottom - (prc->top & 0xfff8U));
        if (hbmpScreen == 0) {
          DeleteDC(hdcMem);
        }
      }
      HVar18 = hdcMem;
      if (hbmpScreen != 0) {
        hdcScreen = hdc;
        hdc = hdcMem;
        hbmpXSav = SelectObject(hdcMem,hbmpScreen);
        SetWindowOrg(HVar18,prc->left & 0xfff8,prc->top & 0xfff8);
        pt.y = 0;
        pt.x = 0;
        ClientToScreen(hwndScanner,&pt);
        ptOrigin = (ptOrigin + 8) - (pt.x & 7U) & 7;
        local_46c = (local_46c + 8) - (pt.y & 7U) & 7;
        rcDraw = prc->left;
        sStack_444 = prc->top;
        sStack_442 = prc->right;
        sStack_440 = prc->bottom;
      }
    }
    uVar17 = 0x1120;
    pRVar16 = prc;
    HVar18 = hdc;
    HVar2 = GetStockObject(4);
    FillRect(HVar18,(RECT *)CONCAT22(uVar17,pRVar16),HVar2);
    rcClip = prc->left;
    local_43a = prc->top;
    local_438 = prc->right;
    local_436 = prc->bottom;
    if (((iScanZoom < 3) || (mdScanBase != 4)) &&
       ((iScanZoom < 0 || ((mdScanBase != 1 && (mdScanBase != 2)))))) {
      dExpand = 9;
    }
    else {
      dExpand = 0x14;
    }
    ExpandRc(prc,dExpand,dExpand);
    prc->bottom = prc->bottom + 0xe;
    dx = ScanToPt(prc->right - prc->left);
    dy = ScanToPt(prc->bottom - prc->top);
    sVar3 = ScanToPt(prc->left);
    xMin = sVar3 + xLeft;
    xMax = xMin + dx;
    sVar3 = ScanToPt(prc->top);
    yMax = (dGalInv - yTop) - sVar3;
    yMin = yMax - dy;
    xOff = -xLeft;
    yOff = dGalInv - yTop;
    id = 1;
    for (i = 0; i < 0x10; i = i + 1) {
      if ((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) != 0) {
        grbitScanShip = grbitScanShip & ~(id & grbitScanShip);
      }
      id = id << 1;
    }
    hdcMem = CreateCompatibleDC(hdc);
    hbmpSav = SelectObject(hdcMem,hbmpScanner);
    if (sel.grobj == grobjNone) {
      local_456 = -2;
      ptSelMain = -2;
    }
    else {
      ptSelMain = sel.pt.x;
      local_456 = sel.pt.y;
    }
    if (((uint)gd.grBits2 >> 10 & 1) == 0) {
      LinkFleets(0);
    }
    else {
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar11 = ((FLEET **)rglpfl)[i];
        iVar12 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar12,pFVar11);
        if ((pFVar11 == (FLEET *)0x0) && (iVar12 == 0)) break;
        pFVar11->wFlags_0x4 = pFVar11->wFlags_0x4 & 0xf7ff;
      }
    }
    if ((grbitScan & 0x20) != 0) {
      fPlanetScanner = 0;
      IntersectClipRect(hdc,rcClip,local_43a,local_438,local_436);
      hbrSav = SelectObject(hdc,hbrRadar);
      hpenSav = SelectObject(hdc,hpenRadar);
      dPlanRange = lpPlanets._2_2_;
      lpplMac = (PLANET *)lpPlanets + cPlanet;
      local_26 = lpPlanets._2_2_;
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      while ((PLANET *)lppl < lpplMac) {
        if (((PLANET *)lppl)->iPlayer == idPlayer) {
          dRange = GetPlanetScannerRange(lppl,&dPlanRange);
          if (0 < dPlanRange) {
            fPlanetScanner = 1;
          }
          if (vpctRadarView < 100) {
            dRange = MulDiv(dRange,vpctRadarView,100);
          }
          id = lppl->id;
          rc.left = PtToScan((xOff + ((POINT *)rgptPlan + id)->x) - dRange);
          rc.top = PtToScan((yOff - *(int *)((int)&rgptPlan[0].y + id * 4)) - dRange);
          rc.right = PtToScan(xOff + ((POINT *)rgptPlan + id)->x + dRange);
          rc.bottom = PtToScan((yOff - *(int *)((int)&rgptPlan[0].y + id * 4)) + dRange);
          DrawRadarCircle(&stack0xf58c,&rc);
        }
        lppl = (PLANET *)lppl + 1;
      }
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar11 = ((FLEET **)rglpfl)[i];
        iVar12 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar12,pFVar11);
        if ((pFVar11 == (FLEET *)0x0) && (iVar12 == 0)) break;
        if (pFVar11->iPlayer == idPlayer) {
          dRange = GetFleetScannerRange
                             ((FLEET *)CONCAT22(iVar12,pFVar11),&dPlanRange,(short *)0x0,
                              (short *)0x0);
          if (0 < dPlanRange) {
            fPlanetScanner = fPlanetScanner | 2;
          }
          if (0 < dRange) {
            if (vpctRadarView < 100) {
              dRange = MulDiv(dRange,vpctRadarView,100);
            }
            rc.left = PtToScan((xOff + (&((FLEET *)lpfl)->pt)->x) - dRange);
            rc.top = PtToScan((yOff - (((FLEET *)lpfl)->pt).y) - dRange);
            rc.right = PtToScan(xOff + (&((FLEET *)lpfl)->pt)->x + dRange);
            rc.bottom = PtToScan((yOff - (((FLEET *)lpfl)->pt).y) + dRange);
            DrawRadarCircle(&stack0xf58c,&rc);
          }
        }
      }
      DrawRadarCircle(&stack0xf58c,(RECT *)0x0);
      if (hbrRadarNear == 0) {
        if (vcScreenColors < 9) {
          uVar4 = 0x7f7f;
        }
        else {
          uVar4 = 0x6060;
        }
        hbrRadarNear = HbrGet((ulong)uVar4);
      }
      if (hpenRadarNear == 0) {
        if (vcScreenColors < 9) {
          uVar4 = 0x7f7f;
        }
        else {
          uVar4 = 0x6060;
        }
        hpenRadarNear = CreatePen(0,1,(ulong)uVar4);
      }
      SelectObject(hdc,hbrRadarNear);
      SelectObject(hdc,hpenRadarNear);
      if ((fPlanetScanner & 1U) != 0) {
        dPlanRange = lpPlanets._2_2_;
        lpplMac = (PLANET *)lpPlanets + cPlanet;
        local_26 = lpPlanets._2_2_;
        lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
        while ((PLANET *)lppl < lpplMac) {
          if (((PLANET *)lppl)->iPlayer == idPlayer) {
            dRange = GetPlanetScannerRange(lppl,&dPlanRange);
            if (0 < dPlanRange) {
              dRange = dRange >> 1;
              if (vpctRadarView < 100) {
                dRange = MulDiv(dRange,vpctRadarView,100);
              }
              id = lppl->id;
              rc.left = PtToScan((xOff + ((POINT *)rgptPlan + id)->x) - dRange);
              rc.top = PtToScan((yOff - *(int *)((int)&rgptPlan[0].y + id * 4)) - dRange);
              rc.right = PtToScan(xOff + ((POINT *)rgptPlan + id)->x + dRange);
              rc.bottom = PtToScan((yOff - *(int *)((int)&rgptPlan[0].y + id * 4)) +
                                   dRange);
              DrawRadarCircle(&stack0xf58c,&rc);
            }
          }
          lppl = (PLANET *)lppl + 1;
        }
      }
      if ((fPlanetScanner & 2U) != 0) {
        for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar11 = ((FLEET **)rglpfl)[i];
          iVar12 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
          lpfl = (FLEET *)CONCAT22(iVar12,pFVar11);
          if ((pFVar11 == (FLEET *)0x0) && (iVar12 == 0)) break;
          if (pFVar11->iPlayer == idPlayer) {
            dRange = GetFleetScannerRange
                               ((FLEET *)CONCAT22(iVar12,pFVar11),&dPlanRange,(short *)0x0,
                                (short *)0x0);
            if (0 < dPlanRange) {
              if (vpctRadarView < 100) {
                dPlanRange = MulDiv(dPlanRange,vpctRadarView,100);
              }
              rc.left = PtToScan((xOff + (&((FLEET *)lpfl)->pt)->x) - dPlanRange);
              rc.top = PtToScan((yOff - (((FLEET *)lpfl)->pt).y) - dPlanRange);
              rc.right = PtToScan(xOff + (&((FLEET *)lpfl)->pt)->x + dPlanRange);
              rc.bottom = PtToScan((yOff - (((FLEET *)lpfl)->pt).y) + dPlanRange);
              DrawRadarCircle(&stack0xf58c,&rc);
            }
          }
        }
      }
      sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
      if (sVar3 == raMassAccel) {
        dPlanRange = lpThings._2_2_;
        lpthMac__1116 = (THING *)lpThings + cThing;
        local_45a = lpThings._2_2_;
        lpth__1064 = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
        while ((THING *)lpth__1064 < lpthMac__1116) {
          if (((lpth__1064->idFull >> 0xd == 1) &&
              ((lpth__1064->idFull >> 9 & 0xf) == idPlayer)) &&
             (uVar17 = (undefined2)((ulong)lpth__1064 >> 0x10),
             (((&((THING *)lpth__1064)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) != 0)) {
            iVar12 = (((&((THING *)lpth__1064)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) + 4;
            dPlanRange = iVar12 * iVar12;
            if (vpctRadarView < 100) {
              dPlanRange = MulDiv(dPlanRange,vpctRadarView,100);
            }
            rc.left = PtToScan((xOff + (&((THING *)lpth__1064)->pt)->x) - dPlanRange);
            rc.top = PtToScan((yOff - (((THING *)lpth__1064)->pt).y) - dPlanRange);
            rc.right = PtToScan(xOff + (&((THING *)lpth__1064)->pt)->x + dPlanRange);
            rc.bottom = PtToScan((yOff - (((THING *)lpth__1064)->pt).y) + dPlanRange);
            DrawRadarCircle(&stack0xf58c,&rc);
          }
          lpth__1064 = (THING *)lpth__1064 + 1;
        }
      }
      DrawRadarCircle(&stack0xf58c,(RECT *)0x0);
      SelectObject(hdc,hbrRadar);
      SelectObject(hdc,hpenRadar);
      if (mdScanBase != 5) {
        id = sel.fl.id;
        if (sel.grobj != grobjFleet) {
          id = -1;
        }
        if (sel.scan.grobj == grobjFleet) {
          id2 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
        }
        else {
          id2 = -1;
        }
        SelectObject(hdcMem,hbmpScanShip);
        SetTextColor(hdc,0);
        SetBkColor(hdc,0xffffff);
        for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar11 = ((FLEET **)rglpfl)[i];
          iVar12 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
          lpfl = (FLEET *)CONCAT22(iVar12,pFVar11);
          if ((pFVar11 == (FLEET *)0x0) && (iVar12 == 0)) break;
          if (pFVar11->idPlanet == -1) {
            lVar15 = CShipsScanVis((FLEET *)CONCAT22(iVar12,pFVar11));
            if (((0 < lVar15) || (lpfl->id == id)) || (lpfl->id == id2)) {
              uVar17 = (undefined2)((ulong)lpfl >> 0x10);
              pt.x = (&((FLEET *)lpfl)->pt)->x;
              pt.y = (((FLEET *)lpfl)->pt).y;
              if ((((xMin <= pt.x) && (pt.x < xMax)) && (yMin <= pt.y)) && (pt.y < yMax)) {
                pt.x = PtToScan((int)&((RECT *)pt.x)->left + xOff);
                pt.y = PtToScan(yOff - pt.y);
                uVar17 = (undefined2)((ulong)lpfl >> 0x10);
                if (((&((FLEET *)lpfl)->pt)->x == ptSelMain) &&
                   ((((FLEET *)lpfl)->pt).y == local_456)) {
                  fSelected = 1;
                }
                else {
                  fSelected = 0;
                }
                if (fSelected == 0) {
                  GetScanFleetOrientation(lpfl,&ptO,&ptD);
                  unaff_DI = (RECT *)(pt.x - ptD.x / 2);
                  unaff_SI = hdc;
                  BitBlt(hdc,(short)unaff_DI,pt.y - ptD.y / 2,ptD.x,ptD.y,hdcMem,ptO.x,ptO.y,
                         0x8800c6);
                }
                else {
                  SelectObject(hdcMem,hbmpScanner);
                  BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->top + 1),pt.y - 5,0xb,0xb,hdcMem,
                         0xb,0x50,0x8800c6);
                  unaff_DI = (RECT *)hbmpScanShip;
                  unaff_SI = hdcMem;
                  SelectObject(hdcMem,hbmpScanShip);
                }
              }
            }
          }
        }
        SelectObject(hdcMem,hbmpScanner);
      }
      SelectObject(hdc,hpenSav);
      SelectObject(hdc,hbrSav);
    }
    if ((grbitScan & 0x40) != 0) {
      psVar19 = rgy;
      psVar20 = rgrad;
      sVar3 = 0;
      sVar21 = 0xfa;
      for (i = 0; i < 3; i = i + 1) {
        UnrealizeObject(((ushort *)rghbrPat)[i]);
      }
      SetBrushOrg(hdc,ptOrigin,local_46c);
      IntersectClipRect(hdc,rcClip,local_43a,local_438,local_436);
      hbrSav = SelectObject(hdc,rghbrPat[0]);
      HVar18 = hdc;
      HVar2 = GetStockObject(8);
      hpenSav = SelectObject(HVar18,HVar2);
      fPlanetScanner = GetROP2(hdc);
      SetBkColor(hdc,0);
      for (j = 0; j < 3; j = j + 1) {
        if (((j != 0) || ((grbitScanMines & 1) != 0)) &&
           (((j != 1 || ((grbitScanMines & 2) != 0)) &&
            ((j != 2 || ((grbitScanMines & 0xc) != 0)))))) {
          for (i = 0; i < 3; i = i + 1) {
            for (dPlanRange = 0; dPlanRange <= (int)(uint)(i == 0); dPlanRange = dPlanRange + 1) {
              SetBrushOrg(hdc,ptOrigin,local_46c);
              SelectObject(hdc,((ushort *)rghbrPat)[i]);
              if (dPlanRange == 0) {
                uVar17 = *(undefined2 *)(j * 4 + rgcrScanMine);
                uVar7 = *(undefined2 *)(j * 4 + 0x28);
              }
              else {
                uVar17 = 0xff;
                uVar7 = 0xff;
              }
              SetTextColor(hdc,CONCAT22(uVar7,uVar17));
              lpthMac__1116 = (THING *)lpThings + cThing;
              local_45a = lpThings._2_2_;
              lpth__1064 = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
              in_stack_0000f586 = (THING *)lpThings;
              while ((THING *)lpth__1064 < lpthMac__1116) {
                if ((((lpth__1064->idFull >> 0xd == 0) &&
                     (uVar17 = (undefined2)((ulong)lpth__1064 >> 0x10),
                     (uint)*(byte *)((int)&((THING *)lpth__1064)->u_THING_0x0006 + 6) == i)) &&
                    ((j != 0 || ((lpth__1064->idFull >> 9 & 0xf) == idPlayer)))) &&
                   ((j < 1 || (((lpth__1064->idFull >> 9 & 0xf) != idPlayer &&
                               (in_stack_0000f586 =
                                     (THING *)(uint)(*(char *)(idPlayer * 0xc0 + 0x5a12 +
                                                              (lpth__1064->idFull >> 9 & 0xf)) ==
                                                    '\x01'),
                               in_stack_0000f586 != (THING *)(uint)(j == 2))))))) {
                  if ((j == 2) && ((grbitScanMines & 0xc) != 0xc)) {
                    if (*(char *)(idPlayer * 0xc0 + 0x5a12 + (lpth__1064->idFull >> 9 & 0xf))
                        == '\0') {
                      uVar4 = grbitScanMines & 4;
                    }
                    else {
                      uVar4 = grbitScanMines & 8;
                    }
                    if (uVar4 == 0) goto LAB_1058_243c;
                  }
                  if ((uint)*(byte *)((int)&((THING *)lpth__1064)->u_THING_0x0006 + 7) == dPlanRange
                     ) {
                    pt.x = (&((THING *)lpth__1064)->pt)->x;
                    pt.y = (((THING *)lpth__1064)->pt).y;
                    dVar1 = (double)((&((THING *)lpth__1064)->u_THING_0x0006)->thm).cMines;
                    _sqrt(SUB84(dVar1,0),
                                  (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >>
                                                                                    0x20))));
                    dPlanRange = 0x229d;
                    lVar15 = __ftol((double)CONCAT26(sVar21,CONCAT24(sVar3,(short *)CONCAT22
                                                  (psVar20,psVar19))));
                    dRange = (short)lVar15;
                    dPlanRange = 0x1118;
                    rc.left = PtToScan(pt.x + (xOff - dRange));
                    dPlanRange = 0x1058;
                    rc.top = PtToScan((yOff - pt.y) - dRange);
                    dPlanRange = 0x1058;
                    rc.right = PtToScan((int)(short *)pt.x + dRange + xOff);
                    dPlanRange = 0x1058;
                    rc.bottom = PtToScan((yOff - pt.y) + dRange);
                    dPlanRange = (short)&stack0xf58c;
                    in_stack_0000f586 =
                         ((ZIPPRODQ1 *)&vrgZipProd[0].u_ZIPPRODQ_0x000e.zpq1)->rgpq + 4;
                    DrawRadarCircle((DRAWCIR *)dPlanRange,&rc);
                    id = 0;
                    while ((id < game.cPlanMax &&
                           (((RECT *)((POINT *)rgptPlan + id)->x != (RECT *)pt.x ||
                            (*(uint *)((int)&rgptPlan[0].y + id * 4) != pt.y))))) {
                      id = id + 1;
                    }
                    if (id == game.cPlanMax) {
                      dPlanRange = 0x1058;
                      pt.x = PtToScan((int)(short *)pt.x + xOff);
                      dPlanRange = 0x1058;
                      pt.y = PtToScan(yOff - pt.y);
                      dPlanRange = 0x1058;
                      dRange = PtToScan(1);
                      if (dRange < 1) {
                        dRange = 1;
                      }
                      else if (3 < dRange) {
                        dRange = 3;
                      }
                      dPlanRange = (short)&rc;
                      SetRect((RECT *)dPlanRange,pt.x - dRange,pt.y - dRange,
                              (int)(short *)pt.x + dRange + 1,pt.y + dRange + 1);
                      dPlanRange = *(short *)(j * 4 + 0x28);
                      SetBkColor(hdc,CONCAT22(dPlanRange,*(undefined2 *)(j * 4 + rgcrScanMine)));
                      dPlanRange = rc.left;
                      unaff_DI = &rc;
                      ExtTextOut(hdc,rc.left,rc.top,2,unaff_DI,(LPCSTR)0x0,0,(short *)0x0);
                      dPlanRange = 0;
                      in_stack_0000f586 = (THING *)&vrptFleet.iSubsort;
                      unaff_SI = 0x243c;
                      SetBkColor(hdc,0);
                    }
                  }
                }
LAB_1058_243c:
                lpth__1064 = (THING *)lpth__1064 + 1;
              }
              DrawRadarCircle(&stack0xf58c,(RECT *)0x0);
            }
          }
        }
      }
      if ((sel.scan.grobj == grobjThing) &&
         (lpth__1064 = (THING *)CONCAT22(lpThings._2_2_,
                                         (THING *)lpThings + sel.scan.ith),
         lpth__1064->idFull >> 0xd == 0)) {
        SetBrushOrg(hdc,ptOrigin,local_46c);
        SelectObject(hdc,((ushort *)rghbrPat)
                         [*(byte *)((int)&((THING *)lpth__1064)->u_THING_0x0006 + 6)]);
        SetTextColor(hdc,0xffff00);
        uVar17 = (undefined2)((ulong)lpth__1064 >> 0x10);
        pTVar10 = (THING *)lpth__1064;
        pt.x = (&pTVar10->pt)->x;
        pt.y = (pTVar10->pt).y;
        dVar1 = (double)((&pTVar10->u_THING_0x0006)->thm).cMines;
        _sqrt(SUB84(dVar1,0),
                      (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20))));
        dPlanRange = 0x2532;
        lVar15 = __ftol((double)CONCAT26(sVar21,CONCAT24(sVar3,(short *)CONCAT22(psVar20,
                                                  psVar19))));
        dRange = (short)lVar15;
        dPlanRange = 0x1118;
        rc.left = PtToScan(pt.x + (xOff - dRange));
        dPlanRange = 0x1058;
        rc.top = PtToScan((yOff - pt.y) - dRange);
        dPlanRange = 0x1058;
        rc.right = PtToScan((int)(short *)pt.x + dRange + xOff);
        dPlanRange = 0x1058;
        rc.bottom = PtToScan((yOff - pt.y) + dRange);
        dPlanRange = (short)&stack0xf58c;
        DrawRadarCircle((DRAWCIR *)dPlanRange,&rc);
        dPlanRange = (short)&stack0xf58c;
        in_stack_0000f586 = (char *)szMineralTitle + 0x18;
        DrawRadarCircle((DRAWCIR *)dPlanRange,(RECT *)0x0);
      }
      SetROP2(hdc,fPlanetScanner);
      SelectObject(hdc,hpenSav);
      SelectObject(hdc,hbrSav);
    }
    if ((cThing != 0) &&
       (crBack = CONCAT22(crBack._2_2_,(undefined2)crBack),
       crFore = CONCAT22(crFore._2_2_,(undefined2)crFore), mdScanBase != 5)) {
      IntersectClipRect(hdc,rcClip,local_43a,local_438,local_436);
      hbrSav = SelectObject(hdc,hbrShip);
      hpenSav = SelectObject(hdc,hpenDkPurple);
      local_492 = (THING *)lpThings;
      hbmpTrSav = lpThings._2_2_;
      lpthMac = (THING *)lpThings + cThing;
      l = lpThings._2_2_;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      while ((THING *)lpth < lpthMac) {
        if (((lpth->idFull >> 0xd == 1) || (lpth->idFull >> 0xd == 2)) || (lpth->idFull >> 0xd == 3)
           ) {
          uVar17 = (undefined2)((ulong)lpth >> 0x10);
          pt.x = (&((THING *)lpth)->pt)->x;
          pt.y = (((THING *)lpth)->pt).y;
          LogicalToScan(&pt);
          if (lpth->idFull >> 0xd == 2) {
            uVar17 = (undefined2)((ulong)lpth >> 0x10);
            pTVar10 = (THING *)lpth;
            if ((lpth->idFull < *(uint *)((int)&pTVar10->u_THING_0x0006 + 6)) &&
               ((1 << ((byte)idPlayer & 0x1f) & *(uint *)((int)&pTVar10->u_THING_0x0006 + 4))
                != 0)) {
              hbr = LpthFromId(*(short *)((int)&pTVar10->u_THING_0x0006 + 6));
              if (hbr != (THING *)0x0) {
                MoveTo(hdc,pt.x,pt.y);
                uVar17 = (undefined2)((ulong)hbr >> 0x10);
                pt2 = (&((THING *)hbr)->pt)->x;
                fTerra = (((THING *)hbr)->pt).y;
                LogicalToScan(&stack0xfb7e);
                LineTo(hdc,pt2,fTerra);
                unaff_DI = (RECT *)hdc;
                LineTo(hdc,pt2,fTerra + 1);
              }
            }
          }
          if (lpth->idFull >> 0xd == 2) {
            BitBlt(hdc,(short)&((RECT *)(pt.x + -8))->right,pt.y - 4,9,9,hdcMem,9,0x5c,0x8800c6);
            BitBlt(hdc,(short)&((RECT *)(pt.x + -8))->right,pt.y - 4,9,9,hdcMem,0,0x5c,0xee0086);
          }
          else if (lpth->idFull >> 0xd == 3) {
            hbmpTrSav = SelectObject(hdcMem,hbmpScanShip);
            CVar14 = SetTextColor(hdc,0xffff00);
            crFore = CVar14;
            CVar14 = SetBkColor(hdc,0);
            uVar17 = (undefined2)((ulong)lpth >> 0x10);
            pTVar10 = (THING *)lpth;
            crBack = CVar14;
            GetDxDyOrientation(((&pTVar10->u_THING_0x0006)->thp).wFlags - (&pTVar10->pt)->x,
                               *(int *)((int)&pTVar10->u_THING_0x0006 + 2) - (pTVar10->pt).y,&ptO,
                               &ptD);
            BitBlt(hdc,pt.x - ptD.x / 2,pt.y - ptD.y / 2,ptD.x,ptD.y,hdcMem,ptO.x,ptO.y,0xee0086);
            SetTextColor(hdc,crFore);
            SetBkColor(hdc,crBack);
            SelectObject(hdcMem,hbmpTrSav);
          }
          else {
            if (iScanZoom < 1) {
              dRange = 2;
            }
            else if (iScanZoom < 3) {
              dRange = 3;
            }
            else {
              dRange = 5;
            }
            dx = dRange * 2 + 1;
            if ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) == 0) {
              SelectObject(hdc,hpenYellow);
              MoveTo(hdc,pt.x,(pt.y - dRange) + -1);
              LineTo(hdc,pt.x + (-1 - dRange),pt.y);
              LineTo(hdc,pt.x,pt.y + dRange + 1);
              LineTo(hdc,(int)(short *)pt.x + dRange + 1,pt.y);
              LineTo(hdc,pt.x,(pt.y - dRange) + -1);
              SelectObject(hdc,hpenDkPurple);
            }
            else {
              if ((lpth->idFull >> 9 & 0xf) != idPlayer) {
                SelectObject(hdc,hbrRed);
              }
              PatBlt(hdc,pt.x - dRange,pt.y - dRange,dx,1,0xf00021);
              PatBlt(hdc,pt.x - dRange,pt.y - dRange,1,dx,0xf00021);
              PatBlt(hdc,pt.x - dRange,pt.y + dRange,dx,1,0xf00021);
              PatBlt(hdc,(int)(short *)pt.x + dRange,pt.y - dRange,1,dx,0xf00021);
              if ((lpth->idFull >> 9 & 0xf) != idPlayer) {
                SelectObject(hdc,hbrShip);
              }
            }
          }
        }
        lpth = (THING *)lpth + 1;
      }
      SelectObject(hdc,hbrSav);
      SelectObject(hdc,hpenSav);
    }
    if (((grbitScan & 0x80) != 0) && (mdScanBase != 5)) {
      id = sel.fl.id;
      if (sel.grobj != grobjFleet) {
        id = -1;
      }
      if (sel.scan.grobj == grobjFleet) {
        id2 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
      }
      else {
        id2 = -1;
      }
      hpenSav = SelectObject(hdc,hpenStarbase);
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar11 = ((FLEET **)rglpfl)[i];
        iVar12 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar12,pFVar11);
        if ((pFVar11 == (FLEET *)0x0) && (iVar12 == 0)) break;
        if (((pFVar11->wFlags_0x4 >> 10 & 1) == 0) &&
           ((6 < (pFVar11->wFlags_0x4 & 0xff) && (1 < pFVar11->cord)))) {
          lVar15 = CShipsScanVis((FLEET *)CONCAT22(iVar12,pFVar11));
          if ((0 < lVar15) || ((lpfl->id == id || (lpfl->id == id2)))) {
            iord = 0;
            while( true ) {
              uVar17 = (undefined2)((ulong)lpfl >> 0x10);
              pFVar11 = (FLEET *)lpfl;
              if (pFVar11->cord <= iord) break;
              uVar7 = *(undefined2 *)((int)&pFVar11->lpplord + 2);
              piVar8 = (int *)(*(int *)&pFVar11->lpplord + 4 + iord * 0x12);
              pt.x = *piVar8;
              pt.y = piVar8[1];
              pt.x = PtToScan(xOff + pt.x);
              pt.y = PtToScan(yOff - pt.y);
              unaff_DI = (RECT *)pt.x;
              if (iord == 0) {
                unaff_SI = hdc;
                MoveTo(hdc,pt.x,pt.y);
              }
              else {
                unaff_SI = hdc;
                LineTo(hdc,pt.x,pt.y);
              }
              iord = iord + 1;
            }
          }
        }
      }
      SelectObject(hdc,hpenSav);
    }
    SelectClipRgn(hdc,hrgnHuge);
    GetClientRect(hwndScanner,&rc);
    ExcludeClipRect(hdc,0,rc.bottom - dySBar,rc.right,rc.bottom);
    _memset(rgWhatsHere,0,999);
    switch(iScanZoom) {
    case 0:
    case 1:
    case 2:
      SelectObject(hdc,rghfontArial8[0]);
      break;
    case 3:
      SelectObject(hdc,rghfontArial8[1]);
      break;
    case 4:
      SelectObject(hdc,rghfontArial10[1]);
      break;
    case -1:
      SelectObject(hdc,rghfontArial6[0]);
    }
    CVar14 = SetTextColor(hdc,0xffffff);
    crFore = CVar14;
    CVar14 = SetBkColor(hdc,0);
    crBack = CVar14;
    iBkPrev = SetBkMode(hdc,1);
    if ((iScanZoom < 3) || (mdScanBase != 4)) {
      j = 0;
    }
    else {
      j = 0xb;
    }
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      if ((((((POINT *)rgptPlan + i)->x < xMin) ||
           (xMax <= ((POINT *)rgptPlan + i)->x)) ||
          (*(int *)((int)&rgptPlan[0].y + i * 4) < yMin)) ||
         (yMax <= *(int *)((int)&rgptPlan[0].y + i * 4))) {
        if ((grbitScan & 0x400) != 0) {
          fDoDraw = 0;
          goto SCAN_LBailIn;
        }
      }
      else {
        fDoDraw = 1;
SCAN_LBailIn:
        pt.x = PtToScan(xOff + ((POINT *)rgptPlan + i)->x);
        pt.y = PtToScan(yOff - *(int *)((int)&rgptPlan[0].y + i * 4));
        if (fDoDraw != 0) {
          if (((ptSelMain == ((POINT *)rgptPlan + i)->x) &&
              (local_456 == *(int *)((int)&rgptPlan[0].y + i * 4))) && (mdScanBase < 3)) {
            BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->top + 1),pt.y - 5,0xb,0xb,hdcMem,0,0x45,
                   0x8800c6);
            BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->top + 1),pt.y - 5,0xb,0xb,hdcMem,0,0x21,
                   0xee0086);
          }
          else {
            BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->bottom + 1),pt.y - 1,3,3,hdcMem,0xb,0xf,
                   0xcc0020);
          }
        }
        if ((((grbitScan & 0x400) != 0) && (-2 < iScanZoom)) &&
           ((xMin + -0x32 <= ((POINT *)rgptPlan + i)->x &&
            (((((POINT *)rgptPlan + i)->x < xMax + 0x32 &&
              (yMin + -0x14 <= *(int *)((int)&rgptPlan[0].y + i * 4))) &&
             (*(int *)((int)&rgptPlan[0].y + i * 4) < yMax + 0x14)))))) {
          PszGetPlanetName(i);
          if ((grbitScan & 0x2000) != 0) {
            lppl = LpplFromId(i);
            iVar12 = (int)((ulong)lppl >> 0x10);
            pPVar9 = (PLANET *)lppl;
            if (((pPVar9 != (PLANET *)0x0) || (iVar12 != 0)) && (pPVar9->iPlayer != -1)) {
              if (pPVar9->iPlayer == idPlayer) {
                uVar17 = 0xffff;
                uVar7 = 0xff;
              }
              else {
                iVar12 = pPVar9->iPlayer * 4;
                uVar17 = *(undefined2 *)(iVar12 + 0x2e);
                uVar7 = *(undefined2 *)(iVar12 + 0x30);
              }
              unaff_DI = (RECT *)hdc;
              SetTextColor(hdc,CONCAT22(uVar7,uVar17));
            }
          }
          CtrTextOut(hdc,pt.x,pt.y + 5U + j,(char *)szWork,0);
          if ((grbitScan & 0x2000) != 0) {
            SetTextColor(hdc,0xffffff);
          }
        }
      }
    }
    SetBkMode(hdc,iBkPrev);
    SetBkColor(hdc,crBack);
    SetTextColor(hdc,crFore);
    if ((iScanZoom < 3) || (mdScanBase != 4)) {
      j = 0;
    }
    else {
      j = 0xb;
    }
    if (((sel.grobj == grobjNone) || (sel.pt.x != sel.scan.pt.x)) ||
       (sel.pt.y != sel.scan.pt.y)) {
      if (sel.scan.grobj != grobjNone) {
        pt.x = sel.scan.pt.x;
        pt.y = sel.scan.pt.y;
        LogicalToScan(&pt);
        BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->right + 1),pt.y + 7U + j,7,8,hdcMem,0x16,
               0x50,0x8800c6);
        BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->right + 1),pt.y + 7U + j,7,8,hdcMem,0x16,
               0x31,0xee0086);
      }
    }
    else {
      pt.x = sel.pt.x;
      pt.y = sel.pt.y;
      LogicalToScan(&pt);
      BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->top + 1),pt.y + 0xbU + j,0xb,0xc,hdcMem,0,0x50
             ,0x8800c6);
      BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->top + 1),pt.y + 0xbU + j,0xb,0xc,hdcMem,0,0x39
             ,0xee0086);
    }
    if ((cPlanet != 0) && (mdScanBase != 5)) {
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      for (i = 0; i < cPlanet; i = i + 1) {
        id = lppl->id;
        uVar17 = (undefined2)((ulong)lppl >> 0x10);
        pPVar9 = (PLANET *)lppl;
        if (((pPVar9->wFlags_0x4 >> 9 & 1) == 0) || (pPVar9->iPlayer == -1)) {
          fStarbase = 0;
        }
        else {
          fStarbase = 1;
        }
        if (fStarbase == 0) {
          fMA = 0;
          fStargate = 0;
        }
        else {
          iVar12 = pPVar9->iPlayer * 4;
          if (*(int *)(*(int *)(iVar12 + 0x14c) + (*(uint *)&pPVar9->lStarbase & 0xf) * 0x93) ==
              0x20) {
            fStarbase = 2;
          }
          sVar3 = IWarpMAFromLppl(lppl,(short *)0x0);
          fMA = (short)(0 < sVar3);
          sVar3 = IStargateFromLppl(lppl);
          fStargate = (short)(sVar3 != -1);
        }
        if ((((xMin <= ((POINT *)rgptPlan + id)->x) &&
             (((POINT *)rgptPlan + id)->x < xMax)) &&
            (yMin <= *(int *)((int)&rgptPlan[0].y + id * 4))) &&
           (*(int *)((int)&rgptPlan[0].y + id * 4) < yMax)) {
          pt.x = PtToScan(xOff + ((POINT *)rgptPlan + id)->x);
          pt.y = PtToScan(yOff - *(int *)((int)&rgptPlan[0].y + id * 4));
          pPVar9 = (PLANET *)lppl;
          uVar17 = (undefined2)((ulong)lppl >> 0x10);
          if (mdScanBase == 3) {
            fTerra = 0;
            if (2 < (pPVar9->wFlags_0x4 & 0xff)) {
              sVar3 = PctPlanetDesirability(lppl,idPlayer);
              hbr = (THING *)CONCAT22(sVar3,(THING *)hbr);
              if (sVar3 < 0) {
LAB_1058_343d:
                sVar3 = PctPlanetOptValue(lppl,idPlayer);
                hbr = (THING *)CONCAT22(sVar3,(THING *)hbr);
                if (-1 < sVar3) {
                  sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
                  if (sVar3 != raTerra) {
                    fTerra = 1;
                  }
                }
              }
              else {
                sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
                if (sVar3 == raTerra) goto LAB_1058_343d;
              }
              HVar5 = hbrRadar;
              if ((-1 < (long)hbr) && (HVar5 = hbrDkYellow, fTerra == 0)) {
                HVar5 = hbrGreen;
              }
              hbrSav = SelectObject(hdc,HVar5);
              HVar6 = hpenRadar;
              if ((-1 < (long)hbr) && (HVar6 = hpenDkYellow, fTerra == 0)) {
                HVar6 = hpenDkGreen;
              }
              hpenSav = SelectObject(hdc,HVar6);
              if ((long)hbr < 0) {
                pt2 = -hbr._2_2_ / 5;
              }
              else {
                pt2 = hbr._2_2_ / 0xb;
              }
              pt2 = pt2 + 2;
              if (10 < pt2) {
                pt2 = 10;
              }
              Ellipse(hdc,pt.x - pt2,pt.y - pt2,(int)(short *)pt.x + pt2 + 1,pt.y + pt2 + 1);
              iVar12 = pt2 + -2;
              if (pt2 + -2 < 3) {
                iVar12 = pt2 + -1;
              }
              pt2 = iVar12;
              if (pt2 < 1) {
                pt2 = 1;
              }
              HVar5 = hbrEnemy;
              if ((-1 < (long)hbr) && (HVar5 = hbrYellow, fTerra == 0)) {
                HVar5 = hbrShip;
              }
              SelectObject(hdc,HVar5);
              HVar6 = hpenEnemy;
              if ((-1 < (long)hbr) && (HVar6 = hpenYellow, fTerra == 0)) {
                HVar6 = hpenShip;
              }
              SelectObject(hdc,HVar6);
              Ellipse(hdc,pt.x - pt2,pt.y - pt2,(int)(short *)pt.x + pt2 + 1,pt.y + pt2 + 1);
              if (((PLANET *)lppl)->iPlayer != -1) {
                rc.left = (int)&((RECT *)(pt.x + -8))->bottom + 1;
                rc.right = pt.x + 8;
                rc.top = pt.y - 0x14;
                rc.bottom = pt.y - 0xc;
                pRVar16 = &rc;
                uVar17 = unaff_SS;
                HVar18 = hdc;
                HVar2 = GetStockObject(4);
                FillRect(HVar18,(RECT *)CONCAT22(uVar17,pRVar16),HVar2);
                uVar17 = (undefined2)((ulong)lppl >> 0x10);
                pPVar9 = (PLANET *)lppl;
                if (pPVar9->iPlayer == idPlayer) {
                  hbr = (THING *)CONCAT22(hbr._2_2_,hbrBBlue);
                }
                else {
                  iVar12 = idPlayer * 0xc0 + 0x5a12;
                  lpth = (THING *)CONCAT22(iVar12,(THING *)lpth);
                  if (*(char *)(iVar12 + pPVar9->iPlayer) == '\x01') {
                    hbr = (THING *)CONCAT22(hbr._2_2_,hbrStarbase);
                  }
                  else {
                    iVar12 = idPlayer * 0xc0 + 0x5a12;
                    lpth = (THING *)CONCAT22(iVar12,(THING *)lpth);
                    if (*(char *)(iVar12 + pPVar9->iPlayer) == '\0') {
                      hbr = (THING *)CONCAT22(hbr._2_2_,hbrRadar);
                    }
                    else {
                      hbr = (THING *)CONCAT22(hbr._2_2_,hbrEnemy);
                    }
                  }
                }
                SelectObject(hdc,(HGDIOBJ)(THING *)hbr);
                PatBlt(hdc,pt.x,pt.y - 0x13,1,0x15,0xf00021);
                PatBlt(hdc,pt.x,pt.y - 0x13,7,6,0xf00021);
              }
              SelectObject(hdc,hpenSav);
              SelectObject(hdc,hbrSav);
            }
          }
          else {
            if ((mdScanBase == 1) || (mdScanBase == 2)) {
              pTVar10 = (THING *)(uint)(mdScanBase == 2);
              hbr = (THING *)CONCAT22(hbr._2_2_,pTVar10);
              fTerra = (short)(iScanZoom < 0);
              if ((3 < (pPVar9->wFlags_0x4 & 0xff)) ||
                 ((pTVar10 != (THING *)0x0 && (2 < (pPVar9->wFlags_0x4 & 0xff))))) {
                hbr = (THING *)CONCAT22(pt.x - *(int *)(fTerra * 10 + 0x58c),pTVar10);
                lpth = (THING *)CONCAT22(pt.y - *(int *)(fTerra * 10 + 0x58e),(THING *)lpth);
                hbrSav = SelectObject(hdc,hbrButtonFace);
                PatBlt(hdc,hbr._2_2_ + -2,lpth._2_2_,*(short *)(fTerra * 10 + 0x590),1,0xf00021);
                PatBlt(hdc,hbr._2_2_ + -2,(lpth._2_2_ - *(int *)(fTerra * 10 + 0x590)) + 1,1,
                       *(short *)(fTerra * 10 + 0x590),0xf00021);
                for (pt2 = 0; pt2 < 3; pt2 = pt2 + 1) {
                  if ((THING *)hbr == (THING *)0x0) {
                    l = *(uint *)(((PLANET *)lppl)->rgwtMin + pt2);
                    pTVar10 = (THING *)*(uint *)((int)(((PLANET *)lppl)->rgwtMin + pt2) + 2);
                    lpth = (THING *)CONCAT22(lpth._2_2_,pTVar10);
                    uVar4 = cMinGrafMax / 0x28;
                    lVar15 = __aFldiv(CONCAT22((int)&pTVar10->idFull +
                                                       (uint)CARRY2(uVar4,l) + ((int)uVar4 >> 0xf),
                                                       uVar4 + l),(long)(cMinGrafMax / 0x14))
                    ;
                    l = (uint)lVar15;
                    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)((ulong)lVar15 >> 0x10));
                    if (0x14 < lVar15) {
                      l = 0x14;
                      lpth = (THING *)((ulong)lpth._2_2_ << 0x10);
                    }
                  }
                  else {
                    l = ((PLANET *)lppl)->rgMinConc[pt2] / 5;
                    if (0x14 < l) {
                      l = 0x14;
                    }
                    lpth = (THING *)((ulong)lpth._2_2_ << 0x10);
                  }
                  if (fTerra != 0) {
                    lVar15 = __aFldiv(CONCAT22((THING *)lpth,l),2);
                    l = (uint)lVar15;
                    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)((ulong)lVar15 >> 0x10));
                  }
                  if ((-1 < (int)(THING *)lpth) && ((0 < (int)(THING *)lpth || (l != 0)))) {
                    SelectObject(hdc,((ushort *)rghbrMineral)[pt2]);
                    PatBlt(hdc,hbr._2_2_,lpth._2_2_ - l,*(short *)(fTerra * 10 + 0x592),l,0xf00021);
                  }
                  hbr = (THING *)CONCAT22(hbr._2_2_ + *(int *)(fTerra * 10 + 0x594),(THING *)hbr);
                }
                SelectObject(hdc,hbrSav);
              }
            }
            else if (mdScanBase == 4) {
              pt2 = 0;
              if (((pPVar9->wFlags_0x4 & 0xff) < 3) || (pPVar9->iPlayer == -1)) {
                if (pPVar9->iPlayer == -1) goto SCAN_LNormalScannerMode;
              }
              else {
                if (pPVar9->iPlayer == idPlayer) {
                  pTVar10 = (THING *)*(int *)((int)pPVar9->rgwtMin + 0xe);
                  lpth = (THING *)CONCAT22((int)pPVar9->rgwtMin[3],(THING *)lpth);
                }
                else {
                  lVar15 = __aFlshl((long)CONCAT22(unaff_SI,unaff_DI),
                                            (ushort)in_stack_0000f586);
                  pTVar10 = (THING *)((ulong)lVar15 >> 0x10);
                  lpth = (THING *)CONCAT22((int)lVar15,(THING *)lpth);
                }
                for (hbr._2_2_ = 0; hbr._2_2_ < 0x13; hbr._2_2_ = hbr._2_2_ + 1) {
                  iVar12 = (int)*(uint *)(hbr._2_2_ * 2) >> 0xf;
                  if (((int)pTVar10 <= iVar12) &&
                     (((int)pTVar10 < iVar12 || (lpth._2_2_ < *(uint *)(hbr._2_2_ * 2))))) break;
                }
                hbr = (THING *)CONCAT22(hbr._2_2_ + 2,pTVar10);
                uVar17 = (undefined2)((ulong)lppl >> 0x10);
                if (((PLANET *)lppl)->iPlayer == idPlayer) {
                  fTerra = 0;
                }
                else {
                  pTVar10 = (THING *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0)
                  ;
                  lpth = (THING *)CONCAT22(lpth._2_2_,pTVar10);
                  if (*(char *)((int)&pTVar10->idFull + ((PLANET *)lppl)->iPlayer) == '\x01') {
                    fTerra = 1;
                  }
                  else {
                    fTerra = 3;
                  }
                }
                HVar5 = hbrShip;
                if ((fTerra != 0) && (HVar5 = hbrEnemy, fTerra != 3)) {
                  HVar5 = hbrYellow;
                }
                hbrSav = SelectObject(hdc,HVar5);
                HVar6 = hpenDkGreen;
                if ((fTerra != 0) && (HVar6 = hpenEnemy, fTerra != 3)) {
                  HVar6 = hpenDkYellow;
                }
                hpenSav = SelectObject(hdc,HVar6);
                if (iScanZoom < 3) {
                  hbr = (THING *)CONCAT22(hbr._2_2_ + 1 >> 1,(THING *)hbr);
                }
                Ellipse(hdc,pt.x - hbr._2_2_,pt.y - hbr._2_2_,(int)(short *)pt.x + hbr._2_2_ + 1,
                        pt.y + hbr._2_2_ + 1);
                SelectObject(hdc,hpenSav);
                SelectObject(hdc,hbrSav);
              }
              goto LAB_1058_3257;
            }
SCAN_LNormalScannerMode:
            uVar17 = (undefined2)((ulong)lppl >> 0x10);
            pPVar9 = (PLANET *)lppl;
            if (pPVar9->iPlayer == -1) {
              if ((((POINT *)rgptPlan + id)->x != ptSelMain) ||
                 (*(int *)((int)&rgptPlan[0].y + id * 4) != local_456)) {
                BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->bottom + 1),pt.y - 1,3,3,hdcMem,0xb,
                       0x12,0xcc0020);
              }
            }
            else if ((((POINT *)rgptPlan + id)->x == ptSelMain) &&
                    (*(int *)((int)&rgptPlan[0].y + id * 4) == local_456)) {
              if (pPVar9->iPlayer == idPlayer) {
                yBmp = 0;
              }
              else {
                fTerra = idPlayer * 0xc0 + 0x5a12;
                if (*(char *)(fTerra + pPVar9->iPlayer) == '\x01') {
                  yBmp = 0x16;
                }
                else {
                  yBmp = 0xb;
                }
              }
              BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->top + 1),pt.y - 5,0xb,0xb,hdcMem,0,
                     0x45,0x8800c6);
              BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->top + 1),pt.y - 5,0xb,0xb,hdcMem,0,
                     yBmp,0xee0086);
              if (fStarbase != 0) {
                HVar5 = hbrBlue;
                if (fStarbase != 2) {
                  HVar5 = hbrYellow;
                }
                hbrSav = SelectObject(hdc,HVar5);
                PatBlt(hdc,pt.x + 4,pt.y - 6,5,5,0x42);
                PatBlt(hdc,(short)((int)(pt.x + 4) + 1),pt.y - 6,3,5,0xf00021);
                PatBlt(hdc,pt.x + 4,pt.y - 5,5,3,0xf00021);
                SelectObject(hdc,hbrSav);
              }
              if (fStargate != 0) {
                hbrSav = SelectObject(hdc,hbrGreen);
                PatBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->left + 1),pt.y - 6,5,5,0x42);
                PatBlt(hdc,(short)&((RECT *)(pt.x + -8))->top,pt.y - 6,3,5,0xf00021);
                PatBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->left + 1),pt.y - 5,5,3,0xf00021);
                SelectObject(hdc,hbrSav);
              }
              if (fMA != 0) {
                hbrSav = SelectObject(hdc,hbrPurple);
                PatBlt(hdc,(short)&((RECT *)(pt.x + -8))->bottom,pt.y - 9,5,5,0x42);
                PatBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->bottom + 1),pt.y - 9,3,5,0xf00021);
                PatBlt(hdc,(short)&((RECT *)(pt.x + -8))->bottom,pt.y - 8,5,3,0xf00021);
                SelectObject(hdc,hbrSav);
              }
            }
            else {
              if (pPVar9->iPlayer == idPlayer) {
                yBmp = 0;
              }
              else {
                fTerra = idPlayer * 0xc0 + 0x5a12;
                if (*(char *)(fTerra + pPVar9->iPlayer) == '\x01') {
                  yBmp = 10;
                }
                else {
                  yBmp = 5;
                }
              }
              BitBlt(hdc,(short)&((RECT *)(pt.x + -8))->bottom,pt.y - 2,5,5,hdcMem,0xb,yBmp,0xcc0020
                    );
              if (fStarbase != 0) {
                HVar5 = hbrBlue;
                if (fStarbase != 2) {
                  HVar5 = hbrYellow;
                }
                hbrSav = SelectObject(hdc,HVar5);
                PatBlt(hdc,(short)((int)(pt.x + 2) + 1),pt.y - 4,3,3,0xf00021);
                SelectObject(hdc,hbrSav);
              }
              if (fStargate != 0) {
                hbrSav = SelectObject(hdc,hbrGreen);
                PatBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->top + 1),pt.y - 4,3,3,0x42);
                PatBlt(hdc,(short)&((RECT *)(pt.x + -8))->right,pt.y - 4,1,3,0xf00021);
                PatBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->top + 1),pt.y - 3,3,1,0xf00021);
                SelectObject(hdc,hbrSav);
              }
              if (fMA != 0) {
                hbrSav = SelectObject(hdc,hbrPurple);
                PatBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->bottom + 1),pt.y - 6,3,3,0x42);
                PatBlt(hdc,pt.x,pt.y - 6,1,3,0xf00021);
                PatBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->bottom + 1),pt.y - 5,3,1,0xf00021);
                SelectObject(hdc,hbrSav);
              }
            }
          }
        }
LAB_1058_3257:
        lppl = (PLANET *)lppl + 1;
      }
    }
    if ((cFleet != 0) && (mdScanBase != 5)) {
                    /* WARNING: Load size is inaccurate */
      lpflT = (FLEET *)CONCAT22(*(undefined2 *)((int)(FLEET **)rglpfl + 2),*rglpfl);
      hbrSav = SelectObject(hdc,hbrShip);
      id = sel.fl.id;
      if (sel.grobj != grobjFleet) {
        id = -1;
      }
      if (sel.scan.grobj == grobjFleet) {
        id2 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
      }
      else {
        id2 = -1;
      }
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar11 = ((FLEET **)rglpfl)[i];
        iVar12 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpflT = (FLEET *)CONCAT22(iVar12,pFVar11);
        if ((pFVar11 == (FLEET *)0x0) && (iVar12 == 0)) break;
        lVar15 = CShipsScanVis((FLEET *)CONCAT22(iVar12,pFVar11));
        if ((0 < lVar15) || ((lpflT->id == id || (lpflT->id == id2)))) {
          uVar17 = (undefined2)((ulong)lpflT >> 0x10);
          pFVar11 = (FLEET *)lpflT;
          idP = pFVar11->idPlanet;
          if (idP == -1) {
            pt.x = (&pFVar11->pt)->x;
            pt.y = (pFVar11->pt).y;
          }
          else {
            pt.x = ((POINT *)rgptPlan + idP)->x;
            pt.y = *(uint *)((int)&rgptPlan[0].y + idP * 4);
          }
          if ((((xMin <= pt.x) && (pt.x < xMax)) && (yMin <= pt.y)) && (pt.y < yMax)) {
            pt.x = PtToScan((int)(short *)pt.x + xOff);
            pt.y = PtToScan(yOff - pt.y);
            uVar17 = (undefined2)((ulong)lpflT >> 0x10);
            pFVar11 = (FLEET *)lpflT;
            bVar13 = pFVar11->iPlayer != idPlayer;
            yBmp = (short)bVar13;
            if (((&pFVar11->pt)->x == ptSelMain) && ((pFVar11->pt).y == local_456)) {
              fSelected = 1;
            }
            else {
              fSelected = 0;
            }
            if (idP == -1) {
              if (fSelected == 0) {
                SelectObject(hdcMem,hbmpScanShip);
                if (yBmp == 0) {
                  pt2 = 0;
                  fTerra = 0xff;
                }
                else {
                  iVar12 = idPlayer * 0xc0 + 0x5a12;
                  hbr = (THING *)CONCAT22(iVar12,(THING *)hbr);
                  if (*(char *)(iVar12 + ((FLEET *)lpflT)->iPlayer) == '\x01') {
                    pt2 = -1;
                    fTerra = 0;
                  }
                  else {
                    pt2 = 0xff;
                    fTerra = 0;
                  }
                }
                SetTextColor(hdc,CONCAT22(fTerra,pt2));
                SetBkColor(hdc,0);
                GetScanFleetOrientation(lpflT,&ptO,&ptD);
                BitBlt(hdc,pt.x - ptD.x / 2,pt.y - ptD.y / 2,ptD.x,ptD.y,hdcMem,ptO.x,ptO.y,0xee0086
                      );
                if (((grbitScan & 0x1000) != 0) &&
                   ((((FLEET *)lpflT)->wFlags_0x4 >> 0xb & 1) == 0)) {
                  DrawScanFleetCount(lpflT,pt.x,(pt.y - ptD.y / 2) + -2,hdc,hdcMem);
                }
                SelectObject(hdcMem,hbmpScanner);
              }
              else {
                BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->top + 1),pt.y - 5,0xb,0xb,hdcMem,0xb
                       ,yBmp * 0xb + 0x24,0xee0086);
                if (((grbitScan & 0x1000) != 0) &&
                   ((((FLEET *)lpflT)->wFlags_0x4 >> 0xb & 1) == 0)) {
                  DrawScanFleetCount(lpflT,pt.x,pt.y - 7,hdc,hdcMem);
                }
              }
            }
            else if (((rgWhatsHere[idP] != '\x03') && ((int)rgWhatsHere[idP] != yBmp + 1U)) &&
                    (mdScanBase < 3)) {
              rgWhatsHere[idP] = rgWhatsHere[idP] + bVar13 + '\x01';
              yBmp = rgWhatsHere[idP] + -1;
              if (fSelected == 0) {
                BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->top + 1),pt.y - 5,0xb,0xb,hdcMem,
                       0x10,0x45,0x8800c6);
                BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -8))->top + 1),pt.y - 5,0xb,0xb,hdcMem,
                       0x10,yBmp * 0xb,0xee0086);
              }
              else {
                BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -0x10))->bottom + 1),pt.y - 9,0x13,0x13,
                       hdcMem,0x1d,0x45,0x8800c6);
                BitBlt(hdc,(short)((int)&((RECT *)(pt.x + -0x10))->bottom + 1),pt.y - 9,0x13,0x13,
                       hdcMem,0x1d,yBmp * 0x13,0xee0086);
              }
              if (((grbitScan & 0x1000) != 0) &&
                 ((((FLEET *)lpflT)->wFlags_0x4 >> 0xb & 1) == 0)) {
                if (fSelected == 0) {
                  iVar12 = 5;
                }
                else {
                  iVar12 = 9;
                }
                DrawScanFleetCount(lpflT,pt.x,(pt.y - iVar12) + -2,hdc,hdcMem);
              }
            }
          }
        }
      }
      SelectObject(hdc,hbrSav);
    }
    ExpandRc(prc,-dExpand,-dExpand);
    prc->bottom = prc->bottom + -0xe;
    CVar14 = SetTextColor(hdc,0);
    crFore = CVar14;
    CVar14 = GetBkColor(hdc);
    if ((((sel.grobj == grobjFleet) || (sel.scan.grobj == grobjFleet)) ||
        (sel.scan.grobj == grobjThing)) ||
       ((sel.grobj == grobjPlanet && ((sel.pl.wFlags_0x4 >> 9 & 1) != 0)))) {
      crBack = CVar14;
      IntersectClipRect(hdc,prc->left,prc->top,prc->right,prc->bottom);
      fOrdersVis = 0;
      DrawShipScanPath(hdc,1);
      SelectClipRgn(hdc,hrgnHuge);
      CVar14 = crBack;
    }
    crBack = CVar14;
    SetBkColor(hdc,CVar14);
    SetTextColor(hdc,crFore);
    SelectObject(hdcMem,hbmpSav);
    DeleteDC(hdcMem);
    if (hdcScreen != 0) {
      SetWindowOrg(hdc,0,0);
      BitBlt(hdcScreen,prc->left,prc->top,prc->right - prc->left,prc->bottom - prc->top,hdc,
             prc->left & 7,prc->top & 7,0xcc0020);
      SelectObject(hdc,hbmpXSav);
      DeleteObject(hbmpScreen);
      DeleteDC(hdc);
    }
  }
  return 0;
}



// ======================================================================
// Function: DrawScanFleetCount
// Address: 1058:47d2
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1058496f) */
/* WARNING: Removing unreachable block (ram,0x105848c3) */
/* WARNING: Removing unreachable block (ram,0x10584832) */
/* WARNING: Removing unreachable block (ram,0x105848e8) */
/* WARNING: Removing unreachable block (ram,0x10584a5c) */

void DrawScanFleetCount(FLEET *lpfl,short x,short y,HDC hdc,HDC hdcMem)

{
  int iVar1;
  bool bVar2;
  int iVar3;
  HGDIOBJ HVar4;
  long lVar5;
  long lVar6;
  int l;
  HBITMAP hbmpSav;
  short iPlr;
  FLEET *lpflWalk;
  int cr;
  int local_c;
  short f999;
  
  lpflWalk = lpfl;
  if ((grbitScan & 0x2000) == 0) {
    iPlr = -2;
  }
  else {
    iPlr = -1;
  }
  lVar6 = 0;
  bVar2 = false;
  do {
    lVar5 = CShipsScanVis(lpflWalk);
    if (((0 < lVar5) && (lVar6 = lVar5 + lVar6, ((FLEET *)lpflWalk)->iPlayer != iPlr)) &&
       (iPlr != -2)) {
      if (iPlr == -1) {
        iPlr = ((FLEET *)lpflWalk)->iPlayer;
      }
      else {
        iPlr = -2;
      }
    }
    ((FLEET *)lpflWalk)->wFlags_0x4 = ((FLEET *)lpflWalk)->wFlags_0x4 & 0xf7ff | 0x800;
                    /* WARNING: Load size is inaccurate */
    lpflWalk = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflWalk)->lpflNext + 2),
                                 ((FLEET *)lpflWalk)->lpflNext);
  } while (lpfl != lpflWalk);
  if (lVar6 < 1000) {
    if (lVar6 < 1) {
      return;
    }
  }
  else {
    lVar6 = 999;
  }
  l = (int)lVar6;
  HVar4 = SelectObject(hdcMem,hbmpNumbers);
  SetBkColor(hdc,0);
  SetTextColor(hdc,0xffffff);
  if ((iPlr < 0) || (iPlr == idPlayer)) {
    cr = -1;
    local_c = 0xff;
  }
  else {
    cr = *(int *)(iPlr * 4 + 0x2e);
    local_c = *(int *)(iPlr * 4 + 0x30);
  }
  iVar1 = y + -7;
  iVar3 = x + -1;
  if (99 < lVar6) {
    bVar2 = true;
    if ((cr != -1) || (local_c != 0xff)) {
      BitBlt(hdc,x + -6,iVar1,4,7,hdcMem,l / 100 << 2,0,0x220326);
      SetTextColor(hdc,CONCAT22(local_c,cr));
    }
    BitBlt(hdc,x + -6,iVar1,4,7,hdcMem,l / 100 << 2,0,0xee0086);
    if ((cr != -1) || (local_c != 0xff)) {
      SetTextColor(hdc,0xffffff);
    }
    lVar6 = __aFlrem(lVar6,100);
    iVar3 = x + 2;
  }
  x = iVar3;
  l = (int)lVar6;
  if ((9 < lVar6) || (bVar2)) {
    if ((cr != -1) || (local_c != 0xff)) {
      BitBlt(hdc,x + -3,iVar1,4,7,hdcMem,l / 10 << 2,0,0x220326);
      SetTextColor(hdc,CONCAT22(local_c,cr));
    }
    BitBlt(hdc,x + -3,iVar1,4,7,hdcMem,l / 10 << 2,0,0xee0086);
    if ((cr != -1) || (local_c != 0xff)) {
      SetTextColor(hdc,0xffffff);
    }
    x = x + 2;
    lVar6 = __aFlrem(lVar6,10);
  }
  l = (int)lVar6;
  if ((cr != -1) || (local_c != 0xff)) {
    BitBlt(hdc,x,iVar1,4,7,hdcMem,l << 2,0,0x220326);
    SetTextColor(hdc,CONCAT22(local_c,cr));
  }
  BitBlt(hdc,x,iVar1,4,7,hdcMem,l << 2,0,0xee0086);
  if ((cr != -1) || (local_c != 0xff)) {
    SetTextColor(hdc,0xffffff);
  }
  SelectObject(hdcMem,HVar4);
  return;
}



// ======================================================================
// Function: CShipsScanVis
// Address: 1058:4bf4
// Segment: MEMORY_SCAN
// ======================================================================


long CShipsScanVis(FLEET *lpfl)

{
  uint uVar1;
  int iVar2;
  bool bVar3;
  HULDEF *pHVar4;
  ushort grbitSh;
  short k;
  uint csh;
  int local_8;
  short j;
  
  csh = 0;
  local_8 = 0;
  if ((grbitScan & 0x100) != 0) {
    if ((((FLEET *)lpfl)->iPlayer == idPlayer) &&
       ((((((FLEET *)lpfl)->cord != 1 ||
          ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 6)) ||
         ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 5)) ||
        (((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 3 ||
         ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 7)))))) {
      csh = 0;
      local_8 = 0;
      goto LAB_1058_4e75;
    }
    if ((((FLEET *)lpfl)->iPlayer != idPlayer) &&
       ((*(uint *)((int)&((FLEET *)lpfl)->dirLong + 2) & 0xf) == 0)) {
      csh = 0;
      local_8 = 0;
      goto LAB_1058_4e75;
    }
  }
  if (((grbitScan & 0x200) == 0) || (((FLEET *)lpfl)->iPlayer != idPlayer)) {
    if (((grbitScan & 0x800) == 0) || (((FLEET *)lpfl)->iPlayer == idPlayer)) {
      for (j = 0; j < 0x10; j = j + 1) {
        uVar1 = ((FLEET *)lpfl)->rgcsh[j];
        bVar3 = CARRY2(csh,uVar1);
        csh = csh + uVar1;
        local_8 = local_8 + ((int)uVar1 >> 0xf) + (uint)bVar3;
      }
    }
    else {
      j = 0;
      for (grbitSh = grbitScanEShip; grbitSh != 0; grbitSh = grbitSh >> 1) {
        if ((grbitSh & 1) != 0) {
          for (k = 0; k < 0x10; k = k + 1) {
            if ((0 < ((FLEET *)lpfl)->rgcsh[k]) &&
               (iVar2 = ((FLEET *)lpfl)->iPlayer * 4,
               pHVar4 = LphuldefFromId(*(HullDef *)(*(int *)(iVar2 + 0xfe) + k * 0x93)),
               (((HULDEF *)pHVar4)->wFlags_0x7b >> 10 & 0xf) == j)) {
              uVar1 = ((FLEET *)lpfl)->rgcsh[k];
              bVar3 = CARRY2(csh,uVar1);
              csh = csh + uVar1;
              local_8 = local_8 + ((int)uVar1 >> 0xf) + (uint)bVar3;
            }
          }
        }
        j = j + 1;
      }
    }
  }
  else {
    j = 0;
    for (grbitSh = grbitScanShip; grbitSh != 0; grbitSh = grbitSh >> 1) {
      if (((grbitSh & 1) != 0) && (0 < ((FLEET *)lpfl)->rgcsh[j])) {
        uVar1 = ((FLEET *)lpfl)->rgcsh[j];
        bVar3 = CARRY2(csh,uVar1);
        csh = csh + uVar1;
        local_8 = local_8 + ((int)uVar1 >> 0xf) + (uint)bVar3;
      }
      j = j + 1;
    }
  }
LAB_1058_4e75:
  return CONCAT22(local_8,csh);
}



// ======================================================================
// Function: DrawRadarCircle
// Address: 1058:4e7c
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10584f8a) */
/* WARNING: Removing unreachable block (ram,0x10584f71) */
/* WARNING: Removing unreachable block (ram,0x10584fd1) */

void DrawRadarCircle(DRAWCIR *pdc,RECT *prc)

{
  BOOL BVar1;
  int iVar2;
  int *piVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  bool bVar4;
  bool bVar5;
  ulong uVar6;
  int local_44;
  int iStack_42;
  ZIPORDER *pZStack_40;
  undefined2 uStack_3e;
  longdouble local_3c;
  long local_32;
  undefined4 local_2e;
  RECT rc;
  short x;
  long l;
  short rad;
  short x2;
  short dx;
  short i;
  short iFree;
  short y;
  short dy;
  undefined4 crSav;
  ulong r2;
  short y2;
  
  if ((prc == (RECT *)0x0) ||
     ((pdc->fCovered == 0 && (BVar1 = IntersectRect(&rc,prc,&pdc->rcClip), BVar1 != 0)))) {
    if (prc == (RECT *)0x0) {
      if (pdc->fHollowOut != 0) {
        SetROP2(pdc->hdc,9);
        crSav = SetBkColor(pdc->hdc,0xffffff);
        l = 1;
      }
      while( true ) {
        for (i = 0; i < pdc->cCur; i = i + 1) {
          if (0 < pdc->rgrad[i]) {
            x = pdc->rgx[i];
            y = pdc->rgy[i];
            rad = pdc->rgrad[i];
            Ellipse(pdc->hdc,x - rad,y - rad,x + rad + 1,y + rad + 1);
          }
        }
        if (((pdc->fHollowOut == 0) || ((int)l != 1)) || (l._2_2_ != 0)) break;
        l = 0;
        SetBkColor(pdc->hdc,crSav);
        SetROP2(pdc->hdc,0xf);
      }
      pdc->fCovered = 0;
      pdc->cCur = 0;
    }
    else {
      iVar2 = prc->right - prc->left;
      rad = iVar2 >> 1;
      x = prc->left + rad;
      y = prc->top + rad;
      iVar2 = iVar2 >> 0xf;
      r2 = __aFulmul(CONCAT22(iVar2,rad),CONCAT22(iVar2,rad));
      for (i = 0; i < 4; i = i + 1) {
        if (i < 2) {
          x2 = (&pdc->rcClip)->left;
        }
        else {
          x2 = (pdc->rcClip).right;
        }
        if ((i & 1U) == 0) {
          y2 = (pdc->rcClip).bottom;
        }
        else {
          y2 = (pdc->rcClip).top;
        }
        dx = x2 - x;
        dy = y2 - y;
        if (((long)r2 < (long)dx) || ((long)r2 < (long)dy)) break;
        uVar6 = __aFulmul((long)dy,(long)dy);
        local_2e = uVar6;
        uVar6 = __aFulmul((long)dx,(long)dx);
        if ((long)r2 < (long)(uVar6 + local_2e)) break;
      }
      if (i == 4) {
        pdc->fCovered = 1;
        pdc->cCur = 0;
      }
      else if (pdc->cCur != pdc->cMax) {
        iFree = pdc->cCur;
        i = 0;
        do {
          if (pdc->cCur <= i) {
            pdc->rgx[iFree] = x;
            pdc->rgy[iFree] = y;
            pdc->rgrad[iFree] = rad;
            if (iFree != pdc->cCur) {
              return;
            }
            pdc->cCur = pdc->cCur + 1;
            return;
          }
          if (pdc->rgrad[i] < 1) {
            iFree = i;
          }
          else {
            x2 = pdc->rgx[i];
            y2 = pdc->rgy[i];
            dx = x - x2;
            dy = y - y2;
            uVar6 = __aFulmul((long)dy,(long)dy);
            local_2e = uVar6;
            uVar6 = __aFulmul((long)dx,(long)dx);
            l = uVar6 + local_2e;
            if (pdc->rgrad[i] < rad) {
              local_32 = (long)rad;
              local_3c = (longdouble)local_32;
              _sqrt(SUB84((double)l,0),
                            (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)l >>
                                                                              0x20))));
              bVar4 = CARRY2((uint)pdc->rgrad,i * 2);
              piVar3 = pdc->rgrad + i;
              bVar5 = piVar3 == (int *)0x0;
              local_44 = *piVar3;
              iStack_42 = local_44 >> 0xf;
              uStack_3e = 0x1118;
              pZStack_40 = (ZIPORDER *)0x51d2;
              __aFfcompp();
              if (bVar4 || bVar5) {
                pdc->rgrad[i] = 0;
                iFree = i;
              }
            }
            else if (rad < pdc->rgrad[i]) {
              local_32 = (long)pdc->rgrad[i];
              local_3c = (longdouble)local_32;
              _sqrt(SUB84((double)l,0),
                            (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)l >>
                                                                              0x20))));
              bVar4 = (undefined1 *)0xfff7 < &local_44;
              bVar5 = &stack0x0000 == (undefined1 *)((int)(ulong *)rgcrPlrHistory + 0xe);
              iStack_42 = rad >> 0xf;
              local_44 = rad;
              uStack_3e = 0x1118;
              pZStack_40 = (ZIPORDER *)vrgZip;
              __aFfcompp();
              if (bVar4 || bVar5) {
                return;
              }
            }
            else if ((x2 == x) && (y2 == y)) {
              return;
            }
          }
          i = i + 1;
        } while( true );
      }
      if (pdc->fHollowOut != 0) {
        SetROP2(pdc->hdc,9);
        crSav = SetBkColor(pdc->hdc,0xffffff);
        Ellipse(pdc->hdc,prc->left,prc->top,prc->right,prc->bottom);
        SetBkColor(pdc->hdc,crSav);
        SetROP2(pdc->hdc,0xf);
      }
      Ellipse(pdc->hdc,prc->left,prc->top,prc->right,prc->bottom);
    }
  }
  return;
}



// ======================================================================
// Function: DrawShipScanPath
// Address: 1058:540c
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: m */
/* WARNING: Variable defined which should be unmapped: dy5 */
/* WARNING: Variable defined which should be unmapped: dAngle */
/* WARNING: Variable defined which should be unmapped: dx5 */
/* WARNING: Variable defined which should be unmapped: dx */

void DrawShipScanPath(HDC hdc,short fShow)

{
  FLEET *pFVar1;
  double dVar2;
  double dVar3;
  uint uVar4;
  short sVar5;
  int iVar6;
  HGDIOBJ HVar7;
  int iVar8;
  ORDER *pOVar9;
  ushort *puVar10;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar11;
  undefined2 unaff_SS;
  bool bVar12;
  long lVar13;
  ulong uVar14;
  double *pdVar15;
  THING *pTVar16;
  undefined2 in_stack_0000fef0;
  undefined2 uVar17;
  undefined2 in_stack_0000fef6;
  double m;
  short dy5;
  ushort uVar18;
  int local_fa;
  short dx5;
  int rgptArrow;
  THING *pTStack_f4;
  int iStack_f2;
  undefined2 uStack_f0;
  double dAngle;
  RECT rc;
  short dx;
  short dRad;
  long lWarp2;
  short fHdc;
  short i;
  FLEET *lpfl;
  POINT ptCur;
  ORDER *lpord1;
  short dy;
  short iRopSav;
  POINT pt;
  POINT pt2;
  HPEN hpenSav;
  short j;
  int rgDup [87];
  ORDER *lpord2;
  
  fHdc = 0;
  if (((sel.grobj != grobjFleet) && (sel.scan.grobj != grobjFleet)) &&
     (sel.scan.grobj != grobjThing)) {
    if (sel.grobj != grobjPlanet) {
      return;
    }
    if ((((sel.pl.wFlags_0x4 >> 9 & 1) == 0) ||
        ((sel.pl.lStarbase._2_2_ & 0x3ff) == 0)) &&
       ((sel.pl.wRouting & 0x3ff) == 0)) {
      return;
    }
  }
  if (fShow == fOrdersVis) {
    return;
  }
  if (((uint)gd.grBits2 & 1) != 0) {
    return;
  }
  fOrdersVis = fShow;
  bVar12 = hdc == 0;
  if (bVar12) {
    hdc = GetDC(hwndScanner);
  }
  fHdc = (short)bVar12;
  if ((sel.scan.grobj == grobjThing) && (sel.scan.ith != -1)) {
    dAngle._4_2_ = (THING *)lpThings + sel.scan.ith;
    dAngle._6_2_ = lpThings._2_2_;
    ptCur.x = (&(dAngle._4_2_)->pt)->x;
    ptCur.y = ((dAngle._4_2_)->pt).y;
    if (((THING *)CONCAT22(lpThings._2_2_,dAngle._4_2_))->idFull >> 0xd == 3) {
      dx = ((&(dAngle._4_2_)->u_THING_0x0006)->thp).wFlags - ptCur.x;
      dy = *(int *)((int)&(dAngle._4_2_)->u_THING_0x0006 + 2) - ptCur.y;
      uVar4 = *(uint *)((int)&(dAngle._4_2_)->u_THING_0x0006 + 4) & 0xf;
    }
    else {
      if ((((THING *)CONCAT22(lpThings._2_2_,dAngle._4_2_))->idFull >> 0xd != 1) ||
         ((((&(dAngle._4_2_)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) == 0)) goto SCAN_LNextCheck;
      dx = ((POINT *)rgptPlan + (((&(dAngle._4_2_)->u_THING_0x0006)->thp).wFlags & 0x3ff))
           ->x - ptCur.x;
      dy = *(int *)((int)&rgptPlan[0].y +
                   (((&(dAngle._4_2_)->u_THING_0x0006)->thp).wFlags & 0x3ff) * 4) - ptCur.y;
      uVar4 = (((&(dAngle._4_2_)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) + 4;
    }
    lWarp2 = (long)uVar4;
    if ((dx == 0) && (dy == 0)) goto SCAN_LNextCheck;
    uVar14 = __aFulmul((ulong)uVar4,5);
    lWarp2 = __aFulmul(lWarp2,uVar14);
    lpfl = (FLEET *)0x0;
  }
  else {
SCAN_LNextCheck:
    if (sel.scan.grobj != grobjFleet) goto SCAN_LNoObjPath;
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[sel.scan.ifl];
    iVar6 = *(int *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar6,pFVar1);
    ptCur.x = (&pFVar1->pt)->x;
    ptCur.y = (pFVar1->pt).y;
    if (((*(uint *)((int)&pFVar1->dirLong + 2) >> 4 & 1) == 0) ||
       ((*(uint *)((int)&pFVar1->dirLong + 2) & 0xf) == 0)) goto SCAN_LNoObjPath;
    dx = (*(uint *)&pFVar1->dirLong & 0xff) - 0x7f;
    dy = (*(uint *)&pFVar1->dirLong >> 8) - 0x7f;
    if ((dx == 0) && (dy == 0)) goto SCAN_LNoObjPath;
    lWarp2 = (long)((*(uint *)((int)&pFVar1->dirLong + 2) & 0xf) *
                    (*(uint *)((int)&pFVar1->dirLong + 2) & 0xf) * 5);
  }
  GetClientRect(hwndScanner,&rc);
  ExcludeClipRect(hdc,rc.left,rc.bottom - dySBar,rc.right,rc.bottom);
  hpenSav = SelectObject(hdc,hpenStarbase);
  iRopSav = SetROP2(hdc,7);
  if (dx == 0) {
    iVar6 = 0;
    dy5 = (int)lWarp2;
    if (dy < 0) {
      dy5 = -(int)lWarp2;
    }
  }
  else {
    lWarp2 = __aFulmul(lWarp2,lWarp2);
    uVar11 = 1;
    uVar17 = 0;
    dVar2 = (double)lWarp2 /
            (((double)(long)dy / (double)(long)dx) * ((double)(long)dy / (double)(long)dx) + 1.0);
    _sqrt(SUB84(dVar2,0),
                  (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar2 >> 0x20))));
    lVar13 = __ftol((double)CONCAT26(in_stack_0000fef6,
                                             CONCAT24(uVar17,CONCAT22(uVar11,in_stack_0000fef0))));
    iVar6 = (int)lVar13;
    if (dx < 0) {
      iVar6 = -iVar6;
    }
    iVar8 = dx >> 0xf;
    sVar5 = dx;
    uVar14 = __aFulmul((long)iVar6,(long)dy);
    lVar13 = __aFldiv(uVar14,CONCAT22(iVar8,sVar5));
    dy5 = (short)lVar13;
  }
  LogicalToScan(&ptCur);
  uVar4 = PtToScan(iVar6);
  _dx5 = (double *)(ulong)uVar4;
  sVar5 = PtToScan(dy5);
  MoveTo(hdc,ptCur.x - uVar4,ptCur.y + sVar5);
  LineTo(hdc,ptCur.x + uVar4,ptCur.y + -sVar5);
  if (dy == 0) {
    uVar18 = 0;
    if (dx < 0) {
      local_fa = -4;
    }
    else {
      local_fa = 4;
    }
  }
  else {
    dVar2 = (double)(long)-dx / (double)(long)dy;
    dVar3 = DOUBLE_24_0__1120_1ce2 / (dVar2 * dVar2 + 1.0);
    _sqrt(SUB84(dVar3,0),
                  (double)CONCAT26(1,CONCAT24(in_stack_0000fef0,(long)((qword)dVar3 >> 0x20))));
    lVar13 = __ftol((double)CONCAT26(-sVar5,(int6)((qword)dVar2 >> 0x10)));
    sVar5 = dy;
    uVar18 = (ushort)lVar13;
    if (uVar18 == 0) {
      if (dy < 0) {
        local_fa = -4;
      }
      else {
        local_fa = 4;
      }
    }
    else {
      if (0 < dx) {
        uVar18 = -uVar18;
      }
      uVar14 = __aFulmul((long)(int)uVar18,(long)dx);
      in_stack_0000fef0 = 0x59b3;
      lVar13 = __aFldiv(uVar14,(long)sVar5);
      local_fa = (int)lVar13;
    }
  }
  dVar2 = (double)(long)-dx;
  iVar6 = -dy;
  pdVar15 = _atan2(SUB84((double)(long)iVar6,0),
                           (double)CONCAT26(iVar6,CONCAT24(SUB82(dVar2,0),
                                                           (long)((qword)(double)(long)iVar6 >> 0x20
                                                                 ))),
                           (double)CONCAT26(-dx,CONCAT24(in_stack_0000fef0,
                                                         CONCAT22((int)((qword)dVar2 >> 0x30),
                                                                  iVar6 >> 0xf))));
  dVar2 = *(double *)pdVar15 - DOUBLE_0_7853982__1120_1cea;
  dAngle._0_2_ = SUB82(dVar2,0);
  dAngle._2_2_ = (undefined2)((qword)dVar2 >> 0x10);
  dAngle._4_2_ = (THING *)((qword)dVar2 >> 0x20);
  dAngle._6_2_ = (int)((qword)dVar2 >> 0x30);
  for (i = 0; uVar11 = 0x1118, i < 2; i = i + 1) {
    _cos((double *)CONCAT22(dAngle._2_2_,dAngle._0_2_),
                 (double)CONCAT26(local_fa,CONCAT24(uVar18,(THING *)CONCAT22(dAngle._6_2_,
                                                                             dAngle._4_2_))));
    iStack_f2 = 0x1118;
    pTStack_f4 = (THING *)0x5a65;
    lVar13 = __ftol((double)CONCAT26(dAngle._4_2_,
                                             CONCAT24(dAngle._2_2_,CONCAT22(dAngle._0_2_,uStack_f0))
                                            ));
    (&rgptArrow)[i * 2] = (int)lVar13;
    iStack_f2 = dAngle._6_2_;
    pTStack_f4 = dAngle._4_2_;
    _dx5 = (double *)CONCAT22(dAngle._2_2_,dAngle._0_2_);
    local_fa = 0x1118;
    uVar18 = 0x5aa2;
    _sin(_dx5,(double)CONCAT26(dAngle._0_2_,
                                       CONCAT24(uStack_f0,
                                                (THING *)CONCAT22(dAngle._6_2_,dAngle._4_2_))));
    rc.left = 0x1118;
    dAngle._6_2_ = 0x5abe;
    pTVar16 = (THING *)__ftol((double)CONCAT26(dx,CONCAT24(rc.bottom,
                                                                   CONCAT22(rc.right,rc.top))));
    (&pTStack_f4)[i * 2] = (THING *)pTVar16;
    dVar2 = DOUBLE_1_5707964__1120_1cfa +
            (double)CONCAT26(dAngle._6_2_,
                             CONCAT24(dAngle._4_2_,(double *)CONCAT22(dAngle._2_2_,dAngle._0_2_)));
    dAngle._0_2_ = SUB82(dVar2,0);
    dAngle._2_2_ = (undefined2)((qword)dVar2 >> 0x10);
    dAngle._4_2_ = (THING *)((qword)dVar2 >> 0x20);
    dAngle._6_2_ = (int)((qword)dVar2 >> 0x30);
  }
  j = -5;
  for (i = -5; i < 6; i = i + 1) {
    if (i == 0) {
      j = 5;
    }
    else {
      __aFulmul((long)dx5,(long)i);
      lVar13 = __aFlshl(10,uVar18);
      lVar13 = __aFldiv(lVar13 + CONCAT22(dx5,uVar11),10);
      pt.x = (int)lVar13 + ptCur.x;
      uVar4 = 0x1118;
      __aFulmul(0,(long)i);
      lVar13 = __aFlshl(10,uVar18);
      uVar11 = 0x1118;
      lVar13 = __aFldiv(lVar13 + (ulong)uVar4,10);
      pt.y = (int)lVar13 + ptCur.y;
      if (i < 1) {
        MoveTo(hdc,pt.x + uVar18,pt.y + local_fa);
        LineTo(hdc,pt.x - uVar18,pt.y - local_fa);
        uVar11 = 0x14f8;
        LineTo(hdc,pt.x - uVar18,(pt.y - local_fa) + -1);
      }
      else {
        for (j = 0; j < 2; j = j + 1) {
          MoveTo(hdc,pt.x + (&rgptArrow)[j * 2],pt.y - (int)(&pTStack_f4)[j * 2]);
          uVar11 = 0x14f8;
          LineTo(hdc,pt.x,pt.y);
        }
      }
    }
  }
  SetROP2(hdc,iRopSav);
  SelectObject(hdc,hpenSav);
SCAN_LNoObjPath:
  if (sel.grobj == grobjPlanet) {
    dAngle._4_2_ = (THING *)0x0;
    if (((sel.pl.wFlags_0x4 >> 9 & 1) != 0) &&
       ((sel.pl.lStarbase._2_2_ & 0x3ff) != 0)) {
      hpenSav = SelectObject(hdc,hpenDkPurple);
      dAngle._6_2_ = (sel.pl.lStarbase._2_2_ & 0x3ff) - 1;
      goto SCAN_LDrawPath;
    }
    while (((sel.pl.wRouting & 0x3ff) != 0 && (dAngle._4_2_ == (THING *)0x0))) {
      dAngle._4_2_ = (THING *)0x1;
      dAngle._6_2_ = (sel.pl.wRouting & 0x3ff) - 1;
      hpenSav = SelectObject(hdc,hpenDkGreen);
SCAN_LDrawPath:
      iRopSav = SetROP2(hdc,7);
      GetClientRect(hwndScanner,&rc);
      ExcludeClipRect(hdc,rc.left,rc.bottom - dySBar,rc.right,rc.bottom);
      pt.x = ((POINT *)rgptPlan + sel.pl.id)->x;
      pt.y = *(short *)((int)&rgptPlan[0].y + sel.pl.id * 4);
      LogicalToScan(&pt);
      MoveTo(hdc,pt.x,pt.y);
      pt.x = ((POINT *)rgptPlan + dAngle._6_2_)->x;
      pt.y = *(ushort *)((int)&rgptPlan[0].y + dAngle._6_2_ * 4);
      LogicalToScan(&pt);
      LineTo(hdc,pt.x,pt.y);
      SetROP2(hdc,iRopSav);
      SelectObject(hdc,hpenSav);
    }
  }
  else if ((sel.grobj == grobjFleet) && (1 < sel.fl.cord)) {
    _memset(rgDup,0,sel.fl.cord << 1);
    lpord1 = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,(PLORD *)sel.fl.lpplord + 1)
    ;
    pt.x = (lpord1->pt).x;
    pt.y = *(ushort *)&((PLORD *)sel.fl.lpplord)[1].iordMax;
    for (i = 1; i < sel.fl.cord; i = i + 1) {
      lpord2 = (ORDER *)lpord1 + 1;
      pt2.x = (lpord2->pt).x;
      pt2.y = ((ORDER *)lpord1)[1].pt.y;
      if (rgDup[i] == 0) {
        for (j = i + 1; j < sel.fl.cord; j = j + 1) {
          uVar11 = (undefined2)((ulong)lpord2 >> 0x10);
          pOVar9 = (ORDER *)lpord2;
          if (((((pt.x == (lpord2->pt).x) && (pt.y == (pOVar9->pt).y)) &&
               (pt2.x == ((pOVar9 + 1)->pt).x)) && (pt2.y == pOVar9[1].pt.y)) ||
             (((pt2.x == (lpord2->pt).x && (pt2.y == (pOVar9->pt).y)) &&
              ((pt.x == ((pOVar9 + 1)->pt).x && (pt.y == pOVar9[1].pt.y)))))) {
            rgDup[i] = 1;
            rgDup[j] = 2;
          }
          lpord2 = (ORDER *)lpord2 + 1;
        }
      }
      pt.x = pt2.x;
      pt.y = pt2.y;
      lpord1 = (ORDER *)lpord1 + 1;
    }
    GetClientRect(hwndScanner,&rc);
    ExcludeClipRect(hdc,rc.left,rc.bottom - dySBar,rc.right,rc.bottom);
    if ((fShow != 0) && ((grbitScan & 0x80) != 0)) {
      hpenSav = SelectObject(hdc,hpenStarbase);
      uVar11 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
      pt.x = ((PLORD *)sel.fl.lpplord + 1)->wFlags;
      pt.y = *(short *)&((PLORD *)sel.fl.lpplord)[1].iordMax;
      LogicalToScan(&pt);
      MoveTo(hdc,pt.x,pt.y);
      for (i = 1; i < sel.fl.cord; i = i + 1) {
        puVar10 = (ushort *)((int)(PLORD *)sel.fl.lpplord + i * 0x12 + 4);
        pt2.x = *puVar10;
        pt2.y = puVar10[1];
        LogicalToScan(&pt2);
        LineTo(hdc,pt2.x,pt2.y);
        pt.x = pt2.x;
        pt.y = pt2.y;
      }
      SelectObject(hdc,hpenSav);
    }
    hpenSav = SelectObject(hdc,hpenShip);
    iRopSav = SetROP2(hdc,7);
    uVar11 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
    pt.x = ((PLORD *)sel.fl.lpplord + 1)->wFlags;
    pt.y = *(short *)&((PLORD *)sel.fl.lpplord)[1].iordMax;
    dRad = 5;
    LogicalToScan(&pt);
    ExcludeClipRect(hdc,pt.x - dRad,pt.y - dRad,pt.x + dRad + 1,pt.y + dRad + 1);
    MoveTo(hdc,pt.x,pt.y);
    for (i = 1; i < sel.fl.cord; i = i + 1) {
      puVar10 = (ushort *)((int)(PLORD *)sel.fl.lpplord + i * 0x12 + 4);
      pt2.x = *puVar10;
      pt2.y = puVar10[1];
      dRad = 5;
      LogicalToScan(&pt2);
      ExcludeClipRect(hdc,pt2.x - dRad,pt2.y - dRad,pt2.x + dRad + 1,pt2.y + dRad + 1);
      if (rgDup[i] == 2) {
        MoveTo(hdc,pt2.x,pt2.y);
      }
      else {
        if (rgDup[i] == 1) {
          HVar7 = hpenYellow;
          if ((grbitScan & 0x80) == 0) {
            HVar7 = GetStockObject(6);
          }
          SelectObject(hdc,HVar7);
        }
        LineTo(hdc,pt2.x,pt2.y);
        if (rgDup[i] == 1) {
          SelectObject(hdc,hpenShip);
        }
      }
      pt.x = pt2.x;
      pt.y = pt2.y;
    }
    SetROP2(hdc,iRopSav);
    SelectObject(hdc,hpenSav);
    SelectClipRgn(hdc,hrgnHuge);
  }
  if (fHdc != 0) {
    ReleaseDC(hwndScanner,hdc);
  }
  return;
}



// ======================================================================
// Function: DrawScannerSBar
// Address: 1058:62d8
// Segment: MEMORY_SCAN
// ======================================================================


void DrawScannerSBar(HDC hdc,RECT *prc,SBAR *psbar,short fFullRedraw)

{
  BOOL BVar1;
  short sVar2;
  char *pcVar3;
  ushort uVar4;
  int iVar5;
  int iVar6;
  undefined2 unaff_SS;
  DWORD DVar7;
  undefined2 uVar8;
  RECT *pRVar9;
  undefined2 uVar10;
  UINT UVar11;
  UINT UVar12;
  HDC HVar13;
  char szBuf [100];
  RECT rc;
  RECT rcT;
  short grobj;
  undefined4 l;
  short fDoName;
  HBRUSH hbrSav;
  char *psz;
  RECT rcClip;
  HFONT hfontSav;
  short dxHole;
  COLORREF crBk;
  short c;
  short iBkPrev;
  short grReal;
  int pt;
  short local_12;
  short id;
  int pt2;
  short local_c;
  COLORREF crText;
  short fhdc;
  
  fhdc = 0;
  fDoName = 1;
  GetClientRect(hwndScanner,&rc);
  rc.top = rc.bottom - dySBar;
  if ((prc == (RECT *)0x0) || (BVar1 = IntersectRect(&rcT,prc,&rc), BVar1 != 0)) {
    if (hdc == 0) {
      fhdc = 1;
      hdc = GetDC(hwndScanner);
    }
    hfontSav = SelectObject(hdc,rghfontArial8[1]);
    if (psbar == (SBAR *)0x0) {
      grobj = sel.scan.grobj;
    }
    else {
      grobj = psbar->grbit;
    }
    iBkPrev = SetBkMode(hdc,1);
    crBk = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
    ;
    crText = SetTextColor(hdc,CONCAT22(crButtonText._2_2_,
                                       (undefined2)crButtonText));
    hbrSav = SelectObject(hdc,hbrButtonFace);
    if (fFullRedraw != 0) {
      PatBlt(hdc,rc.left,rc.top,rc.right - rc.left,dySBar,0xf00021);
      SelectObject(hdc,hbrButtonHilite);
      PatBlt(hdc,rc.left,rc.top,1,dySBar,0xf00021);
      PatBlt(hdc,rc.left,rc.top,rc.right - rc.left,1,0xf00021);
    }
    rc.bottom = rc.bottom - (dySBar >> 1);
    rcT.right = rc.right;
    rcT.top = rc.top + 4;
    rcT.bottom = rc.bottom + -4;
    rcT.left = rc.left + 4;
    if (0x167 < rc.right) {
      l = GetTextExtent(hdc,(LPCSTR)0x112005a2,7);
      dxHole = (int)l + 6;
      rcT.right = dxHole + rcT.left;
      DrawLockLight(hdc,&rcT,fFullRedraw);
      if ((grobj & 1U) == 0) {
        if (grobj == 4) {
          if (psbar == (SBAR *)0x0) {
            id = sel.scan.iwp;
          }
          else {
            id = psbar->id;
          }
          c = _wsprintf(szWork,(char *)0x112005b1,id);
          TextOut(hdc,rcT.left + 3,rcT.top + 2,szWork,c);
        }
      }
      else {
        if (psbar == (SBAR *)0x0) {
          id = sel.scan.idpl;
        }
        else {
          id = psbar->id;
        }
        if (id != -1) {
          c = _wsprintf(szWork,(char *)0x112005aa,id + 1);
          SetBkMode(hdc,2);
          TextOut(hdc,rcT.left + 3,rcT.top + 2,szWork,c);
        }
      }
      DVar7 = GetTextExtent(hdc,(LPCSTR)0x112005b8,7);
      rcT.left = rcT.left + dxHole + 4;
      dxHole = (int)DVar7 + 6;
      rcT.right = dxHole + rcT.left;
      l = DVar7;
      DrawLockLight(hdc,&rcT,fFullRedraw);
      if (psbar == (SBAR *)0x0) {
        if (grobj == 0) {
          local_12 = 0;
          pt = 0;
        }
        else {
          pt = sel.scan.pt.x;
          local_12 = sel.scan.pt.y;
        }
      }
      else {
        pt = (&psbar->pt)->x;
        local_12 = (psbar->pt).y;
      }
      if (0 < pt) {
        c = _wsprintf(szWork,(char *)0x112005c0,pt);
        SetBkMode(hdc,2);
        TextOut(hdc,rcT.left + 3,rcT.top + 2,szWork,c);
      }
      rcT.left = rcT.left + dxHole + 4;
      dxHole = (int)l + 6;
      rcT.right = dxHole + rcT.left;
      DrawLockLight(hdc,&rcT,fFullRedraw);
      if (0 < local_12) {
        c = _wsprintf(szWork,(char *)0x112005c6,local_12);
        SetBkMode(hdc,2);
        TextOut(hdc,rcT.left + 3,rcT.top + 2,szWork,c);
      }
      rcT.left = rcT.left + dxHole + 4;
    }
    dxHole = (rc.right - rcT.left) + -4;
    rcT.right = dxHole + rcT.left;
    DrawLockLight(hdc,&rcT,fFullRedraw);
    rcClip.left = rcT.left;
    rcClip.top = rcT.top;
    rcClip.right = rcT.right;
    rcClip.bottom = rcT.bottom;
    ExpandRc(&rcClip,-2,-2);
    grReal = sel.scan.grobjFull;
    if (grobj != 4) {
      grReal = grobj;
    }
    if ((psbar == (SBAR *)0x0) || (psbar->psz == (char *)0x0)) {
      if ((grReal & grobjPlanet) == grobjNone) {
        if ((grReal & grobjFleet) == grobjNone) {
          if ((grReal & grobjThing) == grobjNone) {
            if ((grReal == grobjNone) && (grobj == 4)) {
              CchGetString(idsDeepSpaceWaypoint,(char *)szWork);
            }
            else {
              fDoName = 0;
            }
          }
          else {
            if (psbar == (SBAR *)0x0) {
              uVar4 = ((THING *)lpThings + sel.scan.ith)->idFull;
            }
            else {
              uVar4 = psbar->id;
            }
            PszGetThingName(uVar4);
          }
        }
        else {
          if (psbar == (SBAR *)0x0) {
            sVar2 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
          }
          else {
            sVar2 = psbar->id;
          }
          PszGetFleetName(sVar2);
        }
      }
      else {
        sVar2 = sel.scan.idpl;
        if (psbar != (SBAR *)0x0) {
          sVar2 = psbar->id;
        }
        PszGetPlanetName(sVar2);
      }
    }
    else {
      _strcpy((char *)szWork,psbar->psz);
    }
    if (fDoName != 0) {
      iVar5 = rcT.left + 3;
      iVar6 = rcT.top + 2;
      UVar11 = 4;
      pRVar9 = &rcClip;
      uVar8 = 0x1120;
      pcVar3 = (char *)szWork;
      uVar10 = unaff_SS;
      HVar13 = hdc;
      UVar12 = lstrlen(szWork);
      ExtTextOut(HVar13,iVar5,iVar6,UVar11,(RECT *)CONCAT22(uVar10,pRVar9),
                 (LPCSTR)CONCAT22(uVar8,pcVar3),UVar12,(short *)0x0);
    }
    OffsetRc(&rc,0,dySBar >> 1);
    rcT.top = rc.top + 4;
    rcT.bottom = rc.bottom + -4;
    rcT.left = rc.left + 4;
    rcT.right = rc.right + -4;
    DrawLockLight(hdc,&rcT,fFullRedraw);
    rcClip.left = rcT.left;
    rcClip.top = rcT.top;
    rcClip.right = rcT.right;
    rcClip.bottom = rcT.bottom;
    ExpandRc(&rcClip,-2,-2);
    if (psbar == (SBAR *)0x0) {
      if (grobj == 0) {
        local_12 = 0;
        pt = 0;
      }
      else {
        pt = sel.scan.pt.x;
        local_12 = sel.scan.pt.y;
      }
    }
    else {
      pt = (&psbar->pt)->x;
      local_12 = (psbar->pt).y;
    }
    if ((psbar == (SBAR *)0x0) || (psbar->pscan == (SCAN *)0x0)) {
      if ((sel.grobj == grobjFleet) || (sel.grobj == grobjPlanet)) {
        pt2 = sel.pt.x;
        local_c = sel.pt.y;
      }
      else {
        pt2 = -1;
      }
    }
    else {
      pt2 = (psbar->pscan->pt).x;
      local_c = (psbar->pscan->pt).y;
    }
    if (((pt != -1) && (pt2 != -1)) && ((pt != pt2 || (local_12 != local_c)))) {
      pcVar3 = PszGetDistance(pt,local_12,pt2,local_c);
      _strcpy(szBuf,pcVar3);
      for (psz = szBuf; *psz != ' '; psz = psz + 1) {
      }
      CchGetString((0x15d < rc.right) + idsLy,psz + 1);
      if ((psbar == (SBAR *)0x0) || (psbar->pscan == (SCAN *)0x0)) {
        uVar4 = _strlen(psz);
        CchGetString(idsFrom,psz + uVar4);
        pcVar3 = PszGetLocName(sel.grobj,sel.id,pt2,local_c);
        _strcat(psz + 8,pcVar3);
      }
      iVar5 = rcT.left + 3;
      iVar6 = rcT.top + 2;
      UVar12 = 4;
      pRVar9 = &rcClip;
      pcVar3 = szBuf;
      uVar10 = unaff_SS;
      HVar13 = hdc;
      uVar4 = _strlen(szBuf);
      ExtTextOut(HVar13,iVar5,iVar6,UVar12,(RECT *)CONCAT22(uVar10,pRVar9),pcVar3,uVar4,(short *)0x0
                );
    }
    SelectObject(hdc,hbrSav);
    SetBkMode(hdc,iBkPrev);
    SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
    SetBkColor(hdc,crBk);
    SelectObject(hdc,hfontSav);
    if (fhdc != 0) {
      ReleaseDC(hwndScanner,hdc);
    }
  }
  return;
}



// ======================================================================
// Function: DrawLockLight
// Address: 1058:6b00
// Segment: MEMORY_SCAN
// ======================================================================


void DrawLockLight(HDC hdc,RECT *prc,short fFullRedraw)

{
  undefined2 unaff_SS;
  RECT rc;
  short dx;
  short dy;
  
  dx = prc->right - prc->left;
  dy = prc->bottom - prc->top;
  if (fFullRedraw == 0) {
    rc.left = prc->left;
    rc.top = prc->top;
    rc.right = prc->right;
    rc.bottom = prc->bottom;
    ExpandRc(&rc,-2,-2);
    FillRect(hdc,&rc,hbrButtonFace);
  }
  else {
    SelectObject(hdc,hbrButtonShadow);
    PatBlt(hdc,prc->left,prc->top,1,dy,0xf00021);
    PatBlt(hdc,prc->left,prc->top,dx,1,0xf00021);
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,prc->right,prc->top,1,dy + 1,0xf00021);
    PatBlt(hdc,prc->left,prc->bottom,dx,1,0xf00021);
  }
  return;
}



// ======================================================================
// Function: SetScanScrollBars
// Address: 1058:6c14
// Segment: MEMORY_SCAN
// ======================================================================


void SetScanScrollBars(HWND hwnd)

{
  int iVar1;
  undefined2 unaff_SS;
  RECT rc;
  short dx;
  short yMax;
  short dy;
  short xMax;
  
  fInScrollSet = 1;
  GetClientRect(hwnd,&rc);
  dx = ScanToPt(rc.right);
  dy = ScanToPt(rc.bottom - dySBar);
  if ((dGalInv + -1000) - dx < 1000) {
    iVar1 = 1000;
  }
  else {
    iVar1 = (dGalInv + -1000) - dx;
  }
  xMax = iVar1 + 3U & 0xfffc;
  if ((dGalInv + -1000) - dy < 1000) {
    iVar1 = 1000;
  }
  else {
    iVar1 = (dGalInv + -1000) - dy;
  }
  yMax = iVar1 + 3U & 0xfffc;
  SetScrollRange(hwnd,0,1000,xMax,1);
  if ((fInScrollSet != 0) && (SetScrollRange(hwnd,1,1000,yMax,1), fInScrollSet != 0))
  {
    if (dy <= dx) {
      dx = dy;
    }
    dScanPage = dx / 3 & 0xfffc;
    dScanInc = dScanPage / 8 + 2U & 0xfffc;
    fInScrollSet = 0;
  }
  return;
}



// ======================================================================
// Function: ScrollScanner
// Address: 1058:6d30
// Segment: MEMORY_SCAN
// ======================================================================


void ScrollScanner(short dx,short dy)

{
  BOOL BVar1;
  short sVar2;
  undefined2 unaff_SS;
  RECT rc;
  RECT rcUpd2;
  RECT rcUpd;
  HDC hdc;
  
  if ((((dx != 0) || (dy != 0)) && (BVar1 = IsWindowVisible(hwndScanner), BVar1 != 0)) &&
     (((uint)gd.grBits2 & 1) == 0)) {
    hdc = GetDC(hwndScanner);
    GetClientRect(hwndScanner,&rc);
    sVar2 = _abs(dx);
    if (((rc.right >> 1 < sVar2) || (sVar2 = _abs(dy), rc.bottom >> 1 < sVar2)) ||
       ((fDlgUp != 0 || (hwndBrowser != 0)))) {
      DrawScanner(hdc,&rc);
    }
    else {
      rc.bottom = rc.bottom - dySBar;
      UpdateWindow(hwndScanner);
      ScrollWindow(hwndScanner,dx,dy,&rc,&rc);
      if (dy < 1) {
        if (dy < 0) {
          SetRect(&rcUpd2,0,rc.bottom + dy,rc.right,rc.bottom);
          rc.bottom = rc.bottom + dy;
        }
      }
      else {
        SetRect(&rcUpd2,0,0,rc.right,dy);
        rc.top = rc.top + dy;
      }
      if (dx < 1) {
        if (dx < 0) {
          rcUpd.top = rc.top;
          rcUpd.right = rc.right;
          rcUpd.bottom = rc.bottom;
          rcUpd.left = rc.right + dx;
          rc.left = rc.left - dx;
        }
      }
      else {
        SetRect(&rcUpd,0,rc.top,dx,rc.bottom);
        rc.right = rc.right - dx;
      }
      if (dx != 0) {
        ValidateRect(hwndScanner,&rcUpd);
      }
      if (dy != 0) {
        ValidateRect(hwndScanner,&rcUpd2);
      }
      if (dx != 0) {
        DrawScanner(hdc,&rcUpd);
      }
      if (dy != 0) {
        DrawScanner(hdc,&rcUpd2);
      }
      UpdateWindow(hwndScanner);
    }
    ReleaseDC(hwndScanner,hdc);
  }
  return;
}



// ======================================================================
// Function: RedrawScanSel
// Address: 1058:6f30
// Segment: MEMORY_SCAN
// ======================================================================


void RedrawScanSel(HDC hdc,short fVis)

{
  int *piVar1;
  int *piVar2;
  GrobjClass GVar3;
  BOOL BVar4;
  int iVar5;
  int *piVar6;
  int *piVar7;
  undefined2 unaff_SS;
  bool bVar8;
  short sel_grobjFull;
  RECT rc;
  int sel_scan;
  int local_20;
  int local_1e;
  short fNoSelRedraw;
  short sel_id;
  POINT pt;
  short dOff;
  short fhdc;
  short sel_grobj;
  
  GVar3 = sel.grobjFull;
  fhdc = 0;
  sel_id = sel.id;
  sel_grobj = sel.grobj;
  piVar6 = (int *)&sel.scan;
  piVar7 = &sel_scan;
  for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
    piVar2 = piVar7;
    piVar7 = piVar7 + 1;
    piVar1 = piVar6;
    piVar6 = piVar6 + 1;
    *piVar2 = *piVar1;
  }
  if ((hwndScanner != 0) && (BVar4 = IsWindowVisible(hwndScanner), BVar4 != 0)) {
    bVar8 = fVis == -1;
    if (bVar8) {
      fVis = 0;
    }
    fNoSelRedraw = (short)bVar8;
    if (hdc == 0) {
      fhdc = 1;
      hdc = GetDC(hwndScanner);
    }
    DrawShipScanPath(hdc,fVis);
    if (fVis == 0) {
      sel.scan.iwp = -1;
      sel.scan.ifl = -1;
      sel.scan.idpl = -1;
      sel.id = -1;
      sel.grobjFull = grobjNone;
      sel.grobj = grobjNone;
      sel.scan.grobjFull = grobjNone;
      sel.scan.grobj = grobjNone;
    }
    if ((iScanZoom < 3) || ((grbitScan & 0xf) != 4)) {
      if ((grbitScan & 0x1000) == 0) {
        dOff = 0;
      }
      else {
        dOff = 7;
      }
    }
    else {
      dOff = 0xb;
    }
    if ((sel_grobj != 0) && (fNoSelRedraw == 0)) {
      pt.x = sel.pt.x;
      pt.y = sel.pt.y;
      LogicalToScan(&pt);
      SetRect(&rc,(pt.x + -0xb) - dOff,(pt.y + -0xb) - dOff,pt.x + 0xc + dOff,pt.y + 0x17 + dOff);
      DrawScanner(hdc,&rc);
    }
    if ((local_1e != 0) && ((sel_scan != sel.pt.x || (local_20 != sel.pt.y)))) {
      pt.x = sel_scan;
      pt.y = local_20;
      LogicalToScan(&pt);
      SetRect(&rc,(pt.x + -6) - dOff,(pt.y + -6) - dOff,pt.x + 7 + dOff,pt.y + 0xf + dOff);
      DrawScanner(hdc,&rc);
    }
    if (fVis == 0) {
      sel.id = sel_id;
      sel.grobj = sel_grobj;
      piVar7 = &sel_scan;
      piVar6 = (int *)&sel.scan;
      sel.grobjFull = GVar3;
      for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
        piVar2 = piVar6;
        piVar6 = piVar6 + 1;
        piVar1 = piVar7;
        piVar7 = piVar7 + 1;
        *piVar2 = *piVar1;
      }
    }
    if (fhdc != 0) {
      ReleaseDC(hwndScanner,hdc);
    }
  }
  return;
}



// ======================================================================
// Function: FEnsurePointOnScreen
// Address: 1058:715c
// Segment: MEMORY_SCAN
// ======================================================================


short FEnsurePointOnScreen(POINT pt,short fScroll)

{
  POINT pt_00;
  BOOL BVar1;
  short sVar2;
  undefined2 unaff_SS;
  RECT rc;
  int ptCtr;
  int local_c;
  short cx;
  short fFix;
  short cy;
  
  fFix = 0;
  GetClientRect(hwndScanner,&rc);
  rc.bottom = rc.bottom - dySBar;
  cx = ScanToPt(rc.right);
  cy = ScanToPt(rc.bottom);
  rc.left = xScanTop + 10;
  rc.right = xScanTop + cx + -0x14;
  rc.bottom = (dGalInv - yScanTop) + -10;
  rc.top = (rc.bottom - cy) + 0x14;
  BVar1 = PtInRect(&rc,pt);
  if (BVar1 == 0) {
    ptCtr = (cx >> 1) + xScanTop;
    local_c = (dGalInv - yScanTop) - (cy >> 1);
    if (pt.x < rc.left) {
      ptCtr = ptCtr - (rc.left - pt.x);
    }
    else if (rc.right < pt.x) {
      ptCtr = ptCtr + (pt.x - rc.right);
    }
    if (pt.y < rc.top) {
      local_c = local_c - (rc.top - pt.y);
    }
    else if (rc.bottom < pt.y) {
      local_c = local_c + (pt.y - rc.bottom);
    }
    pt_00.y = local_c;
    pt_00.x = ptCtr;
    CtrPointScan(pt_00,fScroll);
    sVar2 = 0;
  }
  else {
    sVar2 = 1;
  }
  return sVar2;
}



// ======================================================================
// Function: CtrPointScan
// Address: 1058:7278
// Segment: MEMORY_SCAN
// ======================================================================


void CtrPointScan(POINT pt,short fScroll)

{
  int iVar1;
  int iVar2;
  short dy;
  short dx;
  undefined2 unaff_SS;
  RECT rc;
  short x;
  short dyCur;
  short cx;
  short y;
  short cy;
  short dxCur;
  
  x = pt.x;
  y = pt.y;
  if (hwndScanner != 0) {
    GetClientRect(hwndScanner,&rc);
    rc.bottom = rc.bottom - dySBar;
    cx = ScanToPt(rc.right);
    cy = ScanToPt(rc.bottom);
    if (x - (cx >> 1) < 0x3e9) {
      iVar1 = 1000;
    }
    else {
      iVar1 = x - (cx >> 1);
    }
    if ((cy >> 1) + y < dGalInv + -1000) {
      iVar2 = (cy >> 1) + y;
    }
    else {
      iVar2 = dGalInv + -1000;
    }
    if ((dGalInv + -1000) - cx <= iVar1) {
      iVar1 = (dGalInv + -1000) - cx;
    }
    if (iVar2 <= cy + 1000) {
      iVar2 = cy + 1000;
    }
    iVar2 = dGalInv - iVar2;
    if (iVar1 < 0x3e9) {
      iVar1 = 1000;
    }
    if (iVar2 < 0x3e9) {
      iVar2 = 1000;
    }
    dxCur = xScanTop;
    dyCur = yScanTop;
    x = iVar1 + 2U & 0xfffc;
    y = iVar2 + 2U & 0xfffc;
    if ((xScanTop != x) || (yScanTop != y)) {
      xScanTop = x;
      SetScrollPos(hwndScanner,0,iVar1 + 2U & 0xfffc,1);
      yScanTop = y;
      SetScrollPos(hwndScanner,1,y,1);
      if (fScroll == 0) {
        InvalidateRect(hwndScanner,(RECT *)0x0,0);
      }
      else {
        dy = PtToScan(dyCur - y);
        dx = PtToScan(dxCur - x);
        ScrollScanner(dx,dy);
      }
    }
  }
  return;
}



// ======================================================================
// Function: LogicalToScan
// Address: 1058:744e
// Segment: MEMORY_SCAN
// ======================================================================


void LogicalToScan(POINT *ppt)

{
  short sVar1;
  
  sVar1 = PtToScan(ppt->x - xScanTop);
  ppt->x = sVar1;
  sVar1 = PtToScan((dGalInv - ppt->y) - yScanTop);
  ppt->y = sVar1;
  return;
}



// ======================================================================
// Function: ScanToLogical
// Address: 1058:7490
// Segment: MEMORY_SCAN
// ======================================================================


void ScanToLogical(POINT *ppt)

{
  short sVar1;
  
  sVar1 = ScanToPt(ppt->x);
  ppt->x = sVar1 + xScanTop;
  sVar1 = ScanToPt(ppt->y);
  ppt->y = dGalInv - (sVar1 + yScanTop);
  if (dGal + 1000 < ppt->x) {
    ppt->x = dGal + 1000;
  }
  if (ppt->y < 1000) {
    ppt->y = 1000;
  }
  return;
}



// ======================================================================
// Function: FAddWayPoint
// Address: 1058:7504
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1058763d) */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short FAddWayPoint(POINT ptIn,SCAN *pscan)

{
  byte *pbVar1;
  ORDER *pOVar2;
  ORDER *pOVar3;
  GrobjClass GVar4;
  char *pcVar5;
  int iVar6;
  uint uVar7;
  short sVar8;
  ORDER *pOVar9;
  undefined2 *puVar10;
  ORDER *pOVar11;
  undefined2 uVar12;
  undefined2 unaff_SS;
  ulong uVar13;
  ulong uVar14;
  short ipt;
  short cpt;
  short dx;
  POINT rgpt;
  short local_18;
  short local_16;
  undefined2 local_14;
  undefined2 local_12;
  short lDist;
  ORDER *lpord;
  short dy;
  short id;
  HDC hdc;
  
  if (sel.fl.cord == 0x57) {
    MessageBeep(0x40);
    uVar12 = 0x56;
    pcVar5 = PszGetCompressedString(idsCantHaveDWaypoints);
    _wsprintf(szWork,pcVar5,uVar12);
    AlertSz((char *)szWork,0x10);
    sVar8 = 0;
  }
  else {
    if ((grbitScan & 0x80) != 0) {
      rgpt.x = ptIn.x;
      rgpt.y = ptIn.y;
      local_18 = (pscan->pt).x;
      local_16 = (pscan->pt).y;
      if (sel.iwpAct < sel.fl.cord + -1) {
        cpt = 3;
        puVar10 = (undefined2 *)
                  ((int)(PLORD *)sel.fl.lpplord + (sel.iwpAct + 1) * 0x12 + 4);
        local_14 = *puVar10;
        local_12 = puVar10[1];
      }
      else {
        cpt = 2;
      }
    }
    iVar6 = ptIn.x - (pscan->pt).x;
    dy = ptIn.y - (pscan->pt).y;
    lDist = ScanToPt(0x14);
    uVar13 = __aFulmul((long)dy,(long)dy);
    uVar14 = __aFulmul((long)iVar6,(long)iVar6);
    if ((long)(lDist * lDist) < (long)(uVar14 + uVar13)) {
      pscan->grobjFull = grobjOther;
      pscan->grobj = grobjOther;
      pscan->idpl = -1;
      pscan->ifl = -1;
      pscan->iwp = sel.iwpAct + 1;
      (pscan->pt).x = ptIn.x;
      (pscan->pt).y = ptIn.y;
    }
    pOVar9 = (ORDER *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
    lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,pOVar9);
    if (((pscan->pt).x == (lpord->pt).x) && ((pscan->pt).y == (pOVar9->pt).y)) {
      sVar8 = 0;
    }
    else if ((sel.iwpAct < sel.fl.cord + -1) &&
            (((pscan->pt).x == ((pOVar9 + 1)->pt).x && ((pscan->pt).y == pOVar9[1].pt.y)))) {
      sVar8 = 0;
    }
    else {
      hdc = GetDC(hwndScanner);
      DrawShipScanPath(hdc,0);
      if ((uint)((PLORD *)sel.fl.lpplord)->iordMax == sel.fl.cord) {
        sel.fl.lpplord =
             LpplReAlloc(sel.fl.lpplord,sel.fl.cord + 3);
        lpord = (ORDER *)CONCAT22((int)((ulong)sel.fl.lpplord >> 0x10),
                                  (ORDER *)((int)(PL *)sel.fl.lpplord +
                                           (sel.iwpAct + 1) * 0x12 + 4));
      }
      else {
        lpord = (ORDER *)lpord + 1;
      }
      if (sel.iwpAct != sel.fl.cord + -1) {
        __fmemmove((ORDER *)lpord + 1,lpord,
                           ((sel.fl.cord - sel.iwpAct) + -1) * 0x12);
      }
      pOVar9 = (ORDER *)lpord + -1;
      pOVar11 = (ORDER *)lpord;
      for (iVar6 = 9; iVar6 != 0; iVar6 = iVar6 + -1) {
        pOVar3 = pOVar11;
        pOVar11 = &(pOVar11->pt).y;
        pOVar2 = pOVar9;
        pOVar9 = &(pOVar9->pt).y;
        (pOVar3->pt).x = (pOVar2->pt).x;
      }
      sVar8 = (pscan->pt).y;
      (lpord->pt).x = (pscan->pt).x;
      (((ORDER *)lpord)->pt).y = sVar8;
      GVar4 = pscan->grobj;
      if (GVar4 == grobjPlanet) {
        id = pscan->idpl;
      }
      else if (GVar4 == grobjFleet) {
        id = ((FLEET **)rglpfl)[pscan->ifl]->id;
      }
      else if (GVar4 == grobjOther) {
        id = pscan->iwp;
      }
      else if (GVar4 == grobjThing) {
        id = ((THING *)lpThings + pscan->ith)->idFull;
      }
      ((ORDER *)lpord)->id = id;
      ((ORDER *)lpord)->wFlags_0x6 =
           ((ORDER *)lpord)->wFlags_0x6 & 0xf0ff |
           (pscan->grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 8;
      sel.fl.cord = sel.fl.cord + 1;
      pbVar1 = &((PLORD *)sel.fl.lpplord)->iordMac;
      *pbVar1 = *pbVar1 + 1;
      uVar7 = IWarpBestForWaypoint(&sel.fl,lpord);
      uVar12 = (undefined2)((ulong)lpord >> 0x10);
      ((ORDER *)lpord)->wFlags_0x6 = ((ORDER *)lpord)->wFlags_0x6 & 0xff0f | (uVar7 & 0xf) << 4;
      pscan->grobj = grobjOther;
      pscan->grobjFull = pscan->grobjFull | grobjOther;
      pscan->iwp = sel.iwpAct + 1;
      RedrawScanSel(0,0);
      FLookupFleet(-1,(FLEET *)&sel.fl);
      uVar12 = (undefined2)((ulong)lpord >> 0x10);
      pOVar9 = (ORDER *)lpord;
      if (((pOVar9[-1].wFlags_0x6 & 0xf) == 6) && (((&pOVar9[-1].u_ORDER_0x0008)->tlm).cTime == 5))
      {
        __fmemset((u_ORDER_0x0008 *)CONCAT22(uVar12,&pOVar9[-1].u_ORDER_0x0008),0,10);
        uVar12 = (undefined2)((ulong)lpord >> 0x10);
        ((ORDER *)lpord)[-1].wFlags_0x6 = ((ORDER *)lpord)[-1].wFlags_0x6 & 0xfff0;
        FLookupFleet(-1,(FLEET *)&sel.fl);
      }
      ChangeScanSel(pscan,1);
      ReleaseDC(hwndScanner,hdc);
      if ((grbitScan & 0x80) != 0) {
        for (ipt = 0; ipt < cpt; ipt = ipt + 1) {
          LogicalToScan(&rgpt + ipt);
        }
        BoundPoints(&stack0xffd6,&rgpt,cpt);
        InvalidateRect(hwndScanner,&stack0xffd6,0);
      }
      sVar8 = 1;
    }
  }
  return sVar8;
}



// ======================================================================
// Function: IWarpBestForWaypoint
// Address: 1058:7a18
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10587e7e) */
/* WARNING: Removing unreachable block (ram,0x10587d6c) */
/* WARNING: Removing unreachable block (ram,0x10587f25) */

short IWarpBestForWaypoint(FLEET *lpfl,ORDER *lpord)

{
  uint uVar1;
  POINT pt;
  POINT ptSrc;
  POINT ptDst;
  POINT PVar2;
  POINT PVar3;
  POINT PVar4;
  bool bVar5;
  bool bVar6;
  uint uVar7;
  int iVar8;
  short sVar9;
  ORDER *pOVar10;
  FLEET *pFVar11;
  int iVar12;
  FLEET *unaff_SI;
  undefined2 uVar13;
  undefined2 uVar14;
  POINT PVar15;
  ulong uVar16;
  HULDEF *pHVar17;
  long lVar18;
  long lVar19;
  FLEET *pFVar20;
  undefined2 in_stack_0000ffcc;
  undefined2 uVar22;
  undefined2 in_stack_0000ffce;
  HullDef in_stack_0000ffd0;
  GrobjClass in_stack_0000ffd4;
  GrobjClass in_stack_0000ffd6;
  GrobjClass GVar23;
  short in_stack_0000ffd8;
  long in_stack_0000ffda;
  short iWarpOld;
  undefined4 i;
  short iWarpSav;
  short iWarpAi;
  short fGoFlatOut;
  short fGoFlatOutAi;
  short cSpeed;
  short lDist;
  short iwp;
  short cTravel;
  short iWarp;
  FLEET *pFVar21;
  
  uVar13 = (undefined2)((ulong)lpord >> 0x10);
  pOVar10 = (ORDER *)lpord;
  uVar1 = pOVar10->wFlags_0x6;
  uVar7 = IFindIdealWarp((FLEET *)0x0,0);
  if (fAi != 0) {
    iWarpAi = IFindIdealWarp((FLEET *)0x0,1);
  }
  pFVar20 = (FLEET *)CONCAT22(in_stack_0000ffcc,unaff_SI);
  uVar14 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar11 = (FLEET *)lpfl;
  iwp = pFVar11->cord;
  do {
    iwp = iwp + -1;
    if (iwp < 0) break;
  } while (lpord != (ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar11->lpplord + 2),
                                      (ORDER *)(*(int *)&pFVar11->lpplord + 4 + iwp * 0x12)));
  if (iwp < 1) {
    return uVar7;
  }
  if (((pOVar10->wFlags_0x6 & 0xf) == 2) || ((pOVar10->wFlags_0x6 & 0xf) == 5)) {
    bVar5 = true;
  }
  else {
    bVar5 = false;
    for (i._0_2_ = (PLANET *)0x0; i._2_2_ = 0, (int)(PLANET *)i < 0x10;
        i._0_2_ = (PLANET *)((int)(PLANET *)i + 1)) {
      if (0 < pFVar11->rgcsh[(int)(PLANET *)i]) {
        for (; iVar12 = pFVar11->iPlayer * 4,
            i._2_2_ < (int)(uint)*(byte *)(*(int *)(iVar12 + 0xfe) + (int)(PLANET *)i * 0x93 + 0x7a)
            ; i._2_2_ = i._2_2_ + 1) {
          iVar12 = pFVar11->iPlayer * 4;
          if ((*(int *)(*(int *)(iVar12 + 0xfe) + (int)(PLANET *)i * 0x93 + 0x3a + i._2_2_ * 4) ==
               0x1000) &&
             ((iVar12 = pFVar11->iPlayer * 4,
              (*(uint *)(*(int *)(iVar12 + 0xfe) + (int)(PLANET *)i * 0x93 + i._2_2_ * 4 + 0x3c) &
              0xff) == 0 ||
              (iVar12 = pFVar11->iPlayer * 4,
              (*(uint *)(*(int *)(iVar12 + 0xfe) + (int)(PLANET *)i * 0x93 + i._2_2_ * 4 + 0x3c) &
              0xff) == 1)))) {
            bVar5 = true;
            break;
          }
        }
      }
    }
  }
  if ((bVar5) || (fAi == 0)) {
    bVar6 = false;
  }
  else {
    bVar6 = true;
    bVar5 = true;
  }
  iWarp = uVar7;
  if ((int)uVar7 < 9) {
    pt.y = (pOVar10->pt).y;
    pt.x = (lpord->pt).x;
    sVar9 = FFindNearestObject(pt,0x81,&stack0xffd0);
    if (sVar9 == 0) {
      i = (PLANET *)0x0;
    }
    else {
      i = LpplFromId(in_stack_0000ffd8);
    }
    pFVar20 = (FLEET *)CONCAT22(in_stack_0000ffcc,unaff_SI);
    if ((bVar5) ||
       ((((PLANET *)i != (PLANET *)0x0 || (i._2_2_ != 0)) &&
        ((((PLANET *)i)->iPlayer == -1 || (((PLANET *)i)->iPlayer == idPlayer)))))) {
      if ((bVar6) &&
         (((((PLANET *)i != (PLANET *)0x0 || (i._2_2_ != 0)) &&
           (((PLANET *)i)->iPlayer == idPlayer)) &&
          (*(int *)(*(int *)(idPlayer * 4 + 0x14c) +
                   (*(uint *)&((PLANET *)i)->lStarbase & 0xf) * 0x93) != 0x20)))) {
        bVar6 = false;
      }
      iWarp = 9;
    }
    else {
      if (((1 < iwp) && (uVar7 < (pOVar10[-1].wFlags_0x6 >> 4 & 0xf))) &&
         ((pOVar10[-1].wFlags_0x6 >> 4 & 0xf) < 0xb)) {
        iWarp = pOVar10[-1].wFlags_0x6 >> 4 & 0xf;
      }
      LFuelUseToWaypoint(lpfl,iwp,1);
      pFVar20 = lpfl;
      PVar15 = (POINT)LGetFleetStat(lpfl,grStatFuel);
      pFVar21 = (FLEET *)((ulong)pFVar20 >> 0x10);
      in_stack_0000ffce = 0x1050;
      uVar22 = 0x7d5a;
      lVar19 = __aFldiv((long)PVar15,CONCAT22(in_stack_0000ffd6,in_stack_0000ffd4));
      pFVar20 = (FLEET *)CONCAT22(uVar22,pFVar21);
      if (lVar19 <= CONCAT22(in_stack_0000ffce,uVar22)) goto SCAN_LOptimizeSpeed;
      GVar23 = grobjNone;
      pFVar20 = lpfl;
      uVar16 = LGetFleetStat(lpfl,grStatFuel);
      in_stack_0000ffd0 = 0x1050;
      in_stack_0000ffce = 0x7d9c;
      uVar16 = __aFulmul(uVar16,CONCAT22(in_stack_0000ffd8,GVar23));
      lVar19 = __aFldiv(uVar16,in_stack_0000ffda);
      PVar2.y = 0;
      PVar2.x = in_stack_0000ffd0;
      PVar15.y = 0;
      PVar15.x = in_stack_0000ffd0;
      iVar8 = (int)((ulong)lVar19 >> 0x10);
      iVar12 = *(int *)((int)pFVar11->rgwtMin + 0x12);
      if ((iVar12 < iVar8) ||
         ((iVar12 <= iVar8 && (PVar15 = PVar2, *(uint *)(pFVar11->rgwtMin + 4) < (uint)lVar19))))
      goto SCAN_LOptimizeSpeed;
      iWarp = iWarp + 1;
    }
    for (; (int)uVar7 < iWarp; iWarp = iWarp + -1) {
      pOVar10->wFlags_0x6 = pOVar10->wFlags_0x6 & 0xff0f | (iWarp & 0xfU) << 4;
      lVar19 = LFuelUseToWaypoint(lpfl,iwp,1);
      pFVar21 = (FLEET *)pFVar20;
      if (lVar19 <= CONCAT22(*(undefined2 *)((int)pFVar11->rgwtMin + 0x12),(int)pFVar11->rgwtMin[4])
         ) {
        if (((((PLANET *)i != (PLANET *)0x0) || (i._2_2_ != 0)) &&
            ((((PLANET *)i)->wFlags_0x4 >> 9 & 1) != 0)) &&
           (((PLANET *)i)->iPlayer == idPlayer)) {
          in_stack_0000ffd0 =
               *(HullDef *)
                (*(int *)(idPlayer * 4 + 0x14c) +
                (*(uint *)&((PLANET *)i)->lStarbase & 0xf) * 0x93);
          in_stack_0000ffce = 0x1050;
          uVar22 = 0x7eec;
          pHVar17 = LphuldefFromId(in_stack_0000ffd0);
          pFVar20 = (FLEET *)CONCAT22(uVar22,pFVar21);
          if ((((HULDEF *)pHVar17)->hul).wtCargoMax != 0) break;
        }
        lVar18 = __aFldiv(CONCAT22(*(undefined2 *)((int)pFVar11->rgwtMin + 0x12),
                                           (int)pFVar11->rgwtMin[4]),2);
        if ((lVar19 <= lVar18) || (bVar5)) break;
      }
    }
    pOVar10->wFlags_0x6 = pOVar10->wFlags_0x6 & 0xff0f | (uVar1 >> 4 & 0xf) << 4;
  }
  PVar4.y = 0;
  PVar4.x = in_stack_0000ffd0;
  PVar3.y = 0;
  PVar3.x = in_stack_0000ffd0;
  PVar15.y = 0;
  PVar15.x = in_stack_0000ffd0;
  if ((bVar6) && (PVar15 = PVar3, iWarpAi < iWarp)) {
    iWarp = iWarpAi;
    PVar15 = PVar4;
  }
SCAN_LOptimizeSpeed:
  if ((1 < iWarp) && ((pOVar10->wFlags_0x6 >> 8 & 0xf) != 2)) {
    DGetDistance((double *)CONCAT22((pOVar10->pt).y,(double *)(lpord->pt).x),
                       ((pOVar10 + -1)->pt).x,pOVar10[-1].pt.y,(short)(FLEET *)pFVar20,
                       (short)((ulong)pFVar20 >> 0x10));
    lVar19 = __ftol((double)CONCAT26(PVar15.x,CONCAT24(in_stack_0000ffce,pFVar20)));
    iVar8 = iWarp * iWarp;
    iVar12 = iWarp;
    do {
      iWarp = iVar12;
      iVar12 = iWarp + -1;
      if (iVar12 < 2) break;
    } while ((iVar8 + (int)lVar19 + -1) / iVar8 ==
             ((int)lVar19 + iVar12 * iVar12 + -1) / (iVar12 * iVar12));
  }
  ptSrc.y = pOVar10[-1].pt.y;
  ptSrc.x = ((pOVar10 + -1)->pt).x;
  ptDst.y = (pOVar10->pt).y;
  ptDst.x = (lpord->pt).x;
  sVar9 = FCanFleetUseStargates(lpfl,ptSrc,ptDst);
  if (sVar9 == 1) {
    iWarp = 0xb;
  }
  if (0xb < iWarp) {
    iWarp = 9;
  }
  return iWarp;
}



// ======================================================================
// Function: FNearAWayPoint
// Address: 1058:8074
// Segment: MEMORY_SCAN
// ======================================================================


short FNearAWayPoint(POINT pt,short fLogical)

{
  short sVar1;
  uint uVar2;
  undefined2 uVar3;
  SCAN scan;
  short i;
  ORDER *lpord;
  
  if (sel.grobj == grobjFleet) {
    if (fLogical == 0) {
      ScanToLogical(&pt);
    }
    sVar1 = FFindNearestObject(pt,0x4f,&scan);
    if (sVar1 == 0) {
      uVar2 = 0;
    }
    else if ((scan.grobjFull & grobjOther) == grobjNone) {
      uVar2 = 0;
    }
    else if ((scan.pt.x == sel.pt.x) && (scan.pt.y == sel.pt.y)) {
      lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,
                                &((PLORD *)sel.fl.lpplord)[5].iordMax);
      for (i = 1; i < sel.fl.cord; i = i + 1) {
        uVar3 = (undefined2)((ulong)lpord >> 0x10);
        if (((lpord->pt).x == scan.pt.x) && ((((ORDER *)lpord)->pt).y == scan.pt.y)) break;
        lpord = (ORDER *)CONCAT22(uVar3,(ORDER *)lpord + 1);
      }
      uVar2 = (uint)(i != sel.fl.cord);
    }
    else {
      uVar2 = 1;
    }
  }
  else {
    uVar2 = 0;
  }
  return uVar2;
}



// ======================================================================
// Function: FHandleWayPointDrag
// Address: 1058:8176
// Segment: MEMORY_SCAN
// ======================================================================


short FHandleWayPointDrag(POINT pt)

{
  POINT pt_00;
  POINT pt_01;
  short sVar1;
  uint uVar2;
  int iVar3;
  char *sz;
  uint uVar4;
  HDC hdc_00;
  ORDER *pOVar5;
  uint *puVar6;
  short *psVar7;
  undefined2 uVar8;
  undefined2 unaff_SS;
  char *mbType;
  HDC hdc;
  RECT rc;
  short fFirst;
  SCAN scan;
  uint ptPrev;
  uint local_6e;
  short cpt;
  POINT ptNew;
  POINT rgpt;
  uint local_62;
  uint local_60;
  uint local_5e;
  uint local_5c;
  short local_5a;
  short local_58;
  short fDel;
  short ptNext;
  short local_52;
  POINT ptLogical;
  short i;
  ORDER *lpord;
  HCURSOR hcurSav;
  short grTypeIn;
  short fDup;
  char szDeepSpace [40];
  short fMarker;
  SBAR sbar;
  HPEN hpenSav;
  HDC hdc__8;
  short fChg;
  
  fFirst = 1;
  fMarker = 0;
  LogicalToScan(&pt);
  if (sel.iwpAct == 0) {
    lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,
                              &((PLORD *)sel.fl.lpplord)[5].iordMax);
    for (i = 1; i < sel.fl.cord; i = i + 1) {
      uVar8 = (undefined2)((ulong)lpord >> 0x10);
      if ((sel.fl.pt.x == (lpord->pt).x) &&
         (sel.fl.pt.y == (((ORDER *)lpord)->pt).y)) break;
      lpord = (ORDER *)CONCAT22(uVar8,(ORDER *)lpord + 1);
    }
    SetScanWp(i);
  }
  puVar6 = (uint *)((int)(PLORD *)sel.fl.lpplord + (sel.iwpAct + -1) * 0x12 + 4)
  ;
  ptPrev = *puVar6;
  local_6e = puVar6[1];
  if (sel.iwpAct == sel.fl.cord + -1) {
    cpt = 3;
  }
  else {
    cpt = 4;
    psVar7 = (short *)((int)(PLORD *)sel.fl.lpplord +
                      (sel.iwpAct + 1) * 0x12 + 4);
    local_5a = *psVar7;
    local_58 = psVar7[1];
    ptNext = local_5a;
    local_52 = local_58;
  }
  puVar6 = (uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
  rgpt.x = *puVar6;
  rgpt.y = puVar6[1];
  local_62 = rgpt.x;
  local_60 = rgpt.y;
  local_5e = ptPrev;
  local_5c = local_6e;
  for (i = 0; i < cpt; i = i + 1) {
    LogicalToScan(&rgpt + i);
  }
  GetClientRect(hwndScanner,&rc);
  rc.bottom = rc.bottom - dySBar;
  hdc__8 = GetDC(hwndScanner);
  hcurSav = setcursor(hcurCloseGrab);
  SetCapture(hwndScanner);
  ptNew.x = pt.x;
  ptNew.y = pt.y;
  while (sVar1 = FGetMouseMove(&ptNew), sVar1 != 0) {
    uVar4 = rc.right;
    if (ptNew.x <= rc.right) {
      uVar4 = ptNew.x;
    }
    if (uVar4 < 0x8000) {
      uVar4 = rc.right;
      if (ptNew.x <= rc.right) {
        uVar4 = ptNew.x;
      }
    }
    else {
      uVar4 = 0;
    }
    uVar2 = rc.bottom;
    if (ptNew.y <= rc.bottom) {
      uVar2 = ptNew.y;
    }
    if (uVar2 < 0x8000) {
      uVar2 = rc.bottom;
      if (ptNew.y <= rc.bottom) {
        uVar2 = ptNew.y;
      }
    }
    else {
      uVar2 = 0;
    }
    ptNew.x = uVar4;
    ptNew.y = uVar2;
    if ((pt.x != uVar4) || (pt.y != uVar2)) {
      if ((fFirst == 0) ||
         (pt_01.y = uVar2, pt_01.x = uVar4, sVar1 = FNearAWayPoint(pt_01,0), sVar1 == 0)) {
        fFirst = 0;
        ptLogical.x = ptNew.x;
        ptLogical.y = ptNew.y;
        ScanToLogical(&ptLogical);
        uVar4 = GetAsyncKeyState(0x10);
        if ((uVar4 & 0xfffe) == 0) {
          grTypeIn = 0x4f;
        }
        else {
          grTypeIn = 0x8f;
        }
        pt_00.y = ptLogical.y;
        pt_00.x = ptLogical.x;
        FFindNearestObject(pt_00,grTypeIn,&scan);
        DrawScanXorLines(hdc__8,&rgpt,cpt);
        if (scan.grobj == grobjNone) {
          rgpt.x = ptLogical.x;
          rgpt.y = ptLogical.y;
          sbar.id = 0xffff;
          CchGetString(idsDeepSpace,szDeepSpace);
          sbar.psz = szDeepSpace;
        }
        else {
          rgpt.x = scan.pt.x;
          rgpt.y = scan.pt.y;
          if (scan.grobj == grobjPlanet) {
            sbar.id = scan.idpl;
          }
          else if (scan.grobj == grobjFleet) {
            sbar.id = ((FLEET **)rglpfl)[scan.ifl]->id;
          }
          else if (scan.grobj == grobjThing) {
            sbar.id = ((THING *)lpThings + scan.ith)->idFull;
          }
          else {
            sbar.id = scan.iwp;
          }
          sbar.psz = (char *)0x0;
        }
        sbar.pt.x = rgpt.x;
        sbar.pt.y = rgpt.y;
        sbar.grbit = scan.grobj;
        LogicalToScan(&rgpt);
        DrawScanXorLines(hdc__8,&rgpt,cpt);
        sbar.pscan = (SCAN *)0x0;
        DrawScannerSBar(hdc__8,(RECT *)0x0,&sbar,0);
      }
      pt.y = ptNew.y;
      pt.x = ptNew.x;
    }
  }
  if ((rgpt.x == local_62) && (rgpt.y == local_60)) {
    fChg = 0;
  }
  else {
    fChg = 1;
  }
  if (fChg != 0) {
    if (scan.grobj == grobjNone) {
      scan.pt.x = ptLogical.x;
      scan.pt.y = ptLogical.y;
      scan.grobj = grobjOther;
      scan.iwp = sel.iwpAct;
    }
    if ((scan.pt.x == ptPrev) && (scan.pt.y == local_6e)) {
      fDup = 1;
    }
    else {
      fDup = 0;
    }
    if ((fDup == 0) && (sel.iwpAct < sel.fl.cord + -1)) {
      puVar6 = (uint *)((int)(PLORD *)sel.fl.lpplord +
                       (sel.iwpAct + 1) * 0x12 + 4);
      if ((scan.pt.x == *puVar6) && (scan.pt.y == puVar6[1])) {
        iVar3 = 1;
      }
      else {
        iVar3 = 0;
      }
      fDup = iVar3 << 1;
    }
    GetClientRect(hwndScanner,&rc);
    if (fDup != 0) {
      mbType = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
      sz = PszFormatIds(idsSureWantDeleteCurrentWaypoint,(short *)0x0);
      sVar1 = AlertSz(sz,(short)mbType);
      fDel = (short)(sVar1 == 6);
      if ((grbitScan & 0x80) != 0) {
        hpenSav = SelectObject(hdc__8,hpenStarbase);
        MoveTo(hdc__8,local_5e,local_5c);
        LineTo(hdc__8,rgpt.x,rgpt.y);
        if (3 < cpt) {
          ExcludeClipRect(hdc__8,0,rc.bottom - dySBar,rc.right,rc.bottom);
          LineTo(hdc__8,local_5a,local_58);
        }
        SelectObject(hdc__8,hpenSav);
      }
      DrawScanXorLines(hdc__8,&rgpt,cpt);
      rgpt.x = local_62;
      rgpt.y = local_60;
      if ((grbitScan & 0x80) != 0) {
        hpenSav = SelectObject(hdc__8,hpenStarbase);
        MoveTo(hdc__8,local_5e,local_5c);
        LineTo(hdc__8,rgpt.x,rgpt.y);
        if (3 < cpt) {
          ExcludeClipRect(hdc__8,0,rc.bottom - dySBar,rc.right,rc.bottom);
          LineTo(hdc__8,local_5a,local_58);
        }
        SelectObject(hdc__8,hpenSav);
      }
      DrawScanXorLines(hdc__8,&rgpt,cpt);
      if (fDel != 0) {
        DeleteCurWayPoint((uint)(fDup == 1));
      }
      goto SCAN_Done_5;
    }
    if ((grbitScan & 0x80) != 0) {
      ExcludeClipRect(hdc__8,0,rc.bottom - dySBar,rc.right,rc.bottom);
      hpenSav = SelectObject(hdc__8,hpenStarbase);
      MoveTo(hdc__8,local_5e,local_5c);
      LineTo(hdc__8,rgpt.x,rgpt.y);
      if (3 < cpt) {
        LineTo(hdc__8,local_5a,local_58);
      }
      SelectObject(hdc__8,hpenSav);
    }
    DrawScanXorLines(hdc__8,&rgpt,cpt);
    rgpt.x = local_62;
    rgpt.y = local_60;
    if ((grbitScan & 0x80) != 0) {
      ExcludeClipRect(hdc__8,0,rc.bottom - dySBar,rc.right,rc.bottom);
      hpenSav = SelectObject(hdc__8,hpenStarbase);
      MoveTo(hdc__8,local_5e,local_5c);
      LineTo(hdc__8,rgpt.x,rgpt.y);
      if (3 < cpt) {
        LineTo(hdc__8,local_5a,local_58);
      }
      SelectObject(hdc__8,hpenSav);
    }
    DrawScanXorLines(hdc__8,&rgpt,cpt);
    RedrawScanSel(0,0);
    uVar8 = sel.fl.lpplord._2_2_;
    if (scan.grobj == grobjPlanet) {
      i = scan.idpl;
    }
    else if (scan.grobj == grobjFleet) {
      i = ((FLEET **)rglpfl)[scan.ifl]->id;
    }
    else if (scan.grobj == grobjThing) {
      i = ((THING *)lpThings + scan.ith)->idFull;
    }
    else {
      i = scan.iwp;
    }
    pOVar5 = (ORDER *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
    lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,pOVar5);
    pOVar5->wFlags_0x6 =
         pOVar5->wFlags_0x6 & 0xf0ff |
         (scan.grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 8;
    pOVar5->id = i;
    (lpord->pt).x = scan.pt.x;
    (pOVar5->pt).y = scan.pt.y;
    uVar4 = IWarpBestForWaypoint(&sel.fl,(ORDER *)CONCAT22(uVar8,pOVar5));
    uVar8 = (undefined2)((ulong)lpord >> 0x10);
    ((ORDER *)lpord)->wFlags_0x6 = ((ORDER *)lpord)->wFlags_0x6 & 0xff0f | (uVar4 & 0xf) << 4;
    FLookupFleet(-1,(FLEET *)&sel.fl);
    scan.iwp = sel.iwpAct;
    scan.grobjFull = scan.grobjFull | grobjOther;
    sel.iwpAct = -2;
    ChangeScanSel(&scan,1);
  }
  DrawScannerSBar(hdc__8,(RECT *)0x0,(SBAR *)0x0,0);
  ReleaseCapture();
  setcursor(hcurSav);
  InvalidateRect(hwndMine,(RECT *)0x0,1);
  SetMineralTitleBar(hwndMine);
SCAN_Done_5:
  ReleaseDC(hwndScanner,hdc__8);
  if ((fChg != 0) && ((grbitScan & 0x80) != 0)) {
    local_62 = ptNew.x;
    local_60 = ptNew.y;
    BoundPoints(&rc,&rgpt,cpt);
    hdc_00 = GetDC(hwndScanner);
    DrawScanner(hdc_00,&rc);
    ReleaseDC(hwndScanner,hdc_00);
  }
  return fChg;
}



// ======================================================================
// Function: DrawScanXorLines
// Address: 1058:8af6
// Segment: MEMORY_SCAN
// ======================================================================


void DrawScanXorLines(HDC hdc,POINT *rgpt,short cpt)

{
  undefined2 unaff_SS;
  RECT rc;
  short i;
  short iRopSav;
  HPEN hpenSav;
  
  GetClientRect(hwndScanner,&rc);
  ExcludeClipRect(hdc,0,rc.bottom - dySBar,rc.right,rc.bottom);
  if (((cpt == 4) && ((rgpt + 2)->x == (rgpt + 3)->x)) && (rgpt[2].y == rgpt[3].y)) {
    cpt = 3;
    hpenSav = GetStockObject(6);
  }
  else {
    hpenSav = hpenShip;
  }
  for (i = 1; i < cpt; i = i + 1) {
    ExcludeClipRect(hdc,(rgpt + i)->x + -5,rgpt[i].y + -5,(rgpt + i)->x + 6,rgpt[i].y + 6);
  }
  hpenSav = SelectObject(hdc,hpenSav);
  iRopSav = SetROP2(hdc,7);
  MoveTo(hdc,(rgpt + 2)->x,rgpt[2].y);
  LineTo(hdc,rgpt->x,rgpt->y);
  if (3 < cpt) {
    LineTo(hdc,(rgpt + 3)->x,rgpt[3].y);
  }
  SetROP2(hdc,iRopSav);
  SelectObject(hdc,hpenSav);
  SelectClipRgn(hdc,hrgnHuge);
  return;
}



// ======================================================================
// Function: SetScanWp
// Address: 1058:8c5a
// Segment: MEMORY_SCAN
// ======================================================================


short SetScanWp(short iNew)

{
  short *psVar1;
  POINT pt;
  SCAN scan;
  
  if (iNew != sel.iwpAct) {
    psVar1 = (short *)((int)(PLORD *)sel.fl.lpplord + iNew * 0x12 + 4);
    pt.y = psVar1[1];
    pt.x = *psVar1;
    FFindNearestObject(pt,grobjOther,&scan);
    scan.iwp = iNew;
    ChangeScanSel(&scan,1);
  }
  return iNew;
}



// ======================================================================
// Function: ChangeScanSel
// Address: 1058:8cc4
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: fMineFieldSel */
/* WARNING: Variable defined which should be unmapped: fChgWp */
/* WARNING: Variable defined which should be unmapped: iRad */

void ChangeScanSel(SCAN *pscan,short fValidScan)

{
  SCAN *pSVar1;
  short *psVar2;
  double dVar3;
  POINT pt;
  POINT pt_00;
  short sVar4;
  int iVar5;
  HDC HVar6;
  int iVar7;
  undefined2 unaff_SI;
  SCAN *pSVar8;
  undefined2 unaff_DI;
  short *psVar9;
  int iVar10;
  int iVar11;
  undefined2 unaff_SS;
  long lVar12;
  undefined4 in_stack_00000008;
  short iRad;
  short fChgWp;
  short in_stack_0000fff6;
  int local_8;
  short fMineFieldSel;
  undefined2 in_stack_0000fffc;
  
  if (fValidScan == 0) {
    pt.y = (pscan->pt).y;
    pt.x = (pscan->pt).x;
    FFindNearestObject(pt,pscan->grobj,pscan);
  }
  iVar10 = 0x1118;
  sVar4 = _memcmp(pscan,(void *)&sel.scan,0x10);
  if (sVar4 != 0) {
    if ((sel.scan.grobj == grobjThing) &&
       (((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0)) {
      iVar5 = 1;
    }
    else {
      iVar5 = 0;
    }
    if (iVar5 != 0) {
      dVar3 = (double)((&((THING *)lpThings)[sel.scan.ith].u_THING_0x0006)->thm).
                      cMines;
      _sqrt(SUB84(dVar3,0),
                    (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar3 >> 0x20))));
      lVar12 = __ftol((double)CONCAT26(in_stack_0000fffc,
                                               CONCAT24(iVar5,CONCAT22(local_8,in_stack_0000fff6))))
      ;
      local_8 = ((THING *)lpThings)[sel.scan.ith].pt.y - (int)lVar12;
      LogicalToScan(&stack0xfff2);
      LogicalToScan(&stack0xfff6);
      iVar10 = 0x14f8;
      InflateRect(&stack0xfff2,1,1);
    }
    iVar11 = 0x1058;
    RedrawScanSel(0,-1);
    psVar9 = (short *)&sel.scan;
    pSVar8 = pscan;
    for (iVar7 = 8; iVar7 != 0; iVar7 = iVar7 + -1) {
      psVar2 = psVar9;
      psVar9 = psVar9 + 1;
      pSVar1 = pSVar8;
      pSVar8 = &(pSVar8->pt).y;
      *psVar2 = (pSVar1->pt).x;
    }
    if (((sel.scan.grobjFull & grobjPlanet) != grobjNone) && (fValidScan != 2)) {
      sel.scan.grobj = grobjPlanet;
    }
    if (iVar10 != 0) {
      sel.iwpAct = pscan->iwp;
      FillOrdersLB();
      SetOrdersLbSel(pscan->iwp);
      UpdateOrdersDDs(0);
      iVar11 = 0x1048;
      DrawPlanShip(0,0x122);
    }
    RedrawScanSel(0,1);
    if (iVar11 != 0) {
      pt_00.y = (pscan->pt).y;
      pt_00.x = (pscan->pt).x;
      FEnsurePointOnScreen(pt_00,1);
    }
    DrawScannerSBar(0,(RECT *)0x0,(SBAR *)0x0,0);
    InvalidateRect(hwndMine,(RECT *)0x0,1);
    SetMineralTitleBar(hwndMine);
    if (iVar5 != 0) {
      HVar6 = GetDC(hwndScanner);
      DrawScanner(HVar6,&stack0xfff2);
      ReleaseDC(hwndScanner,HVar6);
    }
    if ((sel.scan.grobj == grobjThing) &&
       (((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0)) {
      iVar10 = 1;
    }
    else {
      iVar10 = 0;
    }
    if (iVar10 == 0) {
      fMineFieldSel = 0;
    }
    else {
      dVar3 = (double)((&((THING *)lpThings)[sel.scan.ith].u_THING_0x0006)->thm).
                      cMines;
      _sqrt(SUB84(dVar3,0),
                    (double)CONCAT26(iVar10,CONCAT24(local_8,(long)((qword)dVar3 >> 0x20))));
      __ftol((double)CONCAT44(in_stack_00000008,(SCAN *)CONCAT22(fValidScan,pscan)));
      LogicalToScan(&stack0xfff2);
      LogicalToScan(&stack0xfff6);
      fMineFieldSel = 0x1058;
      InflateRect(&stack0xfff2,1,1);
    }
    if (fMineFieldSel != 0) {
      HVar6 = GetDC(hwndScanner);
      DrawScanner(HVar6,&stack0xfff2);
      ReleaseDC(hwndScanner,HVar6);
    }
    if (sel.pl.id != -1) {
      DrawPlanShip(0,0x4002);
    }
    if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
      AdvanceTutor();
    }
  }
  return;
}



// ======================================================================
// Function: FGetNextObjHere
// Address: 1058:909c
// Segment: MEMORY_SCAN
// ======================================================================


short FGetNextObjHere(SCAN *pscan,short fOnlyOurs)

{
  FLEET *pFVar1;
  int iVar2;
  short sVar3;
  bool bVar4;
  short fFound;
  short i;
  FLEET *lpfl;
  
  bVar4 = sel.grobj != grobjFleet;
  for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[i];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    if (bVar4) {
      if (((sel.pt.x == (&pFVar1->pt)->x) && (sel.pt.y == (pFVar1->pt).y)) &&
         ((fOnlyOurs == 0 || (pFVar1->iPlayer == idPlayer)))) break;
    }
    else if (lpfl->id == sel.id) {
      bVar4 = true;
    }
  }
  if (bVar4) {
    if (i < cFleet) {
      pscan->ifl = i;
      pscan->grobj = grobjFleet;
    }
    else if (((sel.grobjFull & grobjPlanet) == grobjNone) ||
            (sel.pl.iPlayer != idPlayer)) {
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar1 = ((FLEET **)rglpfl)[i];
        iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
        if (((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) ||
           ((((pscan->pt).x == (&pFVar1->pt)->x && ((pscan->pt).y == (pFVar1->pt).y)) &&
            ((fOnlyOurs == 0 || (pFVar1->iPlayer == idPlayer)))))) break;
      }
      if ((cFleet <= i) || (lpfl->id == sel.id)) {
        return 0;
      }
      pscan->ifl = i;
      pscan->grobj = grobjFleet;
    }
    else {
      pscan->grobj = grobjPlanet;
      pscan->idpl = sel.pl.id;
    }
    sVar3 = 1;
  }
  else {
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: FindDlg
// Address: 1058:9286
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short FindDlg(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  short sVar1;
  char *sz;
  HWND HVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar3;
  ushort in_stack_0000ffcc;
  char szName [42];
  
  if (msg == 0x14) {
    GetClientRect(hwnd,&stack0xffcc);
    FillRect(wParam,&stack0xffcc,hbrButtonFace);
    return 1;
  }
  if (msg == 0x19) {
    uVar3 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffcc);
    if ((int)uVar3 == 6) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return hbrButtonFace;
    }
  }
  else {
    if (msg == 0x110) {
      StickyDlgPos(hwnd,(POINT *)&ptStickyFindDlg,1);
      SendDlgItemMessage(hwnd,0x10c,0x415,0x27,0);
      return 1;
    }
    if (msg == 0x111) {
      if ((wParam == 1) || (wParam == 2)) {
        if (wParam == 1) {
          GetDlgItemText(hwnd,0x10c,szName,0x28);
          sVar1 = FSelectSz(szName);
          if (sVar1 == 0) {
            sVar1 = 0x10;
            sz = PszFormatIds(idsSorryCantFindPlanetFleetName,(short *)0x0);
            AlertSz(sz,sVar1);
            HVar2 = GetDlgItem(hwnd,0x10c);
            SetFocus(HVar2);
            SendDlgItemMessage(hwnd,0x10c,0x401,0,-0x10000);
            return 0;
          }
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyFindDlg,0);
        EndDialog(hwnd,(uint)(wParam == 1));
        return 1;
      }
      if (wParam == 0x76) {
        WinHelp(hwnd,_szHelpFile,1,0x43d);
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: FSelectSz
// Address: 1058:945a
// Segment: MEMORY_SCAN
// ======================================================================


short FSelectSz(char *szName)

{
  FLEET *pFVar1;
  int iVar2;
  POINT pt;
  POINT pt_00;
  POINT pt_01;
  POINT pt_02;
  ushort uVar3;
  short sVar4;
  char *pcVar5;
  undefined2 uVar6;
  char *pcVar7;
  SCAN scan;
  short iplPartial;
  char szT [20];
  short cch;
  short ipl;
  FLEET *lpfl;
  short ifl;
  char *pch;
  
  iplPartial = -1;
  scan.iwp = -1;
  for (ipl = 0; ipl < game.cPlanMax; ipl = ipl + 1) {
    pcVar7 = szName;
    pcVar5 = PszGetCompressedPlanet(((short *)rgidPlan)[ipl]);
    sVar4 = __strcmpi(pcVar5,pcVar7);
    if (sVar4 == 0) break;
    if (iplPartial == -1) {
      uVar3 = _strlen(szName);
      pcVar7 = szName;
      pcVar5 = PszGetCompressedPlanet(((short *)rgidPlan)[ipl]);
      sVar4 = __strnicmp(pcVar5,pcVar7,uVar3);
      if (sVar4 == 0) {
        iplPartial = ipl;
      }
    }
  }
  do {
    if (ipl != game.cPlanMax) {
      pt.y = *(short *)((int)&rgptPlan[0].y + ipl * 4);
      pt.x = ((POINT *)rgptPlan + ipl)->x;
      FFindNearestObject(pt,grobjPlanet,&scan);
      ChangeScanSel(&scan,1);
      pt_00.y = scan.pt.y;
      pt_00.x = scan.pt.x;
      FEnsurePointOnScreen(pt_00,1);
      UpdateWindow(hwndScanner);
      SendMessage(hwndScanner,0x102,0x76,0);
      return 1;
    }
    cch = CchGetString(idsFleet,szT);
    sVar4 = __strnicmp(szName,szT,cch);
    if (sVar4 == 0) {
      pch = szName + 6;
    }
    else {
      pch = szName;
    }
    for (; *pch == ' '; pch = pch + 1) {
    }
    if (*pch == '#') {
      pch = pch + 1;
    }
    for (; *pch == ' '; pch = pch + 1) {
    }
    if (('0' < *pch) && (*pch < ':')) {
      ifl = *pch + -0x30;
      pch = pch + 1;
      do {
        if ((*(byte *)(*pch + 0x175f) & 4) == 0) {
          ifl = ifl - 1U | idPlayer << 9;
          lpfl = LpflFromId(ifl);
          if (((FLEET *)lpfl != (FLEET *)0x0) || ((int)((ulong)lpfl >> 0x10) != 0))
          goto SCAN_LFoundFleetId;
          break;
        }
        ifl = ifl * 10 + (int)*pch + -0x30;
        pch = pch + 1;
      } while (ifl < 0x201);
    }
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar1 = ((FLEET **)rglpfl)[ifl];
      iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
      if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
      pcVar7 = szName;
      pcVar5 = PszGetFleetName(lpfl->id);
      sVar4 = __strcmpi(pcVar5,pcVar7);
      if (sVar4 == 0) {
SCAN_LFoundFleetId:
        uVar6 = (undefined2)((ulong)lpfl >> 0x10);
        pt_01.y = (((FLEET *)lpfl)->pt).y;
        pt_01.x = (&((FLEET *)lpfl)->pt)->x;
        FFindNearestObject(pt_01,grobjFleet,&scan);
        scan.ifl = IflFromLpfl(lpfl);
        ChangeScanSel(&scan,2);
        pt_02.y = scan.pt.y;
        pt_02.x = scan.pt.x;
        FEnsurePointOnScreen(pt_02,1);
        UpdateWindow(hwndScanner);
        SendMessage(hwndScanner,0x102,0x76,0);
        return 1;
      }
    }
    if (iplPartial == -1) {
      return 0;
    }
    ipl = iplPartial;
  } while( true );
}



// ======================================================================
// Function: GetScanFleetOrientation
// Address: 1058:978c
// Segment: MEMORY_SCAN
// ======================================================================


void GetScanFleetOrientation(FLEET *lpfl,POINT *ppt,POINT *pptD)

{
  FLEET *pFVar1;
  undefined2 uVar2;
  short dx;
  short dy;
  
  uVar2 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar1 = (FLEET *)lpfl;
  if (pFVar1->iPlayer == idPlayer) {
    if ((1 < pFVar1->cord) && ((((PLORD *)pFVar1->lpplord + 7)->wFlags >> 4 & 0xf) != 0)) {
      dx = *(int *)&((PLORD *)pFVar1->lpplord)[5].iordMax - (&pFVar1->pt)->x;
      dy = ((PLORD *)pFVar1->lpplord + 6)->wFlags - (pFVar1->pt).y;
      goto LAB_1058_985e;
    }
  }
  else if (((*(uint *)((int)&pFVar1->dirLong + 2) >> 4 & 1) != 0) &&
          ((*(uint *)((int)&pFVar1->dirLong + 2) & 0xf) != 0)) {
    dx = (*(uint *)&pFVar1->dirLong & 0xff) - 0x7f;
    dy = (*(uint *)&pFVar1->dirLong >> 8) - 0x7f;
    goto LAB_1058_985e;
  }
  dy = 0;
  dx = 0;
LAB_1058_985e:
  GetDxDyOrientation(dx,dy,ppt,pptD);
  return;
}



// ======================================================================
// Function: GetDxDyOrientation
// Address: 1058:987c
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: iBmp */

void GetDxDyOrientation(short dx,short dy,POINT *ppt,POINT *pptD)

{
  short sVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  double *pdVar2;
  long lVar3;
  long local_1e;
  long local_16;
  short iBmp;
  double dbl;
  
  iBmp = 0;
  if ((dx != 0) || (dy != 0)) {
    local_16 = (long)dx;
    local_1e = (long)dy;
    pdVar2 = _atan2(SUB84((double)local_1e,0),
                            (double)CONCAT44(SUB84((double)local_16,0),
                                             (long)((qword)(double)local_1e >> 0x20)),
                            (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)
                                                  local_16 >> 0x20))));
    lVar3 = __ftol((double)((sqword)(DOUBLE_0_5__1120_1cf2 +
                                            (DOUBLE_4_0__1120_1d12 *
                                            (DOUBLE_3_1415927__1120_1d0a + *(double *)pdVar2)) /
                                            DOUBLE_3_141592654__1120_1d1a) << 0x10));
    iBmp = 9 - ((uint)lVar3 & 7) & 7;
  }
  if (iScanZoom < 0) {
    sVar1 = 7;
  }
  else {
    sVar1 = 9;
  }
  pptD->y = sVar1;
  pptD->x = sVar1;
  if (iScanZoom < 0) {
    ppt->x = 0;
  }
  else {
    ppt->x = 7;
  }
  ppt->y = iBmp * pptD->y;
  return;
}



// ======================================================================
// Function: FHandleMeasuringTape
// Address: 1058:9974
// Segment: MEMORY_SCAN
// ======================================================================


short FHandleMeasuringTape(SCAN *pscan,POINT pt)

{
  short sVar1;
  uint uVar2;
  undefined2 unaff_SS;
  POINT pt_00;
  RECT rc;
  SCAN scan;
  short fVirgin;
  char szT [20];
  POINT ptNew;
  short iropSav;
  POINT ptBase;
  POINT ptLogical;
  short grTypeIn;
  uint ptLogLast;
  uint local_16;
  SBAR sbar;
  HPEN hpenSav;
  HDC hdc;
  
  fVirgin = 1;
  ptLogLast = (pscan->pt).x;
  local_16 = (pscan->pt).y;
  ptBase.x = (pscan->pt).x;
  ptBase.y = (pscan->pt).y;
  LogicalToScan(&ptBase);
  GetClientRect(hwndScanner,&rc);
  rc.bottom = rc.bottom - dySBar;
  hdc = GetDC(hwndScanner);
  SetCapture(hwndScanner);
  sbar.pscan = pscan;
  hpenSav = SelectObject(hdc,hpenShip);
  iropSav = SetROP2(hdc,7);
  ptNew.x = pt.x;
  ptNew.y = pt.y;
  LogicalToScan(&ptNew);
LAB_1058_9a11:
  do {
    sVar1 = FGetRMouseMove(&ptNew);
    if (sVar1 == 0) {
      if (fVirgin == 0) {
        MoveTo(hdc,ptBase.x,ptBase.y);
        LineTo(hdc,pt.x,pt.y);
      }
      SetROP2(hdc,iropSav);
      SelectObject(hdc,hpenSav);
      DrawScannerSBar(hdc,(RECT *)0x0,(SBAR *)0x0,0);
      ReleaseCapture();
      ReleaseDC(hwndScanner,hdc);
      return (uint)(fVirgin == 0);
    }
    uVar2 = rc.right;
    if (ptNew.x <= rc.right) {
      uVar2 = ptNew.x;
    }
    if (uVar2 < 0x8000) {
      ptLogical.x = rc.right;
      if (ptNew.x <= rc.right) {
        ptLogical.x = ptNew.x;
      }
    }
    else {
      ptLogical.x = 0;
    }
    uVar2 = rc.bottom;
    if (ptNew.y <= rc.bottom) {
      uVar2 = ptNew.y;
    }
    if (uVar2 < 0x8000) {
      ptLogical.y = rc.bottom;
      if (ptNew.y <= rc.bottom) {
        ptLogical.y = ptNew.y;
      }
    }
    else {
      ptLogical.y = 0;
    }
    ptNew.x = ptLogical.x;
    ptNew.y = ptLogical.y;
    ScanToLogical(&ptLogical);
    uVar2 = GetAsyncKeyState(0x10);
    if ((uVar2 & 0xfffe) == 0) {
      grTypeIn = 0x4f;
    }
    else {
      grTypeIn = 0x8f;
    }
    pt_00.y = ptLogical.y;
    pt_00.x = ptLogical.x;
    sVar1 = FFindNearestObject(pt_00,grTypeIn,&scan);
    if (sVar1 != 0) {
      ptLogical.x = scan.pt.x;
      ptLogical.y = scan.pt.y;
    }
  } while ((ptLogLast == ptLogical.x) && (local_16 == ptLogical.y));
  ptNew.x = ptLogical.x;
  ptNew.y = ptLogical.y;
  LogicalToScan(&ptNew);
  if (fVirgin != 0) goto LAB_1058_9b36;
  MoveTo(hdc,ptBase.x,ptBase.y);
  LineTo(hdc,pt.x,pt.y);
  goto LAB_1058_9b8b;
LAB_1058_9b36:
  sVar1 = _abs(ptLogical.x - ptLogLast);
  if ((2 < sVar1) || (sVar1 = _abs(ptLogical.y - local_16), 2 < sVar1)) {
    fVirgin = 0;
LAB_1058_9b8b:
    MoveTo(hdc,ptBase.x,ptBase.y);
    LineTo(hdc,ptNew.x,ptNew.y);
    if (scan.grobj == grobjNone) {
      sbar.id = 0xffff;
      CchGetString(idsDeepSpace,szT);
      sbar.psz = szT;
    }
    else {
      if (scan.grobj == grobjPlanet) {
        sbar.id = scan.idpl;
      }
      else if (scan.grobj == grobjFleet) {
        sbar.id = ((FLEET **)rglpfl)[scan.ifl]->id;
      }
      else if (scan.grobj == grobjThing) {
        sbar.id = ((THING *)lpThings + scan.ith)->idFull;
      }
      else {
        sbar.id = scan.iwp;
      }
      sbar.psz = (char *)0x0;
    }
    sbar.pt.x = ptLogical.x;
    sbar.pt.y = ptLogical.y;
    sbar.grbit = scan.grobj;
    DrawScannerSBar(hdc,(RECT *)0x0,&sbar,0);
    pt.y = ptNew.y;
    pt.x = ptNew.x;
    ptLogLast = ptLogical.x;
    local_16 = ptLogical.y;
  }
  goto LAB_1058_9a11;
}



