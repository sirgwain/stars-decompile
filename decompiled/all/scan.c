// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
//

// ======================================================================
// Function: ScannerWndProc
// Address: 1058:0032
// Segment: MEMORY_SCAN
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x105809f8) */
/* WARNING: Removing unreachable block (ram,0x1058094a) */
/* WARNING: Removing unreachable block (ram,0x1058014f) */

long ScannerWndProc(HWND hwnd, WMType msg, ushort wParam, long lParam)

{
    int         iVar1;
    int         iVar2;
    FLEET      *pFVar3;
    POINT       PVar4;
    POINT       PVar5;
    POINT       pt_00;
    POINT       ptIn;
    POINT       pt_01;
    POINT       pt_02;
    POINT       pt_03;
    HDC         HVar6;
    BOOL        BVar7;
    short       sVar8;
    uint        uVar9;
    HCURSOR     HVar10;
    GrobjClass  grobj;
    undefined1 *puVar11;
    undefined1 *puVar12;
    undefined1 *puVar13;
    undefined1 *puVar14;
    undefined2  unaff_SI;
    undefined2  unaff_DI;
    undefined2  uVar15;
    undefined2  unaff_SS;
    bool        bVar16;
    DWORD       DVar17;
    ulong       uVar18;
    LRESULT     LVar19;
    short       dy;
    ushort      in_stack_0000fdda;
    short       id;
    THING      *lpthMac;
    short       iSel;
    short       iChecked;
    long        rgid[100];
    short       fSep;
    FLEET      *lpfl;
    THING      *lpth;
    short       c;
    short       i;
    SCAN        scan;
    short       fChgScan;
    PLANET      local_6a;
    RECT        rc;
    PAINTSTRUCT ps;
    POINT       pt;
    HDC         hdc;

    uVar15 = 0x1058;
    puVar14 = &stack0xfdd6;
    uVar18 = CONCAT22(unaff_SI, unaff_DI);
    if (msg == WM_CREATE) {
        yScanTop = 1000;
        xScanTop = 1000;
        return 0;
    }
    if (msg == WM_SIZE) {
        SetScanScrollBars(hwnd);
        uVar15 = 0x14f8;
        PostMessage(hwndFrame, WM_COMMAND, iScanZoom + 0xf41, 0);
        puVar14 = &stack0xfdd6;
    SCAN_Default_2:
        *(HWND *)(puVar14 + -2) = hwnd;
        *(WMType *)(puVar14 + -4) = msg;
        *(ushort *)(puVar14 + -6) = wParam;
        *(undefined2 *)(puVar14 + -8) = lParam._2_2_;
        *(int *)(puVar14 + -10) = (int)lParam;
        *(undefined2 *)(puVar14 + -0xc) = uVar15;
        *(undefined2 *)(puVar14 + -0xe) = 0xe81;
        LVar19 = DefWindowProc(*(HWND *)(puVar14 + -2), *(UINT *)(puVar14 + -4), *(WPARAM *)(puVar14 + -6), *(LPARAM *)(puVar14 + -10));
        return LVar19;
    }
    if (msg == WM_PAINT) {
        HVar6 = BeginPaint(hwnd, &ps);
        if ((((FLEET **)rglpfl != (FLEET **)0x0) || (rglpfl._2_2_ != 0)) && (((uint)gd.grBits2 & 1) == 0)) {
            GetClientRect(hwnd, &rc);
            DrawScannerSBar(HVar6, &ps.rcPaint, (SBAR *)0x0, 1);
            rc.bottom = rc.bottom - dySBar;
            DrawScanner(HVar6, &ps.rcPaint);
        }
        EndPaint(hwnd, &ps);
        return 0;
    }
    if (msg != WM_SETCURSOR) {
        if (msg == WM_CHAR) {
            if ((wParam == 0x76) || (wParam == 0x56)) {
                HVar6 = GetDC(hwndScanner);
                pt.x = sel.scan.pt.x;
                pt.y = sel.scan.pt.y;
                LogicalToScan(&pt);
                local_6a.turn = SetROP2(HVar6, 7);
                local_6a.lpplprod._0_2_ = (PLPROD *)SelectObject(HVar6, hpenYellow);
                for (local_6a.wRouting = 0; (int)local_6a.wRouting < 2; local_6a.wRouting = local_6a.wRouting + 1) {
                    MoveTo(HVar6, pt.x + -300, pt.y + -300);
                    LineTo(HVar6, pt.x + 300, pt.y + 300);
                    MoveTo(HVar6, pt.x + -300, pt.y + 300);
                    LineTo(HVar6, pt.x + 300, pt.y + -300);
                    if (local_6a.wRouting == 0) {
                        DVar17 = GetTickCount();
                        local_6a.lStarbase = DVar17;
                        while (true) {
                            DVar17 = GetTickCount();
                            if (local_6a.lStarbase + 0x96U <= DVar17)
                                break;
                            Yield();
                        }
                    }
                }
                SelectObject(HVar6, (HGDIOBJ)(PLPROD *)local_6a.lpplprod);
                SetROP2(HVar6, local_6a.turn);
                ReleaseDC(hwndScanner, HVar6);
            } else {
                if (wParam == 0x2d) {
                    local_6a.lpplprod._2_2_ = iScanZoom + -1;
                    if ((int)local_6a.lpplprod._2_2_ < -4) {
                        local_6a.lpplprod._2_2_ = -4;
                    }
                } else {
                    local_6a.lpplprod._2_2_ = iScanZoom + 1;
                    if (4 < (int)local_6a.lpplprod._2_2_) {
                        local_6a.lpplprod._2_2_ = 4;
                    }
                }
                if (local_6a.lpplprod._2_2_ != iScanZoom) {
                    SendMessage(hwndFrame, WM_COMMAND, local_6a.lpplprod._2_2_ + 0xf41, 0);
                }
            }
        } else if ((msg == WM_HSCROLL) || (msg == WM_VSCROLL)) {
            switch (wParam) {
            case 0:
                local_6a.lpplprod._2_2_ = -dScanInc;
                break;
            case 1:
                local_6a.lpplprod._2_2_ = dScanInc;
                break;
            case 2:
                local_6a.lpplprod._2_2_ = -dScanPage;
                break;
            case 3:
                local_6a.lpplprod._2_2_ = dScanPage;
                break;
            case 4:
            case 5:
                sVar8 = yScanTop;
                if (msg != WM_VSCROLL) {
                    sVar8 = xScanTop;
                }
                local_6a.lpplprod._2_2_ = (int)lParam - sVar8 & 0xfffc;
                break;
            default:
                local_6a.lpplprod._2_2_ = 0;
            }
            if (local_6a.lpplprod._2_2_ != 0) {
                if (msg == WM_VSCROLL) {
                    local_6a.lpplprod._0_2_ = (PLPROD *)yScanTop;
                    SetScrollPos(hwnd, 1, yScanTop + local_6a.lpplprod._2_2_, 1);
                    yScanTop = GetScrollPos(hwnd, 1);
                    sVar8 = PtToScan((int)(PLPROD *)local_6a.lpplprod - yScanTop);
                    ScrollScanner(0, sVar8);
                } else {
                    local_6a.lpplprod._0_2_ = (PLPROD *)xScanTop;
                    SetScrollPos(hwnd, 0, xScanTop + local_6a.lpplprod._2_2_, 1);
                    xScanTop = GetScrollPos(hwnd, 0);
                    dy = 0;
                    sVar8 = PtToScan((int)(PLPROD *)local_6a.lpplprod - xScanTop);
                    ScrollScanner(sVar8, dy);
                }
            }
        } else if ((((msg == WM_LBUTTONDOWN) || (msg == WM_LBUTTONDBLCLK)) || (msg == WM_RBUTTONDOWN)) || (msg == WM_MBUTTONDOWN)) {
            SetFocus(hwndFrame);
            pt.x = (int)lParam;
            uVar18 = __aFulshr(uVar18, in_stack_0000fdda);
            pt.y = (short)uVar18;
            GetClientRect(hwnd, &rc);
            if (pt.y < rc.bottom - dySBar) {
                ScanToLogical(&pt);
                if (((gd.grBits._2_2_ >> 8 & 1) == 0) && ((gd.grBits._2_2_ >> 0xd & 1) == 0)) {
                    grobj = grobjThing | grobjOther | grobjFleet | grobjPlanet;
                } else {
                    grobj = grobjPlanet;
                }
                pt_00.y = pt.y;
                pt_00.x = pt.x;
                FFindNearestObject(pt_00, grobj, &scan);
                if ((((gd.grBits._2_2_ >> 8 & 1) == 0) &&
                     (((sel.grobj != grobjPlanet || ((wParam & 4) == 0)) || (sVar8 = IWarpMAFromLppl(&sel.pl, (short *)0x0), sVar8 < 1)))) ||
                    (msg != WM_LBUTTONDOWN)) {
                    if ((((gd.grBits._2_2_ >> 0xd & 1) == 0) && ((sel.grobj != grobjPlanet || ((wParam & 8) == 0)))) || (msg != WM_LBUTTONDOWN)) {
                        if ((msg == WM_MBUTTONDOWN) || ((msg == WM_RBUTTONDOWN && ((wParam & 4) != 0)))) {
                            pt_02.y = pt.y;
                            pt_02.x = pt.x;
                            FHandleMeasuringTape(&scan, pt_02);
                        } else {
                            if (msg == WM_RBUTTONDOWN) {
                                iChecked = -1;
                                pt.x = scan.pt.x;
                                pt.y = scan.pt.y;
                                if ((scan.grobjFull & grobjPlanet) == grobjNone) {
                                    c = 0;
                                } else {
                                    rgid[0]._2_2_ = scan.idpl >> 0xf;
                                    rgid[0]._0_2_ = scan.idpl;
                                    rgid[1]._0_2_ = 0xffff;
                                    rgid[1]._2_2_ = 0xffff;
                                    c = 2;
                                    if ((sel.grobj == grobjPlanet) && (sel.id == scan.idpl)) {
                                        iChecked = 0;
                                    }
                                }
                                for (i = 0; i < cFleet; i = i + 1) {
                                    /* WARNING: Load size is inaccurate */
                                    pFVar3 = ((FLEET **)rglpfl)[i];
                                    iVar1 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                                    lpfl = (FLEET *)CONCAT22(iVar1, pFVar3);
                                    if ((pFVar3 == (FLEET *)0x0) && (iVar1 == 0))
                                        break;
                                    if ((pt.x == (&pFVar3->pt)->x) && (pt.y == (pFVar3->pt).y)) {
                                        if ((sel.grobj == grobjFleet) && (lpfl->id == sel.id)) {
                                            iChecked = c;
                                        }
                                        iVar2 = lpfl->id;
                                        iVar1 = c + 1;
                                        *(int *)(rgid + c) = iVar2;
                                        *(uint *)((int)rgid + c * 4 + 2) = iVar2 >> 0xf | 0x8000;
                                        c = iVar1;
                                        if (0x61 < iVar1)
                                            break;
                                    }
                                }
                                if ((c == 2) && ((scan.grobjFull & grobjPlanet) != grobjNone)) {
                                    c = 1;
                                }
                                bVar16 = c == 0;
                                lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
                                while ((THING *)lpth < (THING *)lpThings + cThing) {
                                    uVar15 = (undefined2)((ulong)lpth >> 0x10);
                                    if ((pt.x == (&((THING *)lpth)->pt)->x) && (pt.y == (((THING *)lpth)->pt).y)) {
                                        if (!bVar16) {
                                            *(undefined2 *)(rgid + c) = 0xffff;
                                            *(undefined2 *)((int)rgid + c * 4 + 2) = 0xffff;
                                            bVar16 = true;
                                            c = c + 1;
                                        }
                                        iVar1 = c + 1;
                                        *(ushort *)(rgid + c) = lpth->idFull;
                                        *(undefined2 *)((int)rgid + c * 4 + 2) = 0x2000;
                                        c = iVar1;
                                        if (99 < iVar1)
                                            break;
                                    }
                                    lpth = (THING *)CONCAT22(uVar15, (THING *)lpth + 1);
                                }
                                LogicalToScan(&pt);
                                sVar8 = PopupMenu(hwnd, pt.x, pt.y, c, rgid, (char **)0x0, iChecked, 1);
                                if (sVar8 < 0) {
                                    return 0;
                                }
                                if ((*(uint *)((int)rgid + sVar8 * 4 + 2) & 0x8000) == 0) {
                                    if ((*(uint *)((int)rgid + sVar8 * 4 + 2) & 0x2000) == 0) {
                                        scan.grobj = grobjPlanet;
                                    } else {
                                        scan.grobj = grobjThing;
                                        lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
                                        while (((THING *)lpth < (THING *)lpThings + cThing && (lpth->idFull != *(ushort *)(rgid + sVar8)))) {
                                            lpth = (THING *)lpth + 1;
                                        }
                                        scan.ith = ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12;
                                    }
                                } else {
                                    scan.grobj = grobjFleet;
                                    for (i = 0; i < cFleet; i = i + 1) {
                                        /* WARNING: Load size is inaccurate */
                                        pFVar3 = ((FLEET **)rglpfl)[i];
                                        iVar1 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                                        lpfl = (FLEET *)CONCAT22(iVar1, pFVar3);
                                        if (((pFVar3 == (FLEET *)0x0) && (iVar1 == 0)) || (lpfl->id == (int)rgid[sVar8]))
                                            break;
                                    }
                                    scan.ifl = i;
                                }
                                ChangeScanSel(&scan, 2);
                                if (scan.grobj == grobjPlanet) {
                                    sVar8 = FLookupPlanet(scan.idpl, &local_6a);
                                    if (sVar8 == 0) {
                                        return 0;
                                    }
                                    if (local_6a.iPlayer != idPlayer) {
                                        return 0;
                                    }
                                }
                            } else {
                                if ((sel.grobj == grobjFleet) && (((wParam & 4) != 0 || ((grbitScan & 0x10) != 0)))) {
                                    ptIn.y = pt.y;
                                    ptIn.x = pt.x;
                                    FAddWayPoint(ptIn, &scan);
                                    return 0;
                                }
                                if ((scan.pt.x == sel.scan.pt.x) && (scan.pt.y == sel.scan.pt.y)) {
                                    bVar16 = true;
                                } else {
                                    bVar16 = false;
                                }
                                ChangeScanSel(&scan, 1);
                                pt_01.y = pt.y;
                                pt_01.x = pt.x;
                                sVar8 = FNearAWayPoint(pt_01, 1);
                                if ((sVar8 != 0) && (pt_03.y = pt.y, pt_03.x = pt.x, sVar8 = FHandleWayPointDrag(pt_03), sVar8 != 0)) {
                                    return 0;
                                }
                                if (!bVar16) {
                                    return 0;
                                }
                                if ((scan.grobj != grobjFleet) && (scan.grobj != grobjPlanet)) {
                                    return 0;
                                }
                                if ((scan.pt.x == sel.pt.x) && (scan.pt.y == sel.pt.y)) {
                                    sVar8 = FGetNextObjHere(&scan, 1);
                                    if (sVar8 == 0) {
                                        return 0;
                                    }
                                } else if (scan.grobj == grobjPlanet) {
                                    sVar8 = FLookupPlanet(scan.idpl, &local_6a);
                                    if (sVar8 == 0) {
                                        return 0;
                                    }
                                    if ((local_6a.iPlayer != idPlayer) ||
                                        ((((scan.grobjFull & grobjFleet) != grobjNone && (sel.grobj == grobjPlanet)) && (scan.idpl == sel.id)))) {
                                        if ((scan.grobjFull & grobjFleet) == grobjNone) {
                                            return 0;
                                        }
                                        scan.grobj = grobjFleet;
                                    }
                                }
                            }
                            if (((scan.grobj != grobjFleet) || (((FLEET *)((FLEET **)rglpfl)[scan.ifl])->iPlayer == idPlayer)) && (scan.grobj != grobjThing)) {
                                if (scan.grobj == grobjFleet) {
                                    scan.iwp = -1;
                                }
                                ChangeScanSel(&scan, 1);
                                RedrawScanSel(0, 0);
                                if (scan.grobj != grobjPlanet) {
                                    scan.idpl = ((FLEET **)rglpfl)[scan.ifl]->id;
                                }
                                ChangeMainObjSel(scan.grobj, scan.idpl);
                                RedrawScanSel(0, 1);
                                if ((scan.grobj == grobjFleet) && ((scan.grobjFull & grobjPlanet) != grobjNone)) {
                                    scan.grobj = grobjPlanet;
                                    ChangeScanSel(&scan, 1);
                                }
                            }
                        }
                    } else {
                        DrawShipScanPath(0, 0);
                        if (scan.idpl == sel.pl.id) {
                            sel.pl.wRouting = sel.pl.wRouting & 0xfc00;
                        } else {
                            sel.pl.wRouting = sel.pl.wRouting & 0xfc00 | scan.idpl + 1U & 0x3ff;
                        }
                        FLookupPlanet(-1, (PLANET *)&sel.pl);
                        gd.grBits._2_2_ = gd.grBits._2_2_ & 0xdfff;
                        DrawShipScanPath(0, 1);
                        DrawPlanShip(0, 0x4040);
                    }
                } else {
                    DrawShipScanPath(0, 0);
                    if (scan.idpl == sel.pl.id) {
                        sel.pl.lStarbase._2_2_ = sel.pl.lStarbase._2_2_ & 0xfc00;
                    } else {
                        sel.pl.lStarbase._2_2_ = sel.pl.lStarbase._2_2_ & 0xfc00 | scan.idpl + 1U & 0x3ff;
                    }
                    FLookupPlanet(-1, (PLANET *)&sel.pl);
                    gd.grBits._2_2_ = gd.grBits._2_2_ & 0xfeff;
                    DrawShipScanPath(0, 1);
                    DrawPlanShip(0, 0x4100);
                }
            } else if (((msg == WM_LBUTTONDOWN) && (pt.y < rc.bottom - (dySBar >> 1))) && ((sel.scan.grobjFull & (grobjFleet | grobjPlanet)) != grobjNone)) {
                if (sel.scan.grobj == grobjFleet) {
                    GlobalPD.grPopup = 3;
                    GlobalPD.u_POPUPDATA_0x0002.part.hs.grhst = *(undefined2 *)((FLEET **)rglpfl + sel.scan.ifl);
                    GlobalPD.u_POPUPDATA_0x0002.part.hs.wFlags_0x2 = *(ushort *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
                } else {
                    GlobalPD.grPopup = 4;
                }
                Popup(hwnd, pt.x, pt.y);
            }
        } else {
            if (msg != WM_MDIACTIVATE)
                goto SCAN_Default_2;
            hwndActive = hwnd;
            if (wParam == 0) {
                hwndActive = 0;
            }
        }
        return 0;
    }
    GetCursorPos(&pt);
    ScreenToClient(hwndScanner, &pt);
    GetClientRect(hwnd, &rc);
    uVar15 = 0x14f8;
    PVar4.y = pt.y;
    PVar4.x = pt.x;
    BVar7 = PtInRect(&rc, PVar4);
    puVar14 = &stack0xfdd2;
    if (BVar7 == 0)
        goto SCAN_Default_2;
    rc.bottom = rc.bottom - dySBar;
    PVar5.y = pt.y;
    PVar5.x = pt.x;
    BVar7 = PtInRect(&rc, PVar5);
    puVar13 = &stack0xfdd2;
    if (BVar7 == 0) {
        HVar10 = LoadCursor(0, (LPCSTR)0x7f00);
        SetCursor(HVar10);
        return 1;
    }
    if (sel.grobj == grobjFleet) {
        uVar9 = GetAsyncKeyState(0x10);
        puVar13 = &stack0xfdd0;
        if (((uVar9 & 0xfffe) != 0) || ((grbitScan & 0x10) != 0)) {
            SetCursor(hcurScanAdd);
            return 1;
        }
    }
    *(undefined2 *)(puVar13 + -2) = 0;
    *(short *)(puVar13 + -4) = pt.y;
    *(short *)(puVar13 + -6) = pt.x;
    *(undefined2 *)(puVar13 + -8) = 0x14f8;
    uVar15 = 0x1058;
    *(undefined2 *)(puVar13 + -10) = 0x321;
    sVar8 = FNearAWayPoint(*(puVar13 + -6), *(short *)(puVar13 + -2));
    if (sVar8 != 0) {
        *(HCURSOR *)(puVar13 + -2) = hcurOpenGrab;
        *(undefined2 *)(puVar13 + -4) = 0x1058;
        *(undefined2 *)(puVar13 + -6) = 0x335;
        SetCursor(*(HCURSOR *)(puVar13 + -2));
        return 1;
    }
    puVar12 = puVar13;
    if (((gd.grBits._2_2_ >> 8 & 1) == 0) && ((gd.grBits._2_2_ >> 0xd & 1) == 0)) {
        if (sel.grobj == grobjPlanet) {
            *(undefined2 *)(puVar13 + -2) = 0x10;
            *(undefined2 *)(puVar13 + -4) = 0x1058;
            uVar15 = 0x14f8;
            *(undefined2 *)(puVar13 + -6) = 0x371;
            uVar9 = GetAsyncKeyState(*(short *)(puVar13 + -2));
            if ((uVar9 & 0xfffe) != 0) {
                *(undefined2 *)(puVar13 + -4) = 0;
                *(undefined2 *)(puVar13 + -6) = 0x1120;
                *(undefined2 *)(puVar13 + -8) = 0x49ee;
                *(undefined2 *)(puVar13 + -10) = 0x14f8;
                uVar15 = 0x1048;
                *(undefined2 *)(puVar13 + -0xc) = 0x38c;
                sVar8 = IWarpMAFromLppl(*(PLANET **)(puVar13 + -8), *(short **)(puVar13 + -4));
                puVar12 = puVar13 + -2;
                if (0 < sVar8)
                    goto LAB_1058_03ab;
            }
            *(undefined2 *)(puVar13 + -4) = 0x11;
            *(undefined2 *)(puVar13 + -6) = uVar15;
            uVar15 = 0x14f8;
            *(undefined2 *)(puVar13 + -8) = 0x3a0;
            uVar9 = GetAsyncKeyState(*(short *)(puVar13 + -4));
            puVar11 = puVar13 + -4;
            puVar13 = puVar13 + -4;
            puVar12 = puVar11;
            if ((uVar9 & 0xfffe) != 0)
                goto LAB_1058_03ab;
        }
        *(HCURSOR *)(puVar13 + -2) = hcurScanner;
        *(undefined2 *)(puVar13 + -4) = uVar15;
        *(undefined2 *)(puVar13 + -6) = 0x3c0;
        SetCursor(*(HCURSOR *)(puVar13 + -2));
    } else {
    LAB_1058_03ab:
        *(HCURSOR *)(puVar12 + -2) = hcurScanAdd;
        *(undefined2 *)(puVar12 + -4) = uVar15;
        *(undefined2 *)(puVar12 + -6) = 0x3b4;
        SetCursor(*(HCURSOR *)(puVar12 + -2));
    }
    return 1;
}

// ======================================================================
// Function: PtToScan
// Address: 1058:0efc
// Segment: MEMORY_SCAN
// ======================================================================

short PtToScan(short d)

{
    if (iScanZoom != 0) {
        switch (iScanZoom) {
        default:
            break;
        case 1:
            d = d * 5 >> 2;
            break;
        case 2:
            d = d * 3 >> 1;
            break;
        case 3:
            d = d << 1;
            break;
        case 4:
            d = d << 2;
            break;
        case -4:
            d = d >> 2;
            break;
        case -3:
            d = d * 3 >> 3;
            break;
        case -2:
            d = d >> 1;
            break;
        case -1:
            d = d * 3 >> 2;
        }
    }
    return d;
}

// ======================================================================
// Function: ScanToPt
// Address: 1058:0fc2
// Segment: MEMORY_SCAN
// ======================================================================

short ScanToPt(short d)

{
    if (iScanZoom != 0) {
        switch (iScanZoom) {
        default:
            break;
        case 1:
            d = (d << 2) / 5;
            break;
        case 2:
            d = (d << 1) / 3;
            break;
        case 3:
            d = d >> 1;
            break;
        case 4:
            d = d >> 2;
            break;
        case -4:
            d = d << 2;
            break;
        case -3:
            d = (d << 3) / 3;
            break;
        case -2:
            d = d << 1;
            break;
        case -1:
            d = (d << 2) / 3;
        }
    }
    return d;
}

// ======================================================================
// Function: DrawScanner
// Address: 1058:108a
// Segment: MEMORY_SCAN
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x105838a5) */
/* WARNING: Removing unreachable block (ram,0x10583928) */
/* WARNING: Removing unreachable block (ram,0x10581d7f) */
/* WARNING: Removing unreachable block (ram,0x1058118f) */
/* WARNING: Removing unreachable block (ram,0x10582bf0) */
/* WARNING: Removing unreachable block (ram,0x105841d5) */

short DrawScanner(HDC hdc, RECT *prc)

{
    short      sVar1;
    short      sVar2;
    short      sVar3;
    short      sVar4;
    char       cVar5;
    FLEET     *pFVar6;
    short      sVar7;
    uint       uVar8;
    uint       uVar9;
    HGDIOBJ    HVar10;
    int        dx_00;
    short      sVar11;
    short      sVar12;
    short      sVar13;
    int        iVar14;
    int        iVar15;
    int        iVar16;
    int        iVar17;
    int        iVar18;
    HDC        HVar19;
    short      sVar20;
    int        iVar21;
    HGDIOBJ    HVar22;
    HBRUSH     HVar23;
    HPEN       HVar24;
    HGDIOBJ    HVar25;
    HGDIOBJ    HVar26;
    int        iVar27;
    undefined2 uVar28;
    int       *piVar29;
    PLANET    *pPVar30;
    int        iVar31;
    THING     *pTVar32;
    int        iVar33;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 unaff_SS;
    bool       bVar34;
    bool       bVar35;
    COLORREF   CVar36;
    COLORREF   CVar37;
    PLANET    *pPVar38;
    long       lVar39;
    RECT      *pRVar40;
    undefined2 uVar41;
    HDC        HVar42;
    THING     *in_stack_0000f586;
    PLANET    *in_stack_0000f588;
    PLANET    *local_a76;
    DRAWCIR    local_a74;
    short      local_a5c[250];
    short      local_868[250];
    uint       local_674;
    short      local_672[240];
    THING     *local_492;
    PLANET    *local_490;
    THING     *local_48e;
    PLANET    *local_48c;
    undefined4 local_48a;
    undefined4 local_486;
    POINT      local_482;
    COLORREF   crBack;
    long       l;
    RECT       rc;
    POINT      ptOrigin;
    short      fDoDraw;
    short      xLeft;
    HBRUSH     hbrSav;
    short      dx;
    short      yMin;
    ushort     mdScanBase;
    short      fStargate;
    THING     *lpthMac;
    POINT      ptSelMain;
    short      fStarbase;
    short      fMA;
    short      fSelected;
    POINT      ptO;
    short      idP;
    short      dRange;
    RECT       rcDraw;
    short      yOff;
    RECT       rcClip;
    short      iord;
    HBITMAP    hbmpSav;
    short      xMin;
    short      i;
    FLEET     *lpfl;
    THING     *lpth;
    HDC        hdcMem;
    char       rgWhatsHere[999];
    short      yMax;
    PLANET    *lppl;
    HDC        hdcScreen;
    short      id2;
    HBITMAP    hbmpScreen;
    HBITMAP    hbmpXSav;
    short      dy;
    short      yBmp;
    PLANET    *lpplMac;
    POINT      ptD;
    short      iBkPrev;
    COLORREF   crFore;
    short      id;
    POINT      pt;
    short      xMax;
    short      yTop;
    short      j;
    FLEET     *lpflT;
    HPEN       hpenSav;
    short      dExpand;
    short      xOff;

    sVar7 = xScanTop;
    sVar20 = yScanTop;
    uVar8 = grbitScan & 0xf;
    hdcScreen = 0;
    hbmpScreen = 0;
    if (((((FLEET **)rglpfl != (FLEET **)0x0) || (rglpfl._2_2_ != 0)) && (((uint)gd.grBits2 & 1) == 0)) && (((uint)gd.grBits >> 1 & 1) == 0)) {
        uVar9 = PtToScan(4000 - xScanTop);
        ptOrigin.x = uVar9 & 7;
        uVar9 = PtToScan(4000 - yScanTop);
        ptOrigin.y = uVar9 & 7;
        GetClientRect(hwndScanner, &rc);
        ExcludeClipRect(hdc, 0, rc.bottom - dySBar, rc.right, rc.bottom);
        l._0_2_ = prc->right - prc->left;
        l._2_2_ = (int)l >> 0xf;
        l = __aFulmul((long)(int)l, (long)(prc->bottom - prc->top));
        if (l < 48000) {
            HVar19 = CreateCompatibleDC(hdc);
            if (HVar19 != 0) {
                hbmpScreen = CreateCompatibleBitmap(hdc, prc->right - (prc->left & 0xfff8U), prc->bottom - (prc->top & 0xfff8U));
                if (hbmpScreen == 0) {
                    DeleteDC(HVar19);
                }
            }
            if (hbmpScreen != 0) {
                hdcScreen = hdc;
                hbmpXSav = SelectObject(HVar19, hbmpScreen);
                SetWindowOrg(HVar19, prc->left & 0xfff8, prc->top & 0xfff8);
                pt.y = 0;
                pt.x = 0;
                ClientToScreen(hwndScanner, &pt);
                ptOrigin.x = (ptOrigin.x + 8U) - (pt.x & 7U) & 7;
                ptOrigin.y = (ptOrigin.y + 8U) - (pt.y & 7U) & 7;
                hdc = HVar19;
            }
        }
        uVar41 = 0x1120;
        pRVar40 = prc;
        HVar19 = hdc;
        HVar10 = GetStockObject(4);
        FillRect(HVar19, (RECT *)CONCAT22(uVar41, pRVar40), HVar10);
        sVar1 = prc->left;
        sVar2 = prc->top;
        sVar3 = prc->right;
        sVar4 = prc->bottom;
        if (((iScanZoom < 3) || (uVar8 != 4)) && ((iScanZoom < 0 || ((uVar8 != 1 && (uVar8 != 2)))))) {
            dx_00 = 9;
        } else {
            dx_00 = 0x14;
        }
        ExpandRc(prc, dx_00, dx_00);
        prc->bottom = prc->bottom + 0xe;
        sVar11 = ScanToPt(prc->right - prc->left);
        sVar12 = ScanToPt(prc->bottom - prc->top);
        sVar13 = ScanToPt(prc->left);
        iVar14 = sVar13 + sVar7;
        iVar15 = iVar14 + sVar11;
        sVar11 = ScanToPt(prc->top);
        iVar27 = (dGalInv - sVar20) - sVar11;
        iVar16 = iVar27 - sVar12;
        iVar17 = -sVar7;
        iVar18 = dGalInv - sVar20;
        id = 1;
        for (i = 0; i < 0x10; i = i + 1) {
            if ((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) != 0) {
                grbitScanShip = grbitScanShip & ~(id & grbitScanShip);
            }
            id = id << 1;
        }
        HVar19 = CreateCompatibleDC(hdc);
        HVar10 = SelectObject(HVar19, hbmpScanner);
        if (sel.grobj == grobjNone) {
            ptSelMain.y = -2;
            ptSelMain.x = -2;
        } else {
            ptSelMain.x = sel.pt.x;
            ptSelMain.y = sel.pt.y;
        }
        if (((uint)gd.grBits2 >> 10 & 1) == 0) {
            LinkFleets(0);
        } else {
            for (i = 0; i < cFleet; i = i + 1) {
                iVar21 = *(int *)((FLEET **)rglpfl + i);
                iVar31 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                if ((iVar21 == 0) && (iVar31 == 0))
                    break;
                *(uint *)(iVar21 + 4) = *(uint *)(iVar21 + 4) & 0xf7ff;
            }
        }
        if ((grbitScan & 0x20) != 0) {
            local_674 = 0;
            local_a74.rgx = local_868;
            local_a74.rgy = local_672;
            local_a74.rgrad = local_a5c;
            local_a74.cCur = 0;
            local_a74.cMax = 0xfa;
            local_a74.hdc = hdc;
            local_a74.rcClip.left = prc->left;
            local_a74.rcClip.top = prc->top;
            local_a74.rcClip.right = prc->right;
            local_a74.rcClip.bottom = prc->bottom;
            local_a74.fCovered = 0;
            local_a74.fHollowOut = 0;
            IntersectClipRect(hdc, sVar1, sVar2, sVar3, sVar4);
            HVar26 = SelectObject(hdc, hbrRadar);
            HVar25 = SelectObject(hdc, hpenRadar);
            local_a76 = lpPlanets._2_2_;
            pPVar30 = (PLANET *)lpPlanets + cPlanet;
            lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
            in_stack_0000f588 = (PLANET *)lpPlanets;
            while ((PLANET *)lppl < pPVar30) {
                uVar41 = (undefined2)((ulong)lppl >> 0x10);
                if (((PLANET *)lppl)->iPlayer == idPlayer) {
                    dRange = GetPlanetScannerRange(lppl, &local_a76);
                    if (0 < (int)local_a76) {
                        local_674 = 1;
                    }
                    if (vpctRadarView < 100) {
                        dRange = MulDiv(dRange, vpctRadarView, 100);
                    }
                    iVar21 = lppl->id;
                    rc.left = PtToScan((iVar17 + ((POINT *)rgptPlan + iVar21)->x) - dRange);
                    rc.top = PtToScan((iVar18 - *(int *)((int)&rgptPlan[0].y + iVar21 * 4)) - dRange);
                    rc.right = PtToScan(iVar17 + ((POINT *)rgptPlan + iVar21)->x + dRange);
                    rc.bottom = PtToScan((iVar18 - *(int *)((int)&rgptPlan[0].y + iVar21 * 4)) + dRange);
                    DrawRadarCircle(&local_a74, &rc);
                }
                lppl = (PLANET *)CONCAT22(uVar41, (PLANET *)lppl + 1);
            }
            for (i = 0; i < cFleet; i = i + 1) {
                /* WARNING: Load size is inaccurate */
                pFVar6 = ((FLEET **)rglpfl)[i];
                iVar21 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                if ((pFVar6 == (FLEET *)0x0) && (iVar21 == 0))
                    break;
                if (pFVar6->iPlayer == idPlayer) {
                    dRange = GetFleetScannerRange((FLEET *)CONCAT22(iVar21, pFVar6), &local_a76, (short *)0x0, (short *)0x0);
                    if (0 < (int)local_a76) {
                        local_674 = local_674 | 2;
                    }
                    if (0 < dRange) {
                        if (vpctRadarView < 100) {
                            dRange = MulDiv(dRange, vpctRadarView, 100);
                        }
                        rc.left = PtToScan((iVar17 + (&pFVar6->pt)->x) - dRange);
                        rc.top = PtToScan((iVar18 - (pFVar6->pt).y) - dRange);
                        rc.right = PtToScan(iVar17 + (&pFVar6->pt)->x + dRange);
                        rc.bottom = PtToScan((iVar18 - (pFVar6->pt).y) + dRange);
                        DrawRadarCircle(&local_a74, &rc);
                    }
                }
            }
            DrawRadarCircle(&local_a74, (RECT *)0x0);
            if (hbrRadarNear == 0) {
                if (vcScreenColors < 9) {
                    uVar9 = 0x7f7f;
                } else {
                    uVar9 = 0x6060;
                }
                hbrRadarNear = HbrGet((ulong)uVar9);
            }
            if (hpenRadarNear == 0) {
                if (vcScreenColors < 9) {
                    uVar9 = 0x7f7f;
                } else {
                    uVar9 = 0x6060;
                }
                hpenRadarNear = CreatePen(0, 1, (ulong)uVar9);
            }
            SelectObject(hdc, hbrRadarNear);
            SelectObject(hdc, hpenRadarNear);
            if ((local_674 & 1) != 0) {
                local_a76 = lpPlanets._2_2_;
                pPVar30 = (PLANET *)lpPlanets + cPlanet;
                lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
                in_stack_0000f588 = (PLANET *)lpPlanets;
                while ((PLANET *)lppl < pPVar30) {
                    uVar41 = (undefined2)((ulong)lppl >> 0x10);
                    if (((PLANET *)lppl)->iPlayer == idPlayer) {
                        sVar20 = GetPlanetScannerRange(lppl, &local_a76);
                        if (0 < (int)local_a76) {
                            dRange = sVar20 >> 1;
                            if (vpctRadarView < 100) {
                                dRange = MulDiv(dRange, vpctRadarView, 100);
                            }
                            iVar21 = lppl->id;
                            rc.left = PtToScan((iVar17 + ((POINT *)rgptPlan + iVar21)->x) - dRange);
                            rc.top = PtToScan((iVar18 - *(int *)((int)&rgptPlan[0].y + iVar21 * 4)) - dRange);
                            rc.right = PtToScan(iVar17 + ((POINT *)rgptPlan + iVar21)->x + dRange);
                            rc.bottom = PtToScan((iVar18 - *(int *)((int)&rgptPlan[0].y + iVar21 * 4)) + dRange);
                            DrawRadarCircle(&local_a74, &rc);
                        }
                    }
                    lppl = (PLANET *)CONCAT22(uVar41, (PLANET *)lppl + 1);
                }
            }
            if ((local_674 & 2) != 0) {
                for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
                    pFVar6 = ((FLEET **)rglpfl)[i];
                    iVar21 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                    if ((pFVar6 == (FLEET *)0x0) && (iVar21 == 0))
                        break;
                    if (pFVar6->iPlayer == idPlayer) {
                        GetFleetScannerRange((FLEET *)CONCAT22(iVar21, pFVar6), &local_a76, (short *)0x0, (short *)0x0);
                        if (0 < (int)local_a76) {
                            if (vpctRadarView < 100) {
                                local_a76 = (PLANET *)MulDiv((short)local_a76, vpctRadarView, 100);
                            }
                            rc.left = PtToScan((iVar17 + (&pFVar6->pt)->x) - (int)local_a76);
                            rc.top = PtToScan((iVar18 - (pFVar6->pt).y) - (int)local_a76);
                            rc.right = PtToScan(iVar17 + (&pFVar6->pt)->x + (int)local_a76);
                            rc.bottom = PtToScan((iVar18 - (pFVar6->pt).y) + (int)local_a76);
                            DrawRadarCircle(&local_a74, &rc);
                        }
                    }
                }
            }
            sVar20 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv);
            if (sVar20 == raMassAccel) {
                local_a76 = lpThings._2_2_;
                pTVar32 = (THING *)lpThings + cThing;
                lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
                in_stack_0000f588 = (THING *)lpThings;
                while ((THING *)lpth < pTVar32) {
                    uVar41 = (undefined2)((ulong)lpth >> 0x10);
                    if (((lpth->idFull >> 0xd == 1) && ((lpth->idFull >> 9 & 0xf) == idPlayer)) &&
                        ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) != 0)) {
                        iVar21 = (((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) + 4;
                        local_a76 = (PLANET *)(iVar21 * iVar21);
                        if (vpctRadarView < 100) {
                            local_a76 = (PLANET *)MulDiv((short)local_a76, vpctRadarView, 100);
                        }
                        rc.left = PtToScan((iVar17 + (&((THING *)lpth)->pt)->x) - (int)local_a76);
                        rc.top = PtToScan((iVar18 - (((THING *)lpth)->pt).y) - (int)local_a76);
                        rc.right = PtToScan(iVar17 + (&((THING *)lpth)->pt)->x + (int)local_a76);
                        rc.bottom = PtToScan((iVar18 - (((THING *)lpth)->pt).y) + (int)local_a76);
                        DrawRadarCircle(&local_a74, &rc);
                    }
                    lpth = (THING *)CONCAT22(uVar41, (THING *)lpth + 1);
                }
            }
            DrawRadarCircle(&local_a74, (RECT *)0x0);
            SelectObject(hdc, hbrRadar);
            SelectObject(hdc, hpenRadar);
            if (uVar8 != 5) {
                iVar21 = sel.fl.id;
                if (sel.grobj != grobjFleet) {
                    iVar21 = -1;
                }
                if (sel.scan.grobj == grobjFleet) {
                    sVar20 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
                } else {
                    sVar20 = -1;
                }
                SelectObject(HVar19, hbmpScanShip);
                SetTextColor(hdc, 0);
                SetBkColor(hdc, 0xffffff);
                for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
                    pFVar6 = ((FLEET **)rglpfl)[i];
                    iVar31 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                    lpfl = (FLEET *)CONCAT22(iVar31, pFVar6);
                    if ((pFVar6 == (FLEET *)0x0) && (iVar31 == 0))
                        break;
                    if (pFVar6->idPlanet == -1) {
                        lVar39 = CShipsScanVis((FLEET *)CONCAT22(iVar31, pFVar6));
                        if (((0 < lVar39) || (lpfl->id == iVar21)) || (lpfl->id == sVar20)) {
                            pt.x = (&pFVar6->pt)->x;
                            pt.y = (pFVar6->pt).y;
                            if ((((iVar14 <= pt.x) && (pt.x < iVar15)) && (iVar16 <= pt.y)) && (pt.y < iVar27)) {
                                pt.x = PtToScan(iVar17 + pt.x);
                                pt.y = PtToScan(iVar18 - pt.y);
                                if (((&pFVar6->pt)->x == ptSelMain.x) && ((pFVar6->pt).y == ptSelMain.y)) {
                                    bVar35 = true;
                                } else {
                                    bVar35 = false;
                                }
                                if (bVar35) {
                                    SelectObject(HVar19, hbmpScanner);
                                    BitBlt(hdc, pt.x + -5, pt.y + -5, 0xb, 0xb, HVar19, 0xb, 0x50, 0x8800c6);
                                    SelectObject(HVar19, hbmpScanShip);
                                } else {
                                    GetScanFleetOrientation((FLEET *)CONCAT22(iVar31, pFVar6), &ptO, &ptD);
                                    BitBlt(hdc, pt.x - ptD.x / 2, pt.y - ptD.y / 2, ptD.x, ptD.y, HVar19, ptO.x, ptO.y, 0x8800c6);
                                }
                            }
                        }
                    }
                }
                SelectObject(HVar19, hbmpScanner);
            }
            SelectObject(hdc, HVar25);
            SelectObject(hdc, HVar26);
        }
        if ((grbitScan & 0x40) != 0) {
            local_a74.rgx = local_868;
            local_a74.rgy = local_672;
            local_a74.rgrad = local_a5c;
            local_a74.cCur = 0;
            local_a74.cMax = 0xfa;
            local_a74.hdc = hdc;
            local_a74.rcClip.left = prc->left;
            local_a74.rcClip.top = prc->top;
            local_a74.rcClip.right = prc->right;
            local_a74.rcClip.bottom = prc->bottom;
            local_a74.fCovered = 0;
            local_a74.fHollowOut = 1;
            for (i = 0; i < 3; i = i + 1) {
                UnrealizeObject(((ushort *)rghbrPat)[i]);
            }
            SetBrushOrg(hdc, ptOrigin.x, ptOrigin.y);
            IntersectClipRect(hdc, sVar1, sVar2, sVar3, sVar4);
            HVar26 = SelectObject(hdc, rghbrPat[0]);
            HVar42 = hdc;
            HVar25 = GetStockObject(8);
            HVar25 = SelectObject(HVar42, HVar25);
            local_674 = GetROP2(hdc);
            SetBkColor(hdc, 0);
            for (j = 0; pPVar30 = lpThings._2_2_, j < 3; j = j + 1) {
                if (((j != 0) || ((grbitScanMines & 1) != 0)) && (((j != 1 || ((grbitScanMines & 2) != 0)) && ((j != 2 || ((grbitScanMines & 0xc) != 0)))))) {
                    for (i = 0; i < 3; i = i + 1) {
                        for (local_a76 = (PLANET *)0x0; (int)local_a76 <= (int)(uint)(i == 0); local_a76 = (PLANET *)((int)&local_a76->id + 1)) {
                            SetBrushOrg(hdc, ptOrigin.x, ptOrigin.y);
                            SelectObject(hdc, ((ushort *)rghbrPat)[i]);
                            if (local_a76 == (PLANET *)0x0) {
                                uVar41 = *(undefined2 *)(j * 4 + rgcrScanMine);
                                uVar28 = *(undefined2 *)(j * 4 + hbrBlue);
                            } else {
                                uVar41 = 0xff;
                                uVar28 = 0xff;
                            }
                            SetTextColor(hdc, CONCAT22(uVar28, uVar41));
                            pTVar32 = (THING *)lpThings + cThing;
                            lpth = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
                            in_stack_0000f586 = (THING *)lpThings;
                            in_stack_0000f588 = lpThings._2_2_;
                            while ((THING *)lpth < pTVar32) {
                                uVar41 = (undefined2)((ulong)lpth >> 0x10);
                                if (((lpth->idFull >> 0xd == 0) && ((uint) * (byte *)((int)&((THING *)lpth)->u_THING_0x0006 + 6) == i)) &&
                                    ((j != 0 || ((lpth->idFull >> 9 & 0xf) == idPlayer)))) {
                                    if (j < 1) {
                                    LAB_1058_21da:
                                        if ((j == 2) && ((grbitScanMines & 0xc) != 0xc)) {
                                            in_stack_0000f588 = (PLANET *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0);
                                            if (in_stack_0000f588->rgpctMinLevel[(lpth->idFull >> 9 & 0xf) - 6] == 0) {
                                                uVar9 = grbitScanMines & 4;
                                            } else {
                                                uVar9 = grbitScanMines & 8;
                                            }
                                            if (uVar9 == 0)
                                                goto LAB_1058_243c;
                                        }
                                        if ((PLANET *)(uint) * (byte *)((int)&((THING *)lpth)->u_THING_0x0006 + 7) == local_a76) {
                                            pt.x = (&((THING *)lpth)->pt)->x;
                                            pt.y = (((THING *)lpth)->pt).y;
                                            _sqrt((double)((&((THING *)lpth)->u_THING_0x0006)->thm).cMines);
                                            lVar39 = __ftol((double)CONCAT26(in_stack_0000f588, CONCAT24(in_stack_0000f586, CONCAT22(unaff_SI, unaff_DI))));
                                            iVar21 = (int)lVar39;
                                            rc.left = PtToScan((iVar17 + pt.x) - iVar21);
                                            rc.top = PtToScan((iVar18 - pt.y) - iVar21);
                                            rc.right = PtToScan(iVar17 + pt.x + iVar21);
                                            rc.bottom = PtToScan((iVar18 - pt.y) + iVar21);
                                            DrawRadarCircle(&local_a74, &rc);
                                            id = 0;
                                            while ((id < game.cPlanMax &&
                                                    ((((POINT *)rgptPlan + id)->x != pt.x || (*(int *)((int)&rgptPlan[0].y + id * 4) != pt.y))))) {
                                                id = id + 1;
                                            }
                                            if (id == game.cPlanMax) {
                                                pt.x = PtToScan(iVar17 + pt.x);
                                                pt.y = PtToScan(iVar18 - pt.y);
                                                dRange = PtToScan(1);
                                                if (dRange < 1) {
                                                    dRange = 1;
                                                } else if (3 < dRange) {
                                                    dRange = 3;
                                                }
                                                SetRect(&rc, pt.x - dRange, pt.y - dRange, pt.x + dRange + 1, pt.y + dRange + 1);
                                                SetBkColor(hdc, CONCAT22(*(undefined2 *)(j * 4 + hbrBlue), *(undefined2 *)(j * 4 + rgcrScanMine)));
                                                ExtTextOut(hdc, rc.left, rc.top, 2, &rc, (LPCSTR)0x0, 0, (short *)0x0);
                                                SetBkColor(hdc, 0);
                                            }
                                        }
                                    } else if ((lpth->idFull >> 9 & 0xf) != idPlayer) {
                                        in_stack_0000f588 = (PLANET *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0);
                                        in_stack_0000f586 = (THING *)(uint)(in_stack_0000f588->rgpctMinLevel[(lpth->idFull >> 9 & 0xf) - 6] == 1);
                                        if (in_stack_0000f586 != (THING *)(uint)(j == 2))
                                            goto LAB_1058_21da;
                                    }
                                }
                            LAB_1058_243c:
                                lpth = (THING *)CONCAT22(uVar41, (THING *)lpth + 1);
                            }
                            DrawRadarCircle(&local_a74, (RECT *)0x0);
                        }
                    }
                }
            }
            if (sel.scan.grobj == grobjThing) {
                pTVar32 = (THING *)lpThings + sel.scan.ith;
                lpth = (THING *)CONCAT22(lpThings._2_2_, pTVar32);
                if (lpth->idFull >> 0xd == 0) {
                    SetBrushOrg(hdc, ptOrigin.x, ptOrigin.y);
                    SelectObject(hdc, ((ushort *)rghbrPat)[*(byte *)((int)&pTVar32->u_THING_0x0006 + 6)]);
                    SetTextColor(hdc, 0xffff00);
                    pt.x = (&pTVar32->pt)->x;
                    pt.y = (pTVar32->pt).y;
                    _sqrt((double)((&pTVar32->u_THING_0x0006)->thm).cMines);
                    lVar39 = __ftol((double)CONCAT26(in_stack_0000f588, CONCAT24(in_stack_0000f586, CONCAT22(unaff_SI, unaff_DI))));
                    iVar21 = (int)lVar39;
                    rc.left = PtToScan((iVar17 + pt.x) - iVar21);
                    rc.top = PtToScan((iVar18 - pt.y) - iVar21);
                    rc.right = PtToScan(iVar17 + pt.x + iVar21);
                    rc.bottom = PtToScan((iVar18 - pt.y) + iVar21);
                    DrawRadarCircle(&local_a74, &rc);
                    DrawRadarCircle(&local_a74, (RECT *)0x0);
                }
            }
            SetROP2(hdc, local_674);
            SelectObject(hdc, HVar25);
            SelectObject(hdc, HVar26);
        }
        if ((cThing != 0) && (crBack = CONCAT22(crBack._2_2_, (undefined2)crBack), uVar8 != 5)) {
            IntersectClipRect(hdc, sVar1, sVar2, sVar3, sVar4);
            HVar26 = SelectObject(hdc, hbrShip);
            HVar25 = SelectObject(hdc, hpenDkPurple);
            local_492 = (THING *)lpThings;
            local_490 = lpThings._2_2_;
            local_48e = (THING *)lpThings + cThing;
            local_48c = lpThings._2_2_;
            local_48a = (THING *)CONCAT22(lpThings._2_2_, (THING *)lpThings);
            while ((THING *)local_48a < local_48e) {
                if (((local_48a->idFull >> 0xd == 1) || (local_48a->idFull >> 0xd == 2)) || (local_48a->idFull >> 0xd == 3)) {
                    uVar41 = (undefined2)((ulong)local_48a >> 0x10);
                    pt.x = (&((THING *)local_48a)->pt)->x;
                    pt.y = (((THING *)local_48a)->pt).y;
                    LogicalToScan(&pt);
                    if (local_48a->idFull >> 0xd == 2) {
                        uVar41 = (undefined2)((ulong)local_48a >> 0x10);
                        pTVar32 = (THING *)local_48a;
                        if ((local_48a->idFull < *(uint *)((int)&pTVar32->u_THING_0x0006 + 6)) &&
                            ((1 << ((byte)idPlayer & 0x1f) & *(uint *)((int)&pTVar32->u_THING_0x0006 + 4)) != 0)) {
                            local_486 = LpthFromId(*(short *)((int)&pTVar32->u_THING_0x0006 + 6));
                            if (local_486 != (THING *)0x0) {
                                MoveTo(hdc, pt.x, pt.y);
                                uVar41 = (undefined2)((ulong)local_486 >> 0x10);
                                local_482.x = (&((THING *)local_486)->pt)->x;
                                local_482.y = (((THING *)local_486)->pt).y;
                                LogicalToScan(&local_482);
                                LineTo(hdc, local_482.x, local_482.y);
                                LineTo(hdc, local_482.x, local_482.y + 1);
                            }
                        }
                    }
                    if (local_48a->idFull >> 0xd == 2) {
                        BitBlt(hdc, pt.x + -4, pt.y + -4, 9, 9, HVar19, 9, 0x5c, 0x8800c6);
                        BitBlt(hdc, pt.x + -4, pt.y + -4, 9, 9, HVar19, 0, 0x5c, 0xee0086);
                    } else if (local_48a->idFull >> 0xd == 3) {
                        local_490 = (PLANET *)SelectObject(HVar19, hbmpScanShip);
                        CVar36 = SetTextColor(hdc, 0xffff00);
                        CVar37 = SetBkColor(hdc, 0);
                        uVar41 = (undefined2)((ulong)local_48a >> 0x10);
                        pTVar32 = (THING *)local_48a;
                        crBack = CVar37;
                        GetDxDyOrientation(((&pTVar32->u_THING_0x0006)->thp).wFlags - (&pTVar32->pt)->x,
                                           *(int *)((int)&pTVar32->u_THING_0x0006 + 2) - (pTVar32->pt).y, &ptO, &ptD);
                        BitBlt(hdc, pt.x - ptD.x / 2, pt.y - ptD.y / 2, ptD.x, ptD.y, HVar19, ptO.x, ptO.y, 0xee0086);
                        SetTextColor(hdc, CVar36);
                        SetBkColor(hdc, crBack);
                        SelectObject(HVar19, (HGDIOBJ)local_490);
                    } else {
                        if (iScanZoom < 1) {
                            iVar21 = 2;
                        } else if (iScanZoom < 3) {
                            iVar21 = 3;
                        } else {
                            iVar21 = 5;
                        }
                        iVar31 = iVar21 * 2 + 1;
                        if ((((&((THING *)local_48a)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) == 0) {
                            SelectObject(hdc, hpenYellow);
                            MoveTo(hdc, pt.x, (pt.y - iVar21) + -1);
                            LineTo(hdc, (pt.x - iVar21) + -1, pt.y);
                            LineTo(hdc, pt.x, pt.y + iVar21 + 1);
                            LineTo(hdc, pt.x + iVar21 + 1, pt.y);
                            LineTo(hdc, pt.x, (pt.y - iVar21) + -1);
                            SelectObject(hdc, hpenDkPurple);
                        } else {
                            if ((local_48a->idFull >> 9 & 0xf) != idPlayer) {
                                SelectObject(hdc, hbrRed);
                            }
                            PatBlt(hdc, pt.x - iVar21, pt.y - iVar21, iVar31, 1, 0xf00021);
                            PatBlt(hdc, pt.x - iVar21, pt.y - iVar21, 1, iVar31, 0xf00021);
                            PatBlt(hdc, pt.x - iVar21, pt.y + iVar21, iVar31, 1, 0xf00021);
                            PatBlt(hdc, pt.x + iVar21, pt.y - iVar21, 1, iVar31, 0xf00021);
                            if ((local_48a->idFull >> 9 & 0xf) != idPlayer) {
                                SelectObject(hdc, hbrShip);
                            }
                        }
                    }
                }
                local_48a = (THING *)local_48a + 1;
            }
            SelectObject(hdc, HVar26);
            SelectObject(hdc, HVar25);
        }
        if (((grbitScan & 0x80) != 0) && (uVar8 != 5)) {
            iVar21 = sel.fl.id;
            if (sel.grobj != grobjFleet) {
                iVar21 = -1;
            }
            if (sel.scan.grobj == grobjFleet) {
                sVar20 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
            } else {
                sVar20 = -1;
            }
            HVar26 = SelectObject(hdc, hpenStarbase);
            for (i = 0; i < cFleet; i = i + 1) {
                /* WARNING: Load size is inaccurate */
                pFVar6 = ((FLEET **)rglpfl)[i];
                iVar31 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                lpfl = (FLEET *)CONCAT22(iVar31, pFVar6);
                if ((pFVar6 == (FLEET *)0x0) && (iVar31 == 0))
                    break;
                if (((pFVar6->wFlags_0x4 >> 10 & 1) == 0) && ((6 < (pFVar6->wFlags_0x4 & 0xff) && (1 < pFVar6->cord)))) {
                    lVar39 = CShipsScanVis((FLEET *)CONCAT22(iVar31, pFVar6));
                    if ((0 < lVar39) || ((lpfl->id == iVar21 || (lpfl->id == sVar20)))) {
                        for (iord = 0; iord < pFVar6->cord; iord = iord + 1) {
                            uVar41 = *(undefined2 *)((int)&pFVar6->lpplord + 2);
                            piVar29 = (int *)(*(int *)&pFVar6->lpplord + 4 + iord * 0x12);
                            pt.x = *piVar29;
                            pt.y = piVar29[1];
                            pt.x = PtToScan(iVar17 + pt.x);
                            pt.y = PtToScan(iVar18 - pt.y);
                            if (iord == 0) {
                                MoveTo(hdc, pt.x, pt.y);
                            } else {
                                LineTo(hdc, pt.x, pt.y);
                            }
                        }
                    }
                }
            }
            SelectObject(hdc, HVar26);
        }
        SelectClipRgn(hdc, hrgnHuge);
        GetClientRect(hwndScanner, &rc);
        ExcludeClipRect(hdc, 0, rc.bottom - dySBar, rc.right, rc.bottom);
        _memset(rgWhatsHere, 0, 999);
        switch (iScanZoom) {
        case 0:
        case 1:
        case 2:
            SelectObject(hdc, rghfontArial8[0]);
            break;
        case 3:
            SelectObject(hdc, rghfontArial8[1]);
            break;
        case 4:
            SelectObject(hdc, rghfontArial10[1]);
            break;
        case -1:
            SelectObject(hdc, rghfontArial6[0]);
        }
        CVar36 = SetTextColor(hdc, 0xffffff);
        CVar37 = SetBkColor(hdc, 0);
        crBack = CVar37;
        sVar20 = SetBkMode(hdc, 1);
        if ((iScanZoom < 3) || (uVar8 != 4)) {
            iVar21 = 0;
        } else {
            iVar21 = 0xb;
        }
        for (i = 0; i < game.cPlanMax; i = i + 1) {
            if ((((((POINT *)rgptPlan + i)->x < iVar14) || (iVar15 <= ((POINT *)rgptPlan + i)->x)) || (*(int *)((int)&rgptPlan[0].y + i * 4) < iVar16)) ||
                (iVar27 <= *(int *)((int)&rgptPlan[0].y + i * 4))) {
                if ((grbitScan & 0x400) != 0) {
                    bVar35 = false;
                    goto SCAN_LBailIn;
                }
            } else {
                bVar35 = true;
            SCAN_LBailIn:
                pt.x = PtToScan(iVar17 + ((POINT *)rgptPlan + i)->x);
                pt.y = PtToScan(iVar18 - *(int *)((int)&rgptPlan[0].y + i * 4));
                if (bVar35) {
                    if (((ptSelMain.x == ((POINT *)rgptPlan + i)->x) && (ptSelMain.y == *(int *)((int)&rgptPlan[0].y + i * 4))) && (uVar8 < 3)) {
                        BitBlt(hdc, pt.x + -5, pt.y + -5, 0xb, 0xb, HVar19, 0, 0x45, 0x8800c6);
                        BitBlt(hdc, pt.x + -5, pt.y + -5, 0xb, 0xb, HVar19, 0, 0x21, 0xee0086);
                    } else {
                        BitBlt(hdc, pt.x + -1, pt.y + -1, 3, 3, HVar19, 0xb, 0xf, 0xcc0020);
                    }
                }
                if ((((grbitScan & 0x400) != 0) && (-2 < iScanZoom)) &&
                    ((iVar14 + -0x32 <= ((POINT *)rgptPlan + i)->x &&
                      (((((POINT *)rgptPlan + i)->x < iVar15 + 0x32 && (iVar16 + -0x14 <= *(int *)((int)&rgptPlan[0].y + i * 4))) &&
                        (*(int *)((int)&rgptPlan[0].y + i * 4) < iVar27 + 0x14)))))) {
                    PszGetPlanetName(i);
                    if ((grbitScan & 0x2000) != 0) {
                        pPVar38 = LpplFromId(i);
                        iVar31 = (int)((ulong)pPVar38 >> 0x10);
                        pPVar30 = (PLANET *)pPVar38;
                        if (((pPVar30 != (PLANET *)0x0) || (iVar31 != 0)) && (pPVar30->iPlayer != -1)) {
                            if (pPVar30->iPlayer == idPlayer) {
                                uVar41 = 0xffff;
                                uVar28 = 0xff;
                            } else {
                                iVar31 = pPVar30->iPlayer * 4;
                                uVar41 = *(undefined2 *)(iVar31 + rgcrPlrHistory);
                                uVar28 = *(undefined2 *)(iVar31 + rgcrPlrHistory_0x2);
                            }
                            SetTextColor(hdc, CONCAT22(uVar28, uVar41));
                        }
                    }
                    CtrTextOut(hdc, pt.x, pt.y + 5 + iVar21, (char *)szWork, 0);
                    if ((grbitScan & 0x2000) != 0) {
                        SetTextColor(hdc, 0xffffff);
                    }
                }
            }
        }
        SetBkMode(hdc, sVar20);
        SetBkColor(hdc, crBack);
        SetTextColor(hdc, CVar36);
        if ((iScanZoom < 3) || (uVar8 != 4)) {
            iVar21 = 0;
        } else {
            iVar21 = 0xb;
        }
        if (((sel.grobj == grobjNone) || (sel.pt.x != sel.scan.pt.x)) || (sel.pt.y != sel.scan.pt.y)) {
            if (sel.scan.grobj != grobjNone) {
                pt.x = sel.scan.pt.x;
                pt.y = sel.scan.pt.y;
                LogicalToScan(&pt);
                BitBlt(hdc, pt.x + -3, pt.y + 7 + iVar21, 7, 8, HVar19, 0x16, 0x50, 0x8800c6);
                BitBlt(hdc, pt.x + -3, pt.y + 7 + iVar21, 7, 8, HVar19, 0x16, 0x31, 0xee0086);
            }
        } else {
            pt.x = sel.pt.x;
            pt.y = sel.pt.y;
            LogicalToScan(&pt);
            BitBlt(hdc, pt.x + -5, pt.y + 0xb + iVar21, 0xb, 0xc, HVar19, 0, 0x50, 0x8800c6);
            BitBlt(hdc, pt.x + -5, pt.y + 0xb + iVar21, 0xb, 0xc, HVar19, 0, 0x39, 0xee0086);
        }
        if ((cPlanet != 0) && (uVar8 != 5)) {
            lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
            for (i = 0; i < cPlanet; i = i + 1) {
                iVar21 = lppl->id;
                uVar41 = (undefined2)((ulong)lppl >> 0x10);
                pPVar30 = (PLANET *)lppl;
                if (((pPVar30->wFlags_0x4 >> 9 & 1) == 0) || (pPVar30->iPlayer == -1)) {
                    fStarbase = 0;
                } else {
                    fStarbase = 1;
                }
                if (fStarbase == 0) {
                    bVar35 = false;
                    bVar34 = false;
                } else {
                    iVar31 = pPVar30->iPlayer * 4;
                    if (*(int *)(*(int *)(iVar31 + rglpshdefSB) + (*(uint *)&pPVar30->lStarbase & 0xf) * 0x93) == 0x20) {
                        fStarbase = 2;
                    }
                    sVar20 = IWarpMAFromLppl(lppl, (short *)0x0);
                    bVar35 = 0 < sVar20;
                    sVar20 = IStargateFromLppl(lppl);
                    bVar34 = sVar20 != -1;
                }
                if ((((iVar14 <= ((POINT *)rgptPlan + iVar21)->x) && (((POINT *)rgptPlan + iVar21)->x < iVar15)) &&
                     (iVar16 <= *(int *)((int)&rgptPlan[0].y + iVar21 * 4))) &&
                    (*(int *)((int)&rgptPlan[0].y + iVar21 * 4) < iVar27)) {
                    pt.x = PtToScan(iVar17 + ((POINT *)rgptPlan + iVar21)->x);
                    pt.y = PtToScan(iVar18 - *(int *)((int)&rgptPlan[0].y + iVar21 * 4));
                    if (uVar8 == 3) {
                        local_482.y = 0;
                        if (2 < (pPVar30->wFlags_0x4 & 0xff)) {
                            sVar20 = PctPlanetDesirability(lppl, idPlayer);
                            local_486 = (THING *)CONCAT22(sVar20, (THING *)local_486);
                            if (sVar20 < 0) {
                            LAB_1058_343d:
                                sVar20 = PctPlanetOptValue(lppl, idPlayer);
                                local_486 = (THING *)CONCAT22(sVar20, (THING *)local_486);
                                if (-1 < sVar20) {
                                    sVar20 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv);
                                    if (sVar20 != raTerra) {
                                        local_482.y = 1;
                                    }
                                }
                            } else {
                                sVar20 = GetRaceStat((PLAYER *)rgplr + idPlayer, rsMajorAdv);
                                if (sVar20 == raTerra)
                                    goto LAB_1058_343d;
                            }
                            HVar23 = hbrRadar;
                            if ((-1 < (long)local_486) && (HVar23 = hbrDkYellow, local_482.y == 0)) {
                                HVar23 = hbrGreen;
                            }
                            HVar26 = SelectObject(hdc, HVar23);
                            HVar24 = hpenRadar;
                            if ((-1 < (long)local_486) && (HVar24 = hpenDkYellow, local_482.y == 0)) {
                                HVar24 = hpenDkGreen;
                            }
                            HVar25 = SelectObject(hdc, HVar24);
                            if ((long)local_486 < 0) {
                                local_482.x = -local_486._2_2_ / 5;
                            } else {
                                local_482.x = local_486._2_2_ / 0xb;
                            }
                            local_482.x = local_482.x + 2;
                            if (10 < local_482.x) {
                                local_482.x = 10;
                            }
                            Ellipse(hdc, pt.x - local_482.x, pt.y - local_482.x, pt.x + local_482.x + 1, pt.y + local_482.x + 1);
                            iVar21 = local_482.x + -2;
                            if (local_482.x + -2 < 3) {
                                iVar21 = local_482.x + -1;
                            }
                            local_482.x = iVar21;
                            if (local_482.x < 1) {
                                local_482.x = 1;
                            }
                            HVar23 = hbrEnemy;
                            if ((-1 < (long)local_486) && (HVar23 = hbrYellow, local_482.y == 0)) {
                                HVar23 = hbrShip;
                            }
                            SelectObject(hdc, HVar23);
                            HVar24 = hpenEnemy;
                            if ((-1 < (long)local_486) && (HVar24 = hpenYellow, local_482.y == 0)) {
                                HVar24 = hpenShip;
                            }
                            SelectObject(hdc, HVar24);
                            Ellipse(hdc, pt.x - local_482.x, pt.y - local_482.x, pt.x + local_482.x + 1, pt.y + local_482.x + 1);
                            if (pPVar30->iPlayer != -1) {
                                rc.left = pt.x + -1;
                                rc.right = pt.x + 8;
                                rc.top = pt.y + -0x14;
                                rc.bottom = pt.y + -0xc;
                                pRVar40 = &rc;
                                uVar28 = unaff_SS;
                                HVar42 = hdc;
                                HVar22 = GetStockObject(4);
                                FillRect(HVar42, (RECT *)CONCAT22(uVar28, pRVar40), HVar22);
                                if (pPVar30->iPlayer == idPlayer) {
                                    local_486 = (THING *)CONCAT22(local_486._2_2_, hbrBBlue);
                                } else {
                                    iVar21 = idPlayer * 0xc0 + 0x5a12;
                                    local_48a = (THING *)CONCAT22(iVar21, (THING *)local_48a);
                                    if (*(char *)(iVar21 + pPVar30->iPlayer) == '\x01') {
                                        local_486 = (THING *)CONCAT22(local_486._2_2_, hbrStarbase);
                                    } else {
                                        iVar21 = idPlayer * 0xc0 + 0x5a12;
                                        local_48a = (THING *)CONCAT22(iVar21, (THING *)local_48a);
                                        if (*(char *)(iVar21 + pPVar30->iPlayer) == '\0') {
                                            local_486 = (THING *)CONCAT22(local_486._2_2_, hbrRadar);
                                        } else {
                                            local_486 = (THING *)CONCAT22(local_486._2_2_, hbrEnemy);
                                        }
                                    }
                                }
                                SelectObject(hdc, (HGDIOBJ)(THING *)local_486);
                                PatBlt(hdc, pt.x, pt.y + -0x13, 1, 0x15, 0xf00021);
                                PatBlt(hdc, pt.x, pt.y + -0x13, 7, 6, 0xf00021);
                            }
                            SelectObject(hdc, HVar25);
                            SelectObject(hdc, HVar26);
                        }
                    } else {
                        if ((uVar8 == 1) || (uVar8 == 2)) {
                            pTVar32 = (THING *)(uint)(uVar8 == 2);
                            local_486 = (THING *)CONCAT22(local_486._2_2_, pTVar32);
                            local_482.y = (short)(iScanZoom < 0);
                            if ((3 < (pPVar30->wFlags_0x4 & 0xff)) || ((pTVar32 != (THING *)0x0 && (2 < (pPVar30->wFlags_0x4 & 0xff))))) {
                                local_486 = (THING *)CONCAT22(pt.x - *(int *)(local_482.y * 10 + vrgScanPO), pTVar32);
                                local_48a = (THING *)CONCAT22(pt.y - *(int *)(local_482.y * 10 + vrgScanPO_0x2), (THING *)local_48a);
                                HVar26 = SelectObject(hdc, hbrButtonFace);
                                PatBlt(hdc, local_486._2_2_ + -2, local_48a._2_2_, *(short *)(local_482.y * 10 + 0x590), 1, 0xf00021);
                                PatBlt(hdc, local_486._2_2_ + -2, (local_48a._2_2_ - *(int *)(local_482.y * 10 + 0x590)) + 1, 1,
                                       *(short *)(local_482.y * 10 + 0x590), 0xf00021);
                                for (local_482.x = 0; local_482.x < 3; local_482.x = local_482.x + 1) {
                                    if ((THING *)local_486 == (THING *)0x0) {
                                        local_48c = *(PLANET **)(pPVar30->rgwtMin + local_482.x);
                                        local_48a._0_2_ = (THING *)*(uint *)((int)(pPVar30->rgwtMin + local_482.x) + 2);
                                        uVar9 = cMinGrafMax / 0x28;
                                        pPVar38 =
                                            (PLANET *)__aFldiv(CONCAT22(((int)uVar9 >> 0xf) + (int)(THING *)local_48a + (uint)CARRY2(uVar9, (uint)local_48c),
                                                                        uVar9 + (int)local_48c),
                                                               (long)(cMinGrafMax / 0x14));
                                        local_48c = (PLANET *)pPVar38;
                                        local_48a = (THING *)CONCAT22(local_48a._2_2_, (THING *)((ulong)pPVar38 >> 0x10));
                                        if (0x14 < (long)pPVar38) {
                                            local_48c = (PLANET *)&hbrButtonHilite;
                                            local_48a = (THING *)((ulong)local_48a._2_2_ << 0x10);
                                        }
                                    } else {
                                        local_48c = (PLANET *)(pPVar30->rgMinConc[local_482.x] / 5);
                                        if ((PLANET *)&hbrButtonHilite < local_48c) {
                                            local_48c = (PLANET *)&hbrButtonHilite;
                                        }
                                        local_48a = (THING *)((ulong)local_48a._2_2_ << 0x10);
                                    }
                                    if (local_482.y != 0) {
                                        pPVar38 = (PLANET *)__aFldiv((long)CONCAT22((THING *)local_48a, local_48c), 2);
                                        local_48c = (PLANET *)pPVar38;
                                        local_48a = (THING *)CONCAT22(local_48a._2_2_, (THING *)((ulong)pPVar38 >> 0x10));
                                    }
                                    if ((-1 < (int)(THING *)local_48a) && ((0 < (int)(THING *)local_48a || (local_48c != (PLANET *)0x0)))) {
                                        SelectObject(hdc, ((ushort *)rghbrMineral)[local_482.x]);
                                        PatBlt(hdc, local_486._2_2_, local_48a._2_2_ - (int)local_48c, *(short *)(local_482.y * 10 + 0x592), (short)local_48c,
                                               0xf00021);
                                    }
                                    local_486 = (THING *)CONCAT22(local_486._2_2_ + *(int *)(local_482.y * 10 + 0x594), (THING *)local_486);
                                }
                                SelectObject(hdc, HVar26);
                            }
                        } else if (uVar8 == 4) {
                            local_482.x = 0;
                            if (((pPVar30->wFlags_0x4 & 0xff) < 3) || (pPVar30->iPlayer == -1)) {
                                if (pPVar30->iPlayer == -1)
                                    goto SCAN_LNormalScannerMode;
                            } else {
                                if (pPVar30->iPlayer == idPlayer) {
                                    pTVar32 = (THING *)*(int *)((int)pPVar30->rgwtMin + 0xe);
                                    local_48a = (THING *)CONCAT22((int)pPVar30->rgwtMin[3], (THING *)local_48a);
                                } else {
                                    lVar39 = __aFlshl(CONCAT22(unaff_SI, unaff_DI), (ushort)in_stack_0000f586);
                                    pTVar32 = (THING *)((ulong)lVar39 >> 0x10);
                                    local_48a = (THING *)CONCAT22((int)lVar39, (THING *)local_48a);
                                }
                                for (local_486._2_2_ = 0; local_486._2_2_ < 0x13; local_486._2_2_ = local_486._2_2_ + 1) {
                                    iVar21 = (int)*(uint *)(local_486._2_2_ * 2) >> 0xf;
                                    if (((int)pTVar32 <= iVar21) && (((int)pTVar32 < iVar21 || (local_48a._2_2_ < *(uint *)(local_486._2_2_ * 2)))))
                                        break;
                                }
                                local_486 = (THING *)CONCAT22(local_486._2_2_ + 2, pTVar32);
                                if (pPVar30->iPlayer == idPlayer) {
                                    local_482.y = 0;
                                } else {
                                    pTVar32 = (THING *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0);
                                    local_48a = (THING *)CONCAT22(local_48a._2_2_, pTVar32);
                                    if (*(char *)((int)&pTVar32->idFull + pPVar30->iPlayer) == '\x01') {
                                        local_482.y = 1;
                                    } else {
                                        local_482.y = 3;
                                    }
                                }
                                HVar23 = hbrShip;
                                if ((local_482.y != 0) && (HVar23 = hbrEnemy, local_482.y != 3)) {
                                    HVar23 = hbrYellow;
                                }
                                HVar26 = SelectObject(hdc, HVar23);
                                HVar24 = hpenDkGreen;
                                if ((local_482.y != 0) && (HVar24 = hpenEnemy, local_482.y != 3)) {
                                    HVar24 = hpenDkYellow;
                                }
                                HVar25 = SelectObject(hdc, HVar24);
                                if (iScanZoom < 3) {
                                    local_486 = (THING *)CONCAT22(local_486._2_2_ + 1 >> 1, (THING *)local_486);
                                }
                                Ellipse(hdc, pt.x - local_486._2_2_, pt.y - local_486._2_2_, pt.x + local_486._2_2_ + 1, pt.y + local_486._2_2_ + 1);
                                SelectObject(hdc, HVar25);
                                SelectObject(hdc, HVar26);
                            }
                            goto LAB_1058_3257;
                        }
                    SCAN_LNormalScannerMode:
                        if (pPVar30->iPlayer == -1) {
                            if ((((POINT *)rgptPlan + iVar21)->x != ptSelMain.x) || (*(int *)((int)&rgptPlan[0].y + iVar21 * 4) != ptSelMain.y)) {
                                BitBlt(hdc, pt.x + -1, pt.y + -1, 3, 3, HVar19, 0xb, 0x12, 0xcc0020);
                            }
                        } else if ((((POINT *)rgptPlan + iVar21)->x == ptSelMain.x) && (*(int *)((int)&rgptPlan[0].y + iVar21 * 4) == ptSelMain.y)) {
                            if (pPVar30->iPlayer == idPlayer) {
                                yBmp = 0;
                            } else {
                                local_482.y = idPlayer * 0xc0 + 0x5a12;
                                if (*(char *)(local_482.y + pPVar30->iPlayer) == '\x01') {
                                    yBmp = 0x16;
                                } else {
                                    yBmp = 0xb;
                                }
                            }
                            BitBlt(hdc, pt.x + -5, pt.y + -5, 0xb, 0xb, HVar19, 0, 0x45, 0x8800c6);
                            BitBlt(hdc, pt.x + -5, pt.y + -5, 0xb, 0xb, HVar19, 0, yBmp, 0xee0086);
                            if (fStarbase != 0) {
                                HVar23 = hbrBlue;
                                if (fStarbase != 2) {
                                    HVar23 = hbrYellow;
                                }
                                HVar26 = SelectObject(hdc, HVar23);
                                PatBlt(hdc, pt.x + 4, pt.y + -6, 5, 5, 0x42);
                                PatBlt(hdc, pt.x + 5, pt.y + -6, 3, 5, 0xf00021);
                                PatBlt(hdc, pt.x + 4, pt.y + -5, 5, 3, 0xf00021);
                                SelectObject(hdc, HVar26);
                            }
                            if (bVar34) {
                                HVar26 = SelectObject(hdc, hbrGreen);
                                PatBlt(hdc, pt.x + -7, pt.y + -6, 5, 5, 0x42);
                                PatBlt(hdc, pt.x + -6, pt.y + -6, 3, 5, 0xf00021);
                                PatBlt(hdc, pt.x + -7, pt.y + -5, 5, 3, 0xf00021);
                                SelectObject(hdc, HVar26);
                            }
                            if (bVar35) {
                                HVar26 = SelectObject(hdc, hbrPurple);
                                PatBlt(hdc, pt.x + -2, pt.y + -9, 5, 5, 0x42);
                                PatBlt(hdc, pt.x + -1, pt.y + -9, 3, 5, 0xf00021);
                                PatBlt(hdc, pt.x + -2, pt.y + -8, 5, 3, 0xf00021);
                                SelectObject(hdc, HVar26);
                            }
                        } else {
                            if (pPVar30->iPlayer == idPlayer) {
                                yBmp = 0;
                            } else {
                                local_482.y = idPlayer * 0xc0 + 0x5a12;
                                if (*(char *)(local_482.y + pPVar30->iPlayer) == '\x01') {
                                    yBmp = 10;
                                } else {
                                    yBmp = 5;
                                }
                            }
                            BitBlt(hdc, pt.x + -2, pt.y + -2, 5, 5, HVar19, 0xb, yBmp, 0xcc0020);
                            if (fStarbase != 0) {
                                HVar23 = hbrBlue;
                                if (fStarbase != 2) {
                                    HVar23 = hbrYellow;
                                }
                                HVar26 = SelectObject(hdc, HVar23);
                                PatBlt(hdc, pt.x + 3, pt.y + -4, 3, 3, 0xf00021);
                                SelectObject(hdc, HVar26);
                            }
                            if (bVar34) {
                                HVar26 = SelectObject(hdc, hbrGreen);
                                PatBlt(hdc, pt.x + -5, pt.y + -4, 3, 3, 0x42);
                                PatBlt(hdc, pt.x + -4, pt.y + -4, 1, 3, 0xf00021);
                                PatBlt(hdc, pt.x + -5, pt.y + -3, 3, 1, 0xf00021);
                                SelectObject(hdc, HVar26);
                            }
                            if (bVar35) {
                                HVar26 = SelectObject(hdc, hbrPurple);
                                PatBlt(hdc, pt.x + -1, pt.y + -6, 3, 3, 0x42);
                                PatBlt(hdc, pt.x, pt.y + -6, 1, 3, 0xf00021);
                                PatBlt(hdc, pt.x + -1, pt.y + -5, 3, 1, 0xf00021);
                                SelectObject(hdc, HVar26);
                            }
                        }
                    }
                }
            LAB_1058_3257:
                lppl = (PLANET *)CONCAT22(uVar41, pPVar30 + 1);
            }
        }
        if ((cFleet != 0) && (uVar8 != 5)) {
            HVar26 = SelectObject(hdc, hbrShip);
            iVar21 = sel.fl.id;
            if (sel.grobj != grobjFleet) {
                iVar21 = -1;
            }
            if (sel.scan.grobj == grobjFleet) {
                sVar20 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
            } else {
                sVar20 = -1;
            }
            for (i = 0; i < cFleet; i = i + 1) {
                /* WARNING: Load size is inaccurate */
                pFVar6 = ((FLEET **)rglpfl)[i];
                iVar31 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                lpflT = (FLEET *)CONCAT22(iVar31, pFVar6);
                if ((pFVar6 == (FLEET *)0x0) && (iVar31 == 0))
                    break;
                lVar39 = CShipsScanVis((FLEET *)CONCAT22(iVar31, pFVar6));
                if ((0 < lVar39) || ((lpflT->id == iVar21 || (lpflT->id == sVar20)))) {
                    iVar33 = pFVar6->idPlanet;
                    if (iVar33 == -1) {
                        pt.x = (&pFVar6->pt)->x;
                        pt.y = (pFVar6->pt).y;
                    } else {
                        pt.x = ((POINT *)rgptPlan + iVar33)->x;
                        pt.y = *(short *)((int)&rgptPlan[0].y + iVar33 * 4);
                    }
                    if ((((iVar14 <= pt.x) && (pt.x < iVar15)) && (iVar16 <= pt.y)) && (pt.y < iVar27)) {
                        pt.x = PtToScan(iVar17 + pt.x);
                        pt.y = PtToScan(iVar18 - pt.y);
                        bVar35 = pFVar6->iPlayer != idPlayer;
                        uVar9 = (uint)bVar35;
                        if (((&pFVar6->pt)->x == ptSelMain.x) && ((pFVar6->pt).y == ptSelMain.y)) {
                            bVar34 = true;
                        } else {
                            bVar34 = false;
                        }
                        if (iVar33 == -1) {
                            if (bVar34) {
                                BitBlt(hdc, pt.x + -5, pt.y + -5, 0xb, 0xb, HVar19, 0xb, uVar9 * 0xb + 0x24, 0xee0086);
                                if (((grbitScan & 0x1000) != 0) && ((pFVar6->wFlags_0x4 >> 0xb & 1) == 0)) {
                                    DrawScanFleetCount((FLEET *)CONCAT22(iVar31, pFVar6), pt.x, pt.y + -7, hdc, HVar19);
                                }
                            } else {
                                SelectObject(HVar19, hbmpScanShip);
                                if (uVar9 == 0) {
                                    local_482.x = 0;
                                    local_482.y = 0xff;
                                } else {
                                    iVar33 = idPlayer * 0xc0 + 0x5a12;
                                    local_486 = (THING *)CONCAT22(iVar33, (THING *)local_486);
                                    if (*(char *)(iVar33 + pFVar6->iPlayer) == '\x01') {
                                        local_482.x = -1;
                                        local_482.y = 0;
                                    } else {
                                        local_482.x = 0xff;
                                        local_482.y = 0;
                                    }
                                }
                                SetTextColor(hdc, CONCAT22(local_482.y, local_482.x));
                                SetBkColor(hdc, 0);
                                GetScanFleetOrientation((FLEET *)CONCAT22(iVar31, pFVar6), &ptO, &ptD);
                                BitBlt(hdc, pt.x - ptD.x / 2, pt.y - ptD.y / 2, ptD.x, ptD.y, HVar19, ptO.x, ptO.y, 0xee0086);
                                if (((grbitScan & 0x1000) != 0) && ((pFVar6->wFlags_0x4 >> 0xb & 1) == 0)) {
                                    DrawScanFleetCount((FLEET *)CONCAT22(iVar31, pFVar6), pt.x, (pt.y - ptD.y / 2) + -2, hdc, HVar19);
                                }
                                SelectObject(HVar19, hbmpScanner);
                            }
                        } else if (((rgWhatsHere[iVar33] != '\x03') && ((int)rgWhatsHere[iVar33] != uVar9 + 1)) && (uVar8 < 3)) {
                            rgWhatsHere[iVar33] = rgWhatsHere[iVar33] + bVar35 + '\x01';
                            cVar5 = rgWhatsHere[iVar33];
                            if (bVar34) {
                                BitBlt(hdc, pt.x + -9, pt.y + -9, 0x13, 0x13, HVar19, 0x1d, 0x45, 0x8800c6);
                                BitBlt(hdc, pt.x + -9, pt.y + -9, 0x13, 0x13, HVar19, 0x1d, (cVar5 + -1) * 0x13, 0xee0086);
                            } else {
                                BitBlt(hdc, pt.x + -5, pt.y + -5, 0xb, 0xb, HVar19, 0x10, 0x45, 0x8800c6);
                                BitBlt(hdc, pt.x + -5, pt.y + -5, 0xb, 0xb, HVar19, 0x10, (cVar5 + -1) * 0xb, 0xee0086);
                            }
                            if (((grbitScan & 0x1000) != 0) && ((pFVar6->wFlags_0x4 >> 0xb & 1) == 0)) {
                                if (bVar34) {
                                    iVar33 = 9;
                                } else {
                                    iVar33 = 5;
                                }
                                DrawScanFleetCount((FLEET *)CONCAT22(iVar31, pFVar6), pt.x, (pt.y - iVar33) + -2, hdc, HVar19);
                            }
                        }
                    }
                }
            }
            SelectObject(hdc, HVar26);
        }
        ExpandRc(prc, -dx_00, -dx_00);
        prc->bottom = prc->bottom + -0xe;
        CVar37 = SetTextColor(hdc, 0);
        CVar36 = GetBkColor(hdc);
        if ((((sel.grobj == grobjFleet) || (sel.scan.grobj == grobjFleet)) || (sel.scan.grobj == grobjThing)) ||
            ((sel.grobj == grobjPlanet && ((sel.pl.wFlags_0x4 >> 9 & 1) != 0)))) {
            crBack = CVar36;
            IntersectClipRect(hdc, prc->left, prc->top, prc->right, prc->bottom);
            fOrdersVis = 0;
            DrawShipScanPath(hdc, 1);
            SelectClipRgn(hdc, hrgnHuge);
            CVar36 = crBack;
        }
        crBack = CVar36;
        SetBkColor(hdc, CVar36);
        SetTextColor(hdc, CVar37);
        SelectObject(HVar19, HVar10);
        DeleteDC(HVar19);
        if (hdcScreen != 0) {
            SetWindowOrg(hdc, 0, 0);
            BitBlt(hdcScreen, prc->left, prc->top, prc->right - prc->left, prc->bottom - prc->top, hdc, prc->left & 7, prc->top & 7, 0xcc0020);
            SelectObject(hdc, hbmpXSav);
            DeleteObject(hbmpScreen);
            DeleteDC(hdc);
        }
    }
    return 0;
}

// ======================================================================
// Function: DrawScanFleetCount
// Address: 1058:47d2
// Segment: MEMORY_SCAN
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x1058496f) */
/* WARNING: Removing unreachable block (ram,0x105848c3) */
/* WARNING: Removing unreachable block (ram,0x10584832) */
/* WARNING: Removing unreachable block (ram,0x105848e8) */
/* WARNING: Removing unreachable block (ram,0x10584a5c) */

void DrawScanFleetCount(FLEET *lpfl, short x, short y, HDC hdc, HDC hdcMem)

{
    int      iVar1;
    bool     bVar2;
    int      iVar3;
    HGDIOBJ  HVar4;
    long     lVar5;
    long     lVar6;
    long     l;
    HBITMAP  hbmpSav;
    short    iPlr;
    FLEET   *lpflWalk;
    COLORREF cr;
    short    f999;
    long     l2;

    lpflWalk = lpfl;
    if ((grbitScan & 0x2000) == 0) {
        iPlr = -2;
    } else {
        iPlr = -1;
    }
    lVar6 = 0;
    bVar2 = false;
    do {
        lVar5 = CShipsScanVis(lpflWalk);
        if (((0 < lVar5) && (lVar6 = lVar5 + lVar6, ((FLEET *)lpflWalk)->iPlayer != iPlr)) && (iPlr != -2)) {
            if (iPlr == -1) {
                iPlr = ((FLEET *)lpflWalk)->iPlayer;
            } else {
                iPlr = -2;
            }
        }
        ((FLEET *)lpflWalk)->wFlags_0x4 = ((FLEET *)lpflWalk)->wFlags_0x4 & 0xf7ff | 0x800;
        /* WARNING: Load size is inaccurate */
        lpflWalk = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflWalk)->lpflNext + 2), ((FLEET *)lpflWalk)->lpflNext);
    } while (lpfl != lpflWalk);
    if (lVar6 < 1000) {
        if (lVar6 < 1) {
            return;
        }
    } else {
        lVar6 = 999;
    }
    l._0_2_ = (int)lVar6;
    HVar4 = SelectObject(hdcMem, hbmpNumbers);
    SetBkColor(hdc, 0);
    SetTextColor(hdc, 0xffffff);
    if ((iPlr < 0) || (iPlr == idPlayer)) {
        cr._0_2_ = -1;
        cr._2_2_ = 0xff;
    } else {
        cr._0_2_ = *(int *)(iPlr * 4 + rgcrPlrHistory);
        cr._2_2_ = *(int *)(iPlr * 4 + rgcrPlrHistory_0x2);
    }
    iVar1 = y + -7;
    iVar3 = x + -1;
    if (99 < lVar6) {
        bVar2 = true;
        if (((int)cr != -1) || (cr._2_2_ != 0xff)) {
            BitBlt(hdc, x + -6, iVar1, 4, 7, hdcMem, (int)l / 100 << 2, 0, 0x220326);
            SetTextColor(hdc, CONCAT22(cr._2_2_, (int)cr));
        }
        BitBlt(hdc, x + -6, iVar1, 4, 7, hdcMem, (int)l / 100 << 2, 0, 0xee0086);
        if (((int)cr != -1) || (cr._2_2_ != 0xff)) {
            SetTextColor(hdc, 0xffffff);
        }
        lVar6 = __aFlrem(lVar6, 100);
        iVar3 = x + 2;
    }
    x = iVar3;
    l._0_2_ = (int)lVar6;
    if ((9 < lVar6) || (bVar2)) {
        if (((int)cr != -1) || (cr._2_2_ != 0xff)) {
            BitBlt(hdc, x + -3, iVar1, 4, 7, hdcMem, (int)l / 10 << 2, 0, 0x220326);
            SetTextColor(hdc, CONCAT22(cr._2_2_, (int)cr));
        }
        BitBlt(hdc, x + -3, iVar1, 4, 7, hdcMem, (int)l / 10 << 2, 0, 0xee0086);
        if (((int)cr != -1) || (cr._2_2_ != 0xff)) {
            SetTextColor(hdc, 0xffffff);
        }
        x = x + 2;
        lVar6 = __aFlrem(lVar6, 10);
    }
    l._0_2_ = (int)lVar6;
    if (((int)cr != -1) || (cr._2_2_ != 0xff)) {
        BitBlt(hdc, x, iVar1, 4, 7, hdcMem, (int)l << 2, 0, 0x220326);
        SetTextColor(hdc, CONCAT22(cr._2_2_, (int)cr));
    }
    BitBlt(hdc, x, iVar1, 4, 7, hdcMem, (int)l << 2, 0, 0xee0086);
    if (((int)cr != -1) || (cr._2_2_ != 0xff)) {
        SetTextColor(hdc, 0xffffff);
    }
    SelectObject(hdcMem, HVar4);
    return;
}

// ======================================================================
// Function: CShipsScanVis
// Address: 1058:4bf4
// Segment: MEMORY_SCAN
// ======================================================================

long CShipsScanVis(FLEET *lpfl)

{
    uint    uVar1;
    int     iVar2;
    bool    bVar3;
    HULDEF *pHVar4;
    ushort  local_e;
    short   k;
    long    csh;
    short   j;

    csh._0_2_ = 0;
    csh._2_2_ = 0;
    if ((grbitScan & 0x100) != 0) {
        if ((((FLEET *)lpfl)->iPlayer == idPlayer) &&
            ((((((FLEET *)lpfl)->cord != 1 || ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 6)) ||
               ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 5)) ||
              (((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 3 ||
                ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 7)))))) {
            csh._0_2_ = 0;
            csh._2_2_ = 0;
            goto LAB_1058_4e75;
        }
        if ((((FLEET *)lpfl)->iPlayer != idPlayer) && ((*(uint *)((int)&((FLEET *)lpfl)->dirLong + 2) & 0xf) == 0)) {
            csh._0_2_ = 0;
            csh._2_2_ = 0;
            goto LAB_1058_4e75;
        }
    }
    if (((grbitScan & 0x200) == 0) || (((FLEET *)lpfl)->iPlayer != idPlayer)) {
        if (((grbitScan & 0x800) == 0) || (((FLEET *)lpfl)->iPlayer == idPlayer)) {
            for (j = 0; j < 0x10; j = j + 1) {
                uVar1 = ((FLEET *)lpfl)->rgcsh[j];
                bVar3 = CARRY2((uint)csh, uVar1);
                csh._0_2_ = (uint)csh + uVar1;
                csh._2_2_ = csh._2_2_ + ((int)uVar1 >> 0xf) + (uint)bVar3;
            }
        } else {
            j = 0;
            for (local_e = grbitScanEShip; local_e != 0; local_e = local_e >> 1) {
                if ((local_e & 1) != 0) {
                    for (k = 0; k < 0x10; k = k + 1) {
                        if ((0 < ((FLEET *)lpfl)->rgcsh[k]) &&
                            (iVar2 = ((FLEET *)lpfl)->iPlayer * 4, pHVar4 = LphuldefFromId(*(HullDef *)(*(int *)(iVar2 + rglpshdef) + k * 0x93)),
                             (((HULDEF *)pHVar4)->wFlags_0x7b >> 10 & 0xf) == j)) {
                            uVar1 = ((FLEET *)lpfl)->rgcsh[k];
                            bVar3 = CARRY2((uint)csh, uVar1);
                            csh._0_2_ = (uint)csh + uVar1;
                            csh._2_2_ = csh._2_2_ + ((int)uVar1 >> 0xf) + (uint)bVar3;
                        }
                    }
                }
                j = j + 1;
            }
        }
    } else {
        j = 0;
        for (local_e = grbitScanShip; local_e != 0; local_e = local_e >> 1) {
            if (((local_e & 1) != 0) && (0 < ((FLEET *)lpfl)->rgcsh[j])) {
                uVar1 = ((FLEET *)lpfl)->rgcsh[j];
                bVar3 = CARRY2((uint)csh, uVar1);
                csh._0_2_ = (uint)csh + uVar1;
                csh._2_2_ = csh._2_2_ + ((int)uVar1 >> 0xf) + (uint)bVar3;
            }
            j = j + 1;
        }
    }
LAB_1058_4e75:
    return CONCAT22(csh._2_2_, (uint)csh);
}

// ======================================================================
// Function: DrawRadarCircle
// Address: 1058:4e7c
// Segment: MEMORY_SCAN
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10584f8a) */
/* WARNING: Removing unreachable block (ram,0x10584f71) */
/* WARNING: Removing unreachable block (ram,0x10584fd1) */

void DrawRadarCircle(DRAWCIR *pdc, RECT *prc)

{
    BOOL       BVar1;
    int        iVar2;
    int        iVar3;
    int        iVar4;
    int        iVar5;
    int        iVar6;
    int        iVar7;
    int        iVar8;
    undefined2 unaff_SS;
    bool       bVar9;
    bool       bVar10;
    ulong      uVar11;
    ulong      uVar12;
    ulong      uVar13;
    COLORREF   CVar14;
    RECT       rc;
    short      x;
    long       l;
    short      rad;
    short      x2;
    short      dx;
    short      i;
    short      iFree;
    short      y;
    short      dy;
    COLORREF   crSav;
    long       r2;
    short      y2;

    CVar14 = CONCAT22(crSav._2_2_, (undefined2)crSav);
    if ((prc == (RECT *)0x0) ||
        ((pdc->fCovered == 0 && (BVar1 = IntersectRect(&rc, (RECT *)CONCAT62((int6)(CONCAT44(&rc, 0x11200000) >> 0x10), prc), &pdc->rcClip), BVar1 != 0)))) {
        if (prc == (RECT *)0x0) {
            if (pdc->fHollowOut != 0) {
                SetROP2(pdc->hdc, 9);
                CVar14 = SetBkColor(pdc->hdc, (COLORREF)(CONCAT44((long)(CONCAT26(pdc->hdc, 0xff00000000) >> 0x20), 0xffff0000) >> 0x10));
                l = 1;
            }
            while (true) {
                i = 0;
                while (true) {
                    crSav._2_2_ = (undefined2)(CVar14 >> 0x10);
                    crSav._0_2_ = (undefined2)CVar14;
                    if (pdc->cCur <= i)
                        break;
                    if (0 < pdc->rgrad[i]) {
                        iVar2 = pdc->rgrad[i];
                        Ellipse(pdc->hdc, pdc->rgx[i] - iVar2, pdc->rgy[i] - iVar2, pdc->rgx[i] + iVar2 + 1, pdc->rgy[i] + iVar2 + 1);
                    }
                    i = i + 1;
                }
                if (((pdc->fHollowOut == 0) || ((int)l != 1)) || (l._2_2_ != 0))
                    break;
                l = 0;
                SetBkColor(pdc->hdc, (COLORREF)CONCAT42(CONCAT22(pdc->hdc, crSav._2_2_), (undefined2)crSav));
                SetROP2(pdc->hdc, 0xf);
            }
            pdc->fCovered = 0;
            pdc->cCur = 0;
        } else {
            iVar2 = prc->right - prc->left;
            iVar3 = iVar2 >> 1;
            iVar4 = prc->left + iVar3;
            iVar5 = prc->top + iVar3;
            iVar2 = iVar2 >> 0xf;
            uVar11 = CONCAT22(iVar2, iVar3);
            uVar11 = __aFulmul((ulong)CONCAT62(CONCAT42(uVar11, iVar2), iVar3), uVar11);
            for (i = 0; i < 4; i = i + 1) {
                if (i < 2) {
                    iVar2 = (&pdc->rcClip)->left;
                } else {
                    iVar2 = (pdc->rcClip).right;
                }
                if ((i & 1U) == 0) {
                    iVar6 = (pdc->rcClip).bottom;
                } else {
                    iVar6 = (pdc->rcClip).top;
                }
                iVar2 = iVar2 - iVar4;
                iVar6 = iVar6 - iVar5;
                if (((long)uVar11 < (long)iVar2) || ((long)uVar11 < (long)iVar6))
                    break;
                uVar13 = __aFulmul((ulong)CONCAT62(CONCAT42((long)iVar6, iVar6 >> 0xf), iVar6), (long)iVar6);
                uVar12 = __aFulmul((ulong)CONCAT62(CONCAT42((long)iVar2, iVar2 >> 0xf), iVar2), (long)iVar2);
                if ((long)uVar11 < (long)(uVar12 + uVar13))
                    break;
            }
            if (i == 4) {
                pdc->fCovered = 1;
                pdc->cCur = 0;
            } else if (pdc->cCur != pdc->cMax) {
                iFree = pdc->cCur;
                i = 0;
                do {
                    if (pdc->cCur <= i) {
                        pdc->rgx[iFree] = iVar4;
                        pdc->rgy[iFree] = iVar5;
                        pdc->rgrad[iFree] = iVar3;
                        if (iFree != pdc->cCur) {
                            return;
                        }
                        pdc->cCur = pdc->cCur + 1;
                        return;
                    }
                    if (pdc->rgrad[i] < 1) {
                        iFree = i;
                    } else {
                        iVar2 = pdc->rgx[i];
                        iVar6 = pdc->rgy[i];
                        iVar7 = iVar4 - iVar2;
                        iVar8 = iVar5 - iVar6;
                        uVar11 = __aFulmul((ulong)CONCAT62(CONCAT42((long)iVar8, iVar8 >> 0xf), iVar8), (long)iVar8);
                        uVar13 = __aFulmul((ulong)CONCAT62(CONCAT42((long)iVar7, iVar7 >> 0xf), iVar7), (long)iVar7);
                        if (pdc->rgrad[i] < iVar3) {
                            _sqrt((double)(long)(uVar13 + uVar11));
                            bVar9 = CARRY2((uint)pdc->rgrad, i * 2);
                            bVar10 = pdc->rgrad + i == (short *)0x0;
                            __aFfcompp();
                            if (bVar9 || bVar10) {
                                pdc->rgrad[i] = 0;
                                iFree = i;
                            }
                        } else if (iVar3 < pdc->rgrad[i]) {
                            _sqrt((double)(long)(uVar13 + uVar11));
                            bVar9 = (undefined1 *)0xfff7 < &stack0xffb0;
                            bVar10 = &stack0x0000 == (undefined1 *)((int)(ulong *)rgcrPlrHistory + 0x1a);
                            __aFfcompp();
                            if (bVar9 || bVar10) {
                                return;
                            }
                        } else if ((iVar2 == iVar4) && (iVar6 == iVar5)) {
                            return;
                        }
                    }
                    i = i + 1;
                } while (true);
            }
            if (pdc->fHollowOut != 0) {
                SetROP2(pdc->hdc, 9);
                CVar14 = SetBkColor(pdc->hdc, (COLORREF)(CONCAT44((long)(CONCAT26(pdc->hdc, 0xff00000000) >> 0x20), 0xffff0000) >> 0x10));
                Ellipse(pdc->hdc, prc->left, prc->top, prc->right, prc->bottom);
                crSav._2_2_ = (undefined2)(CVar14 >> 0x10);
                crSav._0_2_ = (undefined2)CVar14;
                SetBkColor(pdc->hdc, (COLORREF)CONCAT42(CONCAT22(pdc->hdc, crSav._2_2_), (undefined2)crSav));
                SetROP2(pdc->hdc, 0xf);
            }
            Ellipse(pdc->hdc, prc->left, prc->top, prc->right, prc->bottom);
        }
    }
    return;
}

// ======================================================================
// Function: DrawShipScanPath
// Address: 1058:540c
// Segment: MEMORY_SCAN
// ======================================================================

void DrawShipScanPath(HDC hdc, short fShow)

{
    int        iVar1;
    int        iVar2;
    bool       bVar3;
    uint       uVar4;
    short      sVar5;
    short      sVar6;
    double    *pdVar7;
    HGDIOBJ    HVar8;
    short      sVar9;
    HGDIOBJ    HVar10;
    THING     *pTVar11;
    ORDER     *pOVar12;
    short     *psVar13;
    undefined2 unaff_SI;
    ushort     unaff_DI;
    undefined2 uVar14;
    undefined2 unaff_SS;
    bool       bVar15;
    ulong      uVar16;
    long       lVar17;
    undefined8 uVar18;
    long       lVar19;
    HDC        HVar20;
    undefined2 in_stack_0000fee8;
    short      sVar21;
    undefined2 uVar22;
    long       local_10e;
    double     m;
    short      dy5;
    POINT      ptTick;
    short      dx5;
    POINT      rgptArrow[2];
    undefined8 local_ee;
    RECT       rc;
    short      dx;
    short      dRad;
    long       lWarp2;
    short      fHdc;
    short      i;
    FLEET     *lpfl;
    POINT      ptCur;
    ORDER     *lpord1;
    short      dy;
    short      iRopSav;
    POINT      pt;
    POINT      pt2;
    HPEN       hpenSav;
    short      j;
    short      rgDup[87];
    ORDER     *lpord2;

    if (((sel.grobj != grobjFleet) && (sel.scan.grobj != grobjFleet)) && (sel.scan.grobj != grobjThing)) {
        if (sel.grobj != grobjPlanet) {
            return;
        }
        if ((((sel.pl.wFlags_0x4 >> 9 & 1) == 0) || ((sel.pl.lStarbase._2_2_ & 0x3ff) == 0)) && ((sel.pl.wRouting & 0x3ff) == 0)) {
            return;
        }
    }
    if (fShow == fOrdersVis) {
        return;
    }
    if (((uint)gd.grBits2 & 1) != 0) {
        return;
    }
    fOrdersVis = fShow;
    bVar15 = hdc == 0;
    if (bVar15) {
        hdc = GetDC(hwndScanner);
    }
    if ((sel.scan.grobj == grobjThing) && (sel.scan.ith != -1)) {
        pTVar11 = (THING *)lpThings + sel.scan.ith;
        ptCur.x = (&pTVar11->pt)->x;
        ptCur.y = (pTVar11->pt).y;
        if (((THING *)CONCAT22(lpThings._2_2_, pTVar11))->idFull >> 0xd == 3) {
            dx = ((&pTVar11->u_THING_0x0006)->thp).wFlags - ptCur.x;
            dy = *(int *)((int)&pTVar11->u_THING_0x0006 + 2) - ptCur.y;
            uVar4 = *(uint *)((int)&pTVar11->u_THING_0x0006 + 4) & 0xf;
        } else {
            if ((((THING *)CONCAT22(lpThings._2_2_, pTVar11))->idFull >> 0xd != 1) || ((((&pTVar11->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) == 0))
                goto SCAN_LNextCheck;
            dx = ((POINT *)rgptPlan + (((&pTVar11->u_THING_0x0006)->thp).wFlags & 0x3ff))->x - ptCur.x;
            dy = *(int *)((int)&rgptPlan[0].y + (((&pTVar11->u_THING_0x0006)->thp).wFlags & 0x3ff) * 4) - ptCur.y;
            uVar4 = (((&pTVar11->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) + 4;
        }
        if ((dx == 0) && (dy == 0))
            goto SCAN_LNextCheck;
        uVar16 = __aFulmul((ulong)CONCAT62(0x50000, uVar4), 5);
        lWarp2 = __aFulmul((ulong)uVar4, uVar16);
    } else {
    SCAN_LNextCheck:
        if (sel.scan.grobj != grobjFleet)
            goto SCAN_LNoObjPath;
        iVar1 = *(int *)((FLEET **)rglpfl + sel.scan.ifl);
        iVar2 = *(int *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
        ptCur.x = *(short *)(iVar1 + 8);
        ptCur.y = *(short *)(iVar1 + 10);
        if (((*(uint *)(iVar1 + 0x76) >> 4 & 1) == 0) || ((*(uint *)(iVar1 + 0x76) & 0xf) == 0))
            goto SCAN_LNoObjPath;
        dx = (*(uint *)(iVar1 + 0x74) & 0xff) - 0x7f;
        dy = (*(uint *)(iVar1 + 0x74) >> 8) - 0x7f;
        if ((dx == 0) && (dy == 0))
            goto SCAN_LNoObjPath;
        lWarp2 = (long)((*(uint *)(iVar1 + 0x76) & 0xf) * (*(uint *)(iVar1 + 0x76) & 0xf) * 5);
    }
    GetClientRect(hwndScanner, (RECT *)CONCAT42(CONCAT22(hwndScanner, unaff_SS), &rc));
    ExcludeClipRect(hdc, rc.left, rc.bottom - dySBar, rc.right, rc.bottom);
    HVar8 = SelectObject(hdc, hpenStarbase);
    sVar9 = SetROP2(hdc, 7);
    if (dx == 0) {
        dx5 = 0;
        dy5 = (int)lWarp2;
        if (dy < 0) {
            dy5 = -(int)lWarp2;
        }
    } else {
        uVar16 = __aFulmul((ulong)CONCAT62(CONCAT42(lWarp2, lWarp2._2_2_), (int)lWarp2), lWarp2);
        local_10e = (long)dy;
        sVar5 = dx;
        _sqrt((double)(long)uVar16 / (((double)local_10e / (double)(long)dx) * ((double)local_10e / (double)(long)dx) + 1.0));
        lVar17 = __ftol((double)CONCAT26(sVar5, CONCAT24(in_stack_0000fee8, CONCAT22(unaff_SI, unaff_DI))));
        dx5 = (short)lVar17;
        if (dx < 0) {
            dx5 = -dx5;
        }
        uVar18 = CONCAT62(CONCAT42((long)dx, dy >> 0xf), dy);
        uVar16 = __aFulmul((long)dx5, (ulong)uVar18);
        lVar17 = (long)((ulonglong)uVar18 >> 0x20);
        lVar17 = __aFldiv((long)CONCAT62(CONCAT42(lVar17, (int)(uVar16 >> 0x10)), (int)uVar16), lVar17);
        dy5 = (short)lVar17;
    }
    LogicalToScan(&ptCur);
    sVar5 = PtToScan(dx5);
    sVar6 = PtToScan(dy5);
    MoveTo(hdc, ptCur.x - sVar5, ptCur.y + sVar6);
    LineTo(hdc, ptCur.x + sVar5, ptCur.y + -sVar6);
    if (dy == 0) {
        ptTick.x = 0;
        if (dx < 0) {
            ptTick.y = -4;
        } else {
            ptTick.y = 4;
        }
    } else {
        local_10e = (long)-dx;
        sVar21 = dy;
        _sqrt(DOUBLE_24_0__1120_1ce2 / (((double)local_10e / (double)(long)dy) * ((double)local_10e / (double)(long)dy) + 1.0));
        lVar17 = __ftol((double)CONCAT26(sVar21, CONCAT24(in_stack_0000fee8, CONCAT22(unaff_SI, unaff_DI))));
        ptTick.x = (short)lVar17;
        if (ptTick.x == 0) {
            if (dy < 0) {
                ptTick.y = -4;
            } else {
                ptTick.y = 4;
            }
        } else {
            if (0 < dx) {
                ptTick.x = -ptTick.x;
            }
            uVar18 = CONCAT62(CONCAT42((long)dy, dx >> 0xf), dx);
            uVar16 = __aFulmul((long)ptTick.x, (ulong)uVar18);
            lVar17 = (long)((ulonglong)uVar18 >> 0x20);
            lVar17 = __aFldiv((long)CONCAT62(CONCAT42(lVar17, (int)(uVar16 >> 0x10)), (int)uVar16), lVar17);
            ptTick.y = (short)lVar17;
        }
    }
    local_10e = (long)-dx;
    pdVar7 = _atan2((double)(long)-dy, (double)local_10e);
    local_ee = *pdVar7 - DOUBLE_0_7853982__1120_1cea;
    for (i = 0; i < 2; i = i + 1) {
        uVar14 = SUB102((longdouble)5, 0);
        uVar22 = (undefined2)((unkuint10)(longdouble)5 >> 0x10);
        _cos(local_ee);
        lVar17 = __ftol((double)CONCAT26(uVar22, CONCAT24(uVar14, CONCAT22(unaff_SI, unaff_DI))));
        (rgptArrow + i)->x = (short)lVar17;
        uVar14 = SUB102((longdouble)5, 0);
        uVar22 = (undefined2)((unkuint10)(longdouble)5 >> 0x10);
        _sin(local_ee);
        lVar17 = __ftol((double)CONCAT26(uVar22, CONCAT24(uVar14, CONCAT22(unaff_SI, unaff_DI))));
        rgptArrow[i].y = (short)lVar17;
        local_ee = DOUBLE_1_5707964__1120_1cfa + local_ee;
    }
    j = -5;
    for (i = -5; i < 6; i = i + 1) {
        if (i == 0) {
            j = 5;
        } else {
            uVar18 = CONCAT62(CONCAT42(10, i >> 0xf), i);
            __aFulmul((long)sVar5, (ulong)uVar18);
            lVar19 = (long)((ulonglong)uVar18 >> 0x20);
            lVar17 = __aFlshl(lVar19, unaff_DI);
            lVar17 = __aFldiv((long)CONCAT62(CONCAT42(lVar19, (int)((ulong)(lVar17 + j) >> 0x10)), (int)(lVar17 + j)), lVar19);
            pt.x = (int)lVar17 + ptCur.x;
            uVar18 = CONCAT62(CONCAT42(10, i >> 0xf), i);
            __aFulmul((long)-sVar6, (ulong)uVar18);
            lVar19 = (long)((ulonglong)uVar18 >> 0x20);
            lVar17 = __aFlshl(lVar19, unaff_DI);
            lVar17 = __aFldiv((long)CONCAT62(CONCAT42(lVar19, (int)((ulong)(lVar17 + j) >> 0x10)), (int)(lVar17 + j)), lVar19);
            pt.y = (int)lVar17 + ptCur.y;
            if (i < 1) {
                MoveTo(hdc, pt.x + ptTick.x, pt.y + ptTick.y);
                LineTo(hdc, pt.x - ptTick.x, pt.y - ptTick.y);
                LineTo(hdc, pt.x - ptTick.x, (pt.y - ptTick.y) + -1);
            } else {
                for (j = 0; j < 2; j = j + 1) {
                    MoveTo(hdc, pt.x + (rgptArrow + j)->x, pt.y - rgptArrow[j].y);
                    LineTo(hdc, pt.x, pt.y);
                }
            }
        }
    }
    SetROP2(hdc, sVar9);
    SelectObject(hdc, HVar8);
SCAN_LNoObjPath:
    if (sel.grobj == grobjPlanet) {
        bVar3 = false;
        if (((sel.pl.wFlags_0x4 >> 9 & 1) != 0) && ((sel.pl.lStarbase._2_2_ & 0x3ff) != 0)) {
            hpenSav = SelectObject(hdc, hpenDkPurple);
            bVar3 = false;
            uVar4 = sel.pl.lStarbase._2_2_;
            goto SCAN_LDrawPath;
        }
        while ((uVar4 = sel.pl.wRouting, (sel.pl.wRouting & 0x3ff) != 0 && (!bVar3))) {
            bVar3 = true;
            hpenSav = SelectObject(hdc, hpenDkGreen);
        SCAN_LDrawPath:
            local_ee._6_2_ = (uVar4 & 0x3ff) - 1;
            sVar9 = SetROP2(hdc, 7);
            GetClientRect(hwndScanner, (RECT *)CONCAT42(CONCAT22(hwndScanner, unaff_SS), &rc));
            ExcludeClipRect(hdc, rc.left, rc.bottom - dySBar, rc.right, rc.bottom);
            pt.x = ((POINT *)rgptPlan + sel.pl.id)->x;
            pt.y = *(short *)((int)&rgptPlan[0].y + sel.pl.id * 4);
            LogicalToScan(&pt);
            MoveTo(hdc, pt.x, pt.y);
            pt.x = ((POINT *)rgptPlan + local_ee._6_2_)->x;
            pt.y = *(short *)((int)&rgptPlan[0].y + local_ee._6_2_ * 4);
            LogicalToScan(&pt);
            LineTo(hdc, pt.x, pt.y);
            SetROP2(hdc, sVar9);
            SelectObject(hdc, hpenSav);
        }
    } else if ((sel.grobj == grobjFleet) && (1 < sel.fl.cord)) {
        _memset(rgDup, 0, sel.fl.cord << 1);
        lpord1 = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_, (PLORD *)sel.fl.lpplord + 1);
        pt.x = (lpord1->pt).x;
        pt.y = *(short *)&((PLORD *)sel.fl.lpplord)[1].iordMax;
        for (i = 1; i < sel.fl.cord; i = i + 1) {
            lpord2 = (ORDER *)lpord1 + 1;
            pt2.x = (lpord2->pt).x;
            pt2.y = ((ORDER *)lpord1)[1].pt.y;
            j = i;
            if (rgDup[i] == 0) {
                while (j = j + 1, j < sel.fl.cord) {
                    uVar14 = (undefined2)((ulong)lpord2 >> 0x10);
                    pOVar12 = (ORDER *)lpord2;
                    if (((((pt.x == (lpord2->pt).x) && (pt.y == (pOVar12->pt).y)) && (pt2.x == ((pOVar12 + 1)->pt).x)) && (pt2.y == pOVar12[1].pt.y)) ||
                        (((pt2.x == (lpord2->pt).x && (pt2.y == (pOVar12->pt).y)) && ((pt.x == ((pOVar12 + 1)->pt).x && (pt.y == pOVar12[1].pt.y)))))) {
                        rgDup[i] = 1;
                        rgDup[j] = 2;
                    }
                    lpord2 = (ORDER *)CONCAT22(uVar14, pOVar12 + 1);
                }
            }
            pt.x = pt2.x;
            pt.y = pt2.y;
            lpord1 = (ORDER *)lpord1 + 1;
        }
        GetClientRect(hwndScanner, (RECT *)CONCAT42(CONCAT22(hwndScanner, unaff_SS), &rc));
        ExcludeClipRect(hdc, rc.left, rc.bottom - dySBar, rc.right, rc.bottom);
        if ((fShow != 0) && ((grbitScan & 0x80) != 0)) {
            HVar8 = SelectObject(hdc, hpenStarbase);
            uVar14 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
            pt.x = ((PLORD *)sel.fl.lpplord + 1)->wFlags;
            pt.y = *(short *)&((PLORD *)sel.fl.lpplord)[1].iordMax;
            LogicalToScan(&pt);
            MoveTo(hdc, pt.x, pt.y);
            for (i = 1; i < sel.fl.cord; i = i + 1) {
                psVar13 = (short *)((int)(PLORD *)sel.fl.lpplord + i * 0x12 + 4);
                pt2.x = *psVar13;
                pt2.y = psVar13[1];
                LogicalToScan(&pt2);
                LineTo(hdc, pt2.x, pt2.y);
                pt.x = pt2.x;
                pt.y = pt2.y;
            }
            SelectObject(hdc, HVar8);
        }
        HVar8 = SelectObject(hdc, hpenShip);
        sVar9 = SetROP2(hdc, 7);
        uVar14 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
        pt.x = ((PLORD *)sel.fl.lpplord + 1)->wFlags;
        pt.y = *(short *)&((PLORD *)sel.fl.lpplord)[1].iordMax;
        LogicalToScan(&pt);
        ExcludeClipRect(hdc, pt.x + -5, pt.y + -5, pt.x + 6, pt.y + 6);
        MoveTo(hdc, pt.x, pt.y);
        for (i = 1; i < sel.fl.cord; i = i + 1) {
            psVar13 = (short *)((int)(PLORD *)sel.fl.lpplord + i * 0x12 + 4);
            pt2.x = *psVar13;
            pt2.y = psVar13[1];
            LogicalToScan(&pt2);
            ExcludeClipRect(hdc, pt2.x + -5, pt2.y + -5, pt2.x + 6, pt2.y + 6);
            if (rgDup[i] == 2) {
                MoveTo(hdc, pt2.x, pt2.y);
            } else {
                if (rgDup[i] == 1) {
                    HVar10 = hpenYellow;
                    HVar20 = hdc;
                    if ((grbitScan & 0x80) == 0) {
                        HVar10 = GetStockObject(6);
                    }
                    SelectObject(HVar20, HVar10);
                }
                LineTo(hdc, pt2.x, pt2.y);
                if (rgDup[i] == 1) {
                    SelectObject(hdc, hpenShip);
                }
            }
            pt.x = pt2.x;
            pt.y = pt2.y;
        }
        SetROP2(hdc, sVar9);
        SelectObject(hdc, HVar8);
        SelectClipRgn(hdc, hrgnHuge);
    }
    if (bVar15) {
        ReleaseDC(hwndScanner, hdc);
    }
    return;
}

// ======================================================================
// Function: DrawScannerSBar
// Address: 1058:62d8
// Segment: MEMORY_SCAN
// ======================================================================

void DrawScannerSBar(HDC hdc, RECT *prc, SBAR *psbar, short fFullRedraw)

{
    bool       bVar1;
    BOOL       BVar2;
    HGDIOBJ    HVar3;
    short      sVar4;
    HGDIOBJ    HVar5;
    short      sVar6;
    GrobjClass GVar7;
    char      *pcVar8;
    ushort     uVar9;
    int        iVar10;
    int        iVar11;
    undefined2 unaff_SS;
    bool       bVar12;
    COLORREF   CVar13;
    DWORD      DVar14;
    DWORD      DVar15;
    undefined2 uVar16;
    RECT      *pRVar17;
    undefined2 uVar18;
    UINT       UVar19;
    UINT       UVar20;
    HDC        HVar21;
    char       szBuf[100];
    RECT       rc;
    RECT       rcT;
    short      grobj;
    long       l;
    short      fDoName;
    HBRUSH     hbrSav;
    char      *psz;
    RECT       rcClip;
    HFONT      hfontSav;
    short      dxHole;
    COLORREF   crBk;
    short      c;
    short      iBkPrev;
    short      grReal;
    POINT      pt;
    short      id;
    POINT      pt2;
    COLORREF   crText;
    short      fhdc;

    bVar1 = true;
    GetClientRect(hwndScanner, &rc);
    rc.top = rc.bottom - dySBar;
    if ((prc == (RECT *)0x0) || (BVar2 = IntersectRect(&rcT, prc, &rc), BVar2 != 0)) {
        bVar12 = hdc == 0;
        if (bVar12) {
            hdc = GetDC(hwndScanner);
        }
        HVar3 = SelectObject(hdc, rghfontArial8[1]);
        if (psbar == (SBAR *)0x0) {
            grobj = sel.scan.grobj;
        } else {
            grobj = psbar->grbit;
        }
        sVar4 = SetBkMode(hdc, 1);
        CVar13 = SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
        SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
        HVar5 = SelectObject(hdc, hbrButtonFace);
        if (fFullRedraw != 0) {
            PatBlt(hdc, rc.left, rc.top, rc.right - rc.left, dySBar, 0xf00021);
            SelectObject(hdc, hbrButtonHilite);
            PatBlt(hdc, rc.left, rc.top, 1, dySBar, 0xf00021);
            PatBlt(hdc, rc.left, rc.top, rc.right - rc.left, 1, 0xf00021);
        }
        rc.bottom = rc.bottom - (dySBar >> 1);
        rcT.right = rc.right;
        rcT.top = rc.top + 4;
        rcT.bottom = rc.bottom + -4;
        rcT.left = rc.left + 4;
        if (0x167 < rc.right) {
            DVar14 = GetTextExtent(hdc, s_ID_000_1120_05a2, 7);
            rcT.right = (int)DVar14 + 6 + rcT.left;
            DrawLockLight(hdc, &rcT, fFullRedraw);
            if ((grobj & 1U) == 0) {
                if (grobj == 4) {
                    if (psbar == (SBAR *)0x0) {
                        id = sel.scan.iwp;
                    } else {
                        id = psbar->id;
                    }
                    sVar6 = _wsprintf(szWork, s_WP_d_1120_05b1, id);
                    TextOut(hdc, rcT.left + 3, rcT.top + 2, szWork, sVar6);
                }
            } else {
                if (psbar == (SBAR *)0x0) {
                    id = sel.scan.idpl;
                } else {
                    id = psbar->id;
                }
                if (id != -1) {
                    sVar6 = _wsprintf(szWork, s_ID_d_1120_05aa, id + 1);
                    SetBkMode(hdc, 2);
                    TextOut(hdc, rcT.left + 3, rcT.top + 2, szWork, sVar6);
                }
            }
            DVar15 = GetTextExtent(hdc, s_X_8888_1120_05b8, 7);
            iVar10 = (int)DVar15;
            rcT.left = rcT.left + (int)DVar14 + 10;
            rcT.right = iVar10 + 6 + rcT.left;
            DrawLockLight(hdc, &rcT, fFullRedraw);
            if (psbar == (SBAR *)0x0) {
                if (grobj == 0) {
                    pt.y = 0;
                    pt.x = 0;
                } else {
                    pt.x = sel.scan.pt.x;
                    pt.y = sel.scan.pt.y;
                }
            } else {
                pt.x = (&psbar->pt)->x;
                pt.y = (psbar->pt).y;
            }
            if (0 < pt.x) {
                sVar6 = _wsprintf(szWork, s_X_d_1120_05c0, pt.x);
                SetBkMode(hdc, 2);
                TextOut(hdc, rcT.left + 3, rcT.top + 2, szWork, sVar6);
            }
            rcT.left = rcT.left + iVar10 + 10;
            rcT.right = iVar10 + 6 + rcT.left;
            DrawLockLight(hdc, &rcT, fFullRedraw);
            if (0 < pt.y) {
                sVar6 = _wsprintf(szWork, s_Y_d_1120_05c6, pt.y);
                SetBkMode(hdc, 2);
                TextOut(hdc, rcT.left + 3, rcT.top + 2, szWork, sVar6);
            }
            rcT.left = rcT.left + iVar10 + 10;
        }
        rcT.right = rc.right + -4;
        DrawLockLight(hdc, &rcT, fFullRedraw);
        rcClip.left = rcT.left;
        rcClip.top = rcT.top;
        rcClip.right = rcT.right;
        rcClip.bottom = rcT.bottom;
        ExpandRc(&rcClip, -2, -2);
        GVar7 = sel.scan.grobjFull;
        if (grobj != 4) {
            GVar7 = grobj;
        }
        if ((psbar == (SBAR *)0x0) || (psbar->psz == (char *)0x0)) {
            if ((GVar7 & grobjPlanet) == grobjNone) {
                if ((GVar7 & grobjFleet) == grobjNone) {
                    if ((GVar7 & grobjThing) == grobjNone) {
                        if ((GVar7 == grobjNone) && (grobj == 4)) {
                            CchGetString(idsDeepSpaceWaypoint, (char *)szWork);
                        } else {
                            bVar1 = false;
                        }
                    } else {
                        if (psbar == (SBAR *)0x0) {
                            uVar9 = ((THING *)lpThings + sel.scan.ith)->idFull;
                        } else {
                            uVar9 = psbar->id;
                        }
                        PszGetThingName(uVar9);
                    }
                } else {
                    if (psbar == (SBAR *)0x0) {
                        sVar6 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
                    } else {
                        sVar6 = psbar->id;
                    }
                    PszGetFleetName(sVar6);
                }
            } else {
                sVar6 = sel.scan.idpl;
                if (psbar != (SBAR *)0x0) {
                    sVar6 = psbar->id;
                }
                PszGetPlanetName(sVar6);
            }
        } else {
            _strcpy((char *)szWork, psbar->psz);
        }
        if (bVar1) {
            iVar10 = rcT.left + 3;
            iVar11 = rcT.top + 2;
            UVar19 = 4;
            pRVar17 = &rcClip;
            uVar16 = 0x1120;
            pcVar8 = (char *)szWork;
            uVar18 = unaff_SS;
            HVar21 = hdc;
            UVar20 = lstrlen(szWork);
            ExtTextOut(HVar21, iVar10, iVar11, UVar19, (RECT *)CONCAT22(uVar18, pRVar17), (LPCSTR)CONCAT22(uVar16, pcVar8), UVar20, (short *)0x0);
        }
        OffsetRc(&rc, 0, dySBar >> 1);
        rcT.top = rc.top + 4;
        rcT.bottom = rc.bottom + -4;
        rcT.left = rc.left + 4;
        rcT.right = rc.right + -4;
        DrawLockLight(hdc, &rcT, fFullRedraw);
        rcClip.left = rcT.left;
        rcClip.top = rcT.top;
        rcClip.right = rcT.right;
        rcClip.bottom = rcT.bottom;
        ExpandRc(&rcClip, -2, -2);
        if (psbar == (SBAR *)0x0) {
            if (grobj == 0) {
                pt.y = 0;
                pt.x = 0;
            } else {
                pt.x = sel.scan.pt.x;
                pt.y = sel.scan.pt.y;
            }
        } else {
            pt.x = (&psbar->pt)->x;
            pt.y = (psbar->pt).y;
        }
        if ((psbar == (SBAR *)0x0) || (psbar->pscan == (SCAN *)0x0)) {
            if ((sel.grobj == grobjFleet) || (sel.grobj == grobjPlanet)) {
                pt2.x = sel.pt.x;
                pt2.y = sel.pt.y;
            } else {
                pt2.x = -1;
            }
        } else {
            pt2.x = (psbar->pscan->pt).x;
            pt2.y = (psbar->pscan->pt).y;
        }
        if (((pt.x != -1) && (pt2.x != -1)) && ((pt.x != pt2.x || (pt.y != pt2.y)))) {
            pcVar8 = PszGetDistance(pt.x, pt.y, pt2.x, pt2.y);
            _strcpy(szBuf, pcVar8);
            for (psz = szBuf; *psz != ' '; psz = psz + 1) {
            }
            CchGetString((0x15d < rc.right) + idsLy, psz + 1);
            if ((psbar == (SBAR *)0x0) || (psbar->pscan == (SCAN *)0x0)) {
                uVar9 = _strlen(psz);
                CchGetString(idsFrom, psz + uVar9);
                pcVar8 = PszGetLocName(sel.grobj, sel.id, pt2.x, pt2.y);
                _strcat(psz + 8, pcVar8);
            }
            iVar10 = rcT.left + 3;
            iVar11 = rcT.top + 2;
            UVar20 = 4;
            pRVar17 = &rcClip;
            pcVar8 = szBuf;
            uVar18 = unaff_SS;
            HVar21 = hdc;
            uVar9 = _strlen(szBuf);
            ExtTextOut(HVar21, iVar10, iVar11, UVar20, (RECT *)CONCAT22(uVar18, pRVar17), pcVar8, uVar9, (short *)0x0);
        }
        SelectObject(hdc, HVar5);
        SetBkMode(hdc, sVar4);
        SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
        SetBkColor(hdc, CVar13);
        SelectObject(hdc, HVar3);
        if (bVar12) {
            ReleaseDC(hwndScanner, hdc);
        }
    }
    return;
}

// ======================================================================
// Function: DrawLockLight
// Address: 1058:6b00
// Segment: MEMORY_SCAN
// ======================================================================

void DrawLockLight(HDC hdc, RECT *prc, short fFullRedraw)

{
    int        iVar1;
    int        iVar2;
    undefined2 unaff_SS;
    RECT       rc;
    short      dx;
    short      dy;

    iVar1 = prc->right - prc->left;
    iVar2 = prc->bottom - prc->top;
    if (fFullRedraw == 0) {
        rc.left = prc->left;
        rc.top = prc->top;
        rc.right = prc->right;
        rc.bottom = prc->bottom;
        ExpandRc(&rc, -2, -2);
        FillRect(hdc, &rc, hbrButtonFace);
    } else {
        SelectObject(hdc, hbrButtonShadow);
        PatBlt(hdc, prc->left, prc->top, 1, iVar2, 0xf00021);
        PatBlt(hdc, prc->left, prc->top, iVar1, 1, 0xf00021);
        SelectObject(hdc, hbrButtonHilite);
        PatBlt(hdc, prc->right, prc->top, 1, iVar2 + 1, 0xf00021);
        PatBlt(hdc, prc->left, prc->bottom, iVar1, 1, 0xf00021);
    }
    return;
}

// ======================================================================
// Function: SetScanScrollBars
// Address: 1058:6c14
// Segment: MEMORY_SCAN
// ======================================================================

void SetScanScrollBars(HWND hwnd)

{
    short      sVar1;
    short      sVar2;
    int        iVar3;
    int        iVar4;
    undefined2 unaff_SS;
    RECT       rc;
    short      dx;
    short      yMax;
    short      dy;
    short      xMax;

    fInScrollSet = 1;
    GetClientRect(hwnd, &rc);
    sVar1 = ScanToPt(rc.right);
    sVar2 = ScanToPt(rc.bottom - dySBar);
    if ((dGalInv + -1000) - sVar1 < 1000) {
        iVar3 = 1000;
    } else {
        iVar3 = (dGalInv + -1000) - sVar1;
    }
    if ((dGalInv + -1000) - sVar2 < 1000) {
        iVar4 = 1000;
    } else {
        iVar4 = (dGalInv + -1000) - sVar2;
    }
    SetScrollRange(hwnd, 0, 1000, iVar3 + 3U & 0xfffc, 1);
    if ((fInScrollSet != 0) && (SetScrollRange(hwnd, 1, 1000, iVar4 + 3U & 0xfffc, 1), fInScrollSet != 0)) {
        if (sVar2 <= sVar1) {
            sVar1 = sVar2;
        }
        dScanPage = sVar1 / 3 & 0xfffc;
        dScanInc = dScanPage / 8 + 2U & 0xfffc;
        fInScrollSet = 0;
    }
    return;
}

// ======================================================================
// Function: ScrollScanner
// Address: 1058:6d30
// Segment: MEMORY_SCAN
// ======================================================================

void ScrollScanner(short dx, short dy)

{
    BOOL        BVar1;
    HDC         hdc_00;
    short       sVar2;
    undefined1 *puVar3;
    undefined2  uVar4;
    undefined2  unaff_SS;
    RECT        rc;
    RECT        rcUpd2;
    RECT        rcUpd;
    HDC         hdc;

    if ((((dx != 0) || (dy != 0)) && (BVar1 = IsWindowVisible(hwndScanner), BVar1 != 0)) && (((uint)gd.grBits2 & 1) == 0)) {
        hdc_00 = GetDC(hwndScanner);
        GetClientRect(hwndScanner, &rc);
        sVar2 = _abs(dx);
        if (((rc.right >> 1 < sVar2) || (sVar2 = _abs(dy), rc.bottom >> 1 < sVar2)) || ((fDlgUp != 0 || (hwndBrowser != 0)))) {
            uVar4 = 0x1058;
            DrawScanner(hdc_00, &rc);
            puVar3 = &stack0xffdc;
        } else {
            rc.bottom = rc.bottom - dySBar;
            UpdateWindow(hwndScanner);
            ScrollWindow(hwndScanner, dx, dy, &rc, &rc);
            if (dy < 1) {
                if (dy < 0) {
                    SetRect(&rcUpd2, 0, rc.bottom + dy, rc.right, rc.bottom);
                    rc.bottom = rc.bottom + dy;
                }
            } else {
                SetRect(&rcUpd2, 0, 0, rc.right, dy);
                rc.top = rc.top + dy;
            }
            if (dx < 1) {
                if (dx < 0) {
                    rcUpd.top = rc.top;
                    rcUpd.right = rc.right;
                    rcUpd.bottom = rc.bottom;
                    rcUpd.left = rc.right + dx;
                    rc.left = rc.left - dx;
                }
            } else {
                SetRect(&rcUpd, 0, rc.top, dx, rc.bottom);
                rc.right = rc.right - dx;
            }
            puVar3 = &stack0xffdc;
            if (dx != 0) {
                ValidateRect(hwndScanner, &rcUpd);
                puVar3 = &stack0xffe0;
            }
            if (dy != 0) {
                *(HWND *)(puVar3 + -2) = hwndScanner;
                *(undefined2 *)(puVar3 + -4) = unaff_SS;
                *(RECT **)(puVar3 + -6) = &rcUpd2;
                *(undefined2 *)(puVar3 + -8) = 0x14f8;
                *(undefined2 *)(puVar3 + -10) = 0x6ee5;
                ValidateRect(*(HWND *)(puVar3 + -2), *(RECT **)(puVar3 + -6));
                puVar3 = puVar3 + 4;
            }
            uVar4 = 0x14f8;
            if (dx != 0) {
                *(RECT **)(puVar3 + -2) = &rcUpd;
                *(HDC *)(puVar3 + -4) = hdc_00;
                *(undefined2 *)(puVar3 + -6) = 0x14f8;
                uVar4 = 0x1058;
                *(undefined2 *)(puVar3 + -8) = 0x6efa;
                DrawScanner(*(HDC *)(puVar3 + -4), *(RECT **)(puVar3 + -2));
            }
            if (dy != 0) {
                *(RECT **)(puVar3 + -2) = &rcUpd2;
                *(HDC *)(puVar3 + -4) = hdc_00;
                *(undefined2 *)(puVar3 + -6) = uVar4;
                uVar4 = 0x1058;
                *(undefined2 *)(puVar3 + -8) = 0x6f12;
                DrawScanner(*(HDC *)(puVar3 + -4), *(RECT **)(puVar3 + -2));
            }
            *(HWND *)(puVar3 + -2) = hwndScanner;
            *(undefined2 *)(puVar3 + -4) = uVar4;
            uVar4 = 0x14f8;
            *(undefined2 *)(puVar3 + -6) = 0x6f1e;
            UpdateWindow(*(HWND *)(puVar3 + -2));
        }
        *(HWND *)(puVar3 + -2) = hwndScanner;
        *(HDC *)(puVar3 + -4) = hdc_00;
        *(undefined2 *)(puVar3 + -6) = uVar4;
        *(undefined2 *)(puVar3 + -8) = 0x6f2a;
        ReleaseDC(*(HWND *)(puVar3 + -2), *(HDC *)(puVar3 + -4));
    }
    return;
}

// ======================================================================
// Function: RedrawScanSel
// Address: 1058:6f30
// Segment: MEMORY_SCAN
// ======================================================================

void RedrawScanSel(HDC hdc, short fVis)

{
    short     *psVar1;
    SCAN      *pSVar2;
    GrobjClass GVar3;
    GrobjClass GVar4;
    short      sVar5;
    BOOL       BVar6;
    int        iVar7;
    short     *psVar8;
    SCAN      *pSVar9;
    undefined2 unaff_SS;
    bool       bVar10;
    bool       bVar11;
    short      sel_grobjFull;
    RECT       rc;
    SCAN       sel_scan;
    short      fNoSelRedraw;
    short      sel_id;
    POINT      pt;
    short      dOff;
    short      fhdc;
    short      sel_grobj;

    sVar5 = sel.id;
    GVar4 = sel.grobjFull;
    GVar3 = sel.grobj;
    psVar8 = (short *)&sel.scan;
    pSVar9 = &sel_scan;
    for (iVar7 = 8; iVar7 != 0; iVar7 = iVar7 + -1) {
        pSVar2 = pSVar9;
        pSVar9 = &(pSVar9->pt).y;
        psVar1 = psVar8;
        psVar8 = psVar8 + 1;
        (pSVar2->pt).x = *psVar1;
    }
    if ((hwndScanner != 0) && (BVar6 = IsWindowVisible(hwndScanner), BVar6 != 0)) {
        bVar10 = fVis == -1;
        if (bVar10) {
            fVis = 0;
        }
        bVar11 = hdc == 0;
        if (bVar11) {
            hdc = GetDC(hwndScanner);
        }
        DrawShipScanPath(hdc, fVis);
        if (fVis == 0) {
            sel.scan.iwp = -1;
            sel.scan.ifl = -1;
            sel.scan.idpl = -1;
            sel.id = -1;
            sel.grobjFull = grobjNone;
            sel.grobj = grobjNone;
            sel.scan.grobjFull = grobjNone;
            sel.scan.grobj = grobjNone;
        }
        if ((iScanZoom < 3) || ((grbitScan & 0xf) != 4)) {
            if ((grbitScan & 0x1000) == 0) {
                iVar7 = 0;
            } else {
                iVar7 = 7;
            }
        } else {
            iVar7 = 0xb;
        }
        if ((GVar3 != grobjNone) && (!bVar10)) {
            pt.x = sel.pt.x;
            pt.y = sel.pt.y;
            LogicalToScan(&pt);
            SetRect(&rc, (pt.x + -0xb) - iVar7, (pt.y + -0xb) - iVar7, pt.x + 0xc + iVar7, pt.y + 0x17 + iVar7);
            DrawScanner(hdc, &rc);
        }
        if ((sel_scan.grobj != grobjNone) && ((sel_scan.pt.x != sel.pt.x || (sel_scan.pt.y != sel.pt.y)))) {
            pt.x = sel_scan.pt.x;
            pt.y = sel_scan.pt.y;
            LogicalToScan(&pt);
            SetRect(&rc, (pt.x + -6) - iVar7, (pt.y + -6) - iVar7, pt.x + 7 + iVar7, pt.y + 0xf + iVar7);
            DrawScanner(hdc, &rc);
        }
        if (fVis == 0) {
            pSVar9 = &sel_scan;
            psVar8 = (short *)&sel.scan;
            sel.grobj = GVar3;
            sel.grobjFull = GVar4;
            sel.id = sVar5;
            for (iVar7 = 8; iVar7 != 0; iVar7 = iVar7 + -1) {
                psVar1 = psVar8;
                psVar8 = psVar8 + 1;
                pSVar2 = pSVar9;
                pSVar9 = &(pSVar9->pt).y;
                *psVar1 = (pSVar2->pt).x;
            }
        }
        if (bVar11) {
            ReleaseDC(hwndScanner, hdc);
        }
    }
    return;
}

// ======================================================================
// Function: FEnsurePointOnScreen
// Address: 1058:715c
// Segment: MEMORY_SCAN
// ======================================================================

short FEnsurePointOnScreen(POINT pt, short fScroll)

{
    POINT      pt_00;
    short      sVar1;
    short      sVar2;
    BOOL       BVar3;
    undefined2 unaff_SS;
    RECT       rc;
    POINT      ptCtr;
    short      cx;
    short      fFix;
    short      cy;

    GetClientRect(hwndScanner, &rc);
    rc.bottom = rc.bottom - dySBar;
    sVar1 = ScanToPt(rc.right);
    sVar2 = ScanToPt(rc.bottom);
    rc.left = xScanTop + 10;
    rc.right = xScanTop + sVar1 + -0x14;
    rc.bottom = (dGalInv - yScanTop) + -10;
    rc.top = (rc.bottom - sVar2) + 0x14;
    BVar3 = PtInRect(&rc, pt);
    if (BVar3 == 0) {
        ptCtr.x = (sVar1 >> 1) + xScanTop;
        ptCtr.y = (dGalInv - yScanTop) - (sVar2 >> 1);
        if (pt.x < rc.left) {
            ptCtr.x = ptCtr.x - (rc.left - pt.x);
        } else if (rc.right < pt.x) {
            ptCtr.x = ptCtr.x + (pt.x - rc.right);
        }
        if (pt.y < rc.top) {
            ptCtr.y = ptCtr.y - (rc.top - pt.y);
        } else if (rc.bottom < pt.y) {
            ptCtr.y = ptCtr.y + (pt.y - rc.bottom);
        }
        pt_00.y = ptCtr.y;
        pt_00.x = ptCtr.x;
        CtrPointScan(pt_00, fScroll);
        sVar1 = 0;
    } else {
        sVar1 = 1;
    }
    return sVar1;
}

// ======================================================================
// Function: CtrPointScan
// Address: 1058:7278
// Segment: MEMORY_SCAN
// ======================================================================

void CtrPointScan(POINT pt, short fScroll)

{
    short      sVar1;
    short      sVar2;
    int        iVar3;
    int        iVar4;
    uint       uVar5;
    uint       uVar6;
    short      sVar7;
    short      sVar8;
    undefined2 unaff_SS;
    ulong      uVar9;
    RECT       rc;
    short      x;
    short      dyCur;
    short      cx;
    short      y;
    short      cy;
    short      dxCur;

    if (hwndScanner != 0) {
        GetClientRect(hwndScanner, &rc);
        rc.bottom = rc.bottom - dySBar;
        sVar1 = ScanToPt(rc.right);
        sVar2 = ScanToPt(rc.bottom);
        sVar8 = xScanTop;
        sVar7 = yScanTop;
        if (pt.x - (sVar1 >> 1) < 0x3e9) {
            iVar3 = 1000;
        } else {
            iVar3 = pt.x - (sVar1 >> 1);
        }
        if ((sVar2 >> 1) + pt.y < dGalInv + -1000) {
            iVar4 = (sVar2 >> 1) + pt.y;
        } else {
            iVar4 = dGalInv + -1000;
        }
        if ((dGalInv + -1000) - sVar1 <= iVar3) {
            iVar3 = (dGalInv + -1000) - sVar1;
        }
        if (iVar4 <= sVar2 + 1000) {
            iVar4 = sVar2 + 1000;
        }
        iVar4 = dGalInv - iVar4;
        if (iVar3 < 0x3e9) {
            iVar3 = 1000;
        }
        if (iVar4 < 0x3e9) {
            iVar4 = 1000;
        }
        uVar5 = iVar3 + 2U & 0xfffc;
        uVar6 = iVar4 + 2U & 0xfffc;
        if ((xScanTop != uVar5) || (yScanTop != uVar6)) {
            xScanTop = uVar5;
            SetScrollPos(hwndScanner, 0, iVar3 + 2U & 0xfffc, 1);
            uVar9 = CONCAT22(1, iVar4 + 2U) & 0xfffffffc;
            yScanTop = uVar6;
            SetScrollPos(hwndScanner, (short)(uVar9 >> 0x10), (short)uVar9, 1);
            if (fScroll == 0) {
                InvalidateRect(hwndScanner, (RECT *)0x0, 0);
            } else {
                sVar7 = PtToScan(sVar7 - uVar6);
                sVar8 = PtToScan(sVar8 - uVar5);
                ScrollScanner(sVar8, sVar7);
            }
        }
    }
    return;
}

// ======================================================================
// Function: LogicalToScan
// Address: 1058:744e
// Segment: MEMORY_SCAN
// ======================================================================

void LogicalToScan(POINT *ppt)

{
    short sVar1;

    sVar1 = PtToScan(ppt->x - xScanTop);
    ppt->x = sVar1;
    sVar1 = PtToScan((dGalInv - ppt->y) - yScanTop);
    ppt->y = sVar1;
    return;
}

// ======================================================================
// Function: ScanToLogical
// Address: 1058:7490
// Segment: MEMORY_SCAN
// ======================================================================

void ScanToLogical(POINT *ppt)

{
    short sVar1;

    sVar1 = ScanToPt(ppt->x);
    ppt->x = sVar1 + xScanTop;
    sVar1 = ScanToPt(ppt->y);
    ppt->y = dGalInv - (sVar1 + yScanTop);
    if (dGal + 1000 < ppt->x) {
        ppt->x = dGal + 1000;
    }
    if (ppt->y < 1000) {
        ppt->y = 1000;
    }
    return;
}

// ======================================================================
// Function: FAddWayPoint
// Address: 1058:7504
// Segment: MEMORY_SCAN
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x1058763d) */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short FAddWayPoint(POINT ptIn, SCAN *pscan)

{
    byte      *pbVar1;
    ORDER     *pOVar2;
    ORDER     *pOVar3;
    GrobjClass GVar4;
    char      *pcVar5;
    int        iVar6;
    int        iVar7;
    short      sVar8;
    HDC        hdc_00;
    uint       uVar9;
    ORDER     *pOVar10;
    short     *psVar11;
    ORDER     *pOVar12;
    undefined2 unaff_SS;
    ulong      uVar13;
    ulong      uVar14;
    undefined2 uVar15;
    RECT       rc;
    short      ipt;
    short      cpt;
    short      dx;
    POINT      rgpt[3];
    short      lDist;
    ORDER     *lpord;
    short      dy;
    short      id;
    HDC        hdc;

    if (sel.fl.cord == 0x57) {
        MessageBeep(0x40);
        uVar15 = 0x56;
        pcVar5 = PszGetCompressedString(idsCantHaveDWaypoints);
        _wsprintf(szWork, pcVar5, uVar15);
        AlertSz((char *)szWork, 0x10);
        sVar8 = 0;
    } else {
        if ((grbitScan & 0x80) != 0) {
            rgpt[0].x = ptIn.x;
            rgpt[0].y = ptIn.y;
            rgpt[1].x = (pscan->pt).x;
            rgpt[1].y = (pscan->pt).y;
            if (sel.iwpAct < sel.fl.cord + -1) {
                cpt = 3;
                psVar11 = (short *)((int)(PLORD *)sel.fl.lpplord + (sel.iwpAct + 1) * 0x12 + 4);
                rgpt[2].x = *psVar11;
                rgpt[2].y = psVar11[1];
            } else {
                cpt = 2;
            }
        }
        iVar6 = ptIn.x - (pscan->pt).x;
        iVar7 = ptIn.y - (pscan->pt).y;
        sVar8 = ScanToPt(0x14);
        uVar13 = __aFulmul((long)iVar7, (long)iVar7);
        rc.bottom = (short)uVar13;
        uVar14 = __aFulmul((long)iVar6, (long)iVar6);
        rc._2_4_ = uVar14 + CONCAT22((int)(uVar13 >> 0x10), rc.bottom);
        if ((long)(sVar8 * sVar8) < (long)rc._2_4_) {
            pscan->grobjFull = grobjOther;
            pscan->grobj = grobjOther;
            pscan->idpl = -1;
            pscan->ifl = -1;
            pscan->iwp = sel.iwpAct + 1;
            (pscan->pt).x = ptIn.x;
            (pscan->pt).y = ptIn.y;
        }
        uVar15 = sel.fl.lpplord._2_2_;
        rc.bottom = (short)((PLORD *)sel.fl.lpplord + 1);
        pOVar10 = (ORDER *)(rc.bottom + sel.iwpAct * 0x12);
        lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_, pOVar10);
        if (((pscan->pt).x == (lpord->pt).x) && ((pscan->pt).y == (pOVar10->pt).y)) {
            sVar8 = 0;
        } else if ((sel.iwpAct < sel.fl.cord + -1) && (((pscan->pt).x == ((pOVar10 + 1)->pt).x && ((pscan->pt).y == pOVar10[1].pt.y)))) {
            sVar8 = 0;
        } else {
            hdc_00 = GetDC(hwndScanner);
            DrawShipScanPath(hdc_00, 0);
            if ((uint)((PLORD *)sel.fl.lpplord)->iordMax == sel.fl.cord) {
                sel.fl.lpplord = LpplReAlloc(sel.fl.lpplord, sel.fl.cord + 3);
                rc.bottom = (short)((PL *)sel.fl.lpplord + 1);
                lpord = (ORDER *)CONCAT22((int)((ulong)sel.fl.lpplord >> 0x10), (ORDER *)(rc.bottom + (sel.iwpAct + 1) * 0x12));
            } else {
                lpord = (ORDER *)CONCAT22(uVar15, pOVar10 + 1);
            }
            if (sel.iwpAct != sel.fl.cord + -1) {
                __fmemmove((ORDER *)lpord + 1, lpord, ((sel.fl.cord - sel.iwpAct) + -1) * 0x12);
            }
            pOVar10 = (ORDER *)lpord + -1;
            pOVar12 = (ORDER *)lpord;
            for (iVar6 = 9; iVar6 != 0; iVar6 = iVar6 + -1) {
                pOVar3 = pOVar12;
                pOVar12 = &(pOVar12->pt).y;
                pOVar2 = pOVar10;
                pOVar10 = &(pOVar10->pt).y;
                (pOVar3->pt).x = (pOVar2->pt).x;
            }
            sVar8 = (pscan->pt).y;
            (lpord->pt).x = (pscan->pt).x;
            (((ORDER *)lpord)->pt).y = sVar8;
            GVar4 = pscan->grobj;
            if (GVar4 == grobjPlanet) {
                id = pscan->idpl;
            } else if (GVar4 == grobjFleet) {
                id = ((FLEET **)rglpfl)[pscan->ifl]->id;
            } else if (GVar4 == grobjOther) {
                id = pscan->iwp;
            } else if (GVar4 == grobjThing) {
                id = ((THING *)lpThings + pscan->ith)->idFull;
            }
            ((ORDER *)lpord)->id = id;
            ((ORDER *)lpord)->wFlags_0x6 = ((ORDER *)lpord)->wFlags_0x6 & 0xf0ff | (pscan->grobj & (grobjThing | grobjOther | grobjFleet | grobjPlanet)) << 8;
            sel.fl.cord = sel.fl.cord + 1;
            pbVar1 = &((PLORD *)sel.fl.lpplord)->iordMac;
            *pbVar1 = *pbVar1 + 1;
            uVar9 = IWarpBestForWaypoint(&sel.fl, lpord);
            ((ORDER *)lpord)->wFlags_0x6 = ((ORDER *)lpord)->wFlags_0x6 & 0xff0f | (uVar9 & 0xf) << 4;
            pscan->grobj = grobjOther;
            pscan->grobjFull = pscan->grobjFull | grobjOther;
            pscan->iwp = sel.iwpAct + 1;
            RedrawScanSel(0, 0);
            FLookupFleet(-1, (FLEET *)&sel.fl);
            if (((((ORDER *)lpord)[-1].wFlags_0x6 & 0xf) == 6) && (((&((ORDER *)lpord)[-1].u_ORDER_0x0008)->tlm).cTime == 5)) {
                __fmemset((u_ORDER_0x0008 *)CONCAT22(lpord._2_2_, &((ORDER *)lpord)[-1].u_ORDER_0x0008), 0, 10);
                ((ORDER *)lpord)[-1].wFlags_0x6 = ((ORDER *)lpord)[-1].wFlags_0x6 & 0xfff0;
                FLookupFleet(-1, (FLEET *)&sel.fl);
            }
            ChangeScanSel(pscan, 1);
            ReleaseDC(hwndScanner, hdc_00);
            if ((grbitScan & 0x80) != 0) {
                for (ipt = 0; ipt < cpt; ipt = ipt + 1) {
                    LogicalToScan(rgpt + ipt);
                }
                BoundPoints(&rc, rgpt, cpt);
                InvalidateRect(hwndScanner, &rc, 0);
            }
            sVar8 = 1;
        }
    }
    return sVar8;
}

// ======================================================================
// Function: IWarpBestForWaypoint
// Address: 1058:7a18
// Segment: MEMORY_SCAN
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10587e7e) */
/* WARNING: Removing unreachable block (ram,0x10587d6c) */
/* WARNING: Removing unreachable block (ram,0x10587f25) */

short IWarpBestForWaypoint(FLEET *lpfl, ORDER *lpord)

{
    uint       uVar1;
    POINT      pt;
    POINT      ptSrc;
    POINT      ptDst;
    bool       bVar2;
    bool       bVar3;
    uint       uVar4;
    int        iVar5;
    short      sVar6;
    ORDER     *pOVar7;
    FLEET     *pFVar8;
    int        iVar9;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar10;
    undefined2 uVar11;
    ulong      uVar12;
    long       lVar13;
    HULDEF    *pHVar14;
    long       lVar15;
    long       lVar16;
    undefined2 uVar17;
    undefined2 uVar18;
    undefined2 uVar19;
    undefined2 uVar20;
    undefined2 in_stack_0000ffcc;
    undefined2 in_stack_0000ffce;
    SCAN       scan;
    short      iWarpOld;
    undefined4 local_1e;
    short      iWarpSav;
    short      iWarpAi;
    short      fGoFlatOut;
    short      fGoFlatOutAi;
    short      cSpeed;
    short      lDist;
    short      iwp;
    short      cTravel;
    short      iWarp;
    long       lFuel;

    uVar10 = (undefined2)((ulong)lpord >> 0x10);
    pOVar7 = (ORDER *)lpord;
    uVar1 = pOVar7->wFlags_0x6;
    uVar4 = IFindIdealWarp((FLEET *)0x0, 0);
    if (fAi != 0) {
        iWarpAi = IFindIdealWarp((FLEET *)0x0, 1);
    }
    lVar16 = CONCAT22(in_stack_0000ffce, in_stack_0000ffcc);
    uVar11 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar8 = (FLEET *)lpfl;
    iwp = pFVar8->cord;
    do {
        iwp = iwp + -1;
        if (iwp < 0)
            break;
    } while (lpord != (ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar8->lpplord + 2), (ORDER *)(*(int *)&pFVar8->lpplord + 4 + iwp * 0x12)));
    if (iwp < 1) {
        return uVar4;
    }
    if (((pOVar7->wFlags_0x6 & 0xf) == 2) || ((pOVar7->wFlags_0x6 & 0xf) == 5)) {
        bVar2 = true;
    } else {
        bVar2 = false;
        for (local_1e._0_2_ = (PLANET *)0x0; local_1e._2_2_ = 0, (int)(PLANET *)local_1e < 0x10; local_1e._0_2_ = (PLANET *)((int)(PLANET *)local_1e + 1)) {
            if (0 < pFVar8->rgcsh[(int)(PLANET *)local_1e]) {
                for (;
                     iVar9 = pFVar8->iPlayer * 4, local_1e._2_2_ < (int)(uint) * (byte *)(*(int *)(iVar9 + rglpshdef) + (int)(PLANET *)local_1e * 0x93 + 0x7a);
                     local_1e._2_2_ = local_1e._2_2_ + 1) {
                    iVar9 = pFVar8->iPlayer * 4;
                    if ((*(int *)(*(int *)(iVar9 + rglpshdef) + (int)(PLANET *)local_1e * 0x93 + 0x3a + local_1e._2_2_ * 4) == 0x1000) &&
                        ((iVar9 = pFVar8->iPlayer * 4,
                          (*(uint *)(*(int *)(iVar9 + rglpshdef) + (int)(PLANET *)local_1e * 0x93 + local_1e._2_2_ * 4 + 0x3c) & 0xff) == 0 ||
                              (iVar9 = pFVar8->iPlayer * 4,
                               (*(uint *)(*(int *)(iVar9 + rglpshdef) + (int)(PLANET *)local_1e * 0x93 + local_1e._2_2_ * 4 + 0x3c) & 0xff) == 1)))) {
                        bVar2 = true;
                        break;
                    }
                }
            }
        }
    }
    if ((bVar2) || (fAi == 0)) {
        bVar3 = false;
    } else {
        bVar3 = true;
        bVar2 = true;
    }
    iWarp = uVar4;
    if ((int)uVar4 < 9) {
        pt.y = (pOVar7->pt).y;
        pt.x = (lpord->pt).x;
        sVar6 = FFindNearestObject(pt, 0x81, &scan);
        if (sVar6 == 0) {
            local_1e = (PLANET *)0x0;
        } else {
            local_1e = LpplFromId(scan.idpl);
        }
        lVar16 = CONCAT22(in_stack_0000ffce, in_stack_0000ffcc);
        if ((bVar2) || ((((PLANET *)local_1e != (PLANET *)0x0 || (local_1e._2_2_ != 0)) &&
                         ((((PLANET *)local_1e)->iPlayer == -1 || (((PLANET *)local_1e)->iPlayer == idPlayer)))))) {
            if ((bVar3) && (((((PLANET *)local_1e != (PLANET *)0x0 || (local_1e._2_2_ != 0)) && (((PLANET *)local_1e)->iPlayer == idPlayer)) &&
                             (*(int *)(*(int *)(idPlayer * 4 + rglpshdefSB) + (*(uint *)&((PLANET *)local_1e)->lStarbase & 0xf) * 0x93) != 0x20)))) {
                bVar3 = false;
            }
            iWarp = 9;
        } else {
            if (((1 < iwp) && (uVar4 < (pOVar7[-1].wFlags_0x6 >> 4 & 0xf))) && ((pOVar7[-1].wFlags_0x6 >> 4 & 0xf) < 0xb)) {
                iWarp = pOVar7[-1].wFlags_0x6 >> 4 & 0xf;
            }
            lVar16 = LFuelUseToWaypoint(lpfl, iwp, 1);
            uVar19 = 0;
            uVar17 = 10;
            lVar13 = LGetFleetStat(lpfl, grStatFuel);
            lVar13 = __aFldiv(lVar13, CONCAT22(uVar19, uVar17));
            if (lVar13 <= lVar16)
                goto SCAN_LOptimizeSpeed;
            uVar20 = 0;
            uVar18 = 10;
            uVar19 = 0;
            uVar17 = 7;
            uVar12 = LGetFleetStat(lpfl, grStatFuel);
            uVar12 = __aFulmul(uVar12, CONCAT22(uVar19, uVar17));
            lVar13 = __aFldiv(uVar12, CONCAT22(uVar20, uVar18));
            iVar5 = (int)((ulong)lVar13 >> 0x10);
            iVar9 = *(int *)((int)pFVar8->rgwtMin + 0x12);
            if ((iVar9 < iVar5) || ((iVar9 <= iVar5 && (*(uint *)(pFVar8->rgwtMin + 4) < (uint)lVar13))))
                goto SCAN_LOptimizeSpeed;
            iWarp = iWarp + 1;
        }
        for (; (int)uVar4 < iWarp; iWarp = iWarp + -1) {
            pOVar7->wFlags_0x6 = pOVar7->wFlags_0x6 & 0xff0f | (iWarp & 0xfU) << 4;
            lVar13 = LFuelUseToWaypoint(lpfl, iwp, 1);
            if ((lVar13 <= CONCAT22(*(undefined2 *)((int)pFVar8->rgwtMin + 0x12), (int)pFVar8->rgwtMin[4])) &&
                ((((((PLANET *)local_1e != (PLANET *)0x0 || (local_1e._2_2_ != 0)) && ((((PLANET *)local_1e)->wFlags_0x4 >> 9 & 1) != 0)) &&
                   ((((PLANET *)local_1e)->iPlayer == idPlayer &&
                     (pHVar14 = LphuldefFromId(*(HullDef *)(*(int *)(idPlayer * 4 + rglpshdefSB) + (*(uint *)&((PLANET *)local_1e)->lStarbase & 0xf) * 0x93)),
                      (((HULDEF *)pHVar14)->hul).wtCargoMax != 0)))) ||
                  ((lVar15 = __aFldiv(CONCAT22(*(undefined2 *)((int)pFVar8->rgwtMin + 0x12), (int)pFVar8->rgwtMin[4]), 2), lVar13 <= lVar15 || (bVar2))))))
                break;
        }
        pOVar7->wFlags_0x6 = pOVar7->wFlags_0x6 & 0xff0f | (uVar1 >> 4 & 0xf) << 4;
    }
    if ((bVar3) && (iWarpAi < iWarp)) {
        iWarp = iWarpAi;
    }
SCAN_LOptimizeSpeed:
    if ((1 < iWarp) && ((pOVar7->wFlags_0x6 >> 8 & 0xf) != 2)) {
        DGetDistance((lpord->pt).x, (pOVar7->pt).y, ((pOVar7 + -1)->pt).x, pOVar7[-1].pt.y);
        lVar16 = __ftol((double)CONCAT26((int)((ulong)lVar16 >> 0x10), CONCAT24((int)lVar16, CONCAT22(unaff_SI, unaff_DI))));
        iVar5 = iWarp * iWarp;
        iVar9 = iWarp;
        do {
            iWarp = iVar9;
            iVar9 = iWarp + -1;
            if (iVar9 < 2)
                break;
        } while ((iVar5 + (int)lVar16 + -1) / iVar5 == ((int)lVar16 + iVar9 * iVar9 + -1) / (iVar9 * iVar9));
    }
    ptSrc.y = pOVar7[-1].pt.y;
    ptSrc.x = ((pOVar7 + -1)->pt).x;
    ptDst.y = (pOVar7->pt).y;
    ptDst.x = (lpord->pt).x;
    sVar6 = FCanFleetUseStargates(lpfl, ptSrc, ptDst);
    if (sVar6 == 1) {
        iWarp = 0xb;
    }
    if (0xb < iWarp) {
        iWarp = 9;
    }
    return iWarp;
}

// ======================================================================
// Function: FNearAWayPoint
// Address: 1058:8074
// Segment: MEMORY_SCAN
// ======================================================================

short FNearAWayPoint(POINT pt, short fLogical)

{
    short      sVar1;
    uint       uVar2;
    undefined2 uVar3;
    SCAN       scan;
    short      i;
    ORDER     *lpord;

    if (sel.grobj == grobjFleet) {
        if (fLogical == 0) {
            ScanToLogical(&pt);
        }
        sVar1 = FFindNearestObject(pt, 0x4f, &scan);
        if (sVar1 == 0) {
            uVar2 = 0;
        } else if ((scan.grobjFull & grobjOther) == grobjNone) {
            uVar2 = 0;
        } else if ((scan.pt.x == sel.pt.x) && (scan.pt.y == sel.pt.y)) {
            lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_, &((PLORD *)sel.fl.lpplord)[5].iordMax);
            for (i = 1; i < sel.fl.cord; i = i + 1) {
                uVar3 = (undefined2)((ulong)lpord >> 0x10);
                if (((lpord->pt).x == scan.pt.x) && ((((ORDER *)lpord)->pt).y == scan.pt.y))
                    break;
                lpord = (ORDER *)CONCAT22(uVar3, (ORDER *)lpord + 1);
            }
            uVar2 = (uint)(i != sel.fl.cord);
        } else {
            uVar2 = 1;
        }
    } else {
        uVar2 = 0;
    }
    return uVar2;
}

// ======================================================================
// Function: FHandleWayPointDrag
// Address: 1058:8176
// Segment: MEMORY_SCAN
// ======================================================================

short FHandleWayPointDrag(POINT pt)

{
    int        iVar1;
    bool       bVar2;
    HDC        HVar3;
    HCURSOR    HVar4;
    short      sVar5;
    short      sVar6;
    int        iVar7;
    int        iVar8;
    char      *pcVar9;
    HGDIOBJ    HVar10;
    uint       uVar11;
    ORDER     *pOVar12;
    int       *piVar13;
    short     *psVar14;
    HWND      *pHVar15;
    undefined2 uVar16;
    undefined2 unaff_SS;
    HDC        hdc;
    RECT       rc;
    short      fFirst;
    SCAN       scan;
    POINT      ptPrev;
    short      cpt;
    POINT      ptNew;
    POINT      rgpt[4];
    short      fDel;
    POINT      ptNext;
    POINT      ptLogical;
    short      i;
    ORDER     *lpord;
    HCURSOR    hcurSav;
    short      grTypeIn;
    short      fDup;
    char       szDeepSpace[40];
    short      fMarker;
    SBAR       sbar;
    HPEN       hpenSav;
    short      fChg;

    bVar2 = true;
    LogicalToScan(&pt);
    if (sel.iwpAct == 0) {
        lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_, &((PLORD *)sel.fl.lpplord)[5].iordMax);
        for (i = 1; i < sel.fl.cord; i = i + 1) {
            uVar16 = (undefined2)((ulong)lpord >> 0x10);
            if ((sel.fl.pt.x == (lpord->pt).x) && (sel.fl.pt.y == (((ORDER *)lpord)->pt).y))
                break;
            lpord = (ORDER *)CONCAT22(uVar16, (ORDER *)lpord + 1);
        }
        SetScanWp(i);
    }
    pHVar15 = &stack0xff6e;
    piVar13 = (int *)((int)(PLORD *)sel.fl.lpplord + (sel.iwpAct + -1) * 0x12 + 4);
    iVar8 = *piVar13;
    iVar1 = piVar13[1];
    if (sel.iwpAct == sel.fl.cord + -1) {
        cpt = 3;
    } else {
        cpt = 4;
        psVar14 = (short *)((int)(PLORD *)sel.fl.lpplord + (sel.iwpAct + 1) * 0x12 + 4);
        rgpt[3].x = *psVar14;
        rgpt[3].y = psVar14[1];
    }
    psVar14 = (short *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
    rgpt[0].x = *psVar14;
    rgpt[0].y = psVar14[1];
    rgpt[1].x = rgpt[0].x;
    rgpt[1].y = rgpt[0].y;
    rgpt[2].x = iVar8;
    rgpt[2].y = iVar1;
    for (i = 0; i < cpt; i = i + 1) {
        LogicalToScan(rgpt + i);
    }
    GetClientRect(hwndScanner, &rc);
    rc.bottom = rc.bottom - dySBar;
    HVar3 = GetDC(hwndScanner);
    HVar4 = SetCursor(hcurCloseGrab);
    uVar16 = 0x14f8;
    SetCapture(hwndScanner);
    ptNew.x = pt.x;
    ptNew.y = pt.y;
    while (true) {
        pHVar15[-1] = (HWND)&ptNew;
        pHVar15[-2] = uVar16;
        uVar16 = 0x1040;
        pHVar15[-3] = 0x833c;
        sVar5 = FGetMouseMove((POINT *)pHVar15[-1]);
        if (sVar5 == 0)
            break;
        uVar11 = rc.right;
        if (ptNew.x <= rc.right) {
            uVar11 = ptNew.x;
        }
        if (uVar11 < 0x8000) {
            sVar5 = rc.right;
            if (ptNew.x <= rc.right) {
                sVar5 = ptNew.x;
            }
        } else {
            sVar5 = 0;
        }
        ptNew.x = sVar5;
        uVar11 = rc.bottom;
        if (ptNew.y <= rc.bottom) {
            uVar11 = ptNew.y;
        }
        if (uVar11 < 0x8000) {
            sVar6 = rc.bottom;
            if (ptNew.y <= rc.bottom) {
                sVar6 = ptNew.y;
            }
        } else {
            sVar6 = 0;
        }
        ptNew.y = sVar6;
        if ((pt.x != sVar5) || (pt.y != sVar6)) {
            if (bVar2) {
                pHVar15[-1] = 0;
                pHVar15[-2] = ptNew.y;
                pHVar15[-3] = ptNew.x;
                pHVar15[-4] = 0x1040;
                uVar16 = 0x1058;
                pHVar15[-5] = 0x83f3;
                sVar5 = FNearAWayPoint(*(pHVar15 + -3), pHVar15[-1]);
                if (sVar5 == 0)
                    goto LAB_1058_8401;
            } else {
            LAB_1058_8401:
                bVar2 = false;
                ptLogical.x = ptNew.x;
                ptLogical.y = ptNew.y;
                pHVar15[-1] = (HWND)&ptLogical;
                pHVar15[-2] = uVar16;
                pHVar15[-3] = 0x841b;
                ScanToLogical((POINT *)pHVar15[-1]);
                pHVar15[-1] = 0x10;
                pHVar15[-2] = 0x1058;
                pHVar15[-3] = 0x8427;
                uVar11 = GetAsyncKeyState(pHVar15[-1]);
                if ((uVar11 & 0xfffe) == 0) {
                    uVar16 = 0x4f;
                } else {
                    uVar16 = 0x8f;
                }
                pHVar15[-2] = (HWND)&scan;
                pHVar15[-3] = uVar16;
                pHVar15[-4] = ptLogical.y;
                pHVar15[-5] = ptLogical.x;
                pHVar15[-6] = 0x14f8;
                pHVar15[-7] = 0x8450;
                FFindNearestObject(*(pHVar15 + -5), pHVar15[-3], (SCAN *)pHVar15[-2]);
                pHVar15[-2] = cpt;
                pHVar15[-3] = (HWND)rgpt;
                pHVar15[-4] = HVar3;
                pHVar15[-5] = 0x1038;
                uVar16 = 0x1058;
                pHVar15[-6] = 0x8462;
                DrawScanXorLines(pHVar15[-4], (POINT *)pHVar15[-3], pHVar15[-2]);
                if (scan.grobj == grobjNone) {
                    rgpt[0].x = ptLogical.x;
                    rgpt[0].y = ptLogical.y;
                    sbar.id = -1;
                    pHVar15[-2] = (HWND)szDeepSpace;
                    pHVar15[-3] = 0x362;
                    pHVar15[-4] = 0x1058;
                    uVar16 = 0x1040;
                    pHVar15[-5] = 0x848c;
                    CchGetString(pHVar15[-3], (char *)pHVar15[-2]);
                    sbar.psz = szDeepSpace;
                } else {
                    rgpt[0].x = scan.pt.x;
                    rgpt[0].y = scan.pt.y;
                    if (scan.grobj == grobjPlanet) {
                        sbar.id = scan.idpl;
                    } else if (scan.grobj == grobjFleet) {
                        sbar.id = ((FLEET **)rglpfl)[scan.ifl]->id;
                    } else if (scan.grobj == grobjThing) {
                        sbar.id = ((THING *)lpThings + scan.ith)->idFull;
                    } else {
                        sbar.id = scan.iwp;
                    }
                    sbar.psz = (char *)0x0;
                }
                sbar.pt.x = rgpt[0].x;
                sbar.pt.y = rgpt[0].y;
                sbar.grbit = scan.grobj;
                pHVar15[-2] = (HWND)rgpt;
                pHVar15[-3] = uVar16;
                pHVar15[-4] = 0x8528;
                LogicalToScan((POINT *)pHVar15[-2]);
                pHVar15[-2] = cpt;
                pHVar15[-3] = (HWND)rgpt;
                pHVar15[-4] = HVar3;
                pHVar15[-5] = 0x1058;
                pHVar15[-6] = 0x853a;
                DrawScanXorLines(pHVar15[-4], (POINT *)pHVar15[-3], pHVar15[-2]);
                sbar.pscan = (SCAN *)0x0;
                pHVar15[-2] = 0;
                pHVar15[-3] = (HWND)&sbar;
                pHVar15[-4] = 0;
                pHVar15[-5] = HVar3;
                pHVar15[-6] = 0x1058;
                pHVar15[-7] = 0x8556;
                DrawScannerSBar(pHVar15[-5], (RECT *)pHVar15[-4], (SBAR *)pHVar15[-3], pHVar15[-2]);
                pHVar15 = pHVar15 + -1;
            }
            uVar16 = 0x1058;
            pt.y = ptNew.y;
            pt.x = ptNew.x;
        }
    }
    if ((rgpt[0].x == rgpt[1].x) && (rgpt[0].y == rgpt[1].y)) {
        iVar7 = 0;
    } else {
        iVar7 = 1;
    }
    if (iVar7 != 0) {
        if (scan.grobj == grobjNone) {
            scan.pt.x = ptLogical.x;
            scan.pt.y = ptLogical.y;
            scan.grobj = grobjOther;
            scan.iwp = sel.iwpAct;
        }
        if ((scan.pt.x == iVar8) && (scan.pt.y == iVar1)) {
            fDup = 1;
        } else {
            fDup = 0;
        }
        if ((fDup == 0) && (sel.iwpAct < sel.fl.cord + -1)) {
            piVar13 = (int *)((int)(PLORD *)sel.fl.lpplord + (sel.iwpAct + 1) * 0x12 + 4);
            if ((scan.pt.x == *piVar13) && (scan.pt.y == piVar13[1])) {
                iVar8 = 1;
            } else {
                iVar8 = 0;
            }
            fDup = iVar8 << 1;
        }
        pHVar15[-1] = hwndScanner;
        pHVar15[-2] = unaff_SS;
        pHVar15[-3] = (HWND)&rc;
        pHVar15[-4] = 0x1040;
        pHVar15[-5] = 0x8647;
        GetClientRect(pHVar15[-1], *(RECT **)(pHVar15 + -3));
        if (fDup != 0) {
            pHVar15[-1] = (HWND)((char *)s_M6102__MATH___floating_point_err_1120_2022 + 2);
            pHVar15[-2] = 0;
            pHVar15[-3] = 0;
            pHVar15[-4] = 0x61;
            pHVar15[-5] = 0x14f8;
            pHVar15[-6] = 0x8665;
            pcVar9 = PszFormatIds(pHVar15[-4], *(short **)(pHVar15 + -3));
            pHVar15[-2] = (HWND)pcVar9;
            pHVar15[-3] = 0x1030;
            uVar16 = 0x1040;
            pHVar15[-4] = 0x866e;
            sVar5 = AlertSz((char *)pHVar15[-2], pHVar15[-1]);
            if ((grbitScan & 0x80) != 0) {
                pHVar15[-1] = HVar3;
                pHVar15[-2] = hpenStarbase;
                pHVar15[-3] = 0x1040;
                pHVar15[-4] = 0x869f;
                HVar10 = SelectObject(pHVar15[-1], pHVar15[-2]);
                pHVar15[-1] = HVar3;
                pHVar15[-2] = rgpt[2].x;
                pHVar15[-3] = rgpt[2].y;
                pHVar15[-4] = 0x14f8;
                pHVar15[-5] = 0x86b0;
                MoveTo(pHVar15[-1], pHVar15[-2], pHVar15[-3]);
                pHVar15[-1] = HVar3;
                pHVar15[-2] = rgpt[0].x;
                pHVar15[-3] = rgpt[0].y;
                pHVar15[-4] = 0x14f8;
                pHVar15[-5] = 0x86be;
                LineTo(pHVar15[-1], pHVar15[-2], pHVar15[-3]);
                if (3 < (uint)cpt) {
                    pHVar15[-1] = HVar3;
                    pHVar15[-2] = 0;
                    pHVar15[-3] = rc.bottom - dySBar;
                    pHVar15[-4] = rc.right;
                    pHVar15[-5] = rc.bottom;
                    pHVar15[-6] = 0x14f8;
                    pHVar15[-7] = 0x86e4;
                    ExcludeClipRect(pHVar15[-1], pHVar15[-2], pHVar15[-3], pHVar15[-4], pHVar15[-5]);
                    pHVar15[-1] = HVar3;
                    pHVar15[-2] = rgpt[3].x;
                    pHVar15[-3] = rgpt[3].y;
                    pHVar15[-4] = 0x14f8;
                    pHVar15[-5] = 0x86f2;
                    LineTo(pHVar15[-1], pHVar15[-2], pHVar15[-3]);
                }
                pHVar15[-1] = HVar3;
                pHVar15[-2] = HVar10;
                pHVar15[-3] = 0x14f8;
                uVar16 = 0x14f8;
                pHVar15[-4] = 0x86fd;
                SelectObject(pHVar15[-1], pHVar15[-2]);
            }
            pHVar15[-1] = cpt;
            pHVar15[-2] = (HWND)rgpt;
            pHVar15[-3] = HVar3;
            pHVar15[-4] = uVar16;
            uVar16 = 0x1058;
            pHVar15[-5] = 0x870c;
            DrawScanXorLines(pHVar15[-3], (POINT *)pHVar15[-2], pHVar15[-1]);
            rgpt[0].x = rgpt[1].x;
            rgpt[0].y = rgpt[1].y;
            if ((grbitScan & 0x80) != 0) {
                pHVar15[-1] = HVar3;
                pHVar15[-2] = hpenStarbase;
                pHVar15[-3] = 0x1058;
                pHVar15[-4] = 0x8735;
                HVar10 = SelectObject(pHVar15[-1], pHVar15[-2]);
                pHVar15[-1] = HVar3;
                pHVar15[-2] = rgpt[2].x;
                pHVar15[-3] = rgpt[2].y;
                pHVar15[-4] = 0x14f8;
                pHVar15[-5] = 0x8746;
                MoveTo(pHVar15[-1], pHVar15[-2], pHVar15[-3]);
                pHVar15[-1] = HVar3;
                pHVar15[-2] = rgpt[0].x;
                pHVar15[-3] = rgpt[0].y;
                pHVar15[-4] = 0x14f8;
                pHVar15[-5] = 0x8754;
                LineTo(pHVar15[-1], pHVar15[-2], pHVar15[-3]);
                if (3 < (uint)cpt) {
                    pHVar15[-1] = HVar3;
                    pHVar15[-2] = 0;
                    pHVar15[-3] = rc.bottom - dySBar;
                    pHVar15[-4] = rc.right;
                    pHVar15[-5] = rc.bottom;
                    pHVar15[-6] = 0x14f8;
                    pHVar15[-7] = 0x877a;
                    ExcludeClipRect(pHVar15[-1], pHVar15[-2], pHVar15[-3], pHVar15[-4], pHVar15[-5]);
                    pHVar15[-1] = HVar3;
                    pHVar15[-2] = rgpt[3].x;
                    pHVar15[-3] = rgpt[3].y;
                    pHVar15[-4] = 0x14f8;
                    pHVar15[-5] = 0x8788;
                    LineTo(pHVar15[-1], pHVar15[-2], pHVar15[-3]);
                }
                pHVar15[-1] = HVar3;
                pHVar15[-2] = HVar10;
                pHVar15[-3] = 0x14f8;
                uVar16 = 0x14f8;
                pHVar15[-4] = 0x8793;
                SelectObject(pHVar15[-1], pHVar15[-2]);
            }
            pHVar15[-1] = cpt;
            pHVar15[-2] = (HWND)rgpt;
            pHVar15[-3] = HVar3;
            pHVar15[-4] = uVar16;
            uVar16 = 0x1058;
            pHVar15[-5] = 0x87a2;
            DrawScanXorLines(pHVar15[-3], (POINT *)pHVar15[-2], pHVar15[-1]);
            if (sVar5 == 6) {
                pHVar15[-1] = (uint)(fDup == 1);
                pHVar15[-2] = 0x1058;
                uVar16 = 0x1050;
                pHVar15[-3] = 0x87c6;
                DeleteCurWayPoint(pHVar15[-1]);
            }
            goto SCAN_Done_5;
        }
        if ((grbitScan & 0x80) != 0) {
            pHVar15[-1] = HVar3;
            pHVar15[-2] = 0;
            pHVar15[-3] = rc.bottom - dySBar;
            pHVar15[-4] = rc.right;
            pHVar15[-5] = rc.bottom;
            pHVar15[-6] = 0x14f8;
            pHVar15[-7] = 0x87f7;
            ExcludeClipRect(pHVar15[-1], pHVar15[-2], pHVar15[-3], pHVar15[-4], pHVar15[-5]);
            pHVar15[-1] = HVar3;
            pHVar15[-2] = hpenStarbase;
            pHVar15[-3] = 0x14f8;
            pHVar15[-4] = 0x8803;
            HVar10 = SelectObject(pHVar15[-1], pHVar15[-2]);
            pHVar15[-1] = HVar3;
            pHVar15[-2] = rgpt[2].x;
            pHVar15[-3] = rgpt[2].y;
            pHVar15[-4] = 0x14f8;
            pHVar15[-5] = 0x8814;
            MoveTo(pHVar15[-1], pHVar15[-2], pHVar15[-3]);
            pHVar15[-1] = HVar3;
            pHVar15[-2] = rgpt[0].x;
            pHVar15[-3] = rgpt[0].y;
            pHVar15[-4] = 0x14f8;
            pHVar15[-5] = 0x8822;
            LineTo(pHVar15[-1], pHVar15[-2], pHVar15[-3]);
            if (3 < (uint)cpt) {
                pHVar15[-1] = HVar3;
                pHVar15[-2] = rgpt[3].x;
                pHVar15[-3] = rgpt[3].y;
                pHVar15[-4] = 0x14f8;
                pHVar15[-5] = 0x8839;
                LineTo(pHVar15[-1], pHVar15[-2], pHVar15[-3]);
            }
            pHVar15[-1] = HVar3;
            pHVar15[-2] = HVar10;
            pHVar15[-3] = 0x14f8;
            pHVar15[-4] = 0x8844;
            SelectObject(pHVar15[-1], pHVar15[-2]);
        }
        pHVar15[-1] = cpt;
        pHVar15[-2] = (HWND)rgpt;
        pHVar15[-3] = HVar3;
        pHVar15[-4] = 0x14f8;
        uVar16 = 0x1058;
        pHVar15[-5] = 0x8853;
        DrawScanXorLines(pHVar15[-3], (POINT *)pHVar15[-2], pHVar15[-1]);
        rgpt[0].x = rgpt[1].x;
        rgpt[0].y = rgpt[1].y;
        if ((grbitScan & 0x80) != 0) {
            pHVar15[-1] = HVar3;
            pHVar15[-2] = 0;
            pHVar15[-3] = rc.bottom - dySBar;
            pHVar15[-4] = rc.right;
            pHVar15[-5] = rc.bottom;
            pHVar15[-6] = 0x1058;
            pHVar15[-7] = 0x888d;
            ExcludeClipRect(pHVar15[-1], pHVar15[-2], pHVar15[-3], pHVar15[-4], pHVar15[-5]);
            pHVar15[-1] = HVar3;
            pHVar15[-2] = hpenStarbase;
            pHVar15[-3] = 0x14f8;
            pHVar15[-4] = 0x8899;
            HVar10 = SelectObject(pHVar15[-1], pHVar15[-2]);
            pHVar15[-1] = HVar3;
            pHVar15[-2] = rgpt[2].x;
            pHVar15[-3] = rgpt[2].y;
            pHVar15[-4] = 0x14f8;
            pHVar15[-5] = 0x88aa;
            MoveTo(pHVar15[-1], pHVar15[-2], pHVar15[-3]);
            pHVar15[-1] = HVar3;
            pHVar15[-2] = rgpt[0].x;
            pHVar15[-3] = rgpt[0].y;
            pHVar15[-4] = 0x14f8;
            pHVar15[-5] = 35000;
            LineTo(pHVar15[-1], pHVar15[-2], pHVar15[-3]);
            if (3 < (uint)cpt) {
                pHVar15[-1] = HVar3;
                pHVar15[-2] = rgpt[3].x;
                pHVar15[-3] = rgpt[3].y;
                pHVar15[-4] = 0x14f8;
                pHVar15[-5] = 0x88cf;
                LineTo(pHVar15[-1], pHVar15[-2], pHVar15[-3]);
            }
            pHVar15[-1] = HVar3;
            pHVar15[-2] = HVar10;
            pHVar15[-3] = 0x14f8;
            uVar16 = 0x14f8;
            pHVar15[-4] = 0x88da;
            SelectObject(pHVar15[-1], pHVar15[-2]);
        }
        pHVar15[-1] = cpt;
        pHVar15[-2] = (HWND)rgpt;
        pHVar15[-3] = HVar3;
        pHVar15[-4] = uVar16;
        pHVar15[-5] = 0x88e9;
        DrawScanXorLines(pHVar15[-3], (POINT *)pHVar15[-2], pHVar15[-1]);
        pHVar15[-1] = 0;
        pHVar15[-2] = 0;
        pHVar15[-3] = 0x1058;
        pHVar15[-4] = 0x88f9;
        RedrawScanSel(pHVar15[-2], pHVar15[-1]);
        uVar16 = sel.fl.lpplord._2_2_;
        if (scan.grobj == grobjPlanet) {
            i = scan.idpl;
        } else if (scan.grobj == grobjFleet) {
            i = ((FLEET **)rglpfl)[scan.ifl]->id;
        } else if (scan.grobj == grobjThing) {
            i = ((THING *)lpThings + scan.ith)->idFull;
        } else {
            i = scan.iwp;
        }
        pOVar12 = (ORDER *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
        lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_, pOVar12);
        pOVar12->wFlags_0x6 = pOVar12->wFlags_0x6 & 0xf0ff | (scan.grobj & (grobjThing | grobjOther | grobjFleet | grobjPlanet)) << 8;
        pOVar12->id = i;
        (lpord->pt).x = scan.pt.x;
        (pOVar12->pt).y = scan.pt.y;
        pHVar15[-1] = uVar16;
        pHVar15[-2] = (HWND)pOVar12;
        pHVar15[-3] = 0x1120;
        pHVar15[-4] = 0x4972;
        pHVar15[-5] = 0x1058;
        pHVar15[-6] = 0x89de;
        uVar11 = IWarpBestForWaypoint(*(FLEET **)(pHVar15 + -4), *(ORDER **)(pHVar15 + -2));
        pOVar12->wFlags_0x6 = pOVar12->wFlags_0x6 & 0xff0f | (uVar11 & 0xf) << 4;
        pHVar15[-1] = 0x4972;
        pHVar15[-2] = 0xffff;
        pHVar15[-3] = 0x1058;
        pHVar15[-4] = 0x8a14;
        FLookupFleet(pHVar15[-2], (FLEET *)pHVar15[-1]);
        scan.iwp = sel.iwpAct;
        scan.grobjFull = scan.grobjFull | grobjOther;
        sel.iwpAct = -2;
        pHVar15[-1] = 1;
        pHVar15[-2] = (HWND)&scan;
        pHVar15[-3] = 0x1038;
        uVar16 = 0x1058;
        pHVar15[-4] = 0x8a34;
        ChangeScanSel((SCAN *)pHVar15[-2], pHVar15[-1]);
    }
    pHVar15[-1] = 0;
    pHVar15[-2] = 0;
    pHVar15[-3] = 0;
    pHVar15[-4] = HVar3;
    pHVar15[-5] = uVar16;
    pHVar15[-6] = 0x8a4b;
    DrawScannerSBar(pHVar15[-4], (RECT *)pHVar15[-3], (SBAR *)pHVar15[-2], pHVar15[-1]);
    pHVar15[-1] = 0x1058;
    pHVar15[-2] = 0x8a53;
    ReleaseCapture();
    pHVar15[-1] = HVar4;
    pHVar15[-2] = 0x14f8;
    pHVar15[-3] = 0x8a5b;
    SetCursor(pHVar15[-1]);
    pHVar15[-1] = hwndMine;
    pHVar15[-2] = 0;
    pHVar15[-3] = 0;
    pHVar15[-4] = 1;
    pHVar15[-5] = 0x14f8;
    pHVar15[-6] = 0x8a70;
    InvalidateRect(pHVar15[-1], *(RECT **)(pHVar15 + -3), pHVar15[-4]);
    *pHVar15 = hwndMine;
    pHVar15[-1] = 0x14f8;
    uVar16 = 0x1028;
    pHVar15[-2] = 0x8a79;
    SetMineralTitleBar(*pHVar15);
    pHVar15 = pHVar15 + 1;
SCAN_Done_5:
    *(HWND *)((int)pHVar15 + -2) = hwndScanner;
    *(HDC *)((int)pHVar15 + -4) = HVar3;
    *(undefined2 *)((int)pHVar15 + -6) = uVar16;
    *(undefined2 *)((int)pHVar15 + -8) = 0x8a88;
    ReleaseDC(*(HWND *)((int)pHVar15 + -2), *(HDC *)((int)pHVar15 + -4));
    if ((iVar7 != 0) && ((grbitScan & 0x80) != 0)) {
        rgpt[1].x = ptNew.x;
        rgpt[1].y = ptNew.y;
        *(short *)((int)pHVar15 + -2) = cpt;
        *(int *)((int)pHVar15 + -4) = (int)rgpt;
        *(int *)((int)pHVar15 + -6) = (int)&rc;
        *(undefined2 *)((int)pHVar15 + -8) = 0x14f8;
        *(undefined2 *)((int)pHVar15 + -10) = 0x8abc;
        BoundPoints((RECT *)*(undefined2 *)((int)pHVar15 + -6), (POINT *)*(undefined2 *)((int)pHVar15 + -4), *(short *)((int)pHVar15 + -2));
        *(HWND *)((int)pHVar15 + -2) = hwndScanner;
        *(undefined2 *)((int)pHVar15 + -4) = 0x1040;
        *(undefined2 *)((int)pHVar15 + -6) = 0x8ac8;
        HVar3 = GetDC(*(HWND *)((int)pHVar15 + -2));
        *(int *)((int)pHVar15 + -2) = (int)&rc;
        *(HDC *)((int)pHVar15 + -4) = HVar3;
        *(undefined2 *)((int)pHVar15 + -6) = 0x14f8;
        *(undefined2 *)((int)pHVar15 + -8) = 0x8ada;
        DrawScanner(*(HDC *)((int)pHVar15 + -4), (RECT *)*(undefined2 *)((int)pHVar15 + -2));
        *(HWND *)((int)pHVar15 + -2) = hwndScanner;
        *(HDC *)((int)pHVar15 + -4) = HVar3;
        *(undefined2 *)((int)pHVar15 + -6) = 0x1058;
        *(undefined2 *)((int)pHVar15 + -8) = 0x8aea;
        ReleaseDC(*(HWND *)((int)pHVar15 + -2), *(HDC *)((int)pHVar15 + -4));
    }
    return iVar7;
}

// ======================================================================
// Function: DrawScanXorLines
// Address: 1058:8af6
// Segment: MEMORY_SCAN
// ======================================================================

void DrawScanXorLines(HDC hdc, POINT *rgpt, short cpt)

{
    HGDIOBJ    HVar1;
    short      sVar2;
    undefined2 unaff_SS;
    RECT       rc;
    short      i;
    short      iRopSav;
    HPEN       hpenSav;

    GetClientRect(hwndScanner, &rc);
    ExcludeClipRect(hdc, 0, rc.bottom - dySBar, rc.right, rc.bottom);
    if (((cpt == 4) && ((rgpt + 2)->x == (rgpt + 3)->x)) && (rgpt[2].y == rgpt[3].y)) {
        cpt = 3;
        hpenSav = GetStockObject(6);
    } else {
        hpenSav = hpenShip;
    }
    for (i = 1; i < cpt; i = i + 1) {
        ExcludeClipRect(hdc, (rgpt + i)->x + -5, rgpt[i].y + -5, (rgpt + i)->x + 6, rgpt[i].y + 6);
    }
    HVar1 = SelectObject(hdc, hpenSav);
    sVar2 = SetROP2(hdc, 7);
    MoveTo(hdc, (rgpt + 2)->x, rgpt[2].y);
    LineTo(hdc, rgpt->x, rgpt->y);
    if (3 < cpt) {
        LineTo(hdc, (rgpt + 3)->x, rgpt[3].y);
    }
    SetROP2(hdc, sVar2);
    SelectObject(hdc, HVar1);
    SelectClipRgn(hdc, hrgnHuge);
    return;
}

// ======================================================================
// Function: SetScanWp
// Address: 1058:8c5a
// Segment: MEMORY_SCAN
// ======================================================================

short SetScanWp(short iNew)

{
    short *psVar1;
    POINT  pt;
    SCAN   scan;

    if (iNew != sel.iwpAct) {
        psVar1 = (short *)((int)(PLORD *)sel.fl.lpplord + iNew * 0x12 + 4);
        pt.y = psVar1[1];
        pt.x = *psVar1;
        FFindNearestObject(pt, grobjOther, &scan);
        scan.iwp = iNew;
        ChangeScanSel(&scan, 1);
    }
    return iNew;
}

// ======================================================================
// Function: ChangeScanSel
// Address: 1058:8cc4
// Segment: MEMORY_SCAN
// ======================================================================

/* WARNING: Variable defined which should be unmapped: fChgWp */

void ChangeScanSel(SCAN *pscan, short fValidScan)

{
    SCAN      *pSVar1;
    short     *psVar2;
    POINT      pt;
    POINT      pt_00;
    bool       bVar3;
    short      sVar4;
    int        iVar5;
    int        iVar6;
    HDC        hdc;
    int        iVar7;
    undefined2 unaff_SI;
    SCAN      *pSVar8;
    undefined2 unaff_DI;
    short     *psVar9;
    undefined2 unaff_SS;
    long       lVar10;
    HDC        local_12;
    short      fChgWp;
    RECT       rcMine;
    short      fMineFieldSel;

    if (fValidScan == 0) {
        pt.y = (pscan->pt).y;
        pt.x = (pscan->pt).x;
        FFindNearestObject(pt, pscan->grobj, pscan);
    }
    sVar4 = _memcmp(pscan, (void *)&sel.scan, 0x10);
    if (sVar4 != 0) {
        if ((pscan->iwp == -1) || (pscan->iwp == sel.iwpAct)) {
            iVar5 = 0;
        } else {
            iVar5 = 1;
        }
        if ((sel.scan.grobj == grobjThing) && (((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0)) {
            bVar3 = true;
        } else {
            bVar3 = false;
        }
        if (bVar3) {
            _sqrt((double)((&((THING *)lpThings)[sel.scan.ith].u_THING_0x0006)->thm).cMines);
            lVar10 = __ftol((double)CONCAT26(iVar5, CONCAT24(local_12, CONCAT22(unaff_SI, unaff_DI))));
            local_12 = (HDC)lVar10;
            iVar7 = (&((THING *)lpThings)[sel.scan.ith].pt)->x;
            iVar6 = ((THING *)lpThings)[sel.scan.ith].pt.y;
            rcMine.right = iVar7 + local_12;
            rcMine.bottom = iVar6 - local_12;
            rcMine.left = iVar7 - local_12;
            rcMine.top = iVar6 + local_12;
            LogicalToScan(&rcMine);
            LogicalToScan(&rcMine.right);
            InflateRect(&rcMine, 1, 1);
        }
        RedrawScanSel(0, -1);
        psVar9 = (short *)&sel.scan;
        pSVar8 = pscan;
        for (iVar7 = 8; iVar7 != 0; iVar7 = iVar7 + -1) {
            psVar2 = psVar9;
            psVar9 = psVar9 + 1;
            pSVar1 = pSVar8;
            pSVar8 = &(pSVar8->pt).y;
            *psVar2 = (pSVar1->pt).x;
        }
        if (((sel.scan.grobjFull & grobjPlanet) != grobjNone) && (fValidScan != 2)) {
            sel.scan.grobj = grobjPlanet;
        }
        if (iVar5 != 0) {
            sel.iwpAct = pscan->iwp;
            FillOrdersLB();
            SetOrdersLbSel(pscan->iwp);
            UpdateOrdersDDs(0);
            DrawPlanShip(0, 0x122);
        }
        RedrawScanSel(0, 1);
        if (iVar5 != 0) {
            pt_00.y = (pscan->pt).y;
            pt_00.x = (pscan->pt).x;
            FEnsurePointOnScreen(pt_00, 1);
        }
        DrawScannerSBar(0, (RECT *)0x0, (SBAR *)0x0, 0);
        InvalidateRect(hwndMine, (RECT *)0x0, 1);
        SetMineralTitleBar(hwndMine);
        if (bVar3) {
            local_12 = GetDC(hwndScanner);
            DrawScanner(local_12, &rcMine);
            ReleaseDC(hwndScanner, local_12);
        }
        if ((sel.scan.grobj == grobjThing) && (((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0)) {
            bVar3 = true;
        } else {
            bVar3 = false;
        }
        if (bVar3) {
            _sqrt((double)((&((THING *)lpThings)[sel.scan.ith].u_THING_0x0006)->thm).cMines);
            lVar10 = __ftol((double)CONCAT26(rcMine.left, CONCAT24(iVar5, CONCAT22(local_12, unaff_SI))));
            iVar6 = (int)lVar10;
            iVar5 = (&((THING *)lpThings)[sel.scan.ith].pt)->x;
            iVar7 = ((THING *)lpThings)[sel.scan.ith].pt.y;
            rcMine.right = iVar5 + iVar6;
            rcMine.bottom = iVar7 - iVar6;
            rcMine.left = iVar5 - iVar6;
            rcMine.top = iVar7 + iVar6;
            LogicalToScan(&rcMine);
            LogicalToScan(&rcMine.right);
            InflateRect(&rcMine, 1, 1);
            hdc = GetDC(hwndScanner);
            DrawScanner(hdc, &rcMine);
            ReleaseDC(hwndScanner, hdc);
        }
        if (sel.pl.id != -1) {
            DrawPlanShip(0, 0x4002);
        }
        if ((((uint)gd.grBits >> 0xb & 1) != 0) && (idPlayer == 0)) {
            AdvanceTutor();
        }
    }
    return;
}

// ======================================================================
// Function: FGetNextObjHere
// Address: 1058:909c
// Segment: MEMORY_SCAN
// ======================================================================

short FGetNextObjHere(SCAN *pscan, short fOnlyOurs)

{
    FLEET *pFVar1;
    int    iVar2;
    short  sVar3;
    bool   bVar4;
    short  fFound;
    short  i;
    FLEET *lpfl;

    bVar4 = sel.grobj != grobjFleet;
    for (i = 0; i < cFleet; i = i + 1) {
        /* WARNING: Load size is inaccurate */
        pFVar1 = ((FLEET **)rglpfl)[i];
        iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar2, pFVar1);
        if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0))
            break;
        if (bVar4) {
            if (((sel.pt.x == (&pFVar1->pt)->x) && (sel.pt.y == (pFVar1->pt).y)) && ((fOnlyOurs == 0 || (pFVar1->iPlayer == idPlayer))))
                break;
        } else if (lpfl->id == sel.id) {
            bVar4 = true;
        }
    }
    if (bVar4) {
        if (i < cFleet) {
            pscan->ifl = i;
            pscan->grobj = grobjFleet;
        } else if (((sel.grobjFull & grobjPlanet) == grobjNone) || (sel.pl.iPlayer != idPlayer)) {
            for (i = 0; i < cFleet; i = i + 1) {
                /* WARNING: Load size is inaccurate */
                pFVar1 = ((FLEET **)rglpfl)[i];
                iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                lpfl = (FLEET *)CONCAT22(iVar2, pFVar1);
                if (((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) ||
                    ((((pscan->pt).x == (&pFVar1->pt)->x && ((pscan->pt).y == (pFVar1->pt).y)) && ((fOnlyOurs == 0 || (pFVar1->iPlayer == idPlayer))))))
                    break;
            }
            if ((cFleet <= i) || (lpfl->id == sel.id)) {
                return 0;
            }
            pscan->ifl = i;
            pscan->grobj = grobjFleet;
        } else {
            pscan->grobj = grobjPlanet;
            pscan->idpl = sel.pl.id;
        }
        sVar3 = 1;
    } else {
        sVar3 = 0;
    }
    return sVar3;
}

// ======================================================================
// Function: FindDlg
// Address: 1058:9286
// Segment: MEMORY_SCAN
// ======================================================================

/* WARNING: Variable defined which should be unmapped: rc */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short FindDlg(HWND hwnd, WMType msg, ushort wParam, long lParam)

{
    short      sVar1;
    char      *sz;
    HWND       HVar2;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 unaff_SS;
    ulong      uVar3;
    RECT       rc;
    char       szName[40];

    if (msg == WM_ERASEBKGND) {
        GetClientRect(hwnd, &rc);
        FillRect(wParam, &rc, hbrButtonFace);
        return 1;
    }
    if (msg == WM_CTLCOLOR) {
        uVar3 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), rc.left);
        if ((int)uVar3 == 6) {
            SetBkColor(wParam, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
            return hbrButtonFace;
        }
    } else {
        if (msg == WM_INITDIALOG) {
            StickyDlgPos(hwnd, (POINT *)&ptStickyFindDlg, 1);
            SendDlgItemMessage(hwnd, 0x10c, 0x415, 0x27, 0);
            return 1;
        }
        if (msg == WM_COMMAND) {
            if ((wParam == 1) || (wParam == 2)) {
                if (wParam == 1) {
                    GetDlgItemText(hwnd, IDC_U16_0x010C, szName, 0x28);
                    sVar1 = FSelectSz(szName);
                    if (sVar1 == 0) {
                        sVar1 = 0x10;
                        sz = PszFormatIds(idsSorryCantFindPlanetFleetName, (short *)0x0);
                        AlertSz(sz, sVar1);
                        HVar2 = GetDlgItem(hwnd, IDC_U16_0x010C);
                        SetFocus(HVar2);
                        SendDlgItemMessage(hwnd, 0x10c, 0x401, 0, -0x10000);
                        return 0;
                    }
                }
                StickyDlgPos(hwnd, (POINT *)&ptStickyFindDlg, 0);
                EndDialog(hwnd, (uint)(wParam == 1));
                return 1;
            }
            if (wParam == 0x76) {
                WinHelp(hwnd, _szHelpFile, 1, 0x43d);
                return 1;
            }
        }
    }
    return 0;
}

// ======================================================================
// Function: FSelectSz
// Address: 1058:945a
// Segment: MEMORY_SCAN
// ======================================================================

short FSelectSz(char *szName)

{
    FLEET     *pFVar1;
    int        iVar2;
    POINT      pt;
    POINT      pt_00;
    POINT      pt_01;
    POINT      pt_02;
    ushort     uVar3;
    short      sVar4;
    char      *pcVar5;
    undefined2 uVar6;
    char      *pcVar7;
    SCAN       scan;
    short      iplPartial;
    char       szT[20];
    short      cch;
    short      ipl;
    FLEET     *lpfl;
    short      ifl;
    char      *pch;

    iplPartial = -1;
    scan.iwp = -1;
    for (ipl = 0; ipl < game.cPlanMax; ipl = ipl + 1) {
        pcVar7 = szName;
        pcVar5 = PszGetCompressedPlanet(((short *)rgidPlan)[ipl]);
        sVar4 = __strcmpi(pcVar5, pcVar7);
        if (sVar4 == 0)
            break;
        if (iplPartial == -1) {
            uVar3 = _strlen(szName);
            pcVar7 = szName;
            pcVar5 = PszGetCompressedPlanet(((short *)rgidPlan)[ipl]);
            sVar4 = __strnicmp(pcVar5, pcVar7, uVar3);
            if (sVar4 == 0) {
                iplPartial = ipl;
            }
        }
    }
    do {
        if (ipl != game.cPlanMax) {
            pt.y = *(short *)((int)&rgptPlan[0].y + ipl * 4);
            pt.x = ((POINT *)rgptPlan + ipl)->x;
            FFindNearestObject(pt, grobjPlanet, &scan);
            ChangeScanSel(&scan, 1);
            pt_01.y = scan.pt.y;
            pt_01.x = scan.pt.x;
            FEnsurePointOnScreen(pt_01, 1);
            UpdateWindow(hwndScanner);
            SendMessage(hwndScanner, WM_CHAR, 0x76, 0);
            return 1;
        }
        uVar3 = CchGetString(idsFleet, szT);
        sVar4 = __strnicmp(szName, szT, uVar3);
        if (sVar4 == 0) {
            pch = szName + 6;
        } else {
            pch = szName;
        }
        for (; *pch == ' '; pch = pch + 1) {
        }
        if (*pch == '#') {
            pch = pch + 1;
        }
        for (; *pch == ' '; pch = pch + 1) {
        }
        if (('0' < *pch) && (*pch < ':')) {
            ifl = *pch + -0x30;
            do {
                pch = pch + 1;
                if ((*(byte *)(*pch + 0x175f) & 4) == 0) {
                    lpfl = LpflFromId(ifl - 1U | idPlayer << 9);
                    if (((FLEET *)lpfl != (FLEET *)0x0) || ((int)((ulong)lpfl >> 0x10) != 0))
                        goto SCAN_LFoundFleetId;
                    break;
                }
                ifl = ifl * 10 + (int)*pch + -0x30;
            } while (ifl < 0x201);
        }
        for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
            /* WARNING: Load size is inaccurate */
            pFVar1 = ((FLEET **)rglpfl)[ifl];
            iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
            lpfl = (FLEET *)CONCAT22(iVar2, pFVar1);
            if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0))
                break;
            pcVar7 = szName;
            pcVar5 = PszGetFleetName(lpfl->id);
            sVar4 = __strcmpi(pcVar5, pcVar7);
            if (sVar4 == 0) {
            SCAN_LFoundFleetId:
                uVar6 = (undefined2)((ulong)lpfl >> 0x10);
                pt_00.y = (((FLEET *)lpfl)->pt).y;
                pt_00.x = (&((FLEET *)lpfl)->pt)->x;
                FFindNearestObject(pt_00, grobjFleet, &scan);
                scan.ifl = IflFromLpfl(lpfl);
                ChangeScanSel(&scan, 2);
                pt_02.y = scan.pt.y;
                pt_02.x = scan.pt.x;
                FEnsurePointOnScreen(pt_02, 1);
                UpdateWindow(hwndScanner);
                SendMessage(hwndScanner, WM_CHAR, 0x76, 0);
                return 1;
            }
        }
        if (iplPartial == -1) {
            return 0;
        }
        ipl = iplPartial;
    } while (true);
}

// ======================================================================
// Function: GetScanFleetOrientation
// Address: 1058:978c
// Segment: MEMORY_SCAN
// ======================================================================

void GetScanFleetOrientation(FLEET *lpfl, POINT *ppt, POINT *pptD)

{
    FLEET     *pFVar1;
    undefined2 uVar2;
    short      dx;
    short      dy;

    uVar2 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar1 = (FLEET *)lpfl;
    if (pFVar1->iPlayer == idPlayer) {
        if ((1 < pFVar1->cord) && ((((PLORD *)pFVar1->lpplord + 7)->wFlags >> 4 & 0xf) != 0)) {
            dx = *(int *)&((PLORD *)pFVar1->lpplord)[5].iordMax - (&pFVar1->pt)->x;
            dy = ((PLORD *)pFVar1->lpplord + 6)->wFlags - (pFVar1->pt).y;
            goto LAB_1058_985e;
        }
    } else if (((*(uint *)((int)&pFVar1->dirLong + 2) >> 4 & 1) != 0) && ((*(uint *)((int)&pFVar1->dirLong + 2) & 0xf) != 0)) {
        dx = (*(uint *)&pFVar1->dirLong & 0xff) - 0x7f;
        dy = (*(uint *)&pFVar1->dirLong >> 8) - 0x7f;
        goto LAB_1058_985e;
    }
    dy = 0;
    dx = 0;
LAB_1058_985e:
    GetDxDyOrientation(dx, dy, ppt, pptD);
    return;
}

// ======================================================================
// Function: GetDxDyOrientation
// Address: 1058:987c
// Segment: MEMORY_SCAN
// ======================================================================

void GetDxDyOrientation(short dx, short dy, POINT *ppt, POINT *pptD)

{
    short      sVar1;
    int        iVar2;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    long       lVar3;
    long       local_16;
    short      iBmp;
    double     dbl;

    iBmp = 0;
    if ((dx != 0) || (dy != 0)) {
        local_16 = (long)dx;
        iVar2 = dy >> 0xf;
        _atan2((double)(long)dy, (double)local_16);
        lVar3 = __ftol((double)CONCAT26(iVar2, CONCAT24(dy, CONCAT22(unaff_SI, unaff_DI))));
        iBmp = 9 - ((uint)lVar3 & 7) & 7;
    }
    if (iScanZoom < 0) {
        sVar1 = 7;
    } else {
        sVar1 = 9;
    }
    pptD->y = sVar1;
    pptD->x = sVar1;
    if (iScanZoom < 0) {
        ppt->x = 0;
    } else {
        ppt->x = 7;
    }
    ppt->y = iBmp * pptD->y;
    return;
}

// ======================================================================
// Function: FHandleMeasuringTape
// Address: 1058:9974
// Segment: MEMORY_SCAN
// ======================================================================

short FHandleMeasuringTape(SCAN *pscan, POINT pt)

{
    bool        bVar1;
    undefined1 *puVar2;
    HDC         HVar3;
    HGDIOBJ     HVar4;
    short       sVar5;
    short       sVar6;
    uint        uVar7;
    undefined1 *puVar8;
    undefined2  uVar9;
    undefined2  unaff_SS;
    RECT        rc;
    SCAN        scan;
    short       fVirgin;
    char        szT[20];
    POINT       ptNew;
    short       iropSav;
    POINT       ptBase;
    POINT       ptLogical;
    short       grTypeIn;
    POINT       ptLogLast;
    SBAR        sbar;
    HPEN        hpenSav;
    HDC         hdc;

    bVar1 = true;
    ptLogLast.x = (pscan->pt).x;
    ptLogLast.y = (pscan->pt).y;
    ptBase.x = (pscan->pt).x;
    ptBase.y = (pscan->pt).y;
    LogicalToScan(&ptBase);
    GetClientRect(hwndScanner, &rc);
    rc.bottom = rc.bottom - dySBar;
    HVar3 = GetDC(hwndScanner);
    SetCapture(hwndScanner);
    sbar.pscan = pscan;
    HVar4 = SelectObject(HVar3, hpenShip);
    sVar5 = SetROP2(HVar3, 7);
    ptNew.x = pt.x;
    ptNew.y = pt.y;
    uVar9 = 0x1058;
    LogicalToScan(&ptNew);
    puVar2 = &stack0xffa6;
LAB_1058_9a11:
    do {
        puVar8 = puVar2;
        *(POINT **)(puVar8 + -2) = &ptNew;
        *(undefined2 *)(puVar8 + -4) = uVar9;
        uVar9 = 0x1040;
        *(undefined2 *)(puVar8 + -6) = 0x9a1a;
        sVar6 = FGetRMouseMove(*(POINT **)(puVar8 + -2));
        if (sVar6 == 0) {
            if (!bVar1) {
                *(HDC *)(puVar8 + -2) = HVar3;
                *(short *)(puVar8 + -4) = ptBase.x;
                *(short *)(puVar8 + -6) = ptBase.y;
                *(undefined2 *)(puVar8 + -8) = 0x1040;
                *(undefined2 *)(puVar8 + -10) = 0x9c92;
                MoveTo(*(HDC *)(puVar8 + -2), *(short *)(puVar8 + -4), *(short *)(puVar8 + -6));
                *(HDC *)(puVar8 + -2) = HVar3;
                *(short *)(puVar8 + -4) = pt.x;
                *(short *)(puVar8 + -6) = pt.y;
                *(undefined2 *)(puVar8 + -8) = 0x14f8;
                uVar9 = 0x14f8;
                *(undefined2 *)(puVar8 + -10) = 0x9ca0;
                LineTo(*(HDC *)(puVar8 + -2), *(short *)(puVar8 + -4), *(short *)(puVar8 + -6));
            }
            *(HDC *)(puVar8 + -2) = HVar3;
            *(short *)(puVar8 + -4) = sVar5;
            *(undefined2 *)(puVar8 + -6) = uVar9;
            *(undefined2 *)(puVar8 + -8) = 0x9cab;
            SetROP2(*(HDC *)(puVar8 + -2), *(short *)(puVar8 + -4));
            *(HDC *)(puVar8 + -2) = HVar3;
            *(HGDIOBJ *)(puVar8 + -4) = HVar4;
            *(undefined2 *)(puVar8 + -6) = 0x14f8;
            *(undefined2 *)(puVar8 + -8) = 0x9cb6;
            SelectObject(*(HDC *)(puVar8 + -2), *(HGDIOBJ *)(puVar8 + -4));
            *(undefined2 *)(puVar8 + -2) = 0;
            *(undefined2 *)(puVar8 + -4) = 0;
            *(undefined2 *)(puVar8 + -6) = 0;
            *(HDC *)(puVar8 + -8) = HVar3;
            *(undefined2 *)(puVar8 + -10) = 0x14f8;
            *(undefined2 *)(puVar8 + -0xc) = 0x9cca;
            DrawScannerSBar(*(HDC *)(puVar8 + -8), *(RECT **)(puVar8 + -6), *(SBAR **)(puVar8 + -4), *(short *)(puVar8 + -2));
            *(undefined2 *)(puVar8 + -2) = 0x1058;
            *(undefined2 *)(puVar8 + -4) = 0x9cd2;
            ReleaseCapture();
            *(HWND *)(puVar8 + -2) = hwndScanner;
            *(HDC *)(puVar8 + -4) = HVar3;
            *(undefined2 *)(puVar8 + -6) = 0x14f8;
            *(undefined2 *)(puVar8 + -8) = 0x9cde;
            ReleaseDC(*(HWND *)(puVar8 + -2), *(HDC *)(puVar8 + -4));
            return (uint)!bVar1;
        }
        uVar7 = rc.right;
        if (ptNew.x <= rc.right) {
            uVar7 = ptNew.x;
        }
        if (uVar7 < 0x8000) {
            ptLogical.x = rc.right;
            if (ptNew.x <= rc.right) {
                ptLogical.x = ptNew.x;
            }
        } else {
            ptLogical.x = 0;
        }
        ptNew.x = ptLogical.x;
        uVar7 = rc.bottom;
        if (ptNew.y <= rc.bottom) {
            uVar7 = ptNew.y;
        }
        if (uVar7 < 0x8000) {
            ptLogical.y = rc.bottom;
            if (ptNew.y <= rc.bottom) {
                ptLogical.y = ptNew.y;
            }
        } else {
            ptLogical.y = 0;
        }
        ptNew.y = ptLogical.y;
        *(POINT **)(puVar8 + -2) = &ptLogical;
        *(undefined2 *)(puVar8 + -4) = 0x1040;
        *(undefined2 *)(puVar8 + -6) = 0x9ab0;
        ScanToLogical(*(POINT **)(puVar8 + -2));
        *(undefined2 *)(puVar8 + -2) = 0x10;
        *(undefined2 *)(puVar8 + -4) = 0x1058;
        *(undefined2 *)(puVar8 + -6) = 0x9abc;
        uVar7 = GetAsyncKeyState(*(short *)(puVar8 + -2));
        if ((uVar7 & 0xfffe) == 0) {
            uVar9 = 0x4f;
        } else {
            uVar9 = 0x8f;
        }
        *(SCAN **)(puVar8 + -4) = &scan;
        *(undefined2 *)(puVar8 + -6) = uVar9;
        *(short *)(puVar8 + -8) = ptLogical.y;
        *(short *)(puVar8 + -10) = ptLogical.x;
        *(undefined2 *)(puVar8 + -0xc) = 0x14f8;
        uVar9 = 0x1038;
        *(undefined2 *)(puVar8 + -0xe) = 0x9ae5;
        sVar6 = FFindNearestObject(*(puVar8 + -10), *(GrobjClass *)(puVar8 + -6), *(SCAN **)(puVar8 + -4));
        if (sVar6 != 0) {
            ptLogical.x = scan.pt.x;
            ptLogical.y = scan.pt.y;
        }
    } while ((ptLogLast.x == ptLogical.x) && (puVar2 = puVar8 + -2, ptLogLast.y == ptLogical.y));
    ptNew.x = ptLogical.x;
    ptNew.y = ptLogical.y;
    *(POINT **)(puVar8 + -4) = &ptNew;
    *(undefined2 *)(puVar8 + -6) = 0x1038;
    *(undefined2 *)(puVar8 + -8) = 0x9b2a;
    LogicalToScan(*(POINT **)(puVar8 + -4));
    if (bVar1) {
        *(short *)(puVar8 + -4) = ptLogical.x - ptLogLast.x;
        *(undefined2 *)(puVar8 + -6) = 0x1058;
        *(undefined2 *)(puVar8 + -8) = 0x9b42;
        sVar6 = _abs(*(short *)(puVar8 + -4));
        if (sVar6 < 3)
            goto LAB_1058_9b4d;
        goto LAB_1058_9b67;
    }
    *(HDC *)(puVar8 + -4) = HVar3;
    *(short *)(puVar8 + -6) = ptBase.x;
    *(short *)(puVar8 + -8) = ptBase.y;
    *(undefined2 *)(puVar8 + -10) = 0x1058;
    *(undefined2 *)(puVar8 + -0xc) = 0x9b7d;
    MoveTo(*(HDC *)(puVar8 + -4), *(short *)(puVar8 + -6), *(short *)(puVar8 + -8));
    *(HDC *)(puVar8 + -4) = HVar3;
    *(short *)(puVar8 + -6) = pt.x;
    *(short *)(puVar8 + -8) = pt.y;
    *(undefined2 *)(puVar8 + -10) = 0x14f8;
    uVar9 = 0x14f8;
    *(undefined2 *)(puVar8 + -0xc) = 0x9b8b;
    LineTo(*(HDC *)(puVar8 + -4), *(short *)(puVar8 + -6), *(short *)(puVar8 + -8));
    goto LAB_1058_9b8b;
LAB_1058_9b4d:
    *(short *)(puVar8 + -4) = ptLogical.y - ptLogLast.y;
    *(undefined2 *)(puVar8 + -6) = 0x1118;
    uVar9 = 0x1118;
    *(undefined2 *)(puVar8 + -8) = 0x9b59;
    sVar6 = _abs(*(short *)(puVar8 + -4));
    puVar2 = puVar8 + -2;
    if (2 < sVar6) {
    LAB_1058_9b67:
        uVar9 = 0x1118;
        bVar1 = false;
    LAB_1058_9b8b:
        *(HDC *)(puVar8 + -4) = HVar3;
        *(short *)(puVar8 + -6) = ptBase.x;
        *(short *)(puVar8 + -8) = ptBase.y;
        *(undefined2 *)(puVar8 + -10) = uVar9;
        *(undefined2 *)(puVar8 + -0xc) = 0x9b99;
        MoveTo(*(HDC *)(puVar8 + -4), *(short *)(puVar8 + -6), *(short *)(puVar8 + -8));
        *(HDC *)(puVar8 + -4) = HVar3;
        *(short *)(puVar8 + -6) = ptNew.x;
        *(short *)(puVar8 + -8) = ptNew.y;
        *(undefined2 *)(puVar8 + -10) = 0x14f8;
        uVar9 = 0x14f8;
        *(undefined2 *)(puVar8 + -0xc) = 0x9ba7;
        LineTo(*(HDC *)(puVar8 + -4), *(short *)(puVar8 + -6), *(short *)(puVar8 + -8));
        if (scan.grobj == grobjNone) {
            sbar.id = -1;
            *(char **)(puVar8 + -4) = szT;
            *(undefined2 *)(puVar8 + -6) = 0x362;
            *(undefined2 *)(puVar8 + -8) = 0x14f8;
            uVar9 = 0x1040;
            *(undefined2 *)(puVar8 + -10) = 0x9bc2;
            CchGetString(*(StringId *)(puVar8 + -6), *(char **)(puVar8 + -4));
            sbar.psz = szT;
        } else {
            if (scan.grobj == grobjPlanet) {
                sbar.id = scan.idpl;
            } else if (scan.grobj == grobjFleet) {
                sbar.id = ((FLEET **)rglpfl)[scan.ifl]->id;
            } else if (scan.grobj == grobjThing) {
                sbar.id = ((THING *)lpThings + scan.ith)->idFull;
            } else {
                sbar.id = scan.iwp;
            }
            sbar.psz = (char *)0x0;
        }
        sbar.pt.x = ptLogical.x;
        sbar.pt.y = ptLogical.y;
        sbar.grbit = scan.grobj;
        *(undefined2 *)(puVar8 + -4) = 0;
        *(SBAR **)(puVar8 + -6) = &sbar;
        *(undefined2 *)(puVar8 + -8) = 0;
        *(HDC *)(puVar8 + -10) = HVar3;
        *(undefined2 *)(puVar8 + -0xc) = uVar9;
        uVar9 = 0x1058;
        *(undefined2 *)(puVar8 + -0xe) = 0x9c5d;
        DrawScannerSBar(*(HDC *)(puVar8 + -10), *(RECT **)(puVar8 + -8), *(SBAR **)(puVar8 + -6), *(short *)(puVar8 + -4));
        pt.y = ptNew.y;
        pt.x = ptNew.x;
        ptLogLast.x = ptLogical.x;
        ptLogLast.y = ptLogical.y;
        puVar2 = puVar8 + -2;
    }
    goto LAB_1058_9a11;
}
