// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: ScannerWndProc
// Address: 1058:0032
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x105809f8) */
/* WARNING: Removing unreachable block (ram,0x1058094a) */
/* WARNING: Removing unreachable block (ram,0x1058014f) */

long ScannerWndProc(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  FLEET *pFVar1;
  POINT PVar2;
  POINT PVar3;
  POINT pt_00;
  POINT pt_01;
  POINT ptIn;
  POINT pt_02;
  POINT pt_03;
  POINT pt_04;
  BOOL BVar4;
  short sVar5;
  uint uVar6;
  HCURSOR HVar7;
  GrobjClass grobj;
  int iVar8;
  undefined4 *puVar9;
  int iVar10;
  undefined2 unaff_SI;
  int *piVar11;
  short *psVar12;
  undefined2 unaff_DI;
  undefined2 uVar13;
  undefined2 unaff_SS;
  DWORD DVar14;
  ulong uVar15;
  LRESULT LVar16;
  short dy;
  ushort in_stack_0000fdda;
  short id;
  short iSel;
  short iChecked;
  undefined4 rgid;
  undefined2 local_216;
  undefined2 local_214;
  short fSep;
  FLEET *lpfl;
  THING *lpth;
  short c;
  short i;
  SCAN scan;
  short fChgScan;
  undefined1 plT [48];
  short i__58;
  short iRopSav;
  HPEN hpenSav;
  short iScanNew;
  RECT rc;
  PAINTSTRUCT ps;
  POINT pt;
  HDC hdc;
  
  uVar15 = CONCAT22(unaff_SI,unaff_DI);
  if (msg == 1) {
    yScanTop = 1000;
    xScanTop = 1000;
    return 0;
  }
  if (msg == 5) {
    SetScanScrollBars(hwnd);
    PostMessage(hwndFrame,0x111,iScanZoom + 0xf41,0);
  }
  else {
    if (msg == 0xf) {
      hdc = BeginPaint(hwnd,(PAINTSTRUCT *)&ps);
      if ((((FLEET **)rglpfl != (FLEET **)0x0) || (rglpfl._2_2_ != 0)) &&
         ((gd._4_2_ & 1) == 0)) {
        GetClientRect(hwnd,(RECT *)&rc);
        DrawScannerSBar(hdc,&ps.rcPaint,(SBAR *)0x0,1);
        rc.bottom = rc.bottom - dySBar;
        DrawScanner(hdc,&ps.rcPaint);
      }
      EndPaint(hwnd,(PAINTSTRUCT *)&ps);
      return 0;
    }
    if (msg != 0x20) {
      if (msg == 0x102) {
        if ((wParam == 0x76) || (wParam == 0x56)) {
          hdc = GetDC(hwndScanner);
          pt.x = sel.scan.pt.x;
          pt.y = sel.scan.pt.y;
          LogicalToScan(&pt);
          iRopSav = SetROP2(hdc,7);
          hpenSav = SelectObject(hdc,hpenYellow);
          for (i__58 = 0; i__58 < 2; i__58 = i__58 + 1) {
            MoveTo(hdc,pt.x + -300,pt.y + -300);
            LineTo(hdc,pt.x + 300,pt.y + 300);
            MoveTo(hdc,pt.x + -300,pt.y + 300);
            LineTo(hdc,pt.x + 300,pt.y + -300);
            if (i__58 == 0) {
              DVar14 = GetTickCount();
              plT._44_4_ = DVar14;
              while( true ) {
                DVar14 = GetTickCount();
                if (plT._44_4_ + 0x96 <= DVar14) break;
                Yield();
              }
            }
          }
          SelectObject(hdc,hpenSav);
          SetROP2(hdc,iRopSav);
          ReleaseDC(hwndScanner,hdc);
        }
        else {
          if (wParam == 0x2d) {
            iScanNew = iScanZoom + -1;
            if (iScanNew < -4) {
              iScanNew = -4;
            }
          }
          else {
            iScanNew = iScanZoom + 1;
            if (4 < iScanNew) {
              iScanNew = 4;
            }
          }
          if (iScanNew != iScanZoom) {
            SendMessage(hwndFrame,0x111,iScanNew + 0xf41,0);
          }
        }
      }
      else if ((msg == 0x114) || (msg == 0x115)) {
        switch(wParam) {
        case 0:
          iScanNew = -dScanInc;
          break;
        case 1:
          iScanNew = dScanInc;
          break;
        case 2:
          iScanNew = -dScanPage;
          break;
        case 3:
          iScanNew = dScanPage;
          break;
        case 4:
        case 5:
          sVar5 = yScanTop;
          if (msg != 0x115) {
            sVar5 = xScanTop;
          }
          iScanNew = (int)lParam - sVar5 & 0xfffc;
          break;
        default:
          iScanNew = 0;
        }
        if (iScanNew != 0) {
          if (msg == 0x115) {
            hpenSav = yScanTop;
            SetScrollPos(hwnd,1,yScanTop + iScanNew,1);
            yScanTop = GetScrollPos(hwnd,1);
            sVar5 = PtToScan(hpenSav - yScanTop);
            ScrollScanner(0,sVar5);
          }
          else {
            hpenSav = xScanTop;
            SetScrollPos(hwnd,0,xScanTop + iScanNew,1);
            xScanTop = GetScrollPos(hwnd,0);
            dy = 0;
            sVar5 = PtToScan(hpenSav - xScanTop);
            ScrollScanner(sVar5,dy);
          }
        }
      }
      else if ((((msg == 0x201) || (msg == 0x203)) || (msg == 0x204)) || (msg == 0x207)) {
        SetFocus(hwndFrame);
        pt.x = (int)lParam;
        uVar15 = __aFulshr(uVar15,in_stack_0000fdda);
        pt.y = (short)uVar15;
        GetClientRect(hwnd,(RECT *)&rc);
        if (pt.y < rc.bottom - dySBar) {
          ScanToLogical(&pt);
          if ((((uint)gd.wFlags >> 8 & 1) == 0) && (((uint)gd.wFlags >> 0xd & 1) == 0)
             ) {
            grobj = grobjThing|grobjOther|grobjFleet|grobjPlanet;
          }
          else {
            grobj = grobjPlanet;
          }
          pt_01.y = pt.y;
          pt_01.x = pt.x;
          FFindNearestObject(pt_01,grobj,&scan);
          if (((((uint)gd.wFlags >> 8 & 1) == 0) &&
              (((sel.grobj != grobjPlanet || ((wParam & 4) == 0)) ||
               (sVar5 = IWarpMAFromLppl(&sel.pl,(short *)0x0), sVar5 < 1)))) ||
             (msg != 0x201)) {
            if (((((uint)gd.wFlags >> 0xd & 1) == 0) &&
                ((sel.grobj != grobjPlanet || ((wParam & 8) == 0)))) || (msg != 0x201)) {
              if ((msg == 0x207) || ((msg == 0x204 && ((wParam & 4) != 0)))) {
                pt_03.y = pt.y;
                pt_03.x = pt.x;
                FHandleMeasuringTape(&scan,pt_03);
              }
              else {
                if (msg == 0x204) {
                  iChecked = -1;
                  pt.x = scan.pt.x;
                  pt.y = scan.pt.y;
                  if ((scan.grobjFull & grobjPlanet) == grobjNone) {
                    c = 0;
                  }
                  else {
                    rgid._2_2_ = scan.idpl >> 0xf;
                    rgid._0_2_ = scan.idpl;
                    local_216 = 0xffff;
                    local_214 = 0xffff;
                    c = 2;
                    if ((sel.grobj == grobjPlanet) && (sel.id == scan.idpl)) {
                      iChecked = 0;
                    }
                  }
                  for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
                    pFVar1 = ((FLEET **)rglpfl)[i];
                    iVar10 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                    lpfl = (FLEET *)CONCAT22(iVar10,pFVar1);
                    if ((pFVar1 == (FLEET *)0x0) && (iVar10 == 0)) break;
                    if ((pt.x == (&pFVar1->pt)->x) && (pt.y == (pFVar1->pt).y)) {
                      if ((sel.grobj == grobjFleet) && (lpfl->id == sel.id)) {
                        iChecked = c;
                      }
                      iVar10 = lpfl->id;
                      iVar8 = c * 4;
                      piVar11 = (int *)(&rgid + c);
                      c = c + 1;
                      *piVar11 = iVar10;
                      *(uint *)((int)&rgid + iVar8 + 2) = iVar10 >> 0xf | 0x8000;
                      if (0x61 < c) break;
                    }
                  }
                  if ((c == 2) && ((scan.grobjFull & grobjPlanet) != grobjNone)) {
                    c = 1;
                  }
                  fSep = (short)(c == 0);
                  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
                  while ((THING *)lpth < (THING *)lpThings + cThing) {
                    uVar13 = (undefined2)((ulong)lpth >> 0x10);
                    if ((pt.x == (&((THING *)lpth)->pt)->x) && (pt.y == (((THING *)lpth)->pt).y)) {
                      if (fSep == 0) {
                        iVar10 = c * 4;
                        puVar9 = &rgid + c;
                        c = c + 1;
                        *(undefined2 *)puVar9 = 0xffff;
                        *(undefined2 *)((int)&rgid + iVar10 + 2) = 0xffff;
                        fSep = 1;
                      }
                      iVar10 = c * 4;
                      psVar12 = (short *)(&rgid + c);
                      c = c + 1;
                      *psVar12 = lpth->idFull;
                      *(undefined2 *)((int)&rgid + iVar10 + 2) = 0x2000;
                      if (99 < c) break;
                    }
                    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
                  }
                  LogicalToScan(&pt);
                  sVar5 = PopupMenu(hwnd,pt.x,pt.y,c,&rgid,(char **)0x0,iChecked,1);
                  if (sVar5 < 0) {
                    return 0;
                  }
                  if ((*(uint *)((int)&rgid + sVar5 * 4 + 2) & 0x8000) == 0) {
                    if ((*(uint *)((int)&rgid + sVar5 * 4 + 2) & 0x2000) == 0) {
                      scan.grobj = grobjPlanet;
                    }
                    else {
                      scan.grobj = grobjThing;
                      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
                      while (((THING *)lpth < (THING *)lpThings + cThing &&
                             (lpth->idFull != *(int *)(&rgid + sVar5)))) {
                        lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
                      }
                      scan.ith = ((int)(THING *)lpth - (int)(THING *)lpThings) / 0x12;
                    }
                  }
                  else {
                    scan.grobj = grobjFleet;
                    for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
                      pFVar1 = ((FLEET **)rglpfl)[i];
                      iVar10 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
                      lpfl = (FLEET *)CONCAT22(iVar10,pFVar1);
                      if (((pFVar1 == (FLEET *)0x0) && (iVar10 == 0)) ||
                         (lpfl->id == *(int *)(&rgid + sVar5))) break;
                    }
                    scan.ifl = i;
                  }
                  ChangeScanSel(&scan,2);
                  if (scan.grobj == grobjPlanet) {
                    sVar5 = FLookupPlanet(scan.idpl,(PLANET *)plT);
                    if (sVar5 == 0) {
                      return 0;
                    }
                    if (plT._2_2_ != idPlayer) {
                      return 0;
                    }
                  }
                }
                else {
                  if ((sel.grobj == grobjFleet) &&
                     (((wParam & 4) != 0 || ((grbitScan & 0x10) != 0)))) {
                    ptIn.y = pt.y;
                    ptIn.x = pt.x;
                    FAddWayPoint(ptIn,&scan);
                    return 0;
                  }
                  if ((scan.pt.x == sel.scan.pt.x) &&
                     (scan.pt.y == sel.scan.pt.y)) {
                    fChgScan = 1;
                  }
                  else {
                    fChgScan = 0;
                  }
                  ChangeScanSel(&scan,1);
                  pt_02.y = pt.y;
                  pt_02.x = pt.x;
                  sVar5 = FNearAWayPoint(pt_02,1);
                  if ((sVar5 != 0) &&
                     (pt_04.y = pt.y, pt_04.x = pt.x, sVar5 = FHandleWayPointDrag(pt_04), sVar5 != 0
                     )) {
                    return 0;
                  }
                  if (fChgScan == 0) {
                    return 0;
                  }
                  if ((scan.grobj != grobjFleet) && (scan.grobj != grobjPlanet)) {
                    return 0;
                  }
                  if ((scan.pt.x == sel.pt.x) && (scan.pt.y == sel.pt.y)) {
                    sVar5 = FGetNextObjHere(&scan,1);
                    if (sVar5 == 0) {
                      return 0;
                    }
                  }
                  else if (scan.grobj == grobjPlanet) {
                    sVar5 = FLookupPlanet(scan.idpl,(PLANET *)plT);
                    if (sVar5 == 0) {
                      return 0;
                    }
                    if ((plT._2_2_ != idPlayer) ||
                       ((((scan.grobjFull & grobjFleet) != grobjNone &&
                         (sel.grobj == grobjPlanet)) && (scan.idpl == sel.id))))
                    {
                      if ((scan.grobjFull & grobjFleet) == grobjNone) {
                        return 0;
                      }
                      scan.grobj = grobjFleet;
                    }
                  }
                }
                if (((scan.grobj != grobjFleet) ||
                    (((FLEET *)((FLEET **)rglpfl)[scan.ifl])->iPlayer == idPlayer)) &&
                   (scan.grobj != grobjThing)) {
                  if (scan.grobj == grobjFleet) {
                    scan.iwp = -1;
                  }
                  ChangeScanSel(&scan,1);
                  RedrawScanSel(0,0);
                  if (scan.grobj != grobjPlanet) {
                    scan.idpl = ((FLEET **)rglpfl)[scan.ifl]->id;
                  }
                  ChangeMainObjSel(scan.grobj,scan.idpl);
                  RedrawScanSel(0,1);
                  if ((scan.grobj == grobjFleet) && ((scan.grobjFull & grobjPlanet) != grobjNone)) {
                    scan.grobj = grobjPlanet;
                    ChangeScanSel(&scan,1);
                  }
                }
              }
            }
            else {
              DrawShipScanPath(0,0);
              if (scan.idpl == sel.pl.id) {
                sel.pl.wRouting = sel.pl.wRouting & 0xfc00;
              }
              else {
                i = scan.idpl + 1;
                sel.pl.wRouting = sel.pl.wRouting & 0xfc00U | i & 0x3ffU;
              }
              FLookupPlanet(-1,(PLANET *)&sel.pl);
              gd.wFlags = gd.wFlags & 0xdfff;
              DrawShipScanPath(0,1);
              DrawPlanShip(0,0x4040);
            }
          }
          else {
            DrawShipScanPath(0,0);
            if (scan.idpl == sel.pl.id) {
              sel.pl.wFlags = sel.pl.wFlags & 0xfc00;
            }
            else {
              i = scan.idpl + 1;
              sel.pl.wFlags = sel.pl.wFlags & 0xfc00U | i & 0x3ffU;
            }
            FLookupPlanet(-1,(PLANET *)&sel.pl);
            gd.wFlags = gd.wFlags & 0xfeff;
            DrawShipScanPath(0,1);
            DrawPlanShip(0,0x4100);
          }
        }
        else if (((msg == 0x201) && (pt.y < rc.bottom - (dySBar >> 1))) &&
                ((sel.scan.grobjFull & (grobjFleet|grobjPlanet)) != grobjNone)) {
          if (sel.scan.grobj == grobjFleet) {
            GlobalPD.grPopup = 3;
            GlobalPD._2_2_ =
                 *(undefined2 *)((FLEET **)rglpfl + sel.scan.ifl);
            GlobalPD.psz =
                 (char *)*(undefined2 *)
                          ((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
          }
          else {
            GlobalPD.grPopup = 4;
          }
          Popup(hwnd,pt.x,pt.y);
        }
      }
      else {
        if (msg != 0x222) goto SCAN_Default_2;
        hwndActive = hwnd;
        if (wParam == 0) {
          hwndActive = 0;
        }
      }
      return 0;
    }
    GetCursorPos((POINT *)(POINT *)&pt);
    ScreenToClient(hwndScanner,(POINT *)(POINT *)&pt);
    GetClientRect(hwnd,(RECT *)&rc);
    PVar2.y = pt.y;
    PVar2.x = pt.x;
    BVar4 = PtInRect((RECT *)&rc,PVar2);
    if (BVar4 != 0) {
      rc.bottom = rc.bottom - dySBar;
      PVar3.y = pt.y;
      PVar3.x = pt.x;
      BVar4 = PtInRect((RECT *)&rc,PVar3);
      if (BVar4 == 0) {
        HVar7 = LoadCursor(0,&DAT_0000_7f00);
        setcursor(HVar7);
      }
      else if ((sel.grobj == grobjFleet) &&
              ((uVar6 = GetAsyncKeyState(0x10), (uVar6 & 0xfffe) != 0 ||
               ((grbitScan & 0x10) != 0)))) {
        setcursor(hcurScanAdd);
      }
      else {
        pt_00.y = pt.y;
        pt_00.x = pt.x;
        sVar5 = FNearAWayPoint(pt_00,0);
        if (sVar5 == 0) {
          if (((((uint)gd.wFlags >> 8 & 1) == 0) &&
              (((uint)gd.wFlags >> 0xd & 1) == 0)) &&
             ((sel.grobj != grobjPlanet ||
              (((uVar6 = GetAsyncKeyState(0x10), (uVar6 & 0xfffe) == 0 ||
                (sVar5 = IWarpMAFromLppl(&sel.pl,(short *)0x0), sVar5 < 1)) &&
               (uVar6 = GetAsyncKeyState(0x11), (uVar6 & 0xfffe) == 0)))))) {
            setcursor(hcurScanner);
          }
          else {
            setcursor(hcurScanAdd);
          }
        }
        else {
          setcursor(hcurOpenGrab);
        }
      }
      return 1;
    }
  }
SCAN_Default_2:
  LVar16 = DefWindowProc(hwnd,msg,wParam,lParam);
  return LVar16;
}



// ======================================================================
// Function: PtToScan
// Address: 1058:0efc
// Segment: MEMORY_SCAN
// ======================================================================


short PtToScan(short d)

{
  if (iScanZoom != 0) {
    switch(iScanZoom) {
    default:
      break;
    case 1:
      d = d * 5 >> 2;
      break;
    case 2:
      d = d * 3 >> 1;
      break;
    case 3:
      d = d << 1;
      break;
    case 4:
      d = d << 2;
      break;
    case -4:
      d = d >> 2;
      break;
    case -3:
      d = d * 3 >> 3;
      break;
    case -2:
      d = d >> 1;
      break;
    case -1:
      d = d * 3 >> 2;
    }
  }
  return d;
}



// ======================================================================
// Function: ScanToPt
// Address: 1058:0fc2
// Segment: MEMORY_SCAN
// ======================================================================


short ScanToPt(short d)

{
  if (iScanZoom != 0) {
    switch(iScanZoom) {
    default:
      break;
    case 1:
      d = (d << 2) / 5;
      break;
    case 2:
      d = (d << 1) / 3;
      break;
    case 3:
      d = d >> 1;
      break;
    case 4:
      d = d >> 2;
      break;
    case -4:
      d = d << 2;
      break;
    case -3:
      d = (d << 3) / 3;
      break;
    case -2:
      d = d << 1;
      break;
    case -1:
      d = (d << 2) / 3;
    }
  }
  return d;
}



// ======================================================================
// Function: DrawScanner
// Address: 1058:108a
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x105838a5) */
/* WARNING: Removing unreachable block (ram,0x10583928) */
/* WARNING: Removing unreachable block (ram,0x10581d7f) */
/* WARNING: Removing unreachable block (ram,0x1058118f) */
/* WARNING: Removing unreachable block (ram,0x10582bf0) */
/* WARNING: Removing unreachable block (ram,0x105841d5) */

short DrawScanner(HDC hdc,RECT *prc)

{
  HGDIOBJ HVar1;
  short sVar2;
  uint uVar3;
  HBRUSH HVar4;
  HPEN HVar5;
  undefined2 uVar6;
  int *piVar7;
  PLANET *pPVar8;
  THING *pTVar9;
  FLEET *pFVar10;
  int iVar11;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  bool bVar12;
  COLORREF CVar13;
  PLANET *pPVar14;
  long lVar15;
  RECT *pRVar16;
  undefined2 uVar17;
  HDC HVar18;
  THING *in_stack_0000f586;
  PLANET *in_stack_0000f588;
  short dPlanRange;
  DRAWCIR dc;
  short rgrad [250];
  short rgx [250];
  short fPlanetScanner;
  short rgy [240];
  THING *local_492;
  HBITMAP hbmpTrSav;
  THING *lpthMac;
  PLANET *l;
  THING *lpth;
  undefined4 hbr;
  int pt2;
  short fTerra;
  undefined4 crBack;
  undefined4 l__1146;
  RECT rc;
  uint ptOrigin;
  uint local_46c;
  short fDoDraw;
  short xLeft;
  HBRUSH hbrSav;
  short dx;
  short yMin;
  ushort mdScanBase;
  short fStargate;
  THING *lpthMac__1116;
  PLANET *local_45a;
  short ptSelMain;
  short local_456;
  short fStarbase;
  short fMA;
  short fSelected;
  POINT ptO;
  short idP;
  short dRange;
  short rcDraw;
  short sStack_444;
  short sStack_442;
  short sStack_440;
  short yOff;
  short rcClip;
  short local_43a;
  short local_438;
  short local_436;
  short iord;
  HBITMAP hbmpSav;
  short xMin;
  short i;
  FLEET *lpfl;
  THING *lpth__1064;
  HDC hdcMem;
  char rgWhatsHere [1000];
  short yMax;
  PLANET *lppl;
  HDC hdcScreen;
  short id2;
  HBITMAP hbmpScreen;
  HBITMAP hbmpXSav;
  short dy;
  short yBmp;
  PLANET *lpplMac;
  short local_26;
  POINT ptD;
  short iBkPrev;
  undefined4 crFore;
  short id;
  POINT pt;
  short xMax;
  short yTop;
  short j;
  FLEET *lpflT;
  HPEN hpenSav;
  short dExpand;
  short xOff;
  
  mdScanBase = grbitScan & 0xf;
  hdcScreen = 0;
  hbmpScreen = 0;
  if (((((FLEET **)rglpfl != (FLEET **)0x0) || (rglpfl._2_2_ != 0)) &&
      ((gd._4_2_ & 1) == 0)) && (((uint)gd._0_2_ >> 1 & 1) == 0)) {
    xLeft = xScanTop;
    yTop = yScanTop;
    ptOrigin = PtToScan(4000 - xScanTop);
    ptOrigin = ptOrigin & 7;
    local_46c = PtToScan(4000 - yScanTop);
    local_46c = local_46c & 7;
    GetClientRect(hwndScanner,(RECT *)&rc);
    ExcludeClipRect(hdc,0,rc.bottom - dySBar,rc.right,rc.bottom);
    l__1146._0_2_ = prc->right - prc->left;
    l__1146._2_2_ = (int)l__1146 >> 0xf;
    l__1146 = __aFulmul((long)(int)l__1146,(long)(prc->bottom - prc->top));
    if ((long)l__1146 < 48000) {
      hdcMem = CreateCompatibleDC(hdc);
      if (hdcMem != 0) {
        hbmpScreen = CreateCompatibleBitmap
                               (hdc,prc->right - (prc->left & 0xfff8U),
                                prc->bottom - (prc->top & 0xfff8U));
        if (hbmpScreen == 0) {
          DeleteDC(hdcMem);
        }
      }
      HVar18 = hdcMem;
      if (hbmpScreen != 0) {
        hdcScreen = hdc;
        hdc = hdcMem;
        hbmpXSav = SelectObject(hdcMem,hbmpScreen);
        SetWindowOrg(HVar18,prc->left & 0xfff8,prc->top & 0xfff8);
        pt.y = 0;
        pt.x = 0;
        ClientToScreen(hwndScanner,(POINT *)&pt);
        ptOrigin = (ptOrigin + 8) - (pt.x & 7U) & 7;
        local_46c = (local_46c + 8) - (pt.y & 7U) & 7;
        rcDraw = prc->left;
        sStack_444 = prc->top;
        sStack_442 = prc->right;
        sStack_440 = prc->bottom;
      }
    }
    uVar17 = 0x1120;
    pRVar16 = prc;
    HVar18 = hdc;
    HVar1 = GetStockObject(4);
    FillRect(HVar18,(RECT *)CONCAT22(uVar17,pRVar16),HVar1);
    rcClip = prc->left;
    local_43a = prc->top;
    local_438 = prc->right;
    local_436 = prc->bottom;
    if (((iScanZoom < 3) || (mdScanBase != 4)) &&
       ((iScanZoom < 0 || ((mdScanBase != 1 && (mdScanBase != 2)))))) {
      dExpand = 9;
    }
    else {
      dExpand = 0x14;
    }
    ExpandRc(prc,dExpand,dExpand);
    prc->bottom = prc->bottom + 0xe;
    dx = ScanToPt(prc->right - prc->left);
    dy = ScanToPt(prc->bottom - prc->top);
    sVar2 = ScanToPt(prc->left);
    xMin = sVar2 + xLeft;
    xMax = xMin + dx;
    sVar2 = ScanToPt(prc->top);
    yMax = (dGalInv - yTop) - sVar2;
    yMin = yMax - dy;
    xOff = -xLeft;
    yOff = dGalInv - yTop;
    id = 1;
    for (i = 0; i < 0x10; i = i + 1) {
      if ((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) != 0) {
        grbitScanShip = grbitScanShip & ~(id & grbitScanShip);
      }
      id = id << 1;
    }
    hdcMem = CreateCompatibleDC(hdc);
    hbmpSav = SelectObject(hdcMem,hbmpScanner);
    if (sel.grobj == grobjNone) {
      local_456 = -2;
      ptSelMain = -2;
    }
    else {
      ptSelMain = sel.pt.x;
      local_456 = sel.pt.y;
    }
    if (((uint)gd._4_2_ >> 10 & 1) == 0) {
      LinkFleets(0);
    }
    else {
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar10 = ((FLEET **)rglpfl)[i];
        iVar11 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar11,pFVar10);
        if ((pFVar10 == (FLEET *)0x0) && (iVar11 == 0)) break;
        pFVar10->wFlags = pFVar10->wFlags & 0xf7ff;
      }
    }
    if ((grbitScan & 0x20) != 0) {
      fPlanetScanner = 0;
      dc.rgx = rgx;
      dc.rgy = rgy;
      dc.rgrad = rgrad;
      dc.cCur = 0;
      dc.cMax = 0xfa;
      dc.hdc = hdc;
      dc.rcClip.left = prc->left;
      dc.rcClip.top = prc->top;
      dc.rcClip.right = prc->right;
      dc.rcClip.bottom = prc->bottom;
      dc.fCovered = 0;
      dc.fHollowOut = 0;
      IntersectClipRect(hdc,rcClip,local_43a,local_438,local_436);
      hbrSav = SelectObject(hdc,hbrRadar);
      hpenSav = SelectObject(hdc,hpenRadar);
      dPlanRange = lpPlanets._2_2_;
      lpplMac = (PLANET *)lpPlanets + cPlanet;
      local_26 = lpPlanets._2_2_;
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      in_stack_0000f588 = (PLANET *)lpPlanets;
      while ((PLANET *)lppl < lpplMac) {
        if (((PLANET *)lppl)->iPlayer == idPlayer) {
          dRange = GetPlanetScannerRange(lppl,&dPlanRange);
          if (0 < dPlanRange) {
            fPlanetScanner = 1;
          }
          if (vpctRadarView < 100) {
            dRange = MulDiv(dRange,vpctRadarView,100);
          }
          id = lppl->id;
          rc.left = PtToScan((xOff + ((POINT *)rgptPlan + id)->x) - dRange);
          rc.top = PtToScan((yOff - *(int *)((int)&rgptPlan[0].y + id * 4)) - dRange);
          rc.right = PtToScan(xOff + ((POINT *)rgptPlan + id)->x + dRange);
          rc.bottom = PtToScan((yOff - *(int *)((int)&rgptPlan[0].y + id * 4)) + dRange);
          DrawRadarCircle(&dc,&rc);
        }
        lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
      }
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar10 = ((FLEET **)rglpfl)[i];
        iVar11 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar11,pFVar10);
        if ((pFVar10 == (FLEET *)0x0) && (iVar11 == 0)) break;
        if (pFVar10->iPlayer == idPlayer) {
          dRange = GetFleetScannerRange
                             ((FLEET *)CONCAT22(iVar11,pFVar10),&dPlanRange,(short *)0x0,
                              (short *)0x0);
          if (0 < dPlanRange) {
            fPlanetScanner = fPlanetScanner | 2;
          }
          if (0 < dRange) {
            if (vpctRadarView < 100) {
              dRange = MulDiv(dRange,vpctRadarView,100);
            }
            rc.left = PtToScan((xOff + (&((FLEET *)lpfl)->pt)->x) - dRange);
            rc.top = PtToScan((yOff - (((FLEET *)lpfl)->pt).y) - dRange);
            rc.right = PtToScan(xOff + (&((FLEET *)lpfl)->pt)->x + dRange);
            rc.bottom = PtToScan((yOff - (((FLEET *)lpfl)->pt).y) + dRange);
            DrawRadarCircle(&dc,&rc);
          }
        }
      }
      DrawRadarCircle(&dc,(RECT *)0x0);
      if (hbrRadarNear == 0) {
        if (vcScreenColors < 9) {
          uVar3 = 0x7f7f;
        }
        else {
          uVar3 = 0x6060;
        }
        hbrRadarNear = HbrGet((ulong)uVar3);
      }
      if (hpenRadarNear == 0) {
        if (vcScreenColors < 9) {
          uVar3 = 0x7f7f;
        }
        else {
          uVar3 = 0x6060;
        }
        hpenRadarNear = CreatePen(0,1,(ulong)uVar3);
      }
      SelectObject(hdc,hbrRadarNear);
      SelectObject(hdc,hpenRadarNear);
      if ((fPlanetScanner & 1U) != 0) {
        dPlanRange = lpPlanets._2_2_;
        lpplMac = (PLANET *)lpPlanets + cPlanet;
        local_26 = lpPlanets._2_2_;
        lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
        in_stack_0000f588 = (PLANET *)lpPlanets;
        while ((PLANET *)lppl < lpplMac) {
          if (((PLANET *)lppl)->iPlayer == idPlayer) {
            dRange = GetPlanetScannerRange(lppl,&dPlanRange);
            if (0 < dPlanRange) {
              dRange = dRange >> 1;
              if (vpctRadarView < 100) {
                dRange = MulDiv(dRange,vpctRadarView,100);
              }
              id = lppl->id;
              rc.left = PtToScan((xOff + ((POINT *)rgptPlan + id)->x) - dRange);
              rc.top = PtToScan((yOff - *(int *)((int)&rgptPlan[0].y + id * 4)) - dRange);
              rc.right = PtToScan(xOff + ((POINT *)rgptPlan + id)->x + dRange);
              rc.bottom = PtToScan((yOff - *(int *)((int)&rgptPlan[0].y + id * 4)) +
                                   dRange);
              DrawRadarCircle(&dc,&rc);
            }
          }
          lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
        }
      }
      if ((fPlanetScanner & 2U) != 0) {
        for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar10 = ((FLEET **)rglpfl)[i];
          iVar11 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
          lpfl = (FLEET *)CONCAT22(iVar11,pFVar10);
          if ((pFVar10 == (FLEET *)0x0) && (iVar11 == 0)) break;
          if (pFVar10->iPlayer == idPlayer) {
            dRange = GetFleetScannerRange
                               ((FLEET *)CONCAT22(iVar11,pFVar10),&dPlanRange,(short *)0x0,
                                (short *)0x0);
            if (0 < dPlanRange) {
              if (vpctRadarView < 100) {
                dPlanRange = MulDiv(dPlanRange,vpctRadarView,100);
              }
              rc.left = PtToScan((xOff + (&((FLEET *)lpfl)->pt)->x) - dPlanRange);
              rc.top = PtToScan((yOff - (((FLEET *)lpfl)->pt).y) - dPlanRange);
              rc.right = PtToScan(xOff + (&((FLEET *)lpfl)->pt)->x + dPlanRange);
              rc.bottom = PtToScan((yOff - (((FLEET *)lpfl)->pt).y) + dPlanRange);
              DrawRadarCircle(&dc,&rc);
            }
          }
        }
      }
      sVar2 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
      if (sVar2 == raMassAccel) {
        dPlanRange = (short)lpThings._2_2_;
        lpthMac__1116 = (THING *)lpThings + cThing;
        local_45a = lpThings._2_2_;
        lpth__1064 = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
        in_stack_0000f588 = (PLANET *)(THING *)lpThings;
        while ((THING *)lpth__1064 < lpthMac__1116) {
          if ((((uint)lpth__1064->idFull >> 0xd == 1) &&
              (((uint)lpth__1064->idFull >> 9 & 0xf) == idPlayer)) &&
             (uVar17 = (undefined2)((ulong)lpth__1064 >> 0x10),
             (*(uint *)((THING *)lpth__1064)->rgb >> 10 & 0xf) != 0)) {
            iVar11 = (*(uint *)((THING *)lpth__1064)->rgb >> 10 & 0xf) + 4;
            dPlanRange = iVar11 * iVar11;
            if (vpctRadarView < 100) {
              dPlanRange = MulDiv(dPlanRange,vpctRadarView,100);
            }
            rc.left = PtToScan((xOff + (&((THING *)lpth__1064)->pt)->x) - dPlanRange);
            rc.top = PtToScan((yOff - (((THING *)lpth__1064)->pt).y) - dPlanRange);
            rc.right = PtToScan(xOff + (&((THING *)lpth__1064)->pt)->x + dPlanRange);
            rc.bottom = PtToScan((yOff - (((THING *)lpth__1064)->pt).y) + dPlanRange);
            DrawRadarCircle(&dc,&rc);
          }
          lpth__1064 = (THING *)CONCAT22(lpth__1064._2_2_,(THING *)lpth__1064 + 1);
        }
      }
      DrawRadarCircle(&dc,(RECT *)0x0);
      SelectObject(hdc,hbrRadar);
      SelectObject(hdc,hpenRadar);
      if (mdScanBase != 5) {
        id = sel.fl.id;
        if (sel.grobj != grobjFleet) {
          id = -1;
        }
        if (sel.scan.grobj == grobjFleet) {
          id2 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
        }
        else {
          id2 = -1;
        }
        SelectObject(hdcMem,hbmpScanShip);
        SetTextColor(hdc,0);
        SetBkColor(hdc,0xffffff);
        for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
          pFVar10 = ((FLEET **)rglpfl)[i];
          iVar11 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
          lpfl = (FLEET *)CONCAT22(iVar11,pFVar10);
          if ((pFVar10 == (FLEET *)0x0) && (iVar11 == 0)) break;
          if (pFVar10->idPlanet == -1) {
            lVar15 = CShipsScanVis((FLEET *)CONCAT22(iVar11,pFVar10));
            if (((0 < lVar15) || (lpfl->id == id)) || (lpfl->id == id2)) {
              uVar17 = (undefined2)((ulong)lpfl >> 0x10);
              pt.x = (&((FLEET *)lpfl)->pt)->x;
              pt.y = (((FLEET *)lpfl)->pt).y;
              if ((((xMin <= pt.x) && (pt.x < xMax)) && (yMin <= pt.y)) && (pt.y < yMax)) {
                pt.x = PtToScan(xOff + pt.x);
                pt.y = PtToScan(yOff - pt.y);
                uVar17 = (undefined2)((ulong)lpfl >> 0x10);
                if (((&((FLEET *)lpfl)->pt)->x == ptSelMain) &&
                   ((((FLEET *)lpfl)->pt).y == local_456)) {
                  fSelected = 1;
                }
                else {
                  fSelected = 0;
                }
                if (fSelected == 0) {
                  GetScanFleetOrientation(lpfl,&ptO,&ptD);
                  BitBlt(hdc,pt.x - ptD.x / 2,pt.y - ptD.y / 2,ptD.x,ptD.y,hdcMem,ptO.x,ptO.y,
                         0x8800c6);
                }
                else {
                  SelectObject(hdcMem,hbmpScanner);
                  BitBlt(hdc,pt.x - 5,pt.y - 5,0xb,0xb,hdcMem,0xb,0x50,0x8800c6);
                  SelectObject(hdcMem,hbmpScanShip);
                }
              }
            }
          }
        }
        SelectObject(hdcMem,hbmpScanner);
      }
      SelectObject(hdc,hpenSav);
      SelectObject(hdc,hbrSav);
    }
    if ((grbitScan & 0x40) != 0) {
      dc.rgx = rgx;
      dc.rgy = rgy;
      dc.rgrad = rgrad;
      dc.cCur = 0;
      dc.cMax = 0xfa;
      dc.hdc = hdc;
      dc.rcClip.left = prc->left;
      dc.rcClip.top = prc->top;
      dc.rcClip.right = prc->right;
      dc.rcClip.bottom = prc->bottom;
      dc.fCovered = 0;
      dc.fHollowOut = 1;
      for (i = 0; i < 3; i = i + 1) {
        UnrealizeObject(((ushort *)rghbrPat)[i]);
      }
      SetBrushOrg(hdc,ptOrigin,local_46c);
      IntersectClipRect(hdc,rcClip,local_43a,local_438,local_436);
      hbrSav = SelectObject(hdc,rghbrPat[0]);
      HVar18 = hdc;
      HVar1 = GetStockObject(8);
      hpenSav = SelectObject(HVar18,HVar1);
      fPlanetScanner = GetROP2(hdc);
      SetBkColor(hdc,0);
      for (j = 0; j < 3; j = j + 1) {
        if (((j != 0) || ((grbitScanMines & 1) != 0)) &&
           (((j != 1 || ((grbitScanMines & 2) != 0)) &&
            ((j != 2 || ((grbitScanMines & 0xc) != 0)))))) {
          for (i = 0; i < 3; i = i + 1) {
            for (dPlanRange = 0; dPlanRange <= (int)(uint)(i == 0); dPlanRange = dPlanRange + 1) {
              SetBrushOrg(hdc,ptOrigin,local_46c);
              SelectObject(hdc,((ushort *)rghbrPat)[i]);
              if (dPlanRange == 0) {
                uVar17 = *(undefined2 *)(j * 4 + 0x26);
                uVar6 = *(undefined2 *)(j * 4 + 0x28);
              }
              else {
                uVar17 = 0xff;
                uVar6 = 0xff;
              }
              SetTextColor(hdc,CONCAT22(uVar6,uVar17));
              lpthMac__1116 = (THING *)lpThings + cThing;
              local_45a = lpThings._2_2_;
              lpth__1064 = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
              in_stack_0000f586 = (THING *)lpThings;
              in_stack_0000f588 = lpThings._2_2_;
              while ((THING *)lpth__1064 < lpthMac__1116) {
                if ((((uint)lpth__1064->idFull >> 0xd == 0) &&
                    (uVar17 = (undefined2)((ulong)lpth__1064 >> 0x10),
                    (uint)((THING *)lpth__1064)->rgb[6] == i)) &&
                   ((j != 0 || (((uint)lpth__1064->idFull >> 9 & 0xf) == idPlayer)))) {
                  if (j < 1) {
LAB_1058_21da:
                    if ((j == 2) && ((grbitScanMines & 0xc) != 0xc)) {
                      in_stack_0000f588 =
                           (PLANET *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0)
                      ;
                      if (in_stack_0000f588->rgpctMinLevel
                          [((uint)lpth__1064->idFull >> 9 & 0xf) - 6] == 0) {
                        uVar3 = grbitScanMines & 4;
                      }
                      else {
                        uVar3 = grbitScanMines & 8;
                      }
                      if (uVar3 == 0) goto LAB_1058_243c;
                    }
                    if ((uint)((THING *)lpth__1064)->rgb[7] == dPlanRange) {
                      pt.x = (&((THING *)lpth__1064)->pt)->x;
                      pt.y = (((THING *)lpth__1064)->pt).y;
                      _sqrt(SUB84((double)*(long *)((THING *)lpth__1064)->rgb,0),
                                    (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(
                                                  double)*(long *)((THING *)lpth__1064)->rgb >> 0x20
                                                  ))));
                      lVar15 = __ftol((double)CONCAT26(in_stack_0000f588,
                                                               CONCAT24(in_stack_0000f586,
                                                                        CONCAT22(unaff_SI,unaff_DI))
                                                              ));
                      dRange = (short)lVar15;
                      rc.left = PtToScan((xOff + pt.x) - dRange);
                      rc.top = PtToScan((yOff - pt.y) - dRange);
                      rc.right = PtToScan(xOff + pt.x + dRange);
                      rc.bottom = PtToScan((yOff - pt.y) + dRange);
                      DrawRadarCircle(&dc,&rc);
                      id = 0;
                      while ((id < game.cPlanMax &&
                             ((((POINT *)rgptPlan + id)->x != pt.x ||
                              (*(uint *)((int)&rgptPlan[0].y + id * 4) != pt.y))))) {
                        id = id + 1;
                      }
                      if (id == game.cPlanMax) {
                        pt.x = PtToScan(xOff + pt.x);
                        pt.y = PtToScan(yOff - pt.y);
                        dRange = PtToScan(1);
                        if (dRange < 1) {
                          dRange = 1;
                        }
                        else if (3 < dRange) {
                          dRange = 3;
                        }
                        SetRect((RECT *)&rc,pt.x - dRange,pt.y - dRange,pt.x + dRange + 1,
                                pt.y + dRange + 1);
                        SetBkColor(hdc,CONCAT22(*(undefined2 *)(j * 4 + 0x28),
                                                *(undefined2 *)(j * 4 + 0x26)));
                        ExtTextOut(hdc,rc.left,rc.top,2,(RECT *)&rc,(LPCSTR)0x0,0,(short *)0x0);
                        SetBkColor(hdc,0);
                      }
                    }
                  }
                  else if (((uint)lpth__1064->idFull >> 9 & 0xf) != idPlayer) {
                    in_stack_0000f588 =
                         (PLANET *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0);
                    in_stack_0000f586 =
                         (THING *)(uint)(in_stack_0000f588->rgpctMinLevel
                                         [((uint)lpth__1064->idFull >> 9 & 0xf) - 6] == 1);
                    if (in_stack_0000f586 != (THING *)(uint)(j == 2)) goto LAB_1058_21da;
                  }
                }
LAB_1058_243c:
                lpth__1064 = (THING *)CONCAT22(lpth__1064._2_2_,(THING *)lpth__1064 + 1);
              }
              DrawRadarCircle(&dc,(RECT *)0x0);
            }
          }
        }
      }
      if ((sel.scan.grobj == grobjThing) &&
         (lpth__1064 = (THING *)CONCAT22(lpThings._2_2_,
                                         (THING *)lpThings + sel.scan.ith),
         (uint)lpth__1064->idFull >> 0xd == 0)) {
        SetBrushOrg(hdc,ptOrigin,local_46c);
        SelectObject(hdc,((ushort *)rghbrPat)[((THING *)lpth__1064)->rgb[6]]);
        SetTextColor(hdc,0xffff00);
        uVar17 = (undefined2)((ulong)lpth__1064 >> 0x10);
        pTVar9 = (THING *)lpth__1064;
        pt.x = (&pTVar9->pt)->x;
        pt.y = (pTVar9->pt).y;
        _sqrt(SUB84((double)*(long *)pTVar9->rgb,0),
                      (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)*(long *)
                                                  pTVar9->rgb >> 0x20))));
        lVar15 = __ftol((double)CONCAT26(in_stack_0000f588,
                                                 CONCAT24(in_stack_0000f586,
                                                          CONCAT22(unaff_SI,unaff_DI))));
        dRange = (short)lVar15;
        rc.left = PtToScan((xOff + pt.x) - dRange);
        rc.top = PtToScan((yOff - pt.y) - dRange);
        rc.right = PtToScan(xOff + pt.x + dRange);
        rc.bottom = PtToScan((yOff - pt.y) + dRange);
        DrawRadarCircle(&dc,&rc);
        DrawRadarCircle(&dc,(RECT *)0x0);
      }
      SetROP2(hdc,fPlanetScanner);
      SelectObject(hdc,hpenSav);
      SelectObject(hdc,hbrSav);
    }
    if ((cThing != 0) &&
       (crBack = CONCAT22(crBack._2_2_,(undefined2)crBack),
       crFore = CONCAT22(crFore._2_2_,(undefined2)crFore), mdScanBase != 5)) {
      IntersectClipRect(hdc,rcClip,local_43a,local_438,local_436);
      hbrSav = SelectObject(hdc,hbrShip);
      hpenSav = SelectObject(hdc,hpenDkPurple);
      local_492 = (THING *)lpThings;
      hbmpTrSav = (HBITMAP)lpThings._2_2_;
      lpthMac = (THING *)lpThings + cThing;
      l = lpThings._2_2_;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      while ((THING *)lpth < lpthMac) {
        if ((((uint)lpth->idFull >> 0xd == 1) || ((uint)lpth->idFull >> 0xd == 2)) ||
           ((uint)lpth->idFull >> 0xd == 3)) {
          uVar17 = (undefined2)((ulong)lpth >> 0x10);
          pt.x = (&((THING *)lpth)->pt)->x;
          pt.y = (((THING *)lpth)->pt).y;
          LogicalToScan((POINT *)&pt);
          if ((uint)lpth->idFull >> 0xd == 2) {
            uVar17 = (undefined2)((ulong)lpth >> 0x10);
            pTVar9 = (THING *)lpth;
            if (((uint)lpth->idFull < *(uint *)(pTVar9->rgb + 6)) &&
               ((1 << ((byte)idPlayer & 0x1f) & *(uint *)(pTVar9->rgb + 4)) != 0)) {
              hbr = LpthFromId(*(short *)(pTVar9->rgb + 6));
              if (hbr != (THING *)0x0) {
                MoveTo(hdc,pt.x,pt.y);
                uVar17 = (undefined2)((ulong)hbr >> 0x10);
                pt2 = (&((THING *)hbr)->pt)->x;
                fTerra = (((THING *)hbr)->pt).y;
                LogicalToScan((POINT *)&stack0xfb7e);
                LineTo(hdc,pt2,fTerra);
                LineTo(hdc,pt2,fTerra + 1);
              }
            }
          }
          if ((uint)lpth->idFull >> 0xd == 2) {
            BitBlt(hdc,pt.x - 4,pt.y - 4,9,9,hdcMem,9,0x5c,0x8800c6);
            BitBlt(hdc,pt.x - 4,pt.y - 4,9,9,hdcMem,0,0x5c,0xee0086);
          }
          else if ((uint)lpth->idFull >> 0xd == 3) {
            hbmpTrSav = SelectObject(hdcMem,hbmpScanShip);
            CVar13 = SetTextColor(hdc,0xffff00);
            crFore = CVar13;
            CVar13 = SetBkColor(hdc,0);
            uVar17 = (undefined2)((ulong)lpth >> 0x10);
            pTVar9 = (THING *)lpth;
            crBack = CVar13;
            GetDxDyOrientation(*(int *)pTVar9->rgb - (&pTVar9->pt)->x,
                               *(int *)(pTVar9->rgb + 2) - (pTVar9->pt).y,&ptO,&ptD);
            BitBlt(hdc,pt.x - ptD.x / 2,pt.y - ptD.y / 2,ptD.x,ptD.y,hdcMem,ptO.x,ptO.y,0xee0086);
            SetTextColor(hdc,crFore);
            SetBkColor(hdc,crBack);
            SelectObject(hdcMem,hbmpTrSav);
          }
          else {
            if (iScanZoom < 1) {
              dRange = 2;
            }
            else if (iScanZoom < 3) {
              dRange = 3;
            }
            else {
              dRange = 5;
            }
            dx = dRange * 2 + 1;
            if ((*(uint *)((THING *)lpth)->rgb >> 10 & 0xf) == 0) {
              SelectObject(hdc,hpenYellow);
              MoveTo(hdc,pt.x,(pt.y - dRange) + -1);
              LineTo(hdc,(pt.x - dRange) + -1,pt.y);
              LineTo(hdc,pt.x,pt.y + dRange + 1);
              LineTo(hdc,pt.x + dRange + 1,pt.y);
              LineTo(hdc,pt.x,(pt.y - dRange) + -1);
              SelectObject(hdc,hpenDkPurple);
            }
            else {
              if (((uint)lpth->idFull >> 9 & 0xf) != idPlayer) {
                SelectObject(hdc,hbrRed);
              }
              PatBlt(hdc,pt.x - dRange,pt.y - dRange,dx,1,0xf00021);
              PatBlt(hdc,pt.x - dRange,pt.y - dRange,1,dx,0xf00021);
              PatBlt(hdc,pt.x - dRange,pt.y + dRange,dx,1,0xf00021);
              PatBlt(hdc,pt.x + dRange,pt.y - dRange,1,dx,0xf00021);
              if (((uint)lpth->idFull >> 9 & 0xf) != idPlayer) {
                SelectObject(hdc,hbrShip);
              }
            }
          }
        }
        lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
      }
      SelectObject(hdc,hbrSav);
      SelectObject(hdc,hpenSav);
    }
    if (((grbitScan & 0x80) != 0) && (mdScanBase != 5)) {
      id = sel.fl.id;
      if (sel.grobj != grobjFleet) {
        id = -1;
      }
      if (sel.scan.grobj == grobjFleet) {
        id2 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
      }
      else {
        id2 = -1;
      }
      hpenSav = SelectObject(hdc,hpenStarbase);
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar10 = ((FLEET **)rglpfl)[i];
        iVar11 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar11,pFVar10);
        if ((pFVar10 == (FLEET *)0x0) && (iVar11 == 0)) break;
        if ((((uint)pFVar10->wFlags >> 10 & 1) == 0) &&
           ((6 < (pFVar10->wFlags & 0xffU) && (1 < pFVar10->cord)))) {
          lVar15 = CShipsScanVis((FLEET *)CONCAT22(iVar11,pFVar10));
          if ((0 < lVar15) || ((lpfl->id == id || (lpfl->id == id2)))) {
            iord = 0;
            while( true ) {
              uVar17 = (undefined2)((ulong)lpfl >> 0x10);
              pFVar10 = (FLEET *)lpfl;
              if (pFVar10->cord <= iord) break;
              uVar6 = *(undefined2 *)((int)&pFVar10->lpplord + 2);
              piVar7 = (int *)(*(int *)&pFVar10->lpplord + 4 + iord * 0x12);
              pt.x = *piVar7;
              pt.y = piVar7[1];
              pt.x = PtToScan(xOff + pt.x);
              pt.y = PtToScan(yOff - pt.y);
              if (iord == 0) {
                MoveTo(hdc,pt.x,pt.y);
              }
              else {
                LineTo(hdc,pt.x,pt.y);
              }
              iord = iord + 1;
            }
          }
        }
      }
      SelectObject(hdc,hpenSav);
    }
    SelectClipRgn(hdc,hrgnHuge);
    GetClientRect(hwndScanner,(RECT *)&rc);
    ExcludeClipRect(hdc,0,rc.bottom - dySBar,rc.right,rc.bottom);
    _memset(rgWhatsHere,0,999);
    switch(iScanZoom) {
    case 0:
    case 1:
    case 2:
      SelectObject(hdc,rghfontArial8[0]);
      break;
    case 3:
      SelectObject(hdc,rghfontArial8[1]);
      break;
    case 4:
      SelectObject(hdc,rghfontArial10[1]);
      break;
    case -1:
      SelectObject(hdc,rghfontArial6[0]);
    }
    CVar13 = SetTextColor(hdc,0xffffff);
    crFore = CVar13;
    CVar13 = SetBkColor(hdc,0);
    crBack = CVar13;
    iBkPrev = SetBkMode(hdc,1);
    if ((iScanZoom < 3) || (mdScanBase != 4)) {
      j = 0;
    }
    else {
      j = 0xb;
    }
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      if ((((((POINT *)rgptPlan + i)->x < xMin) ||
           (xMax <= ((POINT *)rgptPlan + i)->x)) ||
          (*(int *)((int)&rgptPlan[0].y + i * 4) < yMin)) ||
         (yMax <= *(int *)((int)&rgptPlan[0].y + i * 4))) {
        if ((grbitScan & 0x400) != 0) {
          fDoDraw = 0;
          goto SCAN_LBailIn;
        }
      }
      else {
        fDoDraw = 1;
SCAN_LBailIn:
        pt.x = PtToScan(xOff + ((POINT *)rgptPlan + i)->x);
        pt.y = PtToScan(yOff - *(int *)((int)&rgptPlan[0].y + i * 4));
        if (fDoDraw != 0) {
          if (((ptSelMain == ((POINT *)rgptPlan + i)->x) &&
              (local_456 == *(int *)((int)&rgptPlan[0].y + i * 4))) && (mdScanBase < 3)) {
            BitBlt(hdc,pt.x - 5,pt.y - 5,0xb,0xb,hdcMem,0,0x45,0x8800c6);
            BitBlt(hdc,pt.x - 5,pt.y - 5,0xb,0xb,hdcMem,0,0x21,0xee0086);
          }
          else {
            BitBlt(hdc,pt.x - 1,pt.y - 1,3,3,hdcMem,0xb,0xf,0xcc0020);
          }
        }
        if ((((grbitScan & 0x400) != 0) && (-2 < iScanZoom)) &&
           ((xMin + -0x32 <= ((POINT *)rgptPlan + i)->x &&
            (((((POINT *)rgptPlan + i)->x < xMax + 0x32 &&
              (yMin + -0x14 <= *(int *)((int)&rgptPlan[0].y + i * 4))) &&
             (*(int *)((int)&rgptPlan[0].y + i * 4) < yMax + 0x14)))))) {
          PszGetPlanetName(i);
          if ((grbitScan & 0x2000) != 0) {
            lppl = LpplFromId(i);
            iVar11 = (int)((ulong)lppl >> 0x10);
            pPVar8 = (PLANET *)lppl;
            if (((pPVar8 != (PLANET *)0x0) || (iVar11 != 0)) && (pPVar8->iPlayer != -1)) {
              if (pPVar8->iPlayer == idPlayer) {
                uVar17 = 0xffff;
                uVar6 = 0xff;
              }
              else {
                iVar11 = pPVar8->iPlayer * 4;
                uVar17 = *(undefined2 *)(iVar11 + 0x2e);
                uVar6 = *(undefined2 *)(iVar11 + 0x30);
              }
              SetTextColor(hdc,CONCAT22(uVar6,uVar17));
            }
          }
          CtrTextOut(hdc,pt.x,pt.y + 5U + j,(char *)szWork,0);
          if ((grbitScan & 0x2000) != 0) {
            SetTextColor(hdc,0xffffff);
          }
        }
      }
    }
    SetBkMode(hdc,iBkPrev);
    SetBkColor(hdc,crBack);
    SetTextColor(hdc,crFore);
    if ((iScanZoom < 3) || (mdScanBase != 4)) {
      j = 0;
    }
    else {
      j = 0xb;
    }
    if (((sel.grobj == grobjNone) || (sel.pt.x != sel.scan.pt.x)) ||
       (sel.pt.y != sel.scan.pt.y)) {
      if (sel.scan.grobj != grobjNone) {
        pt.x = sel.scan.pt.x;
        pt.y = sel.scan.pt.y;
        LogicalToScan((POINT *)&pt);
        BitBlt(hdc,pt.x - 3,pt.y + 7U + j,7,8,hdcMem,0x16,0x50,0x8800c6);
        BitBlt(hdc,pt.x - 3,pt.y + 7U + j,7,8,hdcMem,0x16,0x31,0xee0086);
      }
    }
    else {
      pt.x = sel.pt.x;
      pt.y = sel.pt.y;
      LogicalToScan((POINT *)&pt);
      BitBlt(hdc,pt.x - 5,pt.y + 0xbU + j,0xb,0xc,hdcMem,0,0x50,0x8800c6);
      BitBlt(hdc,pt.x - 5,pt.y + 0xbU + j,0xb,0xc,hdcMem,0,0x39,0xee0086);
    }
    if ((cPlanet != 0) && (mdScanBase != 5)) {
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      for (i = 0; i < cPlanet; i = i + 1) {
        id = lppl->id;
        uVar17 = (undefined2)((ulong)lppl >> 0x10);
        pPVar8 = (PLANET *)lppl;
        if ((((uint)pPVar8->wFlags >> 9 & 1) == 0) || (pPVar8->iPlayer == -1)) {
          fStarbase = 0;
        }
        else {
          fStarbase = 1;
        }
        if (fStarbase == 0) {
          fMA = 0;
          fStargate = 0;
        }
        else {
          iVar11 = pPVar8->iPlayer * 4;
          if (*(int *)(*(int *)(iVar11 + 0x14c) + (*(uint *)&pPVar8->field11_0x2c & 0xf) * 0x93) ==
              0x20) {
            fStarbase = 2;
          }
          sVar2 = IWarpMAFromLppl(lppl,(short *)0x0);
          fMA = (short)(0 < sVar2);
          sVar2 = IStargateFromLppl(lppl);
          fStargate = (short)(sVar2 != -1);
        }
        if ((((xMin <= ((POINT *)rgptPlan + id)->x) &&
             (((POINT *)rgptPlan + id)->x < xMax)) &&
            (yMin <= *(int *)((int)&rgptPlan[0].y + id * 4))) &&
           (*(int *)((int)&rgptPlan[0].y + id * 4) < yMax)) {
          pt.x = PtToScan(xOff + ((POINT *)rgptPlan + id)->x);
          pt.y = PtToScan(yOff - *(int *)((int)&rgptPlan[0].y + id * 4));
          pPVar8 = (PLANET *)lppl;
          uVar17 = (undefined2)((ulong)lppl >> 0x10);
          if (mdScanBase == 3) {
            fTerra = 0;
            if (2 < (pPVar8->wFlags & 0xffU)) {
              sVar2 = PctPlanetDesirability(lppl,idPlayer);
              hbr = (THING *)CONCAT22(sVar2,(THING *)hbr);
              if (sVar2 < 0) {
LAB_1058_343d:
                sVar2 = PctPlanetOptValue(lppl,idPlayer);
                hbr = (THING *)CONCAT22(sVar2,(THING *)hbr);
                if (-1 < sVar2) {
                  sVar2 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
                  if (sVar2 != raTerra) {
                    fTerra = 1;
                  }
                }
              }
              else {
                sVar2 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
                if (sVar2 == raTerra) goto LAB_1058_343d;
              }
              HVar4 = hbrRadar;
              if ((-1 < (long)hbr) && (HVar4 = hbrDkYellow, fTerra == 0)) {
                HVar4 = hbrGreen;
              }
              hbrSav = SelectObject(hdc,HVar4);
              HVar5 = hpenRadar;
              if ((-1 < (long)hbr) && (HVar5 = hpenDkYellow, fTerra == 0)) {
                HVar5 = hpenDkGreen;
              }
              hpenSav = SelectObject(hdc,HVar5);
              if ((long)hbr < 0) {
                pt2 = -hbr._2_2_ / 5;
              }
              else {
                pt2 = hbr._2_2_ / 0xb;
              }
              pt2 = pt2 + 2;
              if (10 < pt2) {
                pt2 = 10;
              }
              Ellipse(hdc,pt.x - pt2,pt.y - pt2,pt.x + pt2 + 1,pt.y + pt2 + 1);
              iVar11 = pt2 + -2;
              if (pt2 + -2 < 3) {
                iVar11 = pt2 + -1;
              }
              pt2 = iVar11;
              if (pt2 < 1) {
                pt2 = 1;
              }
              HVar4 = hbrEnemy;
              if ((-1 < (long)hbr) && (HVar4 = hbrYellow, fTerra == 0)) {
                HVar4 = hbrShip;
              }
              SelectObject(hdc,HVar4);
              HVar5 = hpenEnemy;
              if ((-1 < (long)hbr) && (HVar5 = hpenYellow, fTerra == 0)) {
                HVar5 = hpenShip;
              }
              SelectObject(hdc,HVar5);
              Ellipse(hdc,pt.x - pt2,pt.y - pt2,pt.x + pt2 + 1,pt.y + pt2 + 1);
              if (((PLANET *)lppl)->iPlayer != -1) {
                rc.left = pt.x - 1;
                rc.right = pt.x + 8;
                rc.top = pt.y - 0x14;
                rc.bottom = pt.y - 0xc;
                pRVar16 = &rc;
                uVar17 = unaff_SS;
                HVar18 = hdc;
                HVar1 = GetStockObject(4);
                FillRect(HVar18,(RECT *)CONCAT22(uVar17,pRVar16),HVar1);
                uVar17 = (undefined2)((ulong)lppl >> 0x10);
                pPVar8 = (PLANET *)lppl;
                if (pPVar8->iPlayer == idPlayer) {
                  hbr = (THING *)CONCAT22(hbr._2_2_,hbrBBlue);
                }
                else {
                  iVar11 = idPlayer * 0xc0 + 0x5a12;
                  lpth = (THING *)CONCAT22(iVar11,(THING *)lpth);
                  if (*(char *)(iVar11 + pPVar8->iPlayer) == '\x01') {
                    hbr = (THING *)CONCAT22(hbr._2_2_,hbrStarbase);
                  }
                  else {
                    iVar11 = idPlayer * 0xc0 + 0x5a12;
                    lpth = (THING *)CONCAT22(iVar11,(THING *)lpth);
                    if (*(char *)(iVar11 + pPVar8->iPlayer) == '\0') {
                      hbr = (THING *)CONCAT22(hbr._2_2_,hbrRadar);
                    }
                    else {
                      hbr = (THING *)CONCAT22(hbr._2_2_,hbrEnemy);
                    }
                  }
                }
                SelectObject(hdc,(HGDIOBJ)(THING *)hbr);
                PatBlt(hdc,pt.x,pt.y - 0x13,1,0x15,0xf00021);
                PatBlt(hdc,pt.x,pt.y - 0x13,7,6,0xf00021);
              }
              SelectObject(hdc,hpenSav);
              SelectObject(hdc,hbrSav);
            }
          }
          else {
            if ((mdScanBase == 1) || (mdScanBase == 2)) {
              pTVar9 = (THING *)(uint)(mdScanBase == 2);
              hbr = (THING *)CONCAT22(hbr._2_2_,pTVar9);
              fTerra = (short)(iScanZoom < 0);
              if ((3 < (pPVar8->wFlags & 0xffU)) ||
                 ((pTVar9 != (THING *)0x0 && (2 < (pPVar8->wFlags & 0xffU))))) {
                hbr = (THING *)CONCAT22(pt.x - *(int *)(fTerra * 10 + 0x58c),pTVar9);
                lpth = (THING *)CONCAT22(pt.y - *(int *)(fTerra * 10 + 0x58e),(THING *)lpth);
                hbrSav = SelectObject(hdc,hbrButtonFace);
                PatBlt(hdc,hbr._2_2_ + -2,lpth._2_2_,*(short *)(fTerra * 10 + 0x590),1,0xf00021);
                PatBlt(hdc,hbr._2_2_ + -2,(lpth._2_2_ - *(int *)(fTerra * 10 + 0x590)) + 1,1,
                       *(short *)(fTerra * 10 + 0x590),0xf00021);
                for (pt2 = 0; pt2 < 3; pt2 = pt2 + 1) {
                  if ((THING *)hbr == (THING *)0x0) {
                    l = *(PLANET **)(((PLANET *)lppl)->rgwtMin + pt2);
                    pTVar9 = (THING *)*(uint *)((int)(((PLANET *)lppl)->rgwtMin + pt2) + 2);
                    lpth = (THING *)CONCAT22(lpth._2_2_,pTVar9);
                    uVar3 = cMinGrafMax / 0x28;
                    pPVar14 = (PLANET *)
                              __aFldiv(CONCAT22(pTVar9->rgb +
                                                        (uint)CARRY2(uVar3,(uint)l) +
                                                        ((int)uVar3 >> 0xf) + -6,uVar3 + (int)l),
                                               (long)(cMinGrafMax / 0x14));
                    l = (PLANET *)pPVar14;
                    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)((ulong)pPVar14 >> 0x10));
                    if (0x14 < (long)pPVar14) {
                      l = (PLANET *)&hbrButtonHilite;
                      lpth = (THING *)((ulong)lpth._2_2_ << 0x10);
                    }
                  }
                  else {
                    l = (PLANET *)(((PLANET *)lppl)->rgMinConc[pt2] / 5);
                    if ((PLANET *)&hbrButtonHilite < l) {
                      l = (PLANET *)&hbrButtonHilite;
                    }
                    lpth = (THING *)((ulong)lpth._2_2_ << 0x10);
                  }
                  if (fTerra != 0) {
                    pPVar14 = (PLANET *)__aFldiv((long)CONCAT22((THING *)lpth,l),2);
                    l = (PLANET *)pPVar14;
                    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)((ulong)pPVar14 >> 0x10));
                  }
                  if ((-1 < (int)(THING *)lpth) &&
                     ((0 < (int)(THING *)lpth || (l != (PLANET *)0x0)))) {
                    SelectObject(hdc,((ushort *)rghbrMineral)[pt2]);
                    PatBlt(hdc,hbr._2_2_,lpth._2_2_ - (int)l,*(short *)(fTerra * 10 + 0x592),
                           (short)l,0xf00021);
                  }
                  hbr = (THING *)CONCAT22(hbr._2_2_ + *(int *)(fTerra * 10 + 0x594),(THING *)hbr);
                }
                SelectObject(hdc,hbrSav);
              }
            }
            else if (mdScanBase == 4) {
              pt2 = 0;
              if (((pPVar8->wFlags & 0xffU) < 3) || (pPVar8->iPlayer == -1)) {
                if (pPVar8->iPlayer == -1) goto SCAN_LNormalScannerMode;
              }
              else {
                if (pPVar8->iPlayer == idPlayer) {
                  pTVar9 = (THING *)*(int *)((int)pPVar8->rgwtMin + 0xe);
                  lpth = (THING *)CONCAT22((int)pPVar8->rgwtMin[3],(THING *)lpth);
                }
                else {
                  lVar15 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),(ushort)in_stack_0000f586);
                  pTVar9 = (THING *)((ulong)lVar15 >> 0x10);
                  lpth = (THING *)CONCAT22((int)lVar15,(THING *)lpth);
                }
                for (hbr._2_2_ = 0; hbr._2_2_ < 0x13; hbr._2_2_ = hbr._2_2_ + 1) {
                  iVar11 = (int)*(uint *)(hbr._2_2_ * 2) >> 0xf;
                  if (((int)pTVar9 <= iVar11) &&
                     (((int)pTVar9 < iVar11 || (lpth._2_2_ < *(uint *)(hbr._2_2_ * 2))))) break;
                }
                hbr = (THING *)CONCAT22(hbr._2_2_ + 2,pTVar9);
                uVar17 = (undefined2)((ulong)lppl >> 0x10);
                if (((PLANET *)lppl)->iPlayer == idPlayer) {
                  fTerra = 0;
                }
                else {
                  pTVar9 = (THING *)((int)rgplr[0].rgmdRelation + idPlayer * 0xc0);
                  lpth = (THING *)CONCAT22(lpth._2_2_,pTVar9);
                  if (pTVar9->rgb[((PLANET *)lppl)->iPlayer + -6] == 1) {
                    fTerra = 1;
                  }
                  else {
                    fTerra = 3;
                  }
                }
                HVar4 = hbrShip;
                if ((fTerra != 0) && (HVar4 = hbrEnemy, fTerra != 3)) {
                  HVar4 = hbrYellow;
                }
                hbrSav = SelectObject(hdc,HVar4);
                HVar5 = hpenDkGreen;
                if ((fTerra != 0) && (HVar5 = hpenEnemy, fTerra != 3)) {
                  HVar5 = hpenDkYellow;
                }
                hpenSav = SelectObject(hdc,HVar5);
                if (iScanZoom < 3) {
                  hbr = (THING *)CONCAT22(hbr._2_2_ + 1 >> 1,(THING *)hbr);
                }
                Ellipse(hdc,pt.x - hbr._2_2_,pt.y - hbr._2_2_,pt.x + hbr._2_2_ + 1,
                        pt.y + hbr._2_2_ + 1);
                SelectObject(hdc,hpenSav);
                SelectObject(hdc,hbrSav);
              }
              goto LAB_1058_3257;
            }
SCAN_LNormalScannerMode:
            uVar17 = (undefined2)((ulong)lppl >> 0x10);
            pPVar8 = (PLANET *)lppl;
            if (pPVar8->iPlayer == -1) {
              if ((((POINT *)rgptPlan + id)->x != ptSelMain) ||
                 (*(int *)((int)&rgptPlan[0].y + id * 4) != local_456)) {
                BitBlt(hdc,pt.x - 1,pt.y - 1,3,3,hdcMem,0xb,0x12,0xcc0020);
              }
            }
            else if ((((POINT *)rgptPlan + id)->x == ptSelMain) &&
                    (*(int *)((int)&rgptPlan[0].y + id * 4) == local_456)) {
              if (pPVar8->iPlayer == idPlayer) {
                yBmp = 0;
              }
              else {
                fTerra = idPlayer * 0xc0 + 0x5a12;
                if (*(char *)(fTerra + pPVar8->iPlayer) == '\x01') {
                  yBmp = 0x16;
                }
                else {
                  yBmp = 0xb;
                }
              }
              BitBlt(hdc,pt.x - 5,pt.y - 5,0xb,0xb,hdcMem,0,0x45,0x8800c6);
              BitBlt(hdc,pt.x - 5,pt.y - 5,0xb,0xb,hdcMem,0,yBmp,0xee0086);
              if (fStarbase != 0) {
                HVar4 = hbrBlue;
                if (fStarbase != 2) {
                  HVar4 = hbrYellow;
                }
                hbrSav = SelectObject(hdc,HVar4);
                PatBlt(hdc,pt.x + 4,pt.y - 6,5,5,0x42);
                PatBlt(hdc,pt.x + 5,pt.y - 6,3,5,0xf00021);
                PatBlt(hdc,pt.x + 4,pt.y - 5,5,3,0xf00021);
                SelectObject(hdc,hbrSav);
              }
              if (fStargate != 0) {
                hbrSav = SelectObject(hdc,hbrGreen);
                PatBlt(hdc,pt.x - 7,pt.y - 6,5,5,0x42);
                PatBlt(hdc,pt.x - 6,pt.y - 6,3,5,0xf00021);
                PatBlt(hdc,pt.x - 7,pt.y - 5,5,3,0xf00021);
                SelectObject(hdc,hbrSav);
              }
              if (fMA != 0) {
                hbrSav = SelectObject(hdc,hbrPurple);
                PatBlt(hdc,pt.x - 2,pt.y - 9,5,5,0x42);
                PatBlt(hdc,pt.x - 1,pt.y - 9,3,5,0xf00021);
                PatBlt(hdc,pt.x - 2,pt.y - 8,5,3,0xf00021);
                SelectObject(hdc,hbrSav);
              }
            }
            else {
              if (pPVar8->iPlayer == idPlayer) {
                yBmp = 0;
              }
              else {
                fTerra = idPlayer * 0xc0 + 0x5a12;
                if (*(char *)(fTerra + pPVar8->iPlayer) == '\x01') {
                  yBmp = 10;
                }
                else {
                  yBmp = 5;
                }
              }
              BitBlt(hdc,pt.x - 2,pt.y - 2,5,5,hdcMem,0xb,yBmp,0xcc0020);
              if (fStarbase != 0) {
                HVar4 = hbrBlue;
                if (fStarbase != 2) {
                  HVar4 = hbrYellow;
                }
                hbrSav = SelectObject(hdc,HVar4);
                PatBlt(hdc,pt.x + 3,pt.y - 4,3,3,0xf00021);
                SelectObject(hdc,hbrSav);
              }
              if (fStargate != 0) {
                hbrSav = SelectObject(hdc,hbrGreen);
                PatBlt(hdc,pt.x - 5,pt.y - 4,3,3,0x42);
                PatBlt(hdc,pt.x - 4,pt.y - 4,1,3,0xf00021);
                PatBlt(hdc,pt.x - 5,pt.y - 3,3,1,0xf00021);
                SelectObject(hdc,hbrSav);
              }
              if (fMA != 0) {
                hbrSav = SelectObject(hdc,hbrPurple);
                PatBlt(hdc,pt.x - 1,pt.y - 6,3,3,0x42);
                PatBlt(hdc,pt.x,pt.y - 6,1,3,0xf00021);
                PatBlt(hdc,pt.x - 1,pt.y - 5,3,1,0xf00021);
                SelectObject(hdc,hbrSav);
              }
            }
          }
        }
LAB_1058_3257:
        lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
      }
    }
    if ((cFleet != 0) && (mdScanBase != 5)) {
                    /* WARNING: Load size is inaccurate */
      lpflT = (FLEET *)CONCAT22(*(undefined2 *)((int)(FLEET **)rglpfl + 2),*rglpfl);
      hbrSav = SelectObject(hdc,hbrShip);
      id = sel.fl.id;
      if (sel.grobj != grobjFleet) {
        id = -1;
      }
      if (sel.scan.grobj == grobjFleet) {
        id2 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
      }
      else {
        id2 = -1;
      }
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar10 = ((FLEET **)rglpfl)[i];
        iVar11 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpflT = (FLEET *)CONCAT22(iVar11,pFVar10);
        if ((pFVar10 == (FLEET *)0x0) && (iVar11 == 0)) break;
        lVar15 = CShipsScanVis((FLEET *)CONCAT22(iVar11,pFVar10));
        if ((0 < lVar15) || ((lpflT->id == id || (lpflT->id == id2)))) {
          uVar17 = (undefined2)((ulong)lpflT >> 0x10);
          pFVar10 = (FLEET *)lpflT;
          idP = pFVar10->idPlanet;
          if (idP == -1) {
            pt.x = (&pFVar10->pt)->x;
            pt.y = (pFVar10->pt).y;
          }
          else {
            pt.x = ((POINT *)rgptPlan + idP)->x;
            pt.y = *(uint *)((int)&rgptPlan[0].y + idP * 4);
          }
          if ((((xMin <= pt.x) && (pt.x < xMax)) && (yMin <= pt.y)) && (pt.y < yMax)) {
            pt.x = PtToScan(xOff + pt.x);
            pt.y = PtToScan(yOff - pt.y);
            uVar17 = (undefined2)((ulong)lpflT >> 0x10);
            pFVar10 = (FLEET *)lpflT;
            bVar12 = pFVar10->iPlayer != idPlayer;
            yBmp = (short)bVar12;
            if (((&pFVar10->pt)->x == ptSelMain) && ((pFVar10->pt).y == local_456)) {
              fSelected = 1;
            }
            else {
              fSelected = 0;
            }
            if (idP == -1) {
              if (fSelected == 0) {
                SelectObject(hdcMem,hbmpScanShip);
                if (yBmp == 0) {
                  pt2 = 0;
                  fTerra = 0xff;
                }
                else {
                  iVar11 = idPlayer * 0xc0 + 0x5a12;
                  hbr = (THING *)CONCAT22(iVar11,(THING *)hbr);
                  if (*(char *)(iVar11 + ((FLEET *)lpflT)->iPlayer) == '\x01') {
                    pt2 = -1;
                    fTerra = 0;
                  }
                  else {
                    pt2 = 0xff;
                    fTerra = 0;
                  }
                }
                SetTextColor(hdc,CONCAT22(fTerra,pt2));
                SetBkColor(hdc,0);
                GetScanFleetOrientation(lpflT,&ptO,&ptD);
                BitBlt(hdc,pt.x - ptD.x / 2,pt.y - ptD.y / 2,ptD.x,ptD.y,hdcMem,ptO.x,ptO.y,0xee0086
                      );
                if (((grbitScan & 0x1000) != 0) &&
                   (((uint)((FLEET *)lpflT)->wFlags >> 0xb & 1) == 0)) {
                  DrawScanFleetCount(lpflT,pt.x,(pt.y - ptD.y / 2) + -2,hdc,hdcMem);
                }
                SelectObject(hdcMem,hbmpScanner);
              }
              else {
                BitBlt(hdc,pt.x - 5,pt.y - 5,0xb,0xb,hdcMem,0xb,yBmp * 0xb + 0x24,0xee0086);
                if (((grbitScan & 0x1000) != 0) &&
                   (((uint)((FLEET *)lpflT)->wFlags >> 0xb & 1) == 0)) {
                  DrawScanFleetCount(lpflT,pt.x,pt.y - 7,hdc,hdcMem);
                }
              }
            }
            else if (((rgWhatsHere[idP] != '\x03') && ((int)rgWhatsHere[idP] != yBmp + 1U)) &&
                    (mdScanBase < 3)) {
              rgWhatsHere[idP] = rgWhatsHere[idP] + bVar12 + '\x01';
              yBmp = rgWhatsHere[idP] + -1;
              if (fSelected == 0) {
                BitBlt(hdc,pt.x - 5,pt.y - 5,0xb,0xb,hdcMem,0x10,0x45,0x8800c6);
                BitBlt(hdc,pt.x - 5,pt.y - 5,0xb,0xb,hdcMem,0x10,yBmp * 0xb,0xee0086);
              }
              else {
                BitBlt(hdc,pt.x - 9,pt.y - 9,0x13,0x13,hdcMem,0x1d,0x45,0x8800c6);
                BitBlt(hdc,pt.x - 9,pt.y - 9,0x13,0x13,hdcMem,0x1d,yBmp * 0x13,0xee0086);
              }
              if (((grbitScan & 0x1000) != 0) &&
                 (((uint)((FLEET *)lpflT)->wFlags >> 0xb & 1) == 0)) {
                if (fSelected == 0) {
                  iVar11 = 5;
                }
                else {
                  iVar11 = 9;
                }
                DrawScanFleetCount(lpflT,pt.x,(pt.y - iVar11) + -2,hdc,hdcMem);
              }
            }
          }
        }
      }
      SelectObject(hdc,hbrSav);
    }
    ExpandRc(prc,-dExpand,-dExpand);
    prc->bottom = prc->bottom + -0xe;
    CVar13 = SetTextColor(hdc,0);
    crFore = CVar13;
    CVar13 = GetBkColor(hdc);
    if ((((sel.grobj == grobjFleet) || (sel.scan.grobj == grobjFleet)) ||
        (sel.scan.grobj == grobjThing)) ||
       ((sel.grobj == grobjPlanet && (((uint)sel.pl.wFlags >> 9 & 1) != 0)))) {
      crBack = CVar13;
      IntersectClipRect(hdc,prc->left,prc->top,prc->right,prc->bottom);
      fOrdersVis = 0;
      DrawShipScanPath(hdc,1);
      SelectClipRgn(hdc,hrgnHuge);
      CVar13 = crBack;
    }
    crBack = CVar13;
    SetBkColor(hdc,CVar13);
    SetTextColor(hdc,crFore);
    SelectObject(hdcMem,hbmpSav);
    DeleteDC(hdcMem);
    if (hdcScreen != 0) {
      SetWindowOrg(hdc,0,0);
      BitBlt(hdcScreen,prc->left,prc->top,prc->right - prc->left,prc->bottom - prc->top,hdc,
             prc->left & 7,prc->top & 7,0xcc0020);
      SelectObject(hdc,hbmpXSav);
      DeleteObject(hbmpScreen);
      DeleteDC(hdc);
    }
  }
  return 0;
}



// ======================================================================
// Function: DrawScanFleetCount
// Address: 1058:47d2
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1058496f) */
/* WARNING: Removing unreachable block (ram,0x105848c3) */
/* WARNING: Removing unreachable block (ram,0x10584832) */
/* WARNING: Removing unreachable block (ram,0x105848e8) */
/* WARNING: Removing unreachable block (ram,0x10584a5c) */

void DrawScanFleetCount(FLEET *lpfl,short x,short y,HDC hdc,HDC hdcMem)

{
  int iVar1;
  bool bVar2;
  int iVar3;
  HGDIOBJ HVar4;
  long lVar5;
  long lVar6;
  int l;
  HBITMAP hbmpSav;
  short iPlr;
  FLEET *lpflWalk;
  int cr;
  int local_c;
  short f999;
  
  lpflWalk = lpfl;
  if ((grbitScan & 0x2000) == 0) {
    iPlr = -2;
  }
  else {
    iPlr = -1;
  }
  lVar6 = 0;
  bVar2 = false;
  do {
    lVar5 = CShipsScanVis(lpflWalk);
    if (((0 < lVar5) && (lVar6 = lVar5 + lVar6, ((FLEET *)lpflWalk)->iPlayer != iPlr)) &&
       (iPlr != -2)) {
      if (iPlr == -1) {
        iPlr = ((FLEET *)lpflWalk)->iPlayer;
      }
      else {
        iPlr = -2;
      }
    }
    ((FLEET *)lpflWalk)->wFlags = ((FLEET *)lpflWalk)->wFlags & 0xf7ffU | 0x800;
                    /* WARNING: Load size is inaccurate */
    lpflWalk = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflWalk)->lpflNext + 2),
                                 ((FLEET *)lpflWalk)->lpflNext);
  } while (lpfl != lpflWalk);
  if (lVar6 < 1000) {
    if (lVar6 < 1) {
      return;
    }
  }
  else {
    lVar6 = 999;
  }
  l = (int)lVar6;
  HVar4 = SelectObject(hdcMem,hbmpNumbers);
  SetBkColor(hdc,0);
  SetTextColor(hdc,0xffffff);
  if ((iPlr < 0) || (iPlr == idPlayer)) {
    cr = -1;
    local_c = 0xff;
  }
  else {
    cr = *(int *)(iPlr * 4 + 0x2e);
    local_c = *(int *)(iPlr * 4 + 0x30);
  }
  iVar1 = y + -7;
  iVar3 = x + -1;
  if (99 < lVar6) {
    bVar2 = true;
    if ((cr != -1) || (local_c != 0xff)) {
      BitBlt(hdc,x + -6,iVar1,4,7,hdcMem,l / 100 << 2,0,0x220326);
      SetTextColor(hdc,CONCAT22(local_c,cr));
    }
    BitBlt(hdc,x + -6,iVar1,4,7,hdcMem,l / 100 << 2,0,0xee0086);
    if ((cr != -1) || (local_c != 0xff)) {
      SetTextColor(hdc,0xffffff);
    }
    lVar6 = __aFlrem(lVar6,100);
    iVar3 = x + 2;
  }
  x = iVar3;
  l = (int)lVar6;
  if ((9 < lVar6) || (bVar2)) {
    if ((cr != -1) || (local_c != 0xff)) {
      BitBlt(hdc,x + -3,iVar1,4,7,hdcMem,l / 10 << 2,0,0x220326);
      SetTextColor(hdc,CONCAT22(local_c,cr));
    }
    BitBlt(hdc,x + -3,iVar1,4,7,hdcMem,l / 10 << 2,0,0xee0086);
    if ((cr != -1) || (local_c != 0xff)) {
      SetTextColor(hdc,0xffffff);
    }
    x = x + 2;
    lVar6 = __aFlrem(lVar6,10);
  }
  l = (int)lVar6;
  if ((cr != -1) || (local_c != 0xff)) {
    BitBlt(hdc,x,iVar1,4,7,hdcMem,l << 2,0,0x220326);
    SetTextColor(hdc,CONCAT22(local_c,cr));
  }
  BitBlt(hdc,x,iVar1,4,7,hdcMem,l << 2,0,0xee0086);
  if ((cr != -1) || (local_c != 0xff)) {
    SetTextColor(hdc,0xffffff);
  }
  SelectObject(hdcMem,HVar4);
  return;
}



// ======================================================================
// Function: CShipsScanVis
// Address: 1058:4bf4
// Segment: MEMORY_SCAN
// ======================================================================


long CShipsScanVis(FLEET *lpfl)

{
  uint uVar1;
  int iVar2;
  bool bVar3;
  HULDEF *pHVar4;
  ushort grbitSh;
  short k;
  uint csh;
  int local_8;
  short j;
  
  csh = 0;
  local_8 = 0;
  if ((grbitScan & 0x100) != 0) {
    if ((((FLEET *)lpfl)->iPlayer == idPlayer) &&
       ((((((FLEET *)lpfl)->cord != 1 ||
          ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 6)) ||
         ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 5)) ||
        (((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 3 ||
         ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 7)))))) {
      csh = 0;
      local_8 = 0;
      goto LAB_1058_4e75;
    }
    if ((((FLEET *)lpfl)->iPlayer != idPlayer) && ((((FLEET *)lpfl)->wFlags & 0xfU) == 0)) {
      csh = 0;
      local_8 = 0;
      goto LAB_1058_4e75;
    }
  }
  if (((grbitScan & 0x200) == 0) || (((FLEET *)lpfl)->iPlayer != idPlayer)) {
    if (((grbitScan & 0x800) == 0) || (((FLEET *)lpfl)->iPlayer == idPlayer)) {
      for (j = 0; j < 0x10; j = j + 1) {
        uVar1 = ((FLEET *)lpfl)->rgcsh[j];
        bVar3 = CARRY2(csh,uVar1);
        csh = csh + uVar1;
        local_8 = local_8 + ((int)uVar1 >> 0xf) + (uint)bVar3;
      }
    }
    else {
      j = 0;
      for (grbitSh = grbitScanEShip; grbitSh != 0; grbitSh = grbitSh >> 1) {
        if ((grbitSh & 1) != 0) {
          for (k = 0; k < 0x10; k = k + 1) {
            if ((0 < ((FLEET *)lpfl)->rgcsh[k]) &&
               (iVar2 = ((FLEET *)lpfl)->iPlayer * 4,
               pHVar4 = LphuldefFromId(*(HullDef *)(*(int *)(iVar2 + 0xfe) + k * 0x93)),
               ((uint)((HULDEF *)pHVar4)->wFlags >> 10 & 0xf) == j)) {
              uVar1 = ((FLEET *)lpfl)->rgcsh[k];
              bVar3 = CARRY2(csh,uVar1);
              csh = csh + uVar1;
              local_8 = local_8 + ((int)uVar1 >> 0xf) + (uint)bVar3;
            }
          }
        }
        j = j + 1;
      }
    }
  }
  else {
    j = 0;
    for (grbitSh = grbitScanShip; grbitSh != 0; grbitSh = grbitSh >> 1) {
      if (((grbitSh & 1) != 0) && (0 < ((FLEET *)lpfl)->rgcsh[j])) {
        uVar1 = ((FLEET *)lpfl)->rgcsh[j];
        bVar3 = CARRY2(csh,uVar1);
        csh = csh + uVar1;
        local_8 = local_8 + ((int)uVar1 >> 0xf) + (uint)bVar3;
      }
      j = j + 1;
    }
  }
LAB_1058_4e75:
  return CONCAT22(local_8,csh);
}



// ======================================================================
// Function: DrawRadarCircle
// Address: 1058:4e7c
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10584f8a) */
/* WARNING: Removing unreachable block (ram,0x10584f71) */
/* WARNING: Removing unreachable block (ram,0x10584fd1) */

void DrawRadarCircle(DRAWCIR *pdc,RECT *prc)

{
  BOOL BVar1;
  int iVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  bool bVar3;
  bool bVar4;
  ulong uVar5;
  ulong uVar6;
  RECT rc;
  short x;
  long l;
  short rad;
  short x2;
  short dx;
  short i;
  short iFree;
  short y;
  short dy;
  undefined4 crSav;
  ulong r2;
  short y2;
  
  if ((prc == (RECT *)0x0) ||
     ((pdc->fCovered == 0 &&
      (BVar1 = IntersectRect((RECT *)&rc,(RECT *)prc,(RECT *)&pdc->rcClip), BVar1 != 0)))) {
    if (prc == (RECT *)0x0) {
      if (pdc->fHollowOut != 0) {
        SetROP2(pdc->hdc,9);
        crSav = SetBkColor(pdc->hdc,0xffffff);
        l = 1;
      }
      while( true ) {
        for (i = 0; i < pdc->cCur; i = i + 1) {
          if (0 < pdc->rgrad[i]) {
            x = pdc->rgx[i];
            y = pdc->rgy[i];
            rad = pdc->rgrad[i];
            Ellipse(pdc->hdc,x - rad,y - rad,x + rad + 1,y + rad + 1);
          }
        }
        if (((pdc->fHollowOut == 0) || ((int)l != 1)) || (l._2_2_ != 0)) break;
        l = 0;
        SetBkColor(pdc->hdc,crSav);
        SetROP2(pdc->hdc,0xf);
      }
      pdc->fCovered = 0;
      pdc->cCur = 0;
    }
    else {
      iVar2 = prc->right - prc->left;
      rad = iVar2 >> 1;
      x = prc->left + rad;
      y = prc->top + rad;
      iVar2 = iVar2 >> 0xf;
      r2 = __aFulmul(CONCAT22(iVar2,rad),CONCAT22(iVar2,rad));
      for (i = 0; i < 4; i = i + 1) {
        if (i < 2) {
          x2 = (&pdc->rcClip)->left;
        }
        else {
          x2 = (pdc->rcClip).right;
        }
        if ((i & 1U) == 0) {
          y2 = (pdc->rcClip).bottom;
        }
        else {
          y2 = (pdc->rcClip).top;
        }
        dx = x2 - x;
        dy = y2 - y;
        if (((long)r2 < (long)dx) || ((long)r2 < (long)dy)) break;
        uVar5 = __aFulmul((long)dy,(long)dy);
        uVar6 = __aFulmul((long)dx,(long)dx);
        if ((long)r2 < (long)(uVar6 + uVar5)) break;
      }
      if (i == 4) {
        pdc->fCovered = 1;
        pdc->cCur = 0;
      }
      else if (pdc->cCur != pdc->cMax) {
        iFree = pdc->cCur;
        i = 0;
        do {
          if (pdc->cCur <= i) {
            pdc->rgx[iFree] = x;
            pdc->rgy[iFree] = y;
            pdc->rgrad[iFree] = rad;
            if (iFree != pdc->cCur) {
              return;
            }
            pdc->cCur = pdc->cCur + 1;
            return;
          }
          if (pdc->rgrad[i] < 1) {
            iFree = i;
          }
          else {
            x2 = pdc->rgx[i];
            y2 = pdc->rgy[i];
            dx = x - x2;
            dy = y - y2;
            uVar5 = __aFulmul((long)dy,(long)dy);
            uVar6 = __aFulmul((long)dx,(long)dx);
            l = uVar6 + uVar5;
            if (pdc->rgrad[i] < rad) {
              _sqrt(SUB84((double)l,0),
                            (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)l >>
                                                                              0x20))));
              bVar3 = CARRY2((uint)pdc->rgrad,i * 2);
              bVar4 = pdc->rgrad + i == (short *)0x0;
              __aFfcompp();
              if (bVar3 || bVar4) {
                pdc->rgrad[i] = 0;
                iFree = i;
              }
            }
            else if (rad < pdc->rgrad[i]) {
              _sqrt(SUB84((double)l,0),
                            (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)l >>
                                                                              0x20))));
              bVar3 = (undefined1 *)0xfff7 < &stack0xffb0;
              bVar4 = &stack0x0000 == (undefined1 *)((int)(ulong *)rgcrPlrHistory + 0x1a);
              __aFfcompp();
              if (bVar3 || bVar4) {
                return;
              }
            }
            else if ((x2 == x) && (y2 == y)) {
              return;
            }
          }
          i = i + 1;
        } while( true );
      }
      if (pdc->fHollowOut != 0) {
        SetROP2(pdc->hdc,9);
        crSav = SetBkColor(pdc->hdc,0xffffff);
        Ellipse(pdc->hdc,prc->left,prc->top,prc->right,prc->bottom);
        SetBkColor(pdc->hdc,crSav);
        SetROP2(pdc->hdc,0xf);
      }
      Ellipse(pdc->hdc,prc->left,prc->top,prc->right,prc->bottom);
    }
  }
  return;
}



// ======================================================================
// Function: DrawShipScanPath
// Address: 1058:540c
// Segment: MEMORY_SCAN
// ======================================================================


void DrawShipScanPath(HDC hdc,short fShow)

{
  FLEET *pFVar1;
  double dVar2;
  uint uVar3;
  short sVar4;
  short sVar5;
  HGDIOBJ HVar6;
  THING *pTVar7;
  int iVar8;
  ORDER *pOVar9;
  short *psVar10;
  int *piVar11;
  undefined2 unaff_SI;
  ushort unaff_DI;
  undefined2 uVar12;
  undefined2 unaff_SS;
  bool bVar13;
  long lVar14;
  ulong uVar15;
  double *pdVar16;
  short sVar17;
  undefined2 uVar18;
  HDC HVar19;
  undefined2 in_stack_0000fee8;
  long local_10e;
  short dy5;
  int ptTick;
  int local_fa;
  short dx5;
  int rgptArrow [4];
  undefined8 dAngle;
  RECT rc;
  short dx;
  short dRad;
  long lWarp2;
  short fHdc;
  short i;
  FLEET *lpfl;
  POINT ptCur;
  ORDER *lpord1;
  short dy;
  short iRopSav;
  POINT pt;
  POINT pt2;
  HPEN hpenSav;
  short j;
  int rgDup [87];
  ORDER *lpord2;
  
  fHdc = 0;
  if (((sel.grobj != grobjFleet) && (sel.scan.grobj != grobjFleet)) &&
     (sel.scan.grobj != grobjThing)) {
    if (sel.grobj != grobjPlanet) {
      return;
    }
    if (((((uint)sel.pl.wFlags >> 9 & 1) == 0) ||
        ((sel.pl.wFlags & 0x3ffU) == 0)) && ((sel.pl.wRouting & 0x3ffU) == 0)) {
      return;
    }
  }
  if (fShow == fOrdersVis) {
    return;
  }
  if ((gd._4_2_ & 1) != 0) {
    return;
  }
  fOrdersVis = fShow;
  bVar13 = hdc == 0;
  if (bVar13) {
    hdc = GetDC(hwndScanner);
  }
  fHdc = (short)bVar13;
  if ((sel.scan.grobj == grobjThing) && (sel.scan.ith != -1)) {
    pTVar7 = (THING *)lpThings + sel.scan.ith;
    dAngle._0_6_ = CONCAT24(pTVar7,(ulong)dAngle);
    dAngle = (double)CONCAT26(lpThings._2_2_,(uint6)dAngle);
    ptCur.x = (&pTVar7->pt)->x;
    ptCur.y = (pTVar7->pt).y;
    if (*dAngle._4_4_ >> 0xd == 3) {
      dx = *(int *)pTVar7->rgb - ptCur.x;
      dy = *(int *)(pTVar7->rgb + 2) - ptCur.y;
      uVar3 = *(uint *)(pTVar7->rgb + 4) & 0xf;
    }
    else {
      if ((*dAngle._4_4_ >> 0xd != 1) || ((*(uint *)pTVar7->rgb >> 10 & 0xf) == 0))
      goto SCAN_LNextCheck;
      dx = ((POINT *)rgptPlan + (*(uint *)pTVar7->rgb & 0x3ff))->x - ptCur.x;
      dy = *(int *)((int)&rgptPlan[0].y + (*(uint *)pTVar7->rgb & 0x3ff) * 4) - ptCur.y;
      uVar3 = (*(uint *)pTVar7->rgb >> 10 & 0xf) + 4;
    }
    lWarp2 = (long)uVar3;
    if ((dx == 0) && (dy == 0)) goto SCAN_LNextCheck;
    uVar15 = __aFulmul((ulong)uVar3,5);
    lWarp2 = __aFulmul(lWarp2,uVar15);
    lpfl = (FLEET *)0x0;
  }
  else {
SCAN_LNextCheck:
    if (sel.scan.grobj != grobjFleet) goto SCAN_LNoObjPath;
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[sel.scan.ifl];
    iVar8 = *(int *)((int)((FLEET **)rglpfl + sel.scan.ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar8,pFVar1);
    ptCur.x = (&pFVar1->pt)->x;
    ptCur.y = (pFVar1->pt).y;
    if ((((uint)pFVar1->wFlags >> 4 & 1) == 0) || ((pFVar1->wFlags & 0xfU) == 0))
    goto SCAN_LNoObjPath;
    dx = (*(uint *)&pFVar1->field17_0x74 & 0xff) - 0x7f;
    dy = (*(uint *)&pFVar1->field17_0x74 >> 8) - 0x7f;
    if ((dx == 0) && (dy == 0)) goto SCAN_LNoObjPath;
    lWarp2 = (long)((pFVar1->wFlags & 0xfU) * (pFVar1->wFlags & 0xfU) * 5);
  }
  GetClientRect(hwndScanner,(RECT *)&rc);
  ExcludeClipRect(hdc,rc.left,rc.bottom - dySBar,rc.right,rc.bottom);
  hpenSav = SelectObject(hdc,hpenStarbase);
  iRopSav = SetROP2(hdc,7);
  if (dx == 0) {
    dx5 = 0;
    dy5 = (int)lWarp2;
    if (dy < 0) {
      dy5 = -(int)lWarp2;
    }
  }
  else {
    lWarp2 = __aFulmul(lWarp2,lWarp2);
    local_10e = (long)dy;
    dVar2 = (double)lWarp2 /
            (((double)local_10e / (double)(long)dx) * ((double)local_10e / (double)(long)dx) + 1.0);
    sVar4 = dx;
    _sqrt(SUB84(dVar2,0),
                  (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar2 >> 0x20))));
    lVar14 = __ftol((double)CONCAT26(sVar4,CONCAT24(in_stack_0000fee8,
                                                            CONCAT22(unaff_SI,unaff_DI))));
    dx5 = (short)lVar14;
    if (dx < 0) {
      dx5 = -dx5;
    }
    iVar8 = dx >> 0xf;
    sVar4 = dx;
    uVar15 = __aFulmul((long)dx5,(long)dy);
    lVar14 = __aFldiv(uVar15,CONCAT22(iVar8,sVar4));
    dy5 = (short)lVar14;
  }
  LogicalToScan(&ptCur);
  sVar4 = PtToScan(dx5);
  sVar5 = PtToScan(dy5);
  MoveTo(hdc,ptCur.x - sVar4,ptCur.y + sVar5);
  LineTo(hdc,ptCur.x + sVar4,ptCur.y + -sVar5);
  if (dy == 0) {
    ptTick = 0;
    if (dx < 0) {
      local_fa = -4;
    }
    else {
      local_fa = 4;
    }
  }
  else {
    local_10e = (long)-dx;
    dVar2 = DOUBLE_24_0__1120_1ce2 /
            (((double)local_10e / (double)(long)dy) * ((double)local_10e / (double)(long)dy) + 1.0);
    sVar17 = dy;
    _sqrt(SUB84(dVar2,0),
                  (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar2 >> 0x20))));
    lVar14 = __ftol((double)CONCAT26(sVar17,CONCAT24(in_stack_0000fee8,
                                                             CONCAT22(unaff_SI,unaff_DI))));
    ptTick = (int)lVar14;
    if (ptTick == 0) {
      if (dy < 0) {
        local_fa = -4;
      }
      else {
        local_fa = 4;
      }
    }
    else {
      if (0 < dx) {
        ptTick = -ptTick;
      }
      iVar8 = dy >> 0xf;
      sVar17 = dy;
      uVar15 = __aFulmul((long)ptTick,(long)dx);
      lVar14 = __aFldiv(uVar15,CONCAT22(iVar8,sVar17));
      local_fa = (int)lVar14;
    }
  }
  local_10e = (long)-dx;
  dVar2 = (double)local_10e;
  pdVar16 = _atan2(SUB84((double)(long)-dy,0),
                           (double)CONCAT26((int)((qword)dVar2 >> 0x10),
                                            CONCAT24(SUB82(dVar2,0),
                                                     (long)((qword)(double)(long)-dy >> 0x20))),
                           (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar2 >> 0x20))
                                           ));
  dAngle = *(double *)pdVar16 - DOUBLE_0_7853982__1120_1cea;
  for (i = 0; i < 2; i = i + 1) {
    uVar12 = SUB102((longdouble)5,0);
    uVar18 = (undefined2)((unkuint10)(longdouble)5 >> 0x10);
    _cos(SUB84(dAngle,0),
                 (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dAngle >> 0x20))));
    lVar14 = __ftol((double)CONCAT26(uVar18,CONCAT24(uVar12,CONCAT22(unaff_SI,unaff_DI))));
    rgptArrow[i * 2] = (int)lVar14;
    uVar12 = SUB102((longdouble)5,0);
    uVar18 = (undefined2)((unkuint10)(longdouble)5 >> 0x10);
    _sin(SUB84(dAngle,0),
                 (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dAngle >> 0x20))));
    lVar14 = __ftol((double)CONCAT26(uVar18,CONCAT24(uVar12,CONCAT22(unaff_SI,unaff_DI))));
    rgptArrow[i * 2 + 1] = (int)lVar14;
    dAngle = DOUBLE_1_5707964__1120_1cfa + dAngle;
  }
  j = -5;
  for (i = -5; sVar17 = j, i < 6; i = i + 1) {
    if (i == 0) {
      j = 5;
    }
    else {
      uVar18 = 0;
      uVar12 = 10;
      __aFulmul((long)sVar4,(long)i);
      lVar14 = __aFlshl(CONCAT22(uVar18,uVar12),unaff_DI);
      lVar14 = __aFldiv(lVar14 + sVar17,CONCAT22(uVar18,uVar12));
      sVar17 = j;
      pt.x = (int)lVar14 + ptCur.x;
      uVar18 = 0;
      uVar12 = 10;
      __aFulmul((long)-sVar5,(long)i);
      lVar14 = __aFlshl(CONCAT22(uVar18,uVar12),unaff_DI);
      lVar14 = __aFldiv(lVar14 + sVar17,CONCAT22(uVar18,uVar12));
      pt.y = (int)lVar14 + ptCur.y;
      if (i < 1) {
        MoveTo(hdc,pt.x + ptTick,pt.y + local_fa);
        LineTo(hdc,pt.x - ptTick,pt.y - local_fa);
        LineTo(hdc,pt.x - ptTick,(pt.y - local_fa) + -1);
      }
      else {
        for (j = 0; j < 2; j = j + 1) {
          MoveTo(hdc,pt.x + rgptArrow[j * 2],pt.y - rgptArrow[j * 2 + 1]);
          LineTo(hdc,pt.x,pt.y);
        }
      }
    }
  }
  SetROP2(hdc,iRopSav);
  SelectObject(hdc,hpenSav);
SCAN_LNoObjPath:
  if (sel.grobj == grobjPlanet) {
    dAngle._0_6_ = (uint6)(ulong)dAngle;
    if ((((uint)sel.pl.wFlags >> 9 & 1) != 0) && ((sel.pl.wFlags & 0x3ffU) != 0)
       ) {
      hpenSav = SelectObject(hdc,hpenDkPurple);
      dAngle = (double)CONCAT26((sel.pl.wFlags & 0x3ffU) - 1,(uint6)dAngle);
      goto SCAN_LDrawPath;
    }
    while (((sel.pl.wRouting & 0x3ffU) != 0 && (dAngle._4_2_ == 0))) {
      dAngle._0_6_ = CONCAT24(1,(ulong)dAngle);
      dAngle = (double)CONCAT26((sel.pl.wRouting & 0x3ffU) - 1,(uint6)dAngle);
      hpenSav = SelectObject(hdc,hpenDkGreen);
SCAN_LDrawPath:
      iRopSav = SetROP2(hdc,7);
      GetClientRect(hwndScanner,(RECT *)&rc);
      ExcludeClipRect(hdc,rc.left,rc.bottom - dySBar,rc.right,rc.bottom);
      pt.x = ((POINT *)rgptPlan + sel.pl.id)->x;
      pt.y = *(short *)((int)&rgptPlan[0].y + sel.pl.id * 4);
      LogicalToScan(&pt);
      MoveTo(hdc,pt.x,pt.y);
      pt.x = ((POINT *)rgptPlan + dAngle._6_2_)->x;
      pt.y = *(short *)((int)&rgptPlan[0].y + dAngle._6_2_ * 4);
      LogicalToScan(&pt);
      LineTo(hdc,pt.x,pt.y);
      SetROP2(hdc,iRopSav);
      SelectObject(hdc,hpenSav);
    }
  }
  else if ((sel.grobj == grobjFleet) && (1 < sel.fl.cord)) {
    _memset(rgDup,0,sel.fl.cord << 1);
    lpord1 = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,
                               (ORDER *)((PLORD *)sel.fl.lpplord + 1));
    pt.x = (lpord1->pt).x;
    pt.y = *(int *)&((PLORD *)sel.fl.lpplord)[1].iordMax;
    for (i = 1; i < sel.fl.cord; i = i + 1) {
      lpord2 = (ORDER *)CONCAT22(lpord1._2_2_,(ORDER *)lpord1 + 1);
      pt2.x = (lpord2->pt).x;
      pt2.y = ((ORDER *)lpord1)[1].pt.y;
      if (rgDup[i] == 0) {
        for (j = i + 1; j < sel.fl.cord; j = j + 1) {
          uVar12 = (undefined2)((ulong)lpord2 >> 0x10);
          pOVar9 = (ORDER *)lpord2;
          if (((((pt.x == (lpord2->pt).x) && (pt.y == (pOVar9->pt).y)) &&
               (pt2.x == ((pOVar9 + 1)->pt).x)) && (pt2.y == pOVar9[1].pt.y)) ||
             (((pt2.x == (lpord2->pt).x && (pt2.y == (pOVar9->pt).y)) &&
              ((pt.x == ((pOVar9 + 1)->pt).x && (pt.y == pOVar9[1].pt.y)))))) {
            rgDup[i] = 1;
            rgDup[j] = 2;
          }
          lpord2 = (ORDER *)CONCAT22(lpord2._2_2_,(ORDER *)lpord2 + 1);
        }
      }
      pt.x = pt2.x;
      pt.y = pt2.y;
      lpord1 = (ORDER *)CONCAT22(lpord1._2_2_,(ORDER *)lpord1 + 1);
    }
    GetClientRect(hwndScanner,(RECT *)&rc);
    ExcludeClipRect(hdc,rc.left,rc.bottom - dySBar,rc.right,rc.bottom);
    if ((fShow != 0) && ((grbitScan & 0x80) != 0)) {
      hpenSav = SelectObject(hdc,hpenStarbase);
      uVar12 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
      pt.x = ((PLORD *)sel.fl.lpplord + 1)->wFlags;
      pt.y = *(short *)&((PLORD *)sel.fl.lpplord)[1].iordMax;
      LogicalToScan(&pt);
      MoveTo(hdc,pt.x,pt.y);
      for (i = 1; i < sel.fl.cord; i = i + 1) {
        psVar10 = (short *)((int)(PLORD *)sel.fl.lpplord + i * 0x12 + 4);
        pt2.x = *psVar10;
        pt2.y = psVar10[1];
        LogicalToScan(&pt2);
        LineTo(hdc,pt2.x,pt2.y);
        pt.x = pt2.x;
        pt.y = pt2.y;
      }
      SelectObject(hdc,hpenSav);
    }
    hpenSav = SelectObject(hdc,hpenShip);
    iRopSav = SetROP2(hdc,7);
    uVar12 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
    pt.x = ((PLORD *)sel.fl.lpplord + 1)->wFlags;
    pt.y = *(short *)&((PLORD *)sel.fl.lpplord)[1].iordMax;
    dRad = 5;
    LogicalToScan(&pt);
    ExcludeClipRect(hdc,pt.x - dRad,pt.y - dRad,pt.x + dRad + 1,pt.y + dRad + 1);
    MoveTo(hdc,pt.x,pt.y);
    for (i = 1; i < sel.fl.cord; i = i + 1) {
      piVar11 = (int *)((int)(PLORD *)sel.fl.lpplord + i * 0x12 + 4);
      pt2.x = *piVar11;
      pt2.y = piVar11[1];
      dRad = 5;
      LogicalToScan(&pt2);
      ExcludeClipRect(hdc,pt2.x - dRad,pt2.y - dRad,pt2.x + dRad + 1,pt2.y + dRad + 1);
      if (rgDup[i] == 2) {
        MoveTo(hdc,pt2.x,pt2.y);
      }
      else {
        if (rgDup[i] == 1) {
          HVar6 = hpenYellow;
          HVar19 = hdc;
          if ((grbitScan & 0x80) == 0) {
            HVar6 = GetStockObject(6);
          }
          SelectObject(HVar19,HVar6);
        }
        LineTo(hdc,pt2.x,pt2.y);
        if (rgDup[i] == 1) {
          SelectObject(hdc,hpenShip);
        }
      }
      pt.x = pt2.x;
      pt.y = pt2.y;
    }
    SetROP2(hdc,iRopSav);
    SelectObject(hdc,hpenSav);
    SelectClipRgn(hdc,hrgnHuge);
  }
  if (fHdc != 0) {
    ReleaseDC(hwndScanner,hdc);
  }
  return;
}



// ======================================================================
// Function: DrawScannerSBar
// Address: 1058:62d8
// Segment: MEMORY_SCAN
// ======================================================================


void DrawScannerSBar(HDC hdc,RECT *prc,SBAR *psbar,short fFullRedraw)

{
  BOOL BVar1;
  short sVar2;
  char *pcVar3;
  ushort uVar4;
  int iVar5;
  int iVar6;
  undefined2 unaff_SS;
  DWORD DVar7;
  undefined2 uVar8;
  RECT *pRVar9;
  undefined2 uVar10;
  UINT UVar11;
  UINT UVar12;
  HDC HVar13;
  RECT rc;
  RECT rcT;
  short grobj;
  undefined4 l;
  short fDoName;
  HBRUSH hbrSav;
  char *psz;
  RECT rcClip;
  HFONT hfontSav;
  short dxHole;
  COLORREF crBk;
  short c;
  short iBkPrev;
  short grReal;
  int pt;
  short local_12;
  short id;
  int pt2;
  short local_c;
  COLORREF crText;
  short fhdc;
  
  fhdc = 0;
  fDoName = 1;
  GetClientRect(hwndScanner,(RECT *)&rc);
  rc.top = rc.bottom - dySBar;
  if ((prc == (RECT *)0x0) ||
     (BVar1 = IntersectRect((RECT *)&rcT,(RECT *)prc,(RECT *)&rc), BVar1 != 0)) {
    if (hdc == 0) {
      fhdc = 1;
      hdc = GetDC(hwndScanner);
    }
    hfontSav = SelectObject(hdc,rghfontArial8[1]);
    if (psbar == (SBAR *)0x0) {
      grobj = sel.scan.grobj;
    }
    else {
      grobj = psbar->grbit;
    }
    iBkPrev = SetBkMode(hdc,1);
    crBk = SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
    ;
    crText = SetTextColor(hdc,CONCAT22(crButtonText._2_2_,
                                       (undefined2)crButtonText));
    hbrSav = SelectObject(hdc,hbrButtonFace);
    if (fFullRedraw != 0) {
      PatBlt(hdc,rc.left,rc.top,rc.right - rc.left,dySBar,0xf00021);
      SelectObject(hdc,hbrButtonHilite);
      PatBlt(hdc,rc.left,rc.top,1,dySBar,0xf00021);
      PatBlt(hdc,rc.left,rc.top,rc.right - rc.left,1,0xf00021);
    }
    rc.bottom = rc.bottom - (dySBar >> 1);
    rcT.right = rc.right;
    rcT.top = rc.top + 4;
    rcT.bottom = rc.bottom + -4;
    rcT.left = rc.left + 4;
    if (0x167 < rc.right) {
      l = GetTextExtent(hdc,(LPCSTR)0x112005a2,7);
      dxHole = (int)l + 6;
      rcT.right = dxHole + rcT.left;
      DrawLockLight(hdc,&rcT,fFullRedraw);
      if ((grobj & 1U) == 0) {
        if (grobj == 4) {
          if (psbar == (SBAR *)0x0) {
            id = sel.scan.iwp;
          }
          else {
            id = psbar->id;
          }
          c = wsprintf(szWork,(char *)0x112005b1,id);
          TextOut(hdc,rcT.left + 3,rcT.top + 2,szWork,c);
        }
      }
      else {
        if (psbar == (SBAR *)0x0) {
          id = sel.scan.idpl;
        }
        else {
          id = psbar->id;
        }
        if (id != -1) {
          c = wsprintf(szWork,(char *)0x112005aa,id + 1);
          SetBkMode(hdc,2);
          TextOut(hdc,rcT.left + 3,rcT.top + 2,szWork,c);
        }
      }
      DVar7 = GetTextExtent(hdc,(LPCSTR)0x112005b8,7);
      rcT.left = rcT.left + dxHole + 4;
      dxHole = (int)DVar7 + 6;
      rcT.right = dxHole + rcT.left;
      l = DVar7;
      DrawLockLight(hdc,&rcT,fFullRedraw);
      if (psbar == (SBAR *)0x0) {
        if (grobj == 0) {
          local_12 = 0;
          pt = 0;
        }
        else {
          pt = sel.scan.pt.x;
          local_12 = sel.scan.pt.y;
        }
      }
      else {
        pt = (&psbar->pt)->x;
        local_12 = (psbar->pt).y;
      }
      if (0 < pt) {
        c = wsprintf(szWork,(char *)0x112005c0);
        SetBkMode(hdc,2);
        TextOut(hdc,rcT.left + 3,rcT.top + 2,szWork,c);
      }
      rcT.left = rcT.left + dxHole + 4;
      dxHole = (int)l + 6;
      rcT.right = dxHole + rcT.left;
      DrawLockLight(hdc,&rcT,fFullRedraw);
      if (0 < local_12) {
        c = wsprintf(szWork,(char *)0x112005c6);
        SetBkMode(hdc,2);
        TextOut(hdc,rcT.left + 3,rcT.top + 2,szWork,c);
      }
      rcT.left = rcT.left + dxHole + 4;
    }
    dxHole = (rc.right - rcT.left) + -4;
    rcT.right = dxHole + rcT.left;
    DrawLockLight(hdc,&rcT,fFullRedraw);
    rcClip.left = rcT.left;
    rcClip.top = rcT.top;
    rcClip.right = rcT.right;
    rcClip.bottom = rcT.bottom;
    ExpandRc(&rcClip,-2,-2);
    grReal = sel.scan.grobjFull;
    if (grobj != 4) {
      grReal = grobj;
    }
    if ((psbar == (SBAR *)0x0) || (psbar->psz == (char *)0x0)) {
      if ((grReal & grobjPlanet) == grobjNone) {
        if ((grReal & grobjFleet) == grobjNone) {
          if ((grReal & grobjThing) == grobjNone) {
            if ((grReal == grobjNone) && (grobj == 4)) {
              CchGetString(idsDeepSpaceWaypoint,(char *)szWork);
            }
            else {
              fDoName = 0;
            }
          }
          else {
            if (psbar == (SBAR *)0x0) {
              sVar2 = ((THING *)lpThings + sel.scan.ith)->idFull;
            }
            else {
              sVar2 = psbar->id;
            }
            PszGetThingName(sVar2);
          }
        }
        else {
          if (psbar == (SBAR *)0x0) {
            sVar2 = ((FLEET **)rglpfl)[sel.scan.ifl]->id;
          }
          else {
            sVar2 = psbar->id;
          }
          PszGetFleetName(sVar2);
        }
      }
      else {
        sVar2 = sel.scan.idpl;
        if (psbar != (SBAR *)0x0) {
          sVar2 = psbar->id;
        }
        PszGetPlanetName(sVar2);
      }
    }
    else {
      _strcpy((char *)szWork,psbar->psz);
    }
    if (fDoName != 0) {
      iVar5 = rcT.left + 3;
      iVar6 = rcT.top + 2;
      UVar11 = 4;
      pRVar9 = &rcClip;
      uVar8 = 0x1120;
      pcVar3 = (char *)szWork;
      uVar10 = unaff_SS;
      HVar13 = hdc;
      UVar12 = lstrlen(szWork);
      ExtTextOut(HVar13,iVar5,iVar6,UVar11,(RECT *)CONCAT22(uVar10,pRVar9),
                 (LPCSTR)CONCAT22(uVar8,pcVar3),UVar12,(short *)0x0);
    }
    OffsetRc(&rc,0,dySBar >> 1);
    rcT.top = rc.top + 4;
    rcT.bottom = rc.bottom + -4;
    rcT.left = rc.left + 4;
    rcT.right = rc.right + -4;
    DrawLockLight(hdc,&rcT,fFullRedraw);
    rcClip.left = rcT.left;
    rcClip.top = rcT.top;
    rcClip.right = rcT.right;
    rcClip.bottom = rcT.bottom;
    ExpandRc(&rcClip,-2,-2);
    if (psbar == (SBAR *)0x0) {
      if (grobj == 0) {
        local_12 = 0;
        pt = 0;
      }
      else {
        pt = sel.scan.pt.x;
        local_12 = sel.scan.pt.y;
      }
    }
    else {
      pt = (&psbar->pt)->x;
      local_12 = (psbar->pt).y;
    }
    if ((psbar == (SBAR *)0x0) || (psbar->pscan == (SCAN *)0x0)) {
      if ((sel.grobj == grobjFleet) || (sel.grobj == grobjPlanet)) {
        pt2 = sel.pt.x;
        local_c = sel.pt.y;
      }
      else {
        pt2 = -1;
      }
    }
    else {
      pt2 = (psbar->pscan->pt).x;
      local_c = (psbar->pscan->pt).y;
    }
    if (((pt != -1) && (pt2 != -1)) && ((pt != pt2 || (local_12 != local_c)))) {
      pcVar3 = PszGetDistance(pt,local_12,pt2,local_c);
      _strcpy(&stack0xff56,pcVar3);
      for (psz = &stack0xff56; *psz != ' '; psz = psz + 1) {
      }
      CchGetString((0x15d < rc.right) + idsLy,psz + 1);
      if ((psbar == (SBAR *)0x0) || (psbar->pscan == (SCAN *)0x0)) {
        uVar4 = _strlen(psz);
        CchGetString(idsFrom,psz + uVar4);
        pcVar3 = PszGetLocName(sel.grobj,sel.id,pt2,local_c);
        _strcat(psz + 8,pcVar3);
      }
      iVar5 = rcT.left + 3;
      iVar6 = rcT.top + 2;
      UVar12 = 4;
      pRVar9 = &rcClip;
      pcVar3 = &stack0xff56;
      uVar10 = unaff_SS;
      HVar13 = hdc;
      uVar4 = _strlen(&stack0xff56);
      ExtTextOut(HVar13,iVar5,iVar6,UVar12,(RECT *)CONCAT22(uVar10,pRVar9),(LPCSTR)pcVar3,uVar4,
                 (short *)0x0);
    }
    SelectObject(hdc,hbrSav);
    SetBkMode(hdc,iBkPrev);
    SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
    SetBkColor(hdc,crBk);
    SelectObject(hdc,hfontSav);
    if (fhdc != 0) {
      ReleaseDC(hwndScanner,hdc);
    }
  }
  return;
}



// ======================================================================
// Function: DrawLockLight
// Address: 1058:6b00
// Segment: MEMORY_SCAN
// ======================================================================


void DrawLockLight(HDC hdc,RECT *prc,short fFullRedraw)

{
  undefined2 unaff_SS;
  RECT rc;
  short dx;
  short dy;
  
  dx = prc->right - prc->left;
  dy = prc->bottom - prc->top;
  if (fFullRedraw == 0) {
    rc.left = prc->left;
    rc.top = prc->top;
    rc.right = prc->right;
    rc.bottom = prc->bottom;
    ExpandRc(&rc,-2,-2);
    FillRect(hdc,(RECT *)&rc,hbrButtonFace);
  }
  else {
    SelectObject(hdc,hbrButtonShadow);
    PatBlt(hdc,prc->left,prc->top,1,dy,0xf00021);
    PatBlt(hdc,prc->left,prc->top,dx,1,0xf00021);
    SelectObject(hdc,hbrButtonHilite);
    PatBlt(hdc,prc->right,prc->top,1,dy + 1,0xf00021);
    PatBlt(hdc,prc->left,prc->bottom,dx,1,0xf00021);
  }
  return;
}



// ======================================================================
// Function: SetScanScrollBars
// Address: 1058:6c14
// Segment: MEMORY_SCAN
// ======================================================================


void SetScanScrollBars(HWND hwnd)

{
  int iVar1;
  undefined2 unaff_SS;
  RECT rc;
  short dx;
  short yMax;
  short dy;
  short xMax;
  
  fInScrollSet = 1;
  GetClientRect(hwnd,(RECT *)&rc);
  dx = ScanToPt(rc.right);
  dy = ScanToPt(rc.bottom - dySBar);
  if ((dGalInv + -1000) - dx < 1000) {
    iVar1 = 1000;
  }
  else {
    iVar1 = (dGalInv + -1000) - dx;
  }
  xMax = iVar1 + 3U & 0xfffc;
  if ((dGalInv + -1000) - dy < 1000) {
    iVar1 = 1000;
  }
  else {
    iVar1 = (dGalInv + -1000) - dy;
  }
  yMax = iVar1 + 3U & 0xfffc;
  SetScrollRange(hwnd,0,1000,xMax,1);
  if ((fInScrollSet != 0) && (SetScrollRange(hwnd,1,1000,yMax,1), fInScrollSet != 0))
  {
    if (dy <= dx) {
      dx = dy;
    }
    dScanPage = dx / 3 & 0xfffc;
    dScanInc = dScanPage / 8 + 2U & 0xfffc;
    fInScrollSet = 0;
  }
  return;
}



// ======================================================================
// Function: ScrollScanner
// Address: 1058:6d30
// Segment: MEMORY_SCAN
// ======================================================================


void ScrollScanner(short dx,short dy)

{
  BOOL BVar1;
  short sVar2;
  undefined2 unaff_SS;
  RECT rc;
  RECT rcUpd2;
  RECT rcUpd;
  HDC hdc;
  
  if ((((dx != 0) || (dy != 0)) && (BVar1 = IsWindowVisible(hwndScanner), BVar1 != 0)) &&
     ((gd._4_2_ & 1) == 0)) {
    hdc = GetDC(hwndScanner);
    GetClientRect(hwndScanner,(RECT *)&rc);
    sVar2 = _abs(dx);
    if (((rc.right >> 1 < sVar2) || (sVar2 = _abs(dy), rc.bottom >> 1 < sVar2)) ||
       ((fDlgUp != 0 || (hwndBrowser != 0)))) {
      DrawScanner(hdc,&rc);
    }
    else {
      rc.bottom = rc.bottom - dySBar;
      UpdateWindow(hwndScanner);
      ScrollWindow(hwndScanner,dx,dy,(RECT *)&rc,(RECT *)&rc);
      if (dy < 1) {
        if (dy < 0) {
          SetRect((RECT *)&rcUpd2,0,rc.bottom + dy,rc.right,rc.bottom);
          rc.bottom = rc.bottom + dy;
        }
      }
      else {
        SetRect((RECT *)&rcUpd2,0,0,rc.right,dy);
        rc.top = rc.top + dy;
      }
      if (dx < 1) {
        if (dx < 0) {
          rcUpd.top = rc.top;
          rcUpd.right = rc.right;
          rcUpd.bottom = rc.bottom;
          rcUpd.left = rc.right + dx;
          rc.left = rc.left - dx;
        }
      }
      else {
        SetRect((RECT *)&rcUpd,0,rc.top,dx,rc.bottom);
        rc.right = rc.right - dx;
      }
      if (dx != 0) {
        ValidateRect(hwndScanner,(RECT *)&rcUpd);
      }
      if (dy != 0) {
        ValidateRect(hwndScanner,(RECT *)&rcUpd2);
      }
      if (dx != 0) {
        DrawScanner(hdc,&rcUpd);
      }
      if (dy != 0) {
        DrawScanner(hdc,&rcUpd2);
      }
      UpdateWindow(hwndScanner);
    }
    ReleaseDC(hwndScanner,hdc);
  }
  return;
}



// ======================================================================
// Function: RedrawScanSel
// Address: 1058:6f30
// Segment: MEMORY_SCAN
// ======================================================================


void RedrawScanSel(HDC hdc,short fVis)

{
  int *piVar1;
  int *piVar2;
  GrobjClass GVar3;
  BOOL BVar4;
  int iVar5;
  int *piVar6;
  int *piVar7;
  undefined2 unaff_SS;
  bool bVar8;
  short sel_grobjFull;
  RECT rc;
  int sel_scan;
  int local_20;
  int local_1e;
  short fNoSelRedraw;
  short sel_id;
  POINT pt;
  short dOff;
  short fhdc;
  short sel_grobj;
  
  GVar3 = sel.grobjFull;
  fhdc = 0;
  sel_id = sel.id;
  sel_grobj = sel.grobj;
  piVar6 = (int *)&sel.scan;
  piVar7 = &sel_scan;
  for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
    piVar2 = piVar7;
    piVar7 = piVar7 + 1;
    piVar1 = piVar6;
    piVar6 = piVar6 + 1;
    *piVar2 = *piVar1;
  }
  if ((hwndScanner != 0) && (BVar4 = IsWindowVisible(hwndScanner), BVar4 != 0)) {
    bVar8 = fVis == -1;
    if (bVar8) {
      fVis = 0;
    }
    fNoSelRedraw = (short)bVar8;
    if (hdc == 0) {
      fhdc = 1;
      hdc = GetDC(hwndScanner);
    }
    DrawShipScanPath(hdc,fVis);
    if (fVis == 0) {
      sel.scan.iwp = -1;
      sel.scan.ifl = -1;
      sel.scan.idpl = -1;
      sel.id = -1;
      sel.grobjFull = grobjNone;
      sel.grobj = grobjNone;
      sel.scan.grobjFull = grobjNone;
      sel.scan.grobj = grobjNone;
    }
    if ((iScanZoom < 3) || ((grbitScan & 0xf) != 4)) {
      if ((grbitScan & 0x1000) == 0) {
        dOff = 0;
      }
      else {
        dOff = 7;
      }
    }
    else {
      dOff = 0xb;
    }
    if ((sel_grobj != 0) && (fNoSelRedraw == 0)) {
      pt.x = sel.pt.x;
      pt.y = sel.pt.y;
      LogicalToScan(&pt);
      SetRect((RECT *)&rc,(pt.x + -0xb) - dOff,(pt.y + -0xb) - dOff,pt.x + 0xc + dOff,
              pt.y + 0x17 + dOff);
      DrawScanner(hdc,&rc);
    }
    if ((local_1e != 0) && ((sel_scan != sel.pt.x || (local_20 != sel.pt.y)))) {
      pt.x = sel_scan;
      pt.y = local_20;
      LogicalToScan(&pt);
      SetRect((RECT *)&rc,(pt.x + -6) - dOff,(pt.y + -6) - dOff,pt.x + 7 + dOff,pt.y + 0xf + dOff);
      DrawScanner(hdc,&rc);
    }
    if (fVis == 0) {
      sel.id = sel_id;
      sel.grobj = sel_grobj;
      piVar7 = &sel_scan;
      piVar6 = (int *)&sel.scan;
      sel.grobjFull = GVar3;
      for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
        piVar2 = piVar6;
        piVar6 = piVar6 + 1;
        piVar1 = piVar7;
        piVar7 = piVar7 + 1;
        *piVar2 = *piVar1;
      }
    }
    if (fhdc != 0) {
      ReleaseDC(hwndScanner,hdc);
    }
  }
  return;
}



// ======================================================================
// Function: FEnsurePointOnScreen
// Address: 1058:715c
// Segment: MEMORY_SCAN
// ======================================================================


short FEnsurePointOnScreen(POINT pt,short fScroll)

{
  POINT pt_00;
  BOOL BVar1;
  short sVar2;
  undefined2 unaff_SS;
  RECT rc;
  int ptCtr;
  int local_c;
  short cx;
  short fFix;
  short cy;
  
  fFix = 0;
  GetClientRect(hwndScanner,(RECT *)&rc);
  rc.bottom = rc.bottom - dySBar;
  cx = ScanToPt(rc.right);
  cy = ScanToPt(rc.bottom);
  rc.left = xScanTop + 10;
  rc.right = xScanTop + cx + -0x14;
  rc.bottom = (dGalInv - yScanTop) + -10;
  rc.top = (rc.bottom - cy) + 0x14;
  BVar1 = PtInRect((RECT *)&rc,(POINT)pt);
  if (BVar1 == 0) {
    ptCtr = (cx >> 1) + xScanTop;
    local_c = (dGalInv - yScanTop) - (cy >> 1);
    if (pt.x < rc.left) {
      ptCtr = ptCtr - (rc.left - pt.x);
    }
    else if (rc.right < pt.x) {
      ptCtr = ptCtr + (pt.x - rc.right);
    }
    if (pt.y < rc.top) {
      local_c = local_c - (rc.top - pt.y);
    }
    else if (rc.bottom < pt.y) {
      local_c = local_c + (pt.y - rc.bottom);
    }
    pt_00.y = local_c;
    pt_00.x = ptCtr;
    CtrPointScan(pt_00,fScroll);
    sVar2 = 0;
  }
  else {
    sVar2 = 1;
  }
  return sVar2;
}



// ======================================================================
// Function: CtrPointScan
// Address: 1058:7278
// Segment: MEMORY_SCAN
// ======================================================================


void CtrPointScan(POINT pt,short fScroll)

{
  int iVar1;
  int iVar2;
  short dy;
  short dx;
  undefined2 unaff_SS;
  RECT rc;
  short x;
  short dyCur;
  short cx;
  short y;
  short cy;
  short dxCur;
  
  x = pt.x;
  y = pt.y;
  if (hwndScanner != 0) {
    GetClientRect(hwndScanner,(RECT *)&rc);
    rc.bottom = rc.bottom - dySBar;
    cx = ScanToPt(rc.right);
    cy = ScanToPt(rc.bottom);
    if (x - (cx >> 1) < 0x3e9) {
      iVar1 = 1000;
    }
    else {
      iVar1 = x - (cx >> 1);
    }
    if ((cy >> 1) + y < dGalInv + -1000) {
      iVar2 = (cy >> 1) + y;
    }
    else {
      iVar2 = dGalInv + -1000;
    }
    if ((dGalInv + -1000) - cx <= iVar1) {
      iVar1 = (dGalInv + -1000) - cx;
    }
    if (iVar2 <= cy + 1000) {
      iVar2 = cy + 1000;
    }
    iVar2 = dGalInv - iVar2;
    if (iVar1 < 0x3e9) {
      iVar1 = 1000;
    }
    if (iVar2 < 0x3e9) {
      iVar2 = 1000;
    }
    dxCur = xScanTop;
    dyCur = yScanTop;
    x = iVar1 + 2U & 0xfffc;
    y = iVar2 + 2U & 0xfffc;
    if ((xScanTop != x) || (yScanTop != y)) {
      xScanTop = x;
      SetScrollPos(hwndScanner,0,iVar1 + 2U & 0xfffc,1);
      yScanTop = y;
      SetScrollPos(hwndScanner,1,y,1);
      if (fScroll == 0) {
        InvalidateRect(hwndScanner,(RECT *)0x0,0);
      }
      else {
        dy = PtToScan(dyCur - y);
        dx = PtToScan(dxCur - x);
        ScrollScanner(dx,dy);
      }
    }
  }
  return;
}



// ======================================================================
// Function: LogicalToScan
// Address: 1058:744e
// Segment: MEMORY_SCAN
// ======================================================================


void LogicalToScan(POINT *ppt)

{
  short sVar1;
  
  sVar1 = PtToScan(ppt->x - xScanTop);
  ppt->x = sVar1;
  sVar1 = PtToScan((dGalInv - ppt->y) - yScanTop);
  ppt->y = sVar1;
  return;
}



// ======================================================================
// Function: ScanToLogical
// Address: 1058:7490
// Segment: MEMORY_SCAN
// ======================================================================


void ScanToLogical(POINT *ppt)

{
  short sVar1;
  
  sVar1 = ScanToPt(ppt->x);
  ppt->x = sVar1 + xScanTop;
  sVar1 = ScanToPt(ppt->y);
  ppt->y = dGalInv - (sVar1 + yScanTop);
  if (dGal + 1000 < ppt->x) {
    ppt->x = dGal + 1000;
  }
  if (ppt->y < 1000) {
    ppt->y = 1000;
  }
  return;
}



// ======================================================================
// Function: FAddWayPoint
// Address: 1058:7504
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1058763d) */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short FAddWayPoint(POINT ptIn,SCAN *pscan)

{
  byte *pbVar1;
  ORDER *pOVar2;
  ORDER *pOVar3;
  GrobjClass GVar4;
  long lVar5;
  char *pcVar6;
  int iVar7;
  uint uVar8;
  short sVar9;
  ORDER *pOVar10;
  undefined2 *puVar11;
  ORDER *pOVar12;
  undefined2 uVar13;
  undefined2 unaff_SS;
  ulong uVar14;
  ulong uVar15;
  short rc;
  short local_28;
  short ipt;
  short cpt;
  short dx;
  POINT rgpt;
  short local_18;
  short local_16;
  undefined2 local_14;
  undefined2 local_12;
  short lDist;
  ORDER *lpord;
  short dy;
  short id;
  HDC hdc;
  
  if (sel.fl.cord == 0x57) {
    MessageBeep(0x40);
    uVar13 = 0x56;
    pcVar6 = PszGetCompressedString(idsCantHaveDWaypoints);
    wsprintf(szWork,(char *)pcVar6,uVar13);
    local_28 = 0x14f8;
    rc = 0x7550;
    AlertSz((char *)szWork,0x10);
    sVar9 = 0;
  }
  else {
    if ((grbitScan & 0x80) != 0) {
      rgpt.x = ptIn.x;
      rgpt.y = ptIn.y;
      local_18 = (pscan->pt).x;
      local_16 = (pscan->pt).y;
      if (sel.iwpAct < sel.fl.cord + -1) {
        cpt = 3;
        puVar11 = (undefined2 *)
                  ((int)(PLORD *)sel.fl.lpplord + (sel.iwpAct + 1) * 0x12 + 4);
        local_14 = *puVar11;
        local_12 = puVar11[1];
      }
      else {
        cpt = 2;
      }
    }
    iVar7 = ptIn.x - (pscan->pt).x;
    dy = ptIn.y - (pscan->pt).y;
    lDist = ScanToPt(0x14);
    uVar14 = __aFulmul((long)dy,(long)dy);
    sVar9 = (short)uVar14;
    uVar15 = __aFulmul((long)iVar7,(long)iVar7);
    lVar5 = uVar15 + CONCAT22((int)(uVar14 >> 0x10),sVar9);
    local_28 = (short)lVar5;
    if (lDist * lDist < lVar5) {
      pscan->grobjFull = grobjOther;
      pscan->grobj = grobjOther;
      pscan->idpl = -1;
      pscan->ifl = -1;
      pscan->iwp = sel.iwpAct + 1;
      (pscan->pt).x = ptIn.x;
      (pscan->pt).y = ptIn.y;
    }
    pOVar10 = (ORDER *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
    lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,pOVar10);
    if (((pscan->pt).x == (lpord->pt).x) && ((pscan->pt).y == (pOVar10->pt).y)) {
      sVar9 = 0;
    }
    else if ((sel.iwpAct < sel.fl.cord + -1) &&
            (((pscan->pt).x == ((pOVar10 + 1)->pt).x && ((pscan->pt).y == pOVar10[1].pt.y)))) {
      sVar9 = 0;
    }
    else {
      hdc = GetDC(hwndScanner);
      DrawShipScanPath(hdc,0);
      if ((uint)((PLORD *)sel.fl.lpplord)->iordMax == sel.fl.cord) {
        sel.fl.lpplord =
             (PLORD *)LpplReAlloc((PL *)sel.fl.lpplord,sel.fl.cord + 3);
        lpord = (ORDER *)CONCAT22((int)((ulong)sel.fl.lpplord >> 0x10),
                                  (ORDER *)((int)(PL *)sel.fl.lpplord +
                                           (sel.iwpAct + 1) * 0x12 + 4));
      }
      else {
        lpord = (ORDER *)CONCAT22(lpord._2_2_,(ORDER *)lpord + 1);
      }
      if (sel.iwpAct != sel.fl.cord + -1) {
        __fmemmove((ORDER *)CONCAT22(lpord._2_2_,(ORDER *)lpord + 1),lpord,
                           ((sel.fl.cord - sel.iwpAct) + -1) * 0x12);
      }
      pOVar10 = (ORDER *)lpord + -1;
      pOVar12 = (ORDER *)lpord;
      for (iVar7 = 9; iVar7 != 0; iVar7 = iVar7 + -1) {
        pOVar3 = pOVar12;
        pOVar12 = (ORDER *)&(pOVar12->pt).y;
        pOVar2 = pOVar10;
        pOVar10 = (ORDER *)&(pOVar10->pt).y;
        (pOVar3->pt).x = (pOVar2->pt).x;
      }
      sVar9 = (pscan->pt).y;
      (lpord->pt).x = (pscan->pt).x;
      (((ORDER *)lpord)->pt).y = sVar9;
      GVar4 = pscan->grobj;
      if (GVar4 == grobjPlanet) {
        id = pscan->idpl;
      }
      else if (GVar4 == grobjFleet) {
        id = ((FLEET **)rglpfl)[pscan->ifl]->id;
      }
      else if (GVar4 == grobjOther) {
        id = pscan->iwp;
      }
      else if (GVar4 == grobjThing) {
        id = ((THING *)lpThings + pscan->ith)->idFull;
      }
      ((ORDER *)lpord)->id = id;
      ((ORDER *)lpord)->wFlags =
           ((ORDER *)lpord)->wFlags & 0xf0ffU |
           (pscan->grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 8;
      sel.fl.cord = sel.fl.cord + 1;
      pbVar1 = &((PLORD *)sel.fl.lpplord)->iordMac;
      *pbVar1 = *pbVar1 + 1;
      uVar8 = IWarpBestForWaypoint(&sel.fl,lpord);
      uVar13 = (undefined2)((ulong)lpord >> 0x10);
      ((ORDER *)lpord)->wFlags = ((ORDER *)lpord)->wFlags & 0xff0fU | (uVar8 & 0xf) << 4;
      pscan->grobj = grobjOther;
      pscan->grobjFull = pscan->grobjFull | grobjOther;
      pscan->iwp = sel.iwpAct + 1;
      RedrawScanSel(0,0);
      FLookupFleet(-1,(FLEET *)&sel.fl);
      uVar13 = (undefined2)((ulong)lpord >> 0x10);
      pOVar10 = (ORDER *)lpord;
      if (((pOVar10[-1].wFlags & 0xfU) == 6) && ((&pOVar10[-1].txp)->rgia[0].wFlags == 5)) {
        __fmemset((TASKXPORT *)CONCAT22(uVar13,&pOVar10[-1].txp),0,10);
        uVar13 = (undefined2)((ulong)lpord >> 0x10);
        ((ORDER *)lpord)[-1].wFlags = ((ORDER *)lpord)[-1].wFlags & 0xfff0;
        FLookupFleet(-1,(FLEET *)&sel.fl);
      }
      ChangeScanSel(pscan,1);
      ReleaseDC(hwndScanner,hdc);
      if ((grbitScan & 0x80) != 0) {
        for (ipt = 0; ipt < cpt; ipt = ipt + 1) {
          LogicalToScan(&rgpt + ipt);
        }
        BoundPoints((RECT *)&rc,&rgpt,cpt);
        InvalidateRect(hwndScanner,(RECT *)(RECT *)&rc,0);
      }
      sVar9 = 1;
    }
  }
  return sVar9;
}



// ======================================================================
// Function: IWarpBestForWaypoint
// Address: 1058:7a18
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10587e7e) */
/* WARNING: Removing unreachable block (ram,0x10587d6c) */
/* WARNING: Removing unreachable block (ram,0x10587f25) */

short IWarpBestForWaypoint(FLEET *lpfl,ORDER *lpord)

{
  POINT pt;
  POINT ptSrc;
  POINT ptDst;
  PLANET *pPVar1;
  short sVar2;
  int iVar3;
  ORDER *pOVar4;
  FLEET *pFVar5;
  int iVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar7;
  undefined2 uVar8;
  ulong uVar9;
  long lVar10;
  HULDEF *pHVar11;
  long lVar12;
  undefined2 uVar13;
  undefined2 uVar14;
  undefined2 uVar15;
  undefined2 uVar16;
  undefined2 in_stack_0000ffcc;
  undefined2 in_stack_0000ffce;
  SCAN scan;
  short iWarpOld;
  undefined4 i;
  short iWarpSav;
  short iWarpAi;
  short fGoFlatOut;
  short fGoFlatOutAi;
  short cSpeed;
  short lDist;
  short iwp;
  short cTravel;
  short iWarp;
  undefined4 lFuel;
  
  uVar7 = (undefined2)((ulong)lpord >> 0x10);
  pOVar4 = (ORDER *)lpord;
  iWarpSav = (uint)pOVar4->wFlags >> 4 & 0xf;
  iWarp = IFindIdealWarp((FLEET *)0x0,0);
  if (fAi != 0) {
    iWarpAi = IFindIdealWarp((FLEET *)0x0,1);
  }
  lVar12 = CONCAT22(in_stack_0000ffce,in_stack_0000ffcc);
  uVar8 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar5 = (FLEET *)lpfl;
  iVar6 = pFVar5->cord;
  do {
    iwp = iVar6 + -1;
    if (iwp < 0) break;
    uVar13 = *(undefined2 *)((int)&pFVar5->lpplord + 2);
    pPVar1 = (PLANET *)(*(int *)&pFVar5->lpplord + 4);
    i = (PLANET *)CONCAT22(uVar13,pPVar1);
    iVar3 = iVar6 * 0x12;
    iVar6 = iwp;
  } while (lpord != (ORDER *)CONCAT22(uVar13,(ORDER *)(pPVar1->rgpctMinLevel + iVar3 + -0x18)));
  if (iwp < 1) {
    return iWarp;
  }
  if (((pOVar4->wFlags & 0xfU) == 2) || ((pOVar4->wFlags & 0xfU) == 5)) {
    fGoFlatOut = 1;
  }
  else {
    fGoFlatOut = 0;
    i = (PLANET *)((ulong)i & 0xffff0000);
    while ((int)(PLANET *)i < 0x10) {
      if (0 < pFVar5->rgcsh[(int)(PLANET *)i]) {
        i = (PLANET *)((ulong)i & 0xffff);
        while( true ) {
          iVar6 = pFVar5->iPlayer * 4;
          if ((int)(uint)*(byte *)(*(int *)(iVar6 + 0xfe) + (int)(PLANET *)i * 0x93 + 0x7a) <=
              i._2_2_) break;
          iVar6 = pFVar5->iPlayer * 4;
          if ((*(int *)(*(int *)(iVar6 + 0xfe) + (int)(PLANET *)i * 0x93 + 0x3a + i._2_2_ * 4) ==
               0x1000) &&
             ((iVar6 = pFVar5->iPlayer * 4,
              (*(uint *)(*(int *)(iVar6 + 0xfe) + (int)(PLANET *)i * 0x93 + i._2_2_ * 4 + 0x3c) &
              0xff) == 0 ||
              (iVar6 = pFVar5->iPlayer * 4,
              (*(uint *)(*(int *)(iVar6 + 0xfe) + (int)(PLANET *)i * 0x93 + i._2_2_ * 4 + 0x3c) &
              0xff) == 1)))) {
            fGoFlatOut = 1;
            break;
          }
          i = (PLANET *)CONCAT22(i._2_2_ + 1,(PLANET *)i);
        }
      }
      i = (PLANET *)CONCAT22(i._2_2_,(PLANET *)((int)&((PLANET *)i)->id + 1));
    }
  }
  if ((fGoFlatOut == 0) && (fAi != 0)) {
    fGoFlatOutAi = 1;
    fGoFlatOut = 1;
  }
  else {
    fGoFlatOutAi = 0;
  }
  if (iWarp < 9) {
    iWarpOld = iWarp;
    pt.y = (pOVar4->pt).y;
    pt.x = (lpord->pt).x;
    sVar2 = FFindNearestObject(pt,0x81,&scan);
    if (sVar2 == 0) {
      i = (PLANET *)0x0;
    }
    else {
      i = LpplFromId(scan.idpl);
    }
    lVar12 = CONCAT22(in_stack_0000ffce,in_stack_0000ffcc);
    if ((fGoFlatOut == 0) &&
       ((((PLANET *)i == (PLANET *)0x0 && (i._2_2_ == 0)) ||
        ((((PLANET *)i)->iPlayer != -1 && (((PLANET *)i)->iPlayer != idPlayer)))))) {
      if (((1 < iwp) && ((uint)iWarp < ((uint)pOVar4[-1].wFlags >> 4 & 0xf))) &&
         (((uint)pOVar4[-1].wFlags >> 4 & 0xf) < 0xb)) {
        iWarp = (uint)pOVar4[-1].wFlags >> 4 & 0xf;
      }
      lVar12 = LFuelUseToWaypoint(lpfl,iwp,1);
      uVar15 = 0;
      uVar13 = 10;
      lVar10 = LGetFleetStat(lpfl,1);
      lVar10 = __aFldiv(lVar10,CONCAT22(uVar15,uVar13));
      if (lVar12 < lVar10) {
        uVar16 = 0;
        uVar14 = 10;
        uVar15 = 0;
        uVar13 = 7;
        uVar9 = LGetFleetStat(lpfl,1);
        uVar9 = __aFulmul(uVar9,CONCAT22(uVar15,uVar13));
        lVar10 = __aFldiv(uVar9,CONCAT22(uVar16,uVar14));
        iVar3 = (int)((ulong)lVar10 >> 0x10);
        iVar6 = *(int *)((int)pFVar5->rgwtMin + 0x12);
        if ((iVar3 <= iVar6) &&
           ((iVar3 < iVar6 || ((uint)lVar10 <= *(uint *)(pFVar5->rgwtMin + 4))))) {
          iWarp = iWarp + 1;
          goto SCAN_LTryLimitedSpeed;
        }
      }
      goto SCAN_LOptimizeSpeed;
    }
    if ((fGoFlatOutAi != 0) &&
       (((((PLANET *)i != (PLANET *)0x0 || (i._2_2_ != 0)) &&
         (((PLANET *)i)->iPlayer == idPlayer)) &&
        (*(int *)(*(int *)(idPlayer * 4 + 0x14c) +
                 (*(uint *)&((PLANET *)i)->field11_0x2c & 0xf) * 0x93) != 0x20)))) {
      fGoFlatOutAi = 0;
    }
    iWarp = 9;
SCAN_LTryLimitedSpeed:
    lVar10 = CONCAT22(lFuel._2_2_,(undefined2)lFuel);
    for (; lFuel = lVar10, iWarpOld < iWarp; iWarp = iWarp + -1) {
      pOVar4->wFlags = pOVar4->wFlags & 0xff0fU | (iWarp & 0xfU) << 4;
      lVar10 = LFuelUseToWaypoint(lpfl,iwp,1);
      if (lVar10 <= CONCAT22(*(undefined2 *)((int)pFVar5->rgwtMin + 0x12),(int)pFVar5->rgwtMin[4]))
      {
        if (((((PLANET *)i != (PLANET *)0x0) || (i._2_2_ != 0)) &&
            (((uint)((PLANET *)i)->wFlags >> 9 & 1) != 0)) &&
           (((PLANET *)i)->iPlayer == idPlayer)) {
          lFuel = lVar10;
          pHVar11 = LphuldefFromId
                              (*(HullDef *)
                                (*(int *)(idPlayer * 4 + 0x14c) +
                                (*(uint *)&((PLANET *)i)->field11_0x2c & 0xf) * 0x93));
          lVar10 = lFuel;
          if ((((HULDEF *)pHVar11)->hul).wtCargoMax != 0) break;
        }
        lFuel = lVar10;
        lVar10 = __aFldiv(CONCAT22(*(undefined2 *)((int)pFVar5->rgwtMin + 0x12),
                                           (int)pFVar5->rgwtMin[4]),2);
        if ((lFuel <= lVar10) || (lVar10 = lFuel, fGoFlatOut != 0)) break;
      }
    }
    pOVar4->wFlags = pOVar4->wFlags & 0xff0fU | (iWarpSav & 0xfU) << 4;
  }
  if ((fGoFlatOutAi != 0) && (iWarpAi < iWarp)) {
    iWarp = iWarpAi;
  }
SCAN_LOptimizeSpeed:
  if ((iWarp < 2) || (((uint)pOVar4->wFlags >> 8 & 0xf) == 2)) {
    cTravel = 2;
  }
  else {
    DGetDistance((lpord->pt).x,(pOVar4->pt).y,((pOVar4 + -1)->pt).x,pOVar4[-1].pt.y);
    lVar12 = __ftol((double)CONCAT26((int)((ulong)lVar12 >> 0x10),
                                             CONCAT24((int)lVar12,CONCAT22(unaff_SI,unaff_DI))));
    lDist = (short)lVar12;
    cSpeed = iWarp * iWarp;
    cTravel = (cSpeed + lDist + -1) / cSpeed;
    iVar6 = iWarp;
    do {
      iWarp = iVar6;
      iVar6 = iWarp + -1;
      if (iVar6 < 2) break;
      cSpeed = iVar6 * iVar6;
    } while (cTravel == (lDist + cSpeed + -1) / cSpeed);
  }
  ptSrc.y = pOVar4[-1].pt.y;
  ptSrc.x = ((pOVar4 + -1)->pt).x;
  ptDst.y = (pOVar4->pt).y;
  ptDst.x = (lpord->pt).x;
  sVar2 = FCanFleetUseStargates(lpfl,ptSrc,ptDst);
  if (sVar2 == 1) {
    iWarp = 0xb;
  }
  if (0xb < iWarp) {
    iWarp = 9;
  }
  return iWarp;
}



// ======================================================================
// Function: FNearAWayPoint
// Address: 1058:8074
// Segment: MEMORY_SCAN
// ======================================================================


short FNearAWayPoint(POINT pt,short fLogical)

{
  short sVar1;
  uint uVar2;
  undefined2 uVar3;
  SCAN scan;
  short i;
  ORDER *lpord;
  
  if (sel.grobj == grobjFleet) {
    if (fLogical == 0) {
      ScanToLogical(&pt);
    }
    sVar1 = FFindNearestObject(pt,0x4f,&scan);
    if (sVar1 == 0) {
      uVar2 = 0;
    }
    else if ((scan.grobjFull & grobjOther) == grobjNone) {
      uVar2 = 0;
    }
    else if ((scan.pt.x == sel.pt.x) && (scan.pt.y == sel.pt.y)) {
      lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,
                                &((PLORD *)sel.fl.lpplord)[5].iordMax);
      for (i = 1; i < sel.fl.cord; i = i + 1) {
        uVar3 = (undefined2)((ulong)lpord >> 0x10);
        if (((lpord->pt).x == scan.pt.x) && ((((ORDER *)lpord)->pt).y == scan.pt.y)) break;
        lpord = (ORDER *)CONCAT22(uVar3,(ORDER *)lpord + 1);
      }
      uVar2 = (uint)(i != sel.fl.cord);
    }
    else {
      uVar2 = 1;
    }
  }
  else {
    uVar2 = 0;
  }
  return uVar2;
}



// ======================================================================
// Function: FHandleWayPointDrag
// Address: 1058:8176
// Segment: MEMORY_SCAN
// ======================================================================


short FHandleWayPointDrag(POINT pt)

{
  POINT pt_00;
  POINT pt_01;
  short sVar1;
  uint uVar2;
  int iVar3;
  char *sz;
  uint uVar4;
  HDC hdc_00;
  ORDER *pOVar5;
  uint *puVar6;
  short *psVar7;
  undefined2 uVar8;
  undefined2 unaff_SS;
  char *mbType;
  HDC hdc;
  RECT rc;
  short fFirst;
  SCAN scan;
  uint ptPrev;
  uint local_6e;
  short cpt;
  POINT ptNew;
  POINT rgpt;
  uint local_62;
  uint local_60;
  uint local_5e;
  uint local_5c;
  short local_5a;
  short local_58;
  short fDel;
  short ptNext;
  short local_52;
  POINT ptLogical;
  short i;
  ORDER *lpord;
  HCURSOR hcurSav;
  short grTypeIn;
  short fDup;
  char szDeepSpace [40];
  short fMarker;
  SBAR sbar;
  HPEN hpenSav;
  HDC hdc__8;
  short fChg;
  
  fFirst = 1;
  fMarker = 0;
  LogicalToScan(&pt);
  if (sel.iwpAct == 0) {
    lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,
                              &((PLORD *)sel.fl.lpplord)[5].iordMax);
    for (i = 1; i < sel.fl.cord; i = i + 1) {
      uVar8 = (undefined2)((ulong)lpord >> 0x10);
      if ((sel.fl.pt.x == (lpord->pt).x) &&
         (sel.fl.pt.y == (((ORDER *)lpord)->pt).y)) break;
      lpord = (ORDER *)CONCAT22(uVar8,(ORDER *)lpord + 1);
    }
    SetScanWp(i);
  }
  puVar6 = (uint *)((int)(PLORD *)sel.fl.lpplord + (sel.iwpAct + -1) * 0x12 + 4)
  ;
  ptPrev = *puVar6;
  local_6e = puVar6[1];
  if (sel.iwpAct == sel.fl.cord + -1) {
    cpt = 3;
  }
  else {
    cpt = 4;
    psVar7 = (short *)((int)(PLORD *)sel.fl.lpplord +
                      (sel.iwpAct + 1) * 0x12 + 4);
    local_5a = *psVar7;
    local_58 = psVar7[1];
    ptNext = local_5a;
    local_52 = local_58;
  }
  puVar6 = (uint *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
  rgpt.x = *puVar6;
  rgpt.y = puVar6[1];
  local_62 = rgpt.x;
  local_60 = rgpt.y;
  local_5e = ptPrev;
  local_5c = local_6e;
  for (i = 0; i < cpt; i = i + 1) {
    LogicalToScan(&rgpt + i);
  }
  GetClientRect(hwndScanner,(RECT *)&rc);
  rc.bottom = rc.bottom - dySBar;
  hdc__8 = GetDC(hwndScanner);
  hcurSav = setcursor(hcurCloseGrab);
  SetCapture(hwndScanner);
  ptNew.x = pt.x;
  ptNew.y = pt.y;
  while (sVar1 = FGetMouseMove(&ptNew), sVar1 != 0) {
    uVar4 = rc.right;
    if (ptNew.x <= rc.right) {
      uVar4 = ptNew.x;
    }
    if (uVar4 < 0x8000) {
      uVar4 = rc.right;
      if (ptNew.x <= rc.right) {
        uVar4 = ptNew.x;
      }
    }
    else {
      uVar4 = 0;
    }
    uVar2 = rc.bottom;
    if (ptNew.y <= rc.bottom) {
      uVar2 = ptNew.y;
    }
    if (uVar2 < 0x8000) {
      uVar2 = rc.bottom;
      if (ptNew.y <= rc.bottom) {
        uVar2 = ptNew.y;
      }
    }
    else {
      uVar2 = 0;
    }
    ptNew.x = uVar4;
    ptNew.y = uVar2;
    if ((pt.x != uVar4) || (pt.y != uVar2)) {
      if ((fFirst == 0) ||
         (pt_01.y = uVar2, pt_01.x = uVar4, sVar1 = FNearAWayPoint(pt_01,0), sVar1 == 0)) {
        fFirst = 0;
        ptLogical.x = ptNew.x;
        ptLogical.y = ptNew.y;
        ScanToLogical(&ptLogical);
        uVar4 = GetAsyncKeyState(0x10);
        if ((uVar4 & 0xfffe) == 0) {
          grTypeIn = 0x4f;
        }
        else {
          grTypeIn = 0x8f;
        }
        pt_00.y = ptLogical.y;
        pt_00.x = ptLogical.x;
        FFindNearestObject(pt_00,grTypeIn,&scan);
        DrawScanXorLines(hdc__8,&rgpt,cpt);
        if (scan.grobj == grobjNone) {
          rgpt.x = ptLogical.x;
          rgpt.y = ptLogical.y;
          sbar.id = -1;
          CchGetString(idsDeepSpace,szDeepSpace);
          sbar.psz = szDeepSpace;
        }
        else {
          rgpt.x = scan.pt.x;
          rgpt.y = scan.pt.y;
          if (scan.grobj == grobjPlanet) {
            sbar.id = scan.idpl;
          }
          else if (scan.grobj == grobjFleet) {
            sbar.id = ((FLEET **)rglpfl)[scan.ifl]->id;
          }
          else if (scan.grobj == grobjThing) {
            sbar.id = ((THING *)lpThings + scan.ith)->idFull;
          }
          else {
            sbar.id = scan.iwp;
          }
          sbar.psz = (char *)0x0;
        }
        sbar.pt.x = rgpt.x;
        sbar.pt.y = rgpt.y;
        sbar.grbit = scan.grobj;
        LogicalToScan(&rgpt);
        DrawScanXorLines(hdc__8,&rgpt,cpt);
        sbar.pscan = (SCAN *)0x0;
        DrawScannerSBar(hdc__8,(RECT *)0x0,&sbar,0);
      }
      pt.y = ptNew.y;
      pt.x = ptNew.x;
    }
  }
  if ((rgpt.x == local_62) && (rgpt.y == local_60)) {
    fChg = 0;
  }
  else {
    fChg = 1;
  }
  if (fChg != 0) {
    if (scan.grobj == grobjNone) {
      scan.pt.x = ptLogical.x;
      scan.pt.y = ptLogical.y;
      scan.grobj = grobjOther;
      scan.iwp = sel.iwpAct;
    }
    if ((scan.pt.x == ptPrev) && (scan.pt.y == local_6e)) {
      fDup = 1;
    }
    else {
      fDup = 0;
    }
    if ((fDup == 0) && (sel.iwpAct < sel.fl.cord + -1)) {
      puVar6 = (uint *)((int)(PLORD *)sel.fl.lpplord +
                       (sel.iwpAct + 1) * 0x12 + 4);
      if ((scan.pt.x == *puVar6) && (scan.pt.y == puVar6[1])) {
        iVar3 = 1;
      }
      else {
        iVar3 = 0;
      }
      fDup = iVar3 << 1;
    }
    GetClientRect(hwndScanner,(RECT *)&rc);
    if (fDup != 0) {
      mbType = (char *)s_M6102__MATH___floating_point_err_1120_2022 + 2;
      sz = PszFormatIds(idsSureWantDeleteCurrentWaypoint,(short *)0x0);
      sVar1 = AlertSz(sz,(short)mbType);
      fDel = (short)(sVar1 == 6);
      if ((grbitScan & 0x80) != 0) {
        hpenSav = SelectObject(hdc__8,hpenStarbase);
        MoveTo(hdc__8,local_5e,local_5c);
        LineTo(hdc__8,rgpt.x,rgpt.y);
        if (3 < cpt) {
          ExcludeClipRect(hdc__8,0,rc.bottom - dySBar,rc.right,rc.bottom);
          LineTo(hdc__8,local_5a,local_58);
        }
        SelectObject(hdc__8,hpenSav);
      }
      DrawScanXorLines(hdc__8,&rgpt,cpt);
      rgpt.x = local_62;
      rgpt.y = local_60;
      if ((grbitScan & 0x80) != 0) {
        hpenSav = SelectObject(hdc__8,hpenStarbase);
        MoveTo(hdc__8,local_5e,local_5c);
        LineTo(hdc__8,rgpt.x,rgpt.y);
        if (3 < cpt) {
          ExcludeClipRect(hdc__8,0,rc.bottom - dySBar,rc.right,rc.bottom);
          LineTo(hdc__8,local_5a,local_58);
        }
        SelectObject(hdc__8,hpenSav);
      }
      DrawScanXorLines(hdc__8,&rgpt,cpt);
      if (fDel != 0) {
        DeleteCurWayPoint((uint)(fDup == 1));
      }
      goto SCAN_Done_5;
    }
    if ((grbitScan & 0x80) != 0) {
      ExcludeClipRect(hdc__8,0,rc.bottom - dySBar,rc.right,rc.bottom);
      hpenSav = SelectObject(hdc__8,hpenStarbase);
      MoveTo(hdc__8,local_5e,local_5c);
      LineTo(hdc__8,rgpt.x,rgpt.y);
      if (3 < cpt) {
        LineTo(hdc__8,local_5a,local_58);
      }
      SelectObject(hdc__8,hpenSav);
    }
    DrawScanXorLines(hdc__8,&rgpt,cpt);
    rgpt.x = local_62;
    rgpt.y = local_60;
    if ((grbitScan & 0x80) != 0) {
      ExcludeClipRect(hdc__8,0,rc.bottom - dySBar,rc.right,rc.bottom);
      hpenSav = SelectObject(hdc__8,hpenStarbase);
      MoveTo(hdc__8,local_5e,local_5c);
      LineTo(hdc__8,rgpt.x,rgpt.y);
      if (3 < cpt) {
        LineTo(hdc__8,local_5a,local_58);
      }
      SelectObject(hdc__8,hpenSav);
    }
    DrawScanXorLines(hdc__8,&rgpt,cpt);
    RedrawScanSel(0,0);
    uVar8 = sel.fl.lpplord._2_2_;
    if (scan.grobj == grobjPlanet) {
      i = scan.idpl;
    }
    else if (scan.grobj == grobjFleet) {
      i = ((FLEET **)rglpfl)[scan.ifl]->id;
    }
    else if (scan.grobj == grobjThing) {
      i = ((THING *)lpThings + scan.ith)->idFull;
    }
    else {
      i = scan.iwp;
    }
    pOVar5 = (ORDER *)((int)(PLORD *)sel.fl.lpplord + sel.iwpAct * 0x12 + 4);
    lpord = (ORDER *)CONCAT22(sel.fl.lpplord._2_2_,pOVar5);
    pOVar5->wFlags =
         pOVar5->wFlags & 0xf0ffU |
         (scan.grobj & (grobjThing|grobjOther|grobjFleet|grobjPlanet)) << 8;
    pOVar5->id = i;
    (lpord->pt).x = scan.pt.x;
    (pOVar5->pt).y = scan.pt.y;
    uVar4 = IWarpBestForWaypoint(&sel.fl,(ORDER *)CONCAT22(uVar8,pOVar5));
    uVar8 = (undefined2)((ulong)lpord >> 0x10);
    ((ORDER *)lpord)->wFlags = ((ORDER *)lpord)->wFlags & 0xff0fU | (uVar4 & 0xf) << 4;
    FLookupFleet(-1,(FLEET *)&sel.fl);
    scan.iwp = sel.iwpAct;
    scan.grobjFull = scan.grobjFull | grobjOther;
    sel.iwpAct = -2;
    ChangeScanSel(&scan,1);
  }
  DrawScannerSBar(hdc__8,(RECT *)0x0,(SBAR *)0x0,0);
  ReleaseCapture();
  setcursor(hcurSav);
  InvalidateRect(hwndMine,(RECT *)0x0,1);
  SetMineralTitleBar(hwndMine);
SCAN_Done_5:
  ReleaseDC(hwndScanner,hdc__8);
  if ((fChg != 0) && ((grbitScan & 0x80) != 0)) {
    local_62 = ptNew.x;
    local_60 = ptNew.y;
    BoundPoints(&rc,&rgpt,cpt);
    hdc_00 = GetDC(hwndScanner);
    DrawScanner(hdc_00,&rc);
    ReleaseDC(hwndScanner,hdc_00);
  }
  return fChg;
}



// ======================================================================
// Function: DrawScanXorLines
// Address: 1058:8af6
// Segment: MEMORY_SCAN
// ======================================================================


void DrawScanXorLines(HDC hdc,POINT *rgpt,short cpt)

{
  undefined2 unaff_SS;
  RECT rc;
  short i;
  short iRopSav;
  HPEN hpenSav;
  
  GetClientRect(hwndScanner,(RECT *)&rc);
  ExcludeClipRect(hdc,0,rc.bottom - dySBar,rc.right,rc.bottom);
  if (((cpt == 4) && ((rgpt + 2)->x == (rgpt + 3)->x)) && (rgpt[2].y == rgpt[3].y)) {
    cpt = 3;
    hpenSav = GetStockObject(6);
  }
  else {
    hpenSav = hpenShip;
  }
  for (i = 1; i < cpt; i = i + 1) {
    ExcludeClipRect(hdc,(rgpt + i)->x + -5,rgpt[i].y + -5,(rgpt + i)->x + 6,rgpt[i].y + 6);
  }
  hpenSav = SelectObject(hdc,hpenSav);
  iRopSav = SetROP2(hdc,7);
  MoveTo(hdc,(rgpt + 2)->x,rgpt[2].y);
  LineTo(hdc,rgpt->x,rgpt->y);
  if (3 < cpt) {
    LineTo(hdc,(rgpt + 3)->x,rgpt[3].y);
  }
  SetROP2(hdc,iRopSav);
  SelectObject(hdc,hpenSav);
  SelectClipRgn(hdc,hrgnHuge);
  return;
}



// ======================================================================
// Function: SetScanWp
// Address: 1058:8c5a
// Segment: MEMORY_SCAN
// ======================================================================


short SetScanWp(short iNew)

{
  short *psVar1;
  POINT pt;
  SCAN scan;
  
  if (iNew != sel.iwpAct) {
    psVar1 = (short *)((int)(PLORD *)sel.fl.lpplord + iNew * 0x12 + 4);
    pt.y = psVar1[1];
    pt.x = *psVar1;
    FFindNearestObject(pt,grobjOther,&scan);
    scan.iwp = iNew;
    ChangeScanSel(&scan,1);
  }
  return iNew;
}



// ======================================================================
// Function: ChangeScanSel
// Address: 1058:8cc4
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: iRad */

void ChangeScanSel(SCAN *pscan,short fValidScan)

{
  SCAN *pSVar1;
  short *psVar2;
  POINT pt;
  POINT pt_00;
  short sVar3;
  int iVar4;
  HDC hdc;
  int iVar5;
  undefined2 unaff_SI;
  SCAN *pSVar6;
  undefined2 unaff_DI;
  short *psVar7;
  undefined2 unaff_SS;
  long lVar8;
  short iRad;
  short fChgWp;
  undefined8 rcMine;
  short fMineFieldSel;
  
  if (fValidScan == 0) {
    pt.y = (pscan->pt).y;
    pt.x = (pscan->pt).x;
    FFindNearestObject(pt,pscan->grobj,pscan);
  }
  sVar3 = _memcmp(pscan,(void *)&sel.scan,0x10);
  if (sVar3 != 0) {
    if ((pscan->iwp == -1) || (pscan->iwp == sel.iwpAct)) {
      iVar4 = 0;
    }
    else {
      iVar4 = 1;
    }
    if ((sel.scan.grobj == grobjThing) &&
       ((uint)((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0)) {
      fMineFieldSel = 1;
    }
    else {
      fMineFieldSel = 0;
    }
    if (fMineFieldSel != 0) {
      _sqrt(SUB84((double)*(long *)((THING *)lpThings)[sel.scan.ith].rgb,0)
                    ,(double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)*(long *)((
                                                  THING *)lpThings)[sel.scan.ith].
                                                  rgb >> 0x20))));
      lVar8 = __ftol((double)CONCAT26(iVar4,CONCAT24(iRad,CONCAT22(unaff_SI,unaff_DI))));
      iRad = (short)lVar8;
      rcMine._0_2_ = (&((THING *)lpThings)[sel.scan.ith].pt)->x;
      rcMine._2_2_ = ((THING *)lpThings)[sel.scan.ith].pt.y;
      rcMine._4_2_ = (int)rcMine + iRad;
      rcMine._6_2_ = rcMine._2_2_ - iRad;
      rcMine._0_2_ = (int)rcMine - iRad;
      rcMine._2_2_ = rcMine._2_2_ + iRad;
      LogicalToScan((POINT *)&rcMine);
      LogicalToScan((POINT *)((int)&rcMine + 4));
      InflateRect((RECT *)(RECT *)&rcMine,1,1);
    }
    RedrawScanSel(0,-1);
    psVar7 = (short *)&sel.scan;
    pSVar6 = pscan;
    for (iVar5 = 8; iVar5 != 0; iVar5 = iVar5 + -1) {
      psVar2 = psVar7;
      psVar7 = psVar7 + 1;
      pSVar1 = pSVar6;
      pSVar6 = (SCAN *)&(pSVar6->pt).y;
      *psVar2 = (pSVar1->pt).x;
    }
    if (((sel.scan.grobjFull & grobjPlanet) != grobjNone) && (fValidScan != 2)) {
      sel.scan.grobj = grobjPlanet;
    }
    if (iVar4 != 0) {
      sel.iwpAct = pscan->iwp;
      FillOrdersLB();
      SetOrdersLbSel(pscan->iwp);
      UpdateOrdersDDs(0);
      DrawPlanShip(0,0x122);
    }
    RedrawScanSel(0,1);
    if (iVar4 != 0) {
      pt_00.y = (pscan->pt).y;
      pt_00.x = (pscan->pt).x;
      FEnsurePointOnScreen(pt_00,1);
    }
    DrawScannerSBar(0,(RECT *)0x0,(SBAR *)0x0,0);
    InvalidateRect(hwndMine,(RECT *)0x0,1);
    SetMineralTitleBar(hwndMine);
    if (fMineFieldSel != 0) {
      iRad = GetDC(hwndScanner);
      DrawScanner(iRad,(RECT *)&rcMine);
      ReleaseDC(hwndScanner,iRad);
    }
    if ((sel.scan.grobj == grobjThing) &&
       ((uint)((THING *)lpThings + sel.scan.ith)->idFull >> 0xd == 0)) {
      fMineFieldSel = 1;
    }
    else {
      fMineFieldSel = 0;
    }
    if (fMineFieldSel != 0) {
      _sqrt(SUB84((double)*(long *)((THING *)lpThings)[sel.scan.ith].rgb,0)
                    ,(double)CONCAT26(iRad,CONCAT24(unaff_SI,(long)((qword)(double)*(long *)((THING 
                                                  *)lpThings)[sel.scan.ith].rgb >>
                                                  0x20))));
      lVar8 = __ftol((double)CONCAT26((int)rcMine,CONCAT24(iVar4,CONCAT22(iRad,unaff_SI))));
      iVar4 = (int)lVar8;
      rcMine._0_2_ = (&((THING *)lpThings)[sel.scan.ith].pt)->x;
      rcMine._2_2_ = ((THING *)lpThings)[sel.scan.ith].pt.y;
      rcMine._4_2_ = (int)rcMine + iVar4;
      rcMine._6_2_ = rcMine._2_2_ - iVar4;
      rcMine._0_2_ = (int)rcMine - iVar4;
      rcMine._2_2_ = rcMine._2_2_ + iVar4;
      LogicalToScan((POINT *)&rcMine);
      LogicalToScan((POINT *)((int)&rcMine + 4));
      InflateRect((RECT *)(RECT *)&rcMine,1,1);
    }
    if (fMineFieldSel != 0) {
      hdc = GetDC(hwndScanner);
      DrawScanner(hdc,(RECT *)&rcMine);
      ReleaseDC(hwndScanner,hdc);
    }
    if (sel.pl.id != -1) {
      DrawPlanShip(0,0x4002);
    }
    if ((((uint)gd._0_2_ >> 0xb & 1) != 0) && (idPlayer == 0)) {
      AdvanceTutor();
    }
  }
  return;
}



// ======================================================================
// Function: FGetNextObjHere
// Address: 1058:909c
// Segment: MEMORY_SCAN
// ======================================================================


short FGetNextObjHere(SCAN *pscan,short fOnlyOurs)

{
  FLEET *pFVar1;
  int iVar2;
  short sVar3;
  bool bVar4;
  short fFound;
  short i;
  FLEET *lpfl;
  
  bVar4 = sel.grobj != grobjFleet;
  for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[i];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    if (bVar4) {
      if (((sel.pt.x == (&pFVar1->pt)->x) && (sel.pt.y == (pFVar1->pt).y)) &&
         ((fOnlyOurs == 0 || (pFVar1->iPlayer == idPlayer)))) break;
    }
    else if (lpfl->id == sel.id) {
      bVar4 = true;
    }
  }
  if (bVar4) {
    if (i < cFleet) {
      pscan->ifl = i;
      pscan->grobj = grobjFleet;
    }
    else if (((sel.grobjFull & grobjPlanet) == grobjNone) ||
            (sel.pl.iPlayer != idPlayer)) {
      for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar1 = ((FLEET **)rglpfl)[i];
        iVar2 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
        lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
        if (((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) ||
           ((((pscan->pt).x == (&pFVar1->pt)->x && ((pscan->pt).y == (pFVar1->pt).y)) &&
            ((fOnlyOurs == 0 || (pFVar1->iPlayer == idPlayer)))))) break;
      }
      if ((cFleet <= i) || (lpfl->id == sel.id)) {
        return 0;
      }
      pscan->ifl = i;
      pscan->grobj = grobjFleet;
    }
    else {
      pscan->grobj = grobjPlanet;
      pscan->idpl = sel.pl.id;
    }
    sVar3 = 1;
  }
  else {
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: FindDlg
// Address: 1058:9286
// Segment: MEMORY_SCAN
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short FindDlg(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  short sVar1;
  char *sz;
  HWND HVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar3;
  ushort in_stack_0000ffcc;
  char szName [42];
  
  if (msg == 0x14) {
    GetClientRect(hwnd,(RECT *)(RECT *)&stack0xffcc);
    FillRect(wParam,(RECT *)(RECT *)&stack0xffcc,hbrButtonFace);
    return 1;
  }
  if (msg == 0x19) {
    uVar3 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffcc);
    if ((int)uVar3 == 6) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return hbrButtonFace;
    }
  }
  else {
    if (msg == 0x110) {
      StickyDlgPos(hwnd,(POINT *)&ptStickyFindDlg,1);
      SendDlgItemMessage(hwnd,0x10c,0x415,0x27,0);
      return 1;
    }
    if (msg == 0x111) {
      if ((wParam == 1) || (wParam == 2)) {
        if (wParam == 1) {
          GetDlgItemText(hwnd,0x10c,(LPSTR)szName,0x28);
          sVar1 = FSelectSz(szName);
          if (sVar1 == 0) {
            sVar1 = 0x10;
            sz = PszFormatIds(idsSorryCantFindPlanetFleetName,(short *)0x0);
            AlertSz(sz,sVar1);
            HVar2 = GetDlgItem(hwnd,0x10c);
            SetFocus(HVar2);
            SendDlgItemMessage(hwnd,0x10c,0x401,0,-0x10000);
            return 0;
          }
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyFindDlg,0);
        EndDialog(hwnd,(uint)(wParam == 1));
        return 1;
      }
      if (wParam == 0x76) {
        WinHelp(hwnd,(LPCSTR)_szHelpFile,1,0x43d);
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: FSelectSz
// Address: 1058:945a
// Segment: MEMORY_SCAN
// ======================================================================


short FSelectSz(char *szName)

{
  FLEET *pFVar1;
  int iVar2;
  POINT pt;
  POINT pt_00;
  POINT pt_01;
  POINT pt_02;
  ushort uVar3;
  short sVar4;
  char *pcVar5;
  undefined2 uVar6;
  char *pcVar7;
  SCAN scan;
  short iplPartial;
  char szT [20];
  short cch;
  short ipl;
  FLEET *lpfl;
  short ifl;
  char *pch;
  
  iplPartial = -1;
  scan.iwp = -1;
  for (ipl = 0; ipl < game.cPlanMax; ipl = ipl + 1) {
    pcVar7 = szName;
    pcVar5 = PszGetCompressedPlanet(((short *)rgidPlan)[ipl]);
    sVar4 = __strcmpi(pcVar5,pcVar7);
    if (sVar4 == 0) break;
    if (iplPartial == -1) {
      uVar3 = _strlen(szName);
      pcVar7 = szName;
      pcVar5 = PszGetCompressedPlanet(((short *)rgidPlan)[ipl]);
      sVar4 = __strnicmp(pcVar5,pcVar7,uVar3);
      if (sVar4 == 0) {
        iplPartial = ipl;
      }
    }
  }
  do {
    if (ipl != game.cPlanMax) {
      pt.y = *(short *)((int)&rgptPlan[0].y + ipl * 4);
      pt.x = ((POINT *)rgptPlan + ipl)->x;
      FFindNearestObject(pt,grobjPlanet,&scan);
      ChangeScanSel(&scan,1);
      pt_01.y = scan.pt.y;
      pt_01.x = scan.pt.x;
      FEnsurePointOnScreen(pt_01,1);
      UpdateWindow(hwndScanner);
      SendMessage(hwndScanner,0x102,0x76,0);
      return 1;
    }
    cch = CchGetString(idsFleet,szT);
    sVar4 = __strnicmp(szName,szT,cch);
    if (sVar4 == 0) {
      pch = szName + 6;
    }
    else {
      pch = szName;
    }
    for (; *pch == ' '; pch = pch + 1) {
    }
    if (*pch == '#') {
      pch = pch + 1;
    }
    for (; *pch == ' '; pch = pch + 1) {
    }
    if (('0' < *pch) && (*pch < ':')) {
      ifl = *pch + -0x30;
      pch = pch + 1;
      do {
        if ((((undefined *)&DAT_1120_175f)[*pch] & 4) == 0) {
          ifl = ifl - 1U | idPlayer << 9;
          lpfl = LpflFromId(ifl);
          if (((FLEET *)lpfl != (FLEET *)0x0) || ((int)((ulong)lpfl >> 0x10) != 0))
          goto SCAN_LFoundFleetId;
          break;
        }
        ifl = ifl * 10 + (int)*pch + -0x30;
        pch = pch + 1;
      } while (ifl < 0x201);
    }
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar1 = ((FLEET **)rglpfl)[ifl];
      iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
      if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
      pcVar7 = szName;
      pcVar5 = PszGetFleetName(lpfl->id);
      sVar4 = __strcmpi(pcVar5,pcVar7);
      if (sVar4 == 0) {
SCAN_LFoundFleetId:
        uVar6 = (undefined2)((ulong)lpfl >> 0x10);
        pt_00.y = (((FLEET *)lpfl)->pt).y;
        pt_00.x = (&((FLEET *)lpfl)->pt)->x;
        FFindNearestObject(pt_00,grobjFleet,&scan);
        scan.ifl = IflFromLpfl(lpfl);
        ChangeScanSel(&scan,2);
        pt_02.y = scan.pt.y;
        pt_02.x = scan.pt.x;
        FEnsurePointOnScreen(pt_02,1);
        UpdateWindow(hwndScanner);
        SendMessage(hwndScanner,0x102,0x76,0);
        return 1;
      }
    }
    if (iplPartial == -1) {
      return 0;
    }
    ipl = iplPartial;
  } while( true );
}



// ======================================================================
// Function: GetScanFleetOrientation
// Address: 1058:978c
// Segment: MEMORY_SCAN
// ======================================================================


void GetScanFleetOrientation(FLEET *lpfl,POINT *ppt,POINT *pptD)

{
  FLEET *pFVar1;
  undefined2 uVar2;
  short dx;
  short dy;
  
  uVar2 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar1 = (FLEET *)lpfl;
  if (pFVar1->iPlayer == idPlayer) {
    if ((1 < pFVar1->cord) && (((uint)((PLORD *)pFVar1->lpplord + 7)->wFlags >> 4 & 0xf) != 0)) {
      dx = *(int *)&((PLORD *)pFVar1->lpplord)[5].iordMax - (&pFVar1->pt)->x;
      dy = ((PLORD *)pFVar1->lpplord + 6)->wFlags - (pFVar1->pt).y;
      goto LAB_1058_985e;
    }
  }
  else if ((((uint)pFVar1->wFlags >> 4 & 1) != 0) && ((pFVar1->wFlags & 0xfU) != 0)) {
    dx = (*(uint *)&pFVar1->field17_0x74 & 0xff) - 0x7f;
    dy = (*(uint *)&pFVar1->field17_0x74 >> 8) - 0x7f;
    goto LAB_1058_985e;
  }
  dy = 0;
  dx = 0;
LAB_1058_985e:
  GetDxDyOrientation(dx,dy,ppt,pptD);
  return;
}



// ======================================================================
// Function: GetDxDyOrientation
// Address: 1058:987c
// Segment: MEMORY_SCAN
// ======================================================================


void GetDxDyOrientation(short dx,short dy,POINT *ppt,POINT *pptD)

{
  short sVar1;
  int iVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar3;
  long local_16;
  short iBmp;
  
  iBmp = 0;
  if ((dx != 0) || (dy != 0)) {
    local_16 = (long)dx;
    iVar2 = dy >> 0xf;
    _atan2(SUB84((double)(long)dy,0),
                   (double)CONCAT44(SUB84((double)local_16,0),
                                    (long)((qword)(double)(long)dy >> 0x20)),
                   (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)local_16 >>
                                                                     0x20))));
    lVar3 = __ftol((double)CONCAT26(iVar2,CONCAT24(dy,CONCAT22(unaff_SI,unaff_DI))));
    iBmp = 9 - ((uint)lVar3 & 7) & 7;
  }
  if (iScanZoom < 0) {
    sVar1 = 7;
  }
  else {
    sVar1 = 9;
  }
  pptD->y = sVar1;
  pptD->x = sVar1;
  if (iScanZoom < 0) {
    ppt->x = 0;
  }
  else {
    ppt->x = 7;
  }
  ppt->y = iBmp * pptD->y;
  return;
}



// ======================================================================
// Function: FHandleMeasuringTape
// Address: 1058:9974
// Segment: MEMORY_SCAN
// ======================================================================


short FHandleMeasuringTape(SCAN *pscan,POINT pt)

{
  short sVar1;
  uint uVar2;
  undefined2 unaff_SS;
  POINT pt_00;
  RECT rc;
  SCAN scan;
  short fVirgin;
  char szT [20];
  POINT ptNew;
  short iropSav;
  POINT ptBase;
  POINT ptLogical;
  short grTypeIn;
  uint ptLogLast;
  uint local_16;
  SBAR sbar;
  HPEN hpenSav;
  HDC hdc;
  
  fVirgin = 1;
  ptLogLast = (pscan->pt).x;
  local_16 = (pscan->pt).y;
  ptBase.x = (pscan->pt).x;
  ptBase.y = (pscan->pt).y;
  LogicalToScan(&ptBase);
  GetClientRect(hwndScanner,(RECT *)&rc);
  rc.bottom = rc.bottom - dySBar;
  hdc = GetDC(hwndScanner);
  SetCapture(hwndScanner);
  sbar.pscan = pscan;
  hpenSav = SelectObject(hdc,hpenShip);
  iropSav = SetROP2(hdc,7);
  ptNew.x = pt.x;
  ptNew.y = pt.y;
  LogicalToScan(&ptNew);
LAB_1058_9a11:
  do {
    sVar1 = FGetRMouseMove(&ptNew);
    if (sVar1 == 0) {
      if (fVirgin == 0) {
        MoveTo(hdc,ptBase.x,ptBase.y);
        LineTo(hdc,pt.x,pt.y);
      }
      SetROP2(hdc,iropSav);
      SelectObject(hdc,hpenSav);
      DrawScannerSBar(hdc,(RECT *)0x0,(SBAR *)0x0,0);
      ReleaseCapture();
      ReleaseDC(hwndScanner,hdc);
      return (uint)(fVirgin == 0);
    }
    uVar2 = rc.right;
    if (ptNew.x <= rc.right) {
      uVar2 = ptNew.x;
    }
    if (uVar2 < 0x8000) {
      ptLogical.x = rc.right;
      if (ptNew.x <= rc.right) {
        ptLogical.x = ptNew.x;
      }
    }
    else {
      ptLogical.x = 0;
    }
    uVar2 = rc.bottom;
    if (ptNew.y <= rc.bottom) {
      uVar2 = ptNew.y;
    }
    if (uVar2 < 0x8000) {
      ptLogical.y = rc.bottom;
      if (ptNew.y <= rc.bottom) {
        ptLogical.y = ptNew.y;
      }
    }
    else {
      ptLogical.y = 0;
    }
    ptNew.x = ptLogical.x;
    ptNew.y = ptLogical.y;
    ScanToLogical(&ptLogical);
    uVar2 = GetAsyncKeyState(0x10);
    if ((uVar2 & 0xfffe) == 0) {
      grTypeIn = 0x4f;
    }
    else {
      grTypeIn = 0x8f;
    }
    pt_00.y = ptLogical.y;
    pt_00.x = ptLogical.x;
    sVar1 = FFindNearestObject(pt_00,grTypeIn,&scan);
    if (sVar1 != 0) {
      ptLogical.x = scan.pt.x;
      ptLogical.y = scan.pt.y;
    }
  } while ((ptLogLast == ptLogical.x) && (local_16 == ptLogical.y));
  ptNew.x = ptLogical.x;
  ptNew.y = ptLogical.y;
  LogicalToScan(&ptNew);
  if (fVirgin != 0) goto LAB_1058_9b36;
  MoveTo(hdc,ptBase.x,ptBase.y);
  LineTo(hdc,pt.x,pt.y);
  goto LAB_1058_9b8b;
LAB_1058_9b36:
  sVar1 = _abs(ptLogical.x - ptLogLast);
  if ((2 < sVar1) || (sVar1 = _abs(ptLogical.y - local_16), 2 < sVar1)) {
    fVirgin = 0;
LAB_1058_9b8b:
    MoveTo(hdc,ptBase.x,ptBase.y);
    LineTo(hdc,ptNew.x,ptNew.y);
    if (scan.grobj == grobjNone) {
      sbar.id = -1;
      CchGetString(idsDeepSpace,szT);
      sbar.psz = szT;
    }
    else {
      if (scan.grobj == grobjPlanet) {
        sbar.id = scan.idpl;
      }
      else if (scan.grobj == grobjFleet) {
        sbar.id = ((FLEET **)rglpfl)[scan.ifl]->id;
      }
      else if (scan.grobj == grobjThing) {
        sbar.id = ((THING *)lpThings + scan.ith)->idFull;
      }
      else {
        sbar.id = scan.iwp;
      }
      sbar.psz = (char *)0x0;
    }
    sbar.pt.x = ptLogical.x;
    sbar.pt.y = ptLogical.y;
    sbar.grbit = scan.grobj;
    DrawScannerSBar(hdc,(RECT *)0x0,&sbar,0);
    pt.y = ptNew.y;
    pt.x = ptNew.x;
    ptLogLast = ptLogical.x;
    local_16 = ptLogical.y;
  }
  goto LAB_1058_9a11;
}



