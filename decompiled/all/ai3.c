// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
//

// ======================================================================
// Function: DoMacintiAiTurn
// Address: 10a0:0008
// Segment: MEMORY_AI3
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10a00aea) */
/* WARNING: Removing unreachable block (ram,0x10a00c33) */
/* WARNING: Removing unreachable block (ram,0x10a0117d) */
/* WARNING: Removing unreachable block (ram,0x10a00ac9) */
/* WARNING: Removing unreachable block (ram,0x10a00c12) */
/* WARNING: Removing unreachable block (ram,0x10a016a5) */
/* WARNING: Removing unreachable block (ram,0x10a0133f) */
/* WARNING: Removing unreachable block (ram,0x10a0167c) */
/* WARNING: Removing unreachable block (ram,0x10a00aef) */
/* WARNING: Removing unreachable block (ram,0x10a00c38) */
/* WARNING: Removing unreachable block (ram,0x10a00c61) */
/* WARNING: Removing unreachable block (ram,0x10a00c66) */
/* WARNING: Removing unreachable block (ram,0x10a00e6d) */
/* WARNING: Removing unreachable block (ram,0x10a00ddc) */
/* WARNING: Removing unreachable block (ram,0x10a01263) */
/* WARNING: Removing unreachable block (ram,0x10a00eb7) */
/* WARNING: Removing unreachable block (ram,0x10a01b1f) */
/* WARNING: Removing unreachable block (ram,0x10a02475) */
/* WARNING: Removing unreachable block (ram,0x10a010d6) */
/* WARNING: Removing unreachable block (ram,0x10a0111e) */
/* WARNING: Removing unreachable block (ram,0x10a012c1) */

void DoMacintiAiTurn(PROD *rgprod)

{
    uint       *puVar1;
    int        *piVar2;
    byte       *pbVar3;
    SHDEF      *pSVar4;
    undefined2 *puVar5;
    HullDef    *pHVar6;
    undefined2 *puVar7;
    int         iVar8;
    uint        uVar9;
    PLORD      *pPVar10;
    POINT       pt1;
    POINT       pt;
    POINT       pt2;
    short       sVar11;
    ushort      uVar12;
    short       sVar13;
    uint        uVar14;
    byte       *pbVar15;
    PLANET     *pPVar16;
    FLEET      *pFVar17;
    int         iVar18;
    undefined2  unaff_SI;
    SHDEF      *pSVar19;
    undefined2 *puVar20;
    undefined2  unaff_DI;
    HullDef    *pHVar21;
    undefined2 *puVar22;
    undefined2  uVar23;
    undefined2  unaff_SS;
    bool        bVar24;
    ulong       uVar25;
    ulong       uVar26;
    PLANET     *pPVar27;
    long        lVar28;
    HullDef     in_stack_0000feba;
    undefined1  local_c4[6];
    undefined1  local_be[12];
    PART        part;
    PROD       *lpprod;
    byte        rgRecycleSBShdef[10];
    short       fTonsOfMinerals;
    short       fWrite;
    long        l;
    short       iPlanet;
    FLEET      *lpflAttack;
    ushort      rgCosts[4];
    short       cFlMiners;
    short       cFlMineLayersBase;
    byte       *lpb;
    byte        rgRecycleShdef[16];
    ushort      cRecyclePeriod;
    short       iLatestColony;
    short       ipl;
    short       iLatestDestroyer;
    short       fUsingTempColonizer;
    short       iLatestMiner;
    short       iroCur;
    short       cFr;
    short       cRes;
    short       cFlArmadas;
    short       cGenesis;
    FLEET      *lpfl;
    short       i;
    short       ifl;
    short       iLatestBomber;
    short       cFlCargo;
    PLANET     *lppl;
    short       iLatestBattle;
    short       iAiLvl;
    short       cshDestroyer;
    short       cFlDestroyers;
    short       fShouldColonize;
    short       cFlMineLayers;
    THING      *lpthWorm;
    short       ishLastBattle;
    short       iLatestCruiser;
    PLANET     *lpplMac;
    long        rgResAvail[4];
    FLEET      *lpflEnemy;
    short       j;
    short       idPlanDst;
    long        rgResCost[4];
    short       cColFleet;
    short       iLatestCargo;

    uVar26 = CONCAT22(unaff_SI, unaff_DI);
    iAiLvl = *(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7;
    iroCur = IroEnsureAi(vrgAiMacintiResOrder, 8, 0, 0xf);
    if ((game.turn < 0x28) || (((rgshdef[7].wFlags >> 9 & 1) == 0 && (rgshdef[7].hul.ihuldef == ihuldefColonyShip)))) {
        fUsingTempColonizer = 1;
        sVar11 = FLookupPartX(&part, hstEngine, 0xf);
        if ((sVar11 == 1) && (((int)rgshdef[7].cExist == 0 && (rgshdef[7].cExist._2_2_ == 0)))) {
            pSVar19 = (SHDEF *)(rgshdef + 7);
            pHVar21 = &stack0xfeba;
            for (iVar18 = 0x49; iVar18 != 0; iVar18 = iVar18 + -1) {
                pHVar6 = pHVar21;
                pHVar21 = pHVar21 + 1;
                pSVar4 = pSVar19;
                pSVar19 = (pSVar19->hul).rgTech;
                *pHVar6 = (pSVar4->hul).ihuldef;
            }
            *(char *)pHVar21 = (char)(pSVar19->hul).ihuldef;
            FChangeAiShdef(&stack0xfeba, 7);
            fUsingTempColonizer = 0;
        }
    } else {
        fUsingTempColonizer = 0;
    }
    ishLastBattle = 7 - fUsingTempColonizer;
    if (fUsingTempColonizer == 0) {
        MergeAllShdefs(0x3fc);
    } else {
        MergeAllShdefs(0x37c);
    }
    MergeAllShdefs(1);
    MergeAllShdefs(-0x4000);
    MergeAllShdefs(0x3000);
    j = 6;
    if (0x82 < game.turn) {
        j = (game.turn - 0x78) / 0x14 + 6;
    }
    if (0x32 < (uint)j) {
        j = 0x32;
    }
    vrgAiArmadaPotency[0] = (byte)j;
    vrgAiArmadaPotency[1] = (byte)((ulong)(j & 0xff) / 2);
    j = 6;
    if (0x73 < game.turn) {
        j = (game.turn - 100) / 0x16 + 6;
    }
    if (0xc < (uint)j) {
        j = 0xc;
    }
    vrgAiArmadaPotency[2] = (byte)j;
    if ((int)((uint)j / 2 - 1) < 4) {
        vrgAiArmadaPotency[3] = (char)((uint)j / 2) - 1;
    } else {
        vrgAiArmadaPotency[3] = 3;
    }
    _memset(rgRecycleShdef, 0, 0x10);
    if (game.turn < 0x78) {
        cRecyclePeriod = 0x32;
    } else if (game.turn < 200) {
        cRecyclePeriod = 0x46;
    } else {
        cRecyclePeriod = 100;
    }
    cshDestroyer = CheckAiShdefStatus(0xc, 0xd, cRecyclePeriod, &iLatestDestroyer, rgRecycleShdef);
    for (i = 0xc; i < 0xe; i = i + 1) {
        if (((rgRecycleShdef[i] != 0) && ((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0)) && (*(int *)(i * 0x93 + rgshdef) == 0x1d)) {
            rgRecycleShdef[i] = 0;
        }
    }
    CheckAiShdefStatus(0xe, 0xf, 5000, &iLatestMiner, rgRecycleShdef);
    if (((rgshdef[0xf].wFlags >> 9 & 1) == 0) && (sVar11 = FLookupPartX(&part, hstMining, 6), sVar11 == 1)) {
        if (iLatestMiner == 0xe) {
            i = 0xf;
        } else {
            i = 0xe;
        }
        if ((rgshdef[0xe].hul.rghs[2].wFlags_0x2 & 0xff) == 6) {
            if ((((rgshdef[0xf].hul.rghs[2].wFlags_0x2 & 0xff) == 6) || (sVar11 = FLookupPartX(&part, hstEngine, 0xf), sVar11 != 1)) ||
                ((rgshdef[0xe].hul.rghs[0].wFlags_0x2 & 0xff) == 0xf))
                goto LAB_10a0_03c3;
            i = 0xf;
        } else {
            i = 0xe;
        }
        if ((*(int *)((int)&rgshdef[0].cExist + i * 0x93) == 0) && (*(int *)((int)&rgshdef[0].cExist + 2 + i * 0x93) == 0)) {
            puVar20 = (undefined2 *)(i * 0x93 + rgshdef);
            puVar22 = &stack0xfeba;
            for (iVar18 = 0x49; iVar18 != 0; iVar18 = iVar18 + -1) {
                puVar7 = puVar22;
                puVar22 = puVar22 + 1;
                puVar5 = puVar20;
                puVar20 = puVar20 + 1;
                *puVar7 = *puVar5;
            }
            *(undefined1 *)puVar22 = *(undefined1 *)puVar20;
            FChangeAiShdef(&stack0xfeba, i);
        } else {
            rgRecycleShdef[0xe] = 3;
        }
    }
LAB_10a0_03c3:
    CheckAiShdefStatus(10, 0xb, cRecyclePeriod, &iLatestCargo, rgRecycleShdef);
    CheckAiShdefStatus(8, 9, cRecyclePeriod, &iLatestBomber, rgRecycleShdef);
    CheckAiShdefStatus(2, 4, cRecyclePeriod, &iLatestCruiser, rgRecycleShdef);
    CheckAiShdefStatus(5, ishLastBattle, cRecyclePeriod, &iLatestBattle, rgRecycleShdef);
    if (0x50 < game.turn) {
        SplitOutShdefs(rgRecycleShdef);
        _memset(rgRecycleSBShdef, 0, 10);
        rgRecycleSBShdef[0] = 2;
        SplitOutShdefs(rgRecycleSBShdef);
        _memset(rgRecycleSBShdef, 0, 10);
        rgRecycleSBShdef[1] = 2;
        SplitOutShdefs(rgRecycleSBShdef);
        _memset(rgRecycleSBShdef, 0, 10);
        SplitOutShdefs(rgRecycleSBShdef);
        _memset(rgRecycleSBShdef, 0, 10);
        SplitOutShdefs(rgRecycleSBShdef);
    }
    EnsureMacintiShdefs();
    EnsureMacintiStarbaseDesigns(rgRecycleSBShdef);
    vAiMacRecycleSB = rgRecycleSBShdef;
    fShouldColonize = FShouldWeBuildColonizers(&cColFleet);
    if ((rgshdef[1].hul.rghs[0].wFlags_0x2 & 0xff) == 0xf) {
        iLatestColony = 1;
    } else if (((rgshdef[7].wFlags >> 9 & 1) == 0) && (rgshdef[7].hul.ihuldef == ihuldefColonyShip)) {
        iLatestColony = 7;
    } else {
        iLatestColony = 1;
    }
    if (((iLatestColony == 1) && (fUsingTempColonizer != 0)) && (5 < game.turn - rgshdef[1].turn)) {
        rgRecycleShdef[7] = 2;
    }
    lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_, (byte *)vlpbAiPlanet + 0xe);
    for (i = 0; i < game.cPlanMax; i = i + 1) {
        *lpb = 0;
        lpb = (byte *)lpb + 0x10;
    }
    cFlMiners = 0;
    cFlCargo = 0;
    cFlDestroyers = 0;
    cFlArmadas = 0;
    cFlMineLayers = 0;
    for (ifl = 0; sVar11 = cFlMineLayers, ifl < cFleet; ifl = ifl + 1) {
        /* WARNING: Load size is inaccurate */
        pFVar17 = ((FLEET **)rglpfl)[ifl];
        iVar18 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar18, pFVar17);
        if ((pFVar17 == 0) && (iVar18 == 0))
            break;
        if (pFVar17->iPlayer == idPlayer) {
            if ((iLatestMiner != -1) && ((pFVar17->rgcsh[0xe] != 0 || (pFVar17->rgcsh[0xf] != 0)))) {
                cFlMiners = cFlMiners + 1;
            }
            if (pFVar17->rgcsh[0] != 0) {
                cFlMineLayers = cFlMineLayers + 1;
            }
            if ((iLatestDestroyer != -1) && ((pFVar17->rgcsh[0xc] != 0 || (pFVar17->rgcsh[0xd] != 0)))) {
                cFlDestroyers = cFlDestroyers + 1;
            }
            if ((iLatestCargo != -1) && ((((((pFVar17->rgcsh[10] != 0 || (pFVar17->rgcsh[0xb] != 0)) && (cFlCargo = cFlCargo + 1, pFVar17->idPlanet == -1)) &&
                                            ((1 < pFVar17->cord && ((((PLORD *)pFVar17->lpplord + 7)->wFlags >> 8 & 0xf) == 1)))) &&
                                           (iVar8 = *(int *)((int)pFVar17->rgwtMin + 0xe), -1 < iVar8)) &&
                                          ((0 < iVar8 || ((int)pFVar17->rgwtMin[3] != 0)))))) {
                ((byte *)vlpbAiPlanet)[*(int *)&((PLORD *)pFVar17->lpplord)[6].iordMax * 0x10 + 0xe] =
                    ((byte *)vlpbAiPlanet)[*(int *)&((PLORD *)pFVar17->lpplord)[6].iordMax * 0x10 + 0xe] | 1;
            }
            for (i = 2; i < 10; i = i + 1) {
                if (pFVar17->rgcsh[i] != 0) {
                    cFlArmadas = cFlArmadas + 1;
                    break;
                }
            }
        }
    }
    lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_, (byte *)vlpbAiPlanet + 0xd);
    for (i = 0; i < game.cPlanMax; i = i + 1) {
        *lpb = 0;
        lpb = (byte *)lpb + 0x10;
    }
    for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
        /* WARNING: Load size is inaccurate */
        pPVar16 = ((PLANET **)vrglpplAi)[ipl];
        iVar18 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
        lppl = (PLANET *)CONCAT22(iVar18, pPVar16);
        if ((pPVar16 == 0) && (iVar18 == 0))
            break;
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 0xd] = 1;
    }
    if ((game.turn < 0x79) || (sVar13 = FLookupPartX(&part, hstPlanetary, 0xd), sVar13 != 1)) {
        cGenesis = 0;
    } else {
        cGenesis = *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) / 0x14;
        if (10 < cGenesis) {
            cGenesis = 10;
        }
    }
    UpdateProgressGauge(-0x39e);
    local_be._8_4_ = CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
    lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
    lpplMac._2_2_ = lpPlanets._2_2_;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
    while ((PLANET *)lppl < (PLANET *)lpplMac) {
        uVar23 = (undefined2)((ulong)lppl >> 0x10);
        if ((((PLANET *)lppl)->iPlayer != idPlayer) && (((PLANET *)lppl)->iPlayer != -1)) {
            i = (((PLANET *)lppl)->uGuesses & 0xfff) / 0xfa + 1;
            if (6 < (uint)i) {
                i = 6;
            }
            if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) {
                i = i + 1;
            }
            ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] = (byte)i;
            ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 9] = 1;
        }
        lppl = (PLANET *)CONCAT22(uVar23, (PLANET *)lppl + 1);
    }
    for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
        /* WARNING: Load size is inaccurate */
        pPVar16 = ((PLANET **)vrglpplAi)[ipl];
        iVar18 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
        lppl = (PLANET *)CONCAT22(iVar18, pPVar16);
        if ((pPVar16 == 0) && (iVar18 == 0))
            break;
        if ((((pPVar16->wFlags_0x4 >> 9 & 1) != 0) && (iVar8 = *(int *)((int)pPVar16->rgwtMin + 0xe), -1 < iVar8)) &&
            ((((0 < iVar8 || (199 < *(uint *)(pPVar16->rgwtMin + 3))) && ((*(uint *)&pPVar16->lStarbase & 0xf) != 0)) &&
              (((*(uint *)&pPVar16->lStarbase & 0xf) != 1 || (game.turn < 0x1a)))))) {
            ChangeMainObjSel(1, lppl->id);
            uVar23 = (undefined2)((ulong)lppl >> 0x10);
            pPVar16 = (PLANET *)lppl;
            if (((*(int *)&pPVar16->lpplprod == 0) && (*(int *)((int)&pPVar16->lpplprod + 2) == 0)) || (((PLPROD *)pPVar16->lpplprod)->iprodMac < 0x18)) {
                InitProduction(rgprod);
                fWrite = 0;
                for (i = 0; i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
                    uVar25 = __aFulshr(uVar26, in_stack_0000feba);
                    if (((uint)uVar25 & 7) == 2) {
                        uVar25 = __aFulshr(uVar26, in_stack_0000feba);
                        if (((uint)uVar25 & 0x7f) < 0x10)
                            break;
                    }
                }
                if (i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
                    FinishProduction(0);
                } else {
                    cRes = CResourcesAtPlanet(lppl, idPlayer);
                    if (0x78 < game.turn) {
                        sVar13 = IWarpMAFromLppl(lppl, &j);
                        if (9 < sVar13) {
                            uVar23 = (undefined2)((ulong)lppl >> 0x10);
                            iVar18 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe);
                            if ((-1 < iVar18) && ((0 < iVar18 || (10000 < *(uint *)(((PLANET *)lppl)->rgwtMin + 3))))) {
                                sVar13 = Random(4);
                                if (sVar13 == 0) {
                                    local_be._0_4_ = 0;
                                    local_be._4_2_ = 0x86a0;
                                    local_be._6_2_ = 1;
                                    for (i = 0; i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
                                        uVar25 = __aFulshr(uVar26, in_stack_0000feba);
                                        if (((uint)uVar25 & 7) == 1) {
                                            uVar25 = __aFulshr(uVar26, in_stack_0000feba);
                                            if (0xd < ((uint)uVar25 & 0x7f)) {
                                                uVar25 = __aFulshr(uVar26, in_stack_0000feba);
                                                if (((uint)uVar25 & 0x7f) < 0x12)
                                                    goto AI3_LTryCargo;
                                            }
                                        }
                                    }
                                    j = Random(3);
                                    for (i = j; i < j + 3; i = i + 1) {
                                        uVar14 = *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i % 3) + 2);
                                        if ((-1 < (int)uVar14) &&
                                            ((0 < (int)uVar14 || ((char *)"Stars!" + 4 <= *(char **)(((PLANET *)lppl)->rgwtMin + i % 3)))))
                                            break;
                                    }
                                    if (i != j + 3) {
                                        i = i % 3;
                                        for (local_c4._4_2_ = 0; (int)local_c4._4_2_ < vclpplAi; local_c4._4_2_ = local_c4._4_2_ + 1) {
                                            local_be._8_2_ = *(undefined2 *)((PLANET **)vrglpplAi + local_c4._4_2_);
                                            local_be._10_2_ = *(ushort *)((int)((PLANET **)vrglpplAi + local_c4._4_2_) + 2);
                                            if (((PLANET *)local_be._8_2_ == 0) && (local_be._10_2_ == 0))
                                                break;
                                            uVar14 = *(uint *)((int)((long *)(local_be._8_2_ + 0x1c) + i) + 2);
                                            if ((((int)uVar14 <= (int)local_be._6_2_) &&
                                                 ((((int)uVar14 < (int)local_be._6_2_ ||
                                                    (*(uint *)((long *)(local_be._8_2_ + 0x1c) + i) < (uint)local_be._4_2_)) &&
                                                   (sVar13 = IWarpMAFromLppl((PLANET *)CONCAT22(local_be._10_2_, local_be._8_2_), &j), 9 < sVar13)))) &&
                                                (iVar18 = ((PLANET *)CONCAT22(local_be._10_2_, local_be._8_2_))->id,
                                                 pt1.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4), pt1.x = ((POINT *)rgptPlan + lppl->id)->x,
                                                 pt2.y = *(short *)((int)&rgptPlan[0].y + iVar18 * 4), pt2.x = ((POINT *)rgptPlan + iVar18)->x,
                                                 lVar28 = LDistance2(pt1, pt2), lVar28 < 0x16444)) {
                                                local_be._4_2_ = *(undefined2 *)((long *)(local_be._8_2_ + 0x1c) + i);
                                                local_be._6_2_ = *(ushort *)((int)((long *)(local_be._8_2_ + 0x1c) + i) + 2);
                                                local_be._2_2_ = local_be._10_2_;
                                                local_be._0_2_ = local_be._8_2_;
                                            }
                                        }
                                        if (((PLANET *)local_be._0_2_ != 0) || (local_be._2_2_ != 0)) {
                                            lVar28 = __aFldiv(
                                                CONCAT22(*(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2), (int)((PLANET *)lppl)->rgwtMin[i]), 5);
                                            if (CONCAT22(local_be._6_2_, local_be._4_2_) < lVar28) {
                                                lVar28 = __aFldiv(
                                                    CONCAT22(*(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2), (int)((PLANET *)lppl)->rgwtMin[i]), 5);
                                                if (20000 < lVar28) {
                                                    lVar28 = 20000;
                                                }
                                                lVar28 = __aFldiv(lVar28, 100);
                                                AddItemToQueue(i + 0xe, (ushort)lVar28, grobjPlanet, 1);
                                                FinishProduction(1);
                                                local_c4._2_2_ = *(short *)local_be._0_4_ + 1;
                                                sel.pl.lStarbase._2_2_ = sel.pl.lStarbase._2_2_ & 0xc000 | 0x1c00 | local_c4._2_2_ & 0x3ff;
                                                FLookupPlanet(-1, (PLANET *)&sel.pl);
                                                goto LAB_10a0_0964;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                AI3_LTryCargo:
                    if (((iLatestCargo != -1) && (cFlCargo < 0x40)) && (cFlCargo < *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) / 4)) {
                        sVar13 = Random(3);
                        if (sVar13 == 0) {
                            cFlCargo = cFlCargo + 1;
                            AddItemToQueue(iLatestCargo, 1, grobjFleet, 1);
                            fWrite = 1;
                        }
                    }
                    if ((fShouldColonize == 0) || ((0x28 < cColFleet && ((0x78 < game.turn || (100 < cColFleet)))))) {
                        sVar13 = Random(100);
                        if (sVar13 < 8)
                            goto LAB_10a0_0ffc;
                    AI3_TryShip2:
                        if (((iLatestMiner != -1) && (cFlMiners < 0x3c)) &&
                            ((*(int *)((int)&rgshdef[0].cExist + 2 + iLatestMiner * 0x93) == 0 &&
                              ((char *)*(uint *)((int)&rgshdef[0].cExist + iLatestMiner * 0x93) <= (char *)"Stars!" + 2)))) {
                            sVar13 = Random(2);
                            if (sVar13 == 0) {
                                local_be._6_2_ = lppl->id;
                                local_be._8_2_ = 0;
                                local_be._10_2_ = 0;
                                for (ifl = 0; local_be._8_4_ = 0, ifl < cFleet; ifl = ifl + 1) {
                                    /* WARNING: Load size is inaccurate */
                                    pFVar17 = ((FLEET **)rglpfl)[ifl];
                                    iVar18 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                                    lpfl = (FLEET *)CONCAT22(iVar18, pFVar17);
                                    if ((pFVar17 == 0) && (local_be._8_4_ = 0, iVar18 == 0))
                                        break;
                                    if (((byte *)pFVar17->idPlanet == (byte *)local_be._6_2_) &&
                                        ((0 < pFVar17->rgcsh[iLatestMiner] && (pFVar17->iPlayer == idPlayer)))) {
                                        local_be._8_4_ = CMineFromLpfl((FLEET *)CONCAT22(iVar18, pFVar17));
                                        break;
                                    }
                                }
                                if ((long)local_be._8_4_ < 0x3e9) {
                                    cFr = 0;
                                    for (i = 0; i < 3; i = i + 1) {
                                        cFr = cFr + (uint)((PLANET *)lppl)->rgMinConc[i];
                                    }
                                    cFr = cFr * 3;
                                    if (((long)local_be._8_4_ < (long)cFr) && (0x96 < cFr)) {
                                    LAB_10a0_12f2:
                                        cFlMiners = cFlMiners + 1;
                                        AddItemToQueue(iLatestMiner, 1, grobjFleet, 1);
                                        fWrite = 1;
                                    } else if (cFlMiners < 0x1e) {
                                        sVar13 = Random(10);
                                        if (sVar13 != 0)
                                            goto LAB_10a0_12f2;
                                    }
                                }
                            }
                        }
                        if ((((rgshdef[0].hul.ihuldef == ihuldefFrigate) && (cFlMineLayers < 0x3c)) &&
                             (*(int *)((int)&rgshdef[0].cExist + 2 + iLatestMiner * 0x93) == 0)) &&
                            (*(uint *)((int)&rgshdef[0].cExist + iLatestMiner * 0x93) < 0x1d4c)) {
                            sVar13 = Random(4);
                            if (sVar13 == 0) {
                                local_be._10_2_ = lppl->id;
                                cFr = 0;
                                for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                                    /* WARNING: Load size is inaccurate */
                                    pFVar17 = ((FLEET **)rglpfl)[ifl];
                                    iVar18 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                                    lpfl = (FLEET *)CONCAT22(iVar18, pFVar17);
                                    if ((pFVar17 == 0) && (iVar18 == 0))
                                        break;
                                    if ((pFVar17->idPlanet == local_be._10_2_) && ((0 < pFVar17->rgcsh[0] && (pFVar17->iPlayer == idPlayer)))) {
                                        cFr = pFVar17->rgcsh[0];
                                        break;
                                    }
                                }
                                if (cFr < 10) {
                                LAB_10a0_1419:
                                    sVar13 = Random(cFr * 2 + 1);
                                    if (sVar13 == 0) {
                                        cFlMineLayers = cFlMineLayers + 3;
                                        AddItemToQueue(0, 4, grobjFleet, 1);
                                        fWrite = 1;
                                    }
                                } else if (cFr < 0x11) {
                                    sVar13 = Random(10);
                                    if (sVar13 == 0)
                                        goto LAB_10a0_1419;
                                }
                            }
                        }
                        for (i = 0; i < 3; i = i + 1) {
                            uVar14 = *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                            if (((int)uVar14 < 1) && (((int)uVar14 < 0 || (*(char **)(((PLANET *)lppl)->rgwtMin + i) <= (char *)"Stars!" + 2))))
                                break;
                        }
                        bVar24 = i == 2;
                        pPVar27 = (PLANET *)local_be._8_4_;
                        if (((iLatestBomber != -1) && (cFlArmadas < 0x8c)) && ((cFlArmadas < 0x3c || (2000 < cRes)))) {
                            local_be._10_2_ = lppl->id;
                            if ((0x6e < cFlArmadas) && (sVar13 = Random(3), sVar13 == 0)) {
                            AI3_LAddBombers:
                                cFlArmadas = cFlArmadas + 2;
                                if (bVar24) {
                                    uVar12 = 0xc;
                                } else {
                                    uVar12 = 4;
                                }
                                AddItemToQueue(iLatestBomber, uVar12, grobjFleet, 1);
                                fWrite = 1;
                                pPVar27 = (PLANET *)CONCAT22(local_be._10_2_, local_be._8_2_);
                                goto AI3_FinishProd_3;
                            }
                            ifl = 0;
                            while (true) {
                                pPVar27 = (PLANET *)CONCAT22(local_be._10_2_, local_be._8_2_);
                                if (cFleet <= ifl)
                                    break;
                                /* WARNING: Load size is inaccurate */
                                pFVar17 = ((FLEET **)rglpfl)[ifl];
                                iVar18 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                                lpfl = (FLEET *)CONCAT22(iVar18, pFVar17);
                                if ((pFVar17 == 0) && (pPVar27 = (PLANET *)CONCAT22(local_be._10_2_, local_be._8_2_), iVar18 == 0))
                                    break;
                                if ((pFVar17->idPlanet == local_be._10_2_) &&
                                    ((pFVar17->iPlayer == idPlayer && (sVar13 = FPotentMacWarFleet((FLEET *)CONCAT22(iVar18, pFVar17), 0), sVar13 != 0)))) {
                                    if ((iLatestBomber != -1) &&
                                        (uVar23 = (undefined2)((ulong)lpfl >> 0x10), local_be._8_2_ = ((FLEET *)lpfl)->rgcsh[8] + ((FLEET *)lpfl)->rgcsh[9],
                                         (int)local_be._8_2_ < (int)(uint)vrgAiArmadaPotency[2]))
                                        goto AI3_LAddBombers;
                                    pPVar27 = (PLANET *)CONCAT22(local_be._10_2_, local_be._8_2_);
                                    break;
                                }
                                ifl = ifl + 1;
                            }
                        }
                        if (0 < cGenesis) {
                            uVar23 = (undefined2)((ulong)lppl >> 0x10);
                            iVar18 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe);
                            if ((-1 < iVar18) && ((0 < iVar18 || (10000 < *(uint *)(((PLANET *)lppl)->rgwtMin + 3))))) {
                                for (i = 0; i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
                                    local_be._8_4_ = pPVar27;
                                    uVar25 = __aFulshr(uVar26, in_stack_0000feba);
                                    pPVar27 = (PLANET *)local_be._8_4_;
                                    if (((uint)uVar25 & 7) == 1) {
                                        uVar25 = __aFulshr(uVar26, in_stack_0000feba);
                                        pPVar27 = (PLANET *)local_be._8_4_;
                                        if (((uint)uVar25 & 0x7f) == 0xd)
                                            break;
                                    }
                                }
                                local_be._8_2_ = SUB42(pPVar27, 0);
                                if ((int)(uint)((PLPROD *)lpplProdGlob)->iprodMac <= i) {
                                    i = 0;
                                    while (true) {
                                        if (2 < i)
                                            break;
                                        uVar14 = *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                                        if (((int)uVar14 < 1) && (((int)uVar14 < 0 || (*(uint *)(((PLANET *)lppl)->rgwtMin + i) < 2000))))
                                            break;
                                        i = i + 1;
                                    }
                                    if (i != 2) {
                                        local_be._10_2_ = 0;
                                        for (i = 0; i < 3; i = i + 1) {
                                            local_be._10_2_ = local_be._10_2_ + (uint)((PLANET *)lppl)->rgMinConc[i];
                                        }
                                        if (((int)local_be._10_2_ < 0xf) || (((int)local_be._10_2_ < 0x1e && (sVar13 = Random(3), sVar13 != 0)))) {
                                        LAB_10a0_1794:
                                            cGenesis = cGenesis + -1;
                                            AddItemToQueue(0xd, 1, grobjPlanet, 1);
                                            AddItemToQueue(0xc, 0x4b, grobjPlanet, 1);
                                            pPVar27 = (PLANET *)CONCAT22(local_be._10_2_, local_be._8_2_);
                                            fWrite = 1;
                                        } else {
                                            pPVar27 = (PLANET *)CONCAT22(local_be._10_2_, local_be._8_2_);
                                            if ((int)local_be._10_2_ < 0x3c) {
                                                sVar13 = Random(5);
                                                pPVar27 = (PLANET *)CONCAT22(local_be._10_2_, local_be._8_2_);
                                                if (sVar13 != 0)
                                                    goto LAB_10a0_1794;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        if ((((iLatestCruiser != -1) && (cFlArmadas < 0x82)) && (0x14 < game.turn)) && ((cFlArmadas < 0x32 || (2000 < cRes)))) {
                            if (!bVar24) {
                                local_be._8_4_ = pPVar27;
                                sVar13 = Random(3);
                                pPVar27 = (PLANET *)local_be._8_4_;
                                if (sVar13 != 0)
                                    goto AI3_TryShip3;
                            }
                            local_be._8_2_ = SUB42(pPVar27, 0);
                            if (iLatestBattle == -1) {
                            LAB_10a0_1846:
                                local_be._10_2_ = iLatestCruiser;
                            } else {
                                local_be._8_4_ = pPVar27;
                                sVar13 = Random(3);
                                if (sVar13 != 0)
                                    goto LAB_10a0_1846;
                                local_be._10_2_ = iLatestBattle;
                            }
                            cFlArmadas = cFlArmadas + 1;
                            if (bVar24) {
                                uVar12 = 10;
                            } else {
                                uVar12 = 2;
                            }
                            AddItemToQueue(local_be._10_2_, uVar12, grobjFleet, 1);
                            pPVar27 = (PLANET *)CONCAT22(local_be._10_2_, local_be._8_2_);
                            fWrite = 1;
                            if (bVar24)
                                goto AI3_FinishProd_3;
                        }
                    AI3_TryShip3:
                        if (iLatestDestroyer != -1) {
                            if (game.turn < 0x78) {
                                iVar18 = 0x50;
                            } else {
                                iVar18 = 0x3c;
                            }
                            if ((cFlDestroyers < iVar18) && (cshDestroyer < 2000)) {
                                local_be._8_4_ = pPVar27;
                                GetResourcesAvailable(lppl, rgResAvail);
                                GetProdQCost(lppl, rgResCost);
                                for (i = 0; i < 4; i = i + 1) {
                                    uVar9 = *(uint *)(rgResCost + i);
                                    iVar18 = *(int *)((int)rgResCost + i * 4 + 2);
                                    puVar1 = (uint *)(rgResAvail + i);
                                    uVar14 = *puVar1;
                                    *puVar1 = *puVar1 - uVar9;
                                    piVar2 = (int *)((int)rgResAvail + i * 4 + 2);
                                    *piVar2 = (*piVar2 - iVar18) - (uint)(uVar14 < uVar9);
                                    iVar18 = *(int *)((int)rgResAvail + i * 4 + 2);
                                    if ((iVar18 < 1) && (pPVar27 = (PLANET *)local_be._8_4_, iVar18 < 0))
                                        goto AI3_FinishProd_3;
                                }
                                GetTrueHullCost(idPlayer, (HUL *)(iLatestDestroyer * 0x93 + rgshdef), rgCosts);
                                for (i = 0; i < 0x14; i = i + 1) {
                                    for (j = 0; j < 4; j = j + 1) {
                                        uVar9 = rgCosts[j];
                                        iVar18 = j * 4;
                                        puVar1 = (uint *)(rgResAvail + j);
                                        uVar14 = *puVar1;
                                        *puVar1 = *puVar1 - uVar9;
                                        piVar2 = (int *)((int)rgResAvail + iVar18 + 2);
                                        *piVar2 = *piVar2 - (uint)(uVar14 < uVar9);
                                        iVar18 = *(int *)((int)rgResAvail + j * 4 + 2);
                                        if ((iVar18 < 1) && (iVar18 < 0))
                                            break;
                                    }
                                    if (j < 4)
                                        break;
                                }
                                pPVar27 = (PLANET *)local_be._8_4_;
                                if (0 < i) {
                                    fWrite = 1;
                                    AddItemToQueue(iLatestDestroyer, i, grobjFleet, 1);
                                    cFlDestroyers = cFlDestroyers + 1;
                                    pPVar27 = (PLANET *)local_be._8_4_;
                                }
                            }
                        }
                    } else {
                    LAB_10a0_0ffc:
                        if ((0x31 < cColFleet) && (0x78 < game.turn))
                            goto AI3_TryShip2;
                        i = 0;
                        while (true) {
                            if (2 < i)
                                break;
                            uVar14 = *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
                            if (((int)uVar14 < 1) &&
                                ((pPVar27 = (PLANET *)local_be._8_4_, (int)uVar14 < 0 || (*(uint *)(((PLANET *)lppl)->rgwtMin + i) < 0x1e))))
                                goto AI3_FinishProd_3;
                            i = i + 1;
                        }
                        sVar13 = FShouldPlanetBuildColonizer(lppl);
                        if (sVar13 == 0)
                            goto AI3_TryShip2;
                        cColFleet = cColFleet + 1;
                        AddItemToQueue(iLatestColony, 1, grobjFleet, 1);
                        fWrite = 1;
                        pPVar27 = (PLANET *)local_be._8_4_;
                        if (4 < game.turn) {
                            sVar13 = PctTrueMaxGrowth(idPlayer);
                            uVar23 = (undefined2)((ulong)lppl >> 0x10);
                            uVar25 =
                                __aFulmul(CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe), (int)((PLANET *)lppl)->rgwtMin[3]), (long)sVar13);
                            if (((0x8fc < (long)uVar25) && (0x23 < cRes)) && (0 < iAiLvl)) {
                                cColFleet = cColFleet + 1;
                                AddItemToQueue(iLatestColony, 1, grobjFleet, 1);
                                if (((0xe10 < (long)uVar25) && (0x32 < cRes)) && (1 < iAiLvl)) {
                                    AddItemToQueue(iLatestColony, 1, grobjFleet, 1);
                                }
                            }
                            goto AI3_TryShip2;
                        }
                    }
                AI3_FinishProd_3:
                    local_be._8_4_ = pPVar27;
                    FinishProduction(fWrite);
                }
            }
        }
    LAB_10a0_0964:
    }
    UpdateProgressGauge(-0x39e);
    lpflAttack._0_2_ = 0;
    lpflAttack._2_2_ = 0;
    lpflEnemy._0_2_ = 0;
    lpflEnemy._2_2_ = 0;
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
        /* WARNING: Load size is inaccurate */
        pFVar17 = ((FLEET **)rglpfl)[ifl];
        iVar18 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar18, pFVar17);
        if ((pFVar17 == 0) && (iVar18 == 0))
            break;
        if ((1 < pFVar17->cord) && ((((PLORD *)pFVar17->lpplord + 7)->wFlags >> 8 & 0xf) == 8)) {
            local_be._4_2_ = (&pFVar17->pt)->x - *(int *)&((PLORD *)pFVar17->lpplord)[5].iordMax;
            local_be._10_2_ = (pFVar17->pt).y - ((PLORD *)pFVar17->lpplord + 6)->wFlags;
            local_be._0_4_ = __aFulmul((long)(int)local_be._10_2_, (long)(int)local_be._10_2_);
            uVar26 = __aFulmul((long)(int)local_be._4_2_, (long)(int)local_be._4_2_);
            local_be._6_4_ = (byte *)(local_be._0_4_ + 6) + (uVar26 - 6);
            if (40000 < (long)local_be._6_4_) {
                ChangeMainObjSel(2, lpfl->id);
                sel.fl.cord = 1;
                ((PLORD *)sel.fl.lpplord)->iordMac = 1;
                FLookupFleet(-1, (FLEET *)&sel.fl);
            }
        }
        uVar23 = (undefined2)((ulong)lpfl >> 0x10);
        pFVar17 = (FLEET *)lpfl;
        if (pFVar17->iPlayer == idPlayer) {
            if ((pFVar17->rgcsh[0] < 1) || (game.turn < 0x29)) {
                if (((pFVar17->rgcsh[0xe] < 1) && (pFVar17->rgcsh[0xf] < 1)) || (pFVar17->cord != 1)) {
                    sVar13 = FIsAiAttack(lpfl);
                    if (sVar13 == 0) {
                        sVar13 = FIsAiTransport(lpfl);
                        if (sVar13 != 0) {
                            idPlanDst = -1;
                            uVar23 = (undefined2)((ulong)lpfl >> 0x10);
                            pFVar17 = (FLEET *)lpfl;
                            if ((pFVar17->cord < 2) || ((*(uint *)&((PLORD *)pFVar17->lpplord)[2].iordMax & 0xf) != 0)) {
                                idPlanDst = pFVar17->idPlanet;
                            } else if ((((PLORD *)pFVar17->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
                                idPlanDst = *(short *)&((PLORD *)pFVar17->lpplord)[6].iordMax;
                            }
                            if (idPlanDst != -1) {
                                lppl = LpplFromId(idPlanDst);
                                iVar18 = (int)((ulong)lppl >> 0x10);
                                if ((((PLANET *)lppl == 0) && (iVar18 == 0)) || (((PLANET *)lppl)->iPlayer != idPlayer)) {
                                    uVar23 = (undefined2)((ulong)lpfl >> 0x10);
                                    if (((int)((FLEET *)lpfl)->rgwtMin[3] == 0) && (*(int *)((int)((FLEET *)lpfl)->rgwtMin + 0xe) == 0)) {
                                        ChangeMainObjSel(2, lpfl->id);
                                        sel.fl.cord = 1;
                                        ((PLORD *)sel.fl.lpplord)->iordMac = 1;
                                        FLookupFleet(-1, (FLEET *)&sel.fl);
                                        ClearAiCurrentTask(lpfl, 0);
                                    }
                                }
                            }
                        }
                    } else {
                        *(FLEET **)&((FLEET *)lpfl)->lpflNext = (FLEET *)lpflAttack;
                        *(undefined2 *)((int)&((FLEET *)lpfl)->lpflNext + 2) = lpflAttack._2_2_;
                        lpflAttack._0_2_ = (FLEET *)lpfl;
                        lpflAttack._2_2_ = lpfl._2_2_;
                        for (j = 2; (j <= ishLastBattle && (((FLEET *)lpfl)->rgcsh[j] < 1)); j = j + 1) {
                        }
                        if ((j <= ishLastBattle) && (((1 < ((FLEET *)lpfl)->cord && ((((PLORD *)((FLEET *)lpfl)->lpplord + 7)->wFlags >> 8 & 0xf) == 1)) ||
                                                      (((FLEET *)lpfl)->idPlanet != -1)))) {
                            if ((((FLEET *)lpfl)->cord < 2) || ((((PLORD *)((FLEET *)lpfl)->lpplord + 7)->wFlags >> 8 & 0xf) != 1)) {
                                local_be._10_2_ = ((FLEET *)lpfl)->idPlanet;
                            } else {
                                local_be._10_2_ = *(undefined2 *)&((PLORD *)((FLEET *)lpfl)->lpplord)[6].iordMax;
                            }
                            pbVar15 = (byte *)vlpbAiPlanet + local_be._10_2_ * 0x10 + 10;
                            pbVar3 = (byte *)CONCAT22(vlpbAiPlanet._2_2_, pbVar15);
                            local_be._6_4_ = CONCAT22(vlpbAiPlanet._2_2_, pbVar15);
                            if (*(byte *)CONCAT22(vlpbAiPlanet._2_2_, pbVar15) != 0) {
                                *(byte *)CONCAT22(vlpbAiPlanet._2_2_, pbVar15) = *(byte *)CONCAT22(vlpbAiPlanet._2_2_, pbVar15) | 0x80;
                                local_be._6_4_ = pbVar3;
                            }
                        }
                    }
                } else {
                    if ((*(uint *)&((PLORD *)pFVar17->lpplord)[2].iordMax & 0xf) != 3) {
                        ChangeMainObjSel(2, lpfl->id);
                        uVar23 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                        *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax = *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 3;
                        FLookupFleet(-1, (FLEET *)&sel.fl);
                        goto LAB_10a0_1a3b;
                    }
                    if (cFlMiners < 0x3b) {
                        if (0x30 < cFlMiners) {
                            sVar13 = Random(3);
                            if (sVar13 != 0)
                                goto LAB_10a0_1e15;
                        }
                    } else {
                    LAB_10a0_1e15:
                        sVar13 = FFindBuddyAndJoinUp(lpfl, 0xe, 0xf, 0x48, 0x6c);
                        if (sVar13 != 0)
                            goto LAB_10a0_1a3b;
                    }
                    uVar23 = (undefined2)((ulong)lpfl >> 0x10);
                    if (((FLEET *)lpfl)->idPlanet != -1) {
                        lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
                        uVar23 = (undefined2)((ulong)lppl >> 0x10);
                        if ((lppl != 0) && (((PLANET *)lppl)->iPlayer == idPlayer)) {
                            j = 0;
                            for (i = 0; i < 3; i = i + 1) {
                                j = j + (uint)((PLANET *)lppl)->rgMinConc[i];
                            }
                            if (j < 0x1e) {
                            LAB_10a0_1ee2:
                                FRetargetMiner(lpfl);
                                goto LAB_10a0_1a3b;
                            }
                            if (j < 0x3c) {
                                sVar13 = Random(3);
                                if (sVar13 == 0)
                                    goto LAB_10a0_1ee2;
                            }
                        }
                    }
                    sVar13 = Random(10);
                    if (sVar13 == 0) {
                        FRetargetMiner(lpfl);
                    }
                }
            LAB_10a0_2154:
                pFVar17 = (FLEET *)lpfl;
                uVar23 = (undefined2)((ulong)lpfl >> 0x10);
                if ((game.turn < 0xb) && ((0 < pFVar17->rgcsh[0] || (pFVar17->rgcsh[2] != 0)))) {
                AI3_LRecycle:
                    ChangeMainObjSel(2, lpfl->id);
                    uVar23 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                    *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax = *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
                    FLookupFleet(-1, (FLEET *)&sel.fl);
                } else if (pFVar17->cord < 2) {
                    if ((pFVar17->rgcsh[1] != 0) || ((fUsingTempColonizer != 0 && (pFVar17->rgcsh[7] != 0)))) {
                        if ((fUsingTempColonizer != 0) && ((iLatestColony == 1 && (pFVar17->idPlanet != -1))))
                            goto AI3_LRecycle;
                        if ((iAiLvl < 2) || (pFVar17->idPlanet == -1)) {
                        LAB_10a0_2388:
                            idPlanDst = IdNearestColonizablePlanet(lpfl, &lpthWorm);
                            if (((idPlanDst == -1) && ((THING *)lpthWorm == 0)) && (lpthWorm._2_2_ == 0)) {
                                if (((FLEET *)lpfl)->idPlanet != -1) {
                                    ChangeMainObjSel(2, lpfl->id);
                                    uVar23 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                                    *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax = *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
                                    FLookupFleet(-1, (FLEET *)&sel.fl);
                                }
                            } else {
                                ChangeMainObjSel(2, lpfl->id);
                                uVar23 = (undefined2)((ulong)lpfl >> 0x10);
                                if (((FLEET *)lpfl)->idPlanet != -1) {
                                    lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
                                    iVar18 = (int)((ulong)lppl >> 0x10);
                                    pPVar16 = (PLANET *)lppl;
                                    if ((pPVar16 == 0) && (iVar18 == 0)) {
                                        lVar28 = 0;
                                    } else {
                                        lVar28 = __aFldiv(CONCAT22(*(undefined2 *)((int)pPVar16->rgwtMin + 0xe), (int)pPVar16->rgwtMin[3]), 10);
                                        if (0x19 < lVar28) {
                                            lVar28 = 0x19;
                                        }
                                    }
                                    l._0_2_ = (uint)lVar28;
                                    XferAiSupply(1, ((FLEET *)lpfl)->idPlanet, 2, lpfl->id, 3, (uint)l);
                                    FLookupFleet(lpfl->id, (FLEET *)&sel.fl);
                                }
                                if (idPlanDst == -1) {
                                    FGotoWormholeAiFleet(lpfl, (THING *)CONCAT22(lpthWorm._2_2_, (THING *)lpthWorm));
                                } else {
                                    FColonizeAiFleet(lpfl, idPlanDst);
                                }
                            }
                        } else {
                            pPVar27 = LpplFromId(pFVar17->idPlanet);
                            local_be._10_2_ = (undefined2)((ulong)pPVar27 >> 0x10);
                            local_be._8_2_ = SUB42(pPVar27, 0);
                            if ((((((PLANET *)local_be._8_2_ == 0) && (local_be._10_2_ == 0)) || (*(short *)(local_be._8_2_ + 2) == -1)) ||
                                 ((*(short *)(local_be._8_2_ + 2) == idPlayer || ((*(ushort *)(local_be._8_2_ + 4) >> 9 & 1) != 0)))) ||
                                (0x31 < (*(ushort *)(local_be._8_2_ + 0x12) & 0xfff))) {
                                if ((((PLANET *)local_be._8_2_ == 0) && (local_be._10_2_ == 0)) || (*(short *)(local_be._8_2_ + 2) != -1))
                                    goto LAB_10a0_2388;
                                uVar23 = (undefined2)((ulong)lpfl >> 0x10);
                                if (((int)((FLEET *)lpfl)->rgwtMin[3] == 0) && (*(int *)((int)((FLEET *)lpfl)->rgwtMin + 0xe) == 0)) {
                                    FMoveToNearestStarbase(lpfl, 1);
                                } else {
                                    ChangeMainObjSel(2, lpfl->id);
                                    uVar23 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                                    *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax = *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 2;
                                    FLookupFleet(-1, (FLEET *)&sel.fl);
                                }
                            }
                        }
                    }
                } else if (((fUsingTempColonizer != 0) && (rgRecycleShdef[7] != 0)) && (pFVar17->rgcsh[7] != 0)) {
                    ChangeMainObjSel(2, lpfl->id);
                    sel.fl.cord = 1;
                    ((PLORD *)sel.fl.lpplord)->iordMac = 1;
                    FLookupFleet(-1, (FLEET *)&sel.fl);
                    FMoveToNearestStarbase(lpfl, 0);
                }
            } else if (pFVar17->cord < 2) {
                if (sVar11 < 0x38) {
                    if (0x28 < sVar11) {
                        sVar13 = Random(3);
                        if (sVar13 != 0)
                            goto LAB_10a0_1c04;
                    }
                } else {
                LAB_10a0_1c04:
                    sVar13 = FFindBuddyAndJoinUp(lpfl, 0, 0, 0x48, 0x6c);
                    if (sVar13 != 0)
                        goto LAB_10a0_1a3b;
                }
                if (6 < ((FLEET *)lpfl)->rgcsh[0]) {
                    sVar13 = Random(5);
                    if (sVar13 == 0) {
                        uVar23 = (undefined2)((ulong)lpfl >> 0x10);
                        pt.y = (((FLEET *)lpfl)->pt).y;
                        pt.x = (&((FLEET *)lpfl)->pt)->x;
                        idPlanDst = IdRandomPlanetNearby(pt, 0x69, 1);
                        if ((idPlanDst != -1) && (idPlanDst != ((FLEET *)lpfl)->idPlanet)) {
                            ClearAiCurrentTask(lpfl, 1);
                            local_c4._4_2_ = idPlanDst;
                            local_c4._0_2_ = ((POINT *)rgptPlan + idPlanDst)->x;
                            local_c4._2_2_ = *(uint *)((int)&rgptPlan[0].y + idPlanDst * 4);
                            local_be._0_4_ = local_be._0_4_ & 0xffffe000 | 0x1146;
                            FMoveAiFleet(lpfl, local_c4, 0);
                            goto LAB_10a0_2154;
                        }
                    }
                }
                pPVar10 = ((FLEET *)lpfl)->lpplord;
                if ((*(uint *)&((PLORD *)pPVar10)[2].iordMax & 0xf) == 6)
                    goto LAB_10a0_2154;
                ChangeMainObjSel(2, lpfl->id);
                uVar23 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax = *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 6;
                ((PLORD *)sel.fl.lpplord + 3)->wFlags = 5;
                pbVar3 = &((PLORD *)sel.fl.lpplord)[3].iordMax;
                pbVar3[0] = 5;
                pbVar3[1] = 0;
                FLookupFleet(-1, (FLEET *)&sel.fl);
            } else if ((*(uint *)&((PLORD *)pFVar17->lpplord)[2].iordMax & 0xf) != 0) {
                ClearAiCurrentTask(lpfl, 1);
            }
        } else {
            *(FLEET **)&pFVar17->lpflNext = (FLEET *)lpflEnemy;
            *(undefined2 *)((int)&pFVar17->lpflNext + 2) = lpflEnemy._2_2_;
            lpflEnemy._0_2_ = pFVar17;
            lpflEnemy._2_2_ = uVar23;
        }
    LAB_10a0_1a3b:
    }
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
        /* WARNING: Load size is inaccurate */
        pFVar17 = ((FLEET **)rglpfl)[ifl];
        iVar18 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar18, pFVar17);
        if ((pFVar17 == 0) && (iVar18 == 0))
            break;
        if ((pFVar17->iPlayer == idPlayer) && (pFVar17->cord < 2)) {
            sVar11 = FIsAiTransport((FLEET *)CONCAT22(iVar18, pFVar17));
            if (sVar11 != 0) {
                if (((FLEET *)lpfl)->iplan != 4) {
                    ChangeMainObjSel(2, lpfl->id);
                    sel.fl.iplan = 4;
                    FLookupFleet(-1, (FLEET *)&sel.fl);
                }
                IdTargetMacFreighter(lpfl);
            }
        }
    }
    UpdateProgressGauge(-0x39e);
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
        /* WARNING: Load size is inaccurate */
        pFVar17 = ((FLEET **)rglpfl)[ifl];
        iVar18 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar18, pFVar17);
        if ((pFVar17 == 0) && (iVar18 == 0))
            break;
        if (pFVar17->iPlayer == idPlayer) {
            for (i = 0; (i < 0x10 && ((pFVar17->rgcsh[i] < 1 || (rgRecycleShdef[i] != 0)))); i = i + 1) {
            }
            if (i != 0x10)
                goto LAB_10a0_2787;
            if (pFVar17->idPlanet != -1) {
                lppl = LpplFromId(pFVar17->idPlanet);
                uVar23 = (undefined2)((ulong)lppl >> 0x10);
                if ((lppl != 0) && (((PLANET *)lppl)->iPlayer == idPlayer)) {
                    if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0) {
                        sVar11 = Random(5);
                        if (sVar11 != 0)
                            goto LAB_10a0_2735;
                    }
                    ChangeMainObjSel(2, lpfl->id);
                    uVar23 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                    *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax = *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
                    FLookupFleet(-1, (FLEET *)&sel.fl);
                    goto LAB_10a0_25e7;
                }
            }
        LAB_10a0_2735:
            uVar23 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar17 = (FLEET *)lpfl;
            if (((pFVar17->cord < 2) || (pFVar17->idPlanet != -1)) || ((((PLORD *)pFVar17->lpplord + 7)->wFlags >> 8 & 0xf) != 1)) {
                sVar11 = FMoveToNearestStarbase(lpfl, 0);
                if (sVar11 == 0) {
                LAB_10a0_2787:
                    i = 2;
                LAB_10a0_28ad:
                    if (i < 10) {
                        if ((((FLEET *)lpfl)->rgcsh[i] < 1) || ((i == 7 && (fUsingTempColonizer != 0))))
                            goto LAB_10a0_28a9;
                        if (cFlArmadas < 0x65) {
                            if (cFlArmadas < 0x5b)
                                goto LAB_10a0_2898;
                            sVar11 = Random(3);
                            if (sVar11 != 0)
                                goto LAB_10a0_2898;
                        }
                        l._0_2_ = 0;
                        l._2_2_ = 0;
                        for (j = 2; j < 10; j = j + 1) {
                            uVar14 = ((FLEET *)lpfl)->rgcsh[j];
                            bVar24 = CARRY2((uint)l, uVar14);
                            l._0_2_ = (uint)l + uVar14;
                            l._2_2_ = l._2_2_ + ((int)uVar14 >> 0xf) + (uint)bVar24;
                        }
                        uVar14 = Random(100);
                        iVar18 = l._2_2_ + -1 + (uint)(9 < (uint)l);
                        if ((iVar18 < (int)uVar14 >> 0xf) || ((iVar18 <= (int)uVar14 >> 0xf && ((uint)l - 10 < uVar14)))) {
                        LAB_10a0_2867:
                            sVar11 = FFindBuddyAndJoinUp(lpfl, 2, 9, 100, 200);
                            if (sVar11 == 0)
                                goto LAB_10a0_2898;
                        } else {
                            sVar11 = Random(0x14);
                            if (sVar11 == 0)
                                goto LAB_10a0_2867;
                        LAB_10a0_2898:
                            TargetMacArmada(lpfl);
                        }
                    }
                    if (9 < i) {
                        sVar11 = FIsAiAttack(lpfl);
                        if (sVar11 != 0) {
                            uVar23 = (undefined2)((ulong)lpfl >> 0x10);
                            if ((((FLEET *)lpfl)->cord < 2) || (pPVar10 = ((FLEET *)lpfl)->lpplord, (((PLORD *)pPVar10 + 7)->wFlags >> 8 & 0xf) != 2)) {
                                if (game.turn < 0x79) {
                                    iVar18 = 0x46;
                                } else {
                                    iVar18 = 0x32;
                                }
                                if (iVar18 < cFlDestroyers) {
                                LAB_10a0_2950:
                                    if (0x13 < ((FLEET *)lpfl)->rgcsh[iLatestDestroyer]) {
                                        sVar11 = Random(0x14);
                                        if (sVar11 != 0)
                                            goto LAB_10a0_29b2;
                                    }
                                    sVar11 = FFindBuddyAndJoinUp(lpfl, 0xc, 0xd, 0x24, 0x48);
                                    if (sVar11 != 0)
                                        goto LAB_10a0_25e7;
                                } else {
                                    if (game.turn < 0x79) {
                                        iVar18 = 0x3c;
                                    } else {
                                        iVar18 = 0x28;
                                    }
                                    if (iVar18 < cFlDestroyers) {
                                        sVar11 = Random(3);
                                        if (sVar11 == 0)
                                            goto LAB_10a0_2950;
                                    }
                                }
                            LAB_10a0_29b2:
                                IdTargetAttack(lpfl, (FLEET *)CONCAT22(lpflAttack._2_2_, (FLEET *)lpflAttack),
                                               (FLEET *)CONCAT22(lpflEnemy._2_2_, (FLEET *)lpflEnemy), game.wCrap >> 4 & 1);
                            }
                        }
                    }
                }
            }
        }
    LAB_10a0_25e7:
    }
    HandleBasicAiTasks(iroCur, rgprod, 0, rgResAvail, rgResCost);
    FillProductionQueue();
    return;
LAB_10a0_28a9:
    i = i + 1;
    goto LAB_10a0_28ad;
}

// ======================================================================
// Function: EnsureMacintiShdefs
// Address: 10a0:2b3c
// Segment: MEMORY_AI3
// ======================================================================

void EnsureMacintiShdefs(void)

{
    SHDEF     *pSVar1;
    HullDef   *pHVar2;
    short      sVar3;
    int        iVar4;
    SHDEF     *pSVar5;
    HullDef   *pHVar6;
    undefined2 unaff_SS;
    undefined1 local_a4[148];
    PART       part;
    short      i;
    short      ish;

    for (ish = 0xe; ish < 0x10; ish = ish + 1) {
        if (((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0) &&
            ((((local_a4._146_2_ = ZEXT12(1 < (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7)), local_a4._146_2_ == 0 || (ish != 0xf)) ||
               ('\x0e' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0))) &&
              ((sVar3 = FCreateAiShdef(ish, 0x18 - (uint)(local_a4._146_2_ == 0), (byte *)vrgMacAip + ((ushort *)vrgMacIshAip)[local_a4._146_2_ + 0x15]),
                sVar3 == 0 && (ish == 0xe)))))) {
            if (local_a4._146_2_ == 0) {
                FCreateAiShdef(0xe, 0x15, (byte *)vrgMacAip + vrgMacIshAip[0x17]);
            } else {
                FCreateAiShdef(0xe, 0x16, (byte *)vrgMacAip + vrgMacIshAip[0x16]);
            }
        }
    }
    if ((((rgshdef[0xc].wFlags >> 9 & 1) != 0) && ('\x04' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
        (('\x05' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0) &&
          (sVar3 = FCreateAiShdef(0xc, 0x1d, (byte *)vrgMacAip + vrgMacIshAip[0x1e]), sVar3 == 0)))) {
        for (i = 0; i < 5; i = i + 1) {
            sVar3 = Random(4);
            sVar3 = FCreateAiShdef(0xc, 6, (byte *)vrgMacAip + ((ushort *)vrgMacIshAip)[sVar3]);
            if (sVar3 != 0)
                break;
        }
    }
    if (((((rgshdef[0xd].wFlags >> 9 & 1) != 0) && ('\t' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
         ('\b' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) &&
        (sVar3 = FCreateAiShdef(0xd, 0x1d, (byte *)vrgMacAip + vrgMacIshAip[0x1e]), sVar3 == 0)) {
        for (i = 0; i < 5; i = i + 1) {
            sVar3 = Random(4);
            sVar3 = FCreateAiShdef(0xd, 6, (byte *)vrgMacAip + ((ushort *)vrgMacIshAip)[sVar3 + 4]);
            if (sVar3 != 0)
                break;
        }
    }
    if (((rgshdef[10].wFlags >> 9 & 1) != 0) && (sVar3 = FCreateAiShdef(10, 2, (byte *)vrgMacAip + vrgMacIshAip[0x18]), sVar3 == 0)) {
        FCreateAiShdef(10, 1, (byte *)vrgMacAip + vrgMacIshAip[0x18]);
    }
    if ((rgshdef[0xb].wFlags >> 9 & 1) != 0) {
        FCreateAiShdef(0xb, 2, (byte *)vrgMacAip + vrgMacIshAip[0x18]);
    }
    if (((game.turn < 0x14) && ((rgshdef[2].wFlags >> 9 & 1) == 0)) && (((int)rgshdef[2].cExist == 0 && (rgshdef[2].cExist._2_2_ == 0)))) {
        pSVar5 = (SHDEF *)(rgshdef + 2);
        pHVar6 = local_a4;
        for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
            pHVar2 = pHVar6;
            pHVar6 = pHVar6 + 1;
            pSVar1 = pSVar5;
            pSVar5 = (pSVar5->hul).rgTech;
            *pHVar2 = (pSVar1->hul).ihuldef;
        }
        *(char *)pHVar6 = (char)(pSVar5->hul).ihuldef;
        local_a4._123_2_ = local_a4._123_2_ & 0xfdff | 0x200;
        FChangeAiShdef(local_a4, 2);
    }
    for (ish = 2; ish < 5; ish = ish + 1) {
        if (((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0) &&
            ((ish == 2 || (0x14 < game.turn - *(int *)((int)&rgshdef[0].turn + (ish + -1) * 0x93))))) {
            for (i = 0; i < 5; i = i + 1) {
                sVar3 = Random(4);
                sVar3 = FCreateAiShdef(ish, 7, (byte *)vrgMacAip + ((ushort *)vrgMacIshAip)[sVar3 + 0x19]);
                if (sVar3 != 0)
                    break;
            }
        }
    }
    if ((game.turn < 0x28) && ((rgshdef[7].wFlags >> 9 & 1) != 0)) {
        FCreateAiShdef(7, 0xf, (byte *)vrgMacAip + vrgMacIshAip[0x14]);
    }
    sVar3 = FLookupPartX(&part, hstEngine, 0xf);
    if ((((sVar3 == 1) && ((rgshdef[1].wFlags >> 9 & 1) == 0)) && ((int)rgshdef[1].cExist == 0)) &&
        ((rgshdef[1].cExist._2_2_ == 0 && ((rgshdef[1].hul.rghs[0].wFlags_0x2 & 0xff) != 0xf)))) {
        pSVar5 = (SHDEF *)(rgshdef + 1);
        pHVar6 = local_a4;
        for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
            pHVar2 = pHVar6;
            pHVar6 = pHVar6 + 1;
            pSVar1 = pSVar5;
            pSVar5 = (pSVar5->hul).rgTech;
            *pHVar2 = (pSVar1->hul).ihuldef;
        }
        *(char *)pHVar6 = (char)(pSVar5->hul).ihuldef;
        local_a4._123_2_ = local_a4._123_2_ & 0xfdff | 0x200;
        FChangeAiShdef(local_a4, 1);
        FCreateAiShdef(1, 0xf, (byte *)vrgMacAip + vrgMacIshAip[0x14]);
    }
    ish = 5;
    do {
        if (7 < ish) {
            for (ish = 8; ish < 10; ish = ish + 1) {
                if (((((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0) && ('\r' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
                     ((ish == 8 || (((*(uint *)((int)&rgshdef[0].wFlags + (ish + -1) * 0x93) >> 9 & 1) == 0 &&
                                     (0xf < game.turn - *(int *)((int)&rgshdef[0].turn + (ish + -1) * 0x93))))))) &&
                    (sVar3 = FCreateAiShdef(ish, 9, (byte *)vrgMacAip + vrgMacIshAip[0x13]), sVar3 == 0)) {
                    if (ish == 8) {
                        iVar4 = 8;
                    } else {
                        iVar4 = 9;
                    }
                    FCreateAiShdef(ish, 0x13, (byte *)vrgMacAip + ((ushort *)vrgMacIshAip)[iVar4]);
                }
            }
            if (((((rgshdef[0].hul.ihuldef != ihuldefFrigate) && (1 < (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7))) &&
                  ((int)rgshdef[0].cExist == 0)) &&
                 ((rgshdef[0].cExist._2_2_ == 0 && ('\x03' < *(char *)((int)rgplr[0].rgTech + 5 + idPlayer * 0xc0))))) &&
                ((('\x04' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) &&
                   (('\x05' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) && ('\x05' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))) &&
                  ('\x05' < *(char *)((int)rgplr[0].rgTech + idPlayer * 0xc0))))) {
                pSVar5 = (SHDEF *)rgshdef;
                pHVar6 = local_a4;
                for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
                    pHVar2 = pHVar6;
                    pHVar6 = pHVar6 + 1;
                    pSVar1 = pSVar5;
                    pSVar5 = (pSVar5->hul).rgTech;
                    *pHVar2 = (pSVar1->hul).ihuldef;
                }
                *(char *)pHVar6 = (char)(pSVar5->hul).ihuldef;
                local_a4._123_2_ = local_a4._123_2_ & 0xfdff | 0x200;
                FChangeAiShdef(local_a4, 0);
                FCreateAiShdef(0, 5, (byte *)vrgMacAip + vrgMacIshAip[10]);
            }
            return;
        }
        if (((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0) &&
            ((ish == 5 || (((*(uint *)((int)&rgshdef[0].wFlags + (ish + -1) * 0x93) >> 9 & 1) == 0 &&
                            (0x14 < game.turn - *(int *)((int)&rgshdef[0].turn + (ish + -1) * 0x93))))))) {
            if (ish == 5) {
                local_a4._146_2_ = 0xb;
            } else {
                local_a4._146_2_ = 0xf;
            }
            if (ish == 7) {
                sVar3 = Random(2);
                if (sVar3 == 0) {
                    local_a4._146_2_ = 0xf;
                } else {
                    local_a4._146_2_ = 0xb;
                }
            }
            sVar3 = Random(3);
            if ((sVar3 == 0) || (sVar3 = FCreateAiShdef(ish, 0x1d, (byte *)vrgMacAip + vrgMacIshAip[0x1d]), sVar3 == 0)) {
                for (i = 0; i < 5; i = i + 1) {
                    sVar3 = Random(4);
                    sVar3 = FCreateAiShdef(ish, 9, (byte *)vrgMacAip + ((ushort *)vrgMacIshAip)[sVar3 + local_a4._146_2_]);
                    if (sVar3 != 0)
                        break;
                }
            }
        }
        ish = ish + 1;
    } while (true);
}

// ======================================================================
// Function: FRetargetMiner
// Address: 10a0:336c
// Segment: MEMORY_AI3
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10a03402) */

short FRetargetMiner(FLEET *lpfl)

{
    PLANET *pPVar1;
    int     iVar2;
    uint    uVar3;
    uint    uVar4;
    short   sVar5;
    long    lVar6;
    POINT   pt1;
    POINT   pt2;
    PLANET *lpplBest;
    short   ipl;
    short   cConcCur;
    PLANET *lppl;
    short   cConcBest;
    ORDER   ord;
    short   cConc;

    lpplBest = 0;
    cConcCur = 0;
    cConcBest = 0;
    ipl = 0;
    while (true) {
        if (vclpplAi <= ipl)
            break;
        /* WARNING: Load size is inaccurate */
        pPVar1 = ((PLANET **)vrglpplAi)[ipl];
        iVar2 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
        lppl = (PLANET *)CONCAT22(iVar2, pPVar1);
        if ((pPVar1 == 0) && (iVar2 == 0))
            break;
        pt2.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
        pt2.x = ((POINT *)rgptPlan + lppl->id)->x;
        pt1.y = (((FLEET *)lpfl)->pt).y;
        pt1.x = (&((FLEET *)lpfl)->pt)->x;
        lVar6 = LDistance2(pt1, pt2);
        if (lVar6 < 0x1440) {
            uVar4 = (uint)pPVar1->rgMinConc[0] * 8 + (uint)pPVar1->rgMinConc[1] * 10 + (uint)pPVar1->rgMinConc[2] * 7;
            uVar3 = uVar4;
            if (lppl->id != ((FLEET *)lpfl)->idPlanet) {
                uVar3 = cConcCur;
            }
            cConcCur = uVar3;
            if ((uint)cConcBest < uVar4) {
                lpplBest = (PLANET *)CONCAT22(iVar2, pPVar1);
                cConcBest = uVar4;
            }
        }
        ipl = ipl + 1;
    }
    if ((((PLANET *)lpplBest == 0) && (lpplBest._2_2_ == 0)) || (cConcBest <= (cConcCur * 6) / 5)) {
        sVar5 = 0;
    } else {
        ord.id = lpplBest->id;
        ord.pt.x = ((POINT *)rgptPlan + lpplBest->id)->x;
        ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplBest->id * 4);
        ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe000 | 0x1160;
        sVar5 = FMoveAiFleet(lpfl, &ord, 0);
    }
    return sVar5;
}

// ======================================================================
// Function: IdTargetMacFreighter
// Address: 10a0:3524
// Segment: MEMORY_AI3
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10a03c5f) */
/* WARNING: Removing unreachable block (ram,0x10a03dcb) */
/* WARNING: Removing unreachable block (ram,0x10a03d80) */
/* WARNING: Removing unreachable block (ram,0x10a037e9) */
/* WARNING: Removing unreachable block (ram,0x10a037a9) */
/* WARNING: Removing unreachable block (ram,0x10a0365d) */
/* WARNING: Removing unreachable block (ram,0x10a0363b) */
/* WARNING: Removing unreachable block (ram,0x10a0378e) */
/* WARNING: Removing unreachable block (ram,0x10a037c9) */
/* WARNING: Removing unreachable block (ram,0x10a03b31) */
/* WARNING: Removing unreachable block (ram,0x10a03dac) */
/* WARNING: Removing unreachable block (ram,0x10a03dea) */
/* WARNING: Removing unreachable block (ram,0x10a03c81) */

short IdTargetMacFreighter(FLEET *lpfl)

{
    uint      *puVar1;
    int       *piVar2;
    int        iVar3;
    PLANET    *pPVar4;
    int        iVar5;
    uint       uVar6;
    PLANET    *pPVar7;
    POINT      pt1;
    POINT      pt1_00;
    POINT      pt1_01;
    POINT      pt2;
    POINT      pt2_00;
    POINT      pt2_01;
    short      sVar8;
    short      sVar9;
    uint       uVar10;
    int        iVar11;
    FLEET     *pFVar12;
    int        iVar13;
    undefined2 uVar14;
    ulong      uVar15;
    ulong      uVar16;
    long       lVar17;
    long       lVar18;
    undefined2 uVar19;
    undefined2 uVar20;
    short      iM;
    PLANET    *lpplBest;
    short      ipl;
    long       lDist;
    short      i;
    short      pctKilled;
    PLANET    *lppl;
    short      cResLost;
    short      pctCapHere;
    short      pctCapMost;
    PLANET    *lpplHere;
    ORDER      ord;
    short      cResGain;
    long       cColHaul;
    short      cResGainMost;
    long       cColLeft;
    long       cMax;

    uVar14 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar12 = (FLEET *)lpfl;
    if (pFVar12->idPlanet == -1) {
        lpplHere = 0;
    } else {
        lpplHere = LpplFromId(pFVar12->idPlanet);
        iVar11 = (int)((ulong)lpplHere >> 0x10);
        pPVar7 = (PLANET *)lpplHere;
        if (((((pPVar7 != 0) || (iVar11 != 0)) && (pPVar7->iPlayer == idPlayer)) && (sVar8 = PctPlanetCapacity(lpplHere), 0x19 < sVar8)) &&
            ((iVar3 = *(int *)((int)pPVar7->rgwtMin + 0xe), 0 < iVar3 || ((-1 < iVar3 && (999 < *(uint *)(pPVar7->rgwtMin + 3))))))) {
            uVar15 = LGetFleetStat(lpfl, grStatCargo);
            for (i = 0; i < 3; i = i + 1) {
                uVar15 = uVar15 - CONCAT22(*(undefined2 *)((int)(pFVar12->rgwtMin + i) + 2), (int)pFVar12->rgwtMin[i]);
            }
            uVar16 = __aFldiv(CONCAT22(*(undefined2 *)((int)pPVar7->rgwtMin + 0xe), (int)pPVar7->rgwtMin[3]), 0x14);
            if ((long)uVar16 < (long)uVar15) {
                uVar15 = uVar16;
            }
            cColHaul._2_2_ = (int)(uVar15 >> 0x10);
            cColHaul._0_2_ = (uint)uVar15;
            if (0 < (long)uVar15) {
                sVar8 = CResourcesAtPlanet(lpplHere, idPlayer);
                puVar1 = (uint *)(pPVar7->rgwtMin + 3);
                uVar6 = *puVar1;
                *puVar1 = *puVar1 - (uint)cColHaul;
                piVar2 = (int *)((int)pPVar7->rgwtMin + 0xe);
                *piVar2 = (*piVar2 - cColHaul._2_2_) - (uint)(uVar6 < (uint)cColHaul);
                sVar9 = CResourcesAtPlanet(lpplHere, idPlayer);
                iVar3 = sVar8 - sVar9;
                puVar1 = (uint *)(pPVar7->rgwtMin + 3);
                uVar6 = *puVar1;
                *puVar1 = *puVar1 + (uint)cColHaul;
                piVar2 = (int *)((int)pPVar7->rgwtMin + 0xe);
                *piVar2 = *piVar2 + cColHaul._2_2_ + (uint)CARRY2(uVar6, (uint)cColHaul);
                lpplBest = 0;
                cResGainMost = 0;
                for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
                    /* WARNING: Load size is inaccurate */
                    pPVar4 = ((PLANET **)vrglpplAi)[ipl];
                    iVar5 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
                    lppl = (PLANET *)CONCAT22(iVar5, pPVar4);
                    if ((pPVar4 == 0) && (iVar5 == 0))
                        break;
                    if (((pPVar4 != pPVar7) || (iVar5 != iVar11)) &&
                        (((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 0xe] & 1) == 0 &&
                          (pt1.y = (pFVar12->pt).y, pt1.x = (&pFVar12->pt)->x, pt2.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4),
                           pt2.x = ((POINT *)rgptPlan + lppl->id)->x, lVar18 = LDistance2(pt1, pt2), lVar18 < 0x9c41)))) {
                        if (lVar18 < 0x57e5) {
                            if (lVar18 < 0x2711) {
                                if (lVar18 < 0x9c5) {
                                    pctKilled = 3;
                                } else {
                                    pctKilled = 6;
                                }
                            } else {
                                pctKilled = 9;
                            }
                        } else {
                            pctKilled = 0xc;
                        }
                        uVar20 = 0;
                        uVar19 = 100;
                        uVar16 = __aFulmul(uVar15, (long)pctKilled);
                        lVar18 = __aFldiv(uVar16, CONCAT22(uVar20, uVar19));
                        uVar10 = (uint)(uVar15 - lVar18);
                        iVar13 = (int)(uVar15 - lVar18 >> 0x10);
                        puVar1 = (uint *)(pPVar4->rgwtMin + 3);
                        uVar6 = *puVar1;
                        *puVar1 = *puVar1 + uVar10;
                        piVar2 = (int *)((int)pPVar4->rgwtMin + 0xe);
                        *piVar2 = *piVar2 + iVar13 + (uint)CARRY2(uVar6, uVar10);
                        sVar8 = CResourcesAtPlanet((PLANET *)CONCAT22(iVar5, pPVar4), idPlayer);
                        puVar1 = (uint *)(pPVar4->rgwtMin + 3);
                        uVar6 = *puVar1;
                        *puVar1 = *puVar1 - uVar10;
                        piVar2 = (int *)((int)pPVar4->rgwtMin + 0xe);
                        *piVar2 = (*piVar2 - iVar13) - (uint)(uVar6 < uVar10);
                        sVar9 = CResourcesAtPlanet((PLANET *)CONCAT22(iVar5, pPVar4), idPlayer);
                        if (cResGainMost < sVar8 - sVar9) {
                            lpplBest = (PLANET *)CONCAT22(iVar5, pPVar4);
                            cResGainMost = sVar8 - sVar9;
                        }
                    }
                }
                if (((((PLANET *)lpplBest != 0) || (lpplBest._2_2_ != 0)) && (iVar3 + 5 <= cResGainMost)) &&
                    (((iVar3 + 10 <= cResGainMost || (game.turn < 0x51)) && ((iVar3 + 0xf <= cResGainMost || (game.turn < 0xa1)))))) {
                    ChangeMainObjSel(2, lpfl->id);
                    XferAiSupply(1, pFVar12->idPlanet, 2, lpfl->id, 3, (uint)cColHaul);
                    FLookupFleet(lpfl->id, (FLEET *)&sel.fl);
                    ((byte *)vlpbAiPlanet)[lpplBest->id * 0x10 + 0xe] = ((byte *)vlpbAiPlanet)[lpplBest->id * 0x10 + 0xe] | 1;
                    goto AI3_LMoveToLpplBest;
                }
            }
        }
    }
    if (((PLANET *)lpplHere != 0) || (lpplHere._2_2_ != 0)) {
        for (iM = 0; iM < 3; iM = iM + 1) {
            uVar6 = *(uint *)((int)(((PLANET *)lpplHere)->rgwtMin + iM) + 2);
            if ((-1 < (int)uVar6) && ((0 < (int)uVar6 || (0x9c3 < *(uint *)(((PLANET *)lpplHere)->rgwtMin + iM)))))
                break;
        }
        if (iM < 3) {
            lpplBest = 0;
            cMax._0_2_ = 1000;
            cMax._2_2_ = 0;
            for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
                /* WARNING: Load size is inaccurate */
                pPVar7 = ((PLANET **)vrglpplAi)[ipl];
                iVar11 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
                lppl = (PLANET *)CONCAT22(iVar11, pPVar7);
                if ((pPVar7 == 0) && (iVar11 == 0))
                    break;
                if (((pPVar7 != (PLANET *)lpplHere) || (iVar11 != lpplHere._2_2_)) &&
                    (pt1_00.y = (pFVar12->pt).y, pt1_00.x = (&pFVar12->pt)->x, pt2_00.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4),
                     pt2_00.x = ((POINT *)rgptPlan + lppl->id)->x, lVar18 = LDistance2(pt1_00, pt2_00), lVar18 < 0x9c41)) {
                    uVar6 = *(uint *)((int)(pPVar7->rgwtMin + iM) + 2);
                    if (((int)uVar6 <= cMax._2_2_) && (((int)uVar6 < cMax._2_2_ || (*(uint *)(pPVar7->rgwtMin + iM) < (uint)cMax)))) {
                        cMax._0_2_ = *(uint *)(pPVar7->rgwtMin + iM);
                        cMax._2_2_ = *(int *)((int)(pPVar7->rgwtMin + iM) + 2);
                        lpplBest = (PLANET *)CONCAT22(iVar11, pPVar7);
                    }
                }
            }
            if (((((PLANET *)lpplBest != 0) || (lpplBest._2_2_ != 0)) && (cMax._2_2_ < 1)) && ((cMax._2_2_ < 0 || ((uint)cMax < 200)))) {
                lVar18 = LGetFleetStat(lpfl, grStatCargo);
                for (i = 0; i < 3; i = i + 1) {
                    lVar18 = lVar18 - CONCAT22(*(undefined2 *)((int)(pFVar12->rgwtMin + i) + 2), (int)pFVar12->rgwtMin[i]);
                }
                lVar17 = __aFldiv(CONCAT22(*(undefined2 *)((int)(((PLANET *)lpplHere)->rgwtMin + iM) + 2), (int)((PLANET *)lpplHere)->rgwtMin[iM]), 5);
                if (lVar17 < lVar18) {
                    lVar18 = lVar17;
                }
                cColHaul._0_2_ = (uint)lVar18;
                if (0 < lVar18) {
                    ChangeMainObjSel(2, lpfl->id);
                }
                XferAiSupply(1, pFVar12->idPlanet, 2, lpfl->id, iM, (uint)cColHaul);
                FLookupFleet(lpfl->id, (FLEET *)&sel.fl);
                goto AI3_LMoveToLpplBest;
            }
        }
    }
    lpplBest = 0;
    pctCapMost = 0;
    for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
        /* WARNING: Load size is inaccurate */
        pPVar7 = ((PLANET **)vrglpplAi)[ipl];
        iVar11 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
        lppl = (PLANET *)CONCAT22(iVar11, pPVar7);
        if ((pPVar7 == 0) && (iVar11 == 0))
            break;
        if (((pPVar7 != (PLANET *)lpplHere) || (iVar11 != lpplHere._2_2_)) &&
            (pt1_01.y = (pFVar12->pt).y, pt1_01.x = (&pFVar12->pt)->x, pt2_01.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4),
             pt2_01.x = ((POINT *)rgptPlan + lppl->id)->x, lVar18 = LDistance2(pt1_01, pt2_01), lVar18 < 0x9c41)) {
            pctCapHere = PctPlanetCapacity((PLANET *)CONCAT22(iVar11, pPVar7));
            if (lVar18 < 0x57e5) {
                if (lVar18 < 0x2711) {
                    if (0x9c4 < lVar18) {
                        pctCapHere = pctCapHere + -2;
                    }
                } else {
                    pctCapHere = pctCapHere + -4;
                }
            } else {
                pctCapHere = pctCapHere + -6;
            }
            if (pctCapMost < pctCapHere) {
                lpplBest = (PLANET *)CONCAT22(iVar11, pPVar7);
                pctCapMost = pctCapHere;
            }
        }
    }
    if (((PLANET *)lpplBest == 0) && (lpplBest._2_2_ == 0)) {
        return -1;
    }
AI3_LMoveToLpplBest:
    _memset(&ord, 0, 0x12);
    ord.pt.x = ((POINT *)rgptPlan + lpplBest->id)->x;
    ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplBest->id * 4);
    ord.id = lpplBest->id;
    ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe000 | 0x1141;
    for (i = 0; i < 4; i = i + 1) {
        *(uint *)((int)&ord.u_ORDER_0x0008 + i * 2) = *(uint *)((int)&ord.u_ORDER_0x0008 + i * 2) & 0xfff | 0x2000;
    }
    sVar8 = FMoveAiFleet(lpfl, &ord, 0);
    if (sVar8 == 0) {
        sVar8 = -1;
    } else {
        sVar8 = lpplBest->id;
    }
    return sVar8;
}

// ======================================================================
// Function: TargetMacArmada
// Address: 10a0:3e3a
// Segment: MEMORY_AI3
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10a03e99) */

void TargetMacArmada(FLEET *lpfl)

{
    short     *psVar1;
    ORDER     *pOVar2;
    undefined2 uVar3;
    POINT      pt1;
    POINT      pt2;
    PLANET    *pPVar4;
    short      sVar5;
    int        iVar6;
    FLEET     *pFVar7;
    short     *psVar8;
    ORDER     *pOVar9;
    undefined2 uVar10;
    undefined2 unaff_SS;
    long       lVar11;
    FLEET     *pFVar12;
    PLANET    *lpplTarget;
    short      cshWar;
    PLANET    *lppl;
    short      cshBomb;
    ORDER      ord;
    FLEET     *lpflTarget;

    uVar10 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar7 = (FLEET *)lpfl;
    if (1 < pFVar7->cord) {
        uVar3 = *(undefined2 *)((int)&pFVar7->lpplord + 2);
        psVar8 = (short *)(*(int *)&pFVar7->lpplord + 0x16);
        pOVar9 = &ord;
        for (iVar6 = 9; iVar6 != 0; iVar6 = iVar6 + -1) {
            pOVar2 = pOVar9;
            pOVar9 = &(pOVar9->pt).y;
            psVar1 = psVar8;
            psVar8 = psVar8 + 1;
            (pOVar2->pt).x = *psVar1;
        }
        pt1.y = (pFVar7->pt).y;
        pt1.x = (&pFVar7->pt)->x;
        pt2.y = ord.pt.y;
        pt2.x = ord.pt.x;
        lVar11 = LDistance2(pt1, pt2);
        if ((lVar11 < 0xf425) || ((ord.wFlags_0x6 >> 8 & 0xf) != 2)) {
            if ((ord.wFlags_0x6 >> 8 & 0xf) == 2) {
                return;
            }
            if ((ord.wFlags_0x6 >> 8 & 0xf) == 1) {
                lppl = LpplFromId(ord.id);
                iVar6 = (int)((ulong)lppl >> 0x10);
                pPVar4 = (PLANET *)lppl;
                if ((pPVar4 == 0) && (iVar6 == 0)) {
                    return;
                }
                if (pPVar4->iPlayer != -1) {
                    if (pPVar4->iPlayer != idPlayer) {
                        return;
                    }
                    if ((pPVar4->wFlags_0x4 >> 9 & 1) != 0) {
                        return;
                    }
                }
                if (pPVar4->turn != game.turn) {
                    return;
                }
            }
        }
    }
    FPotentMacWarFleet(lpfl, &cshWar);
    cshBomb = pFVar7->rgcsh[8] + pFVar7->rgcsh[9];
    pFVar7->wFlags_0x4 = pFVar7->wFlags_0x4 & 0x7fff | 0x8000;
    ChangeMainObjSel(2, lpfl->id);
    if (pFVar7->idPlanet == -1) {
        MoveToNearestPlanetOrEnemy(lpfl, 0x1c2);
        return;
    }
    lppl = LpplFromId(pFVar7->idPlanet);
    uVar10 = (undefined2)((ulong)lppl >> 0x10);
    if (((PLANET *)lppl)->iPlayer == idPlayer) {
        if ((cshWar < (int)(uint)vrgAiArmadaPotency[0]) || (cshBomb < (int)(uint)vrgAiArmadaPotency[2])) {
            if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) < 2) {
                return;
            }
            if ((cshWar <= (int)((uint)vrgAiArmadaPotency[0] * 2)) && (cshWar < 0x3c)) {
                return;
            }
            sVar5 = Random(10);
            if ((4 < sVar5) && ((cshWar <= (int)((uint)vrgAiArmadaPotency[0] * 3) || (sVar5 = Random(10), 6 < sVar5)))) {
                if (cshWar < 0x79) {
                    return;
                }
                sVar5 = Random(10);
                if (6 < sVar5) {
                    return;
                }
            }
        }
    } else if ((cshWar < (int)(uint)vrgAiArmadaPotency[1]) || (cshBomb < (int)(uint)vrgAiArmadaPotency[3])) {
        ClearAiCurrentTask(lpfl, 0);
        if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) < 2) ||
            ((((cshWar <= (int)((uint)vrgAiArmadaPotency[0] * 2) || (sVar5 = Random(10), 4 < sVar5)) &&
               ((cshWar <= (int)((uint)vrgAiArmadaPotency[0] * 4) || (sVar5 = Random(10), 6 < sVar5)))) &&
              ((cshWar < 0x79 || (sVar5 = Random(10), 6 < sVar5)))))) {
            lpplTarget = LpplFindClosestEnum(lppl, FEnumOurStarbase);
            goto AI3_TargetEveryArmada;
        }
    } else if (((PLANET *)lppl)->iPlayer != -1) {
        return;
    }
    if ((game.wCrap >> 4 & 1) == 0) {
        lpplTarget = 0;
    } else {
        lpplTarget = LpplFindBestEnum(lppl, FEnumCalcArmadaHumanDest);
    }
    if (((PLANET *)lpplTarget == 0) && (lpplTarget._2_2_ == 0)) {
        lpplTarget = LpplFindBestEnum(lppl, FEnumCalcArmadaDest);
    }
AI3_TargetEveryArmada:
    if (((PLANET *)lpplTarget == 0) && (lpplTarget._2_2_ == 0)) {
        pFVar12 = LpflFindClosestEnum(lpfl, FEnumCalcEnemyFleets);
        iVar6 = (int)((ulong)pFVar12 >> 0x10);
        pFVar7 = (FLEET *)pFVar12;
        if ((pFVar7 == 0) && (iVar6 == 0)) {
            return;
        }
        ord.id = pFVar12->id;
        ord.wFlags_0x6 = ord.wFlags_0x6 & 0xf0ff | 0x200;
        ord.pt.x = (&pFVar7->pt)->x;
        ord.pt.y = (pFVar7->pt).y;
    } else {
        ((byte *)vlpbAiPlanet)[lpplTarget->id * 0x10 + 10] = ((byte *)vlpbAiPlanet)[lpplTarget->id * 0x10 + 10] | 0x80;
        ord.id = lpplTarget->id;
        ord.wFlags_0x6 = ord.wFlags_0x6 & 0xf0ff | 0x100;
        ord.pt.x = ((POINT *)rgptPlan + lpplTarget->id)->x;
        ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplTarget->id * 4);
    }
    ord.wFlags_0x6 = ord.wFlags_0x6 & 0xef00 | 0x1040;
    FMoveAiFleet(lpfl, &ord, 0);
    return;
}

// ======================================================================
// Function: FPotentMacWarFleet
// Address: 10a0:42ec
// Segment: MEMORY_AI3
// ======================================================================

short FPotentMacWarFleet(FLEET *lpfl, short *pcEquiv)

{
    short cEquiv;
    short ish;

    cEquiv = 0;
    ish = 2;
    while (true) {
        if (4 < ish)
            break;
        cEquiv = cEquiv + ((FLEET *)lpfl)->rgcsh[ish];
        ish = ish + 1;
    }
    for (ish = 5; ish < 8; ish = ish + 1) {
        cEquiv = cEquiv + ((FLEET *)lpfl)->rgcsh[ish] * 2;
    }
    if (cEquiv < (int)(uint)vrgAiArmadaPotency[0]) {
        for (ish = 8; ish < 10; ish = ish + 1) {
            if (((((FLEET *)lpfl)->rgcsh[ish] != 0) && ((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) == 0)) &&
                (*(int *)(ish * 0x93 + rgshdef) == 9)) {
                cEquiv = cEquiv + ((FLEET *)lpfl)->rgcsh[ish] * 2;
            }
        }
        if (cEquiv <= (int)(uint)vrgAiArmadaPotency[0]) {
            return 0;
        }
    }
    if (pcEquiv != 0) {
        *pcEquiv = cEquiv;
    }
    return 1;
}
