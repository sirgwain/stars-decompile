// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: ZipOrderDlg
// Address: 1080:0000
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Variable defined which should be unmapped: iAction */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short ZipOrderDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  short *psVar1;
  ZIPORDER *pZVar2;
  char cVar3;
  undefined2 uVar4;
  char *pcVar5;
  HDC hdc_00;
  HWND HVar6;
  short sVar7;
  int iVar8;
  ushort uVar9;
  undefined2 unaff_SI;
  short *psVar10;
  undefined2 unaff_DI;
  ZIPORDER *pZVar11;
  undefined2 unaff_SS;
  DWORD DVar12;
  ulong uVar13;
  char *pcVar14;
  char *pcVar15;
  undefined1 *puVar16;
  HDC HVar17;
  short iAction;
  short xCtr;
  short cch;
  char *pcStack_38;
  char *psz_2;
  char *pszT_2;
  HWND HStack_32;
  RECT rc;
  PAINTSTRUCT ps;
  short i;
  HDC hdc;
  
  if (message == WM_PAINT) {
    hdc_00 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    HVar6 = GetDlgItem(hwnd,0x431);
    GetWindowRect(HVar6,(undefined2 *)CONCAT22(unaff_SS,&stack0xffc8));
    ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&stack0xffc8));
    HVar6 = GetDlgItem(hwnd,0x434);
    GetWindowRect(HVar6,(undefined2 *)CONCAT22(unaff_SS,&rc));
    ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&rc.right));
    pszT_2 = (char *)rc.right;
    HStack_32 = rc.bottom;
    ExpandRc((RECT *)&stack0xffc8,dyArial8,dyArial8 >> 1);
    _Draw3dFrame();
    SelectObject(hdc_00,rghfontArial8[1]);
    SetBkColor(hdc_00,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    sVar7 = CchGetString(idsCustomOrders,(char *)szWork);
    TextOut(hdc_00,(short)(pcStack_38 + 8),(int)psz_2 - (dyArial8 >> 1),szWork,
            sVar7);
    psz_2 = (char *)(HStack_32 + 8);
    if (*(char *)((int)&vrgZip[0].fValid + iResTechNow * 0x18) == '\0') {
      sVar7 = CchGetString(idsEmptyCustomSlot,(char *)szWork);
      TextOut(hdc_00,0xc,(short)psz_2,szWork,sVar7);
    }
    else {
      DVar12 = GetTextExtent(hdc_00,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,DAT_1120_04d0),9);
      for (i = 0; i < 5; i = i + 1) {
        SetTextColor(hdc_00,CONCAT22(*(undefined2 *)(i * 4 + 0x44a),*(undefined2 *)(i * 4 + 0x448)))
        ;
        RightTextOut
                  (hdc_00,(int)DVar12 + 8,(short)psz_2,(char *)*(undefined2 *)(i * 2 + 0x4cc),0,0);
        SetTextColor(hdc_00,0);
        sVar7 = CchGetString
                          (((uint)(((ZIPORDER *)vrgZip)[iResTechNow].txp.rgia +
                                  i)->wFlags >> 0xc) + idsAction,(char *)szWork);
        if (*(char *)((int)(HCURSOR *)&hcurScanAdd + sVar7 + 1) == '.') {
          _WSPRINTF((LPSTR)((ulong)CONCAT22((((ZIPORDER *)vrgZip)[iResTechNow].
                                             txp.rgia + i)->wFlags,(undefined1 *)&DAT_1120_1120) &
                           0xfffffff),(LPCSTR)0x16ba1120,(char *)szBase + 0xff + sVar7);
        }
        iVar8 = (int)DVar12 + 0xe;
        puVar16 = (undefined1 *)&DAT_1120_1120;
        pcVar15 = (char *)szWork;
        pcVar5 = psz_2;
        HVar17 = hdc_00;
        uVar9 = _strlen((char *)szWork);
        TextOut(HVar17,iVar8,(short)pcVar5,(LPCSTR)CONCAT22(puVar16,pcVar15),uVar9);
        psz_2 = psz_2 + dyArial8;
      }
    }
    EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
    sVar7 = 1;
  }
  else if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar7 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      for (i = 0x431; i < 0x435; i = i + 1) {
        HStack_32 = (HWND)lParam;
        HVar6 = GetDlgItem(hwnd,i);
        if (HStack_32 == HVar6) break;
      }
      if (i < 0x435) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        HVar6 = hwnd;
        pcVar5 = PszGetCompressedString(idsCustomizeZipOrders);
        SetWindowText(HVar6,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar5));
        HVar6 = GetDlgItem(hwnd,0x417);
        ShowWindow(HVar6,0);
        hwndZipOrderDlg = hwnd;
        CheckRadioButton(hwnd,0x431,0x434,0x431);
        EnableZipBtns(hwnd,0);
        iResTechNow = 0;
        for (i = 0x431; i < 0x435; i = i + 1) {
          if (*(char *)((int)&vrgZip[0].fValid + (i + -0x431) * 0x18) == '\0') {
            pszT_2 = PszGetCompressedString(idsUnusedD);
            _WSPRINTF((LPSTR)CONCAT22(i + -0x430,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pszT_2,(char *)&DAT_1120_1120),(char *)szWork);
          }
          else {
            psz_2 = (char *)szWork;
            pcVar5 = psz_2;
            pszT_2 = (char *)((int)vrgZip[0].szName + (i + -0x431) * 0x18);
            while (psz_2 = pcVar5, *pszT_2 != '\0') {
              pcVar15 = pszT_2 + 1;
              cVar3 = *pszT_2;
              *psz_2 = cVar3;
              pcVar5 = psz_2 + 1;
              pszT_2 = pcVar15;
              if (cVar3 == '&') {
                psz_2[1] = '&';
                pcVar5 = psz_2 + 2;
              }
            }
            *psz_2 = '\0';
          }
          pszT_2 = (char *)szWork;
          HStack_32 = GetDlgItem(hwnd,i);
          SetWindowText(HStack_32,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pszT_2));
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyZipOrderDlg,1);
        if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
          AdvanceTutor();
        }
        return 1;
      }
      if (message == WM_COMMAND) {
        uVar13 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),iAction);
        if ((((int)uVar13 == 0) && (0x430 < wParam)) && (wParam < 0x435)) {
          iResTechNow = wParam - 0x431;
          EnableZipBtns(hwnd,iResTechNow);
          InvalidateRect(hwnd,(undefined2 *)0x0,1);
        }
        else {
          if ((wParam == 1) || (wParam == 2)) {
            hwndZipOrderDlg = 0;
            StickyDlgPos(hwnd,(POINT *)&ptStickyZipOrderDlg,0);
            EndDialog(hwnd,(uint)(wParam == 1));
            if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
              AdvanceTutor();
            }
            return 1;
          }
          if ((wParam == 0x816) || (wParam == 0x41b)) {
            if (*(char *)((int)&vrgZip[0].fValid + iResTechNow * 0x18) == '\0')
            {
              sVar7 = iResTechNow;
              pcVar5 = PszGetCompressedString(idsCustomD);
              _WSPRINTF((LPSTR)CONCAT22(sVar7,(char *)&DAT_1120_1120),
                        (LPCSTR)CONCAT22(pcVar5,(char *)&DAT_1120_1120),(char *)szWork);
            }
            else {
              _strcpy((char *)szWork,
                              (char *)((int)vrgZip[0].szName +
                                      iResTechNow * 0x18));
            }
            pcVar14 = MakeProcInstance(RenameZipDlg,hInst);
            HStack_32 = (HWND)((ulong)pcVar14 >> 0x10);
            pszT_2 = (char *)pcVar14;
            sVar7 = DialogBox(0,(LPCSTR)CONCAT22(0x7e3,hwndFrame),HStack_32,pszT_2);
            if (sVar7 != 0) {
              if (szWork[0] == '\0') {
                sVar7 = iResTechNow;
                pcVar5 = PszGetCompressedString(idsCustomD);
                _WSPRINTF((LPSTR)CONCAT22(sVar7,(char *)&DAT_1120_1120),
                          (LPCSTR)CONCAT22(pcVar5,(char *)&DAT_1120_1120),(char *)szWork);
              }
              _strcpy((char *)((int)vrgZip[0].szName +
                                      iResTechNow * 0x18),(char *)szWork);
              pcStack_38 = (char *)szWork + 0x40;
              psz_2 = (char *)szWork;
              pcVar5 = pcStack_38;
              while (pcStack_38 = pcVar5, *psz_2 != '\0') {
                pcVar15 = psz_2 + 1;
                cVar3 = *psz_2;
                *pcStack_38 = cVar3;
                pcVar5 = pcStack_38 + 1;
                psz_2 = pcVar15;
                if (cVar3 == '&') {
                  pcStack_38[1] = '&';
                  pcVar5 = pcStack_38 + 2;
                }
              }
              *pcStack_38 = '\0';
              HVar6 = GetDlgItem(hwnd,iResTechNow + 0x431);
              SetWindowText(HVar6,szWork + 0x40);
              if (wParam == 0x816) {
                *(undefined1 *)((int)&vrgZip[0].fValid + iResTechNow * 0x18) = 1
                ;
                uVar4 = sel.fl.lpplord._2_2_;
                psVar10 = (short *)((int)(PLORD *)sel.fl.lpplord +
                                   sel.iwpAct * 0x12 + 0xc);
                pZVar11 = (ZIPORDER *)vrgZip + iResTechNow;
                for (iVar8 = 5; iVar8 != 0; iVar8 = iVar8 + -1) {
                  pZVar2 = pZVar11;
                  pZVar11 = (ZIPORDER *)((pZVar11->txp).rgia + 1);
                  psVar1 = psVar10;
                  psVar10 = psVar10 + 1;
                  (pZVar2->txp).rgia[0].wFlags = *psVar1;
                }
                InvalidateRect(hwnd,(undefined2 *)0x0,1);
              }
              EnableZipBtns(hwnd,iResTechNow);
            }
            FreeProcInstance((char *)CONCAT22(HStack_32,pszT_2));
            SetFocus(hwnd);
            gd._4_2_ = gd._4_2_ & 0xffef | 0x10;
          }
          else if (wParam == 0x817) {
            *(undefined1 *)((int)&vrgZip[0].fValid + iResTechNow * 0x18) = 0;
            iVar8 = iResTechNow + 1;
            pcVar5 = PszGetCompressedString(idsUnusedD);
            _WSPRINTF((LPSTR)CONCAT22(iVar8,(char *)&DAT_1120_1120),
                      (LPCSTR)CONCAT22(pcVar5,(char *)&DAT_1120_1120),(char *)szWork);
            HVar6 = GetDlgItem(hwnd,iResTechNow + 0x431);
            SetWindowText(HVar6,szWork);
            InvalidateRect(hwnd,(undefined2 *)0x0,1);
            gd._4_2_ = gd._4_2_ & 0xffef | 0x10;
          }
          else if (wParam == 0x76) {
            WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x44a);
            return 1;
          }
        }
      }
    }
    sVar7 = 0;
  }
  return sVar7;
}



// ======================================================================
// Function: EnableZipBtns
// Address: 1080:0832
// Segment: MEMORY_SHIP2
// ======================================================================


void EnableZipBtns(HWND hwnd,short iSel)

{
  uint uVar1;
  HWND HVar2;
  short fEnabled;
  
  uVar1 = (uint)*(byte *)((int)&vrgZip[0].fValid + iSel * 0x18);
  HVar2 = GetDlgItem(hwnd,0x817);
  EnableWindow(HVar2,uVar1);
  HVar2 = GetDlgItem(hwnd,0x41b);
  EnableWindow(HVar2,uVar1);
  return;
}



// ======================================================================
// Function: RenameZipDlg
// Address: 1080:0880
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Variable defined which should be unmapped: rc */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short RenameZipDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char *pcVar1;
  HWND HVar2;
  uint uVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar4;
  RECT rc;
  short ids;
  
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    uVar4 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),rc.left);
    if ((int)uVar4 == 6) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return hbrButtonFace;
    }
  }
  else {
    if (message == WM_INITDIALOG) {
      if (hwndZipOrderDlg == 0) {
        ids = 0x4c3;
      }
      else {
        ids = 0x4c2;
      }
      HVar2 = hwnd;
      pcVar1 = PszGetCompressedString(ids);
      SetWindowText(HVar2,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar1));
      SetWindowPos(hwnd,0,ptStickyRenameDlg.x + 0x46,ptStickyRenameDlg.y + 0x46,0,0,
                   0x15);
      SendDlgItemMessage(hwnd,0x10c,0x415,0xc,0);
      HVar2 = GetDlgItem(hwnd,0x10c);
      SetWindowText(HVar2,szWork);
      StickyDlgPos(hwnd,(POINT *)&ptStickyRenameDlg,1);
      return 1;
    }
    if (message == WM_COMMAND) {
      if ((wParam == 1) || (wParam == 2)) {
        if (wParam == 1) {
          GetDlgItemText(hwnd,0x10c,szWork,0xe);
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyRenameDlg,0);
        EndDialog(hwnd,(uint)(wParam == 1));
        return 1;
      }
      if (wParam == 0x76) {
        if (hwndZipOrderDlg == 0) {
          uVar3 = 0x452;
        }
        else {
          uVar3 = 0xc1f;
        }
        WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,(ulong)uVar3);
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: RenameDlg
// Address: 1080:0a68
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lSel */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short RenameDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char *pcVar1;
  HWND HVar2;
  short sVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar4;
  LRESULT LVar5;
  long lSel;
  RECT rc;
  
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar3 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      uVar4 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),(ushort)lSel);
      if ((int)uVar4 == 6) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        HVar2 = hwnd;
        pcVar1 = PszGetCompressedString(idsRenameFleet);
        SetWindowText(HVar2,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar1));
        SetWindowPos(hwnd,0,ptStickyRenameDlg.x + 0x46,ptStickyRenameDlg.y + 0x46,0,0,
                     0x15);
        SendDlgItemMessage(hwnd,0x10c,0x415,0x1f,0);
        HVar2 = GetDlgItem(hwnd,0x10c);
        SetWindowText(HVar2,szWork);
        StickyDlgPos(hwnd,(POINT *)&ptStickyRenameDlg,1);
        return 1;
      }
      if (message == WM_COMMAND) {
        if ((wParam == 1) || (wParam == 2)) {
          if (wParam == 1) {
            GetDlgItemText(hwnd,0x10c,szWork,0x20);
            FStringFitsScreen(szWork,0xa0);
          }
          StickyDlgPos(hwnd,(POINT *)&ptStickyRenameDlg,0);
          EndDialog(hwnd,(uint)(wParam == 1));
          return 1;
        }
        if (((wParam == 0x10c) &&
            (uVar4 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),(ushort)lSel),
            (int)uVar4 == 0x400)) && (fInEditUpdate == 0)) {
          fInEditUpdate = 1;
          GetWindowText((HWND)lParam,szWork,0xfa);
          LVar5 = SendMessage((HWND)lParam,0x400,0,0);
          sVar3 = FStringFitsScreen(szWork,0xa0);
          if (sVar3 == 0) {
            SetWindowText((HWND)lParam,szWork);
            SendMessage((HWND)lParam,0x401,0,LVar5);
          }
          fInEditUpdate = 0;
        }
        else if (wParam == 0x76) {
          WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x447);
          return 1;
        }
      }
    }
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: FStargateJump
// Address: 1080:0cfe
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x108013ce) */

short FStargateJump(FLEET *lpfl,short isbsSrc,short isbsDst,short dDist)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  short sVar3;
  uint uVar4;
  int iVar5;
  PLORD *pPVar6;
  undefined2 unaff_SI;
  FLEET *pFVar7;
  FLEET *pFVar8;
  undefined2 unaff_DI;
  undefined2 uVar9;
  undefined2 unaff_SS;
  bool bVar10;
  ulong uVar11;
  long lVar12;
  ulong uVar13;
  long lVar14;
  ulong uVar15;
  undefined4 uVar16;
  ushort in_stack_0000feb8;
  FLEET flDead;
  short cshDamagedOld;
  short dpPerShdefOld;
  long dp;
  short ishdef;
  short cshdef;
  short rgpct [16];
  short pct;
  long cshKill;
  short idm;
  long cshOrig;
  short i;
  byte pctKill;
  short cshT;
  FLEET flSrc;
  short id;
  POINT pt;
  short dpShdef;
  short dpPerShdefNew;
  
  lVar14 = CONCAT22(unaff_SI,unaff_DI);
  cshdef = 0;
  cshKill._0_2_ = 0;
  cshKill._2_2_ = 0;
  _memset(rgpct,0,0x20);
  pFVar8 = &flSrc;
  pFVar7 = (FLEET *)lpfl;
  for (iVar5 = 0x3e; iVar5 != 0; iVar5 = iVar5 + -1) {
    pFVar2 = pFVar8;
    pFVar8 = (FLEET *)&pFVar8->iPlayer;
    pFVar1 = pFVar7;
    pFVar7 = (FLEET *)&pFVar7->iPlayer;
    pFVar2->id = pFVar1->id;
  }
  uVar9 = (undefined2)((ulong)flSrc.lpplord >> 0x10);
  pPVar6 = (PLORD *)flSrc.lpplord;
  if (((uint)(pPVar6 + 7)->wFlags >> 8 & 0xf) == 1) {
    id = *(short *)&pPVar6[6].iordMax;
  }
  else {
    id = 0;
    while ((id < game.cPlanMax &&
           ((*(int *)&pPVar6[5].iordMax != ((POINT *)rgptPlan + id)->x ||
            ((pPVar6 + 6)->wFlags != *(int *)((int)&rgptPlan[0].y + id * 4)))))) {
      id = id + 1;
    }
  }
  ishdef = 0;
  do {
    if (0xf < ishdef) {
      if (cshdef != 0) {
        _memset(&flDead,0,0x7c);
        for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
          if ((flSrc.rgcsh[ishdef] != 0) && (rgpct[ishdef] != 0)) {
            if (rgpct[ishdef] == 100) {
              uVar4 = flSrc.rgcsh[ishdef];
              bVar10 = CARRY2((uint)cshKill,uVar4);
              cshKill._0_2_ = (uint)cshKill + uVar4;
              cshKill._2_2_ = cshKill._2_2_ + ((int)uVar4 >> 0xf) + (uint)bVar10;
              flSrc.rgcsh[ishdef] = 0;
              (flSrc.rgdv + ishdef)->dp = 0;
              cshdef = cshdef + -1;
            }
            else {
              cshT = flSrc.rgcsh[ishdef];
              sVar3 = GetRaceStat((PLAYER *)rgplr + ((FLEET *)lpfl)->iPlayer,
                                        rsMajorAdv);
              if (sVar3 == 7) {
                pctKill = 0;
              }
              else {
                pctKill = (byte)(rgpct[ishdef] / 3);
              }
              iVar5 = ((FLEET *)lpfl)->iPlayer * 4;
              iVar5 = *(int *)(*(int *)(iVar5 + 0xfe) + ishdef * 0x93 + 0x38);
              if ((flSrc.rgdv + ishdef)->dp == 0) {
                cshDamagedOld = 0;
              }
              else {
                lVar12 = 100;
                uVar11 = __aFulmul((long)cshT,
                                           (ulong)(uint)(flSrc.rgdv + ishdef)->dp & 0xffff007f);
                lVar12 = __aFldiv(uVar11,lVar12);
                cshDamagedOld = (short)lVar12;
                if (cshDamagedOld == 0) {
                  cshDamagedOld = 1;
                }
              }
              if (pctKill != 0) {
                for (i = 0; i < flSrc.rgcsh[ishdef]; i = i + 1) {
                  sVar3 = Random(100);
                  if (((sVar3 < (int)(uint)pctKill) && (cshT = cshT + -1, cshDamagedOld != 0)) &&
                     (uVar4 = Random(500), uVar4 < (uint)(flSrc.rgdv + ishdef)->dp >> 7)) {
                    cshDamagedOld = cshDamagedOld + -1;
                  }
                }
                uVar4 = flSrc.rgcsh[ishdef] - cshT;
                bVar10 = CARRY2((uint)cshKill,uVar4);
                cshKill._0_2_ = (uint)cshKill + uVar4;
                cshKill._2_2_ = cshKill._2_2_ + ((int)uVar4 >> 0xf) + (uint)bVar10;
              }
              if (cshT != 0) {
                if ((flSrc.rgdv + ishdef)->dp == 0) {
                  dpPerShdefOld = 0;
                }
                else {
                  lVar12 = 500;
                  uVar11 = __aFulmul((long)iVar5,
                                             (ulong)((uint)(flSrc.rgdv + ishdef)->dp >> 7));
                  lVar12 = __aFldiv(uVar11,lVar12);
                  dpPerShdefOld = (short)lVar12;
                  if (dpPerShdefOld == 0) {
                    dpPerShdefOld = 1;
                  }
                }
                lVar12 = 100;
                uVar11 = __aFulmul((long)iVar5,(long)rgpct[ishdef]);
                lVar12 = __aFldiv(uVar11,lVar12);
                dpPerShdefNew = (short)lVar12;
                if (dpPerShdefNew == 0) {
                  dpPerShdefNew = 1;
                }
                if ((cshDamagedOld != 0) && (iVar5 <= dpPerShdefNew + dpPerShdefOld)) {
                  bVar10 = CARRY2((uint)cshKill,cshDamagedOld);
                  cshKill._0_2_ = (uint)cshKill + cshDamagedOld;
                  cshKill._2_2_ = cshKill._2_2_ + (cshDamagedOld >> 0xf) + (uint)bVar10;
                  cshT = cshT - cshDamagedOld;
                }
                if (cshT != 0) {
                  uVar11 = __aFulmul((long)dpPerShdefOld,(long)cshDamagedOld);
                  in_stack_0000feb8 = (ushort)uVar11;
                  uVar13 = __aFulmul((long)dpPerShdefNew,(long)cshT);
                  lVar12 = (long)iVar5;
                  uVar15 = 500;
                  uVar11 = __aFldiv(uVar13 + CONCAT22((int)(uVar11 >> 0x10),
                                                              in_stack_0000feb8),(long)cshT);
                  uVar11 = __aFulmul(uVar11,uVar15);
                  lVar12 = __aFldiv(uVar11,lVar12);
                  pct = (short)lVar12;
                  if (pct == 0) {
                    pct = 1;
                  }
                  (flSrc.rgdv + ishdef)->dp = (flSrc.rgdv + ishdef)->dp & 0x7fU | pct << 7;
                  (flSrc.rgdv + ishdef)->dp = (flSrc.rgdv + ishdef)->dp & 0xff80U | 100;
                }
              }
              flSrc.rgcsh[ishdef] = cshT;
              if (cshT == 0) {
                (flSrc.rgdv + ishdef)->dp = 0;
                cshdef = cshdef + -1;
              }
            }
            flDead.rgcsh[ishdef] = ((FLEET *)lpfl)->rgcsh[ishdef] - flSrc.rgcsh[ishdef];
          }
        }
        if (cshdef != 0) {
          if (((uint)cshKill != 0) || (cshKill._2_2_ != 0)) {
            if (cshKill._2_2_ == 0) {
              lVar12 = __aFlshr(lVar14,in_stack_0000feb8);
              if ((lVar12 < 0) || ((lVar12 < 0x10000 && ((uint)lVar12 <= (uint)cshKill)))) {
                lVar14 = __aFlshr(lVar14,in_stack_0000feb8);
                if ((lVar14 < 0x10000) && ((lVar14 < 0 || ((uint)lVar14 < (uint)cshKill)))) {
                  idm = 0xea;
                }
                else {
                  idm = 0xe9;
                }
              }
              else {
                idm = 0xe8;
              }
              FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idm,lpfl->id | 0x8000,lpfl->id,
                               ((FLEET *)lpfl)->idPlanet,id,(uint)cshKill,0,0,0);
            }
            else {
              uVar16 = 0;
              uVar11 = __aFulshr(0,(ushort)lVar14);
              FSendPlrMsg(((FLEET *)lpfl)->iPlayer,
                               idmUsedStargateReachLosingUnbelievableShipsJump,lpfl->id | 0x8000,
                               lpfl->id,((FLEET *)lpfl)->idPlanet,id,(uint)cshKill,(short)uVar11,
                               (short)uVar16,(short)((ulong)uVar16 >> 0x10));
            }
            flDead.iPlayer = flSrc.iPlayer;
            flDead.wFlags = flDead.wFlags & 0xfb00U | 0x407;
            FleetTransferCargoBalance(&flSrc,&flDead);
          }
          pFVar8 = &flSrc;
          for (iVar5 = 0x3e; iVar5 != 0; iVar5 = iVar5 + -1) {
            pFVar2 = (FLEET *)lpfl;
            lpfl._0_2_ = (FLEET *)&((FLEET *)lpfl)->iPlayer;
            pFVar1 = pFVar8;
            pFVar8 = (FLEET *)&pFVar8->iPlayer;
            pFVar2->id = pFVar1->id;
          }
          return 1;
        }
      }
      ((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0xfbffU | 0x400;
      FSendPlrMsg(flSrc.iPlayer,idmHeedlessDangerAttemptedUseStargateReachFleet,
                       flSrc.id | 0x8000,flSrc.id,flSrc.idPlanet,id,0,0,0,0);
      return 0;
    }
    if (flSrc.rgcsh[ishdef] != 0) {
      iVar5 = cshdef + 1;
      sVar3 = MdCalcStargateDamage
                        (isbsSrc,isbsDst,dDist,
                         *(short *)(*(int *)(flSrc.iPlayer * 4 + 0xfe) + ishdef * 0x93 + 0x28),
                         rgpct + ishdef);
      if (sVar3 == -2) {
        FSendPlrMsg(flSrc.iPlayer,idmAttemptedUseStargateReachCouldBecauseShips,
                         flSrc.id | 0x8000,flSrc.id,flSrc.idPlanet,id,ishdef,0,0,0);
        return 0;
      }
      if (sVar3 == -1) {
        FSendPlrMsg(flSrc.iPlayer,idmAttemptedUseStargateReachCouldBecauseDestination,
                         flSrc.id | 0x8000,flSrc.id,flSrc.idPlanet,id,0,0,0,0);
        return 0;
      }
      if ((sVar3 != 0) && (cshdef = iVar5, sVar3 == 1)) {
        flSrc.wFlags = flSrc.wFlags & 0xbfffU | 0x4000;
      }
    }
    ishdef = ishdef + 1;
  } while( true );
}



// ======================================================================
// Function: MdCalcStargateDamage
// Address: 1080:152e
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x108015a5) */
/* WARNING: Removing unreachable block (ram,0x1080178c) */
/* WARNING: Removing unreachable block (ram,0x108016f9) */
/* WARNING: Removing unreachable block (ram,0x1080183b) */

short MdCalcStargateDamage(short isbsSrc,short isbsDst,short dDist,short wt,short *ppctDmg)

{
  short sVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  COMPART *pCVar5;
  undefined2 uVar6;
  ulong uVar7;
  undefined1 *puVar8;
  long lVar9;
  ulong uVar10;
  char *pcVar11;
  undefined1 *puVar12;
  long pctSurvive;
  long pctSurviveT;
  PART partSrc;
  PART partDst;
  long dBaseDistance;
  
  puVar8 = &DAT_0000_2710;
  partDst.hs.grhst = hstSpecialSB;
  partSrc.hs.grhst = hstSpecialSB;
  partSrc.hs.wFlags = partSrc.hs.wFlags & 0xff00U | isbsSrc & 0xffU;
  partDst.hs.wFlags = partDst.hs.wFlags & 0xff00U | isbsDst & 0xffU;
  FLookupPart(&partSrc);
  FLookupPart(&partDst);
  dBaseDistance._0_2_ = *(char **)((COMPART *)partSrc.pcom)[1].rgTech;
  dBaseDistance._2_2_ = (int)(char *)dBaseDistance >> 0xf;
  if ((char *)dBaseDistance == (char *)0xffff) {
    dBaseDistance._0_2_ = (char *)s_R6008___not_enough_space_for_arg_1120_1f2d + 0x13;
    dBaseDistance._2_2_ = 0;
  }
  iVar2 = dDist >> 0xf;
  uVar7 = __aFulmul((ulong)CONCAT22(dBaseDistance._2_2_,(char *)dBaseDistance),5);
  iVar3 = (int)(uVar7 >> 0x10);
  if ((iVar3 <= iVar2) && ((iVar3 < iVar2 || ((uint)uVar7 < (uint)dDist)))) {
    return -1;
  }
  uVar6 = (undefined2)((ulong)partSrc.pcom >> 0x10);
  iVar3 = wt >> 0xf;
  if (0 < ((COMPART *)partSrc.pcom + 1)->id) {
    uVar7 = __aFulmul((long)((COMPART *)partSrc.pcom + 1)->id,5);
    iVar4 = (int)(uVar7 >> 0x10);
    if (iVar4 < iVar3) {
      return -2;
    }
    if ((iVar4 <= iVar3) && ((uint)uVar7 < (uint)wt)) {
      return -2;
    }
  }
  uVar6 = (undefined2)((ulong)partDst.pcom >> 0x10);
  if (0 < ((COMPART *)partDst.pcom + 1)->id) {
    uVar7 = __aFulmul((long)((COMPART *)partDst.pcom + 1)->id,5);
    iVar4 = (int)(uVar7 >> 0x10);
    if ((iVar4 <= iVar3) && ((iVar4 < iVar3 || ((uint)uVar7 < (uint)wt)))) {
      return -2;
    }
  }
  if ((iVar2 < dBaseDistance._2_2_) ||
     ((iVar2 <= dBaseDistance._2_2_ &&
      (puVar8 = &DAT_0000_2710, (uint)dDist <= (char *)dBaseDistance)))) {
LAB_1080_170f:
    uVar6 = (undefined2)((ulong)partSrc.pcom >> 0x10);
    pCVar5 = (COMPART *)partSrc.pcom;
    if (((pCVar5 + 1)->id < wt) && (0 < (pCVar5 + 1)->id)) {
      lVar9 = (long)(pCVar5 + 1)->id;
      uVar10 = 0x9c4;
      uVar7 = __aFulmul((long)(pCVar5 + 1)->id,5);
      uVar7 = __aFulmul(uVar7 - (long)wt,uVar10);
      uVar7 = __aFldiv(uVar7,lVar9);
      if ((long)uVar7 < 1) goto SHIP2_TotalDeath;
      puVar12 = &DAT_0000_2710;
      uVar7 = __aFulmul((ulong)puVar8,uVar7);
      puVar8 = (undefined1 *)__aFldiv(uVar7,(long)puVar12);
    }
    uVar6 = (undefined2)((ulong)partDst.pcom >> 0x10);
    pCVar5 = (COMPART *)partDst.pcom;
    if (((pCVar5 + 1)->id < wt) && (0 < (pCVar5 + 1)->id)) {
      lVar9 = (long)(pCVar5 + 1)->id;
      uVar10 = 0x9c4;
      uVar7 = __aFulmul((long)(pCVar5 + 1)->id,5);
      uVar7 = __aFulmul(uVar7 - (long)wt,uVar10);
      uVar7 = __aFldiv(uVar7,lVar9);
      if ((long)uVar7 < 1) goto SHIP2_TotalDeath;
      puVar12 = &DAT_0000_2710;
      uVar7 = __aFulmul((ulong)puVar8,uVar7);
      puVar8 = (undefined1 *)__aFldiv(uVar7,(long)puVar12);
    }
    pctSurvive._2_2_ = (int)((ulong)puVar8 >> 0x10);
    pctSurvive._0_2_ = (undefined1 *)puVar8;
    lVar9 = __aFldiv(CONCAT22(-(uint)((undefined1 *)0x2710 < (undefined1 *)pctSurvive) -
                                      pctSurvive._2_2_,10000 - (int)(undefined1 *)pctSurvive),100);
    *ppctDmg = (short)lVar9;
    sVar1 = 1;
  }
  else {
    pcVar11 = (char *)CONCAT22(dBaseDistance._2_2_,(char *)dBaseDistance);
    uVar10 = 0x9c4;
    uVar7 = __aFulmul((ulong)CONCAT22(dBaseDistance._2_2_,(char *)dBaseDistance),5);
    uVar7 = __aFulmul(uVar7 - (long)dDist,uVar10);
    puVar8 = (undefined1 *)__aFldiv(uVar7,(long)pcVar11);
    if (0 < (long)puVar8) goto LAB_1080_170f;
SHIP2_TotalDeath:
    *ppctDmg = 100;
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: KillUsedWaypoints
// Address: 1080:189a
// Segment: MEMORY_SHIP2
// ======================================================================


void KillUsedWaypoints(void)

{
  undefined2 *puVar1;
  undefined2 *puVar2;
  FLEET *pFVar3;
  int iVar4;
  short sVar5;
  int iVar6;
  FLEET *pFVar7;
  short *psVar8;
  PLORD *pPVar9;
  undefined2 *puVar10;
  undefined2 *puVar11;
  undefined2 uVar12;
  undefined2 uVar13;
  FLEET *pFVar14;
  PLANET *pPVar15;
  PLANET *lppl;
  short fRep;
  FLEET *lpfl;
  short i;
  short j;
  
  if (0 < cFleet) {
    for (i = 0; i < cFleet; i = i + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar3 = ((FLEET **)rglpfl)[i];
      iVar4 = *(int *)((int)((FLEET **)rglpfl + i) + 2);
      lpfl = (FLEET *)CONCAT22(iVar4,pFVar3);
      if ((pFVar3 == (FLEET *)0x0) && (iVar4 == 0)) {
        return;
      }
      if (1 < pFVar3->cord) {
        if (pFVar3->wFlags < 0) {
          DeleteWpFar((FLEET *)CONCAT22(iVar4,pFVar3),1,0);
          FSendPlrMsg(pFVar3->iPlayer,idmHasExecutedOrdersFollowFleetAwaitsFurther,
                           lpfl->id | 0x8000,lpfl->id,0,0,0,0,0,0);
        }
        else {
          for (j = 1; j < pFVar3->cord; j = j + 1) {
            if ((*(uint *)(*(int *)&pFVar3->lpplord + j * 0x12 + 10) >> 8 & 0xf) == 2) {
              pFVar14 = LpflFromId(*(short *)(*(int *)&pFVar3->lpplord + j * 0x12 + 8));
              *(FLEET **)&pFVar3->lpflNext = (FLEET *)pFVar14;
              *(undefined2 *)((int)&pFVar3->lpflNext + 2) = (int)((ulong)pFVar14 >> 0x10);
              if ((*(int *)&pFVar3->lpflNext == 0) && (*(int *)((int)&pFVar3->lpflNext + 2) == 0)) {
                lppl._2_2_ = *(uint *)(*(int *)&pFVar3->lpplord + j * 0x12 + 10) & 0xf0ff | 0x400;
                *(uint *)(*(int *)&pFVar3->lpplord + j * 0x12 + 10) = lppl._2_2_;
                *(undefined2 *)(*(int *)&pFVar3->lpplord + j * 0x12 + 8) = 0;
              }
              else {
                if ((*(uint *)(*(int *)&pFVar3->lpplord + j * 0x12 + 10) >> 0xd & 1) == 0) {
                  uVar12 = (undefined2)((ulong)pFVar3->lpflNext >> 0x10);
                  pFVar7 = (FLEET *)pFVar3->lpflNext;
                  sVar5 = (pFVar7->pt).y;
                  uVar13 = *(undefined2 *)((int)&pFVar3->lpplord + 2);
                  psVar8 = (short *)(*(int *)&pFVar3->lpplord + 4 + j * 0x12);
                  *psVar8 = (&pFVar7->pt)->x;
                  psVar8[1] = sVar5;
                }
                *(undefined2 *)&pFVar3->lpflNext = 0;
                *(undefined2 *)((int)&pFVar3->lpflNext + 2) = 0;
              }
            }
          }
          uVar13 = (undefined2)((ulong)pFVar3->lpplord >> 0x10);
          pPVar9 = (PLORD *)pFVar3->lpplord;
          if (((&pFVar3->pt)->x == *(int *)&pPVar9[5].iordMax) &&
             ((pFVar3->pt).y == (pPVar9 + 6)->wFlags)) {
            uVar13 = *(undefined2 *)((int)&pFVar3->lpplord + 2);
            puVar10 = (undefined2 *)(*(int *)&pFVar3->lpplord + 0x16);
            uVar12 = *(undefined2 *)((int)&pFVar3->lpplord + 2);
            puVar11 = (undefined2 *)(*(int *)&pFVar3->lpplord + 4);
            for (iVar6 = 9; iVar6 != 0; iVar6 = iVar6 + -1) {
              puVar2 = puVar11;
              puVar11 = puVar11 + 1;
              puVar1 = puVar10;
              puVar10 = puVar10 + 1;
              *puVar2 = *puVar1;
            }
            if ((((*(uint *)&((PLORD *)pFVar3->lpplord)[2].iordMax >> 8 & 0xf) == 2) &&
                ((*(uint *)&((PLORD *)pFVar3->lpplord)[2].iordMax & 0xf) != 1)) &&
               ((*(uint *)&((PLORD *)pFVar3->lpplord)[2].iordMax & 0xf) != 4)) {
              if (pFVar3->idPlanet == -1) {
                *(uint *)&((PLORD *)pFVar3->lpplord)[2].iordMax =
                     *(uint *)&((PLORD *)pFVar3->lpplord)[2].iordMax & 0xf0ff | 0x400;
                ((PLORD *)pFVar3->lpplord + 2)->wFlags = 0;
              }
              else {
                *(uint *)&((PLORD *)pFVar3->lpplord)[2].iordMax =
                     *(uint *)&((PLORD *)pFVar3->lpplord)[2].iordMax & 0xf0ff | 0x100;
                ((PLORD *)pFVar3->lpplord + 2)->wFlags = pFVar3->idPlanet;
              }
            }
            if (((((PLORD *)pFVar3->lpplord + 7)->wFlags & 0xfU) == 7) &&
               (((uint)((PLORD *)pFVar3->lpplord + 7)->wFlags >> 8 & 0xf) == 2)) {
              fRep = 0;
            }
            else {
              fRep = (uint)pFVar3->wFlags >> 9 & 1;
            }
            DeleteWpFar(lpfl,1,fRep);
            if (pFVar3->cord == 1) {
              switch(*(uint *)&((PLORD *)pFVar3->lpplord)[2].iordMax & 0xf) {
              case 1:
              case 2:
              case 3:
              case 5:
              case 6:
              case 7:
                break;
              case 8:
                if (pFVar3->idPlanet != -1) {
                  pPVar15 = LpplFromId(pFVar3->idPlanet);
                  uVar13 = (undefined2)((ulong)pPVar15 >> 0x10);
                  if ((((PLANET *)pPVar15)->iPlayer == pFVar3->iPlayer) &&
                     ((((PLANET *)pPVar15)->wRouting & 0x3ffU) != 0)) break;
                }
              default:
                FSendPlrMsg(pFVar3->iPlayer,idmHasCompletedAssignedOrders,lpfl->id | 0x8000,
                                 lpfl->id,0,0,0,0,0,0);
              }
            }
          }
        }
      }
    }
  }
  return;
}



// ======================================================================
// Function: NoAutoTrackFleet
// Address: 1080:1d32
// Segment: MEMORY_SHIP2
// ======================================================================


void NoAutoTrackFleet(FLEET *lpflTarget)

{
  int iVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  short sVar5;
  FLEET *pFVar6;
  ORDER *pOVar7;
  undefined2 uVar8;
  undefined2 uVar9;
  FLEET *lpfl;
  short ifl;
  ORDER *lpord;
  short i;
  short idTarget;
  short iplr;
  
  uVar8 = (undefined2)((ulong)lpflTarget >> 0x10);
  pFVar6 = (FLEET *)lpflTarget;
  iVar1 = pFVar6->iPlayer;
  iVar2 = lpflTarget->id;
  ifl = 0;
  while( true ) {
    if (cFleet <= ifl) {
      return;
    }
    iVar3 = *(int *)((FLEET **)rglpfl + ifl);
    iVar4 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    if ((iVar3 == 0) && (iVar4 == 0)) break;
    if ((*(int *)(iVar3 + 2) != iVar1) && (1 < *(int *)(iVar3 + 0x62))) {
      lpord = (ORDER *)CONCAT22(*(undefined2 *)(iVar3 + 0x66),
                                (ORDER *)(*(int *)(iVar3 + 100) + 0x16));
      for (i = 1; i < *(int *)(iVar3 + 0x62); i = i + 1) {
        uVar9 = (undefined2)((ulong)lpord >> 0x10);
        pOVar7 = (ORDER *)lpord;
        if ((((uint)pOVar7->wFlags >> 8 & 0xf) == 2) && (pOVar7->id == iVar2)) {
          pOVar7->wFlags = pOVar7->wFlags & 0xdfffU | 0x2000;
          sVar5 = (pFVar6->pt).y;
          (lpord->pt).x = (&pFVar6->pt)->x;
          (pOVar7->pt).y = sVar5;
        }
        lpord = (ORDER *)CONCAT22(uVar9,pOVar7 + 1);
      }
    }
    ifl = ifl + 1;
  }
  return;
}



// ======================================================================
// Function: AutoRouteFleet
// Address: 1080:1e52
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Variable defined which should be unmapped: isbsSrc */
/* WARNING: Removing unreachable block (ram,0x10802151) */
/* WARNING: Removing unreachable block (ram,0x108021f3) */

void AutoRouteFleet(FLEET *lpfl,PLANET *lppl)

{
  int iVar1;
  undefined2 uVar2;
  undefined2 uVar3;
  PLANET *pPVar4;
  short sVar5;
  short isbsSrc_00;
  undefined2 uVar6;
  int iVar7;
  FLEET *pFVar8;
  PLANET *pPVar9;
  int iVar10;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar11;
  undefined2 uVar12;
  PLANET *lppl_00;
  HULDEF *pHVar13;
  long lVar14;
  long lVar15;
  short isbsSrc;
  short ishdefBig;
  short ishdef;
  short wtBig;
  short isbsDst;
  PLANET *lpplRoute;
  ORDER *lpord;
  short i;
  long cTurns;
  short wt;
  short pctDmg;
  short iWarp;
  long dTravel;
  
  uVar11 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar8 = (FLEET *)lpfl;
  pFVar8->cord = 2;
  ((PLORD *)pFVar8->lpplord)->iordMac = 2;
  iVar1 = *(int *)&pFVar8->lpplord;
  uVar2 = *(undefined2 *)((int)&pFVar8->lpplord + 2);
  lpord = (ORDER *)CONCAT22(uVar2,(ORDER *)(iVar1 + 0x16));
  *(uint *)(iVar1 + 0x1c) = *(uint *)(iVar1 + 0x1c) & 0xfff0 | 8;
  *(uint *)(iVar1 + 0x1c) = *(uint *)(iVar1 + 0x1c) & 0xf0ff | 0x100;
  uVar12 = (undefined2)((ulong)lppl >> 0x10);
  pPVar9 = (PLANET *)lppl;
  *(int *)(iVar1 + 0x1a) = (pPVar9->wRouting & 0x3ffU) - 1;
  lppl_00 = LpplFromId((pPVar9->wRouting & 0x3ffU) - 1);
  uVar6 = (undefined2)((ulong)lppl_00 >> 0x10);
  pPVar4 = (PLANET *)lppl_00;
  iVar10 = (pPVar9->wRouting & 0x3ffU) - 1;
  uVar3 = *(undefined2 *)((int)&rgptPlan[0].y + iVar10 * 4);
  (lpord->pt).x = ((POINT *)rgptPlan + iVar10)->x;
  *(undefined2 *)(iVar1 + 0x18) = uVar3;
  *(uint *)(iVar1 + 0x1c) = *(uint *)(iVar1 + 0x1c) & 0xefff | 0x1000;
  iWarp = IFindIdealWarp(lpfl,0);
  DGetDistance((&pFVar8->pt)->x,(pFVar8->pt).y,(lpord->pt).x,*(short *)(iVar1 + 0x18));
  dTravel = __ftol((double)CONCAT26(ishdefBig,CONCAT24(isbsSrc,CONCAT22(unaff_SI,unaff_DI)))
                          );
  if (((pPVar9->iPlayer == pPVar4->iPlayer) && (((uint)pPVar9->wFlags >> 9 & 1) != 0)) &&
     (((uint)pPVar4->wFlags >> 9 & 1) != 0)) {
    sVar5 = IStargateFromLppl(lppl_00);
    isbsSrc_00 = IStargateFromLppl(lppl);
    i = 0;
    while (((i < 4 && ((int)pFVar8->rgwtMin[i] == 0)) &&
           (*(int *)((int)(pFVar8->rgwtMin + i) + 2) == 0))) {
      i = i + 1;
    }
    if (((i == 4) && (sVar5 != -1)) && (isbsSrc_00 != -1)) {
      wtBig = 0;
      for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
        iVar10 = wtBig;
        if ((pFVar8->rgcsh[ishdef] != 0) &&
           (iVar10 = pFVar8->iPlayer * 4,
           iVar10 = *(int *)(*(int *)(iVar10 + 0xfe) + ishdef * 0x93 + 0x28), iVar10 <= wtBig)) {
          iVar10 = wtBig;
        }
        wtBig = iVar10;
      }
      sVar5 = MdCalcStargateDamage(isbsSrc_00,sVar5,(short)dTravel,wtBig,&pctDmg);
      if ((sVar5 == 1) && (pctDmg == 0)) {
        iWarp = 0xb;
      }
    }
    if (iWarp < 9) {
      iVar10 = pFVar8->iPlayer * 4;
      pHVar13 = LphuldefFromId
                          (*(HullDef *)
                            (*(int *)(iVar10 + 0x14c) +
                            (*(uint *)&pPVar4->field11_0x2c & 0xf) * 0x93));
      if ((((HULDEF *)pHVar13)->hul).wtCargoMax != 0) {
        for (iWarp = 9; 0 < iWarp; iWarp = iWarp + -1) {
          lVar14 = EstFuelUse(lpfl,0,iWarp,-1,1);
          if (dTravel <= lVar14) break;
        }
        *(uint *)(iVar1 + 0x1c) = *(uint *)(iVar1 + 0x1c) & 0xff0f | (iWarp & 0xfU) << 4;
      }
    }
  }
  if ((iWarp < 0xb) && (iWarp != 0)) {
    iVar10 = iWarp >> 0xf;
    sVar5 = iWarp;
    lVar14 = __aFldiv(dTravel,(long)iWarp);
    lVar14 = __aFldiv(lVar14,CONCAT22(iVar10,sVar5));
    do {
      if (iWarp < 3) goto LAB_1080_220b;
      iVar10 = iWarp + -1;
      iVar7 = iVar10 >> 0xf;
      iWarp = iVar10;
      lVar15 = __aFldiv(dTravel,(long)iVar10);
      lVar15 = __aFldiv(lVar15,CONCAT22(iVar7,iVar10));
    } while (lVar15 <= lVar14);
    iWarp = iWarp + 1;
LAB_1080_220b:
    do {
      if (iWarp == 0) break;
      lVar14 = EstFuelUse(lpfl,0,iWarp,dTravel,0);
      iVar7 = (int)((ulong)lVar14 >> 0x10);
      iVar10 = *(int *)((int)pFVar8->rgwtMin + 0x12);
      if ((iVar7 < iVar10) ||
         ((iVar7 <= iVar10 && ((uint)lVar14 <= *(uint *)(pFVar8->rgwtMin + 4))))) break;
      iWarp = iWarp + -1;
    } while( true );
  }
  *(uint *)(iVar1 + 0x1c) = *(uint *)(iVar1 + 0x1c) & 0xff0f | (iWarp & 0xfU) << 4;
  return;
}



// ======================================================================
// Function: FColonizer
// Address: 1080:227c
// Segment: MEMORY_SHIP2
// ======================================================================


short FColonizer(FLEET *lpfl)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar1;
  long lVar2;
  long l;
  short i;
  
  lVar2 = CONCAT22(unaff_SI,unaff_DI);
  i = 0;
  while( true ) {
    if (0xf < i) {
      return 0;
    }
    if ((((FLEET *)lpfl)->rgcsh[i] != 0) &&
       (uVar1 = __aFlshl(lVar2,1), (uVar1 & 0xc000) != 0)) break;
    i = i + 1;
  }
  return 1;
}



// ======================================================================
// Function: FScout
// Address: 1080:2322
// Segment: MEMORY_SHIP2
// ======================================================================


short FScout(FLEET *lpfl)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar1;
  long lVar2;
  long l;
  short i;
  
  lVar2 = CONCAT22(unaff_SI,unaff_DI);
  i = 0;
  while( true ) {
    if (0xf < i) {
      return 0;
    }
    if ((((FLEET *)lpfl)->rgcsh[i] != 0) && (uVar1 = __aFlshl(lVar2,1), (uVar1 & 0x70) != 0)
       ) break;
    i = i + 1;
  }
  return 1;
}



// ======================================================================
// Function: AutoFleetOrder
// Address: 1080:23c8
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10802543) */
/* WARNING: Removing unreachable block (ram,0x1080255a) */

void AutoFleetOrder(FLEET *lpfl,PLANET *lppl)

{
  int iVar1;
  undefined2 uVar2;
  FLEET *pFVar3;
  int iVar4;
  bool bVar5;
  short sVar6;
  FLEET *pFVar7;
  PLANET *pPVar8;
  undefined2 uVar9;
  undefined2 uVar10;
  long lVar11;
  short fFoundFleet;
  FLEET *lpflT;
  ORDER *lpord;
  short ifl;
  long cMine;
  
  bVar5 = false;
  uVar9 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar7 = (FLEET *)lpfl;
  iVar1 = *(int *)&pFVar7->lpplord;
  uVar2 = *(undefined2 *)((int)&pFVar7->lpplord + 2);
  uVar10 = (undefined2)((ulong)lppl >> 0x10);
  pPVar8 = (PLANET *)lppl;
  if (((pPVar8->iPlayer == -1) ||
      ((sVar6 = GetRaceStat((PLAYER *)rgplr + pFVar7->iPlayer,rsMajorAdv),
       sVar6 == 8 && (pPVar8->iPlayer == pFVar7->iPlayer)))) &&
     (lVar11 = CMineFromLpfl(lpfl), lVar11 != 0)) {
    if (pPVar8->iPlayer == -1) {
      for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar3 = ((FLEET **)rglpfl)[ifl];
        iVar4 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpflT = (FLEET *)CONCAT22(iVar4,pFVar3);
        if ((pFVar3 == (FLEET *)0x0) && (iVar4 == 0)) break;
        if ((pFVar7->iPlayer <= pFVar3->iPlayer) &&
           ((((uint)pFVar3->wFlags >> 10 & 1) == 0 && (lpfl != lpflT)))) {
          if (pFVar7->iPlayer < pFVar3->iPlayer) break;
          if (((((&pFVar3->pt)->x == (&pFVar7->pt)->x) && ((pFVar3->pt).y == (pFVar7->pt).y)) &&
              (lVar11 = CMineFromLpfl((FLEET *)CONCAT22(iVar4,pFVar3)), 0 < lVar11)) &&
             (lVar11 < 4000)) {
            bVar5 = true;
            break;
          }
        }
      }
    }
    if (bVar5) {
      *(uint *)(iVar1 + 10) = *(uint *)(iVar1 + 10) & 0xfff0 | 4;
      *(uint *)(iVar1 + 10) = *(uint *)(iVar1 + 10) & 0xf0ff | 0x200;
      *(short *)(iVar1 + 8) = lpflT->id;
    }
    else {
      *(uint *)(iVar1 + 10) = *(uint *)(iVar1 + 10) & 0xfff0 | 3;
    }
  }
  pFVar7->iplan = 0;
  return;
}



// ======================================================================
// Function: CMineFromLpfl
// Address: 1080:25d2
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10802697) */
/* WARNING: Removing unreachable block (ram,0x1080273a) */

long CMineFromLpfl(FLEET *lpfl)

{
  byte bVar1;
  long lVar2;
  int iVar3;
  HS *pHVar4;
  undefined2 uVar5;
  ulong uVar6;
  ulong uVar7;
  HS *lphs;
  short chs;
  long cMineTot;
  PART part;
  HUL *lphuldef;
  short i;
  short j;
  long cMine;
  
  lVar2 = 0;
  for (i = 0; i < 0x10; i = i + 1) {
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      iVar3 = ((FLEET *)lpfl)->iPlayer * 4;
      uVar5 = *(undefined2 *)(iVar3 + 0x100);
      iVar3 = *(int *)(iVar3 + 0xfe) + i * 0x93;
      bVar1 = *(byte *)(iVar3 + 0x7a);
      uVar7 = 0;
      lphs = (HS *)CONCAT22(uVar5,(HS *)(iVar3 + 0x3a));
      for (j = 0; j < (int)(uint)bVar1; j = j + 1) {
        pHVar4 = (HS *)lphs;
        uVar5 = (undefined2)((ulong)lphs >> 0x10);
        if ((lphs->grhst == hstMining) && ((pHVar4->wFlags & 0xffU) < 7)) {
          part.hs.grhst = lphs->grhst;
          part.hs.wFlags = pHVar4->wFlags;
          FLookupPart(&part);
          uVar6 = __aFulmul((ulong)((uint)pHVar4->wFlags >> 8),
                                    (long)((COMPART *)part.pcom + 1)->id);
          uVar7 = uVar6 + uVar7;
        }
        lphs = (HS *)CONCAT22(uVar5,pHVar4 + 1);
      }
      uVar7 = __aFulmul(uVar7,(long)((FLEET *)lpfl)->rgcsh[i]);
      lVar2 = uVar7 + lVar2;
    }
  }
  if (3999 < lVar2) {
    lVar2 = 4000;
  }
  return lVar2;
}



// ======================================================================
// Function: PctTerraFromLpfl
// Address: 1080:275c
// Segment: MEMORY_SHIP2
// ======================================================================


long PctTerraFromLpfl(FLEET *lpfl)

{
  undefined2 uVar1;
  long lVar2;
  uint uVar3;
  int iVar4;
  bool bVar5;
  ulong uVar6;
  HS *lphs;
  short chs;
  HUL *lphuldef;
  long pct;
  short i;
  long pctTot;
  short j;
  
  lVar2 = 0;
  for (i = 0; i < 0x10; i = i + 1) {
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      iVar4 = ((FLEET *)lpfl)->iPlayer * 4;
      uVar1 = *(undefined2 *)(iVar4 + 0x100);
      iVar4 = *(int *)(iVar4 + 0xfe) + i * 0x93;
      pct._0_2_ = 0;
      pct._2_2_ = 0;
      lphs = (HS *)CONCAT22(uVar1,(HS *)(iVar4 + 0x3a));
      for (j = 0; j < (int)(uint)*(byte *)(iVar4 + 0x7a); j = j + 1) {
        if ((lphs->grhst == hstMining) && ((((HS *)lphs)->wFlags & 0xffU) == 7)) {
          uVar3 = (uint)((HS *)lphs)->wFlags >> 8;
          bVar5 = CARRY2((uint)pct,uVar3);
          pct._0_2_ = (uint)pct + uVar3;
          pct._2_2_ = pct._2_2_ + (uint)bVar5;
        }
        lphs = (HS *)CONCAT22(lphs._2_2_,(HS *)lphs + 1);
      }
      uVar6 = __aFulmul(CONCAT22(pct._2_2_,(uint)pct),(long)((FLEET *)lpfl)->rgcsh[i]);
      lVar2 = uVar6 + lVar2;
    }
  }
  return lVar2;
}



// ======================================================================
// Function: CLayMinesFromLpfl
// Address: 1080:2886
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lphs */
/* WARNING: Removing unreachable block (ram,0x10802adc) */

long CLayMinesFromLpfl(FLEET *lpfl,short iType,short ishdef)

{
  byte bVar1;
  HUL *pHVar2;
  int iVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar4;
  ulong uVar5;
  long lVar6;
  ulong uVar7;
  ulong uVar8;
  long lVar9;
  HS *lphs;
  short chs;
  long cMineTot;
  PART part;
  HUL *lphul;
  short i;
  short j;
  long cMine;
  ushort iMax;
  ushort iMin;
  
  lVar9 = CONCAT22(unaff_SI,unaff_DI);
  uVar8 = 0;
  if (iType != -1) {
    if (iType == 0) {
      iMin = 0;
      iMax = 3;
      goto LAB_1080_28f9;
    }
    if (iType == 1) {
      iMin = 4;
      iMax = 6;
      goto LAB_1080_28f9;
    }
    if (iType == 2) {
      iMin = 7;
      iMax = 9;
      goto LAB_1080_28f9;
    }
  }
  iMin = 0;
  iMax = 9;
LAB_1080_28f9:
  for (i = 0; i < 0x10; i = i + 1) {
    if ((0 < ((FLEET *)lpfl)->rgcsh[i]) && ((ishdef == -1 || (i == ishdef)))) {
      iVar3 = ((FLEET *)lpfl)->iPlayer * 4;
      uVar4 = *(undefined2 *)(iVar3 + 0x100);
      pHVar2 = (HUL *)(*(int *)(iVar3 + 0xfe) + i * 0x93);
      lphul = (HUL *)CONCAT22(uVar4,pHVar2);
      bVar1 = pHVar2->chs;
      uVar7 = 0;
      lphs = (HS *)CONCAT22(uVar4,pHVar2->rghs);
      for (j = 0; j < (int)(uint)bVar1; j = j + 1) {
        uVar4 = (undefined2)((ulong)lphs >> 0x10);
        if (((lphs->grhst == hstMines) && (iMin <= (((HS *)lphs)->wFlags & 0xffU))) &&
           ((((HS *)lphs)->wFlags & 0xffU) <= iMax)) {
          part.hs.grhst = lphs->grhst;
          part.hs.wFlags = ((HS *)lphs)->wFlags;
          FLookupPart(&part);
          uVar5 = __aFulmul((ulong)((uint)((HS *)lphs)->wFlags >> 8),
                                    (long)((COMPART *)part.pcom + 1)->id);
          uVar7 = uVar5 + uVar7;
        }
        else if (((iType < 1) && (lphs->grhst == hstBeam)) &&
                ((((HS *)lphs)->wFlags & 0xffU) == 0x12)) {
          lVar6 = __aFlshl(lVar9,(ushort)(HS *)lphs);
          uVar7 = lVar6 + uVar7;
        }
        lphs = (HS *)CONCAT22(uVar4,(HS *)lphs + 1);
      }
      if ((lphul->ihuldef == ihuldefMiniMineLayer) || (lphul->ihuldef == ihuldefSuperMineLayer)) {
        uVar7 = __aFlshl(lVar9,(ushort)(HS *)lphs);
      }
      uVar7 = __aFulmul(uVar7,(long)((FLEET *)lpfl)->rgcsh[i]);
      uVar8 = uVar7 + uVar8;
    }
  }
  if (((long)uVar8 < 0x989681) && ((0xffff < (long)uVar8 || (-1 < (long)uVar8)))) {
    uVar8 = __aFulmul(uVar8,10);
  }
  else {
    uVar8 = 100000000;
  }
  return uVar8;
}



// ======================================================================
// Function: CMineSweepFromLpfl
// Address: 1080:2b26
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10802bd9) */

long CMineSweepFromLpfl(FLEET *lpfl)

{
  long lVar1;
  int iVar2;
  ulong uVar3;
  long lPow;
  HUL *lphul;
  short i;
  long lPowTot;
  
  lVar1 = 0;
  for (i = 0; i < 0x10; i = i + 1) {
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      iVar2 = ((FLEET *)lpfl)->iPlayer * 4;
      uVar3 = CMineSweepFromLphul((HUL *)CONCAT22(*(undefined2 *)(iVar2 + 0x100),
                                                  (HUL *)(*(int *)(iVar2 + 0xfe) + i * 0x93)));
      uVar3 = __aFulmul(uVar3,(long)((FLEET *)lpfl)->rgcsh[i]);
      lVar1 = uVar3 + lVar1;
    }
  }
  if (lVar1 < 1) {
    lVar1 = 0;
  }
  return lVar1;
}



// ======================================================================
// Function: CMineSweepFromLphul
// Address: 1080:2bfa
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10802d3d) */

long CMineSweepFromLphul(HUL *lphul)

{
  byte bVar1;
  HullDef HVar2;
  long lVar3;
  HS *pHVar4;
  COMPART *pCVar5;
  undefined2 uVar6;
  undefined2 uVar7;
  bool bVar8;
  ulong uVar9;
  ulong uVar10;
  ulong uVar11;
  PART part;
  long lPow;
  short fStarbase;
  short j;
  long lRange;
  HS *lphs;
  short chs;
  
  HVar2 = lphul->ihuldef;
  uVar6 = (undefined2)((ulong)lphul >> 0x10);
  bVar1 = ((HUL *)lphul)->chs;
  lVar3 = 0;
  j = 0;
  lphs = (HS *)CONCAT22(uVar6,((HUL *)lphul)->rghs);
  do {
    if ((int)(uint)bVar1 <= j) {
      if (lVar3 < 1) {
        lVar3 = 0;
      }
      return lVar3;
    }
    pHVar4 = (HS *)lphs;
    uVar6 = (undefined2)((ulong)lphs >> 0x10);
    if (lphs->grhst == hstBeam) {
      part.hs.grhst = lphs->grhst;
      part.hs.wFlags = pHVar4->wFlags;
      FLookupPart(&part);
      uVar7 = (undefined2)((ulong)part.pcom >> 0x10);
      pCVar5 = (COMPART *)part.pcom;
      if ((*(uint *)(pCVar5[1].rgTech + 4) & 2) == 0) {
        if ((*(uint *)(pCVar5[1].rgTech + 4) & 1) != 0) goto LAB_1080_2c4d;
        lRange._0_2_ = (pCVar5 + 1)->id;
        lRange._2_2_ = (int)(uint)lRange >> 0xf;
      }
      else {
        lRange._0_2_ = 4;
        lRange._2_2_ = 0;
      }
      if (0x1f < (int)HVar2) {
        bVar8 = 0xfffe < (uint)lRange;
        lRange._0_2_ = (uint)lRange + 1;
        lRange._2_2_ = lRange._2_2_ + (uint)bVar8;
      }
      uVar11 = (ulong)*(int *)pCVar5[1].rgTech;
      uVar10 = (ulong)((uint)pHVar4->wFlags >> 8);
      uVar9 = __aFulmul(CONCAT22(lRange._2_2_,(uint)lRange),
                                CONCAT22(lRange._2_2_,(uint)lRange));
      uVar9 = __aFulmul(uVar9,uVar10);
      uVar9 = __aFulmul(uVar9,uVar11);
      lVar3 = uVar9 + lVar3;
    }
LAB_1080_2c4d:
    j = j + 1;
    lphs = (HS *)CONCAT22(uVar6,pHVar4 + 1);
  } while( true );
}



// ======================================================================
// Function: PctCloakFromLpfl
// Address: 1080:2d5e
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lphs */

short PctCloakFromLpfl(FLEET *lpfl)

{
  byte bVar1;
  bool bVar2;
  short sVar3;
  uint uVar4;
  int iVar5;
  FLEET *pFVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar7;
  ulong uVar8;
  long lVar9;
  HS *lphs;
  short chs;
  long wtFleetCur;
  long cPts;
  short cScore;
  long wtFleet;
  HUL *lphul;
  short fUseFloat;
  long cPtsCur;
  short i;
  double dwtFleet;
  double dcPts;
  short j;
  
  wtFleet = 0;
  cPts = 0;
  bVar2 = false;
  i = 0;
  while( true ) {
    pFVar6 = (FLEET *)lpfl;
    uVar7 = (undefined2)((ulong)lpfl >> 0x10);
    if (0xf < i) break;
    if (0 < pFVar6->rgcsh[i]) {
      iVar5 = pFVar6->iPlayer * 4;
      lphs._2_2_ = *(undefined2 *)(iVar5 + 0x100);
      iVar5 = *(int *)(iVar5 + 0xfe) + i * 0x93;
      bVar1 = *(byte *)(iVar5 + 0x7a);
      uVar8 = __aFulmul((long)pFVar6->rgcsh[i],(ulong)*(uint *)(iVar5 + 0x28));
      cPtsCur = 0;
      sVar3 = GetRaceStat((PLAYER *)rgplr + pFVar6->iPlayer,rsMajorAdv);
      if (sVar3 == 1) {
        cPtsCur = 300;
      }
      j = 0;
      lphs._0_2_ = (HS *)(iVar5 + 0x3a);
      while( true ) {
        if ((int)(uint)bVar1 <= j) break;
        uVar4 = CPtsCloakFromLphs((HS *)CONCAT22(lphs._2_2_,(HS *)lphs));
        cPtsCur = CONCAT22(cPtsCur._2_2_ + ((int)uVar4 >> 0xf) + (uint)CARRY2((uint)cPtsCur,uVar4),
                           (uint)cPtsCur + uVar4);
        j = j + 1;
        lphs._0_2_ = (HS *)lphs + 1;
      }
      wtFleetCur._0_2_ = (uint)uVar8;
      wtFleetCur._2_2_ = (int)(uVar8 >> 0x10);
      if ((-1 < cPtsCur) && ((0 < cPtsCur._2_2_ || ((uint)cPtsCur != 0)))) {
        if ((!bVar2) &&
           ((((0 < cPtsCur._2_2_ ||
              ((((-1 < cPtsCur && (4000 < (uint)cPtsCur)) || (7 < wtFleetCur._2_2_)) ||
               ((6 < wtFleetCur._2_2_ && (0xa120 < (uint)wtFleetCur)))))) || (0x5f5 < cPts._2_2_))
            || (((0x5f4 < cPts._2_2_ && (0xe100 < (uint)cPts)) ||
                ((0x2f9 < wtFleet._2_2_ && ((0x2fa < wtFleet._2_2_ || (0xf080 < (uint)wtFleet)))))))
            ))) {
          bVar2 = true;
        }
        if (!bVar2) {
          uVar8 = __aFulmul(cPtsCur,uVar8);
          cPts = uVar8 + cPts;
        }
      }
      if (!bVar2) {
        wtFleet = CONCAT22(wtFleet._2_2_ + wtFleetCur._2_2_ +
                           (uint)CARRY2((uint)wtFleet,(uint)wtFleetCur),
                           (uint)wtFleet + (uint)wtFleetCur);
      }
    }
    i = i + 1;
  }
  if (((bVar2) || ((uint)cPts != 0)) || (cPts._2_2_ != 0)) {
    sVar3 = GetRaceStat((PLAYER *)rgplr + pFVar6->iPlayer,rsMajorAdv);
    if (sVar3 != 1) {
      if (bVar2) {
        for (i = 0; i < 4; i = i + 1) {
        }
      }
      else {
        for (i = 0; i < 4; i = i + 1) {
          uVar4 = *(uint *)(pFVar6->rgwtMin + i);
          wtFleet = CONCAT22(wtFleet._2_2_ + *(uint *)((int)(pFVar6->rgwtMin + i) + 2) +
                             (uint)CARRY2((uint)wtFleet,uVar4),(uint)wtFleet + uVar4);
        }
      }
    }
    if (bVar2) {
      lVar9 = __ftol((double)CONCAT26(lphs._2_2_,
                                              CONCAT24((HS *)lphs,CONCAT22(unaff_SI,unaff_DI))));
    }
    else {
      lVar9 = __aFldiv(cPts,wtFleet);
    }
    cPts._2_2_ = (int)((ulong)lVar9 >> 0x10);
    if ((cPts._2_2_ < 1) && (lVar9 < 0)) {
      sVar3 = 0;
    }
    else {
      cPts._0_2_ = (uint)lVar9;
      if ((int)(uint)cPts < 0x65) {
        sVar3 = (int)(uint)cPts >> 1;
      }
      else if ((int)((uint)cPts + -100) < 0xc9) {
        sVar3 = ((int)((uint)cPts + -100) >> 3) + 0x32;
      }
      else if ((int)((uint)cPts + -300) < 0x139) {
        sVar3 = (int)((uint)cPts + -300) / 0x18 + 0x4b;
      }
      else {
        iVar5 = (uint)cPts + -0x264;
        if (iVar5 < 0x201) {
          sVar3 = (iVar5 >> 6) + 0x58;
        }
        else if (iVar5 < 1000) {
          sVar3 = (0x2ff < iVar5) + 0x60;
        }
        else {
          sVar3 = 0x62;
        }
      }
    }
  }
  else {
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: CPtsCloakFromLphs
// Address: 1080:3170
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x108031b3) */

short CPtsCloakFromLphs(HS *lphs)

{
  HullSlotType HVar1;
  HS *pHVar2;
  undefined2 uVar3;
  PART part;
  short cPts;
  
  cPts = 0;
  uVar3 = (undefined2)((ulong)lphs >> 0x10);
  pHVar2 = (HS *)lphs;
  if ((uint)pHVar2->wFlags >> 8 == 0) {
    cPts = 0;
  }
  else {
    HVar1 = lphs->grhst;
    if (HVar1 == hstEngine) {
      if ((pHVar2->wFlags & 0xffU) == 8) {
        cPts = 0x14;
      }
    }
    else if (HVar1 == hstScanner) {
      if ((pHVar2->wFlags & 0xffU) == 6) {
        cPts = 0x28;
      }
    }
    else if (HVar1 == hstShield) {
      if ((pHVar2->wFlags & 0xffU) == 4) {
        cPts = 0x46;
      }
      else if ((pHVar2->wFlags & 0xffU) == 6) {
        cPts = 0x14;
      }
    }
    else if (HVar1 == hstArmor) {
      if ((pHVar2->wFlags & 0xffU) == 7) {
        cPts = 0x32;
      }
      else if ((pHVar2->wFlags & 0xffU) == 9) {
        cPts = 0x28;
      }
    }
    else if (HVar1 == hstBeam) {
      if ((pHVar2->wFlags & 0xffU) == 0x12) {
        cPts = 0x14;
      }
    }
    else if (HVar1 == hstMining) {
      if ((pHVar2->wFlags & 0xffU) == 6) {
        cPts = 0x3c;
      }
      else if ((pHVar2->wFlags & 0xffU) == 7) {
        cPts = 0x32;
      }
    }
    else if (HVar1 == hstSpecialE) {
      if ((pHVar2->wFlags & 0xffU) < 5) {
        part.hs.grhst = lphs->grhst;
        part.hs.wFlags = pHVar2->wFlags;
        FLookupPart(&part);
        cPts = ((COMPART *)part.pcom + 1)->id;
      }
    }
    else if ((HVar1 == hstSpecialM) && ((pHVar2->wFlags & 0xffU) == 4)) {
      cPts = 0x14;
    }
    if (1 < (uint)pHVar2->wFlags >> 8) {
      cPts = cPts * ((uint)pHVar2->wFlags >> 8);
    }
  }
  return cPts;
}



// ======================================================================
// Function: MergeFleetsDlg
// Address: 1080:3376
// Segment: MEMORY_SHIP2
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short MergeFleetsDlg(HWND hwnd,ushort msg,ushort wParam,long lParam)

{
  char *pcVar1;
  WPARAM WVar2;
  HWND HVar3;
  short sVar4;
  undefined2 unaff_SS;
  LRESULT LVar5;
  char *psz;
  char szT [80];
  RECT rc;
  short i;
  
  if (msg == 0x14) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    return 1;
  }
  if (msg == 0x19) {
    szT[0x4e] = (char)lParam;
    szT[0x4f] = lParam._1_1_;
    HVar3 = GetDlgItem(hwnd,0x51);
    if (szT._78_2_ != HVar3) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return hbrButtonFace;
    }
  }
  else {
    if (msg == 0x110) {
      StickyDlgPos(hwnd,(POINT *)&ptStickyMergeFleetsDlg,1);
      for (i = 0; i < vcflMerge; i = i + 1) {
        pcVar1 = PszGetFleetName(((FLEET **)rglpfl)[vrgiflMerge[i]]->id);
        _strcpy(szT,pcVar1);
        if (1 < ((FLEET *)((FLEET **)rglpfl)[vrgiflMerge[i]])->cord) {
          _strcat(szT,(char *)&DAT_1120_16c4);
        }
        HVar3 = GetDlgItem(hwnd,0x51);
        SendMessage(HVar3,0x401,0,(LPARAM)CONCAT22(unaff_SS,szT));
        HVar3 = GetDlgItem(hwnd,0x51);
        if ((vcflMerge == 2) ||
           (((FLEET **)rglpfl)[vrgiflMerge[i]]->id == sel.fl.id)) {
          WVar2 = 1;
        }
        else {
          WVar2 = 0;
        }
        SendMessage(HVar3,0x406,WVar2,(long)i);
      }
      if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
        AdvanceTutor();
      }
      return 1;
    }
    if (msg == 0x111) {
      if ((wParam == 1) || (wParam == 2)) {
        for (i = 0; i < vcflMerge; i = i + 1) {
          HVar3 = GetDlgItem(hwnd,0x51);
          LVar5 = SendMessage(HVar3,0x408,i,0);
          if (LVar5 == 0) {
            vrgiflMerge[i] = -1;
          }
        }
        if (((wParam == 1) && (((uint)gd._0_2_ >> 0xb & 1) != 0)) &&
           (sVar4 = FOKMergeDialog(), sVar4 == 0)) {
          return 1;
        }
        StickyDlgPos(hwnd,(POINT *)&ptStickyMergeFleetsDlg,0);
        EndDialog(hwnd,(uint)(wParam == 1));
        return 1;
      }
      if (wParam == 0x76) {
        WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x453);
        return 1;
      }
      if ((wParam == 0x7f8) || (wParam == 0x7f9)) {
        for (i = 0; i < vcflMerge; i = i + 1) {
          HVar3 = GetDlgItem(hwnd,0x51);
          SendMessage(HVar3,0x406,(uint)(wParam == 0x7f8),(long)i);
        }
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: MarkTechsSeen
// Address: 1080:36b6
// Segment: MEMORY_SHIP2
// ======================================================================


void MarkTechsSeen(HUL *lphul,short iplr)

{
  short sVar1;
  byte bVar2;
  HUL *pHVar3;
  undefined2 uVar4;
  PART part;
  short ihs;
  short iTech;
  short iplrSav;
  
  sVar1 = idPlayer;
  idPlayer = iplr;
  part.hs.grhst = hstHull;
  part.hs.wFlags = part.hs.wFlags & 0xff00 | lphul->ihuldef & 0xff;
  FLookupPart(&part);
  for (iTech = 0; iTech < 6; iTech = iTech + 1) {
    if ((int)((COMPART *)part.pcom)->rgTech[iTech] <
        (int)(uint)((byte *)rgTechBattle)[iTech]) {
      bVar2 = ((byte *)rgTechBattle)[iTech];
    }
    else {
      bVar2 = ((COMPART *)part.pcom)->rgTech[iTech];
    }
    ((byte *)rgTechBattle)[iTech] = bVar2;
  }
  ihs = 0;
  while( true ) {
    uVar4 = (undefined2)((ulong)lphul >> 0x10);
    pHVar3 = (HUL *)lphul;
    if ((int)(uint)pHVar3->chs <= ihs) break;
    if ((uint)pHVar3->rghs[ihs].wFlags >> 8 != 0) {
      part.hs.grhst = (pHVar3->rghs + ihs)->grhst;
      part.hs.wFlags = pHVar3->rghs[ihs].wFlags;
      FLookupPart(&part);
      for (iTech = 0; iTech < 6; iTech = iTech + 1) {
        if ((int)((COMPART *)part.pcom)->rgTech[iTech] <
            (int)(uint)((byte *)rgTechBattle)[iTech]) {
          bVar2 = ((byte *)rgTechBattle)[iTech];
        }
        else {
          bVar2 = ((COMPART *)part.pcom)->rgTech[iTech];
        }
        ((byte *)rgTechBattle)[iTech] = bVar2;
      }
      iTech = -1;
      if (part.hs.grhst == hstEngine) {
        if ((part.hs.wFlags & 0xffU) == 8) {
          iTech = 9;
        }
      }
      else if (part.hs.grhst == hstShield) {
        if ((part.hs.wFlags & 0xffU) == 6) {
          iTech = 2;
        }
      }
      else if (part.hs.grhst == hstArmor) {
        if ((part.hs.wFlags & 0xffU) == 9) {
          iTech = 3;
        }
      }
      else if (part.hs.grhst == hstBeam) {
        if ((part.hs.wFlags & 0xffU) == 0x12) {
          iTech = 7;
        }
      }
      else if (part.hs.grhst == hstTorp) {
        if ((part.hs.wFlags & 0xffU) == 7) {
          iTech = 6;
        }
      }
      else if (part.hs.grhst == hstBomb) {
        if ((part.hs.wFlags & 0xffU) == 8) {
          iTech = 5;
        }
      }
      else if (part.hs.grhst == hstMining) {
        if ((part.hs.wFlags & 0xffU) == 6) {
          iTech = 4;
        }
      }
      else if (part.hs.grhst == hstSpecialE) {
        if ((part.hs.wFlags & 0xffU) == 4) {
          iTech = 1;
        }
      }
      else if (part.hs.grhst == hstSpecialM) {
        if ((part.hs.wFlags & 0xffU) == 4) {
          iTech = 0;
        }
        else if ((part.hs.wFlags & 0xffU) == 9) {
          iTech = 0xb;
        }
      }
      if (((iTech != -1) && (((byte *)rgTechTrader)[iTech] < 0x19)) &&
         (((byte *)rgTechTrader)[iTech] =
               ((byte *)rgTechTrader)[iTech] + (char)((uint)part.hs.wFlags >> 8),
         0x19 < ((byte *)rgTechTrader)[iTech])) {
        ((byte *)rgTechTrader)[iTech] = 0x19;
      }
    }
    ihs = ihs + 1;
  }
  idPlayer = sVar1;
  return;
}



