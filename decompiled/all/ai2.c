// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: DoMaidAiTurn
// Address: 1098:0000
// Segment: MEMORY_AI2
// ======================================================================


void DoMaidAiTurn(PROD *rgprod)

{
  short sVar1;
  short iroCur;
  long rgResAvail [4];
  long rgResCost [4];
  
                    /* Segment:    20
                       Offset:     00091800
                       Length:     302f
                       Min Alloc:  302f
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  if ((uint)game.turn < 0x14) {
    sVar1 = 0;
  }
  else {
    sVar1 = 0xf;
  }
  sVar1 = IroEnsureAi((byte *)0x0,0,(short *)0x0,sVar1);
  fMarkedPlanets = 0;
  HandleBasicAiTasks(sVar1,rgprod,-1,rgResAvail,rgResCost);
  FillProductionQueue();
  return;
}



// ======================================================================
// Function: FPotentISWarFleet
// Address: 1098:012e
// Segment: MEMORY_AI2
// ======================================================================


short FPotentISWarFleet(FLEET *lpfl,short iPotency)

{
  uint uVar1;
  short cEquiv;
  short ish;
  
  cEquiv = 0;
  ish = 0xb;
  while( true ) {
    if (0xc < ish) break;
    cEquiv = cEquiv + ((FLEET *)lpfl)->rgcsh[ish];
    ish = ish + 1;
  }
  for (ish = 9; ish < 0xb; ish = ish + 1) {
    cEquiv = cEquiv + ((FLEET *)lpfl)->rgcsh[ish] * 2;
  }
  if (iPotency < 2) {
    uVar1 = 1;
  }
  else {
    uVar1 = (uint)((int)(uint)vrgAiArmadaPotency[0] <= cEquiv);
  }
  return uVar1;
}



// ======================================================================
// Function: DoAutomitronAiTurn
// Address: 1098:01e0
// Segment: MEMORY_AI2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1098068c) */
/* WARNING: Variable defined which should be unmapped: ord_2 */
/* WARNING: Removing unreachable block (ram,0x109806ad) */
/* WARNING: Removing unreachable block (ram,0x10980a63) */
/* WARNING: Removing unreachable block (ram,0x109806b2) */
/* WARNING: Removing unreachable block (ram,0x10980be1) */

void DoAutomitronAiTurn(PROD *rgprod)

{
  uint *puVar1;
  int *piVar2;
  byte *pbVar3;
  uint uVar4;
  ORDER *pOVar5;
  PLORD *pPVar6;
  uint uVar7;
  int iVar8;
  short sVar9;
  short sVar10;
  int iVar11;
  PLANET *pPVar12;
  PLORD *pPVar13;
  FLEET *pFVar14;
  byte *pbVar15;
  undefined2 unaff_SI;
  ORDER *pOVar16;
  undefined2 unaff_DI;
  undefined2 uVar17;
  bool bVar18;
  ulong uVar19;
  PLANET *pPVar20;
  ulong uVar21;
  ORDER ord_2;
  short iPlanet;
  short fWrite;
  PROD *lpprod;
  long l;
  short iLatestBattle;
  short j;
  short iLatestBomber;
  short iLatestCargo;
  ushort cplanCol;
  ushort cRecyclePeriod;
  short ishdefSBLatest;
  byte b;
  FLEET *lpflAttack;
  FLEET *lpflT;
  short iroCur;
  short cRes;
  short i;
  short ifl;
  FLEET *lpfl;
  PLANET *lpplHome;
  PLANET *lppl;
  PLANET *lpplMac;
  short cplBadGuy;
  short idPlanDst;
  short cFr;
  THING *lpthWorm;
  short cplNegative;
  PLANET *lpplDest;
  byte rgRecycleShdef [16];
  ORDER ord;
  FLEET *lpflEnemy;
  long rgResAvail [4];
  short iLatestCruiser;
  long rgResCost [4];
  ushort rgCosts [4];
  short cExistCargo;
  
  uVar21 = CONCAT22(unaff_SI,unaff_DI);
  cplBadGuy = 0;
  cplNegative = 0;
  cplanCol = 0;
  if ((uint)game.turn < 10) {
    sVar9 = 0;
  }
  else {
    sVar9 = 0x14;
  }
  iroCur = IroEnsureAi(vrgAiISResOrder,0x12,&ishdefSBLatest,sVar9);
  if ((uint)game.turn < 0x33) {
    if (0x1e < (uint)game.turn) {
      MergeAllShdefs(0x4000);
    }
  }
  else {
    MergeAllShdefs(0x1e0c);
    MergeAllShdefs(0x40);
    MergeAllShdefs(0x4000);
  }
  j = 3;
  if (0x82 < (uint)game.turn) {
    j = (game.turn - 0x78U) / 0x14 + 3;
  }
  if (0x32 < (uint)j) {
    j = 0x32;
  }
  vrgAiArmadaPotency[0] = (byte)j;
  vrgAiArmadaPotency[1] = (byte)((ulong)(j & 0xff) / 2);
  j = 6;
  if (0x73 < (uint)game.turn) {
    j = (game.turn - 100U) / 0x16 + 6;
  }
  if (0xc < (uint)j) {
    j = 0xc;
  }
  vrgAiArmadaPotency[2] = (byte)j;
  if ((int)((uint)j / 2 - 1) < 4) {
    vrgAiArmadaPotency[3] = (char)((uint)j / 2) - 1;
  }
  else {
    vrgAiArmadaPotency[3] = 3;
  }
  _memset(rgRecycleShdef,0,0x10);
  if ((uint)game.turn < 0x78) {
    cRecyclePeriod = 0x32;
  }
  else if ((uint)game.turn < 200) {
    cRecyclePeriod = 0x46;
  }
  else {
    cRecyclePeriod = 100;
  }
  CheckAiShdefStatus(0xb,0xc,cRecyclePeriod,&iLatestCruiser,rgRecycleShdef);
  sVar9 = CheckAiShdefStatus(4,5,cRecyclePeriod,&iLatestCargo,rgRecycleShdef);
  CheckAiShdefStatus(2,3,cRecyclePeriod,&iLatestBomber,rgRecycleShdef);
  CheckAiShdefStatus(9,10,cRecyclePeriod,&iLatestBattle,rgRecycleShdef);
  if (0x3c < (uint)game.turn) {
    SplitOutShdefs(rgRecycleShdef);
  }
  EnsureISShdefs(iroCur);
  ord_2.txp.rgia[3].wFlags = (short)(PLANET *)lpPlanets;
  ord_2.txp.rgia[4].wFlags = lpPlanets._2_2_;
  lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
  lpplMac._2_2_ = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < (PLANET *)lpplMac) {
    uVar17 = (undefined2)((ulong)lppl >> 0x10);
    if (((((PLANET *)lppl)->iPlayer == -1) && (2 < (((PLANET *)lppl)->wFlags & 0xffU))) &&
       (sVar10 = PctPlanetOptValue(lppl,idPlayer), 0 < sVar10)) {
      cplanCol = cplanCol + 1;
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  ord_2.txp.rgia[3].wFlags = (short)(PLANET *)lpPlanets;
  ord_2.txp.rgia[4].wFlags = lpPlanets._2_2_;
  lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
  lpplMac._2_2_ = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < (PLANET *)lpplMac) {
    ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 9] = 1;
    uVar17 = (undefined2)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl)->iPlayer == idPlayer) || (((PLANET *)lppl)->iPlayer == -1)) {
      if ((((PLANET *)lppl)->iPlayer == idPlayer) &&
         (sVar10 = PctPlanetDesirability(lppl,idPlayer), sVar10 < 0)) {
        cplNegative = cplNegative + 1;
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] = 1;
      }
      else {
        uVar17 = (undefined2)((ulong)lppl >> 0x10);
        pPVar12 = (PLANET *)lppl;
        if ((((uint)pPVar12->wFlags >> 9 & 1) != 0) &&
           ((iVar11 = *(int *)((int)pPVar12->rgwtMin + 0xe), 0 < iVar11 ||
            ((-1 < iVar11 && (0x5db < *(uint *)(pPVar12->rgwtMin + 3))))))) {
          ChangeMainObjSel(1,lppl->id);
          InitProduction(rgprod);
          fWrite = 0;
          b = 0;
          i = 0;
          while ((i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac &&
                 ((uVar19 = __aFulshr(uVar21,ord_2.pt.x), ((uint)uVar19 & 7) != 2 ||
                  (uVar19 = __aFulshr(uVar21,ord_2.pt.x), 0xf < ((uint)uVar19 & 0x7f)))))) {
            i = i + 1;
          }
          if (i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
            FinishProduction(0);
          }
          else {
            uVar17 = (undefined2)((ulong)vlpbAiData >> 0x10);
            if (*(int *)((byte *)vlpbAiData + 2) * 2 <
                *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) / 10) {
              cFr = *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) / 10;
            }
            else {
              cFr = *(int *)((byte *)vlpbAiData + 2) << 1;
            }
            if ((('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))
                && (iLatestCargo != -1)) &&
               ((sVar9 < cFr ||
                ((sVar9 < (cFr * 10) / 7 && (sVar10 = Random(4), sVar10 == 0)))))) {
              AddItemToQueue(iLatestCargo,1,grobjFleet,1);
              fWrite = 1;
            }
            if ((((cplanCol != 0) && ((int)rgshdef[1].cExist == 0)) &&
                (rgshdef[1].cExist._2_2_ == 0)) && (10 < (uint)game.turn)) {
              AddItemToQueue(1,1,grobjFleet,1);
              fWrite = 1;
            }
            sVar10 = PctTrueMaxGrowth(idPlayer);
            uVar17 = (undefined2)((ulong)lppl >> 0x10);
            __aFulmul(CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                                       (int)((PLANET *)lppl)->rgwtMin[3]),(long)sVar10);
            cRes = CResourcesAtPlanet(lppl,idPlayer);
            if ((((uint)rgshdef[6].wFlags >> 9 & 1) == 0) &&
               (sVar10 = Random(3), sVar10 == 0)) {
              ord_2.txp.rgia[4].wFlags = lppl->id;
              cFr = 0;
              for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
                pFVar14 = ((FLEET **)rglpfl)[ifl];
                iVar11 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                lpfl = (FLEET *)CONCAT22(iVar11,pFVar14);
                if ((pFVar14 == (FLEET *)0x0) && (iVar11 == 0)) break;
                if ((pFVar14->idPlanet == ord_2.txp.rgia[4].wFlags) &&
                   ((0 < pFVar14->rgcsh[6] && (pFVar14->iPlayer == idPlayer)))) {
                  cFr = pFVar14->rgcsh[6];
                  break;
                }
              }
              if (((cFr < 10) || ((cFr < 0x11 && (sVar10 = Random(8), sVar10 == 0)))) &&
                 (sVar10 = Random(cFr * 2 + 1), sVar10 == 0)) {
                AddItemToQueue(6,3,grobjFleet,1);
                fWrite = 1;
              }
            }
            if (iLatestBomber != -1) {
              ord_2.txp.rgia[4].wFlags = lppl->id;
              for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
                pFVar14 = ((FLEET **)rglpfl)[ifl];
                iVar11 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                lpfl = (FLEET *)CONCAT22(iVar11,pFVar14);
                if ((pFVar14 == (FLEET *)0x0) && (iVar11 == 0)) break;
                if ((pFVar14->idPlanet == ord_2.txp.rgia[4].wFlags) &&
                   ((pFVar14->iPlayer == idPlayer &&
                    (sVar10 = FPotentISWarFleet((FLEET *)CONCAT22(iVar11,pFVar14),2), sVar10 != 0)))
                   ) {
                  if ((iLatestBomber != -1) &&
                     (uVar17 = (undefined2)((ulong)lpfl >> 0x10),
                     ord_2.txp.rgia[3].wFlags =
                          ((FLEET *)lpfl)->rgcsh[2] + ((FLEET *)lpfl)->rgcsh[3],
                     (int)(uint)vrgAiArmadaPotency[2] <= ord_2.txp.rgia[3].wFlags)) {
                    AddItemToQueue(iLatestBomber,4,grobjFleet,1);
                    fWrite = 1;
                    goto AI2_FinishProd;
                  }
                  break;
                }
              }
            }
            if (iLatestCruiser != -1) {
              ord_2.txp.rgia[3].wFlags = game.cPlanMax / 0xc + 8;
              ord_2.txp.rgia[4].wFlags = 0;
              if ((*(int *)((int)&rgshdef[0].cExist + 2 + iLatestCruiser * 0x93) == 0) &&
                 (*(uint *)((int)&rgshdef[0].cExist + iLatestCruiser * 0x93) <
                  (uint)ord_2.txp.rgia[3].wFlags)) {
                GetResourcesAvailable(lppl,rgResAvail);
                GetProdQCost(lppl,rgResCost);
                for (i = 0; i < 4; i = i + 1) {
                  uVar7 = *(uint *)(rgResCost + i);
                  iVar11 = *(int *)((int)rgResCost + i * 4 + 2);
                  puVar1 = (uint *)(rgResAvail + i);
                  uVar4 = *puVar1;
                  *puVar1 = *puVar1 - uVar7;
                  piVar2 = (int *)((int)rgResAvail + i * 4 + 2);
                  *piVar2 = (*piVar2 - iVar11) - (uint)(uVar4 < uVar7);
                  iVar11 = *(int *)((int)rgResAvail + i * 4 + 2);
                  if ((iVar11 < 1) && (iVar11 < 0)) goto AI2_FinishProd;
                }
                for (i = 0; i < 5; i = i + 1) {
                  GetTrueHullCost
                            (idPlayer,
                             (HUL *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                             (HUL *)(iLatestCruiser * 0x93 + 0x3f00)),rgCosts);
                  for (j = 0; j < 4; j = j + 1) {
                    uVar7 = rgCosts[j];
                    puVar1 = (uint *)(rgResAvail + j);
                    uVar4 = *puVar1;
                    *puVar1 = *puVar1 - uVar7;
                    piVar2 = (int *)((int)rgResAvail + j * 4 + 2);
                    *piVar2 = *piVar2 - (uint)(uVar4 < uVar7);
                    iVar11 = *(int *)((int)rgResAvail + j * 4 + 2);
                    if ((iVar11 < 1) && (iVar11 < 0)) goto AI2_FinishProd;
                  }
                  fWrite = 1;
                  AddItemToQueue(iLatestCruiser,1,grobjFleet,1);
                }
              }
            }
            if (iLatestBattle != -1) {
              ord_2.txp.rgia[3].wFlags = game.cPlanMax / 0x18 + 4;
              ord_2.txp.rgia[4].wFlags = 0;
              if ((*(int *)((int)&rgshdef[0].cExist + 2 + iLatestBattle * 0x93) == 0) &&
                 (*(uint *)((int)&rgshdef[0].cExist + iLatestBattle * 0x93) <
                  (uint)ord_2.txp.rgia[3].wFlags)) {
                GetResourcesAvailable(lppl,rgResAvail);
                GetProdQCost(lppl,rgResCost);
                for (i = 0; i < 4; i = i + 1) {
                  uVar7 = *(uint *)(rgResCost + i);
                  iVar11 = *(int *)((int)rgResCost + i * 4 + 2);
                  puVar1 = (uint *)(rgResAvail + i);
                  uVar4 = *puVar1;
                  *puVar1 = *puVar1 - uVar7;
                  piVar2 = (int *)((int)rgResAvail + i * 4 + 2);
                  *piVar2 = (*piVar2 - iVar11) - (uint)(uVar4 < uVar7);
                  iVar11 = *(int *)((int)rgResAvail + i * 4 + 2);
                  if ((iVar11 < 1) && (iVar11 < 0)) goto AI2_FinishProd;
                }
                for (i = 0; i < 5; i = i + 1) {
                  GetTrueHullCost
                            (idPlayer,
                             (HUL *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                             (HUL *)(iLatestBattle * 0x93 + 0x3f00)),rgCosts);
                  for (j = 0; j < 4; j = j + 1) {
                    uVar7 = rgCosts[j];
                    puVar1 = (uint *)(rgResAvail + j);
                    uVar4 = *puVar1;
                    *puVar1 = *puVar1 - uVar7;
                    piVar2 = (int *)((int)rgResAvail + j * 4 + 2);
                    *piVar2 = *piVar2 - (uint)(uVar4 < uVar7);
                    iVar11 = *(int *)((int)rgResAvail + j * 4 + 2);
                    if ((iVar11 < 1) && (iVar11 < 0)) goto AI2_FinishProd;
                  }
                  fWrite = 1;
                  AddItemToQueue(iLatestBattle,1,grobjFleet,1);
                }
              }
            }
AI2_FinishProd:
            FinishProduction(fWrite);
          }
        }
      }
    }
    else {
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] =
           ((byte)((uint)((PLANET *)lppl)->wFlags >> 9) & 1) + 1;
      sVar10 = PctPlanetOptValue(lppl,idPlayer);
      if (0 < sVar10) {
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 3] = 1;
      }
      cplBadGuy = cplBadGuy + 1;
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  lpflAttack._0_2_ = (FLEET *)0x0;
  lpflAttack._2_2_ = 0;
  lpflEnemy._0_2_ = (FLEET *)0x0;
  lpflEnemy._2_2_ = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar14 = ((FLEET **)rglpfl)[ifl];
    iVar11 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar11,pFVar14);
    if ((pFVar14 == (FLEET *)0x0) && (iVar11 == 0)) break;
    if (pFVar14->iPlayer == idPlayer) {
      sVar9 = FIsAiAttack((FLEET *)CONCAT22(iVar11,pFVar14));
      if (sVar9 != 0) {
        *(FLEET **)&((FLEET *)lpfl)->lpflNext = (FLEET *)lpflAttack;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpflNext + 2) = lpflAttack._2_2_;
        lpflAttack._0_2_ = (FLEET *)lpfl;
        lpflAttack._2_2_ = lpfl._2_2_;
      }
      ((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0x7fff;
      sVar9 = FIsAiTransport(lpfl);
      pFVar14 = (FLEET *)lpfl;
      uVar17 = (undefined2)((ulong)lpfl >> 0x10);
      if (sVar9 == 0) {
        if (pFVar14->rgcsh[1] != 0) {
          idPlanDst = -1;
          if (pFVar14->cord < 2) {
            idPlanDst = pFVar14->idPlanet;
          }
          else if (((uint)((PLORD *)pFVar14->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
            idPlanDst = *(short *)&((PLORD *)pFVar14->lpplord)[6].iordMax;
          }
          if (idPlanDst != -1) {
            if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0)
            goto AI2_LCheckForColDrop_2;
            lppl = LpplFromId(idPlanDst);
            iVar11 = (int)((ulong)lppl >> 0x10);
            pPVar12 = (PLANET *)lppl;
            if (((pPVar12 != (PLANET *)0x0) || (iVar11 != 0)) &&
               ((pPVar12->iPlayer != -1 && (pPVar12->iPlayer != idPlayer))))
            goto AI2_LBlowAwayOrders_2;
          }
        }
      }
      else {
        idPlanDst = -1;
        if (pFVar14->cord < 2) {
          idPlanDst = pFVar14->idPlanet;
        }
        else if (((uint)((PLORD *)pFVar14->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
          idPlanDst = *(short *)&((PLORD *)pFVar14->lpplord)[6].iordMax;
        }
AI2_LCheckForColDrop_2:
        if (idPlanDst != -1) {
          lppl = LpplFromId(idPlanDst);
          iVar11 = (int)((ulong)lppl >> 0x10);
          pPVar12 = (PLANET *)lppl;
          if (((pPVar12 == (PLANET *)0x0) && (iVar11 == 0)) ||
             ((pPVar12->iPlayer != -1 && (pPVar12->iPlayer != idPlayer)))) {
            if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0) {
              uVar17 = (undefined2)((ulong)lpfl >> 0x10);
              iVar8 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0xe);
              if ((-1 < iVar8) &&
                 (((0 < iVar8 || ((int)((FLEET *)lpfl)->rgwtMin[3] != 0)) &&
                  (sVar9 = GetRaceStat((PLAYER *)rgplr + pPVar12->iPlayer,rsMajorAdv
                                            ), sVar9 != 8)))) {
                _memset(&ord_2,0,0x12);
                ord_2.pt.x = ((POINT *)rgptPlan + idPlanDst)->x;
                ord_2.pt.y = *(short *)((int)&rgptPlan[0].y + idPlanDst * 4);
                ord_2.id = idPlanDst;
                ord_2.wFlags = ord_2.wFlags & 0xe0f0U | 0x1101;
                ord_2.txp.rgia[3].wFlags = ord_2.txp.rgia[3].wFlags & 0xfffU | 0x2000;
                ChangeMainObjSel(2,lpfl->id);
                uVar17 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                pPVar13 = (PLORD *)sel.fl.lpplord;
                if ((pPVar13 + 2)->wFlags == idPlanDst) {
                  pPVar13 = pPVar13 + 1;
                  pOVar16 = &ord_2;
                  for (iVar11 = 9; iVar11 != 0; iVar11 = iVar11 + -1) {
                    pPVar6 = pPVar13;
                    pPVar13 = (PLORD *)&pPVar13->iordMax;
                    pOVar5 = pOVar16;
                    pOVar16 = (ORDER *)&(pOVar16->pt).y;
                    pPVar6->wFlags = (pOVar5->pt).x;
                  }
                }
                else {
                  pbVar15 = &pPVar13[5].iordMax;
                  pOVar16 = &ord_2;
                  for (iVar11 = 9; iVar11 != 0; iVar11 = iVar11 + -1) {
                    pbVar3 = pbVar15;
                    pbVar15 = pbVar15 + 2;
                    pOVar5 = pOVar16;
                    pOVar16 = (ORDER *)&(pOVar16->pt).y;
                    *(short *)pbVar3 = (pOVar5->pt).x;
                  }
                }
                FLookupFleet(-1,(FLEET *)&sel.fl);
                ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] =
                     ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] | 0x80;
                goto LAB_1098_0d5d;
              }
            }
AI2_LBlowAwayOrders_2:
            ChangeMainObjSel(2,lpfl->id);
            sel.fl.cord = 1;
            ((PLORD *)sel.fl.lpplord)->iordMac = 1;
            FLookupFleet(-1,(FLEET *)&sel.fl);
            ClearAiCurrentTask(lpfl,0);
          }
        }
      }
    }
    else {
      *(FLEET **)&pFVar14->lpflNext = (FLEET *)lpflEnemy;
      *(int *)((int)&pFVar14->lpflNext + 2) = lpflEnemy._2_2_;
      lpflEnemy._0_2_ = pFVar14;
      lpflEnemy._2_2_ = iVar11;
    }
LAB_1098_0d5d:
  }
  fMarkedPlanets = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar14 = ((FLEET **)rglpfl)[ifl];
    iVar11 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar11,pFVar14);
    if ((pFVar14 == (FLEET *)0x0) && (iVar11 == 0)) break;
    if (pFVar14->iPlayer == idPlayer) {
      if (pFVar14->cord < 2) {
        if (pFVar14->rgcsh[6] == 0) {
          if (pFVar14->rgcsh[1] == 0) {
            sVar9 = FIsAiTransport((FLEET *)CONCAT22(iVar11,pFVar14));
            if (sVar9 == 0) {
              uVar17 = (undefined2)((ulong)lpfl >> 0x10);
              pFVar14 = (FLEET *)lpfl;
              if ((pFVar14->rgcsh[2] == 0) && (pFVar14->rgcsh[3] == 0)) {
                if (pFVar14->rgcsh[0] != 0) {
                  ChangeMainObjSel(2,lpfl->id);
                  if ((((rgshdef[0].hul.rghs[0].wFlags & 0xffU) < 10) &&
                      (iVar11 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0x12), iVar11 < 1)) &&
                     ((iVar11 < 0 || (*(uint *)(((FLEET *)lpfl)->rgwtMin + 4) < 2))))
                  goto AI2_LScrapFleet_2;
                  IdTargetScout(lpfl,(FLEET *)CONCAT22(lpflAttack._2_2_,(FLEET *)lpflAttack),
                                     (FLEET *)CONCAT22(lpflEnemy._2_2_,(FLEET *)lpflEnemy),
                                     (uint)game.wCrap >> 4 & 1,&lpthWorm);
                }
              }
              else {
                ChangeMainObjSel(2,lpfl->id);
                uVar17 = (undefined2)((ulong)lpfl >> 0x10);
                if (((FLEET *)lpfl)->idPlanet == -1) {
                  lppl = (PLANET *)CONCAT22(lpplHome._2_2_,(PLANET *)lpplHome);
                }
                else {
                  lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
                  uVar17 = (undefined2)((ulong)lppl >> 0x10);
                  pPVar12 = (PLANET *)lppl;
                  if (pPVar12->iPlayer == idPlayer) {
                    if (((uint)pPVar12->wFlags >> 9 & 1) != 0) {
                      uVar17 = (undefined2)((ulong)lpfl >> 0x10);
                      pFVar14 = (FLEET *)lpfl;
                      if (((pFVar14->rgcsh[2] < 2) && (pFVar14->rgcsh[3] < 2)) ||
                         ((pFVar14->rgcsh[9] < 3 && (pFVar14->rgcsh[10] < 3)))) goto LAB_1098_1162;
                    }
                    FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
                  }
                  else if (pPVar12->iPlayer != -1) {
                    lpflT = (FLEET *)CONCAT22(lpflEnemy._2_2_,(FLEET *)lpflEnemy);
                    do {
                      if (((FLEET *)lpflT == (FLEET *)0x0) && (lpflT._2_2_ == 0))
                      goto LAB_1098_1162;
                      uVar17 = (undefined2)((ulong)lpfl >> 0x10);
                      if (((&((FLEET *)lpfl)->pt)->x == (&((FLEET *)lpflT)->pt)->x) &&
                         ((((FLEET *)lpfl)->pt).y == (((FLEET *)lpflT)->pt).y)) {
                        sVar9 = FIsAiAttack(lpflT);
                        if (sVar9 != 0) break;
                      }
                      uVar17 = (undefined2)((ulong)lpflT >> 0x10);
                    /* WARNING: Load size is inaccurate */
                      lpflT = (FLEET *)CONCAT22(*(undefined2 *)
                                                 ((int)&((FLEET *)lpflT)->lpflNext + 2),
                                                ((FLEET *)lpflT)->lpflNext);
                    } while( true );
                  }
                }
                if (((uint)game.wCrap >> 4 & 1) == 0) {
                  pPVar20 = (PLANET *)0x0;
                }
                else {
                  pPVar20 = LpplFindBestEnum(lppl,FEnumCalcArmadaHumanDest);
                }
                if (pPVar20 == (PLANET *)0x0) {
                  lpplDest = pPVar20;
                  pPVar20 = LpplFindBestEnum(lppl,FEnumCalcArmadaDest);
                }
                lppl = pPVar20;
                lpplDest._2_2_ = (int)((ulong)lppl >> 0x10);
                lpplDest = lppl;
                if (((PLANET *)lppl != (PLANET *)0x0) || (bVar18 = lpplDest._2_2_ != 0, bVar18)) {
                  ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] =
                       ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] | 0x80;
                  ord.id = lppl->id;
                  ord.pt.x = ((POINT *)rgptPlan + lppl->id)->x;
                  ord.pt.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
                  ord.wFlags = ord.wFlags & 0xe000U | 0x1140;
                  FMoveAiFleet(lpfl,&ord,0);
                }
              }
            }
            else {
              lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
              ord_2.txp.rgia[3].wFlags = (short)(PLANET *)lpPlanets;
              ord_2.txp.rgia[4].wFlags = lpPlanets._2_2_;
              lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
              lpplMac._2_2_ = lpPlanets._2_2_;
              while( true ) {
                if (((PLANET *)lpplMac <= (PLANET *)lppl) ||
                   ((((PLANET *)lppl)->iPlayer == idPlayer &&
                    (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)))) break;
                lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
              }
              lpplHome._0_2_ = (PLANET *)lppl;
              lpplHome._2_2_ = lppl._2_2_;
              if (((PLANET *)lppl == (PLANET *)lpplMac) && (lppl._2_2_ == lpPlanets._2_2_)) {
                lpplHome._0_2_ = (PLANET *)0x0;
                lpplHome._2_2_ = 0;
              }
              if (((PLANET *)lpplHome == (PLANET *)0x0) && (lpplHome._2_2_ == 0)) break;
              lppl = (PLANET *)0x0;
              i = 0;
              while( true ) {
                uVar17 = (undefined2)((ulong)vlpbAiData >> 0x10);
                pbVar15 = (byte *)vlpbAiData;
                if (*(int *)(pbVar15 + 2) <= i) break;
                j = 0;
                while ((j < *(int *)(pbVar15 + i * 0x14 + 6) &&
                       (ord_2.txp.rgia[4].wFlags = lpfl->id,
                       *(int *)(pbVar15 + j * 2 + i * 0x14 + 8) != ord_2.txp.rgia[4].wFlags))) {
                  j = j + 1;
                }
                if (j < *(int *)(pbVar15 + i * 0x14 + 6)) break;
                i = i + 1;
              }
              if (i < *(int *)(pbVar15 + 2)) {
                lppl = LpplFromId(*(short *)(pbVar15 + i * 0x14 + 4));
              }
              if (((PLANET *)lppl != (PLANET *)0x0) ||
                 (pPVar12 = (PLANET *)lpplHome, iVar11 = lpplHome._2_2_, lppl._2_2_ != 0)) {
                pPVar12 = (PLANET *)lppl;
                iVar11 = lppl._2_2_;
              }
              IdTargetFreighter(lpfl,(PLANET *)CONCAT22(iVar11,pPVar12));
            }
          }
          else {
            if (rgshdef[1].hul.ihuldef != ihuldefMediumFreighter) goto AI2_LScrapFleet_2;
            ChangeMainObjSel(2,lpfl->id);
            uVar17 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar14 = (FLEET *)lpfl;
            if (((((pFVar14->idPlanet == -1) || (sel.pl.iPlayer != idPlayer)) ||
                 ((sel.pl.rgwtMin[3]._2_2_ < 1 &&
                  ((sel.pl.rgwtMin[3]._2_2_ < 0 ||
                   ((uint)sel.pl.rgwtMin[3] < 200)))))) && ((int)pFVar14->rgwtMin[3] == 0)
                ) && (*(int *)((int)pFVar14->rgwtMin + 0xe) == 0)) {
              if (((sel.fl.idPlanet == -1) ||
                  (sel.pl.iPlayer != idPlayer)) ||
                 (((uint)sel.pl.wFlags >> 9 & 1) == 0)) {
                if (1 < (rgshdef[1].hul.rghs[0].wFlags & 0xffU)) {
                  sVar9 = FMoveToNearestStarbase(lpfl,0);
                  if (sVar9 != 0) goto LAB_1098_1162;
                }
AI2_LScrapFleet_2:
                ChangeMainObjSel(2,lpfl->id);
                uVar17 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                     *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
                FLookupFleet(-1,(FLEET *)&sel.fl);
              }
            }
            else {
              lpthWorm._0_2_ = (THING *)0x0;
              lpthWorm._2_2_ = 0;
              idPlanDst = IdNearestColonizablePlanet(lpfl,(THING **)0x0);
              if ((((FLEET *)lpfl)->idPlanet != -1) && (sel.pl.iPlayer == idPlayer)
                 ) {
                ChangeMainObjSel(2,lpfl->id);
                XferAiSupply(1,((FLEET *)lpfl)->idPlanet,2,lpfl->id,3,0x96);
                FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
              }
              if (idPlanDst != -1) {
                FColonizeAiFleet(lpfl,idPlanDst);
                ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 0xf] = 4;
              }
            }
          }
        }
        else if ((pFVar14->cord == 1) &&
                ((*(uint *)&((PLORD *)pFVar14->lpplord)[2].iordMax & 0xf) == 0)) {
          ChangeMainObjSel(2,lpfl->id);
          uVar17 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
          *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
               *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 6;
          ((PLORD *)sel.fl.lpplord + 3)->wFlags = 5;
          pbVar3 = &((PLORD *)sel.fl.lpplord)[3].iordMax;
          pbVar3[0] = 5;
          pbVar3[1] = 0;
          FLookupFleet(-1,(FLEET *)&sel.fl);
        }
      }
      else if ((((rgshdef[0].hul.rghs[0].wFlags & 0xffU) < 10) &&
               (iVar8 = *(int *)((int)pFVar14->rgwtMin + 0x12), iVar8 < 1)) &&
              ((iVar8 < 0 || (*(uint *)(pFVar14->rgwtMin + 4) < 2)))) goto AI2_LScrapFleet_2;
    }
LAB_1098_1162:
  }
  HandleBasicAiTasks(iroCur,rgprod,ishdefSBLatest,rgResAvail,rgResCost);
  FillProductionQueue();
  return;
}



// ======================================================================
// Function: EnsureISShdefs
// Address: 1098:1938
// Segment: MEMORY_AI2
// ======================================================================


void EnsureISShdefs(short iroCur)

{
  SHDEF *pSVar1;
  SHDEF *pSVar2;
  short sVar3;
  int iVar4;
  SHDEF *pSVar5;
  SHDEF *pSVar6;
  undefined2 unaff_SS;
  short i;
  SHDEF shdef;
  
  if ((((uint)rgshdef[4].wFlags >> 9 & 1) != 0) &&
     ('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) {
    FCreateAiShdef(4,1,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0xe] + 0x78)));
  }
  if ((((uint)rgshdef[5].wFlags >> 9 & 1) != 0) &&
     ('\x06' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) {
    FCreateAiShdef(5,3,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0x12] + 0x78)));
  }
  if ((((((uint)rgshdef[0xe].wFlags >> 9 & 1) != 0) &&
       ('\x04' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
      ('\x05' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0))) &&
     (('\x03' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))) {
    for (i = 0; i < 4; i = i + 1) {
      sVar3 = Random(1);
      sVar3 = FCreateAiShdef(0xe,6,(byte *)CONCAT22(0x1098,(byte *)(*(byte *)(sVar3 + 0x68) +
                                                                        0x78)));
      if (sVar3 != 0) break;
    }
  }
  if ((((uint)rgshdef[1].wFlags >> 9 & 1) != 0) ||
     (((int)rgshdef[1].cExist == 0 && (rgshdef[1].cExist._2_2_ == 0)))) {
    if (((uint)rgshdef[1].wFlags >> 9 & 1) == 0) {
      pSVar5 = (SHDEF *)(rgshdef + 1);
      pSVar6 = &shdef;
      for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
        pSVar2 = pSVar6;
        pSVar6 = (SHDEF *)(pSVar6->hul).rgTech;
        pSVar1 = pSVar5;
        pSVar5 = (SHDEF *)(pSVar5->hul).rgTech;
        (pSVar2->hul).ihuldef = (pSVar1->hul).ihuldef;
      }
      *(char *)&(pSVar6->hul).ihuldef = (char)(pSVar5->hul).ihuldef;
      shdef.wFlags = shdef.wFlags & 0xfdffU | 0x200;
      FChangeAiShdef(&shdef,1);
    }
    FCreateAiShdef(1,1,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0] + 0x78)));
  }
  if ((((uint)rgshdef[0].wFlags >> 9 & 1) != 0) ||
     (((int)rgshdef[0].cExist == 0 && (rgshdef[0].cExist._2_2_ == 0)))) {
    if (((uint)rgshdef[0].wFlags >> 9 & 1) == 0) {
      pSVar5 = (SHDEF *)rgshdef;
      pSVar6 = &shdef;
      for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
        pSVar2 = pSVar6;
        pSVar6 = (SHDEF *)(pSVar6->hul).rgTech;
        pSVar1 = pSVar5;
        pSVar5 = (SHDEF *)(pSVar5->hul).rgTech;
        (pSVar2->hul).ihuldef = (pSVar1->hul).ihuldef;
      }
      *(char *)&(pSVar6->hul).ihuldef = (char)(pSVar5->hul).ihuldef;
      shdef.wFlags = shdef.wFlags & 0xfdffU | 0x200;
      FChangeAiShdef(&shdef,0);
    }
    FCreateAiShdef(0,4,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[1] + 0x78)));
  }
  if ((((((uint)rgshdef[6].wFlags >> 9 & 1) != 0) &&
       ('\x03' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0))) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) &&
     ('\x05' < *(char *)((int)rgplr[0].rgTech + 5 + idPlayer * 0xc0))) {
    FCreateAiShdef(6,0xb,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0x11] + 0x78)));
  }
  if (((((uint)rgshdef[2].wFlags >> 9 & 1) != 0) &&
      ('\a' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
     (('\x06' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) &&
      (('\x05' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
       ('\x06' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))))) {
    FCreateAiShdef(2,0x11,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0xf] + 0x78)));
  }
  if ((((((uint)rgshdef[3].wFlags >> 9 & 1) != 0) &&
       ('\n' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
      ('\v' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0))) &&
     (('\x0e' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
      ('\b' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))) {
    FCreateAiShdef(3,0x13,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0x10] + 0x78)));
  }
  if (((((uint)rgshdef[9].wFlags >> 9 & 1) != 0) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
     (('\x05' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) &&
      (('\f' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
       ('\x06' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))))) {
    for (i = 0; i < 5; i = i + 1) {
      sVar3 = Random(4);
      sVar3 = FCreateAiShdef(9,9,(byte *)CONCAT22(0x1098,(byte *)(*(byte *)(sVar3 + 0x6e) +
                                                                      0x78)));
      if (sVar3 != 0) {
        return;
      }
    }
  }
  return;
}



// ======================================================================
// Function: DoRototillAiTurn
// Address: 1098:1e22
// Segment: MEMORY_AI2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109821c6) */
/* WARNING: Variable defined which should be unmapped: ord_2 */
/* WARNING: Removing unreachable block (ram,0x109821e6) */
/* WARNING: Removing unreachable block (ram,0x109821eb) */
/* WARNING: Removing unreachable block (ram,0x10982294) */

void DoRototillAiTurn(PROD *rgprod)

{
  ORDER *pOVar1;
  PLORD *pPVar2;
  byte *pbVar3;
  int iVar4;
  short sVar5;
  THING **plpthWorm;
  int iVar6;
  PLANET *pPVar7;
  PLORD *pPVar8;
  FLEET *pFVar9;
  byte *pbVar10;
  undefined2 unaff_SI;
  ORDER *pOVar11;
  undefined2 unaff_DI;
  undefined2 uVar12;
  bool bVar13;
  ulong uVar14;
  PLANET *pPVar15;
  ulong uVar16;
  ORDER ord_2;
  short iPlanet;
  short fWrite;
  PROD *lpprod;
  short j;
  ushort cplanCol;
  short fBomberInQueue;
  short ishdefSBLatest;
  byte b;
  FLEET *lpflAttack;
  FLEET *lpflT;
  short iroCur;
  short i;
  short ifl;
  FLEET *lpfl;
  PLANET *lpplHome;
  PLANET *lppl;
  PLANET *lpplMac;
  short cplBadGuy;
  short idPlanDst;
  short fColonyShipInQueue;
  THING *lpthWorm;
  short cplNegative;
  PLANET *lpplDest;
  ORDER ord;
  FLEET *lpflEnemy;
  long rgResAvail [4];
  long rgResCost [4];
  
  uVar16 = CONCAT22(unaff_SI,unaff_DI);
  cplBadGuy = 0;
  cplNegative = 0;
  cplanCol = 0;
  fColonyShipInQueue = 0;
  if ((uint)game.turn < 0x14) {
    sVar5 = 0;
  }
  else {
    sVar5 = 0xf;
  }
  iroCur = IroEnsureAi((byte *)0x0,0,&ishdefSBLatest,sVar5);
  EnsureCAShdefs(iroCur);
  ord_2.txp.rgia[3].wFlags = (short)(PLANET *)lpPlanets;
  ord_2.txp.rgia[4].wFlags = lpPlanets._2_2_;
  lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
  lpplMac._2_2_ = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < (PLANET *)lpplMac) {
    uVar12 = (undefined2)((ulong)lppl >> 0x10);
    if (((((PLANET *)lppl)->iPlayer == -1) && (2 < (((PLANET *)lppl)->wFlags & 0xffU))) &&
       (sVar5 = PctPlanetOptValue(lppl,idPlayer), 0 < sVar5)) {
      cplanCol = cplanCol + 1;
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  ord_2.txp.rgia[3].wFlags = (short)(PLANET *)lpPlanets;
  ord_2.txp.rgia[4].wFlags = lpPlanets._2_2_;
  lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
  lpplMac._2_2_ = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < (PLANET *)lpplMac) {
    ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 9] = 1;
    uVar12 = (undefined2)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl)->iPlayer == -1) && (2 < (((PLANET *)lppl)->wFlags & 0xffU))) {
      b = 0;
      for (i = 0; i < 3; i = i + 1) {
        if (((PLANET *)lppl)->rgMinConc[i] < 0x43) {
          ord_2.txp.rgia[4].wFlags._0_1_ = ((PLANET *)lppl)->rgMinConc[i] / 2;
        }
        else {
          ord_2.txp.rgia[4].wFlags._0_1_ = 0x4b;
        }
        b = b + (byte)ord_2.txp.rgia[4].wFlags;
      }
      if ((b & 0x80) != 0) {
        b = 0x7f;
      }
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] = b;
    }
    if ((((PLANET *)lppl)->iPlayer == idPlayer) || (((PLANET *)lppl)->iPlayer == -1)) {
      if ((((PLANET *)lppl)->iPlayer == idPlayer) &&
         (sVar5 = PctPlanetDesirability(lppl,idPlayer), sVar5 < 0)) {
        cplNegative = cplNegative + 1;
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] = 1;
      }
      else {
        uVar12 = (undefined2)((ulong)lppl >> 0x10);
        pPVar7 = (PLANET *)lppl;
        if ((((uint)pPVar7->wFlags >> 9 & 1) != 0) &&
           ((iVar6 = *(int *)((int)pPVar7->rgwtMin + 0xe), 0 < iVar6 ||
            ((-1 < iVar6 && (999 < *(uint *)(pPVar7->rgwtMin + 3))))))) {
          ChangeMainObjSel(1,lppl->id);
          InitProduction(rgprod);
          fWrite = 0;
          b = 0;
          i = 0;
          while ((i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac &&
                 ((uVar14 = __aFulshr(uVar16,ord_2.pt.x), ((uint)uVar14 & 7) != 2 ||
                  (uVar14 = __aFulshr(uVar16,ord_2.pt.x), ((uint)uVar14 & 0x7f) < 0x11)))))
          {
            i = i + 1;
          }
          if (i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
            FinishProduction(0);
          }
          else {
            if (game.turn == 0) {
              AddItemToQueue(0,1,grobjFleet,1);
              AddItemToQueue(0,1,grobjFleet,1);
            }
            else if ((fColonyShipInQueue == 0) &&
                    ((((uint)rgshdef[1].cExist == 0 &&
                      (rgshdef[1].cExist._2_2_ == 0)) ||
                     ((rgshdef[1].cExist._2_2_ +
                       (uint)(0xfffe < (uint)rgshdef[1].cExist) == 0 &&
                      ((uint)rgshdef[1].cExist + 1 < cplanCol)))))) {
              fColonyShipInQueue = 1;
              AddItemToQueue(1,1,grobjFleet,1);
              fWrite = 1;
            }
            FinishProduction(fWrite);
          }
        }
      }
    }
    else {
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] =
           ((byte)((uint)((PLANET *)lppl)->wFlags >> 9) & 1) + 1;
      sVar5 = PctPlanetOptValue(lppl,idPlayer);
      if (0 < sVar5) {
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 3] = 1;
      }
      cplBadGuy = cplBadGuy + 1;
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  lpflAttack._0_2_ = (FLEET *)0x0;
  lpflAttack._2_2_ = 0;
  lpflEnemy._0_2_ = (FLEET *)0x0;
  lpflEnemy._2_2_ = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar9 = ((FLEET **)rglpfl)[ifl];
    iVar6 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar6,pFVar9);
    if ((pFVar9 == (FLEET *)0x0) && (iVar6 == 0)) break;
    if (pFVar9->iPlayer == idPlayer) {
      sVar5 = FIsTurinDroneAiAttack((FLEET *)CONCAT22(iVar6,pFVar9));
      if (sVar5 != 0) {
        *(FLEET **)&((FLEET *)lpfl)->lpflNext = (FLEET *)lpflAttack;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpflNext + 2) = lpflAttack._2_2_;
        lpflAttack._0_2_ = (FLEET *)lpfl;
        lpflAttack._2_2_ = lpfl._2_2_;
      }
      ((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0x7fff;
      if (((((FLEET *)lpfl)->rgcsh[7] == 0) && (((FLEET *)lpfl)->rgcsh[8] == 0)) ||
         (((FLEET *)lpfl)->cord < 1)) {
        sVar5 = FIsAiTransport(lpfl);
        pFVar9 = (FLEET *)lpfl;
        uVar12 = (undefined2)((ulong)lpfl >> 0x10);
        if (sVar5 == 0) {
          if (pFVar9->rgcsh[1] != 0) {
            idPlanDst = -1;
            if (pFVar9->cord < 2) {
              idPlanDst = pFVar9->idPlanet;
            }
            else if (((uint)((PLORD *)pFVar9->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
              idPlanDst = *(short *)&((PLORD *)pFVar9->lpplord)[6].iordMax;
            }
            if (idPlanDst != -1) {
              if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0)
              goto AI2_LCheckForColDrop;
              lppl = LpplFromId(idPlanDst);
              iVar6 = (int)((ulong)lppl >> 0x10);
              pPVar7 = (PLANET *)lppl;
              if ((((pPVar7 != (PLANET *)0x0) || (iVar6 != 0)) && (pPVar7->iPlayer != -1)) &&
                 (pPVar7->iPlayer != idPlayer)) goto AI2_LBlowAwayOrders;
            }
          }
        }
        else {
          idPlanDst = -1;
          if (pFVar9->cord < 2) {
            idPlanDst = pFVar9->idPlanet;
          }
          else if (((uint)((PLORD *)pFVar9->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
            idPlanDst = *(short *)&((PLORD *)pFVar9->lpplord)[6].iordMax;
          }
AI2_LCheckForColDrop:
          if (idPlanDst != -1) {
            lppl = LpplFromId(idPlanDst);
            iVar6 = (int)((ulong)lppl >> 0x10);
            pPVar7 = (PLANET *)lppl;
            if (((pPVar7 == (PLANET *)0x0) && (iVar6 == 0)) ||
               ((pPVar7->iPlayer != -1 && (pPVar7->iPlayer != idPlayer)))) {
              if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0) {
                uVar12 = (undefined2)((ulong)lpfl >> 0x10);
                iVar4 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0xe);
                if (((-1 < iVar4) && ((0 < iVar4 || ((int)((FLEET *)lpfl)->rgwtMin[3] != 0)))) &&
                   (sVar5 = GetRaceStat((PLAYER *)rgplr + pPVar7->iPlayer,rsMajorAdv
                                             ), sVar5 != 8)) {
                  _memset(&ord_2,0,0x12);
                  ord_2.pt.x = ((POINT *)rgptPlan + idPlanDst)->x;
                  ord_2.pt.y = *(short *)((int)&rgptPlan[0].y + idPlanDst * 4);
                  ord_2.id = idPlanDst;
                  ord_2.wFlags = ord_2.wFlags & 0xe0f0U | 0x1101;
                  ord_2.txp.rgia[3].wFlags = ord_2.txp.rgia[3].wFlags & 0xfffU | 0x2000;
                  ChangeMainObjSel(2,lpfl->id);
                  uVar12 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                  pPVar8 = (PLORD *)sel.fl.lpplord;
                  if ((pPVar8 + 2)->wFlags == idPlanDst) {
                    pPVar8 = pPVar8 + 1;
                    pOVar11 = &ord_2;
                    for (iVar6 = 9; iVar6 != 0; iVar6 = iVar6 + -1) {
                      pPVar2 = pPVar8;
                      pPVar8 = (PLORD *)&pPVar8->iordMax;
                      pOVar1 = pOVar11;
                      pOVar11 = (ORDER *)&(pOVar11->pt).y;
                      pPVar2->wFlags = (pOVar1->pt).x;
                    }
                  }
                  else {
                    pbVar10 = &pPVar8[5].iordMax;
                    pOVar11 = &ord_2;
                    for (iVar6 = 9; iVar6 != 0; iVar6 = iVar6 + -1) {
                      pbVar3 = pbVar10;
                      pbVar10 = pbVar10 + 2;
                      pOVar1 = pOVar11;
                      pOVar11 = (ORDER *)&(pOVar11->pt).y;
                      *(short *)pbVar3 = (pOVar1->pt).x;
                    }
                  }
                  FLookupFleet(-1,(FLEET *)&sel.fl);
                  ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] =
                       ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] | 0x80;
                  goto LAB_1098_22f9;
                }
              }
AI2_LBlowAwayOrders:
              ChangeMainObjSel(2,lpfl->id);
              sel.fl.cord = 1;
              ((PLORD *)sel.fl.lpplord)->iordMac = 1;
              FLookupFleet(-1,(FLEET *)&sel.fl);
              ClearAiCurrentTask(lpfl,0);
            }
          }
        }
      }
      else {
        if (((FLEET *)lpfl)->idPlanet == -1) {
          if (((FLEET *)lpfl)->cord < 2) goto LAB_1098_22f9;
          idPlanDst = *(short *)&((PLORD *)((FLEET *)lpfl)->lpplord)[6].iordMax;
        }
        else {
          pPVar15 = LpplFromId(((FLEET *)lpfl)->idPlanet);
          if (((PLANET *)pPVar15)->iPlayer != -1) goto AI2_LBlowAwayOrders;
          idPlanDst = ((FLEET *)lpfl)->idPlanet;
        }
        ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 1] =
             ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 1] | 0x80;
      }
    }
    else {
      *(FLEET **)&pFVar9->lpflNext = (FLEET *)lpflEnemy;
      *(int *)((int)&pFVar9->lpflNext + 2) = lpflEnemy._2_2_;
      lpflEnemy._0_2_ = pFVar9;
      lpflEnemy._2_2_ = iVar6;
    }
LAB_1098_22f9:
  }
  fMarkedPlanets = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar9 = ((FLEET **)rglpfl)[ifl];
    iVar6 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar6,pFVar9);
    if ((pFVar9 == (FLEET *)0x0) && (iVar6 == 0)) break;
    if (pFVar9->iPlayer == idPlayer) {
      if ((pFVar9->rgcsh[7] == 0) && (pFVar9->rgcsh[8] == 0)) {
        if (pFVar9->cord < 2) {
          if (pFVar9->rgcsh[1] == 0) {
            sVar5 = FIsAiTransport((FLEET *)CONCAT22(iVar6,pFVar9));
            if (sVar5 == 0) {
              uVar12 = (undefined2)((ulong)lpfl >> 0x10);
              pFVar9 = (FLEET *)lpfl;
              if ((pFVar9->rgcsh[0xd] == 0) && (pFVar9->rgcsh[0xe] == 0)) {
                if (pFVar9->rgcsh[0] != 0) {
                  ChangeMainObjSel(2,lpfl->id);
                  uVar12 = (undefined2)((ulong)lpfl >> 0x10);
                  pFVar9 = (FLEET *)lpfl;
                  if ((((pFVar9->rgcsh[0] != 0) &&
                       ((rgshdef[0].hul.rghs[0].wFlags & 0xffU) == 1)) &&
                      (iVar6 = *(int *)((int)pFVar9->rgwtMin + 0x12), iVar6 < 1)) &&
                     ((iVar6 < 0 || (*(uint *)(pFVar9->rgwtMin + 4) < 2)))) goto AI2_LScrapFleet;
                  IdTargetScout(lpfl,(FLEET *)CONCAT22(lpflAttack._2_2_,(FLEET *)lpflAttack),
                                     (FLEET *)CONCAT22(lpflEnemy._2_2_,(FLEET *)lpflEnemy),
                                     (uint)game.wCrap >> 4 & 1,&lpthWorm);
                }
              }
              else {
                ChangeMainObjSel(2,lpfl->id);
                uVar12 = (undefined2)((ulong)lpfl >> 0x10);
                if (((FLEET *)lpfl)->idPlanet == -1) {
                  lppl = (PLANET *)CONCAT22(lpplHome._2_2_,(PLANET *)lpplHome);
                }
                else {
                  lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
                  uVar12 = (undefined2)((ulong)lppl >> 0x10);
                  pPVar7 = (PLANET *)lppl;
                  if (pPVar7->iPlayer == idPlayer) {
                    if (((uint)pPVar7->wFlags >> 9 & 1) != 0) {
                      uVar12 = (undefined2)((ulong)lpfl >> 0x10);
                      if ((((FLEET *)lpfl)->rgcsh[0xd] < 2) && (((FLEET *)lpfl)->rgcsh[0xe] < 2))
                      goto LAB_1098_279b;
                    }
                    FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
                  }
                  else if (pPVar7->iPlayer != -1) {
                    lpflT = (FLEET *)CONCAT22(lpflEnemy._2_2_,(FLEET *)lpflEnemy);
                    do {
                      if (((FLEET *)lpflT == (FLEET *)0x0) && (lpflT._2_2_ == 0))
                      goto LAB_1098_279b;
                      uVar12 = (undefined2)((ulong)lpfl >> 0x10);
                      if (((&((FLEET *)lpfl)->pt)->x == (&((FLEET *)lpflT)->pt)->x) &&
                         ((((FLEET *)lpfl)->pt).y == (((FLEET *)lpflT)->pt).y)) {
                        sVar5 = FIsAiAttack(lpflT);
                        if (sVar5 != 0) break;
                      }
                      uVar12 = (undefined2)((ulong)lpflT >> 0x10);
                    /* WARNING: Load size is inaccurate */
                      lpflT = (FLEET *)CONCAT22(*(undefined2 *)
                                                 ((int)&((FLEET *)lpflT)->lpflNext + 2),
                                                ((FLEET *)lpflT)->lpflNext);
                    } while( true );
                  }
                }
                if (((uint)game.wCrap >> 4 & 1) == 0) {
                  pPVar15 = (PLANET *)0x0;
                }
                else {
                  pPVar15 = LpplFindBestEnum(lppl,FEnumCalcArmadaHumanDest);
                }
                if (pPVar15 == (PLANET *)0x0) {
                  lpplDest = pPVar15;
                  pPVar15 = LpplFindBestEnum(lppl,FEnumCalcArmadaDest);
                }
                lppl = pPVar15;
                lpplDest._2_2_ = (int)((ulong)lppl >> 0x10);
                lpplDest = lppl;
                if (((PLANET *)lppl != (PLANET *)0x0) || (bVar13 = lpplDest._2_2_ != 0, bVar13)) {
                  ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] =
                       ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] | 0x80;
                  ord.id = lppl->id;
                  ord.pt.x = ((POINT *)rgptPlan + lppl->id)->x;
                  ord.pt.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
                  ord.wFlags = ord.wFlags & 0xe000U | 0x1140;
                  FMoveAiFleet(lpfl,&ord,0);
                }
              }
            }
            else {
              lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
              ord_2.txp.rgia[3].wFlags = (short)(PLANET *)lpPlanets;
              ord_2.txp.rgia[4].wFlags = lpPlanets._2_2_;
              lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
              lpplMac._2_2_ = lpPlanets._2_2_;
              while( true ) {
                if (((PLANET *)lpplMac <= (PLANET *)lppl) ||
                   ((((PLANET *)lppl)->iPlayer == idPlayer &&
                    (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)))) break;
                lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
              }
              lpplHome._0_2_ = (PLANET *)lppl;
              lpplHome._2_2_ = lppl._2_2_;
              if (((PLANET *)lppl == (PLANET *)lpplMac) && (lppl._2_2_ == lpPlanets._2_2_)) {
                lpplHome._0_2_ = (PLANET *)0x0;
                lpplHome._2_2_ = 0;
              }
              if (((PLANET *)lpplHome == (PLANET *)0x0) && (lpplHome._2_2_ == 0)) break;
              lppl = (PLANET *)0x0;
              i = 0;
              while( true ) {
                uVar12 = (undefined2)((ulong)vlpbAiData >> 0x10);
                pbVar10 = (byte *)vlpbAiData;
                if (*(int *)(pbVar10 + 2) <= i) break;
                j = 0;
                while ((j < *(int *)(pbVar10 + i * 0x14 + 6) &&
                       (ord_2.txp.rgia[4].wFlags = lpfl->id,
                       *(int *)(pbVar10 + j * 2 + i * 0x14 + 8) != ord_2.txp.rgia[4].wFlags))) {
                  j = j + 1;
                }
                if (j < *(int *)(pbVar10 + i * 0x14 + 6)) break;
                i = i + 1;
              }
              if (i < *(int *)(pbVar10 + 2)) {
                lppl = LpplFromId(*(short *)(pbVar10 + i * 0x14 + 4));
              }
              if (((PLANET *)lppl != (PLANET *)0x0) ||
                 (pPVar7 = (PLANET *)lpplHome, iVar6 = lpplHome._2_2_, lppl._2_2_ != 0)) {
                pPVar7 = (PLANET *)lppl;
                iVar6 = lppl._2_2_;
              }
              IdTargetFreighter(lpfl,(PLANET *)CONCAT22(iVar6,pPVar7));
            }
          }
          else {
            ChangeMainObjSel(2,lpfl->id);
            uVar12 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar9 = (FLEET *)lpfl;
            if (((((pFVar9->idPlanet == -1) || (sel.pl.iPlayer != idPlayer)) ||
                 ((sel.pl.rgwtMin[3]._2_2_ < 1 &&
                  ((sel.pl.rgwtMin[3]._2_2_ < 0 ||
                   ((uint)sel.pl.rgwtMin[3] < 0x32)))))) && ((int)pFVar9->rgwtMin[3] == 0)
                ) && (*(int *)((int)pFVar9->rgwtMin + 0xe) == 0)) {
              if (((sel.fl.idPlanet == -1) ||
                  (sel.pl.iPlayer != idPlayer)) ||
                 (((uint)sel.pl.wFlags >> 9 & 1) == 0)) {
                if (1 < (rgshdef[1].hul.rghs[0].wFlags & 0xffU)) {
                  sVar5 = FMoveToNearestStarbase(lpfl,0);
                  if (sVar5 != 0) goto LAB_1098_279b;
                }
AI2_LScrapFleet:
                ChangeMainObjSel(2,lpfl->id);
                uVar12 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                     *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
                FLookupFleet(-1,(FLEET *)&sel.fl);
              }
            }
            else {
              lpthWorm._0_2_ = (THING *)0x0;
              lpthWorm._2_2_ = 0;
              if ((rgshdef[1].hul.rghs[0].wFlags & 0xffU) < 2) {
                plpthWorm = (THING **)0x0;
              }
              else {
                plpthWorm = &lpthWorm;
              }
              idPlanDst = IdNearestColonizablePlanet(lpfl,plpthWorm);
              if ((((FLEET *)lpfl)->idPlanet != -1) && (sel.pl.iPlayer == idPlayer)
                 ) {
                ChangeMainObjSel(2,lpfl->id);
                XferAiSupply(1,((FLEET *)lpfl)->idPlanet,2,lpfl->id,3,0x19);
                FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
              }
              if (idPlanDst == -1) {
                if (((THING *)lpthWorm != (THING *)0x0) || (lpthWorm._2_2_ != 0)) {
                  FGotoWormholeAiFleet
                            (lpfl,(THING *)CONCAT22(lpthWorm._2_2_,(THING *)lpthWorm));
                }
              }
              else {
                FColonizeAiFleet(lpfl,idPlanDst);
                ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 0xf] = 4;
              }
            }
          }
        }
      }
      else if (pFVar9->idPlanet != -1) {
        ChangeMainObjSel(2,lpfl->id);
        b = ((byte *)vlpbAiPlanet)[((FLEET *)lpfl)->idPlanet * 0x10 + 1];
        if (b < 4) {
          lppl = LpplFindBestEnum(&sel.pl,FEnumCalcMinerDest);
          if (((PLANET *)lppl != (PLANET *)0x0) || ((int)((ulong)lppl >> 0x10) != 0)) {
            ord.id = lppl->id;
            ord.pt.x = ((POINT *)rgptPlan + lppl->id)->x;
            ord.pt.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
            ord.wFlags = ord.wFlags & 0xe000U | 0x1163;
            FMoveAiFleet(lpfl,&ord,1);
            ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] =
                 ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] | 0x80;
            ((byte *)vlpbAiPlanet)[((FLEET *)lpfl)->idPlanet * 0x10 + 1] =
                 ((byte *)vlpbAiPlanet)[((FLEET *)lpfl)->idPlanet * 0x10 + 1] & 0x80;
          }
        }
      }
    }
LAB_1098_279b:
  }
  HandleBasicAiTasks(iroCur,rgprod,ishdefSBLatest,rgResAvail,rgResCost);
  FillProductionQueue();
  return;
}



// ======================================================================
// Function: EnsureCAShdefs
// Address: 1098:3020
// Segment: MEMORY_AI2
// ======================================================================


void EnsureCAShdefs(short iroCur)

{
  return;
}



