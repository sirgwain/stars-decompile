// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: DoMaidAiTurn
// Address: 1098:0000
// Segment: MEMORY_AI2
// ======================================================================


void DoMaidAiTurn(PROD *rgprod)

{
  short sVar1;
  short iroCur;
  long rgResAvail [4];
  long rgResCost [4];
  
                    /* Segment:    20
                       Offset:     00091800
                       Length:     302f
                       Min Alloc:  302f
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  if (game.turn < 0x14) {
    sVar1 = 0;
  }
  else {
    sVar1 = 0xf;
  }
  sVar1 = IroEnsureAi((byte *)0x0,0,(short *)0x0,sVar1);
  fMarkedPlanets = 0;
  HandleBasicAiTasks(sVar1,rgprod,-1,rgResAvail,rgResCost);
  FillProductionQueue();
  return;
}



// ======================================================================
// Function: FPotentISWarFleet
// Address: 1098:012e
// Segment: MEMORY_AI2
// ======================================================================


short FPotentISWarFleet(FLEET *lpfl,short iPotency)

{
  uint uVar1;
  short cEquiv;
  short ish;
  
  cEquiv = 0;
  ish = 0xb;
  while( true ) {
    if (0xc < ish) break;
    cEquiv = cEquiv + ((FLEET *)lpfl)->rgcsh[ish];
    ish = ish + 1;
  }
  for (ish = 9; ish < 0xb; ish = ish + 1) {
    cEquiv = cEquiv + ((FLEET *)lpfl)->rgcsh[ish] * 2;
  }
  if (iPotency < 2) {
    uVar1 = 1;
  }
  else {
    uVar1 = (uint)((int)(uint)vrgAiArmadaPotency[0] <= cEquiv);
  }
  return uVar1;
}



// ======================================================================
// Function: DoAutomitronAiTurn
// Address: 1098:01e0
// Segment: MEMORY_AI2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1098068c) */
/* WARNING: Removing unreachable block (ram,0x109806ad) */
/* WARNING: Removing unreachable block (ram,0x10980a63) */
/* WARNING: Removing unreachable block (ram,0x109806b2) */
/* WARNING: Removing unreachable block (ram,0x10980be1) */

void DoAutomitronAiTurn(PROD *rgprod)

{
  uint *puVar1;
  byte *pbVar2;
  uint uVar3;
  ushort *puVar4;
  undefined2 *puVar5;
  PLORD *pPVar6;
  int iVar7;
  uint uVar8;
  uint uVar9;
  short sVar10;
  int iVar11;
  PLANET *pPVar12;
  PLORD *pPVar13;
  FLEET *pFVar14;
  byte *pbVar15;
  undefined2 unaff_SI;
  ushort *puVar16;
  undefined2 *puVar17;
  undefined2 unaff_DI;
  undefined2 uVar18;
  bool bVar19;
  ulong uVar20;
  PLANET *pPVar21;
  ushort in_stack_0000ff4c;
  short id;
  short iPlanet;
  short fWrite;
  PROD *lpprod;
  short iLatestBattle;
  short j;
  short iLatestBomber;
  short iLatestCargo;
  ushort cplanCol;
  ushort cRecyclePeriod;
  short ishdefSBLatest;
  byte b;
  FLEET *lpflAttack;
  undefined2 local_84;
  FLEET *lpflT;
  short iroCur;
  short cRes;
  short i;
  short ifl;
  FLEET *lpfl;
  PLANET *lpplHome;
  int local_70;
  PLANET *lppl;
  PLANET *lpplMac;
  int local_68;
  short cplBadGuy;
  short idPlanDst;
  short cFr;
  THING *lpthWorm;
  undefined2 local_5e;
  short cplNegative;
  undefined4 lpplDest;
  byte rgRecycleShdef [16];
  ORDER ord__70;
  FLEET *lpflEnemy;
  int local_32;
  uint rgResAvail [8];
  short iLatestCruiser;
  uint rgResCost [8];
  ushort rgCosts [4];
  short cExistCargo;
  
  cplBadGuy = 0;
  cplNegative = 0;
  cplanCol = 0;
  if (game.turn < 10) {
    sVar10 = 0;
  }
  else {
    sVar10 = 0x14;
  }
  iroCur = IroEnsureAi(vrgAiISResOrder,0x12,&ishdefSBLatest,sVar10);
  if (game.turn < 0x33) {
    if (0x1e < game.turn) {
      MergeAllShdefs(0x4000);
    }
  }
  else {
    MergeAllShdefs(0x1e0c);
    MergeAllShdefs(0x40);
    MergeAllShdefs(0x4000);
  }
  j = 3;
  if (0x82 < game.turn) {
    j = (game.turn - 0x78) / 0x14 + 3;
  }
  if (0x32 < (uint)j) {
    j = 0x32;
  }
  vrgAiArmadaPotency[0] = (byte)j;
  vrgAiArmadaPotency[1] = (byte)((ulong)(j & 0xff) / 2);
  j = 6;
  if (0x73 < game.turn) {
    j = (game.turn - 100) / 0x16 + 6;
  }
  if (0xc < (uint)j) {
    j = 0xc;
  }
  vrgAiArmadaPotency[2] = (byte)j;
  if ((int)((uint)j / 2 - 1) < 4) {
    vrgAiArmadaPotency[3] = (char)((uint)j / 2) - 1;
  }
  else {
    vrgAiArmadaPotency[3] = 3;
  }
  _memset(rgRecycleShdef,0,0x10);
  if (game.turn < 0x78) {
    cRecyclePeriod = 0x32;
  }
  else if (game.turn < 200) {
    cRecyclePeriod = 0x46;
  }
  else {
    cRecyclePeriod = 100;
  }
  CheckAiShdefStatus(0xb,0xc,cRecyclePeriod,&iLatestCruiser,rgRecycleShdef);
  cExistCargo = CheckAiShdefStatus(4,5,cRecyclePeriod,&iLatestCargo,rgRecycleShdef);
  CheckAiShdefStatus(2,3,cRecyclePeriod,&iLatestBomber,rgRecycleShdef);
  CheckAiShdefStatus(9,10,cRecyclePeriod,&iLatestBattle,rgRecycleShdef);
  if (0x3c < game.turn) {
    SplitOutShdefs(rgRecycleShdef);
  }
  EnsureISShdefs(iroCur);
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_68 = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < lpplMac) {
    uVar18 = (undefined2)((ulong)lppl >> 0x10);
    if (((((PLANET *)lppl)->iPlayer == -1) && (2 < (((PLANET *)lppl)->wFlags_0x4 & 0xff))) &&
       (sVar10 = PctPlanetOptValue(lppl,idPlayer), 0 < sVar10)) {
      cplanCol = cplanCol + 1;
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_68 = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < lpplMac) {
    ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 9] = 1;
    uVar18 = (undefined2)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl)->iPlayer == idPlayer) || (((PLANET *)lppl)->iPlayer == -1)) {
      if ((((PLANET *)lppl)->iPlayer == idPlayer) &&
         (sVar10 = PctPlanetDesirability(lppl,idPlayer), sVar10 < 0)) {
        cplNegative = cplNegative + 1;
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] = 1;
      }
      else {
        uVar18 = (undefined2)((ulong)lppl >> 0x10);
        pPVar12 = (PLANET *)lppl;
        if (((pPVar12->wFlags_0x4 >> 9 & 1) != 0) &&
           ((iVar11 = *(int *)((int)pPVar12->rgwtMin + 0xe), 0 < iVar11 ||
            ((-1 < iVar11 && (0x5db < *(uint *)(pPVar12->rgwtMin + 3))))))) {
          ChangeMainObjSel(1,lppl->id);
          InitProduction(rgprod);
          fWrite = 0;
          b = 0;
          i = 0;
          while ((i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac &&
                 ((uVar20 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff4c),
                  ((uint)uVar20 & 7) != 2 ||
                  (uVar20 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff4c),
                  0xf < ((uint)uVar20 & 0x7f)))))) {
            i = i + 1;
          }
          if (i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
            FinishProduction(0);
          }
          else {
            uVar18 = (undefined2)((ulong)vlpbAiData >> 0x10);
            if (*(int *)((byte *)vlpbAiData + 2) * 2 <
                *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) / 10) {
              cFr = *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) / 10;
            }
            else {
              cFr = *(int *)((byte *)vlpbAiData + 2) << 1;
            }
            if ((('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))
                && (iLatestCargo != -1)) &&
               ((cExistCargo < cFr ||
                ((cExistCargo < (cFr * 10) / 7 && (sVar10 = Random(4), sVar10 == 0)))))) {
              AddItemToQueue(iLatestCargo,1,grobjFleet,1);
              fWrite = 1;
            }
            if ((((cplanCol != 0) && ((int)rgshdef[1].cExist == 0)) &&
                (rgshdef[1].cExist._2_2_ == 0)) && (10 < game.turn)) {
              AddItemToQueue(1,1,grobjFleet,1);
              fWrite = 1;
            }
            sVar10 = PctTrueMaxGrowth(idPlayer);
            uVar18 = (undefined2)((ulong)lppl >> 0x10);
            __aFulmul(CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                                       (int)((PLANET *)lppl)->rgwtMin[3]),(long)sVar10);
            cRes = CResourcesAtPlanet(lppl,idPlayer);
            if (((rgshdef[6].wFlags >> 9 & 1) == 0) &&
               (sVar10 = Random(3), sVar10 == 0)) {
              cFr = 0;
              for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
                pFVar14 = ((FLEET **)rglpfl)[ifl];
                iVar11 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                lpfl = (FLEET *)CONCAT22(iVar11,pFVar14);
                if ((pFVar14 == (FLEET *)0x0) && (iVar11 == 0)) break;
                if ((pFVar14->idPlanet == lppl->id) &&
                   ((0 < pFVar14->rgcsh[6] && (pFVar14->iPlayer == idPlayer)))) {
                  cFr = pFVar14->rgcsh[6];
                  break;
                }
              }
              if (((cFr < 10) || ((cFr < 0x11 && (sVar10 = Random(8), sVar10 == 0)))) &&
                 (sVar10 = Random(cFr * 2 + 1), sVar10 == 0)) {
                AddItemToQueue(6,3,grobjFleet,1);
                fWrite = 1;
              }
            }
            if (iLatestBomber != -1) {
              iVar11 = lppl->id;
              for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
                pFVar14 = ((FLEET **)rglpfl)[ifl];
                iVar7 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                lpfl = (FLEET *)CONCAT22(iVar7,pFVar14);
                if ((pFVar14 == (FLEET *)0x0) && (iVar7 == 0)) break;
                if ((pFVar14->idPlanet == iVar11) &&
                   ((pFVar14->iPlayer == idPlayer &&
                    (sVar10 = FPotentISWarFleet((FLEET *)CONCAT22(iVar7,pFVar14),2), sVar10 != 0))))
                {
                  if ((iLatestBomber != -1) &&
                     (uVar18 = (undefined2)((ulong)lpfl >> 0x10),
                     (int)(uint)vrgAiArmadaPotency[2] <=
                     ((FLEET *)lpfl)->rgcsh[2] + ((FLEET *)lpfl)->rgcsh[3])) {
                    AddItemToQueue(iLatestBomber,4,grobjFleet,1);
                    fWrite = 1;
                    goto AI2_FinishProd;
                  }
                  break;
                }
              }
            }
            if (iLatestCruiser != -1) {
              if ((*(int *)((int)&rgshdef[0].cExist + 2 + iLatestCruiser * 0x93) == 0) &&
                 (*(uint *)((int)&rgshdef[0].cExist + iLatestCruiser * 0x93) <
                  game.cPlanMax / 0xc + 8U)) {
                GetResourcesAvailable(lppl,(long *)rgResAvail);
                GetProdQCost(lppl,(long *)rgResCost);
                for (i = 0; i < 4; i = i + 1) {
                  uVar8 = rgResCost[i * 2];
                  uVar9 = rgResCost[i * 2 + 1];
                  puVar1 = rgResAvail + i * 2;
                  uVar3 = *puVar1;
                  *puVar1 = *puVar1 - uVar8;
                  rgResAvail[i * 2 + 1] = (rgResAvail[i * 2 + 1] - uVar9) - (uint)(uVar3 < uVar8);
                  if (((int)rgResAvail[i * 2 + 1] < 1) && ((int)rgResAvail[i * 2 + 1] < 0))
                  goto AI2_FinishProd;
                }
                for (i = 0; i < 5; i = i + 1) {
                  GetTrueHullCost
                            (idPlayer,
                             (HUL *)CONCAT22(0x1120,(HUL *)(iLatestCruiser * 0x93 + 0x3f00)),rgCosts
                            );
                  for (j = 0; j < 4; j = j + 1) {
                    uVar8 = rgCosts[j];
                    puVar1 = rgResAvail + j * 2;
                    uVar3 = *puVar1;
                    *puVar1 = *puVar1 - uVar8;
                    rgResAvail[j * 2 + 1] = rgResAvail[j * 2 + 1] - (uint)(uVar3 < uVar8);
                    if (((int)rgResAvail[j * 2 + 1] < 1) && ((int)rgResAvail[j * 2 + 1] < 0))
                    goto AI2_FinishProd;
                  }
                  fWrite = 1;
                  AddItemToQueue(iLatestCruiser,1,grobjFleet,1);
                }
              }
            }
            if (iLatestBattle != -1) {
              if ((*(int *)((int)&rgshdef[0].cExist + 2 + iLatestBattle * 0x93) == 0) &&
                 (*(uint *)((int)&rgshdef[0].cExist + iLatestBattle * 0x93) <
                  game.cPlanMax / 0x18 + 4U)) {
                GetResourcesAvailable(lppl,(long *)rgResAvail);
                GetProdQCost(lppl,(long *)rgResCost);
                for (i = 0; i < 4; i = i + 1) {
                  uVar8 = rgResCost[i * 2];
                  uVar9 = rgResCost[i * 2 + 1];
                  puVar1 = rgResAvail + i * 2;
                  uVar3 = *puVar1;
                  *puVar1 = *puVar1 - uVar8;
                  rgResAvail[i * 2 + 1] = (rgResAvail[i * 2 + 1] - uVar9) - (uint)(uVar3 < uVar8);
                  if (((int)rgResAvail[i * 2 + 1] < 1) && ((int)rgResAvail[i * 2 + 1] < 0))
                  goto AI2_FinishProd;
                }
                for (i = 0; i < 5; i = i + 1) {
                  GetTrueHullCost
                            (idPlayer,
                             (HUL *)CONCAT22(0x1120,(HUL *)(iLatestBattle * 0x93 + 0x3f00)),rgCosts)
                  ;
                  for (j = 0; j < 4; j = j + 1) {
                    uVar8 = rgCosts[j];
                    puVar1 = rgResAvail + j * 2;
                    uVar3 = *puVar1;
                    *puVar1 = *puVar1 - uVar8;
                    rgResAvail[j * 2 + 1] = rgResAvail[j * 2 + 1] - (uint)(uVar3 < uVar8);
                    if (((int)rgResAvail[j * 2 + 1] < 1) && ((int)rgResAvail[j * 2 + 1] < 0))
                    goto AI2_FinishProd;
                  }
                  fWrite = 1;
                  AddItemToQueue(iLatestBattle,1,grobjFleet,1);
                }
              }
            }
AI2_FinishProd:
            FinishProduction(fWrite);
          }
        }
      }
    }
    else {
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] =
           ((byte)(((PLANET *)lppl)->wFlags_0x4 >> 9) & 1) + 1;
      sVar10 = PctPlanetOptValue(lppl,idPlayer);
      if (0 < sVar10) {
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 3] = 1;
      }
      cplBadGuy = cplBadGuy + 1;
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  lpflAttack = (FLEET *)0x0;
  local_84 = 0;
  lpflEnemy = (FLEET *)0x0;
  local_32 = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar14 = ((FLEET **)rglpfl)[ifl];
    iVar11 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar11,pFVar14);
    if ((pFVar14 == (FLEET *)0x0) && (iVar11 == 0)) break;
    if (pFVar14->iPlayer == idPlayer) {
      sVar10 = FIsAiAttack((FLEET *)CONCAT22(iVar11,pFVar14));
      if (sVar10 != 0) {
        *(FLEET **)&((FLEET *)lpfl)->lpflNext = lpflAttack;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpflNext + 2) = local_84;
        lpflAttack = (FLEET *)lpfl;
        local_84 = lpfl._2_2_;
      }
      ((FLEET *)lpfl)->wFlags_0x4 = ((FLEET *)lpfl)->wFlags_0x4 & 0x7fff;
      sVar10 = FIsAiTransport(lpfl);
      pFVar14 = (FLEET *)lpfl;
      uVar18 = (undefined2)((ulong)lpfl >> 0x10);
      if (sVar10 == 0) {
        if (pFVar14->rgcsh[1] != 0) {
          idPlanDst = -1;
          if (pFVar14->cord < 2) {
            idPlanDst = pFVar14->idPlanet;
          }
          else if ((((PLORD *)pFVar14->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
            idPlanDst = *(short *)&((PLORD *)pFVar14->lpplord)[6].iordMax;
          }
          if (idPlanDst != -1) {
            if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0)
            goto AI2_LCheckForColDrop_2;
            lppl = LpplFromId(idPlanDst);
            iVar11 = (int)((ulong)lppl >> 0x10);
            pPVar12 = (PLANET *)lppl;
            if (((pPVar12 != (PLANET *)0x0) || (iVar11 != 0)) &&
               ((pPVar12->iPlayer != -1 && (pPVar12->iPlayer != idPlayer))))
            goto AI2_LBlowAwayOrders_2;
          }
        }
      }
      else {
        idPlanDst = -1;
        if (pFVar14->cord < 2) {
          idPlanDst = pFVar14->idPlanet;
        }
        else if ((((PLORD *)pFVar14->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
          idPlanDst = *(short *)&((PLORD *)pFVar14->lpplord)[6].iordMax;
        }
AI2_LCheckForColDrop_2:
        if (idPlanDst != -1) {
          lppl = LpplFromId(idPlanDst);
          iVar11 = (int)((ulong)lppl >> 0x10);
          pPVar12 = (PLANET *)lppl;
          if (((pPVar12 == (PLANET *)0x0) && (iVar11 == 0)) ||
             ((pPVar12->iPlayer != -1 && (pPVar12->iPlayer != idPlayer)))) {
            if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0) {
              uVar18 = (undefined2)((ulong)lpfl >> 0x10);
              iVar7 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0xe);
              if ((-1 < iVar7) &&
                 (((0 < iVar7 || ((int)((FLEET *)lpfl)->rgwtMin[3] != 0)) &&
                  (sVar10 = GetRaceStat((PLAYER *)rgplr + pPVar12->iPlayer,
                                              rsMajorAdv), sVar10 != raMacintosh)))) {
                _memset(&stack0xff4c,0,0x12);
                ChangeMainObjSel(2,lpfl->id);
                uVar18 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                pPVar13 = (PLORD *)sel.fl.lpplord;
                if ((pPVar13 + 2)->wFlags == idPlanDst) {
                  pPVar13 = pPVar13 + 1;
                  puVar16 = (ushort *)&stack0xff4c;
                  for (iVar11 = 9; iVar11 != 0; iVar11 = iVar11 + -1) {
                    pPVar6 = pPVar13;
                    pPVar13 = (PLORD *)&pPVar13->iordMax;
                    puVar4 = puVar16;
                    puVar16 = puVar16 + 1;
                    pPVar6->wFlags = *puVar4;
                  }
                }
                else {
                  pbVar15 = &pPVar13[5].iordMax;
                  puVar17 = (undefined2 *)&stack0xff4c;
                  for (iVar11 = 9; iVar11 != 0; iVar11 = iVar11 + -1) {
                    pbVar2 = pbVar15;
                    pbVar15 = pbVar15 + 2;
                    puVar5 = puVar17;
                    puVar17 = puVar17 + 1;
                    *(undefined2 *)pbVar2 = *puVar5;
                  }
                }
                FLookupFleet(-1,(FLEET *)&sel.fl);
                ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] =
                     ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] | 0x80;
                goto LAB_1098_0d5d;
              }
            }
AI2_LBlowAwayOrders_2:
            ChangeMainObjSel(2,lpfl->id);
            sel.fl.cord = 1;
            ((PLORD *)sel.fl.lpplord)->iordMac = 1;
            FLookupFleet(-1,(FLEET *)&sel.fl);
            ClearAiCurrentTask(lpfl,0);
          }
        }
      }
    }
    else {
      *(FLEET **)&pFVar14->lpflNext = lpflEnemy;
      *(int *)((int)&pFVar14->lpflNext + 2) = local_32;
      lpflEnemy = pFVar14;
      local_32 = iVar11;
    }
LAB_1098_0d5d:
  }
  fMarkedPlanets = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar14 = ((FLEET **)rglpfl)[ifl];
    iVar11 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar11,pFVar14);
    if ((pFVar14 == (FLEET *)0x0) && (iVar11 == 0)) break;
    if (pFVar14->iPlayer == idPlayer) {
      if (pFVar14->cord < 2) {
        if (pFVar14->rgcsh[6] == 0) {
          if (pFVar14->rgcsh[1] == 0) {
            sVar10 = FIsAiTransport((FLEET *)CONCAT22(iVar11,pFVar14));
            if (sVar10 == 0) {
              uVar18 = (undefined2)((ulong)lpfl >> 0x10);
              pFVar14 = (FLEET *)lpfl;
              if ((pFVar14->rgcsh[2] == 0) && (pFVar14->rgcsh[3] == 0)) {
                if (pFVar14->rgcsh[0] != 0) {
                  ChangeMainObjSel(2,lpfl->id);
                  if ((((rgshdef[0].hul.rghs[0].wFlags_0x2 & 0xff) < 10) &&
                      (iVar11 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0x12), iVar11 < 1)) &&
                     ((iVar11 < 0 || (*(uint *)(((FLEET *)lpfl)->rgwtMin + 4) < 2))))
                  goto AI2_LScrapFleet_2;
                  IdTargetScout(lpfl,(FLEET *)CONCAT22(local_84,lpflAttack),
                                     (FLEET *)CONCAT22(local_32,lpflEnemy),
                                     game.wCrap >> 4 & 1,&lpthWorm);
                }
              }
              else {
                ChangeMainObjSel(2,lpfl->id);
                uVar18 = (undefined2)((ulong)lpfl >> 0x10);
                if (((FLEET *)lpfl)->idPlanet == -1) {
                  lppl = (PLANET *)CONCAT22(local_70,lpplHome);
                }
                else {
                  lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
                  uVar18 = (undefined2)((ulong)lppl >> 0x10);
                  pPVar12 = (PLANET *)lppl;
                  if (pPVar12->iPlayer == idPlayer) {
                    if ((pPVar12->wFlags_0x4 >> 9 & 1) != 0) {
                      uVar18 = (undefined2)((ulong)lpfl >> 0x10);
                      pFVar14 = (FLEET *)lpfl;
                      if (((pFVar14->rgcsh[2] < 2) && (pFVar14->rgcsh[3] < 2)) ||
                         ((pFVar14->rgcsh[9] < 3 && (pFVar14->rgcsh[10] < 3)))) goto LAB_1098_1162;
                    }
                    FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
                  }
                  else if (pPVar12->iPlayer != -1) {
                    lpflT = (FLEET *)CONCAT22(local_32,lpflEnemy);
                    do {
                      if (((FLEET *)lpflT == (FLEET *)0x0) && (lpflT._2_2_ == 0))
                      goto LAB_1098_1162;
                      uVar18 = (undefined2)((ulong)lpfl >> 0x10);
                      if (((&((FLEET *)lpfl)->pt)->x == (&((FLEET *)lpflT)->pt)->x) &&
                         ((((FLEET *)lpfl)->pt).y == (((FLEET *)lpflT)->pt).y)) {
                        sVar10 = FIsAiAttack(lpflT);
                        if (sVar10 != 0) break;
                      }
                      uVar18 = (undefined2)((ulong)lpflT >> 0x10);
                    /* WARNING: Load size is inaccurate */
                      lpflT = (FLEET *)CONCAT22(*(undefined2 *)
                                                 ((int)&((FLEET *)lpflT)->lpflNext + 2),
                                                ((FLEET *)lpflT)->lpflNext);
                    } while( true );
                  }
                }
                if ((game.wCrap >> 4 & 1) == 0) {
                  pPVar21 = (PLANET *)0x0;
                }
                else {
                  pPVar21 = LpplFindBestEnum(lppl,FEnumCalcArmadaHumanDest);
                }
                if (pPVar21 == (PLANET *)0x0) {
                  lpplDest = pPVar21;
                  pPVar21 = LpplFindBestEnum(lppl,FEnumCalcArmadaDest);
                }
                lppl = pPVar21;
                lpplDest._2_2_ = (int)((ulong)lppl >> 0x10);
                lpplDest = lppl;
                if (((PLANET *)lppl != (PLANET *)0x0) || (bVar19 = lpplDest._2_2_ != 0, bVar19)) {
                  ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] =
                       ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] | 0x80;
                  ord__70.id = lppl->id;
                  ord__70.pt.x = ((POINT *)rgptPlan + lppl->id)->x;
                  ord__70.pt.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
                  ord__70.wFlags_0x6 = ord__70.wFlags_0x6 & 0xe000 | 0x1140;
                  FMoveAiFleet(lpfl,&ord__70,0);
                }
              }
            }
            else {
              lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
              lpplMac = (PLANET *)lpPlanets + cPlanet;
              local_68 = lpPlanets._2_2_;
              while( true ) {
                if ((lpplMac <= (PLANET *)lppl) ||
                   ((((PLANET *)lppl)->iPlayer == idPlayer &&
                    ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0)))) break;
                lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
              }
              lpplHome = (PLANET *)lppl;
              local_70 = lppl._2_2_;
              if (((PLANET *)lppl == lpplMac) && (lppl._2_2_ == lpPlanets._2_2_)) {
                lpplHome = (PLANET *)0x0;
                local_70 = 0;
              }
              if ((lpplHome == (PLANET *)0x0) && (local_70 == 0)) break;
              lppl = (PLANET *)0x0;
              i = 0;
              while( true ) {
                uVar18 = (undefined2)((ulong)vlpbAiData >> 0x10);
                pbVar15 = (byte *)vlpbAiData;
                if (*(int *)(pbVar15 + 2) <= i) break;
                j = 0;
                while ((j < *(int *)(pbVar15 + i * 0x14 + 6) &&
                       (*(int *)(pbVar15 + j * 2 + i * 0x14 + 8) != lpfl->id))) {
                  j = j + 1;
                }
                if (j < *(int *)(pbVar15 + i * 0x14 + 6)) break;
                i = i + 1;
              }
              if (i < *(int *)(pbVar15 + 2)) {
                lppl = LpplFromId(*(short *)(pbVar15 + i * 0x14 + 4));
              }
              if (((PLANET *)lppl != (PLANET *)0x0) ||
                 (pPVar12 = lpplHome, iVar11 = local_70, lppl._2_2_ != 0)) {
                pPVar12 = (PLANET *)lppl;
                iVar11 = lppl._2_2_;
              }
              IdTargetFreighter(lpfl,(PLANET *)CONCAT22(iVar11,pPVar12));
            }
          }
          else {
            if (rgshdef[1].hul.ihuldef != ihuldefMediumFreighter) goto AI2_LScrapFleet_2;
            ChangeMainObjSel(2,lpfl->id);
            uVar18 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar14 = (FLEET *)lpfl;
            if (((((pFVar14->idPlanet == -1) || (sel.pl.iPlayer != idPlayer)) ||
                 ((sel.pl.rgwtMin[3]._2_2_ < 1 &&
                  ((sel.pl.rgwtMin[3]._2_2_ < 0 ||
                   ((uint)sel.pl.rgwtMin[3] < 200)))))) && ((int)pFVar14->rgwtMin[3] == 0)
                ) && (*(int *)((int)pFVar14->rgwtMin + 0xe) == 0)) {
              if (((sel.fl.idPlanet == -1) ||
                  (sel.pl.iPlayer != idPlayer)) ||
                 ((sel.pl.wFlags_0x4 >> 9 & 1) == 0)) {
                if (1 < (rgshdef[1].hul.rghs[0].wFlags_0x2 & 0xff)) {
                  sVar10 = FMoveToNearestStarbase(lpfl,0);
                  if (sVar10 != 0) goto LAB_1098_1162;
                }
AI2_LScrapFleet_2:
                ChangeMainObjSel(2,lpfl->id);
                uVar18 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                     *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
                FLookupFleet(-1,(FLEET *)&sel.fl);
              }
            }
            else {
              lpthWorm = (THING *)0x0;
              local_5e = 0;
              idPlanDst = IdNearestColonizablePlanet(lpfl,(THING **)0x0);
              if ((((FLEET *)lpfl)->idPlanet != -1) && (sel.pl.iPlayer == idPlayer)
                 ) {
                ChangeMainObjSel(2,lpfl->id);
                XferAiSupply(1,((FLEET *)lpfl)->idPlanet,2,lpfl->id,3,0x96);
                FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
              }
              if (idPlanDst != -1) {
                FColonizeAiFleet(lpfl,idPlanDst);
                ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 0xf] = 4;
              }
            }
          }
        }
        else if ((pFVar14->cord == 1) &&
                ((*(uint *)&((PLORD *)pFVar14->lpplord)[2].iordMax & 0xf) == 0)) {
          ChangeMainObjSel(2,lpfl->id);
          uVar18 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
          *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
               *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 6;
          ((PLORD *)sel.fl.lpplord + 3)->wFlags = 5;
          pbVar2 = &((PLORD *)sel.fl.lpplord)[3].iordMax;
          pbVar2[0] = 5;
          pbVar2[1] = 0;
          FLookupFleet(-1,(FLEET *)&sel.fl);
        }
      }
      else if ((((rgshdef[0].hul.rghs[0].wFlags_0x2 & 0xff) < 10) &&
               (iVar7 = *(int *)((int)pFVar14->rgwtMin + 0x12), iVar7 < 1)) &&
              ((iVar7 < 0 || (*(uint *)(pFVar14->rgwtMin + 4) < 2)))) goto AI2_LScrapFleet_2;
    }
LAB_1098_1162:
  }
  HandleBasicAiTasks(iroCur,rgprod,ishdefSBLatest,(long *)rgResAvail,(long *)rgResCost);
  FillProductionQueue();
  return;
}



// ======================================================================
// Function: EnsureISShdefs
// Address: 1098:1938
// Segment: MEMORY_AI2
// ======================================================================


void EnsureISShdefs(short iroCur)

{
  SHDEF *pSVar1;
  SHDEF *pSVar2;
  short sVar3;
  int iVar4;
  SHDEF *pSVar5;
  SHDEF *pSVar6;
  undefined2 unaff_SS;
  short i;
  SHDEF shdef;
  
  if (((rgshdef[4].wFlags >> 9 & 1) != 0) &&
     ('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) {
    FCreateAiShdef(4,1,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0xe] + 0x78)));
  }
  if (((rgshdef[5].wFlags >> 9 & 1) != 0) &&
     ('\x06' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) {
    FCreateAiShdef(5,3,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0x12] + 0x78)));
  }
  if (((((rgshdef[0xe].wFlags >> 9 & 1) != 0) &&
       ('\x04' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
      ('\x05' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0))) &&
     (('\x03' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))) {
    for (i = 0; i < 4; i = i + 1) {
      sVar3 = Random(1);
      sVar3 = FCreateAiShdef(0xe,6,(byte *)CONCAT22(0x1098,(byte *)(*(byte *)(sVar3 + 0x68) +
                                                                        0x78)));
      if (sVar3 != 0) break;
    }
  }
  if (((rgshdef[1].wFlags >> 9 & 1) != 0) ||
     (((int)rgshdef[1].cExist == 0 && (rgshdef[1].cExist._2_2_ == 0)))) {
    if ((rgshdef[1].wFlags >> 9 & 1) == 0) {
      pSVar5 = (SHDEF *)(rgshdef + 1);
      pSVar6 = &shdef;
      for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
        pSVar2 = pSVar6;
        pSVar6 = (SHDEF *)(pSVar6->hul).rgTech;
        pSVar1 = pSVar5;
        pSVar5 = (SHDEF *)(pSVar5->hul).rgTech;
        (pSVar2->hul).ihuldef = (pSVar1->hul).ihuldef;
      }
      *(char *)&(pSVar6->hul).ihuldef = (char)(pSVar5->hul).ihuldef;
      shdef.wFlags = shdef.wFlags & 0xfdff | 0x200;
      FChangeAiShdef(&shdef,1);
    }
    FCreateAiShdef(1,1,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0] + 0x78)));
  }
  if (((rgshdef[0].wFlags >> 9 & 1) != 0) ||
     (((int)rgshdef[0].cExist == 0 && (rgshdef[0].cExist._2_2_ == 0)))) {
    if ((rgshdef[0].wFlags >> 9 & 1) == 0) {
      pSVar5 = (SHDEF *)rgshdef;
      pSVar6 = &shdef;
      for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
        pSVar2 = pSVar6;
        pSVar6 = (SHDEF *)(pSVar6->hul).rgTech;
        pSVar1 = pSVar5;
        pSVar5 = (SHDEF *)(pSVar5->hul).rgTech;
        (pSVar2->hul).ihuldef = (pSVar1->hul).ihuldef;
      }
      *(char *)&(pSVar6->hul).ihuldef = (char)(pSVar5->hul).ihuldef;
      shdef.wFlags = shdef.wFlags & 0xfdff | 0x200;
      FChangeAiShdef(&shdef,0);
    }
    FCreateAiShdef(0,4,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[1] + 0x78)));
  }
  if (((((rgshdef[6].wFlags >> 9 & 1) != 0) &&
       ('\x03' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0))) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) &&
     ('\x05' < *(char *)((int)rgplr[0].rgTech + 5 + idPlayer * 0xc0))) {
    FCreateAiShdef(6,0xb,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0x11] + 0x78)));
  }
  if ((((rgshdef[2].wFlags >> 9 & 1) != 0) &&
      ('\a' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
     (('\x06' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) &&
      (('\x05' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
       ('\x06' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))))) {
    FCreateAiShdef(2,0x11,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0xf] + 0x78)));
  }
  if (((((rgshdef[3].wFlags >> 9 & 1) != 0) &&
       ('\n' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
      ('\v' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0))) &&
     (('\x0e' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
      ('\b' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))) {
    FCreateAiShdef(3,0x13,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0x10] + 0x78)));
  }
  if ((((rgshdef[9].wFlags >> 9 & 1) != 0) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
     (('\x05' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) &&
      (('\f' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
       ('\x06' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))))) {
    for (i = 0; i < 5; i = i + 1) {
      sVar3 = Random(4);
      sVar3 = FCreateAiShdef(9,9,(byte *)CONCAT22(0x1098,(byte *)(*(byte *)(sVar3 + 0x6e) +
                                                                      0x78)));
      if (sVar3 != 0) {
        return;
      }
    }
  }
  return;
}



// ======================================================================
// Function: DoRototillAiTurn
// Address: 1098:1e22
// Segment: MEMORY_AI2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109821c6) */
/* WARNING: Removing unreachable block (ram,0x109821e6) */
/* WARNING: Removing unreachable block (ram,0x109821eb) */
/* WARNING: Removing unreachable block (ram,0x10982294) */

void DoRototillAiTurn(PROD *rgprod)

{
  ushort *puVar1;
  undefined2 *puVar2;
  PLORD *pPVar3;
  byte *pbVar4;
  int iVar5;
  byte bVar6;
  short sVar7;
  THING **plpthWorm;
  int iVar8;
  PLANET *pPVar9;
  PLORD *pPVar10;
  FLEET *pFVar11;
  byte *pbVar12;
  undefined2 unaff_SI;
  ushort *puVar13;
  undefined2 *puVar14;
  undefined2 unaff_DI;
  undefined2 uVar15;
  bool bVar16;
  ulong uVar17;
  PLANET *pPVar18;
  ushort in_stack_0000ff74;
  short iPlanet;
  short fWrite;
  PROD *lpprod;
  short j;
  ushort cplanCol;
  short fBomberInQueue;
  short ishdefSBLatest;
  byte b;
  FLEET *lpflAttack;
  undefined2 local_66;
  FLEET *lpflT;
  short iroCur;
  short i;
  short ifl;
  FLEET *lpfl;
  PLANET *lpplHome;
  int local_54;
  PLANET *lppl;
  PLANET *lpplMac;
  int local_4c;
  short cplBadGuy;
  short idPlanDst;
  short fColonyShipInQueue;
  THING *lpthWorm;
  int local_42;
  short cplNegative;
  undefined4 lpplDest;
  ORDER ord__58;
  FLEET *lpflEnemy;
  int local_26;
  long rgResAvail [4];
  long rgResCost [4];
  
  cplBadGuy = 0;
  cplNegative = 0;
  cplanCol = 0;
  fColonyShipInQueue = 0;
  if (game.turn < 0x14) {
    sVar7 = 0;
  }
  else {
    sVar7 = 0xf;
  }
  iroCur = IroEnsureAi((byte *)0x0,0,&ishdefSBLatest,sVar7);
  EnsureCAShdefs(iroCur);
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_4c = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < lpplMac) {
    uVar15 = (undefined2)((ulong)lppl >> 0x10);
    if (((((PLANET *)lppl)->iPlayer == -1) && (2 < (((PLANET *)lppl)->wFlags_0x4 & 0xff))) &&
       (sVar7 = PctPlanetOptValue(lppl,idPlayer), 0 < sVar7)) {
      cplanCol = cplanCol + 1;
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_4c = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < lpplMac) {
    ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 9] = 1;
    uVar15 = (undefined2)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl)->iPlayer == -1) && (2 < (((PLANET *)lppl)->wFlags_0x4 & 0xff))) {
      b = 0;
      for (i = 0; i < 3; i = i + 1) {
        if (((PLANET *)lppl)->rgMinConc[i] < 0x43) {
          bVar6 = ((PLANET *)lppl)->rgMinConc[i] / 2;
        }
        else {
          bVar6 = 0x4b;
        }
        b = b + bVar6;
      }
      if ((b & 0x80) != 0) {
        b = 0x7f;
      }
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] = b;
    }
    if ((((PLANET *)lppl)->iPlayer == idPlayer) || (((PLANET *)lppl)->iPlayer == -1)) {
      if ((((PLANET *)lppl)->iPlayer == idPlayer) &&
         (sVar7 = PctPlanetDesirability(lppl,idPlayer), sVar7 < 0)) {
        cplNegative = cplNegative + 1;
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] = 1;
      }
      else {
        uVar15 = (undefined2)((ulong)lppl >> 0x10);
        pPVar9 = (PLANET *)lppl;
        if (((pPVar9->wFlags_0x4 >> 9 & 1) != 0) &&
           ((iVar8 = *(int *)((int)pPVar9->rgwtMin + 0xe), 0 < iVar8 ||
            ((-1 < iVar8 && (999 < *(uint *)(pPVar9->rgwtMin + 3))))))) {
          ChangeMainObjSel(1,lppl->id);
          InitProduction(rgprod);
          fWrite = 0;
          b = 0;
          i = 0;
          while ((i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac &&
                 ((uVar17 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff74),
                  ((uint)uVar17 & 7) != 2 ||
                  (uVar17 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff74),
                  ((uint)uVar17 & 0x7f) < 0x11))))) {
            i = i + 1;
          }
          if (i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
            FinishProduction(0);
          }
          else {
            if (game.turn == 0) {
              AddItemToQueue(0,1,grobjFleet,1);
              AddItemToQueue(0,1,grobjFleet,1);
            }
            else if ((fColonyShipInQueue == 0) &&
                    ((((uint)rgshdef[1].cExist == 0 &&
                      (rgshdef[1].cExist._2_2_ == 0)) ||
                     ((rgshdef[1].cExist._2_2_ +
                       (uint)(0xfffe < (uint)rgshdef[1].cExist) == 0 &&
                      ((uint)rgshdef[1].cExist + 1 < cplanCol)))))) {
              fColonyShipInQueue = 1;
              AddItemToQueue(1,1,grobjFleet,1);
              fWrite = 1;
            }
            FinishProduction(fWrite);
          }
        }
      }
    }
    else {
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] =
           ((byte)(((PLANET *)lppl)->wFlags_0x4 >> 9) & 1) + 1;
      sVar7 = PctPlanetOptValue(lppl,idPlayer);
      if (0 < sVar7) {
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 3] = 1;
      }
      cplBadGuy = cplBadGuy + 1;
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  lpflAttack = (FLEET *)0x0;
  local_66 = 0;
  lpflEnemy = (FLEET *)0x0;
  local_26 = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar11 = ((FLEET **)rglpfl)[ifl];
    iVar8 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar8,pFVar11);
    if ((pFVar11 == (FLEET *)0x0) && (iVar8 == 0)) break;
    if (pFVar11->iPlayer == idPlayer) {
      sVar7 = FIsTurinDroneAiAttack((FLEET *)CONCAT22(iVar8,pFVar11));
      if (sVar7 != 0) {
        *(FLEET **)&((FLEET *)lpfl)->lpflNext = lpflAttack;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpflNext + 2) = local_66;
        lpflAttack = (FLEET *)lpfl;
        local_66 = lpfl._2_2_;
      }
      ((FLEET *)lpfl)->wFlags_0x4 = ((FLEET *)lpfl)->wFlags_0x4 & 0x7fff;
      if (((((FLEET *)lpfl)->rgcsh[7] == 0) && (((FLEET *)lpfl)->rgcsh[8] == 0)) ||
         (((FLEET *)lpfl)->cord < 1)) {
        sVar7 = FIsAiTransport(lpfl);
        pFVar11 = (FLEET *)lpfl;
        uVar15 = (undefined2)((ulong)lpfl >> 0x10);
        if (sVar7 == 0) {
          if (pFVar11->rgcsh[1] != 0) {
            idPlanDst = -1;
            if (pFVar11->cord < 2) {
              idPlanDst = pFVar11->idPlanet;
            }
            else if ((((PLORD *)pFVar11->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
              idPlanDst = *(short *)&((PLORD *)pFVar11->lpplord)[6].iordMax;
            }
            if (idPlanDst != -1) {
              if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0)
              goto AI2_LCheckForColDrop;
              lppl = LpplFromId(idPlanDst);
              iVar8 = (int)((ulong)lppl >> 0x10);
              pPVar9 = (PLANET *)lppl;
              if ((((pPVar9 != (PLANET *)0x0) || (iVar8 != 0)) && (pPVar9->iPlayer != -1)) &&
                 (pPVar9->iPlayer != idPlayer)) goto AI2_LBlowAwayOrders;
            }
          }
        }
        else {
          idPlanDst = -1;
          if (pFVar11->cord < 2) {
            idPlanDst = pFVar11->idPlanet;
          }
          else if ((((PLORD *)pFVar11->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
            idPlanDst = *(short *)&((PLORD *)pFVar11->lpplord)[6].iordMax;
          }
AI2_LCheckForColDrop:
          if (idPlanDst != -1) {
            lppl = LpplFromId(idPlanDst);
            iVar8 = (int)((ulong)lppl >> 0x10);
            pPVar9 = (PLANET *)lppl;
            if (((pPVar9 == (PLANET *)0x0) && (iVar8 == 0)) ||
               ((pPVar9->iPlayer != -1 && (pPVar9->iPlayer != idPlayer)))) {
              if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0) {
                uVar15 = (undefined2)((ulong)lpfl >> 0x10);
                iVar5 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0xe);
                if (((-1 < iVar5) && ((0 < iVar5 || ((int)((FLEET *)lpfl)->rgwtMin[3] != 0)))) &&
                   (sVar7 = GetRaceStat((PLAYER *)rgplr + pPVar9->iPlayer,rsMajorAdv
                                             ), sVar7 != raMacintosh)) {
                  _memset(&stack0xff74,0,0x12);
                  ChangeMainObjSel(2,lpfl->id);
                  uVar15 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                  pPVar10 = (PLORD *)sel.fl.lpplord;
                  if ((pPVar10 + 2)->wFlags == idPlanDst) {
                    pPVar10 = pPVar10 + 1;
                    puVar13 = (ushort *)&stack0xff74;
                    for (iVar8 = 9; iVar8 != 0; iVar8 = iVar8 + -1) {
                      pPVar3 = pPVar10;
                      pPVar10 = (PLORD *)&pPVar10->iordMax;
                      puVar1 = puVar13;
                      puVar13 = puVar13 + 1;
                      pPVar3->wFlags = *puVar1;
                    }
                  }
                  else {
                    pbVar12 = &pPVar10[5].iordMax;
                    puVar14 = (undefined2 *)&stack0xff74;
                    for (iVar8 = 9; iVar8 != 0; iVar8 = iVar8 + -1) {
                      pbVar4 = pbVar12;
                      pbVar12 = pbVar12 + 2;
                      puVar2 = puVar14;
                      puVar14 = puVar14 + 1;
                      *(undefined2 *)pbVar4 = *puVar2;
                    }
                  }
                  FLookupFleet(-1,(FLEET *)&sel.fl);
                  ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] =
                       ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] | 0x80;
                  goto LAB_1098_22f9;
                }
              }
AI2_LBlowAwayOrders:
              ChangeMainObjSel(2,lpfl->id);
              sel.fl.cord = 1;
              ((PLORD *)sel.fl.lpplord)->iordMac = 1;
              FLookupFleet(-1,(FLEET *)&sel.fl);
              ClearAiCurrentTask(lpfl,0);
            }
          }
        }
      }
      else {
        if (((FLEET *)lpfl)->idPlanet == -1) {
          if (((FLEET *)lpfl)->cord < 2) goto LAB_1098_22f9;
          idPlanDst = *(short *)&((PLORD *)((FLEET *)lpfl)->lpplord)[6].iordMax;
        }
        else {
          pPVar18 = LpplFromId(((FLEET *)lpfl)->idPlanet);
          if (((PLANET *)pPVar18)->iPlayer != -1) goto AI2_LBlowAwayOrders;
          idPlanDst = ((FLEET *)lpfl)->idPlanet;
        }
        ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 1] =
             ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 1] | 0x80;
      }
    }
    else {
      *(FLEET **)&pFVar11->lpflNext = lpflEnemy;
      *(int *)((int)&pFVar11->lpflNext + 2) = local_26;
      lpflEnemy = pFVar11;
      local_26 = iVar8;
    }
LAB_1098_22f9:
  }
  fMarkedPlanets = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar11 = ((FLEET **)rglpfl)[ifl];
    iVar8 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar8,pFVar11);
    if ((pFVar11 == (FLEET *)0x0) && (iVar8 == 0)) break;
    if (pFVar11->iPlayer == idPlayer) {
      if ((pFVar11->rgcsh[7] == 0) && (pFVar11->rgcsh[8] == 0)) {
        if (pFVar11->cord < 2) {
          if (pFVar11->rgcsh[1] == 0) {
            sVar7 = FIsAiTransport((FLEET *)CONCAT22(iVar8,pFVar11));
            if (sVar7 == 0) {
              uVar15 = (undefined2)((ulong)lpfl >> 0x10);
              pFVar11 = (FLEET *)lpfl;
              if ((pFVar11->rgcsh[0xd] == 0) && (pFVar11->rgcsh[0xe] == 0)) {
                if (pFVar11->rgcsh[0] != 0) {
                  ChangeMainObjSel(2,lpfl->id);
                  uVar15 = (undefined2)((ulong)lpfl >> 0x10);
                  pFVar11 = (FLEET *)lpfl;
                  if ((((pFVar11->rgcsh[0] != 0) &&
                       ((rgshdef[0].hul.rghs[0].wFlags_0x2 & 0xff) == 1)) &&
                      (iVar8 = *(int *)((int)pFVar11->rgwtMin + 0x12), iVar8 < 1)) &&
                     ((iVar8 < 0 || (*(uint *)(pFVar11->rgwtMin + 4) < 2)))) goto AI2_LScrapFleet;
                  IdTargetScout(lpfl,(FLEET *)CONCAT22(local_66,lpflAttack),
                                     (FLEET *)CONCAT22(local_26,lpflEnemy),
                                     game.wCrap >> 4 & 1,&lpthWorm);
                }
              }
              else {
                ChangeMainObjSel(2,lpfl->id);
                uVar15 = (undefined2)((ulong)lpfl >> 0x10);
                if (((FLEET *)lpfl)->idPlanet == -1) {
                  lppl = (PLANET *)CONCAT22(local_54,lpplHome);
                }
                else {
                  lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
                  uVar15 = (undefined2)((ulong)lppl >> 0x10);
                  pPVar9 = (PLANET *)lppl;
                  if (pPVar9->iPlayer == idPlayer) {
                    if ((pPVar9->wFlags_0x4 >> 9 & 1) != 0) {
                      uVar15 = (undefined2)((ulong)lpfl >> 0x10);
                      if ((((FLEET *)lpfl)->rgcsh[0xd] < 2) && (((FLEET *)lpfl)->rgcsh[0xe] < 2))
                      goto LAB_1098_279b;
                    }
                    FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
                  }
                  else if (pPVar9->iPlayer != -1) {
                    lpflT = (FLEET *)CONCAT22(local_26,lpflEnemy);
                    do {
                      if (((FLEET *)lpflT == (FLEET *)0x0) && (lpflT._2_2_ == 0))
                      goto LAB_1098_279b;
                      uVar15 = (undefined2)((ulong)lpfl >> 0x10);
                      if (((&((FLEET *)lpfl)->pt)->x == (&((FLEET *)lpflT)->pt)->x) &&
                         ((((FLEET *)lpfl)->pt).y == (((FLEET *)lpflT)->pt).y)) {
                        sVar7 = FIsAiAttack(lpflT);
                        if (sVar7 != 0) break;
                      }
                      uVar15 = (undefined2)((ulong)lpflT >> 0x10);
                    /* WARNING: Load size is inaccurate */
                      lpflT = (FLEET *)CONCAT22(*(undefined2 *)
                                                 ((int)&((FLEET *)lpflT)->lpflNext + 2),
                                                ((FLEET *)lpflT)->lpflNext);
                    } while( true );
                  }
                }
                if ((game.wCrap >> 4 & 1) == 0) {
                  pPVar18 = (PLANET *)0x0;
                }
                else {
                  pPVar18 = LpplFindBestEnum(lppl,FEnumCalcArmadaHumanDest);
                }
                if (pPVar18 == (PLANET *)0x0) {
                  lpplDest = pPVar18;
                  pPVar18 = LpplFindBestEnum(lppl,FEnumCalcArmadaDest);
                }
                lppl = pPVar18;
                lpplDest._2_2_ = (int)((ulong)lppl >> 0x10);
                lpplDest = lppl;
                if (((PLANET *)lppl != (PLANET *)0x0) || (bVar16 = lpplDest._2_2_ != 0, bVar16)) {
                  ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] =
                       ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] | 0x80;
                  ord__58.id = lppl->id;
                  ord__58.pt.x = ((POINT *)rgptPlan + lppl->id)->x;
                  ord__58.pt.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
                  ord__58.wFlags_0x6 = ord__58.wFlags_0x6 & 0xe000 | 0x1140;
                  FMoveAiFleet(lpfl,&ord__58,0);
                }
              }
            }
            else {
              lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
              lpplMac = (PLANET *)lpPlanets + cPlanet;
              local_4c = lpPlanets._2_2_;
              while( true ) {
                if ((lpplMac <= (PLANET *)lppl) ||
                   ((((PLANET *)lppl)->iPlayer == idPlayer &&
                    ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0)))) break;
                lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
              }
              lpplHome = (PLANET *)lppl;
              local_54 = lppl._2_2_;
              if (((PLANET *)lppl == lpplMac) && (lppl._2_2_ == lpPlanets._2_2_)) {
                lpplHome = (PLANET *)0x0;
                local_54 = 0;
              }
              if ((lpplHome == (PLANET *)0x0) && (local_54 == 0)) break;
              lppl = (PLANET *)0x0;
              i = 0;
              while( true ) {
                uVar15 = (undefined2)((ulong)vlpbAiData >> 0x10);
                pbVar12 = (byte *)vlpbAiData;
                if (*(int *)(pbVar12 + 2) <= i) break;
                j = 0;
                while ((j < *(int *)(pbVar12 + i * 0x14 + 6) &&
                       (*(int *)(pbVar12 + j * 2 + i * 0x14 + 8) != lpfl->id))) {
                  j = j + 1;
                }
                if (j < *(int *)(pbVar12 + i * 0x14 + 6)) break;
                i = i + 1;
              }
              if (i < *(int *)(pbVar12 + 2)) {
                lppl = LpplFromId(*(short *)(pbVar12 + i * 0x14 + 4));
              }
              if (((PLANET *)lppl != (PLANET *)0x0) ||
                 (pPVar9 = lpplHome, iVar8 = local_54, lppl._2_2_ != 0)) {
                pPVar9 = (PLANET *)lppl;
                iVar8 = lppl._2_2_;
              }
              IdTargetFreighter(lpfl,(PLANET *)CONCAT22(iVar8,pPVar9));
            }
          }
          else {
            ChangeMainObjSel(2,lpfl->id);
            uVar15 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar11 = (FLEET *)lpfl;
            if (((((pFVar11->idPlanet == -1) || (sel.pl.iPlayer != idPlayer)) ||
                 ((sel.pl.rgwtMin[3]._2_2_ < 1 &&
                  ((sel.pl.rgwtMin[3]._2_2_ < 0 ||
                   ((uint)sel.pl.rgwtMin[3] < 0x32)))))) &&
                ((int)pFVar11->rgwtMin[3] == 0)) && (*(int *)((int)pFVar11->rgwtMin + 0xe) == 0)) {
              if (((sel.fl.idPlanet == -1) ||
                  (sel.pl.iPlayer != idPlayer)) ||
                 ((sel.pl.wFlags_0x4 >> 9 & 1) == 0)) {
                if (1 < (rgshdef[1].hul.rghs[0].wFlags_0x2 & 0xff)) {
                  sVar7 = FMoveToNearestStarbase(lpfl,0);
                  if (sVar7 != 0) goto LAB_1098_279b;
                }
AI2_LScrapFleet:
                ChangeMainObjSel(2,lpfl->id);
                uVar15 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                     *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
                FLookupFleet(-1,(FLEET *)&sel.fl);
              }
            }
            else {
              lpthWorm = (THING *)0x0;
              local_42 = 0;
              if ((rgshdef[1].hul.rghs[0].wFlags_0x2 & 0xff) < 2) {
                plpthWorm = (THING **)0x0;
              }
              else {
                plpthWorm = &lpthWorm;
              }
              idPlanDst = IdNearestColonizablePlanet(lpfl,plpthWorm);
              if ((((FLEET *)lpfl)->idPlanet != -1) && (sel.pl.iPlayer == idPlayer)
                 ) {
                ChangeMainObjSel(2,lpfl->id);
                XferAiSupply(1,((FLEET *)lpfl)->idPlanet,2,lpfl->id,3,0x19);
                FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
              }
              if (idPlanDst == -1) {
                if ((lpthWorm != (THING *)0x0) || (local_42 != 0)) {
                  FGotoWormholeAiFleet(lpfl,(THING *)CONCAT22(local_42,lpthWorm));
                }
              }
              else {
                FColonizeAiFleet(lpfl,idPlanDst);
                ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 0xf] = 4;
              }
            }
          }
        }
      }
      else if (pFVar11->idPlanet != -1) {
        ChangeMainObjSel(2,lpfl->id);
        b = ((byte *)vlpbAiPlanet)[((FLEET *)lpfl)->idPlanet * 0x10 + 1];
        if (b < 4) {
          lppl = LpplFindBestEnum(&sel.pl,FEnumCalcMinerDest);
          if (((PLANET *)lppl != (PLANET *)0x0) || ((int)((ulong)lppl >> 0x10) != 0)) {
            ord__58.id = lppl->id;
            ord__58.pt.x = ((POINT *)rgptPlan + lppl->id)->x;
            ord__58.pt.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
            ord__58.wFlags_0x6 = ord__58.wFlags_0x6 & 0xe000 | 0x1163;
            FMoveAiFleet(lpfl,&ord__58,1);
            ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] =
                 ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] | 0x80;
            ((byte *)vlpbAiPlanet)[((FLEET *)lpfl)->idPlanet * 0x10 + 1] =
                 ((byte *)vlpbAiPlanet)[((FLEET *)lpfl)->idPlanet * 0x10 + 1] & 0x80;
          }
        }
      }
    }
LAB_1098_279b:
  }
  HandleBasicAiTasks(iroCur,rgprod,ishdefSBLatest,rgResAvail,rgResCost);
  FillProductionQueue();
  return;
}



// ======================================================================
// Function: EnsureCAShdefs
// Address: 1098:3020
// Segment: MEMORY_AI2
// ======================================================================


void EnsureCAShdefs(short iroCur)

{
  return;
}



