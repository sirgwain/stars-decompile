// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: DoMaidAiTurn
// Address: 1098:0000
// Segment: MEMORY_AI2
// ======================================================================


void DoMaidAiTurn(PROD *rgprod)

{
  short sVar1;
  short iroCur;
  long rgResAvail [4];
  long rgResCost [4];
  
                    /* Segment:    20
                       Offset:     00091800
                       Length:     302f
                       Min Alloc:  302f
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  if ((uint)game.turn < 0x14) {
    sVar1 = 0;
  }
  else {
    sVar1 = 0xf;
  }
  sVar1 = IroEnsureAi((byte *)0x0,0,(short *)0x0,sVar1);
  fMarkedPlanets = 0;
  HandleBasicAiTasks(sVar1,rgprod,-1,rgResAvail,rgResCost);
  FillProductionQueue();
  return;
}



// ======================================================================
// Function: FPotentISWarFleet
// Address: 1098:012e
// Segment: MEMORY_AI2
// ======================================================================


short FPotentISWarFleet(FLEET *lpfl,short iPotency)

{
  uint uVar1;
  short cEquiv;
  short ish;
  
  cEquiv = 0;
  ish = 0xb;
  while( true ) {
    if (0xc < ish) break;
    cEquiv = cEquiv + ((FLEET *)lpfl)->rgcsh[ish];
    ish = ish + 1;
  }
  for (ish = 9; ish < 0xb; ish = ish + 1) {
    cEquiv = cEquiv + ((FLEET *)lpfl)->rgcsh[ish] * 2;
  }
  if (iPotency < 2) {
    uVar1 = 1;
  }
  else {
    uVar1 = (uint)((int)(uint)vrgAiArmadaPotency[0] <= cEquiv);
  }
  return uVar1;
}



// ======================================================================
// Function: DoAutomitronAiTurn
// Address: 1098:01e0
// Segment: MEMORY_AI2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1098068c) */
/* WARNING: Removing unreachable block (ram,0x109806ad) */
/* WARNING: Removing unreachable block (ram,0x10980a63) */
/* WARNING: Removing unreachable block (ram,0x109806b2) */
/* WARNING: Removing unreachable block (ram,0x10980be1) */

void DoAutomitronAiTurn(PROD *rgprod)

{
  uint *puVar1;
  int *piVar2;
  byte *pbVar3;
  uint uVar4;
  short *psVar5;
  undefined2 *puVar6;
  PLORD *pPVar7;
  uint uVar8;
  int iVar9;
  short sVar10;
  short sVar11;
  int iVar12;
  PLANET *pPVar13;
  PLORD *pPVar14;
  FLEET *pFVar15;
  byte *pbVar16;
  undefined2 unaff_SI;
  short *psVar17;
  undefined2 *puVar18;
  undefined2 unaff_DI;
  undefined2 uVar19;
  bool bVar20;
  ulong uVar21;
  PLANET *pPVar22;
  ulong uVar23;
  ushort in_stack_0000ff4c;
  ORDER ord_2;
  short iLatestBomber;
  short iLatestCargo;
  ushort cplanCol;
  ushort cRecyclePeriod;
  short ishdefSBLatest;
  byte b;
  FLEET *lpflAttack;
  FLEET *lpflT;
  short iroCur;
  short cRes;
  short i;
  short ifl;
  FLEET *lpfl;
  PLANET *lpplHome;
  PLANET *lppl;
  PLANET *lpplMac;
  short cplBadGuy;
  short idPlanDst;
  short cFr;
  THING *lpthWorm;
  short cplNegative;
  PLANET *lpplDest;
  byte rgRecycleShdef [16];
  ORDER ord;
  FLEET *lpflEnemy;
  long rgResAvail [4];
  short iLatestCruiser;
  long rgResCost [4];
  ushort rgCosts [4];
  short cExistCargo;
  
  uVar23 = CONCAT22(unaff_SI,unaff_DI);
  ord_2.pt.y = *(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0);
  cplBadGuy = 0;
  cplNegative = 0;
  cplanCol = 0;
  if ((uint)game.turn < 10) {
    sVar10 = 0;
  }
  else {
    sVar10 = 0x14;
  }
  iroCur = IroEnsureAi(vrgAiISResOrder,0x12,&ishdefSBLatest,sVar10);
  if ((uint)game.turn < 0x33) {
    if (0x1e < (uint)game.turn) {
      MergeAllShdefs(0x4000);
    }
  }
  else {
    MergeAllShdefs(0x1e0c);
    MergeAllShdefs(0x40);
    MergeAllShdefs(0x4000);
  }
  ord_2.txp.rgia[4].wFlags = 3;
  if (0x82 < (uint)game.turn) {
    ord_2.txp.rgia[4].wFlags = (game.turn - 0x78U) / 0x14 + 3;
  }
  if (0x32 < (uint)ord_2.txp.rgia[4].wFlags) {
    ord_2.txp.rgia[4].wFlags = 0x32;
  }
  vrgAiArmadaPotency[0] = (byte)ord_2.txp.rgia[4].wFlags;
  vrgAiArmadaPotency[1] = (byte)((ulong)(ord_2.txp.rgia[4].wFlags & 0xff) / 2);
  ord_2.txp.rgia[4].wFlags = 6;
  if (0x73 < (uint)game.turn) {
    ord_2.txp.rgia[4].wFlags = (game.turn - 100U) / 0x16 + 6;
  }
  if (0xc < (uint)ord_2.txp.rgia[4].wFlags) {
    ord_2.txp.rgia[4].wFlags = 0xc;
  }
  vrgAiArmadaPotency[2] = (byte)ord_2.txp.rgia[4].wFlags;
  if ((int)((uint)ord_2.txp.rgia[4].wFlags / 2 - 1) < 4) {
    vrgAiArmadaPotency[3] = (char)((uint)ord_2.txp.rgia[4].wFlags / 2) - 1;
  }
  else {
    vrgAiArmadaPotency[3] = 3;
  }
  _memset(rgRecycleShdef,0,0x10);
  if ((uint)game.turn < 0x78) {
    cRecyclePeriod = 0x32;
  }
  else if ((uint)game.turn < 200) {
    cRecyclePeriod = 0x46;
  }
  else {
    cRecyclePeriod = 100;
  }
  CheckAiShdefStatus(0xb,0xc,cRecyclePeriod,&iLatestCruiser,rgRecycleShdef);
  sVar10 = CheckAiShdefStatus(4,5,cRecyclePeriod,&iLatestCargo,rgRecycleShdef);
  CheckAiShdefStatus(2,3,cRecyclePeriod,&iLatestBomber,rgRecycleShdef);
  CheckAiShdefStatus(9,10,cRecyclePeriod,&ord_2.txp.rgia[3].wFlags,rgRecycleShdef);
  if (0x3c < (uint)game.turn) {
    SplitOutShdefs(rgRecycleShdef);
  }
  EnsureISShdefs(iroCur);
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  ord_2.pt.x = lpPlanets._2_2_;
  lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
  lpplMac._2_2_ = lpPlanets._2_2_;
  while( true ) {
    if ((PLANET *)lpplMac <= (PLANET *)lppl) break;
    uVar19 = (undefined2)((ulong)lppl >> 0x10);
    if (((((PLANET *)lppl)->iPlayer == -1) && (2 < (((PLANET *)lppl)->wFlags & 0xffU))) &&
       (sVar11 = PctPlanetOptValue(lppl,idPlayer), 0 < sVar11)) {
      cplanCol = cplanCol + 1;
    }
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  ord_2.pt.x = lpPlanets._2_2_;
  lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
  lpplMac._2_2_ = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < (PLANET *)lpplMac) {
    ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 9] = 1;
    uVar19 = (undefined2)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl)->iPlayer == idPlayer) || (((PLANET *)lppl)->iPlayer == -1)) {
      if (((PLANET *)lppl)->iPlayer == idPlayer) {
        sVar11 = PctPlanetDesirability(lppl,idPlayer);
        if (sVar11 < 0) {
          cplNegative = cplNegative + 1;
          ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] = 1;
          goto LAB_1098_0d2d;
        }
      }
      uVar19 = (undefined2)((ulong)lppl >> 0x10);
      pPVar13 = (PLANET *)lppl;
      if ((((uint)pPVar13->wFlags >> 9 & 1) != 0) &&
         ((iVar12 = *(int *)((int)pPVar13->rgwtMin + 0xe), 0 < iVar12 ||
          ((-1 < iVar12 && (0x5db < *(uint *)(pPVar13->rgwtMin + 3))))))) {
        ChangeMainObjSel(1,lppl->id);
        InitProduction(rgprod);
        ord_2.id = 0;
        b = 0;
        ord_2.txp.rgia[0].wFlags = lpplProdGlob._2_2_;
        ord_2.wFlags = (short)(PLPROD *)lpplProdGlob;
        for (i = 0; ord_2.wFlags = ord_2.wFlags + 4,
            i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
          uVar21 = __aFulshr(uVar23,in_stack_0000ff4c);
          if (((uint)uVar21 & 7) == 2) {
            uVar21 = __aFulshr(uVar23,in_stack_0000ff4c);
            if (((uint)uVar21 & 0x7f) < 0x10) break;
          }
        }
        if (i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
          FinishProduction(0);
        }
        else {
          uVar19 = (undefined2)((ulong)vlpbAiData >> 0x10);
          if (*(int *)((byte *)vlpbAiData + 2) * 2 <
              *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) / 10) {
            cFr = *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) / 10;
          }
          else {
            cFr = *(int *)((byte *)vlpbAiData + 2) << 1;
          }
          if (('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0)) &&
             (iLatestCargo != -1)) {
            if (sVar10 < cFr) {
LAB_1098_0785:
              AddItemToQueue(iLatestCargo,1,grobjFleet,1);
              ord_2.id = 1;
            }
            else if (sVar10 < (cFr * 10) / 7) {
              sVar11 = Random(4);
              if (sVar11 == 0) goto LAB_1098_0785;
            }
          }
          if ((((cplanCol != 0) && ((int)rgshdef[1].cExist == 0)) &&
              (rgshdef[1].cExist._2_2_ == 0)) && (10 < (uint)game.turn)) {
            AddItemToQueue(1,1,grobjFleet,1);
            ord_2.id = 1;
          }
          sVar11 = PctTrueMaxGrowth(idPlayer);
          uVar19 = (undefined2)((ulong)lppl >> 0x10);
          uVar21 = __aFulmul(CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                                              (int)((PLANET *)lppl)->rgwtMin[3]),(long)sVar11);
          ord_2.txp.rgia._2_4_ = uVar21;
          cRes = CResourcesAtPlanet(lppl,idPlayer);
          if (((uint)rgshdef[6].wFlags >> 9 & 1) == 0) {
            sVar11 = Random(3);
            if (sVar11 == 0) {
              ord_2.pt.x = lppl->id;
              cFr = 0;
              for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
                pFVar15 = ((FLEET **)rglpfl)[ifl];
                iVar12 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                lpfl = (FLEET *)CONCAT22(iVar12,pFVar15);
                if ((pFVar15 == (FLEET *)0x0) && (iVar12 == 0)) break;
                if ((pFVar15->idPlanet == ord_2.pt.x) &&
                   ((0 < pFVar15->rgcsh[6] && (pFVar15->iPlayer == idPlayer)))) {
                  cFr = pFVar15->rgcsh[6];
                  break;
                }
              }
              if (cFr < 10) {
LAB_1098_0905:
                sVar11 = Random(cFr * 2 + 1);
                if (sVar11 == 0) {
                  AddItemToQueue(6,3,grobjFleet,1);
                  ord_2.id = 1;
                }
              }
              else if (cFr < 0x11) {
                sVar11 = Random(8);
                if (sVar11 == 0) goto LAB_1098_0905;
              }
            }
          }
          if (iLatestBomber != -1) {
            ord_2.pt.x = lppl->id;
            for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
              pFVar15 = ((FLEET **)rglpfl)[ifl];
              iVar12 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
              lpfl = (FLEET *)CONCAT22(iVar12,pFVar15);
              if ((pFVar15 == (FLEET *)0x0) && (iVar12 == 0)) break;
              if ((pFVar15->idPlanet == ord_2.pt.x) && (pFVar15->iPlayer == idPlayer)) {
                sVar11 = FPotentISWarFleet((FLEET *)CONCAT22(iVar12,pFVar15),2);
                if (sVar11 != 0) {
                  if ((iLatestBomber != -1) &&
                     (uVar19 = (undefined2)((ulong)lpfl >> 0x10),
                     (int)(uint)vrgAiArmadaPotency[2] <=
                     ((FLEET *)lpfl)->rgcsh[2] + ((FLEET *)lpfl)->rgcsh[3])) {
                    AddItemToQueue(iLatestBomber,4,grobjFleet,1);
                    ord_2.id = 1;
                    goto AI2_FinishProd;
                  }
                  break;
                }
              }
            }
          }
          if (iLatestCruiser != -1) {
            ord_2.pt.x = 0;
            if ((*(int *)((int)&rgshdef[0].cExist + 2 + iLatestCruiser * 0x93) == 0) &&
               (*(uint *)((int)&rgshdef[0].cExist + iLatestCruiser * 0x93) <
                game.cPlanMax / 0xc + 8U)) {
              GetResourcesAvailable(lppl,rgResAvail);
              GetProdQCost(lppl,rgResCost);
              for (i = 0; i < 4; i = i + 1) {
                uVar8 = *(uint *)(rgResCost + i);
                iVar12 = *(int *)((int)rgResCost + i * 4 + 2);
                puVar1 = (uint *)(rgResAvail + i);
                uVar4 = *puVar1;
                *puVar1 = *puVar1 - uVar8;
                piVar2 = (int *)((int)rgResAvail + i * 4 + 2);
                *piVar2 = (*piVar2 - iVar12) - (uint)(uVar4 < uVar8);
                iVar12 = *(int *)((int)rgResAvail + i * 4 + 2);
                if ((iVar12 < 1) && (iVar12 < 0)) goto AI2_FinishProd;
              }
              for (i = 0; i < 5; i = i + 1) {
                GetTrueHullCost
                          (idPlayer,
                           (HUL *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                           (HUL *)(iLatestCruiser * 0x93 + 0x3f00)),rgCosts);
                for (ord_2.txp.rgia[4].wFlags = 0; ord_2.txp.rgia[4].wFlags < 4;
                    ord_2.txp.rgia[4].wFlags = ord_2.txp.rgia[4].wFlags + 1) {
                  uVar8 = rgCosts[ord_2.txp.rgia[4].wFlags];
                  puVar1 = (uint *)(rgResAvail + ord_2.txp.rgia[4].wFlags);
                  uVar4 = *puVar1;
                  *puVar1 = *puVar1 - uVar8;
                  piVar2 = (int *)((int)rgResAvail + ord_2.txp.rgia[4].wFlags * 4 + 2);
                  *piVar2 = *piVar2 - (uint)(uVar4 < uVar8);
                  iVar12 = *(int *)((int)rgResAvail + ord_2.txp.rgia[4].wFlags * 4 + 2);
                  if ((iVar12 < 1) && (iVar12 < 0)) goto AI2_FinishProd;
                }
                ord_2.id = 1;
                AddItemToQueue(iLatestCruiser,1,grobjFleet,1);
              }
            }
          }
          if (ord_2.txp.rgia[3].wFlags != -1) {
            ord_2.pt.x = 0;
            if ((*(int *)((int)&rgshdef[0].cExist + 2 + ord_2.txp.rgia[3].wFlags * 0x93)
                 == 0) &&
               (*(uint *)((int)&rgshdef[0].cExist + ord_2.txp.rgia[3].wFlags * 0x93) <
                game.cPlanMax / 0x18 + 4U)) {
              GetResourcesAvailable(lppl,rgResAvail);
              GetProdQCost(lppl,rgResCost);
              for (i = 0; i < 4; i = i + 1) {
                uVar8 = *(uint *)(rgResCost + i);
                iVar12 = *(int *)((int)rgResCost + i * 4 + 2);
                puVar1 = (uint *)(rgResAvail + i);
                uVar4 = *puVar1;
                *puVar1 = *puVar1 - uVar8;
                piVar2 = (int *)((int)rgResAvail + i * 4 + 2);
                *piVar2 = (*piVar2 - iVar12) - (uint)(uVar4 < uVar8);
                iVar12 = *(int *)((int)rgResAvail + i * 4 + 2);
                if ((iVar12 < 1) && (iVar12 < 0)) goto AI2_FinishProd;
              }
              for (i = 0; i < 5; i = i + 1) {
                GetTrueHullCost
                          (idPlayer,
                           (HUL *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                           (HUL *)(ord_2.txp.rgia[3].wFlags * 0x93 + 0x3f00)),
                           rgCosts);
                for (ord_2.txp.rgia[4].wFlags = 0; ord_2.txp.rgia[4].wFlags < 4;
                    ord_2.txp.rgia[4].wFlags = ord_2.txp.rgia[4].wFlags + 1) {
                  uVar8 = rgCosts[ord_2.txp.rgia[4].wFlags];
                  puVar1 = (uint *)(rgResAvail + ord_2.txp.rgia[4].wFlags);
                  uVar4 = *puVar1;
                  *puVar1 = *puVar1 - uVar8;
                  piVar2 = (int *)((int)rgResAvail + ord_2.txp.rgia[4].wFlags * 4 + 2);
                  *piVar2 = *piVar2 - (uint)(uVar4 < uVar8);
                  iVar12 = *(int *)((int)rgResAvail + ord_2.txp.rgia[4].wFlags * 4 + 2);
                  if ((iVar12 < 1) && (iVar12 < 0)) goto AI2_FinishProd;
                }
                ord_2.id = 1;
                AddItemToQueue(ord_2.txp.rgia[3].wFlags,1,grobjFleet,1);
              }
            }
          }
AI2_FinishProd:
          FinishProduction(ord_2.id);
        }
      }
    }
    else {
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] =
           ((byte)((uint)((PLANET *)lppl)->wFlags >> 9) & 1) + 1;
      sVar11 = PctPlanetOptValue(lppl,idPlayer);
      if (0 < sVar11) {
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 3] = 1;
      }
      cplBadGuy = cplBadGuy + 1;
    }
LAB_1098_0d2d:
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  lpflAttack._0_2_ = (FLEET *)0x0;
  lpflAttack._2_2_ = 0;
  lpflEnemy._0_2_ = (FLEET *)0x0;
  lpflEnemy._2_2_ = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar15 = ((FLEET **)rglpfl)[ifl];
    iVar12 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar12,pFVar15);
    if ((pFVar15 == (FLEET *)0x0) && (iVar12 == 0)) break;
    if (pFVar15->iPlayer == idPlayer) {
      sVar10 = FIsAiAttack((FLEET *)CONCAT22(iVar12,pFVar15));
      if (sVar10 != 0) {
        *(FLEET **)&((FLEET *)lpfl)->lpflNext = (FLEET *)lpflAttack;
        *(undefined2 *)((int)&((FLEET *)lpfl)->lpflNext + 2) = lpflAttack._2_2_;
        lpflAttack._0_2_ = (FLEET *)lpfl;
        lpflAttack._2_2_ = lpfl._2_2_;
      }
      ((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0x7fff;
      sVar10 = FIsAiTransport(lpfl);
      pFVar15 = (FLEET *)lpfl;
      uVar19 = (undefined2)((ulong)lpfl >> 0x10);
      if (sVar10 == 0) {
        if (pFVar15->rgcsh[1] != 0) {
          idPlanDst = -1;
          if (pFVar15->cord < 2) {
            idPlanDst = pFVar15->idPlanet;
          }
          else if (((uint)((PLORD *)pFVar15->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
            idPlanDst = *(short *)&((PLORD *)pFVar15->lpplord)[6].iordMax;
          }
          if (idPlanDst != -1) {
            if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0)
            goto AI2_LCheckForColDrop_2;
            lppl = LpplFromId(idPlanDst);
            iVar12 = (int)((ulong)lppl >> 0x10);
            pPVar13 = (PLANET *)lppl;
            if ((((pPVar13 != (PLANET *)0x0) || (iVar12 != 0)) && (pPVar13->iPlayer != -1)) &&
               (pPVar13->iPlayer != idPlayer)) goto AI2_LBlowAwayOrders_2;
          }
        }
      }
      else {
        idPlanDst = -1;
        if (pFVar15->cord < 2) {
          idPlanDst = pFVar15->idPlanet;
        }
        else if (((uint)((PLORD *)pFVar15->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
          idPlanDst = *(short *)&((PLORD *)pFVar15->lpplord)[6].iordMax;
        }
AI2_LCheckForColDrop_2:
        if (idPlanDst != -1) {
          lppl = LpplFromId(idPlanDst);
          iVar12 = (int)((ulong)lppl >> 0x10);
          pPVar13 = (PLANET *)lppl;
          if (((pPVar13 == (PLANET *)0x0) && (iVar12 == 0)) ||
             ((pPVar13->iPlayer != -1 && (pPVar13->iPlayer != idPlayer)))) {
            if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0) {
              uVar19 = (undefined2)((ulong)lpfl >> 0x10);
              iVar9 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0xe);
              if ((-1 < iVar9) && ((0 < iVar9 || ((int)((FLEET *)lpfl)->rgwtMin[3] != 0)))) {
                sVar10 = GetRaceStat((PLAYER *)rgplr + pPVar13->iPlayer,rsMajorAdv);
                if (sVar10 != raMacintosh) {
                  _memset(&stack0xff4c,0,0x12);
                  ChangeMainObjSel(2,lpfl->id);
                  uVar19 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                  pPVar14 = (PLORD *)sel.fl.lpplord;
                  if ((pPVar14 + 2)->wFlags == idPlanDst) {
                    pPVar14 = pPVar14 + 1;
                    psVar17 = (short *)&stack0xff4c;
                    for (iVar12 = 9; iVar12 != 0; iVar12 = iVar12 + -1) {
                      pPVar7 = pPVar14;
                      pPVar14 = (PLORD *)&pPVar14->iordMax;
                      psVar5 = psVar17;
                      psVar17 = psVar17 + 1;
                      pPVar7->wFlags = *psVar5;
                    }
                  }
                  else {
                    pbVar16 = &pPVar14[5].iordMax;
                    puVar18 = (undefined2 *)&stack0xff4c;
                    for (iVar12 = 9; iVar12 != 0; iVar12 = iVar12 + -1) {
                      pbVar3 = pbVar16;
                      pbVar16 = pbVar16 + 2;
                      puVar6 = puVar18;
                      puVar18 = puVar18 + 1;
                      *(undefined2 *)pbVar3 = *puVar6;
                    }
                  }
                  FLookupFleet(-1,(FLEET *)&sel.fl);
                  ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] =
                       ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] | 0x80;
                  goto LAB_1098_0d5d;
                }
              }
            }
AI2_LBlowAwayOrders_2:
            ChangeMainObjSel(2,lpfl->id);
            sel.fl.cord = 1;
            ((PLORD *)sel.fl.lpplord)->iordMac = 1;
            FLookupFleet(-1,(FLEET *)&sel.fl);
            ClearAiCurrentTask(lpfl,0);
          }
        }
      }
    }
    else {
      *(FLEET **)&pFVar15->lpflNext = (FLEET *)lpflEnemy;
      *(int *)((int)&pFVar15->lpflNext + 2) = lpflEnemy._2_2_;
      lpflEnemy._0_2_ = pFVar15;
      lpflEnemy._2_2_ = iVar12;
    }
LAB_1098_0d5d:
  }
  fMarkedPlanets = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar15 = ((FLEET **)rglpfl)[ifl];
    iVar12 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar12,pFVar15);
    if ((pFVar15 == (FLEET *)0x0) && (iVar12 == 0)) break;
    if (pFVar15->iPlayer == idPlayer) {
      if (pFVar15->cord < 2) {
        if (pFVar15->rgcsh[6] == 0) {
          if (pFVar15->rgcsh[1] == 0) {
            sVar10 = FIsAiTransport((FLEET *)CONCAT22(iVar12,pFVar15));
            if (sVar10 == 0) {
              uVar19 = (undefined2)((ulong)lpfl >> 0x10);
              pFVar15 = (FLEET *)lpfl;
              if ((pFVar15->rgcsh[2] == 0) && (pFVar15->rgcsh[3] == 0)) {
                if (pFVar15->rgcsh[0] != 0) {
                  ChangeMainObjSel(2,lpfl->id);
                  if ((((rgshdef[0].hul.rghs[0].wFlags & 0xffU) < 10) &&
                      (iVar12 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0x12), iVar12 < 1)) &&
                     ((iVar12 < 0 || (*(uint *)(((FLEET *)lpfl)->rgwtMin + 4) < 2))))
                  goto AI2_LScrapFleet_2;
                  IdTargetScout(lpfl,(FLEET *)CONCAT22(lpflAttack._2_2_,(FLEET *)lpflAttack),
                                     (FLEET *)CONCAT22(lpflEnemy._2_2_,(FLEET *)lpflEnemy),
                                     (uint)game.wCrap >> 4 & 1,&lpthWorm);
                }
              }
              else {
                ChangeMainObjSel(2,lpfl->id);
                uVar19 = (undefined2)((ulong)lpfl >> 0x10);
                if (((FLEET *)lpfl)->idPlanet == -1) {
                  lppl = (PLANET *)CONCAT22(lpplHome._2_2_,(PLANET *)lpplHome);
                }
                else {
                  lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
                  uVar19 = (undefined2)((ulong)lppl >> 0x10);
                  pPVar13 = (PLANET *)lppl;
                  if (pPVar13->iPlayer == idPlayer) {
                    if (((uint)pPVar13->wFlags >> 9 & 1) != 0) {
                      uVar19 = (undefined2)((ulong)lpfl >> 0x10);
                      pFVar15 = (FLEET *)lpfl;
                      if (((pFVar15->rgcsh[2] < 2) && (pFVar15->rgcsh[3] < 2)) ||
                         ((pFVar15->rgcsh[9] < 3 && (pFVar15->rgcsh[10] < 3)))) goto LAB_1098_1162;
                    }
                    FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
                  }
                  else if (pPVar13->iPlayer != -1) {
                    lpflT = (FLEET *)CONCAT22(lpflEnemy._2_2_,(FLEET *)lpflEnemy);
                    do {
                      if (((FLEET *)lpflT == (FLEET *)0x0) && (lpflT._2_2_ == 0))
                      goto LAB_1098_1162;
                      uVar19 = (undefined2)((ulong)lpfl >> 0x10);
                      if (((&((FLEET *)lpfl)->pt)->x == (&((FLEET *)lpflT)->pt)->x) &&
                         ((((FLEET *)lpfl)->pt).y == (((FLEET *)lpflT)->pt).y)) {
                        sVar10 = FIsAiAttack(lpflT);
                        if (sVar10 != 0) break;
                      }
                      uVar19 = (undefined2)((ulong)lpflT >> 0x10);
                    /* WARNING: Load size is inaccurate */
                      lpflT = (FLEET *)CONCAT22(*(undefined2 *)
                                                 ((int)&((FLEET *)lpflT)->lpflNext + 2),
                                                ((FLEET *)lpflT)->lpflNext);
                    } while( true );
                  }
                }
                if (((uint)game.wCrap >> 4 & 1) == 0) {
                  pPVar22 = (PLANET *)0x0;
                }
                else {
                  pPVar22 = LpplFindBestEnum(lppl,FEnumCalcArmadaHumanDest);
                }
                if (pPVar22 == (PLANET *)0x0) {
                  lpplDest = pPVar22;
                  pPVar22 = LpplFindBestEnum(lppl,FEnumCalcArmadaDest);
                }
                lppl = pPVar22;
                lpplDest._2_2_ = (int)((ulong)lppl >> 0x10);
                lpplDest = lppl;
                if (((PLANET *)lppl != (PLANET *)0x0) || (bVar20 = lpplDest._2_2_ != 0, bVar20)) {
                  ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] =
                       ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] | 0x80;
                  ord.id = lppl->id;
                  ord.pt.x = ((POINT *)rgptPlan + lppl->id)->x;
                  ord.pt.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
                  ord.wFlags = ord.wFlags & 0xe000U | 0x1140;
                  FMoveAiFleet(lpfl,&ord,0);
                }
              }
            }
            else {
              lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
              ord_2.pt.x = lpPlanets._2_2_;
              lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
              lpplMac._2_2_ = lpPlanets._2_2_;
              while( true ) {
                if (((PLANET *)lpplMac <= (PLANET *)lppl) ||
                   ((((PLANET *)lppl)->iPlayer == idPlayer &&
                    (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)))) break;
                lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
              }
              lpplHome._0_2_ = (PLANET *)lppl;
              lpplHome._2_2_ = lppl._2_2_;
              if (((PLANET *)lppl == (PLANET *)lpplMac) && (lppl._2_2_ == lpPlanets._2_2_)) {
                lpplHome._0_2_ = (PLANET *)0x0;
                lpplHome._2_2_ = 0;
              }
              if (((PLANET *)lpplHome == (PLANET *)0x0) && (lpplHome._2_2_ == 0)) break;
              lppl = (PLANET *)0x0;
              i = 0;
              while( true ) {
                uVar19 = (undefined2)((ulong)vlpbAiData >> 0x10);
                pbVar16 = (byte *)vlpbAiData;
                if (*(int *)(pbVar16 + 2) <= i) break;
                ord_2.txp.rgia[4].wFlags = 0;
                while ((ord_2.txp.rgia[4].wFlags < *(int *)(pbVar16 + i * 0x14 + 6) &&
                       (ord_2.pt.x = lpfl->id,
                       *(int *)(pbVar16 + ord_2.txp.rgia[4].wFlags * 2 + i * 0x14 + 8) != ord_2.pt.x
                       ))) {
                  ord_2.txp.rgia[4].wFlags = ord_2.txp.rgia[4].wFlags + 1;
                }
                if (ord_2.txp.rgia[4].wFlags < *(int *)(pbVar16 + i * 0x14 + 6)) break;
                i = i + 1;
              }
              if (i < *(int *)(pbVar16 + 2)) {
                lppl = LpplFromId(*(short *)(pbVar16 + i * 0x14 + 4));
              }
              if (((PLANET *)lppl != (PLANET *)0x0) ||
                 (pPVar13 = (PLANET *)lpplHome, iVar12 = lpplHome._2_2_, lppl._2_2_ != 0)) {
                pPVar13 = (PLANET *)lppl;
                iVar12 = lppl._2_2_;
              }
              IdTargetFreighter(lpfl,(PLANET *)CONCAT22(iVar12,pPVar13));
            }
          }
          else {
            if (rgshdef[1].hul.ihuldef != ihuldefMediumFreighter) goto AI2_LScrapFleet_2;
            ChangeMainObjSel(2,lpfl->id);
            uVar19 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar15 = (FLEET *)lpfl;
            if (((((pFVar15->idPlanet == -1) || (sel.pl.iPlayer != idPlayer)) ||
                 ((sel.pl.rgwtMin[3]._2_2_ < 1 &&
                  ((sel.pl.rgwtMin[3]._2_2_ < 0 ||
                   ((uint)sel.pl.rgwtMin[3] < 200)))))) && ((int)pFVar15->rgwtMin[3] == 0)
                ) && (*(int *)((int)pFVar15->rgwtMin + 0xe) == 0)) {
              if (((sel.fl.idPlanet == -1) ||
                  (sel.pl.iPlayer != idPlayer)) ||
                 (((uint)sel.pl.wFlags >> 9 & 1) == 0)) {
                if (1 < (rgshdef[1].hul.rghs[0].wFlags & 0xffU)) {
                  sVar10 = FMoveToNearestStarbase(lpfl,0);
                  if (sVar10 != 0) goto LAB_1098_1162;
                }
AI2_LScrapFleet_2:
                ChangeMainObjSel(2,lpfl->id);
                uVar19 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                     *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
                FLookupFleet(-1,(FLEET *)&sel.fl);
              }
            }
            else {
              lpthWorm._0_2_ = (THING *)0x0;
              lpthWorm._2_2_ = 0;
              idPlanDst = IdNearestColonizablePlanet(lpfl,(THING **)0x0);
              if ((((FLEET *)lpfl)->idPlanet != -1) && (sel.pl.iPlayer == idPlayer)
                 ) {
                ChangeMainObjSel(2,lpfl->id);
                XferAiSupply(1,((FLEET *)lpfl)->idPlanet,2,lpfl->id,3,0x96);
                FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
              }
              if (idPlanDst != -1) {
                FColonizeAiFleet(lpfl,idPlanDst);
                ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 0xf] = 4;
              }
            }
          }
        }
        else if ((pFVar15->cord == 1) &&
                ((*(uint *)&((PLORD *)pFVar15->lpplord)[2].iordMax & 0xf) == 0)) {
          ChangeMainObjSel(2,lpfl->id);
          uVar19 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
          *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
               *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 6;
          ((PLORD *)sel.fl.lpplord + 3)->wFlags = 5;
          pbVar3 = &((PLORD *)sel.fl.lpplord)[3].iordMax;
          pbVar3[0] = 5;
          pbVar3[1] = 0;
          FLookupFleet(-1,(FLEET *)&sel.fl);
        }
      }
      else if ((((rgshdef[0].hul.rghs[0].wFlags & 0xffU) < 10) &&
               (iVar9 = *(int *)((int)pFVar15->rgwtMin + 0x12), iVar9 < 1)) &&
              ((iVar9 < 0 || (*(uint *)(pFVar15->rgwtMin + 4) < 2)))) goto AI2_LScrapFleet_2;
    }
LAB_1098_1162:
  }
  HandleBasicAiTasks(iroCur,rgprod,ishdefSBLatest,rgResAvail,rgResCost);
  FillProductionQueue();
  return;
}



// ======================================================================
// Function: EnsureISShdefs
// Address: 1098:1938
// Segment: MEMORY_AI2
// ======================================================================


void EnsureISShdefs(short iroCur)

{
  SHDEF *pSVar1;
  SHDEF *pSVar2;
  short sVar3;
  int iVar4;
  SHDEF *pSVar5;
  SHDEF *pSVar6;
  undefined2 unaff_SS;
  short i;
  SHDEF shdef;
  
  if ((((uint)rgshdef[4].wFlags >> 9 & 1) != 0) &&
     ('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) {
    FCreateAiShdef(4,1,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0xe] + 0x78)));
  }
  if ((((uint)rgshdef[5].wFlags >> 9 & 1) != 0) &&
     ('\x06' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) {
    FCreateAiShdef(5,3,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0x12] + 0x78)));
  }
  if ((((((uint)rgshdef[0xe].wFlags >> 9 & 1) != 0) &&
       ('\x04' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
      ('\x05' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0))) &&
     (('\x03' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))) {
    for (i = 0; i < 4; i = i + 1) {
      sVar3 = Random(1);
      sVar3 = FCreateAiShdef(0xe,6,(byte *)CONCAT22(0x1098,(byte *)(*(byte *)(sVar3 + 0x68) +
                                                                        0x78)));
      if (sVar3 != 0) break;
    }
  }
  if ((((uint)rgshdef[1].wFlags >> 9 & 1) != 0) ||
     (((int)rgshdef[1].cExist == 0 && (rgshdef[1].cExist._2_2_ == 0)))) {
    if (((uint)rgshdef[1].wFlags >> 9 & 1) == 0) {
      pSVar5 = (SHDEF *)(rgshdef + 1);
      pSVar6 = &shdef;
      for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
        pSVar2 = pSVar6;
        pSVar6 = (SHDEF *)(pSVar6->hul).rgTech;
        pSVar1 = pSVar5;
        pSVar5 = (SHDEF *)(pSVar5->hul).rgTech;
        (pSVar2->hul).ihuldef = (pSVar1->hul).ihuldef;
      }
      *(char *)&(pSVar6->hul).ihuldef = (char)(pSVar5->hul).ihuldef;
      shdef.wFlags = shdef.wFlags & 0xfdffU | 0x200;
      FChangeAiShdef(&shdef,1);
    }
    FCreateAiShdef(1,1,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0] + 0x78)));
  }
  if ((((uint)rgshdef[0].wFlags >> 9 & 1) != 0) ||
     (((int)rgshdef[0].cExist == 0 && (rgshdef[0].cExist._2_2_ == 0)))) {
    if (((uint)rgshdef[0].wFlags >> 9 & 1) == 0) {
      pSVar5 = (SHDEF *)rgshdef;
      pSVar6 = &shdef;
      for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
        pSVar2 = pSVar6;
        pSVar6 = (SHDEF *)(pSVar6->hul).rgTech;
        pSVar1 = pSVar5;
        pSVar5 = (SHDEF *)(pSVar5->hul).rgTech;
        (pSVar2->hul).ihuldef = (pSVar1->hul).ihuldef;
      }
      *(char *)&(pSVar6->hul).ihuldef = (char)(pSVar5->hul).ihuldef;
      shdef.wFlags = shdef.wFlags & 0xfdffU | 0x200;
      FChangeAiShdef(&shdef,0);
    }
    FCreateAiShdef(0,4,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[1] + 0x78)));
  }
  if ((((((uint)rgshdef[6].wFlags >> 9 & 1) != 0) &&
       ('\x03' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0))) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) &&
     ('\x05' < *(char *)((int)rgplr[0].rgTech + 5 + idPlayer * 0xc0))) {
    FCreateAiShdef(6,0xb,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0x11] + 0x78)));
  }
  if (((((uint)rgshdef[2].wFlags >> 9 & 1) != 0) &&
      ('\a' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
     (('\x06' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) &&
      (('\x05' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
       ('\x06' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))))) {
    FCreateAiShdef(2,0x11,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0xf] + 0x78)));
  }
  if ((((((uint)rgshdef[3].wFlags >> 9 & 1) != 0) &&
       ('\n' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
      ('\v' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0))) &&
     (('\x0e' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
      ('\b' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))) {
    FCreateAiShdef(3,0x13,(byte *)CONCAT22(0x1098,(byte *)(vrgISIshAip[0x10] + 0x78)));
  }
  if (((((uint)rgshdef[9].wFlags >> 9 & 1) != 0) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
     (('\x05' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) &&
      (('\f' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
       ('\x06' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))))) {
    for (i = 0; i < 5; i = i + 1) {
      sVar3 = Random(4);
      sVar3 = FCreateAiShdef(9,9,(byte *)CONCAT22(0x1098,(byte *)(*(byte *)(sVar3 + 0x6e) +
                                                                      0x78)));
      if (sVar3 != 0) {
        return;
      }
    }
  }
  return;
}



// ======================================================================
// Function: DoRototillAiTurn
// Address: 1098:1e22
// Segment: MEMORY_AI2
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109821c6) */
/* WARNING: Removing unreachable block (ram,0x109821e6) */
/* WARNING: Removing unreachable block (ram,0x109821eb) */
/* WARNING: Removing unreachable block (ram,0x10982294) */

void DoRototillAiTurn(PROD *rgprod)

{
  short *psVar1;
  undefined2 *puVar2;
  PLORD *pPVar3;
  byte *pbVar4;
  int iVar5;
  FLEET *pFVar6;
  bool bVar7;
  short sVar8;
  short sVar9;
  THING **plpthWorm;
  PLANET *pPVar10;
  int iVar11;
  int iVar12;
  PLORD *pPVar13;
  byte *pbVar14;
  undefined2 unaff_SI;
  short *psVar15;
  undefined2 *puVar16;
  undefined2 unaff_DI;
  undefined2 uVar17;
  ulong uVar18;
  PLANET *pPVar19;
  PLANET *pPVar20;
  ulong uVar21;
  ushort in_stack_0000ff74;
  ORDER ord_2;
  byte b;
  FLEET *lpflAttack;
  FLEET *lpflT;
  short iroCur;
  short i;
  short ifl;
  FLEET *lpfl;
  PLANET *lpplHome;
  PLANET *lppl;
  PLANET *lpplMac;
  short cplBadGuy;
  short idPlanDst;
  short fColonyShipInQueue;
  THING *lpthWorm;
  short cplNegative;
  PLANET *lpplDest;
  ORDER ord;
  FLEET *lpflEnemy;
  long rgResAvail [4];
  long rgResCost [4];
  
  uVar21 = CONCAT22(unaff_SI,unaff_DI);
  ord_2.pt.y = *(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0);
  cplNegative = 0;
  ord_2.txp.rgia[2].wFlags = 0;
  bVar7 = false;
  ord_2.txp.rgia[3].wFlags = 0;
  if ((uint)game.turn < 0x14) {
    sVar8 = 0;
  }
  else {
    sVar8 = 0xf;
  }
  sVar8 = IroEnsureAi((byte *)0x0,0,&ord_2.txp.rgia[4].wFlags,sVar8);
  EnsureCAShdefs(sVar8);
  ord_2.pt.x = lpPlanets._2_2_;
  pPVar10 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < pPVar10) {
    uVar17 = (undefined2)((ulong)lppl >> 0x10);
    if (((((PLANET *)lppl)->iPlayer == -1) && (2 < (((PLANET *)lppl)->wFlags & 0xffU))) &&
       (sVar9 = PctPlanetOptValue(lppl,idPlayer), 0 < sVar9)) {
      ord_2.txp.rgia[2].wFlags = ord_2.txp.rgia[2].wFlags + 1;
    }
    lppl = (PLANET *)CONCAT22(uVar17,(PLANET *)lppl + 1);
  }
  ord_2.pt.x = lpPlanets._2_2_;
  pPVar10 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < pPVar10) {
    ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 9] = 1;
    uVar17 = (undefined2)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl)->iPlayer == -1) && (2 < (((PLANET *)lppl)->wFlags & 0xffU))) {
      b = 0;
      for (i = 0; i < 3; i = i + 1) {
        if (((PLANET *)lppl)->rgMinConc[i] < 0x43) {
          ord_2.pt.x = CONCAT11(ord_2.pt.x._1_1_,((PLANET *)lppl)->rgMinConc[i] / 2);
        }
        else {
          ord_2.pt.x = CONCAT11(ord_2.pt.x._1_1_,0x4b);
        }
        b = b + (char)ord_2.pt.x;
      }
      if ((b & 0x80) != 0) {
        b = 0x7f;
      }
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] = b;
    }
    if ((((PLANET *)lppl)->iPlayer == idPlayer) || (((PLANET *)lppl)->iPlayer == -1)) {
      if ((((PLANET *)lppl)->iPlayer == idPlayer) &&
         (sVar9 = PctPlanetDesirability(lppl,idPlayer), sVar9 < 0)) {
        cplNegative = cplNegative + 1;
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] = 1;
      }
      else if ((((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0) &&
              ((iVar11 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe), 0 < iVar11 ||
               ((-1 < iVar11 && (999 < *(uint *)(((PLANET *)lppl)->rgwtMin + 3))))))) {
        ChangeMainObjSel(1,lppl->id);
        InitProduction(rgprod);
        ord_2.id = 0;
        i = 0;
        ord_2.txp.rgia[0].wFlags = lpplProdGlob._2_2_;
        ord_2.wFlags = (short)(PLPROD *)lpplProdGlob;
        while ((ord_2.wFlags = ord_2.wFlags + 4,
               i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac &&
               ((uVar18 = __aFulshr(uVar21,in_stack_0000ff74), ((uint)uVar18 & 7) != 2 ||
                (uVar18 = __aFulshr(uVar21,in_stack_0000ff74), ((uint)uVar18 & 0x7f) < 0x11)
                )))) {
          i = i + 1;
        }
        if (i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
          FinishProduction(0);
        }
        else {
          if (game.turn == 0) {
            AddItemToQueue(0,1,grobjFleet,1);
            AddItemToQueue(0,1,grobjFleet,1);
          }
          else if ((!bVar7) &&
                  ((((uint)rgshdef[1].cExist == 0 &&
                    (rgshdef[1].cExist._2_2_ == 0)) ||
                   ((rgshdef[1].cExist._2_2_ +
                     (uint)(0xfffe < (uint)rgshdef[1].cExist) == 0 &&
                    ((uint)rgshdef[1].cExist + 1 < (uint)ord_2.txp.rgia[2].wFlags)))))) {
            bVar7 = true;
            AddItemToQueue(1,1,grobjFleet,1);
            ord_2.id = 1;
          }
          FinishProduction(ord_2.id);
        }
      }
    }
    else {
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] =
           ((byte)((uint)((PLANET *)lppl)->wFlags >> 9) & 1) + 1;
      sVar9 = PctPlanetOptValue(lppl,idPlayer);
      if (0 < sVar9) {
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 3] = 1;
      }
    }
    lppl = (PLANET *)CONCAT22(uVar17,(PLANET *)lppl + 1);
  }
  lpflAttack._0_2_ = (FLEET *)0x0;
  lpflAttack._2_2_ = 0;
  lpflEnemy._0_2_ = (FLEET *)0x0;
  lpflEnemy._2_2_ = 0;
  for (ifl = 0; pPVar20 = (PLANET *)CONCAT22(lpplDest._2_2_,(PLANET *)lpplDest),
      ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar6 = ((FLEET **)rglpfl)[ifl];
    iVar11 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar11,pFVar6);
    if ((pFVar6 == (FLEET *)0x0) && (iVar11 == 0)) break;
    if (pFVar6->iPlayer == idPlayer) {
      sVar9 = FIsTurinDroneAiAttack((FLEET *)CONCAT22(iVar11,pFVar6));
      if (sVar9 != 0) {
        *(FLEET **)&pFVar6->lpflNext = (FLEET *)lpflAttack;
        *(int *)((int)&pFVar6->lpflNext + 2) = lpflAttack._2_2_;
        lpflAttack._0_2_ = pFVar6;
        lpflAttack._2_2_ = iVar11;
      }
      pFVar6->wFlags = pFVar6->wFlags & 0x7fff;
      if (((pFVar6->rgcsh[7] == 0) && (pFVar6->rgcsh[8] == 0)) || (pFVar6->cord < 1)) {
        sVar9 = FIsAiTransport((FLEET *)CONCAT22(iVar11,pFVar6));
        if (sVar9 == 0) {
          if (pFVar6->rgcsh[1] != 0) {
            idPlanDst = -1;
            if (pFVar6->cord < 2) {
              idPlanDst = pFVar6->idPlanet;
            }
            else if (((uint)((PLORD *)pFVar6->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
              idPlanDst = *(short *)&((PLORD *)pFVar6->lpplord)[6].iordMax;
            }
            if (idPlanDst != -1) {
              if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0)
              goto AI2_LCheckForColDrop;
              pPVar20 = LpplFromId(idPlanDst);
              iVar12 = (int)((ulong)pPVar20 >> 0x10);
              pPVar10 = (PLANET *)pPVar20;
              if ((((pPVar10 != (PLANET *)0x0) || (iVar12 != 0)) && (pPVar10->iPlayer != -1)) &&
                 (pPVar10->iPlayer != idPlayer)) goto AI2_LBlowAwayOrders;
            }
          }
        }
        else {
          idPlanDst = -1;
          if (pFVar6->cord < 2) {
            idPlanDst = pFVar6->idPlanet;
          }
          else if (((uint)((PLORD *)pFVar6->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
            idPlanDst = *(short *)&((PLORD *)pFVar6->lpplord)[6].iordMax;
          }
AI2_LCheckForColDrop:
          if (idPlanDst != -1) {
            pPVar20 = LpplFromId(idPlanDst);
            iVar12 = (int)((ulong)pPVar20 >> 0x10);
            pPVar10 = (PLANET *)pPVar20;
            if (((pPVar10 == (PLANET *)0x0) && (iVar12 == 0)) ||
               ((pPVar10->iPlayer != -1 && (pPVar10->iPlayer != idPlayer)))) {
              if ((((((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] == 0) ||
                   (iVar5 = *(int *)((int)pFVar6->rgwtMin + 0xe), iVar5 < 0)) ||
                  ((iVar5 < 1 && ((int)pFVar6->rgwtMin[3] == 0)))) ||
                 (sVar9 = GetRaceStat((PLAYER *)rgplr + pPVar10->iPlayer,rsMajorAdv)
                 , sVar9 == raMacintosh)) goto AI2_LBlowAwayOrders;
              _memset(&stack0xff74,0,0x12);
              ChangeMainObjSel(2,lpfl->id);
              uVar17 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
              pPVar13 = (PLORD *)sel.fl.lpplord;
              if ((pPVar13 + 2)->wFlags == idPlanDst) {
                pPVar13 = pPVar13 + 1;
                psVar15 = (short *)&stack0xff74;
                for (iVar11 = 9; iVar11 != 0; iVar11 = iVar11 + -1) {
                  pPVar3 = pPVar13;
                  pPVar13 = (PLORD *)&pPVar13->iordMax;
                  psVar1 = psVar15;
                  psVar15 = psVar15 + 1;
                  pPVar3->wFlags = *psVar1;
                }
              }
              else {
                pbVar14 = &pPVar13[5].iordMax;
                puVar16 = (undefined2 *)&stack0xff74;
                for (iVar11 = 9; iVar11 != 0; iVar11 = iVar11 + -1) {
                  pbVar4 = pbVar14;
                  pbVar14 = pbVar14 + 2;
                  puVar2 = puVar16;
                  puVar16 = puVar16 + 1;
                  *(undefined2 *)pbVar4 = *puVar2;
                }
              }
              FLookupFleet(-1,(FLEET *)&sel.fl);
              ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] =
                   ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] | 0x80;
            }
          }
        }
      }
      else if (pFVar6->idPlanet == -1) {
        if (1 < pFVar6->cord) {
          idPlanDst = *(short *)&((PLORD *)pFVar6->lpplord)[6].iordMax;
          goto LAB_1098_2476;
        }
      }
      else {
        pPVar20 = LpplFromId(pFVar6->idPlanet);
        if (((PLANET *)pPVar20)->iPlayer == -1) {
          idPlanDst = pFVar6->idPlanet;
LAB_1098_2476:
          ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 1] =
               ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 1] | 0x80;
        }
        else {
AI2_LBlowAwayOrders:
          ChangeMainObjSel(2,lpfl->id);
          sel.fl.cord = 1;
          ((PLORD *)sel.fl.lpplord)->iordMac = 1;
          FLookupFleet(-1,(FLEET *)&sel.fl);
          ClearAiCurrentTask((FLEET *)CONCAT22(iVar11,pFVar6),0);
        }
      }
    }
    else {
      *(FLEET **)&pFVar6->lpflNext = (FLEET *)lpflEnemy;
      *(int *)((int)&pFVar6->lpflNext + 2) = lpflEnemy._2_2_;
      lpflEnemy._0_2_ = pFVar6;
      lpflEnemy._2_2_ = iVar11;
    }
  }
  fMarkedPlanets = 0;
  for (ifl = 0; lpplDest = pPVar20, ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar6 = ((FLEET **)rglpfl)[ifl];
    iVar11 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar11,pFVar6);
    if ((pFVar6 == (FLEET *)0x0) && (iVar11 == 0)) break;
    if (pFVar6->iPlayer == idPlayer) {
      if ((pFVar6->rgcsh[7] == 0) && (pFVar6->rgcsh[8] == 0)) {
        if (pFVar6->cord < 2) {
          if (pFVar6->rgcsh[1] == 0) {
            sVar9 = FIsAiTransport((FLEET *)CONCAT22(iVar11,pFVar6));
            if (sVar9 == 0) {
              if ((pFVar6->rgcsh[0xd] == 0) && (pFVar6->rgcsh[0xe] == 0)) {
                pPVar20 = lpplDest;
                if (pFVar6->rgcsh[0] != 0) {
                  ChangeMainObjSel(2,lpfl->id);
                  if ((((pFVar6->rgcsh[0] != 0) &&
                       ((rgshdef[0].hul.rghs[0].wFlags & 0xffU) == 1)) &&
                      (iVar12 = *(int *)((int)pFVar6->rgwtMin + 0x12), iVar12 < 1)) &&
                     ((iVar12 < 0 || (*(uint *)(pFVar6->rgwtMin + 4) < 2)))) goto AI2_LScrapFleet;
                  IdTargetScout((FLEET *)CONCAT22(iVar11,pFVar6),
                                     (FLEET *)CONCAT22(lpflAttack._2_2_,(FLEET *)lpflAttack),
                                     (FLEET *)CONCAT22(lpflEnemy._2_2_,(FLEET *)lpflEnemy),
                                     (uint)game.wCrap >> 4 & 1,&lpthWorm);
                  pPVar20 = lpplDest;
                }
              }
              else {
                ChangeMainObjSel(2,lpfl->id);
                if (pFVar6->idPlanet == -1) {
                  lppl = (PLANET *)CONCAT22(lpplHome._2_2_,(PLANET *)lpplHome);
                }
                else {
                  lppl = LpplFromId(pFVar6->idPlanet);
                  uVar17 = (undefined2)((ulong)lppl >> 0x10);
                  pPVar10 = (PLANET *)lppl;
                  if (pPVar10->iPlayer == idPlayer) {
                    if (((((uint)pPVar10->wFlags >> 9 & 1) != 0) && (pFVar6->rgcsh[0xd] < 2)) &&
                       (pPVar20 = lpplDest, pFVar6->rgcsh[0xe] < 2)) goto LAB_1098_279b;
                    FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
                  }
                  else if (pPVar10->iPlayer != -1) {
                    lpflT = (FLEET *)CONCAT22(lpflEnemy._2_2_,(FLEET *)lpflEnemy);
                    do {
                      if (((FLEET *)lpflT == (FLEET *)0x0) && (pPVar20 = lpplDest, lpflT._2_2_ == 0)
                         ) goto LAB_1098_279b;
                      if (((&pFVar6->pt)->x == (&((FLEET *)lpflT)->pt)->x) &&
                         ((pFVar6->pt).y == (((FLEET *)lpflT)->pt).y)) {
                        sVar9 = FIsAiAttack(lpflT);
                        if (sVar9 != 0) break;
                      }
                    /* WARNING: Load size is inaccurate */
                      lpflT = (FLEET *)CONCAT22(*(undefined2 *)
                                                 ((int)&((FLEET *)lpflT)->lpflNext + 2),
                                                ((FLEET *)lpflT)->lpflNext);
                    } while( true );
                  }
                }
                if (((uint)game.wCrap >> 4 & 1) == 0) {
                  pPVar20 = (PLANET *)0x0;
                }
                else {
                  pPVar20 = LpplFindBestEnum(lppl,FEnumCalcArmadaHumanDest);
                }
                if (pPVar20 == (PLANET *)0x0) {
                  lpplDest = pPVar20;
                  pPVar20 = LpplFindBestEnum(lppl,FEnumCalcArmadaDest);
                }
                lpplDest._2_2_ = (int)((ulong)pPVar20 >> 0x10);
                if (((PLANET *)pPVar20 != (PLANET *)0x0) || (lpplDest._2_2_ != 0)) {
                  ((byte *)vlpbAiPlanet)[pPVar20->id * 0x10 + 10] =
                       ((byte *)vlpbAiPlanet)[pPVar20->id * 0x10 + 10] | 0x80;
                  ord.id = pPVar20->id;
                  ord.pt.x = ((POINT *)rgptPlan + pPVar20->id)->x;
                  ord.pt.y = *(short *)((int)&rgptPlan[0].y + pPVar20->id * 4);
                  ord.wFlags = ord.wFlags & 0xe000U | 0x1140;
                  lpplDest = pPVar20;
                  FMoveAiFleet((FLEET *)CONCAT22(iVar11,pFVar6),&ord,0);
                  pPVar20 = lpplDest;
                }
              }
            }
            else {
              lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
              ord_2.pt.x = lpPlanets._2_2_;
              while( true ) {
                if (((PLANET *)lpPlanets + cPlanet <= (PLANET *)lppl) ||
                   ((((PLANET *)lppl)->iPlayer == idPlayer &&
                    (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)))) break;
                lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
              }
              lpplHome._0_2_ = (PLANET *)lppl;
              lpplHome._2_2_ = lppl._2_2_;
              if (((PLANET *)lppl == (PLANET *)lpPlanets + cPlanet) &&
                 (lppl._2_2_ == lpPlanets._2_2_)) {
                lpplHome._0_2_ = (PLANET *)0x0;
                lpplHome._2_2_ = 0;
              }
              if (((PLANET *)lpplHome == (PLANET *)0x0) && (lpplHome._2_2_ == 0)) break;
              lppl = (PLANET *)0x0;
              i = 0;
              while( true ) {
                uVar17 = (undefined2)((ulong)vlpbAiData >> 0x10);
                pbVar14 = (byte *)vlpbAiData;
                if (*(int *)(pbVar14 + 2) <= i) break;
                ord_2.txp.rgia[1].wFlags = 0;
                while ((ord_2.txp.rgia[1].wFlags < *(int *)(pbVar14 + i * 0x14 + 6) &&
                       (ord_2.pt.x = lpfl->id,
                       *(int *)(pbVar14 + ord_2.txp.rgia[1].wFlags * 2 + i * 0x14 + 8) != ord_2.pt.x
                       ))) {
                  ord_2.txp.rgia[1].wFlags = ord_2.txp.rgia[1].wFlags + 1;
                }
                if (ord_2.txp.rgia[1].wFlags < *(int *)(pbVar14 + i * 0x14 + 6)) break;
                i = i + 1;
              }
              if (i < *(int *)(pbVar14 + 2)) {
                lppl = LpplFromId(*(short *)(pbVar14 + i * 0x14 + 4));
              }
              if (((PLANET *)lppl != (PLANET *)0x0) ||
                 (pPVar10 = (PLANET *)lpplHome, iVar12 = lpplHome._2_2_, lppl._2_2_ != 0)) {
                pPVar10 = (PLANET *)lppl;
                iVar12 = lppl._2_2_;
              }
              IdTargetFreighter
                        ((FLEET *)CONCAT22(iVar11,pFVar6),(PLANET *)CONCAT22(iVar12,pPVar10));
              pPVar20 = lpplDest;
            }
          }
          else {
            ChangeMainObjSel(2,lpfl->id);
            if (((((pFVar6->idPlanet == -1) || (sel.pl.iPlayer != idPlayer)) ||
                 ((sel.pl.rgwtMin[3]._2_2_ < 1 &&
                  ((sel.pl.rgwtMin[3]._2_2_ < 0 ||
                   ((uint)sel.pl.rgwtMin[3] < 0x32)))))) && ((int)pFVar6->rgwtMin[3] == 0)
                ) && (*(int *)((int)pFVar6->rgwtMin + 0xe) == 0)) {
              if (((sel.fl.idPlanet == -1) ||
                  (sel.pl.iPlayer != idPlayer)) ||
                 (pPVar20 = lpplDest, ((uint)sel.pl.wFlags >> 9 & 1) == 0)) {
                if (1 < (rgshdef[1].hul.rghs[0].wFlags & 0xffU)) {
                  sVar9 = FMoveToNearestStarbase((FLEET *)CONCAT22(iVar11,pFVar6),0);
                  pPVar20 = lpplDest;
                  if (sVar9 != 0) goto LAB_1098_279b;
                }
AI2_LScrapFleet:
                ChangeMainObjSel(2,lpfl->id);
                uVar17 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                     *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
                FLookupFleet(-1,(FLEET *)&sel.fl);
                pPVar20 = lpplDest;
              }
            }
            else {
              lpthWorm._0_2_ = (THING *)0x0;
              lpthWorm._2_2_ = 0;
              if ((rgshdef[1].hul.rghs[0].wFlags & 0xffU) < 2) {
                plpthWorm = (THING **)0x0;
              }
              else {
                plpthWorm = &lpthWorm;
              }
              sVar9 = IdNearestColonizablePlanet((FLEET *)CONCAT22(iVar11,pFVar6),plpthWorm);
              if ((pFVar6->idPlanet != -1) && (sel.pl.iPlayer == idPlayer)) {
                ChangeMainObjSel(2,lpfl->id);
                XferAiSupply(1,pFVar6->idPlanet,2,lpfl->id,3,0x19);
                FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
              }
              if (sVar9 == -1) {
                if (((THING *)lpthWorm != (THING *)0x0) || (pPVar20 = lpplDest, lpthWorm._2_2_ != 0)
                   ) {
                  FGotoWormholeAiFleet
                            ((FLEET *)CONCAT22(iVar11,pFVar6),
                             (THING *)CONCAT22(lpthWorm._2_2_,(THING *)lpthWorm));
                  pPVar20 = lpplDest;
                }
              }
              else {
                FColonizeAiFleet((FLEET *)CONCAT22(iVar11,pFVar6),sVar9);
                ((byte *)vlpbAiPlanet)[sVar9 * 0x10 + 0xf] = 4;
                pPVar20 = lpplDest;
              }
            }
          }
        }
      }
      else if (pFVar6->idPlanet != -1) {
        ChangeMainObjSel(2,lpfl->id);
        pPVar20 = lpplDest;
        if (((byte *)vlpbAiPlanet)[pFVar6->idPlanet * 0x10 + 1] < 4) {
          pPVar19 = LpplFindBestEnum(&sel.pl,FEnumCalcMinerDest);
          if (((PLANET *)pPVar19 != (PLANET *)0x0) ||
             (pPVar20 = lpplDest, (int)((ulong)pPVar19 >> 0x10) != 0)) {
            ord.id = pPVar19->id;
            ord.pt.x = ((POINT *)rgptPlan + pPVar19->id)->x;
            ord.pt.y = *(short *)((int)&rgptPlan[0].y + pPVar19->id * 4);
            ord.wFlags = ord.wFlags & 0xe000U | 0x1163;
            FMoveAiFleet((FLEET *)CONCAT22(iVar11,pFVar6),&ord,1);
            ((byte *)vlpbAiPlanet)[pPVar19->id * 0x10 + 1] =
                 ((byte *)vlpbAiPlanet)[pPVar19->id * 0x10 + 1] | 0x80;
            ((byte *)vlpbAiPlanet)[pFVar6->idPlanet * 0x10 + 1] =
                 ((byte *)vlpbAiPlanet)[pFVar6->idPlanet * 0x10 + 1] & 0x80;
            pPVar20 = lpplDest;
          }
        }
      }
    }
LAB_1098_279b:
  }
  HandleBasicAiTasks(sVar8,rgprod,ord_2.txp.rgia[4].wFlags,rgResAvail,rgResCost);
  FillProductionQueue();
  return;
}



// ======================================================================
// Function: EnsureCAShdefs
// Address: 1098:3020
// Segment: MEMORY_AI2
// ======================================================================


void EnsureCAShdefs(short iroCur)

{
  return;
}



