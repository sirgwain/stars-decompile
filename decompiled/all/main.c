// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: WinMain
// Address: 1018:0000
// Segment: MEMORY_MAIN
// ======================================================================


short WinMain(HINSTANCE hInstance,ushort hPrevInstance,char *lpCmdLine,short nCmdShow)

{
  char cVar1;
  undefined2 uVar2;
  HACCEL *pHVar3;
  short sVar4;
  char *pcVar5;
  BOOL BVar6;
  HACCEL *pHVar7;
  undefined2 uVar8;
  undefined2 unaff_SS;
  DWORD dw;
  long lVar9;
  MSG msg;
  short i;
  char *lpT;
  char *pch;
  
                    /* Segment:    4
                       Offset:     000118c0
                       Length:     1c3c
                       Min Alloc:  1c3c
                       Flags:      1d50
                           Code
                           Discardable
                           Moveable
                           Preload
                           Impure (Non-shareable)
                        */
  hInst = hInstance;
  szBase[0] = '\0';
  ini.wFlags = 0;
  _memset((TUTOR *)&tutor,0,0x2c);
  _memset((TIMER *)&vtimer,0,10);
  vtimer.fAutoGenWhenIn = 1;
  if ((hPrevInstance == 0) && (sVar4 = InitMDIApp(), sVar4 == 0)) {
    sVar4 = 0x10;
    pcVar5 = PszFormatIds(idsUnableInitializeStars,(short *)0x0);
    AlertSz(pcVar5,sVar4);
    lVar9 = CONCAT22(lSaltLast._2_2_,(undefined2)lSaltLast);
    msg.wParam = 0;
  }
  else {
    dw = GetTickCount();
    Randomize2(dw);
    sVar4 = FCreateStuff();
    lVar9 = CONCAT22(lSaltLast._2_2_,(undefined2)lSaltLast);
    if (sVar4 == 0) {
      msg.wParam = 0;
    }
    else {
      sVar4 = FGetSystemColors();
      if (sVar4 == 0) {
        sVar4 = 0x10;
        pcVar5 = PszFormatIds(idsUnableInitializeStars,(short *)0x0);
        AlertSz(pcVar5,sVar4);
        lVar9 = CONCAT22(lSaltLast._2_2_,(undefined2)lSaltLast);
        msg.wParam = 0;
      }
      else {
        sVar4 = InitInstance(nCmdShow);
        if (sVar4 == 0) {
          sVar4 = 0x10;
          pcVar5 = PszFormatIds(idsUnableInitializeStars,(short *)0x0);
          AlertSz(pcVar5,sVar4);
          lVar9 = CONCAT22(lSaltLast._2_2_,(undefined2)lSaltLast);
          msg.wParam = 0;
        }
        else {
          lpT = lpCmdLine;
          while (*lpT != '\0') {
            while( true ) {
              if (*lpT != ' ') break;
              lpT = (char *)lpT + 1;
            }
            if ((*lpT == '-') || (*lpT == '/')) {
              lpT = (char *)lpT + 1;
              while ((*lpT != '\0' && (*lpT != ' '))) {
                switch(*lpT) {
                case 'A':
                case 'a':
                  ini.wFlags = ini.wFlags & 0xfbff | 0x400;
                  break;
                case 'B':
                case 'b':
                  lpT = (char *)lpT + 1;
                  while (*lpT == ' ') {
                    lpT = (char *)lpT + 1;
                  }
                  pch = (char *)szBase;
                  while( true ) {
                    if ((*lpT == '\0') || (*lpT == ' ')) break;
                    *pch = *lpT;
                    pch = pch + 1;
                    lpT = (char *)lpT + 1;
                  }
                  *pch = '\0';
                  lpT = (char *)lpT + -1;
                  sVar4 = FSetUpBatchProcessing();
                  if (sVar4 != 0) {
                    ini.wFlags = ini.wFlags & 0xfdf4 | 0x20b;
                  }
                  break;
                case 'C':
                case 'c':
                  ini.wFlags =
                       ini.wFlags & 0xfffd | (uint)(szBase[0] != '\0') << 1;
                  break;
                case 'D':
                case 'd':
                  lpT = (char *)lpT + 1;
                  while( true ) {
                    if ((*lpT == '\0') || (*lpT == ' ')) break;
                    cVar1 = *lpT;
                    if (cVar1 == 'F') {
LAB_1018_01ce:
                      ini.wFlags = ini.wFlags & 0xf7ff | 0x800;
                    }
                    else if (cVar1 == 'M') {
LAB_1018_01ec:
                      ini.wFlags = ini.wFlags & 0xdfff | 0x2000;
                    }
                    else if (cVar1 == 'P') {
LAB_1018_01dd:
                      ini.wFlags = ini.wFlags & 0xefff | 0x1000;
                    }
                    else {
                      if (cVar1 == 'f') goto LAB_1018_01ce;
                      if (cVar1 == 'm') goto LAB_1018_01ec;
                      if (cVar1 == 'p') goto LAB_1018_01dd;
                    }
                    lpT = (char *)lpT + 1;
                  }
                  lpT = (char *)lpT + -1;
                  break;
                default:
                  break;
                case 'G':
                case 'g':
                  ini.wFlags = ini.wFlags & 0xfff7 | 8;
                  i = 0;
                  do {
                    uVar8 = (undefined2)((ulong)lpT >> 0x10);
                    pcVar5 = (char *)lpT;
                    if ((pcVar5[1] < '0') || ('9' < pcVar5[1])) goto LAB_1018_02cb;
                    lpT = (char *)CONCAT22(uVar8,pcVar5 + 1);
                    i = i * 10 + (int)*lpT + -0x30;
                  } while (i < 0x3e9);
                  i = 1000;
                  while( true ) {
                    uVar8 = (undefined2)((ulong)lpT >> 0x10);
                    pcVar5 = (char *)lpT;
                    if ((pcVar5[1] < '0') || ('9' < pcVar5[1])) break;
                    lpT = (char *)CONCAT22(uVar8,pcVar5 + 1);
                  }
LAB_1018_02cb:
                  if (0 < i) {
                    ini.cTurnGen = i + -1;
                  }
                  break;
                case 'H':
                case 'h':
                  gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfdff | 0x200;
                  break;
                case 'L':
                case 'l':
                  ini.wFlags = ini.wFlags & 0x7fff | 0x8000;
                  break;
                case 'P':
                case 'p':
                  lpT = (char *)lpT + 1;
                  while (*lpT == ' ') {
                    lpT = (char *)lpT + 1;
                  }
                  pch = (char *)szPassLast;
                  while( true ) {
                    if (((*lpT == '\0') || (*lpT == ' ')) ||
                       ((char *)szPassLast + 0xe < pch)) break;
                    *pch = *lpT;
                    pch = pch + 1;
                    lpT = (char *)lpT + 1;
                  }
                  *pch = '\0';
                  lpT = (char *)lpT + -1;
                  lVar9 = LSaltFromSz((char *)szPassLast);
                  lSaltLast = lVar9;
                  break;
                case 'T':
                case 't':
                  ini.wFlags = ini.wFlags & 0xffef | 0x10;
                  break;
                case 'V':
                case 'v':
                  ini.wFlags = ini.wFlags & 0xbfff | 0x4000;
                  break;
                case 'W':
                case 'w':
                  ini.wFlags = ini.wFlags & 0xfffb | 4;
                  break;
                case 'X':
                case 'x':
                  gd.grBits._2_2_ = gd.grBits._2_2_ & 0xffbf | 0x40;
                }
                lpT = (char *)lpT + 1;
              }
            }
            else {
              pch = (char *)szBase;
              while ((*lpT != '\0' && (*lpT != ' '))) {
                *pch = *lpT;
                pch = pch + 1;
                lpT = (char *)lpT + 1;
              }
              *pch = '\0';
              ini.wFlags = ini.wFlags & 0xfffc | 3;
            }
          }
          uVar8 = 0x14f8;
          PostMessage(hwndFrame,0x464,0,0);
          pHVar3 = &stack0xffdc;
LAB_1018_058a:
          while( true ) {
            pHVar7 = pHVar3;
            pHVar7[-1] = unaff_SS;
            pHVar7[-2] = (HACCEL)&msg;
            pHVar7[-3] = 0;
            pHVar7[-4] = 0;
            pHVar7[-5] = 0;
            pHVar7[-6] = uVar8;
            pHVar7[-7] = 0x5a2;
            BVar6 = GetMessage(*(MSG **)(pHVar7 + -2),pHVar7[-3],pHVar7[-4],pHVar7[-5]);
            if (BVar6 == 0) break;
            if (hwndTitle == 0) {
              pHVar7[1] = hwndFrame;
              *pHVar7 = 0x14f8;
              pHVar7[-1] = 0x5f4;
              BVar6 = IsIconic(pHVar7[1]);
              if (BVar6 == 0) goto LAB_1018_05fc;
              goto LAB_1018_0618;
            }
            pHVar7[1] = hwndFrame;
            *pHVar7 = hAccelTitle;
            pHVar7[-1] = unaff_SS;
            pHVar7[-2] = (HACCEL)&msg;
            pHVar7[-3] = 0x14f8;
            pHVar7[-4] = 0x5c8;
            sVar4 = TranslateAccelerator(pHVar7[1],*pHVar7,*(MSG **)(pHVar7 + -2));
            if (sVar4 == 0) {
              pHVar7[1] = unaff_SS;
              *pHVar7 = (HACCEL)&msg;
              pHVar7[-1] = 0x14f8;
              pHVar7[-2] = 0x5dc;
              TranslateMessage(*(MSG **)pHVar7);
              pHVar7[1] = unaff_SS;
              *pHVar7 = (HACCEL)&msg;
              pHVar7[-1] = 0x14f8;
              pHVar7[-2] = 0x5e8;
              DispatchMessage(*(MSG **)pHVar7);
            }
            uVar8 = 0x14f8;
            pHVar3 = pHVar7 + 2;
          }
          pHVar7[1] = 0x14f8;
          *pHVar7 = 0x695;
          FreeStuff();
          lVar9 = lSaltLast;
        }
      }
    }
  }
  lSaltLast._2_2_ = (undefined2)((ulong)lVar9 >> 0x10);
  lSaltLast._0_2_ = (undefined2)lVar9;
  return msg.wParam;
LAB_1018_05fc:
  *pHVar7 = hwndFrame;
  pHVar7[-1] = hAccel;
  pHVar7[-2] = unaff_SS;
  pHVar7[-3] = (HACCEL)&msg;
  pHVar7[-4] = 0x14f8;
  uVar8 = 0x14f8;
  pHVar7[-5] = 0x610;
  sVar4 = TranslateAccelerator(*pHVar7,pHVar7[-1],*(MSG **)(pHVar7 + -3));
  pHVar3 = pHVar7 + 1;
  if (sVar4 == 0) {
LAB_1018_0618:
    *pHVar7 = unaff_SS;
    pHVar7[-1] = (HACCEL)&msg;
    pHVar7[-2] = 0x14f8;
    uVar8 = 0x14f8;
    pHVar7[-3] = 0x624;
    TranslateMessage(*(MSG **)(pHVar7 + -1));
    uVar2 = (undefined2)msg.lParam;
    if ((msg.message == 0x100) || (msg.message == 0x101)) {
      *pHVar7 = msg.lParam._2_2_;
      pHVar7[-1] = uVar2;
      pHVar7[-2] = msg.wParam;
      pHVar7[-3] = msg.message;
      pHVar7[-4] = msg.hwnd;
      pHVar7[-5] = 0x14f8;
      uVar8 = 0x1018;
      pHVar7[-6] = 0x650;
      sVar4 = FHandleKey(pHVar7[-4],pHVar7[-3],pHVar7[-2],*(ulong *)(pHVar7 + -1));
      pHVar3 = pHVar7 + 1;
      if (sVar4 != 0) goto LAB_1018_058a;
    }
    if (msg.message == 0x102) {
      *pHVar7 = msg.lParam._2_2_;
      pHVar7[-1] = (undefined2)msg.lParam;
      pHVar7[-2] = msg.wParam;
      pHVar7[-3] = msg.hwnd;
      pHVar7[-4] = uVar8;
      uVar8 = 0x1018;
      pHVar7[-5] = 0x676;
      sVar4 = FHandleChar(pHVar7[-3],pHVar7[-2],*(long *)(pHVar7 + -1));
      pHVar3 = pHVar7 + 1;
      if (sVar4 != 0) goto LAB_1018_058a;
    }
    *pHVar7 = unaff_SS;
    pHVar7[-1] = (HACCEL)&msg;
    pHVar7[-2] = uVar8;
    uVar8 = 0x14f8;
    pHVar7[-3] = 0x68d;
    DispatchMessage(*(MSG **)(pHVar7 + -1));
    pHVar3 = pHVar7 + 1;
  }
  goto LAB_1018_058a;
}



// ======================================================================
// Function: FSetUpBatchProcessing
// Address: 1018:06a4
// Segment: MEMORY_MAIN
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short FSetUpBatchProcessing(void)

{
  short sVar1;
  ushort cb_00;
  long lVar2;
  short cb;
  short fSuccess;
  short env [9];
  char *pch;
  
  fSuccess = 0;
  penvMem = &env;
  sVar1 = __setjmp(env);
  if (sVar1 == 0) {
    StreamOpen((char *)szBase,0x20);
    lVar2 = __filelength(hf);
    cb_00 = (ushort)lVar2;
    _lpchBatch = LpAlloc(cb_00,htPerm);
    RgFromStream(_lpchBatch,cb_00);
    _lpchBatchMac = _lpchBatch + cb_00;
    iRam112051b2 = lpchBatch_2;
    pch = (char *)szBase;
    while( true ) {
      if ((*_lpchBatch == '\n') ||
         ((_lpchBatch == _lpchBatchMac && (lpchBatch_2 == iRam112051b2)))) break;
      *pch = *_lpchBatch;
      _lpchBatch = _lpchBatch + 1;
      pch = pch + 1;
    }
    _lpchBatch = _lpchBatch + 1;
    pch[-1] = '\0';
    fSuccess = 1;
  }
  penvMem = (short (*) [9])0x0;
  StreamClose();
  if (fSuccess == 0) {
    szBase[0] = '\0';
  }
  return fSuccess;
}



// ======================================================================
// Function: IPlrAlsoCheater
// Address: 1018:07aa
// Segment: MEMORY_MAIN
// ======================================================================


short IPlrAlsoCheater(short iplr)

{
  short sVar1;
  short i;
  
  sVar1 = FValidSerialLong
                    (CONCAT22(*(undefined2 *)
                               ((int)&((TURNSERIAL *)vrgts)[iplr].lSerialNumber + 2),
                              (int)((TURNSERIAL *)vrgts + iplr)->lSerialNumber));
  if (sVar1 != 0) {
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if ((i != iplr) && ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 2 & 1) != 0)) {
        if (((int)((TURNSERIAL *)vrgts + iplr)->lSerialNumber ==
             (int)((TURNSERIAL *)vrgts + i)->lSerialNumber) &&
           ((*(int *)((int)&((TURNSERIAL *)vrgts)[iplr].lSerialNumber + 2) ==
             *(int *)((int)&((TURNSERIAL *)vrgts)[i].lSerialNumber + 2) &&
            (sVar1 = __fmemcmp((byte *)CONCAT22(vrgts._2_2_,
                                                        ((TURNSERIAL *)vrgts)[iplr].rgbConfig
                                                       ),
                                       (byte *)CONCAT22(vrgts._2_2_,
                                                        ((TURNSERIAL *)vrgts)[i].rgbConfig),
                                       0xb), sVar1 != 0)))) {
          return i;
        }
      }
    }
  }
  return -1;
}



// ======================================================================
// Function: FGetSystemColors
// Address: 1018:08d2
// Segment: MEMORY_MAIN
// ======================================================================


short FGetSystemColors(void)

{
  char *pcVar1;
  HDC HVar2;
  short sVar3;
  short sVar4;
  undefined2 uVar5;
  COLORREF CVar6;
  char *pcVar7;
  ulong uVar8;
  undefined2 uVar9;
  undefined2 uVar10;
  ushort uVar11;
  HDC hdc;
  
  if (hbrButtonFace != 0) {
    FreeHbr(hbrButtonFace);
  }
  if (hbrButtonHilite != 0) {
    FreeHbr(hbrButtonHilite);
  }
  if (hbrButtonShadow != 0) {
    FreeHbr(hbrButtonShadow);
  }
  if (hbrButtonText != 0) {
    FreeHbr(hbrButtonText);
  }
  if (hbrWindowText != 0) {
    FreeHbr(hbrWindowText);
  }
  if (hbrWindow != 0) {
    FreeHbr(hbrWindow);
  }
  if (hbrWindowFrame != 0) {
    FreeHbr(hbrWindowFrame);
  }
  if (hbrDesktop != 0) {
    FreeHbr(hbrDesktop);
  }
  crButtonFace = GetSysColor(0xf);
  hbrButtonFace = HbrGet(crButtonFace);
  crButtonHilite = GetSysColor(0x14);
  hbrButtonHilite = HbrGet(crButtonHilite);
  crButtonShadow = GetSysColor(0x10);
  hbrButtonShadow = HbrGet(crButtonShadow);
  crButtonText = GetSysColor(0x12);
  hbrButtonText = HbrGet(crButtonText);
  CVar6 = GetSysColor(6);
  hbrWindowFrame = HbrGet(CVar6);
  CVar6 = GetSysColor(1);
  hbrDesktop = HbrGet(CVar6);
  crWindow = GetSysColor(5);
  hbrWindow = HbrGet(crWindow);
  crWindowText = GetSysColor(8);
  hbrWindowText = HbrGet(crWindowText);
  uVar11 = 4;
  dyTitleBar = GetSystemMetrics(4);
  uVar10 = 0x20;
  dxWinFrame = GetSystemMetrics(0x20);
  uVar9 = 0x21;
  dyWinFrame = GetSystemMetrics(0x21);
  if (hdibPlaque != 0) {
    pcVar7 = GlobalLock(hdibPlaque);
    uVar5 = (undefined2)((ulong)pcVar7 >> 0x10);
    pcVar1 = (char *)pcVar7;
    pcVar1[0x40e] = (char)crButtonFace;
    pcVar1[0x40d] = (char)(crButtonFace >> 8);
    uVar8 = __aFulshr(CONCAT22(uVar10,uVar9),uVar11);
    pcVar1[0x40c] = (char)uVar8;
    GlobalUnlock(hdibPlaque);
  }
  if (hdibToolbar != 0) {
    pcVar7 = GlobalLock(hdibToolbar);
    uVar5 = (undefined2)((ulong)pcVar7 >> 0x10);
    pcVar1 = (char *)pcVar7;
    pcVar1[0x41e] = (char)crButtonFace;
    pcVar1[0x41d] = (char)(crButtonFace >> 8);
    uVar8 = __aFulshr(CONCAT22(uVar10,uVar9),uVar11);
    pcVar1[0x41c] = (char)uVar8;
    GlobalUnlock(hdibToolbar);
  }
  HVar2 = GetDC(0);
  sVar3 = GetDeviceCaps(HVar2,0xc);
  sVar4 = GetDeviceCaps(HVar2,0xe);
  vcScreenColors = sVar3 * sVar4;
  ReleaseDC(0,HVar2);
  return 1;
}



// ======================================================================
// Function: FreeStuff
// Address: 1018:0bae
// Segment: MEMORY_MAIN
// ======================================================================


void FreeStuff(void)

{
  HCURSOR HVar1;
  short j;
  short i;
  
  if (hbrButtonFace != 0) {
    FreeHbr(hbrButtonFace);
  }
  if (hbrButtonHilite != 0) {
    FreeHbr(hbrButtonHilite);
  }
  if (hbrButtonShadow != 0) {
    FreeHbr(hbrButtonShadow);
  }
  if (hbrButtonText != 0) {
    FreeHbr(hbrButtonText);
  }
  if (hbrWindowText != 0) {
    FreeHbr(hbrWindowText);
  }
  if (hbrWindow != 0) {
    FreeHbr(hbrWindow);
  }
  if (hbrWindowFrame != 0) {
    FreeHbr(hbrWindowFrame);
  }
  if (hbrDesktop != 0) {
    FreeHbr(hbrDesktop);
  }
  if (hbrRed != 0) {
    FreeHbr(hbrRed);
  }
  if (hbrGreen != 0) {
    FreeHbr(hbrGreen);
  }
  if (hbrBlue != 0) {
    FreeHbr(hbrBlue);
  }
  if (hbrPurple != 0) {
    FreeHbr(hbrPurple);
  }
  if (hbrTooltip != 0) {
    FreeHbr(hbrTooltip);
  }
  for (i = 0; i < 5; i = i + 1) {
    if (((ushort *)rghbrMineral)[i] != 0) {
      FreeHbr(((ushort *)rghbrMineral)[i]);
    }
  }
  for (i = 0; i < 3; i = i + 1) {
    for (j = 0; j < 2; j = j + 1) {
      FreeHbr(((ushort (*) [2])rghbrPlanetAttr)[i][j]);
    }
  }
  for (i = 0; i < 4; i = i + 1) {
    for (j = 0; j < 2; j = j + 1) {
      FreeHbr(((ushort (*) [2])rghbrMinSum)[i][j]);
    }
  }
  FreeProcInstance((fn_lpfnFakeComboProc *)
                   CONCAT22(lpfnFakeComboProc._2_2_,
                            (fn_lpfnFakeComboProc *)lpfnFakeComboProc));
  FreeProcInstance((fn_lpfnFakeCEProc *)
                   CONCAT22(lpfnFakeCEProc._2_2_,
                            (fn_lpfnFakeCEProc *)lpfnFakeCEProc));
  FreeProcInstance((fn_lpfnFakeEditProc *)
                   CONCAT22(lpfnFakeEditProc._2_2_,
                            (fn_lpfnFakeEditProc *)lpfnFakeEditProc));
  FreeProcInstance((fn_lpfnFakeListProc *)
                   CONCAT22(lpfnFakeListProc._2_2_,
                            (fn_lpfnFakeListProc *)lpfnFakeListProc));
  FreeProcInstance((fn_lpfnHostTimerProc *)
                   CONCAT22(lpfnHostTimerProc._2_2_,
                            (fn_lpfnHostTimerProc *)lpfnHostTimerProc));
  FreeProcInstance((fn_lpfnBrowserDlgProc *)
                   CONCAT22(lpfnBrowserDlgProc._2_2_,
                            (fn_lpfnBrowserDlgProc *)lpfnBrowserDlgProc));
  if (((fn_lpfnTutorDlgProc *)lpfnTutorDlgProc != (fn_lpfnTutorDlgProc *)0x0) ||
     (lpfnTutorDlgProc._2_2_ != 0)) {
    FreeProcInstance((fn_lpfnTutorDlgProc *)
                     CONCAT22(lpfnTutorDlgProc._2_2_,
                              (fn_lpfnTutorDlgProc *)lpfnTutorDlgProc));
  }
  DeleteObject(hrgnHuge);
  DeleteObject(hrgnScratch);
  HVar1 = LoadCursor(0,(LPCSTR)0x7f00);
  setcursor(HVar1);
  DestroyCursor(hcurScanner);
  DestroyCursor(hcurOpenGrab);
  DestroyCursor(hcurCloseGrab);
  DestroyCursor(hcurScanAdd);
  DestroyCursor(hcurTrashCan);
  DestroyCursor(hcurNoWay);
  DestroyCursor(hcurResizeWE);
  DestroyCursor(hcurResizeNS);
  DestroyCursor(hcurResize4Way);
  DestroyCursor(hcurArrowHelp);
  DestroyCursor(hcurHand);
  DeleteObject(hbmpScanner);
  DeleteObject(hbmpNumbers);
  DeleteObject(hbmpScanShip);
  DeleteObject(hbmpUnknownPlanet);
  DestroyIcon(hiconStars);
  DestroyIcon(hiconHost);
  DestroyIcon(hiconWait);
  for (i = 0; i < 7; i = i + 1) {
    DestroyIcon(((ushort *)rghiconVCR)[i]);
  }
  GlobalUnlock(hdibPlanets);
  FreeResource(hdibPlanets);
  GlobalUnlock(hdibThings);
  FreeResource(hdibThings);
  GlobalUnlock(hdibToolbar);
  FreeResource(hdibToolbar);
  GlobalUnlock(hdibRaces);
  FreeResource(hdibRaces);
  GlobalUnlock(hdibRacesT);
  FreeResource(hdibRacesT);
  GlobalUnlock(hdibRacesX);
  FreeResource(hdibRacesX);
  DeleteObject(hbmpBackBld);
  DeleteObject(hbmpMsg);
  DeleteObject(hbmpMono);
  FreeResource(hdibPlaque);
  for (i = 0; i < 5; i = i + 1) {
    GlobalUnlock(((ushort *)rghdibShips)[i]);
    FreeResource(((ushort *)rghdibShips)[i]);
    GlobalUnlock(((ushort *)rghdibShipsT)[i]);
    FreeResource(((ushort *)rghdibShipsT)[i]);
  }
  for (i = 0; i < 7; i = i + 1) {
    GlobalUnlock(((ushort *)rghdibInventory)[i]);
    FreeResource(((ushort *)rghdibInventory)[i]);
  }
  FreeLp((byte *)CONCAT22(lpLog._2_2_,(byte *)lpLog),htLog);
  lpLog._0_2_ = (byte *)0x0;
  lpLog._2_2_ = 0;
  FreeLp((short *)CONCAT22(lpMsg._2_2_,(short *)lpMsg),htMsg);
  lpMsg._0_2_ = (short *)0x0;
  lpMsg._2_2_ = 0;
  DeleteObject(vhpal);
  if (vhpalSplash != 0) {
    DeleteObject(vhpalSplash);
  }
  FreeHbr(hbrShip);
  FreeHbr(hbrStarbase);
  FreeHbr(hbrBBlue);
  FreeHbr(hbrEnemy);
  FreeHbr(hbrSelect);
  FreeHbr(hbrRadar);
  if (hbrRadarNear != 0) {
    FreeHbr(hbrRadarNear);
  }
  FreeHbr(hbrLightGray);
  FreeHbr(hbrGray);
  FreeHbr(hbrYellow);
  FreeHbr(hbrDkYellow);
  DeleteObject(hbr50Screen);
  for (i = 0; i < 3; i = i + 1) {
    DeleteObject(((ushort *)rghbrPat)[i]);
  }
  DeleteObject(hbrCargo);
  DeleteObject(hbrDock);
  DeleteObject(hpenShip);
  DeleteObject(hpenDkGreen);
  DeleteObject(hpenDkPurple);
  DeleteObject(hpenStarbase);
  DeleteObject(hpenEnemy);
  DeleteObject(hpenMassPath);
  DeleteObject(hpenRadar);
  if (hpenRadarNear != 0) {
    DeleteObject(hpenRadarNear);
  }
  DeleteObject(hpenDkBlue);
  DeleteObject(hpenYellow);
  DeleteObject(hpenDkYellow);
  DeleteObject(rghfontArial10[0]);
  DeleteObject(rghfontArial10[1]);
  for (i = 0; i < 5; i = i + 1) {
    DeleteObject(((ushort *)rghfontArial8)[i]);
  }
  DeleteObject(rghfontArial6[0]);
  DeleteObject(rghfontArial7[0]);
  for (i = 0; i < 0xc; i = i + 1) {
    FreeHb((HB *)CONCAT22(*(undefined2 *)(i * 4 + rglphb_0x2),
                                  (HB *)*(undefined2 *)(i * 4 + rglphb)));
  }
  return;
}



// ======================================================================
// Function: SzVersion
// Address: 1018:1212
// Segment: MEMORY_MAIN
// ======================================================================


char * SzVersion(void)

{
  char *pcVar1;
  undefined2 uVar2;
  undefined2 uVar3;
  undefined2 uVar4;
  
  uVar4 = 0x6a;
  uVar3 = 0x3c;
  uVar2 = 2;
  pcVar1 = PszGetCompressedString(idsVersionD02dC);
  _wsprintf(szWork,pcVar1,uVar2,uVar3,uVar4);
  return (char *)szWork;
}



// ======================================================================
// Function: About
// Address: 1018:1252
// Segment: MEMORY_MAIN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: hwndCtl */

short About(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  HWND HVar1;
  char *pcVar2;
  short sVar3;
  HDC hdc;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar4;
  FARPROC pvVar5;
  HWND hwndCtl;
  short local_10;
  RECT rc;
  
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    sVar3 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      uVar4 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),hwndCtl);
      if ((int)uVar4 == 6) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        iAbout1st = -0xb;
        iAboutPartial = 0;
        HVar1 = GetDlgItem(hwnd,0x401);
        pcVar2 = SzVersion();
        SetWindowText(HVar1,pcVar2);
        uTimerId = SetTimer(0xe,0x32,0,0);
        return 1;
      }
      if (message == WM_COMMAND) {
        if ((wParam == 1) || (wParam == 2)) {
          KillTimer(hwnd,uTimerId);
          uTimerId = 0;
          EndDialog(hwnd,1);
          return 1;
        }
        if (wParam == 0x76) {
          pvVar5 = MakeProcInstance(OrderInfoDlg,hInst);
          DialogBox(0,(LPCSTR)CONCAT22(0x61,hwnd),(HWND)((ulong)pvVar5 >> 0x10),(char)pvVar5);
          FreeProcInstance(pvVar5);
        }
      }
      else if (message == WM_TIMER) {
        HVar1 = GetDlgItem(hwnd,0x41f);
        iAboutPartial = iAboutPartial + 2;
        if (dyArial8 <= iAboutPartial) {
          iAboutPartial = 0;
          iAbout1st = iAbout1st + 1;
          if (0x4e < iAbout1st) {
            iAbout1st = -0xb;
          }
        }
        GetClientRect(HVar1,&rc);
        hdc = GetDC(HVar1);
        SelectObject(hdc,rghfontArial8[1]);
        SetBkMode(hdc,2);
        SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        IntersectClipRect(hdc,0,0,rc.right,rc.bottom);
        rc.top = rc.top - iAboutPartial;
        rc.bottom = rc.top + dyArial8;
        for (local_10 = iAbout1st; local_10 < iAbout1st + 10;
            local_10 = local_10 + 1) {
          if ((local_10 < 0) || (0x4c < local_10)) {
            if (0x4c < local_10) break;
          }
          else {
            sVar3 = -1;
            pcVar2 = PszGetCompressedString(local_10 + idsDesignProgramming);
            RcCtrTextOut(hdc,&rc,pcVar2,sVar3);
          }
          OffsetRect(&rc,0,dyArial8);
        }
        rc.bottom = 1000;
        FillRect(hdc,&rc,hbrButtonFace);
        SelectClipRgn(hdc,0);
        ReleaseDC(hwnd,hdc);
      }
    }
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: OrderInfoDlg
// Address: 1018:151e
// Segment: MEMORY_MAIN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: rc */

short OrderInfoDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  short sVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar2;
  RECT rc;
  
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    sVar1 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      uVar2 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),rc.left);
      if ((int)uVar2 == 6) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else if ((message == WM_COMMAND) && ((wParam == 2 || (wParam == 1)))) {
      EndDialog(hwnd,1);
      return 1;
    }
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: FHandleChar
// Address: 1018:15de
// Segment: MEMORY_MAIN
// ======================================================================


short FHandleChar(HWND hwnd,ushort ch,long lParam)

{
  HWND HVar1;
  short sVar2;
  HWND hwndF;
  
  if (((((hwndScanner == 0) || ((ch != 0x2b && (ch != 0x2d)))) && (ch != 0x76)) &&
      (ch != 0x56)) ||
     ((HVar1 = GetFocus(), hwndMessage != 0 && (HVar1 == hwndMsgEdit)))) {
    sVar2 = 0;
  }
  else {
    SendMessage(hwndScanner,0x102,ch,lParam);
    sVar2 = 1;
  }
  return sVar2;
}



// ======================================================================
// Function: FHandleKey
// Address: 1018:165a
// Segment: MEMORY_MAIN
// ======================================================================


short FHandleKey(HWND hwnd,short iMsg,short iKey,ulong dw)

{
  POINT PVar1;
  HWND HVar2;
  short sVar3;
  uint uVar4;
  undefined2 uVar5;
  undefined1 *puVar6;
  undefined1 *puVar7;
  undefined2 unaff_SS;
  HWND hwndOver;
  POINT local_a;
  HWND hwndF;
  
  uVar5 = 0x1018;
  if (iMsg == 0x100) {
    if ((iKey == 0x1b) && (hwndBrowser != 0)) {
      uVar5 = 0x14f8;
      HVar2 = GetActiveWindow();
      if (HVar2 == hwndBrowser) {
        DestroyWindow(hwndBrowser);
        return 1;
      }
    }
    if ((iKey == 0x1b) && (hwndPopup != 0)) {
      SendMessage(hwndPopup,0x202,0,0);
      return 1;
    }
    if ((iKey == 0x1b) && (hwndReportDlg != 0)) {
      DestroyWindow(hwndReportDlg);
      return 1;
    }
  }
  else if (((iMsg == 0x101) && (hwndTb != 0)) && ((iKey == 0x1b || (iKey == 0xd)))) {
    HVar2 = GetFocus();
    hwndF = GetParent(HVar2);
    if (hwndF != hwndTb) {
      uVar5 = 0x14f8;
      HVar2 = GetParent(hwndF);
      if (HVar2 != hwndTb) goto LAB_1018_175f;
    }
    uVar5 = 0x1068;
    TerminateToolbarFocus((uint)(iKey == 0x1b));
  }
LAB_1018_175f:
  puVar6 = &stack0xffee;
  if ((iKey == 0x10) && (puVar6 = &stack0xffee, hwndScanner != 0)) {
    GetCursorPos(&local_a);
    uVar5 = 0x14f8;
    PVar1.y = local_a.y;
    PVar1.x = local_a.x;
    HVar2 = WindowFromPoint(PVar1);
    puVar6 = &stack0xffea;
    if (HVar2 == hwndScanner) {
      uVar5 = 0x14f8;
      SendMessage(HVar2,0x20,HVar2,0);
      puVar6 = &stack0xffea;
    }
  }
  if (iMsg != 0x100) {
    return 0;
  }
  if ((((((iKey != 8) && (iKey != 0x2e)) && (iKey != 0x28)) && ((iKey != 0x26 && (iKey != 0x24))))
      && (iKey != 0x23)) &&
     (((iKey < 0x30 || (0x39 < iKey)) &&
      ((iKey != 0xbc && (((iKey != 0xbe && (iKey != 0xdb)) && (iKey != 0xdd)))))))) {
    return 0;
  }
  *(undefined2 *)(puVar6 + -2) = uVar5;
  *(undefined2 *)(puVar6 + -4) = 0x1839;
  hwndF = GetFocus();
  if (hwndMessage != 0) {
    if (hwndTb != 0) {
      if (hwndTb == hwndF) {
        return 0;
      }
      *(HWND *)(puVar6 + -2) = hwndF;
      *(undefined2 *)(puVar6 + -4) = 0x14f8;
      *(undefined2 *)(puVar6 + -6) = 0x1864;
      HVar2 = GetParent(*(HWND *)(puVar6 + -2));
      if (HVar2 == hwndTb) {
        return 0;
      }
      *(HWND *)(puVar6 + -2) = hwndF;
      *(undefined2 *)(puVar6 + -4) = 0x14f8;
      *(undefined2 *)(puVar6 + -6) = 0x1875;
      HVar2 = GetParent(*(HWND *)(puVar6 + -2));
      *(HWND *)(puVar6 + -2) = HVar2;
      *(undefined2 *)(puVar6 + -4) = 0x14f8;
      *(undefined2 *)(puVar6 + -6) = 0x187b;
      HVar2 = GetParent(*(HWND *)(puVar6 + -2));
      if (HVar2 == hwndTb) {
        return 0;
      }
    }
    for (local_a.y = 0; local_a.y < 3; local_a.y = local_a.y + 1) {
      if (hwndF == ((ushort *)rghwndOrderDD)[local_a.y]) {
        return 0;
      }
    }
    if ((((hwndF == hwndFleetCompLB) || (hwndF == hwndPlanetProdLB)) ||
        ((hwndF == hwndMsgEdit ||
         ((hwndF == hwndMsgDrop || (hwndF == hwndOrderED)))))) ||
       ((hwndF == hwndMsgScroll ||
        ((hwndF == hwndFleetCompLB || (hwndF == hwndShipDD)))))) {
      return 0;
    }
    if (hwndBrowser != 0) {
      *(HWND *)(puVar6 + -2) = hwndBrowser;
      *(undefined2 *)(puVar6 + -4) = 0x10b;
      *(undefined2 *)(puVar6 + -6) = 0x14f8;
      *(undefined2 *)(puVar6 + -8) = 0x192b;
      HVar2 = GetDlgItem(*(HWND *)(puVar6 + -2),*(short *)(puVar6 + -4));
      if (hwndF == HVar2) {
        return 0;
      }
    }
  }
  if ((0x2f < iKey) && (iKey < 0x3a)) {
    if ((0x30 < iKey) && (iKey < 0x37)) {
      local_a.x = iKey - 0x31U;
      if (iKey - 0x31U != (grbitScan & 0xf)) {
        *(undefined2 *)(puVar6 + -2) = 1;
        *(short *)(puVar6 + -4) = iKey + -0x31;
        *(undefined2 *)(puVar6 + -6) = 0x14f8;
        *(undefined2 *)(puVar6 + -8) = 0x1984;
        ExecuteButton(*(short *)(puVar6 + -4),*(short *)(puVar6 + -2));
        *(HWND *)(puVar6 + -2) = hwndTb;
        *(undefined2 *)(puVar6 + -4) = 0;
        *(undefined2 *)(puVar6 + -6) = 0;
        *(undefined2 *)(puVar6 + -8) = 0;
        *(undefined2 *)(puVar6 + -10) = 0x1068;
        *(undefined2 *)(puVar6 + -0xc) = 0x199c;
        InvalidateRect(*(HWND *)(puVar6 + -2),*(RECT **)(puVar6 + -6),*(BOOL *)(puVar6 + -8));
      }
      return 1;
    }
    if (iKey == 0x30) {
      *(undefined2 *)(puVar6 + -2) = 0x10;
      *(undefined2 *)(puVar6 + -4) = 0x14f8;
      *(undefined2 *)(puVar6 + -6) = 0x19c9;
      sVar3 = GetKeyState(*(short *)(puVar6 + -2));
      puVar7 = puVar6 + -2;
      if (sVar3 < 0) {
        local_a.y = 0x11;
      }
      else {
        local_a.y = 0xb;
        puVar7 = puVar6 + -2;
      }
    }
    else {
      puVar7 = puVar6;
      if (iKey == 0x37) {
        local_a.y = 7;
      }
      else if (iKey == 0x38) {
        local_a.y = 8;
      }
      else if (iKey == 0x39) {
        local_a.y = 9;
      }
    }
    *(short *)(puVar7 + -2) = local_a.y;
    *(undefined2 *)(puVar7 + -4) = 0x14f8;
    *(undefined2 *)(puVar7 + -6) = 0x1a0f;
    sVar3 = FIsButtonDown(*(short *)(puVar7 + -2));
    *(uint *)(puVar7 + -2) = (uint)(sVar3 == 0);
    *(short *)(puVar7 + -4) = local_a.y;
    *(undefined2 *)(puVar7 + -6) = 0x1068;
    *(undefined2 *)(puVar7 + -8) = 0x1a2c;
    ExecuteButton(*(short *)(puVar7 + -4),*(short *)(puVar7 + -2));
    *(HWND *)(puVar7 + -2) = hwndTb;
    *(undefined2 *)(puVar7 + -4) = 0;
    *(undefined2 *)(puVar7 + -6) = 0;
    *(undefined2 *)(puVar7 + -8) = 0;
    *(undefined2 *)(puVar7 + -10) = 0x1068;
    *(undefined2 *)(puVar7 + -0xc) = 0x1a44;
    InvalidateRect(*(HWND *)(puVar7 + -2),*(RECT **)(puVar7 + -6),*(BOOL *)(puVar7 + -8));
    return 1;
  }
  if (iKey != 8) {
    if ((((iKey == 0x23) || (iKey == 0x24)) || (iKey == 0x26)) || (iKey == 0x28)) {
      if (hwndF != hwndShipLB) {
        *(HWND *)(puVar6 + -2) = hwndMessage;
        *(undefined2 *)(puVar6 + -4) = 0x100;
        *(short *)(puVar6 + -6) = iKey;
        *(undefined2 *)(puVar6 + -8) = dw._2_2_;
        *(undefined2 *)(puVar6 + -10) = (undefined2)dw;
        *(undefined2 *)(puVar6 + -0xc) = 0x14f8;
        *(undefined2 *)(puVar6 + -0xe) = 0x1a9e;
        SendMessage(*(HWND *)(puVar6 + -2),*(UINT *)(puVar6 + -4),*(WPARAM *)(puVar6 + -6),
                    *(LPARAM *)(puVar6 + -10));
        return 1;
      }
      return 0;
    }
    if (iKey != 0x2e) {
      if ((iKey == 0xbc) || (iKey == 0xbe)) {
        if ((sel.grobj == grobjFleet) &&
           ((0 < sel.iwpAct || (1 < sel.fl.cord)))) {
          local_a.x = sel.iwpAct;
          if (sel.iwpAct < 1) {
            local_a.x = 1;
          }
          uVar4 = *(uint *)((int)(PLORD *)sel.fl.lpplord + local_a.x * 0x12 + 10) >> 4 &
                  0xf;
          if (iKey == 0xbc) {
            local_a.y = uVar4 - 1;
          }
          else {
            local_a.y = uVar4 + 1;
          }
          if ((-1 < local_a.y) && (local_a.y < 0xc)) {
            *(uint *)((int)(PLORD *)sel.fl.lpplord + local_a.x * 0x12 + 10) =
                 *(uint *)((int)(PLORD *)sel.fl.lpplord + local_a.x * 0x12 + 10) & 0xff0f
                 | (local_a.y & 0xfU) << 4;
            *(undefined2 *)(puVar6 + -2) = 0x4972;
            *(undefined2 *)(puVar6 + -4) = 0xffff;
            *(undefined2 *)(puVar6 + -6) = 0x14f8;
            *(undefined2 *)(puVar6 + -8) = 0x1b87;
            FLookupFleet(*(short *)(puVar6 + -4),*(FLEET **)(puVar6 + -2));
            *(undefined2 *)(puVar6 + -2) = 0x4220;
            *(undefined2 *)(puVar6 + -4) = 0;
            *(undefined2 *)(puVar6 + -6) = 0x1038;
            *(undefined2 *)(puVar6 + -8) = 0x1b97;
            DrawPlanShip(*(HDC *)(puVar6 + -4),*(short *)(puVar6 + -2));
          }
        }
        return 1;
      }
      if ((iKey != 0xdb) && (iKey != 0xdd)) {
        return 0;
      }
      local_a.x = 0;
      local_a.y = 0;
      if (iKey == 0xdb) {
        uVar5 = 0xfffe;
      }
      else {
        uVar5 = 0xffff;
      }
      *(undefined2 *)(puVar6 + -2) = uVar5;
      *(undefined2 *)(puVar6 + -4) = 0;
      *(undefined2 *)(puVar6 + -6) = 2;
      *(short *)(puVar6 + -8) = local_a.y;
      *(short *)(puVar6 + -10) = local_a.x;
      *(undefined2 *)(puVar6 + -0xc) = 0x14f8;
      *(undefined2 *)(puVar6 + -0xe) = 0x1bd1;
      ExecuteReportClick
                (*(puVar6 + -10),*(short *)(puVar6 + -6),*(short *)(puVar6 + -4),
                 *(short *)(puVar6 + -2));
      return 1;
    }
  }
  if (sel.grobj == grobjFleet) {
    *(undefined2 *)(puVar6 + -2) = 8;
    *(undefined2 *)(puVar6 + -4) = 0x14f8;
    *(undefined2 *)(puVar6 + -6) = 0x1a6e;
    DeleteCurWayPoint(*(short *)(puVar6 + -2));
  }
  return 1;
}



