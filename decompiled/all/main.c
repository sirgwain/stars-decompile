// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: WinMain
// Address: 1018:0000
// Segment: MEMORY_MAIN
// ======================================================================


short WinMain(HINSTANCE hInstance,ushort hPrevInstance,char *lpCmdLine,short nCmdShow)

{
  char cVar1;
  short sVar2;
  char *pcVar3;
  BOOL BVar4;
  undefined2 uVar5;
  undefined2 unaff_SS;
  DWORD dw;
  long lVar6;
  MSG msg;
  short i;
  char *lpT;
  char *pch;
  
                    /* Segment:    4
                       Offset:     000118c0
                       Length:     1c3c
                       Min Alloc:  1c3c
                       Flags:      1d50
                           Code
                           Discardable
                           Moveable
                           Preload
                           Impure (Non-shareable)
                        */
  hInst = hInstance;
  szBase[0] = '\0';
  ini.wFlags = 0;
  _memset((TUTOR *)&tutor,0,0x2c);
  _memset((TIMER *)&vtimer,0,10);
  vtimer.fAutoGenWhenIn = 1;
  if ((hPrevInstance == 0) && (sVar2 = InitMDIApp(), sVar2 == 0)) {
    sVar2 = 0x10;
    pcVar3 = PszFormatIds(idsUnableInitializeStars,(short *)0x0);
    AlertSz(pcVar3,sVar2);
    lVar6 = CONCAT22(lSaltLast._2_2_,(undefined2)lSaltLast);
    msg.wParam = 0;
  }
  else {
    dw = GetTickCount();
    Randomize2(dw);
    sVar2 = FCreateStuff();
    lVar6 = CONCAT22(lSaltLast._2_2_,(undefined2)lSaltLast);
    if (sVar2 == 0) {
      msg.wParam = 0;
    }
    else {
      sVar2 = FGetSystemColors();
      if (sVar2 == 0) {
        sVar2 = 0x10;
        pcVar3 = PszFormatIds(idsUnableInitializeStars,(short *)0x0);
        AlertSz(pcVar3,sVar2);
        lVar6 = CONCAT22(lSaltLast._2_2_,(undefined2)lSaltLast);
        msg.wParam = 0;
      }
      else {
        sVar2 = InitInstance(nCmdShow);
        if (sVar2 == 0) {
          sVar2 = 0x10;
          pcVar3 = PszFormatIds(idsUnableInitializeStars,(short *)0x0);
          AlertSz(pcVar3,sVar2);
          lVar6 = CONCAT22(lSaltLast._2_2_,(undefined2)lSaltLast);
          msg.wParam = 0;
        }
        else {
          lpT = lpCmdLine;
          while (*lpT != '\0') {
            while( true ) {
              if (*lpT != ' ') break;
              lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + 1);
            }
            if ((*lpT == '-') || (*lpT == '/')) {
              lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + 1);
              while ((*lpT != '\0' && (*lpT != ' '))) {
                switch(*lpT) {
                case 'A':
                case 'a':
                  ini.wFlags = ini.wFlags & 0xfbffU | 0x400;
                  break;
                case 'B':
                case 'b':
                  lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + 1);
                  while (*lpT == ' ') {
                    lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + 1);
                  }
                  pch = (char *)szBase;
                  while( true ) {
                    if ((*lpT == '\0') || (*lpT == ' ')) break;
                    *pch = *lpT;
                    pch = pch + 1;
                    lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + 1);
                  }
                  *pch = '\0';
                  lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + -1);
                  sVar2 = FSetUpBatchProcessing();
                  if (sVar2 != 0) {
                    ini.wFlags = ini.wFlags & 0xfdf4U | 0x20b;
                  }
                  break;
                case 'C':
                case 'c':
                  ini.wFlags =
                       ini.wFlags & 0xfffdU | (uint)(szBase[0] != '\0') << 1;
                  break;
                case 'D':
                case 'd':
                  lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + 1);
                  while( true ) {
                    if ((*lpT == '\0') || (*lpT == ' ')) break;
                    cVar1 = *lpT;
                    if (cVar1 == 'F') {
LAB_1018_01ce:
                      ini.wFlags = ini.wFlags & 0xf7ffU | 0x800;
                    }
                    else if (cVar1 == 'M') {
LAB_1018_01ec:
                      ini.wFlags = ini.wFlags & 0xdfffU | 0x2000;
                    }
                    else if (cVar1 == 'P') {
LAB_1018_01dd:
                      ini.wFlags = ini.wFlags & 0xefffU | 0x1000;
                    }
                    else {
                      if (cVar1 == 'f') goto LAB_1018_01ce;
                      if (cVar1 == 'm') goto LAB_1018_01ec;
                      if (cVar1 == 'p') goto LAB_1018_01dd;
                    }
                    lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + 1);
                  }
                  lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + -1);
                  break;
                default:
                  break;
                case 'G':
                case 'g':
                  ini.wFlags = ini.wFlags & 0xfff7U | 8;
                  i = 0;
                  do {
                    uVar5 = (undefined2)((ulong)lpT >> 0x10);
                    pcVar3 = (char *)lpT;
                    if ((pcVar3[1] < '0') || ('9' < pcVar3[1])) goto LAB_1018_02cb;
                    lpT = (char *)CONCAT22(uVar5,pcVar3 + 1);
                    i = i * 10 + (int)*lpT + -0x30;
                  } while (i < 0x3e9);
                  i = 1000;
                  while( true ) {
                    uVar5 = (undefined2)((ulong)lpT >> 0x10);
                    pcVar3 = (char *)lpT;
                    if ((pcVar3[1] < '0') || ('9' < pcVar3[1])) break;
                    lpT = (char *)CONCAT22(uVar5,pcVar3 + 1);
                  }
LAB_1018_02cb:
                  if (0 < i) {
                    ini.cTurnGen = i + -1;
                  }
                  break;
                case 'H':
                case 'h':
                  gd._4_2_ = gd._4_2_ & 0xfdff | 0x200;
                  break;
                case 'L':
                case 'l':
                  ini.wFlags = ini.wFlags & 0x7fffU | 0x8000;
                  break;
                case 'P':
                case 'p':
                  lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + 1);
                  while (*lpT == ' ') {
                    lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + 1);
                  }
                  pch = (char *)szPassLast;
                  while( true ) {
                    if (((*lpT == '\0') || (*lpT == ' ')) ||
                       ((char *)szPassLast + 0xe < pch)) break;
                    *pch = *lpT;
                    pch = pch + 1;
                    lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + 1);
                  }
                  *pch = '\0';
                  lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + -1);
                  lVar6 = LSaltFromSz((char *)szPassLast);
                  lSaltLast = lVar6;
                  break;
                case 'T':
                case 't':
                  ini.wFlags = ini.wFlags & 0xffefU | 0x10;
                  break;
                case 'V':
                case 'v':
                  ini.wFlags = ini.wFlags & 0xbfffU | 0x4000;
                  break;
                case 'W':
                case 'w':
                  ini.wFlags = ini.wFlags & 0xfffbU | 4;
                  break;
                case 'X':
                case 'x':
                  gd.wFlags = gd.wFlags & 0xffbfU | 0x40;
                }
                lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + 1);
              }
            }
            else {
              pch = (char *)szBase;
              while ((*lpT != '\0' && (*lpT != ' '))) {
                *pch = *lpT;
                pch = pch + 1;
                lpT = (char *)CONCAT22(lpT._2_2_,(char *)lpT + 1);
              }
              *pch = '\0';
              ini.wFlags = ini.wFlags & 0xfffcU | 3;
            }
          }
          PostMessage(hwndFrame,0x464,0,0);
LAB_1018_058a:
          while( true ) {
            BVar4 = GetMessage((undefined2 *)CONCAT22(unaff_SS,&msg),0,0,0);
            if (BVar4 == 0) break;
            if (hwndTitle == 0) {
              BVar4 = IsIconic(hwndFrame);
              if (BVar4 == 0) goto LAB_1018_05fc;
              goto LAB_1018_0618;
            }
            sVar2 = TranslateAccelerator
                              (hwndFrame,hAccelTitle,
                               (undefined2 *)CONCAT22(unaff_SS,&msg));
            if (sVar2 == 0) {
              TranslateMessage((undefined2 *)CONCAT22(unaff_SS,&msg));
              DispatchMessage((undefined2 *)CONCAT22(unaff_SS,&msg));
            }
          }
          FreeStuff();
          lVar6 = lSaltLast;
        }
      }
    }
  }
  lSaltLast._2_2_ = (undefined2)((ulong)lVar6 >> 0x10);
  lSaltLast._0_2_ = (undefined2)lVar6;
  return msg.wParam;
LAB_1018_05fc:
  sVar2 = TranslateAccelerator
                    (hwndFrame,hAccel,(undefined2 *)CONCAT22(unaff_SS,&msg));
  if (sVar2 == 0) {
LAB_1018_0618:
    TranslateMessage((undefined2 *)CONCAT22(unaff_SS,&msg));
    if ((msg.message == 0x100) || (msg.message == 0x101)) {
      sVar2 = FHandleKey(msg.hwnd,msg.message,msg.wParam,
                         CONCAT22(msg.lParam._2_2_,(undefined2)msg.lParam));
      if (sVar2 != 0) goto LAB_1018_058a;
    }
    if (msg.message == 0x102) {
      sVar2 = FHandleChar(msg.hwnd,msg.wParam,CONCAT22(msg.lParam._2_2_,(undefined2)msg.lParam));
      if (sVar2 != 0) goto LAB_1018_058a;
    }
    DispatchMessage((undefined2 *)CONCAT22(unaff_SS,&msg));
  }
  goto LAB_1018_058a;
}



// ======================================================================
// Function: FSetUpBatchProcessing
// Address: 1018:06a4
// Segment: MEMORY_MAIN
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short FSetUpBatchProcessing(void)

{
  short sVar1;
  ushort cb_00;
  long lVar2;
  short cb;
  short fSuccess;
  short env [9];
  char *pch;
  
  fSuccess = 0;
  penvMem = env;
  sVar1 = __setjmp(env);
  if (sVar1 == 0) {
    StreamOpen((char *)szBase,0x20);
    lVar2 = __filelength(hf);
    cb_00 = (ushort)lVar2;
    _lpchBatch = LpAlloc(cb_00,htPerm);
    RgFromStream(_lpchBatch,cb_00);
    _lpchBatchMac = _lpchBatch + cb_00;
    DAT_1120_51b2 = DAT_1120_01a0;
    pch = (char *)szBase;
    while( true ) {
      if ((*_lpchBatch == '\n') ||
         ((_lpchBatch == _lpchBatchMac && (DAT_1120_01a0 == DAT_1120_51b2)))) break;
      *pch = *_lpchBatch;
      _lpchBatch = (char *)CONCAT22(DAT_1120_01a0,_lpchBatch + 1);
      pch = pch + 1;
    }
    _lpchBatch = (char *)CONCAT22(DAT_1120_01a0,_lpchBatch + 1);
    pch[-1] = '\0';
    fSuccess = 1;
  }
  penvMem = (short *)0x0;
  StreamClose();
  if (fSuccess == 0) {
    szBase[0] = '\0';
  }
  return fSuccess;
}



// ======================================================================
// Function: IPlrAlsoCheater
// Address: 1018:07aa
// Segment: MEMORY_MAIN
// ======================================================================


short IPlrAlsoCheater(short iplr)

{
  short sVar1;
  short i;
  
  sVar1 = FValidSerialLong
                    (CONCAT22(*(undefined2 *)
                               ((int)&((TURNSERIAL *)vrgts)[iplr].lSerialNumber + 2),
                              (int)((TURNSERIAL *)vrgts + iplr)->lSerialNumber));
  if (sVar1 != 0) {
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if ((i != iplr) && ((*(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 2 & 1) != 0)) {
        if (((int)((TURNSERIAL *)vrgts + iplr)->lSerialNumber ==
             (int)((TURNSERIAL *)vrgts + i)->lSerialNumber) &&
           ((*(int *)((int)&((TURNSERIAL *)vrgts)[iplr].lSerialNumber + 2) ==
             *(int *)((int)&((TURNSERIAL *)vrgts)[i].lSerialNumber + 2) &&
            (sVar1 = __fmemcmp((byte *)CONCAT22(vrgts._2_2_,
                                                        ((TURNSERIAL *)vrgts)[iplr].rgbConfig
                                                       ),
                                       (byte *)CONCAT22(vrgts._2_2_,
                                                        ((TURNSERIAL *)vrgts)[i].rgbConfig),
                                       0xb), sVar1 != 0)))) {
          return i;
        }
      }
    }
  }
  return -1;
}



// ======================================================================
// Function: FGetSystemColors
// Address: 1018:08d2
// Segment: MEMORY_MAIN
// ======================================================================


short FGetSystemColors(void)

{
  char *pcVar1;
  HDC HVar2;
  short sVar3;
  short sVar4;
  undefined2 uVar5;
  COLORREF CVar6;
  char *pcVar7;
  ulong uVar8;
  undefined2 uVar9;
  undefined2 uVar10;
  ushort uVar11;
  BITMAPINFO *lpbi_2;
  HDC hdc;
  
  if (hbrButtonFace != 0) {
    FreeHbr(hbrButtonFace);
  }
  if (hbrButtonHilite != 0) {
    FreeHbr(hbrButtonHilite);
  }
  if (hbrButtonShadow != 0) {
    FreeHbr(hbrButtonShadow);
  }
  if (hbrButtonText != 0) {
    FreeHbr(hbrButtonText);
  }
  if (hbrWindowText != 0) {
    FreeHbr(hbrWindowText);
  }
  if (hbrWindow != 0) {
    FreeHbr(hbrWindow);
  }
  if (hbrWindowFrame != 0) {
    FreeHbr(hbrWindowFrame);
  }
  if (hbrDesktop != 0) {
    FreeHbr(hbrDesktop);
  }
  crButtonFace = GetSysColor(0xf);
  hbrButtonFace = HbrGet(crButtonFace);
  crButtonHilite = GetSysColor(0x14);
  hbrButtonHilite = HbrGet(crButtonHilite);
  crButtonShadow = GetSysColor(0x10);
  hbrButtonShadow = HbrGet(crButtonShadow);
  crButtonText = GetSysColor(0x12);
  hbrButtonText = HbrGet(crButtonText);
  CVar6 = GetSysColor(6);
  hbrWindowFrame = HbrGet(CVar6);
  CVar6 = GetSysColor(1);
  hbrDesktop = HbrGet(CVar6);
  crWindow = GetSysColor(5);
  hbrWindow = HbrGet(crWindow);
  crWindowText = GetSysColor(8);
  hbrWindowText = HbrGet(crWindowText);
  uVar11 = 4;
  dyTitleBar = GetSystemMetrics(4);
  uVar10 = 0x20;
  dxWinFrame = GetSystemMetrics(0x20);
  uVar9 = 0x21;
  dyWinFrame = GetSystemMetrics(0x21);
  if (hdibPlaque != 0) {
    pcVar7 = GlobalLock(hdibPlaque);
    uVar5 = (undefined2)((ulong)pcVar7 >> 0x10);
    pcVar1 = (char *)pcVar7;
    pcVar1[0x40e] = (char)crButtonFace;
    pcVar1[0x40d] = (char)(crButtonFace >> 8);
    uVar8 = __aFulshr(CONCAT22(uVar10,uVar9),uVar11);
    pcVar1[0x40c] = (char)uVar8;
    GlobalUnlock(hdibPlaque);
  }
  if (hdibToolbar != 0) {
    pcVar7 = GlobalLock(hdibToolbar);
    uVar5 = (undefined2)((ulong)pcVar7 >> 0x10);
    pcVar1 = (char *)pcVar7;
    pcVar1[0x41e] = (char)crButtonFace;
    pcVar1[0x41d] = (char)(crButtonFace >> 8);
    uVar8 = __aFulshr(CONCAT22(uVar10,uVar9),uVar11);
    pcVar1[0x41c] = (char)uVar8;
    GlobalUnlock(hdibToolbar);
  }
  HVar2 = GetDC(0);
  sVar3 = GetDeviceCaps(HVar2,0xc);
  sVar4 = GetDeviceCaps(HVar2,0xe);
  vcScreenColors = sVar3 * sVar4;
  ReleaseDC(0,HVar2);
  return 1;
}



// ======================================================================
// Function: FreeStuff
// Address: 1018:0bae
// Segment: MEMORY_MAIN
// ======================================================================


void FreeStuff(void)

{
  HCURSOR HVar1;
  short j;
  short i;
  
  if (hbrButtonFace != 0) {
    FreeHbr(hbrButtonFace);
  }
  if (hbrButtonHilite != 0) {
    FreeHbr(hbrButtonHilite);
  }
  if (hbrButtonShadow != 0) {
    FreeHbr(hbrButtonShadow);
  }
  if (hbrButtonText != 0) {
    FreeHbr(hbrButtonText);
  }
  if (hbrWindowText != 0) {
    FreeHbr(hbrWindowText);
  }
  if (hbrWindow != 0) {
    FreeHbr(hbrWindow);
  }
  if (hbrWindowFrame != 0) {
    FreeHbr(hbrWindowFrame);
  }
  if (hbrDesktop != 0) {
    FreeHbr(hbrDesktop);
  }
  if (hbrRed != 0) {
    FreeHbr(hbrRed);
  }
  if (hbrGreen != 0) {
    FreeHbr(hbrGreen);
  }
  if (hbrBlue != 0) {
    FreeHbr(hbrBlue);
  }
  if (hbrPurple != 0) {
    FreeHbr(hbrPurple);
  }
  if (hbrTooltip != 0) {
    FreeHbr(hbrTooltip);
  }
  for (i = 0; i < 5; i = i + 1) {
    if (((ushort *)rghbrMineral)[i] != 0) {
      FreeHbr(((ushort *)rghbrMineral)[i]);
    }
  }
  for (i = 0; i < 3; i = i + 1) {
    for (j = 0; j < 2; j = j + 1) {
      FreeHbr(((ushort (*) [2])rghbrPlanetAttr)[i][j]);
    }
  }
  for (i = 0; i < 4; i = i + 1) {
    for (j = 0; j < 2; j = j + 1) {
      FreeHbr(((ushort (*) [2])rghbrMinSum)[i][j]);
    }
  }
  FreeProcInstance((fn_lpfnFakeComboProc *)
                   CONCAT22(lpfnFakeComboProc._2_2_,
                            (fn_lpfnFakeComboProc *)lpfnFakeComboProc));
  FreeProcInstance((fn_lpfnFakeCEProc *)
                   CONCAT22(lpfnFakeCEProc._2_2_,
                            (fn_lpfnFakeCEProc *)lpfnFakeCEProc));
  FreeProcInstance((fn_lpfnFakeEditProc *)
                   CONCAT22(lpfnFakeEditProc._2_2_,
                            (fn_lpfnFakeEditProc *)lpfnFakeEditProc));
  FreeProcInstance((fn_lpfnFakeListProc *)
                   CONCAT22(lpfnFakeListProc._2_2_,
                            (fn_lpfnFakeListProc *)lpfnFakeListProc));
  FreeProcInstance((fn_lpfnHostTimerProc *)
                   CONCAT22(lpfnHostTimerProc._2_2_,
                            (fn_lpfnHostTimerProc *)lpfnHostTimerProc));
  FreeProcInstance((fn_lpfnBrowserDlgProc *)
                   CONCAT22(lpfnBrowserDlgProc._2_2_,
                            (fn_lpfnBrowserDlgProc *)lpfnBrowserDlgProc));
  if (((fn_lpfnTutorDlgProc *)lpfnTutorDlgProc != (fn_lpfnTutorDlgProc *)0x0) ||
     (lpfnTutorDlgProc._2_2_ != 0)) {
    FreeProcInstance((fn_lpfnTutorDlgProc *)
                     CONCAT22(lpfnTutorDlgProc._2_2_,
                              (fn_lpfnTutorDlgProc *)lpfnTutorDlgProc));
  }
  DeleteObject(hrgnHuge);
  DeleteObject(hrgnScratch);
  HVar1 = LoadCursor(0,&DAT_0000_7f00);
  setcursor(HVar1);
  DestroyCursor(hcurScanner);
  DestroyCursor(hcurOpenGrab);
  DestroyCursor(hcurCloseGrab);
  DestroyCursor(hcurScanAdd);
  DestroyCursor(hcurTrashCan);
  DestroyCursor(hcurNoWay);
  DestroyCursor(hcurResizeWE);
  DestroyCursor(hcurResizeNS);
  DestroyCursor(hcurResize4Way);
  DestroyCursor(hcurArrowHelp);
  DestroyCursor(hcurHand);
  DeleteObject(hbmpScanner);
  DeleteObject(hbmpNumbers);
  DeleteObject(hbmpScanShip);
  DeleteObject(hbmpUnknownPlanet);
  DestroyIcon(hiconStars);
  DestroyIcon(hiconHost);
  DestroyIcon(hiconWait);
  for (i = 0; i < 7; i = i + 1) {
    DestroyIcon(((ushort *)rghiconVCR)[i]);
  }
  GlobalUnlock(hdibPlanets);
  FreeResource(hdibPlanets);
  GlobalUnlock(hdibThings);
  FreeResource(hdibThings);
  GlobalUnlock(hdibToolbar);
  FreeResource(hdibToolbar);
  GlobalUnlock(hdibRaces);
  FreeResource(hdibRaces);
  GlobalUnlock(hdibRacesT);
  FreeResource(hdibRacesT);
  GlobalUnlock(hdibRacesX);
  FreeResource(hdibRacesX);
  DeleteObject(hbmpBackBld);
  DeleteObject(hbmpMsg);
  DeleteObject(hbmpMono);
  FreeResource(hdibPlaque);
  for (i = 0; i < 5; i = i + 1) {
    GlobalUnlock(((ushort *)rghdibShips)[i]);
    FreeResource(((ushort *)rghdibShips)[i]);
    GlobalUnlock(((ushort *)rghdibShipsT)[i]);
    FreeResource(((ushort *)rghdibShipsT)[i]);
  }
  for (i = 0; i < 7; i = i + 1) {
    GlobalUnlock(((ushort *)rghdibInventory)[i]);
    FreeResource(((ushort *)rghdibInventory)[i]);
  }
  FreeLp((byte *)CONCAT22(lpLog._2_2_,(byte *)lpLog),htLog);
  lpLog._0_2_ = (byte *)0x0;
  lpLog._2_2_ = 0;
  FreeLp((short *)CONCAT22(lpMsg._2_2_,(short *)lpMsg),htMsg);
  lpMsg._0_2_ = (short *)0x0;
  lpMsg._2_2_ = 0;
  DeleteObject(vhpal);
  if (vhpalSplash != 0) {
    DeleteObject(vhpalSplash);
  }
  FreeHbr(hbrShip);
  FreeHbr(hbrStarbase);
  FreeHbr(hbrBBlue);
  FreeHbr(hbrEnemy);
  FreeHbr(hbrSelect);
  FreeHbr(hbrRadar);
  if (hbrRadarNear != 0) {
    FreeHbr(hbrRadarNear);
  }
  FreeHbr(hbrLightGray);
  FreeHbr(hbrGray);
  FreeHbr(hbrYellow);
  FreeHbr(hbrDkYellow);
  DeleteObject(hbr50Screen);
  for (i = 0; i < 3; i = i + 1) {
    DeleteObject(((ushort *)rghbrPat)[i]);
  }
  DeleteObject(hbrCargo);
  DeleteObject(hbrDock);
  DeleteObject(hpenShip);
  DeleteObject(hpenDkGreen);
  DeleteObject(hpenDkPurple);
  DeleteObject(hpenStarbase);
  DeleteObject(hpenEnemy);
  DeleteObject(hpenMassPath);
  DeleteObject(hpenRadar);
  if (hpenRadarNear != 0) {
    DeleteObject(hpenRadarNear);
  }
  DeleteObject(hpenDkBlue);
  DeleteObject(hpenYellow);
  DeleteObject(hpenDkYellow);
  DeleteObject(rghfontArial10[0]);
  DeleteObject(rghfontArial10[1]);
  for (i = 0; i < 5; i = i + 1) {
    DeleteObject(((ushort *)rghfontArial8)[i]);
  }
  DeleteObject(rghfontArial6[0]);
  DeleteObject(rghfontArial7[0]);
  for (i = 0; i < 0xc; i = i + 1) {
    FreeHb((HB *)CONCAT22(*(undefined2 *)(i * 4 + 0xd36),
                                  (HB *)*(undefined2 *)(i * 4 + 0xd34)));
  }
  return;
}



// ======================================================================
// Function: SzVersion
// Address: 1018:1212
// Segment: MEMORY_MAIN
// ======================================================================


char * SzVersion(void)

{
  char *pcVar1;
  undefined2 uVar2;
  
  uVar2 = 2;
  pcVar1 = PszGetCompressedString(idsVersionD02dC);
  _WSPRINTF((LPSTR)CONCAT22(uVar2,(char *)&DAT_1120_1120),
            (LPCSTR)CONCAT22(pcVar1,(char *)&DAT_1120_1120),(char *)szWork);
  return (char *)szWork;
}



// ======================================================================
// Function: About
// Address: 1018:1252
// Segment: MEMORY_MAIN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: hwndCtl */

short About(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  HWND HVar1;
  char *pcVar2;
  short sVar3;
  HDC hdc;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar4;
  FARPROC pvVar5;
  HWND hwndCtl;
  void *lpProc;
  RECT rc;
  
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar3 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      uVar4 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),hwndCtl);
      if ((int)uVar4 == 6) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        iAbout1st = -0xb;
        iAboutPartial = 0;
        HVar1 = GetDlgItem(hwnd,0x401);
        pcVar2 = SzVersion();
        SetWindowText(HVar1,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar2));
        uTimerId = SetTimer(0xe,0x32,0,0);
        return 1;
      }
      if (message == WM_COMMAND) {
        if ((wParam == 1) || (wParam == 2)) {
          KillTimer(hwnd,uTimerId);
          uTimerId = 0;
          EndDialog(hwnd,1);
          return 1;
        }
        if (wParam == 0x76) {
          pvVar5 = MakeProcInstance(OrderInfoDlg,hInst);
          DialogBox(0,(LPCSTR)CONCAT22(0x61,hwnd),(HWND)((ulong)pvVar5 >> 0x10),(void *)pvVar5);
          FreeProcInstance(pvVar5);
        }
      }
      else if (message == WM_TIMER) {
        HVar1 = GetDlgItem(hwnd,0x41f);
        iAboutPartial = iAboutPartial + 2;
        if (dyArial8 <= iAboutPartial) {
          iAboutPartial = 0;
          iAbout1st = iAbout1st + 1;
          if (0x4e < iAbout1st) {
            iAbout1st = -0xb;
          }
        }
        GetClientRect(HVar1,(undefined2 *)CONCAT22(unaff_SS,&rc));
        hdc = GetDC(HVar1);
        SelectObject(hdc,rghfontArial8[1]);
        SetBkMode(hdc,2);
        SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
        SetTextColor(hdc,CONCAT22(crButtonText._2_2_,(undefined2)crButtonText));
        IntersectClipRect(hdc,0,0,rc.right,rc.bottom);
        rc.top = rc.top - iAboutPartial;
        rc.bottom = rc.top + dyArial8;
        for (lpProc._0_2_ = (void *)iAbout1st;
            (int)(void *)lpProc < iAbout1st + 10;
            lpProc._0_2_ = (void *)((int)(void *)lpProc + 1)) {
          if (((int)(void *)lpProc < 0) || (0x4c < (int)(void *)lpProc)) {
            if (0x4c < (int)(void *)lpProc) break;
          }
          else {
            sVar3 = -1;
            pcVar2 = PszGetCompressedString((int)(void *)lpProc + idsDesignProgramming);
            RcCtrTextOut(hdc,&rc,pcVar2,sVar3);
          }
          OffsetRect((undefined2 *)CONCAT22(unaff_SS,&rc),0,dyArial8);
        }
        rc.bottom = 1000;
        FillRect(hdc,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
        SelectClipRgn(hdc,0);
        ReleaseDC(hwnd,hdc);
      }
    }
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: OrderInfoDlg
// Address: 1018:151e
// Segment: MEMORY_MAIN
// ======================================================================


/* WARNING: Variable defined which should be unmapped: rc */

short OrderInfoDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  short sVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar2;
  RECT rc;
  
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    sVar1 = 1;
  }
  else {
    if (message == WM_CTLCOLOR) {
      uVar2 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),rc.left);
      if ((int)uVar2 == 6) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else if ((message == WM_COMMAND) && ((wParam == 2 || (wParam == 1)))) {
      EndDialog(hwnd,1);
      return 1;
    }
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: FHandleChar
// Address: 1018:15de
// Segment: MEMORY_MAIN
// ======================================================================


short FHandleChar(HWND hwnd,ushort ch,long lParam)

{
  HWND HVar1;
  short sVar2;
  HWND hwndF;
  
  if (((((hwndScanner == 0) || ((ch != 0x2b && (ch != 0x2d)))) && (ch != 0x76)) &&
      (ch != 0x56)) ||
     ((HVar1 = GetFocus(), hwndMessage != 0 && (HVar1 == hwndMsgEdit)))) {
    sVar2 = 0;
  }
  else {
    SendMessage(hwndScanner,0x102,ch,lParam);
    sVar2 = 1;
  }
  return sVar2;
}



// ======================================================================
// Function: FHandleKey
// Address: 1018:165a
// Segment: MEMORY_MAIN
// ======================================================================


short FHandleKey(HWND hwnd,short iMsg,short iKey,ulong dw)

{
  HWND HVar1;
  uint uVar2;
  short sVar3;
  undefined2 unaff_SS;
  HWND hwndOver;
  uint uStack_a;
  POINT pt_2;
  
  if (iMsg == 0x100) {
    if (((iKey == 0x1b) && (hwndBrowser != 0)) &&
       (HVar1 = GetActiveWindow(), HVar1 == hwndBrowser)) {
      DestroyWindow(hwndBrowser);
      return 1;
    }
    if ((iKey == 0x1b) && (hwndPopup != 0)) {
      SendMessage(hwndPopup,0x202,0,0);
      return 1;
    }
    if ((iKey == 0x1b) && (hwndReportDlg != 0)) {
      DestroyWindow(hwndReportDlg);
      return 1;
    }
  }
  else if (((iMsg == 0x101) && (hwndTb != 0)) && ((iKey == 0x1b || (iKey == 0xd)))) {
    HVar1 = GetFocus();
    pt_2.y = GetParent(HVar1);
    if ((pt_2.y == hwndTb) || (HVar1 = GetParent(pt_2.y), HVar1 == hwndTb)) {
      TerminateToolbarFocus((uint)(iKey == 0x1b));
    }
  }
  if ((iKey == 0x10) && (hwndScanner != 0)) {
    GetCursorPos((uint *)CONCAT22(unaff_SS,&uStack_a));
    HVar1 = WindowFromPoint(uStack_a);
    if (HVar1 == hwndScanner) {
      SendMessage(HVar1,0x20,HVar1,0);
    }
  }
  if (iMsg != 0x100) {
    return 0;
  }
  if ((((((iKey != 8) && (iKey != 0x2e)) && (iKey != 0x28)) && ((iKey != 0x26 && (iKey != 0x24))))
      && ((iKey != 0x23 && ((iKey < 0x30 || (0x39 < iKey)))))) &&
     ((iKey != 0xbc && (((iKey != 0xbe && (iKey != 0xdb)) && (iKey != 0xdd)))))) {
    return 0;
  }
  pt_2.y = GetFocus();
  if (hwndMessage != 0) {
    if (hwndTb != 0) {
      if ((hwndTb == pt_2.y) || (HVar1 = GetParent(pt_2.y), HVar1 == hwndTb)) {
        return 0;
      }
      HVar1 = GetParent(pt_2.y);
      HVar1 = GetParent(HVar1);
      if (HVar1 == hwndTb) {
        return 0;
      }
    }
    for (pt_2.x = 0; pt_2.x < 3; pt_2.x = pt_2.x + 1) {
      if (pt_2.y == ((ushort *)rghwndOrderDD)[pt_2.x]) {
        return 0;
      }
    }
    if ((((pt_2.y == hwndFleetCompLB) || (pt_2.y == hwndPlanetProdLB)) ||
        ((pt_2.y == hwndMsgEdit ||
         (((pt_2.y == hwndMsgDrop || (pt_2.y == hwndOrderED)) ||
          (pt_2.y == hwndMsgScroll)))))) ||
       ((pt_2.y == hwndFleetCompLB || (pt_2.y == hwndShipDD)))) {
      return 0;
    }
    if ((hwndBrowser != 0) && (HVar1 = GetDlgItem(hwndBrowser,0x10b), pt_2.y == HVar1)
       ) {
      return 0;
    }
  }
  if ((0x2f < iKey) && (iKey < 0x3a)) {
    if ((0x30 < iKey) && (iKey < 0x37)) {
      uStack_a = iKey - 0x31;
      if (uStack_a != (grbitScan & 0xf)) {
        ExecuteButton(iKey + -0x31,1);
        InvalidateRect(hwndTb,(undefined2 *)0x0,0);
      }
      return 1;
    }
    if (iKey == 0x30) {
      sVar3 = GetKeyState(0x10);
      if (sVar3 < 0) {
        pt_2.x = 0x11;
      }
      else {
        pt_2.x = 0xb;
      }
    }
    else if (iKey == 0x37) {
      pt_2.x = 7;
    }
    else if (iKey == 0x38) {
      pt_2.x = 8;
    }
    else if (iKey == 0x39) {
      pt_2.x = 9;
    }
    sVar3 = FIsButtonDown(pt_2.x);
    ExecuteButton(pt_2.x,(uint)(sVar3 == 0));
    InvalidateRect(hwndTb,(undefined2 *)0x0,0);
    return 1;
  }
  if (iKey != 8) {
    if ((((iKey == 0x23) || (iKey == 0x24)) || (iKey == 0x26)) || (iKey == 0x28)) {
      if (pt_2.y != hwndShipLB) {
        SendMessage(hwndMessage,0x100,iKey,dw);
        return 1;
      }
      return 0;
    }
    if (iKey != 0x2e) {
      if ((iKey == 0xbc) || (iKey == 0xbe)) {
        if ((sel.grobj == grobjFleet) &&
           ((0 < sel.iwpAct || (1 < sel.fl.cord)))) {
          uStack_a = sel.iwpAct;
          if (sel.iwpAct < 1) {
            uStack_a = 1;
          }
          uVar2 = *(uint *)((int)(PLORD *)sel.fl.lpplord + uStack_a * 0x12 + 10) >> 4 &
                  0xf;
          if (iKey == 0xbc) {
            pt_2.x = uVar2 - 1;
          }
          else {
            pt_2.x = uVar2 + 1;
          }
          if ((-1 < pt_2.x) && (pt_2.x < 0xc)) {
            *(uint *)((int)(PLORD *)sel.fl.lpplord + uStack_a * 0x12 + 10) =
                 *(uint *)((int)(PLORD *)sel.fl.lpplord + uStack_a * 0x12 + 10) & 0xff0f |
                 (pt_2.x & 0xfU) << 4;
            FLookupFleet(-1,(FLEET *)&sel.fl);
            DrawPlanShip(0,0x4220);
          }
        }
        return 1;
      }
      if ((iKey != 0xdb) && (iKey != 0xdd)) {
        return 0;
      }
      uStack_a = 0;
      pt_2.x = 0;
      if (iKey == 0xdb) {
        sVar3 = -2;
      }
      else {
        sVar3 = -1;
      }
      ExecuteReportClick((POINT)0x0,2,0,sVar3);
      return 1;
    }
  }
  if (sel.grobj == grobjFleet) {
    DeleteCurWayPoint(8);
  }
  return 1;
}



