// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: DoAiTurn
// Address: 1088:0000
// Segment: MEMORY_AI
// ======================================================================


/* WARNING: Variable defined which should be unmapped: idSav */

void DoAiTurn(short iPlayer,ushort wMdPlr)

{
  byte *pbVar1;
  PLANET **ppPVar2;
  short sVar3;
  short sVar4;
  undefined2 unaff_SS;
  short idSav;
  char szExt [6];
  
                    /* Segment:    18
                       Offset:     00081340
                       Length:     60bc
                       Min Alloc:  60bc
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  sVar3 = idPlayer;
  fAi = 1;
  _wsprintf(szExt,MPCTD,iPlayer + 1);
  DestroyCurGame();
  sVar4 = FLoadGame((char *)szBase,szExt);
  pbVar1 = vlpbAiPlanet;
  ppPVar2 = vrglpplAi;
  if (sVar4 != 0) {
    if ((*(uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0) & 1) == 0) {
      vlpbAiPlanet = LpAlloc(game.cPlanMax << 4,htMisc);
      vrglpplAi = LpAlloc(game.cPlanMax << 2,htMisc);
      if (((byte *)vlpbAiData == (byte *)0x0) && (vlpbAiData._2_2_ == 0)) {
        vlpbAiData = LpAlloc(0x2000,htMisc);
        if (((byte *)vlpbAiData != (byte *)0x0) ||
           ((int)((ulong)vlpbAiData >> 0x10) != 0)) {
          pbVar1 = vlpbAiData + 1;
          vlpbAiData[0] = 2;
          *pbVar1 = 0;
        }
      }
      if ((vlpbAiPlanet != (byte *)0x0) &&
         ((((byte *)vlpbAiData != (byte *)0x0 || (vlpbAiData._2_2_ != 0)) &&
          (vrglpplAi != (PLANET **)0x0)))) {
        __fmemset(vlpbAiPlanet,0,game.cPlanMax << 4);
        ComputeShdefPowers();
        MarkPlanetsUnderAttack();
        IncreaseAIMinefieldSizes();
        InitRandomPlanetList();
        if (wMdPlr != 0xffff) {
          *(ushort *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) = wMdPlr;
        }
        switch(*(uint *)((int)&rgplr[0].wMdPlr + iPlayer * 0xc0) >> 0xd) {
        case 0:
          DoRobotoidAiTurn(&stack0xfef8);
          break;
        case 1:
          DoTurinDroneAiTurn(&stack0xfef8);
          break;
        case 2:
          DoAutomitronAiTurn(&stack0xfef8);
          break;
        case 3:
          DoRototillAiTurn(&stack0xfef8);
          break;
        case 4:
          DoCyberAiTurn(&stack0xfef8);
          break;
        case 5:
          DoMacintiAiTurn(&stack0xfef8);
          break;
        default:
          break;
        case 7:
          DoMaidAiTurn(&stack0xfef8);
        }
      }
    }
    idSav = 0x245;
    FWriteLogFile((char *)szBase,iPlayer);
    FWriteHistFile(iPlayer);
    if (vrglpplAi != (PLANET **)0x0) {
      idSav = 0x1048;
      FreeLp(vrglpplAi,htMisc);
    }
    vrglpplAi = (PLANET **)0x0;
    if (((byte *)vlpbAiData != (byte *)0x0) || (vlpbAiData._2_2_ != 0)) {
      FreeLp(vlpbAiPlanet,htMisc);
      idSav = 0x1060;
      FreeLp(vlpbAiData,htMisc);
      vlpbAiPlanet = (byte *)0x0;
      vlpbAiData = (byte *)0x0;
    }
    idPlayer = idSav;
    sVar3 = idPlayer;
    pbVar1 = vlpbAiPlanet;
    ppPVar2 = vrglpplAi;
  }
  idPlayer = sVar3;
  fAi = 0;
  vrglpplAi._2_2_ = (undefined2)((ulong)ppPVar2 >> 0x10);
  vrglpplAi._0_2_ = (PLANET **)ppPVar2;
  vlpbAiPlanet._2_2_ = (undefined2)((ulong)pbVar1 >> 0x10);
  vlpbAiPlanet._0_2_ = (byte *)pbVar1;
  return;
}



// ======================================================================
// Function: DoRobotoidAiTurn
// Address: 1088:0312
// Segment: MEMORY_AI
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x108808ca) */
/* WARNING: Removing unreachable block (ram,0x108808a9) */
/* WARNING: Removing unreachable block (ram,0x108808cf) */
/* WARNING: Removing unreachable block (ram,0x10880d8d) */
/* WARNING: Removing unreachable block (ram,0x10880f50) */
/* WARNING: Removing unreachable block (ram,0x10880a7a) */
/* WARNING: Removing unreachable block (ram,0x10880abe) */

void DoRobotoidAiTurn(PROD *rgprod)

{
  uint *puVar1;
  byte *pbVar2;
  ushort *puVar3;
  int iVar4;
  uint uVar5;
  uint uVar6;
  PLORD *pPVar7;
  POINT pt;
  short sVar8;
  uint uVar9;
  ushort uVar10;
  ITEMACTION IVar11;
  PLANET *pPVar12;
  int iVar13;
  byte *pbVar14;
  FLEET *pFVar15;
  undefined2 unaff_SI;
  ushort *puVar16;
  undefined2 unaff_DI;
  PLORD *pPVar17;
  undefined2 uVar18;
  undefined2 uVar19;
  ulong uVar20;
  PLANET *pPVar21;
  ushort in_stack_0000ff5c;
  undefined2 rgRecycleSBShdef;
  undefined1 local_9c [6];
  short dx;
  undefined1 lDist;
  undefined1 uStack_93;
  undefined1 uStack_92;
  undefined1 uStack_91;
  undefined2 uStack_90;
  PROD *lpprod;
  short fWrite;
  undefined4 l;
  short iLatestBomber;
  short iPlanet;
  short iLatestBattle;
  short cFr;
  ushort cRecyclePeriod;
  short iLatestMeta;
  PLANET *lpplMac;
  ushort local_76;
  short ishdefSBLatest;
  short fTonsOfMinerals;
  short ipl;
  short iLatestCargo;
  short iAiLvl;
  short iroCur;
  short cRes;
  PLANET *lpplHome;
  int local_64;
  FLEET *lpfl;
  FLEET *lpflAttack;
  undefined2 local_5c;
  ushort rgCosts [4];
  short i;
  short ifl;
  PLANET *lppl;
  short fShouldColonize;
  byte rgRecycleShdef [16];
  short j;
  short idPlanDst;
  THING *lpthWorm;
  int local_32;
  short cColFleet;
  short iLatestDestroyer;
  short cFlDestroyers;
  short cExistCargo;
  uint rgResAvail [8];
  FLEET *lpflEnemy;
  undefined2 local_16;
  uint rgResCost [9];
  
  iAiLvl = *(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7;
  iPlanet = *(short *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0);
  if (game.turn < 10) {
    sVar8 = 0;
  }
  else {
    sVar8 = 0xf;
  }
  iroCur = IroEnsureAi(vrgAiRobotoidResOrder,0x24,&ishdefSBLatest,sVar8);
  if (0x32 < game.turn) {
    MergeAllShdefs(0x6fc);
    MergeAllShdefs(1);
    MergeAllShdefs(-0x4000);
  }
  j = 4;
  if (0x82 < game.turn) {
    j = (game.turn - 0x78) / 0x14 + 4;
  }
  if (0x32 < (uint)j) {
    j = 0x32;
  }
  vrgAiArmadaPotency[0] = (byte)j;
  vrgAiArmadaPotency[1] = (byte)((ulong)(j & 0xff) / 2);
  j = 6;
  if (0x73 < game.turn) {
    j = (game.turn - 100) / 0x16 + 6;
  }
  if (0xc < (uint)j) {
    j = 0xc;
  }
  vrgAiArmadaPotency[2] = (byte)j;
  if ((int)((uint)j / 2 - 1) < 4) {
    vrgAiArmadaPotency[3] = (char)((uint)j / 2) - 1;
  }
  else {
    vrgAiArmadaPotency[3] = 3;
  }
  _memset(rgRecycleShdef,0,0x10);
  if (game.turn < 0x78) {
    cRecyclePeriod = 0x32;
  }
  else if (game.turn < 200) {
    cRecyclePeriod = 0x46;
  }
  else {
    cRecyclePeriod = 100;
  }
  CheckAiShdefStatus(0xe,0xf,cRecyclePeriod,&iLatestDestroyer,rgRecycleShdef);
  for (i = 0xe; i < 0x10; i = i + 1) {
    if (((rgRecycleShdef[i] != 0) &&
        ((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0)) &&
       (*(int *)(i * 0x93 + rgshdef) == 0x1d)) {
      rgRecycleShdef[i] = 0;
    }
  }
  cExistCargo = CheckAiShdefStatus(0xb,0xd,cRecyclePeriod,&iLatestCargo,rgRecycleShdef);
  CheckAiShdefStatus(9,10,cRecyclePeriod,&iLatestBomber,rgRecycleShdef);
  CheckAiShdefStatus(2,5,cRecyclePeriod,&iLatestMeta,rgRecycleShdef);
  CheckAiShdefStatus
            (6,7,(ushort)(((long)(int)cRecyclePeriod * 3 & 0xffffU) / 2),&iLatestBattle,
             rgRecycleShdef);
  if (0x50 < game.turn) {
    SplitOutShdefs(rgRecycleShdef);
    _memset(&rgRecycleSBShdef,0,0x10);
    rgRecycleSBShdef = CONCAT11(rgRecycleSBShdef._1_1_,2);
    SplitOutShdefs(&rgRecycleSBShdef);
    _memset(&rgRecycleSBShdef,0,0x10);
    rgRecycleSBShdef = CONCAT11(2,(byte)rgRecycleSBShdef);
    SplitOutShdefs(&rgRecycleSBShdef);
    _memset(&rgRecycleSBShdef,0,0x10);
    uStack_91 = 2;
    uStack_92 = 2;
    uStack_93 = 2;
    SplitOutShdefs(&rgRecycleSBShdef);
  }
  EnsureRobotoidShdefs();
  cFlDestroyers = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar15 = ((FLEET **)rglpfl)[ifl];
    iVar13 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar13,pFVar15);
    if ((pFVar15 == (FLEET *)0x0) && (iVar13 == 0)) break;
    if (((pFVar15->iPlayer == idPlayer) && (iLatestDestroyer != -1)) &&
       ((pFVar15->rgcsh[0xe] != 0 || (pFVar15->rgcsh[0xf] != 0)))) {
      cFlDestroyers = cFlDestroyers + 1;
    }
  }
  fShouldColonize = FShouldWeBuildColonizers(&cColFleet);
  UpdateProgressGauge(-0x39e);
  _uStack_92 = (PLANET *)lpPlanets;
  uStack_90 = lpPlanets._2_2_;
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_76 = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < lpplMac) {
    uVar18 = (undefined2)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl)->iPlayer != idPlayer) && (((PLANET *)lppl)->iPlayer != -1)) {
      i = (((PLANET *)lppl)->uGuesses & 0xfff) / 0xfa + 1;
      if (6 < (uint)i) {
        i = 6;
      }
      if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) {
        i = i + 1;
      }
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] = (byte)i;
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 9] = 1;
    }
    lppl = (PLANET *)CONCAT22(uVar18,(PLANET *)lppl + 1);
  }
  for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
                    /* WARNING: Load size is inaccurate */
    pPVar12 = ((PLANET **)vrglpplAi)[ipl];
    iVar13 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
    lppl = (PLANET *)CONCAT22(iVar13,pPVar12);
    if ((pPVar12 == (PLANET *)0x0) && (iVar13 == 0)) break;
    if (((pPVar12->wFlags_0x4 >> 9 & 1) != 0) &&
       ((iVar4 = *(int *)((int)pPVar12->rgwtMin + 0xe), 0 < iVar4 ||
        ((-1 < iVar4 && (199 < *(uint *)(pPVar12->rgwtMin + 3))))))) {
      ChangeMainObjSel(1,lppl->id);
      InitProduction(rgprod);
      fWrite = 0;
      lpprod._2_2_ = lpplProdGlob._2_2_;
      lpprod._0_2_ = (PLPROD *)lpplProdGlob;
      for (i = 0; lpprod._0_2_ = (PROD *)lpprod + 1,
          i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
        uVar20 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff5c);
        if (((uint)uVar20 & 7) == 2) {
          uVar20 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff5c);
          if (((uint)uVar20 & 0x7f) < 0x10) break;
        }
      }
      if (i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
        FinishProduction(0);
      }
      else {
        uVar18 = (undefined2)((ulong)vlpbAiData >> 0x10);
        if (*(int *)((byte *)vlpbAiData + 2) * 4 <
            *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) / 8) {
          cFr = *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) / 8;
        }
        else {
          cFr = *(int *)((byte *)vlpbAiData + 2) << 2;
        }
        if (iLatestCargo != -1) {
          if (cExistCargo < (cFr << 3) / 10) {
LAB_1088_0990:
            AddItemToQueue(iLatestCargo,1,grobjFleet,1);
            fWrite = 1;
          }
          else if (cExistCargo < cFr) {
            sVar8 = Random(3);
            if (sVar8 == 0) goto LAB_1088_0990;
          }
        }
        if (fShouldColonize == 0) {
          if (cColFleet < 0x1a) {
            sVar8 = Random(*(int *)((byte *)vlpbAiData + 2) << 3);
            if (sVar8 == 0) goto LAB_1088_09e2;
          }
        }
        else {
LAB_1088_09e2:
          if (4 < game.turn) {
            if (game.turn < 0x15) {
              AddItemToQueue(1,1,grobjFleet,1);
            }
            AddItemToQueue(1,1,grobjFleet,1);
            fWrite = 1;
            sVar8 = PctTrueMaxGrowth(idPlayer);
            uVar18 = (undefined2)((ulong)lppl >> 0x10);
            uVar20 = __aFulmul(CONCAT22(*(undefined2 *)
                                                 ((int)((PLANET *)lppl)->rgwtMin + 0xe),
                                                (int)((PLANET *)lppl)->rgwtMin[3]),(long)sVar8);
            l = uVar20;
            cRes = CResourcesAtPlanet(lppl,idPlayer);
            if (((0x8fc < (long)l) && (0x23 < cRes)) && (0 < iAiLvl)) {
              AddItemToQueue(1,1,grobjFleet,1);
              if (((0xe10 < (long)l) && (0x32 < cRes)) && (1 < iAiLvl)) {
                AddItemToQueue(1,1,grobjFleet,1);
              }
            }
          }
        }
        if (rgshdef[0].hul.ihuldef == ihuldefFrigate) {
          sVar8 = Random(4);
          if (sVar8 == 0) {
            uStack_90 = lppl->id;
            cFr = 0;
            for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
              pFVar15 = ((FLEET **)rglpfl)[ifl];
              iVar13 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
              lpfl = (FLEET *)CONCAT22(iVar13,pFVar15);
              if ((pFVar15 == (FLEET *)0x0) && (iVar13 == 0)) break;
              if ((pFVar15->idPlanet == uStack_90) &&
                 ((0 < pFVar15->rgcsh[0] && (pFVar15->iPlayer == idPlayer)))) {
                cFr = pFVar15->rgcsh[0];
                break;
              }
            }
            if (cFr < 10) {
LAB_1088_0bc9:
              sVar8 = Random(cFr * 2 + 1);
              if (sVar8 == 0) {
                AddItemToQueue(0,4,grobjFleet,1);
                fWrite = 1;
              }
            }
            else if (cFr < 0x11) {
              sVar8 = Random(10);
              if (sVar8 == 0) goto LAB_1088_0bc9;
            }
          }
        }
        for (i = 0; i < 3; i = i + 1) {
          uVar5 = *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
          if (((int)uVar5 < 1) &&
             (((int)uVar5 < 0 || (*(uint *)(((PLANET *)lppl)->rgwtMin + i) < 5000)))) break;
        }
        fTonsOfMinerals = (short)(i == 2);
        if (iLatestBomber != -1) {
          uStack_90 = lppl->id;
          for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
            pFVar15 = ((FLEET **)rglpfl)[ifl];
            iVar13 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
            lpfl = (FLEET *)CONCAT22(iVar13,pFVar15);
            if ((pFVar15 == (FLEET *)0x0) && (iVar13 == 0)) break;
            if ((pFVar15->idPlanet == uStack_90) && (pFVar15->iPlayer == idPlayer)) {
              sVar8 = FPotentRobWarFleet((FLEET *)CONCAT22(iVar13,pFVar15),2);
              if (sVar8 != 0) {
                if ((iLatestBomber != -1) &&
                   (uVar18 = (undefined2)((ulong)lpfl >> 0x10),
                   _uStack_92 = ((FLEET *)lpfl)->rgcsh[9] + ((FLEET *)lpfl)->rgcsh[10],
                   (int)_uStack_92 < (int)(uint)vrgAiArmadaPotency[2])) {
                  if (fTonsOfMinerals == 0) {
                    uVar10 = 4;
                  }
                  else {
                    uVar10 = 6;
                  }
                  AddItemToQueue(iLatestBomber,uVar10,grobjFleet,1);
                  fWrite = 1;
                  goto AI_FinishProd_4;
                }
                break;
              }
            }
          }
        }
        if (iLatestMeta != -1) {
          _uStack_92 = game.cPlanMax / 7 + 6;
          uStack_90 = 0;
          if ((*(int *)((int)&rgshdef[0].cExist + 2 + iLatestMeta * 0x93) != 0) ||
             ((uint)_uStack_92 <=
              (PLANET *)*(uint *)((int)&rgshdef[0].cExist + iLatestMeta * 0x93))) {
            sVar8 = Random(2);
            if (sVar8 == 0) goto AI_TryShip3_2;
          }
          if (iLatestBattle == -1) {
LAB_1088_0dd9:
            uStack_90 = iLatestMeta;
          }
          else {
            sVar8 = Random(2);
            if (sVar8 != 0) goto LAB_1088_0dd9;
            uStack_90 = iLatestBattle;
          }
          GetResourcesAvailable(lppl,rgResAvail);
          GetProdQCost(lppl,rgResCost);
          for (i = 0; i < 4; i = i + 1) {
            uVar9 = rgResCost[i * 2];
            uVar6 = rgResCost[i * 2 + 1];
            puVar1 = rgResAvail + i * 2;
            uVar5 = *puVar1;
            *puVar1 = *puVar1 - uVar9;
            rgResAvail[i * 2 + 1] = (rgResAvail[i * 2 + 1] - uVar6) - (uint)(uVar5 < uVar9);
            if (((int)rgResAvail[i * 2 + 1] < 1) && ((int)rgResAvail[i * 2 + 1] < 0))
            goto AI_FinishProd_4;
          }
          GetTrueHullCost(idPlayer,(HUL *)(uStack_90 * 0x93 + rgshdef),rgCosts);
          for (j = 0; j < 4; j = j + 1) {
            uVar9 = (uint)(((long)(int)rgCosts[j] * 3 & 0xffffU) / 5);
            puVar1 = rgResAvail + j * 2;
            uVar5 = *puVar1;
            *puVar1 = *puVar1 - uVar9;
            rgResAvail[j * 2 + 1] = rgResAvail[j * 2 + 1] - (uint)(uVar5 < uVar9);
            if (((int)rgResAvail[j * 2 + 1] < 1) && ((int)rgResAvail[j * 2 + 1] < 0))
            goto AI_TryShip3_2;
          }
          if (fTonsOfMinerals == 0) {
            uVar10 = 1;
          }
          else {
            uVar10 = 5;
          }
          AddItemToQueue(uStack_90,uVar10,grobjFleet,1);
          fWrite = 1;
        }
AI_TryShip3_2:
        if (iLatestDestroyer != -1) {
          _uStack_92 = game.cPlanMax / 0xc + 8;
          uStack_90 = 0;
          if ((*(int *)((int)&rgshdef[0].cExist + 2 + iLatestDestroyer * 0x93) == 0) &&
             ((PLANET *)*(uint *)((int)&rgshdef[0].cExist + iLatestDestroyer * 0x93) <
              (uint)_uStack_92)) {
            GetResourcesAvailable(lppl,rgResAvail);
            GetProdQCost(lppl,rgResCost);
            for (i = 0; i < 4; i = i + 1) {
              uVar9 = rgResCost[i * 2];
              uVar6 = rgResCost[i * 2 + 1];
              puVar1 = rgResAvail + i * 2;
              uVar5 = *puVar1;
              *puVar1 = *puVar1 - uVar9;
              rgResAvail[i * 2 + 1] = (rgResAvail[i * 2 + 1] - uVar6) - (uint)(uVar5 < uVar9);
              if (((int)rgResAvail[i * 2 + 1] < 1) && ((int)rgResAvail[i * 2 + 1] < 0))
              goto AI_FinishProd_4;
            }
            for (i = 0; i < 5; i = i + 1) {
              GetTrueHullCost
                        (idPlayer,(HUL *)(iLatestDestroyer * 0x93 + rgshdef),rgCosts);
              for (j = 0; j < 4; j = j + 1) {
                uVar9 = rgCosts[j];
                puVar1 = rgResAvail + j * 2;
                uVar5 = *puVar1;
                *puVar1 = *puVar1 - uVar9;
                rgResAvail[j * 2 + 1] = rgResAvail[j * 2 + 1] - (uint)(uVar5 < uVar9);
                if (((int)rgResAvail[j * 2 + 1] < 1) && ((int)rgResAvail[j * 2 + 1] < 0))
                goto AI_FinishProd_4;
              }
              fWrite = 1;
              AddItemToQueue(iLatestDestroyer,1,grobjFleet,1);
            }
          }
        }
AI_FinishProd_4:
        FinishProduction(fWrite);
      }
    }
  }
  UpdateProgressGauge(-0x39e);
  lpflAttack = (FLEET *)0x0;
  local_5c = 0;
  lpflEnemy = (FLEET *)0x0;
  local_16 = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar15 = ((FLEET **)rglpfl)[ifl];
    iVar13 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar13,pFVar15);
    if ((pFVar15 == (FLEET *)0x0) && (iVar13 == 0)) break;
    IVar11.wFlags = _lDist;
    uVar18 = _uStack_92;
    if ((1 < pFVar15->cord) && ((((PLORD *)pFVar15->lpplord + 7)->wFlags >> 8 & 0xf) == 8)) {
      dx = (&pFVar15->pt)->x - *(int *)&((PLORD *)pFVar15->lpplord)[5].iordMax;
      uStack_90 = (pFVar15->pt).y - ((PLORD *)pFVar15->lpplord + 6)->wFlags;
      uVar20 = __aFulmul((long)(int)uStack_90,(long)(int)uStack_90);
      local_9c._2_4_ = uVar20;
      uVar20 = __aFulmul((long)dx,(long)dx);
      pbVar2 = (byte *)(uVar20 + local_9c._2_4_);
      IVar11.wFlags = (ushort)pbVar2;
      uVar18 = (undefined2)((ulong)pbVar2 >> 0x10);
      lDist = SUB41(pbVar2,0);
      uStack_93 = (undefined1)((ulong)pbVar2 >> 8);
      uStack_92 = (undefined1)((ulong)pbVar2 >> 0x10);
      uStack_91 = (undefined1)((ulong)pbVar2 >> 0x18);
      if ((-1 < (long)pbVar2) && ((0 < (int)uVar18 || ((byte *)0x9c40 < IVar11.wFlags)))) {
        ChangeMainObjSel(2,lpfl->id);
        sel.fl.cord = 1;
        ((PLORD *)sel.fl.lpplord)->iordMac = 1;
        FLookupFleet(-1,(FLEET *)&sel.fl);
        IVar11.wFlags = (ushort)CONCAT11(uStack_93,lDist);
        uVar18 = (PLANET *)CONCAT11(uStack_91,uStack_92);
      }
    }
    _lDist = IVar11.wFlags;
    uVar19 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar15 = (FLEET *)lpfl;
    _uStack_92 = uVar18;
    if (pFVar15->iPlayer == idPlayer) {
      if (((pFVar15->rgcsh[0] < 1) || (game.turn < 0x29)) || (pFVar15->cord != 1)) {
        sVar8 = FIsAiAttack(lpfl);
        if (sVar8 == 0) {
          sVar8 = FIsAiTransport(lpfl);
          uVar18 = _uStack_92;
          if (sVar8 != 0) {
            idPlanDst = -1;
            uVar19 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar15 = (FLEET *)lpfl;
            if ((pFVar15->cord < 2) ||
               ((*(uint *)&((PLORD *)pFVar15->lpplord)[2].iordMax & 0xf) != 0)) {
              idPlanDst = pFVar15->idPlanet;
            }
            else if ((((PLORD *)pFVar15->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
              idPlanDst = *(short *)&((PLORD *)pFVar15->lpplord)[6].iordMax;
            }
            if (idPlanDst != -1) {
              lppl = LpplFromId(idPlanDst);
              iVar13 = (int)((ulong)lppl >> 0x10);
              uVar18 = _uStack_92;
              if ((((PLANET *)lppl == (PLANET *)0x0) && (iVar13 == 0)) ||
                 (((PLANET *)lppl)->iPlayer != idPlayer)) {
                uVar19 = (undefined2)((ulong)lpfl >> 0x10);
                if (((int)((FLEET *)lpfl)->rgwtMin[3] == 0) &&
                   (*(int *)((int)((FLEET *)lpfl)->rgwtMin + 0xe) == 0)) {
                  ChangeMainObjSel(2,lpfl->id);
                  sel.fl.cord = 1;
                  ((PLORD *)sel.fl.lpplord)->iordMac = 1;
                  FLookupFleet(-1,(FLEET *)&sel.fl);
                  ClearAiCurrentTask(lpfl,0);
                  uVar18 = _uStack_92;
                }
              }
            }
          }
        }
        else {
          *(FLEET **)&((FLEET *)lpfl)->lpflNext = lpflAttack;
          *(undefined2 *)((int)&((FLEET *)lpfl)->lpflNext + 2) = local_5c;
          lpflAttack = (FLEET *)lpfl;
          local_5c = lpfl._2_2_;
          if ((*(uint *)&((PLORD *)((FLEET *)lpfl)->lpplord)[2].iordMax & 0xf) == 6) {
            ClearAiCurrentTask(lpfl,1);
          }
          pPVar12 = vlpbAiPlanet._2_2_;
          j = 2;
          while( true ) {
            if ((7 < j) || (0 < ((FLEET *)lpfl)->rgcsh[j])) break;
            j = j + 1;
          }
          uVar18 = _uStack_92;
          if ((j < 8) &&
             (((1 < ((FLEET *)lpfl)->cord &&
               ((((PLORD *)((FLEET *)lpfl)->lpplord + 7)->wFlags >> 8 & 0xf) == 1)) ||
              (((FLEET *)lpfl)->idPlanet != -1)))) {
            if ((((FLEET *)lpfl)->cord < 2) ||
               ((((PLORD *)((FLEET *)lpfl)->lpplord + 7)->wFlags >> 8 & 0xf) != 1)) {
              uStack_90 = ((FLEET *)lpfl)->idPlanet;
            }
            else {
              uStack_90 = *(ushort *)&((PLORD *)((FLEET *)lpfl)->lpplord)[6].iordMax;
            }
            pbVar14 = (byte *)vlpbAiPlanet + uStack_90 * 0x10 + 10;
            lDist = SUB21(pbVar14,0);
            uStack_93 = (undefined1)((uint)pbVar14 >> 8);
            uStack_92 = SUB21(vlpbAiPlanet._2_2_,0);
            uStack_91 = (undefined1)((uint)vlpbAiPlanet._2_2_ >> 8);
            _lDist = pbVar14;
            uVar18 = pPVar12;
            if (*(char *)CONCAT13(uStack_91,CONCAT12(uStack_92,pbVar14)) != '\0') {
              pbVar2 = (byte *)CONCAT13(uStack_91,CONCAT12(uStack_92,pbVar14));
              *pbVar2 = *pbVar2 | 0x80;
            }
          }
        }
      }
      else {
        if (6 < pFVar15->rgcsh[0]) {
          sVar8 = Random(5);
          uVar18 = _uStack_92;
          if (sVar8 == 0) {
            uVar18 = (undefined2)((ulong)lpfl >> 0x10);
            pt.y = (((FLEET *)lpfl)->pt).y;
            pt.x = (&((FLEET *)lpfl)->pt)->x;
            idPlanDst = IdRandomPlanetNearby(pt,0x69,1);
            uVar18 = _uStack_92;
            if ((idPlanDst != -1) && (idPlanDst != ((FLEET *)lpfl)->idPlanet)) {
              ClearAiCurrentTask(lpfl,1);
              local_9c._0_2_ = idPlanDst;
              rgRecycleSBShdef = *(uint *)((int)&rgptPlan[0].y + idPlanDst * 4);
              local_9c._2_2_ = local_9c._2_2_ & 0xe000 | 0x1140;
              FMoveAiFleet(lpfl,&stack0xff60,0);
              uVar18 = _uStack_92;
              goto LAB_1088_15d1;
            }
          }
        }
        pPVar7 = ((FLEET *)lpfl)->lpplord;
        if ((*(uint *)&((PLORD *)pPVar7)[2].iordMax & 0xf) == 0) {
          _uStack_92 = uVar18;
          ChangeMainObjSel(2,lpfl->id);
          uVar18 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
          *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
               *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 6;
          ((PLORD *)sel.fl.lpplord + 3)->wFlags = 5;
          pbVar2 = &((PLORD *)sel.fl.lpplord)[3].iordMax;
          pbVar2[0] = 5;
          pbVar2[1] = 0;
          FLookupFleet(-1,(FLEET *)&sel.fl);
          goto LAB_1088_10bf;
        }
      }
LAB_1088_15d1:
      _uStack_92 = uVar18;
      pFVar15 = (FLEET *)lpfl;
      uVar18 = (undefined2)((ulong)lpfl >> 0x10);
      if ((game.turn < 0x15) && (0 < pFVar15->rgcsh[0])) {
        ChangeMainObjSel(2,lpfl->id);
        uVar18 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
        *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
             *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
        FLookupFleet(-1,(FLEET *)&sel.fl);
      }
      else if (((pFVar15->cord < 2) && (pFVar15->rgcsh[1] != 0)) &&
              ((4 < game.turn || (game.mdStartDist == 0)))) {
        IVar11.wFlags = _uStack_92;
        if ((1 < iAiLvl) && (pFVar15->idPlanet != -1)) {
          pPVar21 = LpplFromId(pFVar15->idPlanet);
          uStack_90 = (undefined2)((ulong)pPVar21 >> 0x10);
          IVar11.wFlags = (ushort)pPVar21;
          uStack_92 = SUB41(pPVar21,0);
          uStack_91 = (undefined1)((ulong)pPVar21 >> 8);
          if (((((PLANET *)IVar11.wFlags != (PLANET *)0x0) || (uStack_90 != 0)) &&
              (((PLANET *)IVar11.wFlags)->iPlayer != -1)) &&
             (((PLANET *)IVar11.wFlags)->iPlayer != idPlayer)) {
            uVar18 = (undefined2)((ulong)lpfl >> 0x10);
            iVar13 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0xe);
            if ((-1 < iVar13) && ((0 < iVar13 || ((int)((FLEET *)lpfl)->rgwtMin[3] != 0)))) {
              sVar8 = GetRaceStat((PLAYER *)rgplr +
                                        ((PLANET *)IVar11.wFlags)->iPlayer,rsMajorAdv);
              IVar11.wFlags = (ushort)CONCAT11(uStack_91,uStack_92);
              if (sVar8 != raMacintosh) {
                _memset(&stack0xff5c,0,0x12);
                rgRecycleSBShdef = rgRecycleSBShdef & 0xe0f0 | 0x1101;
                dx = dx & 0xfffU | 0x2000;
                ChangeMainObjSel(2,lpfl->id);
                uVar18 = sel.fl.lpplord._2_2_;
                pPVar17 = (PLORD *)sel.fl.lpplord + 1;
                puVar16 = &stack0xff5c;
                for (iVar13 = 9; iVar13 != 0; iVar13 = iVar13 + -1) {
                  pPVar7 = pPVar17;
                  pPVar17 = &pPVar17->iordMax;
                  puVar3 = puVar16;
                  puVar16 = puVar16 + 1;
                  pPVar7->wFlags = *puVar3;
                }
                FLookupFleet(-1,(FLEET *)&sel.fl);
                pPVar21 = LpplFindClosestEnum
                                    ((PLANET *)
                                     CONCAT22(uStack_90,(PLANET *)CONCAT11(uStack_91,uStack_92)),
                                     FEnumOurStarbase);
                uStack_92 = SUB41(pPVar21,0);
                uStack_91 = (undefined1)((ulong)pPVar21 >> 8);
                uStack_90 = (ushort)((ulong)pPVar21 >> 0x10);
                if (pPVar21 != (PLANET *)0x0) {
                  _memset(&stack0xff5c,0,0x12);
                  rgRecycleSBShdef = rgRecycleSBShdef & 0xe000 | 0x1140;
                  FMoveAiFleet(lpfl,&stack0xff5c,0);
                }
                _uStack_92 = (PLANET *)CONCAT11(uStack_91,uStack_92);
                goto LAB_1088_10bf;
              }
            }
          }
        }
        _uStack_92 = IVar11.wFlags;
        idPlanDst = IdNearestColonizablePlanet(lpfl,&lpthWorm);
        if (((idPlanDst == -1) && (lpthWorm == (THING *)0x0)) && (local_32 == 0)) {
          if (((FLEET *)lpfl)->idPlanet != -1) {
            ChangeMainObjSel(2,lpfl->id);
            uVar18 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
            *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                 *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
            FLookupFleet(-1,(FLEET *)&sel.fl);
          }
        }
        else {
          ChangeMainObjSel(2,lpfl->id);
          uVar18 = (undefined2)((ulong)lpfl >> 0x10);
          if (((FLEET *)lpfl)->idPlanet != -1) {
            XferAiSupply(1,((FLEET *)lpfl)->idPlanet,2,lpfl->id,3,10);
            FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
          }
          if (idPlanDst == -1) {
            FGotoWormholeAiFleet(lpfl,(THING *)CONCAT22(local_32,lpthWorm));
          }
          else {
            FColonizeAiFleet(lpfl,idPlanDst);
          }
        }
      }
    }
    else {
      *(FLEET **)&pFVar15->lpflNext = lpflEnemy;
      *(undefined2 *)((int)&pFVar15->lpflNext + 2) = local_16;
      lpflEnemy = pFVar15;
      local_16 = uVar19;
    }
LAB_1088_10bf:
  }
  for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
                    /* WARNING: Load size is inaccurate */
    pPVar12 = ((PLANET **)vrglpplAi)[ipl];
    iVar13 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
    lppl = (PLANET *)CONCAT22(iVar13,pPVar12);
    if (((pPVar12 == (PLANET *)0x0) && (iVar13 == 0)) || ((pPVar12->wFlags_0x4 >> 9 & 1) != 0))
    break;
  }
  if (ipl == vclpplAi) {
    lpplHome = (PLANET *)0x0;
    local_64 = 0;
  }
  else {
    lpplHome = (PLANET *)lppl;
    local_64 = lppl._2_2_;
  }
  if ((lpplHome != (PLANET *)0x0) || (local_64 != 0)) {
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar15 = ((FLEET **)rglpfl)[ifl];
      iVar13 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      lpfl = (FLEET *)CONCAT22(iVar13,pFVar15);
      if ((pFVar15 == (FLEET *)0x0) && (iVar13 == 0)) break;
      if ((pFVar15->iPlayer == idPlayer) && (pFVar15->cord < 2)) {
        sVar8 = FIsAiTransport((FLEET *)CONCAT22(iVar13,pFVar15));
        if (sVar8 != 0) {
          if (((FLEET *)lpfl)->iplan != 4) {
            ChangeMainObjSel(2,lpfl->id);
            sel.fl.iplan = 4;
            FLookupFleet(-1,(FLEET *)&sel.fl);
          }
          lppl = (PLANET *)0x0;
          i = 0;
          while( true ) {
            uVar18 = (undefined2)((ulong)vlpbAiData >> 0x10);
            pbVar14 = (byte *)vlpbAiData;
            if (*(int *)(pbVar14 + 2) <= i) break;
            j = 0;
            while ((j < *(int *)(pbVar14 + i * 0x14 + 6) &&
                   (uStack_90 = lpfl->id, *(ushort *)(pbVar14 + j * 2 + i * 0x14 + 8) != uStack_90))
                  ) {
              j = j + 1;
            }
            if (j < *(int *)(pbVar14 + i * 0x14 + 6)) break;
            i = i + 1;
          }
          if (i < *(int *)(pbVar14 + 2)) {
            lppl = LpplFromId(*(short *)(pbVar14 + i * 0x14 + 4));
          }
          if (((PLANET *)lppl != (PLANET *)0x0) ||
             (pPVar12 = lpplHome, iVar13 = local_64, lppl._2_2_ != 0)) {
            pPVar12 = (PLANET *)lppl;
            iVar13 = lppl._2_2_;
          }
          IdTargetFreighter(lpfl,(PLANET *)CONCAT22(iVar13,pPVar12));
        }
      }
    }
    UpdateProgressGauge(-0x39e);
  }
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar15 = ((FLEET **)rglpfl)[ifl];
    iVar13 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar13,pFVar15);
    if ((pFVar15 == (FLEET *)0x0) && (iVar13 == 0)) break;
    if (pFVar15->iPlayer == idPlayer) {
      for (i = 0; (i < 0x10 && ((pFVar15->rgcsh[i] < 1 || (rgRecycleShdef[i] != 0)))); i = i + 1) {
      }
      if (i == 0x10) {
        if (pFVar15->idPlanet != -1) {
          lppl = LpplFromId(pFVar15->idPlanet);
          uVar18 = (undefined2)((ulong)lppl >> 0x10);
          if ((lppl != (PLANET *)0x0) && (((PLANET *)lppl)->iPlayer == idPlayer)) {
            if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0) {
              sVar8 = Random(5);
              if (sVar8 != 0) goto LAB_1088_1d52;
            }
            ChangeMainObjSel(2,lpfl->id);
            uVar18 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
            *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                 *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
            FLookupFleet(-1,(FLEET *)&sel.fl);
            goto LAB_1088_1c04;
          }
        }
LAB_1088_1d52:
        uVar18 = (undefined2)((ulong)lpfl >> 0x10);
        pFVar15 = (FLEET *)lpfl;
        if (((pFVar15->cord < 2) || (pFVar15->idPlanet != -1)) ||
           ((((PLORD *)pFVar15->lpplord + 7)->wFlags >> 8 & 0xf) != 1)) {
          sVar8 = FMoveToNearestStarbase(lpfl,0);
          if (sVar8 == 0) goto LAB_1088_1da4;
        }
      }
      else {
LAB_1088_1da4:
        for (i = 2; i < 0xb; i = i + 1) {
          if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
            IdTargetArmada(lpfl);
            break;
          }
        }
        if (10 < i) {
          sVar8 = FIsAiAttack(lpfl);
          if (sVar8 != 0) {
            uVar18 = (undefined2)((ulong)lpfl >> 0x10);
            if ((((FLEET *)lpfl)->cord < 2) ||
               (pPVar7 = ((FLEET *)lpfl)->lpplord, (((PLORD *)pPVar7 + 7)->wFlags >> 8 & 0xf) != 2))
            {
              if (game.turn < 0x79) {
                iVar13 = 0x46;
              }
              else {
                iVar13 = 0x32;
              }
              if (iVar13 < cFlDestroyers) {
LAB_1088_1e81:
                if (0x13 < ((FLEET *)lpfl)->rgcsh[iLatestDestroyer]) {
                  sVar8 = Random(0x14);
                  if (sVar8 != 0) goto LAB_1088_1ee3;
                }
                sVar8 = FFindBuddyAndJoinUp(lpfl,0xe,0xf,0x24,0x48);
                if (sVar8 != 0) goto LAB_1088_1c04;
              }
              else {
                if (game.turn < 0x79) {
                  iVar13 = 0x3c;
                }
                else {
                  iVar13 = 0x28;
                }
                if (iVar13 < cFlDestroyers) {
                  sVar8 = Random(3);
                  if (sVar8 == 0) goto LAB_1088_1e81;
                }
              }
LAB_1088_1ee3:
              IdTargetAttack(lpfl,(FLEET *)CONCAT22(local_5c,lpflAttack),
                                  (FLEET *)CONCAT22(local_16,lpflEnemy),game.wCrap >> 4 & 1);
            }
          }
        }
      }
    }
LAB_1088_1c04:
  }
  HandleBasicAiTasks(iroCur,rgprod,ishdefSBLatest,rgResAvail,rgResCost);
  FillProductionQueue();
  return;
}



// ======================================================================
// Function: EnsureRobotoidShdefs
// Address: 1088:20ae
// Segment: MEMORY_AI
// ======================================================================


void EnsureRobotoidShdefs(void)

{
  SHDEF *pSVar1;
  HullDef *pHVar2;
  int iVar3;
  short sVar4;
  SHDEF *pSVar5;
  HullDef *pHVar6;
  undefined2 unaff_SS;
  undefined1 shdef [146];
  short shBase;
  short i;
  short ish;
  
  for (ish = 0xb; ish < 0xe; ish = ish + 1) {
    if (((((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0) &&
         ('\x01' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) &&
        (shBase = (short)*(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0),
        (ish + -0xb) * 3 + 4 <= shBase)) &&
       ((ish == 0xb ||
        (0xe < game.turn - *(int *)((int)&rgshdef[0].turn + (ish + -1) * 0x93)))))
    {
      if (*(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) < '\n') {
        if (ish == 0xb) {
          iVar3 = 0xe;
        }
        else {
          iVar3 = 0xf;
        }
        FCreateAiShdef(ish,0xb,(byte *)(((ushort *)vrgRobIshAip)[iVar3] + 0x1f80));
      }
      else {
        for (i = 0; i < 5; i = i + 1) {
          sVar4 = Random(6);
          sVar4 = FCreateAiShdef(ish,0x1f,(byte *)(((ushort *)vrgRobIshAip)[sVar4 + 8] + 0x1f80
                                                       ));
          if (sVar4 != 0) break;
        }
      }
    }
  }
  if ((((rgshdef[0xe].wFlags >> 9 & 1) != 0) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
     (('\x05' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) &&
      ((('\x05' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
        ('\x05' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) &&
       ('\x01' < *(char *)((int)rgplr[0].rgTech + idPlayer * 0xc0))))))) {
    for (i = 0; i < 5; i = i + 1) {
      sVar4 = FCreateAiShdef(0xe,0x1d,(byte *)(vrgRobIshAip[0x25] + vrgRobAip));
      if (sVar4 == 0) {
        sVar4 = Random(4);
        sVar4 = FCreateAiShdef(0xe,6,(byte *)(((ushort *)vrgRobIshAip)[sVar4 + 0x10] + 0x1f80))
        ;
        if (sVar4 != 0) break;
      }
    }
  }
  if ((((rgshdef[0xf].wFlags >> 9 & 1) != 0) &&
      ('\t' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0))) &&
     ((('\a' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
       (('\b' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0) &&
        ('\r' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))))) &&
      (sVar4 = FCreateAiShdef(0xf,0x1d,(byte *)(vrgRobIshAip[0x25] + vrgRobAip)), sVar4 == 0)))
     ) {
    for (i = 0; i < 5; i = i + 1) {
      sVar4 = Random(4);
      sVar4 = FCreateAiShdef(0xf,6,(byte *)(((ushort *)vrgRobIshAip)[sVar4 + 0x14] + 0x1f80));
      if (sVar4 != 0) break;
    }
  }
  for (ish = 2; ish < 6; ish = ish + 1) {
    if (((((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0) &&
         ('\t' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
        ('\t' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0))) &&
       ((('\b' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0) &&
         ('\x05' < *(char *)((int)rgplr[0].rgTech + idPlayer * 0xc0))) &&
        ((ish == 2 ||
         (((*(uint *)((int)&rgshdef[0].wFlags + (ish + -1) * 0x93) >> 9 & 1) == 0 &&
          (0xc < game.turn - *(int *)((int)&rgshdef[0].turn + (ish + -1) * 0x93))))
         ))))) {
      if ((ish - 2U & 1) == 0) {
        shBase = 0;
      }
      else {
        shBase = 4;
      }
      for (i = 0; i < 5; i = i + 1) {
        sVar4 = Random(4);
        sVar4 = FCreateAiShdef(ish,0x1f,(byte *)(((ushort *)vrgRobIshAip)[sVar4 + shBase] +
                                                     0x1f80));
        if (sVar4 != 0) break;
      }
    }
  }
  ish = 6;
  do {
    if (7 < ish) {
      for (ish = 9; ish < 0xb; ish = ish + 1) {
        if (((((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0) &&
             ('\r' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
            ((ish == 9 ||
             (((*(uint *)((int)&rgshdef[0].wFlags + (ish + -1) * 0x93) >> 9 & 1) == 0 &&
              (0xf < game.turn -
                     *(int *)((int)&rgshdef[0].turn + (ish + -1) * 0x93))))))) &&
           (sVar4 = FCreateAiShdef(ish,9,(byte *)(vrgRobIshAip[0x24] + vrgRobAip)), sVar4 == 0)
           ) {
          if (ish == 9) {
            iVar3 = 0x18;
          }
          else {
            iVar3 = 0x19;
          }
          FCreateAiShdef(ish,0x13,(byte *)(((ushort *)vrgRobIshAip)[iVar3] + 0x1f80));
        }
      }
      if ((((((rgshdef[0].hul.ihuldef != ihuldefFrigate) &&
             (1 < (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7)))
            && ((int)rgshdef[0].cExist == 0)) &&
           ((rgshdef[0].cExist._2_2_ == 0 &&
            ('\x03' < *(char *)((int)rgplr[0].rgTech + 5 + idPlayer * 0xc0))))) &&
          (('\x04' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) &&
           (('\x05' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
            ('\x05' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0)))))))
         && ('\x05' < *(char *)((int)rgplr[0].rgTech + idPlayer * 0xc0))) {
        pSVar5 = (SHDEF *)rgshdef;
        pHVar6 = shdef;
        for (iVar3 = 0x49; iVar3 != 0; iVar3 = iVar3 + -1) {
          pHVar2 = pHVar6;
          pHVar6 = pHVar6 + 1;
          pSVar1 = pSVar5;
          pSVar5 = (pSVar5->hul).rgTech;
          *pHVar2 = (pSVar1->hul).ihuldef;
        }
        *(char *)pHVar6 = (char)(pSVar5->hul).ihuldef;
        shdef._123_2_ = shdef._123_2_ & 0xfdff | 0x200;
        FChangeAiShdef(shdef,0);
        FCreateAiShdef(0,5,(byte *)(vrgRobIshAip[0x1a] + vrgRobAip));
      }
      return;
    }
    if (((((((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0) &&
           ('\x03' < *(char *)((int)rgplr[0].rgTech + 5 + idPlayer * 0xc0))) &&
          ('\t' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0))) &&
         (('\v' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
          ('\v' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))) &&
        ('\x05' < *(char *)((int)rgplr[0].rgTech + idPlayer * 0xc0))) &&
       (('\x0e' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0) &&
        ((ish == 6 ||
         (((*(uint *)((int)&rgshdef[0].wFlags + (ish + -1) * 0x93) >> 9 & 1) == 0 &&
          (0x14 < game.turn - *(int *)((int)&rgshdef[0].turn + (ish + -1) * 0x93)))
         )))))) {
      if (ish == 6) {
        shBase = 0x1b;
      }
      else {
        shBase = 0x1f;
      }
      for (i = 0; i < 5; i = i + 1) {
        sVar4 = Random(4);
        sVar4 = FCreateAiShdef(ish,9,(byte *)(((ushort *)vrgRobIshAip)[sVar4 + shBase] + 0x1f80
                                                  ));
        if (sVar4 != 0) break;
      }
    }
    ish = ish + 1;
  } while( true );
}



// ======================================================================
// Function: IdTargetArmada
// Address: 1088:288e
// Segment: MEMORY_AI
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1088316e) */
/* WARNING: Removing unreachable block (ram,0x108830bb) */
/* WARNING: Removing unreachable block (ram,0x108828ed) */
/* WARNING: Removing unreachable block (ram,0x10883007) */
/* WARNING: Removing unreachable block (ram,0x10883131) */
/* WARNING: Removing unreachable block (ram,0x10882b7b) */

short IdTargetArmada(FLEET *lpfl)

{
  short *psVar1;
  ORDER *pOVar2;
  PLANET *pPVar3;
  int iVar4;
  short sVar5;
  int iVar6;
  FLEET *pFVar7;
  short *psVar8;
  ORDER *pOVar9;
  undefined2 uVar10;
  undefined2 unaff_SS;
  PLANET *pPVar11;
  ulong uVar12;
  long lVar13;
  POINT pt1;
  POINT pt2;
  undefined2 uVar14;
  uint uVar15;
  undefined2 uVar16;
  long lVar17;
  ushort in_stack_0000ffd0;
  short cshBomb;
  short cCol;
  PLANET *lppl;
  short ish;
  ORDER ord;
  PLANET *lpplTarget;
  FLEET *lpflTarget;
  short cshWar;
  
  uVar10 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar7 = (FLEET *)lpfl;
  if (1 < pFVar7->cord) {
    uVar14 = *(undefined2 *)((int)&pFVar7->lpplord + 2);
    psVar8 = (short *)(*(int *)&pFVar7->lpplord + 0x16);
    pOVar9 = &ord;
    for (iVar4 = 9; iVar4 != 0; iVar4 = iVar4 + -1) {
      pOVar2 = pOVar9;
      pOVar9 = &(pOVar9->pt).y;
      psVar1 = psVar8;
      psVar8 = psVar8 + 1;
      (pOVar2->pt).x = *psVar1;
    }
    pt2.y = ord.pt.y;
    pt2.x = ord.pt.x;
    pt1.y = (pFVar7->pt).y;
    pt1.x = (&pFVar7->pt)->x;
    lVar13 = LDistance2(pt1,pt2);
    if ((lVar13 < 0xf425) || ((ord.wFlags_0x6 >> 8 & 0xf) != 2)) {
      if ((ord.wFlags_0x6 >> 8 & 0xf) == 2) {
        return 0;
      }
      if ((ord.wFlags_0x6 >> 8 & 0xf) == 1) {
        pPVar11 = LpplFromId(ord.id);
        iVar4 = (int)((ulong)pPVar11 >> 0x10);
        pPVar3 = (PLANET *)pPVar11;
        if ((((pPVar3 == (PLANET *)0x0) && (iVar4 == 0)) ||
            ((pPVar3->iPlayer != -1 &&
             ((pPVar3->iPlayer != idPlayer || ((pPVar3->wFlags_0x4 >> 9 & 1) != 0)))))) ||
           (pPVar3->turn != game.turn)) {
          return 0;
        }
      }
    }
  }
  cshWar = 0;
  for (ish = 2; ish < 6; ish = ish + 1) {
    cshWar = cshWar + pFVar7->rgcsh[ish];
  }
  for (ish = 6; ish < 8; ish = ish + 1) {
    cshWar = cshWar + pFVar7->rgcsh[ish] * 2;
  }
  iVar4 = pFVar7->rgcsh[9] + pFVar7->rgcsh[10];
  pFVar7->wFlags_0x4 = pFVar7->wFlags_0x4 & 0x7fff | 0x8000;
  ChangeMainObjSel(2,lpfl->id);
  if (pFVar7->idPlanet == -1) {
    MoveToNearestPlanetOrEnemy(lpfl,0x96);
    return 0;
  }
  pPVar11 = LpplFromId(pFVar7->idPlanet);
  uVar14 = (undefined2)((ulong)pPVar11 >> 0x10);
  pPVar3 = (PLANET *)pPVar11;
  if ((pPVar3->iPlayer == idPlayer) && ((pPVar3->wFlags_0x4 >> 9 & 1) != 0)) {
    if ((cshWar < (int)(uint)vrgAiArmadaPotency[0]) ||
       (iVar4 < (int)(uint)vrgAiArmadaPotency[2])) {
      if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) < 2) {
        return 0;
      }
      if ((cshWar <= (int)((uint)vrgAiArmadaPotency[0] * 2)) && (cshWar < 0x3c)) {
        return 0;
      }
      sVar5 = Random(10);
      if ((4 < sVar5) &&
         ((cshWar <= (int)((uint)vrgAiArmadaPotency[0] * 3) ||
          (sVar5 = Random(10), 6 < sVar5)))) {
        if (cshWar < 0x79) {
          return 0;
        }
        sVar5 = Random(10);
        if (6 < sVar5) {
          return 0;
        }
      }
    }
    else {
      if ((sel.pl.rgwtMin[3]._2_2_ < 0) ||
         ((sel.pl.rgwtMin[3]._2_2_ < 1 && ((uint)sel.pl.rgwtMin[3] < 0xbb9)))) {
        if ((sel.pl.rgwtMin[3]._2_2_ < 0) ||
           ((sel.pl.rgwtMin[3]._2_2_ < 1 && ((uint)sel.pl.rgwtMin[3] < 0x7d1))))
        {
          if ((sel.pl.rgwtMin[3]._2_2_ < 0) ||
             ((sel.pl.rgwtMin[3]._2_2_ < 1 && ((uint)sel.pl.rgwtMin[3] < 0x3e9))
             )) {
            lVar13 = 0;
          }
          else {
            lVar13 = __aFldiv(CONCAT22(sel.pl.rgwtMin[3]._2_2_,
                                               (uint)sel.pl.rgwtMin[3]),0x14);
          }
        }
        else {
          lVar13 = __aFldiv(CONCAT22(sel.pl.rgwtMin[3]._2_2_,
                                             (uint)sel.pl.rgwtMin[3]),0xf);
        }
      }
      else {
        lVar13 = __aFldiv(CONCAT22(sel.pl.rgwtMin[3]._2_2_,
                                           (uint)sel.pl.rgwtMin[3]),10);
      }
      cCol = (short)lVar13;
      if (0 < lVar13) {
        XferAiSupply(1,pFVar7->idPlanet,2,lpfl->id,3,cCol);
        FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
      }
    }
  }
  else if ((cshWar < (int)(uint)vrgAiArmadaPotency[1]) ||
          (iVar4 < (int)(uint)vrgAiArmadaPotency[3])) {
    ClearAiCurrentTask(lpfl,0);
    if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) < 2) ||
       ((((cshWar <= (int)((uint)vrgAiArmadaPotency[0] * 2) ||
          (sVar5 = Random(10), 4 < sVar5)) &&
         ((cshWar <= (int)((uint)vrgAiArmadaPotency[0] * 4) ||
          (sVar5 = Random(10), 6 < sVar5)))) &&
        ((cshWar < 0x79 || (sVar5 = Random(10), 6 < sVar5)))))) {
      lpplTarget = LpplFindClosestEnum(pPVar11,FEnumOurStarbase);
      goto AI_TargetEveryArmada_3;
    }
  }
  else if (pPVar3->iPlayer != -1) {
    if (pPVar3->iPlayer != idPlayer) {
      if (pPVar3->iPlayer == idPlayer) {
        return 0;
      }
      lVar17 = CONCAT22(*(undefined2 *)((int)pFVar7->rgwtMin + 0xe),(int)pFVar7->rgwtMin[3]);
      __aFlshl(lVar17,in_stack_0000ffd0);
      uVar12 = __aFulmul((ulong)(pPVar3->uGuesses >> 0xc),6);
      uVar16 = 0;
      uVar14 = 4;
      uVar12 = __aFulmul(uVar12 + 6,3);
      lVar13 = __aFldiv(uVar12,CONCAT22(uVar16,uVar14));
      iVar4 = 100 - (uint)lVar13;
      iVar6 = -(uint)(100 < (uint)lVar13) - (int)((ulong)lVar13 >> 0x10);
      uVar12 = __aFulmul(CONCAT22(iVar6,iVar4),100);
      __aFldiv(uVar12,CONCAT22(iVar6,iVar4));
      iVar4 = 0;
      uVar15 = 5;
      lVar13 = __aFldiv(lVar17,5);
      if (lVar13 <= CONCAT22(iVar4,uVar15)) {
        iVar6 = (int)((ulong)lVar17 >> 0x10);
        if (((0 < iVar4) || ((-1 < iVar4 && (199 < uVar15)))) ||
           ((iVar6 < 1 && ((lVar17 < 0 || ((uint)lVar17 < 0x15f)))))) {
          if (0 < iVar4) {
            return 0;
          }
          if ((-1 < iVar4) && (9 < uVar15)) {
            return 0;
          }
          if (lVar17 < 0) {
            return 0;
          }
          if ((iVar6 < 1) && ((uint)lVar17 < 0x97)) {
            return 0;
          }
        }
      }
      uVar16 = 0;
      uVar14 = 4;
      uVar12 = __aFulmul(4,5);
      __aFldiv(uVar12,CONCAT22(uVar16,uVar14));
      uVar14 = *(undefined2 *)((int)pFVar7->rgwtMin + 0xe);
      uVar16 = (undefined2)pFVar7->rgwtMin[3];
      lVar13 = __aFldiv(CONCAT22(uVar14,uVar16),2);
      if (lVar13 < CONCAT22(uVar14,uVar16)) {
        lVar13 = CONCAT22(uVar14,uVar16);
      }
      else {
        lVar13 = __aFldiv(CONCAT22(*(undefined2 *)((int)pFVar7->rgwtMin + 0xe),
                                           (int)pFVar7->rgwtMin[3]),2);
      }
      iVar6 = (int)((ulong)lVar13 >> 0x10);
      iVar4 = *(int *)((int)pFVar7->rgwtMin + 0xe);
      if ((iVar6 < iVar4) || ((iVar6 <= iVar4 && ((uint)lVar13 <= *(uint *)(pFVar7->rgwtMin + 3)))))
      {
        uVar14 = *(undefined2 *)((int)pFVar7->rgwtMin + 0xe);
        uVar16 = (undefined2)pFVar7->rgwtMin[3];
        lVar13 = __aFldiv(CONCAT22(uVar14,uVar16),2);
        if (lVar13 < CONCAT22(uVar14,uVar16)) {
          lVar13 = CONCAT22(uVar14,uVar16);
        }
        else {
          lVar13 = __aFldiv(CONCAT22(*(undefined2 *)((int)pFVar7->rgwtMin + 0xe),
                                             (int)pFVar7->rgwtMin[3]),2);
        }
      }
      else {
        lVar13 = CONCAT22(*(undefined2 *)((int)pFVar7->rgwtMin + 0xe),(int)pFVar7->rgwtMin[3]);
      }
      sVar5 = (short)lVar13;
      if (30000 < lVar13) {
        sVar5 = 30000;
      }
      XferAiTroopers(lpfl->id,pPVar11->id,sVar5);
      FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
      return 0;
    }
    iVar4 = *(int *)((int)pPVar3->rgwtMin + 0xe);
    if ((-1 < iVar4) && ((0 < iVar4 || (1000 < *(uint *)(pPVar3->rgwtMin + 3))))) {
      XferAiSupply(1,pFVar7->idPlanet,2,lpfl->id,3,(int)pPVar3->rgwtMin[3] / 5);
      FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
    }
  }
  if ((game.wCrap >> 4 & 1) == 0) {
    lpplTarget = (PLANET *)0x0;
  }
  else {
    lpplTarget = LpplFindBestEnum(pPVar11,FEnumCalcArmadaHumanDest);
  }
  if (((PLANET *)lpplTarget == (PLANET *)0x0) && (lpplTarget._2_2_ == 0)) {
    lpplTarget = LpplFindBestEnum(pPVar11,FEnumCalcArmadaDest);
  }
AI_TargetEveryArmada_3:
  if (((PLANET *)lpplTarget == (PLANET *)0x0) && (lpplTarget._2_2_ == 0)) {
    lpflTarget = LpflFindClosestEnum(lpfl,FEnumCalcEnemyFleets);
    iVar4 = (int)((ulong)lpflTarget >> 0x10);
    pFVar7 = (FLEET *)lpflTarget;
    if ((pFVar7 == (FLEET *)0x0) && (iVar4 == 0)) {
      return 0;
    }
    ord.id = lpflTarget->id;
    ord.wFlags_0x6 = ord.wFlags_0x6 & 0xf0ff | 0x200;
    ord.pt.x = (&pFVar7->pt)->x;
    ord.pt.y = (pFVar7->pt).y;
  }
  else {
    ((byte *)vlpbAiPlanet)[lpplTarget->id * 0x10 + 10] =
         ((byte *)vlpbAiPlanet)[lpplTarget->id * 0x10 + 10] | 0x80;
    ord.id = lpplTarget->id;
    ord.wFlags_0x6 = ord.wFlags_0x6 & 0xf0ff | 0x100;
    ord.pt.x = ((POINT *)rgptPlan + lpplTarget->id)->x;
    ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplTarget->id * 4);
  }
  ord.wFlags_0x6 = ord.wFlags_0x6 & 0xef00 | 0x1040;
  sVar5 = FMoveAiFleet(lpfl,&ord,0);
  if (sVar5 != 0) {
    return 0;
  }
  return -1;
}



// ======================================================================
// Function: FPotentRobWarFleet
// Address: 1088:31bc
// Segment: MEMORY_AI
// ======================================================================


short FPotentRobWarFleet(FLEET *lpfl,short iPotency)

{
  uint uVar1;
  short cEquiv;
  short ish;
  
  cEquiv = 0;
  ish = 2;
  while( true ) {
    if (5 < ish) break;
    cEquiv = cEquiv + ((FLEET *)lpfl)->rgcsh[ish];
    ish = ish + 1;
  }
  for (ish = 6; ish < 8; ish = ish + 1) {
    cEquiv = cEquiv + ((FLEET *)lpfl)->rgcsh[ish] * 2;
  }
  if (iPotency < 2) {
    uVar1 = 1;
  }
  else {
    uVar1 = (uint)((int)(uint)vrgAiArmadaPotency[0] <= cEquiv);
  }
  return uVar1;
}



// ======================================================================
// Function: FEnumCalcEnemyFleets
// Address: 1088:325c
// Segment: MEMORY_AI
// ======================================================================


short FEnumCalcEnemyFleets(FLEET *lpflSrc,FLEET *lpflTest)

{
  return (uint)(((FLEET *)lpflTest)->iPlayer != idPlayer);
}



// ======================================================================
// Function: FEnumCalcArmadaDest
// Address: 1088:3286
// Segment: MEMORY_AI
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1088339e) */
/* WARNING: Removing unreachable block (ram,0x10883360) */
/* WARNING: Removing unreachable block (ram,0x10883322) */
/* WARNING: Removing unreachable block (ram,0x10883341) */
/* WARNING: Removing unreachable block (ram,0x1088337f) */
/* WARNING: Removing unreachable block (ram,0x108833bd) */

short FEnumCalcArmadaDest(PLANET *lpplSrc,PLANET *lpplTest)

{
  short sVar1;
  long lVar2;
  POINT pt1;
  POINT pt2;
  byte b;
  short id;
  
  if ((((PLANET *)lpplSrc != (PLANET *)lpplTest) || (lpplSrc._2_2_ != lpplTest._2_2_)) &&
     (b = ((byte *)vlpbAiPlanet)[lpplTest->id * 0x10 + 10], b != 0)) {
    pt2.y = *(short *)((int)&rgptPlan[0].y + lpplTest->id * 4);
    pt2.x = ((POINT *)rgptPlan + lpplTest->id)->x;
    pt1.y = *(short *)((int)&rgptPlan[0].y + lpplSrc->id * 4);
    pt1.x = ((POINT *)rgptPlan + lpplSrc->id)->x;
    lVar2 = LDistance2(pt1,pt2);
    if (lVar2 < 0x9c4) {
      b = b + 7;
    }
    else if (lVar2 < 10000) {
      b = b + 5;
    }
    else if (lVar2 < 0x57e4) {
      b = b + 4;
    }
    else if (lVar2 < 40000) {
      b = b + 3;
    }
    else if (lVar2 < 90000) {
      b = b + 2;
    }
    else if (lVar2 < 250000) {
      b = b + 1;
    }
    if (((b & 0x80) == 0) || (sVar1 = Random(4), sVar1 == 0)) {
      return (uint)b;
    }
  }
  return 0;
}



// ======================================================================
// Function: FEnumCalcArmadaHumanDest
// Address: 1088:3406
// Segment: MEMORY_AI
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10883546) */
/* WARNING: Removing unreachable block (ram,0x10883508) */
/* WARNING: Removing unreachable block (ram,0x108834ca) */
/* WARNING: Removing unreachable block (ram,0x108834e9) */
/* WARNING: Removing unreachable block (ram,0x10883527) */
/* WARNING: Removing unreachable block (ram,0x10883565) */

short FEnumCalcArmadaHumanDest(PLANET *lpplSrc,PLANET *lpplTest)

{
  short sVar1;
  long lVar2;
  POINT pt1;
  POINT pt2;
  byte b;
  short id;
  
  if (((((PLANET *)lpplSrc != (PLANET *)lpplTest) || (lpplSrc._2_2_ != lpplTest._2_2_)) &&
      ((*(uint *)((int)&rgplr[0].wMdPlr + ((PLANET *)lpplTest)->iPlayer * 0xc0) >> 9 & 1)
       == 0)) && (b = ((byte *)vlpbAiPlanet)[lpplTest->id * 0x10 + 10], b != 0)) {
    pt2.y = *(short *)((int)&rgptPlan[0].y + lpplTest->id * 4);
    pt2.x = ((POINT *)rgptPlan + lpplTest->id)->x;
    pt1.y = *(short *)((int)&rgptPlan[0].y + lpplSrc->id * 4);
    pt1.x = ((POINT *)rgptPlan + lpplSrc->id)->x;
    lVar2 = LDistance2(pt1,pt2);
    if (lVar2 < 0x9c4) {
      b = b + 7;
    }
    else if (lVar2 < 10000) {
      b = b + 5;
    }
    else if (lVar2 < 0x57e4) {
      b = b + 4;
    }
    else if (lVar2 < 40000) {
      b = b + 3;
    }
    else if (lVar2 < 90000) {
      b = b + 2;
    }
    else if (lVar2 < 250000) {
      b = b + 1;
    }
    if (((b & 0x80) == 0) || (sVar1 = Random(4), sVar1 == 0)) {
      return (uint)b;
    }
  }
  return 0;
}



// ======================================================================
// Function: DoTurinDroneAiTurn
// Address: 1088:3670
// Segment: MEMORY_AI
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10883d92) */
/* WARNING: Removing unreachable block (ram,0x108845a2) */
/* WARNING: Removing unreachable block (ram,0x1088442c) */
/* WARNING: Removing unreachable block (ram,0x10883db3) */
/* WARNING: Removing unreachable block (ram,0x10883fc0) */
/* WARNING: Removing unreachable block (ram,0x10883db8) */
/* WARNING: Removing unreachable block (ram,0x108842b4) */
/* WARNING: Removing unreachable block (ram,0x10883e88) */
/* WARNING: Removing unreachable block (ram,0x1088472b) */
/* WARNING: Removing unreachable block (ram,0x10883eb7) */

void DoTurinDroneAiTurn(PROD *rgprod)

{
  uint *puVar1;
  byte *pbVar2;
  ORDER *pOVar3;
  PLORD *pPVar4;
  int iVar5;
  uint uVar6;
  uint uVar7;
  short sVar8;
  uint uVar9;
  PLANET *pPVar10;
  PLORD *pPVar11;
  FLEET *pFVar12;
  byte *pbVar13;
  undefined2 unaff_SI;
  ORDER *pOVar14;
  undefined2 unaff_DI;
  undefined2 uVar15;
  long lVar16;
  ulong uVar17;
  PLANET *pPVar18;
  uint in_stack_0000ff4a;
  int iVar19;
  short pct;
  short iPlanet;
  short fWrite;
  PROD *lpprod;
  short iLatestBomber;
  short iLatestBattle;
  short cplBadGuy;
  short cFr;
  ushort cplanCol;
  ushort cRecyclePeriod;
  short ipl;
  short cplNegative;
  short ishdefSBLatest;
  PLANET *lpplMac;
  int local_8e;
  short cplMiners;
  short iLatestCargo;
  short iLatestMiner;
  short iroCur;
  short cRes;
  byte b;
  FLEET *lpflT;
  short i;
  short ifl;
  FLEET *lpfl;
  FLEET *lpflAttack;
  undefined2 local_72;
  PLANET *lpplHome;
  int local_6e;
  ushort rgCosts [4];
  short iLatestTroop;
  PLANET *lppl;
  ORDER ord;
  short iLatestLayer;
  short j;
  short idPlanDst;
  byte rgRecycleShdef [16];
  PLANET *lpplDest;
  THING *lpthWorm;
  int local_30;
  short iLatestDestroyer;
  short cExistCargo;
  FLEET *lpflEnemy;
  int local_28;
  uint rgResAvail [8];
  short iLatestCruiser;
  uint rgResCost [9];
  
  cplBadGuy = 0;
  cplNegative = 0;
  cplanCol = 0;
  cplMiners = 0;
  iroCur = IroEnsureAi(vrgAiTurinDroneResOrder,0x1f,&ishdefSBLatest,0xf);
  if ((rgshdef[0xd].wFlags >> 9 & 1) == 0) {
    MergeAllShdefs(-0x1f10);
  }
  if ((rgshdef[0xc].wFlags >> 9 & 1) == 0) {
    MergeAllShdefs(0x1000);
  }
  if ((rgshdef[10].wFlags >> 9 & 1) == 0) {
    MergeAllShdefs(0xc00);
  }
  if ((rgshdef[2].wFlags >> 9 & 1) == 0) {
    MergeAllShdefs(0xc);
  }
  j = 3;
  if (0x82 < game.turn) {
    j = (game.turn - 0x78) / 0x14 + 3;
  }
  if (0x32 < (uint)j) {
    j = 0x32;
  }
  vrgAiArmadaPotency[0] = (byte)j;
  vrgAiArmadaPotency[1] = (byte)((ulong)(j & 0xff) / 2);
  j = 6;
  if (0x73 < game.turn) {
    j = (game.turn - 100) / 0x16 + 6;
  }
  if (0xc < (uint)j) {
    j = 0xc;
  }
  vrgAiArmadaPotency[2] = (byte)j;
  if ((int)((uint)j / 2 - 1) < 4) {
    vrgAiArmadaPotency[3] = (char)((uint)j / 2) - 1;
  }
  else {
    vrgAiArmadaPotency[3] = 3;
  }
  _memset(rgRecycleShdef,0,0x10);
  if (game.turn < 0x78) {
    cRecyclePeriod = 0x32;
  }
  else if (game.turn < 200) {
    cRecyclePeriod = 0x46;
  }
  else {
    cRecyclePeriod = 100;
  }
  CheckAiShdefStatus(6,7,cRecyclePeriod,&iLatestCruiser,rgRecycleShdef);
  cExistCargo = CheckAiShdefStatus(8,9,cRecyclePeriod,&iLatestCargo,rgRecycleShdef);
  CheckAiShdefStatus(0xd,0xe,cRecyclePeriod,&iLatestBomber,rgRecycleShdef);
  CheckAiShdefStatus(4,5,cRecyclePeriod,&iLatestBattle,rgRecycleShdef);
  CheckAiShdefStatus(0xc,0xc,cRecyclePeriod,&iLatestLayer,rgRecycleShdef);
  CheckAiShdefStatus(0xf,0xf,cRecyclePeriod,&iLatestTroop,rgRecycleShdef);
  if (*(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) < '\a') {
    iLatestMiner = -1;
  }
  else {
    CheckAiShdefStatus(2,3,cRecyclePeriod,&iLatestMiner,rgRecycleShdef);
  }
  CheckAiShdefStatus(10,0xb,cRecyclePeriod,&iLatestDestroyer,rgRecycleShdef);
  if (0x3c < game.turn) {
    SplitOutShdefs(rgRecycleShdef);
  }
  EnsureTurinDroneShdefs(iroCur);
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_8e = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < lpplMac) {
    uVar15 = (undefined2)((ulong)lppl >> 0x10);
    if (((((PLANET *)lppl)->iPlayer == -1) && (2 < (((PLANET *)lppl)->wFlags_0x4 & 0xff))) &&
       (sVar8 = PctPlanetOptValue(lppl,idPlayer), 0 < sVar8)) {
      cplanCol = cplanCol + 1;
    }
    lppl = (PLANET *)lppl + 1;
  }
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_8e = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < lpplMac) {
    ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 9] = 1;
    uVar15 = (undefined2)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl)->iPlayer == -1) && (2 < (((PLANET *)lppl)->wFlags_0x4 & 0xff))) {
      b = 0;
      for (i = 0; i < 3; i = i + 1) {
        if (((PLANET *)lppl)->rgMinConc[i] < 0x43) {
          pct._0_1_ = ((PLANET *)lppl)->rgMinConc[i] / 2;
        }
        else {
          pct._0_1_ = 0x4b;
        }
        b = b + (byte)pct;
      }
      if ((b & 0x80) != 0) {
        b = 0x7f;
      }
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] = b;
      cplMiners = cplMiners + 1;
    }
    if ((((PLANET *)lppl)->iPlayer == idPlayer) || (((PLANET *)lppl)->iPlayer == -1)) {
      if (((PLANET *)lppl)->iPlayer == idPlayer) {
        sVar8 = PctPlanetDesirability(lppl,idPlayer);
        if (sVar8 < 0) {
          cplNegative = cplNegative + 1;
          ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] = 1;
        }
        else {
          uVar15 = (undefined2)((ulong)lppl >> 0x10);
          pPVar10 = (PLANET *)lppl;
          if (((pPVar10->wFlags_0x4 >> 9 & 1) == 0) ||
             ((iVar19 = *(int *)((int)pPVar10->rgwtMin + 0xe), iVar19 < 1 &&
              ((iVar19 < 0 || (*(uint *)(pPVar10->rgwtMin + 3) < 200)))))) {
            ChangeMainObjSel(1,lppl->id);
            lVar16 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff4a);
            sel.pl.rgbImp._4_2_ = sel.pl.rgbImp._4_2_ | (uint)lVar16;
            sel.pl.rgbImp._6_2_ =
                 sel.pl.rgbImp._6_2_ & 0xff7f | (uint)((ulong)lVar16 >> 0x10);
            uVar17 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff4a);
            in_stack_0000ff4a = (uint)uVar17 & 1;
            iVar19 = 0;
            uVar17 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff4a);
            if ((in_stack_0000ff4a != ((uint)uVar17 & 1)) || (iVar19 != 0)) {
              FLookupPlanet(-1,(PLANET *)&sel.pl);
            }
          }
          else {
            ChangeMainObjSel(1,lppl->id);
            InitProduction(rgprod);
            fWrite = 0;
            b = 0;
            i = 0;
            while ((i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac &&
                   ((uVar17 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff4a),
                    ((uint)uVar17 & 7) != 2 ||
                    (uVar17 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff4a),
                    0xf < ((uint)uVar17 & 0x7f)))))) {
              i = i + 1;
            }
            if (i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
              FinishProduction(0);
            }
            else {
              if (game.turn == 0) {
                i = game.cPlanMax;
                while (0 < i) {
                  AddItemToQueue(0,1,grobjFleet,1);
                  if (i < 0xbf) {
                    i = i + -0x1e;
                  }
                  else {
                    i = i + -100;
                  }
                  fWrite = 1;
                }
              }
              else if (((rgshdef[0].wFlags >> 9 & 1) == 0) &&
                      (rgshdef[0].hul.ihuldef == ihuldefFrigate)) {
                if (game.cPlanMax / 4 < 0x20) {
                  uVar9 = game.cPlanMax / 4;
                }
                else {
                  uVar9 = 0x20;
                }
                if (((rgshdef[0].cExist._2_2_ == 0) &&
                    ((uint)rgshdef[0].cExist < uVar9)) &&
                   (uVar17 = __aFuldiv(CONCAT22(rgshdef[0].cBuilt._2_2_,
                                                        (undefined2)rgshdef[0].cBuilt),10)
                   , uVar17 < CONCAT22(rgshdef[0].cExist._2_2_,
                                       (uint)rgshdef[0].cExist))) {
                  AddItemToQueue(0,1,grobjFleet,1);
                  fWrite = 1;
                }
              }
              uVar15 = (undefined2)((ulong)vlpbAiData >> 0x10);
              if (*(int *)((byte *)vlpbAiData + 2) * 2 <
                  *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) / 10) {
                cFr = *(int *)((int)&rgplr[0].cPlanet + idPlayer * 0xc0) / 10;
              }
              else {
                cFr = *(int *)((byte *)vlpbAiData + 2) << 1;
              }
              if ((('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))
                  && (iLatestCargo != -1)) &&
                 ((cExistCargo < cFr ||
                  ((cExistCargo < (cFr * 10) / 7 && (sVar8 = Random(4), sVar8 == 0)))))) {
                AddItemToQueue(iLatestCargo,1,grobjFleet,1);
                fWrite = 1;
              }
              if ((((cplanCol != 0) || (cplBadGuy != 0)) && (rgshdef[1].cExist._2_2_ == 0)
                  ) && ((uint)rgshdef[1].cExist < 2)) {
                AddItemToQueue(1,1,grobjFleet,1);
                AddItemToQueue(1,1,grobjFleet,1);
                AddItemToQueue(1,1,grobjFleet,1);
                AddItemToQueue(1,1,grobjFleet,1);
                fWrite = 1;
              }
              sVar8 = PctTrueMaxGrowth(idPlayer);
              uVar15 = (undefined2)((ulong)lppl >> 0x10);
              __aFulmul(CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                                         (int)((PLANET *)lppl)->rgwtMin[3]),(long)sVar8);
              cRes = CResourcesAtPlanet(lppl,idPlayer);
              if (((rgshdef[0xc].wFlags >> 9 & 1) == 0) &&
                 (sVar8 = Random(3), sVar8 == 0)) {
                cFr = 0;
                for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
                  pFVar12 = ((FLEET **)rglpfl)[ifl];
                  iVar19 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                  lpfl = (FLEET *)CONCAT22(iVar19,pFVar12);
                  if ((pFVar12 == (FLEET *)0x0) && (iVar19 == 0)) break;
                  if ((pFVar12->idPlanet == lppl->id) &&
                     ((0 < pFVar12->rgcsh[0xc] && (pFVar12->iPlayer == idPlayer)))) {
                    cFr = pFVar12->rgcsh[0xc];
                    break;
                  }
                }
                if (((cFr < 10) || ((cFr < 0x11 && (sVar8 = Random(8), sVar8 == 0)))) &&
                   (sVar8 = Random(cFr * 2 + 1), sVar8 == 0)) {
                  AddItemToQueue(0xc,3,grobjFleet,1);
                  fWrite = 1;
                }
              }
              if (iLatestBomber != -1) {
                iVar19 = lppl->id;
                for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
                  pFVar12 = ((FLEET **)rglpfl)[ifl];
                  iVar5 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                  lpfl = (FLEET *)CONCAT22(iVar5,pFVar12);
                  if ((pFVar12 == (FLEET *)0x0) && (iVar5 == 0)) break;
                  if ((pFVar12->idPlanet == iVar19) &&
                     ((pFVar12->iPlayer == idPlayer &&
                      (sVar8 = FPotentRobWarFleet((FLEET *)CONCAT22(iVar5,pFVar12),2), sVar8 != 0)))
                     ) {
                    if ((iLatestBomber != -1) &&
                       (uVar15 = (undefined2)((ulong)lpfl >> 0x10),
                       (int)(uint)vrgAiArmadaPotency[2] <=
                       ((FLEET *)lpfl)->rgcsh[0xd] + ((FLEET *)lpfl)->rgcsh[0xe])) {
                      AddItemToQueue(iLatestBomber,4,grobjFleet,1);
                      fWrite = 1;
                      goto AI_FinishProd_2;
                    }
                    break;
                  }
                }
              }
              if (iLatestBattle != -1) {
                if ((*(int *)((int)&rgshdef[0].cExist + 2 + iLatestBattle * 0x93) == 0) &&
                   (*(uint *)((int)&rgshdef[0].cExist + iLatestBattle * 0x93) <
                    game.cPlanMax / 0x18 + 4U)) {
                  GetResourcesAvailable(lppl,rgResAvail);
                  GetProdQCost(lppl,rgResCost);
                  for (i = 0; i < 4; i = i + 1) {
                    uVar6 = rgResCost[i * 2];
                    uVar7 = rgResCost[i * 2 + 1];
                    puVar1 = rgResAvail + i * 2;
                    uVar9 = *puVar1;
                    *puVar1 = *puVar1 - uVar6;
                    rgResAvail[i * 2 + 1] = (rgResAvail[i * 2 + 1] - uVar7) - (uint)(uVar9 < uVar6);
                    if (((int)rgResAvail[i * 2 + 1] < 1) && ((int)rgResAvail[i * 2 + 1] < 0))
                    goto AI_FinishProd_2;
                  }
                  for (i = 0; i < 5; i = i + 1) {
                    GetTrueHullCost
                              (idPlayer,(HUL *)(iLatestBattle * 0x93 + rgshdef),rgCosts);
                    for (j = 0; j < 4; j = j + 1) {
                      uVar6 = rgCosts[j];
                      puVar1 = rgResAvail + j * 2;
                      uVar9 = *puVar1;
                      *puVar1 = *puVar1 - uVar6;
                      rgResAvail[j * 2 + 1] = rgResAvail[j * 2 + 1] - (uint)(uVar9 < uVar6);
                      if (((int)rgResAvail[j * 2 + 1] < 1) && ((int)rgResAvail[j * 2 + 1] < 0))
                      goto AI_FinishProd_2;
                    }
                    fWrite = 1;
                    AddItemToQueue(iLatestBattle,1,grobjFleet,1);
                  }
                }
              }
              if (iLatestCruiser != -1) {
                if ((*(int *)((int)&rgshdef[0].cExist + 2 + iLatestCruiser * 0x93) == 0)
                   && (*(uint *)((int)&rgshdef[0].cExist + iLatestCruiser * 0x93) <
                       game.cPlanMax / 0xc + 8U)) {
                  GetResourcesAvailable(lppl,rgResAvail);
                  GetProdQCost(lppl,rgResCost);
                  for (i = 0; i < 4; i = i + 1) {
                    uVar6 = rgResCost[i * 2];
                    uVar7 = rgResCost[i * 2 + 1];
                    puVar1 = rgResAvail + i * 2;
                    uVar9 = *puVar1;
                    *puVar1 = *puVar1 - uVar6;
                    rgResAvail[i * 2 + 1] = (rgResAvail[i * 2 + 1] - uVar7) - (uint)(uVar9 < uVar6);
                    if (((int)rgResAvail[i * 2 + 1] < 1) && ((int)rgResAvail[i * 2 + 1] < 0))
                    goto AI_FinishProd_2;
                  }
                  for (i = 0; i < 5; i = i + 1) {
                    GetTrueHullCost
                              (idPlayer,(HUL *)(iLatestCruiser * 0x93 + rgshdef),rgCosts);
                    for (j = 0; j < 4; j = j + 1) {
                      uVar6 = rgCosts[j];
                      puVar1 = rgResAvail + j * 2;
                      uVar9 = *puVar1;
                      *puVar1 = *puVar1 - uVar6;
                      rgResAvail[j * 2 + 1] = rgResAvail[j * 2 + 1] - (uint)(uVar9 < uVar6);
                      if (((int)rgResAvail[j * 2 + 1] < 1) && ((int)rgResAvail[j * 2 + 1] < 0))
                      goto AI_FinishProd_2;
                    }
                    fWrite = 1;
                    AddItemToQueue(iLatestCruiser,1,grobjFleet,1);
                  }
                }
              }
              if (iLatestDestroyer != -1) {
                if ((*(int *)((int)&rgshdef[0].cExist + 2 + iLatestDestroyer * 0x93) == 0)
                   && (*(uint *)((int)&rgshdef[0].cExist + iLatestDestroyer * 0x93) <
                       game.cPlanMax / 4 + 0xcU)) {
                  GetResourcesAvailable(lppl,rgResAvail);
                  GetProdQCost(lppl,rgResCost);
                  for (i = 0; i < 4; i = i + 1) {
                    uVar6 = rgResCost[i * 2];
                    uVar7 = rgResCost[i * 2 + 1];
                    puVar1 = rgResAvail + i * 2;
                    uVar9 = *puVar1;
                    *puVar1 = *puVar1 - uVar6;
                    rgResAvail[i * 2 + 1] = (rgResAvail[i * 2 + 1] - uVar7) - (uint)(uVar9 < uVar6);
                    if (((int)rgResAvail[i * 2 + 1] < 1) && ((int)rgResAvail[i * 2 + 1] < 0))
                    goto AI_FinishProd_2;
                  }
                  for (i = 0; i < 5; i = i + 1) {
                    GetTrueHullCost
                              (idPlayer,(HUL *)(iLatestDestroyer * 0x93 + rgshdef),rgCosts);
                    for (j = 0; j < 4; j = j + 1) {
                      uVar6 = rgCosts[j];
                      puVar1 = rgResAvail + j * 2;
                      uVar9 = *puVar1;
                      *puVar1 = *puVar1 - uVar6;
                      rgResAvail[j * 2 + 1] = rgResAvail[j * 2 + 1] - (uint)(uVar9 < uVar6);
                      if (((int)rgResAvail[j * 2 + 1] < 1) && ((int)rgResAvail[j * 2 + 1] < 0))
                      goto AI_FinishProd_2;
                    }
                    fWrite = 1;
                    AddItemToQueue(iLatestDestroyer,1,grobjFleet,1);
                  }
                }
              }
              if ((iLatestTroop != -1) && ((rgshdef[0xf].wFlags >> 9 & 1) == 0)) {
                if ((*(int *)((int)&rgshdef[0].cExist + 2 + iLatestTroop * 0x93) == 0) &&
                   (*(uint *)((int)&rgshdef[0].cExist + iLatestTroop * 0x93) <
                    game.cPlanMax / 0xc + 8U)) {
                  GetResourcesAvailable(lppl,rgResAvail);
                  GetProdQCost(lppl,rgResCost);
                  for (i = 0; i < 4; i = i + 1) {
                    uVar6 = rgResCost[i * 2];
                    uVar7 = rgResCost[i * 2 + 1];
                    puVar1 = rgResAvail + i * 2;
                    uVar9 = *puVar1;
                    *puVar1 = *puVar1 - uVar6;
                    rgResAvail[i * 2 + 1] = (rgResAvail[i * 2 + 1] - uVar7) - (uint)(uVar9 < uVar6);
                    if (((int)rgResAvail[i * 2 + 1] < 1) && ((int)rgResAvail[i * 2 + 1] < 0))
                    goto AI_FinishProd_2;
                  }
                  for (i = 0; i < 5; i = i + 1) {
                    GetTrueHullCost
                              (idPlayer,(HUL *)(iLatestTroop * 0x93 + rgshdef),rgCosts);
                    for (j = 0; j < 4; j = j + 1) {
                      uVar6 = rgCosts[j];
                      puVar1 = rgResAvail + j * 2;
                      uVar9 = *puVar1;
                      *puVar1 = *puVar1 - uVar6;
                      rgResAvail[j * 2 + 1] = rgResAvail[j * 2 + 1] - (uint)(uVar9 < uVar6);
                      if (((int)rgResAvail[j * 2 + 1] < 1) && ((int)rgResAvail[j * 2 + 1] < 0))
                      goto AI_FinishProd_2;
                    }
                    fWrite = 1;
                    AddItemToQueue(iLatestTroop,1,grobjFleet,1);
                  }
                }
              }
AI_FinishProd_2:
              FinishProduction(fWrite);
            }
          }
        }
      }
    }
    else {
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] =
           ((byte)(((PLANET *)lppl)->wFlags_0x4 >> 9) & 1) + 1;
      sVar8 = PctPlanetOptValue(lppl,idPlayer);
      if (0 < sVar8) {
        ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 3] = (byte)sVar8;
        cplBadGuy = cplBadGuy + 1;
      }
    }
    lppl = (PLANET *)lppl + 1;
  }
  for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
                    /* WARNING: Load size is inaccurate */
    pPVar10 = ((PLANET **)vrglpplAi)[ipl];
    iVar19 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
    lppl = (PLANET *)CONCAT22(iVar19,pPVar10);
    if (((pPVar10 == (PLANET *)0x0) && (iVar19 == 0)) || ((pPVar10->wFlags_0x4 >> 9 & 1) != 0))
    break;
  }
  lpplHome = (PLANET *)lppl;
  local_6e = lppl._2_2_;
  if (((PLANET *)lppl == lpplMac) && (lppl._2_2_ == local_8e)) {
    lpplHome = (PLANET *)0x0;
    local_6e = 0;
  }
  lpflAttack = (FLEET *)0x0;
  local_72 = 0;
  lpflEnemy = (FLEET *)0x0;
  local_28 = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar12 = ((FLEET **)rglpfl)[ifl];
    iVar19 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar19,pFVar12);
    if ((pFVar12 == (FLEET *)0x0) && (iVar19 == 0)) break;
    if (pFVar12->iPlayer == idPlayer) {
      sVar8 = FIsTurinDroneAiAttack((FLEET *)CONCAT22(iVar19,pFVar12));
      pFVar12 = (FLEET *)lpfl;
      uVar15 = (undefined2)((ulong)lpfl >> 0x10);
      if (sVar8 != 0) {
        *(FLEET **)&pFVar12->lpflNext = lpflAttack;
        *(undefined2 *)((int)&pFVar12->lpflNext + 2) = local_72;
        lpflAttack = pFVar12;
        local_72 = uVar15;
      }
      pFVar12->wFlags_0x4 = pFVar12->wFlags_0x4 & 0x7fff;
      if (((pFVar12->rgcsh[2] == 0) && (pFVar12->rgcsh[3] == 0)) ||
         ((*(uint *)(*(int *)&pFVar12->lpplord + (pFVar12->cord + -1) * 0x12 + 10) & 0xf) == 0)) {
        if ((pFVar12->rgcsh[8] == 0) && (pFVar12->rgcsh[9] == 0)) {
          if (pFVar12->rgcsh[1] != 0) {
            idPlanDst = -1;
            if (pFVar12->cord < 2) {
              idPlanDst = pFVar12->idPlanet;
            }
            else if ((((PLORD *)pFVar12->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
              idPlanDst = *(short *)&((PLORD *)pFVar12->lpplord)[6].iordMax;
            }
            if (idPlanDst != -1) {
              if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0)
              goto AI_LCheckForColDrop_3;
              lppl = LpplFromId(idPlanDst);
              iVar19 = (int)((ulong)lppl >> 0x10);
              pPVar10 = (PLANET *)lppl;
              if (((pPVar10 != (PLANET *)0x0) || (iVar19 != 0)) &&
                 ((pPVar10->iPlayer != -1 && (pPVar10->iPlayer != idPlayer))))
              goto AI_LBlowAwayOrders_3;
            }
          }
        }
        else {
          idPlanDst = -1;
          if (pFVar12->cord < 2) {
            idPlanDst = pFVar12->idPlanet;
          }
          else if ((((PLORD *)pFVar12->lpplord + 7)->wFlags >> 8 & 0xf) == 1) {
            idPlanDst = *(short *)&((PLORD *)pFVar12->lpplord)[6].iordMax;
          }
AI_LCheckForColDrop_3:
          if (idPlanDst == -1) {
            if ((1 < pFVar12->cord) && ((((PLORD *)pFVar12->lpplord + 7)->wFlags >> 8 & 0xf) == 4))
            goto AI_LBlowAwayOrders_3;
          }
          else {
            lppl = LpplFromId(idPlanDst);
            iVar19 = (int)((ulong)lppl >> 0x10);
            pPVar10 = (PLANET *)lppl;
            if (((pPVar10 == (PLANET *)0x0) && (iVar19 == 0)) ||
               ((pPVar10->iPlayer != -1 && (pPVar10->iPlayer != idPlayer)))) {
              if (((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] != 0) {
                uVar15 = (undefined2)((ulong)lpfl >> 0x10);
                iVar5 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0xe);
                if ((-1 < iVar5) &&
                   ((((0 < iVar5 || ((int)((FLEET *)lpfl)->rgwtMin[3] != 0)) &&
                     (sVar8 = GetRaceStat((PLAYER *)rgplr + pPVar10->iPlayer,
                                                rsMajorAdv), sVar8 != raMacintosh)) &&
                    ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0)))) {
                  _memset(&ord,0,0x12);
                  ord.pt.x = ((POINT *)rgptPlan + idPlanDst)->x;
                  ord.pt.y = *(short *)((int)&rgptPlan[0].y + idPlanDst * 4);
                  ord.id = idPlanDst;
                  ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe0f0 | 0x1101;
                  ord.u_ORDER_0x0008.txp.rgia[3].wFlags =
                       (ITEMACTION)((uint)ord.u_ORDER_0x0008.txp.rgia[3].wFlags & 0xfff | 0x2000);
                  ChangeMainObjSel(2,lpfl->id);
                  uVar15 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                  pPVar11 = (PLORD *)sel.fl.lpplord;
                  if (((pPVar11 + 2)->wFlags == idPlanDst) &&
                     ((*(uint *)&pPVar11[2].iordMax >> 8 & 0xf) == 1)) {
                    pPVar11 = pPVar11 + 1;
                    pOVar14 = &ord;
                    for (iVar19 = 9; iVar19 != 0; iVar19 = iVar19 + -1) {
                      pPVar4 = pPVar11;
                      pPVar11 = &pPVar11->iordMax;
                      pOVar3 = pOVar14;
                      pOVar14 = &(pOVar14->pt).y;
                      pPVar4->wFlags = (pOVar3->pt).x;
                    }
                  }
                  else {
                    pbVar13 = &pPVar11[5].iordMax;
                    pOVar14 = &ord;
                    for (iVar19 = 9; iVar19 != 0; iVar19 = iVar19 + -1) {
                      pbVar2 = pbVar13;
                      pbVar13 = pbVar13 + 2;
                      pOVar3 = pOVar14;
                      pOVar14 = &(pOVar14->pt).y;
                      *pbVar2 = (pOVar3->pt).x;
                    }
                  }
                  FLookupFleet(-1,(FLEET *)&sel.fl);
                  ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] =
                       ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 3] | 0x80;
                  FMoveToNearestStarbase(lpfl,0);
                  goto LAB_1088_4932;
                }
              }
AI_LBlowAwayOrders_3:
              ChangeMainObjSel(2,lpfl->id);
              sel.fl.cord = 1;
              ((PLORD *)sel.fl.lpplord)->iordMac = 1;
              FLookupFleet(-1,(FLEET *)&sel.fl);
              ClearAiCurrentTask(lpfl,0);
            }
          }
        }
      }
      else {
        if (pFVar12->idPlanet == -1) {
          if (pFVar12->cord < 2) goto LAB_1088_4932;
          ((PLORD *)pFVar12->lpplord + 7)->wFlags =
               ((PLORD *)pFVar12->lpplord + 7)->wFlags & 0xfff0 | 3;
          idPlanDst = *(short *)&((PLORD *)pFVar12->lpplord)[6].iordMax;
        }
        else {
          pPVar18 = LpplFromId(pFVar12->idPlanet);
          if (((PLANET *)pPVar18)->iPlayer != -1) goto AI_LBlowAwayOrders_3;
          idPlanDst = ((FLEET *)lpfl)->idPlanet;
        }
        ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 1] =
             ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 1] | 0x80;
      }
    }
    else {
      *(FLEET **)&pFVar12->lpflNext = lpflEnemy;
      *(int *)((int)&pFVar12->lpflNext + 2) = local_28;
      lpflEnemy = pFVar12;
      local_28 = iVar19;
    }
LAB_1088_4932:
  }
  fMarkedPlanets = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar12 = ((FLEET **)rglpfl)[ifl];
    iVar19 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar19,pFVar12);
    if ((pFVar12 == (FLEET *)0x0) && (iVar19 == 0)) break;
    if (pFVar12->iPlayer == idPlayer) {
      if ((pFVar12->rgcsh[2] == 0) && (pFVar12->rgcsh[3] == 0)) {
        if (pFVar12->cord < 2) {
          if (pFVar12->rgcsh[1] == 0) {
            if ((pFVar12->rgcsh[8] == 0) && (pFVar12->rgcsh[9] == 0)) {
              if ((pFVar12->rgcsh[0xd] == 0) && (pFVar12->rgcsh[0xe] == 0)) {
                if (((pFVar12->rgcsh[0] == 0) && (pFVar12->rgcsh[10] == 0)) &&
                   (pFVar12->rgcsh[0xb] == 0)) {
                  if (((pFVar12->rgcsh[0xc] != 0) && (pFVar12->cord == 1)) &&
                     ((*(uint *)&((PLORD *)pFVar12->lpplord)[2].iordMax & 0xf) == 0)) {
                    ChangeMainObjSel(2,lpfl->id);
                    uVar15 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                    *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                         *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 6;
                    ((PLORD *)sel.fl.lpplord + 3)->wFlags = 5;
                    pbVar2 = &((PLORD *)sel.fl.lpplord)[3].iordMax;
                    pbVar2[0] = 5;
                    pbVar2[1] = 0;
                    FLookupFleet(-1,(FLEET *)&sel.fl);
                  }
                }
                else {
                  if (((pFVar12->rgcsh[0] != 0) &&
                      ('\x05' < *(char *)((int)rgplr[0].rgTech + 3 +
                                         idPlayer * 0xc0))) &&
                     (rgshdef[0].hul.ihuldef == ihuldefScout)) goto AI_LScrapFleet_3;
                  ChangeMainObjSel(2,lpfl->id);
                  IdTargetScout(lpfl,(FLEET *)CONCAT22(local_72,lpflAttack),
                                     (FLEET *)CONCAT22(local_28,lpflEnemy),
                                     game.wCrap >> 4 & 1,&lpthWorm);
                }
              }
              else {
                ChangeMainObjSel(2,lpfl->id);
                uVar15 = (undefined2)((ulong)lpfl >> 0x10);
                if (((FLEET *)lpfl)->idPlanet == -1) {
                  lppl = (PLANET *)CONCAT22(local_6e,lpplHome);
                }
                else {
                  lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
                  uVar15 = (undefined2)((ulong)lppl >> 0x10);
                  pPVar10 = (PLANET *)lppl;
                  if (pPVar10->iPlayer == idPlayer) {
                    if ((pPVar10->wFlags_0x4 >> 9 & 1) != 0) {
                      uVar15 = (undefined2)((ulong)lpfl >> 0x10);
                      pFVar12 = (FLEET *)lpfl;
                      if ((pFVar12->rgcsh[0xd] + pFVar12->rgcsh[0xe] <
                           (int)(uint)vrgAiArmadaPotency[2]) ||
                         (pFVar12->rgcsh[4] + pFVar12->rgcsh[5] <
                          (int)(uint)vrgAiArmadaPotency[1])) goto LAB_1088_4eb0;
                    }
                    FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
                  }
                  else if (pPVar10->iPlayer != -1) {
                    lpflT = (FLEET *)CONCAT22(local_28,lpflEnemy);
                    while( true ) {
                      if (((FLEET *)lpflT == (FLEET *)0x0) && (lpflT._2_2_ == 0))
                      goto LAB_1088_4eb0;
                      uVar15 = (undefined2)((ulong)lpfl >> 0x10);
                      if (((&((FLEET *)lpfl)->pt)->x == (&((FLEET *)lpflT)->pt)->x) &&
                         (((((FLEET *)lpfl)->pt).y == (((FLEET *)lpflT)->pt).y &&
                          (sVar8 = FIsAiAttack(lpflT), sVar8 != 0)))) break;
                      uVar15 = (undefined2)((ulong)lpflT >> 0x10);
                    /* WARNING: Load size is inaccurate */
                      lpflT = (FLEET *)CONCAT22(*(undefined2 *)
                                                 ((int)&((FLEET *)lpflT)->lpflNext + 2),
                                                ((FLEET *)lpflT)->lpflNext);
                    }
                  }
                }
                if ((game.wCrap >> 4 & 1) == 0) {
                  lpplDest = (PLANET *)0x0;
                }
                else {
                  lpplDest = LpplFindBestEnum(lppl,FEnumCalcArmadaHumanDest);
                }
                if (((PLANET *)lpplDest == (PLANET *)0x0) && (lpplDest._2_2_ == 0)) {
                  lpplDest = LpplFindBestEnum(lppl,FEnumCalcArmadaDest);
                }
                lppl = lpplDest;
                if (((PLANET *)lpplDest != (PLANET *)0x0) || (lpplDest._2_2_ != 0)) {
                  ((byte *)vlpbAiPlanet)[lpplDest->id * 0x10 + 10] =
                       ((byte *)vlpbAiPlanet)[lpplDest->id * 0x10 + 10] | 0x80;
                  ord.id = lpplDest->id;
                  ord.pt.x = ((POINT *)rgptPlan + lpplDest->id)->x;
                  ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplDest->id * 4);
                  ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe000 | 0x1140;
                  FMoveAiFleet(lpfl,&ord,0);
                }
              }
            }
            else if (game.turn == 0) {
              ChangeMainObjSel(2,lpfl->id);
AI_LScrapFleet_3:
              ChangeMainObjSel(2,lpfl->id);
              uVar15 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
              *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                   *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
              FLookupFleet(-1,(FLEET *)&sel.fl);
            }
            else {
              if ((lpplHome == (PLANET *)0x0) && (local_6e == 0)) break;
              lppl = (PLANET *)0x0;
              i = 0;
              while( true ) {
                uVar15 = (undefined2)((ulong)vlpbAiData >> 0x10);
                pbVar13 = (byte *)vlpbAiData;
                if (*(int *)(pbVar13 + 2) <= i) break;
                j = 0;
                while ((j < *(int *)(pbVar13 + i * 0x14 + 6) &&
                       (*(int *)(pbVar13 + j * 2 + i * 0x14 + 8) != lpfl->id))) {
                  j = j + 1;
                }
                if (j < *(int *)(pbVar13 + i * 0x14 + 6)) break;
                i = i + 1;
              }
              if (i < *(int *)(pbVar13 + 2)) {
                lppl = LpplFromId(*(short *)(pbVar13 + i * 0x14 + 4));
              }
              if (((PLANET *)lppl != (PLANET *)0x0) ||
                 (pPVar10 = lpplHome, iVar19 = local_6e, lppl._2_2_ != 0)) {
                pPVar10 = (PLANET *)lppl;
                iVar19 = lppl._2_2_;
              }
              IdTargetFreighter(lpfl,(PLANET *)CONCAT22(iVar19,pPVar10));
            }
          }
          else {
            ChangeMainObjSel(2,lpfl->id);
            uVar15 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar12 = (FLEET *)lpfl;
            if (((((pFVar12->idPlanet == -1) || (sel.pl.iPlayer != idPlayer)) ||
                 ((sel.pl.rgwtMin[3]._2_2_ < 1 &&
                  ((sel.pl.rgwtMin[3]._2_2_ < 0 ||
                   ((uint)sel.pl.rgwtMin[3] < 0x32)))))) &&
                ((int)pFVar12->rgwtMin[3] == 0)) && (*(int *)((int)pFVar12->rgwtMin + 0xe) == 0)) {
              if ((((sel.fl.idPlanet == -1) ||
                   (sel.pl.iPlayer != idPlayer)) ||
                  ((sel.pl.wFlags_0x4 >> 9 & 1) == 0)) &&
                 (((rgshdef[1].hul.rghs[0].wFlags_0x2 & 0xff) < 3 ||
                  (sVar8 = FMoveToNearestStarbase(lpfl,0), sVar8 == 0))))
              goto AI_LScrapFleet_3;
            }
            else {
              lpthWorm = (THING *)0x0;
              local_30 = 0;
              idPlanDst = IdNearestColonizablePlanet(lpfl,(THING **)0x0);
              if ((((FLEET *)lpfl)->idPlanet == -1) || (sel.pl.iPlayer != idPlayer)
                 ) {
                lppl = (PLANET *)CONCAT22(local_6e,lpplHome);
              }
              else {
                ChangeMainObjSel(2,lpfl->id);
                XferAiSupply(1,((FLEET *)lpfl)->idPlanet,2,lpfl->id,3,0x19);
                FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
                lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
              }
              if (idPlanDst == -1) {
                if (((PLANET *)lppl != (PLANET *)0x0) || (lppl._2_2_ != 0)) {
                  lpplDest = LpplFindClosestEnum(lppl,FEnumCalcColonistDrop);
                  if (((PLANET *)lpplDest != (PLANET *)0x0) || ((int)((ulong)lpplDest >> 0x10) != 0)
                     ) {
                    ((byte *)vlpbAiPlanet)[lpplDest->id * 0x10 + 10] =
                         ((byte *)vlpbAiPlanet)[lpplDest->id * 0x10 + 10] | 0x80;
                    _memset(&ord,0,0x12);
                    ord.id = lpplDest->id;
                    ord.pt.x = ((POINT *)rgptPlan + lpplDest->id)->x;
                    ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplDest->id * 4);
                    ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe000 | 0x1161;
                    ord.u_ORDER_0x0008.txp.rgia[3].wFlags =
                         (ITEMACTION)((uint)ord.u_ORDER_0x0008.txp.rgia[3].wFlags & 0xfff | 0x2000);
                    FMoveAiFleet(lpfl,&ord,0);
                    goto LAB_1088_4eb0;
                  }
                }
                if (((lpthWorm != (THING *)0x0) || (local_30 != 0)) &&
                   (sVar8 = Random(100), sVar8 < 10)) {
                  FGotoWormholeAiFleet(lpfl,(THING *)CONCAT22(local_30,lpthWorm));
                }
              }
              else {
                FColonizeAiFleet(lpfl,idPlanDst);
                ((byte *)vlpbAiPlanet)[idPlanDst * 0x10 + 0xf] = 4;
              }
            }
          }
        }
      }
      else {
        if (game.turn == 0) goto AI_LScrapFleet_3;
        if (pFVar12->idPlanet != -1) {
          ChangeMainObjSel(2,lpfl->id);
          b = ((byte *)vlpbAiPlanet)[((FLEET *)lpfl)->idPlanet * 0x10 + 1];
          if (b < 4) {
            lppl = LpplFindBestEnum(&sel.pl,FEnumCalcMinerDest);
            if (((PLANET *)lppl != (PLANET *)0x0) || ((int)((ulong)lppl >> 0x10) != 0)) {
              _memset(&ord,0,0x12);
              ord.id = lppl->id;
              ord.pt.x = ((POINT *)rgptPlan + lppl->id)->x;
              ord.pt.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
              ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe000 | 0x1163;
              FMoveAiFleet(lpfl,&ord,1);
              ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] =
                   ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] | 0x80;
              ((byte *)vlpbAiPlanet)[((FLEET *)lpfl)->idPlanet * 0x10 + 1] =
                   ((byte *)vlpbAiPlanet)[((FLEET *)lpfl)->idPlanet * 0x10 + 1] & 0x80;
            }
          }
        }
      }
    }
LAB_1088_4eb0:
  }
  HandleBasicAiTasks(iroCur,rgprod,ishdefSBLatest,rgResAvail,rgResCost);
  FillProductionQueue();
  return;
}



// ======================================================================
// Function: EnsureTurinDroneShdefs
// Address: 1088:58ba
// Segment: MEMORY_AI
// ======================================================================


void EnsureTurinDroneShdefs(short iroCur)

{
  SHDEF *pSVar1;
  SHDEF *pSVar2;
  short sVar3;
  int iVar4;
  SHDEF *pSVar5;
  SHDEF *pSVar6;
  undefined2 unaff_SS;
  short i;
  SHDEF shdef;
  
  if ((((rgshdef[8].wFlags >> 9 & 1) != 0) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) &&
     ('\a' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0))) {
    FCreateAiShdef(8,0xc,(byte *)vrgTDAip + vrgTDIshAip[0xc]);
  }
  if ((((rgshdef[9].wFlags >> 9 & 1) != 0) &&
      ('\x06' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))) &&
     ('\n' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0))) {
    FCreateAiShdef(9,0xd,(byte *)vrgTDAip + vrgTDIshAip[0xf]);
  }
  if ((((rgshdef[10].wFlags >> 9 & 1) != 0) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
     (('\x04' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) &&
      (('\x03' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
       ('\x04' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))))) {
    for (i = 0; i < 4; i = i + 1) {
      sVar3 = Random(1);
      sVar3 = FCreateAiShdef(10,6,(byte *)vrgTDAip + ((byte *)vrgTDIshAip + 2)[sVar3]);
      if (sVar3 != 0) break;
    }
  }
  if (((rgshdef[1].wFlags >> 9 & 1) != 0) ||
     (((int)rgshdef[1].cExist == 0 && (rgshdef[1].cExist._2_2_ == 0)))) {
    if (((rgshdef[1].wFlags >> 9 & 1) == 0) &&
       (rgshdef[1].hul.ihuldef != ihuldefPrivateer)) {
      pSVar5 = (SHDEF *)(rgshdef + 1);
      pSVar6 = &shdef;
      for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
        pSVar2 = pSVar6;
        pSVar6 = (pSVar6->hul).rgTech;
        pSVar1 = pSVar5;
        pSVar5 = (pSVar5->hul).rgTech;
        (pSVar2->hul).ihuldef = (pSVar1->hul).ihuldef;
      }
      *&(pSVar6->hul).ihuldef = (char)(pSVar5->hul).ihuldef;
      shdef.wFlags = shdef.wFlags & 0xfdff | 0x200;
      FChangeAiShdef(&shdef,1);
    }
    FCreateAiShdef(1,0xf,(byte *)vrgTDAip + vrgTDIshAip[0]);
  }
  if (((rgshdef[0].wFlags >> 9 & 1) != 0) ||
     (((int)rgshdef[0].cExist == 0 && (rgshdef[0].cExist._2_2_ == 0)))) {
    if ((rgshdef[0].wFlags >> 9 & 1) == 0) {
      pSVar5 = (SHDEF *)rgshdef;
      pSVar6 = &shdef;
      for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
        pSVar2 = pSVar6;
        pSVar6 = (pSVar6->hul).rgTech;
        pSVar1 = pSVar5;
        pSVar5 = (pSVar5->hul).rgTech;
        (pSVar2->hul).ihuldef = (pSVar1->hul).ihuldef;
      }
      *&(pSVar6->hul).ihuldef = (char)(pSVar5->hul).ihuldef;
      shdef.wFlags = shdef.wFlags & 0xfdff | 0x200;
      FChangeAiShdef(&shdef,0);
    }
    FCreateAiShdef(0,5,(byte *)vrgTDAip + vrgTDIshAip[1]);
  }
  if (((((rgshdef[2].wFlags >> 9 & 1) != 0) ||
       (((int)rgshdef[2].cExist == 0 && (rgshdef[2].cExist._2_2_ == 0)))) &&
      ('\x06' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0))) &&
     ('\x03' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0))) {
    if ((rgshdef[2].wFlags >> 9 & 1) == 0) {
      pSVar5 = (SHDEF *)(rgshdef + 2);
      pSVar6 = &shdef;
      for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
        pSVar2 = pSVar6;
        pSVar6 = (pSVar6->hul).rgTech;
        pSVar1 = pSVar5;
        pSVar5 = (pSVar5->hul).rgTech;
        (pSVar2->hul).ihuldef = (pSVar1->hul).ihuldef;
      }
      *&(pSVar6->hul).ihuldef = (char)(pSVar5->hul).ihuldef;
      shdef.wFlags = shdef.wFlags & 0xfdff | 0x200;
      FChangeAiShdef(&shdef,2);
    }
    FCreateAiShdef(2,0x16,(byte *)vrgTDAip + vrgTDIshAip[0x11]);
  }
  if ((((rgshdef[0xc].wFlags >> 9 & 1) != 0) ||
      (((int)rgshdef[0xc].cExist == 0 && (rgshdef[0xc].cExist._2_2_ == 0)))) &&
     (('\x03' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
      ('\x03' < *(char *)((int)rgplr[0].rgTech + 5 + idPlayer * 0xc0))))) {
    FCreateAiShdef(0xc,0xb,(byte *)vrgTDAip + vrgTDIshAip[0xe]);
  }
  if (((((rgshdef[0xd].wFlags >> 9 & 1) != 0) &&
       ('\a' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
      ('\x06' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0))) &&
     ('\x05' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0))) {
    FCreateAiShdef(0xd,0x12,(byte *)vrgTDAip + vrgTDIshAip[0xd]);
  }
  if ((((rgshdef[0xe].wFlags >> 9 & 1) != 0) &&
      ('\n' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
     (('\v' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) &&
      (('\x0e' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
       ('\b' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))))) {
    FCreateAiShdef(0xe,0x12,(byte *)vrgTDAip + vrgTDIshAip[0xd]);
  }
  if (((((rgshdef[4].wFlags >> 9 & 1) != 0) &&
       ('\x04' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
      ('\x05' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0))) &&
     (('\f' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
      ('\x06' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))) {
    for (i = 0; i < 5; i = i + 1) {
      sVar3 = Random(4);
      sVar3 = FCreateAiShdef(4,9,(byte *)vrgTDAip +
                                      *(byte *)((int)&rgptPlan[0x19d].y + sVar3));
      if (sVar3 != 0) break;
    }
  }
  if ((((rgshdef[0xf].wFlags >> 9 & 1) != 0) &&
      ('\x04' < *(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0))) &&
     (('\x05' < *(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) &&
      (('\f' < *(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) &&
       ('\x06' < *(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0))))))) {
    i = 0;
    while ((i < 5 && (sVar3 = FCreateAiShdef(0xf,0xc,(byte *)vrgTDAip + vrgTDIshAip[0xc]),
                     sVar3 == 0))) {
      i = i + 1;
    }
  }
  return;
}



// ======================================================================
// Function: FEnumCalcMinerDest
// Address: 1088:5f32
// Segment: MEMORY_AI
// ======================================================================


short FEnumCalcMinerDest(PLANET *lpplSrc,PLANET *lpplTest)

{
  byte bVar1;
  short sVar2;
  uint uVar3;
  byte b;
  short id;
  
  if (((PLANET *)lpplSrc == (PLANET *)lpplTest) && (lpplSrc._2_2_ == lpplTest._2_2_)) {
    uVar3 = 0;
  }
  else {
    bVar1 = ((byte *)vlpbAiPlanet)[lpplTest->id * 0x10 + 1];
    if ((bVar1 == 0) || ((sVar2 = Random(100), 0x18 < sVar2 && ((bVar1 & 0x80) != 0)))) {
      uVar3 = 0;
    }
    else {
      uVar3 = (uint)bVar1;
    }
  }
  return uVar3;
}



// ======================================================================
// Function: FEnumCalcColonistDrop
// Address: 1088:5fc8
// Segment: MEMORY_AI
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10886069) */
/* WARNING: Removing unreachable block (ram,0x1088607a) */

short FEnumCalcColonistDrop(PLANET *lpplSrc,PLANET *lpplTest)

{
  byte bVar1;
  short sVar2;
  uint uVar3;
  byte bEnemy;
  byte bWant;
  short id;
  
  if (((PLANET *)lpplSrc == (PLANET *)lpplTest) && (lpplSrc._2_2_ == lpplTest._2_2_)) {
    uVar3 = 0;
  }
  else {
    bVar1 = ((byte *)vlpbAiPlanet)[lpplTest->id * 0x10 + 3];
    if ((((byte *)vlpbAiPlanet)[lpplTest->id * 0x10 + 10] == 1) && (bVar1 != 0)) {
      sVar2 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lpplTest)->iPlayer,rsMajorAdv
                               );
      if (sVar2 == raMacintosh) {
        uVar3 = 0;
      }
      else {
        uVar3 = (uint)bVar1;
      }
    }
    else {
      uVar3 = 0;
    }
  }
  return uVar3;
}



