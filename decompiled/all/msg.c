// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
//

// ======================================================================
// Function: MessageWndProc
// Address: 1030:5c92
// Segment: MEMORY_MSG
// ======================================================================

/* WARNING: Variable defined which should be unmapped: lpmsgplr */
/* WARNING: Type propagation algorithm not settling */
/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

long MessageWndProc(HWND hwnd, WMType message, ushort wParam, long lParam)

{
    byte        bVar1;
    POINT       pt;
    POINT       pt_00;
    MSGPLR    **ppMVar2;
    undefined4  uVar3;
    char       *pcVar4;
    undefined2  uVar5;
    HWND        HVar6;
    int         iVar7;
    short       sVar8;
    ushort      uVar9;
    short       sVar10;
    short       sVar11;
    uint        uVar12;
    MSGPLR     *pMVar13;
    WMType     *pWVar14;
    undefined2 *puVar15;
    undefined1 *puVar16;
    undefined1 *puVar17;
    undefined2  unaff_SI;
    undefined2  unaff_DI;
    undefined2  unaff_SS;
    bool        bVar18;
    ulong       uVar19;
    DWORD       DVar20;
    LRESULT     LVar21;
    THING      *pTVar22;
    HDC         HVar23;
    MSGPLR     *lpmsgplr;
    RECT        rc;
    char        szT[32];
    short       iMode;
    short       cch;
    short       dx;
    RECT        rcActual;
    undefined1  local_3e[8];
    undefined1  auStack_36[6];
    HGDIOBJ     local_30;
    POINT       local_2e;
    PAINTSTRUCT ps;
    char       *psz;
    short       i;
    HDC         hdc;

    uVar5 = 0x1030;
    puVar17 = &stack0xff84;
    pWVar14 = &stack0xff84;
    if (message == WM_CREATE) {
        for (i = 0; i < 4; i = i + 1) {
            hwndMessage = hwnd;
            pWVar14[-1] = 0x1120;
            pWVar14[-2] = 0xb14;
            pWVar14[-3] = i + 0x54c;
            pWVar14[-4] = uVar5;
            pWVar14[-5] = 0x5cc2;
            pcVar4 = PszGetCompressedString(pWVar14[-3]);
            pWVar14[-3] = 0x1120;
            pWVar14[-4] = (WMType)pcVar4;
            pWVar14[-5] = 0x4000;
            pWVar14[-6] = 0;
            pWVar14[-7] = 100;
            pWVar14[-8] = 100;
            if (i == 3) {
                uVar5 = 0x32;
            } else {
                uVar5 = 0x2c;
            }
            pWVar14[-9] = uVar5;
            pWVar14[-10] = (dyArial8 * 3 >> 1) + -1;
            pWVar14[-0xb] = hwnd;
            pWVar14[-0xc] = 0;
            pWVar14[-0xd] = hInst;
            pWVar14[-0xe] = 0;
            pWVar14[-0xf] = 0;
            pWVar14[-0x10] = 0x1010;
            pWVar14[-0x11] = 0x5d11;
            HVar6 = CreateWindow(*(LPCSTR *)(pWVar14 + -2), *(LPCSTR *)(pWVar14 + -4), *(undefined4 *)(pWVar14 + -6), pWVar14[-7], pWVar14[-8], pWVar14[-9],
                                 pWVar14[-10], pWVar14[-0xb], pWVar14[-0xc], pWVar14[-0xd], *(void **)(pWVar14 + -0xf));
            ((ushort *)rghwndMsgBtn)[i] = HVar6;
            pWVar14[1] = ((ushort *)rghwndMsgBtn)[i];
            *pWVar14 = 0x30;
            pWVar14[-1] = rghfontArial8[1];
            pWVar14[-2] = 0;
            pWVar14[-3] = 0;
            pWVar14[-4] = 0x14f8;
            uVar5 = 0x14f8;
            pWVar14[-5] = 0x5d38;
            SendMessage(pWVar14[1], *pWVar14, pWVar14[-1], *(undefined4 *)(pWVar14 + -3));
            pWVar14 = pWVar14 + 2;
        }
        pWVar14[-1] = 0x1120;
        pWVar14[-2] = 0xb21;
        pWVar14[-3] = 0x1120;
        pWVar14[-4] = 0xb1b;
        pWVar14[-5] = 0x4020;
        pWVar14[-6] = 3;
        pWVar14[-7] = 100;
        pWVar14[-8] = 100;
        pWVar14[-9] = 200;
        pWVar14[-10] = 0x50;
        pWVar14[-0xb] = hwnd;
        pWVar14[-0xc] = 0;
        pWVar14[-0xd] = hInst;
        pWVar14[-0xe] = 0;
        pWVar14[-0xf] = 0;
        pWVar14[-0x10] = uVar5;
        pWVar14[-0x11] = 0x5d83;
        hwndMsgDrop = CreateWindow(*(LPCSTR *)(pWVar14 + -2), *(LPCSTR *)(pWVar14 + -4), *(undefined4 *)(pWVar14 + -6), pWVar14[-7], pWVar14[-8], pWVar14[-9],
                                   pWVar14[-10], pWVar14[-0xb], pWVar14[-0xc], pWVar14[-0xd], *(void **)(pWVar14 + -0xf));
        pWVar14[1] = hwndMsgDrop;
        *pWVar14 = 0x30;
        pWVar14[-1] = rghfontArial8[1];
        pWVar14[-2] = 0;
        pWVar14[-3] = 0;
        pWVar14[-4] = 0x14f8;
        pWVar14[-5] = 0x5d9f;
        SendMessage(pWVar14[1], *pWVar14, pWVar14[-1], *(undefined4 *)(pWVar14 + -3));
        pWVar14[1] = 0x1120;
        *pWVar14 = 0xb2a;
        pWVar14[-1] = 0;
        pWVar14[-2] = 0;
        pWVar14[-3] = 0x4080;
        pWVar14[-4] = 0x44;
        pWVar14[-5] = 100;
        pWVar14[-6] = 100;
        pWVar14[-7] = 200;
        pWVar14[-8] = 0x32;
        pWVar14[-9] = hwnd;
        pWVar14[-10] = 0;
        pWVar14[-0xb] = hInst;
        pWVar14[-0xc] = 0;
        pWVar14[-0xd] = 0;
        pWVar14[-0xe] = 0x14f8;
        pWVar14[-0xf] = 0x5dde;
        hwndMsgEdit = CreateWindow(*(LPCSTR *)pWVar14, *(LPCSTR *)(pWVar14 + -2), *(undefined4 *)(pWVar14 + -4), pWVar14[-5], pWVar14[-6], pWVar14[-7],
                                   pWVar14[-8], pWVar14[-9], pWVar14[-10], pWVar14[-0xb], *(void **)(pWVar14 + -0xd));
        pWVar14[3] = hwndMsgEdit;
        pWVar14[2] = 0x415;
        pWVar14[1] = 0x3c8;
        *pWVar14 = 0;
        pWVar14[-1] = 0;
        pWVar14[-2] = 0x14f8;
        pWVar14[-3] = 0x5dfa;
        SendMessage(pWVar14[3], pWVar14[2], pWVar14[1], *(undefined4 *)(pWVar14 + -1));
        pWVar14[3] = hwndMsgEdit;
        pWVar14[2] = 0x30;
        pWVar14[1] = rghfontArial8[1];
        *pWVar14 = 0;
        pWVar14[-1] = 0;
        pWVar14[-2] = 0x14f8;
        pWVar14[-3] = 0x5e13;
        SendMessage(pWVar14[3], pWVar14[2], pWVar14[1], *(undefined4 *)(pWVar14 + -1));
        pWVar14[3] = 0x1120;
        pWVar14[2] = 0xb2f;
        pWVar14[1] = 0;
        *pWVar14 = 0;
        pWVar14[-1] = 0x40a0;
        pWVar14[-2] = 0x844;
        pWVar14[-3] = 100;
        pWVar14[-4] = 100;
        pWVar14[-5] = 200;
        pWVar14[-6] = 0x32;
        pWVar14[-7] = hwnd;
        pWVar14[-8] = 0;
        pWVar14[-9] = hInst;
        pWVar14[-10] = 0;
        pWVar14[-0xb] = 0;
        pWVar14[-0xc] = 0x14f8;
        pWVar14[-0xd] = 0x5e52;
        hwndMsgScroll = CreateWindow(*(LPCSTR *)(pWVar14 + 2), *(LPCSTR *)pWVar14, *(undefined4 *)(pWVar14 + -2), pWVar14[-3], pWVar14[-4], pWVar14[-5],
                                     pWVar14[-6], pWVar14[-7], pWVar14[-8], pWVar14[-9], *(void **)(pWVar14 + -0xb));
        pWVar14[5] = hwnd;
        pWVar14[4] = 0x14f8;
        pWVar14[3] = 0x5e5d;
        SetMsgTitle(pWVar14[5]);
        pWVar14[5] = hwndMsgDrop;
        pWVar14[4] = 0x403;
        pWVar14[3] = 0;
        pWVar14[2] = 0x549;
        pWVar14[1] = 0x1030;
        *pWVar14 = 0x5e75;
        pcVar4 = PszGetCompressedString(pWVar14[2]);
        pWVar14[2] = 0x1120;
        pWVar14[1] = (WMType)pcVar4;
        *pWVar14 = 0x1010;
        pWVar14[-1] = 0x5e81;
        SendMessage(pWVar14[5], pWVar14[4], pWVar14[3], *(undefined4 *)(pWVar14 + 1));
        for (i = 0; i < game.cPlayer; i = i + 1) {
            pWVar14[5] = 0;
            pWVar14[4] = 0;
            pWVar14[3] = 1;
            pWVar14[2] = 1;
            pWVar14[1] = 1;
            *pWVar14 = i;
            pWVar14[-1] = 0x14f8;
            pWVar14[-2] = 0x5eb4;
            pcVar4 = PszPlayerName(*pWVar14, pWVar14[1], pWVar14[2], pWVar14[3], pWVar14[4], (PLAYER *)pWVar14[5]);
            pWVar14[5] = hwndMsgDrop;
            pWVar14[4] = 0x403;
            pWVar14[3] = 0;
            pWVar14[2] = 0x1120;
            pWVar14[1] = (WMType)pcVar4;
            *pWVar14 = 0x1038;
            pWVar14[-1] = 0x5ed2;
            SendMessage(pWVar14[5], pWVar14[4], pWVar14[3], *(undefined4 *)(pWVar14 + 1));
        }
        pWVar14[5] = hwndMsgDrop;
        pWVar14[4] = 0x40e;
        pWVar14[3] = 0;
        pWVar14[2] = 0;
        pWVar14[1] = 0;
        *pWVar14 = 0x14f8;
        pWVar14[-1] = 0x5eee;
        SendMessage(pWVar14[5], pWVar14[4], pWVar14[3], *(undefined4 *)(pWVar14 + 1));
        return 0;
    }
    if (message == WM_SIZE) {
        local_2e.x = (short)(THING *)lParam;
        uVar19 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), (ushort)(MSGPLR *)lpmsgplr);
        local_2e.y = (short)uVar19;
        for (i = 0; i < 3; i = i + 1) {
            stack0xffc8 = (MSGPLR *)CONCAT22(auStack_36._0_2_, (MSGPLR *)(dyArial8 * 2));
            SetWindowPos(((ushort *)rghwndMsgBtn)[i], 0, (short)&((THING *)(local_2e.x + -0x36))->u_THING_0x0006,
                         (int)&((MSGPLR *)(dyArial8 * 2))->lpmsgplrNext + ((dyArial8 * 3 >> 1) + 2) * i + 3, 0, 0, 0x55);
        }
        SetRect(&rcMsgText, 4, dyArial8 * 2 + 3, (short)&((THING *)(local_2e.x + -0x36))->pt, local_2e.y + -4);
        SetRect(&rcMsgTitle, 4, 4, (short)((int)&((THING *)(local_2e.x + -0x12))->u_THING_0x0006 + 8), dyArial8 * 2 + -4);
        stack0xffc8 = (MSGPLR *)CONCAT22(rcMsgText.left, local_3e._6_2_);
        auStack_36._2_2_ = rcMsgText.top;
        auStack_36._4_2_ = rcMsgText.right;
        local_30 = rcMsgText.bottom;
        ExpandRc(auStack_36, -4, -4);
        SetWindowPos(hwndMsgDrop, 0, auStack_36._0_2_ + 0x1e, auStack_36._2_2_, (auStack_36._4_2_ - auStack_36._0_2_) + -0x54, local_30 - auStack_36._2_2_, 4);
        SetWindowPos(rghwndMsgBtn[3], 0, auStack_36._4_2_ + -0x32, auStack_36._2_2_, 0, 0, 5);
        auStack_36._2_2_ = auStack_36._2_2_ + dyShipDD + 3;
        uVar5 = 0x14f8;
        SetWindowPos(hwndMsgEdit, 0, auStack_36._0_2_, auStack_36._2_2_, auStack_36._4_2_ - auStack_36._0_2_, local_30 - auStack_36._2_2_, 4);
        puVar17 = &stack0xff84;
        goto MSG_Default_9;
    }
    if (message != WM_PAINT) {
        if (message == WM_ERASEBKGND) {
            GetClientRect(hwnd, auStack_36 + 4);
            FillRect(wParam, auStack_36 + 4, hbrButtonFace);
            return 1;
        }
        if (message == WM_CTLCOLOR) {
            if ((THING *)lParam == (THING *)hwndMsgScroll) {
                SetBkColor(wParam, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
                return (ulong)hbrButtonFace;
            }
            goto MSG_Default_9;
        }
        if (message == WM_SETCURSOR) {
            local_30 = 0;
            GetCursorPos(&local_2e);
            ScreenToClient(hwnd, &local_2e);
            uVar5 = 0x1030;
            sVar10 = HtMsgBox(local_2e);
            puVar17 = &stack0xff80;
            if (sVar10 != 0) {
                SetCursor(hcurHand);
                return 1;
            }
            goto MSG_Default_9;
        }
        if (message == WM_GETMINMAXINFO) {
            *(int *)((int)&((THING *)lParam)->u_THING_0x0006 + 6) = dxWinFrame * 2 + 0xc6;
            *(int *)((int)&((THING *)lParam)->u_THING_0x0006 + 8) = (dyArial8 * 0xd >> 1) + 0x16;
            puVar17 = &stack0xff84;
            goto MSG_Default_9;
        }
        if (message == WM_KEYDOWN) {
            if (wParam == 0x28) {
            MSG_NextMsg:
                if (((uint)gd.grBits >> 8 & 1) == 0) {
                    uVar12 = GetAsyncKeyState(0x10);
                    if ((uVar12 & 0xfffe) == 0) {
                        i = IMsgNext(0);
                    } else {
                        iMsgCur = cMsg + vcmsgplrIn;
                        i = IMsgPrev(0);
                    }
                    puVar15 = &stack0xff82;
                    if (i == -1) {
                        return 0;
                    }
                    iMsgCur = i;
                } else {
                    FFinishPlrMsgEntry(1);
                    puVar15 = &stack0xff84;
                }
            } else {
                if (wParam != 0x26) {
                    puVar17 = &stack0xff84;
                    if (((uint)gd.grBits >> 8 & 1) != 0)
                        goto MSG_Default_9;
                    if (wParam == 0x24) {
                        iMsgCur = -1;
                        goto MSG_NextMsg;
                    }
                    if (wParam != 0x23) {
                        return 0;
                    }
                    iMsgCur = cMsg + vcmsgplrIn;
                }
            MSG_PrevMsg:
                if (((uint)gd.grBits >> 8 & 1) == 0) {
                    uVar12 = GetAsyncKeyState(0x10);
                    if ((uVar12 & 0xfffe) == 0) {
                        i = IMsgPrev(0);
                    } else {
                        iMsgCur = -1;
                        i = IMsgNext(0);
                    }
                    puVar15 = &stack0xff82;
                    if (i == -1) {
                        if (iMsgCur != cMsg + vcmsgplrIn) {
                            return 0;
                        }
                        iMsgCur = iMsgCur + -1;
                        puVar15 = &stack0xff82;
                    } else {
                        iMsgCur = i;
                    }
                } else {
                    FFinishPlrMsgEntry(-1);
                    puVar15 = &stack0xff84;
                }
            }
        MSG_SetupNewMsg:
            gd.grBits._0_2_ = (uint)gd.grBits & 0xefff;
            puVar15[-1] = hwnd;
            puVar15[-2] = 0x1030;
            puVar15[-3] = 0x6c3e;
            SetMsgTitle(puVar15[-1]);
            puVar15[-1] = hwnd;
            puVar15[-2] = 0x1120;
            puVar15[-3] = (RECT *)&rcMsgText;
            puVar15[-4] = 1;
            puVar15[-5] = 0x1030;
            puVar15[-6] = 0x6c54;
            InvalidateRect(puVar15[-1], *(RECT **)(puVar15 + -3), puVar15[-4]);
            if (((uint)gd.grBits >> 0xb & 1) == 0) {
                return 0;
            }
            tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
            *puVar15 = 0x14f8;
            puVar15[-1] = 0x6c78;
            AdvanceTutor();
            return 0;
        }
        if (message == WM_CHAR) {
            if (wParam == 0xd) {
            MSG_GotoMsg:
                puVar16 = &stack0xff84;
                if ((((uint)gd.grBits >> 8 & 1) == 0) && (iMsgCur < cMsg)) {
                    uVar5 = 0x1030;
                    switch (mdMsgObj) {
                    default:
                        uVar5 = 0x1030;
                        break;
                    case 1:
                        SelectAdjPlanet(0, idMsgObj);
                        UpdateWindow(hwndScanner);
                        SendMessage(hwndScanner, WM_CHAR, 0x76, 0);
                        uVar5 = 0x1030;
                        local_2e.y = IdmGetMessageN(iMsgCur);
                        if (((local_2e.y == 0x3e) || (local_2e.y == 0x3f)) || ((0xae < local_2e.y && (local_2e.y < 0xb5)))) {
                            if (((uint)gd.grBits >> 0xc & 1) == 0) {
                                gd.grBits._0_2_ = (uint)gd.grBits & 0xefff | 0x1000;
                                uVar5 = 0x1030;
                                SetMsgTitle(hwnd);
                            } else if ((sel.grobj == grobjPlanet) && (sel.id == idMsgObj)) {
                                uVar5 = 0x10d0;
                                ChangeProduction(0);
                            }
                        }
                        puVar16 = &stack0xff84;
                        break;
                    case 2:
                        SelectAdjFleet(0, idMsgObj);
                        UpdateWindow(hwndScanner);
                        uVar5 = 0x14f8;
                        SendMessage(hwndScanner, WM_CHAR, 0x76, 0);
                        puVar16 = &stack0xff84;
                        break;
                    case 3:
                        uVar5 = 0x14f8;
                        PostMessage(hwndFrame, WM_COMMAND, IDM_GAME_RESEARCH, 0);
                        puVar16 = &stack0xff84;
                        break;
                    case 4:
                        vpartBrowser.hs.grhst = 1 << ((byte)((uint)idMsgObj >> 8) & 0xf);
                        local_2e = (POINT)(CONCAT22(idMsgObj, local_2e.x) & 0xffffff);
                        vpartBrowser.hs.wFlags_0x2 = vpartBrowser.hs.wFlags_0x2 & 0xff00 | local_2e.y;
                        FLookupPart((PART *)&vpartBrowser);
                        if (hwndBrowser == 0) {
                            fBrowserValid = 1;
                            PostMessage(hwndFrame, WM_COMMAND, IDM_VIEW_BROWSER_TOGGLE2, 0);
                            puVar16 = &stack0xff84;
                        } else {
                            InvalidateRect(hwndBrowserChild, 0, 1);
                            puVar16 = &stack0xff86;
                        }
                        uVar5 = 0x14f8;
                        break;
                    case 5:
                        uVar5 = 0x14f8;
                        PostMessage(hwndFrame, WM_COMMAND, IDM_GAME_SHIP_BUILDER, 0);
                        puVar16 = &stack0xff84;
                        break;
                    case 6:
                        SelectOursAtObject((POINT *)&vptMsg);
                        if (((uint)gd.grBits >> 0xc & 1) == 0) {
                            gd.grBits._0_2_ = (uint)gd.grBits & 0xefff | 0x1000;
                            uVar5 = 0x1030;
                            SetMsgTitle(hwnd);
                        } else {
                            uVar5 = 0x10e8;
                            BattleVCR(idMsgObj);
                        }
                        puVar16 = &stack0xff84;
                        break;
                    case 7:
                        uVar5 = 0x14f8;
                        PostMessage(hwndFrame, WM_COMMAND, IDM_GAME_RELATIONS2, 0);
                        puVar16 = &stack0xff84;
                        break;
                    case 8:
                        uVar5 = 0x14f8;
                        PostMessage(hwndFrame, WM_COMMAND, IDM_GAME_SCORE, 0);
                        puVar16 = &stack0xff84;
                        break;
                    case 9:
                        szWork[200] = '\x02';
                        local_2e = (POINT)MakeProcInstance(MsgDlg, hInst);
                        HVar6 = hwndTitle;
                        if (hwndTitle == 0) {
                            HVar6 = hwndFrame;
                        }
                        local_30 = DialogBox(0, IDD_GENERIC_SMALL, HVar6, (FARPROC)local_2e);
                        uVar5 = 0x14f8;
                        FreeProcInstance((FARPROC)local_2e);
                        if (local_30 != 0) {
                            uVar5 = 0x1038;
                            sVar10 = FValidSerialNo((char *)szWork, auStack_36 + 2);
                            if (sVar10 == 0) {
                                if (((MSGPLR *)vSerialNumber == 0) && (vSerialNumber._2_2_ == 0)) {
                                    uVar5 = 0x1118;
                                    _memcpy((byte *)vrgbMachineConfig, (byte_0_ *)&vrgbEnvCur, 0xb);
                                }
                            } else {
                                vSerialNumber._0_2_ = (MSGPLR *)auStack_36._2_2_;
                                vSerialNumber._2_2_ = auStack_36._4_2_;
                                uVar5 = 0x1118;
                                _memcpy((byte *)vrgbMachineConfig, (byte_0_ *)&vrgbEnvCur, 0xb);
                            }
                        }
                        puVar16 = &stack0xff84;
                        break;
                    case 10:
                        uVar5 = 0x1038;
                        local_2e = (POINT)LpthFromId(vptMsg.x);
                        iVar7 = local_2e.y;
                        pTVar22 = (THING *)local_2e.x;
                        if ((pTVar22 != 0) || (iVar7 != 0)) {
                            local_3e._0_2_ = (&pTVar22->pt)->x;
                            local_3e._2_2_ = (pTVar22->pt).y;
                            local_3e._4_2_ = grobjThing;
                            ChangeScanSel(local_3e, 0);
                            uVar5 = 0x1058;
                            pt.y = local_3e._2_2_;
                            pt.x = local_3e._0_2_;
                            CtrPointScan(pt, 1);
                        }
                        puVar16 = &stack0xff84;
                        break;
                    case 0xb:
                        if ((hwndReportDlg == 0) || (vprptCur != (RPT *)&vrptBattle)) {
                            uVar5 = 0x14f8;
                            PostMessage(hwndFrame, WM_COMMAND, IDM_REPORT_BATTLE, 0);
                        }
                        puVar16 = &stack0xff84;
                    }
                    if (((uint)gd.grBits >> 0xb & 1) == 0) {
                        return 0;
                    }
                    tutor.wFlags = tutor.wFlags & 0xfffbU | 4;
                    *(undefined2 *)(puVar16 + -2) = uVar5;
                    *(undefined2 *)(puVar16 + -4) = 0x7187;
                    AdvanceTutor();
                    return 0;
                }
            MSG_ToggleMsgMode:
                if (((uint)gd.grBits >> 8 & 1) == 0) {
                    if (iMsgCur < cMsg) {
                        viInRe = 0;
                    } else {
                        stack0xffc8 = (MSGPLR *)CONCAT22(vlpmsgplrIn._2_2_, (MSGPLR *)vlpmsgplrIn);
                        i = iMsgCur - cMsg;
                        while (true) {
                            pMVar13 = (MSGPLR *)stack0xffc8;
                            uVar5 = (undefined2)((ulong)stack0xffc8 >> 0x10);
                            if (i == 0)
                                break;
                            /* WARNING: Load size is inaccurate */
                            stack0xffc8 = (MSGPLR *)CONCAT22(*(undefined2 *)((int)&pMVar13->lpmsgplrNext + 2), stack0xffc8->lpmsgplrNext);
                            i = i + -1;
                        }
                        auStack_36._4_2_ = vlpmsgplrOut._2_2_;
                        auStack_36._2_2_ = (MSGPLR *)vlpmsgplrOut;
                        iMsgSendCur = 0;
                        while (true) {
                            if ((((MSGPLR *)auStack_36._2_2_ == 0) && (auStack_36._4_2_ == 0)) ||
                                ((*(short *)(auStack_36._2_2_ + 6) + -1 == pMVar13->iPlrFrom && (*(short *)(auStack_36._2_2_ + 8) == iMsgCur))))
                                break;
                            ppMVar2 = (MSGPLR **)auStack_36._2_4_;
                            /* WARNING: Load size is inaccurate */
                            auStack_36._4_2_ = *(undefined2 *)((int)(MSGPLR **)auStack_36._2_2_ + 2);
                            auStack_36._2_2_ = *ppMVar2;
                            iMsgSendCur = iMsgSendCur + 1;
                        }
                        viInRe = pMVar13->iPlrFrom + 1;
                        i = -1;
                    }
                } else {
                    FFinishPlrMsgEntry(0);
                }
                bVar18 = ((uint)gd.grBits >> 8 & 1) == 0;
                auStack_36[4] = bVar18;
                auStack_36[5] = 0;
                uVar3 = auStack_36._2_4_;
                auStack_36[5] = 0;
                gd.grBits._0_2_ = (uint)gd.grBits & 0xfeff | auStack_36._4_2_ << 8;
                auStack_36._2_4_ = uVar3;
                InvalidateRect(hwndMessage, 0, 1);
                SetMsgTitle(hwnd);
                SetFocus(hwndMsgEdit);
                return 0;
            }
            if (wParam == 0x2b) {
            MSG_CheckBox:
                if (iMsgCur < 0) {
                    return 0;
                }
                auStack_36._2_2_ = IdmGetMessageN(iMsgCur);
                uVar12 = 1 << ((byte)auStack_36._2_2_ & 7);
                stack0xffc8 = (MSGPLR *)CONCAT22(uVar12, local_3e._6_2_);
                auStack_36[4] = (((byte *)bitfMsgFiltered)[(int)auStack_36._2_2_ >> 3] & uVar12) != 0;
                auStack_36[5] = 0;
                SetFilteringGroups(auStack_36._2_2_, (uint) !(bool)auStack_36[4]);
                DirtyGame(1);
                if (((uint)gd.grBits >> 0xb & 1) != 0) {
                    AdvanceTutor();
                }
                InvalidateRect(hwndMessage, 0, 1);
                SetMsgTitle(hwnd);
                return 0;
            }
            if (wParam != 0x2d) {
                return 0;
            }
            local_2e = (POINT)((ulong)local_2e & 0xffff);
            while ((uint)local_2e.y < 0x31) {
                bVar1 = ((byte *)bitfMsgFiltered)[local_2e.y];
                local_2e.x = (short)(uint)bVar1;
                if ((((byte *)bitfMsgSent)[local_2e.y] & bVar1) != 0)
                    break;
                local_2e.y = local_2e.y + 1;
            }
            if (local_2e.y == 0x31) {
                return 0;
            }
        } else {
            if (message == WM_COMMAND) {
                uVar5 = 0x1118;
                uVar19 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), (ushort)(MSGPLR *)lpmsgplr);
                if ((int)uVar19 == 0) {
                    uVar5 = 0x14f8;
                    SetFocus(hwndFrame);
                }
                if ((THING *)lParam == (THING *)rghwndMsgBtn[0]) {
                    uVar5 = 0x1118;
                    uVar19 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), (ushort)(MSGPLR *)lpmsgplr);
                    if ((int)uVar19 == 0)
                        goto MSG_PrevMsg;
                }
                if ((THING *)lParam == (THING *)rghwndMsgBtn[2]) {
                    uVar5 = 0x1118;
                    uVar19 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), (ushort)(MSGPLR *)lpmsgplr);
                    if ((int)uVar19 == 0)
                        goto MSG_NextMsg;
                }
                if ((THING *)lParam == (THING *)rghwndMsgBtn[3]) {
                    uVar5 = 0x1118;
                    uVar19 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), (ushort)(MSGPLR *)lpmsgplr);
                    if ((int)uVar19 == 0) {
                        FFinishPlrMsgEntry(1000);
                        puVar15 = &stack0xff84;
                        goto MSG_SetupNewMsg;
                    }
                }
                puVar17 = &stack0xff84;
                if ((THING *)lParam != (THING *)rghwndMsgBtn[1]) {
                MSG_Default_9:
                    *(HWND *)(puVar17 + -2) = hwnd;
                    *(WMType *)(puVar17 + -4) = message;
                    *(ushort *)(puVar17 + -6) = wParam;
                    *(undefined2 *)(puVar17 + -8) = lParam._2_2_;
                    *(THING **)(puVar17 + -10) = (THING *)lParam;
                    *(undefined2 *)(puVar17 + -0xc) = uVar5;
                    *(undefined2 *)(puVar17 + -0xe) = 0x719e;
                    LVar21 = DefWindowProc(*(HWND *)(puVar17 + -2), *(UINT *)(puVar17 + -4), *(WPARAM *)(puVar17 + -6), *(LPARAM *)(puVar17 + -10));
                    return LVar21;
                }
                uVar5 = 0x1118;
                uVar19 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), (ushort)(MSGPLR *)lpmsgplr);
                puVar17 = &stack0xff84;
                if ((int)uVar19 != 0)
                    goto MSG_Default_9;
                goto MSG_GotoMsg;
            }
            if ((message != WM_LBUTTONDOWN) && (puVar17 = &stack0xff84, message != WM_LBUTTONDBLCLK))
                goto MSG_Default_9;
            local_2e.x = (short)(THING *)lParam;
            uVar19 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), (ushort)(MSGPLR *)lpmsgplr);
            local_2e.y = (short)uVar19;
            pt_00.y = (short)uVar19;
            pt_00.x = local_2e.x;
            local_30 = HtMsgBox(pt_00);
            if (local_30 == 1)
                goto MSG_CheckBox;
            if (local_30 != 2) {
                if (local_30 != 3) {
                    return 0;
                }
                goto MSG_ToggleMsgMode;
            }
        }
        fViewFilteredMsg = (short)(fViewFilteredMsg == 0);
        if (-1 < iMsgCur) {
            sVar10 = IdmGetMessageN(iMsgCur);
            auStack_36._4_2_ = 1 << ((byte)sVar10 & 7);
            sVar10 = IdmGetMessageN(iMsgCur);
            if ((uint)(((uint)((byte *)bitfMsgFiltered)[sVar10 >> 3] & auStack_36._4_2_) != 0) == fViewFilteredMsg)
                goto LAB_1030_626c;
        }
        i = IMsgNext(fViewFilteredMsg);
        if (i == -1) {
            i = IMsgPrev(fViewFilteredMsg);
        }
        iMsgCur = i;
    LAB_1030_626c:
        InvalidateRect(hwndMessage, 0, 1);
        SetMsgTitle(hwnd);
        return 0;
    }
    hdc = BeginPaint(hwnd, &ps);
    Draw3dFrame(hdc, (RECT *)&rcMsgTitle, 0);
    auStack_36._2_4_ = SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
    local_3e._2_4_ = SetBkColor(hdc, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
    cch = _strlen((char *)szMsgTitle);
    puVar17 = &stack0xff86;
    auStack_36._0_2_ = (rcMsgTitle.right - rcMsgTitle.left) + -0x30;
    for (; 0 < cch; cch = cch + -1) {
        DVar20 = GetTextExtent(hdc, szMsgTitle, cch);
        if ((int)DVar20 <= (int)auStack_36._0_2_)
            break;
    }
    RcCtrTextOut(hdc, (RECT *)&rcMsgTitle, (char *)szMsgTitle, cch);
    DecorateMsgTitleBar(hdc, (RECT *)&rcMsgTitle);
    rc.left = rcMsgText.left;
    rc.top = rcMsgText.top;
    rc.right = rcMsgText.right;
    rc.bottom = rcMsgText.bottom;
    iVar7 = rcMsgText.right - rcMsgText.left;
    local_3e._6_2_ = rcMsgText.bottom - rcMsgText.top;
    local_30 = SelectObject(hdc, hbrButtonShadow);
    PatBlt(hdc, rc.left, rc.top, iVar7, 1, 0xf00021);
    PatBlt(hdc, rc.left, rc.top, 1, local_3e._6_2_, 0xf00021);
    SelectObject(hdc, hbrButtonHilite);
    PatBlt(hdc, rc.left, rc.bottom + -1, iVar7, 1, 0xf00021);
    PatBlt(hdc, rc.right + -1, rc.top, 1, local_3e._6_2_, 0xf00021);
    SelectObject(hdc, local_30);
    ExpandRc(&rc, -4, -4);
    if (((uint)gd.grBits >> 8 & 1) != 0) {
        sVar10 = SetBkMode(hdc, 1);
        SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
        sVar11 = CchGetString(idsTo3, szT);
        RightTextOut(hdc, rc.left + 0x1a, rc.top, szT, sVar11, 0);
        SetBkMode(hdc, sVar10);
        puVar17 = &stack0xff86;
        goto LAB_1030_6a4b;
    }
    if (iMsgCur < cMsg) {
        local_3e._0_2_ = IdmGetMessageN(iMsgCur);
        if ((iMsgCur < 0) && (0 < cMsg)) {
            local_2e.x = (short)PszGetCompressedString(idsMessagesHaveSentYearFilteredIfWant);
            local_2e.y = 0x1120;
        } else if ((iMsgCur < 0) ||
                   ((((uint)((byte *)bitfMsgFiltered)[(int)local_3e._0_2_ >> 3] & 1 << ((byte)local_3e._0_2_ & 7)) == 0 || (fViewFilteredMsg != 0)))) {
            local_2e.x = (short)PszGetMessageN(iMsgCur);
            local_2e.y = 0x1120;
        } else {
            local_2e.x = (short)PszGetCompressedString(idsMessageTypeHasFilteredWillShownDefault);
            local_2e.y = 0x1120;
        }
    } else {
        lpmsgplr = (MSGPLR *)CONCAT22(vlpmsgplrIn._2_2_, (MSGPLR *)vlpmsgplrIn);
        i = cMsg;
        while (true) {
            pMVar13 = (MSGPLR *)lpmsgplr;
            uVar5 = (undefined2)((ulong)lpmsgplr >> 0x10);
            if (iMsgCur <= i)
                break;
            /* WARNING: Load size is inaccurate */
            lpmsgplr = (MSGPLR *)CONCAT22(*(undefined2 *)((int)&pMVar13->lpmsgplrNext + 2), lpmsgplr->lpmsgplrNext);
            i = i + 1;
        }
        CchGetString(idsSCC, szT);
        pcVar4 = PszPlayerName(pMVar13->iPlrFrom, 1, 1, 1, 0, 0);
        sVar10 = _wsprintf((char *)CONCAT22(lpb2k._2_2_, (byte *)lpb2k), szT, pcVar4);
        CchGetString(idsSCC2, szT);
        if (pMVar13->iPlrTo == 0) {
            pcVar4 = PszGetCompressedString(idsEverybody);
        } else {
            pcVar4 = PszPlayerName(pMVar13->iPlrTo + -1, 1, 1, 1, 0, 0);
        }
        sVar11 = _wsprintf((char *)CONCAT22(lpb2k._2_2_, (byte *)lpb2k + sVar10), szT, pcVar4);
        if (pMVar13->cLen < 0) {
            __fstrcpy((char *)CONCAT22(lpb2k._2_2_, (byte *)lpb2k + sVar10 + sVar11), (char *)CONCAT22(uVar5, pMVar13 + 1));
        } else {
            i = 1000;
            FDecompressUserString((char *)CONCAT22(uVar5, pMVar13 + 1), pMVar13->cLen, (char *)CONCAT22(lpb2k._2_2_, (byte *)lpb2k + sVar10 + sVar11), &i);
        }
        local_2e.y = lpb2k._2_2_;
        local_2e.x = (short)(byte *)lpb2k;
    }
    SetTextColor(hdc, 0xffffff);
    sVar10 = SetBkMode(hdc, 1);
    if ((iMsgCur < 0) && (0 < cMsg)) {
    LAB_1030_68c6:
        sVar11 = CchGetString(idsFiltered, (char *)szWork);
        DiaganolTextOut(hdc, &rc, (char *)szWork, sVar11);
        local_2e.x = (short)PszGetMessageN(iMsgCur);
        local_2e.y = 0x1120;
    } else if ((-1 < iMsgCur) && (iMsgCur < cMsg)) {
        sVar11 = IdmGetMessageN(iMsgCur);
        sVar8 = IdmGetMessageN(iMsgCur);
        if (((uint)((byte *)bitfMsgFiltered)[sVar8 >> 3] & 1 << ((byte)sVar11 & 7)) != 0)
            goto LAB_1030_68c6;
    }
    SetTextColor(hdc, CONCAT22(crButtonText._2_2_, (undefined2)crButtonText));
    rcActual.left = rc.left;
    rcActual.top = rc.top;
    rcActual.right = rc.right;
    rcActual.bottom = rc.bottom;
    pTVar22 = (THING *)local_2e.x;
    sVar11 = local_2e.y;
    HVar23 = hdc;
    uVar9 = __fstrlen((char *)local_2e);
    DRAWTEXT(HVar23, (LPCSTR)CONCAT22(sVar11, pTVar22), uVar9, &rcActual, 0xc10);
    if ((rc.bottom < rcActual.bottom) || (rc.right < rcActual.right)) {
        SetWindowText(hwndMsgScroll, (LPCSTR)local_2e);
        ExpandRc(&rc, 4, 4);
        SetWindowPos(hwndMsgScroll, 0, rc.left, rc.top, rc.right - rc.left, rc.bottom - rc.top, 0x44);
        puVar17 = &stack0xff80;
    } else {
        ShowWindow(hwndMsgScroll, 0);
        pTVar22 = (THING *)local_2e.x;
        sVar11 = local_2e.y;
        HVar23 = hdc;
        uVar9 = __fstrlen((char *)local_2e);
        DRAWTEXT(HVar23, (LPCSTR)CONCAT22(sVar11, pTVar22), uVar9, &rc, 0x810);
    }
    *(HDC *)(puVar17 + -2) = hdc;
    *(short *)(puVar17 + -4) = sVar10;
    *(undefined2 *)(puVar17 + -6) = 0x14f8;
    *(undefined2 *)(puVar17 + -8) = 0x69eb;
    SetBkMode(*(HDC *)(puVar17 + -2), *(short *)(puVar17 + -4));
LAB_1030_6a4b:
    *(HDC *)(puVar17 + -2) = hdc;
    *(undefined2 *)(puVar17 + -4) = auStack_36._4_2_;
    *(undefined2 *)(puVar17 + -6) = auStack_36._2_2_;
    *(undefined2 *)(puVar17 + -8) = 0x14f8;
    *(undefined2 *)(puVar17 + -10) = 0x6a59;
    SetTextColor(*(HDC *)(puVar17 + -2), *(COLORREF *)(puVar17 + -6));
    *(HDC *)(puVar17 + -2) = hdc;
    *(undefined2 *)(puVar17 + -4) = local_3e._4_2_;
    *(undefined2 *)(puVar17 + -6) = local_3e._2_2_;
    *(undefined2 *)(puVar17 + -8) = 0x14f8;
    *(undefined2 *)(puVar17 + -10) = 0x6a67;
    SetBkColor(*(HDC *)(puVar17 + -2), *(COLORREF *)(puVar17 + -6));
    *(HWND *)(puVar17 + -2) = hwnd;
    *(undefined2 *)(puVar17 + -4) = unaff_SS;
    *(PAINTSTRUCT **)(puVar17 + -6) = &ps;
    *(undefined2 *)(puVar17 + -8) = 0x14f8;
    *(undefined2 *)(puVar17 + -10) = 0x6a76;
    EndPaint(*(HWND *)(puVar17 + -2), *(PAINTSTRUCT **)(puVar17 + -6));
    return 0;
}

// ======================================================================
// Function: SetMsgTitle
// Address: 1030:7218
// Segment: MEMORY_MSG
// ======================================================================

/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

void SetMsgTitle(HWND hwnd)

{
    int         iVar1;
    short       sVar2;
    char       *pcVar3;
    short       sVar4;
    undefined1 *puVar5;
    undefined2  unaff_SS;
    FLEET      *pFVar6;
    ushort      uVar7;
    RECT        rc;
    MSGPLR     *lpmp;
    short       sw;
    char        szT[80];
    char        ch;
    MSGBIG      mb;
    short       i;
    short       cMsgTot;

    if (hwnd == 0) {
        return;
    }
    if (fAi != 0) {
        return;
    }
    if (((uint)gd.grBits >> 8 & 1) == 0) {
        sVar2 = 0;
    } else {
        sVar2 = 5;
    }
    ShowWindow(hwndMsgEdit, sVar2);
    ShowWindow(hwndMsgDrop, sVar2);
    ShowWindow(rghwndMsgBtn[3], sVar2);
    if (((uint)gd.grBits >> 8 & 1) != 0) {
        ShowWindow(hwndMsgScroll, 0);
    }
    cMsgTot = cMsg + vcmsgplrIn;
    if (((uint)gd.grBits >> 8 & 1) == 0) {
        if (iMsgCur < cMsg) {
            if (((uint)gd.grBits >> 0xc & 1) == 0) {
                i = idsGoto3;
            } else {
                i = idsView;
            }
        } else {
            i = idsReply;
        }
    } else {
        i = idsDone;
    }
    uVar7 = rghwndMsgBtn[1];
    pcVar3 = PszGetCompressedString(i);
    SetWindowText(uVar7, pcVar3);
    if (((uint)gd.grBits >> 8 & 1) != 0) {
        pcVar3 = PszGetCompressedString(idsSendMessagesDD);
        _wsprintf(szWork, pcVar3);
        rc.left = rcMsgText.left;
        rc.top = rcMsgText.top;
        rc.right = rcMsgText.right;
        rc.bottom = rcMsgText.bottom;
        ExpandRc(&rc, -4, -4);
        SetWindowPos(hwndMsgDrop, 0, rc.left + 0x1e, rc.top, (rc.right - rc.left) + -0x54, rc.bottom - rc.top, 0x44);
        SetWindowPos(rghwndMsgBtn[3], 0, rc.right + -0x32, rc.top, 0, 0, 0x45);
        rc.top = rc.top + dyShipDD + 3;
        SetWindowPos(hwndMsgEdit, 0, rc.left, rc.top, rc.right - rc.left, rc.bottom - rc.top, 0x44);
        EnableWindow(rghwndMsgBtn[0], (uint)(0 < iMsgSendCur));
        EnableWindow(rghwndMsgBtn[1], 1);
        EnableWindow(rghwndMsgBtn[2], 1);
        lpmp = (MSGPLR *)CONCAT22(vlpmsgplrOut._2_2_, (MSGPLR *)vlpmsgplrOut);
        i = iMsgSendCur;
        while (true) {
            iVar1 = i + -1;
            if (i < 1)
                break;
            /* WARNING: Load size is inaccurate */
            lpmp = (MSGPLR *)CONCAT22(*(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2), lpmp->lpmsgplrNext);
            i = iVar1;
        }
        if (((MSGPLR *)lpmp == 0) && (lpmp._2_2_ == 0)) {
            i = iVar1;
            SendMessage(hwndMsgDrop, CB_SETCURSEL, viInRe, 0);
            SetWindowText(hwndMsgEdit, (LPCSTR)0x11200b34);
        } else {
            i = iVar1;
            SendMessage(hwndMsgDrop, CB_SETCURSEL, ((MSGPLR *)lpmp)->iPlrTo, 0);
            if (((MSGPLR *)lpmp)->cLen < 0) {
                SetWindowText(hwndMsgEdit, (LPCSTR)((MSGPLR *)lpmp + 1));
            } else {
                i = 1000;
                FDecompressUserString((char *)((MSGPLR *)lpmp + 1), ((MSGPLR *)lpmp)->cLen, (char *)CONCAT22(lpb2k._2_2_, (byte *)lpb2k), &i);
                SetWindowText(hwndMsgEdit, (LPCSTR)CONCAT22(lpb2k._2_2_, (byte *)lpb2k));
            }
        }
        puVar5 = &stack0xff76;
        goto MSG_FinishUp;
    }
    if (cMsgTot == 0) {
        CchGetString(idsYearDCMessagesNone, szT);
        _wsprintf(szWork, szT);
    } else {
        CchGetString(idsYearDCMessagesDD, szT);
        _wsprintf(szWork, szT, game.turn + 0x960);
    }
    puVar5 = &stack0xff7c;
    uVar7 = rghwndMsgBtn[0];
    sVar2 = IMsgPrev(0);
    EnableWindow(uVar7, (uint)(sVar2 != -1));
    uVar7 = rghwndMsgBtn[2];
    sVar2 = IMsgNext(0);
    EnableWindow(uVar7, (uint)(sVar2 != -1));
    if (cMsg <= iMsgCur) {
        EnableWindow(rghwndMsgBtn[1], 1);
        goto MSG_FinishUp;
    }
    if (((cMsg != 0) && (iMsgCur < cMsg)) && (sVar2 = FGetNMsgbig(iMsgCur, &mb), sVar2 != 0)) {
        if (mb.wGoto == -1) {
            mdMsgObj = 0;
        } else {
            idMsgObj = mb.wGoto & 0x7fff;
            if (mb.wGoto == -2) {
                mdMsgObj = 3;
            } else if (mb.wGoto == -3) {
                mdMsgObj = 5;
            } else if (mb.wGoto == -4) {
                mdMsgObj = 8;
            } else if (mb.wGoto == -5) {
                mdMsgObj = 9;
            } else if (mb.wGoto == -6) {
                mdMsgObj = 10;
                vptMsg.x = mb.rgParam[0];
            } else if (mb.wGoto == -7) {
                mdMsgObj = 0xb;
            } else if ((mb.wGoto & 0xc000U) == 0xc000) {
                mdMsgObj = 4;
            } else if ((mb.wGoto & 0x4000U) == 0) {
                if (mb.wGoto < 0) {
                    pFVar6 = LpflFromId(idMsgObj);
                    if (pFVar6 == 0) {
                        mdMsgObj = 0;
                    } else {
                        mdMsgObj = 2;
                    }
                } else {
                    mdMsgObj = 1;
                }
            } else {
                idMsgObj = mb.wGoto & 0x3fff;
                if (idMsgObj == 0x800) {
                    mdMsgObj = 7;
                } else {
                    mdMsgObj = 6;
                    vptMsg.x = mb.rgParam[0];
                    vptMsg.y = mb.rgParam[1];
                }
            }
        }
    }
    if (mdMsgObj != 0) {
        if (iMsgCur < 0) {
        LAB_1030_77bb:
            mdMsgObj = 0;
        } else if (fViewFilteredMsg == 0) {
            sVar2 = IdmGetMessageN(iMsgCur);
            sVar4 = IdmGetMessageN(iMsgCur);
            if (((uint)((byte *)bitfMsgFiltered)[sVar4 >> 3] & 1 << ((byte)sVar2 & 7)) != 0)
                goto LAB_1030_77bb;
        }
    }
    EnableWindow(rghwndMsgBtn[1], (uint)(mdMsgObj != 0));
    puVar5 = &stack0xff7c;
MSG_FinishUp:
    *(char **)(puVar5 + -2) = (char *)szWork;
    *(char **)(puVar5 + -4) = (char *)szMsgTitle;
    *(undefined2 *)(puVar5 + -6) = 0x14f8;
    *(undefined2 *)(puVar5 + -8) = 0x77eb;
    _strcpy(*(char **)(puVar5 + -4), *(char **)(puVar5 + -2));
    *(HWND *)(puVar5 + -2) = hwndMessage;
    *(undefined2 *)(puVar5 + -4) = 0x1120;
    *(RECT **)(puVar5 + -6) = (RECT *)&rcMsgTitle;
    *(undefined2 *)(puVar5 + -8) = 1;
    *(undefined2 *)(puVar5 + -10) = 0x1118;
    *(undefined2 *)(puVar5 + -0xc) = 0x7802;
    InvalidateRect(*(HWND *)(puVar5 + -2), *(RECT **)(puVar5 + -6), *(BOOL *)(puVar5 + -8));
    return;
}

// ======================================================================
// Function: IMsgNext
// Address: 1030:7808
// Segment: MEMORY_MSG
// ======================================================================

short IMsgNext(short fFilteredOnly)

{
    short sVar1;
    short idm;
    short i;

    i = iMsgCur;
    if ((fViewFilteredMsg == 0) || (fFilteredOnly != 0)) {
        do {
            i = i + 1;
            if (cMsg <= i) {
                if (i < cMsg + vcmsgplrIn) {
                    return i;
                }
                return -1;
            }
            sVar1 = IdmGetMessageN(i);
        } while ((uint)(((uint)((byte *)bitfMsgFiltered)[sVar1 >> 3] & 1 << ((byte)sVar1 & 7)) == 0) == fFilteredOnly);
    } else if (iMsgCur < cMsg + vcmsgplrIn + -1) {
        i = iMsgCur + 1;
    } else {
        i = -1;
    }
    return i;
}

// ======================================================================
// Function: IMsgPrev
// Address: 1030:78d8
// Segment: MEMORY_MSG
// ======================================================================

short IMsgPrev(short fFilteredOnly)

{
    short sVar1;
    short idm;
    short i;

    i = iMsgCur;
    if ((fViewFilteredMsg == 0) || (fFilteredOnly != 0)) {
        if (cMsg < iMsgCur) {
            i = iMsgCur + -1;
        } else {
            do {
                i = i + -1;
                if (i < 0) {
                    return -1;
                }
                sVar1 = IdmGetMessageN(i);
            } while ((uint)(((uint)((byte *)bitfMsgFiltered)[sVar1 >> 3] & 1 << ((byte)sVar1 & 7)) == 0) == fFilteredOnly);
        }
    } else if (iMsgCur < 1) {
        i = -1;
    } else {
        i = iMsgCur + -1;
    }
    return i;
}

// ======================================================================
// Function: DecorateMsgTitleBar
// Address: 1030:799c
// Segment: MEMORY_MSG
// ======================================================================

void DecorateMsgTitleBar(HDC hdc, RECT *prc)

{
    HDC      HVar1;
    int      iVar2;
    short    sVar3;
    HGDIOBJ  HVar4;
    int      iVar5;
    COLORREF CVar6;
    COLORREF CVar7;
    COLORREF crTextSav;
    COLORREF crBkSav;
    short    xyStart;
    short    dxSrc;
    short    yDst;
    short    ySrc;
    short    idm;
    HDC      hdcMem;
    short    i;
    short    dySrc;
    HBITMAP  hbmpSav;
    HBRUSH   hbrSav;
    short    ySrcMask;
    short    xDst;

    CVar7 = CONCAT22(crBkSav._2_2_, (undefined2)crBkSav);
    CVar6 = CONCAT22(crTextSav._2_2_, (undefined2)crTextSav);
    HVar1 = CreateCompatibleDC(hdc);
    hbmpSav = SelectObject(HVar1, hbmpMono);
    if (((uint)gd.grBits >> 8 & 1) == 0) {
        iVar2 = ((prc->bottom - prc->top) + -0xb) / 2 + prc->top;
        if ((-1 < iMsgCur) && (iMsgCur < cMsg)) {
            sVar3 = IdmGetMessageN(iMsgCur);
            if (((uint)((byte *)bitfMsgFiltered)[sVar3 >> 3] & 1 << ((byte)sVar3 & 7)) == 0) {
                ySrc = 0;
                dxSrc = 0xf;
                dySrc = 0xe;
                ySrcMask = 0x1c;
                yDst = iVar2 + -3;
                xDst = iVar2;
            } else {
                ySrc = 0xe;
                dxSrc = 0xe;
                dySrc = 0xc;
                xDst = iVar2 + -1;
                ySrcMask = 0x2a;
                yDst = iVar2;
            }
            CVar6 = SetTextColor(hdc, 0);
            CVar7 = SetBkColor(hdc, 0xffffff);
            BitBlt(hdc, xDst, yDst, dxSrc, dySrc, HVar1, 0, ySrcMask, 0x8800c6);
            hbmpSav = SelectObject(HVar1, hbmpMsg);
            BitBlt(hdc, xDst, yDst, dxSrc, dySrc, HVar1, 0, ySrc, 0xee0086);
        }
        i = 0;
        while (((uint)i < 0x31 && ((((byte *)bitfMsgSent)[i] & ((byte *)bitfMsgFiltered)[i]) == 0))) {
            i = i + 1;
        }
        if (i == 0x31) {
            fViewFilteredMsg = 0;
        } else {
            if (fViewFilteredMsg == 0) {
                ySrc = 0x29;
                ySrcMask = 0x45;
            } else {
                ySrc = 0x1a;
                ySrcMask = 0x36;
            }
            iVar2 = prc->right - (prc->bottom - prc->top);
            HVar4 = SelectObject(hdc, hbrButtonShadow);
            PatBlt(hdc, iVar2 + -1, prc->top, 1, prc->bottom - prc->top, 0xf00021);
            SelectObject(hdc, hbrButtonHilite);
            PatBlt(hdc, iVar2, prc->top, 1, prc->bottom - prc->top, 0xf00021);
            SelectObject(hdc, HVar4);
            iVar2 = ((prc->bottom - prc->top) + -0xf) / 2 + prc->top;
            iVar5 = prc->right - (prc->bottom - iVar2);
            SelectObject(HVar1, hbmpMono);
            BitBlt(hdc, iVar5, iVar2, 0xf, 0xf, HVar1, 0, ySrcMask, 0x8800c6);
            SelectObject(HVar1, hbmpMsg);
            BitBlt(hdc, iVar5, iVar2, 0xf, 0xf, HVar1, 0, ySrc, 0xee0086);
        }
    }
    SetTextColor(hdc, CVar6);
    SetBkColor(hdc, CVar7);
    if ((game.wCrap >> 2 & 1) == 0) {
        SelectObject(HVar1, hbmpMsg);
        iVar2 = prc->right;
        iVar5 = ((prc->bottom - prc->top) + -7) / 2 + prc->top;
        PatBlt(hdc, iVar2 + -0x2e, iVar5 + -1, 0x11, 0xb, 0x42);
        BitBlt(hdc, iVar2 + -0x2d, iVar5, 0xf, 9, HVar1, 0, 0x38, 0xcc0020);
    }
    SelectObject(HVar1, hbmpSav);
    DeleteDC(HVar1);
    return;
}

// ======================================================================
// Function: HtMsgBox
// Address: 1030:7d8c
// Segment: MEMORY_MSG
// ======================================================================

short HtMsgBox(POINT pt)

{
    BOOL  BVar1;
    short i;

    BVar1 = PtInRect(&rcMsgTitle, pt);
    if (BVar1 != 0) {
        if ((((pt.x < (rcMsgTitle.bottom - rcMsgTitle.top) + rcMsgTitle.left) && (-1 < iMsgCur)) && (iMsgCur < cMsg)) && (((uint)gd.grBits >> 8 & 1) == 0)) {
            return 1;
        }
        if ((pt.x < rcMsgTitle.right - (rcMsgTitle.bottom - rcMsgTitle.top)) || (((uint)gd.grBits >> 8 & 1) != 0)) {
            if (((game.wCrap >> 2 & 1) == 0) && ((rcMsgTitle.right - (rcMsgTitle.bottom - rcMsgTitle.top)) + -0x18 <= pt.x)) {
                return 3;
            }
        } else {
            i = 0;
            while (((uint)i < 0x31 && ((((byte *)bitfMsgSent)[i] & ((byte *)bitfMsgFiltered)[i]) == 0))) {
                i = i + 1;
            }
            if (i != 0x31) {
                return 2;
            }
        }
    }
    return 0;
}

// ======================================================================
// Function: FSendPlrMsg2
// Address: 1030:7eaa
// Segment: MEMORY_MSG
// ======================================================================

short FSendPlrMsg2(short iPlr, MessageId iMsg, short iObj, short p1, short p2)

{
    short sVar1;

    sVar1 = FSendPlrMsg(iPlr, iMsg, iObj, p1, p2, 0, 0, 0, 0, 0);
    return sVar1;
}

// ======================================================================
// Function: FSendPlrMsg
// Address: 1030:7ee8
// Segment: MEMORY_MSG
// ======================================================================

short FSendPlrMsg(short iPlr, MessageId iMsg, short iObj, short p1, short p2, short p3, short p4, short p5, short p6, short p7)

{
    ushort     uVar1;
    uint       uVar2;
    undefined2 unaff_SS;
    byte      *lpb;
    short      cbMsg;
    byte       rgbWork[40];

    uVar1 = PackageUpMsg(rgbWork, iPlr, iMsg, iObj, p1, p2, p3, p4, p5, p6, p7);
    if ((int)uVar1 < 1) {
        uVar2 = (uint)(uVar1 == 0);
    } else {
        __fmemmove((void *)CONCAT22(lpMsg._2_2_, (void *)((int)(short *)lpMsg + imemMsgCur)), rgbWork, uVar1);
        imemMsgCur = imemMsgCur + uVar1;
        cMsg = cMsg + 1;
        uVar2 = 1;
    }
    return uVar2;
}

// ======================================================================
// Function: FSendPrependedPlrMsg
// Address: 1030:7f80
// Segment: MEMORY_MSG
// ======================================================================

short FSendPrependedPlrMsg(short iPlr, MessageId iMsg, short iObj, short p1, short p2, short p3, short p4, short p5, short p6, short p7)

{
    ushort     uVar1;
    uint       uVar2;
    undefined2 unaff_SS;
    short      cbMsg;
    byte       rgbWork[40];

    uVar1 = PackageUpMsg(rgbWork, iPlr, iMsg, iObj, p1, p2, p3, p4, p5, p6, p7);
    if ((int)uVar1 < 1) {
        uVar2 = (uint)(uVar1 == 0);
    } else {
        __fmemmove((void *)CONCAT22(lpMsg._2_2_, (void *)((int)(short *)lpMsg + uVar1)), (short *)CONCAT22(lpMsg._2_2_, (short *)lpMsg), imemMsgCur);
        __fmemmove((short *)CONCAT22(lpMsg._2_2_, (short *)lpMsg), rgbWork, uVar1);
        imemMsgCur = imemMsgCur + uVar1;
        cMsg = cMsg + 1;
        uVar2 = 1;
    }
    return uVar2;
}

// ======================================================================
// Function: PackageUpMsg
// Address: 1030:802a
// Segment: MEMORY_MSG
// ======================================================================

short PackageUpMsg(byte *pb, short iPlr, MessageId iMsg, short iObj, short p1, short p2, short p3, short p4, short p5, short p6, short p7)

{
    byte    *pbVar1;
    uint     uVar2;
    short    sVar3;
    byte    *lpbBase;
    byte    *lpb;
    MSGTURN *lpmt;
    ushort   grbit;
    short    i;
    short   *pi;

    if (iPlr == -1) {
        sVar3 = 0;
    } else if (((((*(uint *)((int)&rgplr[0].wMdPlr + iPlr * 0xc0) >> 9 & 1) == 0) || (*(uint *)((int)&rgplr[0].wMdPlr + iPlr * 0xc0) >> 0xd == 7)) ||
                (iMsg == idmHasBombedKillingOffEnemyColonists)) ||
               (((iMsg == idmHaveAttackedFirstRateStormTroopersThough || (iMsg == idmColonistsHaveDiedOffLongerControlPlanet)) ||
                 (iMsg == idmColonistsHaveJumpedShipLongerControlPlanet)))) {
        if (imemMsgCur + 0x14U < 0xffc9) {
            lpmt = (MSGTURN *)pb;
            lpmt->bFlags = lpmt->bFlags & 0xf0 | (byte)iPlr & 0xf;
            *(MessageId *)(pb + 1) =
                *(MessageId *)(pb + 1) & ~(idmDueExcessiveFleetManeuveringBattleAreaFleets | idmTipCanHideUnimportantMessagesClickingCheckmark) |
                iMsg & (idmDueExcessiveFleetManeuveringBattleAreaFleets | idmTipCanHideUnimportantMessagesClickingCheckmark);
            *(uint *)(pb + 1) = *(uint *)(pb + 1) & 0x1ff;
            *(short *)(pb + 3) = iObj;
            lpb = pb + 5;
            grbit = 1;
            pi = &p1;
            for (i = 0; i < ((char *)rgcMsgArgs)[iMsg]; i = i + 1) {
                if ((*pi & 0xff00U) == 0) {
                    *lpb = (byte)*pi;
                    pbVar1 = (byte *)lpb + 1;
                } else {
                    uVar2 = *(uint *)(pb + 1);
                    *(uint *)(pb + 1) = *(uint *)(pb + 1) & 0x1ff;
                    *(uint *)(pb + 1) = *(uint *)(pb + 1) | grbit << 9 | uVar2 & 0xfe00;
                    *lpb = *pi;
                    pbVar1 = (byte *)lpb + 2;
                }
                lpb = (byte *)CONCAT22(lpb._2_2_, pbVar1);
                pi = pi + 1;
                grbit = grbit << 1;
            }
            lpmt->bFlags = lpmt->bFlags & 0xf | ((char)lpb - (char)(pb + 5)) * '\x10';
            sVar3 = (int)(byte *)lpb - (int)pb;
        } else {
            sVar3 = -1;
        }
    } else {
        sVar3 = 0;
    }
    return sVar3;
}

// ======================================================================
// Function: FSendPlrMsg2XGen
// Address: 1030:823a
// Segment: MEMORY_MSG
// ======================================================================

short FSendPlrMsg2XGen(short fPrepend, MessageId iMsg, short iObj, short p1, short p2)

{
    short      sVar1;
    ushort     uVar2;
    undefined2 unaff_SS;
    MSGHDR    *pmsghdr;
    ushort     cSize;
    byte      *pb;
    ushort     grbit;
    short      i;
    short     *pi;
    byte       rgb[64];

    if (imemMsgCur + 0x14U < 0xffc9) {
        rgb._0_2_ = iMsg & (idmDueExcessiveFleetManeuveringBattleAreaFleets | idmTipCanHideUnimportantMessagesClickingCheckmark);
        ((byte *)bitfMsgSent)[(int)iMsg >> 3] = ((byte *)bitfMsgSent)[(int)iMsg >> 3] & ~(byte)(1 << ((byte)iMsg & 7)) | (byte)(1 << ((byte)iMsg & 7));
        rgb._2_2_ = iObj;
        pb = rgb + 4;
        grbit = 1;
        pi = &p1;
        for (i = 0; i < ((char *)rgcMsgArgs)[iMsg]; i = i + 1) {
            if ((*pi & 0xff00U) == 0) {
                *pb = (byte)*pi;
                pb = pb + 1;
            } else {
                rgb._0_2_ = rgb._0_2_ & 0x1ff | grbit << 9 | rgb._0_2_ & 0xfe00;
                *(short *)pb = *pi;
                pb = pb + 2;
            }
            pi = pi + 1;
            grbit = grbit << 1;
        }
        uVar2 = (int)pb - (int)rgb;
        if (fPrepend == 0) {
            __fmemmove((void *)CONCAT22(lpMsg._2_2_, (void *)((int)(short *)lpMsg + imemMsgCur)), rgb, uVar2);
        } else {
            __fmemmove((void *)CONCAT22(lpMsg._2_2_, (void *)((int)(short *)lpMsg + uVar2)), (short *)CONCAT22(lpMsg._2_2_, (short *)lpMsg), imemMsgCur);
            __fmemmove((short *)CONCAT22(lpMsg._2_2_, (short *)lpMsg), rgb, uVar2);
        }
        imemMsgCur = imemMsgCur + uVar2;
        cMsg = cMsg + 1;
        iMsgCur = -1;
        iMsgCur = IMsgNext(0);
        sVar1 = 1;
    } else {
        sVar1 = 0;
    }
    return sVar1;
}

// ======================================================================
// Function: IdmGetMessageN
// Address: 1030:8412
// Segment: MEMORY_MSG
// ======================================================================

short IdmGetMessageN(short iMsg)

{
    short  sVar1;
    MSGBIG mb;

    sVar1 = FGetNMsgbig(iMsg, &mb);
    if (sVar1 == 0) {
        mb.iMsg = -1;
    }
    return mb.iMsg;
}

// ======================================================================
// Function: FGetNMsgbig
// Address: 1030:8444
// Segment: MEMORY_MSG
// ======================================================================

short FGetNMsgbig(short iMsg, MSGBIG *pmb)

{
    char    cVar1;
    bool    bVar2;
    byte   *pbVar3;
    byte   *pbVar4;
    short   sVar5;
    uint    uVar6;
    byte   *pbVar7;
    ushort  u;
    byte   *lpb;
    short   i;
    MSGHDR *lpmh;
    short   iMax;
    byte   *lpbMax;

    if ((iMsg < 0) || (cMsg <= iMsg)) {
        sVar5 = 0;
    } else {
        lpb = (byte *)CONCAT22(lpMsg._2_2_, (short *)lpMsg);
        pbVar7 = (byte *)((int)(short *)lpMsg + imemMsgCur);
        do {
            pbVar4 = lpb;
            pbVar3 = (byte *)lpb;
            if (pbVar7 <= (byte *)lpb)
                break;
            u = *lpb >> 9;
            lpb = (byte *)lpb + 4;
            if (iMsg == 0) {
                pmb->iMsg = *pbVar4 & 0x1ff;
                pmb->wGoto = *(short *)(pbVar3 + 2);
            }
            cVar1 = ((char *)rgcMsgArgs)[*pbVar4 & 0x1ff];
            for (i = 0; i < cVar1; i = i + 1) {
                if (iMsg == 0) {
                    if ((u & 1) == 0) {
                        uVar6 = (uint)*lpb;
                    } else {
                        uVar6 = *lpb;
                    }
                    pmb->rgParam[i] = uVar6;
                }
                lpb = (byte *)CONCAT22(lpb._2_2_, (byte *)lpb + ((u & 1) == 1) + 1);
                u = u >> 1;
            }
            bVar2 = 0 < iMsg;
            iMsg = iMsg + -1;
        } while (bVar2);
        sVar5 = 1;
    }
    return sVar5;
}

// ======================================================================
// Function: PszGetMessageN
// Address: 1030:8580
// Segment: MEMORY_MSG
// ======================================================================

char *PszGetMessageN(short iMsg)

{
    short      sVar1;
    char      *pcVar2;
    undefined2 unaff_SS;
    char      *psz;
    MSGBIG     mb;

    sVar1 = FGetNMsgbig(iMsg, &mb);
    if (sVar1 == 0) {
        szMsgBuf[0] = '\0';
        pcVar2 = (char *)szMsgBuf;
    } else {
        pcVar2 = PszFormatMessage(mb.iMsg, mb.rgParam);
    }
    return pcVar2;
}

// ======================================================================
// Function: PszFormatString
// Address: 1030:85cc
// Segment: MEMORY_MSG
// ======================================================================

char *PszFormatString(char *pszFormat, short *pParamsReal)

{
    char       cVar1;
    short     *psVar2;
    short      sVar3;
    int        iPlayer;
    char      *pcVar4;
    ushort     uVar5;
    uint       uVar6;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    bool       bVar7;
    long       lVar8;
    long       lVar9;
    uint       in_stack_0000fe00;
    PART       local_1fe;
    char      *pch;
    ushort     w;
    char       szBuf[480];
    char      *pchT;
    short     *pParams;
    short      i;
    short      c;
    short      cOut;
    short      iMineral;

    lVar9 = CONCAT22(unaff_SI, unaff_DI);
    iMineral = -1;
    pParams = pParamsReal;
    pch = (char *)szMsgBuf;
    do {
        if (*pszFormat == '\0') {
            *pch = '\0';
            return (char *)szMsgBuf;
        }
        if (*pszFormat != '\\') {
            *pch = *pszFormat;
            pch = pch + 1;
            goto LAB_1030_8f4d;
        }
        pszFormat = pszFormat + 1;
        uVar6 = (int)*pszFormat - 0x45;
        if (0x35 < uVar6) {
        switchD_1030_8edc_caseD_3:
            *pch = *pszFormat;
            pch = pch + 1;
            goto LAB_1030_8f4d;
        }
        bVar7 = (int)uVar6 < 0;
        psVar2 = (short *)pParams;
        switch (uVar6) {
        case 0:
            pchT = PszCalcEnvVar((uint)*pParams >> 8, *pParams & 0xff);
            break;
        case 1:
            pchT = PszFleetNameFromWord(*pParams);
            break;
        case 2:
            w = *pParams;
            sVar3 = CchGetString(w + idsMineField, pch);
            pch = pch + sVar3;
            pParams = (short *)pParams + 1;
            goto LAB_1030_8f4d;
        default:
            goto switchD_1030_8edc_caseD_3;
        case 4:
            pchT = PszGetCompressedString(*pParams + idsDecreased);
            break;
        case 7:
        case 0x27:
            pchT = PszPlayerName(*pParams & 0xf, (uint)(*pszFormat == 'L'), (uint)((*pParams & 0x10U) != 0), (uint)((*pParams & 0x20U) != 0),
                                 (int)(*pParams & 0xc0U) >> 6, 0);
            break;
        case 8:
            pchT = (char *)*(undefined2 *)(*pParams * 2 + rgszMineField);
            break;
        case 10:
            w = (uint)*pParams >> 9 & 0xf;
            pchT = PszPlayerName(w, 0, 0, 0, 0, 0);
            break;
        case 0xb:
            local_1fe.hs.grhst = *pParams / 100;
            local_1fe.hs.wFlags_0x2 = (int)local_1fe.hs.grhst >> 0xf;
            __aFfcompp();
            if (bVar7) {
                c = _wsprintf(pch, PCTDXPCTDPCTPCT, *pParams / 100, *pParams + (*pParams / 100) * -100);
            } else {
                c = _wsprintf(pch, PCTDPCTPCT, *pParams / 100);
            }
            pch = pch + c;
            pParams = (short *)pParams + 1;
            goto LAB_1030_8f4d;
        case 0xe:
            if (*pParams != idPlayer) {
                CchGetString(idsOf2, szBuf);
                pcVar4 = PszPlayerName(*pParams, 0, 0, 0, 0, 0);
                _strcat(szBuf, pcVar4);
                pcVar4 = PszGetCompressedString(idsOrigin);
                _strcat(szBuf, pcVar4);
                pchT = szBuf;
                break;
            }
            goto MSG_DoNothing;
        case 0x10:
        case 0x11:
        case 0x31:
            local_1fe.hs.grhst = *pParams;
            local_1fe.hs.wFlags_0x2 = 0;
            lVar8 = __aFlshl(lVar9, in_stack_0000fe00);
            local_1fe.u_PART_0x0004.parmor._0_2_ = (ARMOR *)((HullSlotType)lVar8 | local_1fe.hs.grhst);
            local_1fe.u_PART_0x0004._2_2_ = (uint)((ulong)lVar8 >> 0x10) | local_1fe.hs.wFlags_0x2;
            pParams = (short *)pParams + 2;
            sVar3 = _wsprintf(pch, PCTLD, local_1fe.u_PART_0x0004.parmor._0_2_, local_1fe.u_PART_0x0004._2_2_);
            pch = pch + sVar3;
            if (*pszFormat != 'v') {
                if (*pszFormat == 'V') {
                    iMineral = *pParams;
                }
                pcVar4 = (char *)*(undefined2 *)(iMineral * 2 + vrgszUnits);
                _strcpy(pch, pcVar4);
                uVar5 = _strlen(pcVar4);
                pch = pch + uVar5;
            }
            goto LAB_1030_8f4d;
        case 0x13:
            goto MSG_DoNothing;
        case 0x15:
            w = *pParams;
            if (w != 0) {
                if ((w - 1 & w) == 0) {
                    c = 0;
                    for (; (w & 1) == 0; w = w >> 1) {
                        c = c + 1;
                    }
                    pchT = PszPlayerName(c, 0, 1, 1, 0, 0);
                    break;
                }
                cOut = 0;
                for (i = 0; i < game.cPlayer; i = i + 1) {
                    if ((w & 1) != 0) {
                        if (0 < cOut) {
                            if ((w & 0xfffe) == 0) {
                                sVar3 = CchGetString(idsAnd, pch);
                                pch = pch + sVar3;
                            } else {
                                pcVar4 = pch + 1;
                                *pch = ',';
                                pch = pch + 2;
                                *pcVar4 = ' ';
                            }
                        }
                        pcVar4 = PszPlayerName(i, 0, 1, 1, 0, 0);
                        _strcpy(pch, pcVar4);
                        uVar5 = _strlen(pcVar4);
                        pch = pch + uVar5;
                        cOut = cOut + 1;
                    }
                    w = w >> 1;
                }
                goto MSG_DoNothing;
            }
            goto LAB_1030_8f4d;
        case 0x20:
            pchT = (char *)*(undefined2 *)(*pParams * 2 + rgszPlanetAttr);
            break;
        case 0x21:
        case 0x23:
        case 0x2d:
        case 0x2f:
        case 0x34:
            _strcpy(pch, (char *)szBase);
            uVar5 = _strlen((char *)szBase);
            pch = pch + uVar5;
            cVar1 = *pszFormat;
            if (cVar1 == 'f') {
                if (idPlayer == -1) {
                LAB_1030_86a2:
                    if (idPlayer == -1)
                        goto LAB_1030_86d0;
                    c = _wsprintf(pch, ".m%d", idPlayer + 1);
                } else {
                    c = _wsprintf(pch, ".x%d", idPlayer + 1);
                }
                goto MSG_DoInt;
            }
            if (cVar1 == 'h') {
            LAB_1030_86d0:
                _strcat(pch, (char *)0xb5e);
                pch = pch + 4;
            } else {
                if (cVar1 == 'r') {
                    c = _wsprintf(pch, ".h%d", idPlayer + 1);
                    goto MSG_DoInt;
                }
                if (cVar1 == 't')
                    goto LAB_1030_86a2;
                if (cVar1 == 'y') {
                    _strcat(pch, (char *)0xb68);
                    pch = pch + 3;
                }
            }
            goto LAB_1030_8f4d;
        case 0x22:
        MSG_LThingName:
            pchT = PszGetThingName(*pParams);
            break;
        case 0x24:
            c = _wsprintf(pch, PCTD, *pParams);
        MSG_DoInt:
            pch = pch + c;
            pParams = (short *)pParams + 1;
            goto LAB_1030_8f4d;
        case 0x25:
            pchT = PszGetCompressedString(*pParams + idsEnergy);
            break;
        case 0x26:
            local_1fe.hs.grhst = *pParams;
            pParams = (short *)pParams + 1;
            in_stack_0000fe00 = *pParams;
            local_1fe.hs.wFlags_0x2 = local_1fe.hs.wFlags_0x2 & 0xff00 | in_stack_0000fe00 & 0xff;
            FLookupPart(&local_1fe);
            __fstrcpy(pch, (char *)CONCAT22(local_1fe.u_PART_0x0004._2_2_, (local_1fe.u_PART_0x0004.parmor._0_2_)->szName));
            uVar5 = __fstrlen((char *)CONCAT22(local_1fe.u_PART_0x0004._2_2_, (local_1fe.u_PART_0x0004.parmor._0_2_)->szName));
            pch = pch + uVar5;
            pParams = (short *)CONCAT22(pParams._2_2_, psVar2 + 2);
            goto LAB_1030_8f4d;
        case 0x28:
            iMineral = *pParams;
            pchT = (char *)*(undefined2 *)(iMineral * 2 + rgszMinerals);
            break;
        case 0x29:
            if (*pParams == -2) {
                pParams = (short *)pParams + 1;
                goto MSG_LThingName;
            }
            if (*pParams == -1) {
                pParams = (short *)pParams + 1;
                goto switchD_1030_8edc_caseD_2a;
            }
            pchT = PszGetLocName(grobjNone, -1, *pParams, ((short *)pParams)[1]);
            pParams = (short *)pParams + 1;
            break;
        case 0x2a:
        switchD_1030_8edc_caseD_2a:
            if ((*pParams & 0x8000U) != 0)
                goto MSG_DoFleet;
        case 0x2b:
            pchT = PszGetPlanetName(*pParams);
            break;
        case 0x2e:
        MSG_DoFleet:
            w = *pParams | 0x8000;
            pchT = PszGetFleetName(w);
            break;
        case 0x30:
            sVar3 = _wsprintf(pch, s_u_1120_0b6c, *pParams);
            pch = pch + sVar3;
            pParams = (short *)pParams + 1;
            goto LAB_1030_8f4d;
        case 0x32:
            _strcpy(pch, (char *)szWork);
            uVar5 = _strlen((char *)szWork);
            pch = pch + uVar5;
            goto LAB_1030_8f4d;
        case 0x35:
            iPlayer = *pParams >> 5;
            w = *pParams & 0x1f;
            if (w < 0x10) {
                local_1fe.u_PART_0x0004._2_2_ = *(uint *)(iPlayer * 4 + rglpshdef_0x2);
                local_1fe.u_PART_0x0004.parmor._0_2_ = (ARMOR *)(*(int *)(iPlayer * 4 + rglpshdef) + w * 0x93);
            } else {
                local_1fe.u_PART_0x0004._2_2_ = *(uint *)(iPlayer * 4 + rglpshdefSB_0x2);
                local_1fe.u_PART_0x0004.parmor._0_2_ = (ARMOR *)(*(int *)(iPlayer * 4 + rglpshdefSB) + (w - 0x10) * 0x93);
            }
            if (iPlayer == idPlayer) {
                __fstrcpy(pch, (char *)CONCAT22(local_1fe.u_PART_0x0004._2_2_, (local_1fe.u_PART_0x0004.parmor._0_2_)->szName));
            } else {
                pcVar4 = PszPlayerName(iPlayer, 0, 0, 1, 0, 0);
                _wsprintf(pch, "%s %s", pcVar4, 0x1120, (local_1fe.u_PART_0x0004.parmor._0_2_)->szName, local_1fe.u_PART_0x0004._2_2_);
            }
            uVar5 = _strlen(pch);
            pch = pch + uVar5;
            pParams = (short *)pParams + 1;
            goto LAB_1030_8f4d;
        }
        _strcpy(pch, pchT);
        uVar5 = _strlen(pchT);
        pch = pch + uVar5;
    MSG_DoNothing:
        pParams = (short *)pParams + 1;
    LAB_1030_8f4d:
        pszFormat = pszFormat + 1;
    } while (true);
}

// ======================================================================
// Function: MsgDlg
// Address: 1030:8f68
// Segment: MEMORY_MSG
// ======================================================================

/* WARNING: Variable defined which should be unmapped: ps */

short MsgDlg(HWND hwnd, WMType message, ushort wParam, long lParam)

{
    HWND        HVar1;
    short       sVar2;
    char       *sz;
    undefined2  unaff_SI;
    undefined2  unaff_DI;
    undefined2  unaff_SS;
    ulong       uVar3;
    PAINTSTRUCT ps;
    char        szT[256];
    short       cch;
    undefined1  local_16[8];
    HDC         local_e;
    RECT        rc;

    if (message == WM_PAINT) {
        local_e = BeginPaint(hwnd, &ps);
        GetClientRect(hwnd, &rc);
        HVar1 = GetDlgItem(hwnd, IDC_EDITTEXT);
        GetWindowRect(HVar1, local_16);
        ScreenToClient(hwnd, local_16 + 4);
        local_16._0_2_ = 8;
        local_16._4_2_ = rc.right + -8;
        local_16._2_2_ = local_16._6_2_ + 8;
        local_16._6_2_ = local_16._6_2_ + 0x6c;
        SelectObject(local_e, rghfontArial8[1]);
        SetBkColor(local_e, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
        SetTextColor(local_e, 0);
        sVar2 = CchGetString((int)szWork[200] + idsPleaseEnterUniqueEightCharacterSerialNumber, szT);
        DRAWTEXT(local_e, szT, sVar2, local_16, 0x810);
        EndPaint(hwnd, &ps);
        return 1;
    }
    if (message != WM_ERASEBKGND) {
        if (message == WM_CTLCOLOR) {
            uVar3 = __aFulshr(CONCAT22(unaff_SI, unaff_DI), ps.hdc);
            if ((int)uVar3 == 6) {
                SetBkColor(wParam, CONCAT22(crButtonFace._2_2_, (undefined2)crButtonFace));
                return hbrButtonFace;
            }
        } else {
            if (message == WM_INITDIALOG) {
                local_16._6_2_ = -1;
                local_e = 0xffff;
                szWork[0] = '\0';
                SendDlgItemMessage(hwnd, 0x10c, 0x415, 8, 0);
                HVar1 = GetDlgItem(hwnd, IDC_EDITTEXT);
                SetWindowText(HVar1, szWork);
                StickyDlgPos(hwnd, local_16 + 6, 1);
                return 1;
            }
            if (message == WM_COMMAND) {
                if ((wParam == 1) || (wParam == 2)) {
                    if (wParam == 1) {
                        GetDlgItemText(hwnd, IDC_EDITTEXT, szWork, 9);
                        sVar2 = FValidSerialNo((char *)szWork, 0);
                        if (sVar2 == 0) {
                            sVar2 = 0x10;
                            sz = PszFormatIds(idsSerialNumberHaveEnteredValid, 0);
                            AlertSz(sz, sVar2);
                            HVar1 = GetDlgItem(hwnd, IDC_EDITTEXT);
                            SetFocus(HVar1);
                            return 0;
                        }
                    }
                    EndDialog(hwnd, (uint)(wParam == 1));
                    return 1;
                }
                if (wParam == 0x76) {
                    WinHelp(hwnd, szHelpFile, 1, 0xdbc);
                    return 1;
                }
            }
        }
        return 0;
    }
    GetClientRect(hwnd, &rc);
    FillRect(wParam, &rc, hbrButtonFace);
    return 1;
}

// ======================================================================
// Function: PszFormatMessage
// Address: 1030:9220
// Segment: MEMORY_MSG
// ======================================================================

char *PszFormatMessage(short idm, short *pParams)

{
    char *pcVar1;

    pcVar1 = PszGetCompressedMessage(idm);
    pcVar1 = PszFormatString(pcVar1, pParams);
    return pcVar1;
}

// ======================================================================
// Function: PszFormatIds
// Address: 1030:924c
// Segment: MEMORY_MSG
// ======================================================================

char *PszFormatIds(StringId ids, short *pParams)

{
    char *pcVar1;

    pcVar1 = PszGetCompressedString(ids);
    pcVar1 = PszFormatString(pcVar1, pParams);
    return pcVar1;
}

// ======================================================================
// Function: FRemovePlayerMessage
// Address: 1030:9278
// Segment: MEMORY_MSG
// ======================================================================

short FRemovePlayerMessage(short iPlr, MessageId iMsg, short iObj)

{
    byte *pbVar1;
    short cDel;
    byte *lpb;
    byte *lpbMax;

    cDel = 0;
    pbVar1 = (byte *)((int)(short *)lpMsg + imemMsgCur);
    for (lpb = (byte *)CONCAT22(lpMsg._2_2_, (short *)lpMsg); (byte *)lpb < pbVar1;
         lpb = (byte *)CONCAT22(lpb._2_2_, (byte *)lpb + ((int)(uint)*lpb >> 4) + 5)) {
        if ((((*lpb & 0xf) == iPlr) && ((*(MessageId *)((byte *)lpb + 1) &
                                         (idmDueExcessiveFleetManeuveringBattleAreaFleets | idmTipCanHideUnimportantMessagesClickingCheckmark)) == iMsg)) &&
            (*(int *)((byte *)lpb + 3) == iObj)) {
            cDel = cDel + 1;
            *(uint *)((byte *)lpb + 1) = *(uint *)((byte *)lpb + 1) & 0xfe00 | 0x1ff;
        }
    }
    return cDel;
}

// ======================================================================
// Function: FFindPlayerMessage
// Address: 1030:932a
// Segment: MEMORY_MSG
// ======================================================================

short FFindPlayerMessage(short iPlr, short iMsg, short iObj)

{
    byte *lpb;
    byte *lpbMax;

    lpb = (byte *)CONCAT22(lpMsg._2_2_, (short *)lpMsg);
    while (true) {
        if ((byte *)((int)(short *)lpMsg + imemMsgCur) <= (byte *)lpb) {
            return 0;
        }
        if ((((*lpb & 0xf) == iPlr) && ((*(uint *)((byte *)lpb + 1) & 0x1ff) == iMsg)) && (*(int *)((byte *)lpb + 3) == iObj))
            break;
        lpb = (byte *)CONCAT22(lpb._2_2_, (byte *)lpb + ((int)(uint)*lpb >> 4) + 5);
    }
    return 1;
}

// ======================================================================
// Function: MarkPlanetsPlayerLost
// Address: 1030:93c6
// Segment: MEMORY_MSG
// ======================================================================

void MarkPlanetsPlayerLost(short iPlayer)

{
    uint       uVar1;
    byte      *pbVar2;
    undefined2 uVar3;
    PLANET    *lppl_00;
    byte      *lpb;
    ushort     w;
    byte      *lpbT;
    PLANET    *lppl;
    byte      *lpbMax;

    lpb = (byte *)CONCAT22(lpMsg._2_2_, (short *)lpMsg);
    pbVar2 = (byte *)((int)(short *)lpMsg + imemMsgCur);
    do {
        if (pbVar2 <= (byte *)lpb) {
            return;
        }
        uVar3 = (undefined2)((ulong)lpb >> 0x10);
        if ((*lpb & 0xf) == iPlayer) {
            uVar1 = *(uint *)((byte *)lpb + 1) & 0x1ff;
            if (((uVar1 == 7) || (uVar1 == 0x23)) || (uVar1 == 0x40)) {
                w = *(ushort *)((byte *)lpb + 3);
            } else {
                if (uVar1 != 0x8f)
                    goto LAB_1030_95d5;
                lpbT = (byte *)CONCAT22(uVar3, (byte *)lpb + ((*(uint *)((byte *)lpb + 1) >> 9 & 1) == 1) + 6);
                if ((*(uint *)((byte *)lpb + 1) >> 9 & 2) == 0) {
                    w = (ushort)*lpbT;
                } else {
                    w = *lpbT;
                }
            }
            lppl_00 = LpplFromId(w);
            if (lppl_00 != 0) {
                MarkPlanet(lppl_00, iPlayer, 3);
            }
        }
    LAB_1030_95d5:
        lpb = (byte *)CONCAT22(uVar3, (byte *)lpb + ((int)(uint)*lpb >> 4) + 5);
    } while (true);
}

// ======================================================================
// Function: MarkPlayersThatSentMsgs
// Address: 1030:9604
// Segment: MEMORY_MSG
// ======================================================================

void MarkPlayersThatSentMsgs(short iPlayer)

{
    MSGPLR *lpmp;

    if (iPlayer != -1) {
        lpmp = (MSGPLR *)CONCAT22(vlpmsgplrOut._2_2_, (MSGPLR *)vlpmsgplrOut);
        while (true) {
            if (((MSGPLR *)lpmp == 0) && (lpmp._2_2_ == 0))
                break;
            if (((((MSGPLR *)lpmp)->iPlrTo == 0) && (((MSGPLR *)lpmp)->iPlrFrom != iPlayer)) ||
                ((((MSGPLR *)lpmp)->iPlrTo + -1 == iPlayer && ((*(uint *)((int)&rgplr[0].wMdPlr + ((MSGPLR *)lpmp)->iPlrFrom * 0xc0) >> 8 & 1) == 0)))) {
                *(uint *)((int)&rgplr[0].wMdPlr + ((MSGPLR *)lpmp)->iPlrFrom * 0xc0) =
                    *(uint *)((int)&rgplr[0].wMdPlr + ((MSGPLR *)lpmp)->iPlrFrom * 0xc0) & 0xfeff | 0x100;
                *(uint *)((int)&rgplr[0].wMdPlr + ((MSGPLR *)lpmp)->iPlrFrom * 0xc0) =
                    *(uint *)((int)&rgplr[0].wMdPlr + ((MSGPLR *)lpmp)->iPlrFrom * 0xc0) & 0xfff8 | 3;
            }
            /* WARNING: Load size is inaccurate */
            lpmp = (MSGPLR *)CONCAT22(*(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2), lpmp->lpmsgplrNext);
        }
    }
    return;
}

// ======================================================================
// Function: WritePlayerMessages
// Address: 1030:9702
// Segment: MEMORY_MSG
// ======================================================================

/* WARNING: Enum "RecordType": Some values do not have unique names */

void WritePlayerMessages(short iPlayer)

{
    short      sVar1;
    byte      *pbVar2;
    undefined2 uVar3;
    undefined2 unaff_SS;
    MSGPLR    *pMVar4;
    int        iVar5;
    byte      *lpb;
    MSGPLR    *lpmp;
    short      cbMsg;
    byte       rgb[1024];
    byte      *lpbMax;

    cbMsg = 0;
    if (iPlayer != -1) {
        pbVar2 = (byte *)((int)(short *)lpMsg + imemMsgCur);
        for (lpb = (byte *)CONCAT22(lpMsg._2_2_, (short *)lpMsg); (byte *)lpb < pbVar2;
             lpb = (byte *)CONCAT22(uVar3, (byte *)lpb + ((int)(uint)*lpb >> 4) + 5)) {
            if (0x3ff < cbMsg + 0x14) {
                WriteRt(rtMsg, cbMsg, rgb);
                cbMsg = 0;
            }
            uVar3 = (undefined2)((ulong)lpb >> 0x10);
            if (((*lpb & 0xf) == iPlayer) && ((*(uint *)((byte *)lpb + 1) & 0x1ff) != 0x1ff)) {
                __fmemmove(rgb + cbMsg, (byte *)CONCAT22(uVar3, (byte *)lpb + 1), ((int)(uint)*lpb >> 4) + 4);
                cbMsg = cbMsg + ((int)(uint)*lpb >> 4) + 4;
            }
        }
        if (cbMsg != 0) {
            WriteRt(rtMsg, cbMsg, rgb);
        }
        lpmp = (MSGPLR *)CONCAT22(vlpmsgplrOut._2_2_, (MSGPLR *)vlpmsgplrOut);
        while (true) {
            if (((MSGPLR *)lpmp == 0) && (lpmp._2_2_ == 0))
                break;
            if (((((MSGPLR *)lpmp)->iPlrTo == 0) && (((MSGPLR *)lpmp)->iPlrFrom != iPlayer)) || (((MSGPLR *)lpmp)->iPlrTo + -1 == iPlayer)) {
                pMVar4 = (MSGPLR *)lpmp;
                iVar5 = lpmp._2_2_;
                sVar1 = _abs(((MSGPLR *)lpmp)->cLen);
                WriteRt(rtPlrMsg, sVar1 + 0xc, (MSGPLR *)CONCAT22(iVar5, pMVar4));
            }
            /* WARNING: Load size is inaccurate */
            lpmp = (MSGPLR *)CONCAT22(*(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2), lpmp->lpmsgplrNext);
        }
    }
    return;
}

// ======================================================================
// Function: ResetMessages
// Address: 1030:98d6
// Segment: MEMORY_MSG
// ======================================================================

void ResetMessages(void)

{
    imemMsgCur = 0;
    iMsgCur = -1;
    cMsg = 0;
    iMsgSendCur = 0;
    _memset((byte *)bitfMsgSent, 0, 0x31);
    _memset((byte *)bitfMsgFiltered, 0, 0x31);
    vlpmsgplrIn._0_2_ = 0;
    vlpmsgplrIn._2_2_ = 0;
    vlpmsgplrOut._0_2_ = 0;
    vlpmsgplrOut._2_2_ = 0;
    vcmsgplrIn = 0;
    vcmsgplrOut = 0;
    return;
}

// ======================================================================
// Function: ReadPlayerMessages
// Address: 1030:994a
// Segment: MEMORY_MSG
// ======================================================================

void ReadPlayerMessages(void)

{
    MSGPLR *pMVar1;
    bool    bVar2;
    short (*pasVar3)[9];
    short      sVar4;
    byte      *pbVar5;
    undefined2 uVar6;
    void      *pvVar7;
    ushort     u;
    byte      *lpb;
    MSGPLR    *lpmp;
    short      env[9];
    short      i;
    ushort     imemMsgT;
    MSGHDR    *lpmh;
    short (*penvMemSav)[9];
    short fOOM;
    short iMax;
    byte *lpbMax;

    uVar6 = lpMsg._2_2_;
    imemMsgT = 0;
    bVar2 = false;
    lpb._0_2_ = (byte *)((int)(short *)lpMsg + imemMsgCur);
    while ((uint)hdrCur >> 10 == 0xc) {
        if ((((uint)hdrCur & 0x3ff) != 0) && (imemMsgCur + imemMsgT < -((uint)hdrCur & 0x3ff) - 0x38)) {
            __fmemmove((byte *)CONCAT22(uVar6, (byte *)lpb + imemMsgT), rgbCur, (uint)hdrCur & 0x3ff);
            imemMsgT = imemMsgT + ((uint)hdrCur & 0x3ff);
        }
        ReadRt();
    }
    imemMsgCur = imemMsgCur + imemMsgT;
    pbVar5 = (byte *)lpb + imemMsgT;
    while (pasVar3 = penvMem, (byte *)lpb < pbVar5) {
        lpmh = (MSGHDR *)CONCAT22(uVar6, (byte *)lpb);
        ((byte *)bitfMsgSent)[(lpmh->wFlags & 0x1ff) >> 3] =
            ((byte *)bitfMsgSent)[(lpmh->wFlags & 0x1ff) >> 3] & ~(byte)(1 << ((byte)lpmh->wFlags & 7)) | (byte)(1 << ((byte)lpmh->wFlags & 7));
        cMsg = cMsg + 1;
        u = lpmh->wFlags >> 9;
        lpb._0_2_ = (byte *)lpb + 4;
        for (i = 0; i < ((char *)rgcMsgArgs)[lpmh->wFlags & 0x1ff]; i = i + 1) {
            lpb._0_2_ = (byte *)lpb + ((u & 1) == 1) + 1;
            u = u >> 1;
        }
    }
    lpmp = &vlpmsgplrIn;
    while (true) {
        uVar6 = (undefined2)((ulong)lpmp >> 0x10);
        if ((*&lpmp->lpmsgplrNext == 0) && (*(int *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2) == 0))
            break;
        /* WARNING: Load size is inaccurate */
        lpmp = (MSGPLR *)CONCAT22(*(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2), lpmp->lpmsgplrNext);
    }
    penvMem = &env;
    sVar4 = __setjmp(env);
    if (sVar4 == 0)
        goto LAB_1030_9b3a;
    bVar2 = true;
    penvMem = pasVar3;
    while (true) {
        ReadRt();
    LAB_1030_9b3a:
        if ((uint)hdrCur >> 10 != 0x28)
            break;
        if (!bVar2) {
            pvVar7 = LpAlloc((uint)hdrCur & 0x3ff, htPlrMsg);
            uVar6 = (undefined2)((ulong)lpmp >> 0x10);
            *&lpmp->lpmsgplrNext = (void *)pvVar7;
            *(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2) = (int)((ulong)pvVar7 >> 0x10);
            /* WARNING: Load size is inaccurate */
            pMVar1 = lpmp->lpmsgplrNext;
            uVar6 = *(undefined2 *)((int)&((MSGPLR *)lpmp)->lpmsgplrNext + 2);
            lpmp = (MSGPLR *)CONCAT22(uVar6, pMVar1);
            __fmemcpy((MSGPLR *)CONCAT22(uVar6, pMVar1), rgbCur, (uint)hdrCur & 0x3ff);
            *&lpmp->lpmsgplrNext = 0;
            *(undefined2 *)((int)&pMVar1->lpmsgplrNext + 2) = 0;
            vcmsgplrIn = vcmsgplrIn + 1;
        }
    }
    iMsgCur = -1;
    iMsgCur = IMsgNext(0);
    return;
}

// ======================================================================
// Function: FFinishPlrMsgEntry
// Address: 1030:9bd6
// Segment: MEMORY_MSG
// ======================================================================

/* WARNING: Enum "WParamMessageId": Some values do not have unique names */

short FFinishPlrMsgEntry(short dInc)

{
    MSGPLR     *pMVar1;
    int         iVar2;
    short       sVar3;
    MSGPLR     *pMVar4;
    undefined1 *puVar5;
    undefined2  uVar6;
    undefined2  uVar7;
    undefined2  unaff_SS;
    LRESULT     LVar8;
    short       cb;
    MSGPLR     *lpmpPrev;
    MSGPLR     *lpmpCur;
    short       iPlrTo;
    short       cbNew;
    short       i;
    byte       *lpbMsg;

    uVar7 = 0x1030;
    puVar5 = &stack0xffe4;
    lpmpPrev = &vlpmsgplrOut;
    i = iMsgSendCur;
    while (true) {
        sVar3 = i;
        i = i + -1;
        pMVar4 = (MSGPLR *)lpmpPrev;
        uVar6 = (undefined2)((ulong)lpmpPrev >> 0x10);
        if (sVar3 < 1)
            break;
        /* WARNING: Load size is inaccurate */
        lpmpPrev = (MSGPLR *)CONCAT22(*(undefined2 *)((int)&pMVar4->lpmsgplrNext + 2), lpmpPrev->lpmsgplrNext);
    }
    /* WARNING: Load size is inaccurate */
    pMVar1 = lpmpPrev->lpmsgplrNext;
    iVar2 = *(int *)((int)&pMVar4->lpmsgplrNext + 2);
    lpmpCur = (MSGPLR *)CONCAT22(iVar2, pMVar1);
    if (dInc == 1000) {
        cb = 0;
        dInc = 0;
    } else {
        uVar7 = 0x14f8;
        cb = GetWindowText(hwndMsgEdit, (LPSTR)CONCAT22(lpb2k._2_2_, (byte *)lpb2k), 1000);
        puVar5 = &stack0xffdc;
    }
    if (cb == 0) {
        if ((pMVar1 != 0) || (iVar2 != 0)) {
            *(undefined2 *)(puVar5 + -2) = 1;
            *(undefined2 *)(puVar5 + -4) = uVar7;
            *(undefined2 *)(puVar5 + -6) = 0x9c75;
            DirtyGame(*(short *)(puVar5 + -2));
            uVar7 = *(undefined2 *)((int)&pMVar1->lpmsgplrNext + 2);
            *&lpmpPrev->lpmsgplrNext = *&lpmpCur->lpmsgplrNext;
            *(undefined2 *)((int)&pMVar4->lpmsgplrNext + 2) = uVar7;
            *(undefined2 *)(puVar5 + -2) = 8;
            *(int *)(puVar5 + -4) = iVar2;
            *(MSGPLR **)(puVar5 + -6) = pMVar1;
            *(undefined2 *)(puVar5 + -8) = 0x1048;
            *(undefined2 *)(puVar5 + -10) = 0x9c9b;
            FreeLp(*(void **)(puVar5 + -6), *(HeapType *)(puVar5 + -2));
            vcmsgplrOut = vcmsgplrOut + -1;
            if (0 < iMsgSendCur) {
                iMsgSendCur = iMsgSendCur + -1;
            }
        }
        if ((dInc == -1) && (0 < iMsgSendCur)) {
            iMsgSendCur = iMsgSendCur + -1;
        } else if ((dInc == 1) && (iMsgSendCur < vcmsgplrOut)) {
            iMsgSendCur = iMsgSendCur + 1;
        }
        return 0;
    }
    cbNew = cb;
    *(short **)(puVar5 + -2) = &cbNew;
    *(undefined2 *)(puVar5 + -4) = lpb2k._2_2_;
    *(byte **)(puVar5 + -6) = (byte *)lpb2k + 0x400;
    *(undefined2 *)(puVar5 + -8) = lpb2k._2_2_;
    *(byte **)(puVar5 + -10) = (byte *)lpb2k;
    *(undefined2 *)(puVar5 + -0xc) = uVar7;
    *(undefined2 *)(puVar5 + -0xe) = 0x9d13;
    sVar3 = FCompressUserString(*(char **)(puVar5 + -10), *(char **)(puVar5 + -6), *(short **)(puVar5 + -2));
    if (sVar3 == 0) {
        cb = -1 - cb;
        lpbMsg._0_2_ = (byte *)lpb2k;
        lpbMsg._2_2_ = lpb2k._2_2_;
    } else {
        cb = cbNew;
        lpbMsg._0_2_ = (byte *)lpb2k + 0x400;
        lpbMsg._2_2_ = lpb2k._2_2_;
    }
    lpbMsg._2_2_ = lpb2k._2_2_;
    *(short *)(puVar5 + -2) = cb;
    *(undefined2 *)(puVar5 + -4) = 0x1040;
    *(undefined2 *)(puVar5 + -6) = 0x9d5a;
    sVar3 = _abs(*(short *)(puVar5 + -2));
    cbNew = sVar3 + 0xc;
    *(HWND *)(puVar5 + -2) = hwndMsgDrop;
    *(undefined2 *)(puVar5 + -4) = 0x407;
    *(undefined2 *)(puVar5 + -6) = 0;
    *(undefined2 *)(puVar5 + -8) = 0;
    *(undefined2 *)(puVar5 + -10) = 0;
    *(undefined2 *)(puVar5 + -0xc) = 0x1118;
    uVar7 = 0x14f8;
    *(undefined2 *)(puVar5 + -0xe) = 0x9d7c;
    LVar8 = SendMessage(*(HWND *)(puVar5 + -2), *(WMType *)(puVar5 + -4), *(WParamMessageId *)(puVar5 + -6), *(LPARAM *)(puVar5 + -10));
    if ((pMVar1 == 0) && (iVar2 == 0)) {
        *(undefined2 *)(puVar5 + -2) = 1;
        *(undefined2 *)(puVar5 + -4) = 0x14f8;
        *(undefined2 *)(puVar5 + -6) = 0x9e0a;
        DirtyGame(*(short *)(puVar5 + -2));
        *(undefined2 *)(puVar5 + -2) = 8;
        *(short *)(puVar5 + -4) = cbNew;
        *(undefined2 *)(puVar5 + -6) = 0x1048;
        *(undefined2 *)(puVar5 + -8) = 0x9e1a;
        lpmpCur = LpAlloc(*(ushort *)(puVar5 + -4), *(HeapType *)(puVar5 + -2));
        uVar7 = (undefined2)((ulong)lpmpCur >> 0x10);
        *&lpmpCur->lpmsgplrNext = 0;
        *(undefined2 *)((int)&((MSGPLR *)lpmpCur)->lpmsgplrNext + 2) = 0;
        vcmsgplrOut = vcmsgplrOut + 1;
        ((MSGPLR *)lpmpCur)->iInRe = iMsgCur;
        goto LAB_1030_9e40;
    }
    if ((cb == pMVar1->cLen) && (pMVar1->iPlrTo == (int)LVar8)) {
        *(short *)(puVar5 + -2) = cb;
        *(undefined2 *)(puVar5 + -4) = lpbMsg._2_2_;
        *(byte **)(puVar5 + -6) = (byte *)lpbMsg;
        *(int *)(puVar5 + -8) = iVar2;
        *(MSGPLR **)(puVar5 + -10) = pMVar1 + 1;
        *(undefined2 *)(puVar5 + -0xc) = 0x14f8;
        uVar7 = 0x1118;
        *(undefined2 *)(puVar5 + -0xe) = 0x9dcb;
        sVar3 = __fmemcmp(*(void **)(puVar5 + -10), *(void **)(puVar5 + -6), *(ushort *)(puVar5 + -2));
        if (sVar3 != 0)
            goto LAB_1030_9dd6;
    } else {
    LAB_1030_9dd6:
        *(undefined2 *)(puVar5 + -2) = 1;
        *(undefined2 *)(puVar5 + -4) = uVar7;
        uVar7 = 0x1048;
        *(undefined2 *)(puVar5 + -6) = 0x9ddf;
        DirtyGame(*(short *)(puVar5 + -2));
    }
    *(undefined2 *)(puVar5 + -2) = 8;
    *(short *)(puVar5 + -4) = cbNew;
    *(int *)(puVar5 + -6) = iVar2;
    *(MSGPLR **)(puVar5 + -8) = pMVar1;
    *(undefined2 *)(puVar5 + -10) = uVar7;
    *(undefined2 *)(puVar5 + -0xc) = 0x9df5;
    lpmpCur = LpReAlloc(*(void **)(puVar5 + -8), *(ushort *)(puVar5 + -4), *(HeapType *)(puVar5 + -2));
LAB_1030_9e40:
    *&lpmpPrev->lpmsgplrNext = (MSGPLR *)lpmpCur;
    *(undefined2 *)((int)&pMVar4->lpmsgplrNext + 2) = lpmpCur._2_2_;
    ((MSGPLR *)lpmpCur)->iPlrFrom = idPlayer;
    ((MSGPLR *)lpmpCur)->iPlrTo = (int)LVar8;
    ((MSGPLR *)lpmpCur)->cLen = cb;
    *(short *)(puVar5 + -2) = cb;
    *(undefined2 *)(puVar5 + -4) = 0x1060;
    *(undefined2 *)(puVar5 + -6) = 0x9e76;
    sVar3 = _abs(*(short *)(puVar5 + -2));
    *(short *)(puVar5 + -2) = sVar3;
    *(undefined2 *)(puVar5 + -4) = lpbMsg._2_2_;
    *(byte **)(puVar5 + -6) = (byte *)lpbMsg;
    *(undefined2 *)(puVar5 + -8) = lpmpCur._2_2_;
    *(MSGPLR **)(puVar5 + -10) = (MSGPLR *)lpmpCur + 1;
    *(undefined2 *)(puVar5 + -0xc) = 0x1118;
    *(undefined2 *)(puVar5 + -0xe) = 0x9e92;
    __fmemmove(*(void **)(puVar5 + -10), *(void **)(puVar5 + -6), *(ushort *)(puVar5 + -2));
    iMsgSendCur = iMsgSendCur + dInc;
    if (iMsgSendCur < 0) {
        iMsgSendCur = 0;
    }
    return 1;
}

// ======================================================================
// Function: PszGetCompressedMessage
// Address: 1030:9eb8
// Segment: MEMORY_MSG
// ======================================================================

char *PszGetCompressedMessage(MessageId idm)

{
    int   iVar1;
    byte *pbVar2;
    bool  bVar3;
    short iChunk;
    byte *pch;
    short fHigh;
    char *pszOut;
    short iOffset;
    byte *pchLen;
    short iLen;
    short i;
    short iNibble;
    short iBuild;

    iNibble = 0;
    if (idm != (int)iLastMsgGet) {
        pchLen = (byte *)acMSG + ((int)idm >> 6) * 0x40;
        for (i = 0; i < (int)(idm & idmProductionQueueEmpty); i = i + 1) {
            iNibble = iNibble + (uint)*pchLen;
            pchLen = (byte *)pchLen + 1;
        }
        pch = (byte *)(((short *)aiMSGChunkOffset)[(int)idm >> 6] + (iNibble >> 1));
        bVar3 = (iNibble & 1U) == 0;
        pszOut = (char *)szLastMsgGet;
        iBuild = 0;
        iLen = (uint)*pchLen;
        while (pbVar2 = pch, iVar1 = iLen + -1, iLen != 0) {
            if (bVar3) {
                i = (int)(uint)*pch >> 4;
            } else {
                pch = (byte *)pch + 1;
                i = *pbVar2 & 0xf;
            }
            bVar3 = !bVar3;
            iBuild = iBuild + i;
            iLen = iVar1;
            if (i != 0xf) {
                *pszOut = ((char *)rgMSGLookupTable)[iBuild];
                pszOut = pszOut + 1;
                iBuild = 0;
            }
        }
        *pszOut = '\0';
    }
    return (char *)szLastMsgGet;
}

// ======================================================================
// Function: SetFilteringGroups
// Address: 1030:a018
// Segment: MEMORY_MSG
// ======================================================================

void SetFilteringGroups(short idm, short fSet)

{
    byte  bVar1;
    bool  bVar2;
    short i;

    bVar2 = fSet != 0;
    bVar1 = (byte)idm;
    ((byte *)bitfMsgFiltered)[idm >> 3] = ((byte *)bitfMsgFiltered)[idm >> 3] & ~(byte)(1 << (bVar1 & 7)) | bVar2 << (bVar1 & 7);
    if ((idm == 0x35) || (idm == 0x36)) {
        ((byte *)bitfMsgFiltered)[(int)(idm ^ 3U) >> 3] =
            ((byte *)bitfMsgFiltered)[(int)(idm ^ 3U) >> 3] & ~(byte)(1 << ((bVar1 ^ 3) & 7)) | bVar2 << ((bVar1 ^ 3) & 7);
    } else if ((idm == 0x37) || (idm == 0x38)) {
        ((byte *)bitfMsgFiltered)[(int)(idm ^ 0xfU) >> 3] =
            ((byte *)bitfMsgFiltered)[(int)(idm ^ 0xfU) >> 3] & ~(byte)(1 << ((bVar1 ^ 0x37) & 7)) | bVar2 << ((bVar1 ^ 0x37) & 7);
    } else if ((idm == 0x39) || (idm == 0x3a)) {
        ((byte *)bitfMsgFiltered)[(int)(idm ^ 3U) >> 3] =
            ((byte *)bitfMsgFiltered)[(int)(idm ^ 3U) >> 3] & ~(byte)(1 << ((bVar1 ^ 3) & 7)) | bVar2 << ((bVar1 ^ 3) & 7);
    } else if ((idm < 0x2b) || (0x2e < idm)) {
        if ((idm == 0x2f) || (idm == 0x30)) {
            ((byte *)bitfMsgFiltered)[(int)(idm ^ 0x1fU) >> 3] =
                ((byte *)bitfMsgFiltered)[(int)(idm ^ 0x1fU) >> 3] & ~(byte)(1 << ((bVar1 ^ 0x2f) & 7)) | bVar2 << ((bVar1 ^ 0x2f) & 7);
        } else if ((idm == 0x42) || (idm == 0x43)) {
            ((byte *)bitfMsgFiltered)[(int)(idm ^ 1U) >> 3] =
                ((byte *)bitfMsgFiltered)[(int)(idm ^ 1U) >> 3] & ~(byte)(1 << ((bVar1 ^ 1) & 7)) | bVar2 << ((bVar1 ^ 1) & 7);
        } else if ((idm == 0x44) || (idm == 0x45)) {
            ((byte *)bitfMsgFiltered)[(int)(idm ^ 1U) >> 3] =
                ((byte *)bitfMsgFiltered)[(int)(idm ^ 1U) >> 3] & ~(byte)(1 << ((bVar1 ^ 1) & 7)) | bVar2 << ((bVar1 ^ 1) & 7);
        } else if ((idm == 0x46) || (idm == 0x47)) {
            ((byte *)bitfMsgFiltered)[(int)(idm ^ 1U) >> 3] =
                ((byte *)bitfMsgFiltered)[(int)(idm ^ 1U) >> 3] & ~(byte)(1 << ((bVar1 ^ 1) & 7)) | bVar2 << ((bVar1 ^ 1) & 7);
        } else if ((idm == 0x48) || (idm == 0x49)) {
            ((byte *)bitfMsgFiltered)[(int)(idm ^ 1U) >> 3] =
                ((byte *)bitfMsgFiltered)[(int)(idm ^ 1U) >> 3] & ~(byte)(1 << ((bVar1 ^ 0x49) & 7)) | bVar2 << ((bVar1 ^ 0x49) & 7);
        } else if ((idm == 0x4a) || (idm == 0x4b)) {
            ((byte *)bitfMsgFiltered)[(int)(idm ^ 1U) >> 3] =
                ((byte *)bitfMsgFiltered)[(int)(idm ^ 1U) >> 3] & ~(byte)(1 << ((bVar1 ^ 1) & 7)) | bVar2 << ((bVar1 ^ 1) & 7);
        } else if ((idm == 0x4c) || (idm == 0x4d)) {
            ((byte *)bitfMsgFiltered)[(int)(idm ^ 1U) >> 3] =
                ((byte *)bitfMsgFiltered)[(int)(idm ^ 1U) >> 3] & ~(byte)(1 << ((bVar1 ^ 1) & 7)) | bVar2 << ((bVar1 ^ 1) & 7);
        } else if ((idm < 0x60) || (100 < idm)) {
            if ((idm < 0x6a) || (0x6e < idm)) {
                if ((idm == 0x79) || (idm == 0x7a)) {
                    ((byte *)bitfMsgFiltered)[(int)(idm ^ 3U) >> 3] =
                        ((byte *)bitfMsgFiltered)[(int)(idm ^ 3U) >> 3] & ~(byte)(1 << ((bVar1 ^ 3) & 7)) | bVar2 << ((bVar1 ^ 3) & 7);
                } else if ((0x90 < idm) && (idm < 0xa9)) {
                    for (i = 0x91; i < 0xa9; i = i + 1) {
                        ((byte *)bitfMsgFiltered)[i >> 3] = ((byte *)bitfMsgFiltered)[i >> 3] & ~(byte)(1 << ((byte)i & 7)) | bVar2 << ((byte)i & 7);
                    }
                }
            } else {
                for (i = 0x6a; i < 0x6f; i = i + 1) {
                    ((byte *)bitfMsgFiltered)[i >> 3] = ((byte *)bitfMsgFiltered)[i >> 3] & ~(byte)(1 << ((byte)i & 7)) | bVar2 << ((byte)i & 7);
                }
            }
        } else {
            for (i = 0x60; i < 0x65; i = i + 1) {
                ((byte *)bitfMsgFiltered)[i >> 3] = ((byte *)bitfMsgFiltered)[i >> 3] & ~(byte)(1 << ((byte)i & 7)) | bVar2 << ((byte)i & 7);
            }
        }
    } else {
        for (i = 0x2b; i < 0x2f; i = i + 1) {
            ((byte *)bitfMsgFiltered)[i >> 3] = ((byte *)bitfMsgFiltered)[i >> 3] & ~(byte)(1 << ((byte)i & 7)) | bVar2 << ((byte)i & 7);
        }
    }
    return;
}
