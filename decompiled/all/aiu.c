// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: FCreateAiShdef
// Address: 1090:012c
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1090037f) */
/* WARNING: Removing unreachable block (ram,0x1090032c) */
/* WARNING: Type propagation algorithm not settling */

short FCreateAiShdef(short ishdef,short ihul,byte *rgaip)

{
  HUL *pHVar1;
  SHDEF *pSVar2;
  SHDEF *pSVar3;
  ushort grhst;
  short sVar4;
  short sVar5;
  int iVar6;
  uint uVar7;
  undefined2 unaff_SI;
  undefined2 uVar8;
  SHDEF *pSVar9;
  undefined2 unaff_DI;
  SHDEF *pSVar10;
  undefined2 unaff_SS;
  long lVar11;
  uint in_stack_0000ff50;
  SHDEF shdef;
  PART part;
  HUL *lphul;
  short ihs;
  short cItem;
  ulong grbitHull;
  short ids;
  
  lVar11 = CONCAT22(unaff_SI,unaff_DI);
  _memset(&shdef,0,0x93);
  if (ishdef < 0) {
    grhst = 0x400;
  }
  else {
    grhst = 0x4000;
  }
  sVar4 = FLookupPartX(&part,grhst,ihul);
  if (sVar4 == 1) {
    lphul = (HUL *)CONCAT22(part.u_PART_0x0004._2_2_,part.u_PART_0x0004.parmor._0_2_);
    pSVar9 = &shdef;
    uVar8 = part.u_PART_0x0004.parmor._0_2_;
    for (iVar6 = 0x3d; iVar6 != 0; iVar6 = iVar6 + -1) {
      pSVar2 = pSVar9;
      pSVar9 = (SHDEF *)(pSVar9->hul).rgTech;
      pHVar1 = (HUL *)uVar8;
      uVar8 = ((HUL *)uVar8)->rgTech;
      (pSVar2->hul).ihuldef = pHVar1->ihuldef;
    }
    *(char *)&(pSVar9->hul).ihuldef = (char)((HUL *)uVar8)->ihuldef;
    shdef.hul.ihuldef = lphul->ihuldef;
    for (ihs = 0; ihs < (int)(uint)((HUL *)lphul)->chs; ihs = ihs + 1) {
      sVar5 = FGetAIPart((uint)((byte *)rgaip)[ihs],&part);
      sVar4 = ihs;
      if (sVar5 == 0) {
        return 0;
      }
      in_stack_0000ff50 = ((HUL *)lphul)->rghs[ihs].wFlags_0x2 >> 8;
      uVar7 = part.hs.wFlags_0x2 & 0xff | in_stack_0000ff50 << 8;
      part.hs.wFlags_0x2 = uVar7;
      (shdef.hul.rghs + ihs)->grhst = part.hs.grhst;
      shdef.hul.rghs[sVar4].wFlags_0x2 = uVar7;
    }
    shdef.hul.chs = (byte)ihs;
    shdef.wFlags = shdef.wFlags & 0xfdff;
    if (ishdef < 0) {
      pSVar9 = &shdef;
      pSVar10 = (SHDEF *)&shdefBuild;
      for (iVar6 = 0x49; iVar6 != 0; iVar6 = iVar6 + -1) {
        pSVar3 = pSVar10;
        pSVar10 = (SHDEF *)(pSVar10->hul).rgTech;
        pSVar2 = pSVar9;
        pSVar9 = (SHDEF *)(pSVar9->hul).rgTech;
        (pSVar3->hul).ihuldef = (pSVar2->hul).ihuldef;
      }
      *(char *)&(pSVar10->hul).ihuldef = (char)(pSVar9->hul).ihuldef;
      sVar4 = 1;
    }
    else {
      ids = 0;
      grbitHull = __aFlshl(lVar11,in_stack_0000ff50);
      if ((grbitHull & 0x780) == 0) {
        if ((grbitHull & 0x40) == 0) {
          if ((grbitHull & 0x70) == 0) {
            if ((grbitHull & 0xf0000) == 0) {
              if ((grbitHull & 0xf) == 0) {
                if ((grbitHull & 0x1f00000) == 0) {
                  if ((grbitHull & 0x3800) == 0) {
                    if ((grbitHull & 0xc000) == 0) {
                      ids = 0x41a;
                      cItem = 8;
                    }
                    else {
                      ids = 0x402;
                      cItem = 8;
                    }
                  }
                  else {
                    ids = 0x412;
                    cItem = 8;
                  }
                }
                else {
                  ids = 0x3fa;
                  cItem = 8;
                }
              }
              else {
                ids = 0x40a;
                cItem = 8;
              }
            }
            else {
              ids = 0x3ee;
              cItem = 0xc;
            }
          }
          else {
            ids = 0x3d4;
            cItem = 10;
          }
        }
        else {
          ids = 0x422;
          cItem = 0x10;
        }
      }
      else {
        ids = 0x3de;
        cItem = 0x10;
      }
      shdef.wFlags = shdef.wFlags & 0x83ff | (ishdef & 0x1fU) << 10;
      PickANameAndBmp(&shdef,ids,cItem,((HUL *)lphul)->ibmp);
      sVar4 = FChangeAiShdef(&shdef,ishdef);
    }
  }
  else {
    sVar4 = 0;
  }
  return sVar4;
}



// ======================================================================
// Function: FGetAIPart
// Address: 1090:043e
// Segment: MEMORY_AIU
// ======================================================================


short FGetAIPart(short aip,PART *ppart)

{
  short sVar1;
  PART part;
  short cItem;
  short i;
  short iOffset;
  short cTry;
  
  iOffset = 0;
  for (i = 0; i < aip; i = i + 1) {
    iOffset = iOffset + (uint)((byte *)vrgcAiParts)[i];
  }
  cTry = (short)((byte *)vrgcAiParts)[aip];
  do {
    if (cTry < 1) {
      return 0;
    }
    part.hs.grhst = 1 << ((byte)*(undefined2 *)(iOffset * 2) & 0xf);
    part.hs.wFlags_0x2 = *(uint *)(iOffset * 2) >> 4 & 0x1f;
    cItem = *(uint *)(iOffset * 2) >> 9 & 0xf;
    cTry = cTry + -1;
    while (0 < cItem) {
      cItem = cItem + -1;
      sVar1 = FLookupPart(&part);
      if (sVar1 == 1) {
        (ppart->hs).grhst = part.hs.grhst;
        (ppart->hs).wFlags_0x2 = part.hs.wFlags_0x2;
        *(ARMOR **)&(&ppart->u_PART_0x0004)->parmor = part.u_PART_0x0004.parmor._0_2_;
        *(undefined2 *)((int)&ppart->u_PART_0x0004 + 2) = part.u_PART_0x0004._2_2_;
        return 1;
      }
      part.hs.wFlags_0x2 = part.hs.wFlags_0x2 & 0xff00 | part.hs.wFlags_0x2 - 1 & 0xff;
    }
    iOffset = iOffset + 1;
  } while( true );
}



// ======================================================================
// Function: PickANameAndBmp
// Address: 1090:055a
// Segment: MEMORY_AIU
// ======================================================================


void PickANameAndBmp(SHDEF *pshdef,StringId ids,short cids,short ibmpStart)

{
  short sVar1;
  char *pcVar2;
  short ishdef;
  int rgfBmpUsed [4];
  short i;
  
  _memset(rgfBmpUsed,0,8);
  if ((pshdef->wFlags >> 10 & 0x1f) < 0x10) {
    for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
      if (((*(uint *)((int)&rgshdef[0].wFlags + ishdef * 0x93) >> 9 & 1) == 0) &&
         (*(HullDef *)(ishdef * 0x93 + 0x3f00) == (pshdef->hul).ihuldef)) {
        rgfBmpUsed[*(int *)((int)&rgshdef[0].hul + 0x32 + ishdef * 0x93) - ibmpStart] = 1;
      }
    }
  }
  else {
    for (ishdef = 0; ishdef < 10; ishdef = ishdef + 1) {
      if (((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + ishdef * 0x93 + 0x7b) >> 9 & 1) == 0)
         && (*(HullDef *)(*(int *)(idPlayer * 4 + 0x14c) + ishdef * 0x93) ==
             (pshdef->hul).ihuldef)) {
        rgfBmpUsed
        [*(int *)(*(int *)(idPlayer * 4 + 0x14c) + ishdef * 0x93 + 0x32) - ibmpStart] = 1;
      }
    }
  }
  for (i = 0; (i < 4 && (rgfBmpUsed[i] != 0)); i = i + 1) {
  }
  if (i == 4) {
    i = Random(4);
  }
  (pshdef->hul).ibmp = ibmpStart + i;
  i = 0;
  do {
    if (0x13 < i) {
      Random(100);
      sVar1 = Random(cids);
      pcVar2 = PszGetCompressedString(sVar1 + ids);
      _wsprintf((char *)CONCAT22(0x1120,(pshdef->hul).szClass),s__s__d_1120_147d,pcVar2,0x1120);
      return;
    }
    pcVar2 = (pshdef->hul).szClass;
    sVar1 = Random(cids);
    CchGetString(sVar1 + ids,pcVar2);
    if ((pshdef->wFlags >> 10 & 0x1f) < 0x10) {
      ishdef = 0;
      while ((ishdef < 0x10 &&
             (((*(uint *)((int)&rgshdef[0].wFlags + ishdef * 0x93) >> 9 & 1) != 0 ||
              (sVar1 = _strcmp((pshdef->hul).szClass,
                                       (char *)((int)&rgshdef[0].hul + 8 + ishdef * 0x93))
              , sVar1 != 0))))) {
        ishdef = ishdef + 1;
      }
      if (ishdef == 0x10) {
        return;
      }
    }
    else {
      ishdef = 0;
      while ((ishdef < 10 &&
             ((((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + ishdef * 0x93 + 0x7b) >> 9 & 1)
                != 0 || (*(HullDef *)(*(int *)(idPlayer * 4 + 0x14c) + ishdef * 0x93) !=
                         (pshdef->hul).ihuldef)) ||
              (sVar1 = __fstrcmp((char *)CONCAT22(0x1120,(pshdef->hul).szClass),
                                         (char *)CONCAT22(*(undefined2 *)
                                                           (idPlayer * 4 + 0x14e),
                                                          (char *)(*(int *)(idPlayer * 4 +
                                                                           0x14c) + ishdef * 0x93 +
                                                                  8))), sVar1 != 0))))) {
        ishdef = ishdef + 1;
      }
      if (ishdef == 10) {
        return;
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FChangeAiShdef
// Address: 1090:08a2
// Segment: MEMORY_AIU
// ======================================================================


short FChangeAiShdef(SHDEF *pshdef,short ishdef)

{
  uint *puVar1;
  char *pcVar2;
  SHDEF *pSVar3;
  SHDEF *pSVar4;
  HullDef *pHVar5;
  int iVar6;
  SHDEF *pSVar7;
  HullDef *pHVar8;
  undefined2 unaff_SS;
  SHDEF shdef;
  short ishdefWork;
  short iDir;
  int lpshdefBase;
  undefined2 local_6;
  
  pSVar7 = &shdef;
  for (iVar6 = 0x49; iVar6 != 0; iVar6 = iVar6 + -1) {
    pSVar4 = pSVar7;
    pSVar7 = (SHDEF *)(pSVar7->hul).rgTech;
    pSVar3 = pshdef;
    pshdef = (SHDEF *)(pshdef->hul).rgTech;
    (pSVar4->hul).ihuldef = (pSVar3->hul).ihuldef;
  }
  *(char *)&(pSVar7->hul).ihuldef = (char)(pshdef->hul).ihuldef;
  shdef.wFlags = shdef.wFlags & 0x83ff | (ishdef & 0x1fU) << 10;
  shdef.turn = game.turn;
  shdef.cExist._0_2_ = 0;
  shdef.cExist._2_2_ = 0;
  shdef.cBuilt._0_2_ = 0;
  shdef.cBuilt._2_2_ = 0;
  if (ishdef < 0x10) {
    lpshdefBase = *(int *)(idPlayer * 4 + 0xfe);
    local_6 = *(undefined2 *)(idPlayer * 4 + 0x100);
    ishdefWork = ishdef;
  }
  else {
    lpshdefBase = *(int *)(idPlayer * 4 + 0x14c);
    local_6 = *(undefined2 *)(idPlayer * 4 + 0x14e);
    ishdefWork = ishdef + -0x10;
  }
  UpdateShdefCost((SHDEF *)CONCAT22(unaff_SS,&shdef));
  if ((shdef.wFlags >> 9 & 1) == (*(uint *)(lpshdefBase + ishdefWork * 0x93 + 0x7b) >> 9 & 1)) {
    if ((*(uint *)(lpshdefBase + ishdefWork * 0x93 + 0x7b) >> 9 & 1) == 0) {
      *(uint *)(lpshdefBase + ishdefWork * 0x93 + 0x7b) =
           *(uint *)(lpshdefBase + ishdefWork * 0x93 + 0x7b) & 0xfdff | 0x200;
      LogChangeShDef((SHDEF *)CONCAT22(local_6,(SHDEF *)(lpshdefBase + ishdefWork * 0x93)));
    }
  }
  else {
    if ((shdef.wFlags >> 9 & 1) == 0) {
      iDir = 1;
    }
    else {
      iDir = -1;
    }
    if (ishdef < 0x10) {
      pcVar2 = (char *)((int)&rgplr[0].cShDef + idPlayer * 0xc0);
      *pcVar2 = *pcVar2 + (char)iDir;
    }
    else {
      iVar6 = *(int *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0);
      puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0);
      *puVar1 = *puVar1 & 0xfff;
      puVar1 = (uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0);
      *puVar1 = *puVar1 | iDir * 0x1000 + iVar6 & 0xf000U;
    }
  }
  pHVar8 = (HullDef *)(lpshdefBase + ishdefWork * 0x93);
  pSVar7 = &shdef;
  for (iVar6 = 0x49; iVar6 != 0; iVar6 = iVar6 + -1) {
    pHVar5 = pHVar8;
    pHVar8 = pHVar8 + 1;
    pSVar3 = pSVar7;
    pSVar7 = (SHDEF *)(pSVar7->hul).rgTech;
    *pHVar5 = (pSVar3->hul).ihuldef;
  }
  *(char *)pHVar8 = (char)(pSVar7->hul).ihuldef;
  LogChangeShDef((SHDEF *)CONCAT22(unaff_SS,&shdef));
  return 1;
}



// ======================================================================
// Function: XferAiSupply
// Address: 1090:0ad0
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Variable defined which should be unmapped: iT */
/* WARNING: Variable defined which should be unmapped: dChg */
/* WARNING: Removing unreachable block (ram,0x10900b51) */

short XferAiSupply(short grobjSrc,short idSrc,short grobjDst,short idDst,short iSupply,short cQuan)

{
  short sVar1;
  short sVar2;
  int iVar3;
  long lVar4;
  long local_a;
  short iT;
  short dChg;
  
  sVar2 = idSrc;
  sVar1 = grobjSrc;
  if (cQuan == 0) {
    dChg = 0;
  }
  else {
    if (cQuan < 0) {
      grobjSrc = grobjDst;
      grobjDst = sVar1;
      idSrc = idDst;
      idDst = sVar2;
      cQuan = -cQuan;
    }
    lVar4 = ChgCargo(grobjSrc,idSrc,iSupply,0,(void *)0x0);
    if (lVar4 < cQuan) {
      cQuan = (short)lVar4;
    }
    if (cQuan == 0) {
      dChg = 0;
    }
    else {
      local_a = (long)cQuan;
      lVar4 = ChgCargo(grobjDst,idDst,iSupply,local_a,(void *)0x0);
      if ((int)lVar4 == 0) {
        dChg = 0;
      }
      else {
        iVar3 = -(int)lVar4;
        lVar4 = (long)iVar3;
        dChg = 0x1050;
        ChgCargo(iVar3 >> 0xf,0,iSupply,lVar4,(void *)0x0);
      }
    }
  }
  return dChg;
}



// ======================================================================
// Function: XferAiTroopers
// Address: 1090:0bc2
// Segment: MEMORY_AIU
// ======================================================================


short XferAiTroopers(short idSrc,short idDst,short cQuan)

{
  short id;
  int iVar1;
  short sVar2;
  long lVar3;
  
  if (cQuan == 0) {
    sVar2 = 0;
  }
  else {
    lVar3 = ChgCargo(grobjFleet,idSrc,3,0,(void *)0x0);
    iVar1 = (int)((ulong)lVar3 >> 0x10);
    if ((iVar1 <= cQuan >> 0xf) && ((iVar1 < cQuan >> 0xf || ((uint)lVar3 < (uint)cQuan)))) {
      cQuan = (uint)lVar3;
    }
    id = cQuan;
    if (cQuan == 0) {
      sVar2 = 0;
    }
    else {
      ChgCargo(grobjFleet,idSrc,3,(long)-cQuan,(void *)0x0);
      sVar2 = cQuan >> 0xf;
      _idDst = (long)cQuan;
      ChgCargo(grobjPlanet,id,3,_idDst,(void *)0x0);
    }
  }
  return sVar2;
}



// ======================================================================
// Function: FColonizeAiFleet
// Address: 1090:0c78
// Segment: MEMORY_AIU
// ======================================================================


short FColonizeAiFleet(FLEET *lpfl,short idPlanet)

{
  uint uVar1;
  short sVar2;
  ORDER ord;
  
  ChangeMainObjSel(2,lpfl->id);
  _memset(&ord,0,0x12);
  ord.pt.x = ((POINT *)rgptPlan + idPlanet)->x;
  ord.pt.y = *(short *)((int)&rgptPlan[0].y + idPlanet * 4);
  ord.id = idPlanet;
  ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe0f0 | 0x1102;
  uVar1 = IFindIdealWarp(lpfl,1);
  ord.wFlags_0x6 = ord.wFlags_0x6 & 0xff0f | (uVar1 & 0xf) << 4;
  sVar2 = FMoveAiFleet(lpfl,&ord,0);
  if (sVar2 != 0) {
    ((FLEET *)lpfl)->wFlags_0x4 = ((FLEET *)lpfl)->wFlags_0x4 & 0x7fff | 0x8000;
  }
  return (uint)(sVar2 != 0);
}



// ======================================================================
// Function: FGotoWormholeAiFleet
// Address: 1090:0d5c
// Segment: MEMORY_AIU
// ======================================================================


short FGotoWormholeAiFleet(FLEET *lpfl,THING *lpthWorm)

{
  uint uVar1;
  short sVar2;
  undefined2 uVar3;
  ORDER ord;
  
  ChangeMainObjSel(2,lpfl->id);
  _memset(&ord,0,0x12);
  uVar3 = (undefined2)((ulong)lpthWorm >> 0x10);
  ord.pt.x = (&((THING *)lpthWorm)->pt)->x;
  ord.pt.y = (((THING *)lpthWorm)->pt).y;
  ord.id = lpthWorm->idFull;
  ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe0f0 | 0x800;
  uVar1 = IFindIdealWarp(lpfl,1);
  ord.wFlags_0x6 = ord.wFlags_0x6 & 0xff0f | (uVar1 & 0xf) << 4;
  sVar2 = FMoveAiFleet(lpfl,&ord,0);
  if (sVar2 != 0) {
    ((FLEET *)lpfl)->wFlags_0x4 = ((FLEET *)lpfl)->wFlags_0x4 & 0x7fff | 0x8000;
  }
  return (uint)(sVar2 != 0);
}



// ======================================================================
// Function: IdNearestColonizablePlanet
// Address: 1090:0e3e
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109011ef) */
/* WARNING: Removing unreachable block (ram,0x109011a8) */
/* WARNING: Removing unreachable block (ram,0x109011c3) */
/* WARNING: Removing unreachable block (ram,0x10901221) */

short IdNearestColonizablePlanet(FLEET *lpflCol,THING **plpthWorm)

{
  FLEET *pFVar1;
  long d2;
  short sVar2;
  short sVar3;
  int iVar4;
  undefined2 uVar5;
  ulong uVar6;
  ulong uVar7;
  PLANET *pPVar8;
  THING *pTVar9;
  byte *lpb;
  short iVal;
  short i;
  FLEET *lpfl;
  short ifl;
  short idBest;
  PLANET *lppl;
  POINT pt;
  PLANET *lpplMac;
  undefined2 local_6;
  
  if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) ||
     (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 5)) {
    iVal._0_1_ = 0;
  }
  else {
    iVal._0_1_ = 0x10;
    if (fMarkedPlanets != 0) goto AIU_LFindNearest;
  }
  lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,(byte *)vlpbAiPlanet + 0xf);
  for (i = 0; i < game.cPlanMax; i = i + 1) {
    *lpb = (byte)iVal;
    lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 0x10);
  }
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_6 = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < lpplMac) {
    uVar5 = (undefined2)((ulong)lppl >> 0x10);
    if (((PLANET *)lppl)->iPlayer == -1) {
      if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) ||
          (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 5)) ||
         (sVar2 = PctPlanetOptValue(lppl,idPlayer), -1 < sVar2)) {
        iVal._0_1_ = 0;
      }
      else {
        iVal._0_1_ = 8;
      }
    }
    else if (((PLANET *)lppl)->iPlayer == idPlayer) {
      iVal._0_1_ = 1;
    }
    else {
      iVal._0_1_ = 2;
    }
    ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 0xf] = (byte)iVal;
    lppl = (PLANET *)CONCAT22(uVar5,(PLANET *)lppl + 1);
  }
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[ifl];
    iVar4 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    if ((pFVar1 == (FLEET *)0x0) && (iVar4 == 0)) break;
    if ((((pFVar1->iPlayer == idPlayer) &&
         ((1 < pFVar1->cord && (lpflCol != (FLEET *)CONCAT22(iVar4,pFVar1))))) &&
        ((((PLORD *)pFVar1->lpplord + 7)->wFlags >> 8 & 0xf) == 1)) &&
       (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 0 &&
         (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 5)) ||
        ((((PLORD *)pFVar1->lpplord + 7)->wFlags & 0xf) == 2)))) {
      ((byte *)vlpbAiPlanet)[*(int *)&((PLORD *)pFVar1->lpplord)[6].iordMax * 0x10 + 0xf] = 4
      ;
    }
  }
AIU_LFindNearest:
  lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,(byte *)vlpbAiPlanet + 0xf);
  d2 = 99999999;
  pt.x = (&((FLEET *)lpflCol)->pt)->x;
  pt.y = (((FLEET *)lpflCol)->pt).y;
  idBest = -1;
  for (i = 0; i < game.cPlanMax; i = i + 1) {
    if (*lpb == 0) {
      sVar2 = _abs(pt.x - ((POINT *)rgptPlan + i)->x);
      sVar3 = _abs(pt.y - *(int *)((int)&rgptPlan[0].y + i * 4));
      if (((sVar2 < d2) && (sVar3 < d2)) &&
         (uVar6 = __aFulmul((long)sVar2,(long)sVar2), (long)uVar6 < d2)) {
        uVar7 = __aFulmul((long)sVar3,(long)sVar3);
        if ((long)(uVar6 + uVar7) < d2) {
          idBest = i;
          d2 = uVar6 + uVar7;
        }
      }
    }
    lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 0x10);
  }
  fMarkedPlanets = 1;
  if (plpthWorm != (THING **)0x0) {
    *plpthWorm = (THING *)0x0;
    plpthWorm[1] = (THING *)0x0;
    if ((((FLEET *)lpflCol)->idPlanet != -1) && (game.turn < 0x78)) {
      pPVar8 = LpplFromId(((FLEET *)lpflCol)->idPlanet);
      iVar4 = (int)((ulong)pPVar8 >> 0x10);
      if ((((PLANET *)pPVar8 != (PLANET *)0x0) || (iVar4 != 0)) &&
         (((PLANET *)pPVar8)->iPlayer == idPlayer)) {
        pTVar9 = LpthWormFind(&pt,d2);
        *plpthWorm = (THING *)pTVar9;
        plpthWorm[1] = (THING *)((ulong)pTVar9 >> 0x10);
      }
    }
    if ((*plpthWorm != (THING *)0x0) || (plpthWorm[1] != (THING *)0x0)) {
      idBest = -1;
    }
  }
  return idBest;
}



// ======================================================================
// Function: LpthWormFind
// Address: 1090:12e6
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109013bf) */
/* WARNING: Removing unreachable block (ram,0x10901429) */

THING * LpthWormFind(POINT *ppt,long d2)

{
  short sVar1;
  short sVar2;
  uint uVar3;
  byte bVar4;
  THING *pTVar5;
  int iVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  int iVar7;
  long lVar8;
  long lVar9;
  THING *pTVar10;
  short dx;
  short iVal;
  THING *lpthBest;
  int local_14;
  THING *lpth;
  ushort grbitplr;
  uint d2Worm;
  int local_a;
  short dy;
  short pctGood;
  
  lVar9 = CONCAT22(unaff_SI,unaff_DI);
  lpthBest = (THING *)0x0;
  local_14 = 0;
  bVar4 = (byte)idPlayer;
  d2Worm = 0x4240;
  local_a = 0xf;
  pctGood = 0;
  pTVar5 = (THING *)lpThings + cThing;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  pTVar10 = (THING *)lpThings;
  while ((THING *)lpth < pTVar5) {
    iVar7 = (int)((ulong)lpth >> 0x10);
    if (lpth->idFull >> 0xd == 2) {
      sVar1 = _abs(ppt->x - (&((THING *)lpth)->pt)->x);
      sVar2 = _abs(ppt->y - (((THING *)lpth)->pt).y);
      uVar3 = sVar1 * sVar1 + sVar2 * sVar2;
      iVar6 = (int)uVar3 >> 0xf;
      lVar8 = __aFlshl(lVar9,(ushort)pTVar10);
      if (((int)uVar3 <= lVar8) && ((iVar6 < 0 || ((iVar6 < 1 && (uVar3 < 0xb641)))))) {
        if ((*(uint *)((int)&((THING *)lpth)->u_THING_0x0006 + 4) & 1 << (bVar4 & 0x1f)) == 0) {
          if (d2 < (int)uVar3) {
            iVal = 0x32;
          }
          else {
            iVal = 0x5a;
          }
        }
        else {
          sVar1 = PctWormholeMoves(lpth);
          iVal = sVar1 * -10 + 0x46;
        }
        if ((pctGood < iVal) ||
           (((iVal == pctGood && (iVar6 <= local_a)) && ((iVar6 < local_a || (uVar3 < d2Worm)))))) {
          pctGood = iVal;
          lpthBest = (THING *)lpth;
          local_14 = iVar7;
          d2Worm = uVar3;
          local_a = iVar6;
        }
      }
    }
    lpth = (THING *)CONCAT22(iVar7,(THING *)lpth + 1);
  }
  if (((lpthBest == (THING *)0x0) && (local_14 == 0)) ||
     (sVar1 = Random(100), pctGood <= sVar1)) {
    lpthBest = (THING *)0x0;
    local_14 = 0;
  }
  return (THING *)CONCAT22(local_14,lpthBest);
}



// ======================================================================
// Function: UlFleetPower
// Address: 1090:14de
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1090157a) */

ulong UlFleetPower(FLEET *lpfl)

{
  int iVar1;
  undefined2 uVar2;
  ulong uVar3;
  FLEET *pFVar4;
  int iVar5;
  undefined2 uVar6;
  ulong uVar7;
  short ishdef;
  short iplr;
  
  uVar3 = 0;
  uVar6 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar4 = (FLEET *)lpfl;
  iVar1 = pFVar4->iPlayer;
  ishdef = 0;
  do {
    if (0xf < ishdef) {
      return uVar3;
    }
    if (pFVar4->rgcsh[ishdef] != 0) {
      iVar5 = iVar1 * 4;
      uVar2 = *(undefined2 *)(iVar5 + 0x100);
      iVar5 = *(int *)(iVar5 + 0xfe) + ishdef * 0x93;
      uVar7 = __aFulmul(CONCAT22(*(undefined2 *)(iVar5 + 0x89),*(undefined2 *)(iVar5 + 0x87)
                                        ),(long)pFVar4->rgcsh[ishdef]);
      uVar3 = uVar7 + uVar3;
      if ((uVar3 & 0x80000000) != 0) {
        return uVar3;
      }
    }
    ishdef = ishdef + 1;
  } while( true );
}



// ======================================================================
// Function: IdNearestUnknownPlanet
// Address: 1090:15a4
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109016ce) */
/* WARNING: Removing unreachable block (ram,0x10901687) */
/* WARNING: Removing unreachable block (ram,0x109016a2) */
/* WARNING: Removing unreachable block (ram,0x10901700) */

short IdNearestUnknownPlanet(FLEET *lpfl,THING **plpthWorm)

{
  long d2;
  short sVar1;
  short sVar2;
  ulong uVar3;
  ulong uVar4;
  THING *pTVar5;
  byte *lpb;
  short i;
  short idBest;
  POINT pt;
  
  if (fMarkedPlanets == 0) {
    IdNearestColonizablePlanet(lpfl,(THING **)0x0);
  }
  lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,(byte *)vlpbAiPlanet + 0xf);
  d2 = 99999999;
  pt.x = (&((FLEET *)lpfl)->pt)->x;
  pt.y = (((FLEET *)lpfl)->pt).y;
  idBest = -1;
  for (i = 0; i < game.cPlanMax; i = i + 1) {
    if (*lpb == 0x10) {
      sVar2 = _abs(pt.x - ((POINT *)rgptPlan + i)->x);
      sVar1 = _abs(pt.y - *(int *)((int)&rgptPlan[0].y + i * 4));
      if (((sVar2 < d2) && (sVar1 < d2)) &&
         (uVar3 = __aFulmul((long)sVar2,(long)sVar2), (long)uVar3 < d2)) {
        uVar4 = __aFulmul((long)sVar1,(long)sVar1);
        if ((long)(uVar3 + uVar4) < d2) {
          idBest = i;
          d2 = uVar3 + uVar4;
        }
      }
    }
    lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 0x10);
  }
  if (plpthWorm != (THING **)0x0) {
    *plpthWorm = (THING *)0x0;
    plpthWorm[1] = (THING *)0x0;
    if ((((FLEET *)lpfl)->idPlanet != -1) && (sVar2 = Random(100), sVar2 < 5)) {
      pTVar5 = LpthWormFind(&pt,d2);
      *plpthWorm = (THING *)pTVar5;
      plpthWorm[1] = (THING *)((ulong)pTVar5 >> 0x10);
    }
    if ((*plpthWorm != (THING *)0x0) || (plpthWorm[1] != (THING *)0x0)) {
      idBest = -1;
    }
  }
  return idBest;
}



// ======================================================================
// Function: AddMinesToBlockedQueues
// Address: 1090:1792
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10901832) */
/* WARNING: Removing unreachable block (ram,0x109018c2) */
/* WARNING: Removing unreachable block (ram,0x10901974) */
/* WARNING: Removing unreachable block (ram,0x109019cb) */
/* WARNING: Removing unreachable block (ram,0x10901a7c) */
/* WARNING: Removing unreachable block (ram,0x10901ac5) */
/* WARNING: Removing unreachable block (ram,0x10901bf4) */
/* WARNING: Removing unreachable block (ram,0x10901c41) */

void AddMinesToBlockedQueues(void)

{
  byte *pbVar1;
  PLANET *pPVar2;
  int iVar3;
  uint uVar4;
  uint uVar5;
  PLPROD *pPVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar7;
  undefined2 uVar8;
  undefined2 unaff_SS;
  bool bVar9;
  ulong uVar10;
  long lVar11;
  ulong uVar12;
  uint in_stack_0000fec4;
  short etaBetterMines;
  PROD rgprod [64];
  ulong rgCost [3];
  undefined2 local_26;
  undefined2 local_24;
  short ipl;
  uint cRes;
  int local_1e;
  short cResMine;
  int local_1a;
  PLANET *lppl;
  short etaFirst;
  undefined4 cBuild;
  short etaBetterAlchemy;
  int cMaxBuild;
  int local_a;
  PROD prod;
  
  uVar12 = CONCAT22(unaff_SI,unaff_DI);
  ipl = 0;
  do {
    if (vclpplAi <= ipl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pPVar2 = ((PLANET **)vrglpplAi)[ipl];
    iVar3 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
    lppl = (PLANET *)CONCAT22(iVar3,pPVar2);
    if ((pPVar2 == (PLANET *)0x0) && (iVar3 == 0)) {
      return;
    }
    if ((*(int *)&pPVar2->lpplprod != 0) || (*(int *)((int)&pPVar2->lpplprod + 2) != 0)) {
      uVar7 = (undefined2)((ulong)pPVar2->lpplprod >> 0x10);
      pPVar6 = (PLPROD *)pPVar2->lpplprod;
      prod.dwFlags._0_2_ = (pPVar6 + 1)->wFlags;
      prod.dwFlags._2_2_ = *(undefined2 *)&pPVar6[1].iprodMax;
      uVar10 = __aFulshr(uVar12,in_stack_0000fec4);
      if (((uint)uVar10 & 7) == 1) {
        uVar10 = __aFulshr(uVar12,in_stack_0000fec4);
        if (((uint)uVar10 & 0x7f) != 8) {
          uVar10 = __aFulshr(uVar12,in_stack_0000fec4);
          if (((uint)uVar10 & 0x7f) != 3) {
            uVar10 = __aFulshr(uVar12,in_stack_0000fec4);
            if (((uint)uVar10 & 0x7f) != 0xb) {
              uVar10 = __aFulshr(uVar12,in_stack_0000fec4);
              if (((uint)uVar10 & 0x7f) != 0xc) goto LAB_1090_18c8;
            }
          }
        }
      }
      else {
LAB_1090_18c8:
        ChangeMainObjSel(1,lppl->id);
        PszProductionETA
                  (&sel.pl,sel.pl.lpplprod,0,&etaFirst,(short *)0x0);
        if (etaFirst != 1) {
          if (etaFirst == -1) {
            etaFirst = 600;
          }
          GetProductionCosts
                    (lppl,(PROD *)CONCAT22(unaff_SS,&prod),rgCost,idPlayer,1);
          cRes = CResourcesAtPlanet(&sel.pl,idPlayer);
          local_1e = (int)cRes >> 0xf;
          uVar10 = __aFulshr(uVar12,in_stack_0000fec4);
          if ((uVar10 & 1) == 0) {
            uVar8 = 0;
            uVar7 = 100;
            uVar10 = __aFulmul(CONCAT22(local_1e,cRes),
                                       (long)(int)*(char *)((int)&rgplr[0].pctResearch +
                                                           idPlayer * 0xc0));
            lVar11 = __aFldiv(uVar10,CONCAT22(uVar8,uVar7));
            bVar9 = cRes < (uint)lVar11;
            cRes = cRes - (uint)lVar11;
            local_1e = (local_1e - (int)((ulong)lVar11 >> 0x10)) - (uint)bVar9;
          }
          uVar10 = __aFulmul(CONCAT22(local_1e,cRes),(long)(etaFirst + -1));
          if (CONCAT22(local_24,local_26) <= (long)uVar10) {
            uVar10 = __aFulshr(uVar12,in_stack_0000fec4);
            uVar4 = (uint)uVar10 & 0xfff;
            uVar5 = CMaxOperableMines(&sel.pl,idPlayer,1);
            cMaxBuild = uVar5 - uVar4;
            local_a = ((int)uVar5 >> 0xf) - (uint)(uVar5 < uVar4);
            if ((local_a < 1) && (local_a < 0)) {
              cMaxBuild = 0;
              local_a = 0;
            }
            cResMine = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMineBuild);
            local_1a = cResMine >> 0xf;
            uVar10 = __aFulmul((long)cResMine,CONCAT22(local_a,cMaxBuild));
            if (CONCAT22(local_1e,cRes) < (long)uVar10) {
              lVar11 = __aFldiv(CONCAT22(local_1e,cRes),CONCAT22(local_1a,cResMine));
            }
            else {
              lVar11 = CONCAT22(local_a,cMaxBuild);
            }
            cBuild = lVar11;
            InitProduction(rgprod);
            if (cBuild < 1) {
              etaBetterMines = 700;
              AddItemToQueue(3,1,grobjPlanet,0);
              FinishProduction(1);
            }
            else {
              AddItemToQueue(8,(ushort)cBuild,grobjPlanet,0);
              FinishProduction(1);
              PszProductionETA
                        (&sel.pl,sel.pl.lpplprod,1,&etaBetterMines,(short *)0x0)
              ;
              if (etaBetterMines == -1) {
                etaBetterMines = 700;
              }
              uVar8 = (undefined2)((ulong)sel.pl.lpplprod >> 0x10);
              pPVar6 = (PLPROD *)sel.pl.lpplprod;
              uVar7 = *(undefined2 *)&pPVar6[1].iprodMax;
              (pPVar6 + 1)->wFlags = (pPVar6 + 1)->wFlags & 0xfc00 | 1;
              *(undefined2 *)&pPVar6[1].iprodMax = uVar7;
              uVar7 = (undefined2)((ulong)sel.pl.lpplprod >> 0x10);
              pPVar6 = (PLPROD *)sel.pl.lpplprod;
              uVar4 = *(uint *)&pPVar6[1].iprodMax;
              (pPVar6 + 1)->wFlags = (pPVar6 + 1)->wFlags & 0x3ff | 0xc00;
              *(uint *)&pPVar6[1].iprodMax = uVar4 & 0xfffe;
            }
            PszProductionETA
                      (&sel.pl,sel.pl.lpplprod,1,&etaBetterAlchemy,(short *)0x0)
            ;
            if (etaBetterAlchemy == -1) {
              etaBetterAlchemy = 700;
            }
            if (((etaFirst <= etaBetterAlchemy) || (etaBetterMines <= etaBetterAlchemy)) &&
               (0 < cBuild)) {
              uVar7 = (undefined2)((ulong)sel.pl.lpplprod >> 0x10);
              pPVar6 = (PLPROD *)sel.pl.lpplprod;
              uVar4 = *(uint *)&pPVar6[1].iprodMax;
              (pPVar6 + 1)->wFlags = (pPVar6 + 1)->wFlags & 0x3ff | 0x2000;
              *(uint *)&pPVar6[1].iprodMax = uVar4 & 0xfffe;
              if ((etaFirst < etaBetterMines) || (cBuild < 1)) {
                pbVar1 = &((PLPROD *)sel.pl.lpplprod)->iprodMac;
                *pbVar1 = *pbVar1 - 1;
                uVar7 = (undefined2)((ulong)sel.pl.lpplprod >> 0x10);
                pPVar6 = (PLPROD *)sel.pl.lpplprod;
                __fmemmove((PLPROD *)CONCAT22(uVar7,pPVar6 + 1),
                                   (PLPROD *)CONCAT22(uVar7,pPVar6 + 2),(uint)pPVar6->iprodMac << 2)
                ;
              }
              else {
                lVar11 = __aFlshl(uVar12,in_stack_0000fec4);
                uVar7 = (undefined2)((ulong)sel.pl.lpplprod >> 0x10);
                pPVar6 = (PLPROD *)sel.pl.lpplprod;
                uVar4 = *(uint *)&pPVar6[1].iprodMax;
                in_stack_0000fec4 = (pPVar6 + 1)->wFlags & 0xfc00 | (uint)lVar11;
                (pPVar6 + 1)->wFlags = in_stack_0000fec4;
                *(uint *)&pPVar6[1].iprodMax = uVar4 | (uint)((ulong)lVar11 >> 0x10);
              }
            }
          }
        }
      }
    }
    ipl = ipl + 1;
  } while( true );
}



// ======================================================================
// Function: FFleetInField
// Address: 1090:1cf6
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10901d83) */

short FFleetInField(FLEET *lpfl,THING *lpth)

{
  short sVar1;
  short sVar2;
  THING *pTVar3;
  undefined2 uVar4;
  undefined2 uVar5;
  ulong uVar6;
  ulong uVar7;
  short dx;
  short dy;
  
  uVar4 = (undefined2)((ulong)lpfl >> 0x10);
  uVar5 = (undefined2)((ulong)lpth >> 0x10);
  pTVar3 = (THING *)lpth;
  sVar1 = _abs((&((FLEET *)lpfl)->pt)->x - (&pTVar3->pt)->x);
  sVar2 = _abs((((FLEET *)lpfl)->pt).y - (pTVar3->pt).y);
  uVar6 = __aFulmul((long)sVar2,(long)sVar2);
  uVar7 = __aFulmul((long)sVar1,(long)sVar1);
  return (uint)((long)(uVar7 + uVar6) <
               CONCAT22(*(undefined2 *)((int)&pTVar3->u_THING_0x0006 + 2),
                        ((&pTVar3->u_THING_0x0006)->thp).wFlags));
}



// ======================================================================
// Function: SetAiFleetIdealSpeed
// Address: 1090:1d9e
// Segment: MEMORY_AIU
// ======================================================================


void SetAiFleetIdealSpeed(FLEET *lpfl,short wtFuelMax,short cMinefields,THING **rglpth)

{
  char cVar1;
  bool bVar2;
  short sVar3;
  THING *pTVar4;
  FLEET *pFVar5;
  undefined2 uVar6;
  undefined2 uVar7;
  short fMinefield;
  short ith;
  short j;
  short i;
  THING *lpth;
  
  bVar2 = false;
  pFVar5 = (FLEET *)lpfl;
  uVar7 = (undefined2)((ulong)lpfl >> 0x10);
  if (cMinefields != 0) {
    if (cMinefields == -1) {
      pTVar4 = (THING *)lpThings + cThing;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      while ((THING *)lpth < pTVar4) {
        uVar6 = (undefined2)((ulong)lpth >> 0x10);
        if ((((lpth->idFull >> 0xd == 0) && ((lpth->idFull >> 9 & 0xf) != idPlayer)) &&
            (*(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 6) != '\x02')) &&
           (sVar3 = FFleetInField(lpfl,lpth), sVar3 != 0)) {
          bVar2 = true;
          break;
        }
        lpth = (THING *)CONCAT22(uVar6,(THING *)lpth + 1);
      }
    }
    else {
      for (ith = 0; ith < cMinefields; ith = ith + 1) {
        sVar3 = FFleetInField(lpfl,(THING *)CONCAT22((rglpth + ith * 2)[1],rglpth[ith * 2]));
        if (sVar3 != 0) {
          lpth = (THING *)CONCAT22((rglpth + ith * 2)[1],rglpth[ith * 2]);
          bVar2 = true;
          break;
        }
      }
    }
  }
  ChangeMainObjSel(2,lpfl->id);
  if (bVar2) {
    cVar1 = *(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 6);
    if (cVar1 == '\x01') {
      i = 6;
    }
    else if (cVar1 == '\x02') {
      i = 5;
      sVar3 = Random(10);
      if (6 < sVar3) {
        i = 6;
      }
    }
    else {
      i = 4;
      sVar3 = Random(10);
      if (3 < sVar3) {
        i = 5;
      }
    }
    sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (sVar3 == raStealth) {
      i = i + 1;
    }
  }
  else {
    i = IWarpBestForWaypoint
                  (lpfl,(ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar5->lpplord + 2),
                                          (ORDER *)(*(int *)&pFVar5->lpplord + 0x16)));
  }
  if (i != (((PLORD *)pFVar5->lpplord + 7)->wFlags >> 4 & 0xf)) {
    uVar7 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
    ((PLORD *)sel.fl.lpplord + 7)->wFlags =
         ((PLORD *)sel.fl.lpplord + 7)->wFlags & 0xff0f | (i & 0xfU) << 4;
    FLookupFleet(-1,(FLEET *)&sel.fl);
  }
  return;
}



// ======================================================================
// Function: IdTargetAttack
// Address: 1090:1ffe
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10902606) */
/* WARNING: Removing unreachable block (ram,0x10902268) */
/* WARNING: Removing unreachable block (ram,0x10902217) */
/* WARNING: Removing unreachable block (ram,0x1090246d) */
/* WARNING: Removing unreachable block (ram,0x10902757) */

short IdTargetAttack(FLEET *lpfl,FLEET *lpflAtk,FLEET *lpflEnemy,short fOnlyHumans)

{
  short sVar1;
  int iVar2;
  int iVar3;
  undefined2 unaff_SI;
  undefined2 uVar4;
  ulong uVar5;
  ulong uVar6;
  long lVar7;
  undefined2 in_stack_0000ffb2;
  ORDER ord;
  FLEET *lpflAtk2;
  short dx;
  byte *lpb;
  PLANET *lpplClosest;
  short cShipsDst;
  short cShipsAtk;
  short i;
  short idClosest;
  undefined4 lDist;
  PLANET *lppl;
  short dy;
  short pt;
  short local_16;
  PLANET *lpplMac;
  undefined2 local_12;
  undefined4 lDistBest;
  FLEET *lpflT;
  FLEET *lpflClosest;
  
  cShipsDst = 0;
  cShipsAtk = 0;
  i = 0;
  while( true ) {
    if (0xf < i) break;
    cShipsAtk = cShipsAtk + ((FLEET *)lpfl)->rgcsh[i];
    i = i + 1;
  }
  lpflClosest = (FLEET *)0x0;
  lpflT = lpflEnemy;
  lDistBest._0_2_ = 0x4240;
  lDistBest._2_2_ = 0xf;
  pt = (&((FLEET *)lpfl)->pt)->x;
  local_16 = (((FLEET *)lpfl)->pt).y;
  _memset(&ord,0,0x12);
  while( true ) {
    if (((FLEET *)lpflT == (FLEET *)0x0) && (lpflT._2_2_ == 0)) break;
    if ((fOnlyHumans == 0) ||
       ((*(uint *)((int)&rgplr[0].wMdPlr + ((FLEET *)lpflT)->iPlayer * 0xc0) >> 9 & 1) ==
        0)) {
      lpflAtk2 = lpflAtk;
      cShipsDst = 0;
      while( true ) {
        if (lpflAtk2 == (FLEET *)0x0) break;
        if ((((lpfl != lpflAtk2) && (1 < ((FLEET *)lpflAtk2)->cord)) &&
            (*(int *)&((PLORD *)((FLEET *)lpflAtk2)->lpplord)[6].iordMax == lpflT->id)) &&
           ((((PLORD *)((FLEET *)lpflAtk2)->lpplord + 7)->wFlags >> 8 & 0xf) == 2)) {
          for (i = 0; i < 0x10; i = i + 1) {
            cShipsDst = cShipsDst + ((FLEET *)lpflAtk2)->rgcsh[i];
          }
        }
                    /* WARNING: Load size is inaccurate */
        lpflAtk2 = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflAtk2)->lpflNext + 2),
                                     ((FLEET *)lpflAtk2)->lpflNext);
      }
      if (0 < cShipsDst) {
        sVar1 = Random(3);
        if (sVar1 == 0) goto AIU_NextTarg;
      }
      if (cShipsDst * 5 - cShipsAtk != 0 && cShipsAtk <= cShipsDst * 5) {
        sVar1 = Random(0xf);
        if (sVar1 == 0) goto AIU_NextTarg;
      }
      uVar4 = (undefined2)((ulong)lpflT >> 0x10);
      dx = (&((FLEET *)lpflT)->pt)->x - pt;
      dy = (((FLEET *)lpflT)->pt).y - local_16;
      uVar5 = __aFulmul((long)dy,(long)dy);
      in_stack_0000ffb2 = (undefined2)uVar5;
      uVar6 = __aFulmul((long)dx,(long)dx);
      lDist = uVar6 + CONCAT22((int)(uVar5 >> 0x10),in_stack_0000ffb2);
      if (lDist < lDistBest) {
        lpflClosest = lpflT;
        lDistBest = lDist;
      }
    }
AIU_NextTarg:
    uVar4 = (undefined2)((ulong)lpflT >> 0x10);
                    /* WARNING: Load size is inaccurate */
    lpflT = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflT)->lpflNext + 2),
                              ((FLEET *)lpflT)->lpflNext);
  }
  if (lDistBest < 0x7e90) {
    ord.pt.x = (&((FLEET *)lpflClosest)->pt)->x;
    ord.pt.y = (((FLEET *)lpflClosest)->pt).y;
    ord.wFlags_0x6 = ord.wFlags_0x6 & 0xf0ff | 0x200;
    ord.id = lpflClosest->id;
  }
  else {
    if (((FLEET *)lpflClosest == (FLEET *)0x0) && (lpflClosest._2_2_ == 0)) {
      if (fOnlyHumans != 0) {
        sVar1 = IdTargetAttack(lpfl,lpflAtk,lpflEnemy,0);
        return sVar1;
      }
    }
    else {
      lVar7 = LGetFleetStat(lpfl,1);
      lVar7 = __aFldiv(lVar7,CONCAT22(in_stack_0000ffb2,unaff_SI));
      iVar2 = (int)((ulong)lVar7 >> 0x10);
      iVar3 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0x12);
      if ((iVar3 <= iVar2) &&
         ((iVar3 < iVar2 || (*(uint *)(((FLEET *)lpfl)->rgwtMin + 4) < (uint)lVar7)))) {
        sVar1 = FMoveToNearestStarbase(lpfl,0);
        if (sVar1 != 0) {
          return 0;
        }
      }
      uVar4 = (undefined2)((ulong)lpflClosest >> 0x10);
      pt = (&((FLEET *)lpflClosest)->pt)->x;
      local_16 = (((FLEET *)lpflClosest)->pt).y;
      lpplClosest = (PLANET *)0x0;
      lDistBest = 1000000;
      lpplMac = (PLANET *)lpPlanets + cPlanet;
      local_12 = lpPlanets._2_2_;
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      while ((PLANET *)lppl < lpplMac) {
        lpflAtk2 = lpflAtk;
        while( true ) {
          if ((lpflAtk2 == (FLEET *)0x0) ||
             ((((lpfl != lpflAtk2 && (1 < ((FLEET *)lpflAtk2)->cord)) &&
               (*(int *)&((PLORD *)((FLEET *)lpflAtk2)->lpplord)[6].iordMax == lppl->id)) &&
              ((((PLORD *)((FLEET *)lpflAtk2)->lpplord + 7)->wFlags >> 8 & 0xf) == 1)))) break;
                    /* WARNING: Load size is inaccurate */
          lpflAtk2 = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflAtk2)->lpflNext + 2),
                                       ((FLEET *)lpflAtk2)->lpflNext);
        }
        if (lpflAtk2 == (FLEET *)0x0) {
          dx = ((POINT *)rgptPlan + lppl->id)->x - pt;
          dy = *(int *)((int)&rgptPlan[0].y + lppl->id * 4) - local_16;
          uVar5 = __aFulmul((long)dy,(long)dy);
          iVar3 = dx >> 0xf;
          uVar6 = __aFulmul((long)dx,(long)dx);
          lDist = uVar6 + CONCAT22((int)(uVar5 >> 0x10),iVar3);
          if (lDist < lDistBest) {
            lpplClosest = lppl;
            lDistBest = lDist;
          }
        }
        lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
      }
      if ((((PLANET *)lpplClosest != (PLANET *)0x0) || (lpplClosest._2_2_ != 0)) &&
         (lpplClosest->id != ((FLEET *)lpfl)->idPlanet)) {
        ord.pt.x = ((POINT *)rgptPlan + lpplClosest->id)->x;
        ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplClosest->id * 4);
        ord.wFlags_0x6 = ord.wFlags_0x6 & 0xf0ff | 0x100;
        ord.id = lpplClosest->id;
        goto AIU_ThwakSumthin;
      }
    }
    pt = (&((FLEET *)lpfl)->pt)->x;
    local_16 = (((FLEET *)lpfl)->pt).y;
    lpplClosest = (PLANET *)0x0;
    lDistBest = 1000000;
    lpplMac = (PLANET *)lpPlanets + cPlanet;
    local_12 = lpPlanets._2_2_;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    while ((PLANET *)lppl < lpplMac) {
      uVar4 = (undefined2)((ulong)lppl >> 0x10);
      if ((((PLANET *)lppl)->iPlayer != -1) && (((PLANET *)lppl)->iPlayer != idPlayer)) {
        dx = ((POINT *)rgptPlan + lppl->id)->x - pt;
        dy = *(int *)((int)&rgptPlan[0].y + lppl->id * 4) - local_16;
        uVar5 = __aFulmul((long)dy,(long)dy);
        iVar3 = dx >> 0xf;
        uVar6 = __aFulmul((long)dx,(long)dx);
        lDist = uVar6 + CONCAT22((int)(uVar5 >> 0x10),iVar3);
        if (lDist < lDistBest) {
          lpplClosest = lppl;
          lDistBest = lDist;
        }
      }
      lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
    }
    if ((((PLANET *)lpplClosest == (PLANET *)0x0) && (lpplClosest._2_2_ == 0)) ||
       (lpplClosest->id == ((FLEET *)lpfl)->idPlanet)) {
      idClosest = -1;
      lDistBest = 1000000;
      lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,(byte *)vlpbAiPlanet + 9);
      for (i = 0; i < game.cPlanMax; i = i + 1) {
        if (*lpb == 0) {
          dx = ((POINT *)rgptPlan + i)->x - pt;
          dy = *(int *)((int)&rgptPlan[0].y + i * 4) - local_16;
          uVar5 = __aFulmul((long)dy,(long)dy);
          iVar3 = dx >> 0xf;
          uVar6 = __aFulmul((long)dx,(long)dx);
          lDist = uVar6 + CONCAT22((int)(uVar5 >> 0x10),iVar3);
          if (lDist < lDistBest) {
            idClosest = i;
            lDistBest = lDist;
          }
        }
        lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 0x10);
      }
      if (idClosest == -1) {
        ord.id = Random(game.cPlanMax);
        ord.wFlags_0x6 = ord.wFlags_0x6 & 0xf0ff | 0x100;
        ord.pt.x = ((POINT *)rgptPlan + ord.id)->x;
        ord.pt.y = *(short *)((int)&rgptPlan[0].y + ord.id * 4);
      }
      else {
        ord.pt.x = ((POINT *)rgptPlan + idClosest)->x;
        ord.pt.y = *(short *)((int)&rgptPlan[0].y + idClosest * 4);
        ord.wFlags_0x6 = ord.wFlags_0x6 & 0xf0ff | 0x100;
        ord.id = idClosest;
      }
    }
    else {
      ord.pt.x = ((POINT *)rgptPlan + lpplClosest->id)->x;
      ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplClosest->id * 4);
      ord.wFlags_0x6 = ord.wFlags_0x6 & 0xf0ff | 0x100;
      ord.id = lpplClosest->id;
    }
  }
AIU_ThwakSumthin:
  if (((((FLEET *)lpfl)->cord < 2) ||
      ((((PLORD *)((FLEET *)lpfl)->lpplord + 7)->wFlags >> 8 & 0xf) != 1)) ||
     ((ord.wFlags_0x6 >> 8 & 0xf) != 1)) {
    ord.wFlags_0x6 = ord.wFlags_0x6 & 0xef00 | 0x1040;
    sVar1 = FMoveAiFleet(lpfl,&ord,0);
    if (sVar1 == 0) {
      sVar1 = -1;
    }
    else {
      sVar1 = 0;
    }
  }
  else {
    sVar1 = -1;
  }
  return sVar1;
}



// ======================================================================
// Function: IdTargetFreighter
// Address: 1090:286c
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10902f9e) */
/* WARNING: Variable defined which should be unmapped: l */
/* WARNING: Removing unreachable block (ram,0x10902fc3) */
/* WARNING: Removing unreachable block (ram,0x10902fc8) */
/* WARNING: Removing unreachable block (ram,0x10903896) */
/* WARNING: Removing unreachable block (ram,0x1090388d) */
/* WARNING: Removing unreachable block (ram,0x109029d0) */
/* WARNING: Removing unreachable block (ram,0x109029a1) */
/* WARNING: Removing unreachable block (ram,0x10902b0c) */
/* WARNING: Removing unreachable block (ram,0x10902cbd) */
/* WARNING: Removing unreachable block (ram,0x10903112) */
/* WARNING: Removing unreachable block (ram,0x10903249) */
/* WARNING: Removing unreachable block (ram,0x10903209) */

short IdTargetFreighter(FLEET *lpflFr,PLANET *lpplHome)

{
  FLEET *pFVar1;
  double dVar2;
  int iVar3;
  short sVar4;
  int iVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar6;
  long lVar7;
  ulong uVar8;
  long lVar9;
  long lVar10;
  ushort in_stack_0000ff92;
  undefined2 uVar11;
  uint uVar12;
  long l;
  short fSalvage;
  POINT in_stack_0000ff9c;
  short in_stack_0000ffa0;
  ushort in_stack_0000ffa2;
  long lVar13;
  undefined4 in_stack_0000ffa4;
  short fNeedy;
  byte *lpb;
  short dx;
  short pctHere;
  short ishFreighter;
  PLANET *lpplBest;
  short iWorst;
  THING *lpthBest;
  undefined4 wtCargoFree;
  short iWorst2;
  short i;
  short ifl;
  undefined4 wtCargoMax;
  FLEET *lpfl;
  undefined4 wtPlanCargo;
  PLANET *lppl;
  short idBest;
  short pctFull;
  uint lWorst;
  int local_1c;
  short dy;
  int pt;
  int local_16;
  undefined4 score;
  PLANET *lpplMac;
  undefined2 local_e;
  long scoreBest;
  uint lWorst2;
  int local_6;
  
  fSalvage = 0;
  lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,(byte *)vlpbAiPlanet + 0xe);
  for (i = 0; i < game.cPlanMax; i = i + 1) {
    *lpb = 0;
    lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 0x10);
  }
  ishFreighter = 0;
  while( true ) {
    if ((0xf < ishFreighter) || (0 < ((FLEET *)lpflFr)->rgcsh[ishFreighter])) break;
    ishFreighter = ishFreighter + 1;
  }
  lWorst = 0xca00;
  local_1c = 0x3b9a;
  lWorst2 = 0xca00;
  local_6 = 0x3b9a;
  i = 0;
  while( true ) {
    if (2 < i) break;
    uVar12 = *(uint *)((int)(((PLANET *)lpplHome)->rgwtMin + i) + 2);
    if (((int)uVar12 <= local_1c) &&
       (((int)uVar12 < local_1c || (*(uint *)(((PLANET *)lpplHome)->rgwtMin + i) < lWorst)))) {
      lWorst2 = lWorst;
      local_6 = local_1c;
      iWorst2 = iWorst;
      lWorst = *(uint *)(((PLANET *)lpplHome)->rgwtMin + i);
      local_1c = *(int *)((int)(((PLANET *)lpplHome)->rgwtMin + i) + 2);
      iWorst = i;
    }
    i = i + 1;
  }
  lVar7 = __aFlshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff92);
  fNeedy = (short)(CONCAT22(local_1c,lWorst) < lVar7);
  lVar7 = __aFlshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff92);
  if (CONCAT22(local_1c,lWorst) < lVar7) {
    fNeedy = fNeedy + 1;
  }
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[ifl];
    iVar3 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar3,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar3 == 0)) break;
    if ((pFVar1->iPlayer == idPlayer) &&
       ((((1 < pFVar1->cord && (lpflFr != lpfl)) &&
         ((((PLORD *)pFVar1->lpplord + 7)->wFlags >> 8 & 0xf) == 1)) &&
        ((pFVar1->rgcsh[ishFreighter] != 0 &&
         (*(int *)&((PLORD *)pFVar1->lpplord)[6].iordMax != lpplHome->id)))))) {
      ((byte *)vlpbAiPlanet)[*(int *)&((PLORD *)pFVar1->lpplord)[6].iordMax * 0x10 + 0xe] = 1
      ;
    }
  }
  wtCargoMax = LGetFleetStat(lpflFr,2);
  wtCargoFree = GetCargoFree(lpflFr);
  uVar6 = wtCargoMax._2_2_;
  if (wtCargoMax < 1) {
    return -1;
  }
  uVar11 = (undefined2)wtCargoMax;
  uVar8 = __aFulmul(wtCargoFree,100);
  lVar9 = __aFldiv(uVar8,CONCAT22(uVar6,uVar11));
  lVar7 = CONCAT22(in_stack_0000ffa2,in_stack_0000ffa0);
  lVar10 = CONCAT22(score._2_2_,(undefined2)score);
  pctFull = 100 - (int)lVar9;
  scoreBest = 0;
  idBest = -1;
  pt = (&((FLEET *)lpflFr)->pt)->x;
  local_16 = (((FLEET *)lpflFr)->pt).y;
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_e = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while (score = lVar10, (PLANET *)lppl < lpplMac) {
    lVar9 = wtCargoMax;
    if ((lppl->id == ((FLEET *)lpflFr)->idPlanet) ||
       (((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 0xe] != 0)) goto LAB_1090_3272;
    uVar6 = (undefined2)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl)->iPlayer == -1) &&
       ((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] & 0x80) != 0)) {
      iVar3 = pt - ((POINT *)rgptPlan + lppl->id)->x;
      dy = local_16 - *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
      __aFulmul((long)dy,(long)dy);
      iVar5 = iVar3 >> 0xf;
      uVar8 = __aFulmul((long)iVar3,(long)iVar3);
      dVar2 = (double)(long)(uVar8 + CONCAT22(iVar3,iVar5) & 0xffff0000);
      _sqrt(SUB84(dVar2,0),(double)(qword)CONCAT24(0x19,(long)((qword)dVar2 >> 0x20)));
      lVar10 = __ftol((double)CONCAT44(in_stack_0000ffa4,lVar7));
      lVar7 = __aFldiv(lVar10 + 0x18,lVar7);
      if (lVar7 < 1) {
        lVar7 = 1;
      }
      in_stack_0000ff9c =
           (POINT)(long)(int)((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] & 0x7f) * 500);
      fSalvage = 0x1118;
      l._2_2_ = 0x2d09;
      lVar10 = __aFldiv((long)in_stack_0000ff9c,lVar7);
      goto AIU_LScore;
    }
    if (((PLANET *)lppl)->iPlayer != idPlayer) {
      if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 0) ||
          (lpplHome->id != ((FLEET *)lpflFr)->idPlanet)) ||
         (((iVar3 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe), iVar3 < 0 ||
           (((iVar3 < 1 && (*(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) < 0x44d)) ||
            (0x3d < (((PLANET *)lppl)->uGuesses & 0xfff))))) &&
          ((iVar3 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe), iVar3 < 0 ||
           (((iVar3 < 1 && (*(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) < 0x12d)) ||
            (0xe < (((PLANET *)lppl)->uGuesses & 0xfff))))))))) {
        if (((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 3] == 0) ||
            ((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 3] & 0x80) != 0)) ||
           (lpplHome->id != ((FLEET *)lpflFr)->idPlanet)) goto LAB_1090_3272;
        lVar10 = 25000;
        goto LAB_1090_2e39;
      }
      pctHere = 0x41;
AIU_ScorePctHere:
      iVar3 = pt - ((POINT *)rgptPlan + lppl->id)->x;
      dy = local_16 - *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
      __aFulmul((long)dy,(long)dy);
      iVar5 = iVar3 >> 0xf;
      uVar8 = __aFulmul((long)iVar3,(long)iVar3);
      dVar2 = (double)(long)(uVar8 + CONCAT22(iVar3,iVar5) & 0xffff0000);
      _sqrt(SUB84(dVar2,0),(double)(qword)CONCAT24(0x19,(long)((qword)dVar2 >> 0x20)));
      lVar10 = __ftol((double)CONCAT44(in_stack_0000ffa4,lVar7));
      lVar7 = __aFldiv(lVar10 + 0x18,lVar7);
      if (lVar7 < 1) {
        lVar7 = 1;
      }
      in_stack_0000ff9c = (POINT)(long)(pctHere * 100);
      fSalvage = 0x1118;
      l._2_2_ = 0x3230;
      lVar10 = __aFldiv((long)in_stack_0000ff9c,lVar7);
      goto AIU_LScore;
    }
LAB_1090_2e39:
    score = lVar10;
    if (lpplHome == lppl) {
      if (0x22 < pctFull) {
        if (pctFull == 100) {
          lVar10 = 25000;
        }
        else {
          iVar3 = pt - ((POINT *)rgptPlan + lppl->id)->x;
          dy = local_16 - *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
          __aFulmul((long)dy,(long)dy);
          iVar5 = iVar3 >> 0xf;
          uVar8 = __aFulmul((long)iVar3,(long)iVar3);
          dVar2 = (double)(long)(uVar8 + CONCAT22(iVar3,iVar5) & 0xffff0000);
          _sqrt(SUB84(dVar2,0),(double)(qword)CONCAT24(0x19,(long)((qword)dVar2 >> 0x20)));
          lVar10 = __ftol((double)CONCAT44(in_stack_0000ffa4,lVar7));
          in_stack_0000ff9c = (POINT)(lVar10 + 0x18);
          fSalvage = 0x1118;
          lVar13 = lVar7;
          lVar7 = __aFldiv((long)in_stack_0000ff9c,lVar7);
          if (lVar7 == 0) {
            l._2_2_ = 0;
            lVar10 = score;
            lVar9 = wtCargoMax;
            lVar7 = lVar13;
            goto LAB_1090_3272;
          }
          in_stack_0000ff9c = (POINT)(long)(pctFull * 0x14);
          fSalvage = 0x1118;
          l._2_2_ = 0x2f3d;
          lVar10 = __aFldiv((long)in_stack_0000ff9c,lVar7);
        }
AIU_LScore:
        lVar9 = wtCargoMax;
        if (scoreBest < lVar10) {
          lpplBest = lppl;
          idBest = lppl->id;
          scoreBest = lVar10;
        }
      }
    }
    else if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0) {
      if ((*(int *)&((PLANET *)lppl)->lpplprod != 0) ||
         (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) {
        uVar8 = __aFulshr(CONCAT22(fSalvage,l._2_2_),in_stack_0000ff9c.x);
        if (((uint)uVar8 & 7) == 2) {
          uVar8 = __aFulshr(CONCAT22(fSalvage,l._2_2_),in_stack_0000ff9c.x);
          lVar10 = score;
          lVar9 = wtCargoMax;
          if (0xf < ((uint)uVar8 & 0x7f)) goto LAB_1090_3272;
        }
      }
      if (((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] != 0) &&
          ((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] & 0x80) == 0)) &&
         (lpplHome->id == ((FLEET *)lpflFr)->idPlanet)) {
        lVar10 = 25000;
        goto AIU_LScore;
      }
      if (fNeedy == 2) {
        wtPlanCargo = CONCAT22(*(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + iWorst) + 2),
                               (int)((PLANET *)lppl)->rgwtMin[iWorst]);
        lVar10 = score;
        lVar9 = wtCargoMax;
      }
      else {
        wtPlanCargo = 0;
        for (i = 0; lVar10 = score, lVar9 = wtCargoMax, i < 3; i = i + 1) {
          if ((fNeedy == 0) || (i == iWorst)) {
            wtPlanCargo = wtPlanCargo +
                          CONCAT22(*(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2),
                                   (int)((PLANET *)lppl)->rgwtMin[i]);
          }
          else {
            lVar10 = __aFlshr(CONCAT22(fSalvage,l._2_2_),in_stack_0000ff9c.x);
            wtPlanCargo = lVar10 + wtPlanCargo;
          }
        }
      }
      wtCargoMax._2_2_ = (undefined2)((ulong)lVar9 >> 0x10);
      uVar6 = wtCargoMax._2_2_;
      wtCargoMax._0_2_ = (undefined2)lVar9;
      if (9 < (long)wtPlanCargo) {
        uVar11 = (undefined2)wtCargoMax;
        score = lVar10;
        wtCargoMax = lVar9;
        uVar8 = __aFulmul(wtPlanCargo,100);
        lVar10 = __aFldiv(uVar8,CONCAT22(uVar6,uVar11));
        pctHere = (short)lVar10;
        if (100 - pctFull < pctHere) {
          pctHere = 100 - pctFull;
        }
        goto AIU_ScorePctHere;
      }
    }
LAB_1090_3272:
    wtCargoMax = lVar9;
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  lpthBest = (THING *)0x0;
  sVar4 = FSalvageTargetFreighter2
                    (lpflFr,fNeedy,iWorst,pctFull,wtCargoMax,scoreBest,&lpthBest,&idBest);
  if (sVar4 != 0) {
    lVar7 = GetCargoFree(lpflFr);
    if (lVar7 == 0) {
      lpthBest = (THING *)0x0;
      lpplBest = lpplHome;
      idBest = lpplHome->id;
    }
  }
  if (idBest == -1) {
    return -1;
  }
  _memset(&stack0xff9c,0,0x12);
  i = 0;
  while( true ) {
    if (2 < i) break;
    if ((((THING *)lpthBest == (THING *)0x0) && (lpthBest._2_2_ == 0)) && (idBest == lpplHome->id))
    {
      iVar3 = 2;
    }
    else {
      iVar3 = 1;
    }
    *(uint *)(&stack0xffa4 + i * 2) = *(uint *)(&stack0xffa4 + i * 2) & 0xfff | iVar3 << 0xc;
    i = i + 1;
  }
  uVar8 = wtCargoFree;
  if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 1) {
    if (lpplHome->id == ((FLEET *)lpflFr)->idPlanet) {
      ChangeMainObjSel(2,lpflFr->id);
      iVar3 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
      if ((((-1 < iVar3) && ((0 < iVar3 || (0x4b0 < *(uint *)(((PLANET *)lpplHome)->rgwtMin + 3)))))
          && ((THING *)lpthBest == (THING *)0x0)) &&
         ((lpthBest._2_2_ == 0 && (((PLANET *)lpplBest)->iPlayer != -1)))) {
        iVar3 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
        iVar5 = *(int *)((int)((PLANET *)lpplBest)->rgwtMin + 0xe);
        if ((iVar5 <= iVar3) &&
           ((iVar5 < iVar3 ||
            (*(uint *)(((PLANET *)lpplBest)->rgwtMin + 3) <
             *(uint *)(((PLANET *)lpplHome)->rgwtMin + 3))))) {
          XferAiSupply(1,((FLEET *)lpflFr)->idPlanet,2,lpflFr->id,3,1000);
        }
      }
      FLookupFleet(lpflFr->id,(FLEET *)&sel.fl);
      uVar8 = wtCargoFree;
    }
  }
  else if ((((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) &&
            (lpplHome->id == ((FLEET *)lpflFr)->idPlanet)) && ((THING *)lpthBest == (THING *)0x0))
          && ((lpthBest._2_2_ == 0 && (((PLANET *)lpplBest)->iPlayer != -1)))) {
    if (((PLANET *)lpplBest)->iPlayer == idPlayer) {
      iVar3 = *(int *)((int)((PLANET *)lpplBest)->rgwtMin + 0xe);
      if ((iVar3 < 1) && ((iVar3 < 0 || (*(uint *)(((PLANET *)lpplBest)->rgwtMin + 3) < 1000)))) {
        uVar12 = 2;
        uVar8 = __aFulmul(CONCAT22(*(undefined2 *)((int)((PLANET *)lpplBest)->rgwtMin + 0xe)
                                           ,(int)((PLANET *)lpplBest)->rgwtMin[3]),3);
        lVar7 = __aFldiv(uVar8,(ulong)uVar12);
        iVar5 = (int)((ulong)lVar7 >> 0x10);
        iVar3 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
        uVar8 = wtCargoFree;
        if (((iVar5 <= iVar3) &&
            (((iVar5 < iVar3 || ((uint)lVar7 < *(uint *)(((PLANET *)lpplHome)->rgwtMin + 3))) &&
             (iVar3 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe), -1 < iVar3)))) &&
           ((0 < iVar3 || (500 < *(uint *)(((PLANET *)lpplHome)->rgwtMin + 3))))) {
          iVar3 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
          if ((iVar3 < 0) || ((iVar3 < 1 && (*(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) < 0x7d1)))
             ) {
            iVar3 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
            if ((iVar3 < 0) ||
               ((iVar3 < 1 && (*(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) < 0x5dd)))) {
              iVar3 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
              if ((iVar3 < 0) ||
                 ((iVar3 < 1 && (*(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) < 0x3e9)))) {
                lVar7 = __aFldiv(CONCAT22(*(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe)
                                                  + -1 + (uint)(399 < *(uint *)(((PLANET *)lpplHome)
                                                                                ->rgwtMin + 3)),
                                                  *(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) - 400
                                                 ),100);
                l._2_2_ = (uint)((ulong)lVar7 >> 0x10);
              }
              else {
                l._2_2_ = 0;
              }
            }
            else {
              l._2_2_ = 0;
            }
          }
          else {
            l._2_2_ = 0;
          }
          uVar12 = 100;
          uVar8 = __aFulmul(CONCAT22(*(undefined2 *)
                                              ((int)((PLANET *)lpplHome)->rgwtMin + 0xe),
                                             (int)((PLANET *)lpplHome)->rgwtMin[3]),
                                    (ulong)l._2_2_ << 0x10);
          __aFldiv(uVar8,(ulong)uVar12);
          sVar4 = lpflFr->id;
          ChangeMainObjSel(2,sVar4);
          XferAiSupply(1,((FLEET *)lpflFr)->idPlanet,2,lpflFr->id,3,sVar4);
          FLookupFleet(lpflFr->id,(FLEET *)&sel.fl);
          uVar8 = wtCargoFree;
        }
      }
    }
    else {
      ChangeMainObjSel(2,lpflFr->id);
      iVar3 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
      if ((iVar3 < 0) || ((iVar3 < 1 && (*(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) < 0x385)))) {
        XferAiSupply(1,((FLEET *)lpflFr)->idPlanet,2,lpflFr->id,3,100);
      }
      else {
        XferAiSupply(1,((FLEET *)lpflFr)->idPlanet,2,lpflFr->id,3,300);
      }
      FLookupFleet(lpflFr->id,(FLEET *)&sel.fl);
      uVar8 = wtCargoFree;
    }
  }
  wtCargoFree._2_2_ = (int)(uVar8 >> 0x10);
  wtCargoFree._0_2_ = (uint)uVar8;
  if (((((THING *)lpthBest == (THING *)0x0) && (lpthBest._2_2_ == 0)) && (lpplHome->id != idBest))
     && (fNeedy != 0)) {
    if (fNeedy != 2) {
      uVar12 = *(uint *)((int)(((PLANET *)lpplBest)->rgwtMin + iWorst) + 2);
      if (((int)uVar12 < wtCargoFree._2_2_) ||
         (((int)uVar12 <= wtCargoFree._2_2_ &&
          (*(uint *)(((PLANET *)lpplBest)->rgwtMin + iWorst) < (uint)wtCargoFree)))) {
        if (((PLANET *)lpplBest)->iPlayer != -1) {
          for (i = 0; i < 3; i = i + 1) {
            wtCargoFree = uVar8;
            *(uint *)(&stack0xffa4 + i * 2) = *(uint *)(&stack0xffa4 + i * 2) & 0xfff | 0x5000;
            if (i == iWorst) {
              l._0_2_ = 0x42;
            }
            else {
              l._0_2_ = 0x21;
            }
            *(uint *)(&stack0xffa4 + i * 2) = *(uint *)(&stack0xffa4 + i * 2) & 0xf000 | (uint)l;
            uVar8 = wtCargoFree;
          }
        }
        goto LAB_1090_392a;
      }
    }
    for (i = 0; i < 3; i = i + 1) {
      if (i != iWorst) {
        wtCargoFree = uVar8;
        *(uint *)(&stack0xffa4 + i * 2) = *(uint *)(&stack0xffa4 + i * 2) & 0xfff;
        uVar8 = wtCargoFree;
      }
    }
  }
LAB_1090_392a:
  wtCargoFree = uVar8;
  sVar4 = FMoveAiFleet(lpflFr,(ORDER *)&stack0xff9c,0);
  if (sVar4 == 0) {
    idBest = -1;
  }
  return idBest;
}



// ======================================================================
// Function: FSalvageTargetFreighter2
// Address: 1090:395a
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Variable defined which should be unmapped: l */
/* WARNING: Removing unreachable block (ram,0x10903c7f) */
/* WARNING: Removing unreachable block (ram,0x10903cbf) */

short FSalvageTargetFreighter2
          (FLEET *lpflFr,short fNeedy,short iWorst,short pctFull,long wtCargoMax,long scoreBest,
          THING **plpthBest,short *pidBest)

{
  int iVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  int iVar5;
  uint uVar6;
  THING *pTVar7;
  undefined2 uVar8;
  undefined2 uVar9;
  THING *pTVar10;
  ulong uVar11;
  long lVar12;
  long lVar13;
  long l;
  short fSalvage;
  short dx;
  short pctHere;
  THING *lpth;
  uint wtPlanCargo;
  int local_12;
  short i;
  short dy;
  
  fSalvage = 0;
  uVar9 = (undefined2)((ulong)lpflFr >> 0x10);
  iVar1 = (&((FLEET *)lpflFr)->pt)->x;
  iVar2 = (((FLEET *)lpflFr)->pt).y;
  pTVar7 = (THING *)lpThings + cThing;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < pTVar7) {
    pTVar10 = (THING *)((ulong)lpth >> 0x10);
    if ((lpth->idFull >> 0xd == 1) &&
       ((((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags >> 10 & 0xf) == 0)) {
      iVar3 = iVar1 - (&((THING *)lpth)->pt)->x;
      iVar4 = iVar2 - (((THING *)lpth)->pt).y;
      if ((iVar3 == 0) && (iVar4 == 0)) {
        if ((fNeedy != 0) && (*(int *)((((THING *)lpth)->u_THING_0x0006).rgb + iWorst * 2 + 2) != 0)
           ) {
          XferAiSupply(8,lpth->idFull,2,lpflFr->id,iWorst,
                       *(short *)((((THING *)lpth)->u_THING_0x0006).rgb + iWorst * 2 + 2));
        }
        if (fNeedy != 2) {
          for (i = 0; i < 3; i = i + 1) {
            if (*(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) != 0) {
              XferAiSupply(8,lpth->idFull,2,lpflFr->id,i,
                           *(short *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2));
            }
          }
        }
        fSalvage = 1;
        FLookupFleet(lpflFr->id,(FLEET *)&sel.fl);
      }
      else {
        iVar5 = iVar3;
        if (iVar3 <= iVar4) {
          iVar5 = iVar4;
        }
        if (iVar5 < 0xc9) {
          if (fNeedy == 2) {
            wtPlanCargo = *(uint *)((((THING *)lpth)->u_THING_0x0006).rgb + iWorst * 2 + 2);
            local_12 = (int)wtPlanCargo >> 0xf;
          }
          else {
            wtPlanCargo = 0;
            local_12 = 0;
            for (i = 0; i < 3; i = i + 1) {
              if ((fNeedy == 0) || (i == iWorst)) {
                uVar6 = *(uint *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2);
                local_12 = local_12 + ((int)uVar6 >> 0xf) + (uint)CARRY2(wtPlanCargo,uVar6);
              }
              else {
                uVar6 = *(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) >> 1;
                local_12 = local_12 +
                           (*(int *)((((THING *)lpth)->u_THING_0x0006).rgb + i * 2 + 2) >> 0xf) +
                           (uint)CARRY2(wtPlanCargo,uVar6);
              }
              wtPlanCargo = wtPlanCargo + uVar6;
            }
          }
          if ((0 < local_12) || ((-1 < local_12 && (9 < wtPlanCargo)))) {
            lVar12 = wtCargoMax;
            uVar11 = __aFulmul(CONCAT22(local_12,wtPlanCargo),100);
            lVar12 = __aFldiv(uVar11,lVar12);
            pctHere = (short)lVar12;
            if (100 - pctFull < pctHere) {
              pctHere = 100 - pctFull;
            }
            uVar11 = __aFulmul((long)iVar4,(long)iVar4);
            uVar8 = (undefined2)(uVar11 >> 0x10);
            uVar9 = (undefined2)uVar11;
            uVar11 = __aFulmul((long)iVar3,(long)iVar3);
            lVar12 = uVar11 + CONCAT22(uVar8,uVar9);
            _sqrt(SUB84((double)lVar12,0),
                          (double)(qword)CONCAT24(0x19,(long)((qword)(double)lVar12 >> 0x20)));
            lVar13 = __ftol((double)CONCAT26(pTVar7,CONCAT24(fSalvage,lVar12)));
            lVar12 = __aFldiv(lVar13 + 0x18,lVar12);
            if (lVar12 < 1) {
              lVar12 = 1;
            }
            lVar12 = __aFldiv((long)(pctHere * 100),lVar12);
            if (scoreBest < lVar12) {
              *plpthBest = (THING *)lpth;
              plpthBest[1] = pTVar10;
              *pidBest = lpth->idFull;
              scoreBest = lVar12;
            }
          }
        }
      }
    }
    lpth = (THING *)CONCAT22(pTVar10,(THING *)lpth + 1);
  }
  return fSalvage;
}



// ======================================================================
// Function: FMoveAiFleet
// Address: 1090:3d0a
// Segment: MEMORY_AIU
// ======================================================================


short FMoveAiFleet(FLEET *lpfl,ORDER *pord,short fAppend)

{
  ORDER *pOVar1;
  short *psVar2;
  undefined2 uVar3;
  short sVar4;
  int iVar5;
  short *psVar6;
  short iord;
  
  ChangeMainObjSel(2,lpfl->id);
  if ((uint)((PLORD *)sel.fl.lpplord)->iordMax == sel.fl.cord) {
    sel.fl.lpplord =
         (PLORD *)LpplReAlloc((PL *)sel.fl.lpplord,sel.fl.cord + 1);
  }
  if (fAppend == 0) {
    iord = 0;
  }
  else {
    iord = sel.fl.cord + -1;
  }
  if (((pord->pt).x == *(int *)((int)(PLORD *)sel.fl.lpplord + iord * 0x12 + 4)) &&
     ((pord->pt).y == *(int *)((int)(PLORD *)sel.fl.lpplord + iord * 0x12 + 6))) {
    if (1 < sel.fl.cord) {
      sel.fl.cord = 1;
      FLookupFleet(-1,(FLEET *)&sel.fl);
    }
  }
  else {
    iord = iord + 1;
  }
  uVar3 = sel.fl.lpplord._2_2_;
  psVar6 = (short *)((int)(PLORD *)sel.fl.lpplord + iord * 0x12 + 4);
  for (iVar5 = 9; iVar5 != 0; iVar5 = iVar5 + -1) {
    psVar2 = psVar6;
    psVar6 = psVar6 + 1;
    pOVar1 = pord;
    pord = (ORDER *)&(pord->pt).y;
    *psVar2 = (pOVar1->pt).x;
  }
  sel.fl.cord = iord + 1;
  ((PLORD *)sel.fl.lpplord)->iordMac = (byte)sel.fl.cord;
  sVar4 = FLookupFleet(-1,(FLEET *)&sel.fl);
  return sVar4;
}



// ======================================================================
// Function: AddItemToQueue
// Address: 1090:3e50
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10903ee7) */
/* WARNING: Removing unreachable block (ram,0x10903f1b) */

void AddItemToQueue(ushort iItem,ushort cItem,GrobjClass grobj,short mdAddItem)

{
  byte *pbVar1;
  uint uVar2;
  bool bVar3;
  PLPROD *pPVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  ulong uVar6;
  long lVar7;
  ushort in_stack_0000fef4;
  PROD in_stack_0000fef6;
  ushort in_stack_0000fefa;
  short i;
  short iprod;
  short fSingle;
  
  bVar3 = false;
  if ((sel.pl.lpplprod != (PLPROD *)0x0) &&
     (200 < ((PLPROD *)sel.pl.lpplprod)->iprodMac)) {
    return;
  }
  if (((PLPROD *)lpplProdGlob == (PLPROD *)0x0) && (lpplProdGlob._2_2_ == 0)) {
    bVar3 = true;
    InitProduction((PROD *)&stack0xfef6);
    i = 0;
    while ((i < cProdGlob &&
           ((uVar6 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000fef4),
            ((uint)uVar6 & 0x7f) != iItem ||
            (uVar6 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000fef4),
            ((GrobjClass)uVar6 & (grobjOther|grobjFleet|grobjPlanet)) != grobj))))) {
      i = i + 1;
    }
    if (i < cProdGlob) {
      if ((*(uint *)(&stack0xfef6 + i * 4) & 0x3ff) <= cItem) {
        cItem = *(uint *)(&stack0xfef6 + i * 4) & 0x3ff;
      }
    }
    else {
      cItem = 0;
    }
  }
  if (cItem == 0) goto LAB_1090_4230;
  if (mdAddItem != 2) {
    uVar5 = (undefined2)((ulong)lpplProdGlob >> 0x10);
    pPVar4 = (PLPROD *)lpplProdGlob;
    if (pPVar4->iprodMac == pPVar4->iprodMax) {
      lpplProdGlob =
           (PLPROD *)LpplReAlloc((PL *)lpplProdGlob,pPVar4->iprodMac + 3);
    }
  }
  pPVar4 = (PLPROD *)lpplProdGlob;
  uVar5 = (undefined2)((ulong)lpplProdGlob >> 0x10);
  if (mdAddItem == 0) {
    iprod = 0;
    __fmemmove((PLPROD *)CONCAT22(uVar5,pPVar4 + 2),(PLPROD *)CONCAT22(uVar5,pPVar4 + 1),
                       (uint)pPVar4->iprodMac << 2);
    __fmemset((PLPROD *)
                      CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob + 1),0,4);
  }
  else {
    if (mdAddItem != 1) {
      if (mdAddItem != 2) goto LAB_1090_407b;
      pPVar4->iprodMac = 0;
    }
    iprod = (short)((PLPROD *)lpplProdGlob)->iprodMac;
  }
LAB_1090_407b:
  lVar7 = __aFlshl(in_stack_0000fef6.dwFlags,in_stack_0000fefa);
  uVar5 = lpplProdGlob._2_2_;
  uVar2 = *(uint *)&((PLPROD *)lpplProdGlob)[iprod + 1].iprodMax;
  pPVar4 = (PLPROD *)lpplProdGlob + iprod + 1;
  pPVar4->wFlags = ((PLPROD *)lpplProdGlob + iprod + 1)->wFlags & 0xfc00 | (uint)lVar7;
  *(uint *)&pPVar4->iprodMax = uVar2 | (uint)((ulong)lVar7 >> 0x10);
  lVar7 = __aFlshl(in_stack_0000fef6.dwFlags,in_stack_0000fefa);
  uVar5 = lpplProdGlob._2_2_;
  uVar2 = *(uint *)&((PLPROD *)lpplProdGlob)[iprod + 1].iprodMax;
  pPVar4 = (PLPROD *)lpplProdGlob + iprod + 1;
  pPVar4->wFlags = ((PLPROD *)lpplProdGlob + iprod + 1)->wFlags & 0x3ff | (uint)lVar7;
  *(uint *)&pPVar4->iprodMax = uVar2 & 0xfffe | (uint)((ulong)lVar7 >> 0x10);
  lVar7 = __aFlshl(in_stack_0000fef6.dwFlags,in_stack_0000fefa);
  uVar5 = lpplProdGlob._2_2_;
  uVar2 = *(uint *)&((PLPROD *)lpplProdGlob)[iprod + 1].iprodMax;
  pPVar4 = (PLPROD *)lpplProdGlob + iprod + 1;
  pPVar4->wFlags = ((PLPROD *)lpplProdGlob + iprod + 1)->wFlags | (uint)lVar7;
  *(uint *)&pPVar4->iprodMax = uVar2 & 0xfff1 | (uint)((ulong)lVar7 >> 0x10);
  uVar5 = lpplProdGlob._2_2_;
  uVar2 = *(uint *)&((PLPROD *)lpplProdGlob)[iprod + 1].iprodMax;
  pPVar4 = (PLPROD *)lpplProdGlob + iprod + 1;
  pPVar4->wFlags = ((PLPROD *)lpplProdGlob + iprod + 1)->wFlags;
  *(uint *)&pPVar4->iprodMax = uVar2 & 0xf80f;
  uVar5 = lpplProdGlob._2_2_;
  uVar2 = *(uint *)&((PLPROD *)lpplProdGlob)[iprod + 1].iprodMax;
  pPVar4 = (PLPROD *)lpplProdGlob + iprod + 1;
  pPVar4->wFlags = ((PLPROD *)lpplProdGlob + iprod + 1)->wFlags;
  *(uint *)&pPVar4->iprodMax = uVar2 & 0x7ff;
  pbVar1 = &((PLPROD *)lpplProdGlob)->iprodMac;
  *pbVar1 = *pbVar1 + 1;
LAB_1090_4230:
  if (bVar3) {
    FinishProduction((uint)(cItem != 0));
  }
  return;
}



// ======================================================================
// Function: IroEnsureAi
// Address: 1090:425a
// Segment: MEMORY_AIU
// ======================================================================


short IroEnsureAi(byte *lpbRes,short cRes,short *pishdefSBLatest,short pct)

{
  short sVar1;
  int iVar2;
  short ilvl;
  short pctTech;
  short i;
  short iSmallest;
  
  if (pishdefSBLatest != (short *)0x0) {
    EnsureAiStarbaseDesigns();
    sVar1 = IshdefAiSBLatest();
    *pishdefSBLatest = sVar1;
    ValidateStarbaseHistory();
  }
  *(undefined1 *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) = (char)pct;
  for (i = 0; (i < 6 && ('\x17' < *(char *)(idPlayer * 0xc0 + 0x59bc + i))); i = i + 1) {
  }
  if (i == 6) {
    *(undefined1 *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) = 0;
    pctTech = (int)*(char *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) << 8;
    WriteMemRt(0x22,2,&pctTech);
  }
  i = 0;
  while( true ) {
    if (cRes <= i) {
      iSmallest = 0;
      for (i = 1; i < 6; i = i + 1) {
        if (*(char *)(idPlayer * 0xc0 + 0x59bc + i) <
            *(char *)(idPlayer * 0xc0 + 0x59bc + iSmallest)) {
          iSmallest = i;
        }
      }
      if (((int)*(char *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xfU) !=
          iSmallest) {
        *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) =
             *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xf0 |
             (byte)iSmallest;
        if ((*(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xf) == 0x1a) {
          *(undefined1 *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) = 0;
        }
        pctTech = (int)*(char *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) +
                  *(char *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) * 0x100;
        WriteMemRt(0x22,2,&pctTech);
      }
      return 0x39e;
    }
    iVar2 = (int)*(char *)(idPlayer * 0xc0 + 0x59bc + ((int)(uint)((byte *)lpbRes)[i] >> 5));
    if (iVar2 < (int)(((byte *)lpbRes)[i] & 0x1f)) break;
    i = i + 1;
  }
  *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) =
       *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xf0 |
       (byte)((int)(uint)((byte *)lpbRes)[i] >> 5);
  if ((i < cRes + -1) && (iVar2 + 1U == (((byte *)lpbRes)[i] & 0x1f))) {
    *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) =
         *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xf |
         (byte)(((int)(uint)((byte *)lpbRes)[i + 1] >> 5) << 4);
  }
  pctTech = (int)*(char *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) +
            *(char *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) * 0x100;
  WriteMemRt(0x22,2,&pctTech);
  return i;
}



// ======================================================================
// Function: KeepFleetsMoving
// Address: 1090:45ca
// Segment: MEMORY_AIU
// ======================================================================


void KeepFleetsMoving(void)

{
  FLEET *pFVar1;
  int iVar2;
  short sVar3;
  THING *pTVar4;
  short ith;
  THING *rglpth [200];
  THING *lpth;
  FLEET *lpfl;
  short ifl;
  short i;
  
  ith = 0;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  do {
    if ((THING *)lpThings + cThing <= (THING *)lpth) {
AIU_LKeepMovn:
      ifl = 0;
      while( true ) {
        if (cFleet <= ifl) {
          return;
        }
                    /* WARNING: Load size is inaccurate */
        pFVar1 = ((FLEET **)rglpfl)[ifl];
        iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
        if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
        if ((pFVar1->iPlayer == idPlayer) && (1 < pFVar1->cord)) {
          if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) ||
             (4 < game.turn)) {
            i = -1;
            sVar3 = FIsAiTransport((FLEET *)CONCAT22(iVar2,pFVar1));
            if (sVar3 != 0) {
              i = 0x1e;
            }
          }
          else {
            i = 0x10;
          }
          SetAiFleetIdealSpeed(lpfl,i,ith,rglpth);
        }
        ifl = ifl + 1;
      }
      return;
    }
    if (((lpth->idFull >> 0xd == 0) && ((lpth->idFull >> 9 & 0xf) != idPlayer)) &&
       (pTVar4 = (THING *)((ulong)lpth >> 0x10),
       *(char *)((int)&((THING *)lpth)->u_THING_0x0006 + 6) != '\x02')) {
      if (ith == 100) {
        ith = -1;
        goto AIU_LKeepMovn;
      }
      rglpth[ith * 2] = (THING *)lpth;
      rglpth[ith * 2 + 1] = pTVar4;
      ith = ith + 1;
    }
    lpth = (THING *)CONCAT22(lpth._2_2_,(THING *)lpth + 1);
  } while( true );
}



// ======================================================================
// Function: FShouldWeBuildColonizers
// Address: 1090:476a
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10904a33) */

short FShouldWeBuildColonizers(short *pcCol)

{
  FLEET *pFVar1;
  int iVar2;
  uint uVar3;
  short sVar4;
  bool bVar5;
  short cColPl;
  int rgish [16];
  FLEET *lpfl;
  short i;
  short ifl;
  short iMin;
  uint cBuilt;
  int local_a;
  short cColFl;
  short iMax;
  
  cColFl = 0;
  cColPl = 0;
  cBuilt = 0;
  local_a = 0;
  iMax = -1;
  iMin = 0x10;
  if (pcCol != (short *)0x0) {
    *pcCol = 0;
  }
  if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) == 0) &&
     ((game.turn & 1) != 0)) {
    sVar4 = 0;
  }
  else if (game.turn < 0x1e) {
    sVar4 = 1;
  }
  else {
    for (i = 0; i < 0x10; i = i + 1) {
      if (((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0) &&
         ((*(int *)(i * 0x93 + 0x3f00) == 0xe || (*(int *)(i * 0x93 + 0x3f00) == 0xf)))) {
        rgish[i] = 1;
        if (iMax < i) {
          iMax = i;
        }
        if (i < iMin) {
          iMin = i;
        }
      }
      else {
        rgish[i] = 0;
      }
    }
    iMax = iMax + 1;
    if (iMax < 1) {
      sVar4 = 0;
    }
    else {
      for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar1 = ((FLEET **)rglpfl)[ifl];
        iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
        if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
        if (pFVar1->iPlayer == idPlayer) {
          for (i = iMin; i < iMax; i = i + 1) {
            if ((0 < rgish[i]) && (0 < pFVar1->rgcsh[i])) {
              cColFl = cColFl + 1;
              break;
            }
          }
        }
      }
      if (pcCol != (short *)0x0) {
        *pcCol = cColFl;
      }
      if (game.mdSize * 0x14 + 10 < cColFl) {
        sVar4 = 0;
      }
      else {
        for (i = 0; i < game.cPlayer; i = i + 1) {
          if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
            cColPl = cColPl + *(int *)((int)&rgplr[0].cPlanet + i * 0xc0);
          }
        }
        if ((game.cPlanMax << 2) / 5 < cColFl + cColPl) {
          sVar4 = 0;
        }
        else {
          cBuilt = 0;
          local_a = 0;
          for (i = iMin; i < iMax; i = i + 1) {
            if (0 < rgish[i]) {
              uVar3 = *(uint *)((int)&rgshdef[0].cBuilt + i * 0x93);
              bVar5 = CARRY2(cBuilt,uVar3);
              cBuilt = cBuilt + uVar3;
              local_a = local_a + *(int *)((int)&rgshdef[0].cBuilt + 2 + i * 0x93) +
                        (uint)bVar5;
            }
          }
          uVar3 = cColPl + cColFl;
          if (((local_a - ((int)uVar3 >> 0xf) == (uint)(cBuilt < uVar3)) && (cBuilt - uVar3 < 0x1a))
             || ((cColFl < 5 && (sVar4 = Random(2), sVar4 == 0)))) {
            sVar4 = 1;
          }
          else {
            sVar4 = 0;
          }
        }
      }
    }
  }
  return sVar4;
}



// ======================================================================
// Function: FIsAiAttack
// Address: 1090:4a72
// Segment: MEMORY_AIU
// ======================================================================


short FIsAiAttack(FLEET *lpfl)

{
  int iVar1;
  undefined2 uVar2;
  short sVar3;
  int iVar4;
  short i;
  short ihul;
  
  i = 0;
  do {
    if (0xf < i) {
      return 0;
    }
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      iVar1 = *(int *)(i * 0x93 + 0x3f00);
      if ((5 < iVar1) && (iVar1 < 0xb)) {
        return 1;
      }
      if (iVar1 == 5) {
        uVar2 = *(undefined2 *)(idPlayer * 4 + 0x100);
        iVar4 = *(int *)(idPlayer * 4 + 0xfe) + i * 0x93;
        iVar1 = *(int *)(iVar4 + 0x89);
        if ((-1 < iVar1) && ((0 < iVar1 || (*(int *)(iVar4 + 0x87) != 0)))) {
          return 1;
        }
        return 0;
      }
      if (((iVar1 == 0x1f) || (iVar1 == 0x1d)) &&
         (sVar3 = WtMaxShdefStat((SHDEF *)CONCAT22(0x1120,(SHDEF *)(i * 0x93 + 0x3f00)),2),
         sVar3 < 500)) {
        uVar2 = *(undefined2 *)(idPlayer * 4 + 0x100);
        iVar4 = *(int *)(idPlayer * 4 + 0xfe) + i * 0x93;
        iVar1 = *(int *)(iVar4 + 0x89);
        if ((-1 < iVar1) && ((0 < iVar1 || (*(int *)(iVar4 + 0x87) != 0)))) {
          return 1;
        }
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FIsTurinDroneAiAttack
// Address: 1090:4b9a
// Segment: MEMORY_AIU
// ======================================================================


short FIsTurinDroneAiAttack(FLEET *lpfl)

{
  int iVar1;
  short i;
  short ihul;
  
  i = 0;
  while( true ) {
    if (0xf < i) {
      return 0;
    }
    if (((0 < ((FLEET *)lpfl)->rgcsh[i]) && (iVar1 = *(int *)(i * 0x93 + 0x3f00), 3 < iVar1)) &&
       (iVar1 < 0xb)) break;
    i = i + 1;
  }
  return 1;
}



// ======================================================================
// Function: FIsAiTransport
// Address: 1090:4c08
// Segment: MEMORY_AIU
// ======================================================================


short FIsAiTransport(FLEET *lpfl)

{
  int iVar1;
  undefined2 uVar2;
  short sVar3;
  int iVar4;
  short i;
  short ihul;
  
  i = 0;
  do {
    if (0xf < i) {
      return 0;
    }
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      iVar1 = *(int *)(i * 0x93 + 0x3f00);
      if (((-1 < iVar1) && (iVar1 < 4)) || ((10 < iVar1 && (iVar1 < 0xe)))) {
        return 1;
      }
      if ((iVar1 == 0x1f) &&
         (sVar3 = WtMaxShdefStat((SHDEF *)CONCAT22(0x1120,(SHDEF *)(i * 0x93 + 0x3f00)),2),
         499 < sVar3)) {
        uVar2 = *(undefined2 *)(idPlayer * 4 + 0x100);
        iVar4 = *(int *)(idPlayer * 4 + 0xfe) + i * 0x93;
        iVar1 = *(int *)(iVar4 + 0x89);
        if ((-1 < iVar1) && ((0 < iVar1 || (*(int *)(iVar4 + 0x87) != 0)))) {
          return 1;
        }
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: ValidateStarbaseHistory
// Address: 1090:4cf0
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10905124) */
/* WARNING: Removing unreachable block (ram,0x10905129) */
/* WARNING: Removing unreachable block (ram,0x10905152) */
/* WARNING: Removing unreachable block (ram,0x10905157) */
/* WARNING: Removing unreachable block (ram,0x10905255) */
/* WARNING: Removing unreachable block (ram,0x10905508) */

void ValidateStarbaseHistory(void)

{
  uint *puVar1;
  byte *pbVar2;
  byte *pbVar3;
  FLEET *pFVar4;
  uint uVar5;
  int iVar6;
  int iVar7;
  short sVar8;
  int iVar9;
  PLANET *pPVar10;
  byte *pbVar11;
  undefined2 unaff_SI;
  byte *unaff_DI;
  byte *pbVar12;
  undefined2 uVar13;
  undefined2 uVar14;
  bool bVar15;
  PLANET *pPVar16;
  long lVar17;
  ulong uVar18;
  ulong uVar19;
  byte *pbVar20;
  ushort in_stack_0000ffc8;
  uint l;
  int local_30;
  short dx;
  short cFr;
  short ipl;
  short j;
  short i;
  FLEET *lpfl;
  short ifl;
  PLANET *lppl;
  short cFr2;
  short dy;
  short id;
  short iBest;
  short iWrite;
  
  pbVar20 = (byte *)CONCAT22(unaff_SI,unaff_DI);
  if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 4) &&
     (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 5)) {
    if (*(uint *)vlpbAiData < 3) {
      uVar18 = (ulong)vlpbAiData >> 0x10;
      pbVar11 = (byte *)vlpbAiData;
      (pbVar11 + 2)[0] = 0;
      (pbVar11 + 2)[1] = 0;
    }
    if (0x13 < game.turn) {
      iWrite = 0;
      uVar13 = (undefined2)((ulong)vlpbAiData >> 0x10);
      pbVar11 = (byte *)vlpbAiData;
      if ((*(int *)(pbVar11 + 2) < 0) || (0x40 < *(int *)(pbVar11 + 2))) {
        (pbVar11 + 2)[0] = 0;
        (pbVar11 + 2)[1] = 0;
      }
      i = 0;
      while( true ) {
        uVar13 = (undefined2)((ulong)vlpbAiData >> 0x10);
        pbVar11 = (byte *)vlpbAiData;
        if (*(int *)(pbVar11 + 2) <= i) break;
        if ((*(int *)(pbVar11 + i * 0x14 + 6) < 0) || (8 < *(int *)(pbVar11 + i * 0x14 + 6))) {
          (pbVar11 + i * 0x14 + 6)[0] = 0;
          (pbVar11 + i * 0x14 + 6)[1] = 0;
        }
        pPVar16 = LpplFromId(*(short *)((byte *)vlpbAiData + i * 0x14 + 4));
        iVar7 = (int)((ulong)pPVar16 >> 0x10);
        if ((((PLANET *)pPVar16 != (PLANET *)0x0) || (iVar7 != 0)) &&
           (((PLANET *)pPVar16)->iPlayer == idPlayer)) {
          if (iWrite != i) {
            uVar13 = vlpbAiData._2_2_;
            pbVar11 = (byte *)vlpbAiData + i * 0x14 + 4;
            pbVar12 = (byte *)vlpbAiData + iWrite * 0x14 + 4;
            pbVar20 = (byte *)CONCAT22((int)((ulong)pbVar20 >> 0x10),pbVar11);
            for (iVar7 = 10; iVar7 != 0; iVar7 = iVar7 + -1) {
              pbVar3 = pbVar12;
              pbVar12 = pbVar12 + 2;
              pbVar2 = pbVar11;
              pbVar11 = pbVar11 + 2;
              *(undefined2 *)pbVar3 = *(undefined2 *)pbVar2;
            }
          }
          iWrite = iWrite + 1;
        }
        i = i + 1;
      }
      *(short *)(pbVar11 + 2) = iWrite;
      for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
                    /* WARNING: Load size is inaccurate */
        pPVar10 = ((PLANET **)vrglpplAi)[ipl];
        iVar7 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
        lppl = (PLANET *)CONCAT22(iVar7,pPVar10);
        if ((pPVar10 == (PLANET *)0x0) && (iVar7 == 0)) break;
        if ((pPVar10->wFlags_0x4 >> 9 & 1) != 0) {
          i = 0;
          while( true ) {
            uVar13 = (undefined2)((ulong)vlpbAiData >> 0x10);
            pbVar11 = (byte *)vlpbAiData;
            if ((*(int *)(pbVar11 + 2) <= i) || (*(int *)(pbVar11 + i * 0x14 + 4) == lppl->id))
            break;
            i = i + 1;
          }
          if ((i == *(int *)(pbVar11 + 2)) && (i < 0x40)) {
            *(short *)(pbVar11 + i * 0x14 + 4) = lppl->id;
            pbVar2 = (byte *)vlpbAiData + i * 0x14 + 6;
            pbVar2[0] = 0;
            pbVar2[1] = 0;
            *(int *)((byte *)vlpbAiData + 2) = *(int *)((byte *)vlpbAiData + 2) + 1;
          }
        }
      }
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      pPVar10 = (PLANET *)lpPlanets + cPlanet;
      while (((PLANET *)lppl < pPVar10 && (*(int *)((byte *)vlpbAiData + 2) < 0x40))) {
        uVar13 = (undefined2)((ulong)lppl >> 0x10);
        if (((((PLANET *)lppl)->iPlayer == idPlayer) &&
            ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0)) &&
           ((iVar7 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe), 0 < iVar7 ||
            ((-1 < iVar7 && (0x4f < *(uint *)(((PLANET *)lppl)->rgwtMin + 3))))))) {
          l = 0;
          local_30 = 0;
          for (i = 0; i < 3; i = i + 1) {
            __aFulmul((ulong)((PLANET *)lppl)->rgMinConc[i],
                              (ulong)((PLANET *)lppl)->rgMinConc[i]);
            lVar17 = __aFlshl((long)pbVar20,in_stack_0000ffc8);
            puVar1 = (uint *)(((PLANET *)lppl)->rgwtMin + i);
            uVar5 = (uint)lVar17 + *puVar1;
            bVar15 = CARRY2(l,uVar5);
            l = l + uVar5;
            local_30 = local_30 +
                       (int)((ulong)lVar17 >> 0x10) +
                       *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) +
                       (uint)CARRY2((uint)lVar17,*puVar1) + (uint)bVar15;
          }
          if (((-1 < local_30) &&
              (((0 < local_30 || (6999 < l)) &&
               (uVar18 = __aFulshr((ulong)pbVar20,in_stack_0000ffc8),
               0x13 < ((uint)uVar18 & 0xfff))))) &&
             (uVar18 = __aFulshr((ulong)pbVar20,in_stack_0000ffc8),
             0x13 < ((uint)uVar18 & 0xfff))) {
            i = 0;
            while( true ) {
              uVar14 = (undefined2)((ulong)vlpbAiData >> 0x10);
              if ((*(int *)((byte *)vlpbAiData + 2) <= i) ||
                 (iVar7 = *(int *)((byte *)vlpbAiData + i * 0x14 + 4), iVar7 == lppl->id))
              break;
              if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) {
                iVar6 = ((POINT *)rgptPlan + iVar7)->x -
                        ((POINT *)rgptPlan + lppl->id)->x;
                iVar7 = *(int *)((int)&rgptPlan[0].y + iVar7 * 4) -
                        *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
                uVar18 = __aFulmul((long)iVar7,(long)iVar7);
                uVar19 = __aFulmul((long)iVar6,(long)iVar6);
                if ((long)(uVar19 + uVar18) < 0x9c4) break;
              }
              i = i + 1;
            }
            uVar14 = (undefined2)((ulong)vlpbAiData >> 0x10);
            pbVar11 = (byte *)vlpbAiData;
            if (*(int *)(pbVar11 + 2) <= i) {
              in_stack_0000ffc8 = lppl->id;
              *(ushort *)(pbVar11 + *(int *)(pbVar11 + 2) * 0x14 + 4) = in_stack_0000ffc8;
              pbVar2 = (byte *)vlpbAiData +
                       *(int *)((byte *)vlpbAiData + 2) * 0x14 + 6;
              pbVar2[0] = 0;
              pbVar2[1] = 0;
              *(int *)((byte *)vlpbAiData + 2) = *(int *)((byte *)vlpbAiData + 2) + 1;
            }
          }
        }
        lppl = (PLANET *)CONCAT22(uVar13,(PLANET *)lppl + 1);
      }
      for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar4 = ((FLEET **)rglpfl)[ifl];
        iVar7 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar7,pFVar4);
        if ((pFVar4 == (FLEET *)0x0) && (iVar7 == 0)) break;
        if ((pFVar4->iPlayer == idPlayer) &&
           (sVar8 = FIsAiTransport((FLEET *)CONCAT22(iVar7,pFVar4)), sVar8 != 0)) {
          i = 0;
          while( true ) {
            uVar13 = (undefined2)((ulong)vlpbAiData >> 0x10);
            pbVar11 = (byte *)vlpbAiData;
            if (*(int *)(pbVar11 + 2) <= i) break;
            j = 0;
            while ((j < *(int *)(pbVar11 + i * 0x14 + 6) &&
                   (*(int *)(pbVar11 + j * 2 + i * 0x14 + 8) != lpfl->id))) {
              j = j + 1;
            }
            if (j < *(int *)(pbVar11 + i * 0x14 + 6)) break;
            i = i + 1;
          }
          if (i == *(int *)(pbVar11 + 2)) {
            iBest = -1;
            lVar17 = 10000000;
            i = 0;
            while( true ) {
              uVar13 = (undefined2)((ulong)vlpbAiData >> 0x10);
              pbVar11 = (byte *)vlpbAiData;
              if (*(int *)(pbVar11 + 2) <= i) break;
              if (*(int *)(pbVar11 + i * 0x14 + 6) < 8) {
                iVar6 = ((POINT *)rgptPlan + *(int *)(pbVar11 + i * 0x14 + 4))->x -
                        (&pFVar4->pt)->x;
                iVar9 = *(int *)((int)&rgptPlan[0].y +
                                *(int *)(pbVar11 + i * 0x14 + 4) * 4) - (pFVar4->pt).y;
                uVar18 = __aFulmul((long)iVar9,(long)iVar9);
                uVar19 = __aFulmul((long)iVar6,(long)iVar6);
                if ((long)(uVar19 + uVar18) < lVar17) {
                  iBest = i;
                  lVar17 = uVar19 + uVar18;
                }
              }
              i = i + 1;
            }
            if (iBest != -1) {
              sVar8 = lpfl->id;
              iVar7 = *(int *)(pbVar11 + iBest * 0x14 + 6);
              *(int *)(pbVar11 + iBest * 0x14 + 6) = *(int *)(pbVar11 + iBest * 0x14 + 6) + 1;
              *(short *)(pbVar11 + iVar7 * 2 + iBest * 0x14 + 8) = sVar8;
            }
          }
        }
      }
      i = 0;
      while( true ) {
        uVar13 = (undefined2)((ulong)vlpbAiData >> 0x10);
        pbVar11 = (byte *)vlpbAiData;
        if (*(int *)(pbVar11 + 2) <= i) break;
        if (*(int *)(pbVar11 + i * 0x14 + 6) < 4) {
          j = 0;
          while ((j < *(int *)(pbVar11 + 2) &&
                 (*(int *)(pbVar11 + j * 0x14 + 6) < *(int *)(pbVar11 + i * 0x14 + 6) + 2))) {
            j = j + 1;
          }
          if (j < *(int *)(pbVar11 + 2)) {
            *(int *)(pbVar11 + j * 0x14 + 6) = *(int *)(pbVar11 + j * 0x14 + 6) + -1;
            uVar13 = *(undefined2 *)(pbVar11 + *(int *)(pbVar11 + j * 0x14 + 6) * 2 + j * 0x14 + 8);
            pbVar11 = (byte *)vlpbAiData;
            uVar14 = vlpbAiData._2_2_;
            iVar7 = *(int *)((byte *)vlpbAiData + i * 0x14 + 6);
            *(int *)((byte *)vlpbAiData + i * 0x14 + 6) =
                 *(int *)((byte *)vlpbAiData + i * 0x14 + 6) + 1;
            *(undefined2 *)(pbVar11 + iVar7 * 2 + i * 0x14 + 8) = uVar13;
          }
        }
        i = i + 1;
      }
      *(int *)vlpbAiData = *(int *)(pbVar11 + 2) * 0x14 + 4;
    }
  }
  return;
}



// ======================================================================
// Function: GetResourcesAvailable
// Address: 1090:56d0
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10905774) */

void GetResourcesAvailable(PLANET *lppl,long *rgRes)

{
  uint *puVar1;
  uint uVar2;
  uint uVar3;
  uint uVar4;
  ushort uVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  bool bVar6;
  ulong uVar7;
  long lVar8;
  undefined2 uVar9;
  undefined2 uVar10;
  int local_8;
  short i;
  
  uVar7 = CONCAT22(unaff_SI,unaff_DI);
  EstMineralsMined(lppl,rgRes,-1,0);
  for (i = 0; i < 3; i = i + 1) {
    uVar3 = *(uint *)(((PLANET *)lppl)->rgwtMin + i);
    uVar4 = *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
    puVar1 = (uint *)(rgRes + i);
    uVar2 = *puVar1;
    *puVar1 = *puVar1 + uVar3;
    puVar1 = (uint *)((int)(rgRes + i) + 2);
    *puVar1 = *puVar1 + uVar4 + (uint)CARRY2(uVar2,uVar3);
  }
  uVar5 = CResourcesAtPlanet(lppl,idPlayer);
  local_8 = (int)uVar5 >> 0xf;
  uVar7 = __aFulshr(uVar7,uVar5);
  if ((uVar7 & 1) == 0) {
    uVar10 = 0;
    uVar9 = 100;
    uVar7 = __aFulmul(CONCAT22(local_8,uVar5),
                              (long)(int)*(char *)((int)&rgplr[0].pctResearch +
                                                  idPlayer * 0xc0));
    lVar8 = __aFldiv(uVar7,CONCAT22(uVar10,uVar9));
    bVar6 = uVar5 < (uint)lVar8;
    uVar5 = uVar5 - (uint)lVar8;
    local_8 = (local_8 - (int)((ulong)lVar8 >> 0x10)) - (uint)bVar6;
  }
  *(ushort *)(rgRes + 3) = uVar5;
  *(int *)((int)rgRes + 0xe) = local_8;
  return;
}



// ======================================================================
// Function: GetProdQCost
// Address: 1090:57c0
// Segment: MEMORY_AIU
// ======================================================================


void GetProdQCost(PLANET *lppl,long *rgCost)

{
  uint *puVar1;
  uint uVar2;
  PROD *pPVar3;
  uint uVar4;
  int iVar5;
  PLANET *pPVar6;
  undefined2 uVar7;
  PROD *lpprod;
  short j;
  short i;
  PLPROD *lpplprod;
  undefined4 rgCostCur;
  
  for (i = 0; i < 4; i = i + 1) {
    *(undefined2 *)(rgCost + i) = 0;
    *(undefined2 *)((int)(rgCost + i) + 2) = 0;
  }
  uVar7 = (undefined2)((ulong)lppl >> 0x10);
  pPVar6 = (PLANET *)lppl;
  if ((*(int *)&pPVar6->lpplprod != 0) || (*(int *)((int)&pPVar6->lpplprod + 2) != 0)) {
    pPVar3 = *(PROD **)&pPVar6->lpplprod;
    uVar7 = *(undefined2 *)((int)&pPVar6->lpplprod + 2);
    lpprod = pPVar3;
    for (i = 0; lpprod = lpprod + 1, i < (int)(uint)*(byte *)((int)&pPVar3->dwFlags + 3); i = i + 1)
    {
      GetProductionCosts(lppl,(PROD *)CONCAT22(uVar7,lpprod),&rgCostCur,idPlayer,0);
      for (j = 0; j < 4; j = j + 1) {
        uVar4 = *(uint *)(&rgCostCur + j);
        iVar5 = *(int *)((int)&rgCostCur + j * 4 + 2);
        puVar1 = (uint *)(rgCost + j);
        uVar2 = *puVar1;
        *puVar1 = *puVar1 + uVar4;
        puVar1 = (uint *)((int)(rgCost + j) + 2);
        *puVar1 = *puVar1 + iVar5 + (uint)CARRY2(uVar2,uVar4);
      }
    }
  }
  return;
}



// ======================================================================
// Function: MergeAllShdefs
// Address: 1090:58be
// Segment: MEMORY_AIU
// ======================================================================


void MergeAllShdefs(short grbitish)

{
  FLEET *pFVar1;
  short sVar2;
  int iVar3;
  undefined2 uVar4;
  long lVar5;
  short iflNextPass;
  FLEET *lpflNextPass;
  int local_b6;
  int rgish [16];
  short grbit;
  FLEET *lpfl;
  short ifl;
  short i;
  short iMin;
  short iMax;
  undefined4 rglpflW;
  short crglpflW;
  
  iMax = -1;
  iMin = 0x10;
  grbit = 1;
  for (i = 0; i < 0x10; i = i + 1) {
    if ((grbitish & grbit) == 0) {
      rgish[i] = 0;
    }
    else {
      rgish[i] = 1;
      if (iMax < i) {
        iMax = i;
      }
      if (i < iMin) {
        iMin = i;
      }
    }
    grbit = grbit << 1;
  }
  iMax = iMax + 1;
  if (iMax < 1) {
    return;
  }
  lpflNextPass = (FLEET *)0x0;
  local_b6 = 0;
  crglpflW = 0;
  ifl = 0;
  do {
    if (ifl < cFleet) {
                    /* WARNING: Load size is inaccurate */
      pFVar1 = ((FLEET **)rglpfl)[ifl];
      iVar3 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      lpfl = (FLEET *)CONCAT22(iVar3,pFVar1);
      if ((pFVar1 == (FLEET *)0x0) && (iVar3 == 0)) goto LAB_1090_5b67;
    }
    else {
LAB_1090_5b67:
      if ((lpflNextPass == (FLEET *)0x0) && (local_b6 == 0)) {
        return;
      }
      lpfl = (FLEET *)CONCAT22(local_b6,lpflNextPass);
      lpflNextPass = (FLEET *)0x0;
      local_b6 = 0;
      ifl = iflNextPass;
      crglpflW = 0;
    }
    uVar4 = (undefined2)((ulong)lpfl >> 0x10);
    if (((FLEET *)lpfl)->iPlayer == idPlayer) {
      for (i = iMin; (i < iMax && ((((FLEET *)lpfl)->rgcsh[i] < 1 || (rgish[i] < 1)))); i = i + 1) {
      }
      if ((i != iMax) && (lVar5 = CMineFromLpfl(lpfl), sVar2 = crglpflW, lVar5 != 4000)) {
        i = 0;
        while( true ) {
          if (crglpflW <= i) break;
          if (*(int *)((int)(&rglpflW)[i] + 6) == ((FLEET *)lpfl)->idPlanet) {
            uVar4 = (undefined2)((ulong)(&rglpflW)[i] >> 0x10);
            iVar3 = (int)(&rglpflW)[i];
            if ((*(int *)(iVar3 + 8) == (&((FLEET *)lpfl)->pt)->x) &&
               (*(int *)(iVar3 + 10) == (((FLEET *)lpfl)->pt).y)) break;
          }
          i = i + 1;
        }
        if (i < crglpflW) {
          Merge2Fleets((FLEET *)CONCAT22(*(undefined2 *)((int)&rglpflW + i * 4 + 2),
                                               *(FLEET **)(&rglpflW + i)),lpfl,0);
        }
        else if (crglpflW == 0x20) {
          if ((lpflNextPass == (FLEET *)0x0) && (local_b6 == 0)) {
            lpflNextPass = (FLEET *)lpfl;
            local_b6 = lpfl._2_2_;
            iflNextPass = ifl;
          }
        }
        else {
          crglpflW = crglpflW + 1;
          *(FLEET **)(&rglpflW + sVar2) = (FLEET *)lpfl;
          *(int *)((int)&rglpflW + sVar2 * 4 + 2) = lpfl._2_2_;
        }
      }
    }
    ifl = ifl + 1;
  } while( true );
}



// ======================================================================
// Function: LpflFindClosestEnum
// Address: 1090:5bae
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10905c88) */

FLEET * LpflFindClosestEnum(FLEET *lpfl,fn_pfn_conflict *pfn)

{
  int iVar1;
  int iVar2;
  FLEET *pFVar3;
  int iVar4;
  long lVar5;
  long lVar6;
  FLEET *pFVar7;
  int iVar8;
  int iVar9;
  short sVar10;
  FLEET *a1;
  undefined2 uVar11;
  ulong uVar12;
  ulong uVar13;
  FLEET *lpflBest;
  int local_14;
  short dx;
  short ish;
  short dy;
  FLEET *lpflT;
  
  lpflBest = (FLEET *)0x0;
  local_14 = 0;
  uVar11 = (undefined2)((ulong)lpfl >> 0x10);
  a1 = (FLEET *)lpfl;
  iVar1 = (&a1->pt)->x;
  iVar2 = (a1->pt).y;
  lVar6 = 10000000;
  for (ish = 0; ish < cFleet; ish = ish + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar3 = ((FLEET **)rglpfl)[ish];
    iVar4 = *(int *)((int)((FLEET **)rglpfl + ish) + 2);
    if ((pFVar3 == (FLEET *)0x0) && (iVar4 == 0)) break;
    iVar8 = iVar1 - (&pFVar3->pt)->x;
    iVar9 = iVar2 - (pFVar3->pt).y;
    uVar12 = __aFulmul((long)iVar9,(long)iVar9);
    uVar13 = __aFulmul((long)iVar8,(long)iVar8);
    pFVar7 = lpflBest;
    iVar8 = local_14;
    lVar5 = lVar6;
    if ((long)(uVar13 + uVar12) < lVar6) {
      sVar10 = (*(fn_pfn_conflict *)pfn)((void *)0x1118,a1);
      pFVar7 = pFVar3;
      iVar8 = iVar4;
      lVar5 = uVar13 + uVar12;
      if (sVar10 == 0) {
        pFVar7 = lpflBest;
        iVar8 = local_14;
        lVar5 = lVar6;
      }
    }
    local_14 = iVar8;
    lpflBest = pFVar7;
    lVar6 = lVar5;
  }
  return (FLEET *)CONCAT22(local_14,lpflBest);
}



// ======================================================================
// Function: LpplFindClosestEnum
// Address: 1090:5cd4
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10905dab) */

PLANET * LpplFindClosestEnum(PLANET *lppl,fn_pfn_conflict *pfn)

{
  int iVar1;
  int iVar2;
  long lVar3;
  int iVar4;
  int iVar5;
  short sVar6;
  PLANET *pPVar7;
  ulong uVar8;
  ulong uVar9;
  short dx;
  PLANET *lpplT;
  PLANET *lpplBest;
  undefined2 local_10;
  short dy;
  
  lVar3 = 10000000;
  lpplBest = (PLANET *)0x0;
  local_10 = 0;
  iVar1 = ((POINT *)rgptPlan + lppl->id)->x;
  iVar2 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
  pPVar7 = (PLANET *)lpPlanets + cPlanet;
  lpplT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lpplT < pPVar7) {
    iVar4 = iVar1 - ((POINT *)rgptPlan + lpplT->id)->x;
    iVar5 = iVar2 - *(int *)((int)&rgptPlan[0].y + lpplT->id * 4);
    uVar8 = __aFulmul((long)iVar5,(long)iVar5);
    uVar9 = __aFulmul((long)iVar4,(long)iVar4);
    if ((long)(uVar9 + uVar8) < lVar3) {
      sVar6 = (*(fn_pfn_conflict *)pfn)((void *)0x1118,(PLANET *)lppl);
      if (sVar6 != 0) {
        lpplBest = (PLANET *)lpplT;
        local_10 = lpplT._2_2_;
        lVar3 = uVar9 + uVar8;
      }
    }
    lpplT = (PLANET *)CONCAT22(lpplT._2_2_,(PLANET *)lpplT + 1);
  }
  return (PLANET *)CONCAT22(local_10,lpplBest);
}



// ======================================================================
// Function: LpplFindBestEnum
// Address: 1090:5e06
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10905f0d) */

PLANET * LpplFindBestEnum(PLANET *lppl,fn_pfn_conflict *pfn)

{
  int iVar1;
  int iVar2;
  long lVar3;
  int iVar4;
  int iVar5;
  short sVar6;
  PLANET *pPVar7;
  ulong uVar8;
  ulong uVar9;
  short dx;
  short iCur;
  PLANET *lpplT;
  PLANET *lpplBest;
  undefined2 local_12;
  short dy;
  short iBest;
  
  iBest = 1;
  lVar3 = 10000000;
  lpplBest = (PLANET *)0x0;
  local_12 = 0;
  iVar1 = ((POINT *)rgptPlan + lppl->id)->x;
  iVar2 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
  pPVar7 = (PLANET *)lpPlanets + cPlanet;
  lpplT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lpplT < pPVar7) {
    iVar4 = iVar1 - ((POINT *)rgptPlan + lpplT->id)->x;
    iVar5 = iVar2 - *(int *)((int)&rgptPlan[0].y + lpplT->id * 4);
    uVar8 = __aFulmul((long)iVar5,(long)iVar5);
    uVar9 = __aFulmul((long)iVar4,(long)iVar4);
    sVar6 = (*(fn_pfn_conflict *)pfn)((void *)0x1118,(PLANET *)lppl);
    if ((iBest < sVar6) || ((sVar6 == iBest && ((long)(uVar9 + uVar8) < lVar3)))) {
      lpplBest = (PLANET *)lpplT;
      local_12 = lpplT._2_2_;
      iBest = sVar6;
      lVar3 = uVar9 + uVar8;
    }
    lpplT = (PLANET *)CONCAT22(lpplT._2_2_,(PLANET *)lpplT + 1);
  }
  return (PLANET *)CONCAT22(local_12,lpplBest);
}



// ======================================================================
// Function: IdRandomPlanetNearby
// Address: 1090:5f54
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10906035) */

short IdRandomPlanetNearby(POINT pt,short cDist,short fAvoidStarbases)

{
  short sVar1;
  short sVar2;
  int iVar3;
  ulong uVar4;
  ulong uVar5;
  ulong uVar6;
  PLANET *pPVar7;
  PLANET *lppl;
  short cExtraAttempts;
  short i;
  short idBest;
  short iChance;
  
  if (fAvoidStarbases == 0) {
    cExtraAttempts = 0;
  }
  else {
    cExtraAttempts = 2;
  }
  while( true ) {
    uVar4 = __aFulmul((long)cDist,(long)cDist);
    iChance = 1;
    idBest = -1;
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      sVar1 = _abs(pt.x - ((POINT *)rgptPlan + i)->x);
      sVar2 = _abs(pt.y - *(int *)((int)&rgptPlan[0].y + i * 4));
      uVar5 = __aFulmul((long)sVar2,(long)sVar2);
      uVar6 = __aFulmul((long)sVar1,(long)sVar1);
      if ((long)(uVar6 + uVar5) <= (long)uVar4) {
        iVar3 = iChance + 1;
        sVar1 = Random(iChance);
        iChance = iVar3;
        if (sVar1 == 0) {
          idBest = i;
        }
      }
    }
    if ((idBest == -1) || (cExtraAttempts < 1)) break;
    pPVar7 = LpplFromId(idBest);
    iVar3 = (int)((ulong)pPVar7 >> 0x10);
    if (((PLANET *)pPVar7 == (PLANET *)0x0) && (iVar3 == 0)) {
      return idBest;
    }
    cExtraAttempts = cExtraAttempts + -1;
    if ((((PLANET *)pPVar7)->wFlags_0x4 >> 9 & 1) == 0) {
      return idBest;
    }
  }
  return idBest;
}



// ======================================================================
// Function: ClearAiCurrentTask
// Address: 1090:60c0
// Segment: MEMORY_AIU
// ======================================================================


void ClearAiCurrentTask(FLEET *lpfl,short fChangeSel)

{
  undefined2 uVar1;
  
  if (fChangeSel != 0) {
    ChangeMainObjSel(2,lpfl->id);
  }
  uVar1 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
  *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
       *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0;
  FLookupFleet(-1,(FLEET *)&sel.fl);
  return;
}



// ======================================================================
// Function: FEnumOurStarbase
// Address: 1090:6110
// Segment: MEMORY_AIU
// ======================================================================


short FEnumOurStarbase(PLANET *lpplSrc,PLANET *lpplTest)

{
  short sVar1;
  undefined2 uVar2;
  
  uVar2 = (undefined2)((ulong)lpplTest >> 0x10);
  if ((((PLANET *)lpplTest)->iPlayer == idPlayer) &&
     ((((PLANET *)lpplTest)->wFlags_0x4 >> 9 & 1) != 0)) {
    sVar1 = 1;
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: FFleetMightHaveTeeth
// Address: 1090:6152
// Segment: MEMORY_AIU
// ======================================================================


short FFleetMightHaveTeeth(FLEET *lpfl)

{
  short sVar1;
  int iVar2;
  short ishdef;
  
  ishdef = 0;
  while( true ) {
    if (0xf < ishdef) {
      return 0;
    }
    if ((((FLEET *)lpfl)->rgcsh[ishdef] != 0) &&
       (iVar2 = ((uint)lpfl->id >> 9 & 0xf) * 4,
       sVar1 = FHullHasTeeth
                         ((HUL *)CONCAT22(*(undefined2 *)(iVar2 + 0x100),
                                          (HUL *)(*(int *)(iVar2 + 0xfe) + ishdef * 0x93))),
       sVar1 != 0)) break;
    ishdef = ishdef + 1;
  }
  return 1;
}



// ======================================================================
// Function: IdTargetScout
// Address: 1090:61de
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109063de) */
/* WARNING: Removing unreachable block (ram,0x1090638d) */
/* WARNING: Removing unreachable block (ram,0x109065e3) */

short IdTargetScout(FLEET *lpfl,FLEET *lpflAtk,FLEET *lpflEnemy,short fOnlyHumans,THING **plpthWorm)

{
  long lVar1;
  short sVar2;
  int iVar3;
  int iVar4;
  ushort uVar5;
  PLANET *pPVar6;
  int iVar7;
  FLEET *pFVar8;
  int iVar9;
  undefined2 unaff_SI;
  undefined2 uVar10;
  undefined2 uVar11;
  ulong uVar12;
  ulong uVar13;
  long lVar14;
  PLANET *pPVar15;
  undefined2 in_stack_0000ffbc;
  fn_pfn_conflict *pfVar16;
  undefined2 in_stack_0000ffbe;
  short ord;
  short local_3e;
  short local_3c;
  FLEET *lpflAtk2;
  short dx;
  PLANET *lpplClosest;
  short idClosest;
  PLANET *lppl;
  short dy;
  FLEET *lpflT;
  FLEET *lpflClosest;
  
  lpflClosest = (FLEET *)0x0;
  lpflT = lpflEnemy;
  lVar14 = 1000000;
  uVar10 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar8 = (FLEET *)lpfl;
  iVar9 = (&pFVar8->pt)->x;
  iVar7 = (pFVar8->pt).y;
  _memset(&ord,0,0x12);
  sVar2 = FFleetMightHaveTeeth(lpfl);
  uVar12 = CONCAT22(in_stack_0000ffbe,in_stack_0000ffbc);
  if (sVar2 != 0) {
    while( true ) {
      in_stack_0000ffbe = (undefined2)(uVar12 >> 0x10);
      if (((FLEET *)lpflT == (FLEET *)0x0) && (lpflT._2_2_ == 0)) break;
      if ((fOnlyHumans == 0) ||
         ((*(uint *)((int)&rgplr[0].wMdPlr + ((FLEET *)lpflT)->iPlayer * 0xc0) >> 9 & 1)
          == 0)) {
        lpflAtk2 = lpflAtk;
        while( true ) {
          if ((lpflAtk2 == (FLEET *)0x0) ||
             ((((lpfl != lpflAtk2 && (1 < ((FLEET *)lpflAtk2)->cord)) &&
               (*(int *)&((PLORD *)((FLEET *)lpflAtk2)->lpplord)[6].iordMax == lpflT->id)) &&
              ((((PLORD *)((FLEET *)lpflAtk2)->lpplord + 7)->wFlags >> 8 & 0xf) == 2)))) break;
                    /* WARNING: Load size is inaccurate */
          lpflAtk2 = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflAtk2)->lpflNext + 2),
                                       ((FLEET *)lpflAtk2)->lpflNext);
        }
        if ((lpflAtk2 == (FLEET *)0x0) || (sVar2 = Random(3), sVar2 != 0)) {
          iVar3 = (&((FLEET *)lpflT)->pt)->x - iVar9;
          iVar4 = (((FLEET *)lpflT)->pt).y - iVar7;
          uVar12 = __aFulmul((long)iVar4,(long)iVar4);
          uVar13 = __aFulmul((long)iVar3,(long)iVar3);
          if ((long)(uVar13 + uVar12) < lVar14) {
            lpflClosest = lpflT;
            lVar14 = uVar13 + uVar12;
          }
        }
      }
                    /* WARNING: Load size is inaccurate */
      lpflT = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflT)->lpflNext + 2),
                                ((FLEET *)lpflT)->lpflNext);
    }
    if (lVar14 < 0x7e90) {
      ord = (&((FLEET *)lpflClosest)->pt)->x;
      local_3e = (((FLEET *)lpflClosest)->pt).y;
      uVar5 = 0x200;
      local_3c = lpflClosest->id;
      goto AIU_ThwakSumthin_2;
    }
    if (((FLEET *)lpflClosest == (FLEET *)0x0) && (lpflClosest._2_2_ == 0)) {
      if (fOnlyHumans != 0) {
        sVar2 = IdTargetScout(lpfl,lpflAtk,lpflEnemy,0,plpthWorm);
        return sVar2;
      }
    }
    else {
      lVar14 = LGetFleetStat(lpfl,1);
      lVar14 = __aFldiv(lVar14,CONCAT22((int)uVar12,unaff_SI));
      iVar7 = (int)((ulong)lVar14 >> 0x10);
      iVar9 = *(int *)((int)pFVar8->rgwtMin + 0x12);
      if ((iVar9 <= iVar7) &&
         (((iVar9 < iVar7 || (*(uint *)(pFVar8->rgwtMin + 4) < (uint)lVar14)) &&
          (sVar2 = FMoveToNearestStarbase(lpfl,0), sVar2 != 0)))) {
        return 0;
      }
      iVar9 = (&((FLEET *)lpflClosest)->pt)->x;
      iVar7 = (((FLEET *)lpflClosest)->pt).y;
      lpplClosest = (PLANET *)0x0;
      lVar14 = 1000000;
      pPVar6 = (PLANET *)lpPlanets + cPlanet;
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      in_stack_0000ffbe = lpPlanets._2_2_;
      while ((PLANET *)lppl < pPVar6) {
        lpflAtk2 = lpflAtk;
        while( true ) {
          if ((lpflAtk2 == (FLEET *)0x0) ||
             (((lpfl != lpflAtk2 && (1 < ((FLEET *)lpflAtk2)->cord)) &&
              ((*(int *)&((PLORD *)((FLEET *)lpflAtk2)->lpplord)[6].iordMax == lppl->id &&
               ((((PLORD *)((FLEET *)lpflAtk2)->lpplord + 7)->wFlags >> 8 & 0xf) == 1)))))) break;
                    /* WARNING: Load size is inaccurate */
          lpflAtk2 = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflAtk2)->lpflNext + 2),
                                       ((FLEET *)lpflAtk2)->lpflNext);
        }
        if (lpflAtk2 == (FLEET *)0x0) {
          iVar3 = ((POINT *)rgptPlan + lppl->id)->x - iVar9;
          iVar4 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4) - iVar7;
          uVar12 = __aFulmul((long)iVar4,(long)iVar4);
          in_stack_0000ffbe = (undefined2)(uVar12 >> 0x10);
          iVar4 = iVar3 >> 0xf;
          uVar12 = __aFulmul((long)iVar3,(long)iVar3);
          lVar1 = uVar12 + CONCAT22(in_stack_0000ffbe,iVar4);
          if (lVar1 < lVar14) {
            lpplClosest = lppl;
            lVar14 = lVar1;
          }
        }
        lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
      }
      if ((((PLANET *)lpplClosest != (PLANET *)0x0) || (lpplClosest._2_2_ != 0)) &&
         (lpplClosest->id != pFVar8->idPlanet)) {
        ord = ((POINT *)rgptPlan + lpplClosest->id)->x;
        local_3e = *(short *)((int)&rgptPlan[0].y + lpplClosest->id * 4);
        uVar5 = 0x100;
        local_3c = lpplClosest->id;
        goto AIU_ThwakSumthin_2;
      }
    }
  }
  idClosest = IdNearestUnknownPlanet(lpfl,plpthWorm);
  if ((plpthWorm == (THING **)0x0) ||
     ((*plpthWorm == (THING *)0x0 && (plpthWorm[1] == (THING *)0x0)))) {
    if (idClosest == -1) {
      if (*(int *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0) == -1) {
        idClosest = Random(game.cPlanMax);
      }
      else {
        pfVar16 = (fn_pfn_conflict *)0x1088;
        pPVar15 = LpplFromId(*(short *)((int)&rgplr[0].idPlanetHome +
                                             idPlayer * 0xc0));
        pPVar15 = LpplFindBestEnum(pPVar15,(fn_pfn_conflict *)CONCAT22(in_stack_0000ffbe,pfVar16));
        if (((PLANET *)pPVar15 == (PLANET *)0x0) && ((int)((ulong)pPVar15 >> 0x10) == 0)) {
          local_3c = 0x1090;
          local_3e = 0x6771;
          idClosest = Random(game.cPlanMax);
        }
        else {
          idClosest = pPVar15->id;
        }
      }
    }
    local_3c = idClosest;
    uVar5 = 0x100;
    ord = ((POINT *)rgptPlan + idClosest)->x;
    local_3e = *(short *)((int)&rgptPlan[0].y + idClosest * 4);
  }
  else {
    uVar11 = (undefined2)((ulong)*(undefined4 *)plpthWorm >> 0x10);
    iVar9 = (int)*(undefined4 *)plpthWorm;
    ord = *(short *)(iVar9 + 2);
    local_3e = *(short *)(iVar9 + 4);
    uVar5 = 0x800;
    local_3c = **(int **)plpthWorm;
  }
AIU_ThwakSumthin_2:
  if (((pFVar8->cord < 2) || ((((PLORD *)pFVar8->lpplord + 7)->wFlags >> 8 & 0xf) != 1)) ||
     (uVar5 != 0x100)) {
    if (uVar5 == 0x100) {
      ((byte *)vlpbAiPlanet)[local_3c * 0x10 + 0xf] = 4;
    }
    IFindIdealWarp(lpfl,1);
    sVar2 = FMoveAiFleet(lpfl,(ORDER *)&ord,0);
    if (sVar2 == 0) {
      sVar2 = -1;
    }
    else {
      sVar2 = 0;
    }
  }
  else {
    sVar2 = -1;
  }
  return sVar2;
}



// ======================================================================
// Function: MarkPlanetsUnderAttack
// Address: 1090:6896
// Segment: MEMORY_AIU
// ======================================================================


void MarkPlanetsUnderAttack(void)

{
  int iVar1;
  int iVar2;
  int iVar3;
  PLANET *pPVar4;
  short j;
  FLEET *lpfl;
  short ifl;
  short i;
  PLANET *lppl;
  
  ifl = 0;
  while( true ) {
    if (cFleet <= ifl) {
      return;
    }
    iVar1 = *(int *)((FLEET **)rglpfl + ifl);
    iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    if ((iVar1 == 0) && (iVar2 == 0)) break;
    if ((*(int *)(iVar1 + 2) != idPlayer) && (*(int *)(iVar1 + 6) != -1)) {
      i = 0;
      while ((i < 0x10 &&
             (((*(int *)(iVar1 + 0xc + i * 2) < 1 ||
               (iVar3 = *(int *)(iVar1 + 2) * 4, *(int *)(*(int *)(iVar3 + 0xfe) + i * 0x93) < 0x10)
               ) || (iVar3 = *(int *)(iVar1 + 2) * 4,
                    0x13 < *(int *)(*(int *)(iVar3 + 0xfe) + i * 0x93)))))) {
        i = i + 1;
      }
      if ((i != 0x10) &&
         (pPVar4 = LpplFromId(*(short *)(iVar1 + 6)),
         ((PLANET *)pPVar4)->iPlayer == idPlayer)) {
        ((byte *)vlpbAiPlanet)[pPVar4->id * 0x10 + 8] = 1;
      }
    }
    ifl = ifl + 1;
  }
  return;
}



// ======================================================================
// Function: FixPlanetsUnderAttack
// Address: 1090:69e6
// Segment: MEMORY_AIU
// ======================================================================


void FixPlanetsUnderAttack(PROD *rgprod)

{
  PLANET *pPVar1;
  int iVar2;
  short ipl;
  PLANET *lppl;
  
  ipl = 0;
  while( true ) {
    if (vclpplAi <= ipl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pPVar1 = ((PLANET **)vrglpplAi)[ipl];
    iVar2 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
    lppl = (PLANET *)CONCAT22(iVar2,pPVar1);
    if ((pPVar1 == (PLANET *)0x0) && (iVar2 == 0)) break;
    if (((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 8] != 0) {
      QuickBuildDefenses((PLANET *)CONCAT22(iVar2,pPVar1),rgprod);
    }
    ipl = ipl + 1;
  }
  return;
}



// ======================================================================
// Function: QuickBuildDefenses
// Address: 1090:6a7e
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10906c09) */
/* WARNING: Removing unreachable block (ram,0x10906bb9) */
/* WARNING: Removing unreachable block (ram,0x10906b0a) */
/* WARNING: Removing unreachable block (ram,0x10906b32) */
/* WARNING: Removing unreachable block (ram,0x10906be9) */
/* WARNING: Removing unreachable block (ram,0x10906c0e) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10906ca2) */

void QuickBuildDefenses(PLANET *lppl,PROD *rgprod)

{
  int iVar1;
  uint uVar2;
  short sVar3;
  PLANET *pPVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  bool bVar6;
  ulong uVar7;
  long lVar8;
  undefined2 uVar9;
  ulong uVar10;
  PROD *lpprod;
  undefined4 rgRes;
  uint local_18;
  int local_16;
  short cDef;
  undefined4 lVal;
  short cRes;
  short i;
  short cCur;
  short cAlch;
  short cMax;
  
  uVar10 = CONCAT22(unaff_SI,unaff_DI);
  uVar5 = (undefined2)((ulong)lppl >> 0x10);
  pPVar4 = (PLANET *)lppl;
  if ((*(int *)&pPVar4->lpplprod != 0) || (*(int *)((int)&pPVar4->lpplprod + 2) != 0)) {
    i = 0;
    lpprod._0_2_ = *(PROD **)&pPVar4->lpplprod;
    for (; lpprod._0_2_ = (PROD *)lpprod + 1, i < (int)(uint)((PLPROD *)pPVar4->lpplprod)->iprodMac;
        i = i + 1) {
      uVar7 = __aFulshr(uVar10,(ushort)(PROD *)lpprod);
      if ((((uint)uVar7 & 7) == 1) &&
         (uVar7 = __aFulshr(uVar10,(ushort)(PROD *)lpprod), ((uint)uVar7 & 0x7f) == 9)) {
        return;
      }
    }
  }
  GetResourcesAvailable(lppl,&rgRes);
  if ((0 < local_16) || ((-1 < local_16 && (0x31 < local_18)))) {
    ChangeMainObjSel(1,lppl->id);
    InitProduction(rgprod);
    i = 0;
    while ((i < cProdGlob &&
           (((uVar7 = __aFulshr(uVar10,(ushort)(PROD *)lpprod), ((uint)uVar7 & 7) != 1 ||
             (uVar7 = __aFulshr(uVar10,(ushort)(PROD *)lpprod), ((uint)uVar7 & 0x7f) != 9))
            || (((pProdGlob + i)->dwFlags & 0x3ff) == 0))))) {
      i = i + 1;
    }
    lVar8 = CONCAT22(lVal._2_2_,(undefined2)lVal);
    if (i == cProdGlob) {
      FinishProduction(0);
    }
    else {
      cMax = (uint)(pProdGlob + i)->dwFlags & 0x3ff;
      cCur = 100;
      for (i = 0; lVal = lVar8, i < 3; i = i + 1) {
        lVar8 = __aFldiv(CONCAT22(*(undefined2 *)((int)&rgRes + i * 4 + 2),
                                          *(undefined2 *)(&rgRes + i)),5);
        lVal = lVar8;
        if (lVar8 < cCur) {
          cCur = (short)lVar8;
        }
      }
      lVar8 = __aFldiv(CONCAT22(local_16,local_18),0x19);
      cRes = (short)lVar8;
      if (5 < cRes) {
        cRes = cRes - cRes / 6;
      }
      lVar8 = __aFldiv(CONCAT22(local_16,local_18),10);
      bVar6 = local_18 < (uint)lVar8;
      local_18 = local_18 - (uint)lVar8;
      local_16 = (local_16 - (int)((ulong)lVar8 >> 0x10)) - (uint)bVar6;
      if (cMax < cRes) {
        cRes = cMax;
      }
      if (cCur < cRes) {
        uVar9 = 0;
        uVar5 = 0x96;
        sVar3 = GetRaceGrbit((PLAYER *)rgplr + idPlayer,
                                   ibitRaceMineralAlchemy);
        if (sVar3 == 0) {
          iVar1 = 100;
        }
        else {
          iVar1 = 0x19;
        }
        uVar2 = iVar1 * cCur;
        lVar8 = __aFldiv(CONCAT22((local_16 - ((int)uVar2 >> 0xf)) -
                                          (uint)(local_18 < uVar2),local_18 - uVar2),
                                 CONCAT22(uVar9,uVar5));
        cAlch = (short)lVar8;
        if (cAlch < 0) {
          cAlch = 0;
        }
        cDef = cCur + cAlch;
        cAlch = cAlch * 5;
      }
      else {
        cAlch = 0;
        cDef = cRes;
      }
      if (0 < cDef) {
        AddItemToQueue(9,cDef,grobjPlanet,0);
      }
      if (0 < cAlch) {
        AddItemToQueue(0xb,cAlch,grobjPlanet,0);
      }
      if ((cDef < 1) && (cAlch < 1)) {
        sVar3 = 0;
      }
      else {
        sVar3 = 1;
      }
      FinishProduction(sVar3);
    }
  }
  return;
}



// ======================================================================
// Function: IdplFindClosestStarbase
// Address: 1090:6e04
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10906ed8) */

short IdplFindClosestStarbase(FLEET *lpfl,short fBigOnes)

{
  ushort uVar1;
  int iVar2;
  PLORD *pPVar3;
  long lVar4;
  int iVar5;
  int iVar6;
  short sVar7;
  PLANET *pPVar8;
  PLORD *pPVar9;
  undefined2 uVar10;
  ulong uVar11;
  ulong uVar12;
  short dx;
  PLANET *lpplT;
  PLANET *lpplBest;
  short dy;
  
  lVar4 = 10000000;
  lpplBest = (PLANET *)0x0;
  pPVar3 = ((FLEET *)lpfl)->lpplord;
  uVar10 = (undefined2)((ulong)pPVar3 >> 0x10);
  pPVar9 = (PLORD *)pPVar3;
  uVar1 = (pPVar9 + 1)->wFlags;
  iVar2 = *(int *)&pPVar9[1].iordMax;
  pPVar8 = (PLANET *)lpPlanets + cPlanet;
  lpplT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lpplT < pPVar8) {
    iVar5 = uVar1 - ((POINT *)rgptPlan + lpplT->id)->x;
    iVar6 = iVar2 - *(int *)((int)&rgptPlan[0].y + lpplT->id * 4);
    uVar11 = __aFulmul((long)iVar6,(long)iVar6);
    uVar12 = __aFulmul((long)iVar5,(long)iVar5);
    if (((((long)(uVar12 + uVar11) < lVar4) && (((PLANET *)lpplT)->iPlayer == idPlayer)) &&
        ((((PLANET *)lpplT)->wFlags_0x4 >> 9 & 1) != 0)) &&
       ((fBigOnes == 0 ||
        ((iVar5 = *(int *)((int)((PLANET *)lpplT)->rgwtMin + 0xe), -1 < iVar5 &&
         ((0 < iVar5 || (0xfa < *(uint *)(((PLANET *)lpplT)->rgwtMin + 3))))))))) {
      lpplBest = lpplT;
      lVar4 = uVar12 + uVar11;
    }
    lpplT = (PLANET *)CONCAT22(lpplT._2_2_,(PLANET *)lpplT + 1);
  }
  if (((PLANET *)lpplBest == (PLANET *)0x0) && (lpplBest._2_2_ == 0)) {
    sVar7 = -1;
  }
  else {
    sVar7 = lpplBest->id;
  }
  return sVar7;
}



// ======================================================================
// Function: FMoveToNearestStarbase
// Address: 1090:6f7e
// Segment: MEMORY_AIU
// ======================================================================


short FMoveToNearestStarbase(FLEET *lpfl,short fBigOnes)

{
  short sVar1;
  ORDER ord;
  short id;
  
  ord.id = IdplFindClosestStarbase(lpfl,fBigOnes);
  if (ord.id == -1) {
    sVar1 = 0;
  }
  else {
    ord.pt.x = ((POINT *)rgptPlan + ord.id)->x;
    ord.pt.y = *(short *)((int)&rgptPlan[0].y + ord.id * 4);
    ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe000 | 0x1140;
    id = ord.id;
    sVar1 = FMoveAiFleet(lpfl,&ord,0);
  }
  return sVar1;
}



// ======================================================================
// Function: MoveToNearestPlanetOrEnemy
// Address: 1090:7014
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109070e8) */
/* WARNING: Removing unreachable block (ram,0x10907166) */

void MoveToNearestPlanetOrEnemy(FLEET *lpfl,short dEnemyRange)

{
  short sVar1;
  FLEET *pFVar2;
  PLORD *pPVar3;
  undefined2 uVar4;
  undefined2 uVar5;
  ulong uVar6;
  ulong uVar7;
  POINT pt_00;
  SCAN scan;
  long lBest;
  undefined4 l;
  ORDER ord;
  short dx;
  PLANET *lpplT;
  PLANET *lpplBest;
  PLANET *lpplTMac;
  undefined2 local_e;
  short dy;
  short id;
  ushort pt;
  int local_6;
  
  lBest = 10000000;
  lpplBest = (PLANET *)0x0;
  uVar4 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar2 = (FLEET *)lpfl;
  uVar5 = (undefined2)((ulong)pFVar2->lpplord >> 0x10);
  pPVar3 = (PLORD *)pFVar2->lpplord;
  pt = (pPVar3 + 1)->wFlags;
  local_6 = *(int *)&pPVar3[1].iordMax;
  lpplTMac = (PLANET *)lpPlanets + cPlanet;
  local_e = lpPlanets._2_2_;
  lpplT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lpplT < lpplTMac) {
    dx = pt - ((POINT *)rgptPlan + lpplT->id)->x;
    dy = local_6 - *(int *)((int)&rgptPlan[0].y + lpplT->id * 4);
    uVar6 = __aFulmul((long)dy,(long)dy);
    uVar7 = __aFulmul((long)dx,(long)dx);
    l = uVar7 + uVar6;
    if (((l < lBest) && (((PLANET *)lpplT)->iPlayer != idPlayer)) &&
       (((PLANET *)lpplT)->iPlayer != -1)) {
      lpplBest = lpplT;
      lBest = l;
    }
    lpplT = (PLANET *)CONCAT22(lpplT._2_2_,(PLANET *)lpplT + 1);
  }
  if (((PLANET *)lpplBest != (PLANET *)0x0) || (lpplBest._2_2_ != 0)) {
    uVar6 = __aFulmul((long)dEnemyRange,(long)dEnemyRange);
    if (lBest <= (long)uVar6) {
      id = lpplBest->id;
      goto LAB_1090_71a9;
    }
  }
  pt_00.y = (pFVar2->pt).y;
  pt_00.x = (&pFVar2->pt)->x;
  sVar1 = FFindNearestObject(pt_00,0x21,&scan);
  if (sVar1 == 0) {
    return;
  }
  id = scan.idpl;
LAB_1090_71a9:
  if (pFVar2->idPlanet != id) {
    ord.id = id;
    ord.pt.x = ((POINT *)rgptPlan + id)->x;
    ord.pt.y = *(short *)((int)&rgptPlan[0].y + id * 4);
    ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe000 | 0x1140;
    FMoveAiFleet(lpfl,&ord,0);
  }
  return;
}



// ======================================================================
// Function: EnsureAiStarbaseDesigns
// Address: 1090:7222
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109075ca) */
/* WARNING: Removing unreachable block (ram,0x1090743d) */
/* WARNING: Removing unreachable block (ram,0x1090763a) */

void EnsureAiStarbaseDesigns(void)

{
  undefined2 uVar1;
  undefined4 uVar2;
  int iVar3;
  int iVar4;
  short iSetLast;
  short i;
  short iSetNew;
  ushort wTurnLast;
  
  uVar2 = *(undefined4 *)(idPlayer * 4 + 0x14c);
  if ((*(uint *)((int)uVar2 + 0x1a1) >> 9 & 1) != 0) {
    FCreateAiStarbase(2,2,-1,-1);
    FCreateAiStarbase(4,3,-1,-1);
  }
  uVar2 = *(undefined4 *)(idPlayer * 4 + 0x14c);
  if ((*(uint *)((int)uVar2 + 0x10e) >> 9 & 1) != 0) {
    FCreateAiStarbase(1,1,-1,-1);
  }
  uVar2 = *(undefined4 *)(idPlayer * 4 + 0x14c);
  if ((*(uint *)((int)uVar2 + 0x234) >> 9 & 1) != 0) {
    FCreateAiStarbase(3,2,-1,-1);
  }
  if (0x31 < game.turn) {
    iSetLast = -1;
    wTurnLast = 0;
    for (i = 0; i < 10; i = i + 2) {
      if (i == 6) {
        i = 5;
      }
      if (((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) &&
         (wTurnLast <= *(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7d))) {
        wTurnLast = *(ushort *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7d);
        iSetLast = i;
      }
    }
    if ((iSetLast != -1) && (wTurnLast + 0x28 <= game.turn)) {
      if (iSetLast < 5) {
        i = 5;
        iVar3 = i;
      }
      else {
        i = 0;
        iVar3 = i;
      }
      for (; i < iVar3 + 5; i = i + 2) {
        if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) {
          uVar1 = *(undefined2 *)(idPlayer * 4 + 0x14e);
          iVar4 = *(int *)(idPlayer * 4 + 0x14c) + i * 0x93;
          if ((*(int *)(iVar4 + 0x85) != 0) || (*(int *)(iVar4 + 0x83) != 0)) goto AIU_LOrbital;
        }
      }
      FCreateAiStarbase(iVar3,1,-1,-1);
      FCreateAiStarbase(iVar3 + 2,2,-1,-1);
      FCreateAiStarbase(iVar3 + 4,3,-1,-1);
    }
AIU_LOrbital:
    iSetLast = -1;
    wTurnLast = 0;
    for (i = 1; i < 9; i = i + 2) {
      if (i == 5) {
        i = 6;
      }
      if (((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) &&
         (wTurnLast <= *(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7d))) {
        wTurnLast = *(ushort *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7d);
        iSetLast = i;
      }
    }
    if ((iSetLast != -1) && (wTurnLast + 0x28 <= game.turn)) {
      if (iSetLast < 5) {
        iVar3 = 6;
      }
      else {
        iVar3 = 1;
      }
      if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + iVar3 * 0x93 + 0x7b) >> 9 & 1) == 0) {
        uVar1 = *(undefined2 *)(idPlayer * 4 + 0x14e);
        iVar4 = *(int *)(idPlayer * 4 + 0x14c) + iVar3 * 0x93;
        if (*(int *)(iVar4 + 0x85) != 0) {
          return;
        }
        if (*(int *)(iVar4 + 0x83) != 0) {
          return;
        }
      }
      if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + (iVar3 + 2) * 0x93 + 0x7b) >> 9 & 1) ==
          0) {
        uVar1 = *(undefined2 *)(idPlayer * 4 + 0x14e);
        iVar4 = *(int *)(idPlayer * 4 + 0x14c) + (iVar3 + 2) * 0x93;
        if (*(int *)(iVar4 + 0x85) != 0) {
          return;
        }
        if (*(int *)(iVar4 + 0x83) != 0) {
          return;
        }
      }
      FCreateAiStarbase(iVar3,1,-1,-1);
      FCreateAiStarbase(iVar3 + 2,2,-1,-1);
    }
  }
  return;
}



// ======================================================================
// Function: EnsureMacintiStarbaseDesigns
// Address: 1090:76e4
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109079ee) */

void EnsureMacintiStarbaseDesigns(byte *rgSB)

{
  undefined2 uVar1;
  undefined4 uVar2;
  undefined4 uVar3;
  short sVar4;
  int iVar5;
  short iNew;
  short j;
  short i;
  short cAge;
  short iOld;
  short k;
  
  *rgSB = 0;
  i = 1;
  do {
    if (3 < i) {
      iOld = -1;
      for (i = 1; i < 4; i = i + 1) {
        if ((1 < rgSB[i]) &&
           (((iOld == -1 || (rgSB[iOld] < rgSB[i])) ||
            ((rgSB[i] == rgSB[iOld] &&
             (*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7d) <
              *(uint *)(*(int *)(idPlayer * 4 + 0x14c) + iOld * 0x93 + 0x7d))))))) {
          iOld = i;
        }
      }
      for (i = 1; i < 4; i = i + 1) {
        if ((1 < rgSB[i]) && (i != iOld)) {
          rgSB[i] = 0;
        }
      }
      i = 0;
      do {
        if (1 < i) {
          for (i = 4; i < 10; i = i + 1) {
            rgSB[i] = (*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1)
                      != 0;
          }
          uVar2 = *(undefined4 *)(idPlayer * 4 + 0x14c);
          uVar3 = *(undefined4 *)(idPlayer * 4 + 0x14c);
          if (*(uint *)((int)uVar3 + 0x2c9) < *(uint *)((int)uVar2 + 0x482)) {
            iNew = 7;
            iOld = 4;
          }
          else {
            iNew = 4;
            iOld = 7;
          }
          if (game.turn -
              *(int *)(*(int *)(idPlayer * 4 + 0x14c) + iOld * 0x93 + 0x7d) < 0x1e) {
            j._0_1_ = 2;
          }
          else {
            j._0_1_ = 3;
          }
          for (i = iOld; i < iOld + 3; i = i + 1) {
            rgSB[i] = (byte)j;
          }
          iVar5 = *(int *)(*(int *)(idPlayer * 4 + 0x14c) + iNew * 0x93) + -0x20;
          if ((iVar5 < 4) && (rgSB[3] = 2, iVar5 < 3)) {
            rgSB[2] = 2;
          }
          return;
        }
        for (j = 0; j < 3; j = j + 1) {
          if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + (i * 3 + 4 + j) * 0x93 + 0x7b) >> 9
              & 1) == 0) {
            uVar1 = *(undefined2 *)(idPlayer * 4 + 0x14e);
            iVar5 = *(int *)(idPlayer * 4 + 0x14c) + (i * 3 + 4 + j) * 0x93;
            if ((*(int *)(iVar5 + 0x85) != 0) || (*(int *)(iVar5 + 0x83) != 0)) break;
          }
        }
        if (j == 3) {
          for (j = 0; j < 3; j = j + 1) {
            k = 5;
            while ((2 < k && (sVar4 = FCreateAiStarbase(i * 3 + 4 + j,j + 1,
                                                        (uint)*(byte *)(k + 0x76de),k + -1),
                             sVar4 == 0))) {
              k = k + -1;
            }
          }
        }
        i = i + 1;
      } while( true );
    }
    if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) {
      uVar1 = *(undefined2 *)(idPlayer * 4 + 0x14e);
      iVar5 = *(int *)(idPlayer * 4 + 0x14c) + i * 0x93;
      if ((*(int *)(iVar5 + 0x83) == 0) && (*(int *)(iVar5 + 0x85) == 0)) goto LAB_1090_7759;
      iVar5 = game.turn - *(int *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7d);
      if (iVar5 < 0x23) {
        if (((game.turn < 0x1a) || (i != 1)) ||
           (*(char *)(*(int *)(idPlayer * 4 + 0x14c) + 0x10d) == '\b')) {
          rgSB[i] = 0;
        }
        else {
          rgSB[1] = 3;
        }
      }
      else if (iVar5 < 0x32) {
        rgSB[i] = 2;
      }
      else {
        rgSB[i] = 3;
      }
    }
    else {
LAB_1090_7759:
      if (i < 3) {
        sVar4 = 1;
      }
      else {
        sVar4 = 2;
      }
      sVar4 = FCreateAiStarbase(i,sVar4,(uint)*(byte *)(i + 0x76dd),i);
      if (sVar4 == 0) {
        rgSB[i] = 1;
      }
      else {
        rgSB[i] = 0;
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FCreateAiStarbase
// Address: 1090:7bca
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lphs */

short FCreateAiStarbase(short ishdef,short iLevel,short aisb,short isb)

{
  uint *puVar1;
  SHDEF *pSVar2;
  SHDEF *pSVar3;
  uint uVar4;
  ushort uVar5;
  short sVar6;
  int iVar7;
  SHDEF *pSVar8;
  SHDEF *pSVar9;
  undefined2 unaff_SS;
  HS *lphs;
  SHDEF shdef;
  short i;
  
  if (aisb < 0) {
    if ((((ishdef == 1) || (ishdef == 3)) || (ishdef == 6)) || (ishdef == 8)) {
      aisb = 0xc;
      isb = 0;
      if (iLevel == 2) {
        iLevel = 3;
      }
    }
    else {
      aisb = 0;
      isb = 2;
    }
  }
  sVar6 = FCreateAiShdef(-1,isb,(byte *)CONCAT22(0x1090,(byte *)(aisb + 0x7688)));
  if (sVar6 == 0) {
    sVar6 = 0;
  }
  else {
    pSVar8 = (SHDEF *)&shdefBuild;
    pSVar9 = &shdef;
    for (iVar7 = 0x49; iVar7 != 0; iVar7 = iVar7 + -1) {
      pSVar3 = pSVar9;
      pSVar9 = (SHDEF *)(pSVar9->hul).rgTech;
      pSVar2 = pSVar8;
      pSVar8 = (SHDEF *)(pSVar8->hul).rgTech;
      (pSVar3->hul).ihuldef = (pSVar2->hul).ihuldef;
    }
    *(char *)&(pSVar9->hul).ihuldef = (char)(pSVar8->hul).ihuldef;
    if (iLevel < 3) {
      for (i = 0; i < (int)(uint)shdef.hul.chs; i = i + 1) {
        lphs = (HS *)CONCAT22(unaff_SS,shdef.hul.rghs + i);
        if (shdef.hul.rghs[i].wFlags_0x2 >> 8 < 4) {
          if (((iLevel < 2) &&
              (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 4)) &&
             ((lphs->grhst == hstSpecialSB || (1 < shdef.hul.rghs[i].wFlags_0x2 >> 8)))) {
            uVar5 = shdef.hul.rghs[i].wFlags_0x2;
            puVar1 = &shdef.hul.rghs[i].wFlags_0x2;
            *puVar1 = *puVar1 & 0xff;
            puVar1 = &shdef.hul.rghs[i].wFlags_0x2;
            *puVar1 = *puVar1 | uVar5 - 0x100 & 0xff00;
          }
        }
        else {
          uVar4 = shdef.hul.rghs[i].wFlags_0x2;
          puVar1 = &shdef.hul.rghs[i].wFlags_0x2;
          *puVar1 = *puVar1 & 0xff;
          puVar1 = &shdef.hul.rghs[i].wFlags_0x2;
          *puVar1 = *puVar1 | ((uVar4 >> 8) >> (3U - (char)iLevel & 0x1f)) << 8;
        }
      }
    }
    shdef.wFlags = shdef.wFlags & 0x83ff | (ishdef + 0x10U & 0x1f) << 10;
    PickANameAndBmp(&shdef,idsGuardianAngel,0xd,shdef.hul.ibmp);
    sVar6 = FChangeAiShdef(&shdef,ishdef + 0x10);
  }
  return sVar6;
}



// ======================================================================
// Function: FAIFling
// Address: 1090:7dd6
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10907e96) */
/* WARNING: Removing unreachable block (ram,0x10907e76) */
/* WARNING: Removing unreachable block (ram,0x10907e9b) */
/* WARNING: Removing unreachable block (ram,0x10907ec3) */
/* WARNING: Removing unreachable block (ram,0x10907ec8) */
/* WARNING: Removing unreachable block (ram,0x1090816b) */
/* WARNING: Removing unreachable block (ram,0x109083b5) */
/* WARNING: Removing unreachable block (ram,0x109083df) */
/* WARNING: Removing unreachable block (ram,0x109083fd) */

short FAIFling(PLANET *lppl,long *rgResAvail)

{
  uint uVar1;
  long lVar2;
  uint uVar3;
  short sVar4;
  PLANET *pPVar5;
  int iVar6;
  long *plVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar8;
  ulong uVar9;
  ulong uVar10;
  long lVar11;
  ushort in_stack_0000ffc4;
  short iKeep;
  PROD *lpprod;
  short cFound;
  PLANET *lpplBest;
  short iLevelBest;
  short fTwoMAs;
  short i;
  undefined4 dBigAssPacket;
  undefined4 d2;
  short iT;
  int dy;
  int local_e;
  short pt;
  int local_a;
  PLANET *lpplHit;
  
  uVar9 = CONCAT22(unaff_SI,unaff_DI);
  cFound = 0;
  iLevelBest = -1;
  if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 4) {
    for (i = 0; i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
      uVar10 = __aFulshr(uVar9,in_stack_0000ffc4);
      if (((((uint)uVar10 & 7) == 1) &&
          (uVar10 = __aFulshr(uVar9,in_stack_0000ffc4), 0xd < ((uint)uVar10 & 0x7f))) &&
         (uVar10 = __aFulshr(uVar9,in_stack_0000ffc4), ((uint)uVar10 & 0x7f) < 0x12)) {
        return 0;
      }
    }
    if (1 < (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7)) {
      uVar3 = *(uint *)rgResAvail + *(uint *)(rgResAvail + 1);
      iVar6 = *(int *)((int)rgResAvail + 2) + *(int *)((int)rgResAvail + 6) +
              (uint)CARRY2(*(uint *)rgResAvail,*(uint *)(rgResAvail + 1)) +
              *(int *)((int)rgResAvail + 10) + (uint)CARRY2(uVar3,*(uint *)(rgResAvail + 2));
      if ((-1 < iVar6) && ((0 < iVar6 || (3000 < uVar3 + *(uint *)(rgResAvail + 2))))) {
        uVar8 = (undefined2)((ulong)lppl >> 0x10);
        if (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) &&
           ((sVar4 = IWarpMAFromLppl(lppl,&fTwoMAs), 9 < sVar4 &&
            (sVar4 = Random(4), sVar4 == 0)))) {
          pt = ((POINT *)rgptPlan + lppl->id)->x;
          local_a = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
          for (iT = 0; iT < 3; iT = iT + 1) {
            plVar7 = ((PLANET *)lppl)->rgwtMin + iT;
            uVar3 = *(uint *)((int)plVar7 + 2);
            if ((-1 < (int)uVar3) && ((0 < (int)uVar3 || (0x30d4 < *(uint *)plVar7)))) break;
          }
          dBigAssPacket._0_2_ = *(undefined2 *)(fTwoMAs * 4 + 0x7dce);
          dBigAssPacket._2_2_ = *(undefined2 *)(fTwoMAs * 4 + 0x7dd0);
          if (iT < 3) {
            dBigAssPacket =
                 __aFulmul(CONCAT22(dBigAssPacket._2_2_,(undefined2)dBigAssPacket),3);
          }
          pPVar5 = (PLANET *)lpPlanets + cPlanet;
          lpplHit = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
          while ((PLANET *)lpplHit < pPVar5) {
            uVar8 = (undefined2)((ulong)lpplHit >> 0x10);
            if ((((((PLANET *)lpplHit)->iPlayer != -1) &&
                 (((PLANET *)lpplHit)->iPlayer != idPlayer)) &&
                (game.turn <= ((PLANET *)lpplHit)->turn + 2U)) &&
               ((((PLANET *)lpplHit)->uGuesses >> 0xc < 0xe ||
                ((((PLANET *)lpplHit)->uGuesses & 0xfff) < 0x2ee)))) {
              sVar4 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lpplHit)->iPlayer,
                                        rsMajorAdv);
              if (sVar4 != raMacintosh) {
                uVar8 = (undefined2)((ulong)lpplHit >> 0x10);
                if ((((PLANET *)lpplHit)->wFlags_0x4 >> 9 & 1) != 0) {
                  sVar4 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lpplHit)->iPlayer
                                            ,rsMajorAdv);
                  if (sVar4 == raMassAccel) goto LAB_1090_819e;
                }
                iVar6 = pt - ((POINT *)rgptPlan + lpplHit->id)->x;
                dy = local_a - *(int *)((int)&rgptPlan[0].y + lpplHit->id * 4);
                local_e = dy >> 0xf;
                uVar9 = __aFulmul((long)dy,(long)dy);
                uVar10 = __aFulmul((long)iVar6,(long)iVar6);
                d2 = uVar10 + uVar9;
                if (d2 <= (long)dBigAssPacket) {
                  cFound = cFound + 1;
                  sVar4 = Random(cFound);
                  if (sVar4 == 0) {
                    iLevelBest = 0xd;
                    lpplBest = lpplHit;
                  }
                }
              }
            }
LAB_1090_819e:
            lpplHit = (PLANET *)CONCAT22(lpplHit._2_2_,(PLANET *)lpplHit + 1);
          }
          if (9 < iLevelBest) {
            sel.pl.lStarbase._2_2_ =
                 sel.pl.lStarbase._2_2_ & 0xc000 | (iLevelBest - 4U & 0xf) << 10 |
                 lpplBest->id + 1U & 0x3ff;
            FLookupPlanet(-1,(PLANET *)&sel.pl);
            if ((-1 < *(int *)((int)rgResAvail + 10)) &&
               ((0 < *(int *)((int)rgResAvail + 10) ||
                ((char *)rgbCur + 0x289 <= *(char **)(rgResAvail + 2))))) {
              sVar4 = Random(3);
              if (sVar4 != 0) {
                AddItemToQueue(0x10,0x50,grobjPlanet,1);
              }
            }
            if ((((*(int *)((int)rgResAvail + 2) < 0) ||
                 (((*(int *)((int)rgResAvail + 2) < 1 && (*(uint *)rgResAvail < 0xbb9)) ||
                  (*(int *)((int)rgResAvail + 6) < 0)))) ||
                (((*(int *)((int)rgResAvail + 6) < 1 && (*(uint *)(rgResAvail + 1) < 0xfa1)) ||
                 (*(int *)((int)rgResAvail + 10) < 0)))) ||
               ((*(int *)((int)rgResAvail + 10) < 1 && (*(uint *)(rgResAvail + 2) < 0xbb9)))) {
              if (((*(int *)((int)rgResAvail + 2) < 0) ||
                  (((*(int *)((int)rgResAvail + 2) < 1 && (*(uint *)rgResAvail < 0x5dd)) ||
                   (*(int *)((int)rgResAvail + 6) < 0)))) ||
                 (((*(int *)((int)rgResAvail + 6) < 1 && (*(uint *)(rgResAvail + 1) < 0x8cb)) ||
                  ((*(int *)((int)rgResAvail + 10) < 0 ||
                   ((*(int *)((int)rgResAvail + 10) < 1 && (*(uint *)(rgResAvail + 2) < 0x5dd)))))))
                 ) {
                for (iT = 0; iT < 3; iT = iT + 1) {
                  if (iT == 1) {
                    uVar3 = 0x9c4;
                  }
                  else {
                    uVar3 = 0x4e2;
                  }
                  uVar1 = *(uint *)((int)(rgResAvail + iT) + 2);
                  if ((-1 < (int)uVar1) &&
                     ((0 < (int)uVar1 || (uVar3 < *(uint *)(rgResAvail + iT))))) {
                    uVar1 = *(uint *)(rgResAvail + iT);
                    lVar11 = __aFldiv(CONCAT22(*(uint *)((int)(rgResAvail + iT) + 2) -
                                                       (uint)(uVar1 < uVar3),uVar1 - uVar3),200);
                    lVar2 = lVar11;
                    if (lVar11 < 2) {
                      lVar2 = 1;
                    }
                    if (lVar2 < 0x1a) {
                      if (lVar11 < 2) {
                        lVar11 = 1;
                      }
                    }
                    else {
                      lVar11 = 0x19;
                    }
                    AddItemToQueue(iT + 0xe,(ushort)lVar11,grobjPlanet,1);
                  }
                }
              }
              else {
                AddItemToQueue(0x11,0xf,grobjPlanet,1);
              }
            }
            else {
              AddItemToQueue(0x11,0x1e,grobjPlanet,1);
            }
            return 1;
          }
        }
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: IshdefAiSBLatestOF
// Address: 1090:8458
// Segment: MEMORY_AIU
// ======================================================================


short IshdefAiSBLatestOF(void)

{
  undefined4 uVar1;
  undefined4 uVar2;
  short sVar3;
  
  uVar1 = *(undefined4 *)(idPlayer * 4 + 0x14c);
  if (((*(uint *)((int)uVar1 + 0x3ed) >> 9 & 1) == 0) &&
     (uVar1 = *(undefined4 *)(idPlayer * 4 + 0x14c),
     uVar2 = *(undefined4 *)(idPlayer * 4 + 0x14c),
     *(uint *)((int)uVar1 + 0x110) < *(uint *)((int)uVar2 + 0x3ef))) {
    sVar3 = 6;
  }
  else {
    sVar3 = 1;
  }
  return sVar3;
}



// ======================================================================
// Function: IshdefAiSBLatest
// Address: 1090:84be
// Segment: MEMORY_AIU
// ======================================================================


short IshdefAiSBLatest(void)

{
  undefined4 uVar1;
  undefined4 uVar2;
  short sVar3;
  
  uVar1 = *(undefined4 *)(idPlayer * 4 + 0x14c);
  if (((*(uint *)((int)uVar1 + 0x35a) >> 9 & 1) == 0) &&
     (uVar1 = *(undefined4 *)(idPlayer * 4 + 0x14c),
     uVar2 = *(undefined4 *)(idPlayer * 4 + 0x14c),
     *(uint *)((int)uVar1 + 0x7d) < *(uint *)((int)uVar2 + 0x35c))) {
    sVar3 = 5;
  }
  else {
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: QueueAiStarbases
// Address: 1090:8524
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10908793) */
/* WARNING: Removing unreachable block (ram,0x109087b3) */
/* WARNING: Removing unreachable block (ram,0x109087b8) */

void QueueAiStarbases(PROD *rgprod,short ishdefSBLatest)

{
  int iVar1;
  PLANET *pPVar2;
  byte *pbVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar4;
  undefined2 uVar5;
  ulong uVar6;
  ulong uVar7;
  PLANET *pPVar8;
  PROD *lpprod;
  short i;
  PLANET *lppl;
  
  uVar7 = CONCAT22(unaff_SI,unaff_DI);
  if (((ishdefSBLatest != -1) &&
      (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 5)) &&
     (((((uint)gd.grBits >> 0xb & 1) == 0 &&
       ((((int)game.lid != -0x10b7 || (game.lid._2_2_ != 0x8c)) ||
        (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 1)))) ||
      (game.turn < 0x1f)))) {
    pPVar2 = (PLANET *)lpPlanets + cPlanet;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    pPVar8 = (PLANET *)lpPlanets;
    while ((PLANET *)lppl < pPVar2) {
      uVar5 = (undefined2)((ulong)lppl >> 0x10);
      if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 4) {
        if ((((PLANET *)lppl)->iPlayer == idPlayer) &&
           (ishdefSBLatest = iBuildCyberStarbase(lppl), ishdefSBLatest != -1)) {
LAB_1090_870e:
          ChangeMainObjSel(1,lppl->id);
          InitProduction(rgprod);
          i = 0;
          while ((i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac &&
                 ((uVar6 = __aFulshr(uVar7,(ushort)pPVar8), ((uint)uVar6 & 7) != 2 ||
                  (uVar6 = __aFulshr(uVar7,(ushort)pPVar8), ((uint)uVar6 & 0x7f) < 0x10)))))
          {
            i = i + 1;
          }
          if (i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
            FinishProduction(0);
          }
          else {
            AddItemToQueue(ishdefSBLatest + 0x10,1,grobjFleet,1);
            FinishProduction(1);
          }
        }
      }
      else if (((((PLANET *)lppl)->iPlayer == idPlayer) &&
               (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0 ||
                (9 < (*(uint *)&((PLANET *)lppl)->lStarbase & 0xf))))) &&
              ((iVar1 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe), -1 < iVar1 &&
               (((0 < iVar1 || (0x4f < *(uint *)(((PLANET *)lppl)->rgwtMin + 3))) &&
                (((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] == 0)))))) {
        i = 0;
        while( true ) {
          uVar4 = (undefined2)((ulong)vlpbAiData >> 0x10);
          pbVar3 = (byte *)vlpbAiData;
          if ((*(int *)(pbVar3 + 2) <= i) || (*(int *)(pbVar3 + i * 0x14 + 4) == lppl->id)) break;
          i = i + 1;
        }
        if (i != *(int *)(pbVar3 + 2)) goto LAB_1090_870e;
      }
      lppl = (PLANET *)CONCAT22(uVar5,(PLANET *)lppl + 1);
    }
  }
  return;
}



// ======================================================================
// Function: FUpgradeAiStarbase
// Address: 1090:882a
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109088e1) */
/* WARNING: Removing unreachable block (ram,0x109088c1) */
/* WARNING: Removing unreachable block (ram,0x109088e6) */
/* WARNING: Variable defined which should be unmapped: ishdef */

short FUpgradeAiStarbase(PLANET *lppl,short ishdefSBLatest)

{
  uint uVar1;
  short sVar2;
  short sVar3;
  int iVar4;
  PLANET *pPVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar6;
  ulong uVar7;
  ulong uVar8;
  short ishdef;
  PROD *lpprod;
  short isbNew;
  short pctUpg;
  short i;
  short iDesigns;
  short isbCur;
  
  uVar8 = CONCAT22(unaff_SI,unaff_DI);
  if (ishdefSBLatest == -1) {
    return 0;
  }
  uVar6 = (undefined2)((ulong)lppl >> 0x10);
  pPVar5 = (PLANET *)lppl;
  if ((pPVar5->wFlags_0x4 >> 9 & 1) != 0) {
    for (i = 0; i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
      uVar7 = __aFulshr(uVar8,ishdef);
      if ((((uint)uVar7 & 7) == 2) &&
         (uVar7 = __aFulshr(uVar8,ishdef), 0xf < ((uint)uVar7 & 0x7f))) {
        return 0;
      }
    }
  }
  if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 5) {
    if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 4) &&
       (game.turn < 0x28)) {
      return 0;
    }
    if ((pPVar5->wFlags_0x4 >> 9 & 1) != 0) {
      if (((((*(uint *)&pPVar5->lStarbase & 0xf) == 1) || ((*(uint *)&pPVar5->lStarbase & 0xf) == 3)
           ) || ((*(uint *)&pPVar5->lStarbase & 0xf) == 6)) ||
         ((*(uint *)&pPVar5->lStarbase & 0xf) == 8)) {
        iDesigns = 2;
        ishdefSBLatest = IshdefAiSBLatestOF();
      }
      else {
        iDesigns = 3;
      }
      if (((*(uint *)&pPVar5->lStarbase & 0xf) < (uint)ishdefSBLatest) ||
         ((uint)(ishdefSBLatest + (iDesigns + -1) * 2) < (*(uint *)&pPVar5->lStarbase & 0xf))) {
        pctUpg = (game.turn -
                 *(int *)(*(int *)(idPlayer * 4 + 0x14c) + ishdefSBLatest * 0x93 + 0x7d)) +
                 -10;
        if (pctUpg < 0) {
          pctUpg = 0;
        }
        else if (pctUpg < 0x32) {
          pctUpg = pctUpg >> 1;
        }
        sVar3 = Random(100);
        if (sVar3 < pctUpg + 5) {
          if ((((*(uint *)&pPVar5->lStarbase & 0xf) == 1) ||
              ((*(uint *)&pPVar5->lStarbase & 0xf) == 3)) ||
             (((*(uint *)&pPVar5->lStarbase & 0xf) == 6 ||
              ((*(uint *)&pPVar5->lStarbase & 0xf) == 8)))) {
            iVar4 = ishdefSBLatest + (*(uint *)&pPVar5->lStarbase & 0xf) % 5 + -1;
          }
          else {
            iVar4 = ishdefSBLatest + (*(uint *)&pPVar5->lStarbase & 0xf) % 5;
          }
          AddItemToQueue(iVar4 + 0x10,1,grobjFleet,1);
          return 1;
        }
      }
      else if ((((int)(((ulong)*(uint *)&pPVar5->lStarbase & 0xffff000f) % 5) < (iDesigns + -1) * 2)
               && ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) +
                              ((*(uint *)&pPVar5->lStarbase & 0xf) + 2) * 0x93 + 0x7b) >> 9 & 1) ==
                   0)) && (sVar3 = Random(100), sVar3 < 6)) {
        i = 0;
        while( true ) {
          if (2 < i) {
            AddItemToQueue((*(uint *)&pPVar5->lStarbase & 0xf) + 0x12,1,grobjFleet,1);
            return 1;
          }
          uVar1 = *(uint *)((int)(pPVar5->rgwtMin + i) + 2);
          if (((int)uVar1 < 1) && (((int)uVar1 < 0 || (*(uint *)(pPVar5->rgwtMin + i) < 200))))
          break;
          i = i + 1;
        }
        return 0;
      }
    }
    return 0;
  }
  uVar1 = *(uint *)&pPVar5->lStarbase & 0xf;
  if ((vAiMacRecycleSB[uVar1] != 3) &&
     ((vAiMacRecycleSB[uVar1] != 2 || (sVar3 = Random(100), 9 < sVar3)))) {
    if ((3 < uVar1) && (((uVar1 != 6 && (uVar1 != 9)) && (sVar3 = Random(100), sVar3 < 8)))
       ) {
      isbNew = uVar1 + 1;
      goto AIU_LDoMacUpgrade2;
    }
    if (((3 < uVar1) || (sVar3 = PctPlanetCapacity(lppl), sVar3 < 0x10)) ||
       (sVar2 = Random(100), (sVar3 + -0xf) * 6 <= sVar2)) {
      return 0;
    }
  }
  isbNew = uVar1;
  if (uVar1 < 4) {
    do {
      isbNew = isbNew + 1;
      if (8 < isbNew) break;
    } while (vAiMacRecycleSB[isbNew] != 0);
  }
  else {
    isbNew = uVar1 + 3;
    if (9 < (uint)isbNew) {
      isbNew = uVar1 - 3;
    }
  }
AIU_LDoMacUpgrade2:
  AddItemToQueue(isbNew + 0x10,1,grobjFleet,1);
  return 1;
}



// ======================================================================
// Function: FQueueAiTerraforming
// Address: 1090:8d28
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10908f57) */
/* WARNING: Removing unreachable block (ram,0x10908f07) */
/* WARNING: Removing unreachable block (ram,0x10908de1) */
/* WARNING: Removing unreachable block (ram,0x10908e09) */
/* WARNING: Removing unreachable block (ram,0x10908f37) */
/* WARNING: Removing unreachable block (ram,0x10908f5c) */

short FQueueAiTerraforming(PLANET *lppl,long *rgResAvail,long *rgResCost)

{
  uint *puVar1;
  int iVar2;
  short sVar3;
  uint uVar4;
  PLANET *pPVar5;
  undefined2 unaff_SI;
  PROD *pPVar6;
  undefined2 unaff_DI;
  undefined2 uVar7;
  ulong uVar8;
  ulong uVar9;
  GrobjClass grobj;
  ushort in_stack_0000ffe0;
  PROD *lpprod;
  undefined4 rgItemCost;
  short dEnv;
  short j;
  short i;
  
  uVar9 = CONCAT22(unaff_SI,unaff_DI);
  if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 4) {
    uVar7 = (undefined2)((ulong)lppl >> 0x10);
    pPVar5 = (PLANET *)lppl;
    iVar2 = *(int *)((int)pPVar5->rgwtMin + 0xe);
    if ((0 < iVar2) || ((-1 < iVar2 && (199 < *(uint *)(pPVar5->rgwtMin + 3))))) {
      for (i = 0; i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
        uVar8 = __aFulshr(uVar9,in_stack_0000ffe0);
        if ((((uint)uVar8 & 7) == 1) &&
           (uVar8 = __aFulshr(uVar9,in_stack_0000ffe0), ((uint)uVar8 & 0x7f) == 0xc)) {
          return 0;
        }
      }
      j = -1;
      dEnv = 0;
      for (i = 0; i < 3; i = i + 1) {
        in_stack_0000ffe0 = (ushort)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
        sVar3 = _abs((int)pPVar5->rgEnvVar[i] - in_stack_0000ffe0);
        if (dEnv < sVar3) {
          j = i;
          in_stack_0000ffe0 = (ushort)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
          dEnv = _abs((int)pPVar5->rgEnvVar[i] - in_stack_0000ffe0);
        }
      }
      if (j != -1) {
        for (i = 0; i < cProdGlob; i = i + 1) {
          uVar8 = __aFulshr(uVar9,in_stack_0000ffe0);
          if (((((uint)uVar8 & 7) == 1) &&
              (uVar8 = __aFulshr(uVar9,in_stack_0000ffe0), ((uint)uVar8 & 0x7f) == 0xc)) &&
             (((pProdGlob + i)->dwFlags & 0x3ff) != 0)) {
            sVar3 = 1;
            grobj = grobjPlanet;
            if (((uint)(pProdGlob + i)->dwFlags & 0x3ff) < 5) {
              uVar4 = (uint)(pProdGlob + i)->dwFlags & 0x3ff;
            }
            else {
              uVar4 = 4;
            }
            uVar9 = __aFulshr(CONCAT22(1,uVar4),1);
            AddItemToQueue((uint)uVar9 & 0x7f,uVar4,grobj,sVar3);
            uVar7 = *(undefined2 *)((int)&pProdGlob[i].dwFlags + 2);
            pPVar6 = pProdGlob + i;
            *(uint *)&pPVar6->dwFlags = (uint)(pProdGlob + i)->dwFlags & 0xfc00;
            *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar7;
            GetProductionCosts
                      (lppl,(PROD *)CONCAT22(0x1120,pProdGlob + i),&rgItemCost,
                       idPlayer,1);
            for (j = 0; j < 4; j = j + 1) {
              if (((uint)(pProdGlob + i)->dwFlags & 0x3ff) < 5) {
                uVar4 = (uint)(pProdGlob + i)->dwFlags & 0x3ff;
              }
              else {
                uVar4 = 4;
              }
              uVar9 = __aFulmul(CONCAT22(*(undefined2 *)((int)&rgItemCost + j * 4 + 2),
                                                 *(undefined2 *)(&rgItemCost + j)),(ulong)uVar4);
              puVar1 = (uint *)(rgResCost + j);
              uVar4 = *puVar1;
              *puVar1 = *puVar1 + (uint)uVar9;
              puVar1 = (uint *)((int)(rgResCost + j) + 2);
              *puVar1 = *puVar1 + (int)(uVar9 >> 0x10) + (uint)CARRY2(uVar4,(uint)uVar9);
            }
            return 1;
          }
        }
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: FQueueAiScanner
// Address: 1090:90d6
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1090920e) */
/* WARNING: Removing unreachable block (ram,0x1090916c) */
/* WARNING: Removing unreachable block (ram,0x10909147) */
/* WARNING: Removing unreachable block (ram,0x10909167) */
/* WARNING: Removing unreachable block (ram,0x109091e6) */
/* WARNING: Removing unreachable block (ram,0x10909213) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10909248) */
/* WARNING: Removing unreachable block (ram,0x10909194) */
/* WARNING: Removing unreachable block (ram,0x10909243) */
/* WARNING: Removing unreachable block (ram,0x10909199) */

short FQueueAiScanner(PLANET *lppl,long *rgResAvail,long *rgResCost)

{
  uint *puVar1;
  uint uVar2;
  uint uVar3;
  int iVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar5;
  ulong uVar6;
  undefined4 uVar7;
  short mdAddItem;
  PROD *lpprod;
  undefined4 rgItemCost;
  short j;
  short i;
  
  uVar6 = CONCAT22(unaff_SI,unaff_DI);
  lpprod._0_2_ = (PROD *)(PLPROD *)lpplProdGlob;
  for (i = 0; lpprod._0_2_ = (PROD *)((PLPROD *)(PROD *)lpprod + 1), iVar4 = cProdGlob,
      i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
    uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod);
    if (((((uint)uVar5 & 7) == 1) &&
        (uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), 0x11 < ((uint)uVar5 & 0x7f))) &&
       (uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), ((uint)uVar5 & 0x7f) < 0x1b)) {
      return 0;
    }
  }
  do {
    i = iVar4 + -1;
    if (i < 0) break;
    uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod);
    iVar4 = i;
  } while (((((uint)uVar5 & 7) != 1) ||
           (uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), iVar4 = i,
           ((uint)uVar5 & 0x7f) < 0x12)) ||
          (uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), iVar4 = i,
          0x1a < ((uint)uVar5 & 0x7f)));
  if (-1 < i) {
    GetProductionCosts
              (lppl,(PROD *)CONCAT22(0x1120,pProdGlob + i),&rgItemCost,idPlayer,1);
    for (j = 0; j < 4; j = j + 1) {
      iVar4 = *(int *)((int)&rgItemCost + j * 4 + 2);
      if ((-1 < iVar4) && ((0 < iVar4 || (*(int *)(&rgItemCost + j) != 0)))) {
        puVar1 = (uint *)(rgResCost + j);
        iVar4 = *(int *)((int)&rgItemCost + j * 4 + 2) + *(uint *)((int)(rgResCost + j) + 2) +
                (uint)CARRY2(*(uint *)(&rgItemCost + j),*puVar1);
        uVar2 = *(uint *)((int)(rgResAvail + j) + 2);
        if (((int)uVar2 <= iVar4) &&
           (((int)uVar2 < iVar4 ||
            (*(uint *)(rgResAvail + j) < *(uint *)(&rgItemCost + j) + *puVar1)))) break;
      }
    }
    if (j == 4) {
      mdAddItem = 1;
      uVar7 = 0x10001;
      uVar6 = __aFulshr(0x10001,1);
      AddItemToQueue((uint)uVar6 & 0x7f,(ushort)uVar7,(GrobjClass)((ulong)uVar7 >> 0x10),mdAddItem);
      for (j = 0; j < 4; j = j + 1) {
        uVar3 = *(uint *)(&rgItemCost + j);
        iVar4 = *(int *)((int)&rgItemCost + j * 4 + 2);
        puVar1 = (uint *)(rgResCost + j);
        uVar2 = *puVar1;
        *puVar1 = *puVar1 + uVar3;
        puVar1 = (uint *)((int)(rgResCost + j) + 2);
        *puVar1 = *puVar1 + iVar4 + (uint)CARRY2(uVar2,uVar3);
      }
      return 1;
    }
  }
  return 0;
}



// ======================================================================
// Function: FQueueAiDefenses
// Address: 1090:939a
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10909524) */
/* WARNING: Removing unreachable block (ram,0x109094d4) */
/* WARNING: Removing unreachable block (ram,0x1090946b) */
/* WARNING: Removing unreachable block (ram,0x10909493) */
/* WARNING: Removing unreachable block (ram,0x10909504) */
/* WARNING: Removing unreachable block (ram,0x10909529) */
/* WARNING: Variable defined which should be unmapped: lpprod */

short FQueueAiDefenses(PLANET *lppl,long *rgResAvail,long *rgResCost)

{
  int iVar1;
  PLANET *pPVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar3;
  long lVar4;
  ulong uVar5;
  ulong uVar6;
  PROD *lpprod;
  short j;
  short i;
  
  uVar6 = CONCAT22(unaff_SI,unaff_DI);
  uVar3 = (undefined2)((ulong)lppl >> 0x10);
  pPVar2 = (PLANET *)lppl;
  iVar1 = *(int *)((int)pPVar2->rgwtMin + 0xe);
  if ((-1 < iVar1) && ((0 < iVar1 || (0x63f < *(uint *)(pPVar2->rgwtMin + 3))))) {
    lVar4 = __aFldiv(CONCAT22(*(undefined2 *)((int)pPVar2->rgwtMin + 0xe),
                                      (int)pPVar2->rgwtMin[3]),0x50);
    if ((0xffff < lVar4) ||
       ((-1 < lVar4 && ((*(uint *)(pPVar2->rgbImp + 4) & 0xfff) < (uint)lVar4)))) {
      lpprod._0_2_ = (PROD *)(PLPROD *)lpplProdGlob;
      for (i = 0; lpprod._0_2_ = (PROD *)((PLPROD *)(PROD *)lpprod + 1),
          i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
        uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod);
        if ((((uint)uVar5 & 7) == 1) &&
           (uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), ((uint)uVar5 & 0x7f) == 9)) {
          return 0;
        }
      }
      i = 0;
      while ((i < cProdGlob &&
             (((uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), ((uint)uVar5 & 7) != 1 ||
               (uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), ((uint)uVar5 & 0x7f) != 9))
              || (((pProdGlob + i)->dwFlags & 0x3ff) == 0))))) {
        i = i + 1;
      }
      if (cProdGlob <= i) {
        return 0;
      }
      j = (uint)(pProdGlob + i)->dwFlags & 0x3ff;
      if (4 < (uint)j) {
        j = 4;
      }
      AddItemToQueue(9,j,grobjPlanet,1);
      return 1;
    }
  }
  return 0;
}



// ======================================================================
// Function: HandleBasicAiTasks
// Address: 1090:95a4
// Segment: MEMORY_AIU
// ======================================================================


void HandleBasicAiTasks
          (short iroCur,PROD *rgprod,short ishdefSBLatest,long *rgResAvail,long *rgResCost)

{
  PLANET *pPVar1;
  int iVar2;
  int iVar3;
  uint uVar4;
  uint uVar5;
  short sVar6;
  short fWrite;
  short ipl;
  short i;
  PLANET *lppl;
  
  KeepFleetsMoving();
  QueueAiStarbases(rgprod,ishdefSBLatest);
  for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
                    /* WARNING: Load size is inaccurate */
    pPVar1 = ((PLANET **)vrglpplAi)[ipl];
    iVar2 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
    lppl = (PLANET *)CONCAT22(iVar2,pPVar1);
    if ((pPVar1 == (PLANET *)0x0) && (iVar2 == 0)) break;
    if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) {
      iVar3 = *(int *)((int)pPVar1->rgwtMin + 0xe);
      if ((0 < iVar3) || ((-1 < iVar3 && (0x27 < *(uint *)(pPVar1->rgwtMin + 3)))))
      goto LAB_1090_9692;
    }
    else {
      iVar3 = *(int *)((int)pPVar1->rgwtMin + 0xe);
      if ((0 < iVar3) ||
         (((-1 < iVar3 && (0x3b < *(uint *)(pPVar1->rgwtMin + 3))) ||
          (((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] != 0)))) {
LAB_1090_9692:
        GetResourcesAvailable((PLANET *)CONCAT22(iVar2,pPVar1),rgResAvail);
        GetProdQCost((PLANET *)CONCAT22(iVar2,pPVar1),rgResCost);
        if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 5) {
          for (i = 0; i < 4; i = i + 1) {
            uVar4 = *(uint *)((int)(rgResCost + i) + 2);
            uVar5 = *(uint *)((int)(rgResAvail + i) + 2);
            if (((int)uVar5 <= (int)uVar4) &&
               (((int)uVar5 < (int)uVar4 || (*(uint *)(rgResAvail + i) < *(uint *)(rgResCost + i))))
               ) break;
          }
          if (i < 3) goto LAB_1090_95c8;
        }
        ChangeMainObjSel(1,lppl->id);
        InitProduction(rgprod);
        fWrite = 0;
        if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) ||
           (((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] == 0)) {
          sVar6 = FUpgradeAiStarbase((PLANET *)CONCAT22(iVar2,pPVar1),ishdefSBLatest);
          if ((((sVar6 != 0) ||
               (sVar6 = FAIFling((PLANET *)CONCAT22(iVar2,pPVar1),rgResAvail), sVar6 != 0)) ||
              (sVar6 = FQueueAiScanner((PLANET *)CONCAT22(iVar2,pPVar1),rgResAvail,rgResCost),
              sVar6 != 0)) ||
             (sVar6 = FQueueAiDefenses((PLANET *)CONCAT22(iVar2,pPVar1),rgResAvail,rgResCost),
             sVar6 != 0)) {
            fWrite = 1;
          }
        }
        else if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 4)
                && (sVar6 = FUpgradeAiStarbase((PLANET *)CONCAT22(iVar2,pPVar1),ishdefSBLatest),
                   sVar6 != 0)) {
          fWrite = 1;
        }
        if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 0) &&
            (fWrite == 0)) &&
           (sVar6 = FQueueAiTerraforming((PLANET *)CONCAT22(iVar2,pPVar1),rgResAvail,rgResCost),
           sVar6 != 0)) {
          fWrite = 1;
        }
        FinishProduction(fWrite);
      }
    }
LAB_1090_95c8:
  }
  if (((game.wCrap >> 3 & 1) == 0) && (game.mdSize * 10 + 0x14U <= game.turn))
  {
    FixPlanetsUnderAttack(rgprod);
  }
  AddMinesToBlockedQueues();
  return;
}



// ======================================================================
// Function: SplitOutShdefs
// Address: 1090:98d8
// Segment: MEMORY_AIU
// ======================================================================


void SplitOutShdefs(byte *rgbIsh)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  bool bVar3;
  FLEET *pFVar4;
  int iVar5;
  FLEET *pFVar6;
  undefined2 unaff_SS;
  FLEET *pFVar7;
  short fMarked;
  FLEET flNew;
  short fUnmarked;
  FLEET *lpfl;
  short i;
  short ifl;
  short iFirst;
  short iLast;
  
  iLast = -1;
  iFirst = -1;
  for (i = 0; i < 0x10; i = i + 1) {
    if ((rgbIsh[i] != 0) && (iLast = i, iFirst == -1)) {
      iFirst = i;
    }
  }
  if (iFirst != -1) {
    while ((*(uint *)((int)&rgplr[0].wFlags_0x4 + idPlayer * 0xc0) & 0xfff) < 0x1f5
          ) {
      ifl = 0;
      while( true ) {
        if (cFleet <= ifl) {
          return;
        }
                    /* WARNING: Load size is inaccurate */
        pFVar6 = ((FLEET **)rglpfl)[ifl];
        iVar5 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar5,pFVar6);
        if ((pFVar6 == (FLEET *)0x0) && (iVar5 == 0)) {
          return;
        }
        if ((pFVar6->iPlayer == idPlayer) && ((pFVar6->wFlags_0x4 >> 10 & 1) == 0)) break;
LAB_1090_995c:
        ifl = ifl + 1;
      }
      fUnmarked = 0;
      bVar3 = false;
      i = 0;
      while( true ) {
        if (0xf < i) goto LAB_1090_995c;
        if (0 < pFVar6->rgcsh[i]) break;
LAB_1090_9afa:
        i = i + 1;
      }
      if (rgbIsh[i] == 0) {
        if (!bVar3) {
          fUnmarked = 1;
          goto LAB_1090_9afa;
        }
      }
      else if (fUnmarked == 0) {
        bVar3 = true;
        goto LAB_1090_9afa;
      }
      ChangeMainObjSel(2,lpfl->id);
      pFVar7 = LpflNewSplit((FLEET *)&sel.fl);
      pFVar4 = (FLEET *)pFVar7;
      pFVar6 = &flNew;
      for (iVar5 = 0x3e; iVar5 != 0; iVar5 = iVar5 + -1) {
        pFVar2 = pFVar6;
        pFVar6 = (FLEET *)&pFVar6->iPlayer;
        pFVar1 = pFVar4;
        pFVar4 = (FLEET *)&pFVar4->iPlayer;
        pFVar2->id = pFVar1->id;
      }
      for (i = 0; i < 0x10; i = i + 1) {
        if (rgbIsh[i] != 0) {
          flNew.rgcsh[i] = *(short *)((int)&sel.fl + 0xc + i * 2);
          *(undefined2 *)((int)&sel.fl + 0xc + i * 2) = 0;
        }
      }
      FleetTransferCargoBalance((FLEET *)&sel.fl,&flNew);
      FLookupFleet(-1,(FLEET *)&sel.fl);
      FLookupFleet(-1,&flNew);
    }
  }
  return;
}



// ======================================================================
// Function: CheckAiShdefStatus
// Address: 1090:9b10
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10909c3a) */

short CheckAiShdefStatus
          (short ishBeg,short ishEnd,ushort cRecyclePeriod,short *piLatest,byte *rgbOld)

{
  undefined2 *puVar1;
  undefined2 *puVar2;
  uint uVar3;
  int iVar4;
  undefined2 *puVar5;
  undefined2 *puVar6;
  undefined2 unaff_SS;
  bool bVar7;
  undefined1 shdef [148];
  short i;
  uint cExist;
  int local_6;
  
  *piLatest = -1;
  cExist = 0;
  local_6 = 0;
  for (i = ishBeg; i <= ishEnd; i = i + 1) {
    if ((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0) {
      uVar3 = *(uint *)((int)&rgshdef[0].cExist + i * 0x93);
      bVar7 = CARRY2(cExist,uVar3);
      cExist = cExist + uVar3;
      local_6 = local_6 + *(int *)((int)&rgshdef[0].cExist + 2 + i * 0x93) + (uint)bVar7;
      if ((*piLatest == -1) ||
         (shdef._146_2_ = *(uint *)((int)&rgshdef[0].turn + i * 0x93),
         *(uint *)((int)&rgshdef[0].turn + *piLatest * 0x93) < (uint)shdef._146_2_)) {
        *piLatest = i;
      }
      if (cRecyclePeriod < game.turn - *(int *)((int)&rgshdef[0].turn + i * 0x93))
      {
        if ((*(int *)((int)&rgshdef[0].cExist + i * 0x93) == 0) &&
           (*(int *)((int)&rgshdef[0].cExist + 2 + i * 0x93) == 0)) {
          puVar5 = (undefined2 *)(i * 0x93 + 0x3f00);
          puVar6 = (undefined2 *)shdef;
          for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
            puVar2 = puVar6;
            puVar6 = puVar6 + 1;
            puVar1 = puVar5;
            puVar5 = puVar5 + 1;
            *puVar2 = *puVar1;
          }
          *(undefined1 *)puVar6 = *(undefined1 *)puVar5;
          shdef._123_2_ = shdef._123_2_ & 0xfdff | 0x200;
          FChangeAiShdef((SHDEF *)shdef,i);
        }
        else {
          rgbOld[i] = 1;
        }
      }
    }
  }
  if ((local_6 != 0) || (32000 < cExist)) {
    cExist = 32000;
  }
  return cExist;
}



// ======================================================================
// Function: IncreaseAIMinefieldSizes
// Address: 1090:9c66
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lpth */

void IncreaseAIMinefieldSizes(void)

{
  double dVar1;
  undefined2 uVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  THING *pTVar3;
  ulong uVar4;
  THING *pTVar5;
  THING *cMines;
  undefined2 local_a;
  THING *lpth;
  
  uVar2 = lpThings._2_2_;
  pTVar3 = (THING *)CONCAT22(local_a,cMines);
  pTVar5 = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings + cThing);
  for (lpth._0_2_ = (THING *)lpThings; (THING *)lpth < (THING *)pTVar5;
      lpth._0_2_ = (THING *)lpth + 1) {
    if (((THING *)CONCAT22(uVar2,(THING *)lpth))->idFull >> 0xd == 0) {
      dVar1 = (double)((&((THING *)lpth)->u_THING_0x0006)->thm).cMines;
      _sqrt(SUB84(dVar1,0),
                    (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20))));
      pTVar3 = (THING *)__ftol((double)CONCAT26(uVar2,CONCAT24((THING *)lpth,pTVar3)));
      unaff_SI = 0x1118;
      unaff_DI = 0x9cf5;
      pTVar5 = pTVar3;
      uVar4 = __aFulmul((ulong)pTVar3,(ulong)pTVar3);
      ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags = (ushort)uVar4;
      *(undefined2 *)((int)&((THING *)lpth)->u_THING_0x0006 + 2) = (int)(uVar4 >> 0x10);
    }
  }
  return;
}



// ======================================================================
// Function: FFindBuddyAndJoinUp
// Address: 1090:9d18
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10909e69) */
/* WARNING: Removing unreachable block (ram,0x10909e04) */
/* WARNING: Removing unreachable block (ram,0x10909e8f) */

short FFindBuddyAndJoinUp(FLEET *lpfl,short ishLo,short ishHi,long lMaxDist1,long lMaxDist2)

{
  FLEET *pFVar1;
  int iVar2;
  POINT pt1;
  POINT pt2;
  short sVar3;
  undefined2 uVar4;
  long lVar5;
  ulong uVar6;
  ORDER ord;
  FLEET *lpflBest;
  FLEET *lpflOther;
  short ifl;
  short i;
  undefined4 lDist;
  long lDistBest;
  
  lVar5 = CONCAT22(lDist._2_2_,(undefined2)lDist);
  lpflBest = (FLEET *)0x0;
  lDistBest = 9999999;
  ifl = 0;
  while( true ) {
    lDist = lVar5;
    if (cFleet <= ifl) break;
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[ifl];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpflOther = (FLEET *)CONCAT22(iVar2,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    if (pFVar1->iPlayer == idPlayer) {
      if (lpfl == lpflOther) break;
      for (i = ishLo; i <= ishHi; i = i + 1) {
        if (pFVar1->rgcsh[i] != 0) {
          pt1.y = (((FLEET *)lpfl)->pt).y;
          pt1.x = (&((FLEET *)lpfl)->pt)->x;
          pt2.y = (pFVar1->pt).y;
          pt2.x = (&pFVar1->pt)->x;
          lVar5 = LDistance2(pt1,pt2);
          if (lVar5 < lDistBest) {
            lpflBest = lpflOther;
            lDistBest = lVar5;
          }
          break;
        }
      }
    }
    ifl = ifl + 1;
  }
  if (((FLEET *)lpflBest != (FLEET *)0x0) || (lpflBest._2_2_ != 0)) {
    uVar6 = __aFulmul(lMaxDist1,lMaxDist1);
    if (lDistBest <= (long)uVar6) {
LAB_1090_9eab:
      ClearAiCurrentTask(lpfl,1);
      ord.id = lpflBest->id;
      uVar4 = (undefined2)((ulong)lpflBest >> 0x10);
      ord.pt.x = (&((FLEET *)lpflBest)->pt)->x;
      ord.pt.y = (((FLEET *)lpflBest)->pt).y;
      ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe000 | 0x1260;
      FMoveAiFleet(lpfl,&ord,0);
      return 1;
    }
    uVar6 = __aFulmul(lMaxDist2,lMaxDist2);
    if (lDistBest <= (long)uVar6) {
      sVar3 = Random(2);
      if (sVar3 != 0) goto LAB_1090_9eab;
    }
  }
  return 0;
}



// ======================================================================
// Function: FShouldPlanetBuildColonizer
// Address: 1090:9f30
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1090a026) */
/* WARNING: Removing unreachable block (ram,0x10909fe9) */
/* WARNING: Removing unreachable block (ram,0x1090a00e) */
/* WARNING: Removing unreachable block (ram,0x1090a052) */

short FShouldPlanetBuildColonizer(PLANET *lpplSrc)

{
  short sVar1;
  long lVar2;
  short sVar3;
  long lVar4;
  POINT pt1;
  POINT pt2;
  byte *lpb;
  short i;
  
  lVar2 = 10000000;
  sVar3 = ((POINT *)rgptPlan + lpplSrc->id)->x;
  sVar1 = *(short *)((int)&rgptPlan[0].y + lpplSrc->id * 4);
  if (game.turn < 0x3c) {
    sVar3 = 1;
  }
  else {
    lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,(byte *)vlpbAiPlanet + 0xd);
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      if ((*lpb == 0) &&
         (pt2.y = *(short *)((int)&rgptPlan[0].y + i * 4),
         pt2.x = ((POINT *)rgptPlan + i)->x, pt1.y = sVar1, pt1.x = sVar3,
         lVar4 = LDistance2(pt1,pt2), lVar4 < lVar2)) {
        lVar2 = lVar4;
      }
      lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 0x10);
    }
    if (((lVar2 < 0x1de85) && ((lVar2 < 0x15f91 || (sVar3 = Random(2), sVar3 == 0)))) &&
       ((lVar2 < 0xf425 || (sVar3 = Random(2), sVar3 == 0)))) {
      sVar3 = 1;
    }
    else {
      sVar3 = 0;
    }
  }
  return sVar3;
}



// ======================================================================
// Function: InitRandomPlanetList
// Address: 1090:a082
// Segment: MEMORY_AIU
// ======================================================================


void InitRandomPlanetList(void)

{
  undefined2 uVar1;
  undefined2 uVar2;
  undefined2 uVar3;
  short sVar4;
  PLANET *pPVar5;
  PLANET **ppPVar6;
  undefined2 uVar7;
  short i;
  PLANET *lppl;
  short iT;
  
  vclpplAi = 0;
  pPVar5 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while (uVar1 = vrglpplAi._2_2_, (PLANET *)lppl < pPVar5) {
    uVar7 = (undefined2)((ulong)lppl >> 0x10);
    if (((PLANET *)lppl)->iPlayer == idPlayer) {
      ppPVar6 = (PLANET **)vrglpplAi + vclpplAi;
      vclpplAi = vclpplAi + 1;
      *(PLANET **)ppPVar6 = (PLANET *)lppl;
      *(undefined2 *)((int)ppPVar6 + 2) = uVar7;
    }
    lppl = (PLANET *)CONCAT22(uVar7,(PLANET *)lppl + 1);
  }
  if (((uint)gd.grBits >> 0xb & 1) == 0) {
    for (i = 0; i < vclpplAi + -1; i = i + 1) {
      sVar4 = Random(vclpplAi - i);
      uVar3 = vrglpplAi._2_2_;
      uVar1 = *(undefined2 *)((PLANET **)vrglpplAi + i);
      uVar7 = *(undefined2 *)((int)((PLANET **)vrglpplAi + i) + 2);
      uVar2 = *(undefined2 *)((int)((PLANET **)vrglpplAi + sVar4 + i) + 2);
      ppPVar6 = (PLANET **)vrglpplAi + i;
      *(undefined2 *)ppPVar6 = *(undefined2 *)((PLANET **)vrglpplAi + sVar4 + i);
      *(undefined2 *)((int)ppPVar6 + 2) = uVar2;
      uVar2 = vrglpplAi._2_2_;
      ppPVar6 = (PLANET **)vrglpplAi + sVar4 + i;
      *(undefined2 *)ppPVar6 = uVar1;
      *(undefined2 *)((int)ppPVar6 + 2) = uVar7;
    }
  }
  return;
}



