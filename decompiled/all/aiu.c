// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: FCreateAiShdef
// Address: 1090:012c
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1090037f) */
/* WARNING: Removing unreachable block (ram,0x1090032c) */

short FCreateAiShdef(short ishdef,short ihul,byte *rgaip)

{
  COMPART *pCVar1;
  SHDEF *pSVar2;
  SHDEF *pSVar3;
  ushort grhst;
  short sVar4;
  int iVar5;
  uint uVar6;
  undefined2 unaff_SI;
  COMPART *pCVar7;
  SHDEF *pSVar8;
  undefined2 unaff_DI;
  SHDEF *pSVar9;
  undefined2 unaff_SS;
  ulong uVar10;
  long lVar11;
  uint in_stack_0000ff50;
  SHDEF shdef;
  PART part;
  HUL *lphul;
  short ihs;
  short cItem;
  long grbitHull;
  short ids;
  
  lVar11 = CONCAT22(unaff_SI,unaff_DI);
  _memset(&shdef,0,0x93);
  if (ishdef < 0) {
    grhst = 0x400;
  }
  else {
    grhst = 0x4000;
  }
  sVar4 = FLookupPartX(&part,grhst,ihul);
  if (sVar4 == 1) {
    lphul = (HUL *)CONCAT22(part.pcom._2_2_,(COMPART *)part.pcom);
    pSVar8 = &shdef;
    pCVar7 = (COMPART *)part.pcom;
    for (iVar5 = 0x3d; iVar5 != 0; iVar5 = iVar5 + -1) {
      pSVar2 = pSVar8;
      pSVar8 = (SHDEF *)(pSVar8->hul).rgTech;
      pCVar1 = pCVar7;
      pCVar7 = (COMPART *)pCVar7->rgTech;
      (pSVar2->hul).ihuldef = pCVar1->id;
    }
    *(char *)&(pSVar8->hul).ihuldef = (char)pCVar7->id;
    shdef.hul.ihuldef = lphul->ihuldef;
    for (ihs = 0; ihs < (int)(uint)(byte)((COMPART *)part.pcom)[2].szName[10]; ihs = ihs + 1) {
      sVar4 = FGetAIPart((uint)((byte *)rgaip)[ihs],&part);
      if (sVar4 == 0) {
        return 0;
      }
      in_stack_0000ff50 = *(uint *)(((COMPART *)part.pcom)[1].szName + ihs * 4) >> 8;
      uVar6 = part.hs.wFlags & 0xffU | in_stack_0000ff50 << 8;
      part.hs.wFlags = uVar6;
      (shdef.hul.rghs + ihs)->grhst = part.hs.grhst;
      shdef.hul.rghs[ihs].wFlags = uVar6;
    }
    shdef.hul.chs = (byte)ihs;
    shdef.wFlags = shdef.wFlags & 0xfdff;
    if (ishdef < 0) {
      pSVar8 = &shdef;
      pSVar9 = (SHDEF *)&shdefBuild;
      for (iVar5 = 0x49; iVar5 != 0; iVar5 = iVar5 + -1) {
        pSVar3 = pSVar9;
        pSVar9 = (SHDEF *)(pSVar9->hul).rgTech;
        pSVar2 = pSVar8;
        pSVar8 = (SHDEF *)(pSVar8->hul).rgTech;
        (pSVar3->hul).ihuldef = (pSVar2->hul).ihuldef;
      }
      *(char *)&(pSVar9->hul).ihuldef = (char)(pSVar8->hul).ihuldef;
      sVar4 = 1;
    }
    else {
      uVar10 = __aFlshl(lVar11,in_stack_0000ff50);
      if ((uVar10 & 0x780) == 0) {
        if ((uVar10 & 0x40) == 0) {
          if ((uVar10 & 0x70) == 0) {
            if ((uVar10 & 0xf0000) == 0) {
              if ((uVar10 & 0xf) == 0) {
                if ((uVar10 & 0x1f00000) == 0) {
                  if ((uVar10 & 0x3800) == 0) {
                    if ((uVar10 & 0xc000) == 0) {
                      ids = 0x41a;
                      cItem = 8;
                    }
                    else {
                      ids = 0x402;
                      cItem = 8;
                    }
                  }
                  else {
                    ids = 0x412;
                    cItem = 8;
                  }
                }
                else {
                  ids = 0x3fa;
                  cItem = 8;
                }
              }
              else {
                ids = 0x40a;
                cItem = 8;
              }
            }
            else {
              ids = 0x3ee;
              cItem = 0xc;
            }
          }
          else {
            ids = 0x3d4;
            cItem = 10;
          }
        }
        else {
          ids = 0x422;
          cItem = 0x10;
        }
      }
      else {
        ids = 0x3de;
        cItem = 0x10;
      }
      shdef.wFlags = shdef.wFlags & 0x83ffU | (ishdef & 0x1fU) << 10;
      PickANameAndBmp(&shdef,ids,cItem,((COMPART *)part.pcom)->ibmp);
      sVar4 = FChangeAiShdef(&shdef,ishdef);
    }
  }
  else {
    sVar4 = 0;
  }
  return sVar4;
}



// ======================================================================
// Function: FGetAIPart
// Address: 1090:043e
// Segment: MEMORY_AIU
// ======================================================================


short FGetAIPart(short aip,PART *ppart)

{
  short sVar1;
  PART part;
  short cItem;
  short i;
  short iOffset;
  short cTry;
  
  iOffset = 0;
  for (i = 0; i < aip; i = i + 1) {
    iOffset = iOffset + (uint)((byte *)vrgcAiParts)[i];
  }
  cTry = (uint)((byte *)vrgcAiParts)[aip];
  do {
    if (cTry < 1) {
      return 0;
    }
    part.hs.grhst = 1 << ((byte)*(undefined2 *)(iOffset * 2) & 0xf);
    part.hs.wFlags = *(uint *)(iOffset * 2) >> 4 & 0x1f;
    cItem = *(uint *)(iOffset * 2) >> 9 & 0xf;
    while (0 < cItem) {
      sVar1 = FLookupPart(&part);
      if (sVar1 == 1) {
        (ppart->hs).grhst = part.hs.grhst;
        (ppart->hs).wFlags = part.hs.wFlags;
        *(COMPART **)&ppart->pcom = (COMPART *)part.pcom;
        *(undefined2 *)((int)&ppart->pcom + 2) = part.pcom._2_2_;
        return 1;
      }
      part.hs.wFlags = part.hs.wFlags & 0xff00U | part.hs.wFlags - 1U & 0xff;
      cItem = cItem + -1;
    }
    iOffset = iOffset + 1;
    cTry = cTry + -1;
  } while( true );
}



// ======================================================================
// Function: PickANameAndBmp
// Address: 1090:055a
// Segment: MEMORY_AIU
// ======================================================================


void PickANameAndBmp(SHDEF *pshdef,StringId ids,short cids,short ibmpStart)

{
  short sVar1;
  char *pcVar2;
  short ishdef;
  short rgfBmpUsed [4];
  short i;
  
  _memset(rgfBmpUsed,0,8);
  if (((uint)pshdef->wFlags >> 10 & 0x1f) < 0x10) {
    for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
      if (((*(uint *)((int)&rgshdef[0].wFlags + ishdef * 0x93) >> 9 & 1) == 0) &&
         (*(HullDef *)(ishdef * 0x93 + 0x3f00) == (pshdef->hul).ihuldef)) {
        rgfBmpUsed[*(int *)((int)&rgshdef[0].hul + 0x32 + ishdef * 0x93) - ibmpStart] = 1;
      }
    }
  }
  else {
    for (ishdef = 0; ishdef < 10; ishdef = ishdef + 1) {
      if (((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + ishdef * 0x93 + 0x7b) >> 9 & 1) == 0)
         && (*(HullDef *)(*(int *)(idPlayer * 4 + 0x14c) + ishdef * 0x93) ==
             (pshdef->hul).ihuldef)) {
        rgfBmpUsed
        [*(int *)(*(int *)(idPlayer * 4 + 0x14c) + ishdef * 0x93 + 0x32) - ibmpStart] = 1;
      }
    }
  }
  for (i = 0; (i < 4 && (rgfBmpUsed[i] != 0)); i = i + 1) {
  }
  if (i == 4) {
    i = Random(4);
  }
  (pshdef->hul).ibmp = ibmpStart + i;
  i = 0;
  do {
    if (0x13 < i) {
      Random(100);
      sVar1 = Random(cids);
      pcVar2 = PszGetCompressedString(sVar1 + ids);
      _WSPRINTF((LPSTR)CONCAT22(pcVar2,(char *)&DAT_1120_1120),(LPCSTR)0x147d1120,
                (pshdef->hul).szClass);
      return;
    }
    pcVar2 = (pshdef->hul).szClass;
    sVar1 = Random(cids);
    CchGetString(sVar1 + ids,pcVar2);
    if (((uint)pshdef->wFlags >> 10 & 0x1f) < 0x10) {
      ishdef = 0;
      while ((ishdef < 0x10 &&
             (((*(uint *)((int)&rgshdef[0].wFlags + ishdef * 0x93) >> 9 & 1) != 0 ||
              (sVar1 = _strcmp((pshdef->hul).szClass,
                                       (char *)((int)&rgshdef[0].hul + 8 + ishdef * 0x93))
              , sVar1 != 0))))) {
        ishdef = ishdef + 1;
      }
      if (ishdef == 0x10) {
        return;
      }
    }
    else {
      ishdef = 0;
      while ((ishdef < 10 &&
             ((((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + ishdef * 0x93 + 0x7b) >> 9 & 1)
                != 0 || (*(HullDef *)(*(int *)(idPlayer * 4 + 0x14c) + ishdef * 0x93) !=
                         (pshdef->hul).ihuldef)) ||
              (sVar1 = __fstrcmp((char *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                                          (pshdef->hul).szClass),
                                         (char *)CONCAT22(*(undefined2 *)
                                                           (idPlayer * 4 + 0x14e),
                                                          (char *)(*(int *)(idPlayer * 4 +
                                                                           0x14c) + ishdef * 0x93 +
                                                                  8))), sVar1 != 0))))) {
        ishdef = ishdef + 1;
      }
      if (ishdef == 10) {
        return;
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FChangeAiShdef
// Address: 1090:08a2
// Segment: MEMORY_AIU
// ======================================================================


short FChangeAiShdef(SHDEF *pshdef,short ishdef)

{
  uint *puVar1;
  char *pcVar2;
  SHDEF *pSVar3;
  SHDEF *pSVar4;
  int iVar5;
  int iVar6;
  SHDEF *pSVar7;
  SHDEF *pSVar8;
  undefined2 unaff_SS;
  SHDEF shdef;
  short ishdefWork;
  short iDir;
  SHDEF *lpshdefBase;
  
  pSVar7 = &shdef;
  for (iVar6 = 0x49; iVar6 != 0; iVar6 = iVar6 + -1) {
    pSVar4 = pSVar7;
    pSVar7 = (SHDEF *)(pSVar7->hul).rgTech;
    pSVar3 = pshdef;
    pshdef = (SHDEF *)(pshdef->hul).rgTech;
    (pSVar4->hul).ihuldef = (pSVar3->hul).ihuldef;
  }
  *(char *)&(pSVar7->hul).ihuldef = (char)(pshdef->hul).ihuldef;
  shdef.wFlags = shdef.wFlags & 0x83ffU | (ishdef & 0x1fU) << 10;
  shdef.turn = game.turn;
  shdef.cExist._0_2_ = 0;
  shdef.cExist._2_2_ = 0;
  shdef.cBuilt._0_2_ = 0;
  shdef.cBuilt._2_2_ = 0;
  if (ishdef < 0x10) {
    lpshdefBase._0_2_ = (SHDEF *)*(undefined2 *)(idPlayer * 4 + 0xfe);
    lpshdefBase._2_2_ = *(undefined2 *)(idPlayer * 4 + 0x100);
    ishdefWork = ishdef;
  }
  else {
    lpshdefBase._0_2_ = (SHDEF *)*(undefined2 *)(idPlayer * 4 + 0x14c);
    lpshdefBase._2_2_ = *(undefined2 *)(idPlayer * 4 + 0x14e);
    ishdefWork = ishdef + -0x10;
  }
  UpdateShdefCost((SHDEF *)CONCAT22(unaff_SS,&shdef));
  if (((uint)shdef.wFlags >> 9 & 1) == ((uint)((SHDEF *)lpshdefBase)[ishdefWork].wFlags >> 9 & 1)) {
    if (((uint)((SHDEF *)lpshdefBase)[ishdefWork].wFlags >> 9 & 1) == 0) {
      ((SHDEF *)lpshdefBase)[ishdefWork].wFlags =
           ((SHDEF *)lpshdefBase)[ishdefWork].wFlags & 0xfdffU | 0x200;
      LogChangeShDef((SHDEF *)CONCAT22(lpshdefBase._2_2_,(SHDEF *)lpshdefBase + ishdefWork))
      ;
    }
  }
  else {
    if (((uint)shdef.wFlags >> 9 & 1) == 0) {
      iVar6 = 1;
    }
    else {
      iVar6 = -1;
    }
    if (ishdef < 0x10) {
      pcVar2 = (char *)((int)&rgplr[0].cShDef + idPlayer * 0xc0);
      *pcVar2 = *pcVar2 + (char)iVar6;
    }
    else {
      iVar5 = *(int *)((int)&rgplr[0].wFlags + idPlayer * 0xc0);
      puVar1 = (uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0);
      *puVar1 = *puVar1 & 0xfff;
      puVar1 = (uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0);
      *puVar1 = *puVar1 | iVar6 * 0x1000 + iVar5 & 0xf000U;
    }
  }
  pSVar8 = (SHDEF *)lpshdefBase + ishdefWork;
  pSVar7 = &shdef;
  for (iVar6 = 0x49; iVar6 != 0; iVar6 = iVar6 + -1) {
    pSVar4 = pSVar8;
    pSVar8 = (SHDEF *)(pSVar8->hul).rgTech;
    pSVar3 = pSVar7;
    pSVar7 = (SHDEF *)(pSVar7->hul).rgTech;
    (pSVar4->hul).ihuldef = (pSVar3->hul).ihuldef;
  }
  *(char *)&(pSVar8->hul).ihuldef = (char)(pSVar7->hul).ihuldef;
  LogChangeShDef((SHDEF *)CONCAT22(unaff_SS,&shdef));
  return 1;
}



// ======================================================================
// Function: XferAiSupply
// Address: 1090:0ad0
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10900b51) */

short XferAiSupply(short grobjSrc,short idSrc,short grobjDst,short idDst,short iSupply,short cQuan)

{
  short sVar1;
  short sVar2;
  long lVar3;
  long cAvailable;
  short iT;
  short dChg;
  
  sVar1 = idSrc;
  sVar2 = grobjSrc;
  if (cQuan == 0) {
    sVar2 = 0;
  }
  else {
    if (cQuan < 0) {
      grobjSrc = grobjDst;
      grobjDst = sVar2;
      idSrc = idDst;
      idDst = sVar1;
      cQuan = -cQuan;
    }
    lVar3 = ChgCargo(grobjSrc,idSrc,iSupply,0,(void *)0x0);
    if (lVar3 < cQuan) {
      cQuan = (short)lVar3;
    }
    if (cQuan == 0) {
      sVar2 = 0;
    }
    else {
      lVar3 = ChgCargo(grobjDst,idDst,iSupply,(long)cQuan,(void *)0x0);
      sVar2 = (short)lVar3;
      if (sVar2 != 0) {
        ChgCargo(grobjSrc,idSrc,iSupply,(long)-sVar2,(void *)0x0);
      }
    }
  }
  return sVar2;
}



// ======================================================================
// Function: XferAiTroopers
// Address: 1090:0bc2
// Segment: MEMORY_AIU
// ======================================================================


short XferAiTroopers(short idSrc,short idDst,short cQuan)

{
  int iVar1;
  long lVar2;
  long cAvailable;
  
  if (cQuan == 0) {
    cQuan = 0;
  }
  else {
    lVar2 = ChgCargo(grobjFleet,idSrc,3,0,(void *)0x0);
    iVar1 = (int)((ulong)lVar2 >> 0x10);
    if ((iVar1 <= cQuan >> 0xf) && ((iVar1 < cQuan >> 0xf || ((uint)lVar2 < (uint)cQuan)))) {
      cQuan = (uint)lVar2;
    }
    if (cQuan == 0) {
      cQuan = 0;
    }
    else {
      ChgCargo(grobjFleet,idSrc,3,(long)-cQuan,(void *)0x0);
      ChgCargo(grobjPlanet,idDst,3,(long)cQuan,(void *)0x0);
    }
  }
  return cQuan;
}



// ======================================================================
// Function: FColonizeAiFleet
// Address: 1090:0c78
// Segment: MEMORY_AIU
// ======================================================================


short FColonizeAiFleet(FLEET *lpfl,short idPlanet)

{
  uint uVar1;
  short sVar2;
  ORDER ord;
  
  ChangeMainObjSel(2,lpfl->id);
  _memset(&ord,0,0x12);
  ord.pt.x = ((POINT *)rgptPlan + idPlanet)->x;
  ord.pt.y = *(short *)((int)&rgptPlan[0].y + idPlanet * 4);
  ord.id = idPlanet;
  ord.wFlags = ord.wFlags & 0xe0f0U | 0x1102;
  uVar1 = IFindIdealWarp(lpfl,1);
  ord.wFlags = ord.wFlags & 0xff0fU | (uVar1 & 0xf) << 4;
  sVar2 = FMoveAiFleet(lpfl,&ord,0);
  if (sVar2 != 0) {
    ((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0x7fffU | 0x8000;
  }
  return (uint)(sVar2 != 0);
}



// ======================================================================
// Function: FGotoWormholeAiFleet
// Address: 1090:0d5c
// Segment: MEMORY_AIU
// ======================================================================


short FGotoWormholeAiFleet(FLEET *lpfl,THING *lpthWorm)

{
  uint uVar1;
  short sVar2;
  undefined2 uVar3;
  ORDER ord;
  
  ChangeMainObjSel(2,lpfl->id);
  _memset(&ord,0,0x12);
  uVar3 = (undefined2)((ulong)lpthWorm >> 0x10);
  ord.pt.x = (&((THING *)lpthWorm)->pt)->x;
  ord.pt.y = (((THING *)lpthWorm)->pt).y;
  ord.id = lpthWorm->idFull;
  ord.wFlags = ord.wFlags & 0xe0f0U | 0x800;
  uVar1 = IFindIdealWarp(lpfl,1);
  ord.wFlags = ord.wFlags & 0xff0fU | (uVar1 & 0xf) << 4;
  sVar2 = FMoveAiFleet(lpfl,&ord,0);
  if (sVar2 != 0) {
    ((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0x7fffU | 0x8000;
  }
  return (uint)(sVar2 != 0);
}



// ======================================================================
// Function: IdNearestColonizablePlanet
// Address: 1090:0e3e
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109011ef) */
/* WARNING: Removing unreachable block (ram,0x109011a8) */
/* WARNING: Removing unreachable block (ram,0x109011c3) */
/* WARNING: Removing unreachable block (ram,0x10901221) */

short IdNearestColonizablePlanet(FLEET *lpflCol,THING **plpthWorm)

{
  FLEET *pFVar1;
  long d2_00;
  short sVar2;
  short sVar3;
  PLANET *pPVar4;
  int iVar5;
  undefined2 uVar6;
  ulong uVar7;
  ulong uVar8;
  PLANET *pPVar9;
  THING *pTVar10;
  long d2Cur;
  byte *lpb;
  long dx;
  short iVal;
  short i;
  FLEET *lpfl;
  short ifl;
  short idBest;
  PLANET *lppl;
  long d2;
  long dy;
  POINT pt;
  PLANET *lpplMac;
  
  if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) ||
     (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 5)) {
    iVal._0_1_ = 0;
  }
  else {
    iVal._0_1_ = 0x10;
    if (fMarkedPlanets != 0) goto AIU_LFindNearest;
  }
  lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,(byte *)vlpbAiPlanet + 0xf);
  for (i = 0; i < game.cPlanMax; i = i + 1) {
    *lpb = (byte)iVal;
    lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 0x10);
  }
  pPVar4 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < pPVar4) {
    uVar6 = (undefined2)((ulong)lppl >> 0x10);
    if (((PLANET *)lppl)->iPlayer == -1) {
      if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) ||
          (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 5)) ||
         (sVar2 = PctPlanetOptValue(lppl,idPlayer), -1 < sVar2)) {
        iVal._0_1_ = 0;
      }
      else {
        iVal._0_1_ = 8;
      }
    }
    else if (((PLANET *)lppl)->iPlayer == idPlayer) {
      iVal._0_1_ = 1;
    }
    else {
      iVal._0_1_ = 2;
    }
    ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 0xf] = (byte)iVal;
    lppl = (PLANET *)CONCAT22(uVar6,(PLANET *)lppl + 1);
  }
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[ifl];
    iVar5 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    if ((pFVar1 == (FLEET *)0x0) && (iVar5 == 0)) break;
    if ((((pFVar1->iPlayer == idPlayer) &&
         ((1 < pFVar1->cord && (lpflCol != (FLEET *)CONCAT22(iVar5,pFVar1))))) &&
        (((uint)((PLORD *)pFVar1->lpplord + 7)->wFlags >> 8 & 0xf) == 1)) &&
       (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 0 &&
         (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 5)) ||
        ((((PLORD *)pFVar1->lpplord + 7)->wFlags & 0xfU) == 2)))) {
      ((byte *)vlpbAiPlanet)[*(int *)&((PLORD *)pFVar1->lpplord)[6].iordMax * 0x10 + 0xf] = 4
      ;
    }
  }
AIU_LFindNearest:
  lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,(byte *)vlpbAiPlanet + 0xf);
  d2_00 = 99999999;
  pt.x = (&((FLEET *)lpflCol)->pt)->x;
  pt.y = (((FLEET *)lpflCol)->pt).y;
  idBest = -1;
  for (i = 0; i < game.cPlanMax; i = i + 1) {
    if (*lpb == 0) {
      sVar2 = _abs(pt.x - ((POINT *)rgptPlan + i)->x);
      sVar3 = _abs(pt.y - *(int *)((int)&rgptPlan[0].y + i * 4));
      if (((sVar2 < d2_00) && (sVar3 < d2_00)) &&
         (uVar7 = __aFulmul((long)sVar2,(long)sVar2), (long)uVar7 < d2_00)) {
        uVar8 = __aFulmul((long)sVar3,(long)sVar3);
        if ((long)(uVar7 + uVar8) < d2_00) {
          idBest = i;
          d2_00 = uVar7 + uVar8;
        }
      }
    }
    lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 0x10);
  }
  fMarkedPlanets = 1;
  if (plpthWorm != (THING **)0x0) {
    *(undefined2 *)plpthWorm = 0;
    *(undefined2 *)((int)plpthWorm + 2) = 0;
    if ((((FLEET *)lpflCol)->idPlanet != -1) && ((uint)game.turn < 0x78)) {
      pPVar9 = LpplFromId(((FLEET *)lpflCol)->idPlanet);
      iVar5 = (int)((ulong)pPVar9 >> 0x10);
      if ((((PLANET *)pPVar9 != (PLANET *)0x0) || (iVar5 != 0)) &&
         (((PLANET *)pPVar9)->iPlayer == idPlayer)) {
        pTVar10 = LpthWormFind(&pt,d2_00);
        *(THING **)plpthWorm = (THING *)pTVar10;
        *(undefined2 *)((int)plpthWorm + 2) = (int)((ulong)pTVar10 >> 0x10);
      }
    }
    if ((*(int *)plpthWorm != 0) || (*(int *)((int)plpthWorm + 2) != 0)) {
      idBest = -1;
    }
  }
  return idBest;
}



// ======================================================================
// Function: LpthWormFind
// Address: 1090:12e6
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109013bf) */
/* WARNING: Removing unreachable block (ram,0x10901429) */

THING * LpthWormFind(POINT *ppt,long d2)

{
  short sVar1;
  short sVar2;
  uint uVar3;
  byte bVar4;
  THING *pTVar5;
  int iVar6;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  int iVar7;
  long lVar8;
  long lVar9;
  THING *pTVar10;
  long d2Cur;
  THING *lpthMac;
  short dx;
  short iVal;
  THING *lpthBest;
  THING *lpth;
  ushort grbitplr;
  long d2Worm;
  short dy;
  short pctGood;
  
  lVar9 = CONCAT22(unaff_SI,unaff_DI);
  lpthBest._0_2_ = (THING *)0x0;
  lpthBest._2_2_ = 0;
  bVar4 = (byte)idPlayer;
  d2Worm._0_2_ = 0x4240;
  d2Worm._2_2_ = 0xf;
  pctGood = 0;
  pTVar5 = (THING *)lpThings + cThing;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  pTVar10 = (THING *)lpThings;
  while ((THING *)lpth < pTVar5) {
    iVar7 = (int)((ulong)lpth >> 0x10);
    if ((uint)lpth->idFull >> 0xd == 2) {
      sVar1 = _abs(ppt->x - (&((THING *)lpth)->pt)->x);
      sVar2 = _abs(ppt->y - (((THING *)lpth)->pt).y);
      uVar3 = sVar1 * sVar1 + sVar2 * sVar2;
      iVar6 = (int)uVar3 >> 0xf;
      lVar8 = __aFlshl(lVar9,(ushort)pTVar10);
      if (((int)uVar3 <= lVar8) && ((iVar6 < 0 || ((iVar6 < 1 && (uVar3 < 0xb641)))))) {
        if ((*(uint *)(((THING *)lpth)->rgb + 4) & 1 << (bVar4 & 0x1f)) == 0) {
          if (d2 < (int)uVar3) {
            iVal = 0x32;
          }
          else {
            iVal = 0x5a;
          }
        }
        else {
          sVar1 = PctWormholeMoves(lpth);
          iVal = sVar1 * -10 + 0x46;
        }
        if ((pctGood < iVal) ||
           (((iVal == pctGood && (iVar6 <= d2Worm._2_2_)) &&
            ((iVar6 < d2Worm._2_2_ || (uVar3 < (uint)d2Worm)))))) {
          pctGood = iVal;
          lpthBest._0_2_ = (THING *)lpth;
          lpthBest._2_2_ = iVar7;
          d2Worm._0_2_ = uVar3;
          d2Worm._2_2_ = iVar6;
        }
      }
    }
    lpth = (THING *)CONCAT22(iVar7,(THING *)lpth + 1);
  }
  if ((((THING *)lpthBest == (THING *)0x0) && (lpthBest._2_2_ == 0)) ||
     (sVar1 = Random(100), pctGood <= sVar1)) {
    lpthBest._0_2_ = (THING *)0x0;
    lpthBest._2_2_ = 0;
  }
  return (THING *)CONCAT22(lpthBest._2_2_,(THING *)lpthBest);
}



// ======================================================================
// Function: UlFleetPower
// Address: 1090:14de
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1090157a) */

ulong UlFleetPower(FLEET *lpfl)

{
  int iVar1;
  undefined2 uVar2;
  ulong uVar3;
  FLEET *pFVar4;
  int iVar5;
  undefined2 uVar6;
  ulong uVar7;
  short ishdef;
  short iplr;
  ulong ul;
  
  uVar3 = 0;
  uVar6 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar4 = (FLEET *)lpfl;
  iVar1 = pFVar4->iPlayer;
  ishdef = 0;
  do {
    if (0xf < ishdef) {
      return uVar3;
    }
    if (pFVar4->rgcsh[ishdef] != 0) {
      iVar5 = iVar1 * 4;
      uVar2 = *(undefined2 *)(iVar5 + 0x100);
      iVar5 = *(int *)(iVar5 + 0xfe) + ishdef * 0x93;
      uVar7 = __aFulmul(CONCAT22(*(undefined2 *)(iVar5 + 0x89),*(undefined2 *)(iVar5 + 0x87)
                                        ),(long)pFVar4->rgcsh[ishdef]);
      uVar3 = uVar7 + uVar3;
      if ((uVar3 & 0x80000000) != 0) {
        return uVar3;
      }
    }
    ishdef = ishdef + 1;
  } while( true );
}



// ======================================================================
// Function: IdNearestUnknownPlanet
// Address: 1090:15a4
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109016ce) */
/* WARNING: Removing unreachable block (ram,0x10901687) */
/* WARNING: Removing unreachable block (ram,0x109016a2) */
/* WARNING: Removing unreachable block (ram,0x10901700) */

short IdNearestUnknownPlanet(FLEET *lpfl,THING **plpthWorm)

{
  long d2_00;
  short sVar1;
  short sVar2;
  ulong uVar3;
  ulong uVar4;
  THING *pTVar5;
  long d2Cur;
  byte *lpb;
  long dx;
  short i;
  short idBest;
  long d2;
  long dy;
  POINT pt;
  
  if (fMarkedPlanets == 0) {
    IdNearestColonizablePlanet(lpfl,(THING **)0x0);
  }
  lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,(byte *)vlpbAiPlanet + 0xf);
  d2_00 = 99999999;
  pt.x = (&((FLEET *)lpfl)->pt)->x;
  pt.y = (((FLEET *)lpfl)->pt).y;
  idBest = -1;
  for (i = 0; i < game.cPlanMax; i = i + 1) {
    if (*lpb == 0x10) {
      sVar2 = _abs(pt.x - ((POINT *)rgptPlan + i)->x);
      sVar1 = _abs(pt.y - *(int *)((int)&rgptPlan[0].y + i * 4));
      if (((sVar2 < d2_00) && (sVar1 < d2_00)) &&
         (uVar3 = __aFulmul((long)sVar2,(long)sVar2), (long)uVar3 < d2_00)) {
        uVar4 = __aFulmul((long)sVar1,(long)sVar1);
        if ((long)(uVar3 + uVar4) < d2_00) {
          idBest = i;
          d2_00 = uVar3 + uVar4;
        }
      }
    }
    lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 0x10);
  }
  if (plpthWorm != (THING **)0x0) {
    *(undefined2 *)plpthWorm = 0;
    *(undefined2 *)((int)plpthWorm + 2) = 0;
    if ((((FLEET *)lpfl)->idPlanet != -1) && (sVar2 = Random(100), sVar2 < 5)) {
      pTVar5 = LpthWormFind(&pt,d2_00);
      *(THING **)plpthWorm = (THING *)pTVar5;
      *(undefined2 *)((int)plpthWorm + 2) = (int)((ulong)pTVar5 >> 0x10);
    }
    if ((*(int *)plpthWorm != 0) || (*(int *)((int)plpthWorm + 2) != 0)) {
      idBest = -1;
    }
  }
  return idBest;
}



// ======================================================================
// Function: AddMinesToBlockedQueues
// Address: 1090:1792
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10901832) */
/* WARNING: Removing unreachable block (ram,0x109018c2) */
/* WARNING: Removing unreachable block (ram,0x10901974) */
/* WARNING: Removing unreachable block (ram,0x109019cb) */
/* WARNING: Removing unreachable block (ram,0x10901a7c) */
/* WARNING: Removing unreachable block (ram,0x10901ac5) */
/* WARNING: Removing unreachable block (ram,0x10901bf4) */
/* WARNING: Removing unreachable block (ram,0x10901c41) */

void AddMinesToBlockedQueues(void)

{
  byte *pbVar1;
  PLANET *pPVar2;
  int iVar3;
  uint uVar4;
  uint uVar5;
  short sVar6;
  PLPROD *pPVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar8;
  undefined2 uVar9;
  undefined2 unaff_SS;
  bool bVar10;
  ulong uVar11;
  long lVar12;
  ulong uVar13;
  uint in_stack_0000fec4;
  short etaBetterMines;
  PROD rgprod [64];
  long rgCost [4];
  short ipl;
  long cRes;
  long cResMine;
  PLANET *lppl;
  short etaFirst;
  long cBuild;
  short etaBetterAlchemy;
  long cMaxBuild;
  PROD prod;
  
  uVar13 = CONCAT22(unaff_SI,unaff_DI);
  ipl = 0;
  do {
    if (vclpplAi <= ipl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pPVar2 = ((PLANET **)vrglpplAi)[ipl];
    iVar3 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
    lppl = (PLANET *)CONCAT22(iVar3,pPVar2);
    if ((pPVar2 == (PLANET *)0x0) && (iVar3 == 0)) {
      return;
    }
    if ((*(int *)&pPVar2->lpplprod != 0) || (*(int *)((int)&pPVar2->lpplprod + 2) != 0)) {
      uVar8 = (undefined2)((ulong)pPVar2->lpplprod >> 0x10);
      pPVar7 = (PLPROD *)pPVar2->lpplprod;
      prod.dwFlags._0_2_ = (pPVar7 + 1)->wFlags;
      prod.dwFlags._2_2_ = *(undefined2 *)&pPVar7[1].iprodMax;
      uVar11 = __aFulshr(uVar13,in_stack_0000fec4);
      if (((uint)uVar11 & 7) == 1) {
        uVar11 = __aFulshr(uVar13,in_stack_0000fec4);
        if (((uint)uVar11 & 0x7f) != 8) {
          uVar11 = __aFulshr(uVar13,in_stack_0000fec4);
          if (((uint)uVar11 & 0x7f) != 3) {
            uVar11 = __aFulshr(uVar13,in_stack_0000fec4);
            if (((uint)uVar11 & 0x7f) != 0xb) {
              uVar11 = __aFulshr(uVar13,in_stack_0000fec4);
              if (((uint)uVar11 & 0x7f) != 0xc) goto LAB_1090_18c8;
            }
          }
        }
      }
      else {
LAB_1090_18c8:
        ChangeMainObjSel(1,lppl->id);
        PszProductionETA
                  (&sel.pl,sel.pl.lpplprod,0,&etaFirst,(short *)0x0);
        if (etaFirst != 1) {
          if (etaFirst == -1) {
            etaFirst = 600;
          }
          GetProductionCosts
                    ((PLANET *)CONCAT22(iVar3,pPVar2),(PROD *)CONCAT22(unaff_SS,&prod),
                     (ulong *)rgCost,idPlayer,1);
          cRes._0_2_ = CResourcesAtPlanet(&sel.pl,idPlayer);
          cRes._2_2_ = (int)(uint)cRes >> 0xf;
          uVar11 = __aFulshr(uVar13,in_stack_0000fec4);
          if ((uVar11 & 1) == 0) {
            uVar9 = 0;
            uVar8 = 100;
            uVar11 = __aFulmul((long)(int)(uint)cRes,
                                       (long)(int)*(char *)((int)&rgplr[0].pctResearch +
                                                           idPlayer * 0xc0));
            lVar12 = __aFldiv(uVar11,CONCAT22(uVar9,uVar8));
            bVar10 = (uint)cRes < (uint)lVar12;
            cRes._0_2_ = (uint)cRes - (uint)lVar12;
            cRes._2_2_ = (cRes._2_2_ - (int)((ulong)lVar12 >> 0x10)) - (uint)bVar10;
          }
          uVar11 = __aFulmul(CONCAT22(cRes._2_2_,(uint)cRes),(long)(etaFirst + -1));
          if (CONCAT22(rgCost[3]._2_2_,(undefined2)rgCost[3]) <= (long)uVar11) {
            uVar11 = __aFulshr(uVar13,in_stack_0000fec4);
            uVar4 = (uint)uVar11 & 0xfff;
            uVar5 = CMaxOperableMines(&sel.pl,idPlayer,1);
            cMaxBuild._0_2_ = uVar5 - uVar4;
            cMaxBuild._2_2_ = ((int)uVar5 >> 0xf) - (uint)(uVar5 < uVar4);
            if ((cMaxBuild._2_2_ < 1) && (cMaxBuild._2_2_ < 0)) {
              cMaxBuild._0_2_ = 0;
              cMaxBuild._2_2_ = 0;
            }
            sVar6 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMineBuild);
            uVar11 = __aFulmul((long)sVar6,CONCAT22(cMaxBuild._2_2_,(int)cMaxBuild));
            if ((long)CONCAT22(cRes._2_2_,(uint)cRes) < (long)uVar11) {
              lVar12 = __aFldiv(CONCAT22(cRes._2_2_,(uint)cRes),(long)sVar6);
            }
            else {
              lVar12 = CONCAT22(cMaxBuild._2_2_,(int)cMaxBuild);
            }
            cBuild = lVar12;
            InitProduction(rgprod);
            if (cBuild < 1) {
              etaBetterMines = 700;
              AddItemToQueue(3,1,grobjPlanet,0);
              FinishProduction(1);
            }
            else {
              AddItemToQueue(8,(ushort)cBuild,grobjPlanet,0);
              FinishProduction(1);
              PszProductionETA
                        (&sel.pl,sel.pl.lpplprod,1,&etaBetterMines,(short *)0x0)
              ;
              if (etaBetterMines == -1) {
                etaBetterMines = 700;
              }
              uVar9 = (undefined2)((ulong)sel.pl.lpplprod >> 0x10);
              pPVar7 = (PLPROD *)sel.pl.lpplprod;
              uVar8 = *(undefined2 *)&pPVar7[1].iprodMax;
              (pPVar7 + 1)->wFlags = (pPVar7 + 1)->wFlags & 0xfc00U | 1;
              *(undefined2 *)&pPVar7[1].iprodMax = uVar8;
              uVar8 = (undefined2)((ulong)sel.pl.lpplprod >> 0x10);
              pPVar7 = (PLPROD *)sel.pl.lpplprod;
              uVar4 = *(uint *)&pPVar7[1].iprodMax;
              (pPVar7 + 1)->wFlags = (pPVar7 + 1)->wFlags & 0x3ffU | 0xc00;
              *(uint *)&pPVar7[1].iprodMax = uVar4 & 0xfffe;
            }
            PszProductionETA
                      (&sel.pl,sel.pl.lpplprod,1,&etaBetterAlchemy,(short *)0x0)
            ;
            if (etaBetterAlchemy == -1) {
              etaBetterAlchemy = 700;
            }
            if (((etaFirst <= etaBetterAlchemy) || (etaBetterMines <= etaBetterAlchemy)) &&
               (0 < cBuild)) {
              uVar8 = (undefined2)((ulong)sel.pl.lpplprod >> 0x10);
              pPVar7 = (PLPROD *)sel.pl.lpplprod;
              uVar4 = *(uint *)&pPVar7[1].iprodMax;
              (pPVar7 + 1)->wFlags = (pPVar7 + 1)->wFlags & 0x3ffU | 0x2000;
              *(uint *)&pPVar7[1].iprodMax = uVar4 & 0xfffe;
              if ((etaFirst < etaBetterMines) || (cBuild < 1)) {
                pbVar1 = &((PLPROD *)sel.pl.lpplprod)->iprodMac;
                *pbVar1 = *pbVar1 - 1;
                uVar8 = (undefined2)((ulong)sel.pl.lpplprod >> 0x10);
                pPVar7 = (PLPROD *)sel.pl.lpplprod;
                __fmemmove((PLPROD *)CONCAT22(uVar8,pPVar7 + 1),
                                   (PLPROD *)CONCAT22(uVar8,pPVar7 + 2),(uint)pPVar7->iprodMac << 2)
                ;
              }
              else {
                lVar12 = __aFlshl(uVar13,in_stack_0000fec4);
                uVar8 = (undefined2)((ulong)sel.pl.lpplprod >> 0x10);
                pPVar7 = (PLPROD *)sel.pl.lpplprod;
                uVar4 = *(uint *)&pPVar7[1].iprodMax;
                in_stack_0000fec4 = (pPVar7 + 1)->wFlags & 0xfc00U | (uint)lVar12;
                (pPVar7 + 1)->wFlags = in_stack_0000fec4;
                *(uint *)&pPVar7[1].iprodMax = uVar4 | (uint)((ulong)lVar12 >> 0x10);
              }
            }
          }
        }
      }
    }
    ipl = ipl + 1;
  } while( true );
}



// ======================================================================
// Function: FFleetInField
// Address: 1090:1cf6
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10901d83) */

short FFleetInField(FLEET *lpfl,THING *lpth)

{
  short sVar1;
  short sVar2;
  THING *pTVar3;
  undefined2 uVar4;
  undefined2 uVar5;
  ulong uVar6;
  ulong uVar7;
  long dxy2;
  short dx;
  short dy;
  
  uVar4 = (undefined2)((ulong)lpfl >> 0x10);
  uVar5 = (undefined2)((ulong)lpth >> 0x10);
  pTVar3 = (THING *)lpth;
  sVar1 = _abs((&((FLEET *)lpfl)->pt)->x - (&pTVar3->pt)->x);
  sVar2 = _abs((((FLEET *)lpfl)->pt).y - (pTVar3->pt).y);
  uVar6 = __aFulmul((long)sVar2,(long)sVar2);
  uVar7 = __aFulmul((long)sVar1,(long)sVar1);
  return (uint)((long)(uVar7 + uVar6) <
               CONCAT22(*(undefined2 *)(pTVar3->rgb + 2),*(undefined2 *)pTVar3->rgb));
}



// ======================================================================
// Function: SetAiFleetIdealSpeed
// Address: 1090:1d9e
// Segment: MEMORY_AIU
// ======================================================================


void SetAiFleetIdealSpeed(FLEET *lpfl,short wtFuelMax,short cMinefields,THING **rglpth)

{
  byte bVar1;
  bool bVar2;
  short sVar3;
  THING *pTVar4;
  FLEET *pFVar5;
  undefined2 uVar6;
  undefined2 uVar7;
  short fMinefield;
  THING *lpthMac;
  short ith;
  short j;
  short i;
  THING *lpth;
  
  bVar2 = false;
  pFVar5 = (FLEET *)lpfl;
  uVar7 = (undefined2)((ulong)lpfl >> 0x10);
  if (cMinefields != 0) {
    if (cMinefields == -1) {
      pTVar4 = (THING *)lpThings + cThing;
      lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
      while ((THING *)lpth < pTVar4) {
        uVar6 = (undefined2)((ulong)lpth >> 0x10);
        if (((((uint)lpth->idFull >> 0xd == 0) &&
             (((uint)lpth->idFull >> 9 & 0xf) != idPlayer)) && (((THING *)lpth)->rgb[6] != 2)
            ) && (sVar3 = FFleetInField(lpfl,lpth), sVar3 != 0)) {
          bVar2 = true;
          break;
        }
        lpth = (THING *)CONCAT22(uVar6,(THING *)lpth + 1);
      }
    }
    else {
      for (ith = 0; ith < cMinefields; ith = ith + 1) {
                    /* WARNING: Load size is inaccurate */
        sVar3 = FFleetInField(lpfl,(THING *)CONCAT22(*(undefined2 *)((int)(rglpth + ith) + 2),
                                                     rglpth[ith]));
        if (sVar3 != 0) {
                    /* WARNING: Load size is inaccurate */
          lpth = (THING *)CONCAT22(*(undefined2 *)((int)(rglpth + ith) + 2),rglpth[ith]);
          bVar2 = true;
          break;
        }
      }
    }
  }
  ChangeMainObjSel(2,lpfl->id);
  if (bVar2) {
    bVar1 = ((THING *)lpth)->rgb[6];
    if (bVar1 == 1) {
      i = 6;
    }
    else if (bVar1 == 2) {
      i = 5;
      sVar3 = Random(10);
      if (6 < sVar3) {
        i = 6;
      }
    }
    else {
      i = 4;
      sVar3 = Random(10);
      if (3 < sVar3) {
        i = 5;
      }
    }
    sVar3 = GetRaceStat((PLAYER *)rgplr + idPlayer,rsMajorAdv);
    if (sVar3 == 1) {
      i = i + 1;
    }
  }
  else {
    i = IWarpBestForWaypoint
                  (lpfl,(ORDER *)CONCAT22(*(undefined2 *)((int)&pFVar5->lpplord + 2),
                                          (ORDER *)(*(int *)&pFVar5->lpplord + 0x16)));
  }
  if (i != ((uint)((PLORD *)pFVar5->lpplord + 7)->wFlags >> 4 & 0xf)) {
    uVar7 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
    ((PLORD *)sel.fl.lpplord + 7)->wFlags =
         ((PLORD *)sel.fl.lpplord + 7)->wFlags & 0xff0fU | (i & 0xfU) << 4;
    FLookupFleet(-1,(FLEET *)&sel.fl);
  }
  return;
}



// ======================================================================
// Function: IdTargetAttack
// Address: 1090:1ffe
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10902606) */
/* WARNING: Removing unreachable block (ram,0x10902268) */
/* WARNING: Removing unreachable block (ram,0x10902217) */
/* WARNING: Removing unreachable block (ram,0x1090246d) */
/* WARNING: Removing unreachable block (ram,0x10902757) */

short IdTargetAttack(FLEET *lpfl,FLEET *lpflAtk,FLEET *lpflEnemy,short fOnlyHumans)

{
  int iVar1;
  short sVar2;
  int iVar3;
  int iVar4;
  PLANET *pPVar5;
  int iVar6;
  ulong uVar7;
  ulong uVar8;
  long lVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  ORDER ord;
  FLEET *lpflAtk2;
  short dx;
  byte *lpb;
  PLANET *lpplClosest;
  short cShipsDst;
  short cShipsAtk;
  short i;
  short idClosest;
  long lDist;
  PLANET *lppl;
  short dy;
  POINT pt;
  PLANET *lpplMac;
  long lDistBest;
  FLEET *lpflT;
  FLEET *lpflClosest;
  
  cShipsAtk = 0;
  i = 0;
  while( true ) {
    if (0xf < i) break;
    cShipsAtk = cShipsAtk + ((FLEET *)lpfl)->rgcsh[i];
    i = i + 1;
  }
  lpflClosest = (FLEET *)0x0;
  lpflT = lpflEnemy;
  lVar9 = 1000000;
  iVar1 = (&((FLEET *)lpfl)->pt)->x;
  iVar6 = (((FLEET *)lpfl)->pt).y;
  _memset(&ord,0,0x12);
  while( true ) {
    if (((FLEET *)lpflT == (FLEET *)0x0) && (lpflT._2_2_ == 0)) break;
    if ((fOnlyHumans == 0) ||
       ((*(uint *)((int)&rgplr[0].wMdPlr + ((FLEET *)lpflT)->iPlayer * 0xc0) >> 9 & 1) ==
        0)) {
      lpflAtk2 = lpflAtk;
      cShipsDst = 0;
      while( true ) {
        if (lpflAtk2 == (FLEET *)0x0) break;
        if ((((lpfl != lpflAtk2) && (1 < ((FLEET *)lpflAtk2)->cord)) &&
            (*(int *)&((PLORD *)((FLEET *)lpflAtk2)->lpplord)[6].iordMax == lpflT->id)) &&
           (((uint)((PLORD *)((FLEET *)lpflAtk2)->lpplord + 7)->wFlags >> 8 & 0xf) == 2)) {
          for (i = 0; i < 0x10; i = i + 1) {
            cShipsDst = cShipsDst + ((FLEET *)lpflAtk2)->rgcsh[i];
          }
        }
                    /* WARNING: Load size is inaccurate */
        lpflAtk2 = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflAtk2)->lpflNext + 2),
                                     ((FLEET *)lpflAtk2)->lpflNext);
      }
      if (((cShipsDst < 1) || (sVar2 = Random(3), sVar2 != 0)) &&
         ((cShipsDst * 5 - cShipsAtk == 0 || cShipsDst * 5 < cShipsAtk ||
          (sVar2 = Random(0xf), sVar2 != 0)))) {
        iVar3 = (&((FLEET *)lpflT)->pt)->x - iVar1;
        iVar4 = (((FLEET *)lpflT)->pt).y - iVar6;
        uVar7 = __aFulmul((long)iVar4,(long)iVar4);
        uVar8 = __aFulmul((long)iVar3,(long)iVar3);
        if ((long)(uVar8 + uVar7) < lVar9) {
          lpflClosest = lpflT;
          lVar9 = uVar8 + uVar7;
        }
      }
    }
                    /* WARNING: Load size is inaccurate */
    lpflT = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflT)->lpflNext + 2),
                              ((FLEET *)lpflT)->lpflNext);
  }
  if (lVar9 < 0x7e90) {
    ord.pt.x = (&((FLEET *)lpflClosest)->pt)->x;
    ord.pt.y = (((FLEET *)lpflClosest)->pt).y;
    ord.wFlags = ord.wFlags & 0xf0ffU | 0x200;
    ord.id = lpflClosest->id;
  }
  else {
    if (((FLEET *)lpflClosest == (FLEET *)0x0) && (lpflClosest._2_2_ == 0)) {
      if (fOnlyHumans != 0) {
        sVar2 = IdTargetAttack(lpfl,lpflAtk,lpflEnemy,0);
        return sVar2;
      }
    }
    else {
      uVar11 = 0;
      uVar10 = 2;
      lVar9 = LGetFleetStat(lpfl,1);
      lVar9 = __aFldiv(lVar9,CONCAT22(uVar11,uVar10));
      iVar6 = (int)((ulong)lVar9 >> 0x10);
      iVar1 = *(int *)((int)((FLEET *)lpfl)->rgwtMin + 0x12);
      if ((iVar1 <= iVar6) &&
         (((iVar1 < iVar6 || (*(uint *)(((FLEET *)lpfl)->rgwtMin + 4) < (uint)lVar9)) &&
          (sVar2 = FMoveToNearestStarbase(lpfl,0), sVar2 != 0)))) {
        return 0;
      }
      iVar1 = (&((FLEET *)lpflClosest)->pt)->x;
      iVar6 = (((FLEET *)lpflClosest)->pt).y;
      lpplClosest = (PLANET *)0x0;
      lVar9 = 1000000;
      pPVar5 = (PLANET *)lpPlanets + cPlanet;
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      while ((PLANET *)lppl < pPVar5) {
        lpflAtk2 = lpflAtk;
        while( true ) {
          if ((lpflAtk2 == (FLEET *)0x0) ||
             (((lpfl != lpflAtk2 && (1 < ((FLEET *)lpflAtk2)->cord)) &&
              ((*(int *)&((PLORD *)((FLEET *)lpflAtk2)->lpplord)[6].iordMax == lppl->id &&
               (((uint)((PLORD *)((FLEET *)lpflAtk2)->lpplord + 7)->wFlags >> 8 & 0xf) == 1))))))
          break;
                    /* WARNING: Load size is inaccurate */
          lpflAtk2 = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflAtk2)->lpflNext + 2),
                                       ((FLEET *)lpflAtk2)->lpflNext);
        }
        if (lpflAtk2 == (FLEET *)0x0) {
          iVar3 = ((POINT *)rgptPlan + lppl->id)->x - iVar1;
          iVar4 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4) - iVar6;
          uVar7 = __aFulmul((long)iVar4,(long)iVar4);
          uVar8 = __aFulmul((long)iVar3,(long)iVar3);
          if ((long)(uVar8 + uVar7) < lVar9) {
            lpplClosest = lppl;
            lVar9 = uVar8 + uVar7;
          }
        }
        lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
      }
      if ((((PLANET *)lpplClosest != (PLANET *)0x0) || (lpplClosest._2_2_ != 0)) &&
         (lpplClosest->id != ((FLEET *)lpfl)->idPlanet)) {
        ord.pt.x = ((POINT *)rgptPlan + lpplClosest->id)->x;
        ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplClosest->id * 4);
        ord.wFlags = ord.wFlags & 0xf0ffU | 0x100;
        ord.id = lpplClosest->id;
        goto AIU_ThwakSumthin;
      }
    }
    iVar1 = (&((FLEET *)lpfl)->pt)->x;
    iVar6 = (((FLEET *)lpfl)->pt).y;
    lpplClosest = (PLANET *)0x0;
    lVar9 = 1000000;
    pPVar5 = (PLANET *)lpPlanets + cPlanet;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    while ((PLANET *)lppl < pPVar5) {
      uVar10 = (undefined2)((ulong)lppl >> 0x10);
      if ((((PLANET *)lppl)->iPlayer != -1) && (((PLANET *)lppl)->iPlayer != idPlayer)) {
        iVar3 = ((POINT *)rgptPlan + lppl->id)->x - iVar1;
        iVar4 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4) - iVar6;
        uVar7 = __aFulmul((long)iVar4,(long)iVar4);
        uVar8 = __aFulmul((long)iVar3,(long)iVar3);
        if ((long)(uVar8 + uVar7) < lVar9) {
          lpplClosest = lppl;
          lVar9 = uVar8 + uVar7;
        }
      }
      lppl = (PLANET *)CONCAT22(uVar10,(PLANET *)lppl + 1);
    }
    if ((((PLANET *)lpplClosest == (PLANET *)0x0) && (lpplClosest._2_2_ == 0)) ||
       (lpplClosest->id == ((FLEET *)lpfl)->idPlanet)) {
      idClosest = -1;
      lVar9 = 1000000;
      lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,(byte *)vlpbAiPlanet + 9);
      for (i = 0; i < game.cPlanMax; i = i + 1) {
        if (*lpb == 0) {
          iVar3 = ((POINT *)rgptPlan + i)->x - iVar1;
          iVar4 = *(int *)((int)&rgptPlan[0].y + i * 4) - iVar6;
          uVar7 = __aFulmul((long)iVar4,(long)iVar4);
          uVar8 = __aFulmul((long)iVar3,(long)iVar3);
          if ((long)(uVar8 + uVar7) < lVar9) {
            idClosest = i;
            lVar9 = uVar8 + uVar7;
          }
        }
        lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 0x10);
      }
      if (idClosest == -1) {
        ord.id = Random(game.cPlanMax);
        ord.wFlags = ord.wFlags & 0xf0ffU | 0x100;
        ord.pt.x = ((POINT *)rgptPlan + ord.id)->x;
        ord.pt.y = *(short *)((int)&rgptPlan[0].y + ord.id * 4);
      }
      else {
        ord.pt.x = ((POINT *)rgptPlan + idClosest)->x;
        ord.pt.y = *(short *)((int)&rgptPlan[0].y + idClosest * 4);
        ord.wFlags = ord.wFlags & 0xf0ffU | 0x100;
        ord.id = idClosest;
      }
    }
    else {
      ord.pt.x = ((POINT *)rgptPlan + lpplClosest->id)->x;
      ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplClosest->id * 4);
      ord.wFlags = ord.wFlags & 0xf0ffU | 0x100;
      ord.id = lpplClosest->id;
    }
  }
AIU_ThwakSumthin:
  if (((((FLEET *)lpfl)->cord < 2) ||
      (((uint)((PLORD *)((FLEET *)lpfl)->lpplord + 7)->wFlags >> 8 & 0xf) != 1)) ||
     (((uint)ord.wFlags >> 8 & 0xf) != 1)) {
    ord.wFlags = ord.wFlags & 0xef00U | 0x1040;
    sVar2 = FMoveAiFleet(lpfl,&ord,0);
    if (sVar2 == 0) {
      sVar2 = -1;
    }
    else {
      sVar2 = 0;
    }
  }
  else {
    sVar2 = -1;
  }
  return sVar2;
}



// ======================================================================
// Function: IdTargetFreighter
// Address: 1090:286c
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10902f9e) */
/* WARNING: Removing unreachable block (ram,0x10902fc3) */
/* WARNING: Removing unreachable block (ram,0x10902fc8) */
/* WARNING: Removing unreachable block (ram,0x10903896) */
/* WARNING: Removing unreachable block (ram,0x1090388d) */
/* WARNING: Removing unreachable block (ram,0x10903112) */
/* WARNING: Removing unreachable block (ram,0x109029a1) */
/* WARNING: Removing unreachable block (ram,0x109029d0) */
/* WARNING: Removing unreachable block (ram,0x10902b0c) */
/* WARNING: Removing unreachable block (ram,0x10903249) */

short IdTargetFreighter(FLEET *lpflFr,PLANET *lpplHome)

{
  uint uVar1;
  FLEET *pFVar2;
  double dVar3;
  PLANET *pPVar4;
  int iVar5;
  short sVar6;
  PLANET *pPVar7;
  int iVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar9;
  long lVar10;
  ulong uVar11;
  long lVar12;
  PLANET *pPVar13;
  undefined2 uVar14;
  ushort in_stack_0000ff92;
  long l;
  short fSalvage;
  ORDER ord;
  short fNeedy;
  byte *lpb;
  short dx;
  short pctHere;
  short ishFreighter;
  PLANET *lpplBest;
  short iWorst;
  THING *lpthBest;
  long wtCargoFree;
  short iWorst2;
  short i;
  short ifl;
  long wtCargoMax;
  FLEET *lpfl;
  long wtPlanCargo;
  PLANET *lppl;
  short idBest;
  short pctFull;
  long lWorst;
  short dy;
  POINT pt;
  long score;
  PLANET *lpplMac;
  long scoreBest;
  long lWorst2;
  
  lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,(byte *)vlpbAiPlanet + 0xe);
  for (i = 0; i < game.cPlanMax; i = i + 1) {
    *lpb = 0;
    lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 0x10);
  }
  ishFreighter = 0;
  while( true ) {
    if ((0xf < ishFreighter) || (0 < ((FLEET *)lpflFr)->rgcsh[ishFreighter])) break;
    ishFreighter = ishFreighter + 1;
  }
  lWorst._0_2_ = 0xca00;
  lWorst._2_2_ = 0x3b9a;
  i = 0;
  while( true ) {
    if (2 < i) break;
    uVar1 = *(uint *)((int)(((PLANET *)lpplHome)->rgwtMin + i) + 2);
    if (((int)uVar1 <= lWorst._2_2_) &&
       (((int)uVar1 < lWorst._2_2_ || (*(uint *)(((PLANET *)lpplHome)->rgwtMin + i) < (uint)lWorst))
       )) {
      iWorst2 = iWorst;
      lWorst._0_2_ = *(uint *)(((PLANET *)lpplHome)->rgwtMin + i);
      lWorst._2_2_ = *(int *)((int)(((PLANET *)lpplHome)->rgwtMin + i) + 2);
      iWorst = i;
    }
    i = i + 1;
  }
  lVar10 = __aFlshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff92);
  fNeedy = (short)(CONCAT22(lWorst._2_2_,(uint)lWorst) < lVar10);
  lVar10 = __aFlshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ff92);
  if (CONCAT22(lWorst._2_2_,(uint)lWorst) < lVar10) {
    fNeedy = fNeedy + 1;
  }
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar2 = ((FLEET **)rglpfl)[ifl];
    iVar5 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar5,pFVar2);
    if ((pFVar2 == (FLEET *)0x0) && (iVar5 == 0)) break;
    if (((pFVar2->iPlayer == idPlayer) &&
        (((1 < pFVar2->cord && (lpflFr != lpfl)) &&
         (((uint)((PLORD *)pFVar2->lpplord + 7)->wFlags >> 8 & 0xf) == 1)))) &&
       ((pFVar2->rgcsh[ishFreighter] != 0 &&
        (*(int *)&((PLORD *)pFVar2->lpplord)[6].iordMax != lpplHome->id)))) {
      ((byte *)vlpbAiPlanet)[*(int *)&((PLORD *)pFVar2->lpplord)[6].iordMax * 0x10 + 0xe] = 1
      ;
    }
  }
  wtCargoMax = LGetFleetStat(lpflFr,2);
  wtCargoFree = GetCargoFree(lpflFr);
  if (wtCargoMax < 1) {
    return -1;
  }
  lVar10 = wtCargoMax;
  uVar11 = __aFulmul(wtCargoFree,100);
  lVar10 = __aFldiv(uVar11,lVar10);
  pctFull = 100 - (int)lVar10;
  lVar10 = 0;
  idBest = -1;
  pt.x = (&((FLEET *)lpflFr)->pt)->x;
  pt.y = (((FLEET *)lpflFr)->pt).y;
  pPVar7 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  pPVar4 = (PLANET *)lpPlanets;
  while ((PLANET *)lppl < pPVar7) {
    if ((lppl->id == ((FLEET *)lpflFr)->idPlanet) ||
       (((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 0xe] != 0)) goto LAB_1090_3272;
    uVar9 = (undefined2)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl)->iPlayer == -1) &&
       ((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] & 0x80) != 0)) {
      iVar5 = pt.x - ((POINT *)rgptPlan + lppl->id)->x;
      dy = pt.y - *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
      pPVar13 = (PLANET *)__aFulmul((long)dy,(long)dy);
      pPVar4 = (PLANET *)pPVar13;
      uVar11 = __aFulmul((long)iVar5,(long)iVar5);
      uVar14 = 0;
      uVar9 = 0x19;
      dVar3 = (double)(long)(((PLANET *)CONCAT22((int)((ulong)pPVar13 >> 0x10),pPVar4))->
                             rgpctMinLevel + (uVar11 - 6));
      _sqrt(SUB84(dVar3,0),(double)(qword)CONCAT24(0x19,(long)((qword)dVar3 >> 0x20)));
      lVar12 = __ftol((double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,CONCAT22(uVar14,uVar9))));
      l = __aFldiv(lVar12 + 0x18,CONCAT22(uVar14,uVar9));
      if (((int)((ulong)l >> 0x10) < 1) && ((l < 0 || ((int)l == 0)))) {
        l = 1;
      }
      lVar12 = __aFldiv((long)(int)((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 1] &
                                            0x7f) * 500),l);
      goto AIU_LScore;
    }
    if (((PLANET *)lppl)->iPlayer != idPlayer) {
      if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 0) ||
          (lpplHome->id != ((FLEET *)lpflFr)->idPlanet)) ||
         (((iVar5 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe), iVar5 < 0 ||
           (((iVar5 < 1 && (*(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) < 0x44d)) ||
            (0x3d < (((PLANET *)lppl)->uGuesses & 0xfffU))))) &&
          ((iVar5 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe), iVar5 < 0 ||
           (((iVar5 < 1 && (*(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) < 0x12d)) ||
            (0xe < (((PLANET *)lppl)->uGuesses & 0xfffU))))))))) {
        if (((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 3] == 0) ||
            ((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 3] & 0x80) != 0)) ||
           (lpplHome->id != ((FLEET *)lpflFr)->idPlanet)) goto LAB_1090_3272;
        goto LAB_1090_2e39;
      }
      pctHere = 0x41;
AIU_ScorePctHere:
      iVar5 = pt.x - ((POINT *)rgptPlan + lppl->id)->x;
      dy = pt.y - *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
      pPVar13 = (PLANET *)__aFulmul((long)dy,(long)dy);
      pPVar4 = (PLANET *)pPVar13;
      uVar11 = __aFulmul((long)iVar5,(long)iVar5);
      uVar14 = 0;
      uVar9 = 0x19;
      dVar3 = (double)(long)(((PLANET *)CONCAT22((int)((ulong)pPVar13 >> 0x10),pPVar4))->
                             rgpctMinLevel + (uVar11 - 6));
      _sqrt(SUB84(dVar3,0),(double)(qword)CONCAT24(0x19,(long)((qword)dVar3 >> 0x20)));
      lVar12 = __ftol((double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,CONCAT22(uVar14,uVar9))));
      l = __aFldiv(lVar12 + 0x18,CONCAT22(uVar14,uVar9));
      if (((int)((ulong)l >> 0x10) < 1) && ((l < 0 || ((int)l == 0)))) {
        l = 1;
      }
      lVar12 = __aFldiv((long)(pctHere * 100),l);
      goto AIU_LScore;
    }
LAB_1090_2e39:
    if (lpplHome == lppl) {
      if (0x22 < pctFull) {
        if (pctFull == 100) {
          lVar12 = 25000;
        }
        else {
          iVar5 = pt.x - ((POINT *)rgptPlan + lppl->id)->x;
          dy = pt.y - *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
          pPVar13 = (PLANET *)__aFulmul((long)dy,(long)dy);
          pPVar4 = (PLANET *)pPVar13;
          uVar11 = __aFulmul((long)iVar5,(long)iVar5);
          uVar14 = 0;
          uVar9 = 0x19;
          dVar3 = (double)(long)(((PLANET *)CONCAT22((int)((ulong)pPVar13 >> 0x10),pPVar4))->
                                 rgpctMinLevel + (uVar11 - 6));
          _sqrt(SUB84(dVar3,0),(double)(qword)CONCAT24(0x19,(long)((qword)dVar3 >> 0x20)));
          lVar12 = __ftol((double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,CONCAT22(uVar14,uVar9)
                                                                    )));
          lVar12 = __aFldiv(lVar12 + 0x18,CONCAT22(uVar14,uVar9));
          if (((int)lVar12 == 0) && ((int)((ulong)lVar12 >> 0x10) == 0)) goto LAB_1090_3272;
          lVar12 = __aFldiv((long)(pctFull * 0x14),lVar12);
        }
AIU_LScore:
        if (lVar10 < lVar12) {
          lpplBest = lppl;
          idBest = lppl->id;
          lVar10 = lVar12;
        }
      }
    }
    else if (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) == 0) {
      if ((*(int *)&((PLANET *)lppl)->lpplprod != 0) ||
         (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) {
        uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),(ushort)pPVar4);
        if (((uint)uVar11 & 7) == 2) {
          uVar11 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),(ushort)pPVar4);
          if (0xf < ((uint)uVar11 & 0x7f)) goto LAB_1090_3272;
        }
      }
      if (((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] != 0) &&
          ((((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] & 0x80) == 0)) &&
         (lpplHome->id == ((FLEET *)lpflFr)->idPlanet)) {
        lVar12 = 25000;
        goto AIU_LScore;
      }
      if (fNeedy == 2) {
        wtPlanCargo = CONCAT22(*(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + iWorst) + 2),
                               (int)((PLANET *)lppl)->rgwtMin[iWorst]);
      }
      else {
        wtPlanCargo = 0;
        for (i = 0; i < 3; i = i + 1) {
          if ((fNeedy == 0) || (i == iWorst)) {
            wtPlanCargo = wtPlanCargo +
                          CONCAT22(*(undefined2 *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2),
                                   (int)((PLANET *)lppl)->rgwtMin[i]);
          }
          else {
            lVar12 = __aFlshr(CONCAT22(unaff_SI,unaff_DI),(ushort)pPVar4);
            wtPlanCargo = lVar12 + wtPlanCargo;
          }
        }
      }
      if (9 < wtPlanCargo) {
        lVar12 = wtCargoMax;
        uVar11 = __aFulmul(wtPlanCargo,100);
        lVar12 = __aFldiv(uVar11,lVar12);
        pctHere = (short)lVar12;
        if (100 - pctFull < pctHere) {
          pctHere = 100 - pctFull;
        }
        goto AIU_ScorePctHere;
      }
    }
LAB_1090_3272:
    lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
  }
  lpthBest = (THING *)0x0;
  sVar6 = FSalvageTargetFreighter2(lpflFr,fNeedy,iWorst,pctFull,wtCargoMax,lVar10,&lpthBest,&idBest)
  ;
  if (sVar6 != 0) {
    lVar10 = GetCargoFree(lpflFr);
    if (lVar10 == 0) {
      lpthBest = (THING *)0x0;
      lpplBest = lpplHome;
      idBest = lpplHome->id;
    }
  }
  if (idBest == -1) {
    return -1;
  }
  _memset(&ord,0,0x12);
  if (((THING *)lpthBest == (THING *)0x0) && (lpthBest._2_2_ == 0)) {
    ord.wFlags = ord.wFlags & 0xf0ffU | 0x100;
    ord.pt.x = ((POINT *)rgptPlan + idBest)->x;
    ord.pt.y = *(short *)((int)&rgptPlan[0].y + idBest * 4);
  }
  else {
    ord.wFlags = ord.wFlags & 0xf0ffU | 0x800;
    ord.pt.x = (&((THING *)lpthBest)->pt)->x;
    ord.pt.y = (((THING *)lpthBest)->pt).y;
  }
  ord.id = idBest;
  ord.wFlags = ord.wFlags & 0xef00U | 0x1041;
  i = 0;
  while( true ) {
    if (2 < i) break;
    if ((((THING *)lpthBest == (THING *)0x0) && (lpthBest._2_2_ == 0)) && (idBest == lpplHome->id))
    {
      iVar5 = 2;
    }
    else {
      iVar5 = 1;
    }
    (ord.txp.rgia + i)->wFlags = (ord.txp.rgia + i)->wFlags & 0xfffU | iVar5 << 0xc;
    i = i + 1;
  }
  if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 1) {
    if (lpplHome->id == ((FLEET *)lpflFr)->idPlanet) {
      ChangeMainObjSel(2,lpflFr->id);
      iVar5 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
      if ((-1 < iVar5) &&
         ((((0 < iVar5 || (0x4b0 < *(uint *)(((PLANET *)lpplHome)->rgwtMin + 3))) &&
           ((THING *)lpthBest == (THING *)0x0)) &&
          ((lpthBest._2_2_ == 0 && (((PLANET *)lpplBest)->iPlayer != -1)))))) {
        iVar5 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
        iVar8 = *(int *)((int)((PLANET *)lpplBest)->rgwtMin + 0xe);
        if ((iVar8 <= iVar5) &&
           ((iVar8 < iVar5 ||
            (*(uint *)(((PLANET *)lpplBest)->rgwtMin + 3) <
             *(uint *)(((PLANET *)lpplHome)->rgwtMin + 3))))) {
          XferAiSupply(1,((FLEET *)lpflFr)->idPlanet,2,lpflFr->id,3,1000);
        }
      }
      FLookupFleet(lpflFr->id,(FLEET *)&sel.fl);
    }
    lVar10 = wtCargoFree;
    if (((((THING *)lpthBest == (THING *)0x0) && (lpthBest._2_2_ == 0)) &&
        (((PLANET *)lpplBest)->iPlayer != -1)) && (lpplHome != lpplBest)) {
      ord.txp.rgia[3].wFlags = ord.txp.rgia[3].wFlags & 0xfffU | 0x2000;
    }
  }
  else {
    lVar10 = wtCargoFree;
    if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) &&
        (lpplHome->id == ((FLEET *)lpflFr)->idPlanet)) &&
       (((THING *)lpthBest == (THING *)0x0 &&
        ((lpthBest._2_2_ == 0 && (((PLANET *)lpplBest)->iPlayer != -1)))))) {
      if (((PLANET *)lpplBest)->iPlayer == idPlayer) {
        iVar5 = *(int *)((int)((PLANET *)lpplBest)->rgwtMin + 0xe);
        if ((iVar5 < 1) && ((iVar5 < 0 || (*(uint *)(((PLANET *)lpplBest)->rgwtMin + 3) < 1000)))) {
          uVar14 = 0;
          uVar9 = 2;
          uVar11 = __aFulmul(CONCAT22(*(undefined2 *)
                                               ((int)((PLANET *)lpplBest)->rgwtMin + 0xe),
                                              (int)((PLANET *)lpplBest)->rgwtMin[3]),3);
          lVar12 = __aFldiv(uVar11,CONCAT22(uVar14,uVar9));
          iVar8 = (int)((ulong)lVar12 >> 0x10);
          iVar5 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
          lVar10 = wtCargoFree;
          if (((iVar8 <= iVar5) &&
              (((iVar8 < iVar5 || ((uint)lVar12 < *(uint *)(((PLANET *)lpplHome)->rgwtMin + 3))) &&
               (iVar5 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe), -1 < iVar5)))) &&
             ((0 < iVar5 || (500 < *(uint *)(((PLANET *)lpplHome)->rgwtMin + 3))))) {
            iVar5 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
            if ((iVar5 < 0) ||
               ((iVar5 < 1 && (*(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) < 0x7d1)))) {
              iVar5 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
              if ((iVar5 < 0) ||
                 ((iVar5 < 1 && (*(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) < 0x5dd)))) {
                iVar5 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
                if ((iVar5 < 0) ||
                   ((iVar5 < 1 && (*(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) < 0x3e9)))) {
                  l = __aFldiv(CONCAT22(*(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe) +
                                                -1 + (uint)(399 < *(uint *)(((PLANET *)lpplHome)->
                                                                            rgwtMin + 3)),
                                                *(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) - 400),
                                       100);
                }
                else {
                  l = 5;
                }
              }
              else {
                l = 8;
              }
            }
            else {
              l = 10;
            }
            uVar14 = 0;
            uVar9 = 100;
            uVar11 = __aFulmul(CONCAT22(*(undefined2 *)
                                                 ((int)((PLANET *)lpplHome)->rgwtMin + 0xe),
                                                (int)((PLANET *)lpplHome)->rgwtMin[3]),l);
            lVar10 = __aFldiv(uVar11,CONCAT22(uVar14,uVar9));
            ChangeMainObjSel(2,lpflFr->id);
            XferAiSupply(1,((FLEET *)lpflFr)->idPlanet,2,lpflFr->id,3,(short)lVar10);
            FLookupFleet(lpflFr->id,(FLEET *)&sel.fl);
            ord.txp.rgia[3].wFlags = ord.txp.rgia[3].wFlags & 0xfffU | 0x2000;
            lVar10 = wtCargoFree;
          }
        }
      }
      else {
        ChangeMainObjSel(2,lpflFr->id);
        iVar5 = *(int *)((int)((PLANET *)lpplHome)->rgwtMin + 0xe);
        if ((iVar5 < 0) || ((iVar5 < 1 && (*(uint *)(((PLANET *)lpplHome)->rgwtMin + 3) < 0x385))))
        {
          XferAiSupply(1,((FLEET *)lpflFr)->idPlanet,2,lpflFr->id,3,100);
        }
        else {
          XferAiSupply(1,((FLEET *)lpflFr)->idPlanet,2,lpflFr->id,3,300);
        }
        FLookupFleet(lpflFr->id,(FLEET *)&sel.fl);
        ord.txp.rgia[3].wFlags = ord.txp.rgia[3].wFlags & 0xfffU | 0x2000;
        lVar10 = wtCargoFree;
      }
    }
  }
  wtCargoFree._2_2_ = (int)((ulong)lVar10 >> 0x10);
  wtCargoFree._0_2_ = (uint)lVar10;
  if (((THING *)lpthBest == (THING *)0x0) && (lpthBest._2_2_ == 0)) {
    if ((lpplHome->id != idBest) && (fNeedy != 0)) {
      if (fNeedy != 2) {
        uVar1 = *(uint *)((int)(((PLANET *)lpplBest)->rgwtMin + iWorst) + 2);
        if (((int)uVar1 < wtCargoFree._2_2_) ||
           (((int)uVar1 <= wtCargoFree._2_2_ &&
            (*(uint *)(((PLANET *)lpplBest)->rgwtMin + iWorst) < (uint)wtCargoFree)))) {
          if (((PLANET *)lpplBest)->iPlayer != -1) {
            for (i = 0; i < 3; i = i + 1) {
              wtCargoFree = lVar10;
              (ord.txp.rgia + i)->wFlags = (ord.txp.rgia + i)->wFlags & 0xfffU | 0x5000;
              if (i == iWorst) {
                l._0_2_ = 0x42;
              }
              else {
                l._0_2_ = 0x21;
              }
              (ord.txp.rgia + i)->wFlags = (ord.txp.rgia + i)->wFlags & 0xf000U | (uint)l;
              lVar10 = wtCargoFree;
            }
          }
          goto LAB_1090_392a;
        }
      }
      for (i = 0; i < 3; i = i + 1) {
        if (i != iWorst) {
          wtCargoFree = lVar10;
          (ord.txp.rgia + i)->wFlags = (ord.txp.rgia + i)->wFlags & 0xfff;
          lVar10 = wtCargoFree;
        }
      }
    }
  }
  else {
    ord.wFlags = ord.wFlags & 0xeff0;
  }
LAB_1090_392a:
  wtCargoFree = lVar10;
  sVar6 = FMoveAiFleet(lpflFr,&ord,0);
  if (sVar6 == 0) {
    idBest = -1;
  }
  return idBest;
}



// ======================================================================
// Function: FSalvageTargetFreighter2
// Address: 1090:395a
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10903cbf) */

short FSalvageTargetFreighter2
          (FLEET *lpflFr,short fNeedy,short iWorst,short pctFull,long wtCargoMax,long scoreBest,
          THING **plpthBest,short *pidBest)

{
  int iVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  int iVar5;
  uint uVar6;
  THING *pTVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar8;
  ulong uVar9;
  long lVar10;
  ulong uVar11;
  undefined2 uVar12;
  undefined2 uVar13;
  long l;
  short fSalvage;
  THING *lpthMac;
  short dx;
  short pctHere;
  THING *lpth;
  long wtPlanCargo;
  short i;
  short dy;
  long score;
  POINT pt;
  
  fSalvage = 0;
  uVar8 = (undefined2)((ulong)lpflFr >> 0x10);
  iVar1 = (&((FLEET *)lpflFr)->pt)->x;
  iVar2 = (((FLEET *)lpflFr)->pt).y;
  pTVar7 = (THING *)lpThings + cThing;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  while ((THING *)lpth < pTVar7) {
    uVar8 = (undefined2)((ulong)lpth >> 0x10);
    if (((uint)lpth->idFull >> 0xd == 1) && ((*(uint *)((THING *)lpth)->rgb >> 10 & 0xf) == 0)) {
      iVar3 = iVar1 - (&((THING *)lpth)->pt)->x;
      iVar4 = iVar2 - (((THING *)lpth)->pt).y;
      if ((iVar3 == 0) && (iVar4 == 0)) {
        if ((fNeedy != 0) && (*(int *)(((THING *)lpth)->rgb + iWorst * 2 + 2) != 0)) {
          XferAiSupply(8,lpth->idFull,2,lpflFr->id,iWorst,
                       *(short *)(((THING *)lpth)->rgb + iWorst * 2 + 2));
        }
        if (fNeedy != 2) {
          for (i = 0; i < 3; i = i + 1) {
            if (*(int *)(((THING *)lpth)->rgb + i * 2 + 2) != 0) {
              XferAiSupply(8,lpth->idFull,2,lpflFr->id,i,
                           *(short *)(((THING *)lpth)->rgb + i * 2 + 2));
            }
          }
        }
        fSalvage = 1;
        FLookupFleet(lpflFr->id,(FLEET *)&sel.fl);
      }
      else {
        iVar5 = iVar3;
        if (iVar3 <= iVar4) {
          iVar5 = iVar4;
        }
        if (iVar5 < 0xc9) {
          if (fNeedy == 2) {
            wtPlanCargo._0_2_ = *(uint *)(((THING *)lpth)->rgb + iWorst * 2 + 2);
            wtPlanCargo._2_2_ = (int)(uint)wtPlanCargo >> 0xf;
          }
          else {
            wtPlanCargo._0_2_ = 0;
            wtPlanCargo._2_2_ = 0;
            for (i = 0; i < 3; i = i + 1) {
              if ((fNeedy == 0) || (i == iWorst)) {
                uVar6 = *(uint *)(((THING *)lpth)->rgb + i * 2 + 2);
                wtPlanCargo._2_2_ =
                     wtPlanCargo._2_2_ + ((int)uVar6 >> 0xf) + (uint)CARRY2((uint)wtPlanCargo,uVar6)
                ;
              }
              else {
                uVar6 = *(int *)(((THING *)lpth)->rgb + i * 2 + 2) >> 1;
                wtPlanCargo._2_2_ =
                     wtPlanCargo._2_2_ + (*(int *)(((THING *)lpth)->rgb + i * 2 + 2) >> 0xf) +
                     (uint)CARRY2((uint)wtPlanCargo,uVar6);
              }
              wtPlanCargo._0_2_ = (uint)wtPlanCargo + uVar6;
            }
          }
          if ((0 < wtPlanCargo._2_2_) || ((-1 < wtPlanCargo._2_2_ && (9 < (uint)wtPlanCargo)))) {
            lVar10 = wtCargoMax;
            uVar9 = __aFulmul(CONCAT22(wtPlanCargo._2_2_,(uint)wtPlanCargo),100);
            lVar10 = __aFldiv(uVar9,lVar10);
            pctHere = (short)lVar10;
            if (100 - pctFull < pctHere) {
              pctHere = 100 - pctFull;
            }
            uVar9 = __aFulmul((long)iVar4,(long)iVar4);
            uVar11 = __aFulmul((long)iVar3,(long)iVar3);
            uVar13 = 0;
            uVar12 = 0x19;
            _sqrt(SUB84((double)(long)(uVar11 + uVar9),0),
                          (double)(qword)CONCAT24(0x19,(long)((qword)(double)(long)(uVar11 + uVar9)
                                                             >> 0x20)));
            lVar10 = __ftol((double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,CONCAT22(uVar13,
                                                  uVar12))));
            l = __aFldiv(lVar10 + 0x18,CONCAT22(uVar13,uVar12));
            if (((int)((ulong)l >> 0x10) < 1) && ((l < 0 || ((int)l == 0)))) {
              l = 1;
            }
            lVar10 = __aFldiv((long)(pctHere * 100),l);
            if (scoreBest < lVar10) {
              *(THING **)plpthBest = (THING *)lpth;
              *(undefined2 *)((int)plpthBest + 2) = uVar8;
              *pidBest = lpth->idFull;
              scoreBest = lVar10;
            }
          }
        }
      }
    }
    lpth = (THING *)CONCAT22(uVar8,(THING *)lpth + 1);
  }
  return fSalvage;
}



// ======================================================================
// Function: FMoveAiFleet
// Address: 1090:3d0a
// Segment: MEMORY_AIU
// ======================================================================


short FMoveAiFleet(FLEET *lpfl,ORDER *pord,short fAppend)

{
  ORDER *pOVar1;
  short *psVar2;
  undefined2 uVar3;
  short sVar4;
  int iVar5;
  short *psVar6;
  short iord;
  
  ChangeMainObjSel(2,lpfl->id);
  if ((uint)((PLORD *)sel.fl.lpplord)->iordMax == sel.fl.cord) {
    sel.fl.lpplord =
         (PLORD *)LpplReAlloc((PL *)sel.fl.lpplord,sel.fl.cord + 1);
  }
  if (fAppend == 0) {
    iord = 0;
  }
  else {
    iord = sel.fl.cord + -1;
  }
  if (((pord->pt).x == *(int *)((int)(PLORD *)sel.fl.lpplord + iord * 0x12 + 4)) &&
     ((pord->pt).y == *(int *)((int)(PLORD *)sel.fl.lpplord + iord * 0x12 + 6))) {
    if (1 < sel.fl.cord) {
      sel.fl.cord = 1;
      FLookupFleet(-1,(FLEET *)&sel.fl);
    }
  }
  else {
    iord = iord + 1;
  }
  uVar3 = sel.fl.lpplord._2_2_;
  psVar6 = (short *)((int)(PLORD *)sel.fl.lpplord + iord * 0x12 + 4);
  for (iVar5 = 9; iVar5 != 0; iVar5 = iVar5 + -1) {
    psVar2 = psVar6;
    psVar6 = psVar6 + 1;
    pOVar1 = pord;
    pord = (ORDER *)&(pord->pt).y;
    *psVar2 = (pOVar1->pt).x;
  }
  sel.fl.cord = iord + 1;
  ((PLORD *)sel.fl.lpplord)->iordMac = (byte)sel.fl.cord;
  sVar4 = FLookupFleet(-1,(FLEET *)&sel.fl);
  return sVar4;
}



// ======================================================================
// Function: AddItemToQueue
// Address: 1090:3e50
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10903ee7) */
/* WARNING: Removing unreachable block (ram,0x10903f1b) */

void AddItemToQueue(ushort iItem,ushort cItem,GrobjClass grobj,short mdAddItem)

{
  byte *pbVar1;
  uint uVar2;
  bool bVar3;
  PLPROD *pPVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  ulong uVar6;
  long lVar7;
  ulong uVar8;
  uint in_stack_0000fef4;
  PROD rgprod [64];
  short i;
  short iprod;
  short fSingle;
  
  uVar8 = CONCAT22(unaff_SI,unaff_DI);
  bVar3 = false;
  if ((sel.pl.lpplprod != (PLPROD *)0x0) &&
     (200 < ((PLPROD *)sel.pl.lpplprod)->iprodMac)) {
    return;
  }
  if (((PLPROD *)lpplProdGlob == (PLPROD *)0x0) && (lpplProdGlob._2_2_ == 0)) {
    bVar3 = true;
    InitProduction(rgprod);
    i = 0;
    while ((i < cProdGlob &&
           ((uVar6 = __aFulshr(uVar8,in_stack_0000fef4), ((uint)uVar6 & 0x7f) != iItem ||
            (uVar6 = __aFulshr(uVar8,in_stack_0000fef4),
            ((GrobjClass)uVar6 & (grobjOther|grobjFleet|grobjPlanet)) != grobj))))) {
      i = i + 1;
    }
    if (i < cProdGlob) {
      if (((uint)(rgprod + i)->dwFlags & 0x3ff) <= cItem) {
        cItem = (uint)(rgprod + i)->dwFlags & 0x3ff;
      }
    }
    else {
      cItem = 0;
    }
  }
  if (cItem == 0) goto LAB_1090_4230;
  if (mdAddItem != 2) {
    uVar5 = (undefined2)((ulong)lpplProdGlob >> 0x10);
    pPVar4 = (PLPROD *)lpplProdGlob;
    in_stack_0000fef4 = (uint)pPVar4->iprodMac;
    if (in_stack_0000fef4 == pPVar4->iprodMax) {
      lpplProdGlob =
           (PLPROD *)LpplReAlloc((PL *)lpplProdGlob,pPVar4->iprodMac + 3);
    }
  }
  pPVar4 = (PLPROD *)lpplProdGlob;
  uVar5 = (undefined2)((ulong)lpplProdGlob >> 0x10);
  if (mdAddItem == 0) {
    iprod = 0;
    __fmemmove((PLPROD *)CONCAT22(uVar5,pPVar4 + 2),(PLPROD *)CONCAT22(uVar5,pPVar4 + 1),
                       (uint)pPVar4->iprodMac << 2);
    __fmemset((PLPROD *)
                      CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob + 1),0,4);
  }
  else {
    if (mdAddItem != 1) {
      if (mdAddItem != 2) goto LAB_1090_407b;
      pPVar4->iprodMac = 0;
    }
    iprod = (short)((PLPROD *)lpplProdGlob)->iprodMac;
  }
LAB_1090_407b:
  lVar7 = __aFlshl(uVar8,in_stack_0000fef4);
  uVar5 = lpplProdGlob._2_2_;
  uVar2 = *(uint *)&((PLPROD *)lpplProdGlob)[iprod + 1].iprodMax;
  pPVar4 = (PLPROD *)lpplProdGlob + iprod + 1;
  pPVar4->wFlags = ((PLPROD *)lpplProdGlob + iprod + 1)->wFlags & 0xfc00U | (uint)lVar7;
  *(uint *)&pPVar4->iprodMax = uVar2 | (uint)((ulong)lVar7 >> 0x10);
  lVar7 = __aFlshl(uVar8,in_stack_0000fef4);
  uVar5 = lpplProdGlob._2_2_;
  uVar2 = *(uint *)&((PLPROD *)lpplProdGlob)[iprod + 1].iprodMax;
  pPVar4 = (PLPROD *)lpplProdGlob + iprod + 1;
  pPVar4->wFlags = ((PLPROD *)lpplProdGlob + iprod + 1)->wFlags & 0x3ffU | (uint)lVar7;
  *(uint *)&pPVar4->iprodMax = uVar2 & 0xfffe | (uint)((ulong)lVar7 >> 0x10);
  lVar7 = __aFlshl(uVar8,in_stack_0000fef4);
  uVar5 = lpplProdGlob._2_2_;
  uVar2 = *(uint *)&((PLPROD *)lpplProdGlob)[iprod + 1].iprodMax;
  pPVar4 = (PLPROD *)lpplProdGlob + iprod + 1;
  pPVar4->wFlags = ((PLPROD *)lpplProdGlob + iprod + 1)->wFlags | (uint)lVar7;
  *(uint *)&pPVar4->iprodMax = uVar2 & 0xfff1 | (uint)((ulong)lVar7 >> 0x10);
  uVar5 = lpplProdGlob._2_2_;
  uVar2 = *(uint *)&((PLPROD *)lpplProdGlob)[iprod + 1].iprodMax;
  pPVar4 = (PLPROD *)lpplProdGlob + iprod + 1;
  pPVar4->wFlags = ((PLPROD *)lpplProdGlob + iprod + 1)->wFlags;
  *(uint *)&pPVar4->iprodMax = uVar2 & 0xf80f;
  uVar5 = lpplProdGlob._2_2_;
  uVar2 = *(uint *)&((PLPROD *)lpplProdGlob)[iprod + 1].iprodMax;
  pPVar4 = (PLPROD *)lpplProdGlob + iprod + 1;
  pPVar4->wFlags = ((PLPROD *)lpplProdGlob + iprod + 1)->wFlags;
  *(uint *)&pPVar4->iprodMax = uVar2 & 0x7ff;
  pbVar1 = &((PLPROD *)lpplProdGlob)->iprodMac;
  *pbVar1 = *pbVar1 + 1;
LAB_1090_4230:
  if (bVar3) {
    FinishProduction((uint)(cItem != 0));
  }
  return;
}



// ======================================================================
// Function: IroEnsureAi
// Address: 1090:425a
// Segment: MEMORY_AIU
// ======================================================================


short IroEnsureAi(byte *lpbRes,short cRes,short *pishdefSBLatest,short pct)

{
  short sVar1;
  int iVar2;
  short ilvl;
  short pctTech;
  short i;
  short iSmallest;
  
  if (pishdefSBLatest != (short *)0x0) {
    EnsureAiStarbaseDesigns();
    sVar1 = IshdefAiSBLatest();
    *pishdefSBLatest = sVar1;
    ValidateStarbaseHistory();
  }
  *(undefined1 *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) = (char)pct;
  for (i = 0; (i < 6 && ('\x17' < *(char *)(idPlayer * 0xc0 + 0x59bc + i))); i = i + 1) {
  }
  if (i == 6) {
    *(undefined1 *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) = 0;
    pctTech = (int)*(char *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) << 8;
    WriteMemRt(0x22,2,&pctTech);
  }
  i = 0;
  while( true ) {
    if (cRes <= i) {
      iSmallest = 0;
      for (i = 1; i < 6; i = i + 1) {
        if (*(char *)(idPlayer * 0xc0 + 0x59bc + i) <
            *(char *)(idPlayer * 0xc0 + 0x59bc + iSmallest)) {
          iSmallest = i;
        }
      }
      if (((int)*(char *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xfU) !=
          iSmallest) {
        *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) =
             *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xf0 |
             (byte)iSmallest;
        if ((*(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xf) == 0x1a) {
          *(undefined1 *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) = 0;
        }
        pctTech = (int)*(char *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) +
                  *(char *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) * 0x100;
        WriteMemRt(0x22,2,&pctTech);
      }
      return 0x39e;
    }
    iVar2 = (int)*(char *)(idPlayer * 0xc0 + 0x59bc + ((int)(uint)((byte *)lpbRes)[i] >> 5));
    if (iVar2 < (int)(((byte *)lpbRes)[i] & 0x1f)) break;
    i = i + 1;
  }
  *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) =
       *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xf0 |
       (byte)((int)(uint)((byte *)lpbRes)[i] >> 5);
  if ((i < cRes + -1) && (iVar2 + 1U == (((byte *)lpbRes)[i] & 0x1f))) {
    *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) =
         *(byte *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) & 0xf |
         (byte)(((int)(uint)((byte *)lpbRes)[i + 1] >> 5) << 4);
  }
  pctTech = (int)*(char *)((int)&rgplr[0].pctResearch + idPlayer * 0xc0) +
            *(char *)((int)&rgplr[0].iTechCur + idPlayer * 0xc0) * 0x100;
  WriteMemRt(0x22,2,&pctTech);
  return i;
}



// ======================================================================
// Function: KeepFleetsMoving
// Address: 1090:45ca
// Segment: MEMORY_AIU
// ======================================================================


void KeepFleetsMoving(void)

{
  FLEET *pFVar1;
  int iVar2;
  short sVar3;
  undefined2 uVar4;
  THING *lpthMac;
  short ith;
  THING *rglpth [1];
  THING *lpth;
  FLEET *lpfl;
  short ifl;
  short i;
  
  ith = 0;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  do {
    if ((THING *)lpThings + cThing <= (THING *)lpth) {
AIU_LKeepMovn:
      ifl = 0;
      while( true ) {
        if (cFleet <= ifl) {
          return;
        }
                    /* WARNING: Load size is inaccurate */
        pFVar1 = ((FLEET **)rglpfl)[ifl];
        iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
        if ((pFVar1->iPlayer == idPlayer) && (1 < pFVar1->cord)) {
          if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) ||
             (4 < (uint)game.turn)) {
            i = -1;
            sVar3 = FIsAiTransport((FLEET *)CONCAT22(iVar2,pFVar1));
            if (sVar3 != 0) {
              i = 0x1e;
            }
          }
          else {
            i = 0x10;
          }
          SetAiFleetIdealSpeed((FLEET *)CONCAT22(iVar2,pFVar1),i,ith,rglpth);
        }
        ifl = ifl + 1;
      }
      return;
    }
    uVar4 = (undefined2)((ulong)lpth >> 0x10);
    if ((((uint)lpth->idFull >> 0xd == 0) && (((uint)lpth->idFull >> 9 & 0xf) != idPlayer))
       && (((THING *)lpth)->rgb[6] != 2)) {
      if (ith == 100) {
        ith = -1;
        goto AIU_LKeepMovn;
      }
      *(THING **)(rglpth + ith) = (THING *)lpth;
      *(undefined2 *)((int)rglpth + ith * 4 + 2) = uVar4;
      ith = ith + 1;
    }
    lpth = (THING *)CONCAT22(uVar4,(THING *)lpth + 1);
  } while( true );
}



// ======================================================================
// Function: FShouldWeBuildColonizers
// Address: 1090:476a
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10904a33) */

short FShouldWeBuildColonizers(short *pcCol)

{
  int iVar1;
  int iVar2;
  int iVar3;
  uint uVar4;
  short sVar5;
  bool bVar6;
  short cColPl;
  short rgish [16];
  FLEET *lpfl;
  short i;
  short ifl;
  short iMin;
  ulong cBuilt;
  short cColFl;
  short iMax;
  
  cColFl = 0;
  cColPl = 0;
  iMax = -1;
  iMin = 0x10;
  if (pcCol != (short *)0x0) {
    *pcCol = 0;
  }
  if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) == 0) &&
     ((game.turn & 1U) != 0)) {
    sVar5 = 0;
  }
  else if ((uint)game.turn < 0x1e) {
    sVar5 = 1;
  }
  else {
    for (i = 0; i < 0x10; i = i + 1) {
      if (((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0) &&
         ((*(int *)(i * 0x93 + 0x3f00) == 0xe || (*(int *)(i * 0x93 + 0x3f00) == 0xf)))) {
        rgish[i] = 1;
        if (iMax < i) {
          iMax = i;
        }
        if (i < iMin) {
          iMin = i;
        }
      }
      else {
        rgish[i] = 0;
      }
    }
    iVar1 = iMax + 1;
    if (iVar1 < 1) {
      sVar5 = 0;
    }
    else {
      for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
        iVar2 = *(int *)((FLEET **)rglpfl + ifl);
        iVar3 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        if ((iVar2 == 0) && (iVar3 == 0)) break;
        if (*(int *)(iVar2 + 2) == idPlayer) {
          for (i = iMin; i < iVar1; i = i + 1) {
            if ((0 < rgish[i]) && (0 < *(int *)(iVar2 + 0xc + i * 2))) {
              cColFl = cColFl + 1;
              break;
            }
          }
        }
      }
      if (pcCol != (short *)0x0) {
        *pcCol = cColFl;
      }
      if (game.mdSize * 0x14 + 10 < cColFl) {
        sVar5 = 0;
      }
      else {
        for (i = 0; i < game.cPlayer; i = i + 1) {
          if ((*(uint *)((int)&rgplr[0].wMdPlr + i * 0xc0) >> 8 & 1) != 0) {
            cColPl = cColPl + *(int *)((int)&rgplr[0].cPlanet + i * 0xc0);
          }
        }
        if ((game.cPlanMax << 2) / 5 < cColFl + cColPl) {
          sVar5 = 0;
        }
        else {
          cBuilt._0_2_ = 0;
          cBuilt._2_2_ = 0;
          for (i = iMin; i < iVar1; i = i + 1) {
            if (0 < rgish[i]) {
              uVar4 = *(uint *)((int)&rgshdef[0].cBuilt + i * 0x93);
              bVar6 = CARRY2((uint)cBuilt,uVar4);
              cBuilt._0_2_ = (uint)cBuilt + uVar4;
              cBuilt._2_2_ = cBuilt._2_2_ +
                             *(int *)((int)&rgshdef[0].cBuilt + 2 + i * 0x93) +
                             (uint)bVar6;
            }
          }
          uVar4 = cColPl + cColFl;
          if (((cBuilt._2_2_ - ((int)uVar4 >> 0xf) == (uint)((uint)cBuilt < uVar4)) &&
              ((uint)cBuilt - uVar4 < 0x1a)) ||
             ((cColFl < 5 && (sVar5 = Random(2), sVar5 == 0)))) {
            sVar5 = 1;
          }
          else {
            sVar5 = 0;
          }
        }
      }
    }
  }
  return sVar5;
}



// ======================================================================
// Function: FIsAiAttack
// Address: 1090:4a72
// Segment: MEMORY_AIU
// ======================================================================


short FIsAiAttack(FLEET *lpfl)

{
  int iVar1;
  undefined2 uVar2;
  short sVar3;
  int iVar4;
  short i;
  short ihul;
  
  i = 0;
  do {
    if (0xf < i) {
      return 0;
    }
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      iVar1 = *(int *)(i * 0x93 + 0x3f00);
      if ((5 < iVar1) && (iVar1 < 0xb)) {
        return 1;
      }
      if (iVar1 == 5) {
        uVar2 = *(undefined2 *)(idPlayer * 4 + 0x100);
        iVar4 = *(int *)(idPlayer * 4 + 0xfe) + i * 0x93;
        iVar1 = *(int *)(iVar4 + 0x89);
        if ((-1 < iVar1) && ((0 < iVar1 || (*(int *)(iVar4 + 0x87) != 0)))) {
          return 1;
        }
        return 0;
      }
      if (((iVar1 == 0x1f) || (iVar1 == 0x1d)) &&
         (sVar3 = WtMaxShdefStat
                            ((SHDEF *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                               (SHDEF *)(i * 0x93 + 0x3f00)),2), sVar3 < 500)) {
        uVar2 = *(undefined2 *)(idPlayer * 4 + 0x100);
        iVar4 = *(int *)(idPlayer * 4 + 0xfe) + i * 0x93;
        iVar1 = *(int *)(iVar4 + 0x89);
        if ((-1 < iVar1) && ((0 < iVar1 || (*(int *)(iVar4 + 0x87) != 0)))) {
          return 1;
        }
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FIsTurinDroneAiAttack
// Address: 1090:4b9a
// Segment: MEMORY_AIU
// ======================================================================


short FIsTurinDroneAiAttack(FLEET *lpfl)

{
  int iVar1;
  short i;
  short ihul;
  
  i = 0;
  while( true ) {
    if (0xf < i) {
      return 0;
    }
    if (((0 < ((FLEET *)lpfl)->rgcsh[i]) && (iVar1 = *(int *)(i * 0x93 + 0x3f00), 3 < iVar1)) &&
       (iVar1 < 0xb)) break;
    i = i + 1;
  }
  return 1;
}



// ======================================================================
// Function: FIsAiTransport
// Address: 1090:4c08
// Segment: MEMORY_AIU
// ======================================================================


short FIsAiTransport(FLEET *lpfl)

{
  int iVar1;
  undefined2 uVar2;
  short sVar3;
  int iVar4;
  short i;
  short ihul;
  
  i = 0;
  do {
    if (0xf < i) {
      return 0;
    }
    if (0 < ((FLEET *)lpfl)->rgcsh[i]) {
      iVar1 = *(int *)(i * 0x93 + 0x3f00);
      if (((-1 < iVar1) && (iVar1 < 4)) || ((10 < iVar1 && (iVar1 < 0xe)))) {
        return 1;
      }
      if ((iVar1 == 0x1f) &&
         (sVar3 = WtMaxShdefStat
                            ((SHDEF *)CONCAT22((undefined1 *)&DAT_1120_1120,
                                               (SHDEF *)(i * 0x93 + 0x3f00)),2), 499 < sVar3)) {
        uVar2 = *(undefined2 *)(idPlayer * 4 + 0x100);
        iVar4 = *(int *)(idPlayer * 4 + 0xfe) + i * 0x93;
        iVar1 = *(int *)(iVar4 + 0x89);
        if ((-1 < iVar1) && ((0 < iVar1 || (*(int *)(iVar4 + 0x87) != 0)))) {
          return 1;
        }
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: ValidateStarbaseHistory
// Address: 1090:4cf0
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10905124) */
/* WARNING: Removing unreachable block (ram,0x10905129) */
/* WARNING: Removing unreachable block (ram,0x10905152) */
/* WARNING: Removing unreachable block (ram,0x10905157) */
/* WARNING: Removing unreachable block (ram,0x10905255) */
/* WARNING: Removing unreachable block (ram,0x10905508) */

void ValidateStarbaseHistory(void)

{
  uint *puVar1;
  byte *pbVar2;
  byte *pbVar3;
  FLEET *pFVar4;
  uint uVar5;
  int iVar6;
  int iVar7;
  short sVar8;
  int iVar9;
  PLANET *pPVar10;
  byte *pbVar11;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  byte *pbVar12;
  undefined2 uVar13;
  undefined2 uVar14;
  bool bVar15;
  PLANET *pPVar16;
  long lVar17;
  ulong uVar18;
  ulong uVar19;
  ulong uVar20;
  ushort in_stack_0000ffc8;
  long l;
  long lBest;
  short dx;
  short cFr;
  short ipl;
  short j;
  short i;
  FLEET *lpfl;
  short ifl;
  PLANET *lppl;
  short cFr2;
  short dy;
  short id;
  POINT pt;
  PLANET *lpplMac;
  short iBest;
  short iWrite;
  
  uVar20 = CONCAT22(unaff_SI,unaff_DI);
  if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 4) &&
     (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 5)) {
    if (*(uint *)vlpbAiData < 3) {
      uVar18 = (ulong)vlpbAiData >> 0x10;
      pbVar11 = (byte *)vlpbAiData;
      (pbVar11 + 2)[0] = 0;
      (pbVar11 + 2)[1] = 0;
    }
    if (0x13 < (uint)game.turn) {
      iWrite = 0;
      uVar13 = (undefined2)((ulong)vlpbAiData >> 0x10);
      pbVar11 = (byte *)vlpbAiData;
      if ((*(int *)(pbVar11 + 2) < 0) || (0x40 < *(int *)(pbVar11 + 2))) {
        (pbVar11 + 2)[0] = 0;
        (pbVar11 + 2)[1] = 0;
      }
      i = 0;
      while( true ) {
        uVar13 = (undefined2)((ulong)vlpbAiData >> 0x10);
        pbVar11 = (byte *)vlpbAiData;
        if (*(int *)(pbVar11 + 2) <= i) break;
        if ((*(int *)(pbVar11 + i * 0x14 + 6) < 0) || (8 < *(int *)(pbVar11 + i * 0x14 + 6))) {
          (pbVar11 + i * 0x14 + 6)[0] = 0;
          (pbVar11 + i * 0x14 + 6)[1] = 0;
        }
        pPVar16 = LpplFromId(*(short *)((byte *)vlpbAiData + i * 0x14 + 4));
        iVar7 = (int)((ulong)pPVar16 >> 0x10);
        if ((((PLANET *)pPVar16 != (PLANET *)0x0) || (iVar7 != 0)) &&
           (((PLANET *)pPVar16)->iPlayer == idPlayer)) {
          if (iWrite != i) {
            uVar13 = vlpbAiData._2_2_;
            pbVar11 = (byte *)vlpbAiData + i * 0x14 + 4;
            pbVar12 = (byte *)vlpbAiData + iWrite * 0x14 + 4;
            for (iVar7 = 10; iVar7 != 0; iVar7 = iVar7 + -1) {
              pbVar3 = pbVar12;
              pbVar12 = pbVar12 + 2;
              pbVar2 = pbVar11;
              pbVar11 = pbVar11 + 2;
              *(undefined2 *)pbVar3 = *(undefined2 *)pbVar2;
            }
          }
          iWrite = iWrite + 1;
        }
        i = i + 1;
      }
      *(short *)(pbVar11 + 2) = iWrite;
      for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
                    /* WARNING: Load size is inaccurate */
        pPVar10 = ((PLANET **)vrglpplAi)[ipl];
        iVar7 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
        lppl = (PLANET *)CONCAT22(iVar7,pPVar10);
        if ((pPVar10 == (PLANET *)0x0) && (iVar7 == 0)) break;
        if (((uint)pPVar10->wFlags >> 9 & 1) != 0) {
          i = 0;
          while( true ) {
            uVar13 = (undefined2)((ulong)vlpbAiData >> 0x10);
            pbVar11 = (byte *)vlpbAiData;
            if ((*(int *)(pbVar11 + 2) <= i) || (*(int *)(pbVar11 + i * 0x14 + 4) == lppl->id))
            break;
            i = i + 1;
          }
          if ((i == *(int *)(pbVar11 + 2)) && (i < 0x40)) {
            *(short *)(pbVar11 + i * 0x14 + 4) = lppl->id;
            pbVar2 = (byte *)vlpbAiData + i * 0x14 + 6;
            pbVar2[0] = 0;
            pbVar2[1] = 0;
            *(int *)((byte *)vlpbAiData + 2) = *(int *)((byte *)vlpbAiData + 2) + 1;
          }
        }
      }
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      pPVar10 = (PLANET *)lpPlanets + cPlanet;
      while (((PLANET *)lppl < pPVar10 && (*(int *)((byte *)vlpbAiData + 2) < 0x40))) {
        uVar13 = (undefined2)((ulong)lppl >> 0x10);
        if (((((PLANET *)lppl)->iPlayer == idPlayer) &&
            (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) == 0)) &&
           ((iVar7 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe), 0 < iVar7 ||
            ((-1 < iVar7 && (0x4f < *(uint *)(((PLANET *)lppl)->rgwtMin + 3))))))) {
          l._0_2_ = (uint *)0x0;
          l._2_2_ = 0;
          for (i = 0; i < 3; i = i + 1) {
            __aFulmul((ulong)((PLANET *)lppl)->rgMinConc[i],
                              (ulong)((PLANET *)lppl)->rgMinConc[i]);
            lVar17 = __aFlshl(uVar20,in_stack_0000ffc8);
            puVar1 = (uint *)(((PLANET *)lppl)->rgwtMin + i);
            uVar5 = (uint)lVar17 + *puVar1;
            bVar15 = CARRY2((uint)(uint *)l,uVar5);
            l._0_2_ = (uint *)((int)(uint *)l + uVar5);
            l._2_2_ = l._2_2_ + (int)((ulong)lVar17 >> 0x10) +
                                *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2) +
                                (uint)CARRY2((uint)lVar17,*puVar1) + (uint)bVar15;
          }
          if (((-1 < l._2_2_) &&
              (((0 < l._2_2_ || ((uint *)&UINT_1120_1b58 <= (uint *)l)) &&
               (uVar18 = __aFulshr(uVar20,in_stack_0000ffc8), 0x13 < ((uint)uVar18 & 0xfff))
               ))) && (uVar18 = __aFulshr(uVar20,in_stack_0000ffc8),
                      0x13 < ((uint)uVar18 & 0xfff))) {
            i = 0;
            while( true ) {
              uVar14 = (undefined2)((ulong)vlpbAiData >> 0x10);
              if ((*(int *)((byte *)vlpbAiData + 2) <= i) ||
                 (iVar7 = *(int *)((byte *)vlpbAiData + i * 0x14 + 4), iVar7 == lppl->id))
              break;
              if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) {
                iVar6 = ((POINT *)rgptPlan + iVar7)->x -
                        ((POINT *)rgptPlan + lppl->id)->x;
                iVar7 = *(int *)((int)&rgptPlan[0].y + iVar7 * 4) -
                        *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
                uVar18 = __aFulmul((long)iVar7,(long)iVar7);
                uVar19 = __aFulmul((long)iVar6,(long)iVar6);
                if ((long)(uVar19 + uVar18) < 0x9c4) break;
              }
              i = i + 1;
            }
            uVar14 = (undefined2)((ulong)vlpbAiData >> 0x10);
            pbVar11 = (byte *)vlpbAiData;
            if (*(int *)(pbVar11 + 2) <= i) {
              in_stack_0000ffc8 = lppl->id;
              *(ushort *)(pbVar11 + *(int *)(pbVar11 + 2) * 0x14 + 4) = in_stack_0000ffc8;
              pbVar2 = (byte *)vlpbAiData +
                       *(int *)((byte *)vlpbAiData + 2) * 0x14 + 6;
              pbVar2[0] = 0;
              pbVar2[1] = 0;
              *(int *)((byte *)vlpbAiData + 2) = *(int *)((byte *)vlpbAiData + 2) + 1;
            }
          }
        }
        lppl = (PLANET *)CONCAT22(uVar13,(PLANET *)lppl + 1);
      }
      for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
        pFVar4 = ((FLEET **)rglpfl)[ifl];
        iVar7 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar7,pFVar4);
        if ((pFVar4 == (FLEET *)0x0) && (iVar7 == 0)) break;
        if ((pFVar4->iPlayer == idPlayer) &&
           (sVar8 = FIsAiTransport((FLEET *)CONCAT22(iVar7,pFVar4)), sVar8 != 0)) {
          i = 0;
          while( true ) {
            uVar13 = (undefined2)((ulong)vlpbAiData >> 0x10);
            pbVar11 = (byte *)vlpbAiData;
            if (*(int *)(pbVar11 + 2) <= i) break;
            j = 0;
            while ((j < *(int *)(pbVar11 + i * 0x14 + 6) &&
                   (*(int *)(pbVar11 + j * 2 + i * 0x14 + 8) != lpfl->id))) {
              j = j + 1;
            }
            if (j < *(int *)(pbVar11 + i * 0x14 + 6)) break;
            i = i + 1;
          }
          if (i == *(int *)(pbVar11 + 2)) {
            iBest = -1;
            lVar17 = 10000000;
            i = 0;
            while( true ) {
              uVar13 = (undefined2)((ulong)vlpbAiData >> 0x10);
              pbVar11 = (byte *)vlpbAiData;
              if (*(int *)(pbVar11 + 2) <= i) break;
              if (*(int *)(pbVar11 + i * 0x14 + 6) < 8) {
                iVar6 = ((POINT *)rgptPlan + *(int *)(pbVar11 + i * 0x14 + 4))->x -
                        (&pFVar4->pt)->x;
                iVar9 = *(int *)((int)&rgptPlan[0].y +
                                *(int *)(pbVar11 + i * 0x14 + 4) * 4) - (pFVar4->pt).y;
                uVar20 = __aFulmul((long)iVar9,(long)iVar9);
                uVar18 = __aFulmul((long)iVar6,(long)iVar6);
                if ((long)(uVar18 + uVar20) < lVar17) {
                  iBest = i;
                  lVar17 = uVar18 + uVar20;
                }
              }
              i = i + 1;
            }
            if (iBest != -1) {
              sVar8 = lpfl->id;
              iVar7 = *(int *)(pbVar11 + iBest * 0x14 + 6);
              *(int *)(pbVar11 + iBest * 0x14 + 6) = *(int *)(pbVar11 + iBest * 0x14 + 6) + 1;
              *(short *)(pbVar11 + iVar7 * 2 + iBest * 0x14 + 8) = sVar8;
            }
          }
        }
      }
      i = 0;
      while( true ) {
        uVar13 = (undefined2)((ulong)vlpbAiData >> 0x10);
        pbVar11 = (byte *)vlpbAiData;
        if (*(int *)(pbVar11 + 2) <= i) break;
        if (*(int *)(pbVar11 + i * 0x14 + 6) < 4) {
          j = 0;
          while ((j < *(int *)(pbVar11 + 2) &&
                 (*(int *)(pbVar11 + j * 0x14 + 6) < *(int *)(pbVar11 + i * 0x14 + 6) + 2))) {
            j = j + 1;
          }
          if (j < *(int *)(pbVar11 + 2)) {
            *(int *)(pbVar11 + j * 0x14 + 6) = *(int *)(pbVar11 + j * 0x14 + 6) + -1;
            uVar13 = *(undefined2 *)(pbVar11 + *(int *)(pbVar11 + j * 0x14 + 6) * 2 + j * 0x14 + 8);
            pbVar11 = (byte *)vlpbAiData;
            uVar14 = vlpbAiData._2_2_;
            iVar7 = *(int *)((byte *)vlpbAiData + i * 0x14 + 6);
            *(int *)((byte *)vlpbAiData + i * 0x14 + 6) =
                 *(int *)((byte *)vlpbAiData + i * 0x14 + 6) + 1;
            *(undefined2 *)(pbVar11 + iVar7 * 2 + i * 0x14 + 8) = uVar13;
          }
        }
        i = i + 1;
      }
      *(int *)vlpbAiData = *(int *)(pbVar11 + 2) * 0x14 + 4;
    }
  }
  return;
}



// ======================================================================
// Function: GetResourcesAvailable
// Address: 1090:56d0
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10905774) */
/* WARNING: Variable defined which should be unmapped: cRes */

void GetResourcesAvailable(PLANET *lppl,long *rgRes)

{
  uint *puVar1;
  uint uVar2;
  uint uVar3;
  uint uVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  bool bVar5;
  ulong uVar6;
  long lVar7;
  undefined2 uVar8;
  undefined2 uVar9;
  long cRes;
  short i;
  
  uVar6 = CONCAT22(unaff_SI,unaff_DI);
  EstMineralsMined(lppl,rgRes,-1,0);
  for (i = 0; i < 3; i = i + 1) {
    uVar3 = *(uint *)(((PLANET *)lppl)->rgwtMin + i);
    uVar4 = *(uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
    puVar1 = (uint *)(rgRes + i);
    uVar2 = *puVar1;
    *puVar1 = *puVar1 + uVar3;
    puVar1 = (uint *)((int)(rgRes + i) + 2);
    *puVar1 = *puVar1 + uVar4 + (uint)CARRY2(uVar2,uVar3);
  }
  cRes._0_2_ = CResourcesAtPlanet(lppl,idPlayer);
  cRes._2_2_ = (int)(uint)cRes >> 0xf;
  uVar6 = __aFulshr(uVar6,(uint)cRes);
  if ((uVar6 & 1) == 0) {
    uVar9 = 0;
    uVar8 = 100;
    uVar6 = __aFulmul((long)(int)(uint)cRes,
                              (long)(int)*(char *)((int)&rgplr[0].pctResearch +
                                                  idPlayer * 0xc0));
    lVar7 = __aFldiv(uVar6,CONCAT22(uVar9,uVar8));
    bVar5 = (uint)cRes < (uint)lVar7;
    cRes._0_2_ = (uint)cRes - (uint)lVar7;
    cRes._2_2_ = (cRes._2_2_ - (int)((ulong)lVar7 >> 0x10)) - (uint)bVar5;
  }
  *(uint *)(rgRes + 3) = (uint)cRes;
  *(int *)((int)rgRes + 0xe) = cRes._2_2_;
  return;
}



// ======================================================================
// Function: GetProdQCost
// Address: 1090:57c0
// Segment: MEMORY_AIU
// ======================================================================


void GetProdQCost(PLANET *lppl,long *rgCost)

{
  uint *puVar1;
  uint uVar2;
  PROD *pPVar3;
  uint uVar4;
  int iVar5;
  PLANET *pPVar6;
  undefined2 uVar7;
  PROD *lpprod;
  short j;
  short i;
  PLPROD *lpplprod;
  long rgCostCur [4];
  
  for (i = 0; i < 4; i = i + 1) {
    *(undefined2 *)(rgCost + i) = 0;
    *(undefined2 *)((int)(rgCost + i) + 2) = 0;
  }
  uVar7 = (undefined2)((ulong)lppl >> 0x10);
  pPVar6 = (PLANET *)lppl;
  if ((*(int *)&pPVar6->lpplprod != 0) || (*(int *)((int)&pPVar6->lpplprod + 2) != 0)) {
    pPVar3 = *(PROD **)&pPVar6->lpplprod;
    uVar7 = *(undefined2 *)((int)&pPVar6->lpplprod + 2);
    lpprod._0_2_ = pPVar3;
    for (i = 0; lpprod._0_2_ = (PROD *)lpprod + 1,
        i < (int)(uint)*(byte *)((int)&pPVar3->dwFlags + 3); i = i + 1) {
      GetProductionCosts
                (lppl,(PROD *)CONCAT22(uVar7,(PROD *)lpprod),(ulong *)rgCostCur,idPlayer,0);
      for (j = 0; j < 4; j = j + 1) {
        uVar4 = *(uint *)(rgCostCur + j);
        iVar5 = *(int *)((int)rgCostCur + j * 4 + 2);
        puVar1 = (uint *)(rgCost + j);
        uVar2 = *puVar1;
        *puVar1 = *puVar1 + uVar4;
        puVar1 = (uint *)((int)(rgCost + j) + 2);
        *puVar1 = *puVar1 + iVar5 + (uint)CARRY2(uVar2,uVar4);
      }
    }
  }
  return;
}



// ======================================================================
// Function: MergeAllShdefs
// Address: 1090:58be
// Segment: MEMORY_AIU
// ======================================================================


void MergeAllShdefs(short grbitish)

{
  int iVar1;
  FLEET *pFVar2;
  FLEET *pFVar3;
  int iVar4;
  undefined2 uVar5;
  long lVar6;
  short iflNextPass;
  FLEET *lpflNextPass;
  short rgish [16];
  short grbit;
  FLEET *lpfl;
  short ifl;
  short i;
  short iMin;
  short iMax;
  FLEET *rglpflW [1];
  short crglpflW;
  
  iMax = -1;
  iMin = 0x10;
  grbit = 1;
  for (i = 0; i < 0x10; i = i + 1) {
    if ((grbitish & grbit) == 0) {
      rgish[i] = 0;
    }
    else {
      rgish[i] = 1;
      if (iMax < i) {
        iMax = i;
      }
      if (i < iMin) {
        iMin = i;
      }
    }
    grbit = grbit << 1;
  }
  iVar1 = iMax + 1;
  if (iVar1 < 1) {
    return;
  }
  lpflNextPass._0_2_ = (FLEET *)0x0;
  lpflNextPass._2_2_ = 0;
  crglpflW = 0;
  ifl = 0;
  do {
    if (ifl < cFleet) {
                    /* WARNING: Load size is inaccurate */
      pFVar2 = ((FLEET **)rglpfl)[ifl];
      iVar4 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      lpfl = (FLEET *)CONCAT22(iVar4,pFVar2);
      if ((pFVar2 == (FLEET *)0x0) && (iVar4 == 0)) goto LAB_1090_5b67;
    }
    else {
LAB_1090_5b67:
      if (((FLEET *)lpflNextPass == (FLEET *)0x0) && (lpflNextPass._2_2_ == 0)) {
        return;
      }
      lpfl = (FLEET *)CONCAT22(lpflNextPass._2_2_,(FLEET *)lpflNextPass);
      lpflNextPass._0_2_ = (FLEET *)0x0;
      lpflNextPass._2_2_ = 0;
      ifl = iflNextPass;
      crglpflW = 0;
    }
    iVar4 = (int)((ulong)lpfl >> 0x10);
    pFVar2 = (FLEET *)lpfl;
    if (pFVar2->iPlayer == idPlayer) {
      for (i = iMin; (i < iVar1 && ((pFVar2->rgcsh[i] < 1 || (rgish[i] < 1)))); i = i + 1) {
      }
      if ((i != iVar1) && (lVar6 = CMineFromLpfl(lpfl), lVar6 != 4000)) {
        for (i = 0; i < crglpflW; i = i + 1) {
          if (((FLEET *)rglpflW[i])->idPlanet == pFVar2->idPlanet) {
            uVar5 = (undefined2)((ulong)rglpflW[i] >> 0x10);
            pFVar3 = (FLEET *)rglpflW[i];
            if (((&pFVar3->pt)->x == (&pFVar2->pt)->x) && ((pFVar3->pt).y == (pFVar2->pt).y)) break;
          }
        }
        if (i < crglpflW) {
                    /* WARNING: Load size is inaccurate */
          Merge2Fleets((FLEET *)CONCAT22(*(undefined2 *)((int)rglpflW + i * 4 + 2),rglpflW[i])
                             ,lpfl,0);
        }
        else if (crglpflW == 0x20) {
          if (((FLEET *)lpflNextPass == (FLEET *)0x0) && (lpflNextPass._2_2_ == 0)) {
            iflNextPass = ifl;
            lpflNextPass._0_2_ = pFVar2;
            lpflNextPass._2_2_ = iVar4;
          }
        }
        else {
          *(FLEET **)(rglpflW + crglpflW) = pFVar2;
          *(int *)((int)rglpflW + crglpflW * 4 + 2) = iVar4;
          crglpflW = crglpflW + 1;
        }
      }
    }
    ifl = ifl + 1;
  } while( true );
}



// ======================================================================
// Function: LpflFindClosestEnum
// Address: 1090:5bae
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10905c88) */

FLEET * LpflFindClosestEnum(FLEET *lpfl,void *pfn)

{
  int iVar1;
  int iVar2;
  FLEET *pFVar3;
  int iVar4;
  long lVar5;
  long lVar6;
  FLEET *pFVar7;
  int iVar8;
  int iVar9;
  undefined2 uVar10;
  ulong uVar11;
  ulong uVar12;
  long lBest;
  long l;
  FLEET *lpflBest;
  short dx;
  short ish;
  short dy;
  POINT pt;
  FLEET *lpflT;
  
  lpflBest._0_2_ = (FLEET *)0x0;
  lpflBest._2_2_ = 0;
  uVar10 = (undefined2)((ulong)lpfl >> 0x10);
  iVar1 = (&((FLEET *)lpfl)->pt)->x;
  iVar2 = (((FLEET *)lpfl)->pt).y;
  lVar6 = 10000000;
  for (ish = 0; ish < cFleet; ish = ish + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar3 = ((FLEET **)rglpfl)[ish];
    iVar4 = *(int *)((int)((FLEET **)rglpfl + ish) + 2);
    if ((pFVar3 == (FLEET *)0x0) && (iVar4 == 0)) break;
    iVar8 = iVar1 - (&pFVar3->pt)->x;
    iVar9 = iVar2 - (pFVar3->pt).y;
    uVar11 = __aFulmul((long)iVar9,(long)iVar9);
    uVar12 = __aFulmul((long)iVar8,(long)iVar8);
    pFVar7 = (FLEET *)lpflBest;
    iVar8 = lpflBest._2_2_;
    lVar5 = lVar6;
    if ((long)(uVar12 + uVar11) < lVar6) {
      iVar9 = (*(void *)pfn)(0x1118,lpfl,pFVar3);
      pFVar7 = pFVar3;
      iVar8 = iVar4;
      lVar5 = uVar12 + uVar11;
      if (iVar9 == 0) {
        pFVar7 = (FLEET *)lpflBest;
        iVar8 = lpflBest._2_2_;
        lVar5 = lVar6;
      }
    }
    lpflBest._2_2_ = iVar8;
    lpflBest._0_2_ = pFVar7;
    lVar6 = lVar5;
  }
  return (FLEET *)CONCAT22(lpflBest._2_2_,(FLEET *)lpflBest);
}



// ======================================================================
// Function: LpplFindClosestEnum
// Address: 1090:5cd4
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10905dab) */

PLANET * LpplFindClosestEnum(PLANET *lppl,void *pfn)

{
  int iVar1;
  int iVar2;
  long lVar3;
  int iVar4;
  int iVar5;
  PLANET *pPVar6;
  ulong uVar7;
  ulong uVar8;
  long lBest;
  long l;
  short dx;
  PLANET *lpplT;
  PLANET *lpplBest;
  PLANET *lpplTMac;
  short dy;
  POINT pt;
  
  lVar3 = 10000000;
  lpplBest._0_2_ = (PLANET *)0x0;
  lpplBest._2_2_ = 0;
  iVar1 = ((POINT *)rgptPlan + lppl->id)->x;
  iVar2 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
  pPVar6 = (PLANET *)lpPlanets + cPlanet;
  lpplT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lpplT < pPVar6) {
    iVar4 = iVar1 - ((POINT *)rgptPlan + lpplT->id)->x;
    iVar5 = iVar2 - *(int *)((int)&rgptPlan[0].y + lpplT->id * 4);
    uVar7 = __aFulmul((long)iVar5,(long)iVar5);
    uVar8 = __aFulmul((long)iVar4,(long)iVar4);
    if ((long)(uVar8 + uVar7) < lVar3) {
      iVar4 = (*(void *)pfn)(0x1118,lppl,(PLANET *)lpplT);
      if (iVar4 != 0) {
        lpplBest._0_2_ = (PLANET *)lpplT;
        lpplBest._2_2_ = lpplT._2_2_;
        lVar3 = uVar8 + uVar7;
      }
    }
    lpplT = (PLANET *)CONCAT22(lpplT._2_2_,(PLANET *)lpplT + 1);
  }
  return (PLANET *)CONCAT22(lpplBest._2_2_,(PLANET *)lpplBest);
}



// ======================================================================
// Function: LpplFindBestEnum
// Address: 1090:5e06
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10905f0d) */

PLANET * LpplFindBestEnum(PLANET *lppl,void *pfn)

{
  int iVar1;
  int iVar2;
  long lVar3;
  int iVar4;
  int iVar5;
  PLANET *pPVar6;
  ulong uVar7;
  ulong uVar8;
  long lBest;
  long l;
  short dx;
  short iCur;
  PLANET *lpplT;
  PLANET *lpplBest;
  PLANET *lpplTMac;
  short dy;
  POINT pt;
  short iBest;
  
  iBest = 1;
  lVar3 = 10000000;
  lpplBest._0_2_ = (PLANET *)0x0;
  lpplBest._2_2_ = 0;
  iVar1 = ((POINT *)rgptPlan + lppl->id)->x;
  iVar2 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
  pPVar6 = (PLANET *)lpPlanets + cPlanet;
  lpplT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lpplT < pPVar6) {
    iVar4 = iVar1 - ((POINT *)rgptPlan + lpplT->id)->x;
    iVar5 = iVar2 - *(int *)((int)&rgptPlan[0].y + lpplT->id * 4);
    uVar7 = __aFulmul((long)iVar5,(long)iVar5);
    uVar8 = __aFulmul((long)iVar4,(long)iVar4);
    iVar4 = (*(void *)pfn)(0x1118,lppl,(PLANET *)lpplT);
    if ((iBest < iVar4) || ((iVar4 == iBest && ((long)(uVar8 + uVar7) < lVar3)))) {
      lpplBest._0_2_ = (PLANET *)lpplT;
      lpplBest._2_2_ = lpplT._2_2_;
      iBest = iVar4;
      lVar3 = uVar8 + uVar7;
    }
    lpplT = (PLANET *)CONCAT22(lpplT._2_2_,(PLANET *)lpplT + 1);
  }
  return (PLANET *)CONCAT22(lpplBest._2_2_,(PLANET *)lpplBest);
}



// ======================================================================
// Function: IdRandomPlanetNearby
// Address: 1090:5f54
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10906035) */

short IdRandomPlanetNearby(POINT pt,short cDist,short fAvoidStarbases)

{
  short sVar1;
  short sVar2;
  int iVar3;
  ulong uVar4;
  ulong uVar5;
  ulong uVar6;
  PLANET *pPVar7;
  PLANET *lppl;
  long d2Cur;
  short cExtraAttempts;
  long dx;
  short i;
  short idBest;
  long dy;
  long lDistMax;
  short iChance;
  
  if (fAvoidStarbases == 0) {
    cExtraAttempts = 0;
  }
  else {
    cExtraAttempts = 2;
  }
  while( true ) {
    uVar4 = __aFulmul((long)cDist,(long)cDist);
    iChance = 1;
    idBest = -1;
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      sVar1 = _abs(pt.x - ((POINT *)rgptPlan + i)->x);
      sVar2 = _abs(pt.y - *(int *)((int)&rgptPlan[0].y + i * 4));
      uVar5 = __aFulmul((long)sVar2,(long)sVar2);
      uVar6 = __aFulmul((long)sVar1,(long)sVar1);
      if ((long)(uVar6 + uVar5) <= (long)uVar4) {
        iVar3 = iChance + 1;
        sVar1 = Random(iChance);
        iChance = iVar3;
        if (sVar1 == 0) {
          idBest = i;
        }
      }
    }
    if ((idBest == -1) || (cExtraAttempts < 1)) break;
    pPVar7 = LpplFromId(idBest);
    iVar3 = (int)((ulong)pPVar7 >> 0x10);
    if (((PLANET *)pPVar7 == (PLANET *)0x0) && (iVar3 == 0)) {
      return idBest;
    }
    cExtraAttempts = cExtraAttempts + -1;
    if (((uint)((PLANET *)pPVar7)->wFlags >> 9 & 1) == 0) {
      return idBest;
    }
  }
  return idBest;
}



// ======================================================================
// Function: ClearAiCurrentTask
// Address: 1090:60c0
// Segment: MEMORY_AIU
// ======================================================================


void ClearAiCurrentTask(FLEET *lpfl,short fChangeSel)

{
  undefined2 uVar1;
  
  if (fChangeSel != 0) {
    ChangeMainObjSel(2,lpfl->id);
  }
  uVar1 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
  *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
       *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0;
  FLookupFleet(-1,(FLEET *)&sel.fl);
  return;
}



// ======================================================================
// Function: FEnumOurStarbase
// Address: 1090:6110
// Segment: MEMORY_AIU
// ======================================================================


short FEnumOurStarbase(PLANET *lpplSrc,PLANET *lpplTest)

{
  short sVar1;
  undefined2 uVar2;
  
  uVar2 = (undefined2)((ulong)lpplTest >> 0x10);
  if ((((PLANET *)lpplTest)->iPlayer == idPlayer) &&
     (((uint)((PLANET *)lpplTest)->wFlags >> 9 & 1) != 0)) {
    sVar1 = 1;
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: FFleetMightHaveTeeth
// Address: 1090:6152
// Segment: MEMORY_AIU
// ======================================================================


short FFleetMightHaveTeeth(FLEET *lpfl)

{
  short sVar1;
  int iVar2;
  short ishdef;
  HUL *lphul;
  
  ishdef = 0;
  while( true ) {
    if (0xf < ishdef) {
      return 0;
    }
    if ((((FLEET *)lpfl)->rgcsh[ishdef] != 0) &&
       (iVar2 = ((uint)lpfl->id >> 9 & 0xf) * 4,
       sVar1 = FHullHasTeeth
                         ((HUL *)CONCAT22(*(undefined2 *)(iVar2 + 0x100),
                                          (HUL *)(*(int *)(iVar2 + 0xfe) + ishdef * 0x93))),
       sVar1 != 0)) break;
    ishdef = ishdef + 1;
  }
  return 1;
}



// ======================================================================
// Function: IdTargetScout
// Address: 1090:61de
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109063de) */
/* WARNING: Removing unreachable block (ram,0x1090638d) */
/* WARNING: Removing unreachable block (ram,0x109065e3) */

short IdTargetScout(FLEET *lpfl,FLEET *lpflAtk,FLEET *lpflEnemy,short fOnlyHumans,THING **plpthWorm)

{
  int iVar1;
  short sVar2;
  int iVar3;
  int iVar4;
  uint uVar5;
  PLANET *pPVar6;
  int iVar7;
  FLEET *pFVar8;
  THING *pTVar9;
  undefined2 uVar10;
  ulong uVar11;
  ulong uVar12;
  long lVar13;
  PLANET *pPVar14;
  undefined2 uVar15;
  void *pvVar16;
  undefined2 uVar17;
  undefined *puVar18;
  ORDER ord;
  FLEET *lpflAtk2;
  short dx;
  PLANET *lpplClosest;
  short idClosest;
  long lDist;
  PLANET *lppl;
  short dy;
  POINT pt;
  PLANET *lpplMac;
  long lDistBest;
  FLEET *lpflT;
  FLEET *lpflClosest;
  
  lpflClosest = (FLEET *)0x0;
  lpflT = lpflEnemy;
  lVar13 = 1000000;
  uVar10 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar8 = (FLEET *)lpfl;
  iVar1 = (&pFVar8->pt)->x;
  iVar7 = (pFVar8->pt).y;
  _memset(&ord,0,0x12);
  sVar2 = FFleetMightHaveTeeth(lpfl);
  if (sVar2 != 0) {
    while( true ) {
      if (((FLEET *)lpflT == (FLEET *)0x0) && (lpflT._2_2_ == 0)) break;
      if ((fOnlyHumans == 0) ||
         ((*(uint *)((int)&rgplr[0].wMdPlr + ((FLEET *)lpflT)->iPlayer * 0xc0) >> 9 & 1)
          == 0)) {
        lpflAtk2 = lpflAtk;
        while( true ) {
          if ((lpflAtk2 == (FLEET *)0x0) ||
             ((((lpfl != lpflAtk2 && (1 < ((FLEET *)lpflAtk2)->cord)) &&
               (*(int *)&((PLORD *)((FLEET *)lpflAtk2)->lpplord)[6].iordMax == lpflT->id)) &&
              (((uint)((PLORD *)((FLEET *)lpflAtk2)->lpplord + 7)->wFlags >> 8 & 0xf) == 2))))
          break;
                    /* WARNING: Load size is inaccurate */
          lpflAtk2 = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflAtk2)->lpflNext + 2),
                                       ((FLEET *)lpflAtk2)->lpflNext);
        }
        if ((lpflAtk2 == (FLEET *)0x0) || (sVar2 = Random(3), sVar2 != 0)) {
          iVar3 = (&((FLEET *)lpflT)->pt)->x - iVar1;
          iVar4 = (((FLEET *)lpflT)->pt).y - iVar7;
          uVar11 = __aFulmul((long)iVar4,(long)iVar4);
          uVar12 = __aFulmul((long)iVar3,(long)iVar3);
          if ((long)(uVar12 + uVar11) < lVar13) {
            lpflClosest = lpflT;
            lVar13 = uVar12 + uVar11;
          }
        }
      }
                    /* WARNING: Load size is inaccurate */
      lpflT = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflT)->lpflNext + 2),
                                ((FLEET *)lpflT)->lpflNext);
    }
    if (lVar13 < 0x7e90) {
      ord.pt.x = (&((FLEET *)lpflClosest)->pt)->x;
      ord.pt.y = (((FLEET *)lpflClosest)->pt).y;
      ord.wFlags = ord.wFlags & 0xf0ffU | 0x200;
      ord.id = lpflClosest->id;
      goto AIU_ThwakSumthin_2;
    }
    if (((FLEET *)lpflClosest == (FLEET *)0x0) && (lpflClosest._2_2_ == 0)) {
      if (fOnlyHumans != 0) {
        sVar2 = IdTargetScout(lpfl,lpflAtk,lpflEnemy,0,plpthWorm);
        return sVar2;
      }
    }
    else {
      uVar17 = 0;
      uVar15 = 2;
      lVar13 = LGetFleetStat(lpfl,1);
      lVar13 = __aFldiv(lVar13,CONCAT22(uVar17,uVar15));
      iVar7 = (int)((ulong)lVar13 >> 0x10);
      iVar1 = *(int *)((int)pFVar8->rgwtMin + 0x12);
      if ((iVar1 <= iVar7) &&
         (((iVar1 < iVar7 || (*(uint *)(pFVar8->rgwtMin + 4) < (uint)lVar13)) &&
          (sVar2 = FMoveToNearestStarbase(lpfl,0), sVar2 != 0)))) {
        return 0;
      }
      iVar1 = (&((FLEET *)lpflClosest)->pt)->x;
      iVar7 = (((FLEET *)lpflClosest)->pt).y;
      lpplClosest = (PLANET *)0x0;
      lVar13 = 1000000;
      pPVar6 = (PLANET *)lpPlanets + cPlanet;
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
      while ((PLANET *)lppl < pPVar6) {
        lpflAtk2 = lpflAtk;
        while( true ) {
          if ((lpflAtk2 == (FLEET *)0x0) ||
             (((lpfl != lpflAtk2 && (1 < ((FLEET *)lpflAtk2)->cord)) &&
              ((*(int *)&((PLORD *)((FLEET *)lpflAtk2)->lpplord)[6].iordMax == lppl->id &&
               (((uint)((PLORD *)((FLEET *)lpflAtk2)->lpplord + 7)->wFlags >> 8 & 0xf) == 1))))))
          break;
                    /* WARNING: Load size is inaccurate */
          lpflAtk2 = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflAtk2)->lpflNext + 2),
                                       ((FLEET *)lpflAtk2)->lpflNext);
        }
        if (lpflAtk2 == (FLEET *)0x0) {
          iVar3 = ((POINT *)rgptPlan + lppl->id)->x - iVar1;
          iVar4 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4) - iVar7;
          uVar11 = __aFulmul((long)iVar4,(long)iVar4);
          uVar12 = __aFulmul((long)iVar3,(long)iVar3);
          if ((long)(uVar12 + uVar11) < lVar13) {
            lpplClosest = lppl;
            lVar13 = uVar12 + uVar11;
          }
        }
        lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
      }
      if ((((PLANET *)lpplClosest != (PLANET *)0x0) || (lpplClosest._2_2_ != 0)) &&
         (lpplClosest->id != pFVar8->idPlanet)) {
        ord.pt.x = ((POINT *)rgptPlan + lpplClosest->id)->x;
        ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplClosest->id * 4);
        ord.wFlags = ord.wFlags & 0xf0ffU | 0x100;
        ord.id = lpplClosest->id;
        goto AIU_ThwakSumthin_2;
      }
    }
  }
  idClosest = IdNearestUnknownPlanet(lpfl,plpthWorm);
  if ((plpthWorm == (THING **)0x0) ||
     ((*(int *)plpthWorm == 0 && (*(int *)((int)plpthWorm + 2) == 0)))) {
    if (idClosest == -1) {
      if (*(int *)((int)&rgplr[0].idPlanetHome + idPlayer * 0xc0) == -1) {
        idClosest = Random(game.cPlanMax);
      }
      else {
        puVar18 = (undefined *)&DAT_1120_1088;
        pvVar16 = (void *)&rgptPlan[0xd1].y;
        pPVar14 = LpplFromId(*(short *)((int)&rgplr[0].idPlanetHome +
                                             idPlayer * 0xc0));
        pPVar14 = LpplFindBestEnum(pPVar14,(void *)CONCAT22(puVar18,pvVar16));
        if (((PLANET *)pPVar14 == (PLANET *)0x0) && ((int)((ulong)pPVar14 >> 0x10) == 0)) {
          idClosest = Random(game.cPlanMax);
        }
        else {
          idClosest = pPVar14->id;
        }
      }
    }
    ord.id = idClosest;
    ord.wFlags = ord.wFlags & 0xf0ffU | 0x100;
    ord.pt.x = ((POINT *)rgptPlan + idClosest)->x;
    ord.pt.y = *(short *)((int)&rgptPlan[0].y + idClosest * 4);
  }
  else {
    uVar15 = (undefined2)((ulong)*plpthWorm >> 0x10);
    pTVar9 = (THING *)*plpthWorm;
    ord.pt.x = (&pTVar9->pt)->x;
    ord.pt.y = (pTVar9->pt).y;
    ord.wFlags = ord.wFlags & 0xf0ffU | 0x800;
    ord.id = (*plpthWorm)->idFull;
  }
AIU_ThwakSumthin_2:
  if (((pFVar8->cord < 2) || (((uint)((PLORD *)pFVar8->lpplord + 7)->wFlags >> 8 & 0xf) != 1)) ||
     (((uint)ord.wFlags >> 8 & 0xf) != 1)) {
    if (((uint)ord.wFlags >> 8 & 0xf) == 1) {
      ((byte *)vlpbAiPlanet)[ord.id * 0x10 + 0xf] = 4;
    }
    ord.wFlags = ord.wFlags & 0xeff0U | 0x1000;
    uVar5 = IFindIdealWarp(lpfl,1);
    ord.wFlags = ord.wFlags & 0xff0fU | (uVar5 & 0xf) << 4;
    sVar2 = FMoveAiFleet(lpfl,&ord,0);
    if (sVar2 == 0) {
      sVar2 = -1;
    }
    else {
      sVar2 = 0;
    }
  }
  else {
    sVar2 = -1;
  }
  return sVar2;
}



// ======================================================================
// Function: MarkPlanetsUnderAttack
// Address: 1090:6896
// Segment: MEMORY_AIU
// ======================================================================


void MarkPlanetsUnderAttack(void)

{
  int iVar1;
  int iVar2;
  int iVar3;
  PLANET *pPVar4;
  short j;
  FLEET *lpfl;
  short ifl;
  short i;
  PLANET *lppl;
  
  ifl = 0;
  while( true ) {
    if (cFleet <= ifl) {
      return;
    }
    iVar1 = *(int *)((FLEET **)rglpfl + ifl);
    iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    if ((iVar1 == 0) && (iVar2 == 0)) break;
    if ((*(int *)(iVar1 + 2) != idPlayer) && (*(int *)(iVar1 + 6) != -1)) {
      i = 0;
      while ((i < 0x10 &&
             (((*(int *)(iVar1 + 0xc + i * 2) < 1 ||
               (iVar3 = *(int *)(iVar1 + 2) * 4, *(int *)(*(int *)(iVar3 + 0xfe) + i * 0x93) < 0x10)
               ) || (iVar3 = *(int *)(iVar1 + 2) * 4,
                    0x13 < *(int *)(*(int *)(iVar3 + 0xfe) + i * 0x93)))))) {
        i = i + 1;
      }
      if ((i != 0x10) &&
         (pPVar4 = LpplFromId(*(short *)(iVar1 + 6)),
         ((PLANET *)pPVar4)->iPlayer == idPlayer)) {
        ((byte *)vlpbAiPlanet)[pPVar4->id * 0x10 + 8] = 1;
      }
    }
    ifl = ifl + 1;
  }
  return;
}



// ======================================================================
// Function: FixPlanetsUnderAttack
// Address: 1090:69e6
// Segment: MEMORY_AIU
// ======================================================================


void FixPlanetsUnderAttack(PROD *rgprod)

{
  PLANET *pPVar1;
  int iVar2;
  short ipl;
  PLANET *lppl;
  
  ipl = 0;
  while( true ) {
    if (vclpplAi <= ipl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pPVar1 = ((PLANET **)vrglpplAi)[ipl];
    iVar2 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
    lppl = (PLANET *)CONCAT22(iVar2,pPVar1);
    if ((pPVar1 == (PLANET *)0x0) && (iVar2 == 0)) break;
    if (((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 8] != 0) {
      QuickBuildDefenses((PLANET *)CONCAT22(iVar2,pPVar1),rgprod);
    }
    ipl = ipl + 1;
  }
  return;
}



// ======================================================================
// Function: QuickBuildDefenses
// Address: 1090:6a7e
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10906c09) */
/* WARNING: Removing unreachable block (ram,0x10906bb9) */
/* WARNING: Removing unreachable block (ram,0x10906b0a) */
/* WARNING: Removing unreachable block (ram,0x10906b32) */
/* WARNING: Removing unreachable block (ram,0x10906be9) */
/* WARNING: Removing unreachable block (ram,0x10906c0e) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10906ca2) */

void QuickBuildDefenses(PLANET *lppl,PROD *rgprod)

{
  uint uVar1;
  int iVar2;
  short sVar3;
  PLANET *pPVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar5;
  bool bVar6;
  ulong uVar7;
  long lVar8;
  undefined2 uVar9;
  ulong uVar10;
  PROD *lpprod;
  long rgRes [4];
  short cDef;
  long lVal;
  short cRes;
  short i;
  short cCur;
  short cAlch;
  short cMax;
  
  uVar10 = CONCAT22(unaff_SI,unaff_DI);
  uVar5 = (undefined2)((ulong)lppl >> 0x10);
  pPVar4 = (PLANET *)lppl;
  if ((*(int *)&pPVar4->lpplprod != 0) || (*(int *)((int)&pPVar4->lpplprod + 2) != 0)) {
    i = 0;
    lpprod._0_2_ = *(PROD **)&pPVar4->lpplprod;
    for (; lpprod._0_2_ = (PROD *)lpprod + 1, i < (int)(uint)((PLPROD *)pPVar4->lpplprod)->iprodMac;
        i = i + 1) {
      uVar7 = __aFulshr(uVar10,(ushort)(PROD *)lpprod);
      if ((((uint)uVar7 & 7) == 1) &&
         (uVar7 = __aFulshr(uVar10,(ushort)(PROD *)lpprod), ((uint)uVar7 & 0x7f) == 9)) {
        return;
      }
    }
  }
  GetResourcesAvailable(lppl,rgRes);
  if ((0 < rgRes[3]._2_2_) || ((-1 < rgRes[3]._2_2_ && (0x31 < (uint)rgRes[3])))) {
    ChangeMainObjSel(1,lppl->id);
    InitProduction(rgprod);
    i = 0;
    while ((i < cProdGlob &&
           (((uVar7 = __aFulshr(uVar10,(ushort)(PROD *)lpprod), ((uint)uVar7 & 7) != 1 ||
             (uVar7 = __aFulshr(uVar10,(ushort)(PROD *)lpprod), ((uint)uVar7 & 0x7f) != 9))
            || (((pProdGlob + i)->dwFlags & 0x3ff) == 0))))) {
      i = i + 1;
    }
    if (i == cProdGlob) {
      FinishProduction(0);
    }
    else {
      uVar1 = (uint)(pProdGlob + i)->dwFlags & 0x3ff;
      cCur = 100;
      for (i = 0; i < 3; i = i + 1) {
        lVar8 = __aFldiv(CONCAT22(*(undefined2 *)((int)rgRes + i * 4 + 2),(int)rgRes[i]),5);
        if (lVar8 < cCur) {
          cCur = (short)lVar8;
        }
      }
      lVar8 = __aFldiv(CONCAT22(rgRes[3]._2_2_,(uint)rgRes[3]),0x19);
      cRes = (short)lVar8;
      if (5 < cRes) {
        cRes = cRes - cRes / 6;
      }
      lVar8 = __aFldiv(CONCAT22(rgRes[3]._2_2_,(uint)rgRes[3]),10);
      bVar6 = (uint)rgRes[3] < (uint)lVar8;
      rgRes[3]._0_2_ = (uint)rgRes[3] - (uint)lVar8;
      rgRes[3]._2_2_ = (rgRes[3]._2_2_ - (int)((ulong)lVar8 >> 0x10)) - (uint)bVar6;
      if (cRes <= (int)uVar1) {
        uVar1 = cRes;
      }
      cRes = uVar1;
      if (cCur < cRes) {
        uVar9 = 0;
        uVar5 = 0x96;
        sVar3 = GetRaceGrbit((PLAYER *)rgplr + idPlayer,
                                   ibitRaceMineralAlchemy);
        if (sVar3 == 0) {
          iVar2 = 100;
        }
        else {
          iVar2 = 0x19;
        }
        uVar1 = iVar2 * cCur;
        lVar8 = __aFldiv(CONCAT22((rgRes[3]._2_2_ - ((int)uVar1 >> 0xf)) -
                                          (uint)((uint)rgRes[3] < uVar1),(uint)rgRes[3] - uVar1),
                                 CONCAT22(uVar9,uVar5));
        cAlch = (short)lVar8;
        if (cAlch < 0) {
          cAlch = 0;
        }
        cDef = cCur + cAlch;
        cAlch = cAlch * 5;
      }
      else {
        cAlch = 0;
        cDef = cRes;
      }
      if (0 < cDef) {
        AddItemToQueue(9,cDef,grobjPlanet,0);
      }
      if (0 < cAlch) {
        AddItemToQueue(0xb,cAlch,grobjPlanet,0);
      }
      if ((cDef < 1) && (cAlch < 1)) {
        sVar3 = 0;
      }
      else {
        sVar3 = 1;
      }
      FinishProduction(sVar3);
    }
  }
  return;
}



// ======================================================================
// Function: IdplFindClosestStarbase
// Address: 1090:6e04
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10906ed8) */

short IdplFindClosestStarbase(FLEET *lpfl,short fBigOnes)

{
  int iVar1;
  int iVar2;
  PLORD *pPVar3;
  long lVar4;
  int iVar5;
  int iVar6;
  short sVar7;
  PLANET *pPVar8;
  PLORD *pPVar9;
  undefined2 uVar10;
  ulong uVar11;
  ulong uVar12;
  long lBest;
  long l;
  short dx;
  PLANET *lpplT;
  PLANET *lpplBest;
  PLANET *lpplTMac;
  short dy;
  POINT pt;
  
  lVar4 = 10000000;
  lpplBest = (PLANET *)0x0;
  pPVar3 = ((FLEET *)lpfl)->lpplord;
  uVar10 = (undefined2)((ulong)pPVar3 >> 0x10);
  pPVar9 = (PLORD *)pPVar3;
  iVar1 = (pPVar9 + 1)->wFlags;
  iVar2 = *(int *)&pPVar9[1].iordMax;
  pPVar8 = (PLANET *)lpPlanets + cPlanet;
  lpplT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lpplT < pPVar8) {
    iVar5 = iVar1 - ((POINT *)rgptPlan + lpplT->id)->x;
    iVar6 = iVar2 - *(int *)((int)&rgptPlan[0].y + lpplT->id * 4);
    uVar11 = __aFulmul((long)iVar6,(long)iVar6);
    uVar12 = __aFulmul((long)iVar5,(long)iVar5);
    if (((((long)(uVar12 + uVar11) < lVar4) && (((PLANET *)lpplT)->iPlayer == idPlayer)) &&
        (((uint)((PLANET *)lpplT)->wFlags >> 9 & 1) != 0)) &&
       ((fBigOnes == 0 ||
        ((iVar5 = *(int *)((int)((PLANET *)lpplT)->rgwtMin + 0xe), -1 < iVar5 &&
         ((0 < iVar5 || (0xfa < *(uint *)(((PLANET *)lpplT)->rgwtMin + 3))))))))) {
      lpplBest = lpplT;
      lVar4 = uVar12 + uVar11;
    }
    lpplT = (PLANET *)CONCAT22(lpplT._2_2_,(PLANET *)lpplT + 1);
  }
  if (((PLANET *)lpplBest == (PLANET *)0x0) && (lpplBest._2_2_ == 0)) {
    sVar7 = -1;
  }
  else {
    sVar7 = lpplBest->id;
  }
  return sVar7;
}



// ======================================================================
// Function: FMoveToNearestStarbase
// Address: 1090:6f7e
// Segment: MEMORY_AIU
// ======================================================================


short FMoveToNearestStarbase(FLEET *lpfl,short fBigOnes)

{
  short sVar1;
  ORDER ord;
  short id;
  
  ord.id = IdplFindClosestStarbase(lpfl,fBigOnes);
  if (ord.id == -1) {
    sVar1 = 0;
  }
  else {
    ord.pt.x = ((POINT *)rgptPlan + ord.id)->x;
    ord.pt.y = *(short *)((int)&rgptPlan[0].y + ord.id * 4);
    ord.wFlags = ord.wFlags & 0xe000U | 0x1140;
    sVar1 = FMoveAiFleet(lpfl,&ord,0);
  }
  return sVar1;
}



// ======================================================================
// Function: MoveToNearestPlanetOrEnemy
// Address: 1090:7014
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109070e8) */
/* WARNING: Removing unreachable block (ram,0x10907166) */

void MoveToNearestPlanetOrEnemy(FLEET *lpfl,short dEnemyRange)

{
  int iVar1;
  int iVar2;
  long lVar3;
  int iVar4;
  int iVar5;
  short sVar6;
  PLANET *pPVar7;
  FLEET *pFVar8;
  PLORD *pPVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  ulong uVar12;
  ulong uVar13;
  POINT pt_00;
  SCAN scan;
  long lBest;
  long l;
  ORDER ord;
  short dx;
  PLANET *lpplT;
  PLANET *lpplBest;
  PLANET *lpplTMac;
  short dy;
  short id;
  POINT pt;
  
  lVar3 = 10000000;
  lpplBest = (PLANET *)0x0;
  uVar10 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar8 = (FLEET *)lpfl;
  uVar11 = (undefined2)((ulong)pFVar8->lpplord >> 0x10);
  pPVar9 = (PLORD *)pFVar8->lpplord;
  iVar1 = (pPVar9 + 1)->wFlags;
  iVar2 = *(int *)&pPVar9[1].iordMax;
  pPVar7 = (PLANET *)lpPlanets + cPlanet;
  lpplT = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lpplT < pPVar7) {
    iVar4 = iVar1 - ((POINT *)rgptPlan + lpplT->id)->x;
    iVar5 = iVar2 - *(int *)((int)&rgptPlan[0].y + lpplT->id * 4);
    uVar12 = __aFulmul((long)iVar5,(long)iVar5);
    uVar13 = __aFulmul((long)iVar4,(long)iVar4);
    if ((((long)(uVar13 + uVar12) < lVar3) && (((PLANET *)lpplT)->iPlayer != idPlayer)) &&
       (((PLANET *)lpplT)->iPlayer != -1)) {
      lpplBest = lpplT;
      lVar3 = uVar13 + uVar12;
    }
    lpplT = (PLANET *)CONCAT22(lpplT._2_2_,(PLANET *)lpplT + 1);
  }
  if ((((PLANET *)lpplBest == (PLANET *)0x0) && (lpplBest._2_2_ == 0)) ||
     (uVar12 = __aFulmul((long)dEnemyRange,(long)dEnemyRange), (long)uVar12 < lVar3)) {
    pt_00.y = (pFVar8->pt).y;
    pt_00.x = (&pFVar8->pt)->x;
    sVar6 = FFindNearestObject(pt_00,0x21,&scan);
    if (sVar6 == 0) {
      return;
    }
    id = scan.idpl;
  }
  else {
    id = lpplBest->id;
  }
  if (pFVar8->idPlanet != id) {
    ord.id = id;
    ord.pt.x = ((POINT *)rgptPlan + id)->x;
    ord.pt.y = *(short *)((int)&rgptPlan[0].y + id * 4);
    ord.wFlags = ord.wFlags & 0xe000U | 0x1140;
    FMoveAiFleet(lpfl,&ord,0);
  }
  return;
}



// ======================================================================
// Function: EnsureAiStarbaseDesigns
// Address: 1090:7222
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109075ca) */
/* WARNING: Removing unreachable block (ram,0x1090743d) */
/* WARNING: Removing unreachable block (ram,0x1090763a) */

void EnsureAiStarbaseDesigns(void)

{
  undefined2 uVar1;
  undefined4 uVar2;
  int iVar3;
  int iVar4;
  short iSetLast;
  short i;
  short iSetNew;
  ushort wTurnLast;
  
  uVar2 = *(undefined4 *)(idPlayer * 4 + 0x14c);
  if ((*(uint *)((int)uVar2 + 0x1a1) >> 9 & 1) != 0) {
    FCreateAiStarbase(2,2,-1,-1);
    FCreateAiStarbase(4,3,-1,-1);
  }
  uVar2 = *(undefined4 *)(idPlayer * 4 + 0x14c);
  if ((*(uint *)((int)uVar2 + 0x10e) >> 9 & 1) != 0) {
    FCreateAiStarbase(1,1,-1,-1);
  }
  uVar2 = *(undefined4 *)(idPlayer * 4 + 0x14c);
  if ((*(uint *)((int)uVar2 + 0x234) >> 9 & 1) != 0) {
    FCreateAiStarbase(3,2,-1,-1);
  }
  if (0x31 < (uint)game.turn) {
    iSetLast = -1;
    wTurnLast = 0;
    for (i = 0; i < 10; i = i + 2) {
      if (i == 6) {
        i = 5;
      }
      if (((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) &&
         (wTurnLast <= *(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7d))) {
        wTurnLast = *(ushort *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7d);
        iSetLast = i;
      }
    }
    if ((iSetLast != -1) && (wTurnLast + 0x28 <= (uint)game.turn)) {
      if (iSetLast < 5) {
        i = 5;
        iVar3 = i;
      }
      else {
        i = 0;
        iVar3 = i;
      }
      for (; i < iVar3 + 5; i = i + 2) {
        if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) {
          uVar1 = *(undefined2 *)(idPlayer * 4 + 0x14e);
          iVar4 = *(int *)(idPlayer * 4 + 0x14c) + i * 0x93;
          if ((*(int *)(iVar4 + 0x85) != 0) || (*(int *)(iVar4 + 0x83) != 0)) goto AIU_LOrbital;
        }
      }
      FCreateAiStarbase(iVar3,1,-1,-1);
      FCreateAiStarbase(iVar3 + 2,2,-1,-1);
      FCreateAiStarbase(iVar3 + 4,3,-1,-1);
    }
AIU_LOrbital:
    iSetLast = -1;
    wTurnLast = 0;
    for (i = 1; i < 9; i = i + 2) {
      if (i == 5) {
        i = 6;
      }
      if (((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) &&
         (wTurnLast <= *(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7d))) {
        wTurnLast = *(ushort *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7d);
        iSetLast = i;
      }
    }
    if ((iSetLast != -1) && (wTurnLast + 0x28 <= (uint)game.turn)) {
      if (iSetLast < 5) {
        iVar3 = 6;
      }
      else {
        iVar3 = 1;
      }
      if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + iVar3 * 0x93 + 0x7b) >> 9 & 1) == 0) {
        uVar1 = *(undefined2 *)(idPlayer * 4 + 0x14e);
        iVar4 = *(int *)(idPlayer * 4 + 0x14c) + iVar3 * 0x93;
        if (*(int *)(iVar4 + 0x85) != 0) {
          return;
        }
        if (*(int *)(iVar4 + 0x83) != 0) {
          return;
        }
      }
      if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + (iVar3 + 2) * 0x93 + 0x7b) >> 9 & 1) ==
          0) {
        uVar1 = *(undefined2 *)(idPlayer * 4 + 0x14e);
        iVar4 = *(int *)(idPlayer * 4 + 0x14c) + (iVar3 + 2) * 0x93;
        if (*(int *)(iVar4 + 0x85) != 0) {
          return;
        }
        if (*(int *)(iVar4 + 0x83) != 0) {
          return;
        }
      }
      FCreateAiStarbase(iVar3,1,-1,-1);
      FCreateAiStarbase(iVar3 + 2,2,-1,-1);
    }
  }
  return;
}



// ======================================================================
// Function: EnsureMacintiStarbaseDesigns
// Address: 1090:76e4
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109079ee) */

void EnsureMacintiStarbaseDesigns(byte *rgSB)

{
  undefined2 uVar1;
  undefined4 uVar2;
  undefined4 uVar3;
  short sVar4;
  int iVar5;
  short iNew;
  short j;
  short i;
  short cAge;
  short iOld;
  short k;
  
  *rgSB = 0;
  i = 1;
  do {
    if (3 < i) {
      iOld = -1;
      for (i = 1; i < 4; i = i + 1) {
        if ((1 < rgSB[i]) &&
           (((iOld == -1 || (rgSB[iOld] < rgSB[i])) ||
            ((rgSB[i] == rgSB[iOld] &&
             (*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7d) <
              *(uint *)(*(int *)(idPlayer * 4 + 0x14c) + iOld * 0x93 + 0x7d))))))) {
          iOld = i;
        }
      }
      for (i = 1; i < 4; i = i + 1) {
        if ((1 < rgSB[i]) && (i != iOld)) {
          rgSB[i] = 0;
        }
      }
      i = 0;
      do {
        if (1 < i) {
          for (i = 4; i < 10; i = i + 1) {
            rgSB[i] = (*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1)
                      != 0;
          }
          uVar2 = *(undefined4 *)(idPlayer * 4 + 0x14c);
          uVar3 = *(undefined4 *)(idPlayer * 4 + 0x14c);
          if (*(uint *)((int)uVar3 + 0x2c9) < *(uint *)((int)uVar2 + 0x482)) {
            iNew = 7;
            iOld = 4;
          }
          else {
            iNew = 4;
            iOld = 7;
          }
          if ((uint)(game.turn -
                    *(int *)(*(int *)(idPlayer * 4 + 0x14c) + iOld * 0x93 + 0x7d)) < 0x1e) {
            j._0_1_ = 2;
          }
          else {
            j._0_1_ = 3;
          }
          for (i = iOld; i < iOld + 3; i = i + 1) {
            rgSB[i] = (byte)j;
          }
          iVar5 = *(int *)(*(int *)(idPlayer * 4 + 0x14c) + iNew * 0x93) + -0x20;
          if ((iVar5 < 4) && (rgSB[3] = 2, iVar5 < 3)) {
            rgSB[2] = 2;
          }
          return;
        }
        for (j = 0; j < 3; j = j + 1) {
          if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + (i * 3 + 4 + j) * 0x93 + 0x7b) >> 9
              & 1) == 0) {
            uVar1 = *(undefined2 *)(idPlayer * 4 + 0x14e);
            iVar5 = *(int *)(idPlayer * 4 + 0x14c) + (i * 3 + 4 + j) * 0x93;
            if ((*(int *)(iVar5 + 0x85) != 0) || (*(int *)(iVar5 + 0x83) != 0)) break;
          }
        }
        if (j == 3) {
          for (j = 0; j < 3; j = j + 1) {
            k = 5;
            while ((2 < k && (sVar4 = FCreateAiStarbase(i * 3 + 4 + j,j + 1,
                                                        (uint)((byte *)vrgSBMacAisb)[k],k + -1),
                             sVar4 == 0))) {
              k = k + -1;
            }
          }
        }
        i = i + 1;
      } while( true );
    }
    if ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7b) >> 9 & 1) == 0) {
      uVar1 = *(undefined2 *)(idPlayer * 4 + 0x14e);
      iVar5 = *(int *)(idPlayer * 4 + 0x14c) + i * 0x93;
      if ((*(int *)(iVar5 + 0x83) == 0) && (*(int *)(iVar5 + 0x85) == 0)) goto LAB_1090_7759;
      iVar5 = game.turn - *(int *)(*(int *)(idPlayer * 4 + 0x14c) + i * 0x93 + 0x7d);
      if (iVar5 < 0x23) {
        if ((((uint)game.turn < 0x1a) || (i != 1)) ||
           (*(char *)(*(int *)(idPlayer * 4 + 0x14c) + 0x10d) == '\b')) {
          rgSB[i] = 0;
        }
        else {
          rgSB[1] = 3;
        }
      }
      else if (iVar5 < 0x32) {
        rgSB[i] = 2;
      }
      else {
        rgSB[i] = 3;
      }
    }
    else {
LAB_1090_7759:
      if (i < 3) {
        sVar4 = 1;
      }
      else {
        sVar4 = 2;
      }
      sVar4 = FCreateAiStarbase(i,sVar4,(uint)(byte)((undefined *)&UNK_1090_76dd)[i],i);
      if (sVar4 == 0) {
        rgSB[i] = 1;
      }
      else {
        rgSB[i] = 0;
      }
    }
    i = i + 1;
  } while( true );
}



// ======================================================================
// Function: FCreateAiStarbase
// Address: 1090:7bca
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Variable defined which should be unmapped: lphs */

short FCreateAiStarbase(short ishdef,short iLevel,short aisb,short isb)

{
  uint *puVar1;
  SHDEF *pSVar2;
  SHDEF *pSVar3;
  uint uVar4;
  short sVar5;
  int iVar6;
  SHDEF *pSVar7;
  SHDEF *pSVar8;
  undefined2 unaff_SS;
  HS *lphs;
  SHDEF shdef;
  short i;
  
  if (aisb < 0) {
    if ((((ishdef == 1) || (ishdef == 3)) || (ishdef == 6)) || (ishdef == 8)) {
      aisb = 0xc;
      isb = 0;
      if (iLevel == 2) {
        iLevel = 3;
      }
    }
    else {
      aisb = 0;
      isb = 2;
    }
  }
  sVar5 = FCreateAiShdef(-1,isb,(byte *)CONCAT22((undefined *)&DAT_1120_1090,(byte *)vrgSBAip + aisb
                                                ));
  if (sVar5 == 0) {
    sVar5 = 0;
  }
  else {
    pSVar7 = (SHDEF *)&shdefBuild;
    pSVar8 = &shdef;
    for (iVar6 = 0x49; iVar6 != 0; iVar6 = iVar6 + -1) {
      pSVar3 = pSVar8;
      pSVar8 = (SHDEF *)(pSVar8->hul).rgTech;
      pSVar2 = pSVar7;
      pSVar7 = (SHDEF *)(pSVar7->hul).rgTech;
      (pSVar3->hul).ihuldef = (pSVar2->hul).ihuldef;
    }
    *(char *)&(pSVar8->hul).ihuldef = (char)(pSVar7->hul).ihuldef;
    if (iLevel < 3) {
      for (i = 0; i < (int)(uint)shdef.hul.chs; i = i + 1) {
        lphs = (HS *)CONCAT22(unaff_SS,shdef.hul.rghs + i);
        if ((uint)shdef.hul.rghs[i].wFlags >> 8 < 4) {
          if (((iLevel < 2) &&
              (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 4)) &&
             ((lphs->grhst == hstSpecialSB || (1 < (uint)shdef.hul.rghs[i].wFlags >> 8)))) {
            iVar6 = shdef.hul.rghs[i].wFlags;
            puVar1 = (uint *)&shdef.hul.rghs[i].wFlags;
            *puVar1 = *puVar1 & 0xff;
            puVar1 = (uint *)&shdef.hul.rghs[i].wFlags;
            *puVar1 = *puVar1 | iVar6 - 0x100U & 0xff00;
          }
        }
        else {
          uVar4 = shdef.hul.rghs[i].wFlags;
          puVar1 = (uint *)&shdef.hul.rghs[i].wFlags;
          *puVar1 = *puVar1 & 0xff;
          puVar1 = (uint *)&shdef.hul.rghs[i].wFlags;
          *puVar1 = *puVar1 | ((uVar4 >> 8) >> (3U - (char)iLevel & 0x1f)) << 8;
        }
      }
    }
    shdef.wFlags = shdef.wFlags & 0x83ffU | (ishdef + 0x10U & 0x1f) << 10;
    PickANameAndBmp(&shdef,idsGuardianAngel,0xd,shdef.hul.ibmp);
    sVar5 = FChangeAiShdef(&shdef,ishdef + 0x10);
  }
  return sVar5;
}



// ======================================================================
// Function: FAIFling
// Address: 1090:7dd6
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10907e96) */
/* WARNING: Removing unreachable block (ram,0x10907e76) */
/* WARNING: Removing unreachable block (ram,0x10907e9b) */
/* WARNING: Removing unreachable block (ram,0x10907ec3) */
/* WARNING: Removing unreachable block (ram,0x10907ec8) */
/* WARNING: Removing unreachable block (ram,0x1090816b) */
/* WARNING: Removing unreachable block (ram,0x109083b5) */
/* WARNING: Removing unreachable block (ram,0x109083df) */
/* WARNING: Removing unreachable block (ram,0x109083fd) */

short FAIFling(PLANET *lppl,long *rgResAvail)

{
  uint uVar1;
  long lVar2;
  uint uVar3;
  short sVar4;
  PLANET *pPVar5;
  int iVar6;
  long *plVar7;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar8;
  ulong uVar9;
  ulong uVar10;
  long lVar11;
  ushort in_stack_0000ffc4;
  short iKeep;
  PROD *lpprod;
  long l;
  PLANET *lpplHitMac;
  short cFound;
  long dx;
  PLANET *lpplBest;
  short iLevelBest;
  short fTwoMAs;
  short i;
  long dBigAssPacket;
  long d2;
  short iT;
  long dy;
  POINT pt;
  PLANET *lpplHit;
  
  uVar9 = CONCAT22(unaff_SI,unaff_DI);
  cFound = 0;
  iLevelBest = -1;
  if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 4) {
    for (i = 0; i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
      uVar10 = __aFulshr(uVar9,in_stack_0000ffc4);
      if (((((uint)uVar10 & 7) == 1) &&
          (uVar10 = __aFulshr(uVar9,in_stack_0000ffc4), 0xd < ((uint)uVar10 & 0x7f))) &&
         (uVar10 = __aFulshr(uVar9,in_stack_0000ffc4), ((uint)uVar10 & 0x7f) < 0x12)) {
        return 0;
      }
    }
    if (1 < (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7)) {
      uVar3 = *(uint *)rgResAvail + *(uint *)(rgResAvail + 1);
      iVar6 = *(int *)((int)rgResAvail + 2) + *(int *)((int)rgResAvail + 6) +
              (uint)CARRY2(*(uint *)rgResAvail,*(uint *)(rgResAvail + 1)) +
              *(int *)((int)rgResAvail + 10) + (uint)CARRY2(uVar3,*(uint *)(rgResAvail + 2));
      if ((-1 < iVar6) && ((0 < iVar6 || (3000 < uVar3 + *(uint *)(rgResAvail + 2))))) {
        uVar8 = (undefined2)((ulong)lppl >> 0x10);
        if ((((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0) &&
           ((sVar4 = IWarpMAFromLppl(lppl,&fTwoMAs), 9 < sVar4 &&
            (sVar4 = Random(4), sVar4 == 0)))) {
          pt.x = ((POINT *)rgptPlan + lppl->id)->x;
          pt.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
          for (iT = 0; iT < 3; iT = iT + 1) {
            plVar7 = ((PLANET *)lppl)->rgwtMin + iT;
            uVar3 = *(uint *)((int)plVar7 + 2);
            if ((-1 < (int)uVar3) && ((0 < (int)uVar3 || (0x30d4 < *(uint *)plVar7)))) break;
          }
          dBigAssPacket._0_2_ = (undefined2)((long *)vrgAiPacketDist)[fTwoMAs];
          dBigAssPacket._2_2_ = *(undefined2 *)((int)(long *)vrgAiPacketDist + fTwoMAs * 4 + 2);
          if (iT < 3) {
            dBigAssPacket =
                 __aFulmul(CONCAT22(dBigAssPacket._2_2_,(undefined2)dBigAssPacket),3);
          }
          pPVar5 = (PLANET *)lpPlanets + cPlanet;
          lpplHit = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
          while ((PLANET *)lpplHit < pPVar5) {
            uVar8 = (undefined2)((ulong)lpplHit >> 0x10);
            if ((((((PLANET *)lpplHit)->iPlayer != -1) &&
                 (((PLANET *)lpplHit)->iPlayer != idPlayer)) &&
                ((uint)game.turn <= ((PLANET *)lpplHit)->turn + 2U)) &&
               (((uint)((PLANET *)lpplHit)->uGuesses >> 0xc < 0xe ||
                ((((PLANET *)lpplHit)->uGuesses & 0xfffU) < 0x2ee)))) {
              sVar4 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lpplHit)->iPlayer,
                                        rsMajorAdv);
              if (sVar4 != 8) {
                if (((uint)((PLANET *)lpplHit)->wFlags >> 9 & 1) != 0) {
                  sVar4 = GetRaceStat((PLAYER *)rgplr + ((PLANET *)lpplHit)->iPlayer
                                            ,rsMajorAdv);
                  if (sVar4 == 6) goto LAB_1090_819e;
                }
                iVar6 = pt.x - ((POINT *)rgptPlan + lpplHit->id)->x;
                dy._0_2_ = pt.y - *(int *)((int)&rgptPlan[0].y + lpplHit->id * 4);
                dy._2_2_ = (int)dy >> 0xf;
                uVar9 = __aFulmul((long)(int)dy,(long)(int)dy);
                uVar10 = __aFulmul((long)iVar6,(long)iVar6);
                d2 = uVar10 + uVar9;
                if (d2 <= dBigAssPacket) {
                  cFound = cFound + 1;
                  sVar4 = Random(cFound);
                  if (sVar4 == 0) {
                    iLevelBest = 0xd;
                    lpplBest = lpplHit;
                  }
                }
              }
            }
LAB_1090_819e:
            lpplHit = (PLANET *)CONCAT22(uVar8,(PLANET *)lpplHit + 1);
          }
          if (9 < iLevelBest) {
            sel.pl.wFlags =
                 sel.pl.wFlags & 0xc000U | (iLevelBest - 4U & 0xf) << 10 |
                 lpplBest->id + 1U & 0x3ff;
            FLookupPlanet(-1,(PLANET *)&sel.pl);
            if ((-1 < *(int *)((int)rgResAvail + 10)) &&
               ((0 < *(int *)((int)rgResAvail + 10) ||
                ((char *)rgbCur + 0x289 <= *(char **)(rgResAvail + 2))))) {
              sVar4 = Random(3);
              if (sVar4 != 0) {
                AddItemToQueue(0x10,0x50,grobjPlanet,1);
              }
            }
            if ((((*(int *)((int)rgResAvail + 2) < 0) ||
                 (((*(int *)((int)rgResAvail + 2) < 1 && (*(uint *)rgResAvail < 0xbb9)) ||
                  (*(int *)((int)rgResAvail + 6) < 0)))) ||
                (((*(int *)((int)rgResAvail + 6) < 1 && (*(uint *)(rgResAvail + 1) < 0xfa1)) ||
                 (*(int *)((int)rgResAvail + 10) < 0)))) ||
               ((*(int *)((int)rgResAvail + 10) < 1 && (*(uint *)(rgResAvail + 2) < 0xbb9)))) {
              if (((*(int *)((int)rgResAvail + 2) < 0) ||
                  (((*(int *)((int)rgResAvail + 2) < 1 && (*(uint *)rgResAvail < 0x5dd)) ||
                   (*(int *)((int)rgResAvail + 6) < 0)))) ||
                 (((*(int *)((int)rgResAvail + 6) < 1 && (*(uint *)(rgResAvail + 1) < 0x8cb)) ||
                  ((*(int *)((int)rgResAvail + 10) < 0 ||
                   ((*(int *)((int)rgResAvail + 10) < 1 && (*(uint *)(rgResAvail + 2) < 0x5dd)))))))
                 ) {
                for (iT = 0; iT < 3; iT = iT + 1) {
                  if (iT == 1) {
                    uVar3 = 0x9c4;
                  }
                  else {
                    uVar3 = 0x4e2;
                  }
                  uVar1 = *(uint *)((int)(rgResAvail + iT) + 2);
                  if ((-1 < (int)uVar1) &&
                     ((0 < (int)uVar1 || (uVar3 < *(uint *)(rgResAvail + iT))))) {
                    uVar1 = *(uint *)(rgResAvail + iT);
                    lVar11 = __aFldiv(CONCAT22(*(uint *)((int)(rgResAvail + iT) + 2) -
                                                       (uint)(uVar1 < uVar3),uVar1 - uVar3),200);
                    lVar2 = lVar11;
                    if (lVar11 < 2) {
                      lVar2 = 1;
                    }
                    if (lVar2 < 0x1a) {
                      if (lVar11 < 2) {
                        lVar11 = 1;
                      }
                    }
                    else {
                      lVar11 = 0x19;
                    }
                    AddItemToQueue(iT + 0xe,(ushort)lVar11,grobjPlanet,1);
                  }
                }
              }
              else {
                AddItemToQueue(0x11,0xf,grobjPlanet,1);
              }
            }
            else {
              AddItemToQueue(0x11,0x1e,grobjPlanet,1);
            }
            return 1;
          }
        }
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: IshdefAiSBLatestOF
// Address: 1090:8458
// Segment: MEMORY_AIU
// ======================================================================


short IshdefAiSBLatestOF(void)

{
  undefined4 uVar1;
  undefined4 uVar2;
  short sVar3;
  
  uVar1 = *(undefined4 *)(idPlayer * 4 + 0x14c);
  if (((*(uint *)((int)uVar1 + 0x3ed) >> 9 & 1) == 0) &&
     (uVar1 = *(undefined4 *)(idPlayer * 4 + 0x14c),
     uVar2 = *(undefined4 *)(idPlayer * 4 + 0x14c),
     *(uint *)((int)uVar1 + 0x110) < *(uint *)((int)uVar2 + 0x3ef))) {
    sVar3 = 6;
  }
  else {
    sVar3 = 1;
  }
  return sVar3;
}



// ======================================================================
// Function: IshdefAiSBLatest
// Address: 1090:84be
// Segment: MEMORY_AIU
// ======================================================================


short IshdefAiSBLatest(void)

{
  undefined4 uVar1;
  undefined4 uVar2;
  short sVar3;
  
  uVar1 = *(undefined4 *)(idPlayer * 4 + 0x14c);
  if (((*(uint *)((int)uVar1 + 0x35a) >> 9 & 1) == 0) &&
     (uVar1 = *(undefined4 *)(idPlayer * 4 + 0x14c),
     uVar2 = *(undefined4 *)(idPlayer * 4 + 0x14c),
     *(uint *)((int)uVar1 + 0x7d) < *(uint *)((int)uVar2 + 0x35c))) {
    sVar3 = 5;
  }
  else {
    sVar3 = 0;
  }
  return sVar3;
}



// ======================================================================
// Function: QueueAiStarbases
// Address: 1090:8524
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10908793) */
/* WARNING: Removing unreachable block (ram,0x109087b3) */
/* WARNING: Removing unreachable block (ram,0x109087b8) */

void QueueAiStarbases(PROD *rgprod,short ishdefSBLatest)

{
  int iVar1;
  PLANET *pPVar2;
  byte *pbVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar4;
  undefined2 uVar5;
  ulong uVar6;
  ulong uVar7;
  PLANET *pPVar8;
  PROD *lpprod;
  short i;
  PLANET *lppl;
  PLANET *lpplMac;
  
  uVar7 = CONCAT22(unaff_SI,unaff_DI);
  if (((ishdefSBLatest != -1) &&
      (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 5)) &&
     (((((uint)gd._0_2_ >> 0xb & 1) == 0 &&
       ((((int)game.lid != -0x10b7 || (game.lid._2_2_ != 0x8c)) ||
        (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 1)))) ||
      ((uint)game.turn < 0x1f)))) {
    pPVar2 = (PLANET *)lpPlanets + cPlanet;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    pPVar8 = (PLANET *)lpPlanets;
    while ((PLANET *)lppl < pPVar2) {
      uVar5 = (undefined2)((ulong)lppl >> 0x10);
      if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 4) {
        if ((((PLANET *)lppl)->iPlayer == idPlayer) &&
           (ishdefSBLatest = iBuildCyberStarbase(lppl), ishdefSBLatest != -1)) {
LAB_1090_870e:
          ChangeMainObjSel(1,lppl->id);
          InitProduction(rgprod);
          i = 0;
          while ((i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac &&
                 ((uVar6 = __aFulshr(uVar7,(ushort)pPVar8), ((uint)uVar6 & 7) != 2 ||
                  (uVar6 = __aFulshr(uVar7,(ushort)pPVar8), ((uint)uVar6 & 0x7f) < 0x10)))))
          {
            i = i + 1;
          }
          if (i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac) {
            FinishProduction(0);
          }
          else {
            AddItemToQueue(ishdefSBLatest + 0x10,1,grobjFleet,1);
            FinishProduction(1);
          }
        }
      }
      else if (((((PLANET *)lppl)->iPlayer == idPlayer) &&
               ((((uint)((PLANET *)lppl)->wFlags >> 9 & 1) == 0 ||
                (9 < (*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf))))) &&
              ((iVar1 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe), -1 < iVar1 &&
               (((0 < iVar1 || (0x4f < *(uint *)(((PLANET *)lppl)->rgwtMin + 3))) &&
                (((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] == 0)))))) {
        i = 0;
        while( true ) {
          uVar4 = (undefined2)((ulong)vlpbAiData >> 0x10);
          pbVar3 = (byte *)vlpbAiData;
          if ((*(int *)(pbVar3 + 2) <= i) || (*(int *)(pbVar3 + i * 0x14 + 4) == lppl->id)) break;
          i = i + 1;
        }
        if (i != *(int *)(pbVar3 + 2)) goto LAB_1090_870e;
      }
      lppl = (PLANET *)CONCAT22(uVar5,(PLANET *)lppl + 1);
    }
  }
  return;
}



// ======================================================================
// Function: FUpgradeAiStarbase
// Address: 1090:882a
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x109088e1) */
/* WARNING: Removing unreachable block (ram,0x109088c1) */
/* WARNING: Removing unreachable block (ram,0x109088e6) */
/* WARNING: Variable defined which should be unmapped: ishdef */

short FUpgradeAiStarbase(PLANET *lppl,short ishdefSBLatest)

{
  uint uVar1;
  short sVar2;
  short sVar3;
  int iVar4;
  PLANET *pPVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar6;
  ulong uVar7;
  ulong uVar8;
  short ishdef;
  PROD *lpprod;
  short isbNew;
  short pctUpg;
  short i;
  short iDesigns;
  short isbCur;
  
  uVar8 = CONCAT22(unaff_SI,unaff_DI);
  if (ishdefSBLatest == -1) {
    return 0;
  }
  uVar6 = (undefined2)((ulong)lppl >> 0x10);
  pPVar5 = (PLANET *)lppl;
  if (((uint)pPVar5->wFlags >> 9 & 1) != 0) {
    for (i = 0; i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
      uVar7 = __aFulshr(uVar8,ishdef);
      if ((((uint)uVar7 & 7) == 2) &&
         (uVar7 = __aFulshr(uVar8,ishdef), 0xf < ((uint)uVar7 & 0x7f))) {
        return 0;
      }
    }
  }
  if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 5) {
    if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 4) &&
       ((uint)game.turn < 0x28)) {
      return 0;
    }
    if (((uint)pPVar5->wFlags >> 9 & 1) != 0) {
      if (((((*(uint *)&pPVar5->field11_0x2c & 0xf) == 1) ||
           ((*(uint *)&pPVar5->field11_0x2c & 0xf) == 3)) ||
          ((*(uint *)&pPVar5->field11_0x2c & 0xf) == 6)) ||
         ((*(uint *)&pPVar5->field11_0x2c & 0xf) == 8)) {
        iDesigns = 2;
        ishdefSBLatest = IshdefAiSBLatestOF();
      }
      else {
        iDesigns = 3;
      }
      if (((*(uint *)&pPVar5->field11_0x2c & 0xf) < (uint)ishdefSBLatest) ||
         ((uint)(ishdefSBLatest + (iDesigns + -1) * 2) < (*(uint *)&pPVar5->field11_0x2c & 0xf))) {
        pctUpg = (game.turn -
                 *(int *)(*(int *)(idPlayer * 4 + 0x14c) + ishdefSBLatest * 0x93 + 0x7d)) +
                 -10;
        if (pctUpg < 0) {
          pctUpg = 0;
        }
        else if (pctUpg < 0x32) {
          pctUpg = pctUpg >> 1;
        }
        sVar3 = Random(100);
        if (sVar3 < pctUpg + 5) {
          if ((((*(uint *)&pPVar5->field11_0x2c & 0xf) == 1) ||
              ((*(uint *)&pPVar5->field11_0x2c & 0xf) == 3)) ||
             (((*(uint *)&pPVar5->field11_0x2c & 0xf) == 6 ||
              ((*(uint *)&pPVar5->field11_0x2c & 0xf) == 8)))) {
            iVar4 = ishdefSBLatest + (*(uint *)&pPVar5->field11_0x2c & 0xf) % 5 + -1;
          }
          else {
            iVar4 = ishdefSBLatest + (*(uint *)&pPVar5->field11_0x2c & 0xf) % 5;
          }
          AddItemToQueue(iVar4 + 0x10,1,grobjFleet,1);
          return 1;
        }
      }
      else if ((((int)(((ulong)*(uint *)&pPVar5->field11_0x2c & 0xffff000f) % 5) <
                 (iDesigns + -1) * 2) &&
               ((*(uint *)(*(int *)(idPlayer * 4 + 0x14c) +
                           ((*(uint *)&pPVar5->field11_0x2c & 0xf) + 2) * 0x93 + 0x7b) >> 9 & 1) ==
                0)) && (sVar3 = Random(100), sVar3 < 6)) {
        i = 0;
        while( true ) {
          if (2 < i) {
            AddItemToQueue((*(uint *)&pPVar5->field11_0x2c & 0xf) + 0x12,1,grobjFleet,1);
            return 1;
          }
          uVar1 = *(uint *)((int)(pPVar5->rgwtMin + i) + 2);
          if (((int)uVar1 < 1) && (((int)uVar1 < 0 || (*(uint *)(pPVar5->rgwtMin + i) < 200))))
          break;
          i = i + 1;
        }
        return 0;
      }
    }
    return 0;
  }
  uVar1 = *(uint *)&pPVar5->field11_0x2c & 0xf;
  if ((vAiMacRecycleSB[uVar1] != 3) &&
     ((vAiMacRecycleSB[uVar1] != 2 || (sVar3 = Random(100), 9 < sVar3)))) {
    if ((3 < uVar1) && (((uVar1 != 6 && (uVar1 != 9)) && (sVar3 = Random(100), sVar3 < 8)))
       ) {
      isbNew = uVar1 + 1;
      goto AIU_LDoMacUpgrade2;
    }
    if (((3 < uVar1) || (sVar3 = PctPlanetCapacity(lppl), sVar3 < 0x10)) ||
       (sVar2 = Random(100), (sVar3 + -0xf) * 6 <= sVar2)) {
      return 0;
    }
  }
  isbNew = uVar1;
  if (uVar1 < 4) {
    do {
      isbNew = isbNew + 1;
      if (8 < isbNew) break;
    } while (vAiMacRecycleSB[isbNew] != 0);
  }
  else {
    isbNew = uVar1 + 3;
    if (9 < (uint)isbNew) {
      isbNew = uVar1 - 3;
    }
  }
AIU_LDoMacUpgrade2:
  AddItemToQueue(isbNew + 0x10,1,grobjFleet,1);
  return 1;
}



// ======================================================================
// Function: FQueueAiTerraforming
// Address: 1090:8d28
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10908f57) */
/* WARNING: Removing unreachable block (ram,0x10908f07) */
/* WARNING: Removing unreachable block (ram,0x10908de1) */
/* WARNING: Removing unreachable block (ram,0x10908e09) */
/* WARNING: Removing unreachable block (ram,0x10908f37) */
/* WARNING: Removing unreachable block (ram,0x10908f5c) */

short FQueueAiTerraforming(PLANET *lppl,long *rgResAvail,long *rgResCost)

{
  uint *puVar1;
  int iVar2;
  short sVar3;
  uint uVar4;
  PLANET *pPVar5;
  undefined2 unaff_SI;
  PROD *pPVar6;
  undefined2 unaff_DI;
  undefined2 uVar7;
  ulong uVar8;
  ulong uVar9;
  GrobjClass grobj;
  ushort in_stack_0000ffe0;
  PROD *lpprod;
  long rgItemCost [4];
  short dEnv;
  short j;
  short i;
  
  uVar9 = CONCAT22(unaff_SI,unaff_DI);
  if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 4) {
    uVar7 = (undefined2)((ulong)lppl >> 0x10);
    pPVar5 = (PLANET *)lppl;
    iVar2 = *(int *)((int)pPVar5->rgwtMin + 0xe);
    if ((0 < iVar2) || ((-1 < iVar2 && (199 < *(uint *)(pPVar5->rgwtMin + 3))))) {
      for (i = 0; i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
        uVar8 = __aFulshr(uVar9,in_stack_0000ffe0);
        if ((((uint)uVar8 & 7) == 1) &&
           (uVar8 = __aFulshr(uVar9,in_stack_0000ffe0), ((uint)uVar8 & 0x7f) == 0xc)) {
          return 0;
        }
      }
      j = -1;
      dEnv = 0;
      for (i = 0; i < 3; i = i + 1) {
        in_stack_0000ffe0 = (ushort)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
        sVar3 = _abs((int)pPVar5->rgEnvVar[i] - in_stack_0000ffe0);
        if (dEnv < sVar3) {
          j = i;
          in_stack_0000ffe0 = (ushort)*(char *)(idPlayer * 0xc0 + 0x59b2 + i);
          dEnv = _abs((int)pPVar5->rgEnvVar[i] - in_stack_0000ffe0);
        }
      }
      if (j != -1) {
        for (i = 0; i < cProdGlob; i = i + 1) {
          uVar8 = __aFulshr(uVar9,in_stack_0000ffe0);
          if (((((uint)uVar8 & 7) == 1) &&
              (uVar8 = __aFulshr(uVar9,in_stack_0000ffe0), ((uint)uVar8 & 0x7f) == 0xc)) &&
             (((pProdGlob + i)->dwFlags & 0x3ff) != 0)) {
            sVar3 = 1;
            grobj = grobjPlanet;
            if (((uint)(pProdGlob + i)->dwFlags & 0x3ff) < 5) {
              uVar4 = (uint)(pProdGlob + i)->dwFlags & 0x3ff;
            }
            else {
              uVar4 = 4;
            }
            uVar9 = __aFulshr(CONCAT22(1,uVar4),1);
            AddItemToQueue((uint)uVar9 & 0x7f,uVar4,grobj,sVar3);
            uVar7 = *(undefined2 *)((int)&pProdGlob[i].dwFlags + 2);
            pPVar6 = pProdGlob + i;
            *(uint *)&pPVar6->dwFlags = (uint)(pProdGlob + i)->dwFlags & 0xfc00;
            *(undefined2 *)((int)&pPVar6->dwFlags + 2) = uVar7;
            GetProductionCosts
                      (lppl,(PROD *)CONCAT22((undefined1 *)&DAT_1120_1120,pProdGlob + i),
                       (ulong *)rgItemCost,idPlayer,1);
            for (j = 0; j < 4; j = j + 1) {
              if (((uint)(pProdGlob + i)->dwFlags & 0x3ff) < 5) {
                uVar4 = (uint)(pProdGlob + i)->dwFlags & 0x3ff;
              }
              else {
                uVar4 = 4;
              }
              uVar9 = __aFulmul(CONCAT22(*(undefined2 *)((int)rgItemCost + j * 4 + 2),
                                                 (int)rgItemCost[j]),(ulong)uVar4);
              puVar1 = (uint *)(rgResCost + j);
              uVar4 = *puVar1;
              *puVar1 = *puVar1 + (uint)uVar9;
              puVar1 = (uint *)((int)(rgResCost + j) + 2);
              *puVar1 = *puVar1 + (int)(uVar9 >> 0x10) + (uint)CARRY2(uVar4,(uint)uVar9);
            }
            return 1;
          }
        }
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: FQueueAiScanner
// Address: 1090:90d6
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1090920e) */
/* WARNING: Removing unreachable block (ram,0x1090916c) */
/* WARNING: Removing unreachable block (ram,0x10909147) */
/* WARNING: Removing unreachable block (ram,0x10909167) */
/* WARNING: Removing unreachable block (ram,0x109091e6) */
/* WARNING: Removing unreachable block (ram,0x10909213) */
/* WARNING: Variable defined which should be unmapped: lpprod */
/* WARNING: Removing unreachable block (ram,0x10909248) */
/* WARNING: Removing unreachable block (ram,0x10909194) */
/* WARNING: Removing unreachable block (ram,0x10909243) */
/* WARNING: Removing unreachable block (ram,0x10909199) */

short FQueueAiScanner(PLANET *lppl,long *rgResAvail,long *rgResCost)

{
  uint *puVar1;
  uint uVar2;
  uint uVar3;
  int iVar4;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  ulong uVar5;
  ulong uVar6;
  undefined4 uVar7;
  short mdAddItem;
  PROD *lpprod;
  long rgItemCost [4];
  short j;
  short i;
  
  uVar6 = CONCAT22(unaff_SI,unaff_DI);
  lpprod._0_2_ = (PROD *)(PLPROD *)lpplProdGlob;
  for (i = 0; lpprod._0_2_ = (PROD *)((PLPROD *)(PROD *)lpprod + 1), iVar4 = cProdGlob,
      i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
    uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod);
    if (((((uint)uVar5 & 7) == 1) &&
        (uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), 0x11 < ((uint)uVar5 & 0x7f))) &&
       (uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), ((uint)uVar5 & 0x7f) < 0x1b)) {
      return 0;
    }
  }
  do {
    i = iVar4 + -1;
    if (i < 0) break;
    uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod);
    iVar4 = i;
  } while (((((uint)uVar5 & 7) != 1) ||
           (uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), ((uint)uVar5 & 0x7f) < 0x12))
          || (uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), 0x1a < ((uint)uVar5 & 0x7f)))
  ;
  if (-1 < i) {
    GetProductionCosts
              (lppl,(PROD *)CONCAT22((undefined1 *)&DAT_1120_1120,pProdGlob + i),
               (ulong *)rgItemCost,idPlayer,1);
    for (j = 0; j < 4; j = j + 1) {
      iVar4 = *(int *)((int)rgItemCost + j * 4 + 2);
      if ((-1 < iVar4) && ((0 < iVar4 || ((int)rgItemCost[j] != 0)))) {
        puVar1 = (uint *)(rgResCost + j);
        iVar4 = *(int *)((int)rgItemCost + j * 4 + 2) + *(uint *)((int)(rgResCost + j) + 2) +
                (uint)CARRY2(*(uint *)(rgItemCost + j),*puVar1);
        uVar2 = *(uint *)((int)(rgResAvail + j) + 2);
        if (((int)uVar2 <= iVar4) &&
           (((int)uVar2 < iVar4 || (*(uint *)(rgResAvail + j) < *(uint *)(rgItemCost + j) + *puVar1)
            ))) break;
      }
    }
    if (j == 4) {
      mdAddItem = 1;
      uVar7 = 0x10001;
      uVar6 = __aFulshr(0x10001,1);
      AddItemToQueue((uint)uVar6 & 0x7f,(ushort)uVar7,(GrobjClass)((ulong)uVar7 >> 0x10),mdAddItem);
      for (j = 0; j < 4; j = j + 1) {
        uVar3 = *(uint *)(rgItemCost + j);
        iVar4 = *(int *)((int)rgItemCost + j * 4 + 2);
        puVar1 = (uint *)(rgResCost + j);
        uVar2 = *puVar1;
        *puVar1 = *puVar1 + uVar3;
        puVar1 = (uint *)((int)(rgResCost + j) + 2);
        *puVar1 = *puVar1 + iVar4 + (uint)CARRY2(uVar2,uVar3);
      }
      return 1;
    }
  }
  return 0;
}



// ======================================================================
// Function: FQueueAiDefenses
// Address: 1090:939a
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10909524) */
/* WARNING: Removing unreachable block (ram,0x109094d4) */
/* WARNING: Removing unreachable block (ram,0x1090946b) */
/* WARNING: Removing unreachable block (ram,0x10909493) */
/* WARNING: Removing unreachable block (ram,0x10909504) */
/* WARNING: Removing unreachable block (ram,0x10909529) */
/* WARNING: Variable defined which should be unmapped: lpprod */

short FQueueAiDefenses(PLANET *lppl,long *rgResAvail,long *rgResCost)

{
  int iVar1;
  PLANET *pPVar2;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar3;
  long lVar4;
  ulong uVar5;
  ulong uVar6;
  PROD *lpprod;
  short j;
  short i;
  
  uVar6 = CONCAT22(unaff_SI,unaff_DI);
  uVar3 = (undefined2)((ulong)lppl >> 0x10);
  pPVar2 = (PLANET *)lppl;
  iVar1 = *(int *)((int)pPVar2->rgwtMin + 0xe);
  if ((-1 < iVar1) && ((0 < iVar1 || (0x63f < *(uint *)(pPVar2->rgwtMin + 3))))) {
    lVar4 = __aFldiv(CONCAT22(*(undefined2 *)((int)pPVar2->rgwtMin + 0xe),
                                      (int)pPVar2->rgwtMin[3]),0x50);
    if ((0xffff < lVar4) || ((-1 < lVar4 && ((*(uint *)&pPVar2->dwFlags & 0xfff) < (uint)lVar4)))) {
      lpprod._0_2_ = (PROD *)(PLPROD *)lpplProdGlob;
      for (i = 0; lpprod._0_2_ = (PROD *)((PLPROD *)(PROD *)lpprod + 1),
          i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
        uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod);
        if ((((uint)uVar5 & 7) == 1) &&
           (uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), ((uint)uVar5 & 0x7f) == 9)) {
          return 0;
        }
      }
      i = 0;
      while ((i < cProdGlob &&
             (((uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), ((uint)uVar5 & 7) != 1 ||
               (uVar5 = __aFulshr(uVar6,(ushort)(PROD *)lpprod), ((uint)uVar5 & 0x7f) != 9))
              || (((pProdGlob + i)->dwFlags & 0x3ff) == 0))))) {
        i = i + 1;
      }
      if (cProdGlob <= i) {
        return 0;
      }
      j = (uint)(pProdGlob + i)->dwFlags & 0x3ff;
      if (4 < (uint)j) {
        j = 4;
      }
      AddItemToQueue(9,j,grobjPlanet,1);
      return 1;
    }
  }
  return 0;
}



// ======================================================================
// Function: HandleBasicAiTasks
// Address: 1090:95a4
// Segment: MEMORY_AIU
// ======================================================================


void HandleBasicAiTasks
          (short iroCur,PROD *rgprod,short ishdefSBLatest,long *rgResAvail,long *rgResCost)

{
  PLANET *pPVar1;
  int iVar2;
  int iVar3;
  uint uVar4;
  uint uVar5;
  short sVar6;
  short fWrite;
  short ipl;
  short i;
  PLANET *lppl;
  
  KeepFleetsMoving();
  QueueAiStarbases(rgprod,ishdefSBLatest);
  for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
                    /* WARNING: Load size is inaccurate */
    pPVar1 = ((PLANET **)vrglpplAi)[ipl];
    iVar2 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
    lppl = (PLANET *)CONCAT22(iVar2,pPVar1);
    if ((pPVar1 == (PLANET *)0x0) && (iVar2 == 0)) break;
    if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) {
      iVar3 = *(int *)((int)pPVar1->rgwtMin + 0xe);
      if ((0 < iVar3) || ((-1 < iVar3 && (0x27 < *(uint *)(pPVar1->rgwtMin + 3)))))
      goto LAB_1090_9692;
    }
    else {
      iVar3 = *(int *)((int)pPVar1->rgwtMin + 0xe);
      if ((0 < iVar3) ||
         (((-1 < iVar3 && (0x3b < *(uint *)(pPVar1->rgwtMin + 3))) ||
          (((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] != 0)))) {
LAB_1090_9692:
        GetResourcesAvailable((PLANET *)CONCAT22(iVar2,pPVar1),rgResAvail);
        GetProdQCost((PLANET *)CONCAT22(iVar2,pPVar1),rgResCost);
        if (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 5) {
          for (i = 0; i < 4; i = i + 1) {
            uVar4 = *(uint *)((int)(rgResCost + i) + 2);
            uVar5 = *(uint *)((int)(rgResAvail + i) + 2);
            if (((int)uVar5 <= (int)uVar4) &&
               (((int)uVar5 < (int)uVar4 || (*(uint *)(rgResAvail + i) < *(uint *)(rgResCost + i))))
               ) break;
          }
          if (i < 3) goto LAB_1090_95c8;
        }
        ChangeMainObjSel(1,lppl->id);
        InitProduction(rgprod);
        fWrite = 0;
        if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 0) ||
           (((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 2] == 0)) {
          sVar6 = FUpgradeAiStarbase((PLANET *)CONCAT22(iVar2,pPVar1),ishdefSBLatest);
          if ((((sVar6 != 0) ||
               (sVar6 = FAIFling((PLANET *)CONCAT22(iVar2,pPVar1),rgResAvail), sVar6 != 0)) ||
              (sVar6 = FQueueAiScanner((PLANET *)CONCAT22(iVar2,pPVar1),rgResAvail,rgResCost),
              sVar6 != 0)) ||
             (sVar6 = FQueueAiDefenses((PLANET *)CONCAT22(iVar2,pPVar1),rgResAvail,rgResCost),
             sVar6 != 0)) {
            fWrite = 1;
          }
        }
        else if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 4)
                && (sVar6 = FUpgradeAiStarbase((PLANET *)CONCAT22(iVar2,pPVar1),ishdefSBLatest),
                   sVar6 != 0)) {
          fWrite = 1;
        }
        if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd != 0) &&
            (fWrite == 0)) &&
           (sVar6 = FQueueAiTerraforming((PLANET *)CONCAT22(iVar2,pPVar1),rgResAvail,rgResCost),
           sVar6 != 0)) {
          fWrite = 1;
        }
        FinishProduction(fWrite);
      }
    }
LAB_1090_95c8:
  }
  if ((((uint)game.wCrap >> 3 & 1) == 0) &&
     (game.mdSize * 10 + 0x14U <= (uint)game.turn)) {
    FixPlanetsUnderAttack(rgprod);
  }
  AddMinesToBlockedQueues();
  return;
}



// ======================================================================
// Function: SplitOutShdefs
// Address: 1090:98d8
// Segment: MEMORY_AIU
// ======================================================================


void SplitOutShdefs(byte *rgbIsh)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  bool bVar3;
  bool bVar4;
  FLEET *pFVar5;
  int iVar6;
  FLEET *pFVar7;
  undefined2 unaff_SS;
  FLEET *pFVar8;
  FLEET *lpflNew;
  short fMarked;
  FLEET flNew;
  short fUnmarked;
  FLEET *lpfl;
  short i;
  short ifl;
  short iFirst;
  short iLast;
  
  iFirst = -1;
  for (i = 0; i < 0x10; i = i + 1) {
    if ((rgbIsh[i] != 0) && (iFirst == -1)) {
      iFirst = i;
    }
  }
  if (iFirst != -1) {
    while ((*(uint *)((int)&rgplr[0].wFlags + idPlayer * 0xc0) & 0xfff) < 0x1f5) {
      ifl = 0;
      while( true ) {
        if (cFleet <= ifl) {
          return;
        }
                    /* WARNING: Load size is inaccurate */
        pFVar7 = ((FLEET **)rglpfl)[ifl];
        iVar6 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar6,pFVar7);
        if ((pFVar7 == (FLEET *)0x0) && (iVar6 == 0)) {
          return;
        }
        if ((pFVar7->iPlayer == idPlayer) && (((uint)pFVar7->wFlags >> 10 & 1) == 0)) break;
LAB_1090_995c:
        ifl = ifl + 1;
      }
      bVar4 = false;
      bVar3 = false;
      i = 0;
      while( true ) {
        if (0xf < i) goto LAB_1090_995c;
        if (0 < pFVar7->rgcsh[i]) break;
LAB_1090_9afa:
        i = i + 1;
      }
      if (rgbIsh[i] == 0) {
        if (!bVar3) {
          bVar4 = true;
          goto LAB_1090_9afa;
        }
      }
      else if (!bVar4) {
        bVar3 = true;
        goto LAB_1090_9afa;
      }
      ChangeMainObjSel(2,lpfl->id);
      pFVar8 = LpflNewSplit((FLEET *)&sel.fl);
      pFVar5 = (FLEET *)pFVar8;
      pFVar7 = &flNew;
      for (iVar6 = 0x3e; iVar6 != 0; iVar6 = iVar6 + -1) {
        pFVar2 = pFVar7;
        pFVar7 = (FLEET *)&pFVar7->iPlayer;
        pFVar1 = pFVar5;
        pFVar5 = (FLEET *)&pFVar5->iPlayer;
        pFVar2->id = pFVar1->id;
      }
      for (i = 0; i < 0x10; i = i + 1) {
        if (rgbIsh[i] != 0) {
          flNew.rgcsh[i] = *(short *)((int)&sel.fl + 0xc + i * 2);
          *(undefined2 *)((int)&sel.fl + 0xc + i * 2) = 0;
        }
      }
      FleetTransferCargoBalance((FLEET *)&sel.fl,&flNew);
      FLookupFleet(-1,(FLEET *)&sel.fl);
      FLookupFleet(-1,&flNew);
    }
  }
  return;
}



// ======================================================================
// Function: CheckAiShdefStatus
// Address: 1090:9b10
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10909c3a) */

short CheckAiShdefStatus
          (short ishBeg,short ishEnd,ushort cRecyclePeriod,short *piLatest,byte *rgbOld)

{
  HullDef *pHVar1;
  SHDEF *pSVar2;
  uint uVar3;
  int iVar4;
  HullDef *pHVar5;
  SHDEF *pSVar6;
  undefined2 unaff_SS;
  bool bVar7;
  SHDEF shdef;
  short i;
  ulong cExist;
  
  *piLatest = -1;
  cExist._0_2_ = 0;
  cExist._2_2_ = 0;
  for (i = ishBeg; i <= ishEnd; i = i + 1) {
    if ((*(uint *)((int)&rgshdef[0].wFlags + i * 0x93) >> 9 & 1) == 0) {
      uVar3 = *(uint *)((int)&rgshdef[0].cExist + i * 0x93);
      bVar7 = CARRY2((uint)cExist,uVar3);
      cExist._0_2_ = (uint)cExist + uVar3;
      cExist._2_2_ = cExist._2_2_ + *(int *)((int)&rgshdef[0].cExist + 2 + i * 0x93) +
                     (uint)bVar7;
      if ((*piLatest == -1) ||
         (unique0x00016c00 = *(uint *)((int)&rgshdef[0].turn + i * 0x93),
         *(uint *)((int)&rgshdef[0].turn + *piLatest * 0x93) < unique0x00016c00)) {
        *piLatest = i;
      }
      if (cRecyclePeriod <
          (uint)(game.turn - *(int *)((int)&rgshdef[0].turn + i * 0x93))) {
        if ((*(int *)((int)&rgshdef[0].cExist + i * 0x93) == 0) &&
           (*(int *)((int)&rgshdef[0].cExist + 2 + i * 0x93) == 0)) {
          pHVar5 = (HullDef *)(i * 0x93 + 0x3f00);
          pSVar6 = &shdef;
          for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
            pSVar2 = pSVar6;
            pSVar6 = (SHDEF *)(pSVar6->hul).rgTech;
            pHVar1 = pHVar5;
            pHVar5 = pHVar5 + 1;
            (pSVar2->hul).ihuldef = *pHVar1;
          }
          *(char *)&(pSVar6->hul).ihuldef = (char)*pHVar5;
          shdef.wFlags = shdef.wFlags & 0xfdffU | 0x200;
          FChangeAiShdef(&shdef,i);
        }
        else {
          rgbOld[i] = 1;
        }
      }
    }
  }
  if ((cExist._2_2_ != 0) || (32000 < (uint)cExist)) {
    cExist._0_2_ = 32000;
  }
  return (uint)cExist;
}



// ======================================================================
// Function: IncreaseAIMinefieldSizes
// Address: 1090:9c66
// Segment: MEMORY_AIU
// ======================================================================


void IncreaseAIMinefieldSizes(void)

{
  THING *pTVar1;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar2;
  ulong uVar3;
  THING *pTVar4;
  undefined2 uVar5;
  THING *lpthMac;
  long cMines;
  THING *lpth;
  
  pTVar1 = (THING *)lpThings + cThing;
  lpth = (THING *)CONCAT22(lpThings._2_2_,(THING *)lpThings);
  pTVar4 = (THING *)lpThings;
  uVar5 = lpThings._2_2_;
  while ((THING *)lpth < pTVar1) {
    uVar2 = (undefined2)((ulong)lpth >> 0x10);
    if ((uint)lpth->idFull >> 0xd == 0) {
      _sqrt(SUB84((double)*(long *)((THING *)lpth)->rgb,0),
                    (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)(double)*(long *)((
                                                  THING *)lpth)->rgb >> 0x20))));
      uVar3 = __ftol((double)CONCAT26(uVar5,CONCAT24(pTVar4,CONCAT22(unaff_SI,unaff_DI))));
      uVar3 = __aFulmul(uVar3,uVar3);
      *(int *)((THING *)lpth)->rgb = (int)uVar3;
      *(int *)(((THING *)lpth)->rgb + 2) = (int)(uVar3 >> 0x10);
    }
    lpth = (THING *)CONCAT22(uVar2,(THING *)lpth + 1);
  }
  return;
}



// ======================================================================
// Function: FFindBuddyAndJoinUp
// Address: 1090:9d18
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10909e69) */
/* WARNING: Removing unreachable block (ram,0x10909e04) */
/* WARNING: Removing unreachable block (ram,0x10909e8f) */

short FFindBuddyAndJoinUp(FLEET *lpfl,short ishLo,short ishHi,long lMaxDist1,long lMaxDist2)

{
  FLEET *pFVar1;
  int iVar2;
  POINT pt1;
  POINT pt2;
  long lVar3;
  short sVar4;
  long lVar5;
  ulong uVar6;
  ORDER ord;
  FLEET *lpflBest;
  FLEET *lpflOther;
  short ifl;
  short i;
  long lDist;
  long lDistBest;
  
  lpflBest = (FLEET *)0x0;
  lVar3 = 9999999;
  ifl = 0;
  while( true ) {
    if (cFleet <= ifl) break;
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[ifl];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    if (pFVar1->iPlayer == idPlayer) {
      if (lpfl == (FLEET *)CONCAT22(iVar2,pFVar1)) break;
      for (i = ishLo; i <= ishHi; i = i + 1) {
        if (pFVar1->rgcsh[i] != 0) {
          pt1.y = (((FLEET *)lpfl)->pt).y;
          pt1.x = (&((FLEET *)lpfl)->pt)->x;
          pt2.y = (pFVar1->pt).y;
          pt2.x = (&pFVar1->pt)->x;
          lVar5 = LDistance2(pt1,pt2);
          if (lVar5 < lVar3) {
            lpflBest = (FLEET *)CONCAT22(iVar2,pFVar1);
            lVar3 = lVar5;
          }
          break;
        }
      }
    }
    ifl = ifl + 1;
  }
  if ((((FLEET *)lpflBest == (FLEET *)0x0) && (lpflBest._2_2_ == 0)) ||
     ((uVar6 = __aFulmul(lMaxDist1,lMaxDist1), (long)uVar6 < lVar3 &&
      ((uVar6 = __aFulmul(lMaxDist2,lMaxDist2), (long)uVar6 < lVar3 ||
       (sVar4 = Random(2), sVar4 == 0)))))) {
    sVar4 = 0;
  }
  else {
    ClearAiCurrentTask(lpfl,1);
    ord.id = lpflBest->id;
    ord.pt.x = (&((FLEET *)lpflBest)->pt)->x;
    ord.pt.y = (((FLEET *)lpflBest)->pt).y;
    ord.wFlags = ord.wFlags & 0xe000U | 0x1260;
    FMoveAiFleet(lpfl,&ord,0);
    sVar4 = 1;
  }
  return sVar4;
}



// ======================================================================
// Function: FShouldPlanetBuildColonizer
// Address: 1090:9f30
// Segment: MEMORY_AIU
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x1090a026) */
/* WARNING: Removing unreachable block (ram,0x10909fe9) */
/* WARNING: Removing unreachable block (ram,0x1090a00e) */
/* WARNING: Removing unreachable block (ram,0x1090a052) */

short FShouldPlanetBuildColonizer(PLANET *lpplSrc)

{
  short sVar1;
  long lVar2;
  short sVar3;
  long lVar4;
  POINT pt1;
  POINT pt2;
  long lBest;
  byte *lpb;
  long lCur;
  short i;
  POINT pt;
  
  lVar2 = 10000000;
  sVar3 = ((POINT *)rgptPlan + lpplSrc->id)->x;
  sVar1 = *(short *)((int)&rgptPlan[0].y + lpplSrc->id * 4);
  if ((uint)game.turn < 0x3c) {
    sVar3 = 1;
  }
  else {
    lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,(byte *)vlpbAiPlanet + 0xd);
    for (i = 0; i < game.cPlanMax; i = i + 1) {
      if ((*lpb == 0) &&
         (pt2.y = *(short *)((int)&rgptPlan[0].y + i * 4),
         pt2.x = ((POINT *)rgptPlan + i)->x, pt1.y = sVar1, pt1.x = sVar3,
         lVar4 = LDistance2(pt1,pt2), lVar4 < lVar2)) {
        lVar2 = lVar4;
      }
      lpb = (byte *)CONCAT22(lpb._2_2_,(byte *)lpb + 0x10);
    }
    if (((lVar2 < 0x1de85) && ((lVar2 < 0x15f91 || (sVar3 = Random(2), sVar3 == 0)))) &&
       ((lVar2 < 0xf425 || (sVar3 = Random(2), sVar3 == 0)))) {
      sVar3 = 1;
    }
    else {
      sVar3 = 0;
    }
  }
  return sVar3;
}



// ======================================================================
// Function: InitRandomPlanetList
// Address: 1090:a082
// Segment: MEMORY_AIU
// ======================================================================


void InitRandomPlanetList(void)

{
  undefined2 uVar1;
  undefined2 uVar2;
  undefined2 uVar3;
  short sVar4;
  PLANET *pPVar5;
  PLANET **ppPVar6;
  undefined2 uVar7;
  short i;
  PLANET *lppl;
  short iT;
  PLANET *lpplMac;
  
  vclpplAi = 0;
  pPVar5 = (PLANET *)lpPlanets + cPlanet;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while (uVar1 = vrglpplAi._2_2_, (PLANET *)lppl < pPVar5) {
    uVar7 = (undefined2)((ulong)lppl >> 0x10);
    if (((PLANET *)lppl)->iPlayer == idPlayer) {
      ppPVar6 = (PLANET **)vrglpplAi + vclpplAi;
      vclpplAi = vclpplAi + 1;
      *(PLANET **)ppPVar6 = (PLANET *)lppl;
      *(undefined2 *)((int)ppPVar6 + 2) = uVar7;
    }
    lppl = (PLANET *)CONCAT22(uVar7,(PLANET *)lppl + 1);
  }
  if (((uint)gd._0_2_ >> 0xb & 1) == 0) {
    for (i = 0; i < vclpplAi + -1; i = i + 1) {
      sVar4 = Random(vclpplAi - i);
      uVar3 = vrglpplAi._2_2_;
      uVar1 = *(undefined2 *)((PLANET **)vrglpplAi + i);
      uVar7 = *(undefined2 *)((int)((PLANET **)vrglpplAi + i) + 2);
      uVar2 = *(undefined2 *)((int)((PLANET **)vrglpplAi + sVar4 + i) + 2);
      ppPVar6 = (PLANET **)vrglpplAi + i;
      *(undefined2 *)ppPVar6 = *(undefined2 *)((PLANET **)vrglpplAi + sVar4 + i);
      *(undefined2 *)((int)ppPVar6 + 2) = uVar2;
      uVar2 = vrglpplAi._2_2_;
      ppPVar6 = (PLANET **)vrglpplAi + sVar4 + i;
      *(undefined2 *)ppPVar6 = uVar1;
      *(undefined2 *)((int)ppPVar6 + 2) = uVar7;
    }
  }
  return;
}



