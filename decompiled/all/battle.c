// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: RelationsDlg
// Address: 10f0:0088
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short RelationsDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char *pcVar1;
  HWND HVar2;
  undefined2 unaff_SS;
  LRESULT LVar3;
  WPARAM WVar4;
  UINT UVar5;
  RECT rcGBox;
  PAINTSTRUCT ps;
  HDC hdc;
  undefined8 rc;
  short i;
  
  if (message == WM_DESTROY) {
    if (fDirtyPlan != 0) {
      hdc = grbitScan & 0xf;
      LogChangeRelations();
      InvalidateRect(hwndScanner,(RECT *)0x0,1);
    }
  }
  else {
    if (message == WM_PAINT) {
      hdc = BeginPaint(hwnd,&ps);
      HVar2 = GetDlgItem(hwnd,0x7d5);
      GetWindowRect(HVar2,&rcGBox);
      ScreenToClient(hwnd,(POINT *)&rcGBox);
      HVar2 = GetDlgItem(hwnd,0x7d6);
      GetWindowRect(HVar2,&rc);
      ScreenToClient(hwnd,(POINT *)((int)&rc + 4));
      rcGBox.right = rc._4_2_;
      rcGBox.bottom = rc._6_2_;
      ExpandRc(&rcGBox,dyArial8,dyArial8 >> 1);
      _Draw3dFrame();
      SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SelectObject(hdc,rghfontArial8[1]);
      i = CchGetString(idsRelation,(char *)szWork);
      TextOut(hdc,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,i);
      SelectObject(hdc,rghfontArial8[0]);
      EndPaint(hwnd,&ps);
      return 1;
    }
    if (message == WM_ERASEBKGND) {
LAB_10f0_0177:
      GetClientRect(hwnd,&rc);
      FillRect(wParam,&rc,hbrButtonFace);
      return 1;
    }
    if (message == WM_CTLCOLOR) {
      hdc = (HDC)lParam;
      HVar2 = GetDlgItem(hwnd,0x7d3);
      if (hdc != HVar2) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        StickyDlgPos(hwnd,(POINT *)&ptStickyRelationsDlg,1);
        hdc = idPlayer * 0xc0 + 0x5a12;
        CheckRadioButton(hwnd,0x7d4,0x7d6,*(char *)(hdc + (idPlayer == 0)) + 0x7d4);
        for (i = 0; i < game.cPlayer; i = i + 1) {
          if (i != idPlayer) {
            HVar2 = GetDlgItem(hwnd,0x7d3);
            UVar5 = 0x401;
            WVar4 = 0;
            pcVar1 = PszPlayerName(i,0,0,0,0,(PLAYER *)0x0);
            SendMessage(HVar2,UVar5,WVar4,(LPARAM)pcVar1);
          }
        }
        HVar2 = GetDlgItem(hwnd,0x7d3);
        SendMessage(HVar2,0x407,0,0);
        fDirtyPlan = 0;
        goto LAB_10f0_0177;
      }
      if (message == WM_COMMAND) {
        if (wParam == 2) {
          StickyDlgPos(hwnd,(POINT *)&ptStickyRelationsDlg,0);
          HVar2 = GetDlgItem(hwnd,0x7d3);
          LVar3 = SendMessage(HVar2,0x409,0,0);
          i = (short)LVar3;
          if (idPlayer <= i) {
            i = i + 1;
          }
          EndDialog(hwnd,i + 3);
          return 1;
        }
        if ((wParam < 0x7d4) || (0x7d6 < wParam)) {
          if (wParam == 0x7d3) {
            HVar2 = GetDlgItem(hwnd,0x7d3);
            LVar3 = SendMessage(HVar2,0x409,0,0);
            i = (short)LVar3;
            if (idPlayer <= i) {
              i = i + 1;
            }
            CheckRadioButton(hwnd,0x7d4,0x7d6,*(char *)(idPlayer * 0xc0 + 0x5a12 + i) + 0x7d4
                            );
          }
          else if (wParam == 0x76) {
            WinHelp(hwnd,_szHelpFile,1,0x43b);
            return 1;
          }
        }
        else {
          HVar2 = GetDlgItem(hwnd,0x7d3);
          LVar3 = SendMessage(HVar2,0x409,0,0);
          i = (short)LVar3;
          if (idPlayer <= i) {
            i = i + 1;
          }
          *(char *)(idPlayer * 0xc0 + 0x5a12 + i) = (char)wParam + ',';
          fDirtyPlan = 1;
        }
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: NewPlanNameDlg
// Address: 10f0:04ce
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short NewPlanNameDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar1;
  ushort in_stack_0000fff4;
  
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&stack0xfff4);
    FillRect(wParam,&stack0xfff4,hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    uVar1 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000fff4);
    if ((int)uVar1 == 6) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return hbrButtonFace;
    }
  }
  else {
    if (message == WM_INITDIALOG) {
      SetWindowPos(hwnd,0,ptStickyBattlePlansDlg.x + 0x46,
                   ptStickyBattlePlansDlg.y + 0x46,0,0,0x15);
      SendDlgItemMessage(hwnd,0x10c,0x415,0x1f,0);
      SetDlgItemText(hwnd,0x10c,btlplan.szName);
      return 1;
    }
    if (message == WM_COMMAND) {
      if ((wParam == 1) || (wParam == 2)) {
        if (wParam == 1) {
          GetDlgItemText(hwnd,0x10c,btlplan.szName,0x20);
          fDirtyPlan = 1;
        }
        EndDialog(hwnd,(uint)(wParam == 1));
        return 1;
      }
      if (wParam == 0x76) {
        WinHelp(hwnd,_szHelpFile,1,0x439);
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: BattlePlansDlg
// Address: 10f0:0652
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short BattlePlansDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char *pcVar1;
  BTLPLAN *pBVar2;
  BTLPLAN *pBVar3;
  undefined2 uVar4;
  char *pcVar5;
  HWND HVar6;
  short sVar7;
  ushort uVar8;
  int iVar9;
  undefined2 unaff_SI;
  BTLPLAN *pBVar10;
  undefined2 unaff_DI;
  BTLPLAN *pBVar11;
  undefined2 unaff_SS;
  ulong uVar12;
  LRESULT LVar13;
  WPARAM WVar14;
  UINT UVar15;
  ushort in_stack_0000ffe6;
  short cLen;
  RECT rc;
  short fRet;
  short i;
  short idc;
  FARPROC lpProc;
  
  uVar12 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,&rc);
    FillRect(wParam,&rc,hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    for (idc = 0x41d; idc < 0x423; idc = idc + 1) {
      HVar6 = GetDlgItem(hwnd,idc);
      if ((HWND)lParam == HVar6) break;
    }
    if ((idc < 0x41d) && (uVar12 = __aFulshr(uVar12,in_stack_0000ffe6), (int)uVar12 != 6)) {
      return 0;
    }
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    return hbrButtonFace;
  }
  if (message == WM_INITDIALOG) {
    StickyDlgPos(hwnd,(POINT *)&ptStickyBattlePlansDlg,1);
    iPlanSelDlg = 0;
    if (sel.grobj == grobjFleet) {
      iPlanSelDlg = (short)sel.fl.iplan;
    }
    uVar4 = *(undefined2 *)(idPlayer * 4 + 0x593a);
    pBVar10 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
    pBVar11 = (BTLPLAN *)&btlplan;
    for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
      pBVar3 = pBVar11;
      pBVar11 = &pBVar11->wFlags_0x2;
      pBVar2 = pBVar10;
      pBVar10 = &pBVar10->wFlags_0x2;
      pBVar3->wFlags = pBVar2->wFlags;
    }
    for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x403,0,
                  (LPARAM)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x593a),
                                   ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                   szName));
    }
    HVar6 = GetDlgItem(hwnd,0x41e);
    SendMessage(HVar6,0x40e,iPlanSelDlg,0);
    HVar6 = GetDlgItem(hwnd,0x41b);
    EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
    HVar6 = GetDlgItem(hwnd,0x817);
    EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
    for (i = 0x198; i < 0x19e; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x421);
      UVar15 = 0x403;
      WVar14 = 0;
      pcVar5 = PszGetCompressedString(i);
      SendMessage(HVar6,UVar15,WVar14,(LPARAM)pcVar5);
    }
    HVar6 = GetDlgItem(hwnd,0x421);
    SendMessage(HVar6,0x40e,btlplan.wFlags >> 8 & 0xf,0);
    for (i = 400; i < 0x198; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x41f);
      UVar15 = 0x403;
      WVar14 = 0;
      pcVar5 = PszGetCompressedString(i);
      SendMessage(HVar6,UVar15,WVar14,(LPARAM)pcVar5);
    }
    HVar6 = GetDlgItem(hwnd,0x41f);
    SendMessage(HVar6,0x40e,btlplan.wFlags_0x2 & 0xf,0);
    if ((game.wCrap >> 2 & 1) == 0) {
      for (i = 0x78; i < 0x7c; i = i + 1) {
        HVar6 = GetDlgItem(hwnd,0x422);
        UVar15 = 0x403;
        WVar14 = 0;
        pcVar5 = PszGetCompressedString(i);
        SendMessage(HVar6,UVar15,WVar14,(LPARAM)pcVar5);
      }
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if (i != idPlayer) {
          HVar6 = GetDlgItem(hwnd,0x422);
          UVar15 = 0x403;
          WVar14 = 0;
          pcVar5 = PszPlayerName(i,0,1,0,0,(PLAYER *)0x0);
          SendMessage(HVar6,UVar15,WVar14,(LPARAM)pcVar5);
        }
      }
      i = btlplan.wFlags_0x2 >> 8 & 0x1f;
      if (idPlayer + 4 <= i) {
        i = i - 1;
      }
      HVar6 = GetDlgItem(hwnd,0x422);
      SendMessage(HVar6,0x40e,i,0);
    }
    else {
      HVar6 = GetDlgItem(hwnd,0x422);
      UVar15 = 0x403;
      WVar14 = 0;
      pcVar5 = PszGetCompressedString(idsEveryone);
      SendMessage(HVar6,UVar15,WVar14,(LPARAM)pcVar5);
      HVar6 = GetDlgItem(hwnd,0x422);
      SendMessage(HVar6,0x40e,0,0);
      HVar6 = GetDlgItem(hwnd,0x422);
      EnableWindow(HVar6,0);
    }
    for (i = 400; i < 0x198; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x420);
      UVar15 = 0x403;
      WVar14 = 0;
      pcVar5 = PszGetCompressedString(i);
      SendMessage(HVar6,UVar15,WVar14,(LPARAM)pcVar5);
    }
    HVar6 = GetDlgItem(hwnd,0x420);
    SendMessage(HVar6,0x40e,btlplan.wFlags_0x2 >> 4 & 0xf,0);
    HVar6 = GetDlgItem(hwnd,0x41d);
    SendMessage(HVar6,0x401,btlplan.wFlags >> 0xf,0);
    fDirtyPlan = 0;
    if (((uint)gd.grBits >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    return 1;
  }
  if (message != WM_COMMAND) {
    return 0;
  }
  if ((wParam == 1) || (wParam == 2)) {
    if (fDirtyPlan != 0) {
      uVar4 = *(undefined2 *)(idPlayer * 4 + 0x593a);
      pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar10 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar11;
        pBVar11 = &pBVar11->wFlags_0x2;
        pBVar2 = pBVar10;
        pBVar10 = &pBVar10->wFlags_0x2;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      LogChangeBtlplan((BTLPLAN *)&btlplan);
    }
    StickyDlgPos(hwnd,(POINT *)&ptStickyBattlePlansDlg,0);
    EndDialog(hwnd,iPlanSelDlg);
    if (sel.grobj == grobjFleet) {
      FillBattleDD(sel.fl.iplan + 1);
    }
    iPlanSelDlg = -1;
    return 1;
  }
  if (wParam == 0x41d) {
    LVar13 = SendDlgItemMessage(hwnd,0x41d,0x400,0,0);
    fDirtyPlan = 1;
    btlplan.wFlags = btlplan.wFlags & 0x7fff | (int)LVar13 << 0xf;
    return 0;
  }
  if (wParam == 0x817) {
    if (fDirtyPlan != 0) {
      uVar4 = *(undefined2 *)(idPlayer * 4 + 0x593a);
      pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar10 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar11;
        pBVar11 = &pBVar11->wFlags_0x2;
        pBVar2 = pBVar10;
        pBVar10 = &pBVar10->wFlags_0x2;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      LogChangeBtlplan((BTLPLAN *)&btlplan);
      fDirtyPlan = 0;
    }
    btlplan.wFlags = btlplan.wFlags & 0xbfff | 0x4000;
    uVar4 = *(undefined2 *)(idPlayer * 4 + 0x593a);
    pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
    pBVar10 = (BTLPLAN *)&btlplan;
    for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
      pBVar3 = pBVar11;
      pBVar11 = &pBVar11->wFlags_0x2;
      pBVar2 = pBVar10;
      pBVar10 = &pBVar10->wFlags_0x2;
      pBVar3->wFlags = pBVar2->wFlags;
    }
    btlplan.wFlags = btlplan.wFlags & 0xff0f | (iPlanSelDlg & 0xfU) << 4;
    sVar7 = FDeleteBattlePlan(iPlanSelDlg,1);
    if (sVar7 == 0) {
      btlplan.wFlags = btlplan.wFlags & 0xbfff;
      uVar4 = *(undefined2 *)(idPlayer * 4 + 0x593a);
      pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar10 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar11;
        pBVar11 = &pBVar11->wFlags_0x2;
        pBVar2 = pBVar10;
        pBVar10 = &pBVar10->wFlags_0x2;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      return 0;
    }
    LogChangeBtlplan((BTLPLAN *)&btlplan);
    HVar6 = GetDlgItem(hwnd,0x41e);
    SendMessage(HVar6,0x40e,iPlanSelDlg - 1,0);
    HVar6 = GetDlgItem(hwnd,0x41e);
    SendMessage(HVar6,0x40b,0,0);
    for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x403,0,
                  (LPARAM)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x593a),
                                   ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                   szName));
    }
    HVar6 = GetDlgItem(hwnd,0x41e);
    SendMessage(HVar6,0x40e,iPlanSelDlg - 1,0);
BATTLE_LSelectName:
    HVar6 = GetDlgItem(hwnd,0x41e);
    LVar13 = SendMessage(HVar6,0x407,0,0);
    i = (short)LVar13;
    if (i != iPlanSelDlg) {
      if (fDirtyPlan != 0) {
        uVar4 = *(undefined2 *)(idPlayer * 4 + 0x593a);
        pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
        pBVar10 = (BTLPLAN *)&btlplan;
        for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
          pBVar3 = pBVar11;
          pBVar11 = &pBVar11->wFlags_0x2;
          pBVar2 = pBVar10;
          pBVar10 = &pBVar10->wFlags_0x2;
          pBVar3->wFlags = pBVar2->wFlags;
        }
        LogChangeBtlplan((BTLPLAN *)&btlplan);
        fDirtyPlan = 0;
      }
      iPlanSelDlg = i;
      uVar4 = *(undefined2 *)(idPlayer * 4 + 0x593a);
      pBVar10 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i;
      pBVar11 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar11;
        pBVar11 = &pBVar11->wFlags_0x2;
        pBVar2 = pBVar10;
        pBVar10 = &pBVar10->wFlags_0x2;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      HVar6 = GetDlgItem(hwnd,0x41f);
      SendMessage(HVar6,0x40e,btlplan.wFlags_0x2 & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x420);
      SendMessage(HVar6,0x40e,btlplan.wFlags_0x2 >> 4 & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x41d);
      SendMessage(HVar6,0x401,btlplan.wFlags >> 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x41b);
      EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
      HVar6 = GetDlgItem(hwnd,0x817);
      EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
      HVar6 = GetDlgItem(hwnd,0x421);
      SendMessage(HVar6,0x40e,btlplan.wFlags >> 8 & 0xf,0);
      i = btlplan.wFlags_0x2 >> 8 & 0x1f;
      if (idPlayer + 4 <= i) {
        i = i - 1;
      }
      HVar6 = GetDlgItem(hwnd,0x422);
      SendMessage(HVar6,0x40e,i,0);
    }
  }
  else {
    if (wParam == 0x41f) {
      HVar6 = GetDlgItem(hwnd,0x41f);
      LVar13 = SendMessage(HVar6,0x407,0,0);
      fDirtyPlan = 1;
      btlplan.wFlags_0x2 = btlplan.wFlags_0x2 & 0xfff0 | (uint)LVar13 & 0xf;
      return 0;
    }
    if (wParam == 0x420) {
      HVar6 = GetDlgItem(hwnd,0x420);
      LVar13 = SendMessage(HVar6,0x407,0,0);
      fDirtyPlan = 1;
      btlplan.wFlags_0x2 =
           btlplan.wFlags_0x2 & 0xff0f | ((uint)LVar13 & 0xf) << 4;
      return 0;
    }
    if (wParam == 0x422) {
      HVar6 = GetDlgItem(hwnd,0x422);
      LVar13 = SendMessage(HVar6,0x407,0,0);
      i = (short)LVar13;
      if ((game.wCrap >> 2 & 1) == 0) {
        if (idPlayer + 4 <= i) {
          i = i + 1;
        }
      }
      else {
        i = 3;
      }
      fDirtyPlan = 1;
      btlplan.wFlags_0x2 = btlplan.wFlags_0x2 & 0xe0ff | (i & 0x1fU) << 8;
      return 0;
    }
    if (wParam == 0x421) {
      HVar6 = GetDlgItem(hwnd,0x421);
      LVar13 = SendMessage(HVar6,0x407,0,0);
      fDirtyPlan = 1;
      btlplan.wFlags = btlplan.wFlags & 0xf0ff | ((uint)LVar13 & 0xf) << 8;
      return 0;
    }
    if (wParam != 0x41b) {
      if (wParam != 0x41c) {
        if (wParam != 0x41e) {
          if (wParam != 0x76) {
            return 0;
          }
          WinHelp(hwnd,_szHelpFile,1,0x439);
          return 1;
        }
        goto BATTLE_LSelectName;
      }
      if (((byte *)rgcbtlplan)[idPlayer] == 0xf) {
        return 0;
      }
      if (fDirtyPlan != 0) {
        uVar4 = *(undefined2 *)(idPlayer * 4 + 0x593a);
        pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
        pBVar10 = (BTLPLAN *)&btlplan;
        for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
          pBVar3 = pBVar11;
          pBVar11 = &pBVar11->wFlags_0x2;
          pBVar2 = pBVar10;
          pBVar10 = &pBVar10->wFlags_0x2;
          pBVar3->wFlags = pBVar2->wFlags;
        }
        LogChangeBtlplan((BTLPLAN *)&btlplan);
        fDirtyPlan = 0;
      }
      iPlanSelDlg = (short)((byte *)rgcbtlplan)[idPlayer];
      ((byte *)rgcbtlplan)[idPlayer] =
           ((byte *)rgcbtlplan)[idPlayer] + 1;
      uVar8 = _strlen((char *)btlplan.szName);
      if ((int)uVar8 < 0x1c) {
        if (((*(char *)((int)&btlplan.wFlags_0x2 + 1 + uVar8) == ')') &&
            ((*(byte *)(*(byte *)((int)&btlplan.wFlags_0x2 + uVar8) + 0x175f) & 4) != 0))
           && (*(char *)((int)&btlplan.wFlags + 1 + uVar8) == '(')) {
          if (*(char *)((int)&btlplan.wFlags_0x2 + uVar8) == '9') {
            *(undefined1 *)((int)&btlplan.wFlags_0x2 + uVar8) = 0x30;
          }
          else {
            pcVar1 = (char *)((int)&btlplan.wFlags_0x2 + uVar8);
            *pcVar1 = *pcVar1 + '\x01';
          }
        }
        else {
          _strcpy((char *)((int)btlplan.szName + uVar8),(char *)0xd9c);
        }
      }
      btlplan.wFlags =
           btlplan.wFlags & 0xff0f | (iPlanSelDlg & 0xfU) << 4;
      uVar4 = *(undefined2 *)(idPlayer * 4 + 0x593a);
      pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar10 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar11;
        pBVar11 = &pBVar11->wFlags_0x2;
        pBVar2 = pBVar10;
        pBVar10 = &pBVar10->wFlags_0x2;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      HVar6 = GetDlgItem(hwnd,0x421);
      SendMessage(HVar6,0x40e,btlplan.wFlags >> 8 & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x40b,0,0);
      for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
        HVar6 = GetDlgItem(hwnd,0x41e);
        SendMessage(HVar6,0x403,0,
                    (LPARAM)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x593a),
                                     ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                     szName));
      }
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x40e,iPlanSelDlg,0);
      HVar6 = GetDlgItem(hwnd,0x41f);
      SendMessage(HVar6,0x40e,btlplan.wFlags_0x2 & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x420);
      SendMessage(HVar6,0x40e,btlplan.wFlags_0x2 >> 4 & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x41d);
      SendMessage(HVar6,0x401,btlplan.wFlags >> 0xf,0);
      i = btlplan.wFlags_0x2 >> 8 & 0x1f;
      if (idPlayer + 4 <= i) {
        i = i - 1;
      }
      HVar6 = GetDlgItem(hwnd,0x422);
      SendMessage(HVar6,0x40e,i,0);
      fDirtyPlan = 1;
      HVar6 = GetDlgItem(hwnd,0x41b);
      EnableWindow(HVar6,1);
    }
    StickyDlgPos(hwnd,(POINT *)&ptStickyBattlePlansDlg,0);
    lpProc = MakeProcInstance(NewPlanNameDlg,hInst);
    fRet = DialogBox(0,(LPCSTR)CONCAT22(0x7e3,hwndFrame),(HWND)((ulong)lpProc >> 0x10),
                     (char)lpProc);
    FreeProcInstance(lpProc);
    SetFocus(hwnd);
    if (fRet != 0) {
      uVar4 = *(undefined2 *)(idPlayer * 4 + 0x593a);
      pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar10 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar11;
        pBVar11 = &pBVar11->wFlags_0x2;
        pBVar2 = pBVar10;
        pBVar10 = &pBVar10->wFlags_0x2;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x40b,0,0);
      for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
        HVar6 = GetDlgItem(hwnd,0x41e);
        SendMessage(HVar6,0x403,0,
                    (LPARAM)CONCAT22(*(undefined2 *)(idPlayer * 4 + 0x593a),
                                     ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                     szName));
      }
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x40e,iPlanSelDlg,0);
    }
    HVar6 = GetDlgItem(hwnd,0x41b);
    EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
    HVar6 = GetDlgItem(hwnd,0x817);
    EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
  }
  return 0;
}



// ======================================================================
// Function: FDeleteBattlePlan
// Address: 10f0:1706
// Segment: MEMORY_BATTLE
// ======================================================================


short FDeleteBattlePlan(short iplan,short fWarn)

{
  BTLPLAN *pBVar1;
  BTLPLAN *pBVar2;
  int iVar3;
  undefined2 uVar4;
  undefined2 uVar5;
  bool bVar6;
  char *sz;
  int iVar7;
  BTLPLAN *pBVar8;
  BTLPLAN *pBVar9;
  short sVar10;
  FLEET *lpfl;
  short i;
  short iflMac;
  short fFoundBigger;
  
  bVar6 = false;
BATTLE_LCommit:
  do {
    for (iflMac = 0; iflMac < cFleet; iflMac = iflMac + 1) {
      iVar7 = *(int *)((FLEET **)rglpfl + iflMac);
      iVar3 = *(int *)((int)((FLEET **)rglpfl + iflMac) + 2);
      if ((iVar7 == 0) && (iVar3 == 0)) break;
      if (idPlayer <= *(int *)(iVar7 + 2)) {
        if (idPlayer < *(int *)(iVar7 + 2)) break;
        if ((uint)iplan <= (uint)*(byte *)(iVar7 + 0x60)) {
          if ((uint)iplan < (uint)*(byte *)(iVar7 + 0x60)) {
            if (fWarn == 0) {
              *(char *)(iVar7 + 0x60) = *(char *)(iVar7 + 0x60) + -1;
            }
            else {
              bVar6 = true;
            }
          }
          else {
            if (fWarn != 0) {
              sVar10 = 0x31;
              sz = PszFormatIds(idsCurrentlyHaveFleetsUsingBattlePlanIf,(short *)0x0);
              sVar10 = AlertSz(sz,sVar10);
              if (sVar10 == 2) {
                return 0;
              }
              fWarn = 0;
              goto BATTLE_LCommit;
            }
            *(char *)(iVar7 + 0x60) = *(char *)(iVar7 + 0x60) + -1;
          }
        }
      }
    }
    if ((fWarn == 0) || (!bVar6)) {
      ((byte *)rgcbtlplan)[idPlayer] =
           ((byte *)rgcbtlplan)[idPlayer] - 1;
      for (i = iplan; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
        uVar4 = *(undefined2 *)(idPlayer * 4 + 0x593a);
        pBVar8 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i + 1;
        uVar5 = *(undefined2 *)(idPlayer * 4 + 0x593a);
        pBVar9 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i;
        for (iVar7 = 0x12; iVar7 != 0; iVar7 = iVar7 + -1) {
          pBVar2 = pBVar9;
          pBVar9 = &pBVar9->wFlags_0x2;
          pBVar1 = pBVar8;
          pBVar8 = &pBVar8->wFlags_0x2;
          pBVar2->wFlags = pBVar1->wFlags;
        }
        (((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i)->wFlags =
             (((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i)->wFlags & 0xff0f |
             (i & 0xfU) << 4;
      }
      return 1;
    }
    fWarn = 0;
  } while( true );
}



// ======================================================================
// Function: SpankTheCheaters
// Address: 10f0:192a
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f01bdb) */
/* WARNING: Removing unreachable block (ram,0x10f01be0) */
/* WARNING: Removing unreachable block (ram,0x10f01d75) */
/* WARNING: Removing unreachable block (ram,0x10f01c5e) */
/* WARNING: Removing unreachable block (ram,0x10f01d8c) */

void SpankTheCheaters(void)

{
  uint *puVar1;
  int iVar2;
  uint uVar3;
  short sVar4;
  PLANET *pPVar5;
  PLANET *pPVar6;
  FLEET *pFVar7;
  PLANET *pPVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar9;
  ulong uVar10;
  long lVar11;
  ulong uVar12;
  long lVar13;
  ulong uVar14;
  byte rgfCheater [16];
  short fSellOff;
  short fCheater;
  int pctSell;
  int local_16;
  short i;
  short ifl;
  FLEET *lpfl;
  PLANET *lppl;
  undefined4 lSell;
  
  uVar14 = CONCAT22(unaff_SI,unaff_DI);
  fCheater = 0;
  for (i = 0; i < game.cPlayer; i = i + 1) {
    uVar3 = *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 2;
    rgfCheater[i] = (byte)uVar3 & 1;
    if ((uVar3 & 1) != 0) {
      fCheater = 1;
    }
  }
  if ((fCheater != 0) && (9 < game.turn)) {
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar7 = ((FLEET **)rglpfl)[ifl];
      iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      lpfl = (FLEET *)CONCAT22(iVar2,pFVar7);
      if ((pFVar7 == (FLEET *)0x0) && (iVar2 == 0)) break;
      if (((pFVar7->wFlags_0x4 >> 10 & 1) == 0) && (rgfCheater[pFVar7->iPlayer] != 0)) {
        sVar4 = Random(0xc);
        if (sVar4 == 0) {
          uVar9 = (undefined2)((ulong)lpfl >> 0x10);
          pFVar7 = (FLEET *)lpfl;
          pFVar7->wFlags_0x4 = pFVar7->wFlags_0x4 & 0xfbff | 0x400;
          FSendPlrMsg2(pFVar7->iPlayer,idmHasDefectedRanksDueInabilityProjectLegitimate,-5,
                            lpfl->id,0);
        }
        else {
          fSellOff = 0;
          i = 0;
          lVar11 = lSell;
          while( true ) {
            lSell = lVar11;
            if (2 < i) break;
            iVar2 = *(int *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
            if ((-1 < iVar2) && ((0 < iVar2 || ((int)((FLEET *)lpfl)->rgwtMin[i] != 0)))) {
              if (fSellOff == 0) {
                sVar4 = Random(0xb);
                pctSell = sVar4 + 10;
                local_16 = pctSell >> 0xf;
                fSellOff = 1;
                lVar11 = lSell;
              }
              lVar13 = 100;
              lSell = lVar11;
              uVar10 = __aFulmul(CONCAT22(*(undefined2 *)
                                                   ((int)(((FLEET *)lpfl)->rgwtMin + i) + 2),
                                                  (int)((FLEET *)lpfl)->rgwtMin[i]),
                                         CONCAT22(local_16,pctSell));
              lVar11 = __aFldiv(uVar10,lVar13);
              lSell = lVar11;
              if (lVar11 == 0) {
                lSell._0_2_ = 1;
                lSell._2_2_ = 0;
                lVar11 = 1;
              }
              lSell._2_2_ = (int)((ulong)lVar11 >> 0x10);
              lSell._0_2_ = (uint)lVar11;
              puVar1 = (uint *)(((FLEET *)lpfl)->rgwtMin + i);
              uVar3 = *puVar1;
              *puVar1 = *puVar1 - (uint)lSell;
              puVar1 = (uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
              *puVar1 = (*puVar1 - lSell._2_2_) - (uint)(uVar3 < (uint)lSell);
            }
            i = i + 1;
          }
          if (fSellOff != 0) {
            FSendPlrMsg2(((FLEET *)lpfl)->iPlayer,idmCrewHasSoldOffCargoBlackMarket,-5,lpfl->id
                              ,pctSell);
          }
        }
      }
    }
    pPVar5 = (PLANET *)lpPlanets + cPlanet;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    pPVar6 = (PLANET *)lpPlanets;
    while ((PLANET *)lppl < pPVar5) {
      uVar9 = (undefined2)((ulong)lppl >> 0x10);
      if ((((PLANET *)lppl)->iPlayer != -1) && (rgfCheater[((PLANET *)lppl)->iPlayer] != 0)) {
        uVar10 = __aFulshr(uVar14,(ushort)pPVar6);
        if ((uVar10 & 0xfff) != 0) {
          sVar4 = Random(8);
          if (sVar4 == 0) {
            sVar4 = Random(0x1f);
            pctSell = sVar4 + 5;
            local_16 = pctSell >> 0xf;
            lVar11 = 100;
            uVar12 = (ulong)pctSell;
            uVar10 = __aFulshr(uVar12,100);
            uVar10 = __aFulmul(uVar10 & 0xfff,uVar12);
            lVar11 = __aFldiv(uVar10,lVar11);
            if (lVar11 < 1) {
              lVar11 = 1;
            }
            lSell._0_2_ = (uint)lVar11;
            uVar9 = (undefined2)((ulong)lppl >> 0x10);
            pPVar8 = (PLANET *)lppl;
            uVar3 = *(uint *)pPVar8->rgbImp;
            iVar2 = *(int *)(pPVar8->rgbImp + 2);
            pPVar6 = (PLANET *)(uVar3 + (uint)lSell * -0x100 & 0xff00);
            *(uint *)pPVar8->rgbImp = *(uint *)pPVar8->rgbImp & 0xff;
            *(uint *)(pPVar8->rgbImp + 2) = *(uint *)(pPVar8->rgbImp + 2) & 0xfff0;
            *(uint *)pPVar8->rgbImp = *(uint *)pPVar8->rgbImp | (uint)pPVar6;
            *(uint *)(pPVar8->rgbImp + 2) =
                 *(uint *)(pPVar8->rgbImp + 2) | iVar2 - (uint)(uVar3 < (uint)lSell * 0x100) & 0xf;
            FSendPlrMsg2(pPVar8->iPlayer,idmFreedomFightersHaveAttackedDestroyedMinesPress,-5,
                              lppl->id,(uint)lSell);
            lSell = lVar11;
            goto LAB_10f0_1dfe;
          }
        }
        sVar4 = Random(0xf);
        if (sVar4 == 0) {
          i = Random(3);
          sVar4 = Random(0x29);
          pctSell = sVar4 + 5;
          local_16 = pctSell >> 0xf;
          lVar11 = 100;
          uVar10 = __aFulmul(CONCAT22(*(undefined2 *)
                                               ((int)(((PLANET *)lppl)->rgwtMin + i) + 2),
                                              (int)((PLANET *)lppl)->rgwtMin[i]),(long)pctSell);
          lVar11 = __aFldiv(uVar10,lVar11);
          lSell = lVar11;
          if (0 < lVar11) {
            if (30000 < lVar11) {
              lVar11 = 30000;
            }
            lSell._2_2_ = (int)((ulong)lVar11 >> 0x10);
            lSell._0_2_ = (uint)lVar11;
            puVar1 = (uint *)(((PLANET *)lppl)->rgwtMin + i);
            uVar3 = *puVar1;
            *puVar1 = *puVar1 - (uint)lSell;
            puVar1 = (uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
            *puVar1 = (*puVar1 - lSell._2_2_) - (uint)(uVar3 < (uint)lSell);
            FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmFreedomFightersHaveStolenKtStockpilesPress
                             ,-5,lppl->id,(uint)lSell,i + 1,0,0,0,0);
            lSell = lVar11;
          }
        }
      }
LAB_10f0_1dfe:
      lppl = (PLANET *)lppl + 1;
    }
  }
  return;
}



// ======================================================================
// Function: FFleetHasBombs
// Address: 10f0:1e16
// Segment: MEMORY_BATTLE
// ======================================================================


short FFleetHasBombs(FLEET *lpfl)

{
  undefined2 uVar1;
  short sVar2;
  HUL *pHVar3;
  int iVar4;
  short ishdef;
  short imd;
  HUL *lphul;
  
  ishdef = 0;
  do {
    if (0xf < ishdef) {
      return 0;
    }
    if (((FLEET *)lpfl)->rgcsh[ishdef] != 0) {
      iVar4 = ((uint)lpfl->id >> 9 & 0xf) * 4;
      uVar1 = *(undefined2 *)(iVar4 + 0x100);
      pHVar3 = (HUL *)(*(int *)(iVar4 + rglpshdef) + ishdef * 0x93);
      lphul = (HUL *)CONCAT22(uVar1,pHVar3);
      LphuldefFromId(lphul->ihuldef);
      sVar2 = FHullHasBombs((HUL *)CONCAT22(uVar1,pHVar3));
      if (sVar2 != 0) {
        return 1;
      }
    }
    ishdef = ishdef + 1;
  } while( true );
}



// ======================================================================
// Function: FHullHasBombs
// Address: 10f0:1ec2
// Segment: MEMORY_BATTLE
// ======================================================================


short FHullHasBombs(HUL *lphul)

{
  short ihs;
  HS *lphs;
  
  lphs = (HS *)CONCAT22(lphul._2_2_,((HUL *)lphul)->rghs);
  ihs = 0;
  while( true ) {
    if ((int)(uint)((HUL *)lphul)->chs <= ihs) {
      return 0;
    }
    if ((lphs->grhst == hstBomb) && (((HS *)lphs)->wFlags_0x2 >> 8 != 0)) {
      return 1;
    }
    if (((lphs->grhst == hstBeam) && ((((HS *)lphs)->wFlags_0x2 & 0xff) == 0x12)) &&
       (((HS *)lphs)->wFlags_0x2 >> 8 != 0)) {
      return 1;
    }
    if (((lphs->grhst == hstSpecialM) && ((((HS *)lphs)->wFlags_0x2 & 0xff) == 1)) &&
       (((HS *)lphs)->wFlags_0x2 >> 8 != 0)) break;
    ihs = ihs + 1;
    lphs = (HS *)lphs + 1;
  }
  return 1;
}



// ======================================================================
// Function: FFleetHasTeeth
// Address: 10f0:1fbe
// Segment: MEMORY_BATTLE
// ======================================================================


short FFleetHasTeeth(FLEET *lpfl)

{
  short sVar1;
  int iVar2;
  short ishdef;
  
  ishdef = 0;
  while( true ) {
    if (0xf < ishdef) {
      return 0;
    }
    if (((((FLEET *)lpfl)->rgcsh[ishdef] != 0) &&
        (iVar2 = ((uint)lpfl->id >> 9 & 0xf) * 4,
        sVar1 = FHullHasTeeth((HUL *)CONCAT22(*(undefined2 *)(iVar2 + 0x100),
                                              (HUL *)(*(int *)(iVar2 + rglpshdef) + ishdef * 0x93)))
        , sVar1 != 0)) &&
       (iVar2 = ((uint)lpfl->id >> 9 & 0xf) * 4,
       (*(uint *)(*(int *)(iVar2 + rglpshdef) + ishdef * 0x93 + 0x7b) & 0xff) == 7)) break;
    ishdef = ishdef + 1;
  }
  return 1;
}



// ======================================================================
// Function: FHullHasTeeth
// Address: 10f0:2072
// Segment: MEMORY_BATTLE
// ======================================================================


short FHullHasTeeth(HUL *lphul)

{
  short ihs;
  HS *lphs;
  
  lphs = (HS *)CONCAT22(lphul._2_2_,((HUL *)lphul)->rghs);
  ihs = 0;
  while( true ) {
    if ((int)(uint)((HUL *)lphul)->chs <= ihs) {
      return 0;
    }
    if (((lphs->grhst & (hstTorp|hstBeam)) !=
         ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
           hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
       (((HS *)lphs)->wFlags_0x2 >> 8 != 0)) break;
    ihs = ihs + 1;
    lphs = (HS *)lphs + 1;
  }
  return 1;
}



// ======================================================================
// Function: FFuelTanker
// Address: 10f0:20f6
// Segment: MEMORY_BATTLE
// ======================================================================


short FFuelTanker(SHDEF *lpshdef)

{
  short sVar1;
  
  if (((lpshdef->hul).ihuldef == ihuldefFuelTransport) ||
     ((lpshdef->hul).ihuldef == ihuldefSuperFuelXport)) {
    sVar1 = 1;
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: CheckTarget
// Address: 10f0:212a
// Segment: MEMORY_BATTLE
// ======================================================================


void CheckTarget(TOK *ptok,FLEET *lpfl,short ishdef)

{
  undefined2 uVar1;
  uint uVar2;
  short sVar3;
  SHDEF *pSVar4;
  BTLPLAN *pBVar5;
  TOK *pTVar6;
  undefined2 uVar7;
  short ibp;
  BTLPLAN *lpbtlplan;
  short iplr;
  
  uVar2 = (uint)lpfl->id >> 9 & 0xf;
  uVar1 = *(undefined2 *)(uVar2 * 4 + 0x100);
  pSVar4 = (SHDEF *)(*(int *)(uVar2 * 4 + rglpshdef) + ishdef * 0x93);
  sVar3 = FHullHasTeeth((HUL *)CONCAT22(uVar1,pSVar4));
  pTVar6 = (TOK *)ptok;
  uVar7 = (undefined2)((ulong)ptok >> 0x10);
  if (sVar3 == 0) {
    sVar3 = FHullHasBombs((HUL *)CONCAT22(uVar1,pSVar4));
    if (sVar3 == 0) {
      sVar3 = FFuelTanker((SHDEF *)CONCAT22(uVar1,pSVar4));
      if (sVar3 == 0) {
        sVar3 = WtMaxShdefStat((SHDEF *)CONCAT22(uVar1,pSVar4),grStatCargo);
        if (sVar3 == 0) {
          pTVar6->wFlags_0x17 = pTVar6->wFlags_0x17 & 0xfff | 0x5000;
        }
        else {
          pTVar6->wFlags_0x17 = pTVar6->wFlags_0x17 & 0xfff | 0x7000;
        }
      }
      else {
        pTVar6->wFlags_0x17 = pTVar6->wFlags_0x17 & 0xfff | 0x6000;
      }
    }
    else {
      pTVar6->wFlags_0x17 = pTVar6->wFlags_0x17 & 0xfff | 0x4000;
    }
  }
  else {
    pTVar6->wFlags_0x17 = pTVar6->wFlags_0x17 & 0xfff | 0x3000;
  }
  uVar1 = *(undefined2 *)(uVar2 * 4 + 0x593a);
  pBVar5 = ((BTLPLAN **)rglpbtlplan)[uVar2 * 2] + ((FLEET *)lpfl)->iplan;
  lpbtlplan = (BTLPLAN *)CONCAT22(uVar1,pBVar5);
  pTVar6->wFlags_0x17 = pTVar6->wFlags_0x17 & 0xfff0 | pBVar5->wFlags_0x2 & 0xf;
  pTVar6->wFlags_0x17 = pTVar6->wFlags_0x17 & 0xff0f | (pBVar5->wFlags_0x2 >> 4 & 0xf) << 4;
  if (pTVar6->wFlags_0x17 >> 0xc == 3) {
    pTVar6->wFlags_0x17 = pTVar6->wFlags_0x17 & 0xf0ff | (lpbtlplan->wFlags >> 8 & 0xf) << 8;
  }
  else {
    pTVar6->wFlags_0x17 = pTVar6->wFlags_0x17 & 0xf0ff;
  }
  if ((pTVar6->wFlags_0x17 >> 8 & 0xf) == 0) {
    pTVar6->wFlags = pTVar6->wFlags & 0xfc1f | 0xe0;
  }
  return;
}



// ======================================================================
// Function: FDumpCargo
// Address: 10f0:234a
// Segment: MEMORY_BATTLE
// ======================================================================


short FDumpCargo(FLEET *lpfl)

{
  uint *puVar1;
  uint uVar2;
  uint uVar3;
  short sVar4;
  undefined2 uVar5;
  uint uVar6;
  long *plVar7;
  PLANET *pPVar8;
  short i;
  POINT pt;
  
  i = 0;
  while( true ) {
    if (((2 < i) || ((int)((FLEET *)lpfl)->rgwtMin[i] != 0)) ||
       (*(int *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) != 0)) break;
    i = i + 1;
  }
  if (i < 3) {
    uVar6 = (uint)lpfl->id >> 9 & 0xf;
    if ((int)(((BTLPLAN **)rglpbtlplan)[uVar6 * 2] + ((FLEET *)lpfl)->iplan)->wFlags < 0)
    {
      if (((FLEET *)lpfl)->idPlanet == -1) {
        pt.x = (&((FLEET *)lpfl)->pt)->x;
        pt.y = (((FLEET *)lpfl)->pt).y;
        DropSalvage((THING **)&lpthBattle,
                    (long *)CONCAT22(lpfl._2_2_,((FLEET *)lpfl)->rgwtMin),(uint)lpfl->id >> 9 & 0xf,
                    &pt);
      }
      else {
        pPVar8 = LpplFromId(((FLEET *)lpfl)->idPlanet);
        uVar5 = (undefined2)((ulong)pPVar8 >> 0x10);
        for (i = 0; i < 3; i = i + 1) {
          uVar2 = *(uint *)(((FLEET *)lpfl)->rgwtMin + i);
          uVar3 = *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
          plVar7 = ((PLANET *)pPVar8)->rgwtMin + i;
          puVar1 = (uint *)plVar7;
          uVar6 = *puVar1;
          *puVar1 = *puVar1 + uVar2;
          puVar1 = (uint *)((int)plVar7 + 2);
          *puVar1 = *puVar1 + uVar3 + (uint)CARRY2(uVar6,uVar2);
        }
      }
      for (i = 0; i < 3; i = i + 1) {
        *(undefined2 *)(((FLEET *)lpfl)->rgwtMin + i) = 0;
        *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = 0;
      }
      sVar4 = 1;
    }
    else {
      sVar4 = 0;
    }
  }
  else {
    sVar4 = 0;
  }
  return sVar4;
}



// ======================================================================
// Function: DropSalvage
// Address: 10f0:24dc
// Segment: MEMORY_BATTLE
// ======================================================================


void DropSalvage(THING **plpth,long *rgwtMinerals,short iplr,POINT *ppt)

{
  uint *puVar1;
  THING *pTVar2;
  uint uVar3;
  short sVar4;
  uint uVar5;
  int iVar6;
  THING *pTVar7;
  undefined2 uVar8;
  bool bVar9;
  ulong uVar10;
  long lVar11;
  THING *lpth;
  short i;
  uint wtTotal;
  int local_6;
  
  pTVar7 = *plpth;
  pTVar2 = plpth[1];
  lpth = (THING *)CONCAT22(pTVar2,pTVar7);
  wtTotal = 0;
  local_6 = 0;
  for (i = 0; i < game.cPlanMax; i = i + 1) {
    if ((ppt->x == ((POINT *)rgptPlan + i)->x) &&
       (ppt->y == *(int *)((int)&rgptPlan[0].y + i * 4))) {
      return;
    }
  }
  i = 0;
  while( true ) {
    if (2 < i) break;
    uVar5 = *(uint *)((long *)rgwtMinerals + i);
    bVar9 = CARRY2(wtTotal,uVar5);
    wtTotal = wtTotal + uVar5;
    local_6 = local_6 + *(uint *)((int)((long *)rgwtMinerals + i) + 2) + (uint)bVar9;
    i = i + 1;
  }
  while ((wtTotal == 0 && (local_6 == 0))) {
    for (i = 0; i < 3; i = i + 1) {
      sVar4 = Random(10);
      *(short *)((long *)rgwtMinerals + i) = sVar4;
      *(short *)((int)((long *)rgwtMinerals + i) + 2) = sVar4 >> 0xf;
      uVar5 = *(uint *)((long *)rgwtMinerals + i);
      bVar9 = CARRY2(wtTotal,uVar5);
      wtTotal = wtTotal + uVar5;
      local_6 = local_6 + *(uint *)((int)((long *)rgwtMinerals + i) + 2) + (uint)bVar9;
    }
  }
  if ((pTVar7 == (THING *)0x0) && (pTVar2 == (THING *)0x0)) {
    lpth = LpthNew(iplr,ithMineralPacket);
    iVar6 = (int)((ulong)lpth >> 0x10);
    pTVar7 = (THING *)lpth;
    if ((pTVar7 == (THING *)0x0) && (iVar6 == 0)) {
      return;
    }
    ((&pTVar7->u_THING_0x0006)->thp).wFlags = ((&pTVar7->u_THING_0x0006)->thp).wFlags & 0xc3ff;
    sVar4 = ppt->y;
    (&pTVar7->pt)->x = ppt->x;
    (pTVar7->pt).y = sVar4;
    ((&pTVar7->u_THING_0x0006)->thp).wFlags =
         ((&pTVar7->u_THING_0x0006)->thp).wFlags & 0xfc00 | 0x3ff;
  }
  else {
    for (i = 0; i < 3; i = i + 1) {
      uVar3 = *(uint *)((pTVar7->u_THING_0x0006).rgb + i * 2 + 2);
      puVar1 = (uint *)((long *)rgwtMinerals + i);
      uVar5 = *puVar1;
      *puVar1 = *puVar1 + uVar3;
      puVar1 = (uint *)((int)((long *)rgwtMinerals + i) + 2);
      *puVar1 = *puVar1 + ((int)uVar3 >> 0xf) + (uint)CARRY2(uVar5,uVar3);
      uVar5 = *(uint *)((pTVar7->u_THING_0x0006).rgb + i * 2 + 2);
      bVar9 = CARRY2(wtTotal,uVar5);
      wtTotal = wtTotal + uVar5;
      local_6 = local_6 + ((int)uVar5 >> 0xf) + (uint)bVar9;
      ((pTVar7->u_THING_0x0006).rgb + i * 2 + 2)[0] = 0;
      ((pTVar7->u_THING_0x0006).rgb + i * 2 + 2)[1] = 0;
    }
    *(uint *)((int)&pTVar7->u_THING_0x0006 + 8) =
         *(uint *)((int)&pTVar7->u_THING_0x0006 + 8) & 0xc000;
  }
  uVar8 = (undefined2)((ulong)lpth >> 0x10);
  ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags =
       ((&((THING *)lpth)->u_THING_0x0006)->thp).wFlags & 0xbfff | 0x4000;
  do {
    if ((local_6 < 1) && ((local_6 < 0 || (wtTotal == 0)))) {
      *plpth = (THING *)lpth;
      plpth[1] = lpth._2_2_;
      return;
    }
    for (i = 0; i < 3; i = i + 1) {
      uVar8 = (undefined2)((ulong)lpth >> 0x10);
      pTVar7 = (THING *)lpth;
      uVar10 = __aFulmul((ulong)*(uint *)((int)&pTVar7->u_THING_0x0006 + 8) & 0xffff3fff,10)
      ;
      puVar1 = (uint *)((long *)rgwtMinerals + i);
      iVar6 = (int)(uVar10 >> 0x10) + *(uint *)((int)((long *)rgwtMinerals + i) + 2) +
              (uint)CARRY2((uint)uVar10,*puVar1);
      if ((iVar6 < 0) || ((iVar6 < 1 && ((uint)uVar10 + *puVar1 < 0x7531)))) {
        uVar5 = *(uint *)((long *)rgwtMinerals + i);
        lVar11 = __aFldiv(CONCAT22(*(uint *)((int)((long *)rgwtMinerals + i) + 2) +
                                           (uint)(0xfff6 < uVar5),uVar5 + 9),10);
        iVar6 = *(int *)((int)&pTVar7->u_THING_0x0006 + 8);
        puVar1 = (uint *)((int)&pTVar7->u_THING_0x0006 + 8);
        *puVar1 = *puVar1 & 0xc000;
        puVar1 = (uint *)((int)&pTVar7->u_THING_0x0006 + 8);
        *puVar1 = *puVar1 | (int)lVar11 + iVar6 & 0x3fffU;
        *(int *)((pTVar7->u_THING_0x0006).rgb + i * 2 + 2) =
             *(int *)((pTVar7->u_THING_0x0006).rgb + i * 2 + 2) + (int)((long *)rgwtMinerals)[i];
        uVar5 = *(uint *)((long *)rgwtMinerals + i);
        local_6 = (local_6 - *(uint *)((int)((long *)rgwtMinerals + i) + 2)) -
                  (uint)(wtTotal < uVar5);
        *(undefined2 *)((long *)rgwtMinerals + i) = 0;
        *(undefined2 *)((int)((long *)rgwtMinerals + i) + 2) = 0;
      }
      else {
        uVar10 = __aFulmul((ulong)*(uint *)((int)&pTVar7->u_THING_0x0006 + 8) & 0xffff3fff,
                                   10);
        uVar5 = 30000 - (uint)uVar10;
        iVar6 = -(uint)(30000 < (uint)uVar10) - (int)(uVar10 >> 0x10);
        local_6 = (local_6 - iVar6) - (uint)(wtTotal < uVar5);
        *(uint *)((int)&pTVar7->u_THING_0x0006 + 8) =
             *(uint *)((int)&pTVar7->u_THING_0x0006 + 8) & 0xc000 | 3000;
        *(uint *)((pTVar7->u_THING_0x0006).rgb + i * 2 + 2) =
             *(int *)((pTVar7->u_THING_0x0006).rgb + i * 2 + 2) + uVar5;
        puVar1 = (uint *)((long *)rgwtMinerals + i);
        uVar3 = *puVar1;
        *puVar1 = *puVar1 - uVar5;
        puVar1 = (uint *)((int)((long *)rgwtMinerals + i) + 2);
        *puVar1 = (*puVar1 - iVar6) - (uint)(uVar3 < uVar5);
        lpth = LpthNew(iplr,ithMineralPacket);
        iVar6 = (int)((ulong)lpth >> 0x10);
        pTVar7 = (THING *)lpth;
        if ((pTVar7 == (THING *)0x0) && (iVar6 == 0)) {
          return;
        }
        ((&pTVar7->u_THING_0x0006)->thp).wFlags = ((&pTVar7->u_THING_0x0006)->thp).wFlags & 0xc3ff;
        ((&pTVar7->u_THING_0x0006)->thp).wFlags =
             ((&pTVar7->u_THING_0x0006)->thp).wFlags & 0xfc00 | 0x3ff;
        sVar4 = ppt->y;
        (&pTVar7->pt)->x = ppt->x;
        (pTVar7->pt).y = sVar4;
      }
      wtTotal = wtTotal - uVar5;
      if ((local_6 < 1) && ((local_6 < 0 || (wtTotal == 0)))) break;
    }
  } while( true );
}



// ======================================================================
// Function: CplrBattle
// Address: 10f0:2952
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f03389) */

short CplrBattle(FLEET *lpfl,ushort *rggrfAttack,ushort *pgrfPlayer,ushort *pgrfSpectator)

{
  uint *puVar1;
  int iVar2;
  uint uVar3;
  PLANET *pPVar4;
  bool bVar5;
  short sVar6;
  byte bVar7;
  FLEET *pFVar8;
  uint uVar9;
  undefined2 uVar10;
  HULDEF *pHVar11;
  short ctokFleet;
  short ctokNew;
  ushort grfPlayer;
  short cflTotal;
  short ishdef;
  short cshdef;
  short fAttack;
  ushort iplrAttack;
  short fChange;
  byte rgctok [16];
  short mdRel;
  short i;
  short cplr;
  PLANET *lppl;
  short iplrCur;
  ushort grPlr;
  uint rgcsh [32];
  FLEET *lpflCur;
  short iplrStarbase;
  
  bVar5 = false;
  iplrStarbase = -1;
  grfPlayer = 0;
  cshdef = 0;
  grfMissed = 0;
  *pgrfSpectator = 0;
  _memset(rggrfAttack,0,0x20);
  _memset(rgcsh,0,0x40);
  uVar10 = (undefined2)((ulong)lpfl >> 0x10);
  if (((FLEET *)lpfl)->idPlanet != -1) {
    lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
    uVar10 = (undefined2)((ulong)lppl >> 0x10);
    pPVar4 = (PLANET *)lppl;
    if ((pPVar4->wFlags_0x4 >> 9 & 1) == 0) {
      if (pPVar4->iPlayer != -1) {
        *pgrfSpectator = *pgrfSpectator | 1 << ((byte)pPVar4->iPlayer & 0x1f);
      }
    }
    else {
      iplrStarbase = pPVar4->iPlayer;
      grfPlayer = 1 << ((byte)iplrStarbase & 0x1f);
      uVar9 = *(uint *)((int)*(undefined4 *)((BTLPLAN **)rglpbtlplan + iplrStarbase * 2) +
                       2) >> 8 & 0x1f;
      sVar6 = FHullHasTeeth((HUL *)CONCAT22(*(undefined2 *)(iplrStarbase * 4 + 0x14e),
                                            (HUL *)(*(int *)(iplrStarbase * 4 + rglpshdefSB) +
                                                   (*(uint *)&pPVar4->lStarbase & 0xf) * 0x93)));
      if ((sVar6 != 0) && (uVar9 != 0)) {
        if ((uVar9 == 1) || (uVar9 == 2)) {
          for (i = 0; i < game.cPlayer; i = i + 1) {
            if ((i != iplrStarbase) &&
               ((mdRel = (short)*(char *)(iplrStarbase * 0xc0 + 0x5a12 + i), mdRel == 2 ||
                ((mdRel == 0 && (uVar9 == 2)))))) {
              rggrfAttack[iplrStarbase] = rggrfAttack[iplrStarbase] | 1 << ((byte)i & 0x1f);
            }
          }
        }
        else if (uVar9 == 3) {
          rggrfAttack[iplrCur] = ~(1 << ((byte)iplrStarbase & 0x1f));
        }
        else {
          rggrfAttack[iplrCur] = rggrfAttack[iplrCur] | 1 << ((char)uVar9 - 4U & 0x1f);
        }
      }
    }
  }
  lpflCur = lpfl;
  do {
    uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
    pFVar8 = (FLEET *)lpflCur;
    if ((pFVar8->wFlags_0x4 >> 10 & 1) == 0) {
      iplrCur = pFVar8->iPlayer;
      grfPlayer = grfPlayer | 1 << ((byte)iplrCur & 0x1f);
      uVar9 = (uint)lpflCur->id >> 9 & 0xf;
      if ((((((BTLPLAN **)rglpbtlplan)[uVar9 * 2][pFVar8->iplan].wFlags_0x2 & 0xf) != 0)
          && (uVar9 = (uint)lpflCur->id >> 9 & 0xf,
             (((BTLPLAN **)rglpbtlplan)[uVar9 * 2][pFVar8->iplan].wFlags_0x2 >> 8 & 0x1f)
             != 0)) && (sVar6 = FFleetHasTeeth(lpflCur), sVar6 != 0)) {
        bVar5 = true;
        uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
        iplrAttack = ((BTLPLAN **)rglpbtlplan)[iplrCur * 2][((FLEET *)lpflCur)->iplan].
                     wFlags_0x2 >> 8 & 0x1f;
        uVar9 = (uint)lpflCur->id >> 9 & 0xf;
        if ((((BTLPLAN **)rglpbtlplan)[uVar9 * 2][((FLEET *)lpflCur)->iplan].wFlags_0x2 &
            0xf) == 0) {
          iplrAttack = 0;
        }
        if (iplrAttack != 0) {
          if ((iplrAttack == 1) || (iplrAttack == 2)) {
            for (i = 0; i < game.cPlayer; i = i + 1) {
              if ((i != iplrCur) &&
                 ((mdRel = (short)*(char *)(iplrCur * 0xc0 + 0x5a12 + i), mdRel == 2 ||
                  ((mdRel == 0 && (iplrAttack == 2)))))) {
                rggrfAttack[iplrCur] = rggrfAttack[iplrCur] | 1 << ((byte)i & 0x1f);
              }
            }
          }
          else if (iplrAttack == 3) {
            rggrfAttack[iplrCur] = ~(1 << ((byte)iplrCur & 0x1f));
          }
          else {
            rggrfAttack[iplrCur] = rggrfAttack[iplrCur] | 1 << ((char)iplrAttack - 4U & 0x1f);
          }
        }
      }
      uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
      pFVar8 = (FLEET *)lpflCur;
      pFVar8->wFlags_0x4 = pFVar8->wFlags_0x4 & 0xf7ff | 0x800;
      pFVar8->wFlags_0x4 = pFVar8->wFlags_0x4 & 0xfeff | 0x100;
    }
    sVar6 = iplrStarbase;
    uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
                    /* WARNING: Load size is inaccurate */
    lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                ((FLEET *)lpflCur)->lpflNext);
  } while (lpfl != lpflCur);
  if (bVar5) {
    iplrAttack = 0;
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (rggrfAttack[i] != 0) {
        iplrAttack = iplrAttack | grfPlayer & rggrfAttack[i];
      }
    }
    if (iplrAttack == 0) {
      cplr = 0;
    }
    else {
      for (i = 0; i < game.cPlayer; i = i + 1) {
        bVar7 = (byte)i;
        if ((rggrfAttack[i] & iplrAttack) != 0) {
          iplrAttack = iplrAttack | 1 << (bVar7 & 0x1f);
        }
        if ((1 << (bVar7 & 0x1f) & iplrAttack) != 0) {
          for (iplrCur = 0; iplrCur < game.cPlayer; iplrCur = iplrCur + 1) {
            if ((1 << (bVar7 & 0x1f) & rggrfAttack[iplrCur]) != 0) {
              rggrfAttack[i] = rggrfAttack[i] | 1 << ((byte)iplrCur & 0x1f);
            }
          }
        }
      }
      do {
        if (lpfl == lpflCur) {
          fChange = 0;
        }
        iVar2 = ((FLEET *)lpflCur)->iPlayer;
        uVar9 = 1 << ((byte)iVar2 & 0x1f);
        if (((grfPlayer & uVar9) != 0) && ((iplrAttack & uVar9) == 0)) {
          rggrfAttack[iVar2] = 0;
          for (i = 0; i < game.cPlayer; i = i + 1) {
            if (((i != iVar2) && (*(char *)(iVar2 * 0xc0 + 0x5a12 + i) == '\x01')) &&
               ((1 << ((byte)i & 0x1f) & iplrAttack) != 0)) {
              if ((1 << ((byte)i & 0x1f) & rggrfAttack[iVar2]) != 0) {
                rggrfAttack[iVar2] = 0;
                break;
              }
              rggrfAttack[iVar2] = rggrfAttack[iVar2] | rggrfAttack[i];
            }
          }
          if (rggrfAttack[iVar2] == 0) {
            grfPlayer = grfPlayer & ~uVar9;
          }
          else {
            iplrAttack = iplrAttack | uVar9;
          }
          fChange = 1;
        }
                    /* WARNING: Load size is inaccurate */
        lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                    ((FLEET *)lpflCur)->lpflNext);
      } while ((fChange != 0) || (lpfl != lpflCur));
      if ((iplrStarbase != -1) && ((1 << ((byte)iplrStarbase & 0x1f) & grfPlayer) != 0)) {
        rgcsh[iplrStarbase * 2] = 1;
        rgcsh[sVar6 * 2 + 1] = 0;
        cshdef = 1;
      }
      do {
        uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
        pFVar8 = (FLEET *)lpflCur;
        iplrCur = pFVar8->iPlayer;
        grPlr = 1 << ((byte)iplrCur & 0x1f);
        if ((grfPlayer & grPlr) == 0) {
          *pgrfSpectator = *pgrfSpectator | grPlr;
          pFVar8->wFlags_0x4 = pFVar8->wFlags_0x4 & 0xfeff;
        }
        else {
          for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
            if (((FLEET *)lpflCur)->rgcsh[ishdef] != 0) {
              pHVar11 = LphuldefFromId
                                  (*(HullDef *)(*(int *)(iplrCur * 4 + rglpshdef) + ishdef * 0x93));
              if ((((HULDEF *)pHVar11)->wFlags_0x7b >> 6 & 0xf) != 0) {
                uVar3 = ((FLEET *)lpflCur)->rgcsh[ishdef];
                puVar1 = rgcsh + iplrCur * 2;
                uVar9 = *puVar1;
                *puVar1 = *puVar1 + uVar3;
                rgcsh[iplrCur * 2 + 1] =
                     rgcsh[iplrCur * 2 + 1] + ((int)uVar3 >> 0xf) + (uint)CARRY2(uVar9,uVar3);
              }
              cshdef = cshdef + 1;
            }
          }
        }
        uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
                    /* WARNING: Load size is inaccurate */
        lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                    ((FLEET *)lpflCur)->lpflNext);
      } while (lpfl != lpflCur);
      cplr = 0;
      for (; iplrAttack != 0; iplrAttack = iplrAttack >> 1) {
        if ((iplrAttack & 1) != 0) {
          cplr = cplr + 1;
        }
      }
      if (0xff < cshdef) {
        ctokNew = 0;
        i = (short)(0xff / (long)cplr);
        if ((iplrStarbase != -1) && ((1 << ((byte)iplrStarbase & 0x1f) & grfPlayer) != 0)) {
          ctokNew = 1;
        }
        _memset(rgctok,0,0x10);
        do {
          uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
          pFVar8 = (FLEET *)lpflCur;
          if ((pFVar8->wFlags_0x4 >> 8 & 1) != 0) {
            ctokFleet = 0;
            iplrCur = pFVar8->iPlayer;
            for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
              if (pFVar8->rgcsh[ishdef] != 0) {
                ctokFleet = ctokFleet + 1;
              }
            }
            if (i < (int)((uint)rgctok[iplrCur] + ctokFleet)) {
              pFVar8->wFlags_0x4 = pFVar8->wFlags_0x4 & 0xfeff;
              pFVar8->wFlags_0x4 = pFVar8->wFlags_0x4 & 0xefff | 0x1000;
              *(uint *)((int)&pFVar8->dirLong + 2) =
                   *(uint *)((int)&pFVar8->dirLong + 2) & 0xff7f | 0x80;
            }
            else {
              rgctok[iplrCur] = rgctok[iplrCur] + (char)ctokFleet;
              ctokNew = ctokNew + ctokFleet;
            }
          }
          uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
                    /* WARNING: Load size is inaccurate */
          lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                      ((FLEET *)lpflCur)->lpflNext);
        } while (lpfl != lpflCur);
        if (ctokNew < 0xff) {
          do {
            uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
            pFVar8 = (FLEET *)lpflCur;
            if ((*(uint *)((int)&pFVar8->dirLong + 2) >> 7 & 1) != 0) {
              ctokFleet = 0;
              iplrCur = pFVar8->iPlayer;
              for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
                if (pFVar8->rgcsh[ishdef] != 0) {
                  ctokFleet = ctokFleet + 1;
                }
              }
              if (ctokNew + ctokFleet < 0x100) {
                pFVar8->wFlags_0x4 = pFVar8->wFlags_0x4 & 0xfeff | 0x100;
                pFVar8->wFlags_0x4 = pFVar8->wFlags_0x4 & 0xefff;
                *(uint *)((int)&pFVar8->dirLong + 2) = *(uint *)((int)&pFVar8->dirLong + 2) & 0xff7f
                ;
                rgctok[iplrCur] = rgctok[iplrCur] + (char)ctokFleet;
                ctokNew = ctokNew + ctokFleet;
              }
            }
            uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
                    /* WARNING: Load size is inaccurate */
            lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                        ((FLEET *)lpflCur)->lpflNext);
          } while (lpfl != lpflCur);
        }
      }
      *pgrfPlayer = grfPlayer;
    }
  }
  else {
    cplr = 0;
  }
  return cplr;
}



// ======================================================================
// Function: SpdOfShip
// Address: 10f0:339c
// Segment: MEMORY_BATTLE
// ======================================================================


short SpdOfShip(FLEET *lpfl,short ishdef,TOK *ptok,short fDumpCargo,SHDEF *lpshdef)

{
  HullSlotType HVar1;
  uint uVar2;
  short sVar3;
  uint uVar4;
  uint uVar5;
  FLEET *pFVar6;
  int iVar7;
  SHDEF *pSVar8;
  TOK *pTVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  undefined2 uVar12;
  ENGINE *pEVar13;
  long lVar14;
  ulong uVar15;
  short iEngine;
  ushort wtCargoShdefMax;
  short cEngineT;
  short j;
  short cThruster;
  short cHalfThruster;
  ushort wt;
  short iWarp;
  short spd;
  
  pFVar6 = (FLEET *)lpfl;
  uVar10 = (undefined2)((ulong)lpfl >> 0x10);
  if (((SHDEF *)lpshdef == (SHDEF *)0x0) && (lpshdef._2_2_ == 0)) {
    iVar7 = pFVar6->iPlayer * 4;
    lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iVar7 + 0x100),
                                (SHDEF *)(*(int *)(iVar7 + rglpshdef) + ishdef * 0x93));
  }
  iEngine = -1;
  cHalfThruster = 0;
  cThruster = 0;
  j = 0;
  while( true ) {
    uVar11 = (undefined2)((ulong)lpshdef >> 0x10);
    pSVar8 = (SHDEF *)lpshdef;
    if ((int)(uint)(pSVar8->hul).chs <= j) break;
    if ((pSVar8->hul).rghs[j].wFlags_0x2 >> 8 != 0) {
      HVar1 = ((pSVar8->hul).rghs + j)->grhst;
      if (HVar1 == hstEngine) {
        iEngine = (pSVar8->hul).rghs[j].wFlags_0x2 & 0xff;
        cEngineT = (pSVar8->hul).rghs[j].wFlags_0x2 >> 8;
        if (iEngine == 8) {
          cHalfThruster = cHalfThruster + ((pSVar8->hul).rghs[j].wFlags_0x2 >> 8);
        }
      }
      else if (HVar1 == hstMining) {
        if (((pSVar8->hul).rghs[j].wFlags_0x2 & 0xff) == 6) {
          cHalfThruster = cHalfThruster + ((pSVar8->hul).rghs[j].wFlags_0x2 >> 8);
        }
      }
      else if (HVar1 == hstSpecialE) {
        if (((pSVar8->hul).rghs[j].wFlags_0x2 & 0xff) == 4) {
          cThruster = cThruster + ((pSVar8->hul).rghs[j].wFlags_0x2 >> 8);
        }
      }
      else if (HVar1 == hstSpecialM) {
        uVar2 = (pSVar8->hul).rghs[j].wFlags_0x2 & 0xff;
        if (uVar2 == 7) {
          cThruster = cThruster + ((pSVar8->hul).rghs[j].wFlags_0x2 >> 8);
        }
        else if (uVar2 == 8) {
          cThruster = cThruster + ((pSVar8->hul).rghs[j].wFlags_0x2 >> 8) * 2;
        }
      }
    }
    j = j + 1;
  }
  if ((iEngine == -1) || (cEngineT == 0)) {
    uVar2 = 0;
  }
  else {
    pEVar13 = LpengineFromId(iEngine);
    if ((((iEngine == 7) || (iEngine == 8)) || (iEngine == 9)) ||
       ((iEngine == 0xe || (iEngine == 0xf)))) {
      iWarp = 10;
    }
    else {
      for (iWarp = 9; (0 < iWarp && (0x78 < ((ENGINE *)pEVar13)->rgcFuelUsed[iWarp]));
          iWarp = iWarp + -1) {
      }
    }
    spd = iWarp + -4 + cThruster + (cHalfThruster + 1) / 2;
    if (lpfl != (FLEET *)0x0) {
      sVar3 = GetRaceStat((PLAYER *)rgplr + pFVar6->iPlayer,rsMajorAdv);
      spd = spd + (uint)(sVar3 == raAttack) * 2;
    }
    wt = (pSVar8->hul).wtEmpty;
    pTVar9 = (TOK *)ptok;
    uVar12 = (undefined2)((ulong)ptok >> 0x10);
    if (lpfl != (FLEET *)0x0) {
      uVar2 = WtMaxShdefStat(lpshdef,grStatCargo);
      if (uVar2 == 0) {
        fDumpCargo = 0;
      }
      else {
        lVar14 = LGetFleetStat(lpfl,grStatCargo);
        uVar4 = *(uint *)pFVar6->rgwtMin + *(uint *)(pFVar6->rgwtMin + 1);
        uVar5 = uVar4 + *(uint *)(pFVar6->rgwtMin + 2);
        uVar15 = __aFulmul(CONCAT22(*(int *)((int)pFVar6->rgwtMin + 2) +
                                            *(int *)((int)pFVar6->rgwtMin + 6) +
                                            (uint)CARRY2(*(uint *)pFVar6->rgwtMin,
                                                         *(uint *)(pFVar6->rgwtMin + 1)) +
                                            *(int *)((int)pFVar6->rgwtMin + 10) +
                                            (uint)CARRY2(uVar4,*(uint *)(pFVar6->rgwtMin + 2)) +
                                            *(int *)((int)pFVar6->rgwtMin + 0xe) +
                                            (uint)CARRY2(uVar5,*(uint *)(pFVar6->rgwtMin + 3)),
                                            uVar5 + *(uint *)(pFVar6->rgwtMin + 3)),(ulong)uVar2);
        lVar14 = __aFldiv(uVar15,lVar14);
        wt = wt + (int)lVar14;
      }
      if (fDumpCargo != 0) {
        spd = spd + -1;
      }
      uVar2 = Random(0xf);
      pTVar9->wFlags = pTVar9->wFlags & 0xc3ff | (uVar2 & 0xf) << 10;
    }
    if (ptok != (TOK *)0x0) {
      pTVar9->wt = wt;
    }
    uVar2 = spd - (int)(((ulong)wt / 0x46) / (ulong)((pSVar8->hul).rghs[0].wFlags_0x2 >> 8));
    uVar4 = uVar2;
    if (8 < (int)uVar2) {
      uVar4 = 8;
    }
    if (uVar4 < 0x8000) {
      if (8 < (int)uVar2) {
        uVar2 = 8;
      }
    }
    else {
      uVar2 = 0;
    }
  }
  return uVar2;
}



// ======================================================================
// Function: LpshdefFromTok
// Address: 10f0:388e
// Segment: MEMORY_BATTLE
// ======================================================================


SHDEF * LpshdefFromTok(TOK *ptok)

{
  SHDEF *pSVar1;
  undefined2 uVar2;
  TOK *pTVar3;
  int iVar4;
  undefined2 uVar5;
  
  uVar5 = (undefined2)((ulong)ptok >> 0x10);
  pTVar3 = (TOK *)ptok;
  if (*(byte *)((int)&pTVar3->u_TOK_0x0003 + 1) < 0x10) {
    iVar4 = (uint)pTVar3->iplr * 4;
    uVar2 = *(undefined2 *)(iVar4 + 0x100);
    pSVar1 = (SHDEF *)(*(int *)(iVar4 + rglpshdef) +
                      (uint)*(byte *)((int)&pTVar3->u_TOK_0x0003 + 1) * 0x93);
  }
  else {
    iVar4 = (uint)pTVar3->iplr * 4;
    uVar2 = *(undefined2 *)(iVar4 + 0x14e);
    pSVar1 = (SHDEF *)(*(int *)(iVar4 + rglpshdefSB) +
                      (*(byte *)((int)&pTVar3->u_TOK_0x0003 + 1) - 0x10) * 0x93);
  }
  return (SHDEF *)CONCAT22(uVar2,pSVar1);
}



// ======================================================================
// Function: FCanKillTok
// Address: 10f0:391e
// Segment: MEMORY_BATTLE
// ======================================================================


short FCanKillTok(TOK *ptok1,TOK *ptok2)

{
  uint uVar1;
  uint uVar2;
  uint uVar3;
  uint uVar4;
  short sVar5;
  undefined2 uVar6;
  SHDEF *pSVar7;
  
  pSVar7 = LpshdefFromTok(ptok1);
  uVar6 = (undefined2)((ulong)pSVar7 >> 0x10);
  uVar1 = *&((SHDEF *)pSVar7)->u_SHDEF_0x0087;
  uVar2 = *(uint *)((int)&((SHDEF *)pSVar7)->u_SHDEF_0x0087 + 2);
  pSVar7 = LpshdefFromTok(ptok2);
  uVar6 = (undefined2)((ulong)pSVar7 >> 0x10);
  uVar3 = *&((SHDEF *)pSVar7)->u_SHDEF_0x0087;
  uVar4 = *(uint *)((int)&((SHDEF *)pSVar7)->u_SHDEF_0x0087 + 2);
  if (((int)uVar4 < (int)uVar2) || (((int)uVar4 <= (int)uVar2 && (uVar3 <= uVar1)))) {
    if (((uVar2 & 0x7fff) < (uVar4 & 0x7fff)) ||
       (((uVar2 & 0x7fff) <= (uVar4 & 0x7fff) && ((uVar1 & 0xf000) <= (uVar3 & 0xf000))))) {
      if ((((uVar3 & 0xff00) == (uVar1 & 0xff00)) && ((uVar4 & 0x7fff) == (uVar2 & 0x7fff))) &&
         ((((TOK *)ptok2)->wFlags_0x19 >> 8 & 0xf) <= (((TOK *)ptok1)->wFlags_0x19 >> 8 & 0xf))) {
        sVar5 = 1;
      }
      else {
        sVar5 = 0;
      }
    }
    else {
      sVar5 = 1;
    }
  }
  else {
    sVar5 = 0;
  }
  return sVar5;
}



// ======================================================================
// Function: DoBattles
// Address: 10f0:3a26
// Segment: MEMORY_BATTLE
// ======================================================================


void DoBattles(short fPostMovement)

{
  FLEET *pFVar1;
  int iVar2;
  byte *pbVar3;
  ushort grfPlayer;
  ushort grfSpectator;
  FLEET *lpfl;
  short ifl;
  short cplr;
  
  LinkFleets(fPostMovement);
  vrgtok = LpAlloc(0x1d00,htMisc);
  vlpwtCargo = LpAlloc(0x200,htMisc);
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[ifl];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    pFVar1->wFlags_0x4 = pFVar1->wFlags_0x4 & 0xefff;
    if ((((pFVar1->wFlags_0x4 >> 0xb & 1) == 0) && ((pFVar1->wFlags_0x4 >> 10 & 1) == 0)) &&
       ((*(int *)&pFVar1->lpflNext != 0 || (*(int *)((int)&pFVar1->lpflNext + 2) != 0)))) {
      cplr = CplrBattle((FLEET *)CONCAT22(iVar2,pFVar1),&stack0xffd0,&grfPlayer,&grfSpectator);
      if ((cplr != -1) && (cplr != 0)) {
        FDoCoolBattle(lpfl,cplr,&stack0xffd0,grfPlayer,grfSpectator);
      }
    }
  }
  FreeLp(vlpwtCargo,htMisc);
  FreeLp(vrgtok,htMisc);
  vlpwtCargo._0_2_ = (ushort *)0x0;
  vlpwtCargo._2_2_ = 0;
  vrgtok._0_2_ = (TOK *)0x0;
  vrgtok._2_2_ = 0;
  if (((byte *)lpbBattleT != (byte *)0x0) || (lpbBattleT._2_2_ != 0)) {
    pbVar3 = lpbBattleT;
    pbVar3[0] = 0xff;
    pbVar3[1] = 0xff;
    FreeLp(lpbBattleT,htBattle);
    lpbBattleT = (byte *)0x0;
  }
  if (((byte *)lpbBattleCur != (byte *)0x0) || (lpbBattleCur._2_2_ != 0)) {
    pbVar3 = lpbBattleCur;
    pbVar3[0] = 0xff;
    pbVar3[1] = 0xff;
  }
  DoBombing();
  return;
}



// ======================================================================
// Function: RegenShield
// Address: 10f0:3c16
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f03c92) */

void RegenShield(TOK *ptok)

{
  ushort uVar1;
  TOK *pTVar2;
  short unaff_SI;
  undefined2 uVar3;
  SHDEF *lpshdef;
  long lVar4;
  ushort uVar5;
  undefined2 uVar6;
  
  uVar3 = (undefined2)((ulong)ptok >> 0x10);
  pTVar2 = (TOK *)ptok;
  lpshdef = LpshdefFromTok(ptok);
  DpShieldOfShdef(lpshdef,unaff_SI);
  if (pTVar2->dpShield != 0) {
    uVar6 = 10;
    uVar5 = 10;
    lVar4 = __aFldiv(0xa000a,10);
    lVar4 = lVar4 + (ulong)pTVar2->dpShield;
    uVar1 = (ushort)lVar4;
    if (CONCAT22(uVar6,uVar5) < lVar4) {
      uVar1 = uVar5;
    }
    pTVar2->dpShield = uVar1;
  }
  return;
}



// ======================================================================
// Function: InitFromHuldef
// Address: 10f0:3cba
// Segment: MEMORY_BATTLE
// ======================================================================


short InitFromHuldef(HUL *lphul,short *ppctBC)

{
  uint uVar1;
  HS *pHVar2;
  undefined2 uVar3;
  HULDEF *pHVar4;
  PART part;
  short pctBC;
  short cbc;
  short initBase;
  short pct;
  short i;
  short ihs;
  
  pct = 0;
  cbc = 0;
  pHVar4 = LphuldefFromId(lphul->ihuldef);
  initBase = ((HULDEF *)pHVar4)->wFlags_0x7b & 0x3f;
  ihs = 0;
  while( true ) {
    uVar3 = (undefined2)((ulong)lphul >> 0x10);
    if ((int)(uint)((HUL *)lphul)->chs <= ihs) break;
    pHVar2 = ((HUL *)lphul)->rghs + ihs;
    part.hs.grhst = pHVar2->grhst;
    part.hs.wFlags_0x2 = pHVar2->wFlags_0x2;
    if (part.hs.wFlags_0x2 >> 8 != 0) {
      if ((part.hs.grhst & hstSpecialE) ==
          ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
            hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
        if (((part.hs.grhst & hstBeam) !=
             ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines
               |hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
           ((part.hs.wFlags_0x2 & 0xff) == 0x12)) {
          pctBC = 10;
          for (i = 0; i < (int)(part.hs.wFlags_0x2 >> 8); i = i + 1) {
            pct = pct + ((100 - pct) * 10) / 100;
          }
        }
      }
      else {
        uVar1 = part.hs.wFlags_0x2 & 0xff;
        if (((uVar1 == 5) || (uVar1 == 6)) || (uVar1 == 7)) {
          FLookupPart(&part);
          cbc = cbc + ((part.hs.wFlags_0x2 & 0xff) - 4) * (part.hs.wFlags_0x2 >> 8);
          pctBC = ((ARMOR *)part.u_PART_0x0004.parmor)->dp;
          for (i = 0; i < (int)(part.hs.wFlags_0x2 >> 8); i = i + 1) {
            pct = pct + ((100 - pct) * pctBC) / 100;
          }
        }
      }
    }
    ihs = ihs + 1;
  }
  if (ppctBC != (short *)0x0) {
    *ppctBC = pct;
  }
  initBase = initBase + cbc;
  if (0x3f < initBase) {
    initBase = 0x3f;
  }
  return initBase;
}



// ======================================================================
// Function: CheckInitiative
// Address: 10f0:3e68
// Segment: MEMORY_BATTLE
// ======================================================================


void CheckInitiative(TOK *ptok)

{
  short sVar1;
  short pctBC;
  SHDEF *lpshdef;
  
  lpshdef = LpshdefFromTok(ptok);
  idPlayer = (short)((TOK *)ptok)->iplr;
  sVar1 = InitFromHuldef(&lpshdef->hul,&pctBC);
  ((TOK *)ptok)->initBase = (byte)sVar1;
  idPlayer = -1;
  ((TOK *)ptok)->pctBC = (byte)pctBC;
  return;
}



// ======================================================================
// Function: CheckWeapons
// Address: 10f0:3ec2
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f044a9) */
/* WARNING: Removing unreachable block (ram,0x10f043f1) */

void CheckWeapons(TOK *ptok,short *pfDampeningField,byte *pinit)

{
  byte bVar1;
  TOK *pTVar2;
  SHDEF *pSVar3;
  HS *pHVar4;
  BEAM *pBVar5;
  undefined2 uVar6;
  undefined2 uVar7;
  HullSlotType HVar8;
  SHDEF *lpshdef;
  long lVar9;
  ulong uVar10;
  ulong uVar11;
  ulong uVar12;
  HullSlotType HVar13;
  HS HVar14;
  uint uVar15;
  u_PART_0x0004 local_34;
  short dxyPart;
  HUL *lphul;
  short initBase;
  short dxyLim;
  short initMin;
  short i;
  short dxyMax;
  short init;
  short initMac;
  short ihs;
  ushort ldp;
  int local_8;
  short pctJam;
  
  uVar10 = 1000;
  uVar11 = 1000;
  uVar12 = 10000;
  uVar6 = (undefined2)((ulong)ptok >> 0x10);
  pTVar2 = (TOK *)ptok;
  bVar1 = pTVar2->initBase;
  initMin = -1;
  initMac = -1;
  lpshdef = LpshdefFromTok(ptok);
  dxyMax = -1;
  dxyLim = -1;
  HVar8 = hstSpecialM|hstTorp|hstBeam|hstArmor;
  lVar9 = DpShieldOfShdef(lpshdef,(uint)pTVar2->iplr);
  ihs = 0;
  while( true ) {
    local_8 = (int)((ulong)lVar9 >> 0x10);
    ldp = (ushort)lVar9;
    uVar7 = (undefined2)((ulong)lpshdef >> 0x10);
    pSVar3 = (SHDEF *)lpshdef;
    if ((int)(uint)(pSVar3->hul).chs <= ihs) break;
    if (((((pSVar3->hul).rghs + ihs)->grhst &
         (hstSpecialM|hstSpecialE|hstMining|hstTorp|hstBeam|hstArmor|hstShield|hstScanner)) !=
         ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
           hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
       ((pSVar3->hul).rghs[ihs].wFlags_0x2 >> 8 != 0)) {
      pctJam = 100;
      dxyPart = -1;
      pHVar4 = (pSVar3->hul).rghs + ihs;
      HVar13 = pHVar4->grhst;
      HVar14.wFlags_0x2 = pHVar4->wFlags_0x2;
      HVar14.grhst = HVar13;
      pBVar5 = (BEAM *)local_34.pbeam;
      uVar7 = local_34._2_2_;
      if ((HVar13 & (hstTorp|hstBeam)) ==
          ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
            hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
        init = -1;
      }
      else {
        idPlayer = (short)pTVar2->iplr;
        HVar14.wFlags_0x2 = (ushort)&stack0xffc8;
        HVar14.grhst = HVar8;
        HVar8 = hstSpecialM|hstArmor;
        FLookupPart(&stack0xffc8);
        idPlayer = -1;
        init = (uint)bVar1 + pBVar5->init;
        if (0x3f < init) {
          init = 0x3f;
        }
      }
      HVar13 = HVar14.grhst;
      uVar15 = HVar14.wFlags_0x2;
      if (HVar13 == hstShield) {
        if ((uVar15 & 0xff) == 6) {
          pctJam = 0x5f;
        }
      }
      else if (HVar13 == hstArmor) {
        if ((uVar15 & 0xff) == 9) {
          pctJam = 0x50;
        }
      }
      else if (HVar13 == hstBeam) {
        dxyPart = pBVar5->dRangeMax;
      }
      else if (HVar13 == hstTorp) {
        pTVar2->wFlags = pTVar2->wFlags & 0xfffb | 4;
        dxyPart = pBVar5->dRangeMax;
      }
      else if (HVar13 == hstMining) {
        if ((uVar15 & 0xff) == 6) {
          pctJam = 0x46;
        }
      }
      else if (HVar13 == hstSpecialE) {
        HVar8 = hstSpecialM|hstMining|hstBomb|hstTorp|hstBeam;
        switch(uVar15 & 0xff) {
        case 4:
          pctJam = 0x5a;
          HVar8 = hstSpecialM|hstMining|hstBomb|hstTorp|hstBeam;
          break;
        case 8:
        case 9:
        case 10:
        case 0xb:
          idPlayer = (short)pTVar2->iplr;
          HVar14.wFlags_0x2 = (ushort)&stack0xffc8;
          HVar14.grhst = hstSpecialM|hstMining|hstBomb|hstTorp|hstBeam;
          FLookupPart(&stack0xffc8);
          idPlayer = -1;
          pctJam = 100 - pBVar5->dRangeMax;
          HVar8 = hstSpecialM|hstArmor;
          break;
        case 0xc:
        case 0xd:
          idPlayer = (short)pTVar2->iplr;
          HVar14.wFlags_0x2 = (ushort)&stack0xffc8;
          HVar14.grhst = hstSpecialM|hstMining|hstBomb|hstTorp|hstBeam;
          HVar8 = hstSpecialM|hstArmor;
          FLookupPart(&stack0xffc8);
          idPlayer = -1;
          for (i = HVar14.wFlags_0x2 >> 8; 0 < i; i = i + -1) {
            HVar14.grhst = hstBomb|hstTorp|hstShield;
            HVar14.wFlags_0x2 = 0;
            uVar15 = pBVar5->dRangeMax;
            uVar10 = __aFulmul(uVar10,CONCAT22(((int)uVar15 >> 0xf) +
                                                       (uint)(0xff9b < uVar15),uVar15 + 100));
            HVar8 = hstSpecialM|hstMines|hstBeam|hstArmor;
            uVar10 = __aFldiv(uVar10,(long)HVar14);
          }
          break;
        case 0xe:
          *pfDampeningField = 1;
          HVar8 = hstSpecialM|hstMining|hstBomb|hstTorp|hstBeam;
          break;
        case 0xf:
          pTVar2->wFlags = pTVar2->wFlags & 0xfffd | 2;
        }
      }
      else if ((HVar13 == hstSpecialM) && ((uVar15 & 0xff) == 10)) {
        idPlayer = (short)pTVar2->iplr;
        HVar14.wFlags_0x2 = (ushort)&stack0xffc8;
        HVar14.grhst = HVar8;
        HVar8 = hstSpecialM|hstArmor;
        FLookupPart(&stack0xffc8);
        idPlayer = -1;
        for (i = HVar14.wFlags_0x2 >> 8; 0 < i; i = i + -1) {
          HVar14.grhst = hstBomb|hstTorp|hstShield;
          HVar14.wFlags_0x2 = 0;
          uVar15 = pBVar5->dRangeMax;
          uVar11 = __aFulmul(uVar11,CONCAT22(-(uint)(100 < uVar15) - ((int)uVar15 >> 0xf),
                                                     100 - uVar15));
          HVar8 = hstSpecialM|hstMines|hstBeam|hstArmor;
          uVar11 = __aFldiv(uVar11,(long)HVar14);
        }
      }
      if (pctJam < 100) {
        for (i = HVar14.wFlags_0x2 >> 8; 0 < i; i = i + -1) {
          uVar12 = __aFulmul(uVar12,(long)pctJam);
          HVar8 = hstSpecialM|hstMines|hstBeam|hstArmor;
          uVar12 = __aFldiv(uVar12,100);
        }
      }
      if (dxyPart != -1) {
        if (*&pTVar2->u_TOK_0x0003 == '\x01') {
          dxyPart = dxyPart + 1;
        }
        if ((dxyMax < 0) || (dxyPart < dxyMax)) {
          dxyMax = dxyPart;
        }
        if (dxyLim < dxyPart) {
          dxyLim = dxyPart;
        }
        pinit[init] = 1;
        if ((initMin == -1) || (init < initMin)) {
          initMin = init;
        }
        if (initMac < init) {
          initMac = init;
        }
      }
    }
    ihs = ihs + 1;
  }
  if (uVar12 == 10000) {
    pTVar2->pctJam = 0;
  }
  else {
    lVar9 = __aFldiv(uVar12 + 0x32,100);
    pTVar2->pctJam = 100 - (char)lVar9;
    if (0x5f < pTVar2->pctJam) {
      pTVar2->pctJam = 0x5f;
    }
  }
  if (*&pTVar2->u_TOK_0x0003 == '\x01') {
    pTVar2->pctJam = pTVar2->pctJam - pTVar2->pctJam / 4;
  }
  if (uVar10 != 1000) {
    if (0x9f6 < (long)uVar10) {
      uVar10 = 0x9f6;
    }
    lVar9 = __aFldiv(uVar10,10);
    pTVar2->pctCap = (byte)lVar9;
  }
  lVar9 = __aFldiv(uVar11,10);
  pTVar2->pctBeamDef = (byte)lVar9;
  pTVar2->wFlags_0x19 = pTVar2->wFlags_0x19 & 0xff0f | (dxyMax & 0xfU) << 4;
  pTVar2->wFlags_0x19 = pTVar2->wFlags_0x19 & 0xfff0 | dxyLim & 0xfU;
  pTVar2->initMin = (byte)initMin;
  pTVar2->initMac = (byte)initMac;
  if (local_8 == 0) {
    pTVar2->dpShield = ldp;
  }
  else {
    pTVar2->dpShield = 0xffff;
  }
  return;
}



// ======================================================================
// Function: RandomizeTokOrder
// Address: 10f0:44d4
// Segment: MEMORY_BATTLE
// ======================================================================


void RandomizeTokOrder(void)

{
  TOK *pTVar1;
  ushort *puVar2;
  TOK *pTVar3;
  undefined2 uVar4;
  short sVar5;
  int iVar6;
  int iVar7;
  TOK *pTVar8;
  ushort *puVar9;
  TOK *pTVar10;
  undefined2 unaff_SS;
  short itok;
  short itokSwap;
  ushort tok [16];
  
  for (itok = 0; itok < vctok; itok = itok + 1) {
    sVar5 = Random(vctok - itok);
    uVar4 = vrgtok._2_2_;
    iVar6 = sVar5 + itok;
    if (iVar6 != itok) {
      pTVar8 = (TOK *)vrgtok + iVar6;
      puVar9 = tok;
      for (iVar7 = 0xe; iVar7 != 0; iVar7 = iVar7 + -1) {
        puVar2 = puVar9;
        puVar9 = puVar9 + 1;
        pTVar1 = pTVar8;
        pTVar8 = &pTVar8->iplr;
        *puVar2 = pTVar1->id;
      }
      *(char *)puVar9 = (char)pTVar8->id;
      pTVar8 = (TOK *)vrgtok + itok;
      pTVar10 = (TOK *)vrgtok + iVar6;
      for (iVar6 = 0xe; iVar6 != 0; iVar6 = iVar6 + -1) {
        pTVar3 = pTVar10;
        pTVar10 = &pTVar10->iplr;
        pTVar1 = pTVar8;
        pTVar8 = &pTVar8->iplr;
        pTVar3->id = pTVar1->id;
      }
      *&pTVar10->id = (char)pTVar8->id;
      uVar4 = vrgtok._2_2_;
      pTVar8 = (TOK *)vrgtok + itok;
      puVar9 = tok;
      for (iVar6 = 0xe; iVar6 != 0; iVar6 = iVar6 + -1) {
        pTVar1 = pTVar8;
        pTVar8 = &pTVar8->iplr;
        puVar2 = puVar9;
        puVar9 = puVar9 + 1;
        pTVar1->id = *puVar2;
      }
      *&pTVar8->id = (char)*puVar9;
    }
  }
  return;
}



// ======================================================================
// Function: InitializeBoard
// Address: 10f0:45b4
// Segment: MEMORY_BATTLE
// ======================================================================


void InitializeBoard
          (FLEET *lpfl,short ibrc,ushort grfPlayer,byte *pinit,short *pinitMin,short *pinitMac)

{
  TOK *pTVar1;
  ushort *puVar2;
  PLANET *pPVar3;
  short sVar4;
  int iVar5;
  uint uVar6;
  FLEET *pFVar7;
  TOK *pTVar8;
  TOK *pTVar9;
  ushort *puVar10;
  undefined2 uVar11;
  undefined2 uVar12;
  byte rgfTorp [16];
  short ishdef;
  short fDumpCargo;
  byte mpiplrdibrc [16];
  TOK *ptokT;
  ushort *lpwtCargoCur;
  undefined2 local_1a;
  short initMin;
  short fDampeningField;
  PLANET *lppl;
  short initMac;
  TOK *ptok;
  FLEET *lpflCur;
  short iplr;
  
  initMin = -1;
  initMac = -1;
  fDampeningField = 0;
  lpwtCargoCur = (ushort *)vlpwtCargo;
  local_1a = vlpwtCargo._2_2_;
  ishdef = 0;
  _memset(mpiplrdibrc,0xff,0x10);
  for (iplr = 0; iplr < game.cPlayer; iplr = iplr + 1) {
    if ((1 << ((byte)iplr & 0x1f) & grfPlayer) != 0) {
      mpiplrdibrc[iplr] = (byte)ishdef;
      ishdef = ishdef + 1;
    }
  }
  _memset(rgfTorp,0,0x10);
  lpflCur = lpfl;
  ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
  if (((FLEET *)lpfl)->idPlanet != -1) {
    lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
    uVar11 = (undefined2)((ulong)lppl >> 0x10);
    pPVar3 = (PLANET *)lppl;
    iplr = pPVar3->iPlayer;
    if (((iplr != -1) && ((pPVar3->wFlags_0x4 >> 9 & 1) != 0)) &&
       ((1 << ((byte)iplr & 0x1f) & grfPlayer) != 0)) {
      uVar12 = (undefined2)((ulong)ptok >> 0x10);
      pTVar8 = (TOK *)ptok;
      *&pTVar8->u_TOK_0x0003 = 1;
      *(uint *)((int)&pPVar3->lStarbase + 2) =
           *(uint *)((int)&pPVar3->lStarbase + 2) & 0xbfff | 0x4000;
      pTVar8->brc = *(byte *)((uint)mpiplrdibrc[iplr] + ibrc);
      ptok->id = lppl->id;
      pTVar8->iplr = (byte)iplr;
      pTVar8->csh = 1;
      *(char *)((int)&pTVar8->u_TOK_0x0003 + 1) = ((byte)(int)pPVar3->lStarbase & 0xf) + 0x10;
      CheckInitiative(ptok);
      CheckWeapons(ptok,&fDampeningField,pinit);
      rgfTorp[iplr] = rgfTorp[iplr] | (byte)(((TOK *)ptok)->wFlags >> 2) & 1;
      uVar11 = (undefined2)((ulong)ptok >> 0x10);
      pTVar8 = (TOK *)ptok;
      if (pTVar8->initBase == 0xff) {
        pTVar8->wFlags_0x17 = pTVar8->wFlags_0x17 & 0xfff | 0x5000;
      }
      else {
        pTVar8->wFlags_0x17 = pTVar8->wFlags_0x17 & 0xfff | 0x3000;
      }
      pTVar8->wFlags_0x17 = pTVar8->wFlags_0x17 & 0xfff0 | 1;
      pTVar8->wFlags_0x17 = pTVar8->wFlags_0x17 & 0xff0f | 0x10;
      (&pTVar8->dv)->dp =
           (&pTVar8->dv)->dp & 0x7f | (*(uint *)&((PLANET *)lppl)->lStarbase >> 4) << 7;
      pTVar8->wFlags_0x17 = pTVar8->wFlags_0x17 & 0xf0ff | 0x500;
      if ((&pTVar8->dv)->dp >> 7 != 0) {
        (&pTVar8->dv)->dp = (&pTVar8->dv)->dp & 0xff80 | 100;
      }
      pTVar8->wFlags_0x19 = pTVar8->wFlags_0x19 & 0xf0ff;
      pTVar8->wt = 0xffff;
      ptok = (TOK *)CONCAT22(uVar11,pTVar8 + 1);
    }
  }
  do {
    uVar11 = (undefined2)((ulong)lpflCur >> 0x10);
    pFVar7 = (FLEET *)lpflCur;
    if ((pFVar7->wFlags_0x4 >> 10 & 1) == 0) {
      if ((*(uint *)((int)&pFVar7->dirLong + 2) >> 7 & 1) == 0) {
        if ((pFVar7->wFlags_0x4 >> 8 & 1) != 0) {
          pFVar7->wFlags_0x4 = pFVar7->wFlags_0x4 & 0xbfff | 0x4000;
          iplr = pFVar7->iPlayer;
          fDumpCargo = FDumpCargo(lpflCur);
          for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
            if (((FLEET *)lpflCur)->rgcsh[ishdef] != 0) {
              uVar11 = (undefined2)((ulong)ptok >> 0x10);
              pTVar8 = (TOK *)ptok;
              *&pTVar8->u_TOK_0x0003 = 2;
              pTVar8->brc = *(byte *)((uint)mpiplrdibrc[iplr] + ibrc);
              ptok->id = lpflCur->id;
              pTVar8->iplr = (byte)((uint)lpflCur->id >> 9) & 0xf;
              *(undefined1 *)((int)&pTVar8->u_TOK_0x0003 + 1) = (char)ishdef;
              pTVar8->csh = ((FLEET *)lpflCur)->rgcsh[ishdef];
              (&pTVar8->dv)->dp = ((FLEET *)lpflCur)->rgcsh[ishdef + 0x10];
              CheckInitiative(ptok);
              CheckWeapons(ptok,&fDampeningField,pinit);
              rgfTorp[iplr] = rgfTorp[iplr] | (byte)(((TOK *)ptok)->wFlags >> 2) & 1;
              CheckTarget(ptok,lpflCur,ishdef);
              uVar6 = SpdOfShip(lpflCur,ishdef,ptok,fDumpCargo,(SHDEF *)0x0);
              uVar11 = (undefined2)((ulong)ptok >> 0x10);
              pTVar8 = (TOK *)ptok;
              pTVar8->wFlags_0x19 = pTVar8->wFlags_0x19 & 0xf0ff | (uVar6 & 0xf) << 8;
              ptok = (TOK *)CONCAT22(uVar11,pTVar8 + 1);
              if (0xff < ((int)(pTVar8 + 1) - (int)(TOK *)vrgtok) / 0x1d)
              goto BATTLE_LTooManyTokens;
            }
          }
        }
      }
      else {
        grfMissed = grfMissed | 1 << ((byte)pFVar7->iPlayer & 0x1f);
      }
    }
    uVar11 = (undefined2)((ulong)lpflCur >> 0x10);
                    /* WARNING: Load size is inaccurate */
    lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                ((FLEET *)lpflCur)->lpflNext);
  } while (lpfl != lpflCur);
BATTLE_LTooManyTokens:
  vctok = ((int)(TOK *)ptok - (int)(TOK *)vrgtok) / 0x1d;
  RandomizeTokOrder();
  ptokT = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
  while( true ) {
    if ((TOK *)ptok <= (TOK *)ptokT) break;
    uVar11 = (undefined2)((ulong)ptokT >> 0x10);
    ((TOK *)ptokT)->wFlags = ((TOK *)ptokT)->wFlags & 0xffef | 0x10;
    ((TOK *)ptokT)->wFlags = ((TOK *)ptokT)->wFlags & 0xfffe | 1;
    if (((TOK *)ptokT)->initMin == 0xff) {
      ((TOK *)ptokT)->wFlags_0x17 = ((TOK *)ptokT)->wFlags_0x17 & 0xfff0;
    }
    if ((((TOK *)ptokT)->dpShield == 0) ||
       (sVar4 = GetRaceGrbit((PLAYER *)rgplr + ((TOK *)ptokT)->iplr,
                                   ibitRaceRegeneratingShields), sVar4 == 0)) {
      iVar5 = 0;
    }
    else {
      iVar5 = 1;
    }
    uVar11 = (undefined2)((ulong)ptokT >> 0x10);
    pTVar8 = (TOK *)ptokT;
    pTVar8->wFlags = pTVar8->wFlags & 0xfff7 | iVar5 << 3;
    if ((fDampeningField != 0) && (*&pTVar8->u_TOK_0x0003 != '\x01')) {
      if ((int)((pTVar8->wFlags_0x19 >> 8 & 0xf) - 4) < 1) {
        uVar6 = 0;
      }
      else {
        uVar6 = (pTVar8->wFlags_0x19 >> 8 & 0xf) - 4;
      }
      pTVar8->wFlags_0x19 = pTVar8->wFlags_0x19 & 0xf0ff | (uVar6 & 0xf) << 8;
    }
    uVar12 = (undefined2)((ulong)lpbBattleCur >> 0x10);
    puVar10 = (ushort *)lpbBattleCur;
    pTVar9 = pTVar8;
    for (iVar5 = 0xe; iVar5 != 0; iVar5 = iVar5 + -1) {
      puVar2 = puVar10;
      puVar10 = puVar10 + 1;
      pTVar1 = pTVar9;
      pTVar9 = &pTVar9->iplr;
      *puVar2 = pTVar1->id;
    }
    *(byte *)puVar10 = (byte)pTVar9->id;
    lpbBattleCur = (byte *)lpbBattleCur + 0x1d;
    if ((pTVar8->initMin != 0xff) && ((initMin == -1 || ((int)(uint)pTVar8->initMin < initMin)))) {
      initMin = (short)pTVar8->initMin;
    }
    if ((pTVar8->initMac != 0xff) && ((initMac == -1 || (initMac < (int)(uint)pTVar8->initMac)))) {
      initMac = (short)pTVar8->initMac;
    }
    ptokT = (TOK *)CONCAT22(uVar11,pTVar8 + 1);
  }
  *pinitMin = initMin & 0xff;
  *pinitMac = initMac & 0xff;
  return;
}



// ======================================================================
// Function: DzFromBrcBrc
// Address: 10f0:4ca8
// Segment: MEMORY_BATTLE
// ======================================================================


short DzFromBrcBrc(byte brc1,byte brc2)

{
  short sVar1;
  short sVar2;
  short dx;
  short dy;
  
  sVar1 = _abs((brc1 & 0xf) - (brc2 & 0xf));
  sVar2 = _abs(((int)(uint)brc1 >> 4) - ((int)(uint)brc2 >> 4));
  if (sVar1 <= sVar2) {
    sVar1 = sVar2;
  }
  return sVar1;
}



// ======================================================================
// Function: DpFromPtokBrcToBrc
// Address: 10f0:4d2e
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f04fe7) */
/* WARNING: Removing unreachable block (ram,0x10f0522e) */
/* WARNING: Removing unreachable block (ram,0x10f052e6) */

long DpFromPtokBrcToBrc(TOK *ptok,byte brcSrc,byte brcTarget,TOK *ptokTarget,short fProximity)

{
  ulong uVar1;
  bool bVar2;
  uint uVar3;
  uint uVar4;
  uint uVar5;
  uint uVar6;
  int iVar7;
  SHDEF *pSVar8;
  HS *pHVar9;
  undefined2 uVar10;
  SHDEF *pSVar11;
  long lVar12;
  ulong uVar13;
  HS HVar14;
  HS HVar15;
  ulong uVar16;
  ulong uVar17;
  long lVar18;
  ulong uVar19;
  long lVar20;
  u_PART_0x0004 in_stack_0000ffd2;
  HUL *lphul;
  short fOutOfRange;
  short ihs;
  short dz;
  
  uVar3 = DzFromBrcBrc(brcSrc,brcTarget);
  uVar1 = 0;
  if ((fProximity == 0) && ((int)(((TOK *)ptok)->wFlags_0x19 & 0xf) < (int)uVar3)) {
    uVar17 = 0;
  }
  else {
    pSVar11 = LpshdefFromTok(ptok);
    ihs = 0;
    while( true ) {
      uVar10 = (undefined2)((ulong)pSVar11 >> 0x10);
      pSVar8 = (SHDEF *)pSVar11;
      if ((int)(uint)(pSVar8->hul).chs <= ihs) break;
      if (((((pSVar8->hul).rghs + ihs)->grhst & (hstTorp|hstBeam)) !=
           ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
             hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
         ((pSVar8->hul).rghs[ihs].wFlags_0x2 >> 8 != 0)) {
        pHVar9 = (pSVar8->hul).rghs + ihs;
        HVar15.wFlags_0x2 = pHVar9->wFlags_0x2;
        HVar15.grhst = pHVar9->grhst;
        idPlayer = (short)((TOK *)ptok)->iplr;
        FLookupPart(&stack0xffce);
        idPlayer = -1;
        uVar4 = (uint)(*&((TOK *)ptok)->u_TOK_0x0003 == '\x01') +
                ((BEAM *)in_stack_0000ffd2.pbeam)->dRangeMax;
        iVar7 = (int)uVar4 >> 0xf;
        if (((int)uVar3 >> 0xf < iVar7) || (((int)uVar3 >> 0xf <= iVar7 && (uVar3 <= uVar4)))) {
          bVar2 = false;
        }
        else {
          bVar2 = true;
        }
        if ((!bVar2) || (fProximity != 0)) {
          uVar16 = __aFulmul((long)((BEAM *)in_stack_0000ffd2.pbeam)->dp,
                                     (ulong)HVar15 >> 0x18);
          if (HVar15.grhst == hstBeam) {
            if (((TOK *)ptok)->pctCap != 0) {
              lVar12 = 100;
              uVar16 = __aFulmul(uVar16,(ulong)((TOK *)ptok)->pctCap);
              uVar16 = __aFldiv(uVar16,lVar12);
            }
            uVar6 = HVar15.wFlags_0x2;
            if (((0 < (int)uVar3) && (-1 < iVar7)) && ((0 < iVar7 || (uVar4 != 0)))) {
              lVar18 = (long)(int)uVar4;
              lVar12 = 10;
              uVar17 = __aFulmul(uVar16,(long)(int)uVar3);
              lVar12 = __aFldiv(uVar17,lVar12);
              lVar12 = __aFldiv(lVar12,lVar18);
              uVar16 = uVar16 - lVar12;
            }
            if (((TOK *)ptokTarget)->pctBeamDef < 100) {
              lVar12 = 100;
              uVar16 = __aFulmul(uVar16,(ulong)((TOK *)ptokTarget)->pctBeamDef);
              uVar16 = __aFldiv(uVar16,lVar12);
            }
            if (((((BEAM *)in_stack_0000ffd2.pbeam)->grfAbilities & 1U) != 0) &&
               (uVar17 = __aFulmul((ulong)((TOK *)ptokTarget)->dpShield,
                                           (ulong)((TOK *)ptok)->csh), (long)uVar17 < (long)uVar16))
            {
              uVar16 = uVar17;
            }
            if (bVar2) {
              uVar5 = uVar3 + 10;
              uVar16 = __aFldiv(uVar16,CONCAT22((((int)uVar5 >> 0xf) - iVar7) -
                                                        (uint)(uVar5 < uVar4),uVar5 - uVar4));
              if (((long)uVar16 < 0x10000) && (((long)uVar16 < 0 || ((uint)uVar16 < uVar6 >> 8)))) {
                uVar16 = (ulong)(uVar6 >> 8);
              }
            }
            uVar16 = __aFulmul(uVar16,(ulong)((TOK *)ptok)->csh);
            uVar1 = uVar16 + uVar1;
          }
          else if (HVar15.grhst == hstTorp) {
            uVar17 = 200;
            uVar16 = __aFulmul((ulong)HVar15 >> 0x18,(ulong)((TOK *)ptok)->csh);
            uVar16 = __aFulmul(uVar16,uVar17);
            uVar17 = CTorpHit(uVar16,ptokTarget,((BEAM *)in_stack_0000ffd2.pbeam)->grfAbilities,
                              (uint)((TOK *)ptok)->pctBC);
            in_stack_0000ffd2 = (u_PART_0x0004)0xc8;
            uVar13 = __aFulmul((long)iRam000000fe,uVar17);
            HVar14 = (HS)__aFldiv(uVar13,(long)in_stack_0000ffd2);
            if (((TOK *)ptokTarget)->dpShield != 0) {
              in_stack_0000ffd2 = (u_PART_0x0004)0x640;
              uVar16 = __aFulmul(uVar16 - uVar17,(long)iRam00000676);
              lVar12 = __aFldiv(uVar16,(long)in_stack_0000ffd2);
              HVar14 = (HS)(lVar12 + (long)HVar14);
            }
            if (bVar2) {
              uVar6 = uVar3 + 10;
              in_stack_0000ffd2._2_2_ = (((int)uVar6 >> 0xf) - iVar7) - (uint)(uVar6 < uVar4);
              in_stack_0000ffd2.parmor._0_2_ = (ARMOR *)(uVar6 - uVar4);
              HVar15 = (HS)__aFldiv((long)HVar14,(long)in_stack_0000ffd2);
              uVar4 = HVar14.wFlags_0x2;
              HVar14 = HVar15;
              if (((long)HVar15 < 0x10000) && (((long)HVar15 < 0 || (HVar15.grhst < uVar4 >> 8)))) {
                HVar14.wFlags_0x2 = 0;
                HVar14.grhst = uVar4 >> 8;
              }
            }
            uVar1 = uVar1 + (long)HVar14;
          }
        }
      }
      ihs = ihs + 1;
    }
    pSVar11 = LpshdefFromTok(ptokTarget);
    uVar3 = (((SHDEF *)pSVar11)->hul).dp;
    uVar16 = __aFulmul((ulong)CONCAT12(CARRY2(((TOK *)ptokTarget)->dpShield,uVar3),
                                               ((TOK *)ptokTarget)->dpShield + uVar3),
                               (ulong)((TOK *)ptokTarget)->csh);
    iVar7 = (int)uVar16;
    if (((&((TOK *)ptokTarget)->dv)->dp != 0) && (0 < (long)uVar16)) {
      lVar20 = 500;
      uVar19 = (ulong)((TOK *)ptokTarget)->csh;
      lVar18 = 10;
      uVar13 = (ulong)(&((TOK *)ptokTarget)->dv)->dp & 0xffff007f;
      lVar12 = 10;
      uVar17 = __aFulmul((ulong)uVar3,(ulong)((&((TOK *)ptokTarget)->dv)->dp >> 7));
      uVar17 = __aFldiv(uVar17,lVar12);
      uVar17 = __aFulmul(uVar17,uVar13);
      uVar17 = __aFldiv(uVar17,lVar18);
      uVar17 = __aFulmul(uVar17,uVar19);
      lVar18 = __aFldiv(uVar17,lVar20);
      lVar12 = uVar16 - lVar18;
      uVar17 = uVar16 - lVar18;
      uVar16 = uVar16 - lVar18;
      if (((int)((ulong)lVar12 >> 0x10) < 1) &&
         ((lVar12 < 0 || (uVar16 = uVar17, iVar7 == (int)lVar18)))) {
        uVar16 = 1;
      }
    }
    uVar17 = uVar1;
    if (((long)uVar16 < (long)uVar1) && (uVar17 = uVar16, fProximity != 0)) {
      uVar17 = uVar1;
    }
  }
  return uVar17;
}



// ======================================================================
// Function: DzMoveRangeToConsider
// Address: 10f0:5312
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f056af) */

short DzMoveRangeToConsider(TOK *ptok,ushort grfAttack,byte *pbrc)

{
  byte bVar1;
  short sVar2;
  uint uVar3;
  TOK *pTVar4;
  HUL *pHVar5;
  BEAM *pBVar6;
  undefined2 uVar7;
  undefined2 uVar8;
  long lVar9;
  PART part;
  HUL *lphul;
  undefined4 lpshdef;
  short ihs;
  byte brcCur;
  short dzMax;
  TOK *ptokTarget;
  short iplrTarget;
  short itokLook;
  byte dzBest;
  ushort mdTarget;
  short iplr;
  byte dz;
  short dzNonSapper;
  
  uVar7 = (undefined2)((ulong)ptok >> 0x10);
  pTVar4 = (TOK *)ptok;
  brcCur = pTVar4->brc;
  dzMax = (pTVar4->wFlags_0x19 & 0xf) + (pTVar4->wFlags >> 0xe);
  sVar2 = FDoesPrimaryTargetTypeExist(ptok,grfAttack);
  if (sVar2 == 0) {
    uVar3 = pTVar4->wFlags_0x17 >> 4;
  }
  else {
    uVar3 = pTVar4->wFlags_0x17;
  }
  mdTarget = uVar3 & 0xf;
  iplr = (short)pTVar4->iplr;
  dzBest = 10;
  *pbrc = 0xff;
  if ((pTVar4->wFlags_0x19 & 0xf) == 3) {
    dzNonSapper = -1;
    lphul = &LpshdefFromTok(ptok)->hul;
    ihs = 0;
    lpshdef = lphul;
    while( true ) {
      uVar8 = (undefined2)((ulong)lphul >> 0x10);
      pHVar5 = (HUL *)lphul;
      if ((int)(uint)pHVar5->chs <= ihs) break;
      if (((pHVar5->rghs + ihs)->grhst == hstBeam) && (pHVar5->rghs[ihs].wFlags_0x2 >> 8 != 0)) {
        part.hs.grhst = (pHVar5->rghs + ihs)->grhst;
        part.hs.wFlags_0x2 = pHVar5->rghs[ihs].wFlags_0x2;
        idPlayer = (short)pTVar4->iplr;
        FLookupPart(&part);
        idPlayer = -1;
        uVar8 = part.u_PART_0x0004._2_2_;
        pBVar6 = (BEAM *)part.u_PART_0x0004.pbeam;
        if (((pBVar6->grfAbilities & 1U) == 0) && (dzNonSapper < pBVar6->dRangeMax)) {
          dzNonSapper = pBVar6->dRangeMax;
        }
      }
      ihs = ihs + 1;
    }
  }
  else {
    dzNonSapper = pTVar4->wFlags_0x19 & 0xf;
  }
  if (((pTVar4->wFlags_0x19 >> 4 & 0xf) < (pTVar4->wFlags_0x19 & 0xf)) &&
     (((pTVar4->wFlags_0x17 >> 8 & 0xf) == 5 || ((pTVar4->wFlags_0x17 >> 8 & 0xf) == 3)))) {
    dzMax = (pTVar4->wFlags_0x19 >> 4 & 0xf) + (pTVar4->wFlags >> 0xe);
  }
  ptokTarget = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
  itokLook = 0;
  do {
    if (vctok <= itokLook) {
      return 1;
    }
    uVar8 = (undefined2)((ulong)ptokTarget >> 0x10);
    bVar1 = ((TOK *)ptokTarget)->iplr;
    iplrTarget = (short)bVar1;
    if (((iplrTarget != iplr) && ((1 << (bVar1 & 0x1f) & grfAttack) != 0)) &&
       ((((TOK *)ptokTarget)->wFlags & 1) != 0)) {
      sVar2 = FIsTargetOfMdTarget(ptokTarget,mdTarget);
      if (sVar2 != 0) {
        sVar2 = DzFromBrcBrc(brcCur,((TOK *)ptokTarget)->brc);
        dz = (byte)sVar2;
        uVar8 = (undefined2)((ulong)ptokTarget >> 0x10);
        if (pTVar4->wFlags >> 0xe <= ((TOK *)ptokTarget)->wFlags >> 0xe) {
          dz = dz + 1;
        }
        if (((int)(uint)dz <= dzMax) &&
           (((((TOK *)ptokTarget)->dpShield != 0 || (dzNonSapper == (pTVar4->wFlags_0x19 & 0xf))) ||
            ((uint)dz <= dzNonSapper + (pTVar4->wFlags >> 0xe))))) {
          *pbrc = 0xff;
          return pTVar4->wFlags >> 0xe;
        }
        ihs = (short)dz;
        if ((uint)ihs < (uint)dzBest) {
          lVar9 = DpFromPtokBrcToBrc(ptok,0,0,ptokTarget,0);
          if (0 < lVar9) {
            dzBest = dz;
            *pbrc = ((TOK *)ptokTarget)->brc;
          }
        }
      }
    }
    itokLook = itokLook + 1;
    ptokTarget = (TOK *)ptokTarget + 1;
  } while( true );
}



// ======================================================================
// Function: FDoesPrimaryTargetTypeExist
// Address: 10f0:56d8
// Segment: MEMORY_BATTLE
// ======================================================================


short FDoesPrimaryTargetTypeExist(TOK *ptok,ushort grfAttack)

{
  TOK *pTVar1;
  ushort *puVar2;
  int iVar3;
  TOK *pTVar4;
  ushort *puVar5;
  undefined2 uVar6;
  undefined2 unaff_SS;
  short itokLook;
  ushort tok;
  char local_25;
  uint local_11;
  uint local_d;
  short iplrLook;
  short iplr;
  ushort mdTarget;
  
  uVar6 = (undefined2)((ulong)ptok >> 0x10);
  iplr = (short)((TOK *)ptok)->iplr;
  mdTarget = ((TOK *)ptok)->wFlags_0x17 & 0xf;
  if (mdTarget != 0) {
    for (itokLook = 0; itokLook < vctok; itokLook = itokLook + 1) {
      if (((uint)((TOK *)vrgtok)[itokLook].iplr != iplr) &&
         ((1 << (((TOK *)vrgtok)[itokLook].iplr & 0x1f) & grfAttack) != 0)) {
        pTVar4 = (TOK *)vrgtok + itokLook;
        puVar5 = &tok;
        for (iVar3 = 0xe; iVar3 != 0; iVar3 = iVar3 + -1) {
          puVar2 = puVar5;
          puVar5 = puVar5 + 1;
          pTVar1 = pTVar4;
          pTVar4 = &pTVar4->iplr;
          *puVar2 = pTVar1->id;
        }
        *(char *)puVar5 = (char)pTVar4->id;
        if ((local_d & 1) != 0) {
          switch(mdTarget) {
          case 1:
            goto LAB_10f0_5873;
          case 2:
            if (local_25 == '\x01') {
              return 1;
            }
            break;
          case 3:
          case 4:
          case 5:
          case 6:
          case 7:
            if (mdTarget == 3) {
LAB_10f0_5790:
              if (local_11 >> 0xc == mdTarget) {
LAB_10f0_5873:
                return 1;
              }
            }
            else if (mdTarget == 4) {
              if (local_11 >> 0xc == 4) {
                return 1;
              }
              if (local_11 >> 0xc == 7) {
                return 1;
              }
            }
            else {
              if (mdTarget != 5) {
                if ((mdTarget != 6) && (mdTarget != 7)) {
                  return 1;
                }
                goto LAB_10f0_5790;
              }
              if (4 < local_11 >> 0xc) {
                return 1;
              }
            }
          }
        }
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: FIsTargetOfMdTarget
// Address: 10f0:587a
// Segment: MEMORY_BATTLE
// ======================================================================


short FIsTargetOfMdTarget(TOK *ptok,short mdTarget)

{
  uint uVar1;
  TOK *pTVar2;
  undefined2 uVar3;
  
  pTVar2 = (TOK *)ptok;
  uVar3 = (undefined2)((ulong)ptok >> 0x10);
  switch(mdTarget) {
  default:
    uVar1 = 0;
    break;
  case 1:
    uVar1 = 1;
    break;
  case 2:
    uVar1 = (uint)(*&pTVar2->u_TOK_0x0003 == '\x01');
    break;
  case 3:
  case 6:
  case 7:
    uVar1 = (uint)(pTVar2->wFlags_0x17 >> 0xc == mdTarget);
    break;
  case 4:
    if ((pTVar2->wFlags_0x17 >> 0xc == 4) || (pTVar2->wFlags_0x17 >> 0xc == 7)) {
      uVar1 = 1;
    }
    else {
      uVar1 = 0;
    }
    break;
  case 5:
    if (((pTVar2->wFlags_0x17 >> 0xc == 5) || (pTVar2->wFlags_0x17 >> 0xc == 7)) ||
       (pTVar2->wFlags_0x17 >> 0xc == 6)) {
      uVar1 = 1;
    }
    else {
      uVar1 = 0;
    }
  }
  return uVar1;
}



// ======================================================================
// Function: ScoreGuessBattleDamage
// Address: 10f0:598c
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: itok */
/* WARNING: Variable defined which should be unmapped: dMin */
/* WARNING: Variable defined which should be unmapped: xCur */
/* WARNING: Removing unreachable block (ram,0x10f05d83) */
/* WARNING: Removing unreachable block (ram,0x10f05dd7) */

long ScoreGuessBattleDamage(TOK *ptokSrc,byte brc,short fPrimary,ushort grfAttack)

{
  byte bVar1;
  uint uVar2;
  short sVar3;
  TOK *pTVar4;
  TOK *pTVar5;
  undefined2 uVar6;
  undefined2 uVar7;
  long dpTake;
  long lVar8;
  ulong local_58;
  short itok;
  short dMin;
  short x;
  short xCur;
  short fWeAttack;
  byte iplrSrc;
  short dMax;
  byte brcEnemy;
  uint rgx [2];
  short dzCur;
  undefined4 scoreThem;
  undefined4 scoreThemBest;
  undefined4 dpTaken;
  short yCur;
  short xEnemy;
  short i;
  undefined4 dpGivenCur;
  long dpTakenTotal;
  short y;
  undefined4 dpTakenBest;
  long dpGivenBest;
  short dzEnemy;
  short yEnemy;
  TOK *ptok;
  uint rgy [2];
  short dMoves;
  short iBest;
  
  lVar8 = CONCAT22(scoreThem._2_2_,(undefined2)scoreThem);
  uVar6 = (undefined2)((ulong)ptokSrc >> 0x10);
  pTVar4 = (TOK *)ptokSrc;
  bVar1 = pTVar4->iplr;
  yCur = (int)(uint)pTVar4->brc >> 4;
  dpGivenBest = 0;
  dpTakenTotal = 0;
  ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
  for (itok = 0; scoreThem = lVar8, itok < vctok; itok = itok + 1) {
    uVar7 = (undefined2)((ulong)ptok >> 0x10);
    pTVar5 = (TOK *)ptok;
    if ((((pTVar5->wFlags & 1) != 0) &&
        (local_58 = CONCAT22(itok,(uint)bVar1), (uint)bVar1 != (uint)pTVar5->iplr)) &&
       ((1 << (pTVar5->iplr & 0x1f) & grfAttack) != 0)) {
      dMax = DzFromBrcBrc(pTVar5->brc,brc);
      dzCur = dMax;
      uVar7 = (undefined2)((ulong)ptok >> 0x10);
      pTVar5 = (TOK *)ptok;
      dMoves = (short)(pTVar4->wFlags >> 0xe <= pTVar5->wFlags >> 0xe);
      dMin = dMax;
      if (dMoves != 0) {
        if ((uint)(dMax - dMoves) < 0x8000) {
          dMin = dMax - dMoves;
        }
        else {
          dMin = 0;
        }
        xEnemy = pTVar5->brc & 0xf;
        yEnemy = (int)(uint)pTVar5->brc >> 4;
        rgx[0] = xEnemy - dMoves;
        rgx[1] = xEnemy + dMoves;
        rgy[0] = yEnemy - dMoves;
        rgy[1] = yEnemy + dMoves;
        for (x = 0; x < 2; x = x + 1) {
          for (y = 0; y < 2; y = y + 1) {
            if (rgx[x] < 0x8000) {
              uVar2 = rgx[x];
            }
            else {
              uVar2 = 0;
            }
            if ((int)uVar2 < 10) {
              if (rgx[x] < 0x8000) {
                uVar2 = rgx[x];
              }
              else {
                uVar2 = 0;
              }
            }
            else {
              uVar2 = 9;
            }
            local_58 = CONCAT22(itok,uVar2) & 0xffff000f;
            if (rgy[y] < 0x8000) {
              uVar2 = rgy[y];
            }
            else {
              uVar2 = 0;
            }
            if ((int)uVar2 < 10) {
              if (rgy[y] < 0x8000) {
                uVar2 = rgy[y];
              }
              else {
                uVar2 = 0;
              }
            }
            else {
              uVar2 = 9;
            }
            dzEnemy = DzFromBrcBrc(brc,(byte)((uVar2 & 0xf) << 4) | (byte)local_58);
            sVar3 = dzEnemy;
            if (dzEnemy <= dMax) {
              sVar3 = dMax;
            }
            dMax = sVar3;
          }
        }
      }
      if (fPrimary == 0) {
        uVar2 = pTVar4->wFlags_0x17 >> 4;
      }
      else {
        uVar2 = pTVar4->wFlags_0x17;
      }
      sVar3 = FIsTargetOfMdTarget(ptok,uVar2 & 0xf);
      scoreThemBest = 30000000;
      iBest = dMin;
      lVar8 = scoreThem;
      for (i = dMin; i <= dMax; i = i + 1) {
        scoreThem = lVar8;
        if (sVar3 == 0) {
          dpTake = 0;
        }
        else {
          dpTake = DpFromPtokBrcToBrc(ptokSrc,0,(byte)((i & 0xfU) << 4),ptok,0);
        }
        local_58 = DpFromPtokBrcToBrc(ptok,0,(byte)((i & 0xfU) << 4),ptokSrc,
                                      (uint)((pTVar4->wFlags_0x17 >> 8 & 0xf) == 0));
        dpTaken = local_58;
        lVar8 = ScoreFromGiveAndTakeAndTactic(local_58,dpTake,((TOK *)ptok)->wFlags_0x17 >> 8 & 0xf)
        ;
        if (lVar8 <= scoreThemBest) {
          iBest = i;
          scoreThemBest = lVar8;
          dpGivenCur = dpTake;
          dpTakenBest = dpTaken;
        }
      }
      if (dpGivenBest < dpGivenCur) {
        dpGivenBest = dpGivenCur;
      }
      dpTakenTotal = dpTakenBest + dpTakenTotal;
    }
    ptok = (TOK *)ptok + 1;
  }
  lVar8 = ScoreFromGiveAndTakeAndTactic(dpGivenBest,dpTakenTotal,pTVar4->wFlags_0x17 >> 8 & 0xf);
  return lVar8;
}



// ======================================================================
// Function: ScoreFromGiveAndTakeAndTactic
// Address: 10f0:5e34
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f05ecc) */

long ScoreFromGiveAndTakeAndTactic(long dpGive,long dpTake,short mdTactic)

{
  int iVar1;
  ulong uVar2;
  long lVar3;
  
  switch(mdTactic) {
  case 0:
  case 2:
    break;
  case 1:
  case 5:
    dpTake = CONCAT22(-(dpGive._2_2_ + (uint)((int)dpGive != 0)),-(int)dpGive);
    break;
  case 3:
  case 4:
    iVar1 = -(dpGive._2_2_ + (uint)((int)dpGive != 0));
    if ((-(int)dpGive != 0) || (iVar1 != 0)) {
      lVar3 = dpTake + 1;
      uVar2 = __aFulmul(CONCAT22(iVar1,-(int)dpGive),100);
      dpTake = __aFldiv(uVar2,lVar3);
      if (-1 < dpTake) {
        dpTake = -1;
      }
    }
    break;
  default:
    dpTake = 0;
  }
  return dpTake;
}



// ======================================================================
// Function: DxyMoveTokTo
// Address: 10f0:5f18
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f061dc) */

short DxyMoveTokTo(TOK *ptok,short spdMove,ushort grfAttack)

{
  uint uVar1;
  uint uVar2;
  short sVar3;
  short sVar4;
  TOK *pTVar5;
  undefined2 uVar6;
  long lVar7;
  int local_64;
  short cLow;
  uint lLow;
  short fXMajor;
  short x;
  short dzAway;
  undefined2 dp;
  undefined2 local_56;
  short fPrimary;
  short xCur;
  short dx;
  short yMax;
  short dzAwayBest;
  byte brcBest;
  short yCur;
  short i;
  byte brcOOR;
  short y;
  short mdTactic;
  short dy;
  short yMin;
  short cBest;
  undefined4 score;
  uint rgscoreNear [18];
  byte brc;
  undefined4 scoreBest;
  short dz;
  short xMax;
  ushort iplr;
  
  uVar6 = (undefined2)((ulong)ptok >> 0x10);
  pTVar5 = (TOK *)ptok;
  iplr = (ushort)pTVar5->iplr;
  dp = 0;
  local_56 = 0;
  xCur = pTVar5->brc & 0xf;
  yCur = (int)(uint)pTVar5->brc >> 4;
  if ((*&pTVar5->u_TOK_0x0003 == '\x01') || (spdMove == 0)) goto BATTLE_LReturnDxy;
  scoreBest._0_2_ = 0xc380;
  scoreBest._2_2_ = 0x1c9;
  mdTactic = pTVar5->wFlags_0x17 >> 8 & 0xf;
  fPrimary = FDoesPrimaryTargetTypeExist(ptok,grfAttack);
  for (x = 0; x < 3; x = x + 1) {
    for (y = 0; y < 3; y = y + 1) {
      rgscoreNear[x * 6 + y * 2] = 0xc380;
      (rgscoreNear + x * 6 + y * 2)[1] = 0x1c9;
    }
  }
  dz = DzMoveRangeToConsider(ptok,grfAttack,&brcOOR);
  x = xCur - dz;
  if (x < 0) {
    x = 0;
  }
  yMin = yCur - dz;
  if (yMin < 0) {
    yMin = 0;
  }
  xMax = xCur + dz;
  if (9 < xMax) {
    xMax = 9;
  }
  yMax = yCur + dz;
  if (9 < yMax) {
    yMax = 9;
  }
  for (; x <= xMax; x = x + 1) {
    for (y = yMin; y <= yMax; y = y + 1) {
      brc = (byte)((y & 0xfU) << 4) | (byte)x & 0xf;
      dx = xCur - x;
      dy = yCur - y;
      dx = _abs(dx);
      dy = _abs(dy);
      lVar7 = ScoreGuessBattleDamage(ptok,brc,fPrimary,grfAttack);
      if (mdTactic == 0) {
        i = 0;
        while( true ) {
          score._2_2_ = (uint)((ulong)lVar7 >> 0x10);
          score._0_2_ = (uint)lVar7;
          if (vctok <= i) break;
          if ((((TOK *)vrgtok)[i].brc == brc) &&
             (((TOK *)vrgtok)[i].iplr == iplr)) {
            lVar7 = lVar7 + 2;
          }
          i = i + 1;
        }
        fXMajor = (short)brc;
        if (fXMajor == (uint)pTVar5->brc) {
          lVar7 = CONCAT22(score._2_2_ - ((uint)score == 0),(uint)score + -1);
        }
      }
      score = lVar7;
      dzAway = DzFromBrcBrc(pTVar5->brc,brc);
      if (dzAway < 2) {
        rgscoreNear[((x - xCur) + 1) * 6 + ((y - yCur) + 1) * 2] = (uint)score;
        (rgscoreNear + ((x - xCur) + 1) * 6 + ((y - yCur) + 1) * 2)[1] = score._2_2_;
      }
      if ((score < scoreBest) || ((score == scoreBest && (dzAway <= dzAwayBest)))) {
        if ((scoreBest == score) && (dzAway == dzAwayBest)) {
          cBest = cBest + 1;
          sVar3 = Random(cBest);
          if (sVar3 != 0) goto LAB_10f0_6260;
        }
        else {
          cBest = 1;
          dzAwayBest = dzAway;
          scoreBest = score;
        }
        brcBest = brc;
      }
LAB_10f0_6260:
    }
  }
  if (brcOOR != 0xff) {
    brcBest = brcOOR;
  }
  dzAway = DzFromBrcBrc(pTVar5->brc,brcBest);
  if (1 < dzAway) {
    dx = (brcBest & 0xf) - xCur;
    dy = ((int)(uint)brcBest >> 4) - yCur;
    fXMajor = _abs(dx);
    sVar3 = _abs(dy);
    if (fXMajor == sVar3) {
      if (dx < 1) {
        xCur = xCur + -1;
      }
      else {
        xCur = xCur + 1;
      }
      if (dy < 1) {
        yCur = yCur + -1;
      }
      else {
        yCur = yCur + 1;
      }
    }
    else if (dx == 0) {
      lLow = 0xa300;
      fXMajor = 0x11e1;
      cLow = 0;
      if (dy < 0) {
        dy = 0;
      }
      else {
        dy = 2;
      }
      yCur = yCur + dy + -1;
      for (i = 0; i < 3; i = i + 1) {
        uVar1 = (rgscoreNear + i * 6 + dy * 2)[1];
        if (((int)uVar1 <= fXMajor) &&
           (((int)uVar1 < fXMajor || (rgscoreNear[i * 6 + dy * 2] <= lLow)))) {
          uVar1 = (rgscoreNear + i * 6 + dy * 2)[1];
          if ((fXMajor < (int)uVar1) ||
             ((fXMajor <= (int)uVar1 && (lLow <= rgscoreNear[i * 6 + dy * 2])))) {
            cLow = cLow + 1;
          }
          else {
            lLow = rgscoreNear[i * 6 + dy * 2];
            fXMajor = (rgscoreNear + i * 6 + dy * 2)[1];
            cLow = 1;
          }
        }
      }
      x = Random(cLow);
      i = 0;
      while ((sVar3 = x, i < 3 &&
             (((rgscoreNear[i * 6 + dy * 2] != lLow ||
               ((rgscoreNear + i * 6 + dy * 2)[1] != fXMajor)) || (x = x + -1, sVar3 != 0))))) {
        i = i + 1;
      }
      xCur = xCur + i + -1;
    }
    else if (dy == 0) {
      lLow = 0xa300;
      fXMajor = 0x11e1;
      cLow = 0;
      if (dx < 0) {
        dx = 0;
      }
      else {
        dx = 2;
      }
      xCur = xCur + dx + -1;
      for (i = 0; i < 3; i = i + 1) {
        uVar1 = (rgscoreNear + dx * 6 + i * 2)[1];
        if (((int)uVar1 <= fXMajor) &&
           (((int)uVar1 < fXMajor || (rgscoreNear[dx * 6 + i * 2] <= lLow)))) {
          uVar1 = (rgscoreNear + dx * 6 + i * 2)[1];
          if ((fXMajor < (int)uVar1) ||
             ((fXMajor <= (int)uVar1 && (lLow <= rgscoreNear[dx * 6 + i * 2])))) {
            cLow = cLow + 1;
          }
          else {
            lLow = rgscoreNear[dx * 6 + i * 2];
            fXMajor = (rgscoreNear + dx * 6 + i * 2)[1];
            cLow = 1;
          }
        }
      }
      x = Random(cLow);
      i = 0;
      while ((sVar3 = x, i < 3 &&
             (((rgscoreNear[dx * 6 + i * 2] != lLow ||
               ((rgscoreNear + dx * 6 + i * 2)[1] != fXMajor)) || (x = x + -1, sVar3 != 0))))) {
        i = i + 1;
      }
      yCur = yCur + i + -1;
    }
    else {
      sVar3 = _abs(dx);
      sVar4 = _abs(dy);
      fXMajor = (uint)(sVar4 < sVar3);
      if (dx < 1) {
        dx = 0;
      }
      else {
        dx = 2;
      }
      if (dy < 1) {
        dy = 0;
      }
      else {
        dy = 2;
      }
      local_64 = dy;
      if (sVar4 < sVar3 == 0) {
        cLow = 1;
        lLow = dy;
      }
      else {
        cLow = dx;
        lLow = 1;
      }
      uVar1 = (rgscoreNear + cLow * 6 + lLow * 2)[1];
      uVar2 = (rgscoreNear + dx * 6 + dy * 2)[1];
      if (((int)uVar2 < (int)uVar1) ||
         (((int)uVar2 <= (int)uVar1 &&
          (rgscoreNear[dx * 6 + dy * 2] < rgscoreNear[cLow * 6 + lLow * 2])))) {
LAB_10f0_66d1:
        i = 0;
      }
      else {
        if ((rgscoreNear[dx * 6 + dy * 2] == rgscoreNear[cLow * 6 + lLow * 2]) &&
           ((rgscoreNear + dx * 6 + dy * 2)[1] == (rgscoreNear + cLow * 6 + lLow * 2)[1])) {
          sVar3 = Random(2);
          if (sVar3 == 0) goto LAB_10f0_66d1;
        }
        i = 1;
      }
      xCur = xCur + *(int *)(&stack0xff9a + i * 4) + -1;
      yCur = yCur + (&local_64)[i * 2] + -1;
    }
    brcBest = (byte)((yCur & 0xfU) << 4) | (byte)xCur & 0xf;
  }
  if (scoreBest != 30000000) {
    if ((9 < (brcBest & 0xf)) || (9 < (uint)((int)(uint)brcBest >> 4))) {
      brcBest = pTVar5->brc;
    }
    pTVar5->brc = brcBest;
  }
BATTLE_LReturnDxy:
  pTVar5->wFlags = pTVar5->wFlags & 0xffef | 0x10;
  return 1;
}



// ======================================================================
// Function: CTorpHit
// Address: 10f0:6790
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f06913) */
/* WARNING: Removing unreachable block (ram,0x10f068d2) */
/* WARNING: Removing unreachable block (ram,0x10f068f3) */
/* WARNING: Removing unreachable block (ram,0x10f06994) */

long CTorpHit(long cTorpBase,TOK *ptok,short pctBase,short pctBC)

{
  short sVar1;
  bool bVar2;
  ulong uVar3;
  long lVar4;
  uint cTorpHit;
  int local_10;
  int pctHit;
  short i;
  uint pctJam;
  int local_6;
  
  if ((cTorpBase == 0) || (pctBase == 0)) {
    lVar4 = 0;
  }
  else {
    pctJam = (uint)((TOK *)ptok)->pctJam;
    local_6 = 0;
    if ((pctJam != 0) && (pctBC != 0)) {
      bVar2 = pctJam < (uint)pctBC;
      pctJam = pctJam - pctBC;
      local_6 = -(uint)bVar2 - (pctBC >> 0xf);
      if ((local_6 < 1) && (local_6 < 0)) {
        pctBC = -pctJam;
        pctJam = 0;
        local_6 = 0;
      }
      else {
        pctBC = 0;
      }
    }
    if (pctBC == 0) {
      if ((pctJam == 0) && (local_6 == 0)) {
        uVar3 = (ulong)pctBase;
      }
      else {
        lVar4 = 100;
        uVar3 = __aFulmul((long)pctBase,
                                  CONCAT22(-(uint)(100 < pctJam) - local_6,100 - pctJam));
        uVar3 = __aFldiv(uVar3,lVar4);
      }
    }
    else {
      lVar4 = 100;
      uVar3 = __aFulmul(CONCAT22(-(uint)(100 < (uint)pctBase) - (pctBase >> 0xf),
                                         100 - pctBase),(long)(100 - pctBC));
      lVar4 = __aFldiv(uVar3,lVar4);
      uVar3 = CONCAT22(-(uint)(100 < (uint)lVar4) - (int)((ulong)lVar4 >> 0x10),100 - (uint)lVar4);
    }
    if ((long)uVar3 < 1) {
      uVar3 = 1;
    }
    pctHit = (int)uVar3;
    lVar4 = cTorpBase;
    if ((long)uVar3 < 100) {
      if (cTorpBase < 0xc9) {
        cTorpHit = 0;
        local_10 = 0;
        for (i = 0; lVar4 = CONCAT22(local_10,cTorpHit), i < cTorpBase; i = i + 1) {
          sVar1 = Random(100);
          if (sVar1 < pctHit) {
            bVar2 = 0xfffe < cTorpHit;
            cTorpHit = cTorpHit + 1;
            local_10 = local_10 + (uint)bVar2;
          }
        }
      }
      else {
        lVar4 = 100;
        uVar3 = __aFulmul(cTorpBase,uVar3);
        lVar4 = __aFldiv(uVar3,lVar4);
      }
    }
  }
  return lVar4;
}



// ======================================================================
// Function: FAttack
// Address: 10f0:69ac
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: fCapMissile */
/* WARNING: Removing unreachable block (ram,0x10f0798c) */
/* WARNING: Removing unreachable block (ram,0x10f07315) */
/* WARNING: Removing unreachable block (ram,0x10f070f6) */
/* WARNING: Removing unreachable block (ram,0x10f07498) */
/* WARNING: Removing unreachable block (ram,0x10f072a4) */
/* WARNING: Removing unreachable block (ram,0x10f06f66) */
/* WARNING: Removing unreachable block (ram,0x10f0707c) */
/* WARNING: Removing unreachable block (ram,0x10f07265) */
/* WARNING: Removing unreachable block (ram,0x10f07463) */
/* WARNING: Removing unreachable block (ram,0x10f0781f) */
/* WARNING: Removing unreachable block (ram,0x10f07733) */
/* WARNING: Removing unreachable block (ram,0x10f079ee) */
/* WARNING: Removing unreachable block (ram,0x10f0751f) */
/* WARNING: Removing unreachable block (ram,0x10f074c6) */
/* WARNING: Removing unreachable block (ram,0x10f07183) */
/* WARNING: Removing unreachable block (ram,0x10f079c8) */
/* WARNING: Removing unreachable block (ram,0x10f07b2d) */
/* WARNING: Removing unreachable block (ram,0x10f0774a) */
/* WARNING: Removing unreachable block (ram,0x10f07b4d) */
/* WARNING: Removing unreachable block (ram,0x10f077de) */
/* WARNING: Removing unreachable block (ram,0x10f07b89) */
/* WARNING: Removing unreachable block (ram,0x10f07c92) */
/* WARNING: Removing unreachable block (ram,0x10f07ca9) */

short FAttack(short itokAttacker,short init,BTLREC *lpbtlrec,ushort grfAttack)

{
  uint uVar1;
  short sVar2;
  uint uVar3;
  int iVar4;
  int iVar5;
  HUL *pHVar6;
  BTLREC *pBVar7;
  TOK *pTVar8;
  BEAM *pBVar9;
  TOK *pTVar10;
  int iVar11;
  undefined2 uVar12;
  undefined2 uVar13;
  undefined2 uVar14;
  ulong uVar15;
  long lVar16;
  ulong uVar17;
  long *plVar18;
  long lVar19;
  ulong uVar20;
  ulong uVar21;
  ulong dpTorp;
  undefined2 uVar22;
  undefined2 uVar23;
  undefined1 uVar24;
  undefined1 uVar25;
  undefined1 uVar26;
  char cVar27;
  undefined1 uVar28;
  undefined2 in_stack_0000ff74;
  undefined2 in_stack_0000ff76;
  undefined2 uVar29;
  long *in_stack_0000ff78;
  undefined2 uVar30;
  uint in_stack_0000ff7a;
  undefined2 uVar31;
  ushort uVar32;
  undefined2 uVar33;
  short fCapMissile;
  ulong in_stack_0000ff84;
  HullSlotType HVar34;
  uint uVar35;
  u_PART_0x0004 local_76;
  TOK *ptokE;
  undefined4 dpCol;
  short itok;
  long dp;
  short fPrimary;
  undefined4 cTorpHit;
  HUL *lphul;
  long dpT;
  undefined4 lValue;
  SHDEF *lpshdef;
  TOK *ptokTarget;
  undefined4 pctHit;
  short cItem;
  ushort grfWeapon;
  undefined4 cTorpBase;
  short i;
  undefined4 cTorpsLeft;
  undefined4 cTorpFire;
  undefined4 cTorpMiss;
  short ihs;
  short dxRangeCur;
  short fSetItok;
  undefined4 score;
  long dpMain;
  short itokTarget;
  short ctokDamaged;
  TOK *ptok;
  undefined4 scoreBest;
  ushort dpSingle;
  undefined2 local_14;
  undefined4 dpArmorLeft;
  SHDEF *lpshdefE;
  short dz;
  undefined4 dpShieldLeft;
  
  dxRangeCur = 0;
  fSetItok = 0;
  ctokDamaged = 0;
  ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok + itokAttacker);
  lphul = &LpshdefFromTok((TOK *)CONCAT22(vrgtok._2_2_,
                                          (TOK *)vrgtok + itokAttacker))->hul;
  lVar19 = CONCAT22(score._2_2_,(undefined2)score);
  uVar17 = CONCAT22(in_stack_0000ff76,in_stack_0000ff74);
  dpTorp = (ulong)in_stack_0000ff7a;
  uVar21 = CONCAT22(dpMain._2_2_,(undefined2)dpMain);
  uVar15 = CONCAT22(cTorpsLeft._2_2_,(undefined2)cTorpsLeft);
  uVar20 = CONCAT22(dp._2_2_,(int)dp);
  ihs = 0;
  lpshdef = lphul;
  do {
    uVar12 = (undefined2)((ulong)lphul >> 0x10);
    pHVar6 = (HUL *)lphul;
    pBVar7 = (BTLREC *)lpbtlrec;
    uVar13 = (undefined2)((ulong)lpbtlrec >> 0x10);
    if ((int)(uint)pHVar6->chs <= ihs) {
      pBVar7->ctok = ctokDamaged;
      return (uint)(ctokDamaged != 0);
    }
    if ((((pHVar6->rghs + ihs)->grhst & (hstTorp|hstBeam)) !=
         ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
           hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
       (pHVar6->rghs[ihs].wFlags_0x2 >> 8 != 0)) {
      uVar35 = pHVar6->rghs[ihs].wFlags_0x2;
      in_stack_0000ff84 = CONCAT22((pHVar6->rghs + ihs)->grhst,(int)in_stack_0000ff84);
      idPlayer = (short)((TOK *)ptok)->iplr;
      dp = uVar20;
      cTorpsLeft = uVar15;
      dpMain = uVar21;
      score = lVar19;
      FLookupPart(&stack0xff86);
      idPlayer = -1;
      cItem = ((HUL *)lphul)->rghs[ihs].wFlags_0x2 >> 8;
      uVar12 = (undefined2)((ulong)ptok >> 0x10);
      pTVar8 = (TOK *)ptok;
      uVar14 = local_76._2_2_;
      pBVar9 = (BEAM *)local_76.pbeam;
      i = (uint)pTVar8->initBase + pBVar9->init;
      if (0x3f < i) {
        i = 0x3f;
      }
      uVar15 = cTorpsLeft;
      uVar21 = dpMain;
      uVar20 = dp;
      lVar19 = score;
      if (i == init) {
        dxRangeCur = (uint)(*&pTVar8->u_TOK_0x0003 == '\x01') + pBVar9->dRangeMax;
        HVar34 = (HullSlotType)(in_stack_0000ff84 >> 0x10);
        if ((HVar34 == hstBeam) && ((pBVar9->grfAbilities & 2U) != 0)) {
          uVar26 = 0;
          uVar28 = 0;
          uVar24 = (undefined1)pTVar8->csh;
          uVar25 = (undefined1)(pTVar8->csh >> 8);
          uVar20 = __aFulmul((long)pBVar9->dp,(long)cItem);
          uVar20 = __aFulmul(uVar20,CONCAT13(uVar28,CONCAT12(uVar26,CONCAT11(uVar25,uVar24))
                                                    ));
          if (pBVar9->dp < 200) {
            grfWeapon = 1;
          }
          else {
            grfWeapon = 2;
          }
          uVar12 = (undefined2)((ulong)ptok >> 0x10);
          if (((TOK *)ptok)->pctCap != 0) {
            uVar26 = 0;
            uVar28 = 0;
            uVar24 = 100;
            uVar25 = 0;
            dp = uVar20;
            uVar20 = __aFulmul(uVar20,(ulong)((TOK *)ptok)->pctCap);
            uVar20 = __aFldiv(uVar20,CONCAT13(uVar28,CONCAT12(uVar26,CONCAT11(uVar25,uVar24)
                                                                     )));
          }
          ptokE = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
          dpT = uVar20;
          uVar15 = cTorpsLeft;
          uVar21 = dpMain;
          lVar19 = score;
          for (itok = 0; itok < vctok; itok = itok + 1) {
            uVar12 = (undefined2)((ulong)ptokE >> 0x10);
            pTVar8 = (TOK *)ptokE;
            if ((pTVar8->wFlags & 1) != 0) {
              uVar29 = (undefined2)((ulong)ptok >> 0x10);
              in_stack_0000ff84 = (ulong)(uint)pTVar8->iplr;
              if (((uint)pTVar8->iplr != (uint)((TOK *)ptok)->iplr) &&
                 ((1 << (pTVar8->iplr & 0x1f) & grfAttack) != 0)) {
                dp = uVar20;
                cTorpsLeft = uVar15;
                dpMain = uVar21;
                score = lVar19;
                sVar2 = DzFromBrcBrc(pTVar8->brc,((TOK *)ptok)->brc);
                uVar20 = dp;
                uVar15 = cTorpsLeft;
                uVar21 = dpMain;
                lVar19 = score;
                if (sVar2 <= dxRangeCur) {
                  sVar2 = FIsTargetOfMdTarget(ptokE,((TOK *)ptok)->wFlags_0x17 & 0xf);
                  uVar20 = dp;
                  if (sVar2 == 0) {
                    sVar2 = FIsTargetOfMdTarget(ptokE,((TOK *)ptok)->wFlags_0x17 >> 4 & 0xf);
                    uVar20 = dp;
                    uVar15 = cTorpsLeft;
                    uVar21 = dpMain;
                    lVar19 = score;
                    if (sVar2 == 0) goto LAB_10f0_6bfa;
                  }
                  if (pTVar8->pctBeamDef < 100) {
                    uVar26 = 0;
                    uVar28 = 0;
                    uVar24 = 100;
                    uVar25 = 0;
                    dp = uVar20;
                    uVar20 = __aFulmul(uVar20,(ulong)pTVar8->pctBeamDef);
                    uVar20 = __aFldiv(uVar20,CONCAT13(uVar28,CONCAT12(uVar26,CONCAT11(uVar25
                                                  ,uVar24))));
                  }
                  dp = uVar20;
                  sVar2 = FDamageTok(ptokE,itok,&dp,0,grfWeapon,pBVar9->grfAbilities & 1,(long *)0x0
                                    );
                  uVar20 = dpT;
                  uVar15 = cTorpsLeft;
                  uVar21 = dpMain;
                  lVar19 = score;
                  if (sVar2 != 0) {
                    if (fSetItok == 0) {
                      fSetItok = 1;
                      pBVar7->wFlags_0x4 = pBVar7->wFlags_0x4 & 0xff | itok << 8;
                    }
                    ctokDamaged = ctokDamaged + 1;
                  }
                }
              }
            }
LAB_10f0_6bfa:
            ptokE = (TOK *)CONCAT22(uVar12,pTVar8 + 1);
          }
        }
        else {
          if (HVar34 == hstBeam) {
            uVar26 = 0;
            uVar28 = 0;
            uVar24 = (undefined1)pTVar8->csh;
            uVar25 = (undefined1)(pTVar8->csh >> 8);
            uVar20 = __aFulmul((long)pBVar9->dp,(long)cItem);
            uVar21 = __aFulmul(uVar20,CONCAT13(uVar28,CONCAT12(uVar26,CONCAT11(uVar25,uVar24
                                                                                      ))));
            uVar15 = 0;
            lVar19 = score;
          }
          else {
            dpMain._0_2_ = 0;
            dpMain._2_2_ = 0;
            uVar15 = __aFulmul((long)cItem,(ulong)pTVar8->csh);
            uVar21 = CONCAT22(dpMain._2_2_,(undefined2)dpMain);
            lVar19 = score;
          }
          do {
            plVar18 = (long *)CONCAT22((int)dpTorp,in_stack_0000ff78);
            for (fPrimary = 1; -1 < fPrimary; fPrimary = fPrimary + -1) {
              scoreBest = 0;
              ptokTarget = (TOK *)0x0;
              ptokE = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
              for (itok = 0; itok < vctok; itok = itok + 1) {
                uVar12 = (undefined2)((ulong)ptokE >> 0x10);
                pTVar8 = (TOK *)ptokE;
                if ((pTVar8->wFlags & 1) != 0) {
                  uVar29 = (undefined2)((ulong)ptok >> 0x10);
                  in_stack_0000ff84 =
                       CONCAT22((HullSlotType)(in_stack_0000ff84 >> 0x10),(uint)pTVar8->iplr);
                  if (((uint)pTVar8->iplr != (uint)((TOK *)ptok)->iplr) &&
                     ((1 << (pTVar8->iplr & 0x1f) & grfAttack) != 0)) {
                    score = lVar19;
                    cTorpsLeft = uVar15;
                    dpMain = uVar21;
                    sVar2 = DzFromBrcBrc(pTVar8->brc,((TOK *)ptok)->brc);
                    lVar19 = score;
                    uVar15 = cTorpsLeft;
                    uVar21 = dpMain;
                    if (sVar2 <= dxRangeCur) {
                      uVar29 = (undefined2)((ulong)ptok >> 0x10);
                      if (fPrimary == 0) {
                        uVar3 = ((TOK *)ptok)->wFlags_0x17 >> 4;
                      }
                      else {
                        uVar3 = ((TOK *)ptok)->wFlags_0x17;
                      }
                      sVar2 = FIsTargetOfMdTarget(ptokE,uVar3 & 0xf);
                      lVar19 = score;
                      uVar15 = cTorpsLeft;
                      uVar21 = dpMain;
                      if (sVar2 != 0) {
                        lpshdefE = LpshdefFromTok(ptokE);
                        uVar29 = (undefined2)((ulong)lpshdefE >> 0x10);
                        uVar3 = (((SHDEF *)lpshdefE)->hul).rgwtOreCost[1];
                        uVar1 = (((SHDEF *)lpshdefE)->hul).resCost;
                        uVar20 = __aFulmul((ulong)CONCAT12(CARRY2(uVar1,uVar3),uVar1 + uVar3
                                                                  ),(ulong)pTVar8->csh);
                        if ((long)uVar20 < 100000) {
                          lValue = uVar20;
                          uVar20 = __aFulmul(uVar20,100);
                        }
                        else {
                          uVar20 = 10000000;
                        }
                        dpSingle = (((SHDEF *)lpshdefE)->hul).dp;
                        local_14 = 0;
                        lValue = uVar20;
                        uVar20 = __aFulmul((ulong)pTVar8->dpShield,(ulong)pTVar8->csh);
                        uVar3 = pTVar8->csh;
                        uVar29 = 0;
                        dpShieldLeft = uVar20;
                        uVar20 = __aFulmul(CONCAT13((char)((uint)local_14 >> 8),
                                                            CONCAT12((char)local_14,dpSingle)),
                                                   (ulong)uVar3);
                        if ((&pTVar8->dv)->dp != 0) {
                          uVar29 = 0;
                          uVar3 = 500;
                          uVar26 = 0;
                          uVar28 = 0;
                          uVar24 = (undefined1)pTVar8->csh;
                          uVar25 = (undefined1)(pTVar8->csh >> 8);
                          uVar23 = 0;
                          uVar22 = 10;
                          uVar1 = (&pTVar8->dv)->dp & 0x7f;
                          uVar33 = 0;
                          uVar31 = 0;
                          uVar30 = 10;
                          dpArmorLeft = uVar20;
                          uVar20 = __aFulmul(CONCAT22(local_14,dpSingle),
                                                     (ulong)((&pTVar8->dv)->dp >> 7));
                          uVar20 = __aFldiv(uVar20,CONCAT22(uVar31,uVar30));
                          uVar20 = __aFulmul(uVar20,CONCAT22(uVar33,uVar1));
                          uVar20 = __aFldiv(uVar20,CONCAT22(uVar23,uVar22));
                          uVar20 = __aFulmul(uVar20,CONCAT13(uVar28,CONCAT12(uVar26,CONCAT11
                                                  (uVar25,uVar24))));
                          lVar19 = __aFldiv(uVar20,CONCAT22(uVar29,uVar3));
                          uVar20 = dpArmorLeft - lVar19;
                        }
                        if ((long)uVar20 < 1) {
                          uVar20 = 1;
                        }
                        HVar34 = (HullSlotType)(in_stack_0000ff84 >> 0x10);
                        dpArmorLeft = uVar20;
                        if ((HVar34 == hstBeam) || (HVar34 != hstTorp)) {
                          if (pTVar8->pctBeamDef < 100) {
                            uVar29 = 0;
                            uVar3 = 100;
                            uVar20 = __aFulmul(lValue,(ulong)pTVar8->pctBeamDef);
                            uVar20 = __aFldiv(uVar20,CONCAT22(uVar29,uVar3));
                            lValue = uVar20;
                          }
                          uVar17 = CONCAT22(uVar29,uVar3);
                          if ((pBVar9->grfAbilities & 1U) == 0) {
                            uVar17 = dpArmorLeft + dpShieldLeft + 1;
                            uVar20 = __aFulmul(lValue,100);
                            lVar19 = __aFldiv(uVar20,uVar17);
                            uVar15 = cTorpsLeft;
                            uVar21 = dpMain;
                            if (lVar19 < 1) {
                              lVar19 = 1;
                            }
                          }
                          else if ((long)dpShieldLeft < 1) {
                            lVar19 = 0;
                            uVar15 = cTorpsLeft;
                            uVar21 = dpMain;
                          }
                          else {
                            uVar17 = dpShieldLeft;
                            uVar20 = __aFulmul(lValue,100);
                            lVar19 = __aFldiv(uVar20 + dpShieldLeft + -1,uVar17);
                            uVar15 = cTorpsLeft;
                            uVar21 = dpMain;
                          }
                        }
                        else {
                          pctHit._0_2_ = pBVar9->grfAbilities;
                          pctHit._2_2_ = (int)(uint)pctHit >> 0xf;
                          uVar29 = (undefined2)((ulong)ptok >> 0x10);
                          pTVar10 = (TOK *)ptok;
                          if (pTVar10->pctBC < pTVar8->pctJam) {
                            uVar31 = 0;
                            uVar30 = 100;
                            in_stack_0000ff84 = CONCAT22(0x20,(uint)pTVar10->pctBC);
                            iVar11 = (uint)pTVar8->pctJam - (uint)pTVar10->pctBC;
                            cVar27 = (char)(iVar11 >> 0xf);
                            uVar20 = __aFulmul((long)(int)(uint)pctHit,
                                                       CONCAT13(cVar27,CONCAT12(cVar27,iVar11)));
                            lVar19 = __aFldiv(uVar20,CONCAT22(uVar31,uVar30));
                            pctHit = CONCAT22((pctHit._2_2_ - (int)((ulong)lVar19 >> 0x10)) -
                                              (uint)((uint)pctHit < (uint)lVar19),
                                              (uint)pctHit - (uint)lVar19);
                          }
                          else {
                            uVar31 = 0;
                            uVar30 = 100;
                            in_stack_0000ff84 = CONCAT22(0x20,(uint)pTVar8->pctJam);
                            iVar11 = (uint)pTVar10->pctBC - (uint)pTVar8->pctJam;
                            cVar27 = (char)(iVar11 >> 0xf);
                            uVar20 = __aFulmul(CONCAT22(-(uint)(100 < (uint)pctHit) -
                                                                pctHit._2_2_,100 - (uint)pctHit),
                                                       CONCAT13(cVar27,CONCAT12(cVar27,iVar11)));
                            lVar19 = __aFldiv(uVar20,CONCAT22(uVar31,uVar30));
                            pctHit = lVar19 + CONCAT22(pctHit._2_2_,(uint)pctHit);
                          }
                          uVar17 = CONCAT22(uVar31,uVar30);
                          if ((long)pctHit < 1) {
                            lVar19 = 0;
                            uVar15 = cTorpsLeft;
                            uVar21 = dpMain;
                          }
                          else {
                            if (((uVar35 & 0xff) < 8) || (0xb < (uVar35 & 0xff))) {
                              iVar11 = 0;
                            }
                            else {
                              iVar11 = 1;
                            }
                            if ((long)dpArmorLeft < 100000) {
                              uVar20 = pctHit;
                              __aFulmul(dpArmorLeft,100);
                              HVar34 = (HullSlotType)(in_stack_0000ff84 >> 0x10);
                              lVar19 = __aFlshl(uVar20,(ushort)(long *)plVar18);
                              uVar20 = __aFldiv(lVar19,uVar20);
                              uVar21 = pctHit;
                            }
                            else {
                              uVar30 = 0;
                              uVar29 = 200;
                              uVar20 = __aFldiv(dpArmorLeft,pctHit);
                              HVar34 = (HullSlotType)(in_stack_0000ff84 >> 0x10);
                              uVar20 = __aFulmul(uVar20,CONCAT22(uVar30,uVar29));
                              uVar21 = pctHit;
                            }
                            pctHit._2_2_ = (int)(uVar21 >> 0x10);
                            pctHit._0_2_ = (uint)uVar21;
                            pctHit = uVar21;
                            if ((long)dpShieldLeft < 100000) {
                              iVar5 = 100 - (uint)pctHit;
                              iVar4 = -(uint)(100 < (uint)pctHit) - pctHit._2_2_;
                              lVar16 = __aFldiv(CONCAT13((char)((uint)iVar4 >> 8),
                                                                 CONCAT12((char)iVar4,iVar5)),8);
                              lVar19 = __aFldiv(pctHit,lVar16);
                              lVar19 = lVar19 + lVar16;
                              uVar21 = __aFulmul(dpShieldLeft,100);
                              lVar19 = __aFldiv(uVar21,lVar19);
                              uVar29 = (undefined2)lVar19;
                              in_stack_0000ff84 = CONCAT22(HVar34,(int)((ulong)lVar19 >> 0x10));
                            }
                            else {
                              iVar5 = 100 - (uint)pctHit;
                              iVar4 = -(uint)(100 < (uint)pctHit) - pctHit._2_2_;
                              uVar21 = __aFldiv(CONCAT22(iVar4,iVar5),8);
                              lVar19 = __aFldiv(pctHit,2);
                              uVar15 = __aFldiv(dpShieldLeft,lVar19 + uVar21);
                              uVar21 = __aFulmul(uVar15,uVar21);
                              uVar29 = (undefined2)uVar21;
                              in_stack_0000ff84 = CONCAT22(HVar34,(int)(uVar21 >> 0x10));
                            }
                            uVar17 = __aFulmul(pctHit,(long)(iVar11 + 1));
                            uVar26 = 0;
                            uVar28 = 0;
                            uVar24 = 100;
                            uVar25 = 0;
                            uVar31 = 0;
                            uVar30 = 200;
                            uVar21 = __aFulmul(CONCAT22((int)in_stack_0000ff84,uVar29),
                                                       pctHit);
                            lVar19 = __aFldiv(uVar21,CONCAT22(uVar31,uVar30));
                            uVar21 = __aFulmul(dpArmorLeft - lVar19,
                                                       CONCAT13(uVar28,CONCAT12(uVar26,CONCAT11(
                                                  uVar25,uVar24))));
                            plVar18 = (long *)__aFldiv(uVar21,uVar17);
                            lVar19 = CONCAT22((int)in_stack_0000ff84,uVar29);
                            if ((long)plVar18 + lVar19 <= (long)uVar20) {
                              uVar20 = (long)plVar18 + lVar19;
                            }
                            if ((long)uVar20 < 1) {
                              lVar19 = 0;
                              uVar15 = cTorpsLeft;
                              uVar21 = dpMain;
                            }
                            else {
                              uVar17 = uVar20;
                              score = uVar20;
                              lVar19 = __aFldiv(lValue,uVar20);
                              uVar15 = cTorpsLeft;
                              uVar21 = dpMain;
                              if (lVar19 < 1) {
                                lVar19 = 1;
                              }
                            }
                          }
                        }
                        if (scoreBest < lVar19) {
                          ptokTarget = ptokE;
                          itokTarget = itok;
                          scoreBest = lVar19;
                        }
                      }
                    }
                  }
                }
                ptokE = (TOK *)CONCAT22(uVar12,pTVar8 + 1);
              }
              if (((TOK *)ptokTarget != (TOK *)0x0) || (ptokTarget._2_2_ != 0)) break;
            }
            dpTorp = (ulong)plVar18 >> 0x10;
            in_stack_0000ff78 = (long *)plVar18;
            if (((TOK *)ptokTarget == (TOK *)0x0) && (uVar20 = dp, ptokTarget._2_2_ == 0)) break;
            cTorpsLeft = uVar15;
            dpMain = uVar21;
            score = lVar19;
            dz = DzFromBrcBrc(((TOK *)ptokTarget)->brc,((TOK *)ptok)->brc);
            uVar3 = (uint)((ulong)plVar18 >> 0x10);
            in_stack_0000ff78 = (long *)plVar18;
            HVar34 = (HullSlotType)(in_stack_0000ff84 >> 0x10);
            pTVar8 = (TOK *)ptok;
            uVar12 = (undefined2)((ulong)ptok >> 0x10);
            if (HVar34 == hstBeam) {
              dp = dpMain;
              if (pTVar8->pctCap != 0) {
                uVar26 = 0;
                uVar28 = 0;
                uVar24 = 100;
                uVar25 = 0;
                uVar20 = __aFulmul(dpMain,(ulong)pTVar8->pctCap);
                uVar20 = __aFldiv(uVar20,CONCAT13(uVar28,CONCAT12(uVar26,CONCAT11(uVar25,
                                                  uVar24))));
                dp = uVar20;
              }
              uVar12 = (undefined2)((ulong)ptokTarget >> 0x10);
              if (((TOK *)ptokTarget)->pctBeamDef < 100) {
                uVar26 = 0;
                uVar28 = 0;
                uVar24 = 100;
                uVar25 = 0;
                uVar20 = __aFulmul(dp,(ulong)((TOK *)ptokTarget)->pctBeamDef);
                uVar20 = __aFldiv(uVar20,CONCAT13(uVar28,CONCAT12(uVar26,CONCAT11(uVar25,
                                                  uVar24))));
                dp = uVar20;
              }
              if ((0 < dz) && (0 < pBVar9->dRangeMax)) {
                uVar26 = 0;
                uVar28 = 0;
                uVar24 = 100;
                uVar25 = 0;
                iVar11 = pBVar9->dRangeMax;
                iVar5 = iVar11 >> 0xf;
                uVar20 = __aFulmul((long)dz,10);
                lVar19 = __aFldiv(uVar20,CONCAT22(iVar5,iVar11));
                uVar20 = __aFulmul(dp,CONCAT22(-(uint)(100 < (uint)lVar19) -
                                                       (int)((ulong)lVar19 >> 0x10),
                                                       100 - (uint)lVar19));
                uVar20 = __aFldiv(uVar20,CONCAT13(uVar28,CONCAT12(uVar26,CONCAT11(uVar25,
                                                  uVar24))));
                dp = uVar20;
              }
              if (pBVar9->dp < 200) {
                grfWeapon = 1;
              }
              else {
                grfWeapon = 2;
              }
              dpT = dp;
              sVar2 = FDamageTok(ptokTarget,itokTarget,&dp,0,grfWeapon,pBVar9->grfAbilities & 1,
                                 (long *)0x0);
              if (sVar2 != 0) {
                if (fSetItok == 0) {
                  pBVar7->wFlags_0x4 = pBVar7->wFlags_0x4 & 0xff | itokTarget << 8;
                  fSetItok = 1;
                }
                ctokDamaged = ctokDamaged + 1;
              }
              if ((dp < 1) || (dpT < 1)) {
                uVar20 = lValue;
                uVar21 = 0;
              }
              else {
                if ((((dpMain < 0x20000) && (dpMain < 0x10000)) && (dp < 0x20000)) && (dp < 0x10000)
                   ) {
                  uVar26 = (undefined1)((ulong)dpT >> 0x10);
                  uVar28 = (undefined1)((ulong)dpT >> 0x18);
                  uVar24 = (undefined1)dpT;
                  uVar25 = (undefined1)((ulong)dpT >> 8);
                  uVar20 = __aFulmul(dpMain,dp);
                  uVar20 = __aFldiv(uVar20,CONCAT13(uVar28,CONCAT12(uVar26,CONCAT11(uVar25,
                                                  uVar24))));
                }
                else {
                  uVar20 = __ftol((double)CONCAT26((int)((ulong)plVar18 >> 0x10),
                                                           CONCAT24((long *)plVar18,uVar17)));
                }
                uVar21 = uVar20;
                if (dpMain + -1 < (long)uVar20) {
                  uVar21 = dpMain - 1;
                }
              }
              in_stack_0000ff78 = (long *)plVar18;
              lValue = uVar20;
              uVar15 = cTorpsLeft;
              dpTorp = (ulong)plVar18 >> 0x10;
              lVar19 = score;
            }
            else {
              uVar15 = cTorpsLeft;
              uVar21 = dpMain;
              dpTorp = (ulong)uVar3;
              lVar19 = score;
              if ((HVar34 == hstTorp) && (dpTorp = (ulong)uVar3, 0 < (long)cTorpsLeft)) {
                grfWeapon = 4;
                cTorpBase = cTorpsLeft;
                uVar20 = CTorpHit(cTorpsLeft,ptokTarget,pBVar9->grfAbilities,(uint)pTVar8->pctBC);
                cTorpHit = uVar20;
                lpshdefE = LpshdefFromTok(ptokTarget);
                dpSingle = (((SHDEF *)lpshdefE)->hul).dp;
                local_14 = 0;
                uVar12 = (undefined2)((ulong)ptokTarget >> 0x10);
                _fCapMissile = (ulong)((TOK *)ptokTarget)->csh;
                uVar20 = __aFulmul((ulong)((TOK *)ptokTarget)->dpShield,_fCapMissile);
                _fCapMissile = (ulong)((TOK *)ptokTarget)->csh;
                dpShieldLeft = uVar20;
                uVar20 = __aFulmul(CONCAT22(local_14,dpSingle),_fCapMissile);
                uVar12 = (undefined2)((ulong)ptokTarget >> 0x10);
                pTVar8 = (TOK *)ptokTarget;
                if ((&pTVar8->dv)->dp != 0) {
                  uVar32 = pTVar8->csh;
                  uVar33 = 0;
                  uVar31 = 0;
                  uVar30 = 10;
                  uVar3 = (&pTVar8->dv)->dp & 0x7f;
                  uVar29 = 0;
                  uVar26 = 0;
                  uVar28 = 0;
                  uVar24 = 10;
                  uVar25 = 0;
                  dpArmorLeft = uVar20;
                  uVar20 = __aFulmul(CONCAT22(local_14,dpSingle),
                                             (ulong)((&pTVar8->dv)->dp >> 7));
                  uVar20 = __aFldiv(uVar20,CONCAT13(uVar28,CONCAT12(uVar26,CONCAT11(uVar25,
                                                  uVar24))));
                  uVar20 = __aFulmul(uVar20,CONCAT22(uVar29,uVar3));
                  uVar20 = __aFldiv(uVar20,CONCAT22(uVar31,uVar30));
                  uVar20 = __aFulmul(uVar20,CONCAT22(uVar33,uVar32));
                  lVar19 = __aFldiv(uVar20,500);
                  uVar20 = dpArmorLeft - lVar19;
                }
                dp._0_2_ = pBVar9->dp;
                dp._2_2_ = (int)dp >> 0xf;
                uVar15 = (ulong)(int)dp;
                uVar21 = (ulong)(int)dp;
                if ((7 < (uVar35 & 0xff)) && ((uVar35 & 0xff) < 0xc)) {
                  if ((long)dpShieldLeft < 1) {
                    dpArmorLeft = uVar20;
                    uVar21 = __aFlshl(in_stack_0000ff84,uVar35);
                    uVar20 = dpArmorLeft;
                  }
                  grfWeapon = grfWeapon | 8;
                  uVar15 = uVar21;
                }
                i = ((TOK *)ptokTarget)->csh;
                dp = uVar15;
                dpArmorLeft = uVar20;
                if ((long)i < (long)cTorpBase) {
                  uVar21 = __aFulmul(cTorpHit,uVar15);
                  uVar20 = cTorpBase;
                  if ((long)uVar21 <= (long)dpArmorLeft) goto LAB_10f0_79f6;
                  for (; (long)i <= (long)uVar20; i = i + 1) {
                    cTorpBase = uVar20;
                    uVar21 = __aFulmul((long)i,cTorpHit);
                    HVar34 = (HullSlotType)(in_stack_0000ff84 >> 0x10);
                    uVar20 = __aFldiv(uVar21 + cTorpBase + -1,uVar20);
                    cTorpMiss._0_2_ = i - (uint)uVar20;
                    cTorpMiss._2_2_ =
                         ((i >> 0xf) - (int)(uVar20 >> 0x10)) - (uint)((uint)i < (uint)uVar20);
                    cTorpFire = uVar20;
                    uVar20 = __aFulmul(CONCAT22(cTorpMiss._2_2_,(int)cTorpMiss),dp);
                    lVar19 = __aFldiv(uVar20,8);
                    iVar11 = (dpShieldLeft._2_2_ - (int)((ulong)lVar19 >> 0x10)) -
                             (uint)((uint)dpShieldLeft < (uint)lVar19);
                    if ((iVar11 < 1) && (iVar11 < 0)) {
                      iVar11 = 0;
                    }
                    uVar20 = __aFulmul(cTorpFire,dp);
                    lVar19 = __aFldiv(uVar20,2);
                    in_stack_0000ff84 =
                         CONCAT22(HVar34,(iVar11 - (int)((ulong)lVar19 >> 0x10)) -
                                         (uint)((int)lVar19 != 0));
                    uVar20 = __aFulmul(cTorpFire,dp);
                    lVar19 = __aFldiv(uVar20,2);
                    if (((int)in_stack_0000ff84 < 1) && ((int)in_stack_0000ff84 < 0)) {
                      lVar19 = lVar19 + (in_stack_0000ff84 & 0xffff) * -0x10000;
                    }
                    uVar20 = cTorpBase;
                    if ((long)dpArmorLeft <= lVar19) break;
                  }
                }
                else {
LAB_10f0_79f6:
                  cTorpMiss = cTorpBase - cTorpHit;
                  cTorpFire = cTorpHit;
                  uVar20 = cTorpBase;
                }
                cTorpBase = uVar20;
                uVar20 = __aFulmul(cTorpMiss,dp);
                lVar19 = __aFldiv(uVar20,8);
                if (0 < lVar19) {
                  dpCol = lVar19;
                  sVar2 = FDamageTok(ptokTarget,itokTarget,&dpCol,0,grfWeapon | 0x80,1,(long *)0x0);
                  lVar19 = dpCol;
                  if (sVar2 != 0) {
                    ctokDamaged = ctokDamaged + 1;
                  }
                }
                dpCol = lVar19;
                uVar20 = __aFulmul(cTorpFire,dp);
                dpTorp = __aFldiv(uVar20,2);
                cTorpBase = cTorpFire + cTorpMiss;
                in_stack_0000ff78 = &dpT;
                uVar12 = ptokTarget._2_2_;
                sVar2 = itokTarget;
                dpT = dpTorp;
                FDamageTok(ptokTarget,itokTarget,in_stack_0000ff78,dpTorp,grfWeapon,0,&cTorpBase);
                uVar17 = CONCAT22(sVar2,uVar12);
                ctokDamaged = ctokDamaged + 1;
                if (fSetItok == 0) {
                  fSetItok = 1;
                  pBVar7->wFlags_0x4 = pBVar7->wFlags_0x4 & 0xff | itokTarget << 8;
                }
                uVar15 = cTorpsLeft - (cTorpFire + cTorpMiss);
                uVar21 = dpMain;
                lVar19 = score;
              }
            }
          } while ((0 < (long)uVar21) || (uVar20 = dp, 0 < (long)uVar15));
        }
      }
    }
    ihs = ihs + 1;
  } while( true );
}



// ======================================================================
// Function: KillShips
// Address: 10f0:7cde
// Segment: MEMORY_BATTLE
// ======================================================================


void KillShips(TOK *ptok,short cshKill,short ishdef,FLEET *lpfl,short fFallout)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  ushort uVar3;
  int iVar4;
  TOK *pTVar5;
  short unaff_SI;
  FLEET *pFVar6;
  FLEET *pFVar7;
  undefined2 uVar8;
  undefined2 unaff_SS;
  SHDEF *lphul;
  short csh;
  FLEET flSrc;
  short i;
  FLEET flDead;
  
  if (cshKill != 0) {
    pTVar5 = (TOK *)ptok;
    uVar8 = (undefined2)((ulong)ptok >> 0x10);
    if (fFallout != 0) {
      lphul = LpshdefFromTok(ptok);
      MarkTechsSeen(&lphul->hul,unaff_SI);
    }
    pFVar7 = &flSrc;
    pFVar6 = (FLEET *)lpfl;
    for (iVar4 = 0x3e; iVar4 != 0; iVar4 = iVar4 + -1) {
      pFVar2 = pFVar7;
      pFVar7 = &pFVar7->iPlayer;
      pFVar1 = pFVar6;
      pFVar6 = &pFVar6->iPlayer;
      pFVar2->id = pFVar1->id;
    }
    _memset(&flDead,0,0x7c);
    uVar3 = ((FLEET *)lpfl)->rgcsh[ishdef] - cshKill;
    flDead.rgcsh[ishdef] = cshKill;
    flSrc.rgcsh[ishdef] = uVar3;
    pTVar5->csh = uVar3;
    if (uVar3 == 0) {
      pTVar5->wFlags = pTVar5->wFlags & 0xfffe;
      for (ishdef = 0; (ishdef < 0x10 && (flSrc.rgcsh[ishdef] == 0)); ishdef = ishdef + 1) {
      }
      if ((ishdef == 0x10) &&
         (((FLEET *)lpfl)->wFlags_0x4 = ((FLEET *)lpfl)->wFlags_0x4 & 0xfbff | 0x400, fFallout != 0)
         ) {
        for (i = 0; i < 3; i = i + 1) {
          uVar8 = *(undefined2 *)((int)flSrc.rgwtMin + i * 4 + 2);
          *(int *)(flDead.rgwtMin + i) = (int)flSrc.rgwtMin[i];
          *(undefined2 *)((int)flDead.rgwtMin + i * 4 + 2) = uVar8;
        }
      }
    }
    if ((((FLEET *)lpfl)->wFlags_0x4 >> 10 & 1) == 0) {
      flDead.iPlayer = flSrc.iPlayer;
      flDead.wFlags_0x4 = flDead.wFlags_0x4 & 0xfb00 | 0x407;
      FleetTransferCargoBalance(&flSrc,&flDead);
    }
    if (fFallout != 0) {
      flDead.iPlayer = flSrc.iPlayer;
      flDead.pt.x = flSrc.pt.x;
      flDead.pt.y = flSrc.pt.y;
      flDead.idPlanet = flSrc.idPlanet;
      CreateSalvage(&flDead,(THING **)&lpthBattle);
    }
    if ((((FLEET *)lpfl)->wFlags_0x4 >> 10 & 1) == 0) {
      pFVar7 = &flSrc;
      for (iVar4 = 0x3e; iVar4 != 0; iVar4 = iVar4 + -1) {
        pFVar2 = (FLEET *)lpfl;
        lpfl._0_2_ = &((FLEET *)lpfl)->iPlayer;
        pFVar1 = pFVar7;
        pFVar7 = &pFVar7->iPlayer;
        pFVar2->id = pFVar1->id;
      }
    }
  }
  return;
}



// ======================================================================
// Function: CreateSalvage
// Address: 10f0:7ee8
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Restarted to delay deadcode elimination for space: ram */

void CreateSalvage(FLEET *pfl,THING **plpth)

{
  uint *puVar1;
  undefined2 *puVar2;
  undefined2 *puVar3;
  uint uVar4;
  uint uVar5;
  short sVar6;
  short sVar7;
  uint uVar8;
  int iVar9;
  undefined2 unaff_SI;
  undefined2 *puVar10;
  undefined2 *puVar11;
  undefined2 unaff_SS;
  bool bVar12;
  ulong uVar13;
  long lVar14;
  undefined4 in_stack_0000ff48;
  long lVar15;
  ushort in_stack_0000ff4c;
  short fBleeding;
  short j;
  uint rgwtMinerals [6];
  short i;
  PLANET *lppl;
  undefined1 *lpshdefT;
  undefined2 uVar16;
  uint wtTotal;
  int local_6;
  
  lVar15 = CONCAT22((HullDef)((ulong)in_stack_0000ff48 >> 0x10),unaff_SI);
  sVar7 = GetRaceGrbit((PLAYER *)rgplr + pfl->iPlayer,ibitRaceBleedingEdgeTech);
  gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfff7 | 8;
  idPlayer = pfl->iPlayer;
  if (pfl->idPlanet == -1) {
    lppl = (PLANET *)0x0;
  }
  else {
    lppl = LpplFromId(pfl->idPlanet);
  }
  for (i = 0; sVar6 = i, i < 3; i = i + 1) {
    rgwtMinerals[i * 2] = 0;
    rgwtMinerals[sVar6 * 2 + 1] = 0;
    for (j = 0; sVar6 = i, j < 0x10; j = j + 1) {
      if (0 < pfl->rgcsh[j]) {
        if (sVar7 == 0) {
          iVar9 = pfl->iPlayer * 4;
          lpshdefT = (undefined1 *)(*(int *)(iVar9 + rglpshdef) + j * 0x93);
          uVar16 = *(undefined2 *)(iVar9 + 0x100);
        }
        else {
          iVar9 = pfl->iPlayer * 4;
          uVar16 = *(undefined2 *)(iVar9 + 0x100);
          puVar10 = (undefined2 *)(*(int *)(iVar9 + rglpshdef) + j * 0x93);
          puVar11 = &stack0xff4a;
          for (iVar9 = 0x49; iVar9 != 0; iVar9 = iVar9 + -1) {
            puVar3 = puVar11;
            puVar11 = puVar11 + 1;
            puVar2 = puVar10;
            puVar10 = puVar10 + 1;
            *puVar3 = *puVar2;
          }
          *(undefined1 *)puVar11 = *(undefined1 *)puVar10;
          UpdateShdefCost(&stack0xff4a);
          lpshdefT = &stack0xff4a;
          uVar16 = unaff_SS;
        }
        lVar14 = 3;
        uVar13 = __aFulmul((long)pfl->rgcsh[j],(ulong)*(uint *)(lpshdefT + i * 2 + 0x2c));
        lVar14 = __aFldiv(uVar13,lVar14);
        sVar6 = i;
        puVar1 = rgwtMinerals + i * 2;
        uVar8 = *puVar1;
        *puVar1 = *puVar1 + (uint)lVar14;
        rgwtMinerals[sVar6 * 2 + 1] =
             rgwtMinerals[sVar6 * 2 + 1] + (int)((ulong)lVar14 >> 0x10) +
             (uint)CARRY2(uVar8,(uint)lVar14);
      }
    }
    uVar4 = *(uint *)(pfl->rgwtMin + i);
    uVar5 = *(uint *)((int)(pfl->rgwtMin + i) + 2);
    puVar1 = rgwtMinerals + i * 2;
    uVar8 = *puVar1;
    *puVar1 = *puVar1 + uVar4;
    rgwtMinerals[sVar6 * 2 + 1] = rgwtMinerals[sVar6 * 2 + 1] + uVar5 + (uint)CARRY2(uVar8,uVar4);
    if (((PLANET *)lppl != (PLANET *)0x0) || (lppl._2_2_ != 0)) {
      lVar14 = 10;
      if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0) {
        uVar8 = 5;
      }
      else {
        uVar8 = 8;
      }
      uVar13 = __aFulmul(CONCAT22(rgwtMinerals[i * 2 + 1],rgwtMinerals[i * 2]),(ulong)uVar8)
      ;
      lVar14 = __aFldiv(uVar13,lVar14);
      puVar1 = (uint *)(((PLANET *)lppl)->rgwtMin + i);
      uVar8 = *puVar1;
      *puVar1 = *puVar1 + (uint)lVar14;
      puVar1 = (uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
      *puVar1 = *puVar1 + (int)((ulong)lVar14 >> 0x10) + (uint)CARRY2(uVar8,(uint)lVar14);
    }
  }
  if (((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) {
    wtTotal = 0;
    local_6 = 0;
    for (i = 0; i < 3; i = i + 1) {
      lVar14 = __aFlshr(lVar15,in_stack_0000ff4c);
      sVar7 = i;
      puVar1 = rgwtMinerals + i * 2;
      uVar8 = *puVar1;
      *puVar1 = *puVar1 - (uint)lVar14;
      rgwtMinerals[sVar7 * 2 + 1] =
           (rgwtMinerals[sVar7 * 2 + 1] - (int)((ulong)lVar14 >> 0x10)) -
           (uint)(uVar8 < (uint)lVar14);
      bVar12 = CARRY2(wtTotal,rgwtMinerals[i * 2]);
      wtTotal = wtTotal + rgwtMinerals[i * 2];
      local_6 = local_6 + rgwtMinerals[i * 2 + 1] + (uint)bVar12;
    }
    if ((wtTotal != 0) || (local_6 != 0)) {
      DropSalvage(plpth,(long *)rgwtMinerals,pfl->iPlayer,&pfl->pt);
    }
  }
  gd.grBits2._0_2_ = (uint)gd.grBits2 & 0xfff7;
  idPlayer = -1;
  return;
}



// ======================================================================
// Function: FDamageTok
// Address: 10f0:81d4
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f08849) */
/* WARNING: Removing unreachable block (ram,0x10f0827b) */
/* WARNING: Removing unreachable block (ram,0x10f087c1) */
/* WARNING: Removing unreachable block (ram,0x10f08ab8) */

short FDamageTok(TOK *ptok,short itok,long *pdpBeam,long dpTorp,ushort grfWeapon,
                  short fShieldsOnly,long *pcTorp)

{
  byte *pbVar1;
  PLANET *pPVar2;
  ulong uVar3;
  ushort uVar4;
  ushort uVar5;
  uint ishdef_00;
  short sVar6;
  uint *puVar7;
  uint uVar8;
  TOK *pTVar9;
  byte *pbVar10;
  undefined2 uVar11;
  bool bVar12;
  SHDEF *pSVar13;
  PLANET *lppl_00;
  FLEET *lpfl_00;
  ulong uVar14;
  ulong uVar15;
  ulong uVar16;
  long lVar17;
  uint uVar18;
  undefined2 uVar19;
  undefined2 uVar20;
  undefined2 uVar21;
  int iVar22;
  short sVar23;
  ushort pctDpNew;
  uint dp;
  int local_34;
  short ishdef;
  short pctDp;
  short csh;
  int cKillMax;
  int local_26;
  FLEET *lpfl;
  undefined2 local_22;
  short cshOrig;
  short i;
  PLANET *lppl;
  uint ddpOrig;
  int local_12;
  short cshOrigDamaged;
  ushort *pwLosses;
  DV dv;
  short pctSh;
  
  dp = *(uint *)pdpBeam;
  local_34 = *(int *)((int)pdpBeam + 2);
  __fmemset(lpbBattleCur,0,8);
  *lpbBattleCur = (byte)itok;
  ((byte *)lpbBattleCur)[1] = (byte)grfWeapon;
  uVar11 = (undefined2)((ulong)ptok >> 0x10);
  pTVar9 = (TOK *)ptok;
  if (pTVar9->dpShield == 0) {
    if (fShieldsOnly != 0) {
      return 0;
    }
  }
  else {
    uVar8 = pTVar9->dpShield;
    uVar5 = pTVar9->dpShield;
    uVar14 = __aFulmul((ulong)uVar8,(ulong)pTVar9->csh);
    if (CONCAT22(local_34,dp) < (long)uVar14) {
      uVar4 = WPackLong(CONCAT22(local_34,dp));
      *(ushort *)((byte *)lpbBattleCur + 4) = uVar4;
      lVar17 = __aFldiv(uVar14 - CONCAT22(local_34,dp),(ulong)pTVar9->csh);
      pTVar9->dpShield = (int)lVar17 + (uVar5 - uVar8);
      dp = 0;
      local_34 = 0;
    }
    else {
      bVar12 = dp < (uint)uVar14;
      dp = dp - (uint)uVar14;
      local_34 = (local_34 - (int)(uVar14 >> 0x10)) - (uint)bVar12;
      uVar5 = WPackLong(uVar14);
      *(ushort *)((byte *)lpbBattleCur + 4) = uVar5;
      pTVar9->dpShield = 0;
    }
  }
  if ((((dp == 0) && (local_34 == 0)) || (fShieldsOnly != 0)) && (dpTorp == 0)) {
    *(ushort *)((byte *)lpbBattleCur + 6) = (&pTVar9->dv)->dp;
    *(uint *)pdpBeam = dp;
    *(int *)((int)pdpBeam + 2) = local_34;
    uVar11 = (undefined2)((ulong)lpbBattleCur >> 0x10);
    if ((((byte *)lpbBattleCur)[1] & 4) != 0) {
      pbVar1 = (byte *)lpbBattleCur + 1;
      *pbVar1 = *pbVar1 | 0xc0;
    }
    lpbBattleCur = (byte *)lpbBattleCur + 8;
  }
  else {
    if (pcTorp == (long *)0x0) {
      cKillMax = -1;
      local_26 = 0x7fff;
    }
    else {
      cKillMax = (int)*pcTorp;
      local_26 = *(int *)((int)pcTorp + 2);
    }
    uVar14 = dpTorp + CONCAT22(local_34,dp);
    uVar16 = dpTorp + CONCAT22(local_34,dp);
    ishdef_00 = (uint)*(byte *)((int)&pTVar9->u_TOK_0x0003 + 1);
    pSVar13 = LpshdefFromTok(ptok);
    uVar8 = (((SHDEF *)pSVar13)->hul).dp;
    uVar3 = (ulong)uVar8;
    uVar18 = (&pTVar9->dv)->dp;
    if (*&pTVar9->u_TOK_0x0003 == '\x01') {
      lppl_00 = LpplFromId(ptok->id);
      uVar19 = (undefined2)((ulong)lppl_00 >> 0x10);
      pPVar2 = (PLANET *)lppl_00;
      if (uVar18 >> 7 != 0) {
        uVar20 = 0;
        uVar21 = 500;
        uVar14 = __aFulmul((ulong)uVar8,(ulong)(uVar18 >> 7));
        lVar17 = __aFldiv(uVar14,CONCAT22(uVar20,uVar21));
        uVar16 = lVar17 + uVar16;
      }
      dp = (uint)uVar16;
      if (((long)uVar16 < 0) || (((long)uVar16 < 0x10000 && (dp < uVar8)))) {
        uVar21 = 0;
        uVar18 = uVar8;
        uVar14 = __aFulmul(uVar16,500);
        lVar17 = __aFldiv(uVar14,CONCAT22(uVar21,uVar18));
        if (*(uint *)&pPVar2->lStarbase >> 4 == (uint)lVar17) {
          lVar17 = pPVar2->lStarbase;
          *(uint *)&pPVar2->lStarbase = *(uint *)&pPVar2->lStarbase & 0xf;
          *(uint *)&pPVar2->lStarbase = *(uint *)&pPVar2->lStarbase | (int)lVar17 + 0x10U & 0xfff0;
        }
        else {
          uVar21 = 0;
          uVar14 = __aFulmul(uVar16,500);
          lVar17 = __aFldiv(uVar14,CONCAT22(uVar21,uVar8));
          *(uint *)&pPVar2->lStarbase = *(uint *)&pPVar2->lStarbase & 0xf | (int)lVar17 << 4;
        }
        uVar21 = (undefined2)((ulong)lpbBattleCur >> 0x10);
        *(uint *)((byte *)lpbBattleCur + 6) =
             *(uint *)((byte *)lpbBattleCur + 6) & 0x7f |
             (*(uint *)&pPVar2->lStarbase >> 4) << 7;
        fStarbaseDamaged = 1;
      }
      else {
        uVar21 = (undefined2)((ulong)lpbBattleCur >> 0x10);
        *(uint *)((byte *)lpbBattleCur + 6) =
             *(uint *)((byte *)lpbBattleCur + 6) & 0x7f | 64000;
        uVar14 = (ulong)lpbBattleCur >> 0x10;
        pbVar10 = (byte *)lpbBattleCur;
        (pbVar10 + 2)[0] = 1;
        (pbVar10 + 2)[1] = 0;
        pTVar9->wFlags = pTVar9->wFlags & 0xfffe;
        pTVar9->csh = 0;
        fStarbaseDied = 1;
        sVar6 = GetRaceStat((PLAYER *)rgplr + pPVar2->iPlayer,rsMajorAdv);
        if (sVar6 != raMacintosh) {
          pPVar2->wFlags_0x4 = pPVar2->wFlags_0x4 & 0xfdff;
          KillQueuedShips(lppl_00);
          KillQueuedMassPackets(lppl_00);
        }
      }
      uVar19 = (undefined2)((ulong)lpbBattleCur >> 0x10);
      pbVar10 = (byte *)lpbBattleCur;
      if (*(uint *)(pbVar10 + 6) >> 7 != 0) {
        *(uint *)(pbVar10 + 6) = *(uint *)(pbVar10 + 6) & 0xff80 | 100;
        (&pTVar9->dv)->dp = *(ushort *)((byte *)lpbBattleCur + 6);
      }
      *(undefined2 *)pdpBeam = 0;
      *(undefined2 *)((int)pdpBeam + 2) = 0;
      lpbBattleCur = (byte *)lpbBattleCur + 8;
    }
    else {
      if ((pTVar9->wFlags_0x17 >> 8 & 0xf) == 1) {
        pTVar9->wFlags_0x17 = pTVar9->wFlags_0x17 & 0xf0ff;
        pTVar9->wFlags = pTVar9->wFlags & 0xfc1f | 0xe0;
      }
      lpfl_00 = LpflFromId(ptok->id);
      uVar5 = pTVar9->csh;
      if (uVar18 >> 7 == 0) {
        cshOrigDamaged = 0;
        uVar16 = 0;
      }
      else {
        uVar21 = 0;
        uVar19 = 100;
        uVar16 = __aFulmul((long)(int)uVar5,(ulong)(uVar18 & 0x7f));
        lVar17 = __aFldiv(uVar16,CONCAT22(uVar21,uVar19));
        cshOrigDamaged = (short)lVar17;
        if (cshOrigDamaged == 0) {
          cshOrigDamaged = 1;
        }
        uVar21 = 0;
        uVar19 = 500;
        uVar16 = __aFulmul((ulong)uVar8,(ulong)(uVar18 >> 7));
        uVar16 = __aFldiv(uVar16,CONCAT22(uVar21,uVar19));
        if (uVar16 == 0) {
          uVar16 = 1;
        }
      }
      sVar6 = cshOrigDamaged;
      local_12 = (int)(uVar16 >> 0x10);
      ddpOrig = (uint)uVar16;
      puVar7 = vrgPlrLosses + (uint)pTVar9->iplr * 0x10 + ishdef_00;
      *puVar7 = *puVar7 | 0x8000;
      csh = uVar5;
      if (cshOrigDamaged != 0) {
        csh = cshOrigDamaged;
        lVar17 = CONCAT22(-(uint)(uVar8 < ddpOrig) - local_12,uVar8 - ddpOrig);
        while (((lVar17 <= (long)uVar14 && (csh != 0)) && ((cKillMax != 0 || (local_26 != 0))))) {
          uVar14 = uVar14 - lVar17;
          csh = csh + -1;
          bVar12 = cKillMax == 0;
          cKillMax = cKillMax + -1;
          local_26 = local_26 - (uint)bVar12;
          if ((*puVar7 & 0x1fff) < 0x1fff) {
            *puVar7 = *puVar7 + 1;
          }
        }
        uVar3 = uVar16 + lVar17;
        cshOrigDamaged = csh;
        csh = csh + (uVar5 - sVar6);
      }
      while ((((long)uVar3 <= (long)uVar14 && (csh != 0)) && ((cKillMax != 0 || (local_26 != 0)))))
      {
        uVar14 = uVar14 - uVar3;
        csh = csh + -1;
        bVar12 = cKillMax == 0;
        cKillMax = cKillMax + -1;
        local_26 = local_26 - (uint)bVar12;
        if ((*puVar7 & 0x1fff) < 0x1fff) {
          *puVar7 = *puVar7 + 1;
        }
      }
      if ((local_26 < 1) && ((local_26 < 0 || (cKillMax == 0)))) {
        uVar14 = 0;
      }
      iVar22 = cshOrigDamaged >> 0xf;
      if ((uVar14 == 0) || (csh == 0)) {
        if (cshOrigDamaged == 0) {
          pctSh = 0;
          pctDp = 0;
        }
        else {
          sVar6 = csh;
          sVar23 = csh;
          uVar16 = __aFulmul((long)cshOrigDamaged,100);
          lVar17 = __aFldiv(uVar16 + CONCAT22(csh >> 0xf,sVar23) + -1,CONCAT22(sVar23,sVar6)
                                   );
          pctSh = (short)lVar17;
          pctDp = (&pTVar9->dv)->dp >> 7;
        }
      }
      else {
        if (cshOrigDamaged != 0) {
          uVar16 = __aFulmul(uVar16,(long)cshOrigDamaged);
          uVar14 = uVar16 + CONCAT22(csh >> 0xf,iVar22) + -1 + uVar14;
        }
        uVar14 = __aFldiv(uVar14,(long)csh);
        if (uVar14 == 0) {
          uVar14 = 1;
        }
        uVar16 = uVar3;
        uVar15 = __aFulmul(uVar14,500);
        lVar17 = __aFldiv(uVar15 + uVar3 + -1,uVar16);
        pctDp = (short)lVar17;
        if (pctDp == 0) {
          pctDp = 1;
        }
        pctSh = 100;
      }
      *(ushort *)((byte *)lpbBattleCur + 2) = pTVar9->csh - csh;
      if (csh != pTVar9->csh) {
        KillShips(ptok,*(short *)((byte *)lpbBattleCur + 2),ishdef_00,lpfl_00,1);
      }
      local_22 = (undefined2)((ulong)lpfl_00 >> 0x10);
      lpfl = (FLEET *)lpfl_00;
      if (csh != 0) {
        if (499 < pctDp) {
          pctDp = 499;
        }
        uVar8 = pctDp << 7 | pctSh & 0x7fU;
        (&pTVar9->dv)->dp = uVar8;
        lpfl->rgcsh[ishdef_00 + 0x10] = uVar8;
        uVar14 = 0;
      }
      if (dpTorp < (long)uVar14) {
        *(int *)pdpBeam = (int)(uVar14 - dpTorp);
        *(undefined2 *)((int)pdpBeam + 2) = (int)(uVar14 - dpTorp >> 0x10);
      }
      else {
        *(undefined2 *)pdpBeam = 0;
        *(undefined2 *)((int)pdpBeam + 2) = 0;
      }
      *(ushort *)((byte *)lpbBattleCur + 6) = (&pTVar9->dv)->dp;
      lpbBattleCur = (byte *)lpbBattleCur + 8;
      if (pcTorp != (long *)0x0) {
        *(int *)pcTorp = cKillMax;
        *(int *)((int)pcTorp + 2) = local_26;
      }
    }
  }
  return 1;
}



// ======================================================================
// Function: DxyFromSpdRound
// Address: 10f0:8b28
// Segment: MEMORY_BATTLE
// ======================================================================


short DxyFromSpdRound(ushort spd,short iRound)

{
  uint uVar1;
  short dxy;
  
  dxy = (spd + 2) / 4;
  uVar1 = spd & 3;
  if (uVar1 == 0) {
    dxy = dxy + (uint)((iRound & 1U) == 0);
  }
  else if (uVar1 == 1) {
    dxy = dxy + (uint)((iRound & 3U) != 2);
  }
  else if (uVar1 == 3) {
    dxy = dxy + (uint)((iRound & 3U) == 0);
  }
  return dxy;
}



// ======================================================================
// Function: FDoCoolBattle
// Address: 10f0:8bcc
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f098b8) */
/* WARNING: Variable defined which should be unmapped: penvMemSav */

short FDoCoolBattle
          (FLEET *lpfl,short cplr,ushort *rggrfAttack,ushort grfPlayer,ushort grfSpectator)

{
  FLEET *pFVar1;
  int iVar2;
  ushort uVar3;
  byte *pbVar4;
  PLANET *pPVar5;
  byte *pbVar6;
  short (*pasVar7) [9];
  byte *pbVar8;
  short sVar9;
  uint uVar10;
  BTLDATA *pBVar11;
  TOK *pTVar12;
  undefined2 uVar13;
  byte *pbVar14;
  PLANET *pPVar15;
  ulong uVar16;
  long lVar17;
  undefined2 uVar18;
  short (*penvMemSav) [9];
  short env;
  ushort in_stack_0000fd78;
  long lwt;
  short itok;
  ushort wtNext;
  ushort rgPlrLosses [256];
  byte rgfInit [64];
  BTLDATA *lpbtldata;
  ushort brcOrig;
  FLEET *lpflT;
  short iRound;
  BTLREC *lpbtlrec;
  short initMin;
  short j;
  short i;
  ushort grplrLeft;
  ushort wtT;
  short init;
  short initMac;
  byte *lpbSav;
  short cShdefsInvolved;
  ushort wt;
  TOK *ptok;
  byte *lpbMax;
  undefined2 local_8;
  short cShipsInvolved;
  
  pasVar7 = penvMem;
  if (lpbBattleLog == (byte *)0x0) {
    _penvMemSav = (short (*) [9])CONCAT22(env,penvMem);
    penvMem = &env;
    sVar9 = __setjmp(&env);
    pbVar14 = (byte *)CONCAT22(lpbBattleT._2_2_,(byte *)lpbBattleT);
    if (sVar9 != 0) {
      sVar9 = -1;
      penvMem = pasVar7;
      pbVar4 = lpbBattleLog;
      pbVar6 = lpbBattleCur;
      goto LAB_10f0_9911;
    }
    pbVar14 = LpAlloc(0xffc8,htBattle);
    lpbBattleLog = pbVar14;
    lpbBattleCur = pbVar14;
  }
  pasVar7 = penvMem;
  pbVar14 = (byte *)CONCAT22(lpbBattleT._2_2_,(byte *)lpbBattleT);
  lpbSav = lpbBattleCur;
  if (((byte *)lpbBattleT == (byte *)0x0) &&
     (pbVar14 = (byte *)CONCAT22(lpbBattleT._2_2_,(byte *)lpbBattleT),
     lpbBattleT._2_2_ == 0)) {
    _penvMemSav = (short (*) [9])CONCAT22(env,penvMem);
    penvMem = &env;
    sVar9 = __setjmp(&env);
    pbVar14 = (byte *)CONCAT22(lpbBattleT._2_2_,(byte *)lpbBattleT);
    if (sVar9 != 0) {
      sVar9 = -1;
      penvMem = pasVar7;
      pbVar4 = lpbBattleLog;
      pbVar6 = lpbBattleCur;
      goto LAB_10f0_9911;
    }
    pbVar14 = LpAlloc(0xffc8,htBattle);
    lpbSav = lpbBattleCur;
  }
  lpbBattleT._2_2_ = (int)((ulong)pbVar14 >> 0x10);
  lpbBattleT._0_2_ = (byte *)pbVar14;
  lpbMax = (byte *)lpbBattleT + -0x48;
  local_8 = lpbBattleT._2_2_;
  lpbBattleT = pbVar14;
  lpbBattleCur = pbVar14;
  _memset(rgPlrLosses,0,0x200);
  vrgPlrLosses = rgPlrLosses;
  _memset(rgfInit,0,0x40);
  __fmemset((TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok),0,0x1d00);
  vctok = 0;
  lpbtldata = lpbBattleCur;
  lpbBattleCur._0_2_ = (byte *)lpbBattleCur + 0xe;
  _memset((byte *)rgTechBattle,0,6);
  _memset((byte *)rgTechTrader,0,0xd);
  lpthBattle._0_2_ = (THING *)0x0;
  lpthBattle._2_2_ = 0;
  cShdefsInvolved = 0;
  cShipsInvolved = 0;
  fStarbaseDied = 0;
  fStarbaseDamaged = 0;
  lpflT = lpfl;
  do {
    if ((((FLEET *)lpflT)->wFlags_0x4 >> 10 & 1) == 0) {
      for (i = 0; i < 0x10; i = i + 1) {
        if (0 < ((FLEET *)lpflT)->rgcsh[i]) {
          cShipsInvolved = cShipsInvolved + ((FLEET *)lpflT)->rgcsh[i];
          rgPlrLosses[((FLEET *)lpflT)->iPlayer * 0x10 + i] = 0x8000;
        }
      }
    }
    uVar13 = (undefined2)((ulong)lpflT >> 0x10);
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET *)lpflT)->lpflNext;
    iVar2 = *(int *)((int)&((FLEET *)lpflT)->lpflNext + 2);
    lpflT = (FLEET *)CONCAT22(iVar2,pFVar1);
  } while ((lpfl != lpflT) && ((pFVar1 != (FLEET *)0x0 || (iVar2 != 0))));
  for (i = 0; i < 0x100; i = i + 1) {
    if (rgPlrLosses[i] != 0) {
      rgPlrLosses[i] = 0;
      cShdefsInvolved = cShdefsInvolved + 1;
    }
  }
  if (((FLEET *)lpfl)->idPlanet != -1) {
    pPVar15 = LpplFromId(((FLEET *)lpfl)->idPlanet);
    uVar13 = (undefined2)((ulong)pPVar15 >> 0x10);
    pPVar5 = (PLANET *)pPVar15;
    if (((pPVar5->wFlags_0x4 >> 9 & 1) != 0) &&
       ((1 << ((byte)pPVar5->iPlayer & 0x1f) & grfPlayer) != 0)) {
      cShdefsInvolved = cShdefsInvolved + 1;
      cShipsInvolved = cShipsInvolved + 1;
      *(uint *)((int)&pPVar5->lStarbase + 2) =
           *(uint *)((int)&pPVar5->lStarbase + 2) & 0xbfff | 0x4000;
    }
  }
  InitializeBoard(lpfl,((cplr + -1) * cplr) / 2,grfPlayer,rgfInit,&initMin,&initMac);
  uVar13 = (undefined2)((ulong)lpbtldata >> 0x10);
  pBVar11 = (BTLDATA *)lpbtldata;
  pBVar11->cplr = (byte)cplr;
  pBVar11->ctok = (byte)vctok;
  pBVar11->idPlanet = ((FLEET *)lpfl)->idPlanet;
  sVar9 = (((FLEET *)lpfl)->pt).y;
  (&pBVar11->pt)->x = (&((FLEET *)lpfl)->pt)->x;
  (pBVar11->pt).y = sVar9;
  iVar2 = idBattle + 1;
  lpbtldata->id = idBattle;
  idBattle = iVar2;
  for (iRound = 0; iRound < 0x10; iRound = iRound + 1) {
    grplrLeft = 0;
    for (itok = 0; itok < vctok; itok = itok + 1) {
      if ((((TOK *)vrgtok)[itok].wFlags & 1) != 0) {
        grplrLeft = grplrLeft | 1 << (((TOK *)vrgtok)[itok].iplr & 0x1f);
        lwt._2_2_ = ((TOK *)vrgtok)[itok].wFlags_0x19 & 0xfff;
        ((TOK *)vrgtok)[itok].wFlags_0x19 = lwt._2_2_;
        if (((0 < iRound) && (((TOK *)vrgtok)[itok].dpShield != 0)) &&
           ((((TOK *)vrgtok)[itok].wFlags & 1) != 0)) {
          sVar9 = GetRaceGrbit((PLAYER *)rgplr +
                                     ((TOK *)vrgtok)[itok].iplr,
                                     ibitRaceRegeneratingShields);
          if (sVar9 != 0) {
            RegenShield((TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok + itok));
          }
        }
      }
    }
    if ((grplrLeft - 1 & grplrLeft) == 0) break;
    ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
    for (itok = 0; itok < vctok; itok = itok + 1) {
      uVar13 = (undefined2)((ulong)ptok >> 0x10);
      pTVar12 = (TOK *)ptok;
      if ((pTVar12->wFlags & 1) != 0) {
        if (*&pTVar12->u_TOK_0x0003 == '\x01') {
          pTVar12->wFlags = pTVar12->wFlags & 0x3fff;
        }
        else {
          sVar9 = DxyFromSpdRound(pTVar12->wFlags_0x19 >> 8 & 0xf,iRound);
          uVar13 = (undefined2)((ulong)ptok >> 0x10);
          ((TOK *)ptok)->wFlags = ((TOK *)ptok)->wFlags & 0x3fff | sVar9 << 0xe;
        }
      }
      ptok = (TOK *)ptok + 1;
    }
    for (j = 3; 0 < j; j = j + -1) {
      wt = 30000;
      i = vctok;
      do {
        wtNext = 0;
        ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
        for (itok = 0; itok < vctok; itok = itok + 1) {
          uVar13 = (undefined2)((ulong)ptok >> 0x10);
          if (((((TOK *)ptok)->wFlags & 1) == 0) || (((TOK *)ptok)->wt == 0xffff)) {
            i = i + -1;
          }
          else {
            uVar16 = __aFlshl((long)_penvMemSav,in_stack_0000fd78);
            uVar18 = 0;
            uVar13 = 100;
            uVar16 = __aFulmul((ulong)((TOK *)ptok)->wt,uVar16);
            lVar17 = __aFldiv(uVar16,CONCAT22(uVar18,uVar13));
            uVar13 = (undefined2)((ulong)ptok >> 0x10);
            wtT = (int)lVar17 + ((TOK *)ptok)->wt;
            if ((wtNext < wtT) && (wtT < wt)) {
              sVar9 = DxyFromSpdRound(((TOK *)ptok)->wFlags_0x19 >> 8 & 0xf,iRound);
              if (sVar9 != 0) {
                wtNext = wtT;
              }
            }
            uVar13 = lpbBattleCur._2_2_;
            pbVar8 = (byte *)lpbBattleCur;
            if (wtT == wt) {
              i = i + -1;
              uVar18 = (undefined2)((ulong)ptok >> 0x10);
              pTVar12 = (TOK *)ptok;
              if (j <= (int)(pTVar12->wFlags >> 0xe)) {
                lpbtlrec = (BTLREC *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur)
                ;
                lpbBattleCur._0_2_ = (byte *)lpbBattleCur + 6;
                lpbtlrec->itok = (byte)itok;
                (pbVar8 + 2)[0] = 0;
                (pbVar8 + 2)[1] = 0;
                *(uint *)(pbVar8 + 4) = *(uint *)(pbVar8 + 4) & 0xff | itok << 8;
                *(uint *)(pbVar8 + 4) = *(uint *)(pbVar8 + 4) & 0xfff0 | iRound & 0xfU;
                *(uint *)(pbVar8 + 4) =
                     *(uint *)(pbVar8 + 4) & 0xff0f | (pTVar12->wFlags >> 5 & 0xf) << 4;
                brcOrig = (ushort)((TOK *)vrgtok)[itok].brc;
                if ((pTVar12->wFlags_0x17 >> 8 & 0xf) == 0) {
                  brcOrig = 0xff;
                  if ((pTVar12->wFlags >> 5 & 0x1f) == 0) {
                    pbVar8[1] = 0xff;
                    pTVar12->wFlags = pTVar12->wFlags & 0xfffe;
                    goto LAB_10f0_91a1;
                  }
                  uVar3 = pTVar12->wFlags;
                  pTVar12->wFlags = pTVar12->wFlags & 0xfc1f;
                  pTVar12->wFlags = pTVar12->wFlags | uVar3 - 0x20 & 0x3e0;
                }
                DxyMoveTokTo(ptok,j,rggrfAttack[pTVar12->iplr]);
                uVar13 = (undefined2)((ulong)ptok >> 0x10);
                pTVar12 = (TOK *)ptok;
                uVar3 = pTVar12->wFlags;
                pTVar12->wFlags = pTVar12->wFlags & 0x3fff;
                pTVar12->wFlags = pTVar12->wFlags | uVar3 + 0xc000 & 0xc000;
                if ((*&pTVar12->u_TOK_0x0003 == '\x01') ||
                   ((brcOrig == pTVar12->brc && (pTVar12->initMin != 0xff)))) {
                  lpbBattleCur._0_2_ = (byte *)lpbBattleCur + -6;
                }
                else {
                  ((BTLREC *)lpbtlrec)->brcDest = pTVar12->brc;
                }
              }
            }
          }
LAB_10f0_91a1:
          ptok = (TOK *)ptok + 1;
        }
        wt = wtNext;
      } while (wtNext != 0);
    }
    grplrLeft = 0;
    for (i = 0; i < vctok; i = i + 1) {
      if ((((TOK *)vrgtok)[i].wFlags & 1) != 0) {
        uVar10 = Random(0xf);
        ((TOK *)vrgtok)[i].wFlags =
             ((TOK *)vrgtok)[i].wFlags & 0xc3ff | (uVar10 & 0xf) << 10;
        grplrLeft = grplrLeft | 1 << (((TOK *)vrgtok)[i].iplr & 0x1f);
      }
    }
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (((1 << ((byte)i & 0x1f) & grplrLeft) != 0) && ((grplrLeft & rggrfAttack[i]) == 0)) {
        grplrLeft = grplrLeft & ~(1 << ((byte)i & 0x1f));
      }
    }
    if ((grplrLeft - 1 & grplrLeft) == 0) break;
    for (init = initMac; initMin <= init; init = init + -1) {
      itok = vctok;
      if (rgfInit[init] != 0) {
        while (uVar18 = vrgtok._2_2_, uVar13 = lpbBattleCur._2_2_,
              pbVar8 = (byte *)lpbBattleCur, itok = itok + -1, -1 < itok) {
          if (((int)(uint)((TOK *)vrgtok)[itok].initMin <= init) &&
             (init <= (int)(uint)((TOK *)vrgtok)[itok].initMac)) {
            grplrLeft = 0;
            for (i = 0; i < vctok; i = i + 1) {
              if ((((TOK *)vrgtok)[i].wFlags & 1) != 0) {
                grplrLeft = grplrLeft | 1 << (((TOK *)vrgtok)[i].iplr & 0x1f);
              }
            }
            if ((grplrLeft - 1 & grplrLeft) == 0) break;
            pTVar12 = (TOK *)vrgtok + itok;
            ptok = (TOK *)CONCAT22(vrgtok._2_2_,pTVar12);
            if ((pTVar12->wFlags & 1) != 0) {
              lpbtlrec = (BTLREC *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur);
              lpbBattleCur._0_2_ = (byte *)lpbBattleCur + 6;
              lpbtlrec->itok = (byte)itok;
              (pbVar8 + 2)[0] = 0;
              (pbVar8 + 2)[1] = 0;
              *(uint *)(pbVar8 + 4) = *(uint *)(pbVar8 + 4) & 0xfff0 | iRound & 0xfU;
              pbVar8[1] = pTVar12->brc;
              *(uint *)(pbVar8 + 4) = *(uint *)(pbVar8 + 4) & 0xff | itok * 0x100;
              *(uint *)(pbVar8 + 4) =
                   *(uint *)(pbVar8 + 4) & 0xff0f | (pTVar12->wFlags >> 5 & 0xf) << 4;
              sVar9 = FAttack(itok,init,(BTLREC *)CONCAT22(uVar13,pbVar8),rggrfAttack[pTVar12->iplr]
                             );
              if (sVar9 == 0) {
                lpbBattleCur._0_2_ = (byte *)lpbBattleCur + -6;
              }
              else {
                uVar13 = (undefined2)((ulong)ptok >> 0x10);
                ((TOK *)ptok)->wFlags = ((TOK *)ptok)->wFlags & 0xffef;
              }
            }
          }
        }
      }
    }
    if ((grplrLeft - 1 & grplrLeft) == 0) break;
  }
  ((BTLDATA *)lpbtldata)->cbData = (int)(byte *)lpbBattleCur - (int)(BTLDATA *)lpbtldata;
  SendBattleMessages(lpfl,cplr,lpbtldata->id,rgPlrLosses,grfPlayer,cShipsInvolved,cShdefsInvolved,
                     grfSpectator);
  uVar13 = (undefined2)((ulong)lpbtldata >> 0x10);
  pBVar11 = (BTLDATA *)lpbtldata;
  pBVar11->grfPlr = grfPlayer;
  if (((byte *)lpbSav < (byte *)0xffc9) && (-(int)(byte *)lpbSav - 0x38U < pBVar11->cbData)) {
    lpbSav[0] = 0xff;
    lpbSav[1] = 0xff;
    lpbBattleT = (byte *)0x0;
  }
  else {
    __fmemmove(lpbSav,lpbtldata,pBVar11->cbData);
    lpbBattleCur._0_2_ = (byte *)lpbSav + ((BTLDATA *)lpbtldata)->cbData;
    lpbBattleCur._2_2_ = lpbSav._2_2_;
  }
  sVar9 = 1;
  pbVar4 = lpbBattleLog;
  pbVar14 = lpbBattleT;
  pbVar6 = (byte *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur);
LAB_10f0_9911:
  lpbBattleCur._2_2_ = (undefined2)((ulong)pbVar6 >> 0x10);
  lpbBattleCur._0_2_ = (byte *)pbVar6;
  lpbBattleT._2_2_ = (int)((ulong)pbVar14 >> 0x10);
  lpbBattleT._0_2_ = (byte *)pbVar14;
  lpbBattleLog._2_2_ = (undefined2)((ulong)pbVar4 >> 0x10);
  lpbBattleLog._0_2_ = (byte *)pbVar4;
  return sVar9;
}



// ======================================================================
// Function: ITechLearnATech
// Address: 10f0:9918
// Segment: MEMORY_BATTLE
// ======================================================================


short ITechLearnATech(short iplr,short x,short y,MessageId idm,ushort *piGoto)

{
  uint *puVar1;
  uint uVar2;
  short sVar3;
  short sVar4;
  int iVar5;
  ushort uVar6;
  uint *puVar7;
  long lVar8;
  long lVar9;
  ulong uVar10;
  undefined4 uVar11;
  uint uVar12;
  short iTech;
  short i;
  short fBattle;
  ushort iGoto;
  
  if (((*(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) >> 3 & 1) == 0) &&
     (sVar3 = Random(100), 0x31 < sVar3)) {
    for (i = 0; i < 0xd; i = i + 1) {
      sVar3 = Random(0xd);
      if (((((byte *)rgTechTrader)[sVar3] != 0) &&
          ((1 << ((byte)sVar3 & 0x1f) &
           *(uint *)((int)&rgplr[0].grbitTrader + iplr * 0xc0)) == 0)) &&
         (sVar4 = Random(100), sVar4 < (int)(uint)((byte *)rgTechTrader)[sVar3]))
      {
        sVar4 = IdmGiveTraderPart(1 << ((byte)sVar3 & 0x1f),iplr,&iGoto);
        if (idm != ~idmColonistsDroppedMassacredGroundTroops) {
          FSendPlrMsg2(iplr,sVar4 + idmStarbaseHasBuiltNew,iGoto,x,y);
        }
        else if (piGoto != (ushort *)0x0) {
          *piGoto = iGoto;
        }
        *(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) =
             *(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) & 0xfff7 | 8;
        return -(sVar3 + 1);
      }
    }
    for (i = 0; i < 6; i = i + 1) {
      sVar3 = Random(6);
      iVar5 = (int)*(char *)(iplr * 0xc0 + 0x59bc + sVar3);
      if (iVar5 < (int)(uint)((byte *)rgTechBattle)[sVar3]) {
        lVar8 = GetTechLevelCost(sVar3,*(char *)(iplr * 0xc0 + 0x59bc + sVar3) + 1,iplr);
        uVar6 = (ushort)((ulong)lVar8 >> 0x10);
        lVar8 = CONCAT22((int)lVar8,iVar5);
        if ((game.wCrap >> 1 & 1) != 0) {
          lVar8 = __aFlshr(lVar8,uVar6);
          uVar6 = (ushort)((ulong)lVar8 >> 0x10);
          lVar8 = lVar8 << 0x10;
        }
        uVar12 = (uint)((ulong)lVar8 >> 0x10);
        lVar8 = CONCAT22(uVar12,uVar6);
        puVar7 = (uint *)(iplr * 0xc0 + 0x59c2 + sVar3 * 4);
        puVar1 = puVar7;
        uVar2 = *puVar1;
        *puVar1 = *puVar1 + uVar12;
        puVar1 = puVar7 + 1;
        *puVar1 = *puVar1 + uVar6 + (uint)CARRY2(uVar2,uVar12);
        if (idm != ~idmColonistsDroppedMassacredGroundTroops) {
          if ((game.wCrap >> 1 & 1) != 0) {
            lVar9 = __aFlshl(lVar8,uVar6);
            lVar8 = CONCAT22((int)lVar9,(int)lVar8);
          }
          uVar11 = 0;
          uVar10 = __aFulshr(0,(ushort)lVar8);
          FSendPlrMsg(iplr,idm,-2,x,y,sVar3,(short)((ulong)lVar8 >> 0x10),(short)uVar10,
                           (short)uVar11,(short)((ulong)uVar11 >> 0x10));
        }
        else if (piGoto != (ushort *)0x0) {
          *piGoto = 0xfffe;
        }
        *(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) =
             *(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) & 0xfff7 | 8;
        return sVar3 + 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: SendBattleMessages
// Address: 10f0:9c0e
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f0ab9e) */

void SendBattleMessages
          (FLEET *lpflBtl,short cplr,short idBtl,ushort *rgPlrLosses,short grfPlayer,
          short cShipsInvolved,short cShdefsInvolved,ushort grfSpectator)

{
  int iVar1;
  PLANET *pPVar2;
  bool bVar3;
  short sVar4;
  uint uVar5;
  FLEET *pFVar6;
  ushort unaff_SI;
  undefined2 uVar7;
  ulong uVar8;
  undefined4 uVar9;
  short x;
  short cThem;
  ushort *pwUs;
  short iThem;
  short cUsDead;
  short j;
  short idm;
  short i;
  short cThemDead;
  FLEET *lpfl;
  short y;
  short cUs;
  short fAlive;
  ushort *pwThem;
  PLANET *lppl;
  short isb;
  ushort *pw;
  uint lpopStarbase;
  int local_1a;
  undefined1 rgcfl [16];
  short iplr;
  short iplrStarbase;
  
  iplrStarbase = -1;
  lppl = (PLANET *)0x0;
  _memset(rgcfl,0,0x10);
  uVar7 = (undefined2)((ulong)lpflBtl >> 0x10);
  pFVar6 = (FLEET *)lpflBtl;
  if (pFVar6->idPlanet == -1) {
    x = (&pFVar6->pt)->x;
    y = (pFVar6->pt).y;
  }
  else {
    x = -1;
    y = pFVar6->idPlanet;
    lppl = LpplFromId(y);
    uVar7 = (undefined2)((ulong)lppl >> 0x10);
    pPVar2 = (PLANET *)lppl;
    iThem = pPVar2->iPlayer;
    if (iThem != -1) {
      if (((pPVar2->wFlags_0x4 >> 9 & 1) != 0) || (fStarbaseDied != 0)) {
        isb = *(uint *)&pPVar2->lStarbase & 0xf;
        iplrStarbase = iThem;
      }
      if ((fStarbaseDied != 0) &&
         (iplr = iThem,
         sVar4 = GetRaceStat((PLAYER *)rgplr + pPVar2->iPlayer,rsMajorAdv),
         sVar4 == raMacintosh)) {
        lpopStarbase = *(uint *)(pPVar2->rgwtMin + 3);
        local_1a = *(int *)((int)pPVar2->rgwtMin + 0xe);
        UninhabitPlanet(lppl);
      }
    }
  }
  lpfl = lpflBtl;
  do {
    uVar7 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar6 = (FLEET *)lpfl;
    if ((pFVar6->wFlags_0x4 >> 10 & 1) == 0) {
      for (i = 0; i < 0x10; i = i + 1) {
        if (0 < pFVar6->rgcsh[i]) {
          rgPlrLosses[pFVar6->iPlayer * 0x10 + i] = rgPlrLosses[pFVar6->iPlayer * 0x10 + i] | 0x4000
          ;
        }
      }
    }
                    /* WARNING: Load size is inaccurate */
    iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
    lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
  } while ((lpflBtl != lpfl) && ((pFVar6->lpflNext != (FLEET *)0x0 || (iVar1 != 0))));
  iplr = 0;
  do {
    if (game.cPlayer <= iplr) {
      return;
    }
    if ((1 << ((byte)iplr & 0x1f) & grfPlayer) == 0) {
      if ((((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) ||
         (((PLANET *)lppl)->iPlayer != iplr)) {
        if ((iplr & grfSpectator) != 0) {
          lpfl = lpflBtl;
          while( true ) {
            uVar7 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar6 = (FLEET *)lpfl;
            if (pFVar6->iPlayer == iplr) break;
                    /* WARNING: Load size is inaccurate */
            iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
            lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
            if ((lpflBtl == lpfl) || ((pFVar6->lpflNext == (FLEET *)0x0 && (iVar1 == 0)))) break;
          }
          if ((((FLEET *)lpfl != (FLEET *)0x0) || (lpfl._2_2_ != 0)) &&
             (((FLEET *)lpfl)->iPlayer == iplr)) {
            FSendPlrMsg(iplr,idmReportsBattleTookPlaceForcesInvolved,lpfl->id | 0x8000,lpfl->id
                             ,(&((FLEET *)lpfl)->pt)->x,(((FLEET *)lpfl)->pt).y,0,0,0,0);
            ITechLearnATech(iplr,x,y,idmWreckageBattleOccurredOrbitHasBoostedResearch,(ushort *)0x0)
            ;
          }
        }
      }
      else {
        FSendPlrMsg2(iplr,idmColonyReportsBattleTookPlaceOrbitForces,lppl->id,lppl->id,0);
        ITechLearnATech(iplr,x,y,idmFleetFoundWreckageBattleWhichHasBoosted,(ushort *)0x0);
      }
LAB_10f0_ad23:
      if ((1 << ((byte)iplr & 0x1f) & grfMissed) != 0) {
        lpfl = lpflBtl;
        while( true ) {
          uVar7 = (undefined2)((ulong)lpfl >> 0x10);
          pFVar6 = (FLEET *)lpfl;
          if ((pFVar6->iPlayer == iplr) && ((*(uint *)((int)&pFVar6->dirLong + 2) >> 7 & 1) != 0))
          break;
                    /* WARNING: Load size is inaccurate */
          iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
          lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
          if ((lpflBtl == lpfl) || ((pFVar6->lpflNext == (FLEET *)0x0 && (iVar1 == 0)))) break;
        }
        if ((((FLEET *)lpfl != (FLEET *)0x0) || (lpfl._2_2_ != 0)) &&
           ((((FLEET *)lpfl)->iPlayer == iplr &&
            ((*(uint *)((int)&((FLEET *)lpfl)->dirLong + 2) >> 7 & 1) != 0)))) {
          FSendPlrMsg2(iplr,idmDueExcessiveFleetManeuveringBattleAreaFleets,lpfl->id | 0x8000,x
                            ,y);
        }
      }
    }
    else {
      bVar3 = true;
      if ((fStarbaseDied == 0) ||
         (sVar4 = GetRaceStat((PLAYER *)rgplr + iplrStarbase,rsMajorAdv),
         sVar4 != raMacintosh)) {
        if (cplr == 2) {
          if (cShipsInvolved == 2) {
            pwThem = (ushort *)0x0;
            pwUs = (ushort *)0x0;
            pw = rgPlrLosses;
            for (i = 0; i < 0x10; i = i + 1) {
              for (j = 0; j < 0x10; j = j + 1) {
                if (*pw != 0) {
                  if (i == iplr) {
                    pwUs = pw;
                  }
                  else {
                    pwThem = pw;
                  }
                }
                pw = pw + 1;
              }
            }
            if (((pwUs == (ushort *)0x0) && (fStarbaseDied != 0)) ||
               ((pwUs != (ushort *)0x0 && ((*pwUs & 0x3fff) != 0)))) {
              if (((pwThem == (ushort *)0x0) && (fStarbaseDamaged != 0)) ||
                 ((pwThem != (ushort *)0x0 && ((*pwThem & 0x8000) != 0)))) {
                idm = 0x94;
              }
              else {
                idm = 0x92;
              }
              bVar3 = false;
            }
            else if (((pwThem == (ushort *)0x0) && (fStarbaseDied != 0)) ||
                    ((pwThem != (ushort *)0x0 && ((*pwThem & 0x3fff) != 0)))) {
              if (((pwUs == (ushort *)0x0) && (fStarbaseDamaged != 0)) ||
                 ((pwUs != (ushort *)0x0 && ((*pwUs & 0x8000) != 0)))) {
                idm = 0x93;
              }
              else {
                idm = 0x91;
              }
            }
            else {
              idm = 0x95;
            }
            if (pwUs == (ushort *)0x0) {
              i = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwUs - (int)rgPlrLosses >> 1;
              i = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
            if (pwThem == (ushort *)0x0) {
              j = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwThem - (int)rgPlrLosses >> 1;
              j = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
            FSendPlrMsg(iplr,idm,idBtl | 0x4000,x,y,i,j,0,0,0);
            if ((bVar3) &&
               (((((PLANET *)lppl == (PLANET *)0x0 && (lppl._2_2_ == 0)) ||
                 (((PLANET *)lppl)->iPlayer == -1)) || (iplr == ((PLANET *)lppl)->iPlayer)))) {
              ITechLearnATech(iplr,x,y,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                              (ushort *)0x0);
            }
          }
          else {
            if (cShdefsInvolved != 2) goto BATTLE_CommonCountingCode;
            pwThem = (ushort *)0x0;
            pwUs = (ushort *)0x0;
            pw = rgPlrLosses;
            for (i = 0; i < 0x10; i = i + 1) {
              for (j = 0; j < 0x10; j = j + 1) {
                if (*pw != 0) {
                  if (i == iplr) {
                    pwUs = pw;
                  }
                  else {
                    pwThem = pw;
                  }
                }
                pw = pw + 1;
              }
            }
            if (((pwUs == (ushort *)0x0) && (fStarbaseDied != 0)) ||
               ((pwUs != (ushort *)0x0 && ((*pwUs & 0x4000) == 0)))) {
              if (((pwThem == (ushort *)0x0) && (fStarbaseDamaged != 0)) ||
                 ((pwThem != (ushort *)0x0 && ((*pwThem & 0x8000) != 0)))) {
                idm = 0x99;
              }
              else {
                idm = 0x97;
              }
              bVar3 = false;
            }
            else if (((pwThem == (ushort *)0x0) && (fStarbaseDied != 0)) ||
                    ((pwThem != (ushort *)0x0 && ((*pwThem & 0x4000) == 0)))) {
              if (((pwUs == (ushort *)0x0) && (fStarbaseDamaged != 0)) ||
                 ((pwUs != (ushort *)0x0 && ((*pwUs & 0x8000) != 0)))) {
                idm = 0x98;
              }
              else {
                idm = 0x96;
              }
            }
            else {
              idm = 0x9a;
            }
            if (pwUs == (ushort *)0x0) {
              cUs = 1;
            }
            else {
              cUs = *pwUs & 0x1fff;
            }
            if (pwThem == (ushort *)0x0) {
              cThem = 1;
            }
            else {
              cThem = *pwThem & 0x1fff;
            }
            lpfl = lpflBtl;
            do {
              uVar7 = (undefined2)((ulong)lpfl >> 0x10);
              pFVar6 = (FLEET *)lpfl;
              if ((pFVar6->wFlags_0x4 >> 10 & 1) == 0) {
                if ((pFVar6->iPlayer == iplr) && (pwUs != (ushort *)0x0)) {
                  cUs = cUs + *(int *)((int)pFVar6 +
                                      (((int)pwUs - (int)rgPlrLosses >> 1) + pFVar6->iPlayer * -0x10
                                      ) * 2 + 0xc);
                }
                else if (pwThem != (ushort *)0x0) {
                  cThem = cThem + *(int *)((int)pFVar6 +
                                          (((int)pwThem - (int)rgPlrLosses >> 1) +
                                          pFVar6->iPlayer * -0x10) * 2 + 0xc);
                }
              }
                    /* WARNING: Load size is inaccurate */
              iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
              lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
            } while ((lpflBtl != lpfl) && ((pFVar6->lpflNext != (FLEET *)0x0 || (iVar1 != 0))));
            if (pwUs == (ushort *)0x0) {
              i = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwUs - (int)rgPlrLosses >> 1;
              i = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
            if (pwThem == (ushort *)0x0) {
              j = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwThem - (int)rgPlrLosses >> 1;
              j = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
            FSendPlrMsg(iplr,idm,idBtl | 0x4000,x,y,i,cUs,j,cThem,0);
            if ((bVar3) &&
               (((((PLANET *)lppl == (PLANET *)0x0 && (lppl._2_2_ == 0)) ||
                 (((PLANET *)lppl)->iPlayer == -1)) || (iplr == ((PLANET *)lppl)->iPlayer)))) {
              ITechLearnATech(iplr,x,y,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                              (ushort *)0x0);
            }
          }
        }
        else {
BATTLE_CommonCountingCode:
          cThem = 0;
          cUs = 0;
          pw = rgPlrLosses;
          for (i = 0; i < 0x10; i = i + 1) {
            for (j = 0; j < 0x10; j = j + 1) {
              if (*pw != 0) {
                if (i == iplr) {
                  pwUs = pw;
                  cUs = cUs + (*pw & 0x1fff);
                }
                else {
                  pwThem = pw;
                  cThem = cThem + (*pw & 0x1fff);
                  iThem = i;
                }
              }
              pw = pw + 1;
            }
          }
          iThem = iThem | 0x30;
          cUsDead = cUs;
          cThemDead = cThem;
          if (fStarbaseDied != 0) {
            if (iplrStarbase == iplr) {
              cUsDead = cUs + 1;
            }
            else if (iplrStarbase != -1) {
              cThemDead = cThem + 1;
            }
          }
          lpfl = lpflBtl;
          do {
            uVar7 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar6 = (FLEET *)lpfl;
            if ((pFVar6->wFlags_0x4 >> 10 & 1) == 0) {
              if (pFVar6->iPlayer == iplr) {
                for (i = 0; i < 0x10; i = i + 1) {
                  cUs = cUs + pFVar6->rgcsh[i];
                }
              }
              else {
                for (i = 0; i < 0x10; i = i + 1) {
                  cThem = cThem + pFVar6->rgcsh[i];
                }
              }
            }
                    /* WARNING: Load size is inaccurate */
            iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
            lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
          } while ((lpflBtl != lpfl) && ((pFVar6->lpflNext != (FLEET *)0x0 || (iVar1 != 0))));
          if (iplrStarbase == iplr) {
            cUs = cUs + 1;
          }
          else if (iplrStarbase != -1) {
            cThem = cThem + 1;
            iThem = iplrStarbase | 0x30;
          }
          if (cplr != 2) {
            if (cUsDead == 0) {
              if (cThem == cThemDead) {
                FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesForcesDestroyed,idBtl | 0x4000
                                 ,x,y,cplr,cUs,0,0,0);
              }
              else {
BATTLE_IndecisiveXWay:
                FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesLostForces2,idBtl | 0x4000,x,y
                                 ,cplr,cUsDead,cUs,cThemDead,cThem);
              }
            }
            else if (cThemDead == 0) {
              if (cUs != cUsDead) goto BATTLE_IndecisiveXWay;
              FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesEntireArmada,idBtl | 0x4000,x,y,
                               cplr,cUs,cThem,0,0);
            }
            else if (cThemDead == cThem) {
              FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesLostForces,idBtl | 0x4000,x,y,
                               cplr,cUsDead,cUs,0,0);
            }
            else if (cUsDead == cUs) {
              FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesEntireArmada2,idBtl | 0x4000,x,y
                               ,cplr,cUs,cThem,cThemDead,0);
            }
            else {
              FSendPlrMsg2(iplr,idmBattleTookPlacePressGotoButtonView,idBtl | 0x4000,x,y);
            }
            if (((((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) ||
                (((PLANET *)lppl)->iPlayer == -1)) || (iplr == ((PLANET *)lppl)->iPlayer)) {
              ITechLearnATech(iplr,x,y,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                              (ushort *)0x0);
            }
            goto LAB_10f0_ad23;
          }
          if (cThem == 1) {
            if ((iThem & 0xfU) == iplrStarbase) {
              j = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwThem - (int)rgPlrLosses >> 1;
              j = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
          }
          if (cUs == 1) {
            if (iplr == iplrStarbase) {
              i = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwUs - (int)rgPlrLosses >> 1;
              i = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
          }
          if (cThemDead == cThem) {
            if (cThemDead == 1) {
              if (cUsDead == 0) {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedTaking,idBtl | 0x4000,
                                 x,y,iThem,cUs,j,0,0);
              }
              else {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedHowever,idBtl | 0x4000
                                 ,x,y,iThem,cUs,j,cUsDead,0);
              }
            }
            else if (cUsDead == 0) {
              if (cUs == 1) {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstDestroyedEnemyForces,idBtl | 0x4000,x
                                 ,y,iThem,i,cThemDead,0,0);
              }
              else {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedEnemy,idBtl | 0x4000,x
                                 ,y,iThem,cUs,0,0,0);
              }
            }
            else {
              FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedEnemy2,idBtl | 0x4000,x,
                               y,iThem,cUs,cUsDead,0,0);
            }
          }
          else if (cUsDead == cUs) {
            if (cUsDead == 1) {
              if (cThemDead == 0) {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstDestroyedEnemysForces,idBtl | 0x4000,
                                 x,y,iThem,i,cThem,0,0);
              }
              else {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstDestroyedEnemysForces2,idBtl | 0x4000
                                 ,x,y,iThem,i,cThem,cThemDead,0);
              }
            }
            else if (cThemDead == 0) {
              if (cThem == 1) {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyed,idBtl | 0x4000,x,y,
                                 iThem,cUsDead,j,0,0);
              }
              else {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedEnemys,idBtl | 0x4000,
                                 x,y,iThem,cThem,0,0,0);
              }
            }
            else {
              FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedEnemys2,idBtl | 0x4000,x
                               ,y,iThem,cThem,cThemDead,0,0);
            }
          }
          else if (cUs == 1) {
            FSendPlrMsg(iplr,idmBattleTookPlaceAgainstNeitherNorEnemys,idBtl | 0x4000,x,y,iThem
                             ,i,cThem,cThemDead,0);
          }
          else if (cThem == 1) {
            FSendPlrMsg(iplr,idmBattleTookPlaceAgainstNeitherForcesNor2,idBtl | 0x4000,x,y,
                             iThem,cUs,j,cUsDead,0);
          }
          else {
            FSendPlrMsg(iplr,idmBattleTookPlaceAgainstNeitherForcesNor,idBtl | 0x4000,x,y,iThem
                             ,cUs,cThem,cUsDead,cThemDead);
          }
          if ((cUsDead != cUs) &&
             ((((PLANET *)lppl == (PLANET *)0x0 && (lppl._2_2_ == 0)) ||
              ((((PLANET *)lppl)->iPlayer == -1 || (iplr == ((PLANET *)lppl)->iPlayer)))))) {
            ITechLearnATech(iplr,x,y,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                            (ushort *)0x0);
          }
        }
      }
      else {
        if (iplr == iplrStarbase) {
          if ((local_1a < 0) || ((local_1a < 1 && (lpopStarbase < 0x3e9)))) {
            idm = 0x8e;
          }
          else {
            idm = 0x8d;
          }
        }
        else {
          idm = 0x144;
        }
        j = iplrStarbase << 5 | isb + 0x10U;
        uVar9 = 0;
        uVar8 = __aFulshr(0,unaff_SI);
        FSendPlrMsg(iplr,idm,idBtl | 0x4000,x,y,j,lpopStarbase,(short)uVar8,(short)uVar9,
                         (short)((ulong)uVar9 >> 0x10));
      }
    }
    iplr = iplr + 1;
  } while( true );
}



// ======================================================================
// Function: FAttackPlayer
// Address: 10f0:ae06
// Segment: MEMORY_BATTLE
// ======================================================================


short FAttackPlayer(FLEET *lpfl,short iplr)

{
  int iVar1;
  uint uVar2;
  undefined2 uVar3;
  short iplrT;
  short iplrCur;
  
  uVar3 = (undefined2)((ulong)lpfl >> 0x10);
  iVar1 = ((FLEET *)lpfl)->iPlayer;
  uVar2 = ((BTLPLAN **)rglpbtlplan)[iVar1 * 2][((FLEET *)lpfl)->iplan].wFlags_0x2 >> 8 &
          0x1f;
  if (uVar2 == 0) {
    uVar2 = 0;
  }
  else if (uVar2 == 1) {
    uVar2 = (uint)(*(char *)(iVar1 * 0xc0 + 0x5a12 + iplr) == '\x02');
  }
  else if (uVar2 == 2) {
    uVar2 = (uint)(*(char *)(iVar1 * 0xc0 + 0x5a12 + iplr) != '\x01');
  }
  else if (uVar2 == 3) {
    uVar2 = 1;
  }
  else {
    uVar2 = (uint)(iplr == uVar2 - 4);
  }
  return uVar2;
}



// ======================================================================
// Function: DoBombing
// Address: 10f0:aefa
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f0b098) */
/* WARNING: Removing unreachable block (ram,0x10f0bd6f) */
/* WARNING: Removing unreachable block (ram,0x10f0b9fa) */
/* WARNING: Removing unreachable block (ram,0x10f0b289) */
/* WARNING: Removing unreachable block (ram,0x10f0b063) */
/* WARNING: Removing unreachable block (ram,0x10f0b46a) */
/* WARNING: Removing unreachable block (ram,0x10f0b1ff) */
/* WARNING: Removing unreachable block (ram,0x10f0b5d9) */
/* WARNING: Removing unreachable block (ram,0x10f0ba57) */
/* WARNING: Removing unreachable block (ram,0x10f0b76f) */
/* WARNING: Removing unreachable block (ram,0x10f0b377) */
/* WARNING: Removing unreachable block (ram,0x10f0b0cd) */
/* WARNING: Removing unreachable block (ram,0x10f0b583) */
/* WARNING: Removing unreachable block (ram,0x10f0b102) */
/* WARNING: Removing unreachable block (ram,0x10f0b498) */
/* WARNING: Removing unreachable block (ram,0x10f0b2af) */
/* WARNING: Removing unreachable block (ram,0x10f0b39d) */
/* WARNING: Removing unreachable block (ram,0x10f0b481) */
/* WARNING: Removing unreachable block (ram,0x10f0b500) */
/* WARNING: Removing unreachable block (ram,0x10f0b5a6) */
/* WARNING: Removing unreachable block (ram,0x10f0b5f0) */
/* WARNING: Removing unreachable block (ram,0x10f0b616) */
/* WARNING: Removing unreachable block (ram,0x10f0b642) */
/* WARNING: Type propagation algorithm not settling */
/* WARNING: Removing unreachable block (ram,0x10f0b669) */
/* WARNING: Removing unreachable block (ram,0x10f0b691) */
/* WARNING: Removing unreachable block (ram,0x10f0b6ff) */

void DoBombing(void)

{
  uint *puVar1;
  int *piVar2;
  FLEET *pFVar3;
  int iVar4;
  qword qVar5;
  short sVar6;
  uint uVar7;
  uint uVar8;
  MessageId MVar9;
  int iVar10;
  PLANET *pPVar11;
  char *pcVar12;
  char *pcVar13;
  undefined2 unaff_SI;
  ushort unaff_DI;
  undefined2 uVar14;
  bool bVar15;
  long lVar16;
  ulong uVar17;
  ulong uVar18;
  long lVar19;
  undefined2 uVar20;
  short sVar21;
  undefined2 uVar22;
  short sVar23;
  uint in_stack_0000ffa4;
  int in_stack_0000ffa6;
  double pctSuccessHalf;
  long dmgPeopleSmart;
  float pctSuccess;
  float pctSmart;
  long dmgBombPeople;
  undefined4 cPPE;
  FLEET *lpfl;
  short ifl;
  PLANET *lppl;
  long pctTerra;
  undefined4 cKillFact;
  undefined4 cKillDefenses;
  short idmSrc;
  long dmgBombFloor;
  undefined4 cKillMine;
  undefined4 cKillPeopleS;
  long dmgBombBldg;
  undefined4 cKillPeople;
  short fMulti;
  undefined4 modKill;
  short idmDst;
  
  ifl = 0;
  do {
    if (cFleet <= ifl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pFVar3 = ((FLEET **)rglpfl)[ifl];
    iVar4 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar4,pFVar3);
    if ((pFVar3 == (FLEET *)0x0) && (iVar4 == 0)) {
      return;
    }
    if ((((pFVar3->wFlags_0x4 >> 10 & 1) == 0) && (pFVar3->idPlanet != -1)) &&
       ((pFVar3->wFlags_0x4 >> 0xc & 1) == 0)) {
      pPVar11 = (PLANET *)lpPlanets + pFVar3->idPlanet;
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,pPVar11);
      if ((pPVar11->iPlayer != pFVar3->iPlayer) && (pPVar11->iPlayer != -1)) {
        sVar6 = FAttackPlayer((FLEET *)CONCAT22(iVar4,pFVar3),pPVar11->iPlayer);
        if ((sVar6 != 0) && ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) == 0)) {
          sVar6 = FCalcFleetBombDamage
                            (lpfl,&dmgBombPeople,&dmgBombFloor,&dmgPeopleSmart,&dmgBombBldg,
                             &pctTerra,&fMulti);
          if (sVar6 != 0) {
            CalcPctSurvive(lppl,&pctSuccess,&pctSmart);
            bVar15 = (undefined1 *)0xfff7 < &stack0xff98;
            __aFfcompp();
            if (bVar15) {
              lVar19 = dmgBombFloor;
              if (0 < dmgBombPeople) {
                lVar19 = __ftol((double)CONCAT26(in_stack_0000ffa6,
                                                         CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                dmgBombPeople = lVar19;
                lVar19 = dmgBombFloor;
              }
              lVar16 = dmgPeopleSmart;
              if (0 < lVar19) {
                dmgBombFloor = lVar19;
                lVar19 = __ftol((double)CONCAT26(in_stack_0000ffa6,
                                                         CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                lVar16 = dmgPeopleSmart;
              }
              if (0 < lVar16) {
                dmgBombFloor = lVar19;
                dmgPeopleSmart = lVar16;
                lVar16 = __ftol((double)CONCAT26(in_stack_0000ffa6,
                                                         CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                lVar19 = dmgBombFloor;
              }
              dmgPeopleSmart = lVar16;
              dmgBombFloor = lVar19;
              if (0 < dmgBombBldg) {
                lVar19 = __ftol((double)CONCAT26(in_stack_0000ffa6,
                                                         CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                dmgBombBldg = lVar19;
              }
            }
            pctSuccessHalf._0_2_ = *(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff;
            uVar17 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
            in_stack_0000ffa4 = (uint)uVar17 & 0xfff;
            in_stack_0000ffa6 = 0;
            uVar17 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
            uVar7 = (uint)uVar17 & 0xfff;
            uVar8 = uVar7 + in_stack_0000ffa4;
            cPPE._0_2_ = uVar8 + pctSuccessHalf._0_2_;
            cPPE._2_2_ = in_stack_0000ffa6 + (uint)CARRY2(uVar7,in_stack_0000ffa4) +
                         (uint)CARRY2(uVar8,pctSuccessHalf._0_2_);
            cKillDefenses._0_2_ = 0;
            cKillDefenses._2_2_ = 0;
            cKillDefenses = 0;
            cKillPeople._0_2_ = 0;
            cKillPeople._2_2_ = 0;
            cKillMine._0_2_ = 0;
            cKillMine._2_2_ = 0;
            uVar17 = 0;
            cKillFact._0_2_ = 0;
            cKillFact._2_2_ = 0;
            cKillFact = 0;
            if (((0 < dmgBombBldg) &&
                (cKillFact = 0, cKillDefenses = 0, uVar17 = 0, -1 < cPPE._2_2_)) &&
               ((0 < cPPE._2_2_ || (cKillFact = 0, cKillDefenses = 0, uVar17 = 0, (int)cPPE != 0))))
            {
              uVar17 = dmgBombBldg;
              uVar18 = __aFulshr(dmgBombBldg,unaff_DI);
              cKillFact = __aFulmul((ulong)((uint)uVar18 & 0xfff),uVar17);
              lVar19 = __aFlrem(cKillFact,CONCAT22(cPPE._2_2_,(int)cPPE));
              modKill = lVar19;
              uVar17 = __aFldiv(cKillFact,CONCAT22(cPPE._2_2_,(int)cPPE));
              if (0 < modKill) {
                cKillFact = uVar17;
                sVar6 = Random((int)cPPE);
                uVar17 = cKillFact + (sVar6 < modKill);
              }
              cKillFact = uVar17;
              uVar17 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              if ((-1 < (long)cKillFact) &&
                 ((0xffff < (long)cKillFact || (((uint)uVar17 & 0xfff) < (uint)cKillFact)))) {
                uVar17 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
                cKillFact = (ulong)((uint)uVar17 & 0xfff);
              }
              cKillDefenses =
                   __aFulmul((ulong)(*(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff),
                                     dmgBombBldg);
              lVar19 = __aFlrem(cKillDefenses,CONCAT22(cPPE._2_2_,(int)cPPE));
              modKill = lVar19;
              uVar17 = __aFldiv(cKillDefenses,CONCAT22(cPPE._2_2_,(int)cPPE));
              if (0 < modKill) {
                cKillDefenses = uVar17;
                sVar6 = Random((int)cPPE);
                uVar17 = cKillDefenses + (sVar6 < modKill);
              }
              cKillDefenses._0_2_ = (uint)uVar17;
              uVar14 = (undefined2)((ulong)lppl >> 0x10);
              if ((-1 < (long)uVar17) &&
                 ((0xffff < (long)uVar17 ||
                  ((*(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff) < (uint)cKillDefenses)))) {
                uVar17 = (ulong)(*(uint *)(((PLANET *)lppl)->rgbImp + 4) & 0xfff);
              }
              cKillMine = dmgBombBldg - (cKillFact + uVar17);
              cKillDefenses = uVar17;
              uVar18 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              uVar17 = cKillMine;
              if ((-1 < (long)cKillMine) &&
                 ((0xffff < (long)cKillMine || (((uint)uVar18 & 0xfff) < (uint)cKillMine)))) {
                uVar17 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
                uVar17 = (ulong)((uint)uVar17 & 0xfff);
              }
            }
            if (((0 < dmgBombPeople) || (0 < dmgBombFloor)) ||
               (lVar19 = CONCAT22(cKillPeople._2_2_,(uint)cKillPeople), 0 < dmgPeopleSmart)) {
              uVar14 = (undefined2)((ulong)lppl >> 0x10);
              pPVar11 = (PLANET *)lppl;
              iVar4 = *(int *)((int)pPVar11->rgwtMin + 0xe);
              lVar19 = CONCAT22(cKillPeople._2_2_,(uint)cKillPeople);
              if ((-1 < iVar4) &&
                 ((0 < iVar4 ||
                  (lVar19 = CONCAT22(cKillPeople._2_2_,(uint)cKillPeople),
                  (int)pPVar11->rgwtMin[3] != 0)))) {
                uVar22 = 0;
                uVar20 = 1000;
                cKillMine = uVar17;
                uVar17 = __aFulmul(CONCAT22(*(undefined2 *)((int)pPVar11->rgwtMin + 0xe),
                                                    (int)pPVar11->rgwtMin[3]),dmgPeopleSmart);
                lVar19 = __aFldiv(uVar17,CONCAT22(uVar22,uVar20));
                uVar14 = (undefined2)((ulong)lppl >> 0x10);
                pPVar11 = (PLANET *)lppl;
                if (CONCAT22(*(undefined2 *)((int)pPVar11->rgwtMin + 0xe),(int)pPVar11->rgwtMin[3])
                    <= lVar19) {
                  iVar4 = (int)pPVar11->rgwtMin[3];
                  lVar19 = CONCAT22(*(int *)((int)pPVar11->rgwtMin + 0xe) + -1 + (uint)(iVar4 != 0),
                                    iVar4 + -1);
                }
                cKillPeopleS._2_2_ = (int)((ulong)lVar19 >> 0x10);
                cKillPeopleS._0_2_ = (uint)lVar19;
                bVar15 = *(uint *)(pPVar11->rgwtMin + 3) < (uint)cKillPeopleS;
                iVar10 = *(uint *)(pPVar11->rgwtMin + 3) - (uint)cKillPeopleS;
                iVar4 = *(int *)((int)pPVar11->rgwtMin + 0xe) - cKillPeopleS._2_2_;
                cKillPeopleS = lVar19;
                cKillPeople = __aFulmul(CONCAT22(iVar4 - (uint)bVar15,iVar10),dmgBombPeople)
                ;
                lVar19 = __aFlrem(cKillPeople,1000);
                modKill = lVar19;
                lVar19 = __aFldiv(cKillPeople,1000);
                uVar17 = cKillMine;
                if (0 < modKill) {
                  cKillPeople = lVar19;
                  sVar6 = Random(1000);
                  lVar19 = cKillPeople + (sVar6 <= modKill);
                  uVar17 = cKillMine;
                }
                lVar19 = lVar19 + cKillPeopleS;
                if ((0 < dmgBombPeople) && (lVar19 < 1)) {
                  lVar19 = 1;
                }
                if (lVar19 < dmgBombFloor) {
                  lVar19 = dmgBombFloor;
                }
                uVar14 = (undefined2)((ulong)lppl >> 0x10);
                pPVar11 = (PLANET *)lppl;
                if (CONCAT22(*(undefined2 *)((int)pPVar11->rgwtMin + 0xe),
                             *(uint *)(pPVar11->rgwtMin + 3)) < lVar19) {
                  lVar19 = CONCAT22(*(undefined2 *)((int)pPVar11->rgwtMin + 0xe),
                                    (int)pPVar11->rgwtMin[3]);
                }
              }
            }
            cKillPeople._2_2_ = (int)((ulong)lVar19 >> 0x10);
            cKillPeople._0_2_ = (uint)lVar19;
            if (0 < lVar19) {
              uVar14 = (undefined2)((ulong)lppl >> 0x10);
              puVar1 = (uint *)(((PLANET *)lppl)->rgwtMin + 3);
              uVar7 = *puVar1;
              *puVar1 = *puVar1 - (uint)cKillPeople;
              piVar2 = (int *)((int)((PLANET *)lppl)->rgwtMin + 0xe);
              *piVar2 = (*piVar2 - cKillPeople._2_2_) - (uint)(uVar7 < (uint)cKillPeople);
            }
            if (0 < (long)cKillFact) {
              cKillPeople = lVar19;
              cKillMine = uVar17;
              lVar19 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              uVar14 = (undefined2)((ulong)lppl >> 0x10);
              pPVar11 = (PLANET *)lppl;
              pctSuccessHalf._6_2_ =
                   (*(int *)(pPVar11->rgbImp + 2) - (int)((ulong)lVar19 >> 0x10)) -
                   (uint)(*(uint *)pPVar11->rgbImp < (uint)lVar19) & 0xfff0;
              *(undefined2 *)pPVar11->rgbImp = *(undefined2 *)pPVar11->rgbImp;
              *(uint *)(pPVar11->rgbImp + 2) = *(uint *)(pPVar11->rgbImp + 2) & 0xf;
              *(undefined2 *)pPVar11->rgbImp = *(undefined2 *)pPVar11->rgbImp;
              *(uint *)(pPVar11->rgbImp + 2) = *(uint *)(pPVar11->rgbImp + 2) | pctSuccessHalf._6_2_
              ;
              lVar19 = cKillPeople;
              uVar17 = cKillMine;
            }
            if (0 < (long)uVar17) {
              cKillPeople = lVar19;
              cKillMine = uVar17;
              lVar19 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              uVar14 = (undefined2)((ulong)lppl >> 0x10);
              pPVar11 = (PLANET *)lppl;
              qVar5 = (qword)CONCAT22((*(int *)(pPVar11->rgbImp + 2) - (int)((ulong)lVar19 >> 0x10))
                                      - (uint)(*(uint *)pPVar11->rgbImp < (uint)lVar19),
                                      *(uint *)pPVar11->rgbImp - (uint)lVar19) & 0xfff00;
              *(uint *)pPVar11->rgbImp = *(uint *)pPVar11->rgbImp & 0xff;
              *(uint *)(pPVar11->rgbImp + 2) = *(uint *)(pPVar11->rgbImp + 2) & 0xfff0;
              pctSuccessHalf._4_2_ = (uint)qVar5;
              pctSuccessHalf._6_2_ = (uint)(qVar5 >> 0x10);
              *(uint *)pPVar11->rgbImp = *(uint *)pPVar11->rgbImp | pctSuccessHalf._4_2_;
              *(uint *)(pPVar11->rgbImp + 2) = *(uint *)(pPVar11->rgbImp + 2) | pctSuccessHalf._6_2_
              ;
              lVar19 = cKillPeople;
              uVar17 = cKillMine;
            }
            if (0 < (long)cKillDefenses) {
              cKillPeople = lVar19;
              cKillMine = uVar17;
              lVar19 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              uVar14 = (undefined2)((ulong)lppl >> 0x10);
              pPVar11 = (PLANET *)lppl;
              pctSuccessHalf._4_2_ = *(int *)(pPVar11->rgbImp + 4) - (int)lVar19 & 0xfff;
              *(uint *)(pPVar11->rgbImp + 4) = *(uint *)(pPVar11->rgbImp + 4) & 0xf000;
              *(undefined2 *)(pPVar11->rgbImp + 6) = *(undefined2 *)(pPVar11->rgbImp + 6);
              *(uint *)(pPVar11->rgbImp + 4) = *(uint *)(pPVar11->rgbImp + 4) | pctSuccessHalf._4_2_
              ;
              *(undefined2 *)(pPVar11->rgbImp + 6) = *(undefined2 *)(pPVar11->rgbImp + 6);
              lVar19 = cKillPeople;
              uVar17 = cKillMine;
            }
            if ((-1 < pctTerra._2_2_) && ((0 < pctTerra._2_2_ || ((uint)pctTerra != 0)))) {
              in_stack_0000ffa6 = 2;
              cKillPeople = lVar19;
              cKillMine = uVar17;
              lVar19 = __ftol((double)CONCAT26(2,CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
              bVar15 = (uint)pctTerra < (uint)lVar19;
              pctTerra._0_2_ = (uint)pctTerra - (uint)lVar19;
              pctTerra._2_2_ = (pctTerra._2_2_ - (int)((ulong)lVar19 >> 0x10)) - (uint)bVar15;
              if ((-1 < pctTerra._2_2_) && ((0 < pctTerra._2_2_ || (500 < (uint)pctTerra)))) {
                pctTerra._0_2_ = 500;
                pctTerra._2_2_ = 0;
              }
              pctSuccessHalf = 0.0;
              while( true ) {
                iVar4 = pctSuccessHalf._6_2_;
                if (2 < pctSuccessHalf._2_2_) break;
                pcVar12 = ((PLANET *)lppl)->rgEnvVarOrig + pctSuccessHalf._2_2_;
                pcVar13 = ((PLANET *)lppl)->rgEnvVar + pctSuccessHalf._2_2_;
                pctSuccessHalf = (double)CONCAT62(pctSuccessHalf._2_6_,(int)*pcVar12);
                uVar7 = (int)*pcVar13 - (int)*pcVar12;
                pctSuccessHalf._0_6_ = CONCAT24(uVar7,pctSuccessHalf._0_4_);
                pctSuccessHalf = (double)CONCAT26(iVar4,pctSuccessHalf._0_6_);
                if ((int)uVar7 < 1) {
                  if ((int)uVar7 < 0) {
                    iVar10 = (int)-uVar7 >> 0xf;
                    if ((pctTerra._2_2_ <= iVar10) &&
                       ((pctTerra._2_2_ < iVar10 || ((uint)pctTerra <= -uVar7)))) {
                      pctSuccessHalf._0_6_ = CONCAT24(-(uint)pctTerra,pctSuccessHalf._0_4_);
                      pctSuccessHalf = (double)CONCAT26(iVar4,pctSuccessHalf._0_6_);
                    }
                    ((PLANET *)lppl)->rgEnvVar[pctSuccessHalf._2_2_] =
                         ((PLANET *)lppl)->rgEnvVar[pctSuccessHalf._2_2_] -
                         (char)((qword)pctSuccessHalf >> 0x20);
                    iVar4 = pctSuccessHalf._6_2_ - pctSuccessHalf._4_2_;
                    pctSuccessHalf = (double)CONCAT26(iVar4,pctSuccessHalf._0_6_);
                  }
                }
                else {
                  if ((pctTerra._2_2_ <= (int)uVar7 >> 0xf) &&
                     ((pctTerra._2_2_ < (int)uVar7 >> 0xf || ((uint)pctTerra <= uVar7)))) {
                    pctSuccessHalf._0_6_ = CONCAT24((uint)pctTerra,pctSuccessHalf._0_4_);
                    pctSuccessHalf = (double)CONCAT26(iVar4,pctSuccessHalf._0_6_);
                  }
                  ((PLANET *)lppl)->rgEnvVar[pctSuccessHalf._2_2_] =
                       ((PLANET *)lppl)->rgEnvVar[pctSuccessHalf._2_2_] -
                       (char)((qword)pctSuccessHalf >> 0x20);
                  iVar4 = pctSuccessHalf._6_2_ + pctSuccessHalf._4_2_;
                  pctSuccessHalf = (double)CONCAT26(iVar4,pctSuccessHalf._0_6_);
                }
                pctSuccessHalf =
                     (double)((qword)CONCAT42(pctSuccessHalf._4_4_,pctSuccessHalf._2_2_ + 1) << 0x10
                             );
              }
              lVar19 = cKillPeople;
              uVar17 = cKillMine;
              if (0 < (int)pctSuccessHalf._6_2_) {
                if (fMulti == 0) {
                  MVar9 = idmHasRetroBombedUndoingTerraforming;
                }
                else {
                  MVar9 = idmFleetsHaveRetroBombedUndoingTerraforming;
                }
                FSendPlrMsg(((FLEET *)lpfl)->iPlayer,MVar9,lpfl->id | 0x8000,lpfl->id,lppl->id,
                                 pctSuccessHalf._6_2_,0,0,0,0);
                if (fMulti == 0) {
                  MVar9 = idmHasRetroBombedUndoingTerraforming;
                }
                else {
                  MVar9 = idmFleetsHaveRetroBombedUndoingTerraforming2;
                }
                FSendPlrMsg(((PLANET *)lppl)->iPlayer,MVar9,lppl->id,lpfl->id,lppl->id,
                                 pctSuccessHalf._6_2_,0,0,0,0);
                lVar19 = cKillPeople;
                uVar17 = cKillMine;
              }
            }
            cKillPeople._2_2_ = (int)((ulong)lVar19 >> 0x10);
            cKillPeople._0_2_ = (uint)lVar19;
            cPPE = cKillDefenses + cKillFact + uVar17;
            pPVar11 = (PLANET *)lppl;
            uVar14 = (undefined2)((ulong)lppl >> 0x10);
            cKillMine = uVar17;
            if (cPPE < 1) {
              if (0 < lVar19) {
                iVar4 = *(int *)((int)pPVar11->rgwtMin + 0xe);
                if ((iVar4 < 0) || ((iVar4 < 1 && ((int)pPVar11->rgwtMin[3] == 0)))) {
                  if (fMulti == 0) {
                    idmSrc = 0x8f;
                    idmDst = 0x90;
                  }
                  else {
                    idmSrc = 0x17c;
                    idmDst = 0x17d;
                  }
                }
                else if (fMulti == 0) {
                  idmSrc = 0x60;
                  idmDst = 0x6a;
                }
                else {
                  idmSrc = 0x166;
                  idmDst = 0x170;
                }
                FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,lppl->id
                                 ,(uint)cKillPeople,0,0,0,0);
                cKillPeople = lVar19;
                FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                 (uint)cKillPeople,0,0,0,0);
                lVar19 = cKillPeople;
                uVar17 = cKillMine;
              }
            }
            else {
              iVar4 = *(int *)((int)pPVar11->rgwtMin + 0xe);
              if ((iVar4 < 0) || ((iVar4 < 1 && ((int)pPVar11->rgwtMin[3] == 0)))) {
                if (fMulti == 0) {
                  idmSrc = 0x8f;
                  idmDst = 0x90;
                }
                else {
                  idmSrc = 0x17c;
                  idmDst = 0x17d;
                }
BATTLE_GenericBombMsg:
                cKillPeople = lVar19;
                cKillMine = uVar17;
                FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,lppl->id
                                 ,(short)lVar19,(int)cPPE,0,0,0);
                FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                 (uint)cKillPeople,(int)cPPE,0,0,0);
                lVar19 = cKillPeople;
                uVar17 = cKillMine;
              }
              else {
                if (fMulti == 0) {
                  idmSrc = 99;
                  idmDst = 0x6d;
                }
                else {
                  idmSrc = 0x169;
                  idmDst = 0x173;
                }
                if (1 < cPPE) {
                  idmSrc = idmSrc + 1;
                  idmDst = idmDst + 1;
                }
                bVar15 = cKillPeople._2_2_ == 0;
                cKillPeople = lVar19;
                if ((lVar19 < 0) || ((lVar19 < 0x10000 && (bVar15 = false, (uint)cKillPeople == 0)))
                   ) {
                  idmSrc = idmSrc + -2;
                  idmDst = idmDst + -2;
                  bVar15 = idmDst == 0;
                  __aFfcompp();
                  if (bVar15) {
                    FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,
                                     lppl->id,(int)cPPE,0,0,0,0);
                    FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                     (int)cPPE,0,0,0,0);
                    lVar19 = cKillPeople;
                    uVar17 = cKillMine;
                  }
                  else {
                    idmSrc = idmSrc + 5;
                    idmDst = idmDst + 5;
                    sVar23 = 0;
                    sVar21 = 0;
                    sVar6 = 0;
                    lVar19 = __ftol((double)((qword)unaff_DI << 0x30));
                    FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,
                                     lppl->id,(int)cPPE,(short)lVar19,sVar6,sVar21,sVar23);
                    sVar23 = 0;
                    sVar21 = 0;
                    sVar6 = 0;
                    lVar19 = __ftol((double)((qword)unaff_DI << 0x30));
                    FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                     (int)cPPE,(short)lVar19,sVar6,sVar21,sVar23);
                    lVar19 = cKillPeople;
                    uVar17 = cKillMine;
                  }
                }
                else {
                  __aFfcompp();
                  lVar19 = cKillPeople;
                  uVar17 = cKillMine;
                  if (bVar15) goto BATTLE_GenericBombMsg;
                  idmSrc = idmSrc + 5;
                  idmDst = idmDst + 5;
                  sVar21 = 0;
                  sVar6 = 0;
                  lVar19 = __ftol((double)((qword)CONCAT22(unaff_SI,unaff_DI) << 0x20));
                  FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,
                                   lppl->id,(uint)cKillPeople,(int)cPPE,(short)lVar19,sVar6,sVar21);
                  sVar21 = 0;
                  sVar6 = 0;
                  lVar19 = __ftol((double)((qword)CONCAT22(unaff_SI,unaff_DI) << 0x20));
                  FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                   (uint)cKillPeople,(int)cPPE,(short)lVar19,sVar6,sVar21);
                  lVar19 = cKillPeople;
                  uVar17 = cKillMine;
                }
              }
            }
            uVar14 = (undefined2)((ulong)lppl >> 0x10);
            cKillPeople = lVar19;
            cKillMine = uVar17;
            if (((int)((PLANET *)lppl)->rgwtMin[3] == 0) &&
               (*(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe) == 0)) {
              UninhabitPlanet(lppl);
            }
          }
        }
      }
    }
    ifl = ifl + 1;
  } while( true );
}



