// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: RelationsDlg
// Address: 10f0:0088
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short RelationsDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char *pcVar1;
  HDC HVar2;
  HWND HVar3;
  short sVar4;
  undefined2 unaff_SS;
  LRESULT LVar5;
  WPARAM WVar6;
  UINT UVar7;
  RECT rcGBox;
  PAINTSTRUCT ps;
  short mdSBase;
  RECT rc;
  short i;
  
  if (message == WM_DESTROY) {
    if (fDirtyPlan != 0) {
      LogChangeRelations();
      InvalidateRect(hwndScanner,(undefined2 *)0x0,1);
    }
  }
  else {
    if (message == WM_PAINT) {
      HVar2 = BeginPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
      HVar3 = GetDlgItem(hwnd,0x7d5);
      GetWindowRect(HVar3,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
      ScreenToClient(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rcGBox));
      HVar3 = GetDlgItem(hwnd,0x7d6);
      GetWindowRect(HVar3,(undefined2 *)CONCAT22(unaff_SS,&rc));
      ScreenToClient(hwnd,(short *)CONCAT22(unaff_SS,&rc.right));
      rcGBox.right = rc.right;
      rcGBox.bottom = rc.bottom;
      ExpandRc(&rcGBox,dyArial8,dyArial8 >> 1);
      _Draw3dFrame();
      SetBkColor(HVar2,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SelectObject(HVar2,rghfontArial8[1]);
      sVar4 = CchGetString(idsRelation,(char *)szWork);
      TextOut(HVar2,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,sVar4);
      SelectObject(HVar2,rghfontArial8[0]);
      EndPaint(hwnd,(undefined2 *)CONCAT22(unaff_SS,&ps));
      return 1;
    }
    if (message == WM_ERASEBKGND) {
LAB_10f0_0177:
      GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
      FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
      return 1;
    }
    if (message == WM_CTLCOLOR) {
      HVar3 = GetDlgItem(hwnd,0x7d3);
      if ((HWND)lParam != HVar3) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        StickyDlgPos(hwnd,(POINT *)&ptStickyRelationsDlg,1);
        CheckRadioButton(hwnd,0x7d4,0x7d6,
                         *(char *)(idPlayer * 0xc0 + 0x5a12 + (uint)(idPlayer == 0)) +
                         0x7d4);
        for (i = 0; i < game.cPlayer; i = i + 1) {
          if (i != idPlayer) {
            HVar3 = GetDlgItem(hwnd,0x7d3);
            UVar7 = 0x401;
            WVar6 = 0;
            pcVar1 = PszPlayerName(i,0,0,0,0,(PLAYER *)0x0);
            SendMessage(HVar3,UVar7,WVar6,(LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar1));
          }
        }
        HVar3 = GetDlgItem(hwnd,0x7d3);
        SendMessage(HVar3,0x407,0,0);
        fDirtyPlan = 0;
        goto LAB_10f0_0177;
      }
      if (message == WM_COMMAND) {
        if (wParam == 2) {
          StickyDlgPos(hwnd,(POINT *)&ptStickyRelationsDlg,0);
          HVar3 = GetDlgItem(hwnd,0x7d3);
          LVar5 = SendMessage(HVar3,0x409,0,0);
          i = (short)LVar5;
          if (idPlayer <= i) {
            i = i + 1;
          }
          EndDialog(hwnd,i + 3);
          return 1;
        }
        if ((wParam < 0x7d4) || (0x7d6 < wParam)) {
          if (wParam == 0x7d3) {
            HVar3 = GetDlgItem(hwnd,0x7d3);
            LVar5 = SendMessage(HVar3,0x409,0,0);
            i = (short)LVar5;
            if (idPlayer <= i) {
              i = i + 1;
            }
            CheckRadioButton(hwnd,0x7d4,0x7d6,*(char *)(idPlayer * 0xc0 + 0x5a12 + i) + 0x7d4
                            );
          }
          else if (wParam == 0x76) {
            WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x43b);
            return 1;
          }
        }
        else {
          HVar3 = GetDlgItem(hwnd,0x7d3);
          LVar5 = SendMessage(HVar3,0x409,0,0);
          i = (short)LVar5;
          if (idPlayer <= i) {
            i = i + 1;
          }
          *(char *)(idPlayer * 0xc0 + 0x5a12 + i) = (char)wParam + ',';
          fDirtyPlan = 1;
        }
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: NewPlanNameDlg
// Address: 10f0:04ce
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: rc */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short NewPlanNameDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar1;
  RECT rc;
  
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    uVar1 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),rc.left);
    if ((int)uVar1 == 6) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return hbrButtonFace;
    }
  }
  else {
    if (message == WM_INITDIALOG) {
      SetWindowPos(hwnd,0,ptStickyBattlePlansDlg.x + 0x46,
                   ptStickyBattlePlansDlg.y + 0x46,0,0,0x15);
      SendDlgItemMessage(hwnd,0x10c,0x415,0x1f,0);
      SetDlgItemText(hwnd,0x10c,(LPCSTR)btlplan.szName);
      return 1;
    }
    if (message == WM_COMMAND) {
      if ((wParam == 1) || (wParam == 2)) {
        if (wParam == 1) {
          GetDlgItemText(hwnd,0x10c,(LPSTR)btlplan.szName,0x20);
          fDirtyPlan = 1;
        }
        EndDialog(hwnd,(uint)(wParam == 1));
        return 1;
      }
      if (wParam == 0x76) {
        WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x439);
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: BattlePlansDlg
// Address: 10f0:0652
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short BattlePlansDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char *pcVar1;
  BTLPLAN *pBVar2;
  BTLPLAN *pBVar3;
  undefined2 uVar4;
  char *pcVar5;
  HWND HVar6;
  short sVar7;
  ushort uVar8;
  int iVar9;
  int iVar10;
  undefined2 unaff_SI;
  BTLPLAN *pBVar11;
  undefined2 unaff_DI;
  BTLPLAN *pBVar12;
  undefined2 unaff_SS;
  ulong uVar13;
  FARPROC pvVar14;
  LRESULT LVar15;
  WPARAM WVar16;
  UINT UVar17;
  ushort in_stack_0000ffe6;
  short cLen;
  RECT rc;
  short fRet;
  short i;
  short idc;
  void *lpProc;
  
  uVar13 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(undefined2 *)CONCAT22(unaff_SS,&rc));
    FillRect(wParam,(undefined2 *)CONCAT22(unaff_SS,&rc),hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    for (idc = 0x41d; idc < 0x423; idc = idc + 1) {
      HVar6 = GetDlgItem(hwnd,idc);
      if ((HWND)lParam == HVar6) break;
    }
    if ((idc < 0x41d) && (uVar13 = __aFulshr(uVar13,in_stack_0000ffe6), (int)uVar13 != 6)) {
      return 0;
    }
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    return hbrButtonFace;
  }
  if (message == WM_INITDIALOG) {
    StickyDlgPos(hwnd,(POINT *)&ptStickyBattlePlansDlg,1);
    iPlanSelDlg = 0;
    if (sel.grobj == grobjFleet) {
      iPlanSelDlg = (short)sel.fl.iplan;
    }
    uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
    pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
    pBVar12 = (BTLPLAN *)&btlplan;
    for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
      pBVar3 = pBVar12;
      pBVar12 = (BTLPLAN *)&pBVar12->wFlags;
      pBVar2 = pBVar11;
      pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
      pBVar3->wFlags = pBVar2->wFlags;
    }
    for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x403,0,
                  (LPARAM)CONCAT22(((undefined2 *)&DAT_1120_593a)[idPlayer * 2],
                                   ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                   szName));
    }
    HVar6 = GetDlgItem(hwnd,0x41e);
    SendMessage(HVar6,0x40e,iPlanSelDlg,0);
    HVar6 = GetDlgItem(hwnd,0x41b);
    EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
    HVar6 = GetDlgItem(hwnd,0x817);
    EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
    for (i = 0x198; i < 0x19e; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x421);
      UVar17 = 0x403;
      WVar16 = 0;
      pcVar5 = PszGetCompressedString(i);
      SendMessage(HVar6,UVar17,WVar16,(LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar5));
    }
    HVar6 = GetDlgItem(hwnd,0x421);
    SendMessage(HVar6,0x40e,(uint)btlplan.wFlags >> 8 & 0xf,0);
    for (i = 400; i < 0x198; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x41f);
      UVar17 = 0x403;
      WVar16 = 0;
      pcVar5 = PszGetCompressedString(i);
      SendMessage(HVar6,UVar17,WVar16,(LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar5));
    }
    HVar6 = GetDlgItem(hwnd,0x41f);
    SendMessage(HVar6,0x40e,btlplan.wFlags & 0xf,0);
    if (((uint)game.wCrap >> 2 & 1) == 0) {
      for (i = 0x78; i < 0x7c; i = i + 1) {
        HVar6 = GetDlgItem(hwnd,0x422);
        UVar17 = 0x403;
        WVar16 = 0;
        pcVar5 = PszGetCompressedString(i);
        SendMessage(HVar6,UVar17,WVar16,(LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar5));
      }
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if (i != idPlayer) {
          HVar6 = GetDlgItem(hwnd,0x422);
          UVar17 = 0x403;
          WVar16 = 0;
          pcVar5 = PszPlayerName(i,0,1,0,0,(PLAYER *)0x0);
          SendMessage(HVar6,UVar17,WVar16,(LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar5));
        }
      }
      i = (uint)btlplan.wFlags >> 8 & 0x1f;
      if (idPlayer + 4 <= i) {
        i = i - 1;
      }
      HVar6 = GetDlgItem(hwnd,0x422);
      SendMessage(HVar6,0x40e,i,0);
    }
    else {
      HVar6 = GetDlgItem(hwnd,0x422);
      UVar17 = 0x403;
      WVar16 = 0;
      pcVar5 = PszGetCompressedString(idsEveryone);
      SendMessage(HVar6,UVar17,WVar16,(LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar5));
      HVar6 = GetDlgItem(hwnd,0x422);
      SendMessage(HVar6,0x40e,0,0);
      HVar6 = GetDlgItem(hwnd,0x422);
      EnableWindow(HVar6,0);
    }
    for (i = 400; i < 0x198; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x420);
      UVar17 = 0x403;
      WVar16 = 0;
      pcVar5 = PszGetCompressedString(i);
      SendMessage(HVar6,UVar17,WVar16,(LPARAM)CONCAT22((undefined1 *)&DAT_1120_1120,pcVar5));
    }
    HVar6 = GetDlgItem(hwnd,0x420);
    SendMessage(HVar6,0x40e,(uint)btlplan.wFlags >> 4 & 0xf,0);
    HVar6 = GetDlgItem(hwnd,0x41d);
    SendMessage(HVar6,0x401,(uint)btlplan.wFlags >> 0xf,0);
    fDirtyPlan = 0;
    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    return 1;
  }
  if (message != WM_COMMAND) {
    return 0;
  }
  if ((wParam == 1) || (wParam == 2)) {
    if (fDirtyPlan != 0) {
      uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
      pBVar12 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar11 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar12;
        pBVar12 = (BTLPLAN *)&pBVar12->wFlags;
        pBVar2 = pBVar11;
        pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      LogChangeBtlplan((BTLPLAN *)&btlplan);
    }
    StickyDlgPos(hwnd,(POINT *)&ptStickyBattlePlansDlg,0);
    EndDialog(hwnd,iPlanSelDlg);
    if (sel.grobj == grobjFleet) {
      FillBattleDD(sel.fl.iplan + 1);
    }
    iPlanSelDlg = -1;
    return 1;
  }
  if (wParam == 0x41d) {
    LVar15 = SendDlgItemMessage(hwnd,0x41d,0x400,0,0);
    fDirtyPlan = 1;
    btlplan.wFlags = btlplan.wFlags & 0x7fffU | (int)LVar15 << 0xf;
    return 0;
  }
  if (wParam == 0x817) {
    if (fDirtyPlan != 0) {
      uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
      pBVar12 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar11 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar12;
        pBVar12 = (BTLPLAN *)&pBVar12->wFlags;
        pBVar2 = pBVar11;
        pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      LogChangeBtlplan((BTLPLAN *)&btlplan);
      fDirtyPlan = 0;
    }
    btlplan.wFlags = btlplan.wFlags & 0xbfffU | 0x4000;
    uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
    pBVar12 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
    pBVar11 = (BTLPLAN *)&btlplan;
    for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
      pBVar3 = pBVar12;
      pBVar12 = (BTLPLAN *)&pBVar12->wFlags;
      pBVar2 = pBVar11;
      pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
      pBVar3->wFlags = pBVar2->wFlags;
    }
    btlplan.wFlags = btlplan.wFlags & 0xff0fU | (iPlanSelDlg & 0xfU) << 4
    ;
    sVar7 = FDeleteBattlePlan(iPlanSelDlg,1);
    if (sVar7 == 0) {
      btlplan.wFlags = btlplan.wFlags & 0xbfff;
      uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
      pBVar12 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar11 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar12;
        pBVar12 = (BTLPLAN *)&pBVar12->wFlags;
        pBVar2 = pBVar11;
        pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      return 0;
    }
    LogChangeBtlplan((BTLPLAN *)&btlplan);
    HVar6 = GetDlgItem(hwnd,0x41e);
    SendMessage(HVar6,0x40e,iPlanSelDlg - 1,0);
    HVar6 = GetDlgItem(hwnd,0x41e);
    SendMessage(HVar6,0x40b,0,0);
    for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x403,0,
                  (LPARAM)CONCAT22(((undefined2 *)&DAT_1120_593a)[idPlayer * 2],
                                   ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                   szName));
    }
    HVar6 = GetDlgItem(hwnd,0x41e);
    SendMessage(HVar6,0x40e,iPlanSelDlg - 1,0);
BATTLE_LSelectName:
    HVar6 = GetDlgItem(hwnd,0x41e);
    LVar15 = SendMessage(HVar6,0x407,0,0);
    iVar9 = (int)LVar15;
    if (iVar9 != iPlanSelDlg) {
      if (fDirtyPlan != 0) {
        uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
        pBVar12 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
        pBVar11 = (BTLPLAN *)&btlplan;
        for (iVar10 = 0x12; iVar10 != 0; iVar10 = iVar10 + -1) {
          pBVar3 = pBVar12;
          pBVar12 = (BTLPLAN *)&pBVar12->wFlags;
          pBVar2 = pBVar11;
          pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
          pBVar3->wFlags = pBVar2->wFlags;
        }
        LogChangeBtlplan((BTLPLAN *)&btlplan);
        fDirtyPlan = 0;
      }
      uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
      pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iVar9;
      pBVar12 = (BTLPLAN *)&btlplan;
      iPlanSelDlg = iVar9;
      for (iVar10 = 0x12; iVar10 != 0; iVar10 = iVar10 + -1) {
        pBVar3 = pBVar12;
        pBVar12 = (BTLPLAN *)&pBVar12->wFlags;
        pBVar2 = pBVar11;
        pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      HVar6 = GetDlgItem(hwnd,0x41f);
      SendMessage(HVar6,0x40e,btlplan.wFlags & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x420);
      SendMessage(HVar6,0x40e,(uint)btlplan.wFlags >> 4 & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x41d);
      SendMessage(HVar6,0x401,(uint)btlplan.wFlags >> 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x41b);
      EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
      HVar6 = GetDlgItem(hwnd,0x817);
      EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
      HVar6 = GetDlgItem(hwnd,0x421);
      SendMessage(HVar6,0x40e,(uint)btlplan.wFlags >> 8 & 0xf,0);
      i = (uint)btlplan.wFlags >> 8 & 0x1f;
      if (idPlayer + 4 <= i) {
        i = i - 1;
      }
      HVar6 = GetDlgItem(hwnd,0x422);
      SendMessage(HVar6,0x40e,i,0);
    }
  }
  else {
    if (wParam == 0x41f) {
      HVar6 = GetDlgItem(hwnd,0x41f);
      LVar15 = SendMessage(HVar6,0x407,0,0);
      fDirtyPlan = 1;
      btlplan.wFlags = btlplan.wFlags & 0xfff0U | (uint)LVar15 & 0xf;
      return 0;
    }
    if (wParam == 0x420) {
      HVar6 = GetDlgItem(hwnd,0x420);
      LVar15 = SendMessage(HVar6,0x407,0,0);
      fDirtyPlan = 1;
      btlplan.wFlags = btlplan.wFlags & 0xff0fU | ((uint)LVar15 & 0xf) << 4;
      return 0;
    }
    if (wParam == 0x422) {
      HVar6 = GetDlgItem(hwnd,0x422);
      LVar15 = SendMessage(HVar6,0x407,0,0);
      i = (short)LVar15;
      if (((uint)game.wCrap >> 2 & 1) == 0) {
        if (idPlayer + 4 <= i) {
          i = i + 1;
        }
      }
      else {
        i = 3;
      }
      fDirtyPlan = 1;
      btlplan.wFlags = btlplan.wFlags & 0xe0ffU | (i & 0x1fU) << 8;
      return 0;
    }
    if (wParam == 0x421) {
      HVar6 = GetDlgItem(hwnd,0x421);
      LVar15 = SendMessage(HVar6,0x407,0,0);
      fDirtyPlan = 1;
      btlplan.wFlags = btlplan.wFlags & 0xf0ffU | ((uint)LVar15 & 0xf) << 8;
      return 0;
    }
    if (wParam != 0x41b) {
      if (wParam != 0x41c) {
        if (wParam != 0x41e) {
          if (wParam != 0x76) {
            return 0;
          }
          WinHelp(hwnd,(LPCSTR)CONCAT22((undefined1 *)&DAT_1120_1120,_szHelpFile),1,0x439);
          return 1;
        }
        goto BATTLE_LSelectName;
      }
      if (((byte *)rgcbtlplan)[idPlayer] == 0xf) {
        return 0;
      }
      if (fDirtyPlan != 0) {
        uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
        pBVar12 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
        pBVar11 = (BTLPLAN *)&btlplan;
        for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
          pBVar3 = pBVar12;
          pBVar12 = (BTLPLAN *)&pBVar12->wFlags;
          pBVar2 = pBVar11;
          pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
          pBVar3->wFlags = pBVar2->wFlags;
        }
        LogChangeBtlplan((BTLPLAN *)&btlplan);
        fDirtyPlan = 0;
      }
      iPlanSelDlg = (short)((byte *)rgcbtlplan)[idPlayer];
      ((byte *)rgcbtlplan)[idPlayer] =
           ((byte *)rgcbtlplan)[idPlayer] + 1;
      uVar8 = _strlen((char *)btlplan.szName);
      if ((int)uVar8 < 0x1c) {
        if (((*(char *)((int)&btlplan.wFlags + 1 + uVar8) == ')') &&
            ((((undefined *)&DAT_1120_175f)[*(byte *)((int)&btlplan.wFlags + uVar8)] & 4)
             != 0)) && (*(char *)((int)&btlplan.wFlags + 1 + uVar8) == '(')) {
          if (*(char *)((int)&btlplan.wFlags + uVar8) == '9') {
            *(undefined1 *)((int)&btlplan.wFlags + uVar8) = 0x30;
          }
          else {
            pcVar1 = (char *)((int)&btlplan.wFlags + uVar8);
            *pcVar1 = *pcVar1 + '\x01';
          }
        }
        else {
          _strcpy((char *)((int)btlplan.szName + uVar8),(char *)0xd9c);
        }
      }
      btlplan.wFlags =
           btlplan.wFlags & 0xff0fU | (iPlanSelDlg & 0xfU) << 4;
      uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
      pBVar12 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar11 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar12;
        pBVar12 = (BTLPLAN *)&pBVar12->wFlags;
        pBVar2 = pBVar11;
        pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      HVar6 = GetDlgItem(hwnd,0x421);
      SendMessage(HVar6,0x40e,(uint)btlplan.wFlags >> 8 & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x40b,0,0);
      for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
        HVar6 = GetDlgItem(hwnd,0x41e);
        SendMessage(HVar6,0x403,0,
                    (LPARAM)CONCAT22(((undefined2 *)&DAT_1120_593a)[idPlayer * 2],
                                     ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                     szName));
      }
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x40e,iPlanSelDlg,0);
      HVar6 = GetDlgItem(hwnd,0x41f);
      SendMessage(HVar6,0x40e,btlplan.wFlags & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x420);
      SendMessage(HVar6,0x40e,(uint)btlplan.wFlags >> 4 & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x41d);
      SendMessage(HVar6,0x401,(uint)btlplan.wFlags >> 0xf,0);
      i = (uint)btlplan.wFlags >> 8 & 0x1f;
      if (idPlayer + 4 <= i) {
        i = i - 1;
      }
      HVar6 = GetDlgItem(hwnd,0x422);
      SendMessage(HVar6,0x40e,i,0);
      fDirtyPlan = 1;
      HVar6 = GetDlgItem(hwnd,0x41b);
      EnableWindow(HVar6,1);
    }
    StickyDlgPos(hwnd,(POINT *)&ptStickyBattlePlansDlg,0);
    pvVar14 = MakeProcInstance(NewPlanNameDlg,hInst);
    sVar7 = DialogBox(0,(LPCSTR)CONCAT22(0x7e3,hwndFrame),(HWND)((ulong)pvVar14 >> 0x10),
                      (void *)pvVar14);
    FreeProcInstance(pvVar14);
    SetFocus(hwnd);
    if (sVar7 != 0) {
      uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
      pBVar12 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar11 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar12;
        pBVar12 = (BTLPLAN *)&pBVar12->wFlags;
        pBVar2 = pBVar11;
        pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x40b,0,0);
      for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
        HVar6 = GetDlgItem(hwnd,0x41e);
        SendMessage(HVar6,0x403,0,
                    (LPARAM)CONCAT22(((undefined2 *)&DAT_1120_593a)[idPlayer * 2],
                                     ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                     szName));
      }
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x40e,iPlanSelDlg,0);
    }
    HVar6 = GetDlgItem(hwnd,0x41b);
    EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
    HVar6 = GetDlgItem(hwnd,0x817);
    EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
  }
  return 0;
}



// ======================================================================
// Function: FDeleteBattlePlan
// Address: 10f0:1706
// Segment: MEMORY_BATTLE
// ======================================================================


short FDeleteBattlePlan(short iplan,short fWarn)

{
  BTLPLAN *pBVar1;
  BTLPLAN *pBVar2;
  int iVar3;
  undefined2 uVar4;
  undefined2 uVar5;
  bool bVar6;
  char *sz;
  int iVar7;
  BTLPLAN *pBVar8;
  BTLPLAN *pBVar9;
  short sVar10;
  FLEET *lpfl;
  short i;
  short iflMac;
  short fFoundBigger;
  
  bVar6 = false;
BATTLE_LCommit:
  do {
    for (iflMac = 0; iflMac < cFleet; iflMac = iflMac + 1) {
      iVar7 = *(int *)((FLEET **)rglpfl + iflMac);
      iVar3 = *(int *)((int)((FLEET **)rglpfl + iflMac) + 2);
      if ((iVar7 == 0) && (iVar3 == 0)) break;
      if (idPlayer <= *(int *)(iVar7 + 2)) {
        if (idPlayer < *(int *)(iVar7 + 2)) break;
        if ((uint)iplan <= (uint)*(byte *)(iVar7 + 0x60)) {
          if ((uint)iplan < (uint)*(byte *)(iVar7 + 0x60)) {
            if (fWarn == 0) {
              *(char *)(iVar7 + 0x60) = *(char *)(iVar7 + 0x60) + -1;
            }
            else {
              bVar6 = true;
            }
          }
          else {
            if (fWarn != 0) {
              sVar10 = 0x31;
              sz = PszFormatIds(idsCurrentlyHaveFleetsUsingBattlePlanIf,(short *)0x0);
              sVar10 = AlertSz(sz,sVar10);
              if (sVar10 == 2) {
                return 0;
              }
              fWarn = 0;
              goto BATTLE_LCommit;
            }
            *(char *)(iVar7 + 0x60) = *(char *)(iVar7 + 0x60) + -1;
          }
        }
      }
    }
    if ((fWarn == 0) || (!bVar6)) {
      ((byte *)rgcbtlplan)[idPlayer] =
           ((byte *)rgcbtlplan)[idPlayer] - 1;
      for (i = iplan; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
        uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
        pBVar8 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i + 1;
        uVar5 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
        pBVar9 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i;
        for (iVar7 = 0x12; iVar7 != 0; iVar7 = iVar7 + -1) {
          pBVar2 = pBVar9;
          pBVar9 = (BTLPLAN *)&pBVar9->wFlags;
          pBVar1 = pBVar8;
          pBVar8 = (BTLPLAN *)&pBVar8->wFlags;
          pBVar2->wFlags = pBVar1->wFlags;
        }
        (((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i)->wFlags =
             (((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i)->wFlags & 0xff0fU |
             (i & 0xfU) << 4;
      }
      return 1;
    }
    fWarn = 0;
  } while( true );
}



// ======================================================================
// Function: SpankTheCheaters
// Address: 10f0:192a
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f01bdb) */
/* WARNING: Removing unreachable block (ram,0x10f01be0) */
/* WARNING: Removing unreachable block (ram,0x10f01d8c) */
/* WARNING: Removing unreachable block (ram,0x10f01d75) */
/* WARNING: Removing unreachable block (ram,0x10f01c5e) */

void SpankTheCheaters(void)

{
  uint *puVar1;
  FLEET *pFVar2;
  int iVar3;
  int iVar4;
  bool bVar5;
  uint uVar6;
  short sVar7;
  short sVar8;
  PLANET *pPVar9;
  PLANET *pPVar10;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar11;
  ulong uVar12;
  long lVar13;
  ulong uVar14;
  ulong uVar15;
  PLANET *lpplMac;
  char rgfCheater [16];
  short fSellOff;
  short fCheater;
  long pctSell;
  short i;
  short ifl;
  FLEET *lpfl;
  PLANET *lppl;
  long lSell;
  
  uVar15 = CONCAT22(unaff_SI,unaff_DI);
  bVar5 = false;
  for (i = 0; i < game.cPlayer; i = i + 1) {
    uVar6 = *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 2;
    rgfCheater[i] = (byte)uVar6 & 1;
    if ((uVar6 & 1) != 0) {
      bVar5 = true;
    }
  }
  if ((bVar5) && (9 < (uint)game.turn)) {
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar2 = ((FLEET **)rglpfl)[ifl];
      iVar4 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      lpfl = (FLEET *)CONCAT22(iVar4,pFVar2);
      if ((pFVar2 == (FLEET *)0x0) && (iVar4 == 0)) break;
      if ((((uint)pFVar2->wFlags >> 10 & 1) == 0) && (rgfCheater[pFVar2->iPlayer] != '\0')) {
        sVar7 = Random(0xc);
        if (sVar7 == 0) {
          pFVar2->wFlags = pFVar2->wFlags & 0xfbffU | 0x400;
          FSendPlrMsg2(pFVar2->iPlayer,idmHasDefectedRanksDueInabilityProjectLegitimate,-5,
                            lpfl->id,0);
        }
        else {
          bVar5 = false;
          for (i = 0; i < 3; i = i + 1) {
            iVar3 = *(int *)((int)(pFVar2->rgwtMin + i) + 2);
            if ((-1 < iVar3) && ((0 < iVar3 || ((int)pFVar2->rgwtMin[i] != 0)))) {
              if (!bVar5) {
                sVar7 = Random(0xb);
                pctSell._0_2_ = sVar7 + 10;
                pctSell._2_2_ = (int)pctSell >> 0xf;
                bVar5 = true;
              }
              lVar13 = 100;
              uVar12 = __aFulmul(CONCAT22(*(undefined2 *)((int)(pFVar2->rgwtMin + i) + 2),
                                                  (int)pFVar2->rgwtMin[i]),
                                         CONCAT22(pctSell._2_2_,(int)pctSell));
              lVar13 = __aFldiv(uVar12,lVar13);
              if (lVar13 == 0) {
                lVar13 = 1;
              }
              lSell._2_2_ = (int)((ulong)lVar13 >> 0x10);
              lSell._0_2_ = (uint)lVar13;
              puVar1 = (uint *)(pFVar2->rgwtMin + i);
              uVar6 = *puVar1;
              *puVar1 = *puVar1 - (uint)lSell;
              puVar1 = (uint *)((int)(pFVar2->rgwtMin + i) + 2);
              *puVar1 = (*puVar1 - lSell._2_2_) - (uint)(uVar6 < (uint)lSell);
            }
          }
          if (bVar5) {
            FSendPlrMsg2(pFVar2->iPlayer,idmCrewHasSoldOffCargoBlackMarket,-5,lpfl->id,
                              (int)pctSell);
          }
        }
      }
    }
    pPVar9 = (PLANET *)lpPlanets + cPlanet;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    pPVar10 = (PLANET *)lpPlanets;
    while ((PLANET *)lppl < pPVar9) {
      uVar11 = (undefined2)((ulong)lppl >> 0x10);
      if ((((PLANET *)lppl)->iPlayer != -1) && (rgfCheater[((PLANET *)lppl)->iPlayer] != '\0')) {
        uVar12 = __aFulshr(uVar15,(ushort)pPVar10);
        if (((uVar12 & 0xfff) == 0) || (sVar7 = Random(8), sVar7 != 0)) {
          sVar7 = Random(0xf);
          if (sVar7 == 0) {
            sVar7 = Random(3);
            sVar8 = Random(0x29);
            lVar13 = 100;
            uVar12 = __aFulmul(CONCAT22(*(undefined2 *)
                                                 ((int)(((PLANET *)lppl)->rgwtMin + sVar7) + 2),
                                                (int)((PLANET *)lppl)->rgwtMin[sVar7]),
                                       (long)(sVar8 + 5));
            lVar13 = __aFldiv(uVar12,lVar13);
            if (0 < lVar13) {
              if (30000 < lVar13) {
                lVar13 = 30000;
              }
              lSell._2_2_ = (int)((ulong)lVar13 >> 0x10);
              lSell._0_2_ = (uint)lVar13;
              puVar1 = (uint *)(((PLANET *)lppl)->rgwtMin + sVar7);
              uVar6 = *puVar1;
              *puVar1 = *puVar1 - (uint)lSell;
              puVar1 = (uint *)((int)(((PLANET *)lppl)->rgwtMin + sVar7) + 2);
              *puVar1 = (*puVar1 - lSell._2_2_) - (uint)(uVar6 < (uint)lSell);
              FSendPlrMsg(((PLANET *)lppl)->iPlayer,
                               idmFreedomFightersHaveStolenKtStockpilesPress,-5,lppl->id,(uint)lSell
                               ,sVar7 + 1,0,0,0,0);
            }
          }
        }
        else {
          sVar7 = Random(0x1f);
          lVar13 = 100;
          uVar14 = (ulong)(sVar7 + 5);
          uVar12 = __aFulshr(uVar14,100);
          uVar12 = __aFulmul(uVar12 & 0xfff,uVar14);
          lVar13 = __aFldiv(uVar12,lVar13);
          if (lVar13 < 1) {
            lVar13 = 1;
          }
          lSell._0_2_ = (uint)lVar13;
          uVar6 = *(uint *)&((PLANET *)lppl)->dwFlags;
          iVar4 = *(int *)((int)&((PLANET *)lppl)->dwFlags + 2);
          pPVar10 = (PLANET *)(uVar6 + (uint)lSell * -0x100 & 0xff00);
          *(uint *)&((PLANET *)lppl)->dwFlags = *(uint *)&((PLANET *)lppl)->dwFlags & 0xff;
          puVar1 = (uint *)((int)&((PLANET *)lppl)->dwFlags + 2);
          *puVar1 = *puVar1 & 0xfff0;
          *(uint *)&((PLANET *)lppl)->dwFlags = *(uint *)&((PLANET *)lppl)->dwFlags | (uint)pPVar10;
          puVar1 = (uint *)((int)&((PLANET *)lppl)->dwFlags + 2);
          *puVar1 = *puVar1 | iVar4 - (uint)(uVar6 < (uint)lSell * 0x100) & 0xf;
          FSendPlrMsg2(((PLANET *)lppl)->iPlayer,
                            idmFreedomFightersHaveAttackedDestroyedMinesPress,-5,lppl->id,
                            (uint)lSell);
        }
      }
      lppl = (PLANET *)CONCAT22(uVar11,(PLANET *)lppl + 1);
    }
  }
  return;
}



// ======================================================================
// Function: FFleetHasBombs
// Address: 10f0:1e16
// Segment: MEMORY_BATTLE
// ======================================================================


short FFleetHasBombs(FLEET *lpfl)

{
  undefined2 uVar1;
  short sVar2;
  HUL *pHVar3;
  int iVar4;
  short ishdef;
  short imd;
  HUL *lphul;
  
  ishdef = 0;
  do {
    if (0xf < ishdef) {
      return 0;
    }
    if (((FLEET *)lpfl)->rgcsh[ishdef] != 0) {
      iVar4 = ((uint)lpfl->id >> 9 & 0xf) * 4;
      uVar1 = *(undefined2 *)(iVar4 + 0x100);
      pHVar3 = (HUL *)(*(int *)(iVar4 + 0xfe) + ishdef * 0x93);
      lphul = (HUL *)CONCAT22(uVar1,pHVar3);
      LphuldefFromId(lphul->ihuldef);
      sVar2 = FHullHasBombs((HUL *)CONCAT22(uVar1,pHVar3));
      if (sVar2 != 0) {
        return 1;
      }
    }
    ishdef = ishdef + 1;
  } while( true );
}



// ======================================================================
// Function: FHullHasBombs
// Address: 10f0:1ec2
// Segment: MEMORY_BATTLE
// ======================================================================


short FHullHasBombs(HUL *lphul)

{
  short ihs;
  HS *lphs;
  
  lphs = (HS *)CONCAT22(lphul._2_2_,((HUL *)lphul)->rghs);
  ihs = 0;
  while( true ) {
    if ((int)(uint)((HUL *)lphul)->chs <= ihs) {
      return 0;
    }
    if ((lphs->grhst == hstBomb) && ((uint)((HS *)lphs)->wFlags >> 8 != 0)) {
      return 1;
    }
    if (((lphs->grhst == hstBeam) && ((((HS *)lphs)->wFlags & 0xffU) == 0x12)) &&
       ((uint)((HS *)lphs)->wFlags >> 8 != 0)) {
      return 1;
    }
    if (((lphs->grhst == hstSpecialM) && ((((HS *)lphs)->wFlags & 0xffU) == 1)) &&
       ((uint)((HS *)lphs)->wFlags >> 8 != 0)) break;
    ihs = ihs + 1;
    lphs = (HS *)CONCAT22(lphs._2_2_,(HS *)lphs + 1);
  }
  return 1;
}



// ======================================================================
// Function: FFleetHasTeeth
// Address: 10f0:1fbe
// Segment: MEMORY_BATTLE
// ======================================================================


short FFleetHasTeeth(FLEET *lpfl)

{
  short sVar1;
  int iVar2;
  short ishdef;
  
  ishdef = 0;
  while( true ) {
    if (0xf < ishdef) {
      return 0;
    }
    if (((((FLEET *)lpfl)->rgcsh[ishdef] != 0) &&
        (iVar2 = ((uint)lpfl->id >> 9 & 0xf) * 4,
        sVar1 = FHullHasTeeth((HUL *)CONCAT22(*(undefined2 *)(iVar2 + 0x100),
                                              (HUL *)(*(int *)(iVar2 + 0xfe) + ishdef * 0x93))),
        sVar1 != 0)) &&
       (iVar2 = ((uint)lpfl->id >> 9 & 0xf) * 4,
       (*(uint *)(*(int *)(iVar2 + 0xfe) + ishdef * 0x93 + 0x7b) & 0xff) == 7)) break;
    ishdef = ishdef + 1;
  }
  return 1;
}



// ======================================================================
// Function: FHullHasTeeth
// Address: 10f0:2072
// Segment: MEMORY_BATTLE
// ======================================================================


short FHullHasTeeth(HUL *lphul)

{
  short ihs;
  HS *lphs;
  
  lphs = (HS *)CONCAT22(lphul._2_2_,((HUL *)lphul)->rghs);
  ihs = 0;
  while( true ) {
    if ((int)(uint)((HUL *)lphul)->chs <= ihs) {
      return 0;
    }
    if (((lphs->grhst & (hstTorp|hstBeam)) !=
         ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
           hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
       ((uint)((HS *)lphs)->wFlags >> 8 != 0)) break;
    ihs = ihs + 1;
    lphs = (HS *)CONCAT22(lphs._2_2_,(HS *)lphs + 1);
  }
  return 1;
}



// ======================================================================
// Function: FFuelTanker
// Address: 10f0:20f6
// Segment: MEMORY_BATTLE
// ======================================================================


short FFuelTanker(SHDEF *lpshdef)

{
  short sVar1;
  
  if (((lpshdef->hul).ihuldef == ihuldefFuelTransport) ||
     ((lpshdef->hul).ihuldef == ihuldefSuperFuelXport)) {
    sVar1 = 1;
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: CheckTarget
// Address: 10f0:212a
// Segment: MEMORY_BATTLE
// ======================================================================


void CheckTarget(TOK *ptok,FLEET *lpfl,short ishdef)

{
  undefined2 uVar1;
  uint uVar2;
  short sVar3;
  SHDEF *pSVar4;
  BTLPLAN *pBVar5;
  TOK *pTVar6;
  undefined2 uVar7;
  SHDEF *lpshdef;
  short ibp;
  BTLPLAN *lpbtlplan;
  short iplr;
  
  uVar2 = (uint)lpfl->id >> 9 & 0xf;
  uVar1 = *(undefined2 *)(uVar2 * 4 + 0x100);
  pSVar4 = (SHDEF *)(*(int *)(uVar2 * 4 + 0xfe) + ishdef * 0x93);
  sVar3 = FHullHasTeeth((HUL *)CONCAT22(uVar1,pSVar4));
  pTVar6 = (TOK *)ptok;
  uVar7 = (undefined2)((ulong)ptok >> 0x10);
  if (sVar3 == 0) {
    sVar3 = FHullHasBombs((HUL *)CONCAT22(uVar1,pSVar4));
    if (sVar3 == 0) {
      sVar3 = FFuelTanker((SHDEF *)CONCAT22(uVar1,pSVar4));
      if (sVar3 == 0) {
        sVar3 = WtMaxShdefStat((SHDEF *)CONCAT22(uVar1,pSVar4),2);
        if (sVar3 == 0) {
          pTVar6->wFlags = pTVar6->wFlags & 0xfffU | 0x5000;
        }
        else {
          pTVar6->wFlags = pTVar6->wFlags & 0xfffU | 0x7000;
        }
      }
      else {
        pTVar6->wFlags = pTVar6->wFlags & 0xfffU | 0x6000;
      }
    }
    else {
      pTVar6->wFlags = pTVar6->wFlags & 0xfffU | 0x4000;
    }
  }
  else {
    pTVar6->wFlags = pTVar6->wFlags & 0xfffU | 0x3000;
  }
  uVar1 = ((undefined2 *)&DAT_1120_593a)[uVar2 * 2];
  pBVar5 = ((BTLPLAN **)rglpbtlplan)[uVar2 * 2] + ((FLEET *)lpfl)->iplan;
  lpbtlplan = (BTLPLAN *)CONCAT22(uVar1,pBVar5);
  pTVar6->wFlags = pTVar6->wFlags & 0xfff0U | pBVar5->wFlags & 0xfU;
  pTVar6->wFlags = pTVar6->wFlags & 0xff0fU | ((uint)pBVar5->wFlags >> 4 & 0xf) << 4;
  if ((uint)pTVar6->wFlags >> 0xc == 3) {
    pTVar6->wFlags = pTVar6->wFlags & 0xf0ffU | ((uint)lpbtlplan->wFlags >> 8 & 0xf) << 8;
  }
  else {
    pTVar6->wFlags = pTVar6->wFlags & 0xf0ff;
  }
  if (((uint)pTVar6->wFlags >> 8 & 0xf) == 0) {
    pTVar6->wFlags = pTVar6->wFlags & 0xfc1fU | 0xe0;
  }
  return;
}



// ======================================================================
// Function: FDumpCargo
// Address: 10f0:234a
// Segment: MEMORY_BATTLE
// ======================================================================


short FDumpCargo(FLEET *lpfl)

{
  uint *puVar1;
  uint uVar2;
  uint uVar3;
  short sVar4;
  undefined2 uVar5;
  uint uVar6;
  long *plVar7;
  PLANET *pPVar8;
  short i;
  PLANET *lppl;
  POINT pt;
  
  i = 0;
  while( true ) {
    if (((2 < i) || ((int)((FLEET *)lpfl)->rgwtMin[i] != 0)) ||
       (*(int *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) != 0)) break;
    i = i + 1;
  }
  if (i < 3) {
    uVar6 = (uint)lpfl->id >> 9 & 0xf;
    if ((((BTLPLAN **)rglpbtlplan)[uVar6 * 2] + ((FLEET *)lpfl)->iplan)->wFlags < 0) {
      if (((FLEET *)lpfl)->idPlanet == -1) {
        pt.x = (&((FLEET *)lpfl)->pt)->x;
        pt.y = (((FLEET *)lpfl)->pt).y;
        DropSalvage((THING **)&lpthBattle,
                    (long *)CONCAT22(lpfl._2_2_,((FLEET *)lpfl)->rgwtMin),(uint)lpfl->id >> 9 & 0xf,
                    &pt);
      }
      else {
        pPVar8 = LpplFromId(((FLEET *)lpfl)->idPlanet);
        uVar5 = (undefined2)((ulong)pPVar8 >> 0x10);
        for (i = 0; i < 3; i = i + 1) {
          uVar2 = *(uint *)(((FLEET *)lpfl)->rgwtMin + i);
          uVar3 = *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
          plVar7 = ((PLANET *)pPVar8)->rgwtMin + i;
          puVar1 = (uint *)plVar7;
          uVar6 = *puVar1;
          *puVar1 = *puVar1 + uVar2;
          puVar1 = (uint *)((int)plVar7 + 2);
          *puVar1 = *puVar1 + uVar3 + (uint)CARRY2(uVar6,uVar2);
        }
      }
      for (i = 0; i < 3; i = i + 1) {
        *(undefined2 *)(((FLEET *)lpfl)->rgwtMin + i) = 0;
        *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = 0;
      }
      sVar4 = 1;
    }
    else {
      sVar4 = 0;
    }
  }
  else {
    sVar4 = 0;
  }
  return sVar4;
}



// ======================================================================
// Function: DropSalvage
// Address: 10f0:24dc
// Segment: MEMORY_BATTLE
// ======================================================================


void DropSalvage(THING **plpth,long *rgwtMinerals,short iplr,POINT *ppt)

{
  uint *puVar1;
  uint uVar2;
  short sVar3;
  uint uVar4;
  int iVar5;
  THING *pTVar6;
  undefined2 uVar7;
  bool bVar8;
  ulong uVar9;
  long lVar10;
  THING *lpth;
  short i;
  long wt;
  long wtTotal;
  
                    /* WARNING: Load size is inaccurate */
  pTVar6 = *plpth;
  iVar5 = *(int *)((int)plpth + 2);
  lpth = (THING *)CONCAT22(iVar5,pTVar6);
  wtTotal._0_2_ = 0;
  wtTotal._2_2_ = 0;
  for (i = 0; i < game.cPlanMax; i = i + 1) {
    if ((ppt->x == ((POINT *)rgptPlan + i)->x) &&
       (ppt->y == *(int *)((int)&rgptPlan[0].y + i * 4))) {
      return;
    }
  }
  i = 0;
  while( true ) {
    if (2 < i) break;
    uVar4 = *(uint *)((long *)rgwtMinerals + i);
    bVar8 = CARRY2((uint)wtTotal,uVar4);
    wtTotal._0_2_ = (uint)wtTotal + uVar4;
    wtTotal._2_2_ = wtTotal._2_2_ + *(uint *)((int)((long *)rgwtMinerals + i) + 2) + (uint)bVar8;
    i = i + 1;
  }
  while (((uint)wtTotal == 0 && (wtTotal._2_2_ == 0))) {
    for (i = 0; i < 3; i = i + 1) {
      sVar3 = Random(10);
      *(short *)((long *)rgwtMinerals + i) = sVar3;
      *(short *)((int)((long *)rgwtMinerals + i) + 2) = sVar3 >> 0xf;
      uVar4 = *(uint *)((long *)rgwtMinerals + i);
      bVar8 = CARRY2((uint)wtTotal,uVar4);
      wtTotal._0_2_ = (uint)wtTotal + uVar4;
      wtTotal._2_2_ = wtTotal._2_2_ + *(uint *)((int)((long *)rgwtMinerals + i) + 2) + (uint)bVar8;
    }
  }
  if ((pTVar6 == (THING *)0x0) && (iVar5 == 0)) {
    lpth = LpthNew(iplr,ithMineralPacket);
    iVar5 = (int)((ulong)lpth >> 0x10);
    pTVar6 = (THING *)lpth;
    if ((pTVar6 == (THING *)0x0) && (iVar5 == 0)) {
      return;
    }
    *(uint *)pTVar6->rgb = *(uint *)pTVar6->rgb & 0xc3ff;
    sVar3 = ppt->y;
    (&pTVar6->pt)->x = ppt->x;
    (pTVar6->pt).y = sVar3;
    *(uint *)pTVar6->rgb = *(uint *)pTVar6->rgb & 0xfc00 | 0x3ff;
  }
  else {
    for (i = 0; i < 3; i = i + 1) {
      uVar2 = *(uint *)(pTVar6->rgb + i * 2 + 2);
      puVar1 = (uint *)((long *)rgwtMinerals + i);
      uVar4 = *puVar1;
      *puVar1 = *puVar1 + uVar2;
      puVar1 = (uint *)((int)((long *)rgwtMinerals + i) + 2);
      *puVar1 = *puVar1 + ((int)uVar2 >> 0xf) + (uint)CARRY2(uVar4,uVar2);
      uVar4 = *(uint *)(pTVar6->rgb + i * 2 + 2);
      bVar8 = CARRY2((uint)wtTotal,uVar4);
      wtTotal._0_2_ = (uint)wtTotal + uVar4;
      wtTotal._2_2_ = wtTotal._2_2_ + ((int)uVar4 >> 0xf) + (uint)bVar8;
      (pTVar6->rgb + i * 2 + 2)[0] = 0;
      (pTVar6->rgb + i * 2 + 2)[1] = 0;
    }
    *(uint *)(pTVar6->rgb + 8) = *(uint *)(pTVar6->rgb + 8) & 0xc000;
  }
  uVar7 = (undefined2)((ulong)lpth >> 0x10);
  *(uint *)((THING *)lpth)->rgb = *(uint *)((THING *)lpth)->rgb & 0xbfff | 0x4000;
  do {
    if ((wtTotal._2_2_ < 1) && ((wtTotal._2_2_ < 0 || ((uint)wtTotal == 0)))) {
      *(THING **)plpth = (THING *)lpth;
      *(undefined2 *)((int)plpth + 2) = lpth._2_2_;
      return;
    }
    for (i = 0; i < 3; i = i + 1) {
      uVar7 = (undefined2)((ulong)lpth >> 0x10);
      pTVar6 = (THING *)lpth;
      uVar9 = __aFulmul((ulong)*(uint *)(pTVar6->rgb + 8) & 0xffff3fff,10);
      puVar1 = (uint *)((long *)rgwtMinerals + i);
      iVar5 = (int)(uVar9 >> 0x10) + *(uint *)((int)((long *)rgwtMinerals + i) + 2) +
              (uint)CARRY2((uint)uVar9,*puVar1);
      if ((iVar5 < 0) || ((iVar5 < 1 && ((uint)uVar9 + *puVar1 < 0x7531)))) {
        uVar4 = *(uint *)((long *)rgwtMinerals + i);
        lVar10 = __aFldiv(CONCAT22(*(uint *)((int)((long *)rgwtMinerals + i) + 2) +
                                           (uint)(0xfff6 < uVar4),uVar4 + 9),10);
        iVar5 = *(int *)(pTVar6->rgb + 8);
        *(uint *)(pTVar6->rgb + 8) = *(uint *)(pTVar6->rgb + 8) & 0xc000;
        *(uint *)(pTVar6->rgb + 8) = *(uint *)(pTVar6->rgb + 8) | (int)lVar10 + iVar5 & 0x3fffU;
        *(int *)(pTVar6->rgb + i * 2 + 2) =
             *(int *)(pTVar6->rgb + i * 2 + 2) + (int)((long *)rgwtMinerals)[i];
        uVar4 = *(uint *)((long *)rgwtMinerals + i);
        wtTotal._2_2_ =
             (wtTotal._2_2_ - *(uint *)((int)((long *)rgwtMinerals + i) + 2)) -
             (uint)((uint)wtTotal < uVar4);
        *(undefined2 *)((long *)rgwtMinerals + i) = 0;
        *(undefined2 *)((int)((long *)rgwtMinerals + i) + 2) = 0;
      }
      else {
        uVar9 = __aFulmul((ulong)*(uint *)(pTVar6->rgb + 8) & 0xffff3fff,10);
        uVar4 = 30000 - (uint)uVar9;
        iVar5 = -(uint)(30000 < (uint)uVar9) - (int)(uVar9 >> 0x10);
        wtTotal._2_2_ = (wtTotal._2_2_ - iVar5) - (uint)((uint)wtTotal < uVar4);
        *(uint *)(pTVar6->rgb + 8) = *(uint *)(pTVar6->rgb + 8) & 0xc000 | 3000;
        *(uint *)(pTVar6->rgb + i * 2 + 2) = *(int *)(pTVar6->rgb + i * 2 + 2) + uVar4;
        puVar1 = (uint *)((long *)rgwtMinerals + i);
        uVar2 = *puVar1;
        *puVar1 = *puVar1 - uVar4;
        puVar1 = (uint *)((int)((long *)rgwtMinerals + i) + 2);
        *puVar1 = (*puVar1 - iVar5) - (uint)(uVar2 < uVar4);
        lpth = LpthNew(iplr,ithMineralPacket);
        iVar5 = (int)((ulong)lpth >> 0x10);
        pTVar6 = (THING *)lpth;
        if ((pTVar6 == (THING *)0x0) && (iVar5 == 0)) {
          return;
        }
        *(uint *)pTVar6->rgb = *(uint *)pTVar6->rgb & 0xc3ff;
        *(uint *)pTVar6->rgb = *(uint *)pTVar6->rgb & 0xfc00 | 0x3ff;
        sVar3 = ppt->y;
        (&pTVar6->pt)->x = ppt->x;
        (pTVar6->pt).y = sVar3;
      }
      wtTotal._0_2_ = (uint)wtTotal - uVar4;
      if ((wtTotal._2_2_ < 1) && ((wtTotal._2_2_ < 0 || ((uint)wtTotal == 0)))) break;
    }
  } while( true );
}



// ======================================================================
// Function: CplrBattle
// Address: 10f0:2952
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f03389) */

short CplrBattle(FLEET *lpfl,ushort *rggrfAttack,ushort *pgrfPlayer,ushort *pgrfSpectator)

{
  uint *puVar1;
  int *piVar2;
  char cVar3;
  int iVar4;
  uint uVar5;
  PLANET *pPVar6;
  bool bVar7;
  short sVar8;
  byte bVar9;
  FLEET *pFVar10;
  uint uVar11;
  undefined2 uVar12;
  PLANET *pPVar13;
  HULDEF *pHVar14;
  short ctokFleet;
  short ctokNew;
  ushort grfPlayer;
  short cflTotal;
  short ishdef;
  short cshdef;
  short fAttack;
  ushort iplrAttack;
  short fChange;
  byte rgctok [16];
  short mdRel;
  short i;
  short cplr;
  PLANET *lppl;
  short iplrCur;
  ushort grPlr;
  long rgcsh [16];
  FLEET *lpflCur;
  short iplrStarbase;
  
  bVar7 = false;
  iplrStarbase = -1;
  grfPlayer = 0;
  cshdef = 0;
  grfMissed = 0;
  *pgrfSpectator = 0;
  _memset(rggrfAttack,0,0x20);
  _memset(rgcsh,0,0x40);
  uVar12 = (undefined2)((ulong)lpfl >> 0x10);
  if (((FLEET *)lpfl)->idPlanet != -1) {
    pPVar13 = LpplFromId(((FLEET *)lpfl)->idPlanet);
    uVar12 = (undefined2)((ulong)pPVar13 >> 0x10);
    pPVar6 = (PLANET *)pPVar13;
    if (((uint)pPVar6->wFlags >> 9 & 1) == 0) {
      if (pPVar6->iPlayer != -1) {
        *pgrfSpectator = *pgrfSpectator | 1 << ((byte)pPVar6->iPlayer & 0x1f);
      }
    }
    else {
      iplrStarbase = pPVar6->iPlayer;
      grfPlayer = 1 << ((byte)iplrStarbase & 0x1f);
      uVar11 = *(uint *)((int)*(undefined4 *)((BTLPLAN **)rglpbtlplan + iplrStarbase * 2)
                        + 2) >> 8 & 0x1f;
      sVar8 = FHullHasTeeth((HUL *)CONCAT22(*(undefined2 *)(iplrStarbase * 4 + 0x14e),
                                            (HUL *)(*(int *)(iplrStarbase * 4 + 0x14c) +
                                                   (*(uint *)&pPVar6->field11_0x2c & 0xf) * 0x93)));
      if ((sVar8 != 0) && (uVar11 != 0)) {
        if ((uVar11 == 1) || (uVar11 == 2)) {
          for (i = 0; i < game.cPlayer; i = i + 1) {
            if ((i != iplrStarbase) &&
               ((cVar3 = *(char *)(iplrStarbase * 0xc0 + 0x5a12 + i), cVar3 == '\x02' ||
                ((cVar3 == '\0' && (uVar11 == 2)))))) {
              rggrfAttack[iplrStarbase] = rggrfAttack[iplrStarbase] | 1 << ((byte)i & 0x1f);
            }
          }
        }
        else if (uVar11 == 3) {
          rggrfAttack[iplrCur] = ~(1 << ((byte)iplrStarbase & 0x1f));
        }
        else {
          rggrfAttack[iplrCur] = rggrfAttack[iplrCur] | 1 << ((char)uVar11 - 4U & 0x1f);
        }
      }
    }
  }
  lpflCur = lpfl;
  do {
    uVar12 = (undefined2)((ulong)lpflCur >> 0x10);
    pFVar10 = (FLEET *)lpflCur;
    if (((uint)pFVar10->wFlags >> 10 & 1) == 0) {
      iVar4 = pFVar10->iPlayer;
      grfPlayer = grfPlayer | 1 << ((byte)iVar4 & 0x1f);
      uVar11 = (uint)lpflCur->id >> 9 & 0xf;
      if ((((((BTLPLAN **)rglpbtlplan)[uVar11 * 2][pFVar10->iplan].wFlags & 0xfU) != 0) &&
          (uVar11 = (uint)lpflCur->id >> 9 & 0xf,
          ((uint)((BTLPLAN **)rglpbtlplan)[uVar11 * 2][pFVar10->iplan].wFlags >> 8 & 0x1f)
          != 0)) && (sVar8 = FFleetHasTeeth(lpflCur), sVar8 != 0)) {
        bVar7 = true;
        iplrAttack = (uint)((BTLPLAN **)rglpbtlplan)[iVar4 * 2][pFVar10->iplan].wFlags >>
                     8 & 0x1f;
        uVar11 = (uint)lpflCur->id >> 9 & 0xf;
        if ((((BTLPLAN **)rglpbtlplan)[uVar11 * 2][pFVar10->iplan].wFlags & 0xfU) == 0) {
          iplrAttack = 0;
        }
        if (iplrAttack != 0) {
          if ((iplrAttack == 1) || (iplrAttack == 2)) {
            for (i = 0; i < game.cPlayer; i = i + 1) {
              if ((i != iVar4) &&
                 ((cVar3 = *(char *)(iVar4 * 0xc0 + 0x5a12 + i), cVar3 == '\x02' ||
                  ((cVar3 == '\0' && (iplrAttack == 2)))))) {
                rggrfAttack[iVar4] = rggrfAttack[iVar4] | 1 << ((byte)i & 0x1f);
              }
            }
          }
          else if (iplrAttack == 3) {
            rggrfAttack[iVar4] = ~(1 << ((byte)iVar4 & 0x1f));
          }
          else {
            rggrfAttack[iVar4] = rggrfAttack[iVar4] | 1 << ((char)iplrAttack - 4U & 0x1f);
          }
        }
      }
      pFVar10->wFlags = pFVar10->wFlags & 0xf7ffU | 0x800;
      pFVar10->wFlags = pFVar10->wFlags & 0xfeffU | 0x100;
    }
                    /* WARNING: Load size is inaccurate */
    lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&pFVar10->lpflNext + 2),pFVar10->lpflNext);
  } while (lpfl != lpflCur);
  if (bVar7) {
    iplrAttack = 0;
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (rggrfAttack[i] != 0) {
        iplrAttack = iplrAttack | grfPlayer & rggrfAttack[i];
      }
    }
    if (iplrAttack == 0) {
      cplr = 0;
    }
    else {
      for (i = 0; i < game.cPlayer; i = i + 1) {
        bVar9 = (byte)i;
        if ((rggrfAttack[i] & iplrAttack) != 0) {
          iplrAttack = iplrAttack | 1 << (bVar9 & 0x1f);
        }
        if ((1 << (bVar9 & 0x1f) & iplrAttack) != 0) {
          for (iplrCur = 0; iplrCur < game.cPlayer; iplrCur = iplrCur + 1) {
            if ((1 << (bVar9 & 0x1f) & rggrfAttack[iplrCur]) != 0) {
              rggrfAttack[i] = rggrfAttack[i] | 1 << ((byte)iplrCur & 0x1f);
            }
          }
        }
      }
      do {
        if (lpfl == lpflCur) {
          fChange = 0;
        }
        iVar4 = ((FLEET *)lpflCur)->iPlayer;
        uVar11 = 1 << ((byte)iVar4 & 0x1f);
        if (((grfPlayer & uVar11) != 0) && ((iplrAttack & uVar11) == 0)) {
          rggrfAttack[iVar4] = 0;
          for (i = 0; i < game.cPlayer; i = i + 1) {
            if (((i != iVar4) && (*(char *)(iVar4 * 0xc0 + 0x5a12 + i) == '\x01')) &&
               ((1 << ((byte)i & 0x1f) & iplrAttack) != 0)) {
              if ((1 << ((byte)i & 0x1f) & rggrfAttack[iVar4]) != 0) {
                rggrfAttack[iVar4] = 0;
                break;
              }
              rggrfAttack[iVar4] = rggrfAttack[iVar4] | rggrfAttack[i];
            }
          }
          if (rggrfAttack[iVar4] == 0) {
            grfPlayer = grfPlayer & ~uVar11;
          }
          else {
            iplrAttack = iplrAttack | uVar11;
          }
          fChange = 1;
        }
                    /* WARNING: Load size is inaccurate */
        lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                    ((FLEET *)lpflCur)->lpflNext);
      } while ((fChange != 0) || (lpfl != lpflCur));
      if ((iplrStarbase != -1) && ((1 << ((byte)iplrStarbase & 0x1f) & grfPlayer) != 0)) {
        *(undefined2 *)(rgcsh + iplrStarbase) = 1;
        *(undefined2 *)((int)rgcsh + iplrStarbase * 4 + 2) = 0;
        cshdef = 1;
      }
      do {
        uVar12 = (undefined2)((ulong)lpflCur >> 0x10);
        pFVar10 = (FLEET *)lpflCur;
        iVar4 = pFVar10->iPlayer;
        uVar11 = 1 << ((byte)iVar4 & 0x1f);
        if ((grfPlayer & uVar11) == 0) {
          *pgrfSpectator = *pgrfSpectator | uVar11;
          pFVar10->wFlags = pFVar10->wFlags & 0xfeff;
        }
        else {
          for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
            if (pFVar10->rgcsh[ishdef] != 0) {
              pHVar14 = LphuldefFromId
                                  (*(HullDef *)(*(int *)(iVar4 * 4 + 0xfe) + ishdef * 0x93));
              if (((uint)((HULDEF *)pHVar14)->wFlags >> 6 & 0xf) != 0) {
                uVar5 = pFVar10->rgcsh[ishdef];
                puVar1 = (uint *)(rgcsh + iVar4);
                uVar11 = *puVar1;
                *puVar1 = *puVar1 + uVar5;
                piVar2 = (int *)((int)rgcsh + iVar4 * 4 + 2);
                *piVar2 = *piVar2 + ((int)uVar5 >> 0xf) + (uint)CARRY2(uVar11,uVar5);
              }
              cshdef = cshdef + 1;
            }
          }
        }
                    /* WARNING: Load size is inaccurate */
        lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&pFVar10->lpflNext + 2),pFVar10->lpflNext);
      } while (lpfl != lpflCur);
      cplr = 0;
      for (; iplrAttack != 0; iplrAttack = iplrAttack >> 1) {
        if ((iplrAttack & 1) != 0) {
          cplr = cplr + 1;
        }
      }
      if (0xff < cshdef) {
        ctokNew = 0;
        if ((iplrStarbase != -1) && ((1 << ((byte)iplrStarbase & 0x1f) & grfPlayer) != 0)) {
          ctokNew = 1;
        }
        _memset(rgctok,0,0x10);
        do {
          uVar12 = (undefined2)((ulong)lpflCur >> 0x10);
          pFVar10 = (FLEET *)lpflCur;
          if (((uint)pFVar10->wFlags >> 8 & 1) != 0) {
            ctokFleet = 0;
            for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
              if (pFVar10->rgcsh[ishdef] != 0) {
                ctokFleet = ctokFleet + 1;
              }
            }
            if ((int)(0xff / (long)cplr) < (int)((uint)rgctok[pFVar10->iPlayer] + ctokFleet)) {
              pFVar10->wFlags = pFVar10->wFlags & 0xfeff;
              pFVar10->wFlags = pFVar10->wFlags & 0xefffU | 0x1000;
              pFVar10->wFlags = pFVar10->wFlags & 0xff7fU | 0x80;
            }
            else {
              rgctok[pFVar10->iPlayer] = rgctok[pFVar10->iPlayer] + (char)ctokFleet;
              ctokNew = ctokNew + ctokFleet;
            }
          }
                    /* WARNING: Load size is inaccurate */
          lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&pFVar10->lpflNext + 2),pFVar10->lpflNext
                                     );
        } while (lpfl != lpflCur);
        if (ctokNew < 0xff) {
          do {
            uVar12 = (undefined2)((ulong)lpflCur >> 0x10);
            pFVar10 = (FLEET *)lpflCur;
            if (((uint)pFVar10->wFlags >> 7 & 1) != 0) {
              ctokFleet = 0;
              iVar4 = pFVar10->iPlayer;
              for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
                if (pFVar10->rgcsh[ishdef] != 0) {
                  ctokFleet = ctokFleet + 1;
                }
              }
              if (ctokNew + ctokFleet < 0x100) {
                pFVar10->wFlags = pFVar10->wFlags & 0xfeffU | 0x100;
                pFVar10->wFlags = pFVar10->wFlags & 0xefff;
                pFVar10->wFlags = pFVar10->wFlags & 0xff7f;
                rgctok[iVar4] = rgctok[iVar4] + (char)ctokFleet;
                ctokNew = ctokNew + ctokFleet;
              }
            }
                    /* WARNING: Load size is inaccurate */
            lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&pFVar10->lpflNext + 2),
                                        pFVar10->lpflNext);
          } while (lpfl != lpflCur);
        }
      }
      *pgrfPlayer = grfPlayer;
    }
  }
  else {
    cplr = 0;
  }
  return cplr;
}



// ======================================================================
// Function: SpdOfShip
// Address: 10f0:339c
// Segment: MEMORY_BATTLE
// ======================================================================


short SpdOfShip(FLEET *lpfl,short ishdef,TOK *ptok,short fDumpCargo,SHDEF *lpshdef)

{
  HullSlotType HVar1;
  uint uVar2;
  short sVar3;
  uint uVar4;
  uint uVar5;
  FLEET *pFVar6;
  int iVar7;
  SHDEF *pSVar8;
  TOK *pTVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  undefined2 uVar12;
  ENGINE *pEVar13;
  long lVar14;
  ulong uVar15;
  ENGINE *lpengine;
  short iEngine;
  ushort wtCargoShdefMax;
  short cEngineT;
  short j;
  long wtFleetCargo;
  short cThruster;
  short cHalfThruster;
  ushort wt;
  short iWarp;
  short spd;
  long wtCargoFleetMax;
  
  pFVar6 = (FLEET *)lpfl;
  uVar10 = (undefined2)((ulong)lpfl >> 0x10);
  if (((SHDEF *)lpshdef == (SHDEF *)0x0) && (lpshdef._2_2_ == 0)) {
    iVar7 = pFVar6->iPlayer * 4;
    lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iVar7 + 0x100),
                                (SHDEF *)(*(int *)(iVar7 + 0xfe) + ishdef * 0x93));
  }
  iEngine = -1;
  cHalfThruster = 0;
  cThruster = 0;
  j = 0;
  while( true ) {
    uVar11 = (undefined2)((ulong)lpshdef >> 0x10);
    pSVar8 = (SHDEF *)lpshdef;
    if ((int)(uint)(pSVar8->hul).chs <= j) break;
    if ((uint)(pSVar8->hul).rghs[j].wFlags >> 8 != 0) {
      HVar1 = ((pSVar8->hul).rghs + j)->grhst;
      if (HVar1 == hstEngine) {
        iEngine = (pSVar8->hul).rghs[j].wFlags & 0xff;
        cEngineT = (uint)(pSVar8->hul).rghs[j].wFlags >> 8;
        if (iEngine == 8) {
          cHalfThruster = cHalfThruster + ((uint)(pSVar8->hul).rghs[j].wFlags >> 8);
        }
      }
      else if (HVar1 == hstMining) {
        if (((pSVar8->hul).rghs[j].wFlags & 0xffU) == 6) {
          cHalfThruster = cHalfThruster + ((uint)(pSVar8->hul).rghs[j].wFlags >> 8);
        }
      }
      else if (HVar1 == hstSpecialE) {
        if (((pSVar8->hul).rghs[j].wFlags & 0xffU) == 4) {
          cThruster = cThruster + ((uint)(pSVar8->hul).rghs[j].wFlags >> 8);
        }
      }
      else if (HVar1 == hstSpecialM) {
        uVar2 = (pSVar8->hul).rghs[j].wFlags & 0xff;
        if (uVar2 == 7) {
          cThruster = cThruster + ((uint)(pSVar8->hul).rghs[j].wFlags >> 8);
        }
        else if (uVar2 == 8) {
          cThruster = cThruster + ((uint)(pSVar8->hul).rghs[j].wFlags >> 8) * 2;
        }
      }
    }
    j = j + 1;
  }
  if ((iEngine == -1) || (cEngineT == 0)) {
    uVar2 = 0;
  }
  else {
    pEVar13 = LpengineFromId(iEngine);
    if ((((iEngine == 7) || (iEngine == 8)) || (iEngine == 9)) ||
       ((iEngine == 0xe || (iEngine == 0xf)))) {
      iWarp = 10;
    }
    else {
      for (iWarp = 9; (0 < iWarp && (0x78 < ((ENGINE *)pEVar13)->rgcFuelUsed[iWarp]));
          iWarp = iWarp + -1) {
      }
    }
    spd = iWarp + -4 + cThruster + (cHalfThruster + 1) / 2;
    if (lpfl != (FLEET *)0x0) {
      sVar3 = GetRaceStat((PLAYER *)rgplr + pFVar6->iPlayer,rsMajorAdv);
      spd = spd + (uint)(sVar3 == 2) * 2;
    }
    wt = (pSVar8->hul).wtEmpty;
    pTVar9 = (TOK *)ptok;
    uVar12 = (undefined2)((ulong)ptok >> 0x10);
    if (lpfl != (FLEET *)0x0) {
      uVar2 = WtMaxShdefStat(lpshdef,2);
      if (uVar2 == 0) {
        fDumpCargo = 0;
      }
      else {
        lVar14 = LGetFleetStat(lpfl,2);
        uVar4 = *(uint *)pFVar6->rgwtMin + *(uint *)(pFVar6->rgwtMin + 1);
        uVar5 = uVar4 + *(uint *)(pFVar6->rgwtMin + 2);
        uVar15 = __aFulmul(CONCAT22(*(int *)((int)pFVar6->rgwtMin + 2) +
                                            *(int *)((int)pFVar6->rgwtMin + 6) +
                                            (uint)CARRY2(*(uint *)pFVar6->rgwtMin,
                                                         *(uint *)(pFVar6->rgwtMin + 1)) +
                                            *(int *)((int)pFVar6->rgwtMin + 10) +
                                            (uint)CARRY2(uVar4,*(uint *)(pFVar6->rgwtMin + 2)) +
                                            *(int *)((int)pFVar6->rgwtMin + 0xe) +
                                            (uint)CARRY2(uVar5,*(uint *)(pFVar6->rgwtMin + 3)),
                                            uVar5 + *(uint *)(pFVar6->rgwtMin + 3)),(ulong)uVar2);
        lVar14 = __aFldiv(uVar15,lVar14);
        wt = wt + (int)lVar14;
      }
      if (fDumpCargo != 0) {
        spd = spd + -1;
      }
      uVar2 = Random(0xf);
      pTVar9->wFlags = pTVar9->wFlags & 0xc3ffU | (uVar2 & 0xf) << 10;
    }
    if (ptok != (TOK *)0x0) {
      pTVar9->wt = wt;
    }
    uVar2 = spd - (int)(((ulong)wt / 0x46) / (ulong)((uint)(pSVar8->hul).rghs[0].wFlags >> 8));
    uVar4 = uVar2;
    if (8 < (int)uVar2) {
      uVar4 = 8;
    }
    if (uVar4 < 0x8000) {
      if (8 < (int)uVar2) {
        uVar2 = 8;
      }
    }
    else {
      uVar2 = 0;
    }
  }
  return uVar2;
}



// ======================================================================
// Function: LpshdefFromTok
// Address: 10f0:388e
// Segment: MEMORY_BATTLE
// ======================================================================


SHDEF * LpshdefFromTok(TOK *ptok)

{
  SHDEF *pSVar1;
  undefined2 uVar2;
  TOK *pTVar3;
  int iVar4;
  undefined2 uVar5;
  
  uVar5 = (undefined2)((ulong)ptok >> 0x10);
  pTVar3 = (TOK *)ptok;
  if (pTVar3->ishdef < 0x10) {
    iVar4 = (uint)pTVar3->iplr * 4;
    uVar2 = *(undefined2 *)(iVar4 + 0x100);
    pSVar1 = (SHDEF *)(*(int *)(iVar4 + 0xfe) + (uint)pTVar3->ishdef * 0x93);
  }
  else {
    iVar4 = (uint)pTVar3->iplr * 4;
    uVar2 = *(undefined2 *)(iVar4 + 0x14e);
    pSVar1 = (SHDEF *)(*(int *)(iVar4 + 0x14c) + (pTVar3->ishdef - 0x10) * 0x93);
  }
  return (SHDEF *)CONCAT22(uVar2,pSVar1);
}



// ======================================================================
// Function: FCanKillTok
// Address: 10f0:391e
// Segment: MEMORY_BATTLE
// ======================================================================


short FCanKillTok(TOK *ptok1,TOK *ptok2)

{
  uint uVar1;
  uint uVar2;
  uint uVar3;
  uint uVar4;
  short sVar5;
  undefined2 uVar6;
  SHDEF *pSVar7;
  long lp2;
  long lp1;
  
  pSVar7 = LpshdefFromTok(ptok1);
  uVar6 = (undefined2)((ulong)pSVar7 >> 0x10);
  uVar1 = *(uint *)&((SHDEF *)pSVar7)->lPower;
  uVar2 = *(uint *)((int)&((SHDEF *)pSVar7)->lPower + 2);
  pSVar7 = LpshdefFromTok(ptok2);
  uVar6 = (undefined2)((ulong)pSVar7 >> 0x10);
  uVar3 = *(uint *)&((SHDEF *)pSVar7)->lPower;
  uVar4 = *(uint *)((int)&((SHDEF *)pSVar7)->lPower + 2);
  if (((int)uVar4 < (int)uVar2) || (((int)uVar4 <= (int)uVar2 && (uVar3 <= uVar1)))) {
    if (((uVar2 & 0x7fff) < (uVar4 & 0x7fff)) ||
       (((uVar2 & 0x7fff) <= (uVar4 & 0x7fff) && ((uVar1 & 0xf000) <= (uVar3 & 0xf000))))) {
      if ((((uVar3 & 0xff00) == (uVar1 & 0xff00)) && ((uVar4 & 0x7fff) == (uVar2 & 0x7fff))) &&
         (((uint)((TOK *)ptok2)->wFlags >> 8 & 0xf) <= ((uint)((TOK *)ptok1)->wFlags >> 8 & 0xf))) {
        sVar5 = 1;
      }
      else {
        sVar5 = 0;
      }
    }
    else {
      sVar5 = 1;
    }
  }
  else {
    sVar5 = 0;
  }
  return sVar5;
}



// ======================================================================
// Function: DoBattles
// Address: 10f0:3a26
// Segment: MEMORY_BATTLE
// ======================================================================


void DoBattles(short fPostMovement)

{
  FLEET *pFVar1;
  int iVar2;
  byte *pbVar3;
  ushort rggrfAttack [16];
  ushort grfPlayer;
  ushort grfSpectator;
  FLEET *lpfl;
  short ifl;
  short cplr;
  
  LinkFleets(fPostMovement);
  vrgtok = LpAlloc(0x1d00,htMisc);
  vlpwtCargo = LpAlloc(0x200,htMisc);
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[ifl];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    pFVar1->wFlags = pFVar1->wFlags & 0xefff;
    if (((((uint)pFVar1->wFlags >> 0xb & 1) == 0) && (((uint)pFVar1->wFlags >> 10 & 1) == 0)) &&
       ((*(int *)&pFVar1->lpflNext != 0 || (*(int *)((int)&pFVar1->lpflNext + 2) != 0)))) {
      cplr = CplrBattle((FLEET *)CONCAT22(iVar2,pFVar1),rggrfAttack,&grfPlayer,&grfSpectator);
      if ((cplr != -1) && (cplr != 0)) {
        FDoCoolBattle(lpfl,cplr,rggrfAttack,grfPlayer,grfSpectator);
      }
    }
  }
  FreeLp(vlpwtCargo,htMisc);
  FreeLp(vrgtok,htMisc);
  vlpwtCargo._0_2_ = (ushort *)0x0;
  vlpwtCargo._2_2_ = 0;
  vrgtok._0_2_ = (TOK *)0x0;
  vrgtok._2_2_ = 0;
  if (((byte *)lpbBattleT != (byte *)0x0) || (lpbBattleT._2_2_ != 0)) {
    pbVar3 = lpbBattleT;
    pbVar3[0] = 0xff;
    pbVar3[1] = 0xff;
    FreeLp(lpbBattleT,htBattle);
    lpbBattleT = (byte *)0x0;
  }
  if (((byte *)lpbBattleCur != (byte *)0x0) || (lpbBattleCur._2_2_ != 0)) {
    pbVar3 = lpbBattleCur;
    pbVar3[0] = 0xff;
    pbVar3[1] = 0xff;
  }
  DoBombing();
  return;
}



// ======================================================================
// Function: RegenShield
// Address: 10f0:3c16
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f03c92) */

void RegenShield(TOK *ptok)

{
  uint iplr;
  TOK *pTVar1;
  undefined2 uVar2;
  SHDEF *lpshdef;
  long lVar3;
  long lVar4;
  long dpOrig;
  long dpNew;
  
  uVar2 = (undefined2)((ulong)ptok >> 0x10);
  pTVar1 = (TOK *)ptok;
  iplr = (uint)pTVar1->iplr;
  lpshdef = LpshdefFromTok(ptok);
  lVar3 = DpShieldOfShdef(lpshdef,iplr);
  if (pTVar1->dpShield != 0) {
    lVar4 = __aFldiv(lVar3,10);
    lVar4 = lVar4 + (ulong)(uint)pTVar1->dpShield;
    dpNew._0_2_ = (short)lVar4;
    if (lVar3 < lVar4) {
      dpNew._0_2_ = (short)lVar3;
    }
    pTVar1->dpShield = (short)dpNew;
  }
  return;
}



// ======================================================================
// Function: InitFromHuldef
// Address: 10f0:3cba
// Segment: MEMORY_BATTLE
// ======================================================================


short InitFromHuldef(HUL *lphul,short *ppctBC)

{
  uint uVar1;
  uint uVar2;
  HS *pHVar3;
  undefined2 uVar4;
  HULDEF *pHVar5;
  PART part;
  short pctBC;
  short cbc;
  short initBase;
  short pct;
  short i;
  short ihs;
  
  pct = 0;
  cbc = 0;
  pHVar5 = LphuldefFromId(lphul->ihuldef);
  uVar1 = ((HULDEF *)pHVar5)->wFlags;
  ihs = 0;
  while( true ) {
    uVar4 = (undefined2)((ulong)lphul >> 0x10);
    if ((int)(uint)((HUL *)lphul)->chs <= ihs) break;
    pHVar3 = ((HUL *)lphul)->rghs + ihs;
    part.hs.grhst = pHVar3->grhst;
    part.hs.wFlags = pHVar3->wFlags;
    if ((uint)part.hs.wFlags >> 8 != 0) {
      if ((part.hs.grhst & hstSpecialE) ==
          ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
            hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
        if (((part.hs.grhst & hstBeam) !=
             ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines
               |hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
           ((part.hs.wFlags & 0xffU) == 0x12)) {
          for (i = 0; i < (int)((uint)part.hs.wFlags >> 8); i = i + 1) {
            pct = pct + ((100 - pct) * 10) / 100;
          }
        }
      }
      else {
        uVar2 = part.hs.wFlags & 0xff;
        if (((uVar2 == 5) || (uVar2 == 6)) || (uVar2 == 7)) {
          FLookupPart(&part);
          cbc = cbc + ((part.hs.wFlags & 0xffU) - 4) * ((uint)part.hs.wFlags >> 8);
          for (i = 0; i < (int)((uint)part.hs.wFlags >> 8); i = i + 1) {
            pct = pct + ((100 - pct) * ((COMPART *)part.pcom + 1)->id) / 100;
          }
        }
      }
    }
    ihs = ihs + 1;
  }
  if (ppctBC != (short *)0x0) {
    *ppctBC = pct;
  }
  initBase = (uVar1 & 0x3f) + cbc;
  if (0x3f < initBase) {
    initBase = 0x3f;
  }
  return initBase;
}



// ======================================================================
// Function: CheckInitiative
// Address: 10f0:3e68
// Segment: MEMORY_BATTLE
// ======================================================================


void CheckInitiative(TOK *ptok)

{
  short sVar1;
  short pctBC;
  SHDEF *lpshdef;
  
  lpshdef = LpshdefFromTok(ptok);
  idPlayer = (short)((TOK *)ptok)->iplr;
  sVar1 = InitFromHuldef(&lpshdef->hul,&pctBC);
  ((TOK *)ptok)->initBase = (byte)sVar1;
  idPlayer = -1;
  ((TOK *)ptok)->pctBC = (byte)pctBC;
  return;
}



// ======================================================================
// Function: CheckWeapons
// Address: 10f0:3ec2
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f044a9) */
/* WARNING: Removing unreachable block (ram,0x10f043f1) */

void CheckWeapons(TOK *ptok,short *pfDampeningField,byte *pinit)

{
  byte bVar1;
  uint uVar2;
  TOK *pTVar3;
  SHDEF *pSVar4;
  HS *pHVar5;
  undefined2 uVar6;
  undefined2 uVar7;
  SHDEF *lpshdef_00;
  long lVar8;
  ulong uVar9;
  ulong uVar10;
  ulong uVar11;
  undefined1 *puVar12;
  undefined2 uVar13;
  PART part;
  short dxyPart;
  HUL *lphul;
  short initBase;
  short dxyLim;
  SHDEF *lpshdef;
  long pctHit;
  short initMin;
  long pctCap;
  short i;
  short dxyMax;
  short init;
  short initMac;
  short ihs;
  long pctBeamDef;
  long ldp;
  short pctJam;
  
  uVar9 = 1000;
  uVar10 = 1000;
  puVar12 = &DAT_0000_2710;
  uVar6 = (undefined2)((ulong)ptok >> 0x10);
  pTVar3 = (TOK *)ptok;
  bVar1 = pTVar3->initBase;
  initMin = -1;
  initMac = -1;
  lpshdef_00 = LpshdefFromTok(ptok);
  dxyMax = -1;
  dxyLim = -1;
  lVar8 = DpShieldOfShdef(lpshdef_00,(uint)pTVar3->iplr);
  ihs = 0;
  while( true ) {
    ldp._2_2_ = (int)((ulong)lVar8 >> 0x10);
    ldp._0_2_ = (short)lVar8;
    uVar7 = (undefined2)((ulong)lpshdef_00 >> 0x10);
    pSVar4 = (SHDEF *)lpshdef_00;
    if ((int)(uint)(pSVar4->hul).chs <= ihs) break;
    if (((((pSVar4->hul).rghs + ihs)->grhst &
         (hstSpecialM|hstSpecialE|hstMining|hstTorp|hstBeam|hstArmor|hstShield|hstScanner)) !=
         ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
           hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
       ((uint)(pSVar4->hul).rghs[ihs].wFlags >> 8 != 0)) {
      pctJam = 100;
      dxyPart = -1;
      pHVar5 = (pSVar4->hul).rghs + ihs;
      part.hs.grhst = pHVar5->grhst;
      part.hs.wFlags = pHVar5->wFlags;
      if ((part.hs.grhst & (hstTorp|hstBeam)) ==
          ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
            hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
        init = -1;
      }
      else {
        idPlayer = (short)pTVar3->iplr;
        FLookupPart(&part);
        idPlayer = -1;
        init = (uint)bVar1 + *(int *)(((COMPART *)part.pcom)[1].rgTech + 2);
        if (0x3f < init) {
          init = 0x3f;
        }
      }
      if (part.hs.grhst == hstShield) {
        if ((part.hs.wFlags & 0xffU) == 6) {
          pctJam = 0x5f;
        }
      }
      else if (part.hs.grhst == hstArmor) {
        if ((part.hs.wFlags & 0xffU) == 9) {
          pctJam = 0x50;
        }
      }
      else {
        uVar7 = (undefined2)((ulong)part.pcom >> 0x10);
        if (part.hs.grhst == hstBeam) {
          dxyPart = ((COMPART *)part.pcom + 1)->id;
        }
        else if (part.hs.grhst == hstTorp) {
          pTVar3->wFlags = pTVar3->wFlags & 0xfffbU | 4;
          dxyPart = ((COMPART *)part.pcom + 1)->id;
        }
        else if (part.hs.grhst == hstMining) {
          if ((part.hs.wFlags & 0xffU) == 6) {
            pctJam = 0x46;
          }
        }
        else if (part.hs.grhst == hstSpecialE) {
          switch(part.hs.wFlags & 0xff) {
          case 4:
            pctJam = 0x5a;
            break;
          case 8:
          case 9:
          case 10:
          case 0xb:
            idPlayer = (short)pTVar3->iplr;
            FLookupPart(&part);
            idPlayer = -1;
            pctJam = 100 - ((COMPART *)part.pcom + 1)->id;
            break;
          case 0xc:
          case 0xd:
            idPlayer = (short)pTVar3->iplr;
            FLookupPart(&part);
            idPlayer = -1;
            for (i = (uint)part.hs.wFlags >> 8; 0 < i; i = i + -1) {
              uVar13 = 0;
              uVar7 = 100;
              uVar2 = ((COMPART *)part.pcom + 1)->id;
              uVar9 = __aFulmul(uVar9,CONCAT22(((int)uVar2 >> 0xf) + (uint)(0xff9b < uVar2),
                                                       uVar2 + 100));
              uVar9 = __aFldiv(uVar9,CONCAT22(uVar13,uVar7));
            }
            break;
          case 0xe:
            *pfDampeningField = 1;
            break;
          case 0xf:
            pTVar3->wFlags = pTVar3->wFlags & 0xfffdU | 2;
          }
        }
        else if ((part.hs.grhst == hstSpecialM) && ((part.hs.wFlags & 0xffU) == 10)) {
          idPlayer = (short)pTVar3->iplr;
          FLookupPart(&part);
          idPlayer = -1;
          for (i = (uint)part.hs.wFlags >> 8; 0 < i; i = i + -1) {
            uVar13 = 0;
            uVar7 = 100;
            uVar2 = ((COMPART *)part.pcom + 1)->id;
            uVar10 = __aFulmul(uVar10,CONCAT22(-(uint)(100 < uVar2) - ((int)uVar2 >> 0xf),
                                                       100 - uVar2));
            uVar10 = __aFldiv(uVar10,CONCAT22(uVar13,uVar7));
          }
        }
      }
      if (pctJam < 100) {
        for (i = (uint)part.hs.wFlags >> 8; 0 < i; i = i + -1) {
          uVar11 = __aFulmul((ulong)puVar12,(long)pctJam);
          puVar12 = (undefined1 *)__aFldiv(uVar11,100);
        }
      }
      if (dxyPart != -1) {
        if (pTVar3->field2_0x3 == '\x01') {
          dxyPart = dxyPart + 1;
        }
        if ((dxyMax < 0) || (dxyPart < dxyMax)) {
          dxyMax = dxyPart;
        }
        if (dxyLim < dxyPart) {
          dxyLim = dxyPart;
        }
        pinit[init] = 1;
        if ((initMin == -1) || (init < initMin)) {
          initMin = init;
        }
        if (initMac < init) {
          initMac = init;
        }
      }
    }
    ihs = ihs + 1;
  }
  if (puVar12 == &DAT_0000_2710) {
    pTVar3->pctJam = 0;
  }
  else {
    lVar8 = __aFldiv((long)(puVar12 + 0x32),100);
    pTVar3->pctJam = 100 - (char)lVar8;
    if (0x5f < pTVar3->pctJam) {
      pTVar3->pctJam = 0x5f;
    }
  }
  if (pTVar3->field2_0x3 == '\x01') {
    pTVar3->pctJam = pTVar3->pctJam - pTVar3->pctJam / 4;
  }
  if (uVar9 != 1000) {
    if (0x9f6 < (long)uVar9) {
      uVar9 = 0x9f6;
    }
    lVar8 = __aFldiv(uVar9,10);
    pTVar3->pctCap = (byte)lVar8;
  }
  lVar8 = __aFldiv(uVar10,10);
  pTVar3->pctBeamDef = (byte)lVar8;
  pTVar3->wFlags = pTVar3->wFlags & 0xff0fU | (dxyMax & 0xfU) << 4;
  pTVar3->wFlags = pTVar3->wFlags & 0xfff0U | dxyLim & 0xfU;
  pTVar3->initMin = (byte)initMin;
  pTVar3->initMac = (byte)initMac;
  if (ldp._2_2_ == 0) {
    pTVar3->dpShield = (short)ldp;
  }
  else {
    pTVar3->dpShield = -1;
  }
  return;
}



// ======================================================================
// Function: RandomizeTokOrder
// Address: 10f0:44d4
// Segment: MEMORY_BATTLE
// ======================================================================


void RandomizeTokOrder(void)

{
  TOK *pTVar1;
  TOK *pTVar2;
  undefined2 uVar3;
  short sVar4;
  int iVar5;
  int iVar6;
  TOK *pTVar7;
  TOK *pTVar8;
  undefined2 unaff_SS;
  short itok;
  short itokSwap;
  TOK tok;
  
  for (itok = 0; itok < vctok; itok = itok + 1) {
    sVar4 = Random(vctok - itok);
    uVar3 = vrgtok._2_2_;
    iVar5 = sVar4 + itok;
    if (iVar5 != itok) {
      pTVar7 = (TOK *)vrgtok + iVar5;
      pTVar8 = &tok;
      for (iVar6 = 0xe; iVar6 != 0; iVar6 = iVar6 + -1) {
        pTVar2 = pTVar8;
        pTVar8 = (TOK *)&pTVar8->iplr;
        pTVar1 = pTVar7;
        pTVar7 = (TOK *)&pTVar7->iplr;
        pTVar2->id = pTVar1->id;
      }
      *(char *)&pTVar8->id = (char)pTVar7->id;
      pTVar8 = (TOK *)vrgtok + itok;
      pTVar7 = (TOK *)vrgtok + iVar5;
      for (iVar5 = 0xe; iVar5 != 0; iVar5 = iVar5 + -1) {
        pTVar2 = pTVar7;
        pTVar7 = (TOK *)&pTVar7->iplr;
        pTVar1 = pTVar8;
        pTVar8 = (TOK *)&pTVar8->iplr;
        pTVar2->id = pTVar1->id;
      }
      *(char *)&pTVar7->id = (char)pTVar8->id;
      uVar3 = vrgtok._2_2_;
      pTVar7 = (TOK *)vrgtok + itok;
      pTVar8 = &tok;
      for (iVar5 = 0xe; iVar5 != 0; iVar5 = iVar5 + -1) {
        pTVar2 = pTVar7;
        pTVar7 = (TOK *)&pTVar7->iplr;
        pTVar1 = pTVar8;
        pTVar8 = (TOK *)&pTVar8->iplr;
        pTVar2->id = pTVar1->id;
      }
      *(char *)&pTVar7->id = (char)pTVar8->id;
    }
  }
  return;
}



// ======================================================================
// Function: InitializeBoard
// Address: 10f0:45b4
// Segment: MEMORY_BATTLE
// ======================================================================


void InitializeBoard
          (FLEET *lpfl,short ibrc,ushort grfPlayer,byte *pinit,short *pinitMin,short *pinitMac)

{
  TOK *pTVar1;
  byte *pbVar2;
  PLANET *pPVar3;
  short sVar4;
  int iVar5;
  uint uVar6;
  FLEET *pFVar7;
  TOK *pTVar8;
  byte *pbVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  byte rgfTorp [16];
  short ishdef;
  short fDumpCargo;
  byte mpiplrdibrc [16];
  TOK *ptokT;
  ushort *lpwtCargoCur;
  short initMin;
  short fDampeningField;
  PLANET *lppl;
  short initMac;
  TOK *ptok;
  FLEET *lpflCur;
  short iplr;
  
  initMin = -1;
  initMac = -1;
  fDampeningField = 0;
  ishdef = 0;
  _memset(mpiplrdibrc,0xff,0x10);
  for (iplr = 0; iplr < game.cPlayer; iplr = iplr + 1) {
    if ((1 << ((byte)iplr & 0x1f) & grfPlayer) != 0) {
      mpiplrdibrc[iplr] = (byte)ishdef;
      ishdef = ishdef + 1;
    }
  }
  _memset(rgfTorp,0,0x10);
  lpflCur = lpfl;
  ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
  if (((FLEET *)lpfl)->idPlanet != -1) {
    lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
    uVar10 = (undefined2)((ulong)lppl >> 0x10);
    pPVar3 = (PLANET *)lppl;
    iplr = pPVar3->iPlayer;
    if (((iplr != -1) && (((uint)pPVar3->wFlags >> 9 & 1) != 0)) &&
       ((1 << ((byte)iplr & 0x1f) & grfPlayer) != 0)) {
      uVar11 = (undefined2)((ulong)ptok >> 0x10);
      pTVar8 = (TOK *)ptok;
      pTVar8->field2_0x3 = 1;
      pPVar3->wFlags = pPVar3->wFlags & 0xbfffU | 0x4000;
      pTVar8->brc = *(byte *)((uint)mpiplrdibrc[iplr] + ibrc);
      ptok->id = lppl->id;
      pTVar8->iplr = (byte)iplr;
      pTVar8->csh = 1;
      pTVar8->ishdef = ((byte)*(undefined2 *)&pPVar3->field11_0x2c & 0xf) + 0x10;
      CheckInitiative(ptok);
      CheckWeapons(ptok,&fDampeningField,pinit);
      rgfTorp[iplr] = rgfTorp[iplr] | (byte)((uint)((TOK *)ptok)->wFlags >> 2) & 1;
      uVar10 = (undefined2)((ulong)ptok >> 0x10);
      pTVar8 = (TOK *)ptok;
      if (pTVar8->initBase == 0xff) {
        pTVar8->wFlags = pTVar8->wFlags & 0xfffU | 0x5000;
      }
      else {
        pTVar8->wFlags = pTVar8->wFlags & 0xfffU | 0x3000;
      }
      pTVar8->wFlags = pTVar8->wFlags & 0xfff0U | 1;
      pTVar8->wFlags = pTVar8->wFlags & 0xff0fU | 0x10;
      (&pTVar8->dv)->dp =
           (&pTVar8->dv)->dp & 0x7fU | (*(uint *)&((PLANET *)lppl)->field11_0x2c >> 4) << 7;
      pTVar8->wFlags = pTVar8->wFlags & 0xf0ffU | 0x500;
      if ((uint)(&pTVar8->dv)->dp >> 7 != 0) {
        (&pTVar8->dv)->dp = (&pTVar8->dv)->dp & 0xff80U | 100;
      }
      pTVar8->wFlags = pTVar8->wFlags & 0xf0ff;
      pTVar8->wt = -1;
      ptok = (TOK *)CONCAT22(uVar10,pTVar8 + 1);
    }
  }
  do {
    uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
    pFVar7 = (FLEET *)lpflCur;
    if (((uint)pFVar7->wFlags >> 10 & 1) == 0) {
      if (((uint)pFVar7->wFlags >> 7 & 1) == 0) {
        if (((uint)pFVar7->wFlags >> 8 & 1) != 0) {
          pFVar7->wFlags = pFVar7->wFlags & 0xbfffU | 0x4000;
          iplr = pFVar7->iPlayer;
          sVar4 = FDumpCargo(lpflCur);
          for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
            if (((FLEET *)lpflCur)->rgcsh[ishdef] != 0) {
              uVar10 = (undefined2)((ulong)ptok >> 0x10);
              pTVar8 = (TOK *)ptok;
              pTVar8->field2_0x3 = 2;
              pTVar8->brc = *(byte *)((uint)mpiplrdibrc[iplr] + ibrc);
              ptok->id = lpflCur->id;
              pTVar8->iplr = (byte)((uint)lpflCur->id >> 9) & 0xf;
              pTVar8->ishdef = (byte)ishdef;
              pTVar8->csh = ((FLEET *)lpflCur)->rgcsh[ishdef];
              (&pTVar8->dv)->dp = (((FLEET *)lpflCur)->rgdv + ishdef)->dp;
              CheckInitiative(ptok);
              CheckWeapons(ptok,&fDampeningField,pinit);
              rgfTorp[iplr] = rgfTorp[iplr] | (byte)((uint)((TOK *)ptok)->wFlags >> 2) & 1;
              CheckTarget(ptok,lpflCur,ishdef);
              uVar6 = SpdOfShip(lpflCur,ishdef,ptok,sVar4,(SHDEF *)0x0);
              uVar10 = (undefined2)((ulong)ptok >> 0x10);
              pTVar8 = (TOK *)ptok;
              pTVar8->wFlags = pTVar8->wFlags & 0xf0ffU | (uVar6 & 0xf) << 8;
              ptok = (TOK *)CONCAT22(uVar10,pTVar8 + 1);
              if (0xff < ((int)(pTVar8 + 1) - (int)(TOK *)vrgtok) / 0x1d)
              goto BATTLE_LTooManyTokens;
            }
          }
        }
      }
      else {
        grfMissed = grfMissed | 1 << ((byte)pFVar7->iPlayer & 0x1f);
      }
    }
    uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
                    /* WARNING: Load size is inaccurate */
    lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                ((FLEET *)lpflCur)->lpflNext);
  } while (lpfl != lpflCur);
BATTLE_LTooManyTokens:
  vctok = ((int)(TOK *)ptok - (int)(TOK *)vrgtok) / 0x1d;
  RandomizeTokOrder();
  ptokT = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
  while( true ) {
    if ((TOK *)ptok <= (TOK *)ptokT) break;
    uVar10 = (undefined2)((ulong)ptokT >> 0x10);
    ((TOK *)ptokT)->wFlags = ((TOK *)ptokT)->wFlags & 0xffefU | 0x10;
    ((TOK *)ptokT)->wFlags = ((TOK *)ptokT)->wFlags & 0xfffeU | 1;
    if (((TOK *)ptokT)->initMin == 0xff) {
      ((TOK *)ptokT)->wFlags = ((TOK *)ptokT)->wFlags & 0xfff0;
    }
    if ((((TOK *)ptokT)->dpShield == 0) ||
       (sVar4 = GetRaceGrbit((PLAYER *)rgplr + ((TOK *)ptokT)->iplr,
                                   ibitRaceRegeneratingShields), sVar4 == 0)) {
      iVar5 = 0;
    }
    else {
      iVar5 = 1;
    }
    ((TOK *)ptokT)->wFlags = ((TOK *)ptokT)->wFlags & 0xfff7U | iVar5 << 3;
    if ((fDampeningField != 0) && (((TOK *)ptokT)->field2_0x3 != '\x01')) {
      if ((int)(((uint)((TOK *)ptokT)->wFlags >> 8 & 0xf) - 4) < 1) {
        uVar6 = 0;
      }
      else {
        uVar6 = ((uint)((TOK *)ptokT)->wFlags >> 8 & 0xf) - 4;
      }
      ((TOK *)ptokT)->wFlags = ((TOK *)ptokT)->wFlags & 0xf0ffU | (uVar6 & 0xf) << 8;
    }
    uVar11 = (undefined2)((ulong)lpbBattleCur >> 0x10);
    pbVar9 = (byte *)lpbBattleCur;
    pTVar8 = (TOK *)ptokT;
    for (iVar5 = 0xe; iVar5 != 0; iVar5 = iVar5 + -1) {
      pbVar2 = pbVar9;
      pbVar9 = pbVar9 + 2;
      pTVar1 = pTVar8;
      pTVar8 = (TOK *)&pTVar8->iplr;
      *(short *)pbVar2 = pTVar1->id;
    }
    *pbVar9 = (byte)pTVar8->id;
    lpbBattleCur =
         (byte *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur + 0x1d);
    if ((((TOK *)ptokT)->initMin != 0xff) &&
       ((initMin == -1 || ((int)(uint)((TOK *)ptokT)->initMin < initMin)))) {
      initMin = (short)((TOK *)ptokT)->initMin;
    }
    if ((((TOK *)ptokT)->initMac != 0xff) &&
       ((initMac == -1 || (initMac < (int)(uint)((TOK *)ptokT)->initMac)))) {
      initMac = (short)((TOK *)ptokT)->initMac;
    }
    ptokT = (TOK *)CONCAT22(uVar10,(TOK *)ptokT + 1);
  }
  *pinitMin = initMin & 0xff;
  *pinitMac = initMac & 0xff;
  return;
}



// ======================================================================
// Function: DzFromBrcBrc
// Address: 10f0:4ca8
// Segment: MEMORY_BATTLE
// ======================================================================


short DzFromBrcBrc(byte brc1,byte brc2)

{
  short sVar1;
  short sVar2;
  short dx;
  short dy;
  
  sVar1 = _abs((brc1 & 0xf) - (brc2 & 0xf));
  sVar2 = _abs(((int)(uint)brc1 >> 4) - ((int)(uint)brc2 >> 4));
  if (sVar1 <= sVar2) {
    sVar1 = sVar2;
  }
  return sVar1;
}



// ======================================================================
// Function: DpFromPtokBrcToBrc
// Address: 10f0:4d2e
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f04fe7) */
/* WARNING: Removing unreachable block (ram,0x10f0522e) */
/* WARNING: Removing unreachable block (ram,0x10f052e6) */

long DpFromPtokBrcToBrc(TOK *ptok,byte brcSrc,byte brcTarget,TOK *ptokTarget,short fProximity)

{
  ulong uVar1;
  bool bVar2;
  uint uVar3;
  uint uVar4;
  uint uVar5;
  int iVar6;
  SHDEF *pSVar7;
  HS *pHVar8;
  undefined2 uVar9;
  SHDEF *pSVar10;
  long lVar11;
  ulong uVar12;
  ulong uVar13;
  ulong uVar14;
  long lVar15;
  ulong uVar16;
  long lVar17;
  long dpShieldsLeft;
  PART part;
  long dp;
  long cTorpHit;
  HUL *lphul;
  long dRange;
  short fOutOfRange;
  long dpTotal;
  long cTorpBase;
  short ihs;
  long dpShdef;
  long dpMax;
  short dz;
  
  uVar3 = DzFromBrcBrc(brcSrc,brcTarget);
  uVar1 = 0;
  if ((fProximity == 0) && ((int)(((TOK *)ptok)->wFlags & 0xfU) < (int)uVar3)) {
    uVar14 = 0;
  }
  else {
    pSVar10 = LpshdefFromTok(ptok);
    ihs = 0;
    while( true ) {
      uVar9 = (undefined2)((ulong)pSVar10 >> 0x10);
      pSVar7 = (SHDEF *)pSVar10;
      if ((int)(uint)(pSVar7->hul).chs <= ihs) break;
      if (((((pSVar7->hul).rghs + ihs)->grhst & (hstTorp|hstBeam)) !=
           ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
             hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
         ((uint)(pSVar7->hul).rghs[ihs].wFlags >> 8 != 0)) {
        pHVar8 = (pSVar7->hul).rghs + ihs;
        part.hs.grhst = pHVar8->grhst;
        part.hs.wFlags = pHVar8->wFlags;
        idPlayer = (short)((TOK *)ptok)->iplr;
        FLookupPart(&part);
        idPlayer = -1;
        uVar9 = (undefined2)((ulong)part.pcom >> 0x10);
        uVar4 = (uint)(((TOK *)ptok)->field2_0x3 == '\x01') + ((COMPART *)part.pcom + 1)->id;
        iVar6 = (int)uVar4 >> 0xf;
        if (((int)uVar3 >> 0xf < iVar6) || (((int)uVar3 >> 0xf <= iVar6 && (uVar3 <= uVar4)))) {
          bVar2 = false;
        }
        else {
          bVar2 = true;
        }
        if ((!bVar2) || (fProximity != 0)) {
          uVar13 = __aFulmul((long)*(int *)((COMPART *)part.pcom)[1].rgTech,
                                     (ulong)((uint)part.hs.wFlags >> 8));
          if (part.hs.grhst == hstBeam) {
            if (((TOK *)ptok)->pctCap != 0) {
              lVar11 = 100;
              uVar13 = __aFulmul(uVar13,(ulong)((TOK *)ptok)->pctCap);
              uVar13 = __aFldiv(uVar13,lVar11);
            }
            if (((0 < (int)uVar3) && (-1 < iVar6)) && ((0 < iVar6 || (uVar4 != 0)))) {
              lVar15 = (long)(int)uVar4;
              lVar11 = 10;
              uVar14 = __aFulmul(uVar13,(long)(int)uVar3);
              lVar11 = __aFldiv(uVar14,lVar11);
              lVar11 = __aFldiv(lVar11,lVar15);
              uVar13 = uVar13 - lVar11;
            }
            if (((TOK *)ptokTarget)->pctBeamDef < 100) {
              lVar11 = 100;
              uVar13 = __aFulmul(uVar13,(ulong)((TOK *)ptokTarget)->pctBeamDef);
              uVar13 = __aFldiv(uVar13,lVar11);
            }
            if (((*(uint *)(((COMPART *)part.pcom)[1].rgTech + 4) & 1) != 0) &&
               (uVar14 = __aFulmul((ulong)(uint)((TOK *)ptokTarget)->dpShield,
                                           (ulong)(uint)((TOK *)ptok)->csh),
               (long)uVar14 < (long)uVar13)) {
              uVar13 = uVar14;
            }
            if (bVar2) {
              uVar5 = uVar3 + 10;
              uVar13 = __aFldiv(uVar13,CONCAT22((((int)uVar5 >> 0xf) - iVar6) -
                                                        (uint)(uVar5 < uVar4),uVar5 - uVar4));
              if (((long)uVar13 < 0x10000) &&
                 (((long)uVar13 < 0 || ((uint)uVar13 < (uint)part.hs.wFlags >> 8)))) {
                uVar13 = (ulong)((uint)part.hs.wFlags >> 8);
              }
            }
            uVar13 = __aFulmul(uVar13,(ulong)(uint)((TOK *)ptok)->csh);
            uVar1 = uVar13 + uVar1;
          }
          else if (part.hs.grhst == hstTorp) {
            uVar14 = 200;
            uVar13 = __aFulmul((ulong)((uint)part.hs.wFlags >> 8),
                                       (ulong)(uint)((TOK *)ptok)->csh);
            uVar14 = __aFulmul(uVar13,uVar14);
            uVar12 = CTorpHit(uVar14,ptokTarget,*(short *)(((COMPART *)part.pcom)[1].rgTech + 4),
                              (uint)((TOK *)ptok)->pctBC);
            lVar11 = 200;
            uVar13 = __aFulmul((long)*(int *)((COMPART *)part.pcom)[1].rgTech,uVar12);
            uVar13 = __aFldiv(uVar13,lVar11);
            if (((TOK *)ptokTarget)->dpShield != 0) {
              lVar11 = 0x640;
              uVar14 = __aFulmul(uVar14 - uVar12,
                                         (long)*(int *)((COMPART *)part.pcom)[1].rgTech);
              lVar11 = __aFldiv(uVar14,lVar11);
              uVar13 = lVar11 + uVar13;
            }
            if (bVar2) {
              uVar5 = uVar3 + 10;
              uVar13 = __aFldiv(uVar13,CONCAT22((((int)uVar5 >> 0xf) - iVar6) -
                                                        (uint)(uVar5 < uVar4),uVar5 - uVar4));
              if (((long)uVar13 < 0x10000) &&
                 (((long)uVar13 < 0 || ((uint)uVar13 < (uint)part.hs.wFlags >> 8)))) {
                uVar13 = (ulong)((uint)part.hs.wFlags >> 8);
              }
            }
            uVar1 = uVar1 + uVar13;
          }
        }
      }
      ihs = ihs + 1;
    }
    pSVar10 = LpshdefFromTok(ptokTarget);
    uVar3 = (((SHDEF *)pSVar10)->hul).dp;
    uVar13 = __aFulmul((ulong)CONCAT12(CARRY2(((TOK *)ptokTarget)->dpShield,uVar3),
                                               ((TOK *)ptokTarget)->dpShield + uVar3),
                               (ulong)(uint)((TOK *)ptokTarget)->csh);
    iVar6 = (int)uVar13;
    if (((&((TOK *)ptokTarget)->dv)->dp != 0) && (0 < (long)uVar13)) {
      lVar17 = 500;
      uVar16 = (ulong)(uint)((TOK *)ptokTarget)->csh;
      lVar15 = 10;
      uVar12 = (ulong)(uint)(&((TOK *)ptokTarget)->dv)->dp & 0xffff007f;
      lVar11 = 10;
      uVar14 = __aFulmul((ulong)uVar3,(ulong)((uint)(&((TOK *)ptokTarget)->dv)->dp >> 7));
      uVar14 = __aFldiv(uVar14,lVar11);
      uVar14 = __aFulmul(uVar14,uVar12);
      uVar14 = __aFldiv(uVar14,lVar15);
      uVar14 = __aFulmul(uVar14,uVar16);
      lVar15 = __aFldiv(uVar14,lVar17);
      lVar11 = uVar13 - lVar15;
      uVar14 = uVar13 - lVar15;
      uVar13 = uVar13 - lVar15;
      if (((int)((ulong)lVar11 >> 0x10) < 1) &&
         ((lVar11 < 0 || (uVar13 = uVar14, iVar6 == (int)lVar15)))) {
        uVar13 = 1;
      }
    }
    uVar14 = uVar1;
    if (((long)uVar13 < (long)uVar1) && (uVar14 = uVar13, fProximity != 0)) {
      uVar14 = uVar1;
    }
  }
  return uVar14;
}



// ======================================================================
// Function: DzMoveRangeToConsider
// Address: 10f0:5312
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f056af) */

short DzMoveRangeToConsider(TOK *ptok,ushort grfAttack,byte *pbrc)

{
  byte brc1;
  byte bVar1;
  short sVar2;
  uint uVar3;
  TOK *pTVar4;
  SHDEF *pSVar5;
  HS *pHVar6;
  COMPART *pCVar7;
  TOK *pTVar8;
  undefined2 uVar9;
  undefined2 uVar10;
  SHDEF *pSVar11;
  long lVar12;
  PART part;
  HUL *lphul;
  SHDEF *lpshdef;
  short ihs;
  byte brcCur;
  short dzMax;
  TOK *ptokTarget;
  short iplrTarget;
  short itokLook;
  byte dzBest;
  ushort mdTarget;
  short iplr;
  byte dz;
  short dzNonSapper;
  
  uVar9 = (undefined2)((ulong)ptok >> 0x10);
  pTVar4 = (TOK *)ptok;
  brc1 = pTVar4->brc;
  dzMax = (pTVar4->wFlags & 0xfU) + ((uint)pTVar4->wFlags >> 0xe);
  sVar2 = FDoesPrimaryTargetTypeExist(ptok,grfAttack);
  if (sVar2 == 0) {
    uVar3 = (uint)pTVar4->wFlags >> 4;
  }
  else {
    uVar3 = pTVar4->wFlags;
  }
  bVar1 = pTVar4->iplr;
  dzBest = 10;
  *pbrc = 0xff;
  if ((pTVar4->wFlags & 0xfU) == 3) {
    dzNonSapper = -1;
    pSVar11 = LpshdefFromTok(ptok);
    ihs = 0;
    while( true ) {
      uVar10 = (undefined2)((ulong)pSVar11 >> 0x10);
      pSVar5 = (SHDEF *)pSVar11;
      if ((int)(uint)(pSVar5->hul).chs <= ihs) break;
      if ((((pSVar5->hul).rghs + ihs)->grhst == hstBeam) &&
         ((uint)(pSVar5->hul).rghs[ihs].wFlags >> 8 != 0)) {
        pHVar6 = (pSVar5->hul).rghs + ihs;
        part.hs.grhst = pHVar6->grhst;
        part.hs.wFlags = pHVar6->wFlags;
        idPlayer = (short)pTVar4->iplr;
        FLookupPart(&part);
        idPlayer = -1;
        uVar10 = (undefined2)((ulong)part.pcom >> 0x10);
        pCVar7 = (COMPART *)part.pcom;
        if (((*(uint *)(pCVar7[1].rgTech + 4) & 1) == 0) && (dzNonSapper < (pCVar7 + 1)->id)) {
          dzNonSapper = (pCVar7 + 1)->id;
        }
      }
      ihs = ihs + 1;
    }
  }
  else {
    dzNonSapper = pTVar4->wFlags & 0xf;
  }
  if ((((uint)pTVar4->wFlags >> 4 & 0xf) < (pTVar4->wFlags & 0xfU)) &&
     ((((uint)pTVar4->wFlags >> 8 & 0xf) == 5 || (((uint)pTVar4->wFlags >> 8 & 0xf) == 3)))) {
    dzMax = ((uint)pTVar4->wFlags >> 4 & 0xf) + ((uint)pTVar4->wFlags >> 0xe);
  }
  ptokTarget = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
  itokLook = 0;
  do {
    if (vctok <= itokLook) {
      return 1;
    }
    uVar10 = (undefined2)((ulong)ptokTarget >> 0x10);
    pTVar8 = (TOK *)ptokTarget;
    if ((((pTVar8->iplr != bVar1) && ((1 << (pTVar8->iplr & 0x1f) & grfAttack) != 0)) &&
        ((pTVar8->wFlags & 1U) != 0)) &&
       (sVar2 = FIsTargetOfMdTarget(ptokTarget,uVar3 & 0xf), sVar2 != 0)) {
      sVar2 = DzFromBrcBrc(brc1,pTVar8->brc);
      dz = (byte)sVar2;
      if ((uint)pTVar4->wFlags >> 0xe <= (uint)pTVar8->wFlags >> 0xe) {
        dz = dz + 1;
      }
      if (((uint)dz <= (uint)dzMax) &&
         (((pTVar8->dpShield != 0 || (dzNonSapper == (pTVar4->wFlags & 0xfU))) ||
          ((uint)dz <= dzNonSapper + ((uint)pTVar4->wFlags >> 0xe))))) {
        *pbrc = 0xff;
        return (uint)pTVar4->wFlags >> 0xe;
      }
      if ((dz < dzBest) && (lVar12 = DpFromPtokBrcToBrc(ptok,0,0,ptokTarget,0), 0 < lVar12)) {
        dzBest = dz;
        *pbrc = pTVar8->brc;
      }
    }
    itokLook = itokLook + 1;
    ptokTarget = (TOK *)CONCAT22(uVar10,pTVar8 + 1);
  } while( true );
}



// ======================================================================
// Function: FDoesPrimaryTargetTypeExist
// Address: 10f0:56d8
// Segment: MEMORY_BATTLE
// ======================================================================


short FDoesPrimaryTargetTypeExist(TOK *ptok,ushort grfAttack)

{
  TOK *pTVar1;
  TOK *pTVar2;
  byte bVar3;
  uint uVar4;
  int iVar5;
  TOK *pTVar6;
  TOK *pTVar7;
  undefined2 uVar8;
  undefined2 unaff_SS;
  short itokLook;
  TOK tok;
  short iplrLook;
  short iplr;
  ushort mdTarget;
  
  uVar8 = (undefined2)((ulong)ptok >> 0x10);
  bVar3 = ((TOK *)ptok)->iplr;
  uVar4 = ((TOK *)ptok)->wFlags & 0xf;
  if (uVar4 != 0) {
    for (itokLook = 0; itokLook < vctok; itokLook = itokLook + 1) {
      if ((((TOK *)vrgtok)[itokLook].iplr != bVar3) &&
         ((1 << (((TOK *)vrgtok)[itokLook].iplr & 0x1f) & grfAttack) != 0)) {
        pTVar6 = (TOK *)vrgtok + itokLook;
        pTVar7 = &tok;
        for (iVar5 = 0xe; iVar5 != 0; iVar5 = iVar5 + -1) {
          pTVar2 = pTVar7;
          pTVar7 = (TOK *)&pTVar7->iplr;
          pTVar1 = pTVar6;
          pTVar6 = (TOK *)&pTVar6->iplr;
          pTVar2->id = pTVar1->id;
        }
        *(char *)&pTVar7->id = (char)pTVar6->id;
        if ((tok.wFlags & 1U) != 0) {
          switch(uVar4) {
          case 1:
            goto LAB_10f0_5873;
          case 2:
            if (tok.field2_0x3 == '\x01') {
              return 1;
            }
            break;
          case 3:
          case 4:
          case 5:
          case 6:
          case 7:
            if (uVar4 == 3) {
LAB_10f0_5790:
              if ((uint)tok.wFlags >> 0xc == uVar4) {
LAB_10f0_5873:
                return 1;
              }
            }
            else if (uVar4 == 4) {
              if ((uint)tok.wFlags >> 0xc == 4) {
                return 1;
              }
              if ((uint)tok.wFlags >> 0xc == 7) {
                return 1;
              }
            }
            else {
              if (uVar4 != 5) {
                if ((uVar4 != 6) && (uVar4 != 7)) {
                  return 1;
                }
                goto LAB_10f0_5790;
              }
              if (4 < (uint)tok.wFlags >> 0xc) {
                return 1;
              }
            }
          }
        }
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: FIsTargetOfMdTarget
// Address: 10f0:587a
// Segment: MEMORY_BATTLE
// ======================================================================


short FIsTargetOfMdTarget(TOK *ptok,short mdTarget)

{
  uint uVar1;
  TOK *pTVar2;
  undefined2 uVar3;
  
  pTVar2 = (TOK *)ptok;
  uVar3 = (undefined2)((ulong)ptok >> 0x10);
  switch(mdTarget) {
  default:
    uVar1 = 0;
    break;
  case 1:
    uVar1 = 1;
    break;
  case 2:
    uVar1 = (uint)(pTVar2->field2_0x3 == '\x01');
    break;
  case 3:
  case 6:
  case 7:
    uVar1 = (uint)((uint)pTVar2->wFlags >> 0xc == mdTarget);
    break;
  case 4:
    if (((uint)pTVar2->wFlags >> 0xc == 4) || ((uint)pTVar2->wFlags >> 0xc == 7)) {
      uVar1 = 1;
    }
    else {
      uVar1 = 0;
    }
    break;
  case 5:
    if ((((uint)pTVar2->wFlags >> 0xc == 5) || ((uint)pTVar2->wFlags >> 0xc == 7)) ||
       ((uint)pTVar2->wFlags >> 0xc == 6)) {
      uVar1 = 1;
    }
    else {
      uVar1 = 0;
    }
  }
  return uVar1;
}



// ======================================================================
// Function: ScoreGuessBattleDamage
// Address: 10f0:598c
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f05d83) */
/* WARNING: Removing unreachable block (ram,0x10f05dd7) */

long ScoreGuessBattleDamage(TOK *ptokSrc,byte brc,short fPrimary,ushort grfAttack)

{
  byte bVar1;
  long lVar2;
  long lVar3;
  long dpGive;
  long dpTake;
  byte bVar4;
  int iVar5;
  uint uVar6;
  int iVar7;
  uint uVar8;
  short sVar9;
  TOK *pTVar10;
  TOK *pTVar11;
  undefined2 uVar12;
  undefined2 uVar13;
  long dpTake_00;
  long dpGive_00;
  long lVar14;
  long lVar15;
  short itok;
  short dMin;
  short x;
  short xCur;
  short fWeAttack;
  byte iplrSrc;
  long scoreUs;
  short dMax;
  long dpGiven;
  byte brcEnemy;
  short rgx [2];
  short dzCur;
  long scoreThem;
  long scoreThemBest;
  long dpTaken;
  short yCur;
  short xEnemy;
  short i;
  long dpGivenCur;
  long dpTakenTotal;
  short y;
  long dpTakenBest;
  long dpGivenBest;
  short dzEnemy;
  short yEnemy;
  TOK *ptok;
  short rgy [2];
  short dMoves;
  short iBest;
  
  lVar15 = CONCAT22(dpTakenBest._2_2_,(undefined2)dpTakenBest);
  lVar2 = CONCAT22(dpGivenCur._2_2_,(undefined2)dpGivenCur);
  uVar12 = (undefined2)((ulong)ptokSrc >> 0x10);
  pTVar10 = (TOK *)ptokSrc;
  bVar1 = pTVar10->iplr;
  dpGive = 0;
  dpTake = 0;
  ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
  for (itok = 0; itok < vctok; itok = itok + 1) {
    uVar13 = (undefined2)((ulong)ptok >> 0x10);
    pTVar11 = (TOK *)ptok;
    if ((((pTVar11->wFlags & 1U) != 0) && (bVar1 != pTVar11->iplr)) &&
       ((1 << (pTVar11->iplr & 0x1f) & grfAttack) != 0)) {
      dMin = DzFromBrcBrc(pTVar11->brc,brc);
      uVar8 = (uint)((uint)pTVar10->wFlags >> 0xe <= (uint)pTVar11->wFlags >> 0xe);
      dMax = dMin;
      if (uVar8 != 0) {
        if (dMin - uVar8 < 0x8000) {
          iVar5 = dMin - uVar8;
        }
        else {
          iVar5 = 0;
        }
        uVar6 = pTVar11->brc & 0xf;
        iVar7 = (int)(uint)pTVar11->brc >> 4;
        rgx[0] = uVar6 - uVar8;
        rgx[1] = uVar6 + uVar8;
        rgy[0] = iVar7 - uVar8;
        rgy[1] = iVar7 + uVar8;
        for (x = 0; dMin = iVar5, x < 2; x = x + 1) {
          for (y = 0; y < 2; y = y + 1) {
            if ((uint)rgx[x] < 0x8000) {
              iVar7 = rgx[x];
            }
            else {
              iVar7 = 0;
            }
            if (iVar7 < 10) {
              if ((uint)rgx[x] < 0x8000) {
                bVar4 = (byte)rgx[x];
              }
              else {
                bVar4 = 0;
              }
            }
            else {
              bVar4 = 9;
            }
            if ((uint)rgy[y] < 0x8000) {
              iVar7 = rgy[y];
            }
            else {
              iVar7 = 0;
            }
            if (iVar7 < 10) {
              if ((uint)rgy[y] < 0x8000) {
                uVar8 = rgy[y];
              }
              else {
                uVar8 = 0;
              }
            }
            else {
              uVar8 = 9;
            }
            sVar9 = DzFromBrcBrc(brc,(byte)((uVar8 & 0xf) << 4) | bVar4 & 0xf);
            if (sVar9 <= dMax) {
              sVar9 = dMax;
            }
            dMax = sVar9;
          }
        }
      }
      if (fPrimary == 0) {
        uVar8 = (uint)pTVar10->wFlags >> 4;
      }
      else {
        uVar8 = pTVar10->wFlags;
      }
      sVar9 = FIsTargetOfMdTarget(ptok,uVar8 & 0xf);
      lVar3 = 30000000;
      for (i = dMin; i <= dMax; i = i + 1) {
        if (sVar9 == 0) {
          dpTake_00 = 0;
        }
        else {
          dpTake_00 = DpFromPtokBrcToBrc(ptokSrc,0,(byte)((i & 0xfU) << 4),ptok,0);
        }
        dpGive_00 = DpFromPtokBrcToBrc(ptok,0,(byte)((i & 0xfU) << 4),ptokSrc,
                                       (uint)(((uint)pTVar10->wFlags >> 8 & 0xf) == 0));
        lVar14 = ScoreFromGiveAndTakeAndTactic(dpGive_00,dpTake_00,(uint)pTVar11->wFlags >> 8 & 0xf)
        ;
        if (lVar14 <= lVar3) {
          lVar15 = dpGive_00;
          lVar2 = dpTake_00;
          lVar3 = lVar14;
        }
      }
      if (dpGive < lVar2) {
        dpGive = lVar2;
      }
      dpTake = lVar15 + dpTake;
    }
    ptok = (TOK *)CONCAT22(uVar13,pTVar11 + 1);
  }
  lVar15 = ScoreFromGiveAndTakeAndTactic(dpGive,dpTake,(uint)pTVar10->wFlags >> 8 & 0xf);
  return lVar15;
}



// ======================================================================
// Function: ScoreFromGiveAndTakeAndTactic
// Address: 10f0:5e34
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f05ecc) */

long ScoreFromGiveAndTakeAndTactic(long dpGive,long dpTake,short mdTactic)

{
  int iVar1;
  ulong uVar2;
  long lVar3;
  long score;
  
  switch(mdTactic) {
  case 0:
  case 2:
    break;
  case 1:
  case 5:
    dpTake = CONCAT22(-(dpGive._2_2_ + (uint)((int)dpGive != 0)),-(int)dpGive);
    break;
  case 3:
  case 4:
    iVar1 = -(dpGive._2_2_ + (uint)((int)dpGive != 0));
    if ((-(int)dpGive != 0) || (iVar1 != 0)) {
      lVar3 = dpTake + 1;
      uVar2 = __aFulmul(CONCAT22(iVar1,-(int)dpGive),100);
      dpTake = __aFldiv(uVar2,lVar3);
      if (-1 < dpTake) {
        dpTake = -1;
      }
    }
    break;
  default:
    dpTake = 0;
  }
  return dpTake;
}



// ======================================================================
// Function: DxyMoveTokTo
// Address: 10f0:5f18
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f061dc) */

short DxyMoveTokTo(TOK *ptok,short spdMove,ushort grfAttack)

{
  byte bVar1;
  uint uVar2;
  long lVar3;
  char cVar4;
  uint uVar5;
  int iVar6;
  short sVar7;
  short sVar8;
  int iVar9;
  byte brc_00;
  TOK *pTVar10;
  undefined2 *puVar11;
  undefined2 uVar12;
  bool bVar13;
  long lVar14;
  POINT rgptDeltas [2];
  short fXMajor;
  short x;
  short dzAway;
  long dp;
  short fPrimary;
  short xCur;
  short dx;
  short yMax;
  short dzAwayBest;
  byte brcBest;
  short yCur;
  short i;
  byte brcOOR;
  short y;
  short mdTactic;
  short dy;
  short yMin;
  short cBest;
  long score;
  long rgscoreNear [3] [3];
  byte brc;
  long scoreBest;
  short dz;
  short xMax;
  ushort iplr;
  
  uVar12 = (undefined2)((ulong)ptok >> 0x10);
  pTVar10 = (TOK *)ptok;
  bVar1 = pTVar10->iplr;
  uVar5 = pTVar10->brc & 0xf;
  iVar6 = (int)(uint)pTVar10->brc >> 4;
  if ((pTVar10->field2_0x3 == '\x01') || (spdMove == 0)) goto BATTLE_LReturnDxy;
  lVar3 = 30000000;
  mdTactic = (uint)pTVar10->wFlags >> 8 & 0xf;
  sVar7 = FDoesPrimaryTargetTypeExist(ptok,grfAttack);
  for (x = 0; x < 3; x = x + 1) {
    for (y = 0; y < 3; y = y + 1) {
      *(undefined2 *)(rgscoreNear[x] + y) = 0xc380;
      *(undefined2 *)((int)(rgscoreNear[x] + y) + 2) = 0x1c9;
    }
  }
  sVar8 = DzMoveRangeToConsider(ptok,grfAttack,&brcOOR);
  x = uVar5 - sVar8;
  if (x < 0) {
    x = 0;
  }
  yMin = iVar6 - sVar8;
  if (yMin < 0) {
    yMin = 0;
  }
  xMax = uVar5 + sVar8;
  if (9 < xMax) {
    xMax = 9;
  }
  yMax = iVar6 + sVar8;
  if (9 < yMax) {
    yMax = 9;
  }
  for (; x <= xMax; x = x + 1) {
    for (y = yMin; y <= yMax; y = y + 1) {
      brc_00 = (byte)((y & 0xfU) << 4) | (byte)x & 0xf;
      dy = iVar6 - y;
      _abs(uVar5 - x);
      dy = _abs(dy);
      lVar14 = ScoreGuessBattleDamage(ptok,brc_00,sVar7,grfAttack);
      if (mdTactic == 0) {
        i = 0;
        while( true ) {
          score._2_2_ = (int)((ulong)lVar14 >> 0x10);
          score._0_2_ = (int)lVar14;
          if (vctok <= i) break;
          if ((((TOK *)vrgtok)[i].brc == brc_00) &&
             (((TOK *)vrgtok)[i].iplr == bVar1)) {
            lVar14 = lVar14 + 2;
          }
          i = i + 1;
        }
        if (brc_00 == pTVar10->brc) {
          lVar14 = CONCAT22(score._2_2_ - (uint)((int)score == 0),(int)score + -1);
        }
      }
      score = lVar14;
      sVar8 = DzFromBrcBrc(pTVar10->brc,brc_00);
      if (sVar8 < 2) {
        puVar11 = (undefined2 *)((int)rgscoreNear + ((y - iVar6) + 1) * 4 + ((x - uVar5) + 1) * 0xc)
        ;
        *puVar11 = (int)score;
        puVar11[1] = score._2_2_;
      }
      if ((score < lVar3) || ((score == lVar3 && (sVar8 <= dzAwayBest)))) {
        if ((lVar3 == score) && (sVar8 == dzAwayBest)) {
          cBest = cBest + 1;
          sVar8 = Random(cBest);
          if (sVar8 != 0) goto LAB_10f0_6260;
        }
        else {
          cBest = 1;
          dzAwayBest = sVar8;
          lVar3 = score;
        }
        brcBest = brc_00;
      }
LAB_10f0_6260:
    }
  }
  if (brcOOR != 0xff) {
    brcBest = brcOOR;
  }
  sVar7 = DzFromBrcBrc(pTVar10->brc,brcBest);
  if (1 < sVar7) {
    iVar9 = (brcBest & 0xf) - uVar5;
    dy = ((int)(uint)brcBest >> 4) - iVar6;
    sVar7 = _abs(iVar9);
    sVar8 = _abs(dy);
    cVar4 = (char)uVar5;
    if (sVar7 == sVar8) {
      if (iVar9 < 1) {
        xCur._0_1_ = cVar4 - 1;
      }
      else {
        xCur._0_1_ = cVar4 + 1;
      }
      if (dy < 1) {
        yCur = iVar6 + -1;
      }
      else {
        yCur = iVar6 + 1;
      }
    }
    else if (iVar9 == 0) {
      rgptDeltas[1].y = -0x5d00;
      fXMajor = (short)&DAT_1120_11e1;
      rgptDeltas[1].x = 0;
      if (dy < 0) {
        dy = 0;
      }
      else {
        dy = 2;
      }
      yCur = iVar6 + dy + -1;
      for (i = 0; i < 3; i = i + 1) {
        uVar5 = *(uint *)((int)(rgscoreNear[i] + dy) + 2);
        if (((int)uVar5 <= fXMajor) &&
           (((int)uVar5 < fXMajor || (*(uint *)(rgscoreNear[i] + dy) <= (uint)rgptDeltas[1].y)))) {
          uVar5 = *(uint *)((int)(rgscoreNear[i] + dy) + 2);
          if ((fXMajor < (int)uVar5) ||
             ((fXMajor <= (int)uVar5 && ((uint)rgptDeltas[1].y <= *(uint *)(rgscoreNear[i] + dy)))))
          {
            rgptDeltas[1].x = rgptDeltas[1].x + 1;
          }
          else {
            fXMajor = *(short *)((int)(rgscoreNear[i] + dy) + 2);
            rgptDeltas[1].y = (short)rgscoreNear[i][dy];
            rgptDeltas[1].x = 1;
          }
        }
      }
      x = Random(rgptDeltas[1].x);
      i = 0;
      while ((i < 3 && ((((int)rgscoreNear[i][dy] != rgptDeltas[1].y ||
                         (*(int *)((int)(rgscoreNear[i] + dy) + 2) != fXMajor)) ||
                        (bVar13 = x != 0, x = x + -1, bVar13))))) {
        i = i + 1;
      }
      xCur._0_1_ = cVar4 + (char)i + -1;
    }
    else if (dy == 0) {
      rgptDeltas[1].y = -0x5d00;
      fXMajor = (short)&DAT_1120_11e1;
      rgptDeltas[1].x = 0;
      if (iVar9 < 0) {
        iVar9 = 0;
      }
      else {
        iVar9 = 2;
      }
      xCur._0_1_ = cVar4 + (char)iVar9 + -1;
      for (i = 0; i < 3; i = i + 1) {
        uVar5 = *(uint *)((int)(rgscoreNear[iVar9] + i) + 2);
        if (((int)uVar5 <= fXMajor) &&
           (((int)uVar5 < fXMajor || (*(uint *)(rgscoreNear[iVar9] + i) <= (uint)rgptDeltas[1].y))))
        {
          uVar5 = *(uint *)((int)(rgscoreNear[iVar9] + i) + 2);
          if ((fXMajor < (int)uVar5) ||
             ((fXMajor <= (int)uVar5 && ((uint)rgptDeltas[1].y <= *(uint *)(rgscoreNear[iVar9] + i))
              ))) {
            rgptDeltas[1].x = rgptDeltas[1].x + 1;
          }
          else {
            fXMajor = *(short *)((int)(rgscoreNear[iVar9] + i) + 2);
            rgptDeltas[1].y = (short)rgscoreNear[iVar9][i];
            rgptDeltas[1].x = 1;
          }
        }
      }
      x = Random(rgptDeltas[1].x);
      i = 0;
      while ((i < 3 && ((((int)rgscoreNear[iVar9][i] != rgptDeltas[1].y ||
                         (*(int *)((int)(rgscoreNear[iVar9] + i) + 2) != fXMajor)) ||
                        (bVar13 = x != 0, x = x + -1, bVar13))))) {
        i = i + 1;
      }
      yCur = iVar6 + i + -1;
    }
    else {
      sVar7 = _abs(iVar9);
      sVar8 = _abs(dy);
      if (iVar9 < 1) {
        rgptDeltas[0].x = 0;
      }
      else {
        rgptDeltas[0].x = 2;
      }
      if (dy < 1) {
        dy = 0;
      }
      else {
        dy = 2;
      }
      rgptDeltas[0].y = dy;
      if (sVar8 < sVar7) {
        rgptDeltas[1].x = rgptDeltas[0].x;
        rgptDeltas[1].y = 1;
      }
      else {
        rgptDeltas[1].x = 1;
        rgptDeltas[1].y = dy;
      }
      uVar5 = *(uint *)((int)(rgscoreNear[rgptDeltas[1].x] + rgptDeltas[1].y) + 2);
      uVar2 = *(uint *)((int)(rgscoreNear[rgptDeltas[0].x] + dy) + 2);
      if (((int)uVar2 < (int)uVar5) ||
         (((int)uVar2 <= (int)uVar5 &&
          (*(uint *)(rgscoreNear[rgptDeltas[0].x] + dy) <
           *(uint *)(rgscoreNear[rgptDeltas[1].x] + rgptDeltas[1].y))))) {
LAB_10f0_66d1:
        i = 0;
      }
      else {
        if (((int)rgscoreNear[rgptDeltas[0].x][dy] ==
             (int)rgscoreNear[rgptDeltas[1].x][rgptDeltas[1].y]) &&
           (*(int *)((int)(rgscoreNear[rgptDeltas[0].x] + dy) + 2) ==
            *(int *)((int)(rgscoreNear[rgptDeltas[1].x] + rgptDeltas[1].y) + 2))) {
          sVar7 = Random(2);
          if (sVar7 == 0) goto LAB_10f0_66d1;
        }
        i = 1;
      }
      xCur._0_1_ = cVar4 + (char)(rgptDeltas + i)->x + -1;
      yCur = iVar6 + rgptDeltas[i].y + -1;
    }
    brcBest = (byte)((yCur & 0xfU) << 4) | (byte)xCur & 0xf;
  }
  if (lVar3 != 30000000) {
    if ((9 < (brcBest & 0xf)) || (9 < (uint)((int)(uint)brcBest >> 4))) {
      brcBest = pTVar10->brc;
    }
    pTVar10->brc = brcBest;
  }
BATTLE_LReturnDxy:
  pTVar10->wFlags = pTVar10->wFlags & 0xffefU | 0x10;
  return 1;
}



// ======================================================================
// Function: CTorpHit
// Address: 10f0:6790
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f06913) */
/* WARNING: Removing unreachable block (ram,0x10f068d2) */
/* WARNING: Removing unreachable block (ram,0x10f068f3) */
/* WARNING: Removing unreachable block (ram,0x10f06994) */

long CTorpHit(long cTorpBase,TOK *ptok,short pctBase,short pctBC)

{
  short sVar1;
  bool bVar2;
  ulong uVar3;
  long lVar4;
  long cTorpHit;
  long pctHit;
  short i;
  long pctJam;
  
  if ((cTorpBase == 0) || (pctBase == 0)) {
    lVar4 = 0;
  }
  else {
    pctJam._0_2_ = (uint)((TOK *)ptok)->pctJam;
    pctJam._2_2_ = 0;
    if (((uint)pctJam != 0) && (pctBC != 0)) {
      bVar2 = (uint)pctJam < (uint)pctBC;
      pctJam._0_2_ = (uint)pctJam - pctBC;
      pctJam._2_2_ = -(uint)bVar2 - (pctBC >> 0xf);
      if ((pctJam._2_2_ < 1) && (pctJam._2_2_ < 0)) {
        pctBC = -(uint)pctJam;
        pctJam._0_2_ = 0;
        pctJam._2_2_ = 0;
      }
      else {
        pctBC = 0;
      }
    }
    if (pctBC == 0) {
      if (((uint)pctJam == 0) && (pctJam._2_2_ == 0)) {
        uVar3 = (ulong)pctBase;
      }
      else {
        lVar4 = 100;
        uVar3 = __aFulmul((long)pctBase,
                                  CONCAT22(-(uint)(100 < (uint)pctJam) - pctJam._2_2_,
                                           100 - (uint)pctJam));
        uVar3 = __aFldiv(uVar3,lVar4);
      }
    }
    else {
      lVar4 = 100;
      uVar3 = __aFulmul(CONCAT22(-(uint)(100 < (uint)pctBase) - (pctBase >> 0xf),
                                         100 - pctBase),(long)(100 - pctBC));
      lVar4 = __aFldiv(uVar3,lVar4);
      uVar3 = CONCAT22(-(uint)(100 < (uint)lVar4) - (int)((ulong)lVar4 >> 0x10),100 - (uint)lVar4);
    }
    if ((long)uVar3 < 1) {
      uVar3 = 1;
    }
    pctHit._0_2_ = (int)uVar3;
    lVar4 = cTorpBase;
    if ((long)uVar3 < 100) {
      if (cTorpBase < 0xc9) {
        cTorpHit._0_2_ = 0;
        cTorpHit._2_2_ = 0;
        for (i = 0; lVar4 = CONCAT22(cTorpHit._2_2_,(uint)cTorpHit), i < cTorpBase; i = i + 1) {
          sVar1 = Random(100);
          if (sVar1 < (int)pctHit) {
            bVar2 = 0xfffe < (uint)cTorpHit;
            cTorpHit._0_2_ = (uint)cTorpHit + 1;
            cTorpHit._2_2_ = cTorpHit._2_2_ + (uint)bVar2;
          }
        }
      }
      else {
        lVar4 = 100;
        uVar3 = __aFulmul(cTorpBase,uVar3);
        lVar4 = __aFldiv(uVar3,lVar4);
      }
    }
  }
  return lVar4;
}



// ======================================================================
// Function: FAttack
// Address: 10f0:69ac
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f0798c) */
/* WARNING: Removing unreachable block (ram,0x10f07315) */
/* WARNING: Removing unreachable block (ram,0x10f070f6) */
/* WARNING: Removing unreachable block (ram,0x10f07498) */
/* WARNING: Removing unreachable block (ram,0x10f072a4) */
/* WARNING: Removing unreachable block (ram,0x10f06f66) */
/* WARNING: Removing unreachable block (ram,0x10f0707c) */
/* WARNING: Removing unreachable block (ram,0x10f07265) */
/* WARNING: Removing unreachable block (ram,0x10f07463) */
/* WARNING: Removing unreachable block (ram,0x10f0781f) */
/* WARNING: Removing unreachable block (ram,0x10f07733) */
/* WARNING: Removing unreachable block (ram,0x10f079ee) */
/* WARNING: Removing unreachable block (ram,0x10f0751f) */
/* WARNING: Removing unreachable block (ram,0x10f074c6) */
/* WARNING: Removing unreachable block (ram,0x10f07183) */
/* WARNING: Removing unreachable block (ram,0x10f079c8) */
/* WARNING: Removing unreachable block (ram,0x10f07b2d) */
/* WARNING: Removing unreachable block (ram,0x10f0774a) */
/* WARNING: Removing unreachable block (ram,0x10f07b4d) */
/* WARNING: Removing unreachable block (ram,0x10f077de) */
/* WARNING: Removing unreachable block (ram,0x10f07b89) */
/* WARNING: Removing unreachable block (ram,0x10f07c92) */
/* WARNING: Removing unreachable block (ram,0x10f07ca9) */

short FAttack(short itokAttacker,short init,BTLREC *lpbtlrec,ushort grfAttack)

{
  uint uVar1;
  int iVar2;
  short sVar3;
  uint uVar4;
  int iVar5;
  int iVar6;
  HUL *pHVar7;
  BTLREC *pBVar8;
  TOK *pTVar9;
  COMPART *pCVar10;
  TOK *pTVar11;
  undefined2 unaff_SI;
  ushort unaff_DI;
  undefined2 uVar12;
  undefined2 uVar13;
  undefined2 uVar14;
  ulong uVar15;
  long lVar16;
  long lVar17;
  ulong uVar18;
  ulong uVar19;
  long lVar20;
  long lVar21;
  undefined2 uVar22;
  undefined2 uVar23;
  undefined2 uVar24;
  undefined2 uVar25;
  undefined2 uVar26;
  undefined1 uVar27;
  undefined1 uVar28;
  undefined1 uVar29;
  undefined1 uVar30;
  undefined2 in_stack_0000ff74;
  undefined2 in_stack_0000ff76;
  long ntk;
  long dpHitArmor;
  long dpShieldCur;
  PART part;
  TOK *ptokE;
  long dpCol;
  short itok;
  long dp;
  short fPrimary;
  long cTorpHit;
  HUL *lphul;
  long dpT;
  long lValue;
  SHDEF *lpshdef;
  TOK *ptokTarget;
  long pctHit;
  short cItem;
  ushort grfWeapon;
  long cTorpBase;
  short i;
  long cTorpsLeft;
  long cTorpFire;
  long cTorpMiss;
  short ihs;
  short dxRangeCur;
  short fSetItok;
  long score;
  long dpMain;
  short itokTarget;
  short ctokDamaged;
  TOK *ptok;
  long scoreBest;
  long dpSingle;
  long dpArmorLeft;
  SHDEF *lpshdefE;
  short dz;
  long dpShieldLeft;
  
  dxRangeCur = 0;
  fSetItok = 0;
  ctokDamaged = 0;
  ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok + itokAttacker);
  lphul = &LpshdefFromTok((TOK *)CONCAT13((char)((uint)vrgtok._2_2_ >> 8),
                                          CONCAT12((char)vrgtok._2_2_,
                                                   (TOK *)vrgtok + itokAttacker)))->hul;
  lVar17 = CONCAT22(score._2_2_,(undefined2)score);
  lVar16 = CONCAT22(in_stack_0000ff76,in_stack_0000ff74);
  uVar19 = CONCAT22(dpMain._2_2_,(undefined2)dpMain);
  uVar15 = CONCAT22(cTorpsLeft._2_2_,(undefined2)cTorpsLeft);
  uVar18 = CONCAT22(dp._2_2_,(int)dp);
  ihs = 0;
  lpshdef = (SHDEF *)lphul;
  do {
    uVar12 = (undefined2)((ulong)lphul >> 0x10);
    pHVar7 = (HUL *)lphul;
    pBVar8 = (BTLREC *)lpbtlrec;
    uVar13 = (undefined2)((ulong)lpbtlrec >> 0x10);
    if ((int)(uint)pHVar7->chs <= ihs) {
      pBVar8->ctok = ctokDamaged;
      return (uint)(ctokDamaged != 0);
    }
    if ((((pHVar7->rghs + ihs)->grhst & (hstTorp|hstBeam)) !=
         ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
           hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
       ((uint)pHVar7->rghs[ihs].wFlags >> 8 != 0)) {
      part.hs.grhst = (pHVar7->rghs + ihs)->grhst;
      part.hs.wFlags = pHVar7->rghs[ihs].wFlags;
      idPlayer = (short)((TOK *)ptok)->iplr;
      dp = uVar18;
      cTorpsLeft = uVar15;
      dpMain = uVar19;
      score = lVar17;
      FLookupPart(&part);
      idPlayer = -1;
      cItem = (uint)((HUL *)lphul)->rghs[ihs].wFlags >> 8;
      uVar12 = (undefined2)((ulong)ptok >> 0x10);
      pTVar9 = (TOK *)ptok;
      uVar14 = (undefined2)((ulong)part.pcom >> 0x10);
      pCVar10 = (COMPART *)part.pcom;
      i = (uint)pTVar9->initBase + *(int *)(pCVar10[1].rgTech + 2);
      if (0x3f < i) {
        i = 0x3f;
      }
      uVar15 = cTorpsLeft;
      uVar19 = dpMain;
      uVar18 = dp;
      lVar17 = score;
      if (i == init) {
        dxRangeCur = (uint)(pTVar9->field2_0x3 == '\x01') + (pCVar10 + 1)->id;
        if ((part.hs.grhst == hstBeam) && ((*(uint *)(pCVar10[1].rgTech + 4) & 2) != 0)) {
          uVar29 = 0;
          uVar30 = 0;
          uVar27 = (undefined1)pTVar9->csh;
          uVar28 = (undefined1)((uint)pTVar9->csh >> 8);
          uVar18 = __aFulmul((long)*(int *)pCVar10[1].rgTech,(long)cItem);
          uVar18 = __aFulmul(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,uVar27))
                                                    ));
          if (*(int *)((COMPART *)part.pcom)[1].rgTech < 200) {
            grfWeapon = 1;
          }
          else {
            grfWeapon = 2;
          }
          uVar12 = (undefined2)((ulong)ptok >> 0x10);
          if (((TOK *)ptok)->pctCap != 0) {
            uVar29 = 0;
            uVar30 = 0;
            uVar27 = 100;
            uVar28 = 0;
            dp = uVar18;
            uVar18 = __aFulmul(uVar18,(ulong)((TOK *)ptok)->pctCap);
            uVar18 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,uVar27)
                                                                     )));
          }
          ptokE = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
          dpT = uVar18;
          uVar15 = cTorpsLeft;
          uVar19 = dpMain;
          lVar17 = score;
          for (itok = 0; itok < vctok; itok = itok + 1) {
            uVar12 = (undefined2)((ulong)ptokE >> 0x10);
            pTVar9 = (TOK *)ptokE;
            if ((pTVar9->wFlags & 1U) != 0) {
              uVar14 = (undefined2)((ulong)ptok >> 0x10);
              if ((pTVar9->iplr != ((TOK *)ptok)->iplr) &&
                 ((1 << (pTVar9->iplr & 0x1f) & grfAttack) != 0)) {
                dp = uVar18;
                cTorpsLeft = uVar15;
                dpMain = uVar19;
                score = lVar17;
                sVar3 = DzFromBrcBrc(pTVar9->brc,((TOK *)ptok)->brc);
                uVar18 = dp;
                uVar15 = cTorpsLeft;
                uVar19 = dpMain;
                lVar17 = score;
                if (sVar3 <= dxRangeCur) {
                  sVar3 = FIsTargetOfMdTarget(ptokE,((TOK *)ptok)->wFlags & 0xf);
                  uVar18 = dp;
                  if (sVar3 == 0) {
                    sVar3 = FIsTargetOfMdTarget(ptokE,(uint)((TOK *)ptok)->wFlags >> 4 & 0xf);
                    uVar18 = dp;
                    uVar15 = cTorpsLeft;
                    uVar19 = dpMain;
                    lVar17 = score;
                    if (sVar3 == 0) goto LAB_10f0_6bfa;
                  }
                  if (pTVar9->pctBeamDef < 100) {
                    uVar29 = 0;
                    uVar30 = 0;
                    uVar27 = 100;
                    uVar28 = 0;
                    dp = uVar18;
                    uVar18 = __aFulmul(uVar18,(ulong)pTVar9->pctBeamDef);
                    uVar18 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28
                                                  ,uVar27))));
                  }
                  dp = uVar18;
                  sVar3 = FDamageTok(ptokE,itok,&dp,0,grfWeapon,
                                     *(uint *)(((COMPART *)part.pcom)[1].rgTech + 4) & 1,(long *)0x0
                                    );
                  uVar18 = dpT;
                  uVar15 = cTorpsLeft;
                  uVar19 = dpMain;
                  lVar17 = score;
                  if (sVar3 != 0) {
                    if (fSetItok == 0) {
                      fSetItok = 1;
                      pBVar8->wFlags = pBVar8->wFlags & 0xffU | itok << 8;
                    }
                    ctokDamaged = ctokDamaged + 1;
                  }
                }
              }
            }
LAB_10f0_6bfa:
            ptokE = (TOK *)CONCAT22(uVar12,pTVar9 + 1);
          }
        }
        else {
          if (part.hs.grhst == hstBeam) {
            uVar29 = 0;
            uVar30 = 0;
            uVar27 = (undefined1)pTVar9->csh;
            uVar28 = (undefined1)((uint)pTVar9->csh >> 8);
            uVar18 = __aFulmul((long)*(int *)pCVar10[1].rgTech,(long)cItem);
            uVar19 = __aFulmul(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,uVar27
                                                                                      ))));
            uVar15 = 0;
            lVar17 = score;
          }
          else {
            dpMain._0_2_ = 0;
            dpMain._2_2_ = 0;
            uVar15 = __aFulmul((long)cItem,(ulong)(uint)pTVar9->csh);
            uVar19 = CONCAT22(dpMain._2_2_,(undefined2)dpMain);
            lVar17 = score;
          }
          do {
            for (fPrimary = 1; -1 < fPrimary; fPrimary = fPrimary + -1) {
              scoreBest = 0;
              ptokTarget = (TOK *)0x0;
              ptokE = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
              for (itok = 0; itok < vctok; itok = itok + 1) {
                uVar12 = (undefined2)((ulong)ptokE >> 0x10);
                pTVar9 = (TOK *)ptokE;
                if ((pTVar9->wFlags & 1U) != 0) {
                  uVar14 = (undefined2)((ulong)ptok >> 0x10);
                  if ((pTVar9->iplr != ((TOK *)ptok)->iplr) &&
                     ((1 << (pTVar9->iplr & 0x1f) & grfAttack) != 0)) {
                    score = lVar17;
                    cTorpsLeft = uVar15;
                    dpMain = uVar19;
                    sVar3 = DzFromBrcBrc(pTVar9->brc,((TOK *)ptok)->brc);
                    lVar17 = score;
                    uVar15 = cTorpsLeft;
                    uVar19 = dpMain;
                    if (sVar3 <= dxRangeCur) {
                      uVar14 = (undefined2)((ulong)ptok >> 0x10);
                      if (fPrimary == 0) {
                        uVar4 = (uint)((TOK *)ptok)->wFlags >> 4;
                      }
                      else {
                        uVar4 = ((TOK *)ptok)->wFlags;
                      }
                      sVar3 = FIsTargetOfMdTarget(ptokE,uVar4 & 0xf);
                      lVar17 = score;
                      uVar15 = cTorpsLeft;
                      uVar19 = dpMain;
                      if (sVar3 != 0) {
                        lpshdefE = LpshdefFromTok(ptokE);
                        uVar14 = (undefined2)((ulong)lpshdefE >> 0x10);
                        uVar4 = (((SHDEF *)lpshdefE)->hul).rgwtOreCost[1];
                        uVar1 = (((SHDEF *)lpshdefE)->hul).resCost;
                        uVar18 = __aFulmul((ulong)CONCAT12(CARRY2(uVar1,uVar4),uVar1 + uVar4
                                                                  ),(ulong)(uint)pTVar9->csh);
                        if ((long)uVar18 < 100000) {
                          lValue = uVar18;
                          uVar18 = __aFulmul(uVar18,100);
                        }
                        else {
                          uVar18 = 10000000;
                        }
                        dpSingle._0_2_ = (((SHDEF *)lpshdefE)->hul).dp;
                        dpSingle._2_2_ = 0;
                        lValue = uVar18;
                        uVar18 = __aFulmul((ulong)(uint)pTVar9->dpShield,
                                                   (ulong)(uint)pTVar9->csh);
                        dpShieldLeft = uVar18;
                        uVar18 = __aFulmul(CONCAT22(dpSingle._2_2_,(short)dpSingle),
                                                   (ulong)(uint)pTVar9->csh);
                        if ((&pTVar9->dv)->dp != 0) {
                          uVar29 = 0;
                          uVar30 = 0;
                          uVar27 = 0xf4;
                          uVar28 = 1;
                          sVar3 = pTVar9->csh;
                          uVar26 = 0;
                          uVar25 = 0;
                          uVar24 = 10;
                          uVar4 = (&pTVar9->dv)->dp & 0x7f;
                          uVar23 = 0;
                          uVar22 = 0;
                          uVar14 = 10;
                          dpArmorLeft = uVar18;
                          uVar18 = __aFulmul(CONCAT22(dpSingle._2_2_,(short)dpSingle),
                                                     (ulong)((uint)(&pTVar9->dv)->dp >> 7));
                          uVar18 = __aFldiv(uVar18,CONCAT22(uVar22,uVar14));
                          uVar18 = __aFulmul(uVar18,CONCAT22(uVar23,uVar4));
                          uVar18 = __aFldiv(uVar18,CONCAT22(uVar25,uVar24));
                          uVar18 = __aFulmul(uVar18,CONCAT22(uVar26,sVar3));
                          lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(
                                                  uVar28,uVar27))));
                          uVar18 = dpArmorLeft - lVar17;
                        }
                        if ((long)uVar18 < 1) {
                          uVar18 = 1;
                        }
                        dpArmorLeft = uVar18;
                        if ((part.hs.grhst == hstBeam) || (part.hs.grhst != hstTorp)) {
                          if (pTVar9->pctBeamDef < 100) {
                            uVar29 = 0;
                            uVar30 = 0;
                            uVar27 = 100;
                            uVar28 = 0;
                            uVar18 = __aFulmul(lValue,(ulong)pTVar9->pctBeamDef);
                            uVar18 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                            lValue = uVar18;
                          }
                          if ((*(uint *)(((COMPART *)part.pcom)[1].rgTech + 4) & 1) == 0) {
                            lVar17 = dpArmorLeft + dpShieldLeft + 1;
                            uVar18 = __aFulmul(lValue,100);
                            lVar17 = __aFldiv(uVar18,lVar17);
                            uVar15 = cTorpsLeft;
                            uVar19 = dpMain;
                            if (lVar17 < 1) {
                              lVar17 = 1;
                            }
                          }
                          else if (dpShieldLeft < 1) {
                            lVar17 = 0;
                            uVar15 = cTorpsLeft;
                            uVar19 = dpMain;
                          }
                          else {
                            uVar29 = (undefined1)((ulong)dpShieldLeft >> 0x10);
                            uVar30 = (undefined1)((ulong)dpShieldLeft >> 0x18);
                            uVar27 = (undefined1)dpShieldLeft;
                            uVar28 = (undefined1)((ulong)dpShieldLeft >> 8);
                            uVar18 = __aFulmul(lValue,100);
                            lVar17 = __aFldiv(uVar18 + dpShieldLeft + -1,
                                                      CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(
                                                  uVar28,uVar27))));
                            uVar15 = cTorpsLeft;
                            uVar19 = dpMain;
                          }
                        }
                        else {
                          pctHit._0_2_ = *(uint *)(((COMPART *)part.pcom)[1].rgTech + 4);
                          pctHit._2_2_ = (int)(uint)pctHit >> 0xf;
                          uVar14 = (undefined2)((ulong)ptok >> 0x10);
                          pTVar11 = (TOK *)ptok;
                          if (pTVar11->pctBC < pTVar9->pctJam) {
                            uVar29 = 0;
                            uVar30 = 0;
                            uVar27 = 100;
                            uVar28 = 0;
                            uVar18 = __aFulmul((long)(int)(uint)pctHit,
                                                       (long)(int)((uint)pTVar9->pctJam -
                                                                  (uint)pTVar11->pctBC));
                            lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                            pctHit = CONCAT22((pctHit._2_2_ - (int)((ulong)lVar17 >> 0x10)) -
                                              (uint)((uint)pctHit < (uint)lVar17),
                                              (uint)pctHit - (uint)lVar17);
                          }
                          else {
                            uVar29 = 0;
                            uVar30 = 0;
                            uVar27 = 100;
                            uVar28 = 0;
                            uVar18 = __aFulmul(CONCAT22(-(uint)(100 < (uint)pctHit) -
                                                                pctHit._2_2_,100 - (uint)pctHit),
                                                       (long)(int)((uint)pTVar11->pctBC -
                                                                  (uint)pTVar9->pctJam));
                            lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                            pctHit = lVar17 + CONCAT22(pctHit._2_2_,(uint)pctHit);
                          }
                          if (pctHit < 1) {
                            lVar17 = 0;
                            uVar15 = cTorpsLeft;
                            uVar19 = dpMain;
                          }
                          else {
                            if (((part.hs.wFlags & 0xffU) < 8) || (0xb < (part.hs.wFlags & 0xffU)))
                            {
                              iVar2 = 0;
                            }
                            else {
                              iVar2 = 1;
                            }
                            if (dpArmorLeft < 100000) {
                              uVar29 = (undefined1)((ulong)pctHit >> 0x10);
                              uVar30 = (undefined1)((ulong)pctHit >> 0x18);
                              uVar27 = (undefined1)pctHit;
                              uVar28 = (undefined1)((ulong)pctHit >> 8);
                              __aFulmul(dpArmorLeft,100);
                              lVar17 = __aFlshl(CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(
                                                  uVar28,uVar27))),unaff_DI);
                              uVar18 = __aFldiv(lVar17,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                              lVar17 = pctHit;
                            }
                            else {
                              uVar29 = 0;
                              uVar30 = 0;
                              uVar27 = 200;
                              uVar28 = 0;
                              uVar18 = __aFldiv(dpArmorLeft,pctHit);
                              uVar18 = __aFulmul(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                              lVar17 = pctHit;
                            }
                            pctHit._2_2_ = (int)((ulong)lVar17 >> 0x10);
                            pctHit._0_2_ = (uint)lVar17;
                            pctHit = lVar17;
                            if (dpShieldLeft < 100000) {
                              iVar6 = 100 - (uint)pctHit;
                              iVar5 = -(uint)(100 < (uint)pctHit) - pctHit._2_2_;
                              lVar16 = __aFldiv(CONCAT22(iVar5,iVar6),8);
                              lVar17 = __aFldiv(pctHit,2);
                              lVar17 = lVar17 + lVar16;
                              uVar29 = (undefined1)((ulong)lVar17 >> 0x10);
                              uVar30 = (undefined1)((ulong)lVar17 >> 0x18);
                              uVar27 = (undefined1)lVar17;
                              uVar28 = (undefined1)((ulong)lVar17 >> 8);
                              uVar19 = __aFulmul(dpShieldLeft,100);
                              uVar19 = __aFldiv(uVar19,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                            }
                            else {
                              uVar29 = 0;
                              uVar30 = 0;
                              uVar27 = 100;
                              uVar28 = 0;
                              iVar6 = 100 - (uint)pctHit;
                              iVar5 = -(uint)(100 < (uint)pctHit) - pctHit._2_2_;
                              lVar16 = __aFldiv(CONCAT22(iVar5,iVar6),8);
                              lVar17 = __aFldiv(pctHit,2);
                              uVar19 = __aFldiv(dpShieldLeft,lVar17 + lVar16);
                              uVar19 = __aFulmul(uVar19,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                            }
                            uVar15 = __aFulmul(pctHit,(ulong)(iVar2 + 1));
                            uVar29 = (undefined1)(uVar15 >> 0x10);
                            uVar30 = (undefined1)(uVar15 >> 0x18);
                            uVar27 = (undefined1)uVar15;
                            uVar28 = (undefined1)(uVar15 >> 8);
                            uVar24 = 0;
                            uVar23 = 100;
                            uVar22 = 0;
                            uVar14 = 200;
                            uVar15 = __aFulmul(uVar19,pctHit);
                            lVar17 = __aFldiv(uVar15,CONCAT22(uVar22,uVar14));
                            uVar15 = __aFulmul(dpArmorLeft - lVar17,CONCAT22(uVar24,uVar23))
                            ;
                            lVar17 = __aFldiv(uVar15,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                            if ((long)(uVar19 + lVar17) <= (long)uVar18) {
                              uVar18 = lVar17 + uVar19;
                            }
                            if ((long)uVar18 < 1) {
                              lVar17 = 0;
                              uVar15 = cTorpsLeft;
                              uVar19 = dpMain;
                            }
                            else {
                              score = uVar18;
                              lVar17 = __aFldiv(lValue,uVar18);
                              uVar15 = cTorpsLeft;
                              uVar19 = dpMain;
                              if (lVar17 < 1) {
                                lVar17 = 1;
                              }
                            }
                          }
                        }
                        if (scoreBest < lVar17) {
                          ptokTarget = ptokE;
                          itokTarget = itok;
                          scoreBest = lVar17;
                        }
                      }
                    }
                  }
                }
                ptokE = (TOK *)CONCAT22(uVar12,pTVar9 + 1);
              }
              if (((TOK *)ptokTarget != (TOK *)0x0) || (ptokTarget._2_2_ != 0)) break;
            }
            if (((TOK *)ptokTarget == (TOK *)0x0) && (uVar18 = dp, ptokTarget._2_2_ == 0)) break;
            cTorpsLeft = uVar15;
            dpMain = uVar19;
            score = lVar17;
            dz = DzFromBrcBrc(((TOK *)ptokTarget)->brc,((TOK *)ptok)->brc);
            pTVar9 = (TOK *)ptok;
            uVar12 = (undefined2)((ulong)ptok >> 0x10);
            if (part.hs.grhst == hstBeam) {
              dp = dpMain;
              if (pTVar9->pctCap != 0) {
                uVar29 = 0;
                uVar30 = 0;
                uVar27 = 100;
                uVar28 = 0;
                uVar18 = __aFulmul(dpMain,(ulong)pTVar9->pctCap);
                uVar18 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                dp = uVar18;
              }
              uVar12 = (undefined2)((ulong)ptokTarget >> 0x10);
              if (((TOK *)ptokTarget)->pctBeamDef < 100) {
                uVar29 = 0;
                uVar30 = 0;
                uVar27 = 100;
                uVar28 = 0;
                uVar18 = __aFulmul(dp,(ulong)((TOK *)ptokTarget)->pctBeamDef);
                uVar18 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                dp = uVar18;
              }
              if (0 < dz) {
                uVar12 = (undefined2)((ulong)part.pcom >> 0x10);
                if (0 < ((COMPART *)part.pcom + 1)->id) {
                  uVar29 = 0;
                  uVar30 = 0;
                  uVar27 = 100;
                  uVar28 = 0;
                  iVar2 = ((COMPART *)part.pcom + 1)->id;
                  iVar6 = iVar2 >> 0xf;
                  uVar18 = __aFulmul((long)dz,10);
                  lVar17 = __aFldiv(uVar18,CONCAT22(iVar6,iVar2));
                  uVar18 = __aFulmul(dp,CONCAT22(-(uint)(100 < (uint)lVar17) -
                                                         (int)((ulong)lVar17 >> 0x10),
                                                         100 - (uint)lVar17));
                  uVar18 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                  dp = uVar18;
                }
              }
              uVar12 = (undefined2)((ulong)part.pcom >> 0x10);
              if (*(int *)((COMPART *)part.pcom)[1].rgTech < 200) {
                grfWeapon = 1;
              }
              else {
                grfWeapon = 2;
              }
              dpT = dp;
              sVar3 = FDamageTok(ptokTarget,itokTarget,&dp,0,grfWeapon,
                                 *(uint *)(((COMPART *)part.pcom)[1].rgTech + 4) & 1,(long *)0x0);
              if (sVar3 != 0) {
                if (fSetItok == 0) {
                  pBVar8->wFlags = pBVar8->wFlags & 0xffU | itokTarget << 8;
                  fSetItok = 1;
                }
                ctokDamaged = ctokDamaged + 1;
              }
              if ((dp < 1) || (dpT < 1)) {
                uVar15 = cTorpsLeft;
                uVar19 = 0;
                lVar17 = score;
              }
              else {
                if ((((dpMain < 0x20000) && (dpMain < 0x10000)) && (dp < 0x20000)) && (dp < 0x10000)
                   ) {
                  uVar29 = (undefined1)((ulong)dpT >> 0x10);
                  uVar30 = (undefined1)((ulong)dpT >> 0x18);
                  uVar27 = (undefined1)dpT;
                  uVar28 = (undefined1)((ulong)dpT >> 8);
                  uVar18 = __aFulmul(dpMain,dp);
                  uVar19 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                }
                else {
                  uVar19 = __ftol((double)CONCAT26((int)((ulong)lVar16 >> 0x10),
                                                           CONCAT24((int)lVar16,
                                                                    CONCAT22(unaff_SI,unaff_DI))));
                }
                lValue = uVar19;
                uVar15 = cTorpsLeft;
                lVar17 = score;
                if (dpMain + -1 < (long)uVar19) {
                  uVar19 = dpMain - 1;
                }
              }
            }
            else {
              uVar15 = cTorpsLeft;
              uVar19 = dpMain;
              lVar17 = score;
              if ((part.hs.grhst == hstTorp) && (0 < cTorpsLeft)) {
                grfWeapon = 4;
                cTorpBase = cTorpsLeft;
                lVar17 = CTorpHit(cTorpsLeft,ptokTarget,
                                  *(short *)(((COMPART *)part.pcom)[1].rgTech + 4),
                                  (uint)pTVar9->pctBC);
                cTorpHit = lVar17;
                lpshdefE = LpshdefFromTok(ptokTarget);
                dpSingle._0_2_ = (((SHDEF *)lpshdefE)->hul).dp;
                dpSingle._2_2_ = 0;
                uVar12 = (undefined2)((ulong)ptokTarget >> 0x10);
                uVar18 = __aFulmul((ulong)(uint)((TOK *)ptokTarget)->dpShield,
                                           (ulong)(uint)((TOK *)ptokTarget)->csh);
                dpShieldLeft = uVar18;
                uVar18 = __aFulmul(CONCAT22(dpSingle._2_2_,(short)dpSingle),
                                           (ulong)(uint)((TOK *)ptokTarget)->csh);
                uVar12 = (undefined2)((ulong)ptokTarget >> 0x10);
                pTVar9 = (TOK *)ptokTarget;
                if ((&pTVar9->dv)->dp != 0) {
                  uVar29 = 0;
                  uVar30 = 0;
                  uVar27 = 0xf4;
                  uVar28 = 1;
                  sVar3 = pTVar9->csh;
                  uVar26 = 0;
                  uVar25 = 0;
                  uVar24 = 10;
                  uVar4 = (&pTVar9->dv)->dp & 0x7f;
                  uVar23 = 0;
                  uVar22 = 0;
                  uVar14 = 10;
                  dpArmorLeft = uVar18;
                  uVar18 = __aFulmul(CONCAT22(dpSingle._2_2_,(short)dpSingle),
                                             (ulong)((uint)(&pTVar9->dv)->dp >> 7));
                  uVar18 = __aFldiv(uVar18,CONCAT22(uVar22,uVar14));
                  uVar18 = __aFulmul(uVar18,CONCAT22(uVar23,uVar4));
                  uVar18 = __aFldiv(uVar18,CONCAT22(uVar25,uVar24));
                  uVar18 = __aFulmul(uVar18,CONCAT22(uVar26,sVar3));
                  lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                  uVar18 = dpArmorLeft - lVar17;
                }
                dp._0_2_ = *(int *)((COMPART *)part.pcom)[1].rgTech;
                dp._2_2_ = (int)dp >> 0xf;
                uVar15 = (ulong)(int)dp;
                uVar19 = (ulong)(int)dp;
                if ((7 < (part.hs.wFlags & 0xffU)) && ((part.hs.wFlags & 0xffU) < 0xc)) {
                  if (dpShieldLeft < 1) {
                    dpArmorLeft = uVar18;
                    uVar19 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),(ushort)lVar16);
                    uVar18 = dpArmorLeft;
                  }
                  grfWeapon = grfWeapon | 8;
                  uVar15 = uVar19;
                }
                i = ((TOK *)ptokTarget)->csh;
                dp = uVar15;
                dpArmorLeft = uVar18;
                if (i < cTorpBase) {
                  uVar18 = __aFulmul(cTorpHit,uVar15);
                  if ((long)uVar18 <= dpArmorLeft) goto LAB_10f0_79f6;
                  for (; i <= cTorpBase; i = i + 1) {
                    uVar29 = (undefined1)((ulong)cTorpBase >> 0x10);
                    uVar30 = (undefined1)((ulong)cTorpBase >> 0x18);
                    uVar27 = (undefined1)cTorpBase;
                    uVar28 = (undefined1)((ulong)cTorpBase >> 8);
                    uVar18 = __aFulmul((long)i,cTorpHit);
                    lVar17 = __aFldiv(uVar18 + cTorpBase + -1,
                                              CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,uVar27
                                                                                      ))));
                    cTorpMiss._0_2_ = i - (uint)lVar17;
                    cTorpMiss._2_2_ =
                         ((i >> 0xf) - (int)((ulong)lVar17 >> 0x10)) -
                         (uint)((uint)i < (uint)lVar17);
                    uVar29 = 0;
                    uVar30 = 0;
                    uVar27 = 8;
                    uVar28 = 0;
                    cTorpFire = lVar17;
                    uVar18 = __aFulmul(CONCAT22(cTorpMiss._2_2_,(int)cTorpMiss),dp);
                    lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28
                                                  ,uVar27))));
                    lVar17 = dpShieldLeft - lVar17;
                    if ((lVar17 < 0x10000) && (lVar17 < 0)) {
                      lVar17 = 0;
                    }
                    dpShieldCur._2_2_ = (int)((ulong)lVar17 >> 0x10);
                    dpShieldCur._0_2_ = (uint)lVar17;
                    uVar29 = 0;
                    uVar30 = 0;
                    uVar27 = 2;
                    uVar28 = 0;
                    uVar18 = __aFulmul(cTorpFire,dp);
                    lVar20 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28
                                                  ,uVar27))));
                    iVar2 = (dpShieldCur._2_2_ - (int)((ulong)lVar20 >> 0x10)) -
                            (uint)((uint)dpShieldCur < (uint)lVar20);
                    uVar29 = 0;
                    uVar30 = 0;
                    uVar27 = 2;
                    uVar28 = 0;
                    uVar18 = __aFulmul(cTorpFire,dp);
                    lVar21 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28
                                                  ,uVar27))));
                    if ((iVar2 < 1) && (iVar2 < 0)) {
                      lVar21 = lVar21 - (lVar17 - lVar20);
                    }
                    if (dpArmorLeft <= lVar21) break;
                  }
                }
                else {
LAB_10f0_79f6:
                  cTorpMiss = cTorpBase - cTorpHit;
                  cTorpFire = cTorpHit;
                }
                uVar29 = 0;
                uVar30 = 0;
                uVar27 = 8;
                uVar28 = 0;
                uVar18 = __aFulmul(cTorpMiss,dp);
                lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                if (0 < lVar17) {
                  dpCol = lVar17;
                  sVar3 = FDamageTok(ptokTarget,itokTarget,&dpCol,0,grfWeapon | 0x80,1,(long *)0x0);
                  lVar17 = dpCol;
                  if (sVar3 != 0) {
                    ctokDamaged = ctokDamaged + 1;
                  }
                }
                uVar29 = 0;
                uVar30 = 0;
                uVar27 = 2;
                uVar28 = 0;
                dpCol = lVar17;
                uVar18 = __aFulmul(cTorpFire,dp);
                lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                cTorpBase = cTorpFire + cTorpMiss;
                dpT = lVar17;
                FDamageTok(ptokTarget,itokTarget,&dpT,lVar17,grfWeapon,0,&cTorpBase);
                ctokDamaged = ctokDamaged + 1;
                if (fSetItok == 0) {
                  fSetItok = 1;
                  pBVar8->wFlags = pBVar8->wFlags & 0xffU | itokTarget << 8;
                }
                uVar15 = cTorpsLeft - (cTorpFire + cTorpMiss);
                uVar19 = dpMain;
                lVar17 = score;
              }
            }
          } while ((0 < (long)uVar19) || (uVar18 = dp, 0 < (long)uVar15));
        }
      }
    }
    ihs = ihs + 1;
  } while( true );
}



// ======================================================================
// Function: KillShips
// Address: 10f0:7cde
// Segment: MEMORY_BATTLE
// ======================================================================


void KillShips(TOK *ptok,short cshKill,short ishdef,FLEET *lpfl,short fFallout)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  uint iplr;
  int iVar3;
  TOK *pTVar4;
  FLEET *pFVar5;
  FLEET *pFVar6;
  undefined2 uVar7;
  undefined2 unaff_SS;
  SHDEF *lphul;
  short csh;
  FLEET flSrc;
  short i;
  FLEET flDead;
  
  if (cshKill != 0) {
    pTVar4 = (TOK *)ptok;
    uVar7 = (undefined2)((ulong)ptok >> 0x10);
    if (fFallout != 0) {
      iplr = (uint)pTVar4->iplr;
      lphul = LpshdefFromTok(ptok);
      MarkTechsSeen(&lphul->hul,iplr);
    }
    pFVar6 = &flSrc;
    pFVar5 = (FLEET *)lpfl;
    for (iVar3 = 0x3e; iVar3 != 0; iVar3 = iVar3 + -1) {
      pFVar2 = pFVar6;
      pFVar6 = (FLEET *)&pFVar6->iPlayer;
      pFVar1 = pFVar5;
      pFVar5 = (FLEET *)&pFVar5->iPlayer;
      pFVar2->id = pFVar1->id;
    }
    _memset(&flDead,0,0x7c);
    iVar3 = ((FLEET *)lpfl)->rgcsh[ishdef] - cshKill;
    flDead.rgcsh[ishdef] = cshKill;
    flSrc.rgcsh[ishdef] = iVar3;
    pTVar4->csh = iVar3;
    if (iVar3 == 0) {
      pTVar4->wFlags = pTVar4->wFlags & 0xfffe;
      for (ishdef = 0; (ishdef < 0x10 && (flSrc.rgcsh[ishdef] == 0)); ishdef = ishdef + 1) {
      }
      if ((ishdef == 0x10) &&
         (((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0xfbffU | 0x400, fFallout != 0)) {
        for (i = 0; i < 3; i = i + 1) {
          uVar7 = *(undefined2 *)((int)flSrc.rgwtMin + i * 4 + 2);
          *(int *)(flDead.rgwtMin + i) = (int)flSrc.rgwtMin[i];
          *(undefined2 *)((int)flDead.rgwtMin + i * 4 + 2) = uVar7;
        }
      }
    }
    if (((uint)((FLEET *)lpfl)->wFlags >> 10 & 1) == 0) {
      flDead.iPlayer = flSrc.iPlayer;
      flDead.wFlags = flDead.wFlags & 0xfb00U | 0x407;
      FleetTransferCargoBalance(&flSrc,&flDead);
    }
    if (fFallout != 0) {
      flDead.iPlayer = flSrc.iPlayer;
      flDead.pt.x = flSrc.pt.x;
      flDead.pt.y = flSrc.pt.y;
      flDead.idPlanet = flSrc.idPlanet;
      CreateSalvage(&flDead,(THING **)&lpthBattle);
    }
    if (((uint)((FLEET *)lpfl)->wFlags >> 10 & 1) == 0) {
      pFVar6 = &flSrc;
      for (iVar3 = 0x3e; iVar3 != 0; iVar3 = iVar3 + -1) {
        pFVar2 = (FLEET *)lpfl;
        lpfl._0_2_ = (FLEET *)&((FLEET *)lpfl)->iPlayer;
        pFVar1 = pFVar6;
        pFVar6 = (FLEET *)&pFVar6->iPlayer;
        pFVar2->id = pFVar1->id;
      }
    }
  }
  return;
}



// ======================================================================
// Function: CreateSalvage
// Address: 10f0:7ee8
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Variable defined which should be unmapped: shdefT */
/* WARNING: Variable defined which should be unmapped: lpshdefT */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

void CreateSalvage(FLEET *pfl,THING **plpth)

{
  uint *puVar1;
  int *piVar2;
  HullDef *pHVar3;
  SHDEF *pSVar4;
  undefined2 uVar5;
  uint uVar6;
  uint uVar7;
  short sVar8;
  uint uVar9;
  int iVar10;
  undefined2 unaff_SI;
  HullDef *pHVar11;
  undefined2 unaff_DI;
  SHDEF *pSVar12;
  undefined2 unaff_SS;
  bool bVar13;
  ulong uVar14;
  long lVar15;
  long lVar16;
  SHDEF shdefT;
  short fBleeding;
  short j;
  long rgwtMinerals [3];
  short i;
  PLANET *lppl;
  SHDEF *lpshdefT;
  long wtTotal;
  
  lVar16 = CONCAT22(unaff_SI,unaff_DI);
  sVar8 = GetRaceGrbit((PLAYER *)rgplr + pfl->iPlayer,ibitRaceBleedingEdgeTech);
  gd._4_2_ = gd._4_2_ & 0xfff7 | 8;
  idPlayer = pfl->iPlayer;
  if (pfl->idPlanet == -1) {
    lppl = (PLANET *)0x0;
  }
  else {
    lppl = LpplFromId(pfl->idPlanet);
  }
  i = 0;
  while( true ) {
    if (2 < i) break;
    *(undefined2 *)(rgwtMinerals + i) = 0;
    *(undefined2 *)((int)rgwtMinerals + i * 4 + 2) = 0;
    for (j = 0; j < 0x10; j = j + 1) {
      if (0 < pfl->rgcsh[j]) {
        if (sVar8 == 0) {
          iVar10 = pfl->iPlayer * 4;
          lpshdefT._2_2_ = *(undefined2 *)(iVar10 + 0x100);
          lpshdefT._0_2_ = (SHDEF *)(*(int *)(iVar10 + 0xfe) + j * 0x93);
        }
        else {
          iVar10 = pfl->iPlayer * 4;
          uVar5 = *(undefined2 *)(iVar10 + 0x100);
          pHVar11 = (HullDef *)(*(int *)(iVar10 + 0xfe) + j * 0x93);
          pSVar12 = &shdefT;
          for (iVar10 = 0x49; iVar10 != 0; iVar10 = iVar10 + -1) {
            pSVar4 = pSVar12;
            pSVar12 = (SHDEF *)(pSVar12->hul).rgTech;
            pHVar3 = pHVar11;
            pHVar11 = pHVar11 + 1;
            (pSVar4->hul).ihuldef = *pHVar3;
          }
          *(char *)&(pSVar12->hul).ihuldef = (char)*pHVar11;
          UpdateShdefCost((SHDEF *)CONCAT22(unaff_SS,&shdefT));
          lpshdefT._0_2_ = &shdefT;
          lpshdefT._2_2_ = unaff_SS;
        }
        lVar15 = 3;
        uVar14 = __aFulmul((long)pfl->rgcsh[j],
                                   (ulong)(uint)(((SHDEF *)lpshdefT)->hul).rgwtOreCost[i]);
        lVar15 = __aFldiv(uVar14,lVar15);
        puVar1 = (uint *)(rgwtMinerals + i);
        uVar9 = *puVar1;
        *puVar1 = *puVar1 + (uint)lVar15;
        piVar2 = (int *)((int)rgwtMinerals + i * 4 + 2);
        *piVar2 = *piVar2 + (int)((ulong)lVar15 >> 0x10) + (uint)CARRY2(uVar9,(uint)lVar15);
      }
    }
    uVar6 = *(uint *)(pfl->rgwtMin + i);
    uVar7 = *(uint *)((int)(pfl->rgwtMin + i) + 2);
    puVar1 = (uint *)(rgwtMinerals + i);
    uVar9 = *puVar1;
    *puVar1 = *puVar1 + uVar6;
    piVar2 = (int *)((int)rgwtMinerals + i * 4 + 2);
    *piVar2 = *piVar2 + uVar7 + (uint)CARRY2(uVar9,uVar6);
    if (((PLANET *)lppl != (PLANET *)0x0) || (lppl._2_2_ != 0)) {
      lVar15 = 10;
      if (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) == 0) {
        uVar9 = 5;
      }
      else {
        uVar9 = 8;
      }
      uVar14 = __aFulmul(CONCAT22(*(undefined2 *)((int)rgwtMinerals + i * 4 + 2),
                                          (int)rgwtMinerals[i]),(ulong)uVar9);
      lVar15 = __aFldiv(uVar14,lVar15);
      puVar1 = (uint *)(((PLANET *)lppl)->rgwtMin + i);
      uVar9 = *puVar1;
      *puVar1 = *puVar1 + (uint)lVar15;
      puVar1 = (uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
      *puVar1 = *puVar1 + (int)((ulong)lVar15 >> 0x10) + (uint)CARRY2(uVar9,(uint)lVar15);
    }
    i = i + 1;
  }
  if (((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) {
    wtTotal._0_2_ = 0;
    wtTotal._2_2_ = 0;
    for (i = 0; i < 3; i = i + 1) {
      lVar15 = __aFlshr(lVar16,shdefT.hul.ihuldef);
      puVar1 = (uint *)(rgwtMinerals + i);
      uVar9 = *puVar1;
      *puVar1 = *puVar1 - (uint)lVar15;
      piVar2 = (int *)((int)rgwtMinerals + i * 4 + 2);
      *piVar2 = (*piVar2 - (int)((ulong)lVar15 >> 0x10)) - (uint)(uVar9 < (uint)lVar15);
      bVar13 = CARRY2((uint)wtTotal,*(uint *)(rgwtMinerals + i));
      wtTotal._0_2_ = (uint)wtTotal + *(uint *)(rgwtMinerals + i);
      wtTotal._2_2_ = wtTotal._2_2_ + *(int *)((int)rgwtMinerals + i * 4 + 2) + (uint)bVar13;
    }
    if (((uint)wtTotal != 0) || (wtTotal._2_2_ != 0)) {
      DropSalvage(plpth,(long *)CONCAT22(unaff_SS,rgwtMinerals),pfl->iPlayer,&pfl->pt);
    }
  }
  uVar9 = gd._4_2_ & 0xfff7;
  gd.field3_0x4 = (char)uVar9;
  gd.field4_0x5 = (char)(uVar9 >> 8);
  idPlayer = -1;
  return;
}



// ======================================================================
// Function: FDamageTok
// Address: 10f0:81d4
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f08849) */
/* WARNING: Removing unreachable block (ram,0x10f0827b) */
/* WARNING: Removing unreachable block (ram,0x10f087c1) */
/* WARNING: Removing unreachable block (ram,0x10f08ab8) */

short FDamageTok(TOK *ptok,short itok,long *pdpBeam,long dpTorp,ushort grfWeapon,
                  short fShieldsOnly,long *pcTorp)

{
  byte *pbVar1;
  PLANET *pPVar2;
  ulong uVar3;
  ushort uVar4;
  uint ishdef_00;
  short sVar5;
  uint *puVar6;
  uint uVar7;
  TOK *pTVar8;
  byte *pbVar9;
  undefined2 uVar10;
  bool bVar11;
  SHDEF *pSVar12;
  PLANET *lppl_00;
  FLEET *lpfl_00;
  ulong uVar13;
  ulong uVar14;
  ulong uVar15;
  long lVar16;
  uint uVar17;
  undefined2 uVar18;
  undefined2 uVar19;
  undefined2 uVar20;
  int iVar21;
  ushort pctDpNew;
  long dp;
  short ishdef;
  short pctDp;
  long dpT;
  short csh;
  long cKillMax;
  FLEET *lpfl;
  short cshOrig;
  short i;
  PLANET *lppl;
  long dpOrig;
  long ddpOrig;
  long dpShdef;
  short cshOrigDamaged;
  ushort *pwLosses;
  DV dv;
  short pctSh;
  
  dp._0_2_ = *(uint *)pdpBeam;
  dp._2_2_ = *(int *)((int)pdpBeam + 2);
  __fmemset(lpbBattleCur,0,8);
  *lpbBattleCur = (byte)itok;
  ((byte *)lpbBattleCur)[1] = (byte)grfWeapon;
  uVar10 = (undefined2)((ulong)ptok >> 0x10);
  pTVar8 = (TOK *)ptok;
  if (pTVar8->dpShield == 0) {
    if (fShieldsOnly != 0) {
      return 0;
    }
  }
  else {
    uVar7 = pTVar8->dpShield;
    iVar21 = pTVar8->dpShield;
    uVar13 = __aFulmul((ulong)uVar7,(ulong)(uint)pTVar8->csh);
    if (CONCAT22(dp._2_2_,(uint)dp) < (long)uVar13) {
      uVar4 = WPackLong(CONCAT22(dp._2_2_,(uint)dp));
      *(ushort *)((byte *)lpbBattleCur + 4) = uVar4;
      lVar16 = __aFldiv(uVar13 - CONCAT22(dp._2_2_,(uint)dp),(ulong)(uint)pTVar8->csh);
      pTVar8->dpShield = (int)lVar16 + (iVar21 - uVar7);
      dp._0_2_ = 0;
      dp._2_2_ = 0;
    }
    else {
      bVar11 = (uint)dp < (uint)uVar13;
      dp._0_2_ = (uint)dp - (uint)uVar13;
      dp._2_2_ = (dp._2_2_ - (int)(uVar13 >> 0x10)) - (uint)bVar11;
      uVar4 = WPackLong(uVar13);
      *(ushort *)((byte *)lpbBattleCur + 4) = uVar4;
      pTVar8->dpShield = 0;
    }
  }
  if (((((uint)dp == 0) && (dp._2_2_ == 0)) || (fShieldsOnly != 0)) && (dpTorp == 0)) {
    *(short *)((byte *)lpbBattleCur + 6) = (&pTVar8->dv)->dp;
    *(uint *)pdpBeam = (uint)dp;
    *(int *)((int)pdpBeam + 2) = dp._2_2_;
    uVar10 = (undefined2)((ulong)lpbBattleCur >> 0x10);
    if ((((byte *)lpbBattleCur)[1] & 4) != 0) {
      pbVar1 = (byte *)lpbBattleCur + 1;
      *pbVar1 = *pbVar1 | 0xc0;
    }
    lpbBattleCur =
         (byte *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur + 8);
  }
  else {
    if (pcTorp == (long *)0x0) {
      cKillMax._0_2_ = -1;
      cKillMax._2_2_ = 0x7fff;
    }
    else {
      cKillMax._0_2_ = (int)*pcTorp;
      cKillMax._2_2_ = *(int *)((int)pcTorp + 2);
    }
    uVar13 = dpTorp + CONCAT22(dp._2_2_,(uint)dp);
    uVar15 = dpTorp + CONCAT22(dp._2_2_,(uint)dp);
    ishdef_00 = (uint)pTVar8->ishdef;
    pSVar12 = LpshdefFromTok(ptok);
    uVar7 = (((SHDEF *)pSVar12)->hul).dp;
    uVar3 = (ulong)uVar7;
    uVar17 = (&pTVar8->dv)->dp;
    if (pTVar8->field2_0x3 == '\x01') {
      lppl_00 = LpplFromId(ptok->id);
      uVar18 = (undefined2)((ulong)lppl_00 >> 0x10);
      pPVar2 = (PLANET *)lppl_00;
      if (uVar17 >> 7 != 0) {
        uVar19 = 0;
        uVar20 = 500;
        uVar13 = __aFulmul((ulong)uVar7,(ulong)(uVar17 >> 7));
        lVar16 = __aFldiv(uVar13,CONCAT22(uVar19,uVar20));
        uVar15 = lVar16 + uVar15;
      }
      dp._0_2_ = (uint)uVar15;
      if (((long)uVar15 < 0) || (((long)uVar15 < 0x10000 && ((uint)dp < uVar7)))) {
        uVar20 = 0;
        uVar17 = uVar7;
        uVar13 = __aFulmul(uVar15,500);
        lVar16 = __aFldiv(uVar13,CONCAT22(uVar20,uVar17));
        if (*(uint *)&pPVar2->field11_0x2c >> 4 == (uint)lVar16) {
          iVar21 = *(int *)&pPVar2->field11_0x2c;
          *(uint *)&pPVar2->field11_0x2c = *(uint *)&pPVar2->field11_0x2c & 0xf;
          *(uint *)&pPVar2->field11_0x2c = *(uint *)&pPVar2->field11_0x2c | iVar21 + 0x10U & 0xfff0;
        }
        else {
          uVar20 = 0;
          uVar13 = __aFulmul(uVar15,500);
          lVar16 = __aFldiv(uVar13,CONCAT22(uVar20,uVar7));
          *(uint *)&pPVar2->field11_0x2c = *(uint *)&pPVar2->field11_0x2c & 0xf | (int)lVar16 << 4;
        }
        uVar20 = (undefined2)((ulong)lpbBattleCur >> 0x10);
        *(uint *)((byte *)lpbBattleCur + 6) =
             *(uint *)((byte *)lpbBattleCur + 6) & 0x7f |
             (*(uint *)&pPVar2->field11_0x2c >> 4) << 7;
        fStarbaseDamaged = 1;
      }
      else {
        uVar20 = (undefined2)((ulong)lpbBattleCur >> 0x10);
        *(uint *)((byte *)lpbBattleCur + 6) =
             *(uint *)((byte *)lpbBattleCur + 6) & 0x7f | 64000;
        uVar13 = (ulong)lpbBattleCur >> 0x10;
        pbVar9 = (byte *)lpbBattleCur;
        (pbVar9 + 2)[0] = 1;
        (pbVar9 + 2)[1] = 0;
        pTVar8->wFlags = pTVar8->wFlags & 0xfffe;
        pTVar8->csh = 0;
        fStarbaseDied = 1;
        sVar5 = GetRaceStat((PLAYER *)rgplr + pPVar2->iPlayer,rsMajorAdv);
        if (sVar5 != 8) {
          pPVar2->wFlags = pPVar2->wFlags & 0xfdff;
          KillQueuedShips(lppl_00);
          KillQueuedMassPackets(lppl_00);
        }
      }
      uVar18 = (undefined2)((ulong)lpbBattleCur >> 0x10);
      pbVar9 = (byte *)lpbBattleCur;
      if (*(uint *)(pbVar9 + 6) >> 7 != 0) {
        *(uint *)(pbVar9 + 6) = *(uint *)(pbVar9 + 6) & 0xff80 | 100;
        (&pTVar8->dv)->dp = *(short *)((byte *)lpbBattleCur + 6);
      }
      *(undefined2 *)pdpBeam = 0;
      *(undefined2 *)((int)pdpBeam + 2) = 0;
      lpbBattleCur =
           (byte *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur + 8);
    }
    else {
      if (((uint)pTVar8->wFlags >> 8 & 0xf) == 1) {
        pTVar8->wFlags = pTVar8->wFlags & 0xf0ff;
        pTVar8->wFlags = pTVar8->wFlags & 0xfc1fU | 0xe0;
      }
      lpfl_00 = LpflFromId(ptok->id);
      iVar21 = pTVar8->csh;
      if (uVar17 >> 7 == 0) {
        cshOrigDamaged = 0;
        uVar15 = 0;
      }
      else {
        uVar20 = 0;
        uVar18 = 100;
        uVar15 = __aFulmul((long)iVar21,(ulong)(uVar17 & 0x7f));
        lVar16 = __aFldiv(uVar15,CONCAT22(uVar20,uVar18));
        cshOrigDamaged = (short)lVar16;
        if (cshOrigDamaged == 0) {
          cshOrigDamaged = 1;
        }
        uVar20 = 0;
        uVar18 = 500;
        uVar15 = __aFulmul((ulong)uVar7,(ulong)(uVar17 >> 7));
        uVar15 = __aFldiv(uVar15,CONCAT22(uVar20,uVar18));
        if (uVar15 == 0) {
          uVar15 = 1;
        }
      }
      sVar5 = cshOrigDamaged;
      ddpOrig._2_2_ = (int)(uVar15 >> 0x10);
      ddpOrig._0_2_ = (uint)uVar15;
      puVar6 = vrgPlrLosses + (uint)pTVar8->iplr * 0x10 + ishdef_00;
      *puVar6 = *puVar6 | 0x8000;
      csh = iVar21;
      if (cshOrigDamaged != 0) {
        csh = cshOrigDamaged;
        lVar16 = CONCAT22(-(uint)(uVar7 < (uint)ddpOrig) - ddpOrig._2_2_,uVar7 - (uint)ddpOrig);
        while (((lVar16 <= (long)uVar13 && (csh != 0)) &&
               (((int)cKillMax != 0 || (cKillMax._2_2_ != 0))))) {
          uVar13 = uVar13 - lVar16;
          csh = csh + -1;
          bVar11 = (int)cKillMax == 0;
          cKillMax._0_2_ = (int)cKillMax + -1;
          cKillMax._2_2_ = cKillMax._2_2_ - (uint)bVar11;
          if ((*puVar6 & 0x1fff) < 0x1fff) {
            *puVar6 = *puVar6 + 1;
          }
        }
        uVar3 = uVar15 + lVar16;
        cshOrigDamaged = csh;
        csh = csh + (iVar21 - sVar5);
      }
      while ((((long)uVar3 <= (long)uVar13 && (csh != 0)) &&
             (((int)cKillMax != 0 || (cKillMax._2_2_ != 0))))) {
        uVar13 = uVar13 - uVar3;
        csh = csh + -1;
        bVar11 = (int)cKillMax == 0;
        cKillMax._0_2_ = (int)cKillMax + -1;
        cKillMax._2_2_ = cKillMax._2_2_ - (uint)bVar11;
        if ((*puVar6 & 0x1fff) < 0x1fff) {
          *puVar6 = *puVar6 + 1;
        }
      }
      if ((cKillMax._2_2_ < 1) && ((cKillMax._2_2_ < 0 || ((int)cKillMax == 0)))) {
        uVar13 = 0;
      }
      iVar21 = csh >> 0xf;
      if ((uVar13 == 0) || (csh == 0)) {
        if (cshOrigDamaged == 0) {
          pctSh = 0;
          pctDp = 0;
        }
        else {
          sVar5 = csh;
          uVar15 = __aFulmul((long)cshOrigDamaged,100);
          lVar16 = __aFldiv(uVar15 + (long)csh + -1,CONCAT22(iVar21,sVar5));
          pctSh = (short)lVar16;
          pctDp = (uint)(&pTVar8->dv)->dp >> 7;
        }
      }
      else {
        if (cshOrigDamaged != 0) {
          uVar15 = __aFulmul(uVar15,(long)cshOrigDamaged);
          uVar13 = uVar15 + (long)csh + -1 + uVar13;
        }
        uVar13 = __aFldiv(uVar13,(long)csh);
        if (uVar13 == 0) {
          uVar13 = 1;
        }
        uVar15 = uVar3;
        uVar14 = __aFulmul(uVar13,500);
        lVar16 = __aFldiv(uVar14 + uVar3 + -1,uVar15);
        pctDp = (short)lVar16;
        if (pctDp == 0) {
          pctDp = 1;
        }
        pctSh = 100;
      }
      lpfl._2_2_ = (undefined2)((ulong)lpfl_00 >> 0x10);
      lpfl._0_2_ = (FLEET *)lpfl_00;
      *(short *)((byte *)lpbBattleCur + 2) = pTVar8->csh - csh;
      if (csh != pTVar8->csh) {
        KillShips(ptok,*(short *)((byte *)lpbBattleCur + 2),ishdef_00,lpfl_00,1);
      }
      if (csh != 0) {
        if (499 < pctDp) {
          pctDp = 499;
        }
        uVar7 = pctDp << 7 | pctSh & 0x7fU;
        (&pTVar8->dv)->dp = uVar7;
        (((FLEET *)lpfl)->rgdv + ishdef_00)->dp = uVar7;
        uVar13 = 0;
      }
      if (dpTorp < (long)uVar13) {
        *(int *)pdpBeam = (int)(uVar13 - dpTorp);
        *(undefined2 *)((int)pdpBeam + 2) = (int)(uVar13 - dpTorp >> 0x10);
      }
      else {
        *(undefined2 *)pdpBeam = 0;
        *(undefined2 *)((int)pdpBeam + 2) = 0;
      }
      *(short *)((byte *)lpbBattleCur + 6) = (&pTVar8->dv)->dp;
      lpbBattleCur =
           (byte *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur + 8);
      if (pcTorp != (long *)0x0) {
        *(int *)pcTorp = (int)cKillMax;
        *(int *)((int)pcTorp + 2) = cKillMax._2_2_;
      }
    }
  }
  return 1;
}



// ======================================================================
// Function: DxyFromSpdRound
// Address: 10f0:8b28
// Segment: MEMORY_BATTLE
// ======================================================================


short DxyFromSpdRound(ushort spd,short iRound)

{
  uint uVar1;
  short dxy;
  
  dxy = (spd + 2) / 4;
  uVar1 = spd & 3;
  if (uVar1 == 0) {
    dxy = dxy + (uint)((iRound & 1U) == 0);
  }
  else if (uVar1 == 1) {
    dxy = dxy + (uint)((iRound & 3U) != 2);
  }
  else if (uVar1 == 3) {
    dxy = dxy + (uint)((iRound & 3U) == 0);
  }
  return dxy;
}



// ======================================================================
// Function: FDoCoolBattle
// Address: 10f0:8bcc
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f098b8) */
/* WARNING: Variable defined which should be unmapped: penvMemSav_2 */

short FDoCoolBattle
          (FLEET *lpfl,short cplr,ushort *rggrfAttack,ushort grfPlayer,ushort grfSpectator)

{
  int iVar1;
  byte *pbVar2;
  PLANET *pPVar3;
  byte *pbVar4;
  short (*pasVar5) [9];
  byte *pbVar6;
  byte *pbVar7;
  undefined2 uVar8;
  short sVar9;
  uint uVar10;
  FLEET *pFVar11;
  TOK *pTVar12;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar13;
  byte *pbVar14;
  ulong uVar15;
  long lVar16;
  undefined2 uVar17;
  long lVar18;
  short (*penvMemSav_2) [9];
  short asStack_28a [6];
  uint uStack_27e;
  long lwt;
  short itok;
  ushort wtNext;
  ushort rgPlrLosses [256];
  byte rgfInit [64];
  BTLDATA *lpbtldata;
  ushort brcOrig;
  FLEET *lpflT;
  short iRound;
  BTLREC *lpbtlrec;
  short initMin;
  short j;
  short i;
  ushort grplrLeft;
  ushort wtT;
  short init;
  short initMac;
  byte *lpbSav;
  short cShdefsInvolved;
  ushort wt;
  TOK *ptok;
  byte *lpbMax;
  short cShipsInvolved;
  
  pasVar5 = penvMem;
  lVar18 = CONCAT22(unaff_SI,unaff_DI);
  if (lpbBattleLog == (byte *)0x0) {
    penvMemSav_2 = penvMem;
    penvMem = (short (*) [9])asStack_28a;
    sVar9 = __setjmp(asStack_28a);
    pbVar14 = (byte *)CONCAT22(lpbBattleT._2_2_,(byte *)lpbBattleT);
    if (sVar9 != 0) {
      sVar9 = -1;
      penvMem = pasVar5;
      pbVar2 = lpbBattleLog;
      pbVar4 = lpbBattleCur;
      goto LAB_10f0_9911;
    }
    pbVar14 = LpAlloc(0xffc8,htBattle);
    lpbBattleLog = pbVar14;
    lpbBattleCur = pbVar14;
  }
  pasVar5 = penvMem;
  pbVar14 = (byte *)CONCAT22(lpbBattleT._2_2_,(byte *)lpbBattleT);
  lpbSav = lpbBattleCur;
  if (((byte *)lpbBattleT == (byte *)0x0) &&
     (pbVar14 = (byte *)CONCAT22(lpbBattleT._2_2_,(byte *)lpbBattleT),
     lpbBattleT._2_2_ == 0)) {
    penvMemSav_2 = penvMem;
    penvMem = (short (*) [9])asStack_28a;
    sVar9 = __setjmp(asStack_28a);
    pbVar14 = (byte *)CONCAT22(lpbBattleT._2_2_,(byte *)lpbBattleT);
    if (sVar9 != 0) {
      sVar9 = -1;
      penvMem = pasVar5;
      pbVar2 = lpbBattleLog;
      pbVar4 = lpbBattleCur;
      goto LAB_10f0_9911;
    }
    pbVar14 = LpAlloc(0xffc8,htBattle);
    lpbSav = lpbBattleCur;
  }
  lpbBattleT._2_2_ = (int)((ulong)pbVar14 >> 0x10);
  lpbBattleT._0_2_ = (byte *)pbVar14;
  lpbMax._0_2_ = (byte *)lpbBattleT + -0x48;
  lpbMax._2_2_ = lpbBattleT._2_2_;
  lpbBattleT = pbVar14;
  lpbBattleCur = pbVar14;
  _memset(rgPlrLosses,0,0x200);
  vrgPlrLosses = rgPlrLosses;
  _memset(rgfInit,0,0x40);
  __fmemset((TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok),0,0x1d00);
  pbVar14 = lpbBattleCur;
  uVar8 = lpbBattleCur._2_2_;
  pbVar6 = (byte *)lpbBattleCur;
  vctok = 0;
  lpbBattleCur._0_2_ = (byte *)lpbBattleCur + 0xe;
  _memset((byte *)rgTechBattle,0,6);
  _memset((byte *)rgTechTrader,0,0xd);
  lpthBattle._0_2_ = (THING *)0x0;
  lpthBattle._2_2_ = 0;
  cShdefsInvolved = 0;
  cShipsInvolved = 0;
  fStarbaseDied = 0;
  fStarbaseDamaged = 0;
  lpflT = lpfl;
  do {
    uVar13 = (undefined2)((ulong)lpflT >> 0x10);
    pFVar11 = (FLEET *)lpflT;
    if (((uint)pFVar11->wFlags >> 10 & 1) == 0) {
      for (i = 0; i < 0x10; i = i + 1) {
        if (0 < pFVar11->rgcsh[i]) {
          cShipsInvolved = cShipsInvolved + pFVar11->rgcsh[i];
          rgPlrLosses[pFVar11->iPlayer * 0x10 + i] = 0x8000;
        }
      }
    }
                    /* WARNING: Load size is inaccurate */
    iVar1 = *(int *)((int)&pFVar11->lpflNext + 2);
    lpflT = (FLEET *)CONCAT22(iVar1,pFVar11->lpflNext);
  } while ((lpfl != lpflT) && ((pFVar11->lpflNext != (FLEET *)0x0 || (iVar1 != 0))));
  for (i = 0; i < 0x100; i = i + 1) {
    if (rgPlrLosses[i] != 0) {
      rgPlrLosses[i] = 0;
      cShdefsInvolved = cShdefsInvolved + 1;
    }
  }
  if (((FLEET *)lpfl)->idPlanet != -1) {
    lwt = (long)LpplFromId(((FLEET *)lpfl)->idPlanet);
    uVar13 = (undefined2)((ulong)lwt >> 0x10);
    pPVar3 = (PLANET *)lwt;
    if ((((uint)pPVar3->wFlags >> 9 & 1) != 0) &&
       ((1 << ((byte)pPVar3->iPlayer & 0x1f) & grfPlayer) != 0)) {
      cShdefsInvolved = cShdefsInvolved + 1;
      cShipsInvolved = cShipsInvolved + 1;
      pPVar3->wFlags = pPVar3->wFlags & 0xbfffU | 0x4000;
    }
  }
  InitializeBoard(lpfl,((cplr + -1) * cplr) / 2,grfPlayer,rgfInit,&initMin,&initMac);
  pbVar6[2] = (byte)cplr;
  pbVar6[3] = (byte)vctok;
  *(short *)(pbVar6 + 8) = ((FLEET *)lpfl)->idPlanet;
  sVar9 = (((FLEET *)lpfl)->pt).y;
  *(short *)(pbVar6 + 10) = (&((FLEET *)lpfl)->pt)->x;
  *(short *)(pbVar6 + 0xc) = sVar9;
  iVar1 = idBattle + 1;
  *(short *)pbVar14 = idBattle;
  idBattle = iVar1;
  for (iRound = 0; iRound < 0x10; iRound = iRound + 1) {
    grplrLeft = 0;
    for (itok = 0; itok < vctok; itok = itok + 1) {
      if ((((TOK *)vrgtok)[itok].wFlags & 1U) != 0) {
        grplrLeft = grplrLeft | 1 << (((TOK *)vrgtok)[itok].iplr & 0x1f);
        lwt = CONCAT22(((TOK *)vrgtok)[itok].wFlags,(undefined2)lwt) & 0xfffffff;
        ((TOK *)vrgtok)[itok].wFlags = lwt._2_2_;
        if (((0 < iRound) && (((TOK *)vrgtok)[itok].dpShield != 0)) &&
           ((((TOK *)vrgtok)[itok].wFlags & 1U) != 0)) {
          sVar9 = GetRaceGrbit((PLAYER *)rgplr +
                                     ((TOK *)vrgtok)[itok].iplr,
                                     ibitRaceRegeneratingShields);
          if (sVar9 != 0) {
            RegenShield((TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok + itok));
          }
        }
      }
    }
    if ((grplrLeft - 1 & grplrLeft) == 0) break;
    ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
    for (itok = 0; itok < vctok; itok = itok + 1) {
      uVar13 = (undefined2)((ulong)ptok >> 0x10);
      pTVar12 = (TOK *)ptok;
      if ((pTVar12->wFlags & 1U) != 0) {
        if (pTVar12->field2_0x3 == '\x01') {
          pTVar12->wFlags = pTVar12->wFlags & 0x3fff;
        }
        else {
          sVar9 = DxyFromSpdRound((uint)pTVar12->wFlags >> 8 & 0xf,iRound);
          lwt = CONCAT22(sVar9,(undefined2)lwt);
          uVar13 = (undefined2)((ulong)ptok >> 0x10);
          ((TOK *)ptok)->wFlags = ((TOK *)ptok)->wFlags & 0x3fffU | sVar9 << 0xe;
        }
      }
      ptok = (TOK *)CONCAT22(ptok._2_2_,(TOK *)ptok + 1);
    }
    for (j = 3; 0 < j; j = j + -1) {
      wt = 30000;
      i = vctok;
      do {
        wtNext = 0;
        ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
        for (itok = 0; itok < vctok; itok = itok + 1) {
          uVar13 = (undefined2)((ulong)ptok >> 0x10);
          pTVar12 = (TOK *)ptok;
          if (((pTVar12->wFlags & 1U) == 0) || (pTVar12->wt == -1)) {
            i = i + -1;
          }
          else {
            uVar10 = (uint)pTVar12->wFlags >> 10 & 0xf;
            lwt = CONCAT22(-(uint)(uVar10 < 7),uVar10 - 7);
            lwt = __aFlshl(lVar18,(ushort)penvMemSav_2);
            uVar17 = 0;
            uVar13 = 100;
            uVar15 = __aFulmul((ulong)(uint)((TOK *)ptok)->wt,lwt);
            lVar16 = __aFldiv(uVar15,CONCAT22(uVar17,uVar13));
            uVar13 = (undefined2)((ulong)ptok >> 0x10);
            lwt = lVar16 + (ulong)(uint)((TOK *)ptok)->wt;
            wtT = (ushort)lwt;
            if ((wtNext < wtT) && (wtT < wt)) {
              sVar9 = DxyFromSpdRound((uint)((TOK *)ptok)->wFlags >> 8 & 0xf,iRound);
              if (sVar9 != 0) {
                wtNext = wtT;
              }
            }
            uVar13 = lpbBattleCur._2_2_;
            pbVar7 = (byte *)lpbBattleCur;
            if (wtT == wt) {
              i = i + -1;
              uVar17 = (undefined2)((ulong)ptok >> 0x10);
              pTVar12 = (TOK *)ptok;
              if (j <= (int)((uint)pTVar12->wFlags >> 0xe)) {
                lpbtlrec = (BTLREC *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur)
                ;
                lpbBattleCur._0_2_ = (byte *)lpbBattleCur + 6;
                lpbtlrec->itok = (byte)itok;
                (pbVar7 + 2)[0] = 0;
                (pbVar7 + 2)[1] = 0;
                *(uint *)(pbVar7 + 4) = *(uint *)(pbVar7 + 4) & 0xff | itok << 8;
                *(uint *)(pbVar7 + 4) = *(uint *)(pbVar7 + 4) & 0xfff0 | iRound & 0xfU;
                uVar10 = (uint)pTVar12->wFlags >> 5;
                uStack_27e = uVar10 & 0x1f;
                *(uint *)(pbVar7 + 4) = *(uint *)(pbVar7 + 4) & 0xff0f | (uVar10 & 0xf) << 4;
                brcOrig = (ushort)((TOK *)vrgtok)[itok].brc;
                if (((uint)pTVar12->wFlags >> 8 & 0xf) == 0) {
                  brcOrig = 0xff;
                  if (((uint)pTVar12->wFlags >> 5 & 0x1f) == 0) {
                    pbVar7[1] = 0xff;
                    pTVar12->wFlags = pTVar12->wFlags & 0xfffe;
                    goto LAB_10f0_91a1;
                  }
                  uStack_27e = pTVar12->wFlags - 0x20U & 0x3e0;
                  pTVar12->wFlags = pTVar12->wFlags & 0xfc1f;
                  pTVar12->wFlags = pTVar12->wFlags | uStack_27e;
                }
                DxyMoveTokTo(ptok,j,rggrfAttack[pTVar12->iplr]);
                uVar17 = (undefined2)((ulong)ptok >> 0x10);
                pTVar12 = (TOK *)ptok;
                uStack_27e = pTVar12->wFlags + 0xc000U & 0xc000;
                pTVar12->wFlags = pTVar12->wFlags & 0x3fff;
                pTVar12->wFlags = pTVar12->wFlags | uStack_27e;
                if ((pTVar12->field2_0x3 == '\x01') ||
                   ((brcOrig == pTVar12->brc && (pTVar12->initMin != 0xff)))) {
                  lpbBattleCur._0_2_ = (byte *)lpbBattleCur + -6;
                }
                else {
                  pbVar7[1] = pTVar12->brc;
                }
              }
            }
          }
LAB_10f0_91a1:
          ptok = (TOK *)CONCAT22(ptok._2_2_,(TOK *)ptok + 1);
        }
        wt = wtNext;
      } while (wtNext != 0);
    }
    grplrLeft = 0;
    for (i = 0; i < vctok; i = i + 1) {
      if ((((TOK *)vrgtok)[i].wFlags & 1U) != 0) {
        uVar10 = Random(0xf);
        uStack_27e = (uVar10 & 0xf) << 10;
        lwt = CONCAT22(uVar10,uStack_27e);
        uStack_27e = ((TOK *)vrgtok)[i].wFlags & 0xc3ffU | uStack_27e;
        ((TOK *)vrgtok)[i].wFlags = uStack_27e;
        grplrLeft = grplrLeft | 1 << (((TOK *)vrgtok)[i].iplr & 0x1f);
      }
    }
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (((1 << ((byte)i & 0x1f) & grplrLeft) != 0) && ((grplrLeft & rggrfAttack[i]) == 0)) {
        grplrLeft = grplrLeft & ~(1 << ((byte)i & 0x1f));
      }
    }
    if ((grplrLeft - 1 & grplrLeft) == 0) break;
    for (init = initMac; initMin <= init; init = init + -1) {
      iVar1 = vctok;
      if (rgfInit[init] != 0) {
        while (uVar17 = vrgtok._2_2_, uVar13 = lpbBattleCur._2_2_,
              pbVar7 = (byte *)lpbBattleCur, itok = iVar1 + -1, -1 < itok) {
          iVar1 = itok;
          if (((int)(uint)((TOK *)vrgtok)[itok].initMin <= init) &&
             (init <= (int)(uint)((TOK *)vrgtok)[itok].initMac)) {
            grplrLeft = 0;
            for (i = 0; i < vctok; i = i + 1) {
              if ((((TOK *)vrgtok)[i].wFlags & 1U) != 0) {
                grplrLeft = grplrLeft | 1 << (((TOK *)vrgtok)[i].iplr & 0x1f);
              }
            }
            if ((grplrLeft - 1 & grplrLeft) == 0) break;
            pTVar12 = (TOK *)vrgtok + itok;
            ptok = (TOK *)CONCAT22(vrgtok._2_2_,pTVar12);
            if ((pTVar12->wFlags & 1U) != 0) {
              lpbtlrec = (BTLREC *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur);
              lpbBattleCur._0_2_ = (byte *)lpbBattleCur + 6;
              lpbtlrec->itok = (byte)itok;
              (pbVar7 + 2)[0] = 0;
              (pbVar7 + 2)[1] = 0;
              *(uint *)(pbVar7 + 4) = *(uint *)(pbVar7 + 4) & 0xfff0 | iRound & 0xfU;
              pbVar7[1] = pTVar12->brc;
              *(uint *)(pbVar7 + 4) = *(uint *)(pbVar7 + 4) & 0xff | itok * 0x100;
              lwt = CONCAT22((uint)pTVar12->wFlags >> 5,(undefined2)lwt) & 0x1fffff;
              *(uint *)(pbVar7 + 4) = *(uint *)(pbVar7 + 4) & 0xff0f | (lwt._2_2_ & 0xf) << 4;
              sVar9 = FAttack(itok,init,(BTLREC *)CONCAT22(uVar13,pbVar7),rggrfAttack[pTVar12->iplr]
                             );
              iVar1 = itok;
              if (sVar9 == 0) {
                lpbBattleCur._0_2_ = (byte *)lpbBattleCur + -6;
              }
              else {
                uVar13 = (undefined2)((ulong)ptok >> 0x10);
                ((TOK *)ptok)->wFlags = ((TOK *)ptok)->wFlags & 0xffef;
              }
            }
          }
        }
      }
    }
    if ((grplrLeft - 1 & grplrLeft) == 0) break;
  }
  *(int *)(pbVar6 + 6) = (int)(byte *)lpbBattleCur - (int)pbVar6;
  SendBattleMessages(lpfl,cplr,*(short *)pbVar14,rgPlrLosses,grfPlayer,cShipsInvolved,
                     cShdefsInvolved,grfSpectator);
  *(ushort *)(pbVar6 + 4) = grfPlayer;
  lwt = CONCAT22(-(uint)((byte *)0xffc8 < (byte *)lpbSav),-(int)(byte *)lpbSav - 0x38U);
  if ((-(uint)((byte *)0xffc8 < (byte *)lpbSav) == 0) &&
     (-(int)(byte *)lpbSav - 0x38U < *(uint *)(pbVar6 + 6))) {
    lpbSav[0] = 0xff;
    lpbSav[1] = 0xff;
    lpbBattleT = (byte *)0x0;
  }
  else {
    __fmemmove(lpbSav,pbVar14,*(ushort *)(pbVar6 + 6));
    lpbBattleCur._0_2_ = (byte *)lpbSav + *(int *)(pbVar6 + 6);
    lpbBattleCur._2_2_ = lpbSav._2_2_;
  }
  sVar9 = 1;
  pbVar2 = lpbBattleLog;
  pbVar14 = lpbBattleT;
  pbVar4 = (byte *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur);
LAB_10f0_9911:
  lpbBattleCur._2_2_ = (undefined2)((ulong)pbVar4 >> 0x10);
  lpbBattleCur._0_2_ = (byte *)pbVar4;
  lpbBattleT._2_2_ = (int)((ulong)pbVar14 >> 0x10);
  lpbBattleT._0_2_ = (byte *)pbVar14;
  lpbBattleLog._2_2_ = (undefined2)((ulong)pbVar2 >> 0x10);
  lpbBattleLog._0_2_ = (byte *)pbVar2;
  return sVar9;
}



// ======================================================================
// Function: ITechLearnATech
// Address: 10f0:9918
// Segment: MEMORY_BATTLE
// ======================================================================


short ITechLearnATech(short iplr,short x,short y,MessageId idm,ushort *piGoto)

{
  uint *puVar1;
  uint uVar2;
  short sVar3;
  short sVar4;
  uint *puVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar6;
  ulong uVar7;
  undefined4 uVar8;
  long lVar9;
  ushort in_stack_0000ffec;
  long l;
  short iTech;
  short i;
  short fBattle;
  ushort iGoto;
  
  lVar9 = CONCAT22(unaff_SI,unaff_DI);
  if (((*(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) >> 3 & 1) == 0) &&
     (sVar3 = Random(100), 0x31 < sVar3)) {
    for (i = 0; i < 0xd; i = i + 1) {
      sVar3 = Random(0xd);
      if (((((byte *)rgTechTrader)[sVar3] != 0) &&
          ((1 << ((byte)sVar3 & 0x1f) &
           *(uint *)((int)&rgplr[0].grbitTrader + iplr * 0xc0)) == 0)) &&
         (sVar4 = Random(100), sVar4 < (int)(uint)((byte *)rgTechTrader)[sVar3]))
      {
        sVar4 = IdmGiveTraderPart(1 << ((byte)sVar3 & 0x1f),iplr,&iGoto);
        if (idm != ~idmColonistsDroppedMassacredGroundTroops) {
          FSendPlrMsg2(iplr,sVar4 + idmStarbaseHasBuiltNew,iGoto,x,y);
        }
        else if (piGoto != (ushort *)0x0) {
          *piGoto = iGoto;
        }
        *(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) =
             *(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) & 0xfff7 | 8;
        return -(sVar3 + 1);
      }
    }
    for (i = 0; i < 6; i = i + 1) {
      sVar3 = Random(6);
      if ((int)*(char *)(iplr * 0xc0 + 0x59bc + sVar3) <
          (int)(uint)((byte *)rgTechBattle)[sVar3]) {
        lVar6 = GetTechLevelCost(sVar3,*(char *)(iplr * 0xc0 + 0x59bc + sVar3) + 1,iplr);
        if (((uint)game.wCrap >> 1 & 1) != 0) {
          lVar6 = __aFlshr(lVar9,in_stack_0000ffec);
        }
        l._2_2_ = (int)((ulong)lVar6 >> 0x10);
        l._0_2_ = (uint)lVar6;
        puVar5 = (uint *)(iplr * 0xc0 + 0x59c2 + sVar3 * 4);
        puVar1 = puVar5;
        uVar2 = *puVar1;
        *puVar1 = *puVar1 + (uint)l;
        puVar1 = puVar5 + 1;
        *puVar1 = *puVar1 + l._2_2_ + (uint)CARRY2(uVar2,(uint)l);
        if (idm != ~idmColonistsDroppedMassacredGroundTroops) {
          if (((uint)game.wCrap >> 1 & 1) != 0) {
            lVar6 = __aFlshl(lVar9,(uint)l);
          }
          uVar8 = 0;
          uVar7 = __aFulshr(0,(ushort)lVar9);
          l._0_2_ = (uint)lVar6;
          FSendPlrMsg(iplr,idm,-2,x,y,sVar3,(uint)l,(short)uVar7,(short)uVar8,
                           (short)((ulong)uVar8 >> 0x10));
        }
        else if (piGoto != (ushort *)0x0) {
          *piGoto = 0xfffe;
        }
        *(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) =
             *(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) & 0xfff7 | 8;
        return sVar3 + 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: SendBattleMessages
// Address: 10f0:9c0e
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f0ab9e) */

void SendBattleMessages
          (FLEET *lpflBtl,short cplr,short idBtl,ushort *rgPlrLosses,short grfPlayer,
          short cShipsInvolved,short cShdefsInvolved,ushort grfSpectator)

{
  int iVar1;
  PLANET *pPVar2;
  bool bVar3;
  short sVar4;
  uint uVar5;
  FLEET *pFVar6;
  ushort unaff_DI;
  undefined2 uVar7;
  ulong uVar8;
  undefined4 uVar9;
  short x;
  short cThem;
  ushort *pwUs;
  short iThem;
  short cUsDead;
  FLEET *lpflT;
  short j;
  short idm;
  short i;
  short cThemDead;
  FLEET *lpfl;
  short y;
  short cUs;
  short fAlive;
  ushort *pwThem;
  PLANET *lppl;
  short isb;
  ushort *pw;
  long lpopStarbase;
  byte rgcfl [16];
  short iplr;
  short iplrStarbase;
  
  iplrStarbase = -1;
  lppl = (PLANET *)0x0;
  _memset(rgcfl,0,0x10);
  uVar7 = (undefined2)((ulong)lpflBtl >> 0x10);
  pFVar6 = (FLEET *)lpflBtl;
  if (pFVar6->idPlanet == -1) {
    x = (&pFVar6->pt)->x;
    y = (pFVar6->pt).y;
  }
  else {
    x = -1;
    y = pFVar6->idPlanet;
    lppl = LpplFromId(y);
    uVar7 = (undefined2)((ulong)lppl >> 0x10);
    pPVar2 = (PLANET *)lppl;
    iThem = pPVar2->iPlayer;
    if (iThem != -1) {
      if ((((uint)pPVar2->wFlags >> 9 & 1) != 0) || (fStarbaseDied != 0)) {
        isb = *(uint *)&pPVar2->field11_0x2c & 0xf;
        iplrStarbase = iThem;
      }
      if ((fStarbaseDied != 0) &&
         (sVar4 = GetRaceStat((PLAYER *)rgplr + pPVar2->iPlayer,rsMajorAdv),
         sVar4 == 8)) {
        lpopStarbase._0_2_ = *(uint *)(pPVar2->rgwtMin + 3);
        lpopStarbase._2_2_ = *(int *)((int)pPVar2->rgwtMin + 0xe);
        UninhabitPlanet(lppl);
      }
    }
  }
  lpfl = lpflBtl;
  do {
    uVar7 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar6 = (FLEET *)lpfl;
    if (((uint)pFVar6->wFlags >> 10 & 1) == 0) {
      for (i = 0; i < 0x10; i = i + 1) {
        if (0 < pFVar6->rgcsh[i]) {
          rgPlrLosses[pFVar6->iPlayer * 0x10 + i] = rgPlrLosses[pFVar6->iPlayer * 0x10 + i] | 0x4000
          ;
        }
      }
    }
                    /* WARNING: Load size is inaccurate */
    iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
    lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
  } while ((lpflBtl != lpfl) && ((pFVar6->lpflNext != (FLEET *)0x0 || (iVar1 != 0))));
  iplr = 0;
  do {
    if (game.cPlayer <= iplr) {
      return;
    }
    if ((1 << ((byte)iplr & 0x1f) & grfPlayer) == 0) {
      if ((((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) ||
         (((PLANET *)lppl)->iPlayer != iplr)) {
        if ((iplr & grfSpectator) != 0) {
          lpfl = lpflBtl;
          while( true ) {
            uVar7 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar6 = (FLEET *)lpfl;
            if (pFVar6->iPlayer == iplr) break;
                    /* WARNING: Load size is inaccurate */
            iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
            lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
            if ((lpflBtl == lpfl) || ((pFVar6->lpflNext == (FLEET *)0x0 && (iVar1 == 0)))) break;
          }
          if ((((FLEET *)lpfl != (FLEET *)0x0) || (lpfl._2_2_ != 0)) &&
             (((FLEET *)lpfl)->iPlayer == iplr)) {
            FSendPlrMsg(iplr,idmReportsBattleTookPlaceForcesInvolved,lpfl->id | 0x8000,lpfl->id
                             ,(&((FLEET *)lpfl)->pt)->x,(((FLEET *)lpfl)->pt).y,0,0,0,0);
            ITechLearnATech(iplr,x,y,idmWreckageBattleOccurredOrbitHasBoostedResearch,(ushort *)0x0)
            ;
          }
        }
      }
      else {
        FSendPlrMsg2(iplr,idmColonyReportsBattleTookPlaceOrbitForces,lppl->id,lppl->id,0);
        ITechLearnATech(iplr,x,y,idmFleetFoundWreckageBattleWhichHasBoosted,(ushort *)0x0);
      }
LAB_10f0_ad23:
      if ((1 << ((byte)iplr & 0x1f) & grfMissed) != 0) {
        lpfl = lpflBtl;
        while( true ) {
          uVar7 = (undefined2)((ulong)lpfl >> 0x10);
          pFVar6 = (FLEET *)lpfl;
          if ((pFVar6->iPlayer == iplr) && (((uint)pFVar6->wFlags >> 7 & 1) != 0)) break;
                    /* WARNING: Load size is inaccurate */
          iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
          lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
          if ((lpflBtl == lpfl) || ((pFVar6->lpflNext == (FLEET *)0x0 && (iVar1 == 0)))) break;
        }
        if ((((FLEET *)lpfl != (FLEET *)0x0) || (lpfl._2_2_ != 0)) &&
           ((((FLEET *)lpfl)->iPlayer == iplr && (((uint)((FLEET *)lpfl)->wFlags >> 7 & 1) != 0))))
        {
          FSendPlrMsg2(iplr,idmDueExcessiveFleetManeuveringBattleAreaFleets,lpfl->id | 0x8000,x
                            ,y);
        }
      }
    }
    else {
      bVar3 = true;
      if ((fStarbaseDied == 0) ||
         (sVar4 = GetRaceStat((PLAYER *)rgplr + iplrStarbase,rsMajorAdv), sVar4 != 8
         )) {
        if (cplr == 2) {
          if (cShipsInvolved == 2) {
            pwThem = (ushort *)0x0;
            pwUs = (ushort *)0x0;
            pw = rgPlrLosses;
            for (i = 0; i < 0x10; i = i + 1) {
              for (j = 0; j < 0x10; j = j + 1) {
                if (*pw != 0) {
                  if (i == iplr) {
                    pwUs = pw;
                  }
                  else {
                    pwThem = pw;
                  }
                }
                pw = pw + 1;
              }
            }
            if (((pwUs == (ushort *)0x0) && (fStarbaseDied != 0)) ||
               ((pwUs != (ushort *)0x0 && ((*pwUs & 0x3fff) != 0)))) {
              if (((pwThem == (ushort *)0x0) && (fStarbaseDamaged != 0)) ||
                 ((pwThem != (ushort *)0x0 && ((*pwThem & 0x8000) != 0)))) {
                idm = 0x94;
              }
              else {
                idm = 0x92;
              }
              bVar3 = false;
            }
            else if (((pwThem == (ushort *)0x0) && (fStarbaseDied != 0)) ||
                    ((pwThem != (ushort *)0x0 && ((*pwThem & 0x3fff) != 0)))) {
              if (((pwUs == (ushort *)0x0) && (fStarbaseDamaged != 0)) ||
                 ((pwUs != (ushort *)0x0 && ((*pwUs & 0x8000) != 0)))) {
                idm = 0x93;
              }
              else {
                idm = 0x91;
              }
            }
            else {
              idm = 0x95;
            }
            if (pwUs == (ushort *)0x0) {
              i = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwUs - (int)rgPlrLosses >> 1;
              i = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
            if (pwThem == (ushort *)0x0) {
              j = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwThem - (int)rgPlrLosses >> 1;
              j = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
            FSendPlrMsg(iplr,idm,idBtl | 0x4000,x,y,i,j,0,0,0);
            if ((bVar3) &&
               (((((PLANET *)lppl == (PLANET *)0x0 && (lppl._2_2_ == 0)) ||
                 (((PLANET *)lppl)->iPlayer == -1)) || (iplr == ((PLANET *)lppl)->iPlayer)))) {
              ITechLearnATech(iplr,x,y,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                              (ushort *)0x0);
            }
          }
          else {
            if (cShdefsInvolved != 2) goto BATTLE_CommonCountingCode;
            pwThem = (ushort *)0x0;
            pwUs = (ushort *)0x0;
            pw = rgPlrLosses;
            for (i = 0; i < 0x10; i = i + 1) {
              for (j = 0; j < 0x10; j = j + 1) {
                if (*pw != 0) {
                  if (i == iplr) {
                    pwUs = pw;
                  }
                  else {
                    pwThem = pw;
                  }
                }
                pw = pw + 1;
              }
            }
            if (((pwUs == (ushort *)0x0) && (fStarbaseDied != 0)) ||
               ((pwUs != (ushort *)0x0 && ((*pwUs & 0x4000) == 0)))) {
              if (((pwThem == (ushort *)0x0) && (fStarbaseDamaged != 0)) ||
                 ((pwThem != (ushort *)0x0 && ((*pwThem & 0x8000) != 0)))) {
                idm = 0x99;
              }
              else {
                idm = 0x97;
              }
              bVar3 = false;
            }
            else if (((pwThem == (ushort *)0x0) && (fStarbaseDied != 0)) ||
                    ((pwThem != (ushort *)0x0 && ((*pwThem & 0x4000) == 0)))) {
              if (((pwUs == (ushort *)0x0) && (fStarbaseDamaged != 0)) ||
                 ((pwUs != (ushort *)0x0 && ((*pwUs & 0x8000) != 0)))) {
                idm = 0x98;
              }
              else {
                idm = 0x96;
              }
            }
            else {
              idm = 0x9a;
            }
            if (pwUs == (ushort *)0x0) {
              cUs = 1;
            }
            else {
              cUs = *pwUs & 0x1fff;
            }
            if (pwThem == (ushort *)0x0) {
              cThem = 1;
            }
            else {
              cThem = *pwThem & 0x1fff;
            }
            lpfl = lpflBtl;
            do {
              uVar7 = (undefined2)((ulong)lpfl >> 0x10);
              pFVar6 = (FLEET *)lpfl;
              if (((uint)pFVar6->wFlags >> 10 & 1) == 0) {
                if ((pFVar6->iPlayer == iplr) && (pwUs != (ushort *)0x0)) {
                  cUs = cUs + *(int *)((int)pFVar6 +
                                      (((int)pwUs - (int)rgPlrLosses >> 1) + pFVar6->iPlayer * -0x10
                                      ) * 2 + 0xc);
                }
                else if (pwThem != (ushort *)0x0) {
                  cThem = cThem + *(int *)((int)pFVar6 +
                                          (((int)pwThem - (int)rgPlrLosses >> 1) +
                                          pFVar6->iPlayer * -0x10) * 2 + 0xc);
                }
              }
                    /* WARNING: Load size is inaccurate */
              iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
              lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
            } while ((lpflBtl != lpfl) && ((pFVar6->lpflNext != (FLEET *)0x0 || (iVar1 != 0))));
            if (pwUs == (ushort *)0x0) {
              i = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwUs - (int)rgPlrLosses >> 1;
              i = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
            if (pwThem == (ushort *)0x0) {
              j = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwThem - (int)rgPlrLosses >> 1;
              j = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
            FSendPlrMsg(iplr,idm,idBtl | 0x4000,x,y,i,cUs,j,cThem,0);
            if ((bVar3) &&
               (((((PLANET *)lppl == (PLANET *)0x0 && (lppl._2_2_ == 0)) ||
                 (((PLANET *)lppl)->iPlayer == -1)) || (iplr == ((PLANET *)lppl)->iPlayer)))) {
              ITechLearnATech(iplr,x,y,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                              (ushort *)0x0);
            }
          }
        }
        else {
BATTLE_CommonCountingCode:
          cThem = 0;
          cUs = 0;
          pw = rgPlrLosses;
          for (i = 0; i < 0x10; i = i + 1) {
            for (j = 0; j < 0x10; j = j + 1) {
              if (*pw != 0) {
                if (i == iplr) {
                  pwUs = pw;
                  cUs = cUs + (*pw & 0x1fff);
                }
                else {
                  pwThem = pw;
                  cThem = cThem + (*pw & 0x1fff);
                  iThem = i;
                }
              }
              pw = pw + 1;
            }
          }
          iThem = iThem | 0x30;
          cUsDead = cUs;
          cThemDead = cThem;
          if (fStarbaseDied != 0) {
            if (iplrStarbase == iplr) {
              cUsDead = cUs + 1;
            }
            else if (iplrStarbase != -1) {
              cThemDead = cThem + 1;
            }
          }
          lpfl = lpflBtl;
          do {
            uVar7 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar6 = (FLEET *)lpfl;
            if (((uint)pFVar6->wFlags >> 10 & 1) == 0) {
              if (pFVar6->iPlayer == iplr) {
                for (i = 0; i < 0x10; i = i + 1) {
                  cUs = cUs + pFVar6->rgcsh[i];
                }
              }
              else {
                for (i = 0; i < 0x10; i = i + 1) {
                  cThem = cThem + pFVar6->rgcsh[i];
                }
              }
            }
                    /* WARNING: Load size is inaccurate */
            iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
            lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
          } while ((lpflBtl != lpfl) && ((pFVar6->lpflNext != (FLEET *)0x0 || (iVar1 != 0))));
          if (iplrStarbase == iplr) {
            cUs = cUs + 1;
          }
          else if (iplrStarbase != -1) {
            cThem = cThem + 1;
            iThem = iplrStarbase | 0x30;
          }
          if (cplr != 2) {
            if (cUsDead == 0) {
              if (cThem == cThemDead) {
                FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesForcesDestroyed,idBtl | 0x4000
                                 ,x,y,cplr,cUs,0,0,0);
              }
              else {
BATTLE_IndecisiveXWay:
                FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesLostForces2,idBtl | 0x4000,x,y
                                 ,cplr,cUsDead,cUs,cThemDead,cThem);
              }
            }
            else if (cThemDead == 0) {
              if (cUs != cUsDead) goto BATTLE_IndecisiveXWay;
              FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesEntireArmada,idBtl | 0x4000,x,y,
                               cplr,cUs,cThem,0,0);
            }
            else if (cThemDead == cThem) {
              FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesLostForces,idBtl | 0x4000,x,y,
                               cplr,cUsDead,cUs,0,0);
            }
            else if (cUsDead == cUs) {
              FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesEntireArmada2,idBtl | 0x4000,x,y
                               ,cplr,cUs,cThem,cThemDead,0);
            }
            else {
              FSendPlrMsg2(iplr,idmBattleTookPlacePressGotoButtonView,idBtl | 0x4000,x,y);
            }
            if (((((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) ||
                (((PLANET *)lppl)->iPlayer == -1)) || (iplr == ((PLANET *)lppl)->iPlayer)) {
              ITechLearnATech(iplr,x,y,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                              (ushort *)0x0);
            }
            goto LAB_10f0_ad23;
          }
          if (cThem == 1) {
            if ((iThem & 0xfU) == iplrStarbase) {
              j = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwThem - (int)rgPlrLosses >> 1;
              j = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
          }
          if (cUs == 1) {
            if (iplr == iplrStarbase) {
              i = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwUs - (int)rgPlrLosses >> 1;
              i = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
          }
          if (cThemDead == cThem) {
            if (cThemDead == 1) {
              if (cUsDead == 0) {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedTaking,idBtl | 0x4000,
                                 x,y,iThem,cUs,j,0,0);
              }
              else {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedHowever,idBtl | 0x4000
                                 ,x,y,iThem,cUs,j,cUsDead,0);
              }
            }
            else if (cUsDead == 0) {
              if (cUs == 1) {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstDestroyedEnemyForces,idBtl | 0x4000,x
                                 ,y,iThem,i,cThemDead,0,0);
              }
              else {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedEnemy,idBtl | 0x4000,x
                                 ,y,iThem,cUs,0,0,0);
              }
            }
            else {
              FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedEnemy2,idBtl | 0x4000,x,
                               y,iThem,cUs,cUsDead,0,0);
            }
          }
          else if (cUsDead == cUs) {
            if (cUsDead == 1) {
              if (cThemDead == 0) {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstDestroyedEnemysForces,idBtl | 0x4000,
                                 x,y,iThem,i,cThem,0,0);
              }
              else {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstDestroyedEnemysForces2,idBtl | 0x4000
                                 ,x,y,iThem,i,cThem,cThemDead,0);
              }
            }
            else if (cThemDead == 0) {
              if (cThem == 1) {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyed,idBtl | 0x4000,x,y,
                                 iThem,cUsDead,j,0,0);
              }
              else {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedEnemys,idBtl | 0x4000,
                                 x,y,iThem,cThem,0,0,0);
              }
            }
            else {
              FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedEnemys2,idBtl | 0x4000,x
                               ,y,iThem,cThem,cThemDead,0,0);
            }
          }
          else if (cUs == 1) {
            FSendPlrMsg(iplr,idmBattleTookPlaceAgainstNeitherNorEnemys,idBtl | 0x4000,x,y,iThem
                             ,i,cThem,cThemDead,0);
          }
          else if (cThem == 1) {
            FSendPlrMsg(iplr,idmBattleTookPlaceAgainstNeitherForcesNor2,idBtl | 0x4000,x,y,
                             iThem,cUs,j,cUsDead,0);
          }
          else {
            FSendPlrMsg(iplr,idmBattleTookPlaceAgainstNeitherForcesNor,idBtl | 0x4000,x,y,iThem
                             ,cUs,cThem,cUsDead,cThemDead);
          }
          if ((cUsDead != cUs) &&
             ((((PLANET *)lppl == (PLANET *)0x0 && (lppl._2_2_ == 0)) ||
              ((((PLANET *)lppl)->iPlayer == -1 || (iplr == ((PLANET *)lppl)->iPlayer)))))) {
            ITechLearnATech(iplr,x,y,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                            (ushort *)0x0);
          }
        }
      }
      else {
        if (iplr == iplrStarbase) {
          if ((lpopStarbase._2_2_ < 0) || ((lpopStarbase._2_2_ < 1 && ((uint)lpopStarbase < 0x3e9)))
             ) {
            idm = 0x8e;
          }
          else {
            idm = 0x8d;
          }
        }
        else {
          idm = 0x144;
        }
        j = iplrStarbase << 5 | isb + 0x10U;
        uVar9 = 0;
        uVar8 = __aFulshr(0,unaff_DI);
        FSendPlrMsg(iplr,idm,idBtl | 0x4000,x,y,j,(uint)lpopStarbase,(short)uVar8,(short)uVar9,
                         (short)((ulong)uVar9 >> 0x10));
      }
    }
    iplr = iplr + 1;
  } while( true );
}



// ======================================================================
// Function: FAttackPlayer
// Address: 10f0:ae06
// Segment: MEMORY_BATTLE
// ======================================================================


short FAttackPlayer(FLEET *lpfl,short iplr)

{
  int iVar1;
  uint uVar2;
  undefined2 uVar3;
  short iplrT;
  short iplrCur;
  
  uVar3 = (undefined2)((ulong)lpfl >> 0x10);
  iVar1 = ((FLEET *)lpfl)->iPlayer;
  uVar2 = (uint)((BTLPLAN **)rglpbtlplan)[iVar1 * 2][((FLEET *)lpfl)->iplan].wFlags >> 8 &
          0x1f;
  if (uVar2 == 0) {
    uVar2 = 0;
  }
  else if (uVar2 == 1) {
    uVar2 = (uint)(*(char *)(iVar1 * 0xc0 + 0x5a12 + iplr) == '\x02');
  }
  else if (uVar2 == 2) {
    uVar2 = (uint)(*(char *)(iVar1 * 0xc0 + 0x5a12 + iplr) != '\x01');
  }
  else if (uVar2 == 3) {
    uVar2 = 1;
  }
  else {
    uVar2 = (uint)(iplr == uVar2 - 4);
  }
  return uVar2;
}



// ======================================================================
// Function: DoBombing
// Address: 10f0:aefa
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f0b098) */
/* WARNING: Removing unreachable block (ram,0x10f0bd6f) */
/* WARNING: Removing unreachable block (ram,0x10f0b9fa) */
/* WARNING: Removing unreachable block (ram,0x10f0b289) */
/* WARNING: Removing unreachable block (ram,0x10f0b063) */
/* WARNING: Removing unreachable block (ram,0x10f0b46a) */
/* WARNING: Removing unreachable block (ram,0x10f0b1ff) */
/* WARNING: Removing unreachable block (ram,0x10f0b5d9) */
/* WARNING: Removing unreachable block (ram,0x10f0ba57) */
/* WARNING: Removing unreachable block (ram,0x10f0b76f) */
/* WARNING: Removing unreachable block (ram,0x10f0b377) */
/* WARNING: Removing unreachable block (ram,0x10f0b0cd) */
/* WARNING: Removing unreachable block (ram,0x10f0b583) */
/* WARNING: Removing unreachable block (ram,0x10f0b102) */
/* WARNING: Removing unreachable block (ram,0x10f0b498) */
/* WARNING: Removing unreachable block (ram,0x10f0b2af) */
/* WARNING: Removing unreachable block (ram,0x10f0b39d) */
/* WARNING: Removing unreachable block (ram,0x10f0b481) */
/* WARNING: Removing unreachable block (ram,0x10f0b500) */
/* WARNING: Removing unreachable block (ram,0x10f0b5a6) */
/* WARNING: Removing unreachable block (ram,0x10f0b5f0) */
/* WARNING: Removing unreachable block (ram,0x10f0b616) */
/* WARNING: Removing unreachable block (ram,0x10f0b642) */
/* WARNING: Type propagation algorithm not settling */
/* WARNING: Removing unreachable block (ram,0x10f0b669) */
/* WARNING: Removing unreachable block (ram,0x10f0b691) */
/* WARNING: Removing unreachable block (ram,0x10f0b6ff) */

void DoBombing(void)

{
  int *piVar1;
  uint *puVar2;
  undefined2 *puVar3;
  FLEET *pFVar4;
  qword qVar5;
  short sVar6;
  uint uVar7;
  uint uVar8;
  int iVar9;
  uint uVar10;
  MessageId MVar11;
  int iVar12;
  PLANET *pPVar13;
  char *pcVar14;
  char *pcVar15;
  undefined2 unaff_SI;
  ushort unaff_DI;
  undefined2 uVar16;
  bool bVar17;
  long lVar18;
  ulong uVar19;
  ulong uVar20;
  long lVar21;
  undefined2 uVar22;
  short sVar23;
  undefined2 uVar24;
  short sVar25;
  uint in_stack_0000ffa4;
  int in_stack_0000ffa6;
  double pctSuccessHalf;
  short i;
  short dChg;
  short pctTot;
  long dmgPeopleSmart;
  float pctSuccess;
  float pctSmart;
  long dmgBombPeople;
  long cPPE;
  FLEET *lpfl;
  short ifl;
  PLANET *lppl;
  long pctTerra;
  long cKillFact;
  long cKillDefenses;
  short idmSrc;
  long dmgBombFloor;
  long cKillMine;
  long cKillPeopleS;
  long dmgBombBldg;
  long cKillPeople;
  short fMulti;
  long modKill;
  short idmDst;
  
  ifl = 0;
  do {
    if (cFleet <= ifl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pFVar4 = ((FLEET **)rglpfl)[ifl];
    iVar12 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar12,pFVar4);
    if ((pFVar4 == (FLEET *)0x0) && (iVar12 == 0)) {
      return;
    }
    if (((((uint)pFVar4->wFlags >> 10 & 1) == 0) && (pFVar4->idPlanet != -1)) &&
       (((uint)pFVar4->wFlags >> 0xc & 1) == 0)) {
      pPVar13 = (PLANET *)lpPlanets + pFVar4->idPlanet;
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,pPVar13);
      if ((pPVar13->iPlayer != pFVar4->iPlayer) && (pPVar13->iPlayer != -1)) {
        sVar6 = FAttackPlayer((FLEET *)CONCAT22(iVar12,pFVar4),pPVar13->iPlayer);
        if ((sVar6 != 0) && (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) == 0)) {
          sVar6 = FCalcFleetBombDamage
                            (lpfl,&dmgBombPeople,&dmgBombFloor,&dmgPeopleSmart,&dmgBombBldg,
                             &pctTerra,&fMulti);
          if (sVar6 != 0) {
            CalcPctSurvive(lppl,&pctSuccess,&pctSmart);
            bVar17 = (undefined1 *)0xfff7 < &stack0xff98;
            __aFfcompp();
            if (bVar17) {
              lVar21 = dmgBombFloor;
              if (0 < dmgBombPeople) {
                lVar21 = __ftol((double)CONCAT26(in_stack_0000ffa6,
                                                         CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                dmgBombPeople = lVar21;
                lVar21 = dmgBombFloor;
              }
              lVar18 = dmgPeopleSmart;
              if (0 < lVar21) {
                dmgBombFloor = lVar21;
                lVar21 = __ftol((double)CONCAT26(in_stack_0000ffa6,
                                                         CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                lVar18 = dmgPeopleSmart;
              }
              if (0 < lVar18) {
                dmgBombFloor = lVar21;
                dmgPeopleSmart = lVar18;
                lVar18 = __ftol((double)CONCAT26(in_stack_0000ffa6,
                                                         CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                lVar21 = dmgBombFloor;
              }
              dmgPeopleSmart = lVar18;
              dmgBombFloor = lVar21;
              if (0 < dmgBombBldg) {
                lVar21 = __ftol((double)CONCAT26(in_stack_0000ffa6,
                                                         CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                dmgBombBldg = lVar21;
              }
            }
            uVar10 = *(uint *)&((PLANET *)lppl)->dwFlags & 0xfff;
            uVar19 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
            in_stack_0000ffa4 = (uint)uVar19 & 0xfff;
            in_stack_0000ffa6 = 0;
            uVar19 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
            uVar7 = (uint)uVar19 & 0xfff;
            uVar8 = uVar7 + in_stack_0000ffa4;
            cPPE._0_2_ = uVar8 + uVar10;
            cPPE._2_2_ = in_stack_0000ffa6 + (uint)CARRY2(uVar7,in_stack_0000ffa4) +
                         (uint)CARRY2(uVar8,uVar10);
            cKillDefenses._0_2_ = 0;
            cKillDefenses._2_2_ = 0;
            cKillDefenses = 0;
            cKillPeople._0_2_ = 0;
            cKillPeople._2_2_ = 0;
            cKillMine._0_2_ = 0;
            cKillMine._2_2_ = 0;
            uVar19 = 0;
            cKillFact._0_2_ = 0;
            cKillFact._2_2_ = 0;
            cKillFact = 0;
            if (((0 < dmgBombBldg) &&
                (cKillFact = 0, cKillDefenses = 0, uVar19 = 0, -1 < cPPE._2_2_)) &&
               ((0 < cPPE._2_2_ || (cKillFact = 0, cKillDefenses = 0, uVar19 = 0, (int)cPPE != 0))))
            {
              uVar19 = dmgBombBldg;
              uVar20 = __aFulshr(dmgBombBldg,unaff_DI);
              cKillFact = __aFulmul((ulong)((uint)uVar20 & 0xfff),uVar19);
              lVar21 = __aFlrem(cKillFact,CONCAT22(cPPE._2_2_,(int)cPPE));
              modKill = lVar21;
              lVar21 = __aFldiv(cKillFact,CONCAT22(cPPE._2_2_,(int)cPPE));
              if (0 < modKill) {
                cKillFact = lVar21;
                sVar6 = Random((int)cPPE);
                lVar21 = cKillFact + (ulong)(sVar6 < modKill);
              }
              cKillFact = lVar21;
              uVar19 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              if ((-1 < cKillFact) &&
                 ((0xffff < cKillFact || (((uint)uVar19 & 0xfff) < (uint)cKillFact)))) {
                uVar19 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
                cKillFact = (long)((uint)uVar19 & 0xfff);
              }
              cKillDefenses =
                   __aFulmul((ulong)(*(uint *)&((PLANET *)lppl)->dwFlags & 0xfff),
                                     dmgBombBldg);
              lVar21 = __aFlrem(cKillDefenses,CONCAT22(cPPE._2_2_,(int)cPPE));
              modKill = lVar21;
              uVar19 = __aFldiv(cKillDefenses,CONCAT22(cPPE._2_2_,(int)cPPE));
              if (0 < modKill) {
                cKillDefenses = uVar19;
                sVar6 = Random((int)cPPE);
                uVar19 = cKillDefenses + (ulong)(sVar6 < modKill);
              }
              cKillDefenses._0_2_ = (uint)uVar19;
              uVar16 = (undefined2)((ulong)lppl >> 0x10);
              if ((-1 < (long)uVar19) &&
                 ((0xffff < (long)uVar19 ||
                  ((*(uint *)&((PLANET *)lppl)->dwFlags & 0xfff) < (uint)cKillDefenses)))) {
                uVar19 = (ulong)(*(uint *)&((PLANET *)lppl)->dwFlags & 0xfff);
              }
              cKillMine = dmgBombBldg - (cKillFact + uVar19);
              cKillDefenses = uVar19;
              uVar20 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              uVar19 = cKillMine;
              if ((-1 < cKillMine) &&
                 ((0xffff < cKillMine || (((uint)uVar20 & 0xfff) < (uint)cKillMine)))) {
                uVar19 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
                uVar19 = (ulong)((uint)uVar19 & 0xfff);
              }
            }
            if (((0 < dmgBombPeople) || (0 < dmgBombFloor)) ||
               (lVar21 = CONCAT22(cKillPeople._2_2_,(uint)cKillPeople), 0 < dmgPeopleSmart)) {
              uVar16 = (undefined2)((ulong)lppl >> 0x10);
              pPVar13 = (PLANET *)lppl;
              iVar12 = *(int *)((int)pPVar13->rgwtMin + 0xe);
              lVar21 = CONCAT22(cKillPeople._2_2_,(uint)cKillPeople);
              if ((-1 < iVar12) &&
                 ((0 < iVar12 ||
                  (lVar21 = CONCAT22(cKillPeople._2_2_,(uint)cKillPeople),
                  (int)pPVar13->rgwtMin[3] != 0)))) {
                uVar24 = 0;
                uVar22 = 1000;
                cKillMine = uVar19;
                uVar19 = __aFulmul(CONCAT22(*(undefined2 *)((int)pPVar13->rgwtMin + 0xe),
                                                    (int)pPVar13->rgwtMin[3]),dmgPeopleSmart);
                lVar21 = __aFldiv(uVar19,CONCAT22(uVar24,uVar22));
                uVar16 = (undefined2)((ulong)lppl >> 0x10);
                pPVar13 = (PLANET *)lppl;
                if (CONCAT22(*(undefined2 *)((int)pPVar13->rgwtMin + 0xe),(int)pPVar13->rgwtMin[3])
                    <= lVar21) {
                  iVar12 = (int)pPVar13->rgwtMin[3];
                  lVar21 = CONCAT22(*(int *)((int)pPVar13->rgwtMin + 0xe) + -1 + (uint)(iVar12 != 0)
                                    ,iVar12 + -1);
                }
                cKillPeopleS._2_2_ = (int)((ulong)lVar21 >> 0x10);
                cKillPeopleS._0_2_ = (uint)lVar21;
                bVar17 = *(uint *)(pPVar13->rgwtMin + 3) < (uint)cKillPeopleS;
                iVar9 = *(uint *)(pPVar13->rgwtMin + 3) - (uint)cKillPeopleS;
                iVar12 = *(int *)((int)pPVar13->rgwtMin + 0xe) - cKillPeopleS._2_2_;
                cKillPeopleS = lVar21;
                cKillPeople = __aFulmul(CONCAT22(iVar12 - (uint)bVar17,iVar9),dmgBombPeople)
                ;
                lVar21 = __aFlrem(cKillPeople,1000);
                modKill = lVar21;
                lVar21 = __aFldiv(cKillPeople,1000);
                uVar19 = cKillMine;
                if (0 < modKill) {
                  cKillPeople = lVar21;
                  sVar6 = Random(1000);
                  lVar21 = cKillPeople + (ulong)(sVar6 <= modKill);
                  uVar19 = cKillMine;
                }
                lVar21 = lVar21 + cKillPeopleS;
                if ((0 < dmgBombPeople) && (lVar21 < 1)) {
                  lVar21 = 1;
                }
                if (lVar21 < dmgBombFloor) {
                  lVar21 = dmgBombFloor;
                }
                uVar16 = (undefined2)((ulong)lppl >> 0x10);
                pPVar13 = (PLANET *)lppl;
                if (CONCAT22(*(undefined2 *)((int)pPVar13->rgwtMin + 0xe),
                             *(uint *)(pPVar13->rgwtMin + 3)) < lVar21) {
                  lVar21 = CONCAT22(*(undefined2 *)((int)pPVar13->rgwtMin + 0xe),
                                    (int)pPVar13->rgwtMin[3]);
                }
              }
            }
            cKillPeople._2_2_ = (int)((ulong)lVar21 >> 0x10);
            cKillPeople._0_2_ = (uint)lVar21;
            if (0 < lVar21) {
              uVar16 = (undefined2)((ulong)lppl >> 0x10);
              puVar2 = (uint *)(((PLANET *)lppl)->rgwtMin + 3);
              uVar10 = *puVar2;
              *puVar2 = *puVar2 - (uint)cKillPeople;
              piVar1 = (int *)((int)((PLANET *)lppl)->rgwtMin + 0xe);
              *piVar1 = (*piVar1 - cKillPeople._2_2_) - (uint)(uVar10 < (uint)cKillPeople);
            }
            if (0 < cKillFact) {
              cKillPeople = lVar21;
              cKillMine = uVar19;
              lVar21 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              uVar16 = (undefined2)((ulong)lppl >> 0x10);
              pPVar13 = (PLANET *)lppl;
              pctTot = (*(int *)((int)&pPVar13->dwFlags + 2) - (int)((ulong)lVar21 >> 0x10)) -
                       (uint)(*(uint *)&pPVar13->dwFlags < (uint)lVar21) & 0xfff0;
              *(int *)&pPVar13->dwFlags = (int)pPVar13->dwFlags;
              puVar2 = (uint *)((int)&pPVar13->dwFlags + 2);
              *puVar2 = *puVar2 & 0xf;
              *(int *)&pPVar13->dwFlags = (int)pPVar13->dwFlags;
              puVar2 = (uint *)((int)&pPVar13->dwFlags + 2);
              *puVar2 = *puVar2 | pctTot;
              lVar21 = cKillPeople;
              uVar19 = cKillMine;
            }
            if (0 < (long)uVar19) {
              cKillPeople = lVar21;
              cKillMine = uVar19;
              lVar21 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              uVar16 = (undefined2)((ulong)lppl >> 0x10);
              pPVar13 = (PLANET *)lppl;
              qVar5 = (qword)CONCAT22((*(int *)((int)&pPVar13->dwFlags + 2) -
                                      (int)((ulong)lVar21 >> 0x10)) -
                                      (uint)(*(uint *)&pPVar13->dwFlags < (uint)lVar21),
                                      *(uint *)&pPVar13->dwFlags - (uint)lVar21) & 0xfff00;
              *(uint *)&pPVar13->dwFlags = *(uint *)&pPVar13->dwFlags & 0xff;
              puVar2 = (uint *)((int)&pPVar13->dwFlags + 2);
              *puVar2 = *puVar2 & 0xfff0;
              dChg = (short)qVar5;
              pctTot = (short)(qVar5 >> 0x10);
              *(uint *)&pPVar13->dwFlags = *(uint *)&pPVar13->dwFlags | dChg;
              puVar2 = (uint *)((int)&pPVar13->dwFlags + 2);
              *puVar2 = *puVar2 | pctTot;
              lVar21 = cKillPeople;
              uVar19 = cKillMine;
            }
            if (0 < cKillDefenses) {
              cKillPeople = lVar21;
              cKillMine = uVar19;
              lVar21 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              uVar16 = (undefined2)((ulong)lppl >> 0x10);
              pPVar13 = (PLANET *)lppl;
              dChg = (int)pPVar13->dwFlags - (int)lVar21 & 0xfff;
              *(uint *)&pPVar13->dwFlags = *(uint *)&pPVar13->dwFlags & 0xf000;
              puVar3 = (undefined2 *)((int)&pPVar13->dwFlags + 2);
              *puVar3 = *puVar3;
              *(uint *)&pPVar13->dwFlags = *(uint *)&pPVar13->dwFlags | dChg;
              puVar3 = (undefined2 *)((int)&pPVar13->dwFlags + 2);
              *puVar3 = *puVar3;
              lVar21 = cKillPeople;
              uVar19 = cKillMine;
            }
            if ((-1 < pctTerra._2_2_) && ((0 < pctTerra._2_2_ || ((uint)pctTerra != 0)))) {
              in_stack_0000ffa6 = 2;
              cKillPeople = lVar21;
              cKillMine = uVar19;
              lVar21 = __ftol((double)CONCAT26(2,CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
              bVar17 = (uint)pctTerra < (uint)lVar21;
              pctTerra._0_2_ = (uint)pctTerra - (uint)lVar21;
              pctTerra._2_2_ = (pctTerra._2_2_ - (int)((ulong)lVar21 >> 0x10)) - (uint)bVar17;
              if ((-1 < pctTerra._2_2_) && ((0 < pctTerra._2_2_ || (500 < (uint)pctTerra)))) {
                pctTerra._0_2_ = 500;
                pctTerra._2_2_ = 0;
              }
              _pctSuccessHalf = 0;
              while( true ) {
                sVar6 = pctTot;
                if (2 < i) break;
                pcVar14 = ((PLANET *)lppl)->rgEnvVarOrig + i;
                pcVar15 = ((PLANET *)lppl)->rgEnvVar + i;
                _pctSuccessHalf = CONCAT62(_i,(int)*pcVar14);
                uVar10 = (int)*pcVar15 - (int)*pcVar14;
                _pctSuccessHalf = CONCAT24(uVar10,_pctSuccessHalf);
                _pctSuccessHalf = CONCAT26(sVar6,_pctSuccessHalf);
                if ((int)uVar10 < 1) {
                  if ((int)uVar10 < 0) {
                    iVar12 = (int)-uVar10 >> 0xf;
                    if ((pctTerra._2_2_ <= iVar12) &&
                       ((pctTerra._2_2_ < iVar12 || ((uint)pctTerra <= -uVar10)))) {
                      _pctSuccessHalf = CONCAT24(-(uint)pctTerra,_pctSuccessHalf);
                      _pctSuccessHalf = CONCAT26(sVar6,_pctSuccessHalf);
                    }
                    ((PLANET *)lppl)->rgEnvVar[i] =
                         ((PLANET *)lppl)->rgEnvVar[i] - (char)((qword)_pctSuccessHalf >> 0x20);
                    iVar12 = pctTot - dChg;
                    _pctSuccessHalf = CONCAT26(iVar12,_pctSuccessHalf);
                  }
                }
                else {
                  if ((pctTerra._2_2_ <= (int)uVar10 >> 0xf) &&
                     ((pctTerra._2_2_ < (int)uVar10 >> 0xf || ((uint)pctTerra <= uVar10)))) {
                    _pctSuccessHalf = CONCAT24((uint)pctTerra,_pctSuccessHalf);
                    _pctSuccessHalf = CONCAT26(sVar6,_pctSuccessHalf);
                  }
                  ((PLANET *)lppl)->rgEnvVar[i] =
                       ((PLANET *)lppl)->rgEnvVar[i] - (char)((qword)_pctSuccessHalf >> 0x20);
                  iVar12 = pctTot + dChg;
                  _pctSuccessHalf = CONCAT26(iVar12,_pctSuccessHalf);
                }
                _pctSuccessHalf = (qword)CONCAT42(_dChg,i + 1) << 0x10;
              }
              lVar21 = cKillPeople;
              uVar19 = cKillMine;
              if (0 < pctTot) {
                if (fMulti == 0) {
                  MVar11 = idmHasRetroBombedUndoingTerraforming;
                }
                else {
                  MVar11 = idmFleetsHaveRetroBombedUndoingTerraforming;
                }
                FSendPlrMsg(((FLEET *)lpfl)->iPlayer,MVar11,lpfl->id | 0x8000,lpfl->id,lppl->id
                                 ,pctTot,0,0,0,0);
                if (fMulti == 0) {
                  MVar11 = idmHasRetroBombedUndoingTerraforming;
                }
                else {
                  MVar11 = idmFleetsHaveRetroBombedUndoingTerraforming2;
                }
                FSendPlrMsg(((PLANET *)lppl)->iPlayer,MVar11,lppl->id,lpfl->id,lppl->id,pctTot,
                                 0,0,0,0);
                lVar21 = cKillPeople;
                uVar19 = cKillMine;
              }
            }
            cKillPeople._2_2_ = (int)((ulong)lVar21 >> 0x10);
            cKillPeople._0_2_ = (uint)lVar21;
            cPPE = cKillDefenses + cKillFact + uVar19;
            pPVar13 = (PLANET *)lppl;
            uVar16 = (undefined2)((ulong)lppl >> 0x10);
            cKillMine = uVar19;
            if (cPPE < 1) {
              if (0 < lVar21) {
                iVar12 = *(int *)((int)pPVar13->rgwtMin + 0xe);
                if ((iVar12 < 0) || ((iVar12 < 1 && ((int)pPVar13->rgwtMin[3] == 0)))) {
                  if (fMulti == 0) {
                    idmSrc = 0x8f;
                    idmDst = 0x90;
                  }
                  else {
                    idmSrc = 0x17c;
                    idmDst = 0x17d;
                  }
                }
                else if (fMulti == 0) {
                  idmSrc = 0x60;
                  idmDst = 0x6a;
                }
                else {
                  idmSrc = 0x166;
                  idmDst = 0x170;
                }
                FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,lppl->id
                                 ,(uint)cKillPeople,0,0,0,0);
                cKillPeople = lVar21;
                FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                 (uint)cKillPeople,0,0,0,0);
                lVar21 = cKillPeople;
                uVar19 = cKillMine;
              }
            }
            else {
              iVar12 = *(int *)((int)pPVar13->rgwtMin + 0xe);
              if ((iVar12 < 0) || ((iVar12 < 1 && ((int)pPVar13->rgwtMin[3] == 0)))) {
                if (fMulti == 0) {
                  idmSrc = 0x8f;
                  idmDst = 0x90;
                }
                else {
                  idmSrc = 0x17c;
                  idmDst = 0x17d;
                }
BATTLE_GenericBombMsg:
                cKillPeople = lVar21;
                cKillMine = uVar19;
                FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,lppl->id
                                 ,(short)lVar21,(int)cPPE,0,0,0);
                FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                 (uint)cKillPeople,(int)cPPE,0,0,0);
                lVar21 = cKillPeople;
                uVar19 = cKillMine;
              }
              else {
                if (fMulti == 0) {
                  idmSrc = 99;
                  idmDst = 0x6d;
                }
                else {
                  idmSrc = 0x169;
                  idmDst = 0x173;
                }
                if (1 < cPPE) {
                  idmSrc = idmSrc + 1;
                  idmDst = idmDst + 1;
                }
                bVar17 = cKillPeople._2_2_ == 0;
                cKillPeople = lVar21;
                if ((lVar21 < 0) || ((lVar21 < 0x10000 && (bVar17 = false, (uint)cKillPeople == 0)))
                   ) {
                  idmSrc = idmSrc + -2;
                  idmDst = idmDst + -2;
                  bVar17 = idmDst == 0;
                  __aFfcompp();
                  if (bVar17) {
                    FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,
                                     lppl->id,(int)cPPE,0,0,0,0);
                    FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                     (int)cPPE,0,0,0,0);
                    lVar21 = cKillPeople;
                    uVar19 = cKillMine;
                  }
                  else {
                    idmSrc = idmSrc + 5;
                    idmDst = idmDst + 5;
                    sVar25 = 0;
                    sVar23 = 0;
                    sVar6 = 0;
                    lVar21 = __ftol((double)((qword)unaff_DI << 0x30));
                    FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,
                                     lppl->id,(int)cPPE,(short)lVar21,sVar6,sVar23,sVar25);
                    sVar25 = 0;
                    sVar23 = 0;
                    sVar6 = 0;
                    lVar21 = __ftol((double)((qword)unaff_DI << 0x30));
                    FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                     (int)cPPE,(short)lVar21,sVar6,sVar23,sVar25);
                    lVar21 = cKillPeople;
                    uVar19 = cKillMine;
                  }
                }
                else {
                  __aFfcompp();
                  lVar21 = cKillPeople;
                  uVar19 = cKillMine;
                  if (bVar17) goto BATTLE_GenericBombMsg;
                  idmSrc = idmSrc + 5;
                  idmDst = idmDst + 5;
                  sVar23 = 0;
                  sVar6 = 0;
                  lVar21 = __ftol((double)((qword)CONCAT22(unaff_SI,unaff_DI) << 0x20));
                  FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,
                                   lppl->id,(uint)cKillPeople,(int)cPPE,(short)lVar21,sVar6,sVar23);
                  sVar23 = 0;
                  sVar6 = 0;
                  lVar21 = __ftol((double)((qword)CONCAT22(unaff_SI,unaff_DI) << 0x20));
                  FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                   (uint)cKillPeople,(int)cPPE,(short)lVar21,sVar6,sVar23);
                  lVar21 = cKillPeople;
                  uVar19 = cKillMine;
                }
              }
            }
            uVar16 = (undefined2)((ulong)lppl >> 0x10);
            cKillPeople = lVar21;
            cKillMine = uVar19;
            if (((int)((PLANET *)lppl)->rgwtMin[3] == 0) &&
               (*(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe) == 0)) {
              UninhabitPlanet(lppl);
            }
          }
        }
      }
    }
    ifl = ifl + 1;
  } while( true );
}



