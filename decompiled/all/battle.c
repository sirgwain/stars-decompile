// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: RelationsDlg
// Address: 10f0:0088
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short RelationsDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char *pcVar1;
  HWND HVar2;
  undefined2 unaff_SS;
  LRESULT LVar3;
  WPARAM WVar4;
  UINT UVar5;
  RECT rcGBox;
  PAINTSTRUCT ps;
  HDC hdc;
  undefined8 rc;
  short i;
  
  if (message == WM_DESTROY) {
    if (fDirtyPlan != 0) {
      hdc = grbitScan & 0xf;
      LogChangeRelations();
      InvalidateRect(hwndScanner,(RECT *)0x0,1);
    }
  }
  else {
    if (message == WM_PAINT) {
      hdc = BeginPaint(hwnd,(PAINTSTRUCT *)&ps);
      HVar2 = GetDlgItem(hwnd,0x7d5);
      GetWindowRect(HVar2,(RECT *)&rcGBox);
      ScreenToClient(hwnd,(POINT *)&rcGBox);
      HVar2 = GetDlgItem(hwnd,0x7d6);
      GetWindowRect(HVar2,(RECT *)(RECT *)&rc);
      ScreenToClient(hwnd,(POINT *)(POINT *)((int)&rc + 4));
      rcGBox.right = rc._4_2_;
      rcGBox.bottom = rc._6_2_;
      ExpandRc(&rcGBox,dyArial8,dyArial8 >> 1);
      _Draw3dFrame();
      SetBkColor(hdc,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      SelectObject(hdc,rghfontArial8[1]);
      i = CchGetString(idsRelation,(char *)szWork);
      TextOut(hdc,rcGBox.left + 8,rcGBox.top - (dyArial8 >> 1),szWork,i);
      SelectObject(hdc,rghfontArial8[0]);
      EndPaint(hwnd,(PAINTSTRUCT *)&ps);
      return 1;
    }
    if (message == WM_ERASEBKGND) {
LAB_10f0_0177:
      GetClientRect(hwnd,(RECT *)(RECT *)&rc);
      FillRect(wParam,(RECT *)(RECT *)&rc,hbrButtonFace);
      return 1;
    }
    if (message == WM_CTLCOLOR) {
      hdc = (HDC)lParam;
      HVar2 = GetDlgItem(hwnd,0x7d3);
      if (hdc != HVar2) {
        SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace))
        ;
        return hbrButtonFace;
      }
    }
    else {
      if (message == WM_INITDIALOG) {
        StickyDlgPos(hwnd,(POINT *)&ptStickyRelationsDlg,1);
        hdc = idPlayer * 0xc0 + 0x5a12;
        CheckRadioButton(hwnd,0x7d4,0x7d6,*(char *)(hdc + (idPlayer == 0)) + 0x7d4);
        for (i = 0; i < game.cPlayer; i = i + 1) {
          if (i != idPlayer) {
            HVar2 = GetDlgItem(hwnd,0x7d3);
            UVar5 = 0x401;
            WVar4 = 0;
            pcVar1 = PszPlayerName(i,0,0,0,0,(PLAYER *)0x0);
            SendMessage(HVar2,UVar5,WVar4,(LPARAM)pcVar1);
          }
        }
        HVar2 = GetDlgItem(hwnd,0x7d3);
        SendMessage(HVar2,0x407,0,0);
        fDirtyPlan = 0;
        goto LAB_10f0_0177;
      }
      if (message == WM_COMMAND) {
        if (wParam == 2) {
          StickyDlgPos(hwnd,(POINT *)&ptStickyRelationsDlg,0);
          HVar2 = GetDlgItem(hwnd,0x7d3);
          LVar3 = SendMessage(HVar2,0x409,0,0);
          i = (short)LVar3;
          if (idPlayer <= i) {
            i = i + 1;
          }
          EndDialog(hwnd,i + 3);
          return 1;
        }
        if ((wParam < 0x7d4) || (0x7d6 < wParam)) {
          if (wParam == 0x7d3) {
            HVar2 = GetDlgItem(hwnd,0x7d3);
            LVar3 = SendMessage(HVar2,0x409,0,0);
            i = (short)LVar3;
            if (idPlayer <= i) {
              i = i + 1;
            }
            CheckRadioButton(hwnd,0x7d4,0x7d6,*(char *)(idPlayer * 0xc0 + 0x5a12 + i) + 0x7d4
                            );
          }
          else if (wParam == 0x76) {
            WinHelp(hwnd,(LPCSTR)_szHelpFile,1,0x43b);
            return 1;
          }
        }
        else {
          HVar2 = GetDlgItem(hwnd,0x7d3);
          LVar3 = SendMessage(HVar2,0x409,0,0);
          i = (short)LVar3;
          if (idPlayer <= i) {
            i = i + 1;
          }
          *(char *)(idPlayer * 0xc0 + 0x5a12 + i) = (char)wParam + ',';
          fDirtyPlan = 1;
        }
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: NewPlanNameDlg
// Address: 10f0:04ce
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short NewPlanNameDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 unaff_SS;
  ulong uVar1;
  ushort in_stack_0000fff4;
  
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(RECT *)(RECT *)&stack0xfff4);
    FillRect(wParam,(RECT *)(RECT *)&stack0xfff4,hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    uVar1 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000fff4);
    if ((int)uVar1 == 6) {
      SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
      return hbrButtonFace;
    }
  }
  else {
    if (message == WM_INITDIALOG) {
      SetWindowPos(hwnd,0,ptStickyBattlePlansDlg.x + 0x46,
                   ptStickyBattlePlansDlg.y + 0x46,0,0,0x15);
      SendDlgItemMessage(hwnd,0x10c,0x415,0x1f,0);
      SetDlgItemText(hwnd,0x10c,(LPCSTR)btlplan.szName);
      return 1;
    }
    if (message == WM_COMMAND) {
      if ((wParam == 1) || (wParam == 2)) {
        if (wParam == 1) {
          GetDlgItemText(hwnd,0x10c,(LPSTR)btlplan.szName,0x20);
          fDirtyPlan = 1;
        }
        EndDialog(hwnd,(uint)(wParam == 1));
        return 1;
      }
      if (wParam == 0x76) {
        WinHelp(hwnd,(LPCSTR)_szHelpFile,1,0x439);
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: BattlePlansDlg
// Address: 10f0:0652
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short BattlePlansDlg(HWND hwnd,WMType message,ushort wParam,long lParam)

{
  char *pcVar1;
  BTLPLAN *pBVar2;
  BTLPLAN *pBVar3;
  undefined2 uVar4;
  char *pcVar5;
  HWND HVar6;
  short sVar7;
  ushort uVar8;
  int iVar9;
  undefined2 unaff_SI;
  BTLPLAN *pBVar10;
  undefined2 unaff_DI;
  BTLPLAN *pBVar11;
  undefined2 unaff_SS;
  ulong uVar12;
  LRESULT LVar13;
  WPARAM WVar14;
  UINT UVar15;
  ushort in_stack_0000ffe6;
  short cLen;
  RECT rc;
  short fRet;
  short i;
  short idc;
  FARPROC lpProc;
  
  uVar12 = CONCAT22(unaff_SI,unaff_DI);
  if (message == WM_ERASEBKGND) {
    GetClientRect(hwnd,(RECT *)&rc);
    FillRect(wParam,(RECT *)&rc,hbrButtonFace);
    return 1;
  }
  if (message == WM_CTLCOLOR) {
    for (idc = 0x41d; idc < 0x423; idc = idc + 1) {
      HVar6 = GetDlgItem(hwnd,idc);
      if ((HWND)lParam == HVar6) break;
    }
    if ((idc < 0x41d) && (uVar12 = __aFulshr(uVar12,in_stack_0000ffe6), (int)uVar12 != 6)) {
      return 0;
    }
    SetBkColor(wParam,CONCAT22(crButtonFace._2_2_,(undefined2)crButtonFace));
    return hbrButtonFace;
  }
  if (message == WM_INITDIALOG) {
    StickyDlgPos(hwnd,(POINT *)&ptStickyBattlePlansDlg,1);
    iPlanSelDlg = 0;
    if (sel.grobj == grobjFleet) {
      iPlanSelDlg = (short)sel.fl.iplan;
    }
    uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
    pBVar10 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
    pBVar11 = (BTLPLAN *)&btlplan;
    for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
      pBVar3 = pBVar11;
      pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
      pBVar2 = pBVar10;
      pBVar10 = (BTLPLAN *)&pBVar10->wFlags;
      pBVar3->wFlags = pBVar2->wFlags;
    }
    for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x403,0,
                  (LPARAM)CONCAT22(((undefined2 *)&DAT_1120_593a)[idPlayer * 2],
                                   ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                   szName));
    }
    HVar6 = GetDlgItem(hwnd,0x41e);
    SendMessage(HVar6,0x40e,iPlanSelDlg,0);
    HVar6 = GetDlgItem(hwnd,0x41b);
    EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
    HVar6 = GetDlgItem(hwnd,0x817);
    EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
    for (i = 0x198; i < 0x19e; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x421);
      UVar15 = 0x403;
      WVar14 = 0;
      pcVar5 = PszGetCompressedString(i);
      SendMessage(HVar6,UVar15,WVar14,(LPARAM)pcVar5);
    }
    HVar6 = GetDlgItem(hwnd,0x421);
    SendMessage(HVar6,0x40e,(uint)btlplan.wFlags >> 8 & 0xf,0);
    for (i = 400; i < 0x198; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x41f);
      UVar15 = 0x403;
      WVar14 = 0;
      pcVar5 = PszGetCompressedString(i);
      SendMessage(HVar6,UVar15,WVar14,(LPARAM)pcVar5);
    }
    HVar6 = GetDlgItem(hwnd,0x41f);
    SendMessage(HVar6,0x40e,btlplan.wFlags & 0xf,0);
    if (((uint)game.wCrap >> 2 & 1) == 0) {
      for (i = 0x78; i < 0x7c; i = i + 1) {
        HVar6 = GetDlgItem(hwnd,0x422);
        UVar15 = 0x403;
        WVar14 = 0;
        pcVar5 = PszGetCompressedString(i);
        SendMessage(HVar6,UVar15,WVar14,(LPARAM)pcVar5);
      }
      for (i = 0; i < game.cPlayer; i = i + 1) {
        if (i != idPlayer) {
          HVar6 = GetDlgItem(hwnd,0x422);
          UVar15 = 0x403;
          WVar14 = 0;
          pcVar5 = PszPlayerName(i,0,1,0,0,(PLAYER *)0x0);
          SendMessage(HVar6,UVar15,WVar14,(LPARAM)pcVar5);
        }
      }
      i = (uint)btlplan.wFlags >> 8 & 0x1f;
      if (idPlayer + 4 <= i) {
        i = i - 1;
      }
      HVar6 = GetDlgItem(hwnd,0x422);
      SendMessage(HVar6,0x40e,i,0);
    }
    else {
      HVar6 = GetDlgItem(hwnd,0x422);
      UVar15 = 0x403;
      WVar14 = 0;
      pcVar5 = PszGetCompressedString(idsEveryone);
      SendMessage(HVar6,UVar15,WVar14,(LPARAM)pcVar5);
      HVar6 = GetDlgItem(hwnd,0x422);
      SendMessage(HVar6,0x40e,0,0);
      HVar6 = GetDlgItem(hwnd,0x422);
      EnableWindow(HVar6,0);
    }
    for (i = 400; i < 0x198; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x420);
      UVar15 = 0x403;
      WVar14 = 0;
      pcVar5 = PszGetCompressedString(i);
      SendMessage(HVar6,UVar15,WVar14,(LPARAM)pcVar5);
    }
    HVar6 = GetDlgItem(hwnd,0x420);
    SendMessage(HVar6,0x40e,(uint)btlplan.wFlags >> 4 & 0xf,0);
    HVar6 = GetDlgItem(hwnd,0x41d);
    SendMessage(HVar6,0x401,(uint)btlplan.wFlags >> 0xf,0);
    fDirtyPlan = 0;
    if (((uint)gd._0_2_ >> 0xb & 1) != 0) {
      AdvanceTutor();
    }
    return 1;
  }
  if (message != WM_COMMAND) {
    return 0;
  }
  if ((wParam == 1) || (wParam == 2)) {
    if (fDirtyPlan != 0) {
      uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
      pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar10 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar11;
        pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
        pBVar2 = pBVar10;
        pBVar10 = (BTLPLAN *)&pBVar10->wFlags;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      LogChangeBtlplan((BTLPLAN *)&btlplan);
    }
    StickyDlgPos(hwnd,(POINT *)&ptStickyBattlePlansDlg,0);
    EndDialog(hwnd,iPlanSelDlg);
    if (sel.grobj == grobjFleet) {
      FillBattleDD(sel.fl.iplan + 1);
    }
    iPlanSelDlg = -1;
    return 1;
  }
  if (wParam == 0x41d) {
    LVar13 = SendDlgItemMessage(hwnd,0x41d,0x400,0,0);
    fDirtyPlan = 1;
    btlplan.wFlags = btlplan.wFlags & 0x7fffU | (int)LVar13 << 0xf;
    return 0;
  }
  if (wParam == 0x817) {
    if (fDirtyPlan != 0) {
      uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
      pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar10 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar11;
        pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
        pBVar2 = pBVar10;
        pBVar10 = (BTLPLAN *)&pBVar10->wFlags;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      LogChangeBtlplan((BTLPLAN *)&btlplan);
      fDirtyPlan = 0;
    }
    btlplan.wFlags = btlplan.wFlags & 0xbfffU | 0x4000;
    uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
    pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
    pBVar10 = (BTLPLAN *)&btlplan;
    for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
      pBVar3 = pBVar11;
      pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
      pBVar2 = pBVar10;
      pBVar10 = (BTLPLAN *)&pBVar10->wFlags;
      pBVar3->wFlags = pBVar2->wFlags;
    }
    btlplan.wFlags = btlplan.wFlags & 0xff0fU | (iPlanSelDlg & 0xfU) << 4
    ;
    sVar7 = FDeleteBattlePlan(iPlanSelDlg,1);
    if (sVar7 == 0) {
      btlplan.wFlags = btlplan.wFlags & 0xbfff;
      uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
      pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar10 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar11;
        pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
        pBVar2 = pBVar10;
        pBVar10 = (BTLPLAN *)&pBVar10->wFlags;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      return 0;
    }
    LogChangeBtlplan((BTLPLAN *)&btlplan);
    HVar6 = GetDlgItem(hwnd,0x41e);
    SendMessage(HVar6,0x40e,iPlanSelDlg - 1,0);
    HVar6 = GetDlgItem(hwnd,0x41e);
    SendMessage(HVar6,0x40b,0,0);
    for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x403,0,
                  (LPARAM)CONCAT22(((undefined2 *)&DAT_1120_593a)[idPlayer * 2],
                                   ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                   szName));
    }
    HVar6 = GetDlgItem(hwnd,0x41e);
    SendMessage(HVar6,0x40e,iPlanSelDlg - 1,0);
BATTLE_LSelectName:
    HVar6 = GetDlgItem(hwnd,0x41e);
    LVar13 = SendMessage(HVar6,0x407,0,0);
    i = (short)LVar13;
    if (i != iPlanSelDlg) {
      if (fDirtyPlan != 0) {
        uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
        pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
        pBVar10 = (BTLPLAN *)&btlplan;
        for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
          pBVar3 = pBVar11;
          pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
          pBVar2 = pBVar10;
          pBVar10 = (BTLPLAN *)&pBVar10->wFlags;
          pBVar3->wFlags = pBVar2->wFlags;
        }
        LogChangeBtlplan((BTLPLAN *)&btlplan);
        fDirtyPlan = 0;
      }
      iPlanSelDlg = i;
      uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
      pBVar10 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i;
      pBVar11 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar11;
        pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
        pBVar2 = pBVar10;
        pBVar10 = (BTLPLAN *)&pBVar10->wFlags;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      HVar6 = GetDlgItem(hwnd,0x41f);
      SendMessage(HVar6,0x40e,btlplan.wFlags & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x420);
      SendMessage(HVar6,0x40e,(uint)btlplan.wFlags >> 4 & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x41d);
      SendMessage(HVar6,0x401,(uint)btlplan.wFlags >> 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x41b);
      EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
      HVar6 = GetDlgItem(hwnd,0x817);
      EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
      HVar6 = GetDlgItem(hwnd,0x421);
      SendMessage(HVar6,0x40e,(uint)btlplan.wFlags >> 8 & 0xf,0);
      i = (uint)btlplan.wFlags >> 8 & 0x1f;
      if (idPlayer + 4 <= i) {
        i = i - 1;
      }
      HVar6 = GetDlgItem(hwnd,0x422);
      SendMessage(HVar6,0x40e,i,0);
    }
  }
  else {
    if (wParam == 0x41f) {
      HVar6 = GetDlgItem(hwnd,0x41f);
      LVar13 = SendMessage(HVar6,0x407,0,0);
      fDirtyPlan = 1;
      btlplan.wFlags = btlplan.wFlags & 0xfff0U | (uint)LVar13 & 0xf;
      return 0;
    }
    if (wParam == 0x420) {
      HVar6 = GetDlgItem(hwnd,0x420);
      LVar13 = SendMessage(HVar6,0x407,0,0);
      fDirtyPlan = 1;
      btlplan.wFlags = btlplan.wFlags & 0xff0fU | ((uint)LVar13 & 0xf) << 4;
      return 0;
    }
    if (wParam == 0x422) {
      HVar6 = GetDlgItem(hwnd,0x422);
      LVar13 = SendMessage(HVar6,0x407,0,0);
      i = (short)LVar13;
      if (((uint)game.wCrap >> 2 & 1) == 0) {
        if (idPlayer + 4 <= i) {
          i = i + 1;
        }
      }
      else {
        i = 3;
      }
      fDirtyPlan = 1;
      btlplan.wFlags = btlplan.wFlags & 0xe0ffU | (i & 0x1fU) << 8;
      return 0;
    }
    if (wParam == 0x421) {
      HVar6 = GetDlgItem(hwnd,0x421);
      LVar13 = SendMessage(HVar6,0x407,0,0);
      fDirtyPlan = 1;
      btlplan.wFlags = btlplan.wFlags & 0xf0ffU | ((uint)LVar13 & 0xf) << 8;
      return 0;
    }
    if (wParam != 0x41b) {
      if (wParam != 0x41c) {
        if (wParam != 0x41e) {
          if (wParam != 0x76) {
            return 0;
          }
          WinHelp(hwnd,(LPCSTR)_szHelpFile,1,0x439);
          return 1;
        }
        goto BATTLE_LSelectName;
      }
      if (((byte *)rgcbtlplan)[idPlayer] == 0xf) {
        return 0;
      }
      if (fDirtyPlan != 0) {
        uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
        pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
        pBVar10 = (BTLPLAN *)&btlplan;
        for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
          pBVar3 = pBVar11;
          pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
          pBVar2 = pBVar10;
          pBVar10 = (BTLPLAN *)&pBVar10->wFlags;
          pBVar3->wFlags = pBVar2->wFlags;
        }
        LogChangeBtlplan((BTLPLAN *)&btlplan);
        fDirtyPlan = 0;
      }
      iPlanSelDlg = (short)((byte *)rgcbtlplan)[idPlayer];
      ((byte *)rgcbtlplan)[idPlayer] =
           ((byte *)rgcbtlplan)[idPlayer] + 1;
      uVar8 = _strlen((char *)btlplan.szName);
      if ((int)uVar8 < 0x1c) {
        if (((*(char *)((int)&btlplan.wFlags + 1 + uVar8) == ')') &&
            ((((undefined *)&DAT_1120_175f)[*(byte *)((int)&btlplan.wFlags + uVar8)] & 4)
             != 0)) && (*(char *)((int)&btlplan.wFlags + 1 + uVar8) == '(')) {
          if (*(char *)((int)&btlplan.wFlags + uVar8) == '9') {
            *(undefined1 *)((int)&btlplan.wFlags + uVar8) = 0x30;
          }
          else {
            pcVar1 = (char *)((int)&btlplan.wFlags + uVar8);
            *pcVar1 = *pcVar1 + '\x01';
          }
        }
        else {
          _strcpy((char *)((int)btlplan.szName + uVar8),(char *)0xd9c);
        }
      }
      btlplan.wFlags =
           btlplan.wFlags & 0xff0fU | (iPlanSelDlg & 0xfU) << 4;
      uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
      pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar10 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar11;
        pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
        pBVar2 = pBVar10;
        pBVar10 = (BTLPLAN *)&pBVar10->wFlags;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      HVar6 = GetDlgItem(hwnd,0x421);
      SendMessage(HVar6,0x40e,(uint)btlplan.wFlags >> 8 & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x40b,0,0);
      for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
        HVar6 = GetDlgItem(hwnd,0x41e);
        SendMessage(HVar6,0x403,0,
                    (LPARAM)CONCAT22(((undefined2 *)&DAT_1120_593a)[idPlayer * 2],
                                     ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                     szName));
      }
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x40e,iPlanSelDlg,0);
      HVar6 = GetDlgItem(hwnd,0x41f);
      SendMessage(HVar6,0x40e,btlplan.wFlags & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x420);
      SendMessage(HVar6,0x40e,(uint)btlplan.wFlags >> 4 & 0xf,0);
      HVar6 = GetDlgItem(hwnd,0x41d);
      SendMessage(HVar6,0x401,(uint)btlplan.wFlags >> 0xf,0);
      i = (uint)btlplan.wFlags >> 8 & 0x1f;
      if (idPlayer + 4 <= i) {
        i = i - 1;
      }
      HVar6 = GetDlgItem(hwnd,0x422);
      SendMessage(HVar6,0x40e,i,0);
      fDirtyPlan = 1;
      HVar6 = GetDlgItem(hwnd,0x41b);
      EnableWindow(HVar6,1);
    }
    StickyDlgPos(hwnd,(POINT *)&ptStickyBattlePlansDlg,0);
    lpProc = MakeProcInstance(NewPlanNameDlg,hInst);
    fRet = DialogBox(0,(LPCSTR)CONCAT22(0x7e3,hwndFrame),(HWND)((ulong)lpProc >> 0x10),
                     (void *)lpProc);
    FreeProcInstance(lpProc);
    SetFocus(hwnd);
    if (fRet != 0) {
      uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
      pBVar11 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + iPlanSelDlg;
      pBVar10 = (BTLPLAN *)&btlplan;
      for (iVar9 = 0x12; iVar9 != 0; iVar9 = iVar9 + -1) {
        pBVar3 = pBVar11;
        pBVar11 = (BTLPLAN *)&pBVar11->wFlags;
        pBVar2 = pBVar10;
        pBVar10 = (BTLPLAN *)&pBVar10->wFlags;
        pBVar3->wFlags = pBVar2->wFlags;
      }
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x40b,0,0);
      for (i = 0; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
        HVar6 = GetDlgItem(hwnd,0x41e);
        SendMessage(HVar6,0x403,0,
                    (LPARAM)CONCAT22(((undefined2 *)&DAT_1120_593a)[idPlayer * 2],
                                     ((BTLPLAN **)rglpbtlplan)[idPlayer * 2][i].
                                     szName));
      }
      HVar6 = GetDlgItem(hwnd,0x41e);
      SendMessage(HVar6,0x40e,iPlanSelDlg,0);
    }
    HVar6 = GetDlgItem(hwnd,0x41b);
    EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
    HVar6 = GetDlgItem(hwnd,0x817);
    EnableWindow(HVar6,(uint)(0 < iPlanSelDlg));
  }
  return 0;
}



// ======================================================================
// Function: FDeleteBattlePlan
// Address: 10f0:1706
// Segment: MEMORY_BATTLE
// ======================================================================


short FDeleteBattlePlan(short iplan,short fWarn)

{
  BTLPLAN *pBVar1;
  BTLPLAN *pBVar2;
  int iVar3;
  undefined2 uVar4;
  undefined2 uVar5;
  bool bVar6;
  char *sz;
  int iVar7;
  BTLPLAN *pBVar8;
  BTLPLAN *pBVar9;
  short sVar10;
  FLEET *lpfl;
  short i;
  short iflMac;
  short fFoundBigger;
  
  bVar6 = false;
BATTLE_LCommit:
  do {
    for (iflMac = 0; iflMac < cFleet; iflMac = iflMac + 1) {
      iVar7 = *(int *)((FLEET **)rglpfl + iflMac);
      iVar3 = *(int *)((int)((FLEET **)rglpfl + iflMac) + 2);
      if ((iVar7 == 0) && (iVar3 == 0)) break;
      if (idPlayer <= *(int *)(iVar7 + 2)) {
        if (idPlayer < *(int *)(iVar7 + 2)) break;
        if ((uint)iplan <= (uint)*(byte *)(iVar7 + 0x60)) {
          if ((uint)iplan < (uint)*(byte *)(iVar7 + 0x60)) {
            if (fWarn == 0) {
              *(char *)(iVar7 + 0x60) = *(char *)(iVar7 + 0x60) + -1;
            }
            else {
              bVar6 = true;
            }
          }
          else {
            if (fWarn != 0) {
              sVar10 = 0x31;
              sz = PszFormatIds(idsCurrentlyHaveFleetsUsingBattlePlanIf,(short *)0x0);
              sVar10 = AlertSz(sz,sVar10);
              if (sVar10 == 2) {
                return 0;
              }
              fWarn = 0;
              goto BATTLE_LCommit;
            }
            *(char *)(iVar7 + 0x60) = *(char *)(iVar7 + 0x60) + -1;
          }
        }
      }
    }
    if ((fWarn == 0) || (!bVar6)) {
      ((byte *)rgcbtlplan)[idPlayer] =
           ((byte *)rgcbtlplan)[idPlayer] - 1;
      for (i = iplan; i < (int)(uint)((byte *)rgcbtlplan)[idPlayer]; i = i + 1) {
        uVar4 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
        pBVar8 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i + 1;
        uVar5 = ((undefined2 *)&DAT_1120_593a)[idPlayer * 2];
        pBVar9 = ((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i;
        for (iVar7 = 0x12; iVar7 != 0; iVar7 = iVar7 + -1) {
          pBVar2 = pBVar9;
          pBVar9 = (BTLPLAN *)&pBVar9->wFlags;
          pBVar1 = pBVar8;
          pBVar8 = (BTLPLAN *)&pBVar8->wFlags;
          pBVar2->wFlags = pBVar1->wFlags;
        }
        (((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i)->wFlags =
             (((BTLPLAN **)rglpbtlplan)[idPlayer * 2] + i)->wFlags & 0xff0fU |
             (i & 0xfU) << 4;
      }
      return 1;
    }
    fWarn = 0;
  } while( true );
}



// ======================================================================
// Function: SpankTheCheaters
// Address: 10f0:192a
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f01bdb) */
/* WARNING: Removing unreachable block (ram,0x10f01be0) */
/* WARNING: Removing unreachable block (ram,0x10f01d75) */
/* WARNING: Removing unreachable block (ram,0x10f01c5e) */
/* WARNING: Removing unreachable block (ram,0x10f01d8c) */

void SpankTheCheaters(void)

{
  uint *puVar1;
  int iVar2;
  uint uVar3;
  short sVar4;
  PLANET *pPVar5;
  PLANET *pPVar6;
  FLEET *pFVar7;
  PLANET *pPVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar9;
  ulong uVar10;
  long lVar11;
  ulong uVar12;
  long lVar13;
  ulong uVar14;
  byte rgfCheater [16];
  short fSellOff;
  short fCheater;
  int pctSell;
  int local_16;
  short i;
  short ifl;
  FLEET *lpfl;
  PLANET *lppl;
  undefined4 lSell;
  
  uVar14 = CONCAT22(unaff_SI,unaff_DI);
  fCheater = 0;
  for (i = 0; i < game.cPlayer; i = i + 1) {
    uVar3 = *(uint *)((int)&rgplr[0].wFlags + i * 0xc0) >> 2;
    rgfCheater[i] = (byte)uVar3 & 1;
    if ((uVar3 & 1) != 0) {
      fCheater = 1;
    }
  }
  if ((fCheater != 0) && (9 < (uint)game.turn)) {
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
      pFVar7 = ((FLEET **)rglpfl)[ifl];
      iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
      lpfl = (FLEET *)CONCAT22(iVar2,pFVar7);
      if ((pFVar7 == (FLEET *)0x0) && (iVar2 == 0)) break;
      if ((((uint)pFVar7->wFlags >> 10 & 1) == 0) && (rgfCheater[pFVar7->iPlayer] != 0)) {
        sVar4 = Random(0xc);
        if (sVar4 == 0) {
          uVar9 = (undefined2)((ulong)lpfl >> 0x10);
          pFVar7 = (FLEET *)lpfl;
          pFVar7->wFlags = pFVar7->wFlags & 0xfbffU | 0x400;
          FSendPlrMsg2(pFVar7->iPlayer,idmHasDefectedRanksDueInabilityProjectLegitimate,-5,
                            lpfl->id,0);
        }
        else {
          fSellOff = 0;
          i = 0;
          lVar11 = lSell;
          while( true ) {
            lSell = lVar11;
            if (2 < i) break;
            iVar2 = *(int *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
            if ((-1 < iVar2) && ((0 < iVar2 || ((int)((FLEET *)lpfl)->rgwtMin[i] != 0)))) {
              if (fSellOff == 0) {
                sVar4 = Random(0xb);
                pctSell = sVar4 + 10;
                local_16 = pctSell >> 0xf;
                fSellOff = 1;
                lVar11 = lSell;
              }
              lVar13 = 100;
              lSell = lVar11;
              uVar10 = __aFulmul(CONCAT22(*(undefined2 *)
                                                   ((int)(((FLEET *)lpfl)->rgwtMin + i) + 2),
                                                  (int)((FLEET *)lpfl)->rgwtMin[i]),
                                         CONCAT22(local_16,pctSell));
              lVar11 = __aFldiv(uVar10,lVar13);
              lSell = lVar11;
              if (lVar11 == 0) {
                lSell._0_2_ = 1;
                lSell._2_2_ = 0;
                lVar11 = 1;
              }
              lSell._2_2_ = (int)((ulong)lVar11 >> 0x10);
              lSell._0_2_ = (uint)lVar11;
              puVar1 = (uint *)(((FLEET *)lpfl)->rgwtMin + i);
              uVar3 = *puVar1;
              *puVar1 = *puVar1 - (uint)lSell;
              puVar1 = (uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
              *puVar1 = (*puVar1 - lSell._2_2_) - (uint)(uVar3 < (uint)lSell);
            }
            i = i + 1;
          }
          if (fSellOff != 0) {
            FSendPlrMsg2(((FLEET *)lpfl)->iPlayer,idmCrewHasSoldOffCargoBlackMarket,-5,lpfl->id
                              ,pctSell);
          }
        }
      }
    }
    pPVar5 = (PLANET *)lpPlanets + cPlanet;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
    pPVar6 = (PLANET *)lpPlanets;
    while ((PLANET *)lppl < pPVar5) {
      uVar9 = (undefined2)((ulong)lppl >> 0x10);
      if ((((PLANET *)lppl)->iPlayer != -1) && (rgfCheater[((PLANET *)lppl)->iPlayer] != 0)) {
        uVar10 = __aFulshr(uVar14,(ushort)pPVar6);
        if ((uVar10 & 0xfff) != 0) {
          sVar4 = Random(8);
          if (sVar4 == 0) {
            sVar4 = Random(0x1f);
            pctSell = sVar4 + 5;
            local_16 = pctSell >> 0xf;
            lVar11 = 100;
            uVar12 = (ulong)pctSell;
            uVar10 = __aFulshr(uVar12,100);
            uVar10 = __aFulmul(uVar10 & 0xfff,uVar12);
            lVar11 = __aFldiv(uVar10,lVar11);
            if (lVar11 < 1) {
              lVar11 = 1;
            }
            lSell._0_2_ = (uint)lVar11;
            uVar9 = (undefined2)((ulong)lppl >> 0x10);
            pPVar8 = (PLANET *)lppl;
            uVar3 = *(uint *)&pPVar8->dwFlags;
            iVar2 = *(int *)((int)&pPVar8->dwFlags + 2);
            pPVar6 = (PLANET *)(uVar3 + (uint)lSell * -0x100 & 0xff00);
            *(uint *)&pPVar8->dwFlags = *(uint *)&pPVar8->dwFlags & 0xff;
            puVar1 = (uint *)((int)&pPVar8->dwFlags + 2);
            *puVar1 = *puVar1 & 0xfff0;
            *(uint *)&pPVar8->dwFlags = *(uint *)&pPVar8->dwFlags | (uint)pPVar6;
            puVar1 = (uint *)((int)&pPVar8->dwFlags + 2);
            *puVar1 = *puVar1 | iVar2 - (uint)(uVar3 < (uint)lSell * 0x100) & 0xf;
            FSendPlrMsg2(pPVar8->iPlayer,idmFreedomFightersHaveAttackedDestroyedMinesPress,-5,
                              lppl->id,(uint)lSell);
            lSell = lVar11;
            goto LAB_10f0_1dfe;
          }
        }
        sVar4 = Random(0xf);
        if (sVar4 == 0) {
          i = Random(3);
          sVar4 = Random(0x29);
          pctSell = sVar4 + 5;
          local_16 = pctSell >> 0xf;
          lVar11 = 100;
          uVar10 = __aFulmul(CONCAT22(*(undefined2 *)
                                               ((int)(((PLANET *)lppl)->rgwtMin + i) + 2),
                                              (int)((PLANET *)lppl)->rgwtMin[i]),(long)pctSell);
          lVar11 = __aFldiv(uVar10,lVar11);
          lSell = lVar11;
          if (0 < lVar11) {
            if (30000 < lVar11) {
              lVar11 = 30000;
            }
            lSell._2_2_ = (int)((ulong)lVar11 >> 0x10);
            lSell._0_2_ = (uint)lVar11;
            puVar1 = (uint *)(((PLANET *)lppl)->rgwtMin + i);
            uVar3 = *puVar1;
            *puVar1 = *puVar1 - (uint)lSell;
            puVar1 = (uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
            *puVar1 = (*puVar1 - lSell._2_2_) - (uint)(uVar3 < (uint)lSell);
            FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmFreedomFightersHaveStolenKtStockpilesPress
                             ,-5,lppl->id,(uint)lSell,i + 1,0,0,0,0);
            lSell = lVar11;
          }
        }
      }
LAB_10f0_1dfe:
      lppl = (PLANET *)CONCAT22(lppl._2_2_,(PLANET *)lppl + 1);
    }
  }
  return;
}



// ======================================================================
// Function: FFleetHasBombs
// Address: 10f0:1e16
// Segment: MEMORY_BATTLE
// ======================================================================


short FFleetHasBombs(FLEET *lpfl)

{
  undefined2 uVar1;
  short sVar2;
  HUL *pHVar3;
  int iVar4;
  short ishdef;
  short imd;
  HUL *lphul;
  
  ishdef = 0;
  do {
    if (0xf < ishdef) {
      return 0;
    }
    if (((FLEET *)lpfl)->rgcsh[ishdef] != 0) {
      iVar4 = ((uint)lpfl->id >> 9 & 0xf) * 4;
      uVar1 = *(undefined2 *)(iVar4 + 0x100);
      pHVar3 = (HUL *)(*(int *)(iVar4 + 0xfe) + ishdef * 0x93);
      lphul = (HUL *)CONCAT22(uVar1,pHVar3);
      LphuldefFromId(lphul->ihuldef);
      sVar2 = FHullHasBombs((HUL *)CONCAT22(uVar1,pHVar3));
      if (sVar2 != 0) {
        return 1;
      }
    }
    ishdef = ishdef + 1;
  } while( true );
}



// ======================================================================
// Function: FHullHasBombs
// Address: 10f0:1ec2
// Segment: MEMORY_BATTLE
// ======================================================================


short FHullHasBombs(HUL *lphul)

{
  short ihs;
  HS *lphs;
  
  lphs = (HS *)CONCAT22(lphul._2_2_,((HUL *)lphul)->rghs);
  ihs = 0;
  while( true ) {
    if ((int)(uint)((HUL *)lphul)->chs <= ihs) {
      return 0;
    }
    if ((lphs->grhst == hstBomb) && ((uint)((HS *)lphs)->wFlags >> 8 != 0)) {
      return 1;
    }
    if (((lphs->grhst == hstBeam) && ((((HS *)lphs)->wFlags & 0xffU) == 0x12)) &&
       ((uint)((HS *)lphs)->wFlags >> 8 != 0)) {
      return 1;
    }
    if (((lphs->grhst == hstSpecialM) && ((((HS *)lphs)->wFlags & 0xffU) == 1)) &&
       ((uint)((HS *)lphs)->wFlags >> 8 != 0)) break;
    ihs = ihs + 1;
    lphs = (HS *)CONCAT22(lphs._2_2_,(HS *)lphs + 1);
  }
  return 1;
}



// ======================================================================
// Function: FFleetHasTeeth
// Address: 10f0:1fbe
// Segment: MEMORY_BATTLE
// ======================================================================


short FFleetHasTeeth(FLEET *lpfl)

{
  short sVar1;
  int iVar2;
  short ishdef;
  
  ishdef = 0;
  while( true ) {
    if (0xf < ishdef) {
      return 0;
    }
    if (((((FLEET *)lpfl)->rgcsh[ishdef] != 0) &&
        (iVar2 = ((uint)lpfl->id >> 9 & 0xf) * 4,
        sVar1 = FHullHasTeeth((HUL *)CONCAT22(*(undefined2 *)(iVar2 + 0x100),
                                              (HUL *)(*(int *)(iVar2 + 0xfe) + ishdef * 0x93))),
        sVar1 != 0)) &&
       (iVar2 = ((uint)lpfl->id >> 9 & 0xf) * 4,
       (*(uint *)(*(int *)(iVar2 + 0xfe) + ishdef * 0x93 + 0x7b) & 0xff) == 7)) break;
    ishdef = ishdef + 1;
  }
  return 1;
}



// ======================================================================
// Function: FHullHasTeeth
// Address: 10f0:2072
// Segment: MEMORY_BATTLE
// ======================================================================


short FHullHasTeeth(HUL *lphul)

{
  short ihs;
  HS *lphs;
  
  lphs = (HS *)CONCAT22(lphul._2_2_,((HUL *)lphul)->rghs);
  ihs = 0;
  while( true ) {
    if ((int)(uint)((HUL *)lphul)->chs <= ihs) {
      return 0;
    }
    if (((lphs->grhst & (hstTorp|hstBeam)) !=
         ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
           hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
       ((uint)((HS *)lphs)->wFlags >> 8 != 0)) break;
    ihs = ihs + 1;
    lphs = (HS *)CONCAT22(lphs._2_2_,(HS *)lphs + 1);
  }
  return 1;
}



// ======================================================================
// Function: FFuelTanker
// Address: 10f0:20f6
// Segment: MEMORY_BATTLE
// ======================================================================


short FFuelTanker(SHDEF *lpshdef)

{
  short sVar1;
  
  if (((lpshdef->hul).ihuldef == ihuldefFuelTransport) ||
     ((lpshdef->hul).ihuldef == ihuldefSuperFuelXport)) {
    sVar1 = 1;
  }
  else {
    sVar1 = 0;
  }
  return sVar1;
}



// ======================================================================
// Function: CheckTarget
// Address: 10f0:212a
// Segment: MEMORY_BATTLE
// ======================================================================


void CheckTarget(TOK *ptok,FLEET *lpfl,short ishdef)

{
  undefined2 uVar1;
  uint uVar2;
  short sVar3;
  SHDEF *pSVar4;
  BTLPLAN *pBVar5;
  TOK *pTVar6;
  undefined2 uVar7;
  short ibp;
  BTLPLAN *lpbtlplan;
  short iplr;
  
  uVar2 = (uint)lpfl->id >> 9 & 0xf;
  uVar1 = *(undefined2 *)(uVar2 * 4 + 0x100);
  pSVar4 = (SHDEF *)(*(int *)(uVar2 * 4 + 0xfe) + ishdef * 0x93);
  sVar3 = FHullHasTeeth((HUL *)CONCAT22(uVar1,pSVar4));
  pTVar6 = (TOK *)ptok;
  uVar7 = (undefined2)((ulong)ptok >> 0x10);
  if (sVar3 == 0) {
    sVar3 = FHullHasBombs((HUL *)CONCAT22(uVar1,pSVar4));
    if (sVar3 == 0) {
      sVar3 = FFuelTanker((SHDEF *)CONCAT22(uVar1,pSVar4));
      if (sVar3 == 0) {
        sVar3 = WtMaxShdefStat((SHDEF *)CONCAT22(uVar1,pSVar4),2);
        if (sVar3 == 0) {
          pTVar6->wFlags = pTVar6->wFlags & 0xfffU | 0x5000;
        }
        else {
          pTVar6->wFlags = pTVar6->wFlags & 0xfffU | 0x7000;
        }
      }
      else {
        pTVar6->wFlags = pTVar6->wFlags & 0xfffU | 0x6000;
      }
    }
    else {
      pTVar6->wFlags = pTVar6->wFlags & 0xfffU | 0x4000;
    }
  }
  else {
    pTVar6->wFlags = pTVar6->wFlags & 0xfffU | 0x3000;
  }
  uVar1 = ((undefined2 *)&DAT_1120_593a)[uVar2 * 2];
  pBVar5 = ((BTLPLAN **)rglpbtlplan)[uVar2 * 2] + ((FLEET *)lpfl)->iplan;
  lpbtlplan = (BTLPLAN *)CONCAT22(uVar1,pBVar5);
  pTVar6->wFlags = pTVar6->wFlags & 0xfff0U | pBVar5->wFlags & 0xfU;
  pTVar6->wFlags = pTVar6->wFlags & 0xff0fU | ((uint)pBVar5->wFlags >> 4 & 0xf) << 4;
  if ((uint)pTVar6->wFlags >> 0xc == 3) {
    pTVar6->wFlags = pTVar6->wFlags & 0xf0ffU | ((uint)lpbtlplan->wFlags >> 8 & 0xf) << 8;
  }
  else {
    pTVar6->wFlags = pTVar6->wFlags & 0xf0ff;
  }
  if (((uint)pTVar6->wFlags >> 8 & 0xf) == 0) {
    pTVar6->wFlags = pTVar6->wFlags & 0xfc1fU | 0xe0;
  }
  return;
}



// ======================================================================
// Function: FDumpCargo
// Address: 10f0:234a
// Segment: MEMORY_BATTLE
// ======================================================================


short FDumpCargo(FLEET *lpfl)

{
  uint *puVar1;
  uint uVar2;
  uint uVar3;
  short sVar4;
  undefined2 uVar5;
  uint uVar6;
  long *plVar7;
  PLANET *pPVar8;
  short i;
  POINT pt;
  
  i = 0;
  while( true ) {
    if (((2 < i) || ((int)((FLEET *)lpfl)->rgwtMin[i] != 0)) ||
       (*(int *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) != 0)) break;
    i = i + 1;
  }
  if (i < 3) {
    uVar6 = (uint)lpfl->id >> 9 & 0xf;
    if ((((BTLPLAN **)rglpbtlplan)[uVar6 * 2] + ((FLEET *)lpfl)->iplan)->wFlags < 0) {
      if (((FLEET *)lpfl)->idPlanet == -1) {
        pt.x = (&((FLEET *)lpfl)->pt)->x;
        pt.y = (((FLEET *)lpfl)->pt).y;
        DropSalvage((THING **)&lpthBattle,
                    (long *)CONCAT22(lpfl._2_2_,((FLEET *)lpfl)->rgwtMin),(uint)lpfl->id >> 9 & 0xf,
                    &pt);
      }
      else {
        pPVar8 = LpplFromId(((FLEET *)lpfl)->idPlanet);
        uVar5 = (undefined2)((ulong)pPVar8 >> 0x10);
        for (i = 0; i < 3; i = i + 1) {
          uVar2 = *(uint *)(((FLEET *)lpfl)->rgwtMin + i);
          uVar3 = *(uint *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2);
          plVar7 = ((PLANET *)pPVar8)->rgwtMin + i;
          puVar1 = (uint *)plVar7;
          uVar6 = *puVar1;
          *puVar1 = *puVar1 + uVar2;
          puVar1 = (uint *)((int)plVar7 + 2);
          *puVar1 = *puVar1 + uVar3 + (uint)CARRY2(uVar6,uVar2);
        }
      }
      for (i = 0; i < 3; i = i + 1) {
        *(undefined2 *)(((FLEET *)lpfl)->rgwtMin + i) = 0;
        *(undefined2 *)((int)(((FLEET *)lpfl)->rgwtMin + i) + 2) = 0;
      }
      sVar4 = 1;
    }
    else {
      sVar4 = 0;
    }
  }
  else {
    sVar4 = 0;
  }
  return sVar4;
}



// ======================================================================
// Function: DropSalvage
// Address: 10f0:24dc
// Segment: MEMORY_BATTLE
// ======================================================================


void DropSalvage(THING **plpth,long *rgwtMinerals,short iplr,POINT *ppt)

{
  uint *puVar1;
  uint uVar2;
  short sVar3;
  uint uVar4;
  int iVar5;
  THING *pTVar6;
  undefined2 uVar7;
  bool bVar8;
  ulong uVar9;
  long lVar10;
  THING *lpth;
  short i;
  uint wtTotal;
  int local_6;
  
                    /* WARNING: Load size is inaccurate */
  pTVar6 = *plpth;
  iVar5 = *(int *)((int)plpth + 2);
  lpth = (THING *)CONCAT22(iVar5,pTVar6);
  wtTotal = 0;
  local_6 = 0;
  for (i = 0; i < game.cPlanMax; i = i + 1) {
    if ((ppt->x == ((POINT *)rgptPlan + i)->x) &&
       (ppt->y == *(int *)((int)&rgptPlan[0].y + i * 4))) {
      return;
    }
  }
  i = 0;
  while( true ) {
    if (2 < i) break;
    uVar4 = *(uint *)((long *)rgwtMinerals + i);
    bVar8 = CARRY2(wtTotal,uVar4);
    wtTotal = wtTotal + uVar4;
    local_6 = local_6 + *(uint *)((int)((long *)rgwtMinerals + i) + 2) + (uint)bVar8;
    i = i + 1;
  }
  while ((wtTotal == 0 && (local_6 == 0))) {
    for (i = 0; i < 3; i = i + 1) {
      sVar3 = Random(10);
      *(short *)((long *)rgwtMinerals + i) = sVar3;
      *(short *)((int)((long *)rgwtMinerals + i) + 2) = sVar3 >> 0xf;
      uVar4 = *(uint *)((long *)rgwtMinerals + i);
      bVar8 = CARRY2(wtTotal,uVar4);
      wtTotal = wtTotal + uVar4;
      local_6 = local_6 + *(uint *)((int)((long *)rgwtMinerals + i) + 2) + (uint)bVar8;
    }
  }
  if ((pTVar6 == (THING *)0x0) && (iVar5 == 0)) {
    lpth = LpthNew(iplr,ithMineralPacket);
    iVar5 = (int)((ulong)lpth >> 0x10);
    pTVar6 = (THING *)lpth;
    if ((pTVar6 == (THING *)0x0) && (iVar5 == 0)) {
      return;
    }
    *(uint *)pTVar6->rgb = *(uint *)pTVar6->rgb & 0xc3ff;
    sVar3 = ppt->y;
    (&pTVar6->pt)->x = ppt->x;
    (pTVar6->pt).y = sVar3;
    *(uint *)pTVar6->rgb = *(uint *)pTVar6->rgb & 0xfc00 | 0x3ff;
  }
  else {
    for (i = 0; i < 3; i = i + 1) {
      uVar2 = *(uint *)(pTVar6->rgb + i * 2 + 2);
      puVar1 = (uint *)((long *)rgwtMinerals + i);
      uVar4 = *puVar1;
      *puVar1 = *puVar1 + uVar2;
      puVar1 = (uint *)((int)((long *)rgwtMinerals + i) + 2);
      *puVar1 = *puVar1 + ((int)uVar2 >> 0xf) + (uint)CARRY2(uVar4,uVar2);
      uVar4 = *(uint *)(pTVar6->rgb + i * 2 + 2);
      bVar8 = CARRY2(wtTotal,uVar4);
      wtTotal = wtTotal + uVar4;
      local_6 = local_6 + ((int)uVar4 >> 0xf) + (uint)bVar8;
      (pTVar6->rgb + i * 2 + 2)[0] = 0;
      (pTVar6->rgb + i * 2 + 2)[1] = 0;
    }
    *(uint *)(pTVar6->rgb + 8) = *(uint *)(pTVar6->rgb + 8) & 0xc000;
  }
  uVar7 = (undefined2)((ulong)lpth >> 0x10);
  *(uint *)((THING *)lpth)->rgb = *(uint *)((THING *)lpth)->rgb & 0xbfff | 0x4000;
  do {
    if ((local_6 < 1) && ((local_6 < 0 || (wtTotal == 0)))) {
      *(THING **)plpth = (THING *)lpth;
      *(undefined2 *)((int)plpth + 2) = lpth._2_2_;
      return;
    }
    for (i = 0; i < 3; i = i + 1) {
      uVar7 = (undefined2)((ulong)lpth >> 0x10);
      pTVar6 = (THING *)lpth;
      uVar9 = __aFulmul((ulong)*(uint *)(pTVar6->rgb + 8) & 0xffff3fff,10);
      puVar1 = (uint *)((long *)rgwtMinerals + i);
      iVar5 = (int)(uVar9 >> 0x10) + *(uint *)((int)((long *)rgwtMinerals + i) + 2) +
              (uint)CARRY2((uint)uVar9,*puVar1);
      if ((iVar5 < 0) || ((iVar5 < 1 && ((uint)uVar9 + *puVar1 < 0x7531)))) {
        uVar4 = *(uint *)((long *)rgwtMinerals + i);
        lVar10 = __aFldiv(CONCAT22(*(uint *)((int)((long *)rgwtMinerals + i) + 2) +
                                           (uint)(0xfff6 < uVar4),uVar4 + 9),10);
        iVar5 = *(int *)(pTVar6->rgb + 8);
        *(uint *)(pTVar6->rgb + 8) = *(uint *)(pTVar6->rgb + 8) & 0xc000;
        *(uint *)(pTVar6->rgb + 8) = *(uint *)(pTVar6->rgb + 8) | (int)lVar10 + iVar5 & 0x3fffU;
        *(int *)(pTVar6->rgb + i * 2 + 2) =
             *(int *)(pTVar6->rgb + i * 2 + 2) + (int)((long *)rgwtMinerals)[i];
        uVar4 = *(uint *)((long *)rgwtMinerals + i);
        local_6 = (local_6 - *(uint *)((int)((long *)rgwtMinerals + i) + 2)) -
                  (uint)(wtTotal < uVar4);
        *(undefined2 *)((long *)rgwtMinerals + i) = 0;
        *(undefined2 *)((int)((long *)rgwtMinerals + i) + 2) = 0;
      }
      else {
        uVar9 = __aFulmul((ulong)*(uint *)(pTVar6->rgb + 8) & 0xffff3fff,10);
        uVar4 = 30000 - (uint)uVar9;
        iVar5 = -(uint)(30000 < (uint)uVar9) - (int)(uVar9 >> 0x10);
        local_6 = (local_6 - iVar5) - (uint)(wtTotal < uVar4);
        *(uint *)(pTVar6->rgb + 8) = *(uint *)(pTVar6->rgb + 8) & 0xc000 | 3000;
        *(uint *)(pTVar6->rgb + i * 2 + 2) = *(int *)(pTVar6->rgb + i * 2 + 2) + uVar4;
        puVar1 = (uint *)((long *)rgwtMinerals + i);
        uVar2 = *puVar1;
        *puVar1 = *puVar1 - uVar4;
        puVar1 = (uint *)((int)((long *)rgwtMinerals + i) + 2);
        *puVar1 = (*puVar1 - iVar5) - (uint)(uVar2 < uVar4);
        lpth = LpthNew(iplr,ithMineralPacket);
        iVar5 = (int)((ulong)lpth >> 0x10);
        pTVar6 = (THING *)lpth;
        if ((pTVar6 == (THING *)0x0) && (iVar5 == 0)) {
          return;
        }
        *(uint *)pTVar6->rgb = *(uint *)pTVar6->rgb & 0xc3ff;
        *(uint *)pTVar6->rgb = *(uint *)pTVar6->rgb & 0xfc00 | 0x3ff;
        sVar3 = ppt->y;
        (&pTVar6->pt)->x = ppt->x;
        (pTVar6->pt).y = sVar3;
      }
      wtTotal = wtTotal - uVar4;
      if ((local_6 < 1) && ((local_6 < 0 || (wtTotal == 0)))) break;
    }
  } while( true );
}



// ======================================================================
// Function: CplrBattle
// Address: 10f0:2952
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f03389) */

short CplrBattle(FLEET *lpfl,ushort *rggrfAttack,ushort *pgrfPlayer,ushort *pgrfSpectator)

{
  uint *puVar1;
  int iVar2;
  uint uVar3;
  PLANET *pPVar4;
  bool bVar5;
  short sVar6;
  byte bVar7;
  FLEET *pFVar8;
  uint uVar9;
  undefined2 uVar10;
  HULDEF *pHVar11;
  short ctokFleet;
  short ctokNew;
  ushort grfPlayer;
  short cflTotal;
  short ishdef;
  short cshdef;
  short fAttack;
  ushort iplrAttack;
  short fChange;
  byte rgctok [16];
  short mdRel;
  short i;
  short cplr;
  PLANET *lppl;
  short iplrCur;
  ushort grPlr;
  uint rgcsh [32];
  FLEET *lpflCur;
  short iplrStarbase;
  
  bVar5 = false;
  iplrStarbase = -1;
  grfPlayer = 0;
  cshdef = 0;
  grfMissed = 0;
  *pgrfSpectator = 0;
  _memset(rggrfAttack,0,0x20);
  _memset(rgcsh,0,0x40);
  uVar10 = (undefined2)((ulong)lpfl >> 0x10);
  if (((FLEET *)lpfl)->idPlanet != -1) {
    lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
    uVar10 = (undefined2)((ulong)lppl >> 0x10);
    pPVar4 = (PLANET *)lppl;
    if (((uint)pPVar4->wFlags >> 9 & 1) == 0) {
      if (pPVar4->iPlayer != -1) {
        *pgrfSpectator = *pgrfSpectator | 1 << ((byte)pPVar4->iPlayer & 0x1f);
      }
    }
    else {
      iplrStarbase = pPVar4->iPlayer;
      grfPlayer = 1 << ((byte)iplrStarbase & 0x1f);
      uVar9 = *(uint *)((int)*(undefined4 *)((BTLPLAN **)rglpbtlplan + iplrStarbase * 2) +
                       2) >> 8 & 0x1f;
      sVar6 = FHullHasTeeth((HUL *)CONCAT22(*(undefined2 *)(iplrStarbase * 4 + 0x14e),
                                            (HUL *)(*(int *)(iplrStarbase * 4 + 0x14c) +
                                                   (*(uint *)&pPVar4->field11_0x2c & 0xf) * 0x93)));
      if ((sVar6 != 0) && (uVar9 != 0)) {
        if ((uVar9 == 1) || (uVar9 == 2)) {
          for (i = 0; i < game.cPlayer; i = i + 1) {
            if ((i != iplrStarbase) &&
               ((mdRel = (short)*(char *)(iplrStarbase * 0xc0 + 0x5a12 + i), mdRel == 2 ||
                ((mdRel == 0 && (uVar9 == 2)))))) {
              rggrfAttack[iplrStarbase] = rggrfAttack[iplrStarbase] | 1 << ((byte)i & 0x1f);
            }
          }
        }
        else if (uVar9 == 3) {
          rggrfAttack[iplrCur] = ~(1 << ((byte)iplrStarbase & 0x1f));
        }
        else {
          rggrfAttack[iplrCur] = rggrfAttack[iplrCur] | 1 << ((char)uVar9 - 4U & 0x1f);
        }
      }
    }
  }
  lpflCur = lpfl;
  do {
    uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
    pFVar8 = (FLEET *)lpflCur;
    if (((uint)pFVar8->wFlags >> 10 & 1) == 0) {
      iplrCur = pFVar8->iPlayer;
      grfPlayer = grfPlayer | 1 << ((byte)iplrCur & 0x1f);
      uVar9 = (uint)lpflCur->id >> 9 & 0xf;
      if ((((((BTLPLAN **)rglpbtlplan)[uVar9 * 2][pFVar8->iplan].wFlags & 0xfU) != 0) &&
          (uVar9 = (uint)lpflCur->id >> 9 & 0xf,
          ((uint)((BTLPLAN **)rglpbtlplan)[uVar9 * 2][pFVar8->iplan].wFlags >> 8 & 0x1f)
          != 0)) && (sVar6 = FFleetHasTeeth(lpflCur), sVar6 != 0)) {
        bVar5 = true;
        uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
        iplrAttack = (uint)((BTLPLAN **)rglpbtlplan)[iplrCur * 2]
                           [((FLEET *)lpflCur)->iplan].wFlags >> 8 & 0x1f;
        uVar9 = (uint)lpflCur->id >> 9 & 0xf;
        if ((((BTLPLAN **)rglpbtlplan)[uVar9 * 2][((FLEET *)lpflCur)->iplan].wFlags & 0xfU
            ) == 0) {
          iplrAttack = 0;
        }
        if (iplrAttack != 0) {
          if ((iplrAttack == 1) || (iplrAttack == 2)) {
            for (i = 0; i < game.cPlayer; i = i + 1) {
              if ((i != iplrCur) &&
                 ((mdRel = (short)*(char *)(iplrCur * 0xc0 + 0x5a12 + i), mdRel == 2 ||
                  ((mdRel == 0 && (iplrAttack == 2)))))) {
                rggrfAttack[iplrCur] = rggrfAttack[iplrCur] | 1 << ((byte)i & 0x1f);
              }
            }
          }
          else if (iplrAttack == 3) {
            rggrfAttack[iplrCur] = ~(1 << ((byte)iplrCur & 0x1f));
          }
          else {
            rggrfAttack[iplrCur] = rggrfAttack[iplrCur] | 1 << ((char)iplrAttack - 4U & 0x1f);
          }
        }
      }
      uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
      pFVar8 = (FLEET *)lpflCur;
      pFVar8->wFlags = pFVar8->wFlags & 0xf7ffU | 0x800;
      pFVar8->wFlags = pFVar8->wFlags & 0xfeffU | 0x100;
    }
    sVar6 = iplrStarbase;
    uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
                    /* WARNING: Load size is inaccurate */
    lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                ((FLEET *)lpflCur)->lpflNext);
  } while (lpfl != lpflCur);
  if (bVar5) {
    iplrAttack = 0;
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (rggrfAttack[i] != 0) {
        iplrAttack = iplrAttack | grfPlayer & rggrfAttack[i];
      }
    }
    if (iplrAttack == 0) {
      cplr = 0;
    }
    else {
      for (i = 0; i < game.cPlayer; i = i + 1) {
        bVar7 = (byte)i;
        if ((rggrfAttack[i] & iplrAttack) != 0) {
          iplrAttack = iplrAttack | 1 << (bVar7 & 0x1f);
        }
        if ((1 << (bVar7 & 0x1f) & iplrAttack) != 0) {
          for (iplrCur = 0; iplrCur < game.cPlayer; iplrCur = iplrCur + 1) {
            if ((1 << (bVar7 & 0x1f) & rggrfAttack[iplrCur]) != 0) {
              rggrfAttack[i] = rggrfAttack[i] | 1 << ((byte)iplrCur & 0x1f);
            }
          }
        }
      }
      do {
        if (lpfl == lpflCur) {
          fChange = 0;
        }
        iVar2 = ((FLEET *)lpflCur)->iPlayer;
        uVar9 = 1 << ((byte)iVar2 & 0x1f);
        if (((grfPlayer & uVar9) != 0) && ((iplrAttack & uVar9) == 0)) {
          rggrfAttack[iVar2] = 0;
          for (i = 0; i < game.cPlayer; i = i + 1) {
            if (((i != iVar2) && (*(char *)(iVar2 * 0xc0 + 0x5a12 + i) == '\x01')) &&
               ((1 << ((byte)i & 0x1f) & iplrAttack) != 0)) {
              if ((1 << ((byte)i & 0x1f) & rggrfAttack[iVar2]) != 0) {
                rggrfAttack[iVar2] = 0;
                break;
              }
              rggrfAttack[iVar2] = rggrfAttack[iVar2] | rggrfAttack[i];
            }
          }
          if (rggrfAttack[iVar2] == 0) {
            grfPlayer = grfPlayer & ~uVar9;
          }
          else {
            iplrAttack = iplrAttack | uVar9;
          }
          fChange = 1;
        }
                    /* WARNING: Load size is inaccurate */
        lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                    ((FLEET *)lpflCur)->lpflNext);
      } while ((fChange != 0) || (lpfl != lpflCur));
      if ((iplrStarbase != -1) && ((1 << ((byte)iplrStarbase & 0x1f) & grfPlayer) != 0)) {
        rgcsh[iplrStarbase * 2] = 1;
        rgcsh[sVar6 * 2 + 1] = 0;
        cshdef = 1;
      }
      do {
        uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
        pFVar8 = (FLEET *)lpflCur;
        iplrCur = pFVar8->iPlayer;
        grPlr = 1 << ((byte)iplrCur & 0x1f);
        if ((grfPlayer & grPlr) == 0) {
          *pgrfSpectator = *pgrfSpectator | grPlr;
          pFVar8->wFlags = pFVar8->wFlags & 0xfeff;
        }
        else {
          for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
            if (((FLEET *)lpflCur)->rgcsh[ishdef] != 0) {
              pHVar11 = LphuldefFromId
                                  (*(HullDef *)(*(int *)(iplrCur * 4 + 0xfe) + ishdef * 0x93));
              if (((uint)((HULDEF *)pHVar11)->wFlags >> 6 & 0xf) != 0) {
                uVar3 = ((FLEET *)lpflCur)->rgcsh[ishdef];
                puVar1 = rgcsh + iplrCur * 2;
                uVar9 = *puVar1;
                *puVar1 = *puVar1 + uVar3;
                rgcsh[iplrCur * 2 + 1] =
                     rgcsh[iplrCur * 2 + 1] + ((int)uVar3 >> 0xf) + (uint)CARRY2(uVar9,uVar3);
              }
              cshdef = cshdef + 1;
            }
          }
        }
        uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
                    /* WARNING: Load size is inaccurate */
        lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                    ((FLEET *)lpflCur)->lpflNext);
      } while (lpfl != lpflCur);
      cplr = 0;
      for (; iplrAttack != 0; iplrAttack = iplrAttack >> 1) {
        if ((iplrAttack & 1) != 0) {
          cplr = cplr + 1;
        }
      }
      if (0xff < cshdef) {
        ctokNew = 0;
        i = (short)(0xff / (long)cplr);
        if ((iplrStarbase != -1) && ((1 << ((byte)iplrStarbase & 0x1f) & grfPlayer) != 0)) {
          ctokNew = 1;
        }
        _memset(rgctok,0,0x10);
        do {
          uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
          pFVar8 = (FLEET *)lpflCur;
          if (((uint)pFVar8->wFlags >> 8 & 1) != 0) {
            ctokFleet = 0;
            iplrCur = pFVar8->iPlayer;
            for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
              if (pFVar8->rgcsh[ishdef] != 0) {
                ctokFleet = ctokFleet + 1;
              }
            }
            if (i < (int)((uint)rgctok[iplrCur] + ctokFleet)) {
              pFVar8->wFlags = pFVar8->wFlags & 0xfeff;
              pFVar8->wFlags = pFVar8->wFlags & 0xefffU | 0x1000;
              pFVar8->wFlags = pFVar8->wFlags & 0xff7fU | 0x80;
            }
            else {
              rgctok[iplrCur] = rgctok[iplrCur] + (char)ctokFleet;
              ctokNew = ctokNew + ctokFleet;
            }
          }
          uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
                    /* WARNING: Load size is inaccurate */
          lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                      ((FLEET *)lpflCur)->lpflNext);
        } while (lpfl != lpflCur);
        if (ctokNew < 0xff) {
          do {
            uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
            pFVar8 = (FLEET *)lpflCur;
            if (((uint)pFVar8->wFlags >> 7 & 1) != 0) {
              ctokFleet = 0;
              iplrCur = pFVar8->iPlayer;
              for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
                if (pFVar8->rgcsh[ishdef] != 0) {
                  ctokFleet = ctokFleet + 1;
                }
              }
              if (ctokNew + ctokFleet < 0x100) {
                pFVar8->wFlags = pFVar8->wFlags & 0xfeffU | 0x100;
                pFVar8->wFlags = pFVar8->wFlags & 0xefff;
                pFVar8->wFlags = pFVar8->wFlags & 0xff7f;
                rgctok[iplrCur] = rgctok[iplrCur] + (char)ctokFleet;
                ctokNew = ctokNew + ctokFleet;
              }
            }
            uVar10 = (undefined2)((ulong)lpflCur >> 0x10);
                    /* WARNING: Load size is inaccurate */
            lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                        ((FLEET *)lpflCur)->lpflNext);
          } while (lpfl != lpflCur);
        }
      }
      *pgrfPlayer = grfPlayer;
    }
  }
  else {
    cplr = 0;
  }
  return cplr;
}



// ======================================================================
// Function: SpdOfShip
// Address: 10f0:339c
// Segment: MEMORY_BATTLE
// ======================================================================


short SpdOfShip(FLEET *lpfl,short ishdef,TOK *ptok,short fDumpCargo,SHDEF *lpshdef)

{
  HullSlotType HVar1;
  uint uVar2;
  short sVar3;
  uint uVar4;
  uint uVar5;
  FLEET *pFVar6;
  int iVar7;
  SHDEF *pSVar8;
  TOK *pTVar9;
  undefined2 uVar10;
  undefined2 uVar11;
  undefined2 uVar12;
  ENGINE *pEVar13;
  long lVar14;
  ulong uVar15;
  short iEngine;
  ushort wtCargoShdefMax;
  short cEngineT;
  short j;
  short cThruster;
  short cHalfThruster;
  ushort wt;
  short iWarp;
  short spd;
  
  pFVar6 = (FLEET *)lpfl;
  uVar10 = (undefined2)((ulong)lpfl >> 0x10);
  if (((SHDEF *)lpshdef == (SHDEF *)0x0) && (lpshdef._2_2_ == 0)) {
    iVar7 = pFVar6->iPlayer * 4;
    lpshdef = (SHDEF *)CONCAT22(*(undefined2 *)(iVar7 + 0x100),
                                (SHDEF *)(*(int *)(iVar7 + 0xfe) + ishdef * 0x93));
  }
  iEngine = -1;
  cHalfThruster = 0;
  cThruster = 0;
  j = 0;
  while( true ) {
    uVar11 = (undefined2)((ulong)lpshdef >> 0x10);
    pSVar8 = (SHDEF *)lpshdef;
    if ((int)(uint)(pSVar8->hul).chs <= j) break;
    if ((uint)(pSVar8->hul).rghs[j].wFlags >> 8 != 0) {
      HVar1 = ((pSVar8->hul).rghs + j)->grhst;
      if (HVar1 == hstEngine) {
        iEngine = (pSVar8->hul).rghs[j].wFlags & 0xff;
        cEngineT = (uint)(pSVar8->hul).rghs[j].wFlags >> 8;
        if (iEngine == 8) {
          cHalfThruster = cHalfThruster + ((uint)(pSVar8->hul).rghs[j].wFlags >> 8);
        }
      }
      else if (HVar1 == hstMining) {
        if (((pSVar8->hul).rghs[j].wFlags & 0xffU) == 6) {
          cHalfThruster = cHalfThruster + ((uint)(pSVar8->hul).rghs[j].wFlags >> 8);
        }
      }
      else if (HVar1 == hstSpecialE) {
        if (((pSVar8->hul).rghs[j].wFlags & 0xffU) == 4) {
          cThruster = cThruster + ((uint)(pSVar8->hul).rghs[j].wFlags >> 8);
        }
      }
      else if (HVar1 == hstSpecialM) {
        uVar2 = (pSVar8->hul).rghs[j].wFlags & 0xff;
        if (uVar2 == 7) {
          cThruster = cThruster + ((uint)(pSVar8->hul).rghs[j].wFlags >> 8);
        }
        else if (uVar2 == 8) {
          cThruster = cThruster + ((uint)(pSVar8->hul).rghs[j].wFlags >> 8) * 2;
        }
      }
    }
    j = j + 1;
  }
  if ((iEngine == -1) || (cEngineT == 0)) {
    uVar2 = 0;
  }
  else {
    pEVar13 = LpengineFromId(iEngine);
    if ((((iEngine == 7) || (iEngine == 8)) || (iEngine == 9)) ||
       ((iEngine == 0xe || (iEngine == 0xf)))) {
      iWarp = 10;
    }
    else {
      for (iWarp = 9; (0 < iWarp && (0x78 < ((ENGINE *)pEVar13)->rgcFuelUsed[iWarp]));
          iWarp = iWarp + -1) {
      }
    }
    spd = iWarp + -4 + cThruster + (cHalfThruster + 1) / 2;
    if (lpfl != (FLEET *)0x0) {
      sVar3 = GetRaceStat((PLAYER *)rgplr + pFVar6->iPlayer,rsMajorAdv);
      spd = spd + (uint)(sVar3 == raAttack) * 2;
    }
    wt = (pSVar8->hul).wtEmpty;
    pTVar9 = (TOK *)ptok;
    uVar12 = (undefined2)((ulong)ptok >> 0x10);
    if (lpfl != (FLEET *)0x0) {
      uVar2 = WtMaxShdefStat(lpshdef,2);
      if (uVar2 == 0) {
        fDumpCargo = 0;
      }
      else {
        lVar14 = LGetFleetStat(lpfl,2);
        uVar4 = *(uint *)pFVar6->rgwtMin + *(uint *)(pFVar6->rgwtMin + 1);
        uVar5 = uVar4 + *(uint *)(pFVar6->rgwtMin + 2);
        uVar15 = __aFulmul(CONCAT22(*(int *)((int)pFVar6->rgwtMin + 2) +
                                            *(int *)((int)pFVar6->rgwtMin + 6) +
                                            (uint)CARRY2(*(uint *)pFVar6->rgwtMin,
                                                         *(uint *)(pFVar6->rgwtMin + 1)) +
                                            *(int *)((int)pFVar6->rgwtMin + 10) +
                                            (uint)CARRY2(uVar4,*(uint *)(pFVar6->rgwtMin + 2)) +
                                            *(int *)((int)pFVar6->rgwtMin + 0xe) +
                                            (uint)CARRY2(uVar5,*(uint *)(pFVar6->rgwtMin + 3)),
                                            uVar5 + *(uint *)(pFVar6->rgwtMin + 3)),(ulong)uVar2);
        lVar14 = __aFldiv(uVar15,lVar14);
        wt = wt + (int)lVar14;
      }
      if (fDumpCargo != 0) {
        spd = spd + -1;
      }
      uVar2 = Random(0xf);
      pTVar9->wFlags = pTVar9->wFlags & 0xc3ffU | (uVar2 & 0xf) << 10;
    }
    if (ptok != (TOK *)0x0) {
      pTVar9->wt = wt;
    }
    uVar2 = spd - (int)(((ulong)wt / 0x46) / (ulong)((uint)(pSVar8->hul).rghs[0].wFlags >> 8));
    uVar4 = uVar2;
    if (8 < (int)uVar2) {
      uVar4 = 8;
    }
    if (uVar4 < 0x8000) {
      if (8 < (int)uVar2) {
        uVar2 = 8;
      }
    }
    else {
      uVar2 = 0;
    }
  }
  return uVar2;
}



// ======================================================================
// Function: LpshdefFromTok
// Address: 10f0:388e
// Segment: MEMORY_BATTLE
// ======================================================================


SHDEF * LpshdefFromTok(TOK *ptok)

{
  SHDEF *pSVar1;
  undefined2 uVar2;
  TOK *pTVar3;
  int iVar4;
  undefined2 uVar5;
  
  uVar5 = (undefined2)((ulong)ptok >> 0x10);
  pTVar3 = (TOK *)ptok;
  if (pTVar3->ishdef < 0x10) {
    iVar4 = (uint)pTVar3->iplr * 4;
    uVar2 = *(undefined2 *)(iVar4 + 0x100);
    pSVar1 = (SHDEF *)(*(int *)(iVar4 + 0xfe) + (uint)pTVar3->ishdef * 0x93);
  }
  else {
    iVar4 = (uint)pTVar3->iplr * 4;
    uVar2 = *(undefined2 *)(iVar4 + 0x14e);
    pSVar1 = (SHDEF *)(*(int *)(iVar4 + 0x14c) + (pTVar3->ishdef - 0x10) * 0x93);
  }
  return (SHDEF *)CONCAT22(uVar2,pSVar1);
}



// ======================================================================
// Function: FCanKillTok
// Address: 10f0:391e
// Segment: MEMORY_BATTLE
// ======================================================================


short FCanKillTok(TOK *ptok1,TOK *ptok2)

{
  uint uVar1;
  uint uVar2;
  uint uVar3;
  uint uVar4;
  short sVar5;
  undefined2 uVar6;
  SHDEF *pSVar7;
  
  pSVar7 = LpshdefFromTok(ptok1);
  uVar6 = (undefined2)((ulong)pSVar7 >> 0x10);
  uVar1 = *(uint *)&((SHDEF *)pSVar7)->lPower;
  uVar2 = *(uint *)((int)&((SHDEF *)pSVar7)->lPower + 2);
  pSVar7 = LpshdefFromTok(ptok2);
  uVar6 = (undefined2)((ulong)pSVar7 >> 0x10);
  uVar3 = *(uint *)&((SHDEF *)pSVar7)->lPower;
  uVar4 = *(uint *)((int)&((SHDEF *)pSVar7)->lPower + 2);
  if (((int)uVar4 < (int)uVar2) || (((int)uVar4 <= (int)uVar2 && (uVar3 <= uVar1)))) {
    if (((uVar2 & 0x7fff) < (uVar4 & 0x7fff)) ||
       (((uVar2 & 0x7fff) <= (uVar4 & 0x7fff) && ((uVar1 & 0xf000) <= (uVar3 & 0xf000))))) {
      if ((((uVar3 & 0xff00) == (uVar1 & 0xff00)) && ((uVar4 & 0x7fff) == (uVar2 & 0x7fff))) &&
         (((uint)((TOK *)ptok2)->wFlags >> 8 & 0xf) <= ((uint)((TOK *)ptok1)->wFlags >> 8 & 0xf))) {
        sVar5 = 1;
      }
      else {
        sVar5 = 0;
      }
    }
    else {
      sVar5 = 1;
    }
  }
  else {
    sVar5 = 0;
  }
  return sVar5;
}



// ======================================================================
// Function: DoBattles
// Address: 10f0:3a26
// Segment: MEMORY_BATTLE
// ======================================================================


void DoBattles(short fPostMovement)

{
  FLEET *pFVar1;
  int iVar2;
  byte *pbVar3;
  ushort rggrfAttack [16];
  ushort grfPlayer;
  ushort grfSpectator;
  FLEET *lpfl;
  short ifl;
  short cplr;
  
  LinkFleets(fPostMovement);
  vrgtok = LpAlloc(0x1d00,htMisc);
  vlpwtCargo = LpAlloc(0x200,htMisc);
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET **)rglpfl)[ifl];
    iVar2 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar2,pFVar1);
    if ((pFVar1 == (FLEET *)0x0) && (iVar2 == 0)) break;
    pFVar1->wFlags = pFVar1->wFlags & 0xefff;
    if (((((uint)pFVar1->wFlags >> 0xb & 1) == 0) && (((uint)pFVar1->wFlags >> 10 & 1) == 0)) &&
       ((*(int *)&pFVar1->lpflNext != 0 || (*(int *)((int)&pFVar1->lpflNext + 2) != 0)))) {
      cplr = CplrBattle((FLEET *)CONCAT22(iVar2,pFVar1),rggrfAttack,&grfPlayer,&grfSpectator);
      if ((cplr != -1) && (cplr != 0)) {
        FDoCoolBattle(lpfl,cplr,rggrfAttack,grfPlayer,grfSpectator);
      }
    }
  }
  FreeLp(vlpwtCargo,htMisc);
  FreeLp(vrgtok,htMisc);
  vlpwtCargo._0_2_ = (ushort *)0x0;
  vlpwtCargo._2_2_ = 0;
  vrgtok._0_2_ = (TOK *)0x0;
  vrgtok._2_2_ = 0;
  if (((byte *)lpbBattleT != (byte *)0x0) || (lpbBattleT._2_2_ != 0)) {
    pbVar3 = lpbBattleT;
    pbVar3[0] = 0xff;
    pbVar3[1] = 0xff;
    FreeLp(lpbBattleT,htBattle);
    lpbBattleT = (byte *)0x0;
  }
  if (((byte *)lpbBattleCur != (byte *)0x0) || (lpbBattleCur._2_2_ != 0)) {
    pbVar3 = lpbBattleCur;
    pbVar3[0] = 0xff;
    pbVar3[1] = 0xff;
  }
  DoBombing();
  return;
}



// ======================================================================
// Function: RegenShield
// Address: 10f0:3c16
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f03c92) */

void RegenShield(TOK *ptok)

{
  uint iplr;
  TOK *pTVar1;
  undefined2 uVar2;
  SHDEF *lpshdef;
  long lVar3;
  long lVar4;
  short dpOrig;
  short dpNew;
  
  uVar2 = (undefined2)((ulong)ptok >> 0x10);
  pTVar1 = (TOK *)ptok;
  iplr = (uint)pTVar1->iplr;
  lpshdef = LpshdefFromTok(ptok);
  lVar3 = DpShieldOfShdef(lpshdef,iplr);
  if (pTVar1->dpShield != 0) {
    lVar4 = __aFldiv(lVar3,10);
    dpOrig = (short)lVar3;
    lVar4 = lVar4 + (ulong)(uint)pTVar1->dpShield;
    dpNew = (short)lVar4;
    if (lVar3 < lVar4) {
      dpNew = dpOrig;
    }
    pTVar1->dpShield = dpNew;
  }
  return;
}



// ======================================================================
// Function: InitFromHuldef
// Address: 10f0:3cba
// Segment: MEMORY_BATTLE
// ======================================================================


short InitFromHuldef(HUL *lphul,short *ppctBC)

{
  uint uVar1;
  HS *pHVar2;
  undefined2 uVar3;
  HULDEF *pHVar4;
  PART part;
  short pctBC;
  short cbc;
  short initBase;
  short pct;
  short i;
  short ihs;
  
  pct = 0;
  cbc = 0;
  pHVar4 = LphuldefFromId(lphul->ihuldef);
  initBase = ((HULDEF *)pHVar4)->wFlags & 0x3f;
  ihs = 0;
  while( true ) {
    uVar3 = (undefined2)((ulong)lphul >> 0x10);
    if ((int)(uint)((HUL *)lphul)->chs <= ihs) break;
    pHVar2 = ((HUL *)lphul)->rghs + ihs;
    part.hs.grhst = pHVar2->grhst;
    part.hs.wFlags = pHVar2->wFlags;
    if ((uint)part.hs.wFlags >> 8 != 0) {
      if ((part.hs.grhst & hstSpecialE) ==
          ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
            hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
        if (((part.hs.grhst & hstBeam) !=
             ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines
               |hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
           ((part.hs.wFlags & 0xffU) == 0x12)) {
          pctBC = 10;
          for (i = 0; i < (int)((uint)part.hs.wFlags >> 8); i = i + 1) {
            pct = pct + ((100 - pct) * 10) / 100;
          }
        }
      }
      else {
        uVar1 = part.hs.wFlags & 0xff;
        if (((uVar1 == 5) || (uVar1 == 6)) || (uVar1 == 7)) {
          FLookupPart(&part);
          cbc = cbc + ((part.hs.wFlags & 0xffU) - 4) * ((uint)part.hs.wFlags >> 8);
          pctBC = ((COMPART *)part.pcom + 1)->id;
          for (i = 0; i < (int)((uint)part.hs.wFlags >> 8); i = i + 1) {
            pct = pct + ((100 - pct) * pctBC) / 100;
          }
        }
      }
    }
    ihs = ihs + 1;
  }
  if (ppctBC != (short *)0x0) {
    *ppctBC = pct;
  }
  initBase = initBase + cbc;
  if (0x3f < initBase) {
    initBase = 0x3f;
  }
  return initBase;
}



// ======================================================================
// Function: CheckInitiative
// Address: 10f0:3e68
// Segment: MEMORY_BATTLE
// ======================================================================


void CheckInitiative(TOK *ptok)

{
  short sVar1;
  short pctBC;
  SHDEF *lpshdef;
  
  lpshdef = LpshdefFromTok(ptok);
  idPlayer = (short)((TOK *)ptok)->iplr;
  sVar1 = InitFromHuldef(&lpshdef->hul,&pctBC);
  ((TOK *)ptok)->initBase = (byte)sVar1;
  idPlayer = -1;
  ((TOK *)ptok)->pctBC = (byte)pctBC;
  return;
}



// ======================================================================
// Function: CheckWeapons
// Address: 10f0:3ec2
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f044a9) */
/* WARNING: Removing unreachable block (ram,0x10f043f1) */

void CheckWeapons(TOK *ptok,short *pfDampeningField,byte *pinit)

{
  uint uVar1;
  TOK *pTVar2;
  HUL *pHVar3;
  undefined2 uVar4;
  undefined2 uVar5;
  ulong uVar6;
  ulong uVar7;
  undefined1 *puVar8;
  long lVar9;
  undefined2 uVar10;
  PART part;
  short dxyPart;
  HUL *lphul;
  short initBase;
  short dxyLim;
  SHDEF *lpshdef;
  undefined4 pctHit;
  short initMin;
  undefined4 pctCap;
  short i;
  short dxyMax;
  short init;
  short initMac;
  short ihs;
  undefined4 pctBeamDef;
  undefined4 ldp;
  short pctJam;
  
  pctCap._0_2_ = 1000;
  pctCap._2_2_ = 0;
  pctBeamDef._0_2_ = 1000;
  pctBeamDef._2_2_ = 0;
  pctHit._0_2_ = (undefined1 *)0x2710;
  pctHit._2_2_ = 0;
  uVar4 = (undefined2)((ulong)ptok >> 0x10);
  pTVar2 = (TOK *)ptok;
  initBase = (short)pTVar2->initBase;
  initMin = -1;
  initMac = -1;
  lphul = &LpshdefFromTok(ptok)->hul;
  dxyMax = -1;
  dxyLim = -1;
  lpshdef = (SHDEF *)lphul;
  ldp = DpShieldOfShdef((SHDEF *)lphul,(uint)pTVar2->iplr);
  uVar6 = CONCAT22(pctBeamDef._2_2_,(undefined2)pctBeamDef);
  uVar7 = CONCAT22(pctCap._2_2_,(undefined2)pctCap);
  puVar8 = (undefined1 *)CONCAT22(pctHit._2_2_,(undefined1 *)pctHit);
  ihs = 0;
  while( true ) {
    uVar5 = (undefined2)((ulong)lphul >> 0x10);
    pHVar3 = (HUL *)lphul;
    pctCap = uVar7;
    pctBeamDef = uVar6;
    pctHit = puVar8;
    if ((int)(uint)pHVar3->chs <= ihs) break;
    if ((((pHVar3->rghs + ihs)->grhst &
         (hstSpecialM|hstSpecialE|hstMining|hstTorp|hstBeam|hstArmor|hstShield|hstScanner)) !=
         ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
           hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
       ((uint)pHVar3->rghs[ihs].wFlags >> 8 != 0)) {
      pctJam = 100;
      dxyPart = -1;
      part.hs.grhst = (pHVar3->rghs + ihs)->grhst;
      part.hs.wFlags = pHVar3->rghs[ihs].wFlags;
      if ((part.hs.grhst & (hstTorp|hstBeam)) ==
          ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
            hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) {
        init = -1;
      }
      else {
        idPlayer = (short)pTVar2->iplr;
        FLookupPart(&part);
        idPlayer = -1;
        init = initBase + *(int *)(((COMPART *)part.pcom)[1].rgTech + 2);
        uVar7 = pctCap;
        uVar6 = pctBeamDef;
        if (0x3f < init) {
          init = 0x3f;
        }
      }
      puVar8 = pctHit;
      if (part.hs.grhst == hstShield) {
        if ((part.hs.wFlags & 0xffU) == 6) {
          pctJam = 0x5f;
        }
      }
      else if (part.hs.grhst == hstArmor) {
        if ((part.hs.wFlags & 0xffU) == 9) {
          pctJam = 0x50;
        }
      }
      else {
        uVar5 = (undefined2)((ulong)part.pcom >> 0x10);
        if (part.hs.grhst == hstBeam) {
          dxyPart = ((COMPART *)part.pcom + 1)->id;
        }
        else if (part.hs.grhst == hstTorp) {
          pTVar2->wFlags = pTVar2->wFlags & 0xfffbU | 4;
          dxyPart = ((COMPART *)part.pcom + 1)->id;
        }
        else if (part.hs.grhst == hstMining) {
          if ((part.hs.wFlags & 0xffU) == 6) {
            pctJam = 0x46;
          }
        }
        else {
          pctCap = uVar7;
          pctBeamDef = uVar6;
          if (part.hs.grhst == hstSpecialE) {
            switch(part.hs.wFlags & 0xff) {
            case 4:
              pctJam = 0x5a;
              break;
            case 8:
            case 9:
            case 10:
            case 0xb:
              idPlayer = (short)pTVar2->iplr;
              FLookupPart(&part);
              idPlayer = -1;
              pctJam = 100 - ((COMPART *)part.pcom + 1)->id;
              uVar7 = pctCap;
              uVar6 = pctBeamDef;
              break;
            case 0xc:
            case 0xd:
              idPlayer = (short)pTVar2->iplr;
              FLookupPart(&part);
              idPlayer = -1;
              uVar7 = pctCap;
              uVar6 = pctBeamDef;
              for (i = (uint)part.hs.wFlags >> 8; 0 < i; i = i + -1) {
                uVar10 = 0;
                uVar5 = 100;
                uVar1 = ((COMPART *)part.pcom + 1)->id;
                pctCap = uVar7;
                pctBeamDef = uVar6;
                uVar7 = __aFulmul(uVar7,CONCAT22(((int)uVar1 >> 0xf) +
                                                         (uint)(0xff9b < uVar1),uVar1 + 100));
                uVar7 = __aFldiv(uVar7,CONCAT22(uVar10,uVar5));
                uVar6 = pctBeamDef;
              }
              break;
            case 0xe:
              *pfDampeningField = 1;
              break;
            case 0xf:
              pTVar2->wFlags = pTVar2->wFlags & 0xfffdU | 2;
            }
            puVar8 = pctHit;
          }
          else if ((part.hs.grhst == hstSpecialM) && ((part.hs.wFlags & 0xffU) == 10)) {
            idPlayer = (short)pTVar2->iplr;
            FLookupPart(&part);
            idPlayer = -1;
            uVar6 = pctBeamDef;
            uVar7 = pctCap;
            for (i = (uint)part.hs.wFlags >> 8; puVar8 = pctHit, 0 < i; i = i + -1) {
              uVar10 = 0;
              uVar5 = 100;
              uVar1 = ((COMPART *)part.pcom + 1)->id;
              pctBeamDef = uVar6;
              pctCap = uVar7;
              uVar7 = __aFulmul(uVar6,CONCAT22(-(uint)(100 < uVar1) - ((int)uVar1 >> 0xf),
                                                       100 - uVar1));
              uVar6 = __aFldiv(uVar7,CONCAT22(uVar10,uVar5));
              uVar7 = pctCap;
            }
          }
        }
      }
      if (pctJam < 100) {
        pctCap = uVar7;
        pctBeamDef = uVar6;
        for (i = (uint)part.hs.wFlags >> 8; uVar7 = pctCap, uVar6 = pctBeamDef, 0 < i; i = i + -1) {
          pctHit = puVar8;
          uVar7 = __aFulmul((ulong)puVar8,(long)pctJam);
          pctHit = (undefined1 *)uVar7;
          puVar8 = (undefined1 *)__aFldiv(uVar7,100);
        }
      }
      if (dxyPart != -1) {
        if (pTVar2->field2_0x3 == '\x01') {
          dxyPart = dxyPart + 1;
        }
        if ((dxyMax < 0) || (dxyPart < dxyMax)) {
          dxyMax = dxyPart;
        }
        if (dxyLim < dxyPart) {
          dxyLim = dxyPart;
        }
        pinit[init] = 1;
        if ((initMin == -1) || (init < initMin)) {
          initMin = init;
        }
        if (initMac < init) {
          initMac = init;
        }
      }
    }
    ihs = ihs + 1;
  }
  if (puVar8 == &DAT_0000_2710) {
    pTVar2->pctJam = 0;
  }
  else {
    lVar9 = __aFldiv((long)(puVar8 + 0x32),100);
    pTVar2->pctJam = 100 - (char)lVar9;
    if (0x5f < pTVar2->pctJam) {
      pTVar2->pctJam = 0x5f;
    }
  }
  if (pTVar2->field2_0x3 == '\x01') {
    pTVar2->pctJam = pTVar2->pctJam - pTVar2->pctJam / 4;
  }
  if (pctCap != 1000) {
    if (0x9f6 < (long)pctCap) {
      pctCap = 0x9f6;
    }
    lVar9 = __aFldiv(pctCap,10);
    pTVar2->pctCap = (byte)lVar9;
  }
  lVar9 = __aFldiv(pctBeamDef,10);
  pTVar2->pctBeamDef = (byte)lVar9;
  pTVar2->wFlags = pTVar2->wFlags & 0xff0fU | (dxyMax & 0xfU) << 4;
  pTVar2->wFlags = pTVar2->wFlags & 0xfff0U | dxyLim & 0xfU;
  pTVar2->initMin = (byte)initMin;
  pTVar2->initMac = (byte)initMac;
  if (ldp._2_2_ == 0) {
    pTVar2->dpShield = (short)ldp;
  }
  else {
    pTVar2->dpShield = -1;
  }
  return;
}



// ======================================================================
// Function: RandomizeTokOrder
// Address: 10f0:44d4
// Segment: MEMORY_BATTLE
// ======================================================================


void RandomizeTokOrder(void)

{
  TOK *pTVar1;
  short *psVar2;
  TOK *pTVar3;
  undefined2 uVar4;
  short sVar5;
  int iVar6;
  int iVar7;
  TOK *pTVar8;
  short *psVar9;
  TOK *pTVar10;
  undefined2 unaff_SS;
  short itok;
  short itokSwap;
  short tok [16];
  
  for (itok = 0; itok < vctok; itok = itok + 1) {
    sVar5 = Random(vctok - itok);
    uVar4 = vrgtok._2_2_;
    iVar6 = sVar5 + itok;
    if (iVar6 != itok) {
      pTVar8 = (TOK *)vrgtok + iVar6;
      psVar9 = tok;
      for (iVar7 = 0xe; iVar7 != 0; iVar7 = iVar7 + -1) {
        psVar2 = psVar9;
        psVar9 = psVar9 + 1;
        pTVar1 = pTVar8;
        pTVar8 = (TOK *)&pTVar8->iplr;
        *psVar2 = pTVar1->id;
      }
      *(char *)psVar9 = (char)pTVar8->id;
      pTVar8 = (TOK *)vrgtok + itok;
      pTVar10 = (TOK *)vrgtok + iVar6;
      for (iVar6 = 0xe; iVar6 != 0; iVar6 = iVar6 + -1) {
        pTVar3 = pTVar10;
        pTVar10 = (TOK *)&pTVar10->iplr;
        pTVar1 = pTVar8;
        pTVar8 = (TOK *)&pTVar8->iplr;
        pTVar3->id = pTVar1->id;
      }
      *(char *)&pTVar10->id = (char)pTVar8->id;
      uVar4 = vrgtok._2_2_;
      pTVar8 = (TOK *)vrgtok + itok;
      psVar9 = tok;
      for (iVar6 = 0xe; iVar6 != 0; iVar6 = iVar6 + -1) {
        pTVar1 = pTVar8;
        pTVar8 = (TOK *)&pTVar8->iplr;
        psVar2 = psVar9;
        psVar9 = psVar9 + 1;
        pTVar1->id = *psVar2;
      }
      *(char *)&pTVar8->id = (char)*psVar9;
    }
  }
  return;
}



// ======================================================================
// Function: InitializeBoard
// Address: 10f0:45b4
// Segment: MEMORY_BATTLE
// ======================================================================


void InitializeBoard
          (FLEET *lpfl,short ibrc,ushort grfPlayer,byte *pinit,short *pinitMin,short *pinitMac)

{
  TOK *pTVar1;
  byte *pbVar2;
  PLANET *pPVar3;
  short sVar4;
  int iVar5;
  uint uVar6;
  FLEET *pFVar7;
  TOK *pTVar8;
  TOK *pTVar9;
  byte *pbVar10;
  undefined2 uVar11;
  undefined2 uVar12;
  byte rgfTorp [16];
  short ishdef;
  short fDumpCargo;
  byte mpiplrdibrc [16];
  TOK *ptokT;
  ushort *lpwtCargoCur;
  undefined2 local_1a;
  short initMin;
  short fDampeningField;
  PLANET *lppl;
  short initMac;
  TOK *ptok;
  FLEET *lpflCur;
  short iplr;
  
  initMin = -1;
  initMac = -1;
  fDampeningField = 0;
  lpwtCargoCur = (ushort *)vlpwtCargo;
  local_1a = vlpwtCargo._2_2_;
  ishdef = 0;
  _memset(mpiplrdibrc,0xff,0x10);
  for (iplr = 0; iplr < game.cPlayer; iplr = iplr + 1) {
    if ((1 << ((byte)iplr & 0x1f) & grfPlayer) != 0) {
      mpiplrdibrc[iplr] = (byte)ishdef;
      ishdef = ishdef + 1;
    }
  }
  _memset(rgfTorp,0,0x10);
  lpflCur = lpfl;
  ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
  if (((FLEET *)lpfl)->idPlanet != -1) {
    lppl = LpplFromId(((FLEET *)lpfl)->idPlanet);
    uVar11 = (undefined2)((ulong)lppl >> 0x10);
    pPVar3 = (PLANET *)lppl;
    iplr = pPVar3->iPlayer;
    if (((iplr != -1) && (((uint)pPVar3->wFlags >> 9 & 1) != 0)) &&
       ((1 << ((byte)iplr & 0x1f) & grfPlayer) != 0)) {
      uVar12 = (undefined2)((ulong)ptok >> 0x10);
      pTVar8 = (TOK *)ptok;
      pTVar8->field2_0x3 = 1;
      pPVar3->wFlags = pPVar3->wFlags & 0xbfffU | 0x4000;
      pTVar8->brc = *(byte *)((uint)mpiplrdibrc[iplr] + ibrc);
      ptok->id = lppl->id;
      pTVar8->iplr = (byte)iplr;
      pTVar8->csh = 1;
      pTVar8->ishdef = ((byte)*(undefined2 *)&pPVar3->field11_0x2c & 0xf) + 0x10;
      CheckInitiative(ptok);
      CheckWeapons(ptok,&fDampeningField,pinit);
      rgfTorp[iplr] = rgfTorp[iplr] | (byte)((uint)((TOK *)ptok)->wFlags >> 2) & 1;
      uVar11 = (undefined2)((ulong)ptok >> 0x10);
      pTVar8 = (TOK *)ptok;
      if (pTVar8->initBase == 0xff) {
        pTVar8->wFlags = pTVar8->wFlags & 0xfffU | 0x5000;
      }
      else {
        pTVar8->wFlags = pTVar8->wFlags & 0xfffU | 0x3000;
      }
      pTVar8->wFlags = pTVar8->wFlags & 0xfff0U | 1;
      pTVar8->wFlags = pTVar8->wFlags & 0xff0fU | 0x10;
      (&pTVar8->dv)->dp =
           (&pTVar8->dv)->dp & 0x7fU | (*(uint *)&((PLANET *)lppl)->field11_0x2c >> 4) << 7;
      pTVar8->wFlags = pTVar8->wFlags & 0xf0ffU | 0x500;
      if ((uint)(&pTVar8->dv)->dp >> 7 != 0) {
        (&pTVar8->dv)->dp = (&pTVar8->dv)->dp & 0xff80U | 100;
      }
      pTVar8->wFlags = pTVar8->wFlags & 0xf0ff;
      pTVar8->wt = -1;
      ptok = (TOK *)CONCAT22(uVar11,pTVar8 + 1);
    }
  }
  do {
    uVar11 = (undefined2)((ulong)lpflCur >> 0x10);
    pFVar7 = (FLEET *)lpflCur;
    if (((uint)pFVar7->wFlags >> 10 & 1) == 0) {
      if (((uint)pFVar7->wFlags >> 7 & 1) == 0) {
        if (((uint)pFVar7->wFlags >> 8 & 1) != 0) {
          pFVar7->wFlags = pFVar7->wFlags & 0xbfffU | 0x4000;
          iplr = pFVar7->iPlayer;
          fDumpCargo = FDumpCargo(lpflCur);
          for (ishdef = 0; ishdef < 0x10; ishdef = ishdef + 1) {
            if (((FLEET *)lpflCur)->rgcsh[ishdef] != 0) {
              uVar11 = (undefined2)((ulong)ptok >> 0x10);
              pTVar8 = (TOK *)ptok;
              pTVar8->field2_0x3 = 2;
              pTVar8->brc = *(byte *)((uint)mpiplrdibrc[iplr] + ibrc);
              ptok->id = lpflCur->id;
              pTVar8->iplr = (byte)((uint)lpflCur->id >> 9) & 0xf;
              pTVar8->ishdef = (byte)ishdef;
              pTVar8->csh = ((FLEET *)lpflCur)->rgcsh[ishdef];
              (&pTVar8->dv)->dp = (((FLEET *)lpflCur)->rgdv + ishdef)->dp;
              CheckInitiative(ptok);
              CheckWeapons(ptok,&fDampeningField,pinit);
              rgfTorp[iplr] = rgfTorp[iplr] | (byte)((uint)((TOK *)ptok)->wFlags >> 2) & 1;
              CheckTarget(ptok,lpflCur,ishdef);
              uVar6 = SpdOfShip(lpflCur,ishdef,ptok,fDumpCargo,(SHDEF *)0x0);
              uVar11 = (undefined2)((ulong)ptok >> 0x10);
              pTVar8 = (TOK *)ptok;
              pTVar8->wFlags = pTVar8->wFlags & 0xf0ffU | (uVar6 & 0xf) << 8;
              ptok = (TOK *)CONCAT22(uVar11,pTVar8 + 1);
              if (0xff < ((int)(pTVar8 + 1) - (int)(TOK *)vrgtok) / 0x1d)
              goto BATTLE_LTooManyTokens;
            }
          }
        }
      }
      else {
        grfMissed = grfMissed | 1 << ((byte)pFVar7->iPlayer & 0x1f);
      }
    }
    uVar11 = (undefined2)((ulong)lpflCur >> 0x10);
                    /* WARNING: Load size is inaccurate */
    lpflCur = (FLEET *)CONCAT22(*(undefined2 *)((int)&((FLEET *)lpflCur)->lpflNext + 2),
                                ((FLEET *)lpflCur)->lpflNext);
  } while (lpfl != lpflCur);
BATTLE_LTooManyTokens:
  vctok = ((int)(TOK *)ptok - (int)(TOK *)vrgtok) / 0x1d;
  RandomizeTokOrder();
  ptokT = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
  while( true ) {
    if ((TOK *)ptok <= (TOK *)ptokT) break;
    uVar11 = (undefined2)((ulong)ptokT >> 0x10);
    ((TOK *)ptokT)->wFlags = ((TOK *)ptokT)->wFlags & 0xffefU | 0x10;
    ((TOK *)ptokT)->wFlags = ((TOK *)ptokT)->wFlags & 0xfffeU | 1;
    if (((TOK *)ptokT)->initMin == 0xff) {
      ((TOK *)ptokT)->wFlags = ((TOK *)ptokT)->wFlags & 0xfff0;
    }
    if ((((TOK *)ptokT)->dpShield == 0) ||
       (sVar4 = GetRaceGrbit((PLAYER *)rgplr + ((TOK *)ptokT)->iplr,
                                   ibitRaceRegeneratingShields), sVar4 == 0)) {
      iVar5 = 0;
    }
    else {
      iVar5 = 1;
    }
    uVar11 = (undefined2)((ulong)ptokT >> 0x10);
    pTVar8 = (TOK *)ptokT;
    pTVar8->wFlags = pTVar8->wFlags & 0xfff7U | iVar5 << 3;
    if ((fDampeningField != 0) && (pTVar8->field2_0x3 != '\x01')) {
      if ((int)(((uint)pTVar8->wFlags >> 8 & 0xf) - 4) < 1) {
        uVar6 = 0;
      }
      else {
        uVar6 = ((uint)pTVar8->wFlags >> 8 & 0xf) - 4;
      }
      pTVar8->wFlags = pTVar8->wFlags & 0xf0ffU | (uVar6 & 0xf) << 8;
    }
    uVar12 = (undefined2)((ulong)lpbBattleCur >> 0x10);
    pbVar10 = (byte *)lpbBattleCur;
    pTVar9 = pTVar8;
    for (iVar5 = 0xe; iVar5 != 0; iVar5 = iVar5 + -1) {
      pbVar2 = pbVar10;
      pbVar10 = pbVar10 + 2;
      pTVar1 = pTVar9;
      pTVar9 = (TOK *)&pTVar9->iplr;
      *(short *)pbVar2 = pTVar1->id;
    }
    *pbVar10 = (byte)pTVar9->id;
    lpbBattleCur =
         (byte *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur + 0x1d);
    if ((pTVar8->initMin != 0xff) && ((initMin == -1 || ((int)(uint)pTVar8->initMin < initMin)))) {
      initMin = (short)pTVar8->initMin;
    }
    if ((pTVar8->initMac != 0xff) && ((initMac == -1 || (initMac < (int)(uint)pTVar8->initMac)))) {
      initMac = (short)pTVar8->initMac;
    }
    ptokT = (TOK *)CONCAT22(uVar11,pTVar8 + 1);
  }
  *pinitMin = initMin & 0xff;
  *pinitMac = initMac & 0xff;
  return;
}



// ======================================================================
// Function: DzFromBrcBrc
// Address: 10f0:4ca8
// Segment: MEMORY_BATTLE
// ======================================================================


short DzFromBrcBrc(byte brc1,byte brc2)

{
  short sVar1;
  short sVar2;
  short dx;
  short dy;
  
  sVar1 = _abs((brc1 & 0xf) - (brc2 & 0xf));
  sVar2 = _abs(((int)(uint)brc1 >> 4) - ((int)(uint)brc2 >> 4));
  if (sVar1 <= sVar2) {
    sVar1 = sVar2;
  }
  return sVar1;
}



// ======================================================================
// Function: DpFromPtokBrcToBrc
// Address: 10f0:4d2e
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f04fe7) */
/* WARNING: Removing unreachable block (ram,0x10f0522e) */
/* WARNING: Removing unreachable block (ram,0x10f052e6) */

long DpFromPtokBrcToBrc(TOK *ptok,byte brcSrc,byte brcTarget,TOK *ptokTarget,short fProximity)

{
  uint uVar1;
  HUL *pHVar2;
  undefined2 uVar3;
  ulong uVar4;
  SHDEF *pSVar5;
  ulong uVar6;
  long lVar7;
  long lVar8;
  ulong uVar9;
  long lVar10;
  PART part;
  undefined4 dp;
  undefined4 cTorpHit;
  HUL *lphul;
  uint dRange;
  int local_1c;
  short fOutOfRange;
  undefined4 dpTotal;
  undefined4 cTorpBase;
  short ihs;
  uint dpShdef;
  undefined2 local_c;
  ulong dpMax;
  short dz;
  
  dz = DzFromBrcBrc(brcSrc,brcTarget);
  dpTotal._0_2_ = 0;
  dpTotal._2_2_ = 0;
  if ((fProximity == 0) && ((int)(((TOK *)ptok)->wFlags & 0xfU) < dz)) {
    uVar4 = 0;
  }
  else {
    lphul = &LpshdefFromTok(ptok)->hul;
    uVar6 = CONCAT22(dp._2_2_,(undefined2)dp);
    ihs = 0;
    while( true ) {
      uVar3 = (undefined2)((ulong)lphul >> 0x10);
      pHVar2 = (HUL *)lphul;
      dp = uVar6;
      if ((int)(uint)pHVar2->chs <= ihs) break;
      if ((((pHVar2->rghs + ihs)->grhst & (hstTorp|hstBeam)) !=
           ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
             hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
         ((uint)pHVar2->rghs[ihs].wFlags >> 8 != 0)) {
        part.hs.grhst = (pHVar2->rghs + ihs)->grhst;
        part.hs.wFlags = pHVar2->rghs[ihs].wFlags;
        idPlayer = (short)((TOK *)ptok)->iplr;
        FLookupPart(&part);
        idPlayer = -1;
        uVar3 = (undefined2)((ulong)part.pcom >> 0x10);
        dRange = (uint)(((TOK *)ptok)->field2_0x3 == '\x01') + ((COMPART *)part.pcom + 1)->id;
        local_1c = (int)dRange >> 0xf;
        if ((dz >> 0xf < local_1c) || ((dz >> 0xf <= local_1c && ((uint)dz <= dRange)))) {
          fOutOfRange = 0;
        }
        else {
          fOutOfRange = 1;
        }
        if ((fOutOfRange == 0) || (uVar6 = dp, fProximity != 0)) {
          uVar6 = __aFulmul((long)*(int *)((COMPART *)part.pcom)[1].rgTech,
                                    (ulong)((uint)part.hs.wFlags >> 8));
          dp = uVar6;
          if (part.hs.grhst == hstBeam) {
            if (((TOK *)ptok)->pctCap != 0) {
              lVar7 = 100;
              uVar6 = __aFulmul(uVar6,(ulong)((TOK *)ptok)->pctCap);
              uVar6 = __aFldiv(uVar6,lVar7);
            }
            if (((0 < dz) && (-1 < local_1c)) && ((0 < local_1c || (dRange != 0)))) {
              lVar8 = CONCAT22(local_1c,dRange);
              lVar7 = 10;
              dp = uVar6;
              uVar6 = __aFulmul(uVar6,(long)dz);
              lVar7 = __aFldiv(uVar6,lVar7);
              lVar7 = __aFldiv(lVar7,lVar8);
              uVar6 = dp - lVar7;
            }
            if (((TOK *)ptokTarget)->pctBeamDef < 100) {
              lVar7 = 100;
              dp = uVar6;
              uVar6 = __aFulmul(uVar6,(ulong)((TOK *)ptokTarget)->pctBeamDef);
              uVar6 = __aFldiv(uVar6,lVar7);
            }
            if ((*(uint *)(((COMPART *)part.pcom)[1].rgTech + 4) & 1) != 0) {
              dp = uVar6;
              uVar4 = __aFulmul((ulong)(uint)((TOK *)ptokTarget)->dpShield,
                                        (ulong)(uint)((TOK *)ptok)->csh);
              uVar6 = dp;
              if ((long)uVar4 < (long)dp) {
                uVar6 = uVar4;
              }
            }
            if (fOutOfRange != 0) {
              uVar1 = dz + 10;
              dp = uVar6;
              uVar6 = __aFldiv(uVar6,CONCAT22((((int)uVar1 >> 0xf) - local_1c) -
                                                      (uint)(uVar1 < dRange),uVar1 - dRange));
              if (((long)uVar6 < 0x10000) &&
                 (((long)uVar6 < 0 || ((uint)uVar6 < (uint)part.hs.wFlags >> 8)))) {
                uVar6 = (ulong)((uint)part.hs.wFlags >> 8);
              }
            }
            dp = uVar6;
            uVar6 = __aFulmul(uVar6,(ulong)(uint)((TOK *)ptok)->csh);
            dpTotal = uVar6 + dpTotal;
            uVar6 = dp;
          }
          else if (part.hs.grhst == hstTorp) {
            uVar4 = 200;
            uVar6 = __aFulmul((ulong)((uint)part.hs.wFlags >> 8),
                                      (ulong)(uint)((TOK *)ptok)->csh);
            uVar6 = __aFulmul(uVar6,uVar4);
            cTorpBase = uVar6;
            uVar6 = CTorpHit(uVar6,ptokTarget,*(short *)(((COMPART *)part.pcom)[1].rgTech + 4),
                             (uint)((TOK *)ptok)->pctBC);
            lVar7 = 200;
            cTorpHit = uVar6;
            uVar6 = __aFulmul((long)*(int *)((COMPART *)part.pcom)[1].rgTech,uVar6);
            uVar6 = __aFldiv(uVar6,lVar7);
            if (((TOK *)ptokTarget)->dpShield != 0) {
              lVar7 = 0x640;
              dp = uVar6;
              uVar6 = __aFulmul(cTorpBase - cTorpHit,
                                        (long)*(int *)((COMPART *)part.pcom)[1].rgTech);
              lVar7 = __aFldiv(uVar6,lVar7);
              uVar6 = lVar7 + dp;
            }
            if (fOutOfRange != 0) {
              uVar1 = dz + 10;
              dp = uVar6;
              uVar6 = __aFldiv(uVar6,CONCAT22((((int)uVar1 >> 0xf) - local_1c) -
                                                      (uint)(uVar1 < dRange),uVar1 - dRange));
              if (((long)uVar6 < 0x10000) &&
                 (((long)uVar6 < 0 || ((uint)uVar6 < (uint)part.hs.wFlags >> 8)))) {
                uVar6 = (ulong)((uint)part.hs.wFlags >> 8);
              }
            }
            dpTotal = uVar6 + dpTotal;
          }
        }
      }
      ihs = ihs + 1;
    }
    pSVar5 = LpshdefFromTok(ptokTarget);
    dpShdef = (((SHDEF *)pSVar5)->hul).dp;
    local_c = 0;
    uVar6 = __aFulmul((ulong)CONCAT12(CARRY2(((TOK *)ptokTarget)->dpShield,dpShdef),
                                              ((TOK *)ptokTarget)->dpShield + dpShdef),
                              (ulong)(uint)((TOK *)ptokTarget)->csh);
    if (((&((TOK *)ptokTarget)->dv)->dp != 0) && (0 < (long)uVar6)) {
      lVar10 = 500;
      uVar9 = (ulong)(uint)((TOK *)ptokTarget)->csh;
      lVar8 = 10;
      uVar4 = (ulong)(uint)(&((TOK *)ptokTarget)->dv)->dp & 0xffff007f;
      lVar7 = 10;
      dpMax = uVar6;
      uVar6 = __aFulmul(CONCAT22(local_c,dpShdef),
                                (ulong)((uint)(&((TOK *)ptokTarget)->dv)->dp >> 7));
      uVar6 = __aFldiv(uVar6,lVar7);
      uVar6 = __aFulmul(uVar6,uVar4);
      uVar6 = __aFldiv(uVar6,lVar8);
      uVar6 = __aFulmul(uVar6,uVar9);
      lVar7 = __aFldiv(uVar6,lVar10);
      uVar6 = dpMax - lVar7;
      if (((int)(dpMax - lVar7 >> 0x10) < 1) &&
         (((long)(dpMax - lVar7) < 0 || (uVar6 = dpMax - lVar7, (int)dpMax == (int)lVar7)))) {
        uVar6 = 1;
      }
    }
    uVar4 = dpTotal;
    if (((long)uVar6 < (long)dpTotal) && (uVar4 = uVar6, fProximity != 0)) {
      uVar4 = dpTotal;
    }
  }
  return uVar4;
}



// ======================================================================
// Function: DzMoveRangeToConsider
// Address: 10f0:5312
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f056af) */

short DzMoveRangeToConsider(TOK *ptok,ushort grfAttack,byte *pbrc)

{
  byte bVar1;
  short sVar2;
  uint uVar3;
  TOK *pTVar4;
  HUL *pHVar5;
  COMPART *pCVar6;
  undefined2 uVar7;
  undefined2 uVar8;
  long lVar9;
  PART part;
  HUL *lphul;
  undefined4 lpshdef;
  short ihs;
  byte brcCur;
  short dzMax;
  TOK *ptokTarget;
  short iplrTarget;
  short itokLook;
  byte dzBest;
  ushort mdTarget;
  short iplr;
  byte dz;
  short dzNonSapper;
  
  uVar7 = (undefined2)((ulong)ptok >> 0x10);
  pTVar4 = (TOK *)ptok;
  brcCur = pTVar4->brc;
  dzMax = (pTVar4->wFlags & 0xfU) + ((uint)pTVar4->wFlags >> 0xe);
  sVar2 = FDoesPrimaryTargetTypeExist(ptok,grfAttack);
  if (sVar2 == 0) {
    uVar3 = (uint)pTVar4->wFlags >> 4;
  }
  else {
    uVar3 = pTVar4->wFlags;
  }
  mdTarget = uVar3 & 0xf;
  iplr = (short)pTVar4->iplr;
  dzBest = 10;
  *pbrc = 0xff;
  if ((pTVar4->wFlags & 0xfU) == 3) {
    dzNonSapper = -1;
    lphul = &LpshdefFromTok(ptok)->hul;
    ihs = 0;
    lpshdef = (SHDEF *)lphul;
    while( true ) {
      uVar8 = (undefined2)((ulong)lphul >> 0x10);
      pHVar5 = (HUL *)lphul;
      if ((int)(uint)pHVar5->chs <= ihs) break;
      if (((pHVar5->rghs + ihs)->grhst == hstBeam) && ((uint)pHVar5->rghs[ihs].wFlags >> 8 != 0)) {
        part.hs.grhst = (pHVar5->rghs + ihs)->grhst;
        part.hs.wFlags = pHVar5->rghs[ihs].wFlags;
        idPlayer = (short)pTVar4->iplr;
        FLookupPart(&part);
        idPlayer = -1;
        uVar8 = (undefined2)((ulong)part.pcom >> 0x10);
        pCVar6 = (COMPART *)part.pcom;
        if (((*(uint *)(pCVar6[1].rgTech + 4) & 1) == 0) && (dzNonSapper < (pCVar6 + 1)->id)) {
          dzNonSapper = (pCVar6 + 1)->id;
        }
      }
      ihs = ihs + 1;
    }
  }
  else {
    dzNonSapper = pTVar4->wFlags & 0xf;
  }
  if ((((uint)pTVar4->wFlags >> 4 & 0xf) < (pTVar4->wFlags & 0xfU)) &&
     ((((uint)pTVar4->wFlags >> 8 & 0xf) == 5 || (((uint)pTVar4->wFlags >> 8 & 0xf) == 3)))) {
    dzMax = ((uint)pTVar4->wFlags >> 4 & 0xf) + ((uint)pTVar4->wFlags >> 0xe);
  }
  ptokTarget = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
  itokLook = 0;
  do {
    if (vctok <= itokLook) {
      return 1;
    }
    uVar8 = (undefined2)((ulong)ptokTarget >> 0x10);
    bVar1 = ((TOK *)ptokTarget)->iplr;
    iplrTarget = (short)bVar1;
    if (((iplrTarget != iplr) && ((1 << (bVar1 & 0x1f) & grfAttack) != 0)) &&
       ((((TOK *)ptokTarget)->wFlags & 1U) != 0)) {
      sVar2 = FIsTargetOfMdTarget(ptokTarget,mdTarget);
      if (sVar2 != 0) {
        sVar2 = DzFromBrcBrc(brcCur,((TOK *)ptokTarget)->brc);
        dz = (byte)sVar2;
        uVar8 = (undefined2)((ulong)ptokTarget >> 0x10);
        if ((uint)pTVar4->wFlags >> 0xe <= (uint)((TOK *)ptokTarget)->wFlags >> 0xe) {
          dz = dz + 1;
        }
        if (((int)(uint)dz <= dzMax) &&
           (((((TOK *)ptokTarget)->dpShield != 0 || (dzNonSapper == (pTVar4->wFlags & 0xfU))) ||
            ((uint)dz <= dzNonSapper + ((uint)pTVar4->wFlags >> 0xe))))) {
          *pbrc = 0xff;
          return (uint)pTVar4->wFlags >> 0xe;
        }
        ihs = (short)dz;
        if ((uint)ihs < (uint)dzBest) {
          lVar9 = DpFromPtokBrcToBrc(ptok,0,0,ptokTarget,0);
          if (0 < lVar9) {
            dzBest = dz;
            *pbrc = ((TOK *)ptokTarget)->brc;
          }
        }
      }
    }
    itokLook = itokLook + 1;
    ptokTarget = (TOK *)CONCAT22(ptokTarget._2_2_,(TOK *)ptokTarget + 1);
  } while( true );
}



// ======================================================================
// Function: FDoesPrimaryTargetTypeExist
// Address: 10f0:56d8
// Segment: MEMORY_BATTLE
// ======================================================================


short FDoesPrimaryTargetTypeExist(TOK *ptok,ushort grfAttack)

{
  TOK *pTVar1;
  short *psVar2;
  int iVar3;
  TOK *pTVar4;
  short *psVar5;
  undefined2 uVar6;
  undefined2 unaff_SS;
  short itokLook;
  short tok;
  char local_25;
  uint local_11;
  uint local_d;
  short iplrLook;
  short iplr;
  ushort mdTarget;
  
  uVar6 = (undefined2)((ulong)ptok >> 0x10);
  iplr = (short)((TOK *)ptok)->iplr;
  mdTarget = ((TOK *)ptok)->wFlags & 0xf;
  if (mdTarget != 0) {
    for (itokLook = 0; itokLook < vctok; itokLook = itokLook + 1) {
      if (((uint)((TOK *)vrgtok)[itokLook].iplr != iplr) &&
         ((1 << (((TOK *)vrgtok)[itokLook].iplr & 0x1f) & grfAttack) != 0)) {
        pTVar4 = (TOK *)vrgtok + itokLook;
        psVar5 = &tok;
        for (iVar3 = 0xe; iVar3 != 0; iVar3 = iVar3 + -1) {
          psVar2 = psVar5;
          psVar5 = psVar5 + 1;
          pTVar1 = pTVar4;
          pTVar4 = (TOK *)&pTVar4->iplr;
          *psVar2 = pTVar1->id;
        }
        *(char *)psVar5 = (char)pTVar4->id;
        if ((local_d & 1) != 0) {
          switch(mdTarget) {
          case 1:
            goto LAB_10f0_5873;
          case 2:
            if (local_25 == '\x01') {
              return 1;
            }
            break;
          case 3:
          case 4:
          case 5:
          case 6:
          case 7:
            if (mdTarget == 3) {
LAB_10f0_5790:
              if (local_11 >> 0xc == mdTarget) {
LAB_10f0_5873:
                return 1;
              }
            }
            else if (mdTarget == 4) {
              if (local_11 >> 0xc == 4) {
                return 1;
              }
              if (local_11 >> 0xc == 7) {
                return 1;
              }
            }
            else {
              if (mdTarget != 5) {
                if ((mdTarget != 6) && (mdTarget != 7)) {
                  return 1;
                }
                goto LAB_10f0_5790;
              }
              if (4 < local_11 >> 0xc) {
                return 1;
              }
            }
          }
        }
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: FIsTargetOfMdTarget
// Address: 10f0:587a
// Segment: MEMORY_BATTLE
// ======================================================================


short FIsTargetOfMdTarget(TOK *ptok,short mdTarget)

{
  uint uVar1;
  TOK *pTVar2;
  undefined2 uVar3;
  
  pTVar2 = (TOK *)ptok;
  uVar3 = (undefined2)((ulong)ptok >> 0x10);
  switch(mdTarget) {
  default:
    uVar1 = 0;
    break;
  case 1:
    uVar1 = 1;
    break;
  case 2:
    uVar1 = (uint)(pTVar2->field2_0x3 == '\x01');
    break;
  case 3:
  case 6:
  case 7:
    uVar1 = (uint)((uint)pTVar2->wFlags >> 0xc == mdTarget);
    break;
  case 4:
    if (((uint)pTVar2->wFlags >> 0xc == 4) || ((uint)pTVar2->wFlags >> 0xc == 7)) {
      uVar1 = 1;
    }
    else {
      uVar1 = 0;
    }
    break;
  case 5:
    if ((((uint)pTVar2->wFlags >> 0xc == 5) || ((uint)pTVar2->wFlags >> 0xc == 7)) ||
       ((uint)pTVar2->wFlags >> 0xc == 6)) {
      uVar1 = 1;
    }
    else {
      uVar1 = 0;
    }
  }
  return uVar1;
}



// ======================================================================
// Function: ScoreGuessBattleDamage
// Address: 10f0:598c
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f05d83) */
/* WARNING: Removing unreachable block (ram,0x10f05dd7) */

long ScoreGuessBattleDamage(TOK *ptokSrc,byte brc,short fPrimary,ushort grfAttack)

{
  byte bVar1;
  byte bVar2;
  int iVar3;
  uint uVar4;
  short sVar5;
  TOK *pTVar6;
  TOK *pTVar7;
  undefined2 uVar8;
  undefined2 uVar9;
  long dpTake;
  long lVar10;
  short itok;
  short dMin;
  short x;
  short xCur;
  short fWeAttack;
  byte iplrSrc;
  short dMax;
  byte brcEnemy;
  uint rgx [2];
  short dzCur;
  undefined4 scoreThem;
  undefined4 scoreThemBest;
  undefined4 dpTaken;
  short yCur;
  short xEnemy;
  short i;
  undefined4 dpGivenCur;
  long dpTakenTotal;
  short y;
  undefined4 dpTakenBest;
  long dpGivenBest;
  short dzEnemy;
  short yEnemy;
  TOK *ptok;
  uint rgy [2];
  short dMoves;
  short iBest;
  
  lVar10 = CONCAT22(scoreThem._2_2_,(undefined2)scoreThem);
  uVar8 = (undefined2)((ulong)ptokSrc >> 0x10);
  pTVar6 = (TOK *)ptokSrc;
  bVar1 = pTVar6->iplr;
  yCur = (int)(uint)pTVar6->brc >> 4;
  dpGivenBest = 0;
  dpTakenTotal = 0;
  ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
  for (itok = 0; scoreThem = lVar10, itok < vctok; itok = itok + 1) {
    uVar9 = (undefined2)((ulong)ptok >> 0x10);
    pTVar7 = (TOK *)ptok;
    if ((((pTVar7->wFlags & 1U) != 0) && (bVar1 != pTVar7->iplr)) &&
       ((1 << (pTVar7->iplr & 0x1f) & grfAttack) != 0)) {
      dMin = DzFromBrcBrc(pTVar7->brc,brc);
      dzCur = dMin;
      uVar9 = (undefined2)((ulong)ptok >> 0x10);
      pTVar7 = (TOK *)ptok;
      dMoves = (short)((uint)pTVar6->wFlags >> 0xe <= (uint)pTVar7->wFlags >> 0xe);
      dMax = dMin;
      if (dMoves != 0) {
        if ((uint)(dMin - dMoves) < 0x8000) {
          iVar3 = dMin - dMoves;
        }
        else {
          iVar3 = 0;
        }
        xEnemy = pTVar7->brc & 0xf;
        yEnemy = (int)(uint)pTVar7->brc >> 4;
        rgx[0] = xEnemy - dMoves;
        rgx[1] = xEnemy + dMoves;
        rgy[0] = yEnemy - dMoves;
        rgy[1] = yEnemy + dMoves;
        for (x = 0; dMin = iVar3, x < 2; x = x + 1) {
          for (y = 0; y < 2; y = y + 1) {
            if (rgx[x] < 0x8000) {
              uVar4 = rgx[x];
            }
            else {
              uVar4 = 0;
            }
            if ((int)uVar4 < 10) {
              if (rgx[x] < 0x8000) {
                bVar2 = (byte)rgx[x];
              }
              else {
                bVar2 = 0;
              }
            }
            else {
              bVar2 = 9;
            }
            if (rgy[y] < 0x8000) {
              uVar4 = rgy[y];
            }
            else {
              uVar4 = 0;
            }
            if ((int)uVar4 < 10) {
              if (rgy[y] < 0x8000) {
                uVar4 = rgy[y];
              }
              else {
                uVar4 = 0;
              }
            }
            else {
              uVar4 = 9;
            }
            dzEnemy = DzFromBrcBrc(brc,(byte)((uVar4 & 0xf) << 4) | bVar2 & 0xf);
            sVar5 = dzEnemy;
            if (dzEnemy <= dMax) {
              sVar5 = dMax;
            }
            dMax = sVar5;
          }
        }
      }
      if (fPrimary == 0) {
        uVar4 = (uint)pTVar6->wFlags >> 4;
      }
      else {
        uVar4 = pTVar6->wFlags;
      }
      sVar5 = FIsTargetOfMdTarget(ptok,uVar4 & 0xf);
      scoreThemBest = 30000000;
      iBest = dMin;
      lVar10 = scoreThem;
      for (i = dMin; i <= dMax; i = i + 1) {
        scoreThem = lVar10;
        if (sVar5 == 0) {
          dpTake = 0;
        }
        else {
          dpTake = DpFromPtokBrcToBrc(ptokSrc,0,(byte)((i & 0xfU) << 4),ptok,0);
        }
        lVar10 = DpFromPtokBrcToBrc(ptok,0,(byte)((i & 0xfU) << 4),ptokSrc,
                                    (uint)(((uint)pTVar6->wFlags >> 8 & 0xf) == 0));
        dpTaken = lVar10;
        lVar10 = ScoreFromGiveAndTakeAndTactic(lVar10,dpTake,(uint)((TOK *)ptok)->wFlags >> 8 & 0xf)
        ;
        if (lVar10 <= scoreThemBest) {
          iBest = i;
          scoreThemBest = lVar10;
          dpGivenCur = dpTake;
          dpTakenBest = dpTaken;
        }
      }
      if (dpGivenBest < dpGivenCur) {
        dpGivenBest = dpGivenCur;
      }
      dpTakenTotal = dpTakenBest + dpTakenTotal;
    }
    ptok = (TOK *)CONCAT22(ptok._2_2_,(TOK *)ptok + 1);
  }
  lVar10 = ScoreFromGiveAndTakeAndTactic(dpGivenBest,dpTakenTotal,(uint)pTVar6->wFlags >> 8 & 0xf);
  return lVar10;
}



// ======================================================================
// Function: ScoreFromGiveAndTakeAndTactic
// Address: 10f0:5e34
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f05ecc) */

long ScoreFromGiveAndTakeAndTactic(long dpGive,long dpTake,short mdTactic)

{
  int iVar1;
  ulong uVar2;
  long lVar3;
  
  switch(mdTactic) {
  case 0:
  case 2:
    break;
  case 1:
  case 5:
    dpTake = CONCAT22(-(dpGive._2_2_ + (uint)((int)dpGive != 0)),-(int)dpGive);
    break;
  case 3:
  case 4:
    iVar1 = -(dpGive._2_2_ + (uint)((int)dpGive != 0));
    if ((-(int)dpGive != 0) || (iVar1 != 0)) {
      lVar3 = dpTake + 1;
      uVar2 = __aFulmul(CONCAT22(iVar1,-(int)dpGive),100);
      dpTake = __aFldiv(uVar2,lVar3);
      if (-1 < dpTake) {
        dpTake = -1;
      }
    }
    break;
  default:
    dpTake = 0;
  }
  return dpTake;
}



// ======================================================================
// Function: DxyMoveTokTo
// Address: 10f0:5f18
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f061dc) */

short DxyMoveTokTo(TOK *ptok,short spdMove,ushort grfAttack)

{
  uint uVar1;
  uint uVar2;
  short sVar3;
  short sVar4;
  TOK *pTVar5;
  undefined2 uVar6;
  long lVar7;
  int rgptDeltas [2];
  short cLow;
  uint lLow;
  short fXMajor;
  short x;
  short dzAway;
  undefined2 dp;
  undefined2 local_56;
  short fPrimary;
  short xCur;
  short dx;
  short yMax;
  short dzAwayBest;
  byte brcBest;
  short yCur;
  short i;
  byte brcOOR;
  short y;
  short mdTactic;
  short dy;
  short yMin;
  short cBest;
  undefined4 score;
  uint rgscoreNear [18];
  byte brc;
  undefined4 scoreBest;
  short dz;
  short xMax;
  ushort iplr;
  
  uVar6 = (undefined2)((ulong)ptok >> 0x10);
  pTVar5 = (TOK *)ptok;
  iplr = (ushort)pTVar5->iplr;
  dp = 0;
  local_56 = 0;
  xCur = pTVar5->brc & 0xf;
  yCur = (int)(uint)pTVar5->brc >> 4;
  if ((pTVar5->field2_0x3 == '\x01') || (spdMove == 0)) goto BATTLE_LReturnDxy;
  scoreBest._0_2_ = 0xc380;
  scoreBest._2_2_ = 0x1c9;
  mdTactic = (uint)pTVar5->wFlags >> 8 & 0xf;
  fPrimary = FDoesPrimaryTargetTypeExist(ptok,grfAttack);
  for (x = 0; x < 3; x = x + 1) {
    for (y = 0; y < 3; y = y + 1) {
      rgscoreNear[x * 6 + y * 2] = 0xc380;
      (rgscoreNear + x * 6 + y * 2)[1] = 0x1c9;
    }
  }
  dz = DzMoveRangeToConsider(ptok,grfAttack,&brcOOR);
  x = xCur - dz;
  if (x < 0) {
    x = 0;
  }
  yMin = yCur - dz;
  if (yMin < 0) {
    yMin = 0;
  }
  xMax = xCur + dz;
  if (9 < xMax) {
    xMax = 9;
  }
  yMax = yCur + dz;
  if (9 < yMax) {
    yMax = 9;
  }
  for (; x <= xMax; x = x + 1) {
    for (y = yMin; y <= yMax; y = y + 1) {
      brc = (byte)((y & 0xfU) << 4) | (byte)x & 0xf;
      dx = xCur - x;
      dy = yCur - y;
      dx = _abs(dx);
      dy = _abs(dy);
      lVar7 = ScoreGuessBattleDamage(ptok,brc,fPrimary,grfAttack);
      if (mdTactic == 0) {
        i = 0;
        while( true ) {
          score._2_2_ = (uint)((ulong)lVar7 >> 0x10);
          score._0_2_ = (uint)lVar7;
          if (vctok <= i) break;
          if ((((TOK *)vrgtok)[i].brc == brc) &&
             (((TOK *)vrgtok)[i].iplr == iplr)) {
            lVar7 = lVar7 + 2;
          }
          i = i + 1;
        }
        fXMajor = (short)brc;
        if (fXMajor == (uint)pTVar5->brc) {
          lVar7 = CONCAT22(score._2_2_ - ((uint)score == 0),(uint)score + -1);
        }
      }
      score = lVar7;
      dzAway = DzFromBrcBrc(pTVar5->brc,brc);
      if (dzAway < 2) {
        rgscoreNear[((x - xCur) + 1) * 6 + ((y - yCur) + 1) * 2] = (uint)score;
        (rgscoreNear + ((x - xCur) + 1) * 6 + ((y - yCur) + 1) * 2)[1] = score._2_2_;
      }
      if ((score < scoreBest) || ((score == scoreBest && (dzAway <= dzAwayBest)))) {
        if ((scoreBest == score) && (dzAway == dzAwayBest)) {
          cBest = cBest + 1;
          sVar3 = Random(cBest);
          if (sVar3 != 0) goto LAB_10f0_6260;
        }
        else {
          cBest = 1;
          dzAwayBest = dzAway;
          scoreBest = score;
        }
        brcBest = brc;
      }
LAB_10f0_6260:
    }
  }
  if (brcOOR != 0xff) {
    brcBest = brcOOR;
  }
  dzAway = DzFromBrcBrc(pTVar5->brc,brcBest);
  if (1 < dzAway) {
    dx = (brcBest & 0xf) - xCur;
    dy = ((int)(uint)brcBest >> 4) - yCur;
    fXMajor = _abs(dx);
    sVar3 = _abs(dy);
    if (fXMajor == sVar3) {
      if (dx < 1) {
        xCur = xCur + -1;
      }
      else {
        xCur = xCur + 1;
      }
      if (dy < 1) {
        yCur = yCur + -1;
      }
      else {
        yCur = yCur + 1;
      }
    }
    else if (dx == 0) {
      lLow = 0xa300;
      fXMajor = (short)&DAT_1120_11e1;
      cLow = 0;
      if (dy < 0) {
        dy = 0;
      }
      else {
        dy = 2;
      }
      yCur = yCur + dy + -1;
      for (i = 0; i < 3; i = i + 1) {
        uVar1 = (rgscoreNear + i * 6 + dy * 2)[1];
        if (((int)uVar1 <= fXMajor) &&
           (((int)uVar1 < fXMajor || (rgscoreNear[i * 6 + dy * 2] <= lLow)))) {
          uVar1 = (rgscoreNear + i * 6 + dy * 2)[1];
          if ((fXMajor < (int)uVar1) ||
             ((fXMajor <= (int)uVar1 && (lLow <= rgscoreNear[i * 6 + dy * 2])))) {
            cLow = cLow + 1;
          }
          else {
            lLow = rgscoreNear[i * 6 + dy * 2];
            fXMajor = (rgscoreNear + i * 6 + dy * 2)[1];
            cLow = 1;
          }
        }
      }
      x = Random(cLow);
      i = 0;
      while ((sVar3 = x, i < 3 &&
             (((rgscoreNear[i * 6 + dy * 2] != lLow ||
               ((rgscoreNear + i * 6 + dy * 2)[1] != fXMajor)) || (x = x + -1, sVar3 != 0))))) {
        i = i + 1;
      }
      xCur = xCur + i + -1;
    }
    else if (dy == 0) {
      lLow = 0xa300;
      fXMajor = (short)&DAT_1120_11e1;
      cLow = 0;
      if (dx < 0) {
        dx = 0;
      }
      else {
        dx = 2;
      }
      xCur = xCur + dx + -1;
      for (i = 0; i < 3; i = i + 1) {
        uVar1 = (rgscoreNear + dx * 6 + i * 2)[1];
        if (((int)uVar1 <= fXMajor) &&
           (((int)uVar1 < fXMajor || (rgscoreNear[dx * 6 + i * 2] <= lLow)))) {
          uVar1 = (rgscoreNear + dx * 6 + i * 2)[1];
          if ((fXMajor < (int)uVar1) ||
             ((fXMajor <= (int)uVar1 && (lLow <= rgscoreNear[dx * 6 + i * 2])))) {
            cLow = cLow + 1;
          }
          else {
            lLow = rgscoreNear[dx * 6 + i * 2];
            fXMajor = (rgscoreNear + dx * 6 + i * 2)[1];
            cLow = 1;
          }
        }
      }
      x = Random(cLow);
      i = 0;
      while ((sVar3 = x, i < 3 &&
             (((rgscoreNear[dx * 6 + i * 2] != lLow ||
               ((rgscoreNear + dx * 6 + i * 2)[1] != fXMajor)) || (x = x + -1, sVar3 != 0))))) {
        i = i + 1;
      }
      yCur = yCur + i + -1;
    }
    else {
      sVar3 = _abs(dx);
      sVar4 = _abs(dy);
      fXMajor = (uint)(sVar4 < sVar3);
      if (dx < 1) {
        dx = 0;
      }
      else {
        dx = 2;
      }
      if (dy < 1) {
        dy = 0;
      }
      else {
        dy = 2;
      }
      rgptDeltas[0] = dx;
      rgptDeltas[1] = dy;
      if (sVar4 < sVar3 == 0) {
        cLow = 1;
        lLow = dy;
      }
      else {
        cLow = dx;
        lLow = 1;
      }
      uVar1 = (rgscoreNear + cLow * 6 + lLow * 2)[1];
      uVar2 = (rgscoreNear + dx * 6 + dy * 2)[1];
      if (((int)uVar2 < (int)uVar1) ||
         (((int)uVar2 <= (int)uVar1 &&
          (rgscoreNear[dx * 6 + dy * 2] < rgscoreNear[cLow * 6 + lLow * 2])))) {
LAB_10f0_66d1:
        i = 0;
      }
      else {
        if ((rgscoreNear[dx * 6 + dy * 2] == rgscoreNear[cLow * 6 + lLow * 2]) &&
           ((rgscoreNear + dx * 6 + dy * 2)[1] == (rgscoreNear + cLow * 6 + lLow * 2)[1])) {
          sVar3 = Random(2);
          if (sVar3 == 0) goto LAB_10f0_66d1;
        }
        i = 1;
      }
      xCur = xCur + rgptDeltas[i * 2] + -1;
      yCur = yCur + rgptDeltas[i * 2 + 1] + -1;
    }
    brcBest = (byte)((yCur & 0xfU) << 4) | (byte)xCur & 0xf;
  }
  if (scoreBest != 30000000) {
    if ((9 < (brcBest & 0xf)) || (9 < (uint)((int)(uint)brcBest >> 4))) {
      brcBest = pTVar5->brc;
    }
    pTVar5->brc = brcBest;
  }
BATTLE_LReturnDxy:
  pTVar5->wFlags = pTVar5->wFlags & 0xffefU | 0x10;
  return 1;
}



// ======================================================================
// Function: CTorpHit
// Address: 10f0:6790
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f06913) */
/* WARNING: Removing unreachable block (ram,0x10f068d2) */
/* WARNING: Removing unreachable block (ram,0x10f068f3) */
/* WARNING: Removing unreachable block (ram,0x10f06994) */

long CTorpHit(long cTorpBase,TOK *ptok,short pctBase,short pctBC)

{
  short sVar1;
  bool bVar2;
  ulong uVar3;
  long lVar4;
  uint cTorpHit;
  int local_10;
  int pctHit;
  short i;
  uint pctJam;
  int local_6;
  
  if ((cTorpBase == 0) || (pctBase == 0)) {
    lVar4 = 0;
  }
  else {
    pctJam = (uint)((TOK *)ptok)->pctJam;
    local_6 = 0;
    if ((pctJam != 0) && (pctBC != 0)) {
      bVar2 = pctJam < (uint)pctBC;
      pctJam = pctJam - pctBC;
      local_6 = -(uint)bVar2 - (pctBC >> 0xf);
      if ((local_6 < 1) && (local_6 < 0)) {
        pctBC = -pctJam;
        pctJam = 0;
        local_6 = 0;
      }
      else {
        pctBC = 0;
      }
    }
    if (pctBC == 0) {
      if ((pctJam == 0) && (local_6 == 0)) {
        uVar3 = (ulong)pctBase;
      }
      else {
        lVar4 = 100;
        uVar3 = __aFulmul((long)pctBase,
                                  CONCAT22(-(uint)(100 < pctJam) - local_6,100 - pctJam));
        uVar3 = __aFldiv(uVar3,lVar4);
      }
    }
    else {
      lVar4 = 100;
      uVar3 = __aFulmul(CONCAT22(-(uint)(100 < (uint)pctBase) - (pctBase >> 0xf),
                                         100 - pctBase),(long)(100 - pctBC));
      lVar4 = __aFldiv(uVar3,lVar4);
      uVar3 = CONCAT22(-(uint)(100 < (uint)lVar4) - (int)((ulong)lVar4 >> 0x10),100 - (uint)lVar4);
    }
    if ((long)uVar3 < 1) {
      uVar3 = 1;
    }
    pctHit = (int)uVar3;
    lVar4 = cTorpBase;
    if ((long)uVar3 < 100) {
      if (cTorpBase < 0xc9) {
        cTorpHit = 0;
        local_10 = 0;
        for (i = 0; lVar4 = CONCAT22(local_10,cTorpHit), i < cTorpBase; i = i + 1) {
          sVar1 = Random(100);
          if (sVar1 < pctHit) {
            bVar2 = 0xfffe < cTorpHit;
            cTorpHit = cTorpHit + 1;
            local_10 = local_10 + (uint)bVar2;
          }
        }
      }
      else {
        lVar4 = 100;
        uVar3 = __aFulmul(cTorpBase,uVar3);
        lVar4 = __aFldiv(uVar3,lVar4);
      }
    }
  }
  return lVar4;
}



// ======================================================================
// Function: FAttack
// Address: 10f0:69ac
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f0798c) */
/* WARNING: Removing unreachable block (ram,0x10f07315) */
/* WARNING: Removing unreachable block (ram,0x10f070f6) */
/* WARNING: Removing unreachable block (ram,0x10f07498) */
/* WARNING: Removing unreachable block (ram,0x10f072a4) */
/* WARNING: Removing unreachable block (ram,0x10f06f66) */
/* WARNING: Removing unreachable block (ram,0x10f0707c) */
/* WARNING: Removing unreachable block (ram,0x10f07265) */
/* WARNING: Removing unreachable block (ram,0x10f07463) */
/* WARNING: Removing unreachable block (ram,0x10f0781f) */
/* WARNING: Removing unreachable block (ram,0x10f07733) */
/* WARNING: Removing unreachable block (ram,0x10f079ee) */
/* WARNING: Removing unreachable block (ram,0x10f0751f) */
/* WARNING: Removing unreachable block (ram,0x10f074c6) */
/* WARNING: Removing unreachable block (ram,0x10f07183) */
/* WARNING: Removing unreachable block (ram,0x10f079c8) */
/* WARNING: Removing unreachable block (ram,0x10f07b2d) */
/* WARNING: Removing unreachable block (ram,0x10f0774a) */
/* WARNING: Removing unreachable block (ram,0x10f07b4d) */
/* WARNING: Removing unreachable block (ram,0x10f077de) */
/* WARNING: Removing unreachable block (ram,0x10f07b89) */
/* WARNING: Removing unreachable block (ram,0x10f07c92) */
/* WARNING: Removing unreachable block (ram,0x10f07ca9) */

short FAttack(short itokAttacker,short init,BTLREC *lpbtlrec,ushort grfAttack)

{
  uint uVar1;
  int iVar2;
  short sVar3;
  uint uVar4;
  int iVar5;
  int iVar6;
  HUL *pHVar7;
  BTLREC *pBVar8;
  TOK *pTVar9;
  COMPART *pCVar10;
  TOK *pTVar11;
  undefined2 unaff_SI;
  ushort unaff_DI;
  undefined2 uVar12;
  undefined2 uVar13;
  undefined2 uVar14;
  ulong uVar15;
  long lVar16;
  long lVar17;
  ulong uVar18;
  ulong uVar19;
  long lVar20;
  long lVar21;
  undefined2 uVar22;
  undefined2 uVar23;
  undefined2 uVar24;
  undefined2 uVar25;
  undefined2 uVar26;
  undefined1 uVar27;
  undefined1 uVar28;
  undefined1 uVar29;
  undefined1 uVar30;
  undefined2 in_stack_0000ff74;
  undefined2 in_stack_0000ff76;
  short fCapMissile;
  uint nds;
  int local_7c;
  PART part;
  TOK *ptokE;
  undefined4 dpCol;
  short itok;
  long dp;
  short fPrimary;
  undefined4 cTorpHit;
  HUL *lphul;
  long dpT;
  undefined4 lValue;
  SHDEF *lpshdef;
  TOK *ptokTarget;
  undefined4 pctHit;
  short cItem;
  ushort grfWeapon;
  undefined4 cTorpBase;
  short i;
  undefined4 cTorpsLeft;
  undefined4 cTorpFire;
  undefined4 cTorpMiss;
  short ihs;
  short dxRangeCur;
  short fSetItok;
  undefined4 score;
  long dpMain;
  short itokTarget;
  short ctokDamaged;
  TOK *ptok;
  undefined4 scoreBest;
  short dpSingle;
  undefined2 local_14;
  undefined4 dpArmorLeft;
  SHDEF *lpshdefE;
  short dz;
  undefined4 dpShieldLeft;
  
  dxRangeCur = 0;
  fSetItok = 0;
  ctokDamaged = 0;
  ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok + itokAttacker);
  lphul = &LpshdefFromTok((TOK *)CONCAT13((char)((uint)vrgtok._2_2_ >> 8),
                                          CONCAT12((char)vrgtok._2_2_,
                                                   (TOK *)vrgtok + itokAttacker)))->hul;
  lVar17 = CONCAT22(score._2_2_,(undefined2)score);
  lVar16 = CONCAT22(in_stack_0000ff76,in_stack_0000ff74);
  uVar19 = CONCAT22(dpMain._2_2_,(undefined2)dpMain);
  uVar15 = CONCAT22(cTorpsLeft._2_2_,(undefined2)cTorpsLeft);
  uVar18 = CONCAT22(dp._2_2_,(int)dp);
  ihs = 0;
  lpshdef = (SHDEF *)lphul;
  do {
    uVar12 = (undefined2)((ulong)lphul >> 0x10);
    pHVar7 = (HUL *)lphul;
    pBVar8 = (BTLREC *)lpbtlrec;
    uVar13 = (undefined2)((ulong)lpbtlrec >> 0x10);
    if ((int)(uint)pHVar7->chs <= ihs) {
      pBVar8->ctok = ctokDamaged;
      return (uint)(ctokDamaged != 0);
    }
    if ((((pHVar7->rghs + ihs)->grhst & (hstTorp|hstBeam)) !=
         ~(hstPlanetary|hstHull|hstTerra|hstSpecialM|hstSpecialE|hstSBHull|hstSpecialSB|hstMines|
           hstMining|hstBomb|hstTorp|hstBeam|hstArmor|hstShield|hstScanner|hstEngine)) &&
       ((uint)pHVar7->rghs[ihs].wFlags >> 8 != 0)) {
      part.hs.grhst = (pHVar7->rghs + ihs)->grhst;
      part.hs.wFlags = pHVar7->rghs[ihs].wFlags;
      idPlayer = (short)((TOK *)ptok)->iplr;
      dp = uVar18;
      cTorpsLeft = uVar15;
      dpMain = uVar19;
      score = lVar17;
      FLookupPart(&part);
      idPlayer = -1;
      cItem = (uint)((HUL *)lphul)->rghs[ihs].wFlags >> 8;
      uVar12 = (undefined2)((ulong)ptok >> 0x10);
      pTVar9 = (TOK *)ptok;
      uVar14 = (undefined2)((ulong)part.pcom >> 0x10);
      pCVar10 = (COMPART *)part.pcom;
      i = (uint)pTVar9->initBase + *(int *)(pCVar10[1].rgTech + 2);
      if (0x3f < i) {
        i = 0x3f;
      }
      uVar15 = cTorpsLeft;
      uVar19 = dpMain;
      uVar18 = dp;
      lVar17 = score;
      if (i == init) {
        dxRangeCur = (uint)(pTVar9->field2_0x3 == '\x01') + (pCVar10 + 1)->id;
        if ((part.hs.grhst == hstBeam) && ((*(uint *)(pCVar10[1].rgTech + 4) & 2) != 0)) {
          uVar29 = 0;
          uVar30 = 0;
          uVar27 = (undefined1)pTVar9->csh;
          uVar28 = (undefined1)((uint)pTVar9->csh >> 8);
          uVar18 = __aFulmul((long)*(int *)pCVar10[1].rgTech,(long)cItem);
          uVar18 = __aFulmul(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,uVar27))
                                                    ));
          if (*(int *)((COMPART *)part.pcom)[1].rgTech < 200) {
            grfWeapon = 1;
          }
          else {
            grfWeapon = 2;
          }
          uVar12 = (undefined2)((ulong)ptok >> 0x10);
          if (((TOK *)ptok)->pctCap != 0) {
            uVar29 = 0;
            uVar30 = 0;
            uVar27 = 100;
            uVar28 = 0;
            dp = uVar18;
            uVar18 = __aFulmul(uVar18,(ulong)((TOK *)ptok)->pctCap);
            uVar18 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,uVar27)
                                                                     )));
          }
          ptokE = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
          dpT = uVar18;
          uVar15 = cTorpsLeft;
          uVar19 = dpMain;
          lVar17 = score;
          for (itok = 0; itok < vctok; itok = itok + 1) {
            uVar12 = (undefined2)((ulong)ptokE >> 0x10);
            pTVar9 = (TOK *)ptokE;
            if ((pTVar9->wFlags & 1U) != 0) {
              uVar14 = (undefined2)((ulong)ptok >> 0x10);
              if ((pTVar9->iplr != ((TOK *)ptok)->iplr) &&
                 ((1 << (pTVar9->iplr & 0x1f) & grfAttack) != 0)) {
                dp = uVar18;
                cTorpsLeft = uVar15;
                dpMain = uVar19;
                score = lVar17;
                sVar3 = DzFromBrcBrc(pTVar9->brc,((TOK *)ptok)->brc);
                uVar18 = dp;
                uVar15 = cTorpsLeft;
                uVar19 = dpMain;
                lVar17 = score;
                if (sVar3 <= dxRangeCur) {
                  sVar3 = FIsTargetOfMdTarget(ptokE,((TOK *)ptok)->wFlags & 0xf);
                  uVar18 = dp;
                  if (sVar3 == 0) {
                    sVar3 = FIsTargetOfMdTarget(ptokE,(uint)((TOK *)ptok)->wFlags >> 4 & 0xf);
                    uVar18 = dp;
                    uVar15 = cTorpsLeft;
                    uVar19 = dpMain;
                    lVar17 = score;
                    if (sVar3 == 0) goto LAB_10f0_6bfa;
                  }
                  uVar12 = (undefined2)((ulong)ptokE >> 0x10);
                  if (((TOK *)ptokE)->pctBeamDef < 100) {
                    uVar29 = 0;
                    uVar30 = 0;
                    uVar27 = 100;
                    uVar28 = 0;
                    dp = uVar18;
                    uVar18 = __aFulmul(uVar18,(ulong)((TOK *)ptokE)->pctBeamDef);
                    uVar18 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28
                                                  ,uVar27))));
                  }
                  dp = uVar18;
                  sVar3 = FDamageTok(ptokE,itok,&dp,0,grfWeapon,
                                     *(uint *)(((COMPART *)part.pcom)[1].rgTech + 4) & 1,(long *)0x0
                                    );
                  uVar18 = dpT;
                  uVar15 = cTorpsLeft;
                  uVar19 = dpMain;
                  lVar17 = score;
                  if (sVar3 != 0) {
                    if (fSetItok == 0) {
                      fSetItok = 1;
                      pBVar8->wFlags = pBVar8->wFlags & 0xffU | itok << 8;
                    }
                    ctokDamaged = ctokDamaged + 1;
                  }
                }
              }
            }
LAB_10f0_6bfa:
            ptokE = (TOK *)CONCAT22(ptokE._2_2_,(TOK *)ptokE + 1);
          }
        }
        else {
          if (part.hs.grhst == hstBeam) {
            uVar29 = 0;
            uVar30 = 0;
            uVar27 = (undefined1)pTVar9->csh;
            uVar28 = (undefined1)((uint)pTVar9->csh >> 8);
            uVar18 = __aFulmul((long)*(int *)pCVar10[1].rgTech,(long)cItem);
            uVar19 = __aFulmul(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,uVar27
                                                                                      ))));
            uVar15 = 0;
            lVar17 = score;
          }
          else {
            dpMain._0_2_ = 0;
            dpMain._2_2_ = 0;
            uVar15 = __aFulmul((long)cItem,(ulong)(uint)pTVar9->csh);
            uVar19 = CONCAT22(dpMain._2_2_,(undefined2)dpMain);
            lVar17 = score;
          }
          do {
            for (fPrimary = 1; -1 < fPrimary; fPrimary = fPrimary + -1) {
              scoreBest = 0;
              ptokTarget = (TOK *)0x0;
              ptokE = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
              for (itok = 0; itok < vctok; itok = itok + 1) {
                uVar12 = (undefined2)((ulong)ptokE >> 0x10);
                pTVar9 = (TOK *)ptokE;
                if ((pTVar9->wFlags & 1U) != 0) {
                  uVar14 = (undefined2)((ulong)ptok >> 0x10);
                  if ((pTVar9->iplr != ((TOK *)ptok)->iplr) &&
                     ((1 << (pTVar9->iplr & 0x1f) & grfAttack) != 0)) {
                    score = lVar17;
                    cTorpsLeft = uVar15;
                    dpMain = uVar19;
                    sVar3 = DzFromBrcBrc(pTVar9->brc,((TOK *)ptok)->brc);
                    lVar17 = score;
                    uVar15 = cTorpsLeft;
                    uVar19 = dpMain;
                    if (sVar3 <= dxRangeCur) {
                      uVar12 = (undefined2)((ulong)ptok >> 0x10);
                      if (fPrimary == 0) {
                        uVar4 = (uint)((TOK *)ptok)->wFlags >> 4;
                      }
                      else {
                        uVar4 = ((TOK *)ptok)->wFlags;
                      }
                      sVar3 = FIsTargetOfMdTarget(ptokE,uVar4 & 0xf);
                      lVar17 = score;
                      uVar15 = cTorpsLeft;
                      uVar19 = dpMain;
                      if (sVar3 != 0) {
                        lpshdefE = LpshdefFromTok(ptokE);
                        uVar12 = (undefined2)((ulong)lpshdefE >> 0x10);
                        uVar4 = (((SHDEF *)lpshdefE)->hul).rgwtOreCost[1];
                        uVar1 = (((SHDEF *)lpshdefE)->hul).resCost;
                        uVar18 = __aFulmul((ulong)CONCAT12(CARRY2(uVar1,uVar4),uVar1 + uVar4
                                                                  ),(ulong)(uint)((TOK *)ptokE)->csh
                                                  );
                        if ((long)uVar18 < 100000) {
                          lValue = uVar18;
                          uVar18 = __aFulmul(uVar18,100);
                        }
                        else {
                          uVar18 = 10000000;
                        }
                        dpSingle = (((SHDEF *)lpshdefE)->hul).dp;
                        local_14 = 0;
                        uVar12 = (undefined2)((ulong)ptokE >> 0x10);
                        lValue = uVar18;
                        uVar18 = __aFulmul((ulong)(uint)((TOK *)ptokE)->dpShield,
                                                   (ulong)(uint)((TOK *)ptokE)->csh);
                        dpShieldLeft = uVar18;
                        uVar18 = __aFulmul(CONCAT22(local_14,dpSingle),
                                                   (ulong)(uint)((TOK *)ptokE)->csh);
                        uVar12 = (undefined2)((ulong)ptokE >> 0x10);
                        pTVar9 = (TOK *)ptokE;
                        if ((&pTVar9->dv)->dp != 0) {
                          uVar29 = 0;
                          uVar30 = 0;
                          uVar27 = 0xf4;
                          uVar28 = 1;
                          sVar3 = pTVar9->csh;
                          uVar26 = 0;
                          uVar25 = 0;
                          uVar24 = 10;
                          uVar4 = (&pTVar9->dv)->dp & 0x7f;
                          uVar23 = 0;
                          uVar22 = 0;
                          uVar14 = 10;
                          dpArmorLeft = uVar18;
                          uVar18 = __aFulmul(CONCAT22(local_14,dpSingle),
                                                     (ulong)((uint)(&pTVar9->dv)->dp >> 7));
                          uVar18 = __aFldiv(uVar18,CONCAT22(uVar22,uVar14));
                          uVar18 = __aFulmul(uVar18,CONCAT22(uVar23,uVar4));
                          uVar18 = __aFldiv(uVar18,CONCAT22(uVar25,uVar24));
                          uVar18 = __aFulmul(uVar18,CONCAT22(uVar26,sVar3));
                          lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(
                                                  uVar28,uVar27))));
                          uVar18 = dpArmorLeft - lVar17;
                        }
                        if ((long)uVar18 < 1) {
                          uVar18 = 1;
                        }
                        pTVar9 = (TOK *)ptokE;
                        uVar12 = (undefined2)((ulong)ptokE >> 0x10);
                        dpArmorLeft = uVar18;
                        if ((part.hs.grhst == hstBeam) || (part.hs.grhst != hstTorp)) {
                          if (pTVar9->pctBeamDef < 100) {
                            uVar29 = 0;
                            uVar30 = 0;
                            uVar27 = 100;
                            uVar28 = 0;
                            uVar18 = __aFulmul(lValue,(ulong)pTVar9->pctBeamDef);
                            uVar18 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                            lValue = uVar18;
                          }
                          if ((*(uint *)(((COMPART *)part.pcom)[1].rgTech + 4) & 1) == 0) {
                            lVar17 = dpArmorLeft + dpShieldLeft + 1;
                            uVar18 = __aFulmul(lValue,100);
                            lVar17 = __aFldiv(uVar18,lVar17);
                            uVar15 = cTorpsLeft;
                            uVar19 = dpMain;
                            if (lVar17 < 1) {
                              lVar17 = 1;
                            }
                          }
                          else if ((long)dpShieldLeft < 1) {
                            lVar17 = 0;
                            uVar15 = cTorpsLeft;
                            uVar19 = dpMain;
                          }
                          else {
                            uVar29 = (undefined1)(dpShieldLeft >> 0x10);
                            uVar30 = (undefined1)(dpShieldLeft >> 0x18);
                            uVar27 = (undefined1)dpShieldLeft;
                            uVar28 = (undefined1)(dpShieldLeft >> 8);
                            uVar18 = __aFulmul(lValue,100);
                            lVar17 = __aFldiv(uVar18 + dpShieldLeft + -1,
                                                      CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(
                                                  uVar28,uVar27))));
                            uVar15 = cTorpsLeft;
                            uVar19 = dpMain;
                          }
                        }
                        else {
                          pctHit._0_2_ = *(uint *)(((COMPART *)part.pcom)[1].rgTech + 4);
                          pctHit._2_2_ = (int)(uint)pctHit >> 0xf;
                          uVar14 = (undefined2)((ulong)ptok >> 0x10);
                          pTVar11 = (TOK *)ptok;
                          if (pTVar11->pctBC < pTVar9->pctJam) {
                            uVar29 = 0;
                            uVar30 = 0;
                            uVar27 = 100;
                            uVar28 = 0;
                            uVar18 = __aFulmul((long)(int)(uint)pctHit,
                                                       (long)(int)((uint)pTVar9->pctJam -
                                                                  (uint)pTVar11->pctBC));
                            lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                            pctHit = CONCAT22((pctHit._2_2_ - (int)((ulong)lVar17 >> 0x10)) -
                                              (uint)((uint)pctHit < (uint)lVar17),
                                              (uint)pctHit - (uint)lVar17);
                          }
                          else {
                            uVar29 = 0;
                            uVar30 = 0;
                            uVar27 = 100;
                            uVar28 = 0;
                            uVar18 = __aFulmul(CONCAT22(-(uint)(100 < (uint)pctHit) -
                                                                pctHit._2_2_,100 - (uint)pctHit),
                                                       (long)(int)((uint)pTVar11->pctBC -
                                                                  (uint)pTVar9->pctJam));
                            lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                            pctHit = lVar17 + CONCAT22(pctHit._2_2_,(uint)pctHit);
                          }
                          if ((long)pctHit < 1) {
                            lVar17 = 0;
                            uVar15 = cTorpsLeft;
                            uVar19 = dpMain;
                          }
                          else {
                            if (((part.hs.wFlags & 0xffU) < 8) || (0xb < (part.hs.wFlags & 0xffU)))
                            {
                              iVar2 = 0;
                            }
                            else {
                              iVar2 = 1;
                            }
                            if ((long)dpArmorLeft < 100000) {
                              uVar29 = (undefined1)(pctHit >> 0x10);
                              uVar30 = (undefined1)(pctHit >> 0x18);
                              uVar27 = (undefined1)pctHit;
                              uVar28 = (undefined1)(pctHit >> 8);
                              __aFulmul(dpArmorLeft,100);
                              lVar17 = __aFlshl(CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(
                                                  uVar28,uVar27))),unaff_DI);
                              uVar18 = __aFldiv(lVar17,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                              uVar19 = pctHit;
                            }
                            else {
                              uVar29 = 0;
                              uVar30 = 0;
                              uVar27 = 200;
                              uVar28 = 0;
                              uVar18 = __aFldiv(dpArmorLeft,pctHit);
                              uVar18 = __aFulmul(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                              uVar19 = pctHit;
                            }
                            pctHit._2_2_ = (int)(uVar19 >> 0x10);
                            pctHit._0_2_ = (uint)uVar19;
                            pctHit = uVar19;
                            if ((long)dpShieldLeft < 100000) {
                              iVar6 = 100 - (uint)pctHit;
                              iVar5 = -(uint)(100 < (uint)pctHit) - pctHit._2_2_;
                              lVar16 = __aFldiv(CONCAT22(iVar5,iVar6),8);
                              lVar17 = __aFldiv(pctHit,2);
                              lVar17 = lVar17 + lVar16;
                              uVar29 = (undefined1)((ulong)lVar17 >> 0x10);
                              uVar30 = (undefined1)((ulong)lVar17 >> 0x18);
                              uVar27 = (undefined1)lVar17;
                              uVar28 = (undefined1)((ulong)lVar17 >> 8);
                              uVar19 = __aFulmul(dpShieldLeft,100);
                              uVar19 = __aFldiv(uVar19,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                            }
                            else {
                              uVar29 = 0;
                              uVar30 = 0;
                              uVar27 = 100;
                              uVar28 = 0;
                              iVar6 = 100 - (uint)pctHit;
                              iVar5 = -(uint)(100 < (uint)pctHit) - pctHit._2_2_;
                              lVar16 = __aFldiv(CONCAT22(iVar5,iVar6),8);
                              lVar17 = __aFldiv(pctHit,2);
                              uVar19 = __aFldiv(dpShieldLeft,lVar17 + lVar16);
                              uVar19 = __aFulmul(uVar19,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                            }
                            uVar15 = __aFulmul(pctHit,(ulong)(iVar2 + 1));
                            uVar29 = (undefined1)(uVar15 >> 0x10);
                            uVar30 = (undefined1)(uVar15 >> 0x18);
                            uVar27 = (undefined1)uVar15;
                            uVar28 = (undefined1)(uVar15 >> 8);
                            uVar23 = 0;
                            uVar22 = 100;
                            uVar14 = 0;
                            uVar12 = 200;
                            uVar15 = __aFulmul(uVar19,pctHit);
                            lVar17 = __aFldiv(uVar15,CONCAT22(uVar14,uVar12));
                            uVar15 = __aFulmul(dpArmorLeft - lVar17,CONCAT22(uVar23,uVar22))
                            ;
                            lVar17 = __aFldiv(uVar15,CONCAT13(uVar30,CONCAT12(uVar29,
                                                  CONCAT11(uVar28,uVar27))));
                            if ((long)(lVar17 + uVar19) <= (long)uVar18) {
                              uVar18 = uVar19 + lVar17;
                            }
                            if ((long)uVar18 < 1) {
                              lVar17 = 0;
                              uVar15 = cTorpsLeft;
                              uVar19 = dpMain;
                            }
                            else {
                              score = uVar18;
                              lVar17 = __aFldiv(lValue,uVar18);
                              uVar15 = cTorpsLeft;
                              uVar19 = dpMain;
                              if (lVar17 < 1) {
                                lVar17 = 1;
                              }
                            }
                          }
                        }
                        if (scoreBest < lVar17) {
                          ptokTarget = ptokE;
                          itokTarget = itok;
                          scoreBest = lVar17;
                        }
                      }
                    }
                  }
                }
                ptokE = (TOK *)CONCAT22(ptokE._2_2_,(TOK *)ptokE + 1);
              }
              if (((TOK *)ptokTarget != (TOK *)0x0) || (ptokTarget._2_2_ != 0)) break;
            }
            if (((TOK *)ptokTarget == (TOK *)0x0) && (uVar18 = dp, ptokTarget._2_2_ == 0)) break;
            cTorpsLeft = uVar15;
            dpMain = uVar19;
            score = lVar17;
            dz = DzFromBrcBrc(((TOK *)ptokTarget)->brc,((TOK *)ptok)->brc);
            pTVar9 = (TOK *)ptok;
            uVar12 = (undefined2)((ulong)ptok >> 0x10);
            if (part.hs.grhst == hstBeam) {
              dp = dpMain;
              if (pTVar9->pctCap != 0) {
                uVar29 = 0;
                uVar30 = 0;
                uVar27 = 100;
                uVar28 = 0;
                uVar18 = __aFulmul(dpMain,(ulong)pTVar9->pctCap);
                uVar18 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                dp = uVar18;
              }
              uVar12 = (undefined2)((ulong)ptokTarget >> 0x10);
              if (((TOK *)ptokTarget)->pctBeamDef < 100) {
                uVar29 = 0;
                uVar30 = 0;
                uVar27 = 100;
                uVar28 = 0;
                uVar18 = __aFulmul(dp,(ulong)((TOK *)ptokTarget)->pctBeamDef);
                uVar18 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                dp = uVar18;
              }
              if (0 < dz) {
                uVar12 = (undefined2)((ulong)part.pcom >> 0x10);
                if (0 < ((COMPART *)part.pcom + 1)->id) {
                  uVar29 = 0;
                  uVar30 = 0;
                  uVar27 = 100;
                  uVar28 = 0;
                  iVar2 = ((COMPART *)part.pcom + 1)->id;
                  iVar6 = iVar2 >> 0xf;
                  uVar18 = __aFulmul((long)dz,10);
                  lVar17 = __aFldiv(uVar18,CONCAT22(iVar6,iVar2));
                  uVar18 = __aFulmul(dp,CONCAT22(-(uint)(100 < (uint)lVar17) -
                                                         (int)((ulong)lVar17 >> 0x10),
                                                         100 - (uint)lVar17));
                  uVar18 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                  dp = uVar18;
                }
              }
              uVar12 = (undefined2)((ulong)part.pcom >> 0x10);
              if (*(int *)((COMPART *)part.pcom)[1].rgTech < 200) {
                grfWeapon = 1;
              }
              else {
                grfWeapon = 2;
              }
              dpT = dp;
              sVar3 = FDamageTok(ptokTarget,itokTarget,&dp,0,grfWeapon,
                                 *(uint *)(((COMPART *)part.pcom)[1].rgTech + 4) & 1,(long *)0x0);
              if (sVar3 != 0) {
                if (fSetItok == 0) {
                  pBVar8->wFlags = pBVar8->wFlags & 0xffU | itokTarget << 8;
                  fSetItok = 1;
                }
                ctokDamaged = ctokDamaged + 1;
              }
              if ((dp < 1) || (dpT < 1)) {
                uVar15 = cTorpsLeft;
                uVar19 = 0;
                lVar17 = score;
              }
              else {
                if ((((dpMain < 0x20000) && (dpMain < 0x10000)) && (dp < 0x20000)) && (dp < 0x10000)
                   ) {
                  uVar29 = (undefined1)((ulong)dpT >> 0x10);
                  uVar30 = (undefined1)((ulong)dpT >> 0x18);
                  uVar27 = (undefined1)dpT;
                  uVar28 = (undefined1)((ulong)dpT >> 8);
                  uVar18 = __aFulmul(dpMain,dp);
                  uVar19 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                }
                else {
                  uVar19 = __ftol((double)CONCAT26((int)((ulong)lVar16 >> 0x10),
                                                           CONCAT24((int)lVar16,
                                                                    CONCAT22(unaff_SI,unaff_DI))));
                }
                lValue = uVar19;
                uVar15 = cTorpsLeft;
                lVar17 = score;
                if (dpMain + -1 < (long)uVar19) {
                  uVar19 = dpMain - 1;
                }
              }
            }
            else {
              uVar15 = cTorpsLeft;
              uVar19 = dpMain;
              lVar17 = score;
              if ((part.hs.grhst == hstTorp) && (0 < (long)cTorpsLeft)) {
                grfWeapon = 4;
                cTorpBase = cTorpsLeft;
                uVar18 = CTorpHit(cTorpsLeft,ptokTarget,
                                  *(short *)(((COMPART *)part.pcom)[1].rgTech + 4),
                                  (uint)pTVar9->pctBC);
                cTorpHit = uVar18;
                lpshdefE = LpshdefFromTok(ptokTarget);
                dpSingle = (((SHDEF *)lpshdefE)->hul).dp;
                local_14 = 0;
                uVar12 = (undefined2)((ulong)ptokTarget >> 0x10);
                uVar18 = __aFulmul((ulong)(uint)((TOK *)ptokTarget)->dpShield,
                                           (ulong)(uint)((TOK *)ptokTarget)->csh);
                dpShieldLeft = uVar18;
                uVar18 = __aFulmul(CONCAT22(local_14,dpSingle),
                                           (ulong)(uint)((TOK *)ptokTarget)->csh);
                uVar12 = (undefined2)((ulong)ptokTarget >> 0x10);
                pTVar9 = (TOK *)ptokTarget;
                if ((&pTVar9->dv)->dp != 0) {
                  uVar29 = 0;
                  uVar30 = 0;
                  uVar27 = 0xf4;
                  uVar28 = 1;
                  sVar3 = pTVar9->csh;
                  uVar26 = 0;
                  uVar25 = 0;
                  uVar24 = 10;
                  uVar4 = (&pTVar9->dv)->dp & 0x7f;
                  uVar23 = 0;
                  uVar22 = 0;
                  uVar14 = 10;
                  dpArmorLeft = uVar18;
                  uVar18 = __aFulmul(CONCAT22(local_14,dpSingle),
                                             (ulong)((uint)(&pTVar9->dv)->dp >> 7));
                  uVar18 = __aFldiv(uVar18,CONCAT22(uVar22,uVar14));
                  uVar18 = __aFulmul(uVar18,CONCAT22(uVar23,uVar4));
                  uVar18 = __aFldiv(uVar18,CONCAT22(uVar25,uVar24));
                  uVar18 = __aFulmul(uVar18,CONCAT22(uVar26,sVar3));
                  lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                  uVar18 = dpArmorLeft - lVar17;
                }
                dp._0_2_ = *(int *)((COMPART *)part.pcom)[1].rgTech;
                dp._2_2_ = (int)dp >> 0xf;
                uVar15 = (ulong)(int)dp;
                uVar19 = (ulong)(int)dp;
                if ((7 < (part.hs.wFlags & 0xffU)) && ((part.hs.wFlags & 0xffU) < 0xc)) {
                  if ((long)dpShieldLeft < 1) {
                    dpArmorLeft = uVar18;
                    uVar19 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),(ushort)lVar16);
                    uVar18 = dpArmorLeft;
                  }
                  grfWeapon = grfWeapon | 8;
                  uVar15 = uVar19;
                }
                i = ((TOK *)ptokTarget)->csh;
                dp = uVar15;
                dpArmorLeft = uVar18;
                if ((long)i < (long)cTorpBase) {
                  uVar18 = __aFulmul(cTorpHit,uVar15);
                  if ((long)uVar18 <= (long)dpArmorLeft) goto LAB_10f0_79f6;
                  for (; (long)i <= (long)cTorpBase; i = i + 1) {
                    uVar29 = (undefined1)(cTorpBase >> 0x10);
                    uVar30 = (undefined1)(cTorpBase >> 0x18);
                    uVar27 = (undefined1)cTorpBase;
                    uVar28 = (undefined1)(cTorpBase >> 8);
                    uVar18 = __aFulmul((long)i,cTorpHit);
                    uVar18 = __aFldiv(uVar18 + cTorpBase + -1,
                                              CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,uVar27
                                                                                      ))));
                    cTorpMiss._0_2_ = i - (uint)uVar18;
                    cTorpMiss._2_2_ =
                         ((i >> 0xf) - (int)(uVar18 >> 0x10)) - (uint)((uint)i < (uint)uVar18);
                    uVar29 = 0;
                    uVar30 = 0;
                    uVar27 = 8;
                    uVar28 = 0;
                    cTorpFire = uVar18;
                    uVar18 = __aFulmul(CONCAT22(cTorpMiss._2_2_,(int)cTorpMiss),dp);
                    lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28
                                                  ,uVar27))));
                    lVar17 = dpShieldLeft - lVar17;
                    if ((lVar17 < 0x10000) && (lVar17 < 0)) {
                      lVar17 = 0;
                    }
                    local_7c = (int)((ulong)lVar17 >> 0x10);
                    nds = (uint)lVar17;
                    uVar29 = 0;
                    uVar30 = 0;
                    uVar27 = 2;
                    uVar28 = 0;
                    uVar18 = __aFulmul(cTorpFire,dp);
                    lVar20 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28
                                                  ,uVar27))));
                    iVar2 = (local_7c - (int)((ulong)lVar20 >> 0x10)) - (uint)(nds < (uint)lVar20);
                    uVar29 = 0;
                    uVar30 = 0;
                    uVar27 = 2;
                    uVar28 = 0;
                    uVar18 = __aFulmul(cTorpFire,dp);
                    lVar21 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28
                                                  ,uVar27))));
                    if ((iVar2 < 1) && (iVar2 < 0)) {
                      lVar21 = lVar21 - (lVar17 - lVar20);
                    }
                    if ((long)dpArmorLeft <= lVar21) break;
                  }
                }
                else {
LAB_10f0_79f6:
                  cTorpMiss = cTorpBase - cTorpHit;
                  cTorpFire = cTorpHit;
                }
                uVar29 = 0;
                uVar30 = 0;
                uVar27 = 8;
                uVar28 = 0;
                uVar18 = __aFulmul(cTorpMiss,dp);
                lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                if (0 < lVar17) {
                  dpCol = lVar17;
                  sVar3 = FDamageTok(ptokTarget,itokTarget,&dpCol,0,grfWeapon | 0x80,1,(long *)0x0);
                  lVar17 = dpCol;
                  if (sVar3 != 0) {
                    ctokDamaged = ctokDamaged + 1;
                  }
                }
                uVar29 = 0;
                uVar30 = 0;
                uVar27 = 2;
                uVar28 = 0;
                dpCol = lVar17;
                uVar18 = __aFulmul(cTorpFire,dp);
                lVar17 = __aFldiv(uVar18,CONCAT13(uVar30,CONCAT12(uVar29,CONCAT11(uVar28,
                                                  uVar27))));
                cTorpBase = cTorpFire + cTorpMiss;
                dpT = lVar17;
                FDamageTok(ptokTarget,itokTarget,&dpT,lVar17,grfWeapon,0,&cTorpBase);
                ctokDamaged = ctokDamaged + 1;
                if (fSetItok == 0) {
                  fSetItok = 1;
                  pBVar8->wFlags = pBVar8->wFlags & 0xffU | itokTarget << 8;
                }
                uVar15 = cTorpsLeft - (cTorpFire + cTorpMiss);
                uVar19 = dpMain;
                lVar17 = score;
              }
            }
          } while ((0 < (long)uVar19) || (uVar18 = dp, 0 < (long)uVar15));
        }
      }
    }
    ihs = ihs + 1;
  } while( true );
}



// ======================================================================
// Function: KillShips
// Address: 10f0:7cde
// Segment: MEMORY_BATTLE
// ======================================================================


void KillShips(TOK *ptok,short cshKill,short ishdef,FLEET *lpfl,short fFallout)

{
  FLEET *pFVar1;
  FLEET *pFVar2;
  uint iplr;
  int iVar3;
  TOK *pTVar4;
  FLEET *pFVar5;
  FLEET *pFVar6;
  undefined2 uVar7;
  undefined2 unaff_SS;
  SHDEF *lphul;
  short csh;
  FLEET flSrc;
  short i;
  FLEET flDead;
  
  if (cshKill != 0) {
    pTVar4 = (TOK *)ptok;
    uVar7 = (undefined2)((ulong)ptok >> 0x10);
    if (fFallout != 0) {
      iplr = (uint)pTVar4->iplr;
      lphul = LpshdefFromTok(ptok);
      MarkTechsSeen(&lphul->hul,iplr);
    }
    pFVar6 = &flSrc;
    pFVar5 = (FLEET *)lpfl;
    for (iVar3 = 0x3e; iVar3 != 0; iVar3 = iVar3 + -1) {
      pFVar2 = pFVar6;
      pFVar6 = (FLEET *)&pFVar6->iPlayer;
      pFVar1 = pFVar5;
      pFVar5 = (FLEET *)&pFVar5->iPlayer;
      pFVar2->id = pFVar1->id;
    }
    _memset(&flDead,0,0x7c);
    iVar3 = ((FLEET *)lpfl)->rgcsh[ishdef] - cshKill;
    flDead.rgcsh[ishdef] = cshKill;
    flSrc.rgcsh[ishdef] = iVar3;
    pTVar4->csh = iVar3;
    if (iVar3 == 0) {
      pTVar4->wFlags = pTVar4->wFlags & 0xfffe;
      for (ishdef = 0; (ishdef < 0x10 && (flSrc.rgcsh[ishdef] == 0)); ishdef = ishdef + 1) {
      }
      if ((ishdef == 0x10) &&
         (((FLEET *)lpfl)->wFlags = ((FLEET *)lpfl)->wFlags & 0xfbffU | 0x400, fFallout != 0)) {
        for (i = 0; i < 3; i = i + 1) {
          uVar7 = *(undefined2 *)((int)flSrc.rgwtMin + i * 4 + 2);
          *(int *)(flDead.rgwtMin + i) = (int)flSrc.rgwtMin[i];
          *(undefined2 *)((int)flDead.rgwtMin + i * 4 + 2) = uVar7;
        }
      }
    }
    if (((uint)((FLEET *)lpfl)->wFlags >> 10 & 1) == 0) {
      flDead.iPlayer = flSrc.iPlayer;
      flDead.wFlags = flDead.wFlags & 0xfb00U | 0x407;
      FleetTransferCargoBalance(&flSrc,&flDead);
    }
    if (fFallout != 0) {
      flDead.iPlayer = flSrc.iPlayer;
      flDead.pt.x = flSrc.pt.x;
      flDead.pt.y = flSrc.pt.y;
      flDead.idPlanet = flSrc.idPlanet;
      CreateSalvage(&flDead,(THING **)&lpthBattle);
    }
    if (((uint)((FLEET *)lpfl)->wFlags >> 10 & 1) == 0) {
      pFVar6 = &flSrc;
      for (iVar3 = 0x3e; iVar3 != 0; iVar3 = iVar3 + -1) {
        pFVar2 = (FLEET *)lpfl;
        lpfl._0_2_ = (FLEET *)&((FLEET *)lpfl)->iPlayer;
        pFVar1 = pFVar6;
        pFVar6 = (FLEET *)&pFVar6->iPlayer;
        pFVar2->id = pFVar1->id;
      }
    }
  }
  return;
}



// ======================================================================
// Function: CreateSalvage
// Address: 10f0:7ee8
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Restarted to delay deadcode elimination for space: ram */

void CreateSalvage(FLEET *pfl,THING **plpth)

{
  uint *puVar1;
  undefined2 *puVar2;
  undefined2 *puVar3;
  uint uVar4;
  uint uVar5;
  short sVar6;
  short sVar7;
  uint uVar8;
  int iVar9;
  undefined2 unaff_SI;
  undefined2 *puVar10;
  undefined2 unaff_DI;
  undefined2 *puVar11;
  undefined2 unaff_SS;
  bool bVar12;
  ulong uVar13;
  long lVar14;
  long lVar15;
  HullDef in_stack_0000ff4a;
  short fBleeding;
  short j;
  uint rgwtMinerals [6];
  short i;
  PLANET *lppl;
  undefined1 *lpshdefT;
  undefined2 uVar16;
  uint wtTotal;
  int local_6;
  
  lVar15 = CONCAT22(unaff_SI,unaff_DI);
  sVar7 = GetRaceGrbit((PLAYER *)rgplr + pfl->iPlayer,ibitRaceBleedingEdgeTech);
  gd._4_2_ = gd._4_2_ & 0xfff7 | 8;
  idPlayer = pfl->iPlayer;
  if (pfl->idPlanet == -1) {
    lppl = (PLANET *)0x0;
  }
  else {
    lppl = LpplFromId(pfl->idPlanet);
  }
  for (i = 0; sVar6 = i, i < 3; i = i + 1) {
    rgwtMinerals[i * 2] = 0;
    rgwtMinerals[sVar6 * 2 + 1] = 0;
    for (j = 0; sVar6 = i, j < 0x10; j = j + 1) {
      if (0 < pfl->rgcsh[j]) {
        if (sVar7 == 0) {
          iVar9 = pfl->iPlayer * 4;
          lpshdefT = (undefined1 *)(*(int *)(iVar9 + 0xfe) + j * 0x93);
          uVar16 = *(undefined2 *)(iVar9 + 0x100);
        }
        else {
          iVar9 = pfl->iPlayer * 4;
          uVar16 = *(undefined2 *)(iVar9 + 0x100);
          puVar10 = (undefined2 *)(*(int *)(iVar9 + 0xfe) + j * 0x93);
          puVar11 = (undefined2 *)&stack0xff4a;
          for (iVar9 = 0x49; iVar9 != 0; iVar9 = iVar9 + -1) {
            puVar3 = puVar11;
            puVar11 = puVar11 + 1;
            puVar2 = puVar10;
            puVar10 = puVar10 + 1;
            *puVar3 = *puVar2;
          }
          *(undefined1 *)puVar11 = *(undefined1 *)puVar10;
          UpdateShdefCost((SHDEF *)(SHDEF *)&stack0xff4a);
          lpshdefT = &stack0xff4a;
          uVar16 = unaff_SS;
        }
        lVar14 = 3;
        uVar13 = __aFulmul((long)pfl->rgcsh[j],(ulong)*(uint *)(lpshdefT + i * 2 + 0x2c));
        lVar14 = __aFldiv(uVar13,lVar14);
        sVar6 = i;
        puVar1 = rgwtMinerals + i * 2;
        uVar8 = *puVar1;
        *puVar1 = *puVar1 + (uint)lVar14;
        rgwtMinerals[sVar6 * 2 + 1] =
             rgwtMinerals[sVar6 * 2 + 1] + (int)((ulong)lVar14 >> 0x10) +
             (uint)CARRY2(uVar8,(uint)lVar14);
      }
    }
    uVar4 = *(uint *)(pfl->rgwtMin + i);
    uVar5 = *(uint *)((int)(pfl->rgwtMin + i) + 2);
    puVar1 = rgwtMinerals + i * 2;
    uVar8 = *puVar1;
    *puVar1 = *puVar1 + uVar4;
    rgwtMinerals[sVar6 * 2 + 1] = rgwtMinerals[sVar6 * 2 + 1] + uVar5 + (uint)CARRY2(uVar8,uVar4);
    if (((PLANET *)lppl != (PLANET *)0x0) || (lppl._2_2_ != 0)) {
      lVar14 = 10;
      if (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) == 0) {
        uVar8 = 5;
      }
      else {
        uVar8 = 8;
      }
      uVar13 = __aFulmul(CONCAT22(rgwtMinerals[i * 2 + 1],rgwtMinerals[i * 2]),(ulong)uVar8)
      ;
      lVar14 = __aFldiv(uVar13,lVar14);
      puVar1 = (uint *)(((PLANET *)lppl)->rgwtMin + i);
      uVar8 = *puVar1;
      *puVar1 = *puVar1 + (uint)lVar14;
      puVar1 = (uint *)((int)(((PLANET *)lppl)->rgwtMin + i) + 2);
      *puVar1 = *puVar1 + (int)((ulong)lVar14 >> 0x10) + (uint)CARRY2(uVar8,(uint)lVar14);
    }
  }
  if (((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) {
    wtTotal = 0;
    local_6 = 0;
    for (i = 0; i < 3; i = i + 1) {
      lVar14 = __aFlshr(lVar15,in_stack_0000ff4a);
      sVar7 = i;
      puVar1 = rgwtMinerals + i * 2;
      uVar8 = *puVar1;
      *puVar1 = *puVar1 - (uint)lVar14;
      rgwtMinerals[sVar7 * 2 + 1] =
           (rgwtMinerals[sVar7 * 2 + 1] - (int)((ulong)lVar14 >> 0x10)) -
           (uint)(uVar8 < (uint)lVar14);
      bVar12 = CARRY2(wtTotal,rgwtMinerals[i * 2]);
      wtTotal = wtTotal + rgwtMinerals[i * 2];
      local_6 = local_6 + rgwtMinerals[i * 2 + 1] + (uint)bVar12;
    }
    if ((wtTotal != 0) || (local_6 != 0)) {
      DropSalvage(plpth,(long *)rgwtMinerals,pfl->iPlayer,(POINT *)&pfl->pt);
    }
  }
  uVar8 = gd._4_2_ & 0xfff7;
  gd.field3_0x4 = (char)uVar8;
  gd.field4_0x5 = (char)(uVar8 >> 8);
  idPlayer = -1;
  return;
}



// ======================================================================
// Function: FDamageTok
// Address: 10f0:81d4
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f08849) */
/* WARNING: Removing unreachable block (ram,0x10f0827b) */
/* WARNING: Removing unreachable block (ram,0x10f087c1) */
/* WARNING: Removing unreachable block (ram,0x10f08ab8) */

short FDamageTok(TOK *ptok,short itok,long *pdpBeam,long dpTorp,ushort grfWeapon,
                  short fShieldsOnly,long *pcTorp)

{
  byte *pbVar1;
  PLANET *pPVar2;
  ulong uVar3;
  ushort uVar4;
  uint ishdef_00;
  short sVar5;
  uint *puVar6;
  uint uVar7;
  TOK *pTVar8;
  byte *pbVar9;
  undefined2 uVar10;
  bool bVar11;
  SHDEF *pSVar12;
  PLANET *lppl_00;
  FLEET *lpfl_00;
  ulong uVar13;
  ulong uVar14;
  ulong uVar15;
  long lVar16;
  uint uVar17;
  undefined2 uVar18;
  undefined2 uVar19;
  undefined2 uVar20;
  int iVar21;
  ushort pctDpNew;
  uint dp;
  int local_34;
  short ishdef;
  short pctDp;
  short csh;
  int cKillMax;
  int local_26;
  FLEET *lpfl;
  undefined2 local_22;
  short cshOrig;
  short i;
  PLANET *lppl;
  uint ddpOrig;
  int local_12;
  short cshOrigDamaged;
  DV dv;
  short pctSh;
  
  dp = *(uint *)pdpBeam;
  local_34 = *(int *)((int)pdpBeam + 2);
  __fmemset(lpbBattleCur,0,8);
  *lpbBattleCur = (byte)itok;
  ((byte *)lpbBattleCur)[1] = (byte)grfWeapon;
  uVar10 = (undefined2)((ulong)ptok >> 0x10);
  pTVar8 = (TOK *)ptok;
  if (pTVar8->dpShield == 0) {
    if (fShieldsOnly != 0) {
      return 0;
    }
  }
  else {
    uVar7 = pTVar8->dpShield;
    iVar21 = pTVar8->dpShield;
    uVar13 = __aFulmul((ulong)uVar7,(ulong)(uint)pTVar8->csh);
    if (CONCAT22(local_34,dp) < (long)uVar13) {
      uVar4 = WPackLong(CONCAT22(local_34,dp));
      *(ushort *)((byte *)lpbBattleCur + 4) = uVar4;
      lVar16 = __aFldiv(uVar13 - CONCAT22(local_34,dp),(ulong)(uint)pTVar8->csh);
      pTVar8->dpShield = (int)lVar16 + (iVar21 - uVar7);
      dp = 0;
      local_34 = 0;
    }
    else {
      bVar11 = dp < (uint)uVar13;
      dp = dp - (uint)uVar13;
      local_34 = (local_34 - (int)(uVar13 >> 0x10)) - (uint)bVar11;
      uVar4 = WPackLong(uVar13);
      *(ushort *)((byte *)lpbBattleCur + 4) = uVar4;
      pTVar8->dpShield = 0;
    }
  }
  if ((((dp == 0) && (local_34 == 0)) || (fShieldsOnly != 0)) && (dpTorp == 0)) {
    *(short *)((byte *)lpbBattleCur + 6) = (&pTVar8->dv)->dp;
    *(uint *)pdpBeam = dp;
    *(int *)((int)pdpBeam + 2) = local_34;
    uVar10 = (undefined2)((ulong)lpbBattleCur >> 0x10);
    if ((((byte *)lpbBattleCur)[1] & 4) != 0) {
      pbVar1 = (byte *)lpbBattleCur + 1;
      *pbVar1 = *pbVar1 | 0xc0;
    }
    lpbBattleCur =
         (byte *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur + 8);
  }
  else {
    if (pcTorp == (long *)0x0) {
      cKillMax = -1;
      local_26 = 0x7fff;
    }
    else {
      cKillMax = (int)*pcTorp;
      local_26 = *(int *)((int)pcTorp + 2);
    }
    uVar13 = dpTorp + CONCAT22(local_34,dp);
    uVar15 = dpTorp + CONCAT22(local_34,dp);
    ishdef_00 = (uint)pTVar8->ishdef;
    pSVar12 = LpshdefFromTok(ptok);
    uVar7 = (((SHDEF *)pSVar12)->hul).dp;
    uVar3 = (ulong)uVar7;
    uVar17 = (&pTVar8->dv)->dp;
    if (pTVar8->field2_0x3 == '\x01') {
      lppl_00 = LpplFromId(ptok->id);
      uVar18 = (undefined2)((ulong)lppl_00 >> 0x10);
      pPVar2 = (PLANET *)lppl_00;
      if (uVar17 >> 7 != 0) {
        uVar19 = 0;
        uVar20 = 500;
        uVar13 = __aFulmul((ulong)uVar7,(ulong)(uVar17 >> 7));
        lVar16 = __aFldiv(uVar13,CONCAT22(uVar19,uVar20));
        uVar15 = lVar16 + uVar15;
      }
      dp = (uint)uVar15;
      if (((long)uVar15 < 0) || (((long)uVar15 < 0x10000 && (dp < uVar7)))) {
        uVar20 = 0;
        uVar17 = uVar7;
        uVar13 = __aFulmul(uVar15,500);
        lVar16 = __aFldiv(uVar13,CONCAT22(uVar20,uVar17));
        if (*(uint *)&pPVar2->field11_0x2c >> 4 == (uint)lVar16) {
          iVar21 = *(int *)&pPVar2->field11_0x2c;
          *(uint *)&pPVar2->field11_0x2c = *(uint *)&pPVar2->field11_0x2c & 0xf;
          *(uint *)&pPVar2->field11_0x2c = *(uint *)&pPVar2->field11_0x2c | iVar21 + 0x10U & 0xfff0;
        }
        else {
          uVar20 = 0;
          uVar13 = __aFulmul(uVar15,500);
          lVar16 = __aFldiv(uVar13,CONCAT22(uVar20,uVar7));
          *(uint *)&pPVar2->field11_0x2c = *(uint *)&pPVar2->field11_0x2c & 0xf | (int)lVar16 << 4;
        }
        uVar20 = (undefined2)((ulong)lpbBattleCur >> 0x10);
        *(uint *)((byte *)lpbBattleCur + 6) =
             *(uint *)((byte *)lpbBattleCur + 6) & 0x7f |
             (*(uint *)&pPVar2->field11_0x2c >> 4) << 7;
        fStarbaseDamaged = 1;
      }
      else {
        uVar20 = (undefined2)((ulong)lpbBattleCur >> 0x10);
        *(uint *)((byte *)lpbBattleCur + 6) =
             *(uint *)((byte *)lpbBattleCur + 6) & 0x7f | 64000;
        uVar13 = (ulong)lpbBattleCur >> 0x10;
        pbVar9 = (byte *)lpbBattleCur;
        (pbVar9 + 2)[0] = 1;
        (pbVar9 + 2)[1] = 0;
        pTVar8->wFlags = pTVar8->wFlags & 0xfffe;
        pTVar8->csh = 0;
        fStarbaseDied = 1;
        sVar5 = GetRaceStat((PLAYER *)rgplr + pPVar2->iPlayer,rsMajorAdv);
        if (sVar5 != raMacintosh) {
          pPVar2->wFlags = pPVar2->wFlags & 0xfdff;
          KillQueuedShips(lppl_00);
          KillQueuedMassPackets(lppl_00);
        }
      }
      uVar18 = (undefined2)((ulong)lpbBattleCur >> 0x10);
      pbVar9 = (byte *)lpbBattleCur;
      if (*(uint *)(pbVar9 + 6) >> 7 != 0) {
        *(uint *)(pbVar9 + 6) = *(uint *)(pbVar9 + 6) & 0xff80 | 100;
        (&pTVar8->dv)->dp = *(short *)((byte *)lpbBattleCur + 6);
      }
      *(undefined2 *)pdpBeam = 0;
      *(undefined2 *)((int)pdpBeam + 2) = 0;
      lpbBattleCur =
           (byte *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur + 8);
    }
    else {
      if (((uint)pTVar8->wFlags >> 8 & 0xf) == 1) {
        pTVar8->wFlags = pTVar8->wFlags & 0xf0ff;
        pTVar8->wFlags = pTVar8->wFlags & 0xfc1fU | 0xe0;
      }
      lpfl_00 = LpflFromId(ptok->id);
      iVar21 = pTVar8->csh;
      if (uVar17 >> 7 == 0) {
        cshOrigDamaged = 0;
        uVar15 = 0;
      }
      else {
        uVar20 = 0;
        uVar18 = 100;
        uVar15 = __aFulmul((long)iVar21,(ulong)(uVar17 & 0x7f));
        lVar16 = __aFldiv(uVar15,CONCAT22(uVar20,uVar18));
        cshOrigDamaged = (short)lVar16;
        if (cshOrigDamaged == 0) {
          cshOrigDamaged = 1;
        }
        uVar20 = 0;
        uVar18 = 500;
        uVar15 = __aFulmul((ulong)uVar7,(ulong)(uVar17 >> 7));
        uVar15 = __aFldiv(uVar15,CONCAT22(uVar20,uVar18));
        if (uVar15 == 0) {
          uVar15 = 1;
        }
      }
      sVar5 = cshOrigDamaged;
      local_12 = (int)(uVar15 >> 0x10);
      ddpOrig = (uint)uVar15;
      puVar6 = vrgPlrLosses + (uint)pTVar8->iplr * 0x10 + ishdef_00;
      *puVar6 = *puVar6 | 0x8000;
      csh = iVar21;
      if (cshOrigDamaged != 0) {
        csh = cshOrigDamaged;
        lVar16 = CONCAT22(-(uint)(uVar7 < ddpOrig) - local_12,uVar7 - ddpOrig);
        while (((lVar16 <= (long)uVar13 && (csh != 0)) && ((cKillMax != 0 || (local_26 != 0))))) {
          uVar13 = uVar13 - lVar16;
          csh = csh + -1;
          bVar11 = cKillMax == 0;
          cKillMax = cKillMax + -1;
          local_26 = local_26 - (uint)bVar11;
          if ((*puVar6 & 0x1fff) < 0x1fff) {
            *puVar6 = *puVar6 + 1;
          }
        }
        uVar3 = uVar15 + lVar16;
        cshOrigDamaged = csh;
        csh = csh + (iVar21 - sVar5);
      }
      while ((((long)uVar3 <= (long)uVar13 && (csh != 0)) && ((cKillMax != 0 || (local_26 != 0)))))
      {
        uVar13 = uVar13 - uVar3;
        csh = csh + -1;
        bVar11 = cKillMax == 0;
        cKillMax = cKillMax + -1;
        local_26 = local_26 - (uint)bVar11;
        if ((*puVar6 & 0x1fff) < 0x1fff) {
          *puVar6 = *puVar6 + 1;
        }
      }
      if ((local_26 < 1) && ((local_26 < 0 || (cKillMax == 0)))) {
        uVar13 = 0;
      }
      iVar21 = csh >> 0xf;
      if ((uVar13 == 0) || (csh == 0)) {
        if (cshOrigDamaged == 0) {
          pctSh = 0;
          pctDp = 0;
        }
        else {
          sVar5 = csh;
          uVar15 = __aFulmul((long)cshOrigDamaged,100);
          lVar16 = __aFldiv(uVar15 + (long)csh + -1,CONCAT22(iVar21,sVar5));
          pctSh = (short)lVar16;
          pctDp = (uint)(&pTVar8->dv)->dp >> 7;
        }
      }
      else {
        if (cshOrigDamaged != 0) {
          uVar15 = __aFulmul(uVar15,(long)cshOrigDamaged);
          uVar13 = uVar15 + (long)csh + -1 + uVar13;
        }
        uVar13 = __aFldiv(uVar13,(long)csh);
        if (uVar13 == 0) {
          uVar13 = 1;
        }
        uVar15 = uVar3;
        uVar14 = __aFulmul(uVar13,500);
        lVar16 = __aFldiv(uVar14 + uVar3 + -1,uVar15);
        pctDp = (short)lVar16;
        if (pctDp == 0) {
          pctDp = 1;
        }
        pctSh = 100;
      }
      *(short *)((byte *)lpbBattleCur + 2) = pTVar8->csh - csh;
      if (csh != pTVar8->csh) {
        KillShips(ptok,*(short *)((byte *)lpbBattleCur + 2),ishdef_00,lpfl_00,1);
      }
      local_22 = (undefined2)((ulong)lpfl_00 >> 0x10);
      lpfl = (FLEET *)lpfl_00;
      if (csh != 0) {
        if (499 < pctDp) {
          pctDp = 499;
        }
        uVar7 = pctDp << 7 | pctSh & 0x7fU;
        (&pTVar8->dv)->dp = uVar7;
        (lpfl->rgdv + ishdef_00)->dp = uVar7;
        uVar13 = 0;
      }
      if (dpTorp < (long)uVar13) {
        *(int *)pdpBeam = (int)(uVar13 - dpTorp);
        *(undefined2 *)((int)pdpBeam + 2) = (int)(uVar13 - dpTorp >> 0x10);
      }
      else {
        *(undefined2 *)pdpBeam = 0;
        *(undefined2 *)((int)pdpBeam + 2) = 0;
      }
      *(short *)((byte *)lpbBattleCur + 6) = (&pTVar8->dv)->dp;
      lpbBattleCur =
           (byte *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur + 8);
      if (pcTorp != (long *)0x0) {
        *(int *)pcTorp = cKillMax;
        *(int *)((int)pcTorp + 2) = local_26;
      }
    }
  }
  return 1;
}



// ======================================================================
// Function: DxyFromSpdRound
// Address: 10f0:8b28
// Segment: MEMORY_BATTLE
// ======================================================================


short DxyFromSpdRound(ushort spd,short iRound)

{
  uint uVar1;
  short dxy;
  
  dxy = (spd + 2) / 4;
  uVar1 = spd & 3;
  if (uVar1 == 0) {
    dxy = dxy + (uint)((iRound & 1U) == 0);
  }
  else if (uVar1 == 1) {
    dxy = dxy + (uint)((iRound & 3U) != 2);
  }
  else if (uVar1 == 3) {
    dxy = dxy + (uint)((iRound & 3U) == 0);
  }
  return dxy;
}



// ======================================================================
// Function: FDoCoolBattle
// Address: 10f0:8bcc
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f098b8) */

short FDoCoolBattle
          (FLEET *lpfl,short cplr,ushort *rggrfAttack,ushort grfPlayer,ushort grfSpectator)

{
  FLEET *pFVar1;
  int iVar2;
  byte *pbVar3;
  PLANET *pPVar4;
  byte *pbVar5;
  byte *pbVar6;
  short sVar7;
  uint uVar8;
  BTLDATA *pBVar9;
  TOK *pTVar10;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar11;
  byte *pbVar12;
  ulong uVar13;
  long lVar14;
  undefined2 uVar15;
  long lVar16;
  undefined1 *in_stack_0000fd74;
  undefined1 env [12];
  uint local_27e;
  long lwt;
  short itok;
  ushort wtNext;
  ushort rgPlrLosses [256];
  byte rgfInit [64];
  BTLDATA *lpbtldata;
  ushort brcOrig;
  FLEET *lpflT;
  short iRound;
  BTLREC *lpbtlrec;
  short initMin;
  short j;
  short i;
  ushort grplrLeft;
  ushort wtT;
  short init;
  short initMac;
  byte *lpbSav;
  short cShdefsInvolved;
  ushort wt;
  TOK *ptok;
  byte *lpbMax;
  undefined2 local_8;
  short cShipsInvolved;
  
  lVar16 = CONCAT22(unaff_SI,unaff_DI);
  if (lpbBattleLog == (byte *)0x0) {
    in_stack_0000fd74 = penvMem;
    penvMem = env;
    sVar7 = __setjmp(env);
    pbVar12 = (byte *)CONCAT22(lpbBattleT._2_2_,(byte *)lpbBattleT);
    if (sVar7 != 0) {
      sVar7 = -1;
      penvMem = in_stack_0000fd74;
      pbVar3 = lpbBattleLog;
      pbVar5 = lpbBattleCur;
      goto LAB_10f0_9911;
    }
    pbVar12 = LpAlloc(0xffc8,htBattle);
    lpbBattleLog = pbVar12;
    lpbBattleCur = pbVar12;
  }
  pbVar12 = (byte *)CONCAT22(lpbBattleT._2_2_,(byte *)lpbBattleT);
  lpbSav = lpbBattleCur;
  if (((byte *)lpbBattleT == (byte *)0x0) &&
     (pbVar12 = (byte *)CONCAT22(lpbBattleT._2_2_,(byte *)lpbBattleT),
     lpbBattleT._2_2_ == 0)) {
    in_stack_0000fd74 = penvMem;
    penvMem = env;
    sVar7 = __setjmp(env);
    pbVar12 = (byte *)CONCAT22(lpbBattleT._2_2_,(byte *)lpbBattleT);
    if (sVar7 != 0) {
      sVar7 = -1;
      penvMem = in_stack_0000fd74;
      pbVar3 = lpbBattleLog;
      pbVar5 = lpbBattleCur;
      goto LAB_10f0_9911;
    }
    pbVar12 = LpAlloc(0xffc8,htBattle);
    lpbSav = lpbBattleCur;
  }
  lpbBattleT._2_2_ = (int)((ulong)pbVar12 >> 0x10);
  lpbBattleT._0_2_ = (byte *)pbVar12;
  lpbMax = (byte *)lpbBattleT + -0x48;
  local_8 = lpbBattleT._2_2_;
  lpbBattleT = pbVar12;
  lpbBattleCur = pbVar12;
  _memset(rgPlrLosses,0,0x200);
  vrgPlrLosses = rgPlrLosses;
  _memset(rgfInit,0,0x40);
  __fmemset((TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok),0,0x1d00);
  vctok = 0;
  lpbtldata = (BTLDATA *)lpbBattleCur;
  lpbBattleCur._0_2_ = (byte *)lpbBattleCur + 0xe;
  _memset((byte *)rgTechBattle,0,6);
  _memset((byte *)rgTechTrader,0,0xd);
  lpthBattle._0_2_ = (THING *)0x0;
  lpthBattle._2_2_ = 0;
  cShdefsInvolved = 0;
  cShipsInvolved = 0;
  fStarbaseDied = 0;
  fStarbaseDamaged = 0;
  lpflT = lpfl;
  do {
    if (((uint)((FLEET *)lpflT)->wFlags >> 10 & 1) == 0) {
      for (i = 0; i < 0x10; i = i + 1) {
        if (0 < ((FLEET *)lpflT)->rgcsh[i]) {
          cShipsInvolved = cShipsInvolved + ((FLEET *)lpflT)->rgcsh[i];
          rgPlrLosses[((FLEET *)lpflT)->iPlayer * 0x10 + i] = 0x8000;
        }
      }
    }
    uVar11 = (undefined2)((ulong)lpflT >> 0x10);
                    /* WARNING: Load size is inaccurate */
    pFVar1 = ((FLEET *)lpflT)->lpflNext;
    iVar2 = *(int *)((int)&((FLEET *)lpflT)->lpflNext + 2);
    lpflT = (FLEET *)CONCAT22(iVar2,pFVar1);
  } while ((lpfl != lpflT) && ((pFVar1 != (FLEET *)0x0 || (iVar2 != 0))));
  for (i = 0; i < 0x100; i = i + 1) {
    if (rgPlrLosses[i] != 0) {
      rgPlrLosses[i] = 0;
      cShdefsInvolved = cShdefsInvolved + 1;
    }
  }
  if (((FLEET *)lpfl)->idPlanet != -1) {
    lwt = (long)LpplFromId(((FLEET *)lpfl)->idPlanet);
    uVar11 = (undefined2)((ulong)lwt >> 0x10);
    pPVar4 = (PLANET *)lwt;
    if ((((uint)pPVar4->wFlags >> 9 & 1) != 0) &&
       ((1 << ((byte)pPVar4->iPlayer & 0x1f) & grfPlayer) != 0)) {
      cShdefsInvolved = cShdefsInvolved + 1;
      cShipsInvolved = cShipsInvolved + 1;
      pPVar4->wFlags = pPVar4->wFlags & 0xbfffU | 0x4000;
    }
  }
  InitializeBoard(lpfl,((cplr + -1) * cplr) / 2,grfPlayer,rgfInit,&initMin,&initMac);
  uVar11 = (undefined2)((ulong)lpbtldata >> 0x10);
  pBVar9 = (BTLDATA *)lpbtldata;
  pBVar9->cplr = (byte)cplr;
  pBVar9->ctok = (byte)vctok;
  pBVar9->idPlanet = ((FLEET *)lpfl)->idPlanet;
  sVar7 = (((FLEET *)lpfl)->pt).y;
  (&pBVar9->pt)->x = (&((FLEET *)lpfl)->pt)->x;
  (pBVar9->pt).y = sVar7;
  iVar2 = idBattle + 1;
  lpbtldata->id = idBattle;
  idBattle = iVar2;
  for (iRound = 0; iRound < 0x10; iRound = iRound + 1) {
    grplrLeft = 0;
    for (itok = 0; itok < vctok; itok = itok + 1) {
      if ((((TOK *)vrgtok)[itok].wFlags & 1U) != 0) {
        grplrLeft = grplrLeft | 1 << (((TOK *)vrgtok)[itok].iplr & 0x1f);
        lwt = CONCAT22(((TOK *)vrgtok)[itok].wFlags,(undefined2)lwt) & 0xfffffff;
        ((TOK *)vrgtok)[itok].wFlags = lwt._2_2_;
        if (((0 < iRound) && (((TOK *)vrgtok)[itok].dpShield != 0)) &&
           ((((TOK *)vrgtok)[itok].wFlags & 1U) != 0)) {
          sVar7 = GetRaceGrbit((PLAYER *)rgplr +
                                     ((TOK *)vrgtok)[itok].iplr,
                                     ibitRaceRegeneratingShields);
          if (sVar7 != 0) {
            RegenShield((TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok + itok));
          }
        }
      }
    }
    if ((grplrLeft - 1 & grplrLeft) == 0) break;
    ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
    for (itok = 0; itok < vctok; itok = itok + 1) {
      uVar11 = (undefined2)((ulong)ptok >> 0x10);
      pTVar10 = (TOK *)ptok;
      if ((pTVar10->wFlags & 1U) != 0) {
        if (pTVar10->field2_0x3 == '\x01') {
          pTVar10->wFlags = pTVar10->wFlags & 0x3fff;
        }
        else {
          sVar7 = DxyFromSpdRound((uint)pTVar10->wFlags >> 8 & 0xf,iRound);
          lwt = CONCAT22(sVar7,(undefined2)lwt);
          uVar11 = (undefined2)((ulong)ptok >> 0x10);
          ((TOK *)ptok)->wFlags = ((TOK *)ptok)->wFlags & 0x3fffU | sVar7 << 0xe;
        }
      }
      ptok = (TOK *)CONCAT22(ptok._2_2_,(TOK *)ptok + 1);
    }
    for (j = 3; 0 < j; j = j + -1) {
      wt = 30000;
      i = vctok;
      do {
        wtNext = 0;
        ptok = (TOK *)CONCAT22(vrgtok._2_2_,(TOK *)vrgtok);
        for (itok = 0; itok < vctok; itok = itok + 1) {
          uVar11 = (undefined2)((ulong)ptok >> 0x10);
          pTVar10 = (TOK *)ptok;
          if (((pTVar10->wFlags & 1U) == 0) || (pTVar10->wt == -1)) {
            i = i + -1;
          }
          else {
            uVar8 = (uint)pTVar10->wFlags >> 10 & 0xf;
            lwt = CONCAT22(-(uint)(uVar8 < 7),uVar8 - 7);
            lwt = __aFlshl(lVar16,(ushort)in_stack_0000fd74);
            uVar15 = 0;
            uVar11 = 100;
            uVar13 = __aFulmul((ulong)(uint)((TOK *)ptok)->wt,lwt);
            lVar14 = __aFldiv(uVar13,CONCAT22(uVar15,uVar11));
            uVar11 = (undefined2)((ulong)ptok >> 0x10);
            lwt = lVar14 + (ulong)(uint)((TOK *)ptok)->wt;
            wtT = (ushort)lwt;
            if ((wtNext < wtT) && (wtT < wt)) {
              sVar7 = DxyFromSpdRound((uint)((TOK *)ptok)->wFlags >> 8 & 0xf,iRound);
              if (sVar7 != 0) {
                wtNext = wtT;
              }
            }
            uVar11 = lpbBattleCur._2_2_;
            pbVar6 = (byte *)lpbBattleCur;
            if (wtT == wt) {
              i = i + -1;
              uVar15 = (undefined2)((ulong)ptok >> 0x10);
              pTVar10 = (TOK *)ptok;
              if (j <= (int)((uint)pTVar10->wFlags >> 0xe)) {
                lpbtlrec = (BTLREC *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur)
                ;
                lpbBattleCur._0_2_ = (byte *)lpbBattleCur + 6;
                lpbtlrec->itok = (byte)itok;
                (pbVar6 + 2)[0] = 0;
                (pbVar6 + 2)[1] = 0;
                *(uint *)(pbVar6 + 4) = *(uint *)(pbVar6 + 4) & 0xff | itok << 8;
                *(uint *)(pbVar6 + 4) = *(uint *)(pbVar6 + 4) & 0xfff0 | iRound & 0xfU;
                uVar8 = (uint)pTVar10->wFlags >> 5;
                local_27e = uVar8 & 0x1f;
                *(uint *)(pbVar6 + 4) = *(uint *)(pbVar6 + 4) & 0xff0f | (uVar8 & 0xf) << 4;
                brcOrig = (ushort)((TOK *)vrgtok)[itok].brc;
                if (((uint)pTVar10->wFlags >> 8 & 0xf) == 0) {
                  brcOrig = 0xff;
                  if (((uint)pTVar10->wFlags >> 5 & 0x1f) == 0) {
                    pbVar6[1] = 0xff;
                    pTVar10->wFlags = pTVar10->wFlags & 0xfffe;
                    goto LAB_10f0_91a1;
                  }
                  local_27e = pTVar10->wFlags - 0x20U & 0x3e0;
                  pTVar10->wFlags = pTVar10->wFlags & 0xfc1f;
                  pTVar10->wFlags = pTVar10->wFlags | local_27e;
                }
                DxyMoveTokTo(ptok,j,rggrfAttack[pTVar10->iplr]);
                uVar11 = (undefined2)((ulong)ptok >> 0x10);
                pTVar10 = (TOK *)ptok;
                local_27e = pTVar10->wFlags + 0xc000U & 0xc000;
                pTVar10->wFlags = pTVar10->wFlags & 0x3fff;
                pTVar10->wFlags = pTVar10->wFlags | local_27e;
                if ((pTVar10->field2_0x3 == '\x01') ||
                   ((brcOrig == pTVar10->brc && (pTVar10->initMin != 0xff)))) {
                  lpbBattleCur._0_2_ = (byte *)lpbBattleCur + -6;
                }
                else {
                  ((BTLREC *)lpbtlrec)->brcDest = pTVar10->brc;
                }
              }
            }
          }
LAB_10f0_91a1:
          ptok = (TOK *)CONCAT22(ptok._2_2_,(TOK *)ptok + 1);
        }
        wt = wtNext;
      } while (wtNext != 0);
    }
    grplrLeft = 0;
    for (i = 0; i < vctok; i = i + 1) {
      if ((((TOK *)vrgtok)[i].wFlags & 1U) != 0) {
        uVar8 = Random(0xf);
        local_27e = (uVar8 & 0xf) << 10;
        lwt = CONCAT22(uVar8,local_27e);
        local_27e = ((TOK *)vrgtok)[i].wFlags & 0xc3ffU | local_27e;
        ((TOK *)vrgtok)[i].wFlags = local_27e;
        grplrLeft = grplrLeft | 1 << (((TOK *)vrgtok)[i].iplr & 0x1f);
      }
    }
    for (i = 0; i < game.cPlayer; i = i + 1) {
      if (((1 << ((byte)i & 0x1f) & grplrLeft) != 0) && ((grplrLeft & rggrfAttack[i]) == 0)) {
        grplrLeft = grplrLeft & ~(1 << ((byte)i & 0x1f));
      }
    }
    if ((grplrLeft - 1 & grplrLeft) == 0) break;
    for (init = initMac; initMin <= init; init = init + -1) {
      iVar2 = vctok;
      if (rgfInit[init] != 0) {
        while (uVar15 = vrgtok._2_2_, uVar11 = lpbBattleCur._2_2_,
              pbVar6 = (byte *)lpbBattleCur, itok = iVar2 + -1, -1 < itok) {
          iVar2 = itok;
          if (((int)(uint)((TOK *)vrgtok)[itok].initMin <= init) &&
             (init <= (int)(uint)((TOK *)vrgtok)[itok].initMac)) {
            grplrLeft = 0;
            for (i = 0; i < vctok; i = i + 1) {
              if ((((TOK *)vrgtok)[i].wFlags & 1U) != 0) {
                grplrLeft = grplrLeft | 1 << (((TOK *)vrgtok)[i].iplr & 0x1f);
              }
            }
            if ((grplrLeft - 1 & grplrLeft) == 0) break;
            pTVar10 = (TOK *)vrgtok + itok;
            ptok = (TOK *)CONCAT22(vrgtok._2_2_,pTVar10);
            if ((pTVar10->wFlags & 1U) != 0) {
              lpbtlrec = (BTLREC *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur);
              lpbBattleCur._0_2_ = (byte *)lpbBattleCur + 6;
              lpbtlrec->itok = (byte)itok;
              (pbVar6 + 2)[0] = 0;
              (pbVar6 + 2)[1] = 0;
              *(uint *)(pbVar6 + 4) = *(uint *)(pbVar6 + 4) & 0xfff0 | iRound & 0xfU;
              pbVar6[1] = pTVar10->brc;
              *(uint *)(pbVar6 + 4) = *(uint *)(pbVar6 + 4) & 0xff | itok * 0x100;
              lwt = CONCAT22((uint)pTVar10->wFlags >> 5,(undefined2)lwt) & 0x1fffff;
              *(uint *)(pbVar6 + 4) = *(uint *)(pbVar6 + 4) & 0xff0f | (lwt._2_2_ & 0xf) << 4;
              sVar7 = FAttack(itok,init,(BTLREC *)CONCAT22(uVar11,pbVar6),rggrfAttack[pTVar10->iplr]
                             );
              iVar2 = itok;
              if (sVar7 == 0) {
                lpbBattleCur._0_2_ = (byte *)lpbBattleCur + -6;
              }
              else {
                uVar11 = (undefined2)((ulong)ptok >> 0x10);
                ((TOK *)ptok)->wFlags = ((TOK *)ptok)->wFlags & 0xffef;
              }
            }
          }
        }
      }
    }
    if ((grplrLeft - 1 & grplrLeft) == 0) break;
  }
  ((BTLDATA *)lpbtldata)->cbData = (int)(byte *)lpbBattleCur - (int)(BTLDATA *)lpbtldata;
  SendBattleMessages(lpfl,cplr,lpbtldata->id,rgPlrLosses,grfPlayer,cShipsInvolved,cShdefsInvolved,
                     grfSpectator);
  uVar11 = (undefined2)((ulong)lpbtldata >> 0x10);
  pBVar9 = (BTLDATA *)lpbtldata;
  pBVar9->grfPlr = grfPlayer;
  lwt = CONCAT22(-(uint)((byte *)0xffc8 < (byte *)lpbSav),-(int)(byte *)lpbSav - 0x38U);
  if ((-(uint)((byte *)0xffc8 < (byte *)lpbSav) == 0) &&
     (-(int)(byte *)lpbSav - 0x38U < (uint)pBVar9->cbData)) {
    lpbSav[0] = 0xff;
    lpbSav[1] = 0xff;
    lpbBattleT = (byte *)0x0;
  }
  else {
    __fmemmove(lpbSav,lpbtldata,pBVar9->cbData);
    lpbBattleCur._0_2_ = (byte *)lpbSav + ((BTLDATA *)lpbtldata)->cbData;
    lpbBattleCur._2_2_ = lpbSav._2_2_;
  }
  sVar7 = 1;
  pbVar3 = lpbBattleLog;
  pbVar12 = lpbBattleT;
  pbVar5 = (byte *)CONCAT22(lpbBattleCur._2_2_,(byte *)lpbBattleCur);
LAB_10f0_9911:
  lpbBattleCur._2_2_ = (undefined2)((ulong)pbVar5 >> 0x10);
  lpbBattleCur._0_2_ = (byte *)pbVar5;
  lpbBattleT._2_2_ = (int)((ulong)pbVar12 >> 0x10);
  lpbBattleT._0_2_ = (byte *)pbVar12;
  lpbBattleLog._2_2_ = (undefined2)((ulong)pbVar3 >> 0x10);
  lpbBattleLog._0_2_ = (byte *)pbVar3;
  return sVar7;
}



// ======================================================================
// Function: ITechLearnATech
// Address: 10f0:9918
// Segment: MEMORY_BATTLE
// ======================================================================


short ITechLearnATech(short iplr,short x,short y,MessageId idm,ushort *piGoto)

{
  uint *puVar1;
  uint uVar2;
  short sVar3;
  short sVar4;
  uint *puVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar6;
  ulong uVar7;
  undefined4 uVar8;
  long lVar9;
  ushort in_stack_0000ffec;
  uint l;
  int local_e;
  short iTech;
  short i;
  short fBattle;
  ushort iGoto;
  
  lVar9 = CONCAT22(unaff_SI,unaff_DI);
  if (((*(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) >> 3 & 1) == 0) &&
     (sVar3 = Random(100), 0x31 < sVar3)) {
    for (i = 0; i < 0xd; i = i + 1) {
      sVar3 = Random(0xd);
      if (((((byte *)rgTechTrader)[sVar3] != 0) &&
          ((1 << ((byte)sVar3 & 0x1f) &
           *(uint *)((int)&rgplr[0].grbitTrader + iplr * 0xc0)) == 0)) &&
         (sVar4 = Random(100), sVar4 < (int)(uint)((byte *)rgTechTrader)[sVar3]))
      {
        sVar4 = IdmGiveTraderPart(1 << ((byte)sVar3 & 0x1f),iplr,&iGoto);
        if (idm != ~idmColonistsDroppedMassacredGroundTroops) {
          FSendPlrMsg2(iplr,sVar4 + idmStarbaseHasBuiltNew,iGoto,x,y);
        }
        else if (piGoto != (ushort *)0x0) {
          *piGoto = iGoto;
        }
        *(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) =
             *(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) & 0xfff7 | 8;
        return -(sVar3 + 1);
      }
    }
    for (i = 0; i < 6; i = i + 1) {
      sVar3 = Random(6);
      if ((int)*(char *)(iplr * 0xc0 + 0x59bc + sVar3) <
          (int)(uint)((byte *)rgTechBattle)[sVar3]) {
        lVar6 = GetTechLevelCost(sVar3,*(char *)(iplr * 0xc0 + 0x59bc + sVar3) + 1,iplr);
        if (((uint)game.wCrap >> 1 & 1) != 0) {
          lVar6 = __aFlshr(lVar9,in_stack_0000ffec);
        }
        local_e = (int)((ulong)lVar6 >> 0x10);
        l = (uint)lVar6;
        puVar5 = (uint *)(iplr * 0xc0 + 0x59c2 + sVar3 * 4);
        puVar1 = puVar5;
        uVar2 = *puVar1;
        *puVar1 = *puVar1 + l;
        puVar1 = puVar5 + 1;
        *puVar1 = *puVar1 + local_e + (uint)CARRY2(uVar2,l);
        if (idm != ~idmColonistsDroppedMassacredGroundTroops) {
          if (((uint)game.wCrap >> 1 & 1) != 0) {
            lVar6 = __aFlshl(lVar9,l);
          }
          uVar8 = 0;
          uVar7 = __aFulshr(0,(ushort)lVar9);
          l = (uint)lVar6;
          FSendPlrMsg(iplr,idm,-2,x,y,sVar3,l,(short)uVar7,(short)uVar8,
                           (short)((ulong)uVar8 >> 0x10));
        }
        else if (piGoto != (ushort *)0x0) {
          *piGoto = 0xfffe;
        }
        *(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) =
             *(uint *)((int)&rgplr[0].wFlags + iplr * 0xc0) & 0xfff7 | 8;
        return sVar3 + 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: SendBattleMessages
// Address: 10f0:9c0e
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f0ab9e) */

void SendBattleMessages
          (FLEET *lpflBtl,short cplr,short idBtl,ushort *rgPlrLosses,short grfPlayer,
          short cShipsInvolved,short cShdefsInvolved,ushort grfSpectator)

{
  int iVar1;
  PLANET *pPVar2;
  bool bVar3;
  short sVar4;
  uint uVar5;
  FLEET *pFVar6;
  ushort unaff_DI;
  undefined2 uVar7;
  ulong uVar8;
  undefined4 uVar9;
  short x;
  short cThem;
  uint *pwUs;
  short iThem;
  short cUsDead;
  short j;
  short idm;
  short i;
  short cThemDead;
  FLEET *lpfl;
  short y;
  short cUs;
  short fAlive;
  uint *pwThem;
  PLANET *lppl;
  short isb;
  uint *pw;
  uint lpopStarbase;
  int local_1a;
  undefined1 rgcfl [16];
  short iplr;
  short iplrStarbase;
  
  iplrStarbase = -1;
  lppl = (PLANET *)0x0;
  _memset(rgcfl,0,0x10);
  uVar7 = (undefined2)((ulong)lpflBtl >> 0x10);
  pFVar6 = (FLEET *)lpflBtl;
  if (pFVar6->idPlanet == -1) {
    x = (&pFVar6->pt)->x;
    y = (pFVar6->pt).y;
  }
  else {
    x = -1;
    y = pFVar6->idPlanet;
    lppl = LpplFromId(y);
    uVar7 = (undefined2)((ulong)lppl >> 0x10);
    pPVar2 = (PLANET *)lppl;
    iThem = pPVar2->iPlayer;
    if (iThem != -1) {
      if ((((uint)pPVar2->wFlags >> 9 & 1) != 0) || (fStarbaseDied != 0)) {
        isb = *(uint *)&pPVar2->field11_0x2c & 0xf;
        iplrStarbase = iThem;
      }
      if ((fStarbaseDied != 0) &&
         (iplr = iThem,
         sVar4 = GetRaceStat((PLAYER *)rgplr + pPVar2->iPlayer,rsMajorAdv),
         sVar4 == raMacintosh)) {
        lpopStarbase = *(uint *)(pPVar2->rgwtMin + 3);
        local_1a = *(int *)((int)pPVar2->rgwtMin + 0xe);
        UninhabitPlanet(lppl);
      }
    }
  }
  lpfl = lpflBtl;
  do {
    uVar7 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar6 = (FLEET *)lpfl;
    if (((uint)pFVar6->wFlags >> 10 & 1) == 0) {
      for (i = 0; i < 0x10; i = i + 1) {
        if (0 < pFVar6->rgcsh[i]) {
          rgPlrLosses[pFVar6->iPlayer * 0x10 + i] = rgPlrLosses[pFVar6->iPlayer * 0x10 + i] | 0x4000
          ;
        }
      }
    }
                    /* WARNING: Load size is inaccurate */
    iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
    lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
  } while ((lpflBtl != lpfl) && ((pFVar6->lpflNext != (FLEET *)0x0 || (iVar1 != 0))));
  iplr = 0;
  do {
    if (game.cPlayer <= iplr) {
      return;
    }
    if ((1 << ((byte)iplr & 0x1f) & grfPlayer) == 0) {
      if ((((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) ||
         (((PLANET *)lppl)->iPlayer != iplr)) {
        if ((iplr & grfSpectator) != 0) {
          lpfl = lpflBtl;
          while( true ) {
            uVar7 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar6 = (FLEET *)lpfl;
            if (pFVar6->iPlayer == iplr) break;
                    /* WARNING: Load size is inaccurate */
            iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
            lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
            if ((lpflBtl == lpfl) || ((pFVar6->lpflNext == (FLEET *)0x0 && (iVar1 == 0)))) break;
          }
          if ((((FLEET *)lpfl != (FLEET *)0x0) || (lpfl._2_2_ != 0)) &&
             (((FLEET *)lpfl)->iPlayer == iplr)) {
            FSendPlrMsg(iplr,idmReportsBattleTookPlaceForcesInvolved,lpfl->id | 0x8000,lpfl->id
                             ,(&((FLEET *)lpfl)->pt)->x,(((FLEET *)lpfl)->pt).y,0,0,0,0);
            ITechLearnATech(iplr,x,y,idmWreckageBattleOccurredOrbitHasBoostedResearch,(ushort *)0x0)
            ;
          }
        }
      }
      else {
        FSendPlrMsg2(iplr,idmColonyReportsBattleTookPlaceOrbitForces,lppl->id,lppl->id,0);
        ITechLearnATech(iplr,x,y,idmFleetFoundWreckageBattleWhichHasBoosted,(ushort *)0x0);
      }
LAB_10f0_ad23:
      if ((1 << ((byte)iplr & 0x1f) & grfMissed) != 0) {
        lpfl = lpflBtl;
        while( true ) {
          uVar7 = (undefined2)((ulong)lpfl >> 0x10);
          pFVar6 = (FLEET *)lpfl;
          if ((pFVar6->iPlayer == iplr) && (((uint)pFVar6->wFlags >> 7 & 1) != 0)) break;
                    /* WARNING: Load size is inaccurate */
          iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
          lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
          if ((lpflBtl == lpfl) || ((pFVar6->lpflNext == (FLEET *)0x0 && (iVar1 == 0)))) break;
        }
        if ((((FLEET *)lpfl != (FLEET *)0x0) || (lpfl._2_2_ != 0)) &&
           ((((FLEET *)lpfl)->iPlayer == iplr && (((uint)((FLEET *)lpfl)->wFlags >> 7 & 1) != 0))))
        {
          FSendPlrMsg2(iplr,idmDueExcessiveFleetManeuveringBattleAreaFleets,lpfl->id | 0x8000,x
                            ,y);
        }
      }
    }
    else {
      bVar3 = true;
      if ((fStarbaseDied == 0) ||
         (sVar4 = GetRaceStat((PLAYER *)rgplr + iplrStarbase,rsMajorAdv),
         sVar4 != raMacintosh)) {
        if (cplr == 2) {
          if (cShipsInvolved == 2) {
            pwThem = (uint *)0x0;
            pwUs = (uint *)0x0;
            pw = rgPlrLosses;
            for (i = 0; i < 0x10; i = i + 1) {
              for (j = 0; j < 0x10; j = j + 1) {
                if (*pw != 0) {
                  if (i == iplr) {
                    pwUs = pw;
                  }
                  else {
                    pwThem = pw;
                  }
                }
                pw = pw + 1;
              }
            }
            if (((pwUs == (uint *)0x0) && (fStarbaseDied != 0)) ||
               ((pwUs != (uint *)0x0 && ((*pwUs & 0x3fff) != 0)))) {
              if (((pwThem == (uint *)0x0) && (fStarbaseDamaged != 0)) ||
                 ((pwThem != (uint *)0x0 && ((*pwThem & 0x8000) != 0)))) {
                idm = 0x94;
              }
              else {
                idm = 0x92;
              }
              bVar3 = false;
            }
            else if (((pwThem == (uint *)0x0) && (fStarbaseDied != 0)) ||
                    ((pwThem != (uint *)0x0 && ((*pwThem & 0x3fff) != 0)))) {
              if (((pwUs == (uint *)0x0) && (fStarbaseDamaged != 0)) ||
                 ((pwUs != (uint *)0x0 && ((*pwUs & 0x8000) != 0)))) {
                idm = 0x93;
              }
              else {
                idm = 0x91;
              }
            }
            else {
              idm = 0x95;
            }
            if (pwUs == (uint *)0x0) {
              i = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwUs - (int)rgPlrLosses >> 1;
              i = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
            if (pwThem == (uint *)0x0) {
              j = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwThem - (int)rgPlrLosses >> 1;
              j = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
            FSendPlrMsg(iplr,idm,idBtl | 0x4000,x,y,i,j,0,0,0);
            if ((bVar3) &&
               (((((PLANET *)lppl == (PLANET *)0x0 && (lppl._2_2_ == 0)) ||
                 (((PLANET *)lppl)->iPlayer == -1)) || (iplr == ((PLANET *)lppl)->iPlayer)))) {
              ITechLearnATech(iplr,x,y,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                              (ushort *)0x0);
            }
          }
          else {
            if (cShdefsInvolved != 2) goto BATTLE_CommonCountingCode;
            pwThem = (uint *)0x0;
            pwUs = (uint *)0x0;
            pw = rgPlrLosses;
            for (i = 0; i < 0x10; i = i + 1) {
              for (j = 0; j < 0x10; j = j + 1) {
                if (*pw != 0) {
                  if (i == iplr) {
                    pwUs = pw;
                  }
                  else {
                    pwThem = pw;
                  }
                }
                pw = pw + 1;
              }
            }
            if (((pwUs == (uint *)0x0) && (fStarbaseDied != 0)) ||
               ((pwUs != (uint *)0x0 && ((*pwUs & 0x4000) == 0)))) {
              if (((pwThem == (uint *)0x0) && (fStarbaseDamaged != 0)) ||
                 ((pwThem != (uint *)0x0 && ((*pwThem & 0x8000) != 0)))) {
                idm = 0x99;
              }
              else {
                idm = 0x97;
              }
              bVar3 = false;
            }
            else if (((pwThem == (uint *)0x0) && (fStarbaseDied != 0)) ||
                    ((pwThem != (uint *)0x0 && ((*pwThem & 0x4000) == 0)))) {
              if (((pwUs == (uint *)0x0) && (fStarbaseDamaged != 0)) ||
                 ((pwUs != (uint *)0x0 && ((*pwUs & 0x8000) != 0)))) {
                idm = 0x98;
              }
              else {
                idm = 0x96;
              }
            }
            else {
              idm = 0x9a;
            }
            if (pwUs == (uint *)0x0) {
              cUs = 1;
            }
            else {
              cUs = *pwUs & 0x1fff;
            }
            if (pwThem == (uint *)0x0) {
              cThem = 1;
            }
            else {
              cThem = *pwThem & 0x1fff;
            }
            lpfl = lpflBtl;
            do {
              uVar7 = (undefined2)((ulong)lpfl >> 0x10);
              pFVar6 = (FLEET *)lpfl;
              if (((uint)pFVar6->wFlags >> 10 & 1) == 0) {
                if ((pFVar6->iPlayer == iplr) && (pwUs != (uint *)0x0)) {
                  cUs = cUs + *(int *)((int)pFVar6 +
                                      (((int)pwUs - (int)rgPlrLosses >> 1) + pFVar6->iPlayer * -0x10
                                      ) * 2 + 0xc);
                }
                else if (pwThem != (uint *)0x0) {
                  cThem = cThem + *(int *)((int)pFVar6 +
                                          (((int)pwThem - (int)rgPlrLosses >> 1) +
                                          pFVar6->iPlayer * -0x10) * 2 + 0xc);
                }
              }
                    /* WARNING: Load size is inaccurate */
              iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
              lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
            } while ((lpflBtl != lpfl) && ((pFVar6->lpflNext != (FLEET *)0x0 || (iVar1 != 0))));
            if (pwUs == (uint *)0x0) {
              i = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwUs - (int)rgPlrLosses >> 1;
              i = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
            if (pwThem == (uint *)0x0) {
              j = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwThem - (int)rgPlrLosses >> 1;
              j = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
            FSendPlrMsg(iplr,idm,idBtl | 0x4000,x,y,i,cUs,j,cThem,0);
            if ((bVar3) &&
               (((((PLANET *)lppl == (PLANET *)0x0 && (lppl._2_2_ == 0)) ||
                 (((PLANET *)lppl)->iPlayer == -1)) || (iplr == ((PLANET *)lppl)->iPlayer)))) {
              ITechLearnATech(iplr,x,y,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                              (ushort *)0x0);
            }
          }
        }
        else {
BATTLE_CommonCountingCode:
          cThem = 0;
          cUs = 0;
          pw = rgPlrLosses;
          for (i = 0; i < 0x10; i = i + 1) {
            for (j = 0; j < 0x10; j = j + 1) {
              if (*pw != 0) {
                if (i == iplr) {
                  pwUs = pw;
                  cUs = cUs + (*pw & 0x1fff);
                }
                else {
                  pwThem = pw;
                  cThem = cThem + (*pw & 0x1fff);
                  iThem = i;
                }
              }
              pw = pw + 1;
            }
          }
          iThem = iThem | 0x30;
          cUsDead = cUs;
          cThemDead = cThem;
          if (fStarbaseDied != 0) {
            if (iplrStarbase == iplr) {
              cUsDead = cUs + 1;
            }
            else if (iplrStarbase != -1) {
              cThemDead = cThem + 1;
            }
          }
          lpfl = lpflBtl;
          do {
            uVar7 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar6 = (FLEET *)lpfl;
            if (((uint)pFVar6->wFlags >> 10 & 1) == 0) {
              if (pFVar6->iPlayer == iplr) {
                for (i = 0; i < 0x10; i = i + 1) {
                  cUs = cUs + pFVar6->rgcsh[i];
                }
              }
              else {
                for (i = 0; i < 0x10; i = i + 1) {
                  cThem = cThem + pFVar6->rgcsh[i];
                }
              }
            }
                    /* WARNING: Load size is inaccurate */
            iVar1 = *(int *)((int)&pFVar6->lpflNext + 2);
            lpfl = (FLEET *)CONCAT22(iVar1,pFVar6->lpflNext);
          } while ((lpflBtl != lpfl) && ((pFVar6->lpflNext != (FLEET *)0x0 || (iVar1 != 0))));
          if (iplrStarbase == iplr) {
            cUs = cUs + 1;
          }
          else if (iplrStarbase != -1) {
            cThem = cThem + 1;
            iThem = iplrStarbase | 0x30;
          }
          if (cplr != 2) {
            if (cUsDead == 0) {
              if (cThem == cThemDead) {
                FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesForcesDestroyed,idBtl | 0x4000
                                 ,x,y,cplr,cUs,0,0,0);
              }
              else {
BATTLE_IndecisiveXWay:
                FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesLostForces2,idBtl | 0x4000,x,y
                                 ,cplr,cUsDead,cUs,cThemDead,cThem);
              }
            }
            else if (cThemDead == 0) {
              if (cUs != cUsDead) goto BATTLE_IndecisiveXWay;
              FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesEntireArmada,idBtl | 0x4000,x,y,
                               cplr,cUs,cThem,0,0);
            }
            else if (cThemDead == cThem) {
              FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesLostForces,idBtl | 0x4000,x,y,
                               cplr,cUsDead,cUs,0,0);
            }
            else if (cUsDead == cUs) {
              FSendPlrMsg(iplr,idmBattleTookPlaceInvolvingRacesEntireArmada2,idBtl | 0x4000,x,y
                               ,cplr,cUs,cThem,cThemDead,0);
            }
            else {
              FSendPlrMsg2(iplr,idmBattleTookPlacePressGotoButtonView,idBtl | 0x4000,x,y);
            }
            if (((((PLANET *)lppl == (PLANET *)0x0) && (lppl._2_2_ == 0)) ||
                (((PLANET *)lppl)->iPlayer == -1)) || (iplr == ((PLANET *)lppl)->iPlayer)) {
              ITechLearnATech(iplr,x,y,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                              (ushort *)0x0);
            }
            goto LAB_10f0_ad23;
          }
          if (cThem == 1) {
            if ((iThem & 0xfU) == iplrStarbase) {
              j = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwThem - (int)rgPlrLosses >> 1;
              j = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
          }
          if (cUs == 1) {
            if (iplr == iplrStarbase) {
              i = iplrStarbase << 5 | isb + 0x10U;
            }
            else {
              uVar5 = (int)pwUs - (int)rgPlrLosses >> 1;
              i = (uVar5 & 0xf0) << 1 | uVar5 & 0xf;
            }
          }
          if (cThemDead == cThem) {
            if (cThemDead == 1) {
              if (cUsDead == 0) {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedTaking,idBtl | 0x4000,
                                 x,y,iThem,cUs,j,0,0);
              }
              else {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedHowever,idBtl | 0x4000
                                 ,x,y,iThem,cUs,j,cUsDead,0);
              }
            }
            else if (cUsDead == 0) {
              if (cUs == 1) {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstDestroyedEnemyForces,idBtl | 0x4000,x
                                 ,y,iThem,i,cThemDead,0,0);
              }
              else {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedEnemy,idBtl | 0x4000,x
                                 ,y,iThem,cUs,0,0,0);
              }
            }
            else {
              FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedEnemy2,idBtl | 0x4000,x,
                               y,iThem,cUs,cUsDead,0,0);
            }
          }
          else if (cUsDead == cUs) {
            if (cUsDead == 1) {
              if (cThemDead == 0) {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstDestroyedEnemysForces,idBtl | 0x4000,
                                 x,y,iThem,i,cThem,0,0);
              }
              else {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstDestroyedEnemysForces2,idBtl | 0x4000
                                 ,x,y,iThem,i,cThem,cThemDead,0);
              }
            }
            else if (cThemDead == 0) {
              if (cThem == 1) {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyed,idBtl | 0x4000,x,y,
                                 iThem,cUsDead,j,0,0);
              }
              else {
                FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedEnemys,idBtl | 0x4000,
                                 x,y,iThem,cThem,0,0,0);
              }
            }
            else {
              FSendPlrMsg(iplr,idmBattleTookPlaceAgainstForcesDestroyedEnemys2,idBtl | 0x4000,x
                               ,y,iThem,cThem,cThemDead,0,0);
            }
          }
          else if (cUs == 1) {
            FSendPlrMsg(iplr,idmBattleTookPlaceAgainstNeitherNorEnemys,idBtl | 0x4000,x,y,iThem
                             ,i,cThem,cThemDead,0);
          }
          else if (cThem == 1) {
            FSendPlrMsg(iplr,idmBattleTookPlaceAgainstNeitherForcesNor2,idBtl | 0x4000,x,y,
                             iThem,cUs,j,cUsDead,0);
          }
          else {
            FSendPlrMsg(iplr,idmBattleTookPlaceAgainstNeitherForcesNor,idBtl | 0x4000,x,y,iThem
                             ,cUs,cThem,cUsDead,cThemDead);
          }
          if ((cUsDead != cUs) &&
             ((((PLANET *)lppl == (PLANET *)0x0 && (lppl._2_2_ == 0)) ||
              ((((PLANET *)lppl)->iPlayer == -1 || (iplr == ((PLANET *)lppl)->iPlayer)))))) {
            ITechLearnATech(iplr,x,y,idmWreckageDiscoveredBattleHasBoostedResearchResour,
                            (ushort *)0x0);
          }
        }
      }
      else {
        if (iplr == iplrStarbase) {
          if ((local_1a < 0) || ((local_1a < 1 && (lpopStarbase < 0x3e9)))) {
            idm = 0x8e;
          }
          else {
            idm = 0x8d;
          }
        }
        else {
          idm = 0x144;
        }
        j = iplrStarbase << 5 | isb + 0x10U;
        uVar9 = 0;
        uVar8 = __aFulshr(0,unaff_DI);
        FSendPlrMsg(iplr,idm,idBtl | 0x4000,x,y,j,lpopStarbase,(short)uVar8,(short)uVar9,
                         (short)((ulong)uVar9 >> 0x10));
      }
    }
    iplr = iplr + 1;
  } while( true );
}



// ======================================================================
// Function: FAttackPlayer
// Address: 10f0:ae06
// Segment: MEMORY_BATTLE
// ======================================================================


short FAttackPlayer(FLEET *lpfl,short iplr)

{
  int iVar1;
  uint uVar2;
  undefined2 uVar3;
  short iplrT;
  short iplrCur;
  
  uVar3 = (undefined2)((ulong)lpfl >> 0x10);
  iVar1 = ((FLEET *)lpfl)->iPlayer;
  uVar2 = (uint)((BTLPLAN **)rglpbtlplan)[iVar1 * 2][((FLEET *)lpfl)->iplan].wFlags >> 8 &
          0x1f;
  if (uVar2 == 0) {
    uVar2 = 0;
  }
  else if (uVar2 == 1) {
    uVar2 = (uint)(*(char *)(iVar1 * 0xc0 + 0x5a12 + iplr) == '\x02');
  }
  else if (uVar2 == 2) {
    uVar2 = (uint)(*(char *)(iVar1 * 0xc0 + 0x5a12 + iplr) != '\x01');
  }
  else if (uVar2 == 3) {
    uVar2 = 1;
  }
  else {
    uVar2 = (uint)(iplr == uVar2 - 4);
  }
  return uVar2;
}



// ======================================================================
// Function: DoBombing
// Address: 10f0:aefa
// Segment: MEMORY_BATTLE
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10f0b098) */
/* WARNING: Removing unreachable block (ram,0x10f0bd6f) */
/* WARNING: Removing unreachable block (ram,0x10f0b9fa) */
/* WARNING: Removing unreachable block (ram,0x10f0b289) */
/* WARNING: Removing unreachable block (ram,0x10f0b063) */
/* WARNING: Removing unreachable block (ram,0x10f0b46a) */
/* WARNING: Removing unreachable block (ram,0x10f0b1ff) */
/* WARNING: Removing unreachable block (ram,0x10f0b5d9) */
/* WARNING: Removing unreachable block (ram,0x10f0ba57) */
/* WARNING: Removing unreachable block (ram,0x10f0b76f) */
/* WARNING: Removing unreachable block (ram,0x10f0b377) */
/* WARNING: Removing unreachable block (ram,0x10f0b0cd) */
/* WARNING: Removing unreachable block (ram,0x10f0b583) */
/* WARNING: Removing unreachable block (ram,0x10f0b102) */
/* WARNING: Removing unreachable block (ram,0x10f0b498) */
/* WARNING: Removing unreachable block (ram,0x10f0b2af) */
/* WARNING: Removing unreachable block (ram,0x10f0b39d) */
/* WARNING: Removing unreachable block (ram,0x10f0b481) */
/* WARNING: Removing unreachable block (ram,0x10f0b500) */
/* WARNING: Removing unreachable block (ram,0x10f0b5a6) */
/* WARNING: Removing unreachable block (ram,0x10f0b5f0) */
/* WARNING: Removing unreachable block (ram,0x10f0b616) */
/* WARNING: Removing unreachable block (ram,0x10f0b642) */
/* WARNING: Type propagation algorithm not settling */
/* WARNING: Removing unreachable block (ram,0x10f0b669) */
/* WARNING: Removing unreachable block (ram,0x10f0b691) */
/* WARNING: Removing unreachable block (ram,0x10f0b6ff) */

void DoBombing(void)

{
  int *piVar1;
  uint *puVar2;
  undefined2 *puVar3;
  FLEET *pFVar4;
  int iVar5;
  qword qVar6;
  short sVar7;
  uint uVar8;
  uint uVar9;
  uint uVar10;
  MessageId MVar11;
  int iVar12;
  PLANET *pPVar13;
  char *pcVar14;
  char *pcVar15;
  undefined2 unaff_SI;
  ushort unaff_DI;
  undefined2 uVar16;
  bool bVar17;
  long lVar18;
  ulong uVar19;
  ulong uVar20;
  long lVar21;
  undefined2 uVar22;
  short sVar23;
  undefined2 uVar24;
  short sVar25;
  uint in_stack_0000ffa4;
  int in_stack_0000ffa6;
  undefined8 pctSuccessHalf;
  long dmgPeopleSmart;
  float pctSuccess;
  float pctSmart;
  long dmgBombPeople;
  undefined4 cPPE;
  FLEET *lpfl;
  short ifl;
  PLANET *lppl;
  long pctTerra;
  undefined4 cKillFact;
  undefined4 cKillDefenses;
  short idmSrc;
  long dmgBombFloor;
  undefined4 cKillMine;
  undefined4 cKillPeopleS;
  long dmgBombBldg;
  undefined4 cKillPeople;
  short fMulti;
  undefined4 modKill;
  short idmDst;
  
  ifl = 0;
  do {
    if (cFleet <= ifl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pFVar4 = ((FLEET **)rglpfl)[ifl];
    iVar5 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar5,pFVar4);
    if ((pFVar4 == (FLEET *)0x0) && (iVar5 == 0)) {
      return;
    }
    if (((((uint)pFVar4->wFlags >> 10 & 1) == 0) && (pFVar4->idPlanet != -1)) &&
       (((uint)pFVar4->wFlags >> 0xc & 1) == 0)) {
      pPVar13 = (PLANET *)lpPlanets + pFVar4->idPlanet;
      lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,pPVar13);
      if ((pPVar13->iPlayer != pFVar4->iPlayer) && (pPVar13->iPlayer != -1)) {
        sVar7 = FAttackPlayer((FLEET *)CONCAT22(iVar5,pFVar4),pPVar13->iPlayer);
        if ((sVar7 != 0) && (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) == 0)) {
          sVar7 = FCalcFleetBombDamage
                            (lpfl,&dmgBombPeople,&dmgBombFloor,&dmgPeopleSmart,&dmgBombBldg,
                             &pctTerra,&fMulti);
          if (sVar7 != 0) {
            CalcPctSurvive(lppl,&pctSuccess,&pctSmart);
            bVar17 = (undefined1 *)0xfff7 < &stack0xff98;
            __aFfcompp();
            if (bVar17) {
              lVar21 = dmgBombFloor;
              if (0 < dmgBombPeople) {
                lVar21 = __ftol((double)CONCAT26(in_stack_0000ffa6,
                                                         CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                dmgBombPeople = lVar21;
                lVar21 = dmgBombFloor;
              }
              lVar18 = dmgPeopleSmart;
              if (0 < lVar21) {
                dmgBombFloor = lVar21;
                lVar21 = __ftol((double)CONCAT26(in_stack_0000ffa6,
                                                         CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                lVar18 = dmgPeopleSmart;
              }
              if (0 < lVar18) {
                dmgBombFloor = lVar21;
                dmgPeopleSmart = lVar18;
                lVar18 = __ftol((double)CONCAT26(in_stack_0000ffa6,
                                                         CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                lVar21 = dmgBombFloor;
              }
              dmgPeopleSmart = lVar18;
              dmgBombFloor = lVar21;
              if (0 < dmgBombBldg) {
                lVar21 = __ftol((double)CONCAT26(in_stack_0000ffa6,
                                                         CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                dmgBombBldg = lVar21;
              }
            }
            uVar10 = *(uint *)&((PLANET *)lppl)->dwFlags & 0xfff;
            uVar19 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
            in_stack_0000ffa4 = (uint)uVar19 & 0xfff;
            in_stack_0000ffa6 = 0;
            uVar19 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
            uVar8 = (uint)uVar19 & 0xfff;
            uVar9 = uVar8 + in_stack_0000ffa4;
            cPPE._0_2_ = uVar9 + uVar10;
            cPPE._2_2_ = in_stack_0000ffa6 + (uint)CARRY2(uVar8,in_stack_0000ffa4) +
                         (uint)CARRY2(uVar9,uVar10);
            cKillDefenses._0_2_ = 0;
            cKillDefenses._2_2_ = 0;
            cKillDefenses = 0;
            cKillPeople._0_2_ = 0;
            cKillPeople._2_2_ = 0;
            cKillMine._0_2_ = 0;
            cKillMine._2_2_ = 0;
            uVar19 = 0;
            cKillFact._0_2_ = 0;
            cKillFact._2_2_ = 0;
            cKillFact = 0;
            if (((0 < dmgBombBldg) &&
                (cKillFact = 0, cKillDefenses = 0, uVar19 = 0, -1 < cPPE._2_2_)) &&
               ((0 < cPPE._2_2_ || (cKillFact = 0, cKillDefenses = 0, uVar19 = 0, (int)cPPE != 0))))
            {
              uVar19 = dmgBombBldg;
              uVar20 = __aFulshr(dmgBombBldg,unaff_DI);
              cKillFact = __aFulmul((ulong)((uint)uVar20 & 0xfff),uVar19);
              lVar21 = __aFlrem(cKillFact,CONCAT22(cPPE._2_2_,(int)cPPE));
              modKill = lVar21;
              uVar19 = __aFldiv(cKillFact,CONCAT22(cPPE._2_2_,(int)cPPE));
              if (0 < modKill) {
                cKillFact = uVar19;
                sVar7 = Random((int)cPPE);
                uVar19 = cKillFact + (sVar7 < modKill);
              }
              cKillFact = uVar19;
              uVar19 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              if ((-1 < (long)cKillFact) &&
                 ((0xffff < (long)cKillFact || (((uint)uVar19 & 0xfff) < (uint)cKillFact)))) {
                uVar19 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
                cKillFact = (ulong)((uint)uVar19 & 0xfff);
              }
              cKillDefenses =
                   __aFulmul((ulong)(*(uint *)&((PLANET *)lppl)->dwFlags & 0xfff),
                                     dmgBombBldg);
              lVar21 = __aFlrem(cKillDefenses,CONCAT22(cPPE._2_2_,(int)cPPE));
              modKill = lVar21;
              uVar19 = __aFldiv(cKillDefenses,CONCAT22(cPPE._2_2_,(int)cPPE));
              if (0 < modKill) {
                cKillDefenses = uVar19;
                sVar7 = Random((int)cPPE);
                uVar19 = cKillDefenses + (sVar7 < modKill);
              }
              cKillDefenses._0_2_ = (uint)uVar19;
              uVar16 = (undefined2)((ulong)lppl >> 0x10);
              if ((-1 < (long)uVar19) &&
                 ((0xffff < (long)uVar19 ||
                  ((*(uint *)&((PLANET *)lppl)->dwFlags & 0xfff) < (uint)cKillDefenses)))) {
                uVar19 = (ulong)(*(uint *)&((PLANET *)lppl)->dwFlags & 0xfff);
              }
              cKillMine = dmgBombBldg - (cKillFact + uVar19);
              cKillDefenses = uVar19;
              uVar20 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              uVar19 = cKillMine;
              if ((-1 < (long)cKillMine) &&
                 ((0xffff < (long)cKillMine || (((uint)uVar20 & 0xfff) < (uint)cKillMine)))) {
                uVar19 = __aFulshr(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
                uVar19 = (ulong)((uint)uVar19 & 0xfff);
              }
            }
            if (((0 < dmgBombPeople) || (0 < dmgBombFloor)) ||
               (lVar21 = CONCAT22(cKillPeople._2_2_,(uint)cKillPeople), 0 < dmgPeopleSmart)) {
              uVar16 = (undefined2)((ulong)lppl >> 0x10);
              pPVar13 = (PLANET *)lppl;
              iVar5 = *(int *)((int)pPVar13->rgwtMin + 0xe);
              lVar21 = CONCAT22(cKillPeople._2_2_,(uint)cKillPeople);
              if ((-1 < iVar5) &&
                 ((0 < iVar5 ||
                  (lVar21 = CONCAT22(cKillPeople._2_2_,(uint)cKillPeople),
                  (int)pPVar13->rgwtMin[3] != 0)))) {
                uVar24 = 0;
                uVar22 = 1000;
                cKillMine = uVar19;
                uVar19 = __aFulmul(CONCAT22(*(undefined2 *)((int)pPVar13->rgwtMin + 0xe),
                                                    (int)pPVar13->rgwtMin[3]),dmgPeopleSmart);
                lVar21 = __aFldiv(uVar19,CONCAT22(uVar24,uVar22));
                uVar16 = (undefined2)((ulong)lppl >> 0x10);
                pPVar13 = (PLANET *)lppl;
                if (CONCAT22(*(undefined2 *)((int)pPVar13->rgwtMin + 0xe),(int)pPVar13->rgwtMin[3])
                    <= lVar21) {
                  iVar5 = (int)pPVar13->rgwtMin[3];
                  lVar21 = CONCAT22(*(int *)((int)pPVar13->rgwtMin + 0xe) + -1 + (uint)(iVar5 != 0),
                                    iVar5 + -1);
                }
                cKillPeopleS._2_2_ = (int)((ulong)lVar21 >> 0x10);
                cKillPeopleS._0_2_ = (uint)lVar21;
                bVar17 = *(uint *)(pPVar13->rgwtMin + 3) < (uint)cKillPeopleS;
                iVar12 = *(uint *)(pPVar13->rgwtMin + 3) - (uint)cKillPeopleS;
                iVar5 = *(int *)((int)pPVar13->rgwtMin + 0xe) - cKillPeopleS._2_2_;
                cKillPeopleS = lVar21;
                cKillPeople = __aFulmul(CONCAT22(iVar5 - (uint)bVar17,iVar12),dmgBombPeople)
                ;
                lVar21 = __aFlrem(cKillPeople,1000);
                modKill = lVar21;
                lVar21 = __aFldiv(cKillPeople,1000);
                uVar19 = cKillMine;
                if (0 < modKill) {
                  cKillPeople = lVar21;
                  sVar7 = Random(1000);
                  lVar21 = cKillPeople + (sVar7 <= modKill);
                  uVar19 = cKillMine;
                }
                lVar21 = lVar21 + cKillPeopleS;
                if ((0 < dmgBombPeople) && (lVar21 < 1)) {
                  lVar21 = 1;
                }
                if (lVar21 < dmgBombFloor) {
                  lVar21 = dmgBombFloor;
                }
                uVar16 = (undefined2)((ulong)lppl >> 0x10);
                pPVar13 = (PLANET *)lppl;
                if (CONCAT22(*(undefined2 *)((int)pPVar13->rgwtMin + 0xe),
                             *(uint *)(pPVar13->rgwtMin + 3)) < lVar21) {
                  lVar21 = CONCAT22(*(undefined2 *)((int)pPVar13->rgwtMin + 0xe),
                                    (int)pPVar13->rgwtMin[3]);
                }
              }
            }
            cKillPeople._2_2_ = (int)((ulong)lVar21 >> 0x10);
            cKillPeople._0_2_ = (uint)lVar21;
            if (0 < lVar21) {
              uVar16 = (undefined2)((ulong)lppl >> 0x10);
              puVar2 = (uint *)(((PLANET *)lppl)->rgwtMin + 3);
              uVar10 = *puVar2;
              *puVar2 = *puVar2 - (uint)cKillPeople;
              piVar1 = (int *)((int)((PLANET *)lppl)->rgwtMin + 0xe);
              *piVar1 = (*piVar1 - cKillPeople._2_2_) - (uint)(uVar10 < (uint)cKillPeople);
            }
            if (0 < (long)cKillFact) {
              cKillPeople = lVar21;
              cKillMine = uVar19;
              lVar21 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              uVar16 = (undefined2)((ulong)lppl >> 0x10);
              pPVar13 = (PLANET *)lppl;
              pctSuccessHalf._6_2_ =
                   (*(int *)((int)&pPVar13->dwFlags + 2) - (int)((ulong)lVar21 >> 0x10)) -
                   (uint)(*(uint *)&pPVar13->dwFlags < (uint)lVar21) & 0xfff0;
              *(int *)&pPVar13->dwFlags = (int)pPVar13->dwFlags;
              puVar2 = (uint *)((int)&pPVar13->dwFlags + 2);
              *puVar2 = *puVar2 & 0xf;
              *(int *)&pPVar13->dwFlags = (int)pPVar13->dwFlags;
              puVar2 = (uint *)((int)&pPVar13->dwFlags + 2);
              *puVar2 = *puVar2 | pctSuccessHalf._6_2_;
              lVar21 = cKillPeople;
              uVar19 = cKillMine;
            }
            if (0 < (long)uVar19) {
              cKillPeople = lVar21;
              cKillMine = uVar19;
              lVar21 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              uVar16 = (undefined2)((ulong)lppl >> 0x10);
              pPVar13 = (PLANET *)lppl;
              qVar6 = (qword)CONCAT22((*(int *)((int)&pPVar13->dwFlags + 2) -
                                      (int)((ulong)lVar21 >> 0x10)) -
                                      (uint)(*(uint *)&pPVar13->dwFlags < (uint)lVar21),
                                      *(uint *)&pPVar13->dwFlags - (uint)lVar21) & 0xfff00;
              *(uint *)&pPVar13->dwFlags = *(uint *)&pPVar13->dwFlags & 0xff;
              puVar2 = (uint *)((int)&pPVar13->dwFlags + 2);
              *puVar2 = *puVar2 & 0xfff0;
              pctSuccessHalf._4_2_ = (uint)qVar6;
              pctSuccessHalf._6_2_ = (uint)(qVar6 >> 0x10);
              *(uint *)&pPVar13->dwFlags = *(uint *)&pPVar13->dwFlags | pctSuccessHalf._4_2_;
              puVar2 = (uint *)((int)&pPVar13->dwFlags + 2);
              *puVar2 = *puVar2 | pctSuccessHalf._6_2_;
              lVar21 = cKillPeople;
              uVar19 = cKillMine;
            }
            if (0 < (long)cKillDefenses) {
              cKillPeople = lVar21;
              cKillMine = uVar19;
              lVar21 = __aFlshl(CONCAT22(unaff_SI,unaff_DI),in_stack_0000ffa4);
              uVar16 = (undefined2)((ulong)lppl >> 0x10);
              pPVar13 = (PLANET *)lppl;
              pctSuccessHalf._4_2_ = (int)pPVar13->dwFlags - (int)lVar21 & 0xfff;
              *(uint *)&pPVar13->dwFlags = *(uint *)&pPVar13->dwFlags & 0xf000;
              puVar3 = (undefined2 *)((int)&pPVar13->dwFlags + 2);
              *puVar3 = *puVar3;
              *(uint *)&pPVar13->dwFlags = *(uint *)&pPVar13->dwFlags | pctSuccessHalf._4_2_;
              puVar3 = (undefined2 *)((int)&pPVar13->dwFlags + 2);
              *puVar3 = *puVar3;
              lVar21 = cKillPeople;
              uVar19 = cKillMine;
            }
            if ((-1 < pctTerra._2_2_) && ((0 < pctTerra._2_2_ || ((uint)pctTerra != 0)))) {
              in_stack_0000ffa6 = 2;
              cKillPeople = lVar21;
              cKillMine = uVar19;
              lVar21 = __ftol((double)CONCAT26(2,CONCAT24(in_stack_0000ffa4,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
              bVar17 = (uint)pctTerra < (uint)lVar21;
              pctTerra._0_2_ = (uint)pctTerra - (uint)lVar21;
              pctTerra._2_2_ = (pctTerra._2_2_ - (int)((ulong)lVar21 >> 0x10)) - (uint)bVar17;
              if ((-1 < pctTerra._2_2_) && ((0 < pctTerra._2_2_ || (500 < (uint)pctTerra)))) {
                pctTerra._0_2_ = 500;
                pctTerra._2_2_ = 0;
              }
              pctSuccessHalf = 0;
              while( true ) {
                iVar5 = pctSuccessHalf._6_2_;
                if (2 < pctSuccessHalf._2_2_) break;
                pcVar14 = ((PLANET *)lppl)->rgEnvVarOrig + pctSuccessHalf._2_2_;
                pcVar15 = ((PLANET *)lppl)->rgEnvVar + pctSuccessHalf._2_2_;
                pctSuccessHalf = CONCAT62(pctSuccessHalf._2_6_,(int)*pcVar14);
                uVar10 = (int)*pcVar15 - (int)*pcVar14;
                pctSuccessHalf._0_6_ = CONCAT24(uVar10,(undefined4)pctSuccessHalf);
                pctSuccessHalf = CONCAT26(iVar5,(undefined6)pctSuccessHalf);
                if ((int)uVar10 < 1) {
                  if ((int)uVar10 < 0) {
                    iVar12 = (int)-uVar10 >> 0xf;
                    if ((pctTerra._2_2_ <= iVar12) &&
                       ((pctTerra._2_2_ < iVar12 || ((uint)pctTerra <= -uVar10)))) {
                      pctSuccessHalf._0_6_ = CONCAT24(-(uint)pctTerra,(undefined4)pctSuccessHalf);
                      pctSuccessHalf = CONCAT26(iVar5,(undefined6)pctSuccessHalf);
                    }
                    ((PLANET *)lppl)->rgEnvVar[pctSuccessHalf._2_2_] =
                         ((PLANET *)lppl)->rgEnvVar[pctSuccessHalf._2_2_] -
                         (char)((qword)pctSuccessHalf >> 0x20);
                    iVar5 = pctSuccessHalf._6_2_ - pctSuccessHalf._4_2_;
                    pctSuccessHalf = CONCAT26(iVar5,(undefined6)pctSuccessHalf);
                  }
                }
                else {
                  if ((pctTerra._2_2_ <= (int)uVar10 >> 0xf) &&
                     ((pctTerra._2_2_ < (int)uVar10 >> 0xf || ((uint)pctTerra <= uVar10)))) {
                    pctSuccessHalf._0_6_ = CONCAT24((uint)pctTerra,(undefined4)pctSuccessHalf);
                    pctSuccessHalf = CONCAT26(iVar5,(undefined6)pctSuccessHalf);
                  }
                  ((PLANET *)lppl)->rgEnvVar[pctSuccessHalf._2_2_] =
                       ((PLANET *)lppl)->rgEnvVar[pctSuccessHalf._2_2_] -
                       (char)((qword)pctSuccessHalf >> 0x20);
                  iVar5 = pctSuccessHalf._6_2_ + pctSuccessHalf._4_2_;
                  pctSuccessHalf = CONCAT26(iVar5,(undefined6)pctSuccessHalf);
                }
                pctSuccessHalf =
                     (qword)CONCAT42(pctSuccessHalf._4_4_,pctSuccessHalf._2_2_ + 1) << 0x10;
              }
              lVar21 = cKillPeople;
              uVar19 = cKillMine;
              if (0 < (int)pctSuccessHalf._6_2_) {
                if (fMulti == 0) {
                  MVar11 = idmHasRetroBombedUndoingTerraforming;
                }
                else {
                  MVar11 = idmFleetsHaveRetroBombedUndoingTerraforming;
                }
                FSendPlrMsg(((FLEET *)lpfl)->iPlayer,MVar11,lpfl->id | 0x8000,lpfl->id,lppl->id
                                 ,pctSuccessHalf._6_2_,0,0,0,0);
                if (fMulti == 0) {
                  MVar11 = idmHasRetroBombedUndoingTerraforming;
                }
                else {
                  MVar11 = idmFleetsHaveRetroBombedUndoingTerraforming2;
                }
                FSendPlrMsg(((PLANET *)lppl)->iPlayer,MVar11,lppl->id,lpfl->id,lppl->id,
                                 pctSuccessHalf._6_2_,0,0,0,0);
                lVar21 = cKillPeople;
                uVar19 = cKillMine;
              }
            }
            cKillPeople._2_2_ = (int)((ulong)lVar21 >> 0x10);
            cKillPeople._0_2_ = (uint)lVar21;
            cPPE = cKillDefenses + cKillFact + uVar19;
            pPVar13 = (PLANET *)lppl;
            uVar16 = (undefined2)((ulong)lppl >> 0x10);
            cKillMine = uVar19;
            if (cPPE < 1) {
              if (0 < lVar21) {
                iVar5 = *(int *)((int)pPVar13->rgwtMin + 0xe);
                if ((iVar5 < 0) || ((iVar5 < 1 && ((int)pPVar13->rgwtMin[3] == 0)))) {
                  if (fMulti == 0) {
                    idmSrc = 0x8f;
                    idmDst = 0x90;
                  }
                  else {
                    idmSrc = 0x17c;
                    idmDst = 0x17d;
                  }
                }
                else if (fMulti == 0) {
                  idmSrc = 0x60;
                  idmDst = 0x6a;
                }
                else {
                  idmSrc = 0x166;
                  idmDst = 0x170;
                }
                FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,lppl->id
                                 ,(uint)cKillPeople,0,0,0,0);
                cKillPeople = lVar21;
                FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                 (uint)cKillPeople,0,0,0,0);
                lVar21 = cKillPeople;
                uVar19 = cKillMine;
              }
            }
            else {
              iVar5 = *(int *)((int)pPVar13->rgwtMin + 0xe);
              if ((iVar5 < 0) || ((iVar5 < 1 && ((int)pPVar13->rgwtMin[3] == 0)))) {
                if (fMulti == 0) {
                  idmSrc = 0x8f;
                  idmDst = 0x90;
                }
                else {
                  idmSrc = 0x17c;
                  idmDst = 0x17d;
                }
BATTLE_GenericBombMsg:
                cKillPeople = lVar21;
                cKillMine = uVar19;
                FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,lppl->id
                                 ,(short)lVar21,(int)cPPE,0,0,0);
                FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                 (uint)cKillPeople,(int)cPPE,0,0,0);
                lVar21 = cKillPeople;
                uVar19 = cKillMine;
              }
              else {
                if (fMulti == 0) {
                  idmSrc = 99;
                  idmDst = 0x6d;
                }
                else {
                  idmSrc = 0x169;
                  idmDst = 0x173;
                }
                if (1 < cPPE) {
                  idmSrc = idmSrc + 1;
                  idmDst = idmDst + 1;
                }
                bVar17 = cKillPeople._2_2_ == 0;
                cKillPeople = lVar21;
                if ((lVar21 < 0) || ((lVar21 < 0x10000 && (bVar17 = false, (uint)cKillPeople == 0)))
                   ) {
                  idmSrc = idmSrc + -2;
                  idmDst = idmDst + -2;
                  bVar17 = idmDst == 0;
                  __aFfcompp();
                  if (bVar17) {
                    FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,
                                     lppl->id,(int)cPPE,0,0,0,0);
                    FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                     (int)cPPE,0,0,0,0);
                    lVar21 = cKillPeople;
                    uVar19 = cKillMine;
                  }
                  else {
                    idmSrc = idmSrc + 5;
                    idmDst = idmDst + 5;
                    sVar25 = 0;
                    sVar23 = 0;
                    sVar7 = 0;
                    lVar21 = __ftol((double)((qword)unaff_DI << 0x30));
                    FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,
                                     lppl->id,(int)cPPE,(short)lVar21,sVar7,sVar23,sVar25);
                    sVar25 = 0;
                    sVar23 = 0;
                    sVar7 = 0;
                    lVar21 = __ftol((double)((qword)unaff_DI << 0x30));
                    FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                     (int)cPPE,(short)lVar21,sVar7,sVar23,sVar25);
                    lVar21 = cKillPeople;
                    uVar19 = cKillMine;
                  }
                }
                else {
                  __aFfcompp();
                  lVar21 = cKillPeople;
                  uVar19 = cKillMine;
                  if (bVar17) goto BATTLE_GenericBombMsg;
                  idmSrc = idmSrc + 5;
                  idmDst = idmDst + 5;
                  sVar23 = 0;
                  sVar7 = 0;
                  lVar21 = __ftol((double)((qword)CONCAT22(unaff_SI,unaff_DI) << 0x20));
                  FSendPlrMsg(((FLEET *)lpfl)->iPlayer,idmSrc,lpfl->id | 0x8000,lpfl->id,
                                   lppl->id,(uint)cKillPeople,(int)cPPE,(short)lVar21,sVar7,sVar23);
                  sVar23 = 0;
                  sVar7 = 0;
                  lVar21 = __ftol((double)((qword)CONCAT22(unaff_SI,unaff_DI) << 0x20));
                  FSendPlrMsg(((PLANET *)lppl)->iPlayer,idmDst,lppl->id,lpfl->id,lppl->id,
                                   (uint)cKillPeople,(int)cPPE,(short)lVar21,sVar7,sVar23);
                  lVar21 = cKillPeople;
                  uVar19 = cKillMine;
                }
              }
            }
            uVar16 = (undefined2)((ulong)lppl >> 0x10);
            cKillPeople = lVar21;
            cKillMine = uVar19;
            if (((int)((PLANET *)lppl)->rgwtMin[3] == 0) &&
               (*(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe) == 0)) {
              UninhabitPlanet(lppl);
            }
          }
        }
      }
    }
    ifl = ifl + 1;
  } while( true );
}



