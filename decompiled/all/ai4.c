// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
//

// ======================================================================
// Function: DoCyberAiTurn
// Address: 10a8:002a
// Segment: MEMORY_AI4
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10a81610) */
/* WARNING: Removing unreachable block (ram,0x10a81952) */
/* WARNING: Removing unreachable block (ram,0x10a81697) */

void DoCyberAiTurn(PROD *rgprod)

{
    byte          *pbVar1;
    undefined2    *puVar2;
    undefined2    *puVar3;
    int            iVar4;
    bool           bVar5;
    PLORD         *pPVar6;
    POINT          pt;
    POINT          pt1;
    POINT          pt2;
    short          sVar7;
    int            iVar8;
    int            iVar9;
    FLEET         *pFVar10;
    PLANET        *pPVar11;
    undefined2    *puVar12;
    undefined2    *puVar13;
    undefined2     uVar14;
    uint           uVar15;
    undefined2     unaff_SS;
    ulong          uVar16;
    PLANET        *pPVar17;
    long           lVar18;
    long          *rgResAvail_00;
    long          *rgResCost_00;
    undefined1     local_124[134];
    byte           local_9e;
    undefined1     uStack_9d;
    undefined2     local_9c;
    uint           local_9a;
    undefined4     local_94;
    uint           local_90;
    short          fWrite;
    short          idPlanDst;
    CYBERINFOTEMP *lpciPlanTemp;
    short          iAttackStr;
    short          dOffsetPlanTemp;
    short          iLatestBattle;
    long           lNewPop;
    CYBERINFO     *lpciPlan;
    PLANET        *lpplMac;
    short          pctValue;
    short          ishdefLatestSB;
    ushort         cRecyclePeriod;
    short          iLatestDestroyer;
    short          iBuilt;
    short         *lpiHistSize;
    short          ipl;
    short          pctValueIdeal;
    short          iLatestCargo;
    FLEET         *lpflAttack;
    short          j;
    short          iroCur;
    long           cExistCargo;
    short          iLatestSBDefender;
    short          cFlArmadas;
    short          cFlDestroyers;
    FLEET         *lpfl;
    short          i;
    short          ifl;
    short          cMineLayers;
    PLANET        *lppl;
    byte           rgRecycleShdef[16];
    short          cFlMineLayers;
    long           cExistColony;
    FLEET         *lpflEnemy;
    long           rgResAvail[4];
    short          cSBDefenderFleets;
    long           rgResCost[4];

    uVar15 = 0x10a8;
    dOffsetPlanTemp = game.cPlanMax * 2 + 2;
    cSBDefenderFleets = 0;
    cFlMineLayers = 0;
    cMineLayers = 0;
    cFlArmadas = 0;
    cFlDestroyers = 0;
    lpiHistSize = (short *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData);
    if (*lpiHistSize == 2) {
        uVar15 = 0x1118;
        __fmemset((byte *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData), 0, 0x2000);
        *lpiHistSize = game.cPlanMax * 2 + 2;
    }
    fMarkedPlanets = 0;
    iroCur = IroEnsureAi((byte *)((ulong)uVar15 << 0x10), 0x2a, &ishdefLatestSB, 0x11);
    EnsureCyberAiShdefs(iroCur);
    MergeAllShdefs(1);
    MergeAllShdefs(0x30);
    MergeAllShdefs(-0x4000);
    MergeAllShdefs(0x3c0);
    MergeAllShdefs(0x3c00);
    iAttackStr = 1;
    if (0x32 < game.turn) {
        iAttackStr = (game.turn - 0x32) / 10 + 1;
    }
    if (100 < game.turn) {
        local_90 = (game.turn - 100) / 10;
        iAttackStr = iAttackStr + local_90 * (game.turn / 100);
    }
    j = 3;
    if (0x82 < game.turn) {
        j = (game.turn - 0x78) / 0x14 + 3;
    }
    if (0x32 < (uint)j) {
        j = 0x32;
    }
    vrgAiCyberArmadaPotency[0] = (byte)j;
    vrgAiCyberArmadaPotency[1] = (byte)((ulong)(j & 0xff) / 2);
    j = 6;
    if (0x73 < game.turn) {
        j = (game.turn - 100) / 0x16 + 6;
    }
    if (0xc < (uint)j) {
        j = 0xc;
    }
    vrgAiCyberArmadaPotency[2] = (byte)j;
    if ((int)((uint)j / 2 - 1) < 4) {
        vrgAiCyberArmadaPotency[3] = (char)((uint)j / 2) - 1;
    } else {
        vrgAiCyberArmadaPotency[3] = 3;
    }
    _memset(rgRecycleShdef, 0, 0x10);
    if (game.turn < 0x78) {
        cRecyclePeriod = 0x32;
    } else if (game.turn < 200) {
        cRecyclePeriod = 0x46;
    } else if (game.turn < 400) {
        cRecyclePeriod = 100;
    } else {
        cRecyclePeriod = 300;
    }
    CheckAiShdefStatus(4, 5, cRecyclePeriod, &iLatestDestroyer, rgRecycleShdef);
    rgRecycleShdef[iLatestDestroyer] = 0;
    CheckAiShdefStatus(0xe, 0xf, cRecyclePeriod, &iLatestSBDefender, rgRecycleShdef);
    rgRecycleShdef[iLatestDestroyer] = 0;
    cExistCargo._0_2_ = CheckAiShdefStatus(2, 3, cRecyclePeriod, &iLatestCargo, rgRecycleShdef);
    cExistCargo._2_2_ = (int)(uint)cExistCargo >> 0xf;
    rgRecycleShdef[iLatestCargo] = 0;
    iLatestBattle = -1;
    for (i = 0; iVar8 = rgshdef[1].cExist._2_2_, uVar15 = (uint)rgshdef[1].cExist, i < 2; i = i + 1) {
        if (((*(uint *)((int)&rgshdef[0].wFlags + (i * 4 + 6) * 0x93) >> 9 & 1) == 0) &&
            (cRecyclePeriod < game.turn - *(int *)((int)&rgshdef[0].turn + (i * 4 + 6) * 0x93))) {
            local_90 = 1;
            for (j = i * 4 + 9; i * 4 + 6 <= j; j = j + -1) {
                if ((*(uint *)((int)&rgshdef[0].wFlags + j * 0x93) >> 9 & 1) == 0) {
                    if (((*(int *)((int)&rgshdef[0].cExist + j * 0x93) == 0) && (*(int *)((int)&rgshdef[0].cExist + 2 + j * 0x93) == 0)) &&
                        ((local_90 != 0 || (j != i * 4 + 6)))) {
                        puVar12 = (undefined2 *)(j * 0x93 + rgshdef);
                        puVar13 = local_124;
                        for (iVar8 = 0x49; iVar8 != 0; iVar8 = iVar8 + -1) {
                            puVar3 = puVar13;
                            puVar13 = puVar13 + 1;
                            puVar2 = puVar12;
                            puVar12 = puVar12 + 1;
                            *puVar3 = *puVar2;
                        }
                        *(undefined1 *)puVar13 = *(undefined1 *)puVar12;
                        local_124._123_2_ = local_124._123_2_ & 0xfdff | 0x200;
                        FChangeAiShdef(local_124, j);
                    } else {
                        rgRecycleShdef[j] = 1;
                        local_90 = 0;
                    }
                }
            }
        }
        if (((*(uint *)((int)&rgshdef[0].wFlags + (i * 4 + 6) * 0x93) >> 9 & 1) == 0) &&
            ((iLatestBattle == -1 || (local_90 = *(uint *)((int)&rgshdef[0].turn + (i * 4 + 6) * 0x93),
                                      *(uint *)((int)&rgshdef[0].turn + (iLatestBattle * 4 + 6) * 0x93) < local_90)))) {
            iLatestBattle = i;
        }
    }
    if (0x50 < game.turn) {
        SplitOutShdefs(rgRecycleShdef);
        _memset(&local_9e, 0, 0x10);
        local_9e = 2;
        SplitOutShdefs(&local_9e);
        _memset(&local_9e, 0, 0x10);
        uStack_9d = 2;
        SplitOutShdefs(&local_9e);
        _memset(&local_9e, 0, 0x10);
        local_9c = 0x202;
        SplitOutShdefs(&local_9e);
    }
    lpciPlanTemp = (CYBERINFOTEMP *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData + dOffsetPlanTemp);
    __fmemset((CYBERINFOTEMP *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData + dOffsetPlanTemp), 0, game.cPlanMax << 1);
    local_94 = (PLANET *)CONCAT22((PLANET *)lpPlanets, (PLANET *)local_94);
    local_90 = lpPlanets._2_2_;
    lpplMac._0_2_ = (PLANET *)lpPlanets + cPlanet;
    lpplMac._2_2_ = lpPlanets._2_2_;
    lppl = (PLANET *)CONCAT22(lpPlanets._2_2_, (PLANET *)lpPlanets);
    while ((PLANET *)lppl < (PLANET *)lpplMac) {
        lpciPlan = (CYBERINFO *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData + lppl->id * 2 + 2);
        lpciPlanTemp = (CYBERINFOTEMP *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData + lppl->id * 2 + dOffsetPlanTemp);
        if ((lpciPlan->wInfo >> 5 & 3) != 0) {
            local_90 = lpciPlan->wInfo - 0x20 & 0x60;
            lpciPlan->wInfo = lpciPlan->wInfo & 0xff9f;
            lpciPlan->wInfo = lpciPlan->wInfo | local_90;
        }
        uVar14 = (undefined2)((ulong)lppl >> 0x10);
        if ((((PLANET *)lppl)->iPlayer == idPlayer) || (((PLANET *)lppl)->iPlayer == -1)) {
            if ((((PLANET *)lppl)->iPlayer == idPlayer) && ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0)) {
                if (((((*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) == 1) || ((*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) == 3)) ||
                     ((*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) == 6)) ||
                    ((*(uint *)&((PLANET *)lppl)->lStarbase & 0xf) == 8)) {
                    iVar9 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 2);
                    if ((iVar9 < 1) && ((iVar9 < 0 || (*(uint *)((PLANET *)lppl)->rgwtMin < 10)))) {
                        lpciPlanTemp->wInfo1 = lpciPlanTemp->wInfo1 & 0xfeff | 0x100;
                    }
                    iVar9 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 6);
                    if ((iVar9 < 1) && ((iVar9 < 0 || (*(uint *)(((PLANET *)lppl)->rgwtMin + 1) < 10)))) {
                        lpciPlanTemp->wInfo1 = lpciPlanTemp->wInfo1 & 0xfdff | 0x200;
                    }
                    iVar9 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 10);
                    if ((iVar9 < 1) && ((iVar9 < 0 || (*(uint *)(((PLANET *)lppl)->rgwtMin + 2) < 10)))) {
                        lpciPlanTemp->wInfo1 = lpciPlanTemp->wInfo1 & 0xfbff | 0x400;
                    }
                } else {
                    iVar9 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 2);
                    if ((iVar9 < 1) && ((iVar9 < 0 || (*(uint *)((PLANET *)lppl)->rgwtMin < 1000)))) {
                        lpciPlanTemp->wInfo1 = lpciPlanTemp->wInfo1 & 0xfeff | 0x100;
                    }
                    iVar9 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 6);
                    if ((iVar9 < 1) && ((iVar9 < 0 || (*(uint *)(((PLANET *)lppl)->rgwtMin + 1) < 1000)))) {
                        lpciPlanTemp->wInfo1 = lpciPlanTemp->wInfo1 & 0xfdff | 0x200;
                    }
                    iVar9 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 10);
                    if ((iVar9 < 1) && ((iVar9 < 0 || (*(uint *)(((PLANET *)lppl)->rgwtMin + 2) < 1000)))) {
                        lpciPlanTemp->wInfo1 = lpciPlanTemp->wInfo1 & 0xfbff | 0x400;
                    }
                }
            }
        } else {
            i = (((PLANET *)lppl)->uGuesses & 0xfff) / 0xfa + 1;
            if (6 < (uint)i) {
                i = 6;
            }
            if ((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0) {
                i = i + 1;
            }
            ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] = (byte)i;
            ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 9] = 1;
        }
        lppl = (PLANET *)CONCAT22(uVar14, (PLANET *)lppl + 1);
    }
    lpflAttack._0_2_ = 0;
    lpflAttack._2_2_ = 0;
    lpflEnemy._0_2_ = 0;
    lpflEnemy._2_2_ = 0;
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
        /* WARNING: Load size is inaccurate */
        pFVar10 = ((FLEET **)rglpfl)[ifl];
        iVar9 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar9, pFVar10);
        if ((pFVar10 == 0) && (iVar9 == 0))
            break;
        if (fMarkedPlanets == 0) {
            IdNearestColonizablePlanet((FLEET *)CONCAT22(iVar9, pFVar10), 0);
        }
        uVar14 = (undefined2)((ulong)lpfl >> 0x10);
        pFVar10 = (FLEET *)lpfl;
        if (pFVar10->iPlayer == idPlayer) {
            if ((pFVar10->rgcsh[0xe] < 1) && (pFVar10->rgcsh[0xf] < 1)) {
                if (0 < pFVar10->rgcsh[0]) {
                    cFlMineLayers = cFlMineLayers + 1;
                    cMineLayers = cMineLayers + pFVar10->rgcsh[0];
                }
                for (i = 4; (i < 0xe && (pFVar10->rgcsh[i] < 1)); i = i + 1) {
                }
                if (i < 0xe) {
                    *(FLEET **)&pFVar10->lpflNext = (FLEET *)lpflAttack;
                    *(undefined2 *)((int)&pFVar10->lpflNext + 2) = lpflAttack._2_2_;
                    lpflAttack._0_2_ = pFVar10;
                    lpflAttack._2_2_ = uVar14;
                    if ((j < 6) || (((pFVar10->cord < 2 || ((((PLORD *)pFVar10->lpplord + 7)->wFlags >> 8 & 0xf) != 1)) && (pFVar10->idPlanet == -1)))) {
                        cFlDestroyers = cFlDestroyers + 1;
                    } else {
                        if ((pFVar10->cord < 2) || ((((PLORD *)pFVar10->lpplord + 7)->wFlags >> 8 & 0xf) != 1)) {
                            local_90 = pFVar10->idPlanet;
                        } else {
                            local_90 = *(uint *)&((PLORD *)pFVar10->lpplord)[6].iordMax;
                        }
                        local_94 = (PLANET *)CONCAT22(vlpbAiPlanet._2_2_, (byte *)vlpbAiPlanet + local_90 * 0x10 + 10);
                        if ((byte)local_94->id != 0) {
                            *&local_94->id = (byte)local_94->id | 0x80;
                        }
                        cFlArmadas = cFlArmadas + 1;
                    }
                } else if ((((0 < pFVar10->rgcsh[2]) || (0 < pFVar10->rgcsh[3])) &&
                            ((1 < pFVar10->cord && (iVar9 = *(int *)((int)pFVar10->rgwtMin + 0xe), -1 < iVar9)))) &&
                           (((0 < iVar9 || ((int)pFVar10->rgwtMin[3] != 0)) && ((((PLORD *)pFVar10->lpplord + 7)->wFlags >> 8 & 0xf) == 1)))) {
                    if ((((CYBERINFOTEMP *)lpciPlanTemp + *(int *)&((PLORD *)pFVar10->lpplord)[6].iordMax)->wInfo1 >> 3 & 3) < 3) {
                        local_90 = ((CYBERINFOTEMP *)lpciPlanTemp + *(int *)&((PLORD *)pFVar10->lpplord)[6].iordMax)->wInfo1 + 8 & 0x18;
                        ((CYBERINFOTEMP *)lpciPlanTemp + *(int *)&((PLORD *)pFVar10->lpplord)[6].iordMax)->wInfo1 =
                            ((CYBERINFOTEMP *)lpciPlanTemp + *(int *)&((PLORD *)pFVar10->lpplord)[6].iordMax)->wInfo1 & 0xffe7;
                        ((CYBERINFOTEMP *)lpciPlanTemp + *(int *)&((PLORD *)pFVar10->lpplord)[6].iordMax)->wInfo1 =
                            ((CYBERINFOTEMP *)lpciPlanTemp + *(int *)&((PLORD *)pFVar10->lpplord)[6].iordMax)->wInfo1 | local_90;
                    }
                }
            } else {
                cSBDefenderFleets = cSBDefenderFleets + 1;
            }
        } else {
            *(FLEET **)&pFVar10->lpflNext = (FLEET *)lpflEnemy;
            *(undefined2 *)((int)&pFVar10->lpflNext + 2) = lpflEnemy._2_2_;
            lpflEnemy._0_2_ = pFVar10;
            lpflEnemy._2_2_ = uVar14;
        }
    }
    UpdateProgressGauge(-0x39e);
    for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
        /* WARNING: Load size is inaccurate */
        pFVar10 = ((FLEET **)rglpfl)[ifl];
        iVar9 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
        lpfl = (FLEET *)CONCAT22(iVar9, pFVar10);
        if ((pFVar10 == 0) && (iVar9 == 0))
            break;
        if (pFVar10->iPlayer == idPlayer) {
            for (i = 0; (i < 0x10 && ((pFVar10->rgcsh[i] < 1 || (rgRecycleShdef[i] != 0)))); i = i + 1) {
            }
            if (i == 0x10) {
                if (pFVar10->idPlanet != -1) {
                    lppl = LpplFromId(pFVar10->idPlanet);
                    uVar14 = (undefined2)((ulong)lppl >> 0x10);
                    if (((lppl != 0) && (((PLANET *)lppl)->iPlayer == idPlayer)) &&
                        (((((PLANET *)lppl)->wFlags_0x4 >> 9 & 1) != 0 || (sVar7 = Random(5), sVar7 == 0)))) {
                        ChangeMainObjSel(2, lpfl->id);
                        uVar14 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                        *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax = *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
                        FLookupFleet(-1, (FLEET *)&sel.fl);
                        goto LAB_10a8_0b45;
                    }
                }
                uVar14 = (undefined2)((ulong)lpfl >> 0x10);
                if (((1 < ((FLEET *)lpfl)->cord) && (((FLEET *)lpfl)->idPlanet == -1)) || (sVar7 = FMoveToNearestStarbase(lpfl, 0), sVar7 != 0))
                    goto LAB_10a8_0b45;
            }
            uVar14 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar10 = (FLEET *)lpfl;
            if (((pFVar10->rgcsh[0xe] < 1) && (pFVar10->rgcsh[0xf] < 1)) || (pFVar10->idPlanet == -1)) {
                for (i = 4; (i < 0xe && (pFVar10->rgcsh[i] < 1)); i = i + 1) {
                }
                if (i < 0xe) {
                    if ((pFVar10->rgcsh[4] < 1) && (pFVar10->rgcsh[4] < 1)) {
                        TargetCyberArmada(lpfl);
                        if ((((FLEET *)lpfl)->cord == 1) && (sVar7 = Random(100), sVar7 < 0x4b)) {
                            if (i < 10) {
                                FFindBuddyAndJoinUp(lpfl, 6, 9, 100, 200);
                            } else {
                                FFindBuddyAndJoinUp(lpfl, 10, 0xd, 100, 200);
                            }
                        }
                    } else {
                        if ((iAttackStr <= pFVar10->rgcsh[4] + pFVar10->rgcsh[4]) || (1 < pFVar10->cord)) {
                            IdTargetAttack(lpfl, (FLEET *)CONCAT22(lpflAttack._2_2_, (FLEET *)lpflAttack),
                                           (FLEET *)CONCAT22(lpflEnemy._2_2_, (FLEET *)lpflEnemy), game.wCrap >> 4 & 1);
                        }
                        if ((((FLEET *)lpfl)->cord == 1) && (sVar7 = Random(100), sVar7 < 0x4b)) {
                            FFindBuddyAndJoinUp(lpfl, 4, 5, 100, 200);
                        }
                    }
                } else if (pFVar10->cord < 2) {
                    if (((game.turn < 6) && (0 < pFVar10->rgcsh[0])) && (pFVar10->cord == 1)) {
                        ChangeMainObjSel(2, lpfl->id);
                        uVar14 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                        *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax = *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
                        FLookupFleet(-1, (FLEET *)&sel.fl);
                    } else if (pFVar10->rgcsh[1] < 1) {
                    LAB_10a8_111c:
                        uVar14 = (undefined2)((ulong)lpfl >> 0x10);
                        pFVar10 = (FLEET *)lpfl;
                        if ((pFVar10->rgcsh[2] < 1) && (pFVar10->rgcsh[3] < 1)) {
                            if (((0 < pFVar10->rgcsh[0]) && (0x28 < game.turn)) && (pFVar10->cord == 1)) {
                                if (pFVar10->cord < 2) {
                                    if (((cFlMineLayers < 0x38) && ((cFlMineLayers < 0x29 || (sVar7 = Random(3), sVar7 == 0)))) ||
                                        (sVar7 = FFindBuddyAndJoinUp(lpfl, 0, 0, 0x48, 0x6c), sVar7 == 0)) {
                                        if (((((FLEET *)lpfl)->rgcsh[0] < 7) || (sVar7 = Random(5), sVar7 != 0)) ||
                                            ((uVar14 = (undefined2)((ulong)lpfl >> 0x10), pt.y = (((FLEET *)lpfl)->pt).y, pt.x = (&((FLEET *)lpfl)->pt)->x,
                                              idPlanDst = IdRandomPlanetNearby(pt, 0x69, 1), idPlanDst == -1 || (idPlanDst == ((FLEET *)lpfl)->idPlanet)))) {
                                            pPVar6 = ((FLEET *)lpfl)->lpplord;
                                            if ((*(uint *)&((PLORD *)pPVar6)[2].iordMax & 0xf) != 6) {
                                                ChangeMainObjSel(2, lpfl->id);
                                                uVar14 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                                                *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax = *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 6;
                                                ((PLORD *)sel.fl.lpplord + 3)->wFlags = 5;
                                                pbVar1 = &((PLORD *)sel.fl.lpplord)[3].iordMax;
                                                pbVar1[0] = 5;
                                                pbVar1[1] = 0;
                                                FLookupFleet(-1, (FLEET *)&sel.fl);
                                            }
                                        } else {
                                            ClearAiCurrentTask(lpfl, 1);
                                            local_9c = idPlanDst;
                                            local_124._132_2_ = ((POINT *)rgptPlan + idPlanDst)->x;
                                            _local_9e = *(undefined2 *)((int)&rgptPlan[0].y + idPlanDst * 4);
                                            local_9a = local_9a & 0xe000 | 0x1146;
                                            FMoveAiFleet(lpfl, local_124 + 0x84, 0);
                                        }
                                    }
                                } else if ((*(uint *)&((PLORD *)pFVar10->lpplord)[2].iordMax & 0xf) != 0) {
                                    ClearAiCurrentTask(lpfl, 1);
                                }
                            }
                        } else {
                            if (pFVar10->iplan != 4) {
                                ChangeMainObjSel(2, lpfl->id);
                                sel.fl.iplan = 4;
                                FLookupFleet(-1, (FLEET *)&sel.fl);
                            }
                            DoCyberFreighter(lpfl, lpciPlanTemp);
                        }
                    } else {
                        idPlanDst = IdNearestColonizablePlanet(lpfl, 0);
                        if (idPlanDst == -1) {
                            uVar14 = (undefined2)((ulong)lpfl >> 0x10);
                            pFVar10 = (FLEET *)lpfl;
                            if ((*(uint *)&((PLORD *)pFVar10->lpplord)[2].iordMax >> 8 & 0xf) == 1) {
                                ((CYBERINFOTEMP *)lpciPlanTemp + ((PLORD *)pFVar10->lpplord + 2)->wFlags)->wInfo1 =
                                    ((CYBERINFOTEMP *)lpciPlanTemp + ((PLORD *)pFVar10->lpplord + 2)->wFlags)->wInfo1 & 0xfffe | 1;
                            }
                        } else {
                            ChangeMainObjSel(2, lpfl->id);
                            uVar14 = (undefined2)((ulong)lpfl >> 0x10);
                            if ((((FLEET *)lpfl)->idPlanet != -1) &&
                                (FLookupPlanet(((FLEET *)lpfl)->idPlanet, (PLANET *)&sel.pl), sel.pl.iPlayer == idPlayer)) {
                                XferAiSupply(1, ((FLEET *)lpfl)->idPlanet, 2, lpfl->id, 3, 0xfa);
                                FLookupFleet(lpfl->id, (FLEET *)&sel.fl);
                            }
                            if (idPlanDst == -1)
                                goto LAB_10a8_111c;
                            sVar7 = FColonizeAiFleet(lpfl, idPlanDst);
                            if (sVar7 != 0) {
                                uVar14 = (undefined2)((ulong)lpfl >> 0x10);
                                if (1 < ((FLEET *)lpfl)->cord) {
                                    pPVar6 = ((FLEET *)lpfl)->lpplord;
                                    ((byte *)vlpbAiPlanet)[*(int *)&((PLORD *)pPVar6)[6].iordMax * 0x10 + 0xf] = 4;
                                }
                            }
                        }
                    }
                }
            } else {
                local_90 = 0;
                if (game.turn - rgshdef[0xe].turn < cRecyclePeriod - 10) {
                    local_90 = pFVar10->rgcsh[0xe];
                }
                if (game.turn - rgshdef[0xf].turn < cRecyclePeriod - 10) {
                    local_90 = local_90 + pFVar10->rgcsh[0xf];
                }
                if (0 < (int)local_90) {
                    ((CYBERINFOTEMP *)lpciPlanTemp + pFVar10->idPlanet)->wInfo1 = ((CYBERINFOTEMP *)lpciPlanTemp + pFVar10->idPlanet)->wInfo1 & 0xffbf | 0x40;
                    bVar5 = (int)local_90 < iAttackStr * 2;
                    local_94 = (PLANET *)(ulong)CONCAT12(bVar5, (PLANET *)local_94);
                    pPVar17 = local_94;
                    local_94._2_2_ = (uint)bVar5;
                    ((CYBERINFOTEMP *)lpciPlanTemp + pFVar10->idPlanet)->wInfo1 =
                        ((CYBERINFOTEMP *)lpciPlanTemp + pFVar10->idPlanet)->wInfo1 & 0xffdf | local_94._2_2_ << 5;
                    local_94 = pPVar17;
                }
            }
        }
    LAB_10a8_0b45:
    }
    UpdateProgressGauge(-0x39e);
    for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
        /* WARNING: Load size is inaccurate */
        pPVar11 = ((PLANET **)vrglpplAi)[ipl];
        iVar9 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
        lppl = (PLANET *)CONCAT22(iVar9, pPVar11);
        if ((pPVar11 == 0) && (iVar9 == 0))
            break;
        lpciPlan = (CYBERINFO *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData + lppl->id * 2 + 2);
        lpciPlanTemp = (CYBERINFOTEMP *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData + lppl->id * 2 + dOffsetPlanTemp);
        ChangeMainObjSel(1, lppl->id);
        InitProduction(rgprod);
        fWrite = 0;
        sVar7 = PctTrueMaxGrowth(idPlayer);
        uVar14 = (undefined2)((ulong)lppl >> 0x10);
        uVar16 = __aFulmul(CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe), (int)((PLANET *)lppl)->rgwtMin[3]), (long)sVar7);
        lNewPop = uVar16;
        GetResourcesAvailable(lppl, rgResAvail);
        GetProdQCost(lppl, rgResCost);
        for (i = 0; i < 4; i = i + 1) {
            iVar9 = *(int *)((int)rgResAvail + i * 4 + 2);
            iVar4 = *(int *)((int)rgResCost + i * 4 + 2);
            if ((iVar9 <= iVar4) && ((iVar9 < iVar4 || (*(uint *)(rgResAvail + i) < *(uint *)(rgResCost + i)))))
                goto LAB_10a8_1393;
        }
        pctValue = PctPlanetDesirability(lppl, idPlayer);
        pctValueIdeal = PctPlanetOptValue(lppl, idPlayer);
        if (pctValue < 10) {
            lVar18 = __aFldiv(CONCAT22((rgResAvail[3]._2_2_ - rgResCost[3]._2_2_) - (uint)((uint)rgResAvail[3] < (uint)rgResCost[3]),
                                       (uint)rgResAvail[3] - (uint)rgResCost[3]),
                              0x46);
            i = (int)lVar18 + 1;
            AddItemToQueue(0xc, i, grobjPlanet, 1);
            fWrite = 1;
        } else {
            if (pctValue < pctValueIdeal) {
                iVar9 = (rgResAvail[3]._2_2_ - rgResCost[3]._2_2_) - (uint)((uint)rgResAvail[3] < (uint)rgResCost[3]);
                if ((-1 < iVar9) && ((0 < iVar9 || (0x46 < (uint)rgResAvail[3] - (uint)rgResCost[3])))) {
                    AddItemToQueue(0xc, 1, grobjPlanet, 1);
                    fWrite = 1;
                }
            }
            uVar14 = (undefined2)((ulong)lppl >> 0x10);
            pPVar11 = (PLANET *)lppl;
            if (((((pPVar11->wFlags_0x4 >> 9 & 1) != 0) && ((*(uint *)&pPVar11->lStarbase & 0xf) != 1)) && ((*(uint *)&pPVar11->lStarbase & 0xf) != 3)) &&
                (((*(uint *)&pPVar11->lStarbase & 0xf) != 6 && ((*(uint *)&pPVar11->lStarbase & 0xf) != 8)))) {
                if (((((lpciPlan->wInfo >> 3 & 1) == 0) || (0x157c < lNewPop)) && (((lpciPlanTemp->wInfo1 & 1) == 0 && (iVar8 < 1)))) &&
                    ((iVar8 < 0 || (uVar15 < 0x28)))) {
                    sVar7 = FShouldPlanetBuildColonizer(lppl);
                    if (sVar7 == 0)
                        goto LAB_10a8_16c6;
                    AddItemToQueue(1, 1, grobjFleet, 1);
                    lpciPlan->wInfo = lpciPlan->wInfo & 0xfff7 | 8;
                    fWrite = 1;
                    if ((15000 < lNewPop) && (game.turn < 100)) {
                        AddItemToQueue(1, 1, grobjFleet, 1);
                    }
                } else {
                LAB_10a8_16c6:
                    lpciPlan->wInfo = lpciPlan->wInfo & 0xfff7;
                }
                uVar14 = (undefined2)((ulong)lppl >> 0x10);
                iVar9 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe);
                if (((-1 < iVar9) && (((0 < iVar9 || (2000 < *(uint *)(((PLANET *)lppl)->rgwtMin + 3))) && ((rgshdef[2].wFlags >> 9 & 1) == 0)))) &&
                    ((cExistCargo._2_2_ < 1 && (((cExistCargo._2_2_ < 0 || ((uint)cExistCargo < 0x32)) && ((lpciPlanTemp->wInfo1 >> 1 & 3) == 0)))))) {
                    pPVar17 = LpplFindClosestEnum(lppl, FEnumDropOffStage2);
                    if (pPVar17 != 0) {
                        AddItemToQueue(iLatestCargo, 1, grobjFleet, 1);
                        fWrite = 1;
                    }
                }
                if (rgshdef[0].hul.ihuldef == ihuldefFrigate) {
                    sVar7 = Random(4);
                    pPVar17 = local_94;
                    if ((sVar7 == 0) && (cMineLayers < 10000)) {
                        local_90 = lppl->id;
                        local_94 = (PLANET *)((ulong)local_94 & 0xffff);
                        for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                            /* WARNING: Load size is inaccurate */
                            pFVar10 = ((FLEET **)rglpfl)[ifl];
                            iVar9 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
                            lpfl = (FLEET *)CONCAT22(iVar9, pFVar10);
                            if ((pFVar10 == 0) && (iVar9 == 0))
                                break;
                            if ((pFVar10->idPlanet == local_90) && ((0 < pFVar10->rgcsh[0] && (pFVar10->iPlayer == idPlayer)))) {
                                local_94._0_2_ = (PLANET *)pPVar17;
                                local_94 = (PLANET *)CONCAT22(pFVar10->rgcsh[0], (PLANET *)local_94);
                                break;
                            }
                        }
                        if ((int)local_94._2_2_ < 10) {
                        LAB_10a8_185b:
                            sVar7 = Random(local_94._2_2_ * 2 + 1);
                            if (sVar7 == 0) {
                                AddItemToQueue(0, 4, grobjFleet, 1);
                                fWrite = 1;
                            }
                        } else if ((int)local_94._2_2_ < 0x11) {
                            sVar7 = Random(10);
                            if (sVar7 == 0)
                                goto LAB_10a8_185b;
                        }
                    }
                }
                local_90 = iLatestSBDefender;
                if ((lpciPlanTemp->wInfo1 >> 5 & 1) == 0) {
                    local_90 = 0xffff;
                }
                if (((local_90 == 0xffff) && ((lpciPlanTemp->wInfo1 >> 6 & 1) == 0)) && (cSBDefenderFleets < 0x28)) {
                    local_94 = LpplFindClosestEnum(lppl, FEnumCalcEnemyPlanets);
                    if (((PLANET *)local_94 != 0) || ((int)((ulong)local_94 >> 0x10) != 0)) {
                        pt1.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
                        pt1.x = ((POINT *)rgptPlan + lppl->id)->x;
                        pt2.y = *(short *)((int)&rgptPlan[0].y + local_94->id * 4);
                        pt2.x = ((POINT *)rgptPlan + local_94->id)->x;
                        lVar18 = LDistance2(pt1, pt2);
                        if (lVar18 < 0x15f91) {
                            sVar7 = Random(100);
                            local_90 = iLatestSBDefender;
                            if (0x31 < sVar7) {
                                local_90 = 0xffff;
                            }
                            goto LAB_10a8_199f;
                        }
                    }
                    sVar7 = Random(100);
                    local_90 = iLatestSBDefender;
                    if (9 < sVar7) {
                        local_90 = 0xffff;
                    }
                }
            LAB_10a8_199f:
                if (0x78 < cFlDestroyers) {
                    iLatestDestroyer = -1;
                }
                if (0xfa < cFlArmadas) {
                    iLatestBattle = -1;
                }
                iBuilt = iAddAttackFleet(lppl, iAttackStr, iLatestDestroyer, iLatestBattle, local_90);
                fWrite = fWrite | (uint)(iBuilt != 0);
                if (iBuilt == 1) {
                    cFlArmadas = cFlArmadas + 1;
                }
                if (iBuilt == 2) {
                    cSBDefenderFleets = cSBDefenderFleets + 1;
                }
                if (iBuilt == 3) {
                    cFlDestroyers = cFlDestroyers + 1;
                }
            }
        }
    LAB_10a8_1393:
        FinishProduction(fWrite);
    }
    UpdateProgressGauge(-0x39e);
    rgResCost_00 = rgResCost;
    rgResAvail_00 = rgResAvail;
    sVar7 = IshdefAiSBLatest();
    HandleBasicAiTasks(iroCur, rgprod, sVar7, rgResAvail_00, rgResCost_00);
    UpdateProgressGauge(-0x39e);
    DoCyberPackets();
    UpdateProgressGauge(-0x39e);
    FillProductionQueue();
    return;
}

// ======================================================================
// Function: DoCyberPackets
// Address: 10a8:1a78
// Segment: MEMORY_AI4
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10a820d0) */
/* WARNING: Removing unreachable block (ram,0x10a82345) */
/* WARNING: Removing unreachable block (ram,0x10a824b8) */
/* WARNING: Restarted to delay deadcode elimination for space: stack */

void DoCyberPackets(void)

{
    uint          *puVar1;
    int           *piVar2;
    double         dVar3;
    PLANET        *pPVar4;
    int            iVar5;
    double         dVar6;
    undefined2     uVar7;
    undefined1     auVar8[8];
    int            iVar9;
    ushort         uVar10;
    int            iVar11;
    double        *pdVar12;
    short          sVar13;
    uint           uVar14;
    uint          *puVar15;
    byte          *pbVar16;
    undefined2     unaff_SI;
    uint           uVar17;
    undefined2     unaff_DI;
    int            iVar18;
    bool           bVar19;
    long           lVar20;
    long           lVar21;
    ulong          uVar22;
    int            in_stack_0000fe72;
    undefined2     in_stack_0000fe74;
    undefined1     auStack_188[8];
    short          iMin;
    double         dDistanceTgt;
    CYBERINFOTEMP *lpciPlanT;
    long           lMinNeeded;
    CYBERINFO     *lpciPlanDst;
    short          iPacketAdd;
    short          cPacket[3];
    double         dMod;
    uint           uStack_150;
    int            iStack_14e;
    undefined4     local_148;
    short          fWrite;
    CYBERINFOTEMP *lpciPlanTemp;
    short          idPlanDst;
    short          dOffsetPlanTemp;
    PROD           rgprod[64];
    CYBERINFO     *lpciPlan;
    short          iWarpDst;
    short          ipl;
    short          i;
    PLANET        *lppl;
    PLANET        *lpplDst;
    short          iWarp;
    long           rgResAvail[4];
    long           rgResCost[4];
    short          fTwoMA;

    iVar9 = game.cPlanMax * 2 + 2;
    ipl = 0;
    do {
        if (vclpplAi <= ipl) {
            return;
        }
        /* WARNING: Load size is inaccurate */
        pPVar4 = ((PLANET **)vrglpplAi)[ipl];
        iVar5 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
        lppl = (PLANET *)CONCAT22(iVar5, pPVar4);
        if ((pPVar4 == 0) && (iVar5 == 0)) {
            return;
        }
        if ((pPVar4->wFlags_0x4 >> 9 & 1) != 0) {
            lpciPlan = (CYBERINFO *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData + lppl->id * 2 + 2);
            ChangeMainObjSel(1, lppl->id);
            InitProduction(rgprod);
            fWrite = 0;
            GetResourcesAvailable((PLANET *)CONCAT42(CONCAT22(rgResAvail, iVar5), pPVar4), rgResAvail);
            GetProdQCost((PLANET *)CONCAT42(CONCAT22(rgResCost, iVar5), pPVar4), rgResCost);
            if ((((lpciPlan->wInfo >> 7 & 1) == 0) &&
                 (((((*(uint *)&pPVar4->lStarbase & 0xf) == 1 || ((*(uint *)&pPVar4->lStarbase & 0xf) == 3)) || ((*(uint *)&pPVar4->lStarbase & 0xf) == 6)) ||
                   ((*(uint *)&pPVar4->lStarbase & 0xf) == 8)))) &&
                (((iVar11 = *(int *)((int)pPVar4->rgwtMin + 2),
                   0 < iVar11 ||
                       (((-1 < iVar11 && (700 < *(uint *)pPVar4->rgwtMin)) ||
                         ((iVar11 = *(int *)((int)pPVar4->rgwtMin + 6), 0 < iVar11 || ((-1 < iVar11 && (700 < *(uint *)(pPVar4->rgwtMin + 1))))))))) ||
                  ((iVar11 = *(int *)((int)pPVar4->rgwtMin + 10), -1 < iVar11 && ((0 < iVar11 || (700 < *(uint *)(pPVar4->rgwtMin + 2))))))))) {
                lVar20 = __aFldiv((long)CONCAT62(CONCAT24(2, (ulong)rgResAvail[3]._2_2_ << 0x10) >> 0x10, (undefined2)rgResAvail[3]), 2);
                local_148._2_2_ = (int)lVar20 / 5;
                if ((int)local_148._2_2_ < 7) {
                    lpplDst = 0;
                } else {
                    lpplDst = LpplFindClosestEnum((PLANET *)CONCAT22(iVar5, pPVar4), FEnumNeedMinerals);
                }
                uVar7 = vlpbAiData._2_2_;
                if (((PLANET *)lpplDst == 0) && (lpplDst._2_2_ == 0))
                    goto LAB_10a8_1fa3;
                puVar15 = (byte *)vlpbAiData + lpplDst->id * 2 + iVar9;
                if (((((*(uint *)&((PLANET *)lpplDst)->lStarbase & 0xf) == 1) || ((*(uint *)&((PLANET *)lpplDst)->lStarbase & 0xf) == 3)) ||
                     ((*(uint *)&((PLANET *)lpplDst)->lStarbase & 0xf) == 6)) ||
                    ((*(uint *)&((PLANET *)lpplDst)->lStarbase & 0xf) == 8)) {
                    local_148._0_2_ = 10;
                } else {
                    local_148._0_2_ = 1000;
                }
                iVar11 = *(int *)((int)((PLANET *)lpplDst)->rgwtMin + 2);
                if ((((iVar11 < 1) && ((iVar11 < 0 || (*(uint *)((PLANET *)lpplDst)->rgwtMin < (uint)local_148)))) &&
                     (iVar11 = *(int *)((int)pPVar4->rgwtMin + 2), -1 < iVar11)) &&
                    ((0 < iVar11 || (700 < *(uint *)pPVar4->rgwtMin)))) {
                    uVar10 = local_148._2_2_;
                    if (6 < (int)local_148._2_2_) {
                        uVar10 = 7;
                    }
                    AddItemToQueue(0xe, uVar10, grobjPlanet, 0);
                    local_148._2_2_ = local_148._2_2_ - uVar10;
                    *(uint *)CONCAT22(uVar7, puVar15) = *(uint *)CONCAT22(uVar7, puVar15) & 0xfeff;
                    fWrite = 1;
                }
                iVar11 = *(int *)((int)((PLANET *)lpplDst)->rgwtMin + 6);
                if (((iVar11 < 1) && (((iVar11 < 0 || (*(uint *)(((PLANET *)lpplDst)->rgwtMin + 1) < (uint)local_148)) &&
                                       (iVar11 = *(int *)((int)pPVar4->rgwtMin + 6), -1 < iVar11)))) &&
                    ((0 < iVar11 || (700 < *(uint *)(pPVar4->rgwtMin + 1))))) {
                    uVar10 = local_148._2_2_;
                    if (6 < (int)local_148._2_2_) {
                        uVar10 = 7;
                    }
                    AddItemToQueue(0xf, uVar10, grobjPlanet, 0);
                    local_148._2_2_ = local_148._2_2_ - uVar10;
                    *(uint *)CONCAT22(uVar7, puVar15) = *(uint *)CONCAT22(uVar7, puVar15) & 0xfdff;
                    fWrite = 1;
                }
                iVar11 = *(int *)((int)((PLANET *)lpplDst)->rgwtMin + 10);
                if (((iVar11 < 1) && ((iVar11 < 0 || (*(uint *)(((PLANET *)lpplDst)->rgwtMin + 2) < (uint)local_148)))) &&
                    ((iVar11 = *(int *)((int)pPVar4->rgwtMin + 10), -1 < iVar11 && ((0 < iVar11 || (700 < *(uint *)(pPVar4->rgwtMin + 2))))))) {
                    if (6 < (int)local_148._2_2_) {
                        local_148._2_2_ = 7;
                    }
                    AddItemToQueue(0x10, local_148._2_2_, grobjPlanet, 0);
                    *(uint *)CONCAT22(uVar7, puVar15) = *(uint *)CONCAT22(uVar7, puVar15) & 0xfbff;
                    fWrite = 1;
                }
                if (fWrite != 0) {
                    sVar13 = IWarpMAFromLppl((PLANET *)CONCAT42(CONCAT22(&fTwoMA, iVar5), pPVar4), &fTwoMA);
                    uVar14 = sVar13 - 4;
                    if (fTwoMA != 0) {
                        uVar14 = sVar13 - 3;
                    }
                    sVar13 = IWarpMAFromLppl((PLANET *)CONCAT42(CONCAT22(&fTwoMA, lpplDst._2_2_), (PLANET *)lpplDst), &fTwoMA);
                    uVar17 = sVar13 - 4;
                    if (fTwoMA != 0) {
                        uVar17 = sVar13 - 3;
                    }
                    if ((int)uVar17 <= (int)uVar14) {
                        uVar14 = uVar17;
                    }
                    sel.pl.lStarbase._2_2_ = sel.pl.lStarbase._2_2_ & 0xc000 | (uVar14 & 0xf) << 10 | lpplDst->id + 1U & 0x3ff;
                    FLookupPlanet(-1, (PLANET *)&sel.pl);
                }
            } else {
            LAB_10a8_1fa3:
                if (((lpciPlan->wInfo >> 7 & 1) == 0) &&
                    ((1 < (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) ||
                      (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) == 1 && (sVar13 = Random(3), sVar13 == 0)))))) {
                    uVar7 = vlpbAiData._2_2_;
                    pbVar16 = (byte *)vlpbAiData + game.cPlanMax * 2 + iVar9;
                    local_148 = (uint *)CONCAT22(vlpbAiData._2_2_, pbVar16);
                    bVar19 = (uint)rgResAvail[0] < (uint)rgResCost[0];
                    rgResAvail[0]._0_2_ = (uint)rgResAvail[0] - (uint)rgResCost[0];
                    rgResAvail[0]._2_2_ = (rgResAvail[0]._2_2_ - rgResCost[0]._2_2_) - (uint)bVar19;
                    bVar19 = (uint)rgResAvail[1] < (uint)rgResCost[1];
                    rgResAvail[1]._0_2_ = (uint)rgResAvail[1] - (uint)rgResCost[1];
                    rgResAvail[1]._2_2_ = (rgResAvail[1]._2_2_ - rgResCost[1]._2_2_) - (uint)bVar19;
                    bVar19 = (uint)rgResAvail[2] < (uint)rgResCost[2];
                    rgResAvail[2]._0_2_ = (uint)rgResAvail[2] - (uint)rgResCost[2];
                    rgResAvail[2]._2_2_ = (rgResAvail[2]._2_2_ - rgResCost[2]._2_2_) - (uint)bVar19;
                    uVar14 = ((uint)rgResAvail[0] - 0x46) + ((uint)rgResAvail[1] - 0x46);
                    uVar17 = uVar14 + ((uint)rgResAvail[2] - 0x46);
                    iVar18 = rgResAvail[0]._2_2_ + (uint)(0x45 < (uint)rgResAvail[0]) + rgResAvail[1]._2_2_ + (uint)(0x45 < (uint)rgResAvail[1]) +
                             (uint)CARRY2((uint)rgResAvail[0] - 0x46, (uint)rgResAvail[1] - 0x46) + rgResAvail[2]._2_2_ + -3 +
                             (uint)(0x45 < (uint)rgResAvail[2]) + (uint)CARRY2(uVar14, (uint)rgResAvail[2] - 0x46);
                    lVar20 = CONCAT22(iVar18, uVar17);
                    lVar21 = __aFldiv((long)CONCAT62(CONCAT24(2, (ulong)rgResAvail[3]._2_2_ << 0x10) >> 0x10, (undefined2)rgResAvail[3]), 2);
                    iVar11 = ((int)lVar21 + -5) / 5;
                    uVar22 = __aFulmul((ulong)CONCAT62(CONCAT24(0x46, (ulong)(uint)(iVar11 >> 0xf) << 0x10) >> 0x10, iVar11), 0x46);
                    if (lVar20 < (long)uVar22) {
                        uVar22 = CONCAT22(iVar18, uVar17);
                    } else {
                        uVar22 = __aFulmul((ulong)CONCAT62(CONCAT24(0x46, (ulong)(uint)(iVar11 >> 0xf) << 0x10) >> 0x10, iVar11), 0x46);
                    }
                    *local_148 = (int)uVar22;
                    *(int *)(pbVar16 + 2) = (int)(uVar22 >> 0x10);
                    if ((iVar18 < 0) || ((iVar18 < 1 && (uVar17 < 0x97)))) {
                        lpplDst = 0;
                    } else {
                        lpplDst = LpplFindClosestEnum((PLANET *)CONCAT22(iVar5, pPVar4), FEnumPktAttack);
                    }
                    if (((PLANET *)lpplDst != 0) || (lpplDst._2_2_ != 0)) {
                        cPacket[0] = 0;
                        cPacket[1] = 0;
                        cPacket[2] = 0;
                        lpciPlanDst = (CYBERINFO *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData + lpplDst->id * 2 + 2);
                        if ((((PLANET *)lpplDst)->wFlags_0x4 >> 9 & 1) != 0) {
                            IWarpMAFromLppl((PLANET *)CONCAT42(CONCAT22(&fTwoMA, lpplDst._2_2_), (PLANET *)lpplDst), &fTwoMA);
                        }
                        sVar13 = IWarpMAFromLppl((PLANET *)CONCAT42(CONCAT22(&fTwoMA, iVar5), pPVar4), &fTwoMA);
                        dVar6 = (double)(long)((sVar13 + 3) * (sVar13 + 3));
                        pdVar12 = DGetDistance(((POINT *)rgptPlan + lppl->id)->x, *(short *)((int)&rgptPlan[0].y + lppl->id * 4),
                                               ((POINT *)rgptPlan + lpplDst->id)->x, *(short *)((int)&rgptPlan[0].y + lpplDst->id * 4));
                        dVar3 = *pdVar12;
                        if (((((PLANET *)lpplDst)->uGuesses & 0xfff) + 0x19) * 4 < 0x3e9) {
                            in_stack_0000fe72 = ((((PLANET *)lpplDst)->uGuesses & 0xfff) + 0x19) * 4;
                            in_stack_0000fe74 = 0;
                        }
                        lVar21 = __ftol((double)CONCAT26(in_stack_0000fe74, CONCAT24(in_stack_0000fe72, CONCAT22(unaff_SI, unaff_DI))));
                        if (lVar21 < lVar20) {
                            lVar20 = lVar21;
                        }
                        if (fTwoMA == 0) {
                            _pow(DOUBLE_0_75__1120_1e3e, dVar3 / dVar6);
                            lVar21 = __ftol((double)CONCAT26(in_stack_0000fe74, CONCAT24(in_stack_0000fe72, CONCAT22(unaff_SI, unaff_DI))));
                        } else {
                            _pow(DOUBLE_0_875__1120_1e36, dVar3 / dVar6);
                            lVar21 = __ftol((double)CONCAT26(in_stack_0000fe74, CONCAT24(in_stack_0000fe72, CONCAT22(unaff_SI, unaff_DI))));
                        }
                        _auStack_188 = (longdouble)lVar20;
                        while (true) {
                            iStack_14e = (int)((ulong)lVar21 >> 0x10);
                            uStack_150 = (uint)lVar21;
                            auVar8 = auStack_188;
                            if (lVar21 < 1)
                                break;
                            _auStack_188 = (longdouble)(unkuint10)(ulonglong)auStack_188;
                            if ((rgResAvail[0]._2_2_ <= rgResAvail[1]._2_2_) &&
                                ((rgResAvail[0]._2_2_ < rgResAvail[1]._2_2_ || ((uint)rgResAvail[0] < (uint)rgResAvail[1])))) {
                                _auStack_188 = (longdouble)CONCAT28(1, auVar8);
                            }
                            iVar5 = *(int *)((int)rgResAvail + iMin * 4 + 2);
                            if ((iVar5 <= rgResAvail[2]._2_2_) && ((iVar5 < rgResAvail[2]._2_2_ || (*(uint *)(rgResAvail + iMin) < (uint)rgResAvail[2])))) {
                                _auStack_188 = (longdouble)CONCAT28(2, auStack_188);
                            }
                            cPacket[iMin] = cPacket[iMin] + 1;
                            puVar1 = (uint *)(rgResAvail + iMin);
                            uVar14 = *puVar1;
                            *puVar1 = *puVar1 - 0x46;
                            piVar2 = (int *)((int)rgResAvail + iMin * 4 + 2);
                            *piVar2 = *piVar2 - (uint)(uVar14 < 0x46);
                            lVar21 = CONCAT22(iStack_14e - (uint)(uStack_150 < 0x46), uStack_150 - 0x46);
                        }
                        if (0 < cPacket[0]) {
                            AddItemToQueue(0xe, cPacket[0], grobjPlanet, 0);
                        }
                        if (0 < cPacket[1]) {
                            AddItemToQueue(0xf, cPacket[1], grobjPlanet, 0);
                        }
                        if (0 < cPacket[2]) {
                            AddItemToQueue(0x10, cPacket[2], grobjPlanet, 0);
                        }
                        sel.pl.lStarbase._2_2_ = sel.pl.lStarbase._2_2_ & 0xc000 | (sVar13 - 1U & 0xf) << 10 | lpplDst->id + 1U & 0x3ff;
                        FLookupPlanet(-1, (PLANET *)&sel.pl);
                        bVar19 = false;
                        lpciPlanDst->wInfo = lpciPlanDst->wInfo & 0xff9f | 0x60;
                        __aFfcompp();
                        if (bVar19) {
                            lpciPlan->wInfo = lpciPlan->wInfo & 0xff7f | 0x80;
                        }
                        lpciPlan->wInfo = lpciPlan->wInfo & 0xffef;
                        fWrite = 1;
                        goto AI4_LFinish;
                    }
                }
                if (((lpciPlan->wInfo >> 4 & 1) == 0) || ((lpciPlan->wInfo >> 7 & 1) != 0)) {
                    if ((lpciPlan->wInfo >> 7 & 1) == 0) {
                        uVar14 = Random(7);
                        if (uVar14 == (lpciPlan->wInfo & 7)) {
                            lpciPlan->wInfo = lpciPlan->wInfo & 0xfff8 | uVar14 + 1 & 7;
                        } else {
                            lpciPlan->wInfo = lpciPlan->wInfo & 0xfff8 | uVar14 & 7;
                        }
                        idPlanDst = IdGetBestScannerDest((PLANET *)CONCAT42(CONCAT22(lpciPlan->wInfo, iVar5), pPVar4), lpciPlan->wInfo & 7);
                    }
                    if (((lpciPlan->wInfo >> 7 & 1) != 0) || (idPlanDst != -1)) {
                        local_148 = (uint *)CONCAT22(vlpbAiData._2_2_, (byte *)vlpbAiData + idPlanDst * 2 + 2);
                        if (((*local_148 >> 5 & 3) == 0) && (sVar13 = FAddPacketToQueue((PLANET *)CONCAT22(iVar5, pPVar4)), sVar13 != 0)) {
                            *local_148 = *local_148 & 0xff9f | 0x60;
                            lpciPlan->wInfo = lpciPlan->wInfo & 0xffef | (uint)((lpciPlan->wInfo >> 7 & 1) == 0) << 4;
                            fWrite = 1;
                        } else {
                            lpciPlan->wInfo = lpciPlan->wInfo & 0xffef;
                        }
                        sVar13 = IWarpMAFromLppl((PLANET *)CONCAT42(CONCAT22(&fTwoMA, iVar5), pPVar4), &fTwoMA);
                        uVar14 = (sVar13 - 1U & 0xf) << 10;
                        if ((lpciPlan->wInfo >> 7 & 1) == 0) {
                            sel.pl.lStarbase._2_2_ = sel.pl.lStarbase._2_2_ & 0xc000 | uVar14 | idPlanDst & 0x3ffU;
                        } else {
                            sel.pl.lStarbase._2_2_ = sel.pl.lStarbase._2_2_ & 0xc3ff | uVar14;
                            lpciPlan->wInfo = lpciPlan->wInfo & 0xff7f;
                        }
                        FLookupPlanet(-1, (PLANET *)&sel.pl);
                    }
                } else {
                    lpciPlan->wInfo = lpciPlan->wInfo & 0xffef;
                }
            }
        AI4_LFinish:
            FinishProduction(fWrite);
        }
        ipl = ipl + 1;
    } while (true);
}

// ======================================================================
// Function: IdGetBestScannerDest
// Address: 10a8:282a
// Segment: MEMORY_AI4
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10a82b98) */

short IdGetBestScannerDest(PLANET *lppl, short iDir)

{
    int        iVar1;
    POINT      pt;
    POINT      pt1;
    POINT      pt2;
    int        iVar2;
    short      sVar3;
    int        c;
    int        iVar4;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    long       lVar5;
    PLANET    *pPVar6;
    SCAN       scan;
    POINT      ptEdge;
    short      iSize;
    short      dAdjust;
    PLANET    *lpplDst;
    short      iWarp;
    short      iDistance;

    iVar4 = ((POINT *)rgptPlan + lppl->id)->x;
    iVar1 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
    iVar2 = game.mdSize * 400 + 400;
    sVar3 = IWarpMAFromLppl(lppl, 0);
    c = (sVar3 + 3) * (sVar3 + 3);
    iVar4 = iVar4 + -1000;
    iVar1 = iVar1 + -1000;
    ptEdge.x = iVar2;
    ptEdge.y = iVar2;
    switch (iDir) {
    case 0:
        ptEdge.y = iVar1;
        break;
    case 1:
        if (iVar1 < iVar2 - iVar4) {
            ptEdge.x = iVar4 + iVar1;
            ptEdge.y = 0;
        } else {
            ptEdge.y = iVar1 - (iVar2 - iVar4);
        }
        break;
    case 2:
        ptEdge.y = 0;
        ptEdge.x = iVar4;
        break;
    case 3:
        if (iVar1 < iVar4) {
            ptEdge.y = 0;
            ptEdge.x = iVar4 - iVar1;
        } else {
            ptEdge.y = iVar1 - iVar4;
            ptEdge.x = 0;
        }
        break;
    case 4:
        ptEdge.x = 0;
        ptEdge.y = iVar1;
        break;
    case 5:
        if (iVar1 < iVar2 - iVar4) {
            ptEdge.y = iVar1 + iVar4;
            ptEdge.x = 0;
        } else {
            ptEdge.x = iVar4 - (iVar2 - iVar1);
        }
        break;
    case 6:
        ptEdge.x = iVar4;
        break;
    case 7:
        if (iVar1 < iVar4) {
            ptEdge.y = iVar1 + (iVar2 - iVar4);
        } else {
            ptEdge.x = iVar4 + (iVar2 - iVar1);
        }
        break;
    default:
        return -1;
    }
    lVar5 = __ftol((double)CONCAT26(iVar2 >> 0xf, CONCAT24(iVar2, CONCAT22(unaff_SI, unaff_DI))));
    sVar3 = Random((short)lVar5);
    lVar5 = __ftol((double)CONCAT26(iVar2 >> 0xf, CONCAT24(iVar2, CONCAT22(unaff_SI, unaff_DI))));
    iVar4 = sVar3 - (int)lVar5;
    if ((ptEdge.x == 0) || (ptEdge.x == iVar2)) {
        ptEdge.y = ptEdge.y + iVar4;
        if (iVar2 < ptEdge.y) {
            dAdjust = ptEdge.y - iVar2;
            ptEdge.y = iVar2;
        } else if (ptEdge.y < 0) {
            dAdjust = -ptEdge.y;
            ptEdge.y = 0;
        } else {
            dAdjust = 0;
        }
        if (ptEdge.x != 0) {
            dAdjust = -dAdjust;
        }
        ptEdge.x = ptEdge.x + dAdjust;
    } else {
        ptEdge.x = ptEdge.x + iVar4;
        if (iVar2 < ptEdge.x) {
            dAdjust = ptEdge.x - iVar2;
            ptEdge.x = iVar2;
        } else if (ptEdge.x < 0) {
            dAdjust = -ptEdge.x;
            ptEdge.x = 0;
        } else {
            dAdjust = 0;
        }
        if (ptEdge.y == 0) {
            ptEdge.y = dAdjust;
        } else {
            ptEdge.y = ptEdge.y - dAdjust;
        }
    }
    sVar3 = Random(c);
    iVar4 = ptEdge.x;
    iVar1 = sVar3;
    if (ptEdge.y != 0) {
        if (ptEdge.y == iVar2) {
            iVar1 = ptEdge.y - sVar3;
        } else {
            iVar4 = sVar3;
            iVar1 = ptEdge.y;
            if ((ptEdge.x != 0) && (iVar4 = ptEdge.x, ptEdge.x == iVar2)) {
                iVar4 = ptEdge.x - sVar3;
            }
        }
    }
    ptEdge.y = iVar1;
    ptEdge.x = iVar4;
    pt.y = ptEdge.y + 1000;
    pt.x = ptEdge.x + 1000;
    sVar3 = FFindNearestObject(pt, 0x21, &scan);
    if (sVar3 == 0) {
        sVar3 = -1;
    } else {
        pPVar6 = LpplFromId(scan.idpl);
        iVar4 = (int)((ulong)pPVar6 >> 0x10);
        if (((((PLANET *)pPVar6 == 0) && (iVar4 == 0)) || (((PLANET *)pPVar6)->iPlayer != idPlayer)) &&
            (pt1.y = *(short *)((int)&rgptPlan[0].y + scan.idpl * 4), pt1.x = ((POINT *)rgptPlan + scan.idpl)->x,
             pt2.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4), pt2.x = ((POINT *)rgptPlan + lppl->id)->x, lVar5 = LDistance2(pt1, pt2), c * c <= lVar5)) {
            sVar3 = scan.idpl + 1;
        } else {
            sVar3 = -1;
        }
    }
    return sVar3;
}

// ======================================================================
// Function: FAddPacketToQueue
// Address: 10a8:2bc0
// Segment: MEMORY_AI4
// ======================================================================

short FAddPacketToQueue(PLANET *lppl)

{
    short sVar1;
    int   iVar2;
    int   iVar3;
    long  rgResAvail[4];
    short iMineral;
    long  rgResCost[4];

    iMineral = 0;
    GetResourcesAvailable(lppl, rgResAvail);
    GetProdQCost(lppl, rgResCost);
    iVar2 = (rgResAvail[0]._2_2_ - rgResCost[0]._2_2_) - (uint)((uint)rgResAvail[0] < (uint)rgResCost[0]);
    iVar3 = (rgResAvail[1]._2_2_ - rgResCost[1]._2_2_) - (uint)((uint)rgResAvail[1] < (uint)rgResCost[1]);
    if ((iVar2 <= iVar3) && ((iVar2 < iVar3 || ((uint)rgResAvail[0] - (uint)rgResCost[0] < (uint)rgResAvail[1] - (uint)rgResCost[1])))) {
        iMineral = 1;
    }
    iVar2 = (*(int *)((int)rgResAvail + iMineral * 4 + 2) - *(int *)((int)rgResCost + iMineral * 4 + 2)) -
            (uint)(*(uint *)(rgResAvail + iMineral) < *(uint *)(rgResCost + iMineral));
    iVar3 = (rgResAvail[2]._2_2_ - rgResCost[2]._2_2_) - (uint)((uint)rgResAvail[2] < (uint)rgResCost[2]);
    if ((iVar2 <= iVar3) &&
        ((iVar2 < iVar3 || (*(uint *)(rgResAvail + iMineral) - *(uint *)(rgResCost + iMineral) < (uint)rgResAvail[2] - (uint)rgResCost[2])))) {
        iMineral = 2;
    }
    iVar2 = (*(int *)((int)rgResAvail + iMineral * 4 + 2) - *(int *)((int)rgResCost + iMineral * 4 + 2)) -
            (uint)(*(uint *)(rgResAvail + iMineral) < *(uint *)(rgResCost + iMineral));
    if ((iVar2 < 0) || ((iVar2 < 1 && (*(uint *)(rgResAvail + iMineral) - *(uint *)(rgResCost + iMineral) < 0xaa)))) {
        sVar1 = 0;
    } else {
        AddItemToQueue(iMineral + 0xe, 1, grobjPlanet, 0);
        sVar1 = 1;
    }
    return sVar1;
}

// ======================================================================
// Function: FillProductionQueue
// Address: 10a8:2ce2
// Segment: MEMORY_AI4
// ======================================================================

void FillProductionQueue(void)

{
    PLANET *pPVar1;
    int     iVar2;
    short   fWrite;
    PROD    rgprod[64];
    short   ipl;
    PLANET *lppl;

    ipl = 0;
    while (true) {
        if (vclpplAi <= ipl) {
            return;
        }
        /* WARNING: Load size is inaccurate */
        pPVar1 = ((PLANET **)vrglpplAi)[ipl];
        iVar2 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
        lppl = (PLANET *)CONCAT22(iVar2, pPVar1);
        if ((pPVar1 == 0) && (iVar2 == 0))
            break;
        ChangeMainObjSel(1, lppl->id);
        InitProduction(rgprod);
        fWrite = FFillProdMinesAndFactories((PLANET *)CONCAT22(iVar2, pPVar1));
        FinishProduction(fWrite);
        ipl = ipl + 1;
    }
    return;
}

// ======================================================================
// Function: FFillProdMinesAndFactories
// Address: 10a8:2d72
// Segment: MEMORY_AI4
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10a83333) */
/* WARNING: Removing unreachable block (ram,0x10a83088) */
/* WARNING: Removing unreachable block (ram,0x10a82fba) */
/* WARNING: Removing unreachable block (ram,0x10a82ed5) */
/* WARNING: Removing unreachable block (ram,0x10a82ead) */
/* WARNING: Removing unreachable block (ram,0x10a82f38) */
/* WARNING: Removing unreachable block (ram,0x10a82f8a) */
/* WARNING: Removing unreachable block (ram,0x10a83156) */
/* WARNING: Removing unreachable block (ram,0x10a832eb) */
/* WARNING: Removing unreachable block (ram,0x10a82f10) */
/* WARNING: Removing unreachable block (ram,0x10a831b1) */

short FFillProdMinesAndFactories(PLANET *lppl)

{
    uint       uVar1;
    int        iVar2;
    ushort     uVar3;
    uint       uVar4;
    short      sVar5;
    short      sVar6;
    int        iVar7;
    PROD      *pPVar8;
    PLPROD    *pPVar9;
    undefined2 uVar10;
    bool       bVar11;
    bool       bVar12;
    ulong      uVar13;
    long       lVar14;
    short      cAdd;
    PROD      *lpprod;
    short      fInsert;
    short      iMaxMines;
    short      iMaxFactBuildable;
    short      iMaxFactories;
    short      i;
    short      iMaxTerra;
    short      iAddAlchemy;
    long       rgResLeft[4];
    long       rgFactCost[4];
    long       rgMineCost[4];
    long       rgAlchCost[4];
    PROD       prod;
    short      iAddMines;
    short      iAddFactories;
    long       rgResAvail[4];
    long       rgResCost[4];

    bVar11 = false;
    GetResourcesAvailable(lppl, rgResAvail);
    GetProdQCost(lppl, rgResCost);
    for (i = 0; i < 4; i = i + 1) {
        uVar4 = *(uint *)(rgResAvail + i);
        iVar7 = *(int *)((int)rgResAvail + i * 4 + 2);
        uVar1 = *(uint *)(rgResCost + i);
        iVar2 = *(int *)((int)rgResCost + i * 4 + 2);
        *(uint *)(rgResLeft + i) = uVar4 - *(uint *)(rgResCost + i);
        *(int *)((int)rgResLeft + i * 4 + 2) = (iVar7 - iVar2) - (uint)(uVar4 < uVar1);
    }
    if ((rgResLeft[3]._2_2_ < 1) && (rgResLeft[3]._2_2_ < 0)) {
        uVar4 = 0;
    } else {
        iMaxTerra = 0;
        iMaxMines = 0;
        iAddMines = 0;
        iMaxFactories = 0;
        iAddFactories = 0;
        rgMineCost[3]._0_2_ = 0;
        rgMineCost[3]._2_2_ = 0;
        rgFactCost[3]._0_2_ = 0;
        rgFactCost[3]._2_2_ = 0;
        rgAlchCost[3]._0_2_ = 0;
        rgAlchCost[3]._2_2_ = 0;
        lpprod = (PROD *)((PLPROD *)lpplProdGlob + 1);
        for (i = 0; iVar7 = cProdGlob, i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
            uVar10 = (undefined2)((ulong)lpprod >> 0x10);
            pPVar8 = (PROD *)lpprod;
            uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar8->dwFlags + 2), (int)lpprod->dwFlags), 0x11);
            if ((((uint)uVar13 & 7) == 1) &&
                (uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar8->dwFlags + 2), (int)lpprod->dwFlags), 10), ((uint)uVar13 & 0x7f) == 8)) {
                iAddMines = iAddMines + ((uint)lpprod->dwFlags & 0x3ff);
            }
            uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar8->dwFlags + 2), (int)lpprod->dwFlags), 0x11);
            if ((((uint)uVar13 & 7) == 1) &&
                (uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pPVar8->dwFlags + 2), (int)lpprod->dwFlags), 10), ((uint)uVar13 & 0x7f) == 7)) {
                iAddFactories = iAddFactories + ((uint)lpprod->dwFlags & 0x3ff);
            }
            lpprod = (PROD *)CONCAT22(uVar10, pPVar8 + 1);
        }
        while (i = iVar7 + -1, -1 < i) {
            uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[i].dwFlags + 2), (int)(pProdGlob + i)->dwFlags), 0x11);
            iVar7 = i;
            if (((uint)uVar13 & 7) == 1) {
                uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[i].dwFlags + 2), (int)(pProdGlob + i)->dwFlags), 10);
                if (((uint)uVar13 & 0x7f) == 8) {
                    sVar5 = CMaxOperableMines(lppl, idPlayer, 0);
                    sVar6 = CMinesOperating(lppl);
                    if ((uint)((sVar5 - sVar6) - iAddMines) < 0x8000) {
                        sVar5 = CMaxOperableMines(lppl, idPlayer, 0);
                        sVar6 = CMinesOperating(lppl);
                        iMaxMines = (sVar5 - sVar6) - iAddMines;
                    } else {
                        iMaxMines = 0;
                    }
                    GetProductionCosts(lppl, pProdGlob + i, rgMineCost, idPlayer, 1);
                }
                uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[i].dwFlags + 2), (int)(pProdGlob + i)->dwFlags), 10);
                if (((uint)uVar13 & 0x7f) == 7) {
                    sVar5 = CMaxOperableFactories(lppl, idPlayer, 0);
                    sVar6 = CFactoriesOperating(lppl);
                    if ((uint)((sVar5 - sVar6) - iAddFactories) < 0x8000) {
                        sVar5 = CMaxOperableFactories(lppl, idPlayer, 0);
                        sVar6 = CFactoriesOperating(lppl);
                        iMaxFactories = (sVar5 - sVar6) - iAddFactories;
                    } else {
                        iMaxFactories = 0;
                    }
                    GetProductionCosts(lppl, pProdGlob + i, rgFactCost, idPlayer, 1);
                }
                uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[i].dwFlags + 2), (int)(pProdGlob + i)->dwFlags), 10);
                if (((uint)uVar13 & 0x7f) == 0xb) {
                    GetProductionCosts(lppl, pProdGlob + i, rgAlchCost, idPlayer, 1);
                }
                uVar13 = __aFulshr(CONCAT22(*(undefined2 *)((int)&pProdGlob[i].dwFlags + 2), (int)(pProdGlob + i)->dwFlags), 10);
                if (((uint)uVar13 & 0x7f) == 0xc) {
                    iMaxTerra = (uint)(pProdGlob + i)->dwFlags & 0x3ff;
                }
            }
        }
        if ((iMaxTerra != 0) && (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 5)) {
            lVar14 = __aFldiv(CONCAT22(rgResLeft[3]._2_2_ + (uint)(0xffba < (uint)rgResLeft[3]), (uint)rgResLeft[3] + 0x45), 0x46);
            cAdd = (short)lVar14;
            if (iMaxTerra < cAdd) {
                cAdd = iMaxTerra;
            }
            if (0 < cAdd) {
                AddItemToQueue(0xc, cAdd, grobjPlanet, 0);
                return 1;
            }
        }
        iAddMines = iMaxMines;
        if (((rgResLeft[0]._2_2_ < 0) || ((((rgResLeft[0]._2_2_ < 1 && ((int)rgResLeft[0] == 0)) || (rgResLeft[1]._2_2_ < 0)) ||
                                           ((rgResLeft[1]._2_2_ < 1 && ((int)rgResLeft[1] == 0)))))) ||
            ((rgResLeft[2]._2_2_ < 1 && ((rgResLeft[2]._2_2_ < 0 || ((int)rgResLeft[2] == 0)))))) {
            if ((*(int *)&((PLANET *)lppl)->lpplprod != 0) || (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) {
                uVar10 = (undefined2)((ulong)((PLANET *)lppl)->lpplprod >> 0x10);
                pPVar9 = (PLPROD *)((PLANET *)lppl)->lpplprod;
                uVar3 = (pPVar9 + 1)->wFlags;
                uVar10 = *(undefined2 *)&pPVar9[1].iprodMax;
                uVar13 = __aFulshr(CONCAT22(uVar10, uVar3), 0x11);
                if ((((uint)uVar13 & 7) == 1) &&
                    ((uVar13 = __aFulshr(CONCAT22(uVar10, uVar3), 10),
                      ((uint)uVar13 & 0x7f) == 3 || (uVar13 = __aFulshr(CONCAT22(uVar10, uVar3), 10), ((uint)uVar13 & 0x7f) == 0xb)))) {
                    return 0;
                }
            }
            if (iMaxMines < 1) {
                iAddMines = 0;
            } else {
                lVar14 = __aFldiv(CONCAT22(rgResLeft[3]._2_2_, (uint)rgResLeft[3]), CONCAT22(rgMineCost[3]._2_2_, (undefined2)rgMineCost[3]));
                if ((int)lVar14 <= iMaxMines) {
                    lVar14 = __aFldiv(CONCAT22(rgResLeft[3]._2_2_, (uint)rgResLeft[3]), CONCAT22(rgMineCost[3]._2_2_, (undefined2)rgMineCost[3]));
                    iAddMines = (short)lVar14;
                }
            }
            uVar13 = __aFulmul((long)iAddMines, CONCAT22(rgMineCost[3]._2_2_, (undefined2)rgMineCost[3]));
            bVar11 = (uint)rgResLeft[3] < (uint)uVar13;
            rgResLeft[3]._0_2_ = (uint)rgResLeft[3] - (uint)uVar13;
            rgResLeft[3]._2_2_ = (rgResLeft[3]._2_2_ - (int)(uVar13 >> 0x10)) - (uint)bVar11;
            iAddFactories = 0;
            bVar11 = true;
        } else {
            if (0 < iMaxFactories) {
                if (((uint)gd.grBits >> 0xb & 1) == 0) {
                    lVar14 = __aFldiv(CONCAT22(rgResLeft[2]._2_2_, (int)rgResLeft[2]), CONCAT22(rgFactCost[2]._2_2_, (undefined2)rgFactCost[2]));
                    if ((int)lVar14 <= iMaxFactories) {
                        lVar14 = __aFldiv(CONCAT22(rgResLeft[2]._2_2_, (int)rgResLeft[2]), CONCAT22(rgFactCost[2]._2_2_, (undefined2)rgFactCost[2]));
                        iMaxFactories = (short)lVar14;
                    }
                } else {
                    lVar14 = __aFldiv(CONCAT22(rgResLeft[0]._2_2_, (int)rgResLeft[0]), CONCAT22(rgFactCost[0]._2_2_, (undefined2)rgFactCost[0]));
                    iVar7 = iMaxFactories;
                    if ((int)lVar14 <= iMaxFactories) {
                        lVar14 = __aFldiv(CONCAT22(rgResLeft[0]._2_2_, (int)rgResLeft[0]), CONCAT22(rgFactCost[0]._2_2_, (undefined2)rgFactCost[0]));
                        iVar7 = (int)lVar14;
                    }
                    lVar14 = __aFldiv(CONCAT22(rgResLeft[1]._2_2_, (int)rgResLeft[1]), CONCAT22(rgFactCost[1]._2_2_, (undefined2)rgFactCost[1]));
                    if (iVar7 < (int)lVar14) {
                        lVar14 = __aFldiv(CONCAT22(rgResLeft[0]._2_2_, (int)rgResLeft[0]), CONCAT22(rgFactCost[0]._2_2_, (undefined2)rgFactCost[0]));
                        iVar7 = iMaxFactories;
                        if ((int)lVar14 <= iMaxFactories) {
                            lVar14 = __aFldiv(CONCAT22(rgResLeft[0]._2_2_, (int)rgResLeft[0]), CONCAT22(rgFactCost[0]._2_2_, (undefined2)rgFactCost[0]));
                            iVar7 = (int)lVar14;
                        }
                    } else {
                        lVar14 = __aFldiv(CONCAT22(rgResLeft[1]._2_2_, (int)rgResLeft[1]), CONCAT22(rgFactCost[1]._2_2_, (undefined2)rgFactCost[1]));
                        iVar7 = (int)lVar14;
                    }
                    lVar14 = __aFldiv(CONCAT22(rgResLeft[2]._2_2_, (int)rgResLeft[2]), CONCAT22(rgFactCost[2]._2_2_, (undefined2)rgFactCost[2]));
                    if (iVar7 < (int)lVar14) {
                        lVar14 = __aFldiv(CONCAT22(rgResLeft[0]._2_2_, (int)rgResLeft[0]), CONCAT22(rgFactCost[0]._2_2_, (undefined2)rgFactCost[0]));
                        iVar7 = iMaxFactories;
                        if ((int)lVar14 <= iMaxFactories) {
                            lVar14 = __aFldiv(CONCAT22(rgResLeft[0]._2_2_, (int)rgResLeft[0]), CONCAT22(rgFactCost[0]._2_2_, (undefined2)rgFactCost[0]));
                            iVar7 = (int)lVar14;
                        }
                        lVar14 = __aFldiv(CONCAT22(rgResLeft[1]._2_2_, (int)rgResLeft[1]), CONCAT22(rgFactCost[1]._2_2_, (undefined2)rgFactCost[1]));
                        if (iVar7 < (int)lVar14) {
                            lVar14 = __aFldiv(CONCAT22(rgResLeft[0]._2_2_, (int)rgResLeft[0]), CONCAT22(rgFactCost[0]._2_2_, (undefined2)rgFactCost[0]));
                            if ((int)lVar14 <= iMaxFactories) {
                                lVar14 = __aFldiv(CONCAT22(rgResLeft[0]._2_2_, (int)rgResLeft[0]), CONCAT22(rgFactCost[0]._2_2_, (undefined2)rgFactCost[0]));
                                iMaxFactories = (short)lVar14;
                            }
                        } else {
                            lVar14 = __aFldiv(CONCAT22(rgResLeft[1]._2_2_, (int)rgResLeft[1]), CONCAT22(rgFactCost[1]._2_2_, (undefined2)rgFactCost[1]));
                            iMaxFactories = (short)lVar14;
                        }
                    } else {
                        lVar14 = __aFldiv(CONCAT22(rgResLeft[2]._2_2_, (int)rgResLeft[2]), CONCAT22(rgFactCost[2]._2_2_, (undefined2)rgFactCost[2]));
                        iMaxFactories = (short)lVar14;
                    }
                }
            }
            if (iMaxFactories < 1) {
                iAddFactories = 0;
            } else {
                lVar14 = __aFldiv(CONCAT22(rgResLeft[3]._2_2_, (uint)rgResLeft[3]), CONCAT22(rgFactCost[3]._2_2_, (undefined2)rgFactCost[3]));
                iAddFactories = iMaxFactories;
                if ((int)lVar14 <= iMaxFactories) {
                    lVar14 = __aFldiv(CONCAT22(rgResLeft[3]._2_2_, (uint)rgResLeft[3]), CONCAT22(rgFactCost[3]._2_2_, (undefined2)rgFactCost[3]));
                    iAddFactories = (short)lVar14;
                }
            }
            uVar13 = __aFulmul((long)iAddFactories, CONCAT22(rgFactCost[3]._2_2_, (undefined2)rgFactCost[3]));
            bVar12 = (uint)rgResLeft[3] < (uint)uVar13;
            rgResLeft[3]._0_2_ = (uint)rgResLeft[3] - (uint)uVar13;
            rgResLeft[3]._2_2_ = (rgResLeft[3]._2_2_ - (int)(uVar13 >> 0x10)) - (uint)bVar12;
            if (iMaxMines < 1) {
                iAddMines = 0;
            } else {
                lVar14 = __aFldiv(CONCAT22(rgResLeft[3]._2_2_, (uint)rgResLeft[3]), CONCAT22(rgMineCost[3]._2_2_, (undefined2)rgMineCost[3]));
                if ((int)lVar14 <= iMaxMines) {
                    lVar14 = __aFldiv(CONCAT22(rgResLeft[3]._2_2_, (uint)rgResLeft[3]), CONCAT22(rgMineCost[3]._2_2_, (undefined2)rgMineCost[3]));
                    iAddMines = (short)lVar14;
                }
            }
            uVar13 = __aFulmul((long)iAddMines, CONCAT22(rgMineCost[3]._2_2_, (undefined2)rgMineCost[3]));
            bVar12 = (uint)rgResLeft[3] < (uint)uVar13;
            rgResLeft[3]._0_2_ = (uint)rgResLeft[3] - (uint)uVar13;
            rgResLeft[3]._2_2_ = (rgResLeft[3]._2_2_ - (int)(uVar13 >> 0x10)) - (uint)bVar12;
        }
        if ((((rgAlchCost[3]._2_2_ < 0) ||
              (((rgAlchCost[3]._2_2_ < 1 && ((int)rgAlchCost[3] == 0)) || (*(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) != '\x1a')))) ||
             (((*(char *)((int)rgplr[0].rgTech + 5 + idPlayer * 0xc0) != '\x1a' || (*(char *)((int)rgplr[0].rgTech + idPlayer * 0xc0) != '\x1a')) ||
               (*(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0) != '\x1a')))) ||
            ((*(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) != '\x1a' || (*(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0) != '\x1a')))) {
            iAddAlchemy = 0;
        } else {
            lVar14 = __aFldiv(CONCAT22(rgResLeft[3]._2_2_, (uint)rgResLeft[3]), CONCAT22(rgAlchCost[3]._2_2_, (int)rgAlchCost[3]));
            if ((int)lVar14 + 1U < 0x8000) {
                lVar14 = __aFldiv(CONCAT22(rgResLeft[3]._2_2_, (uint)rgResLeft[3]), CONCAT22(rgAlchCost[3]._2_2_, (int)rgAlchCost[3]));
                iAddAlchemy = (int)lVar14 + 1;
            } else {
                iAddAlchemy = 0;
            }
        }
        uVar13 = __aFulmul((long)iAddAlchemy, CONCAT22(rgAlchCost[3]._2_2_, (int)rgAlchCost[3]));
        bVar12 = (uint)rgResLeft[3] < (uint)uVar13;
        rgResLeft[3]._0_2_ = (uint)rgResLeft[3] - (uint)uVar13;
        rgResLeft[3]._2_2_ = (rgResLeft[3]._2_2_ - (int)(uVar13 >> 0x10)) - (uint)bVar12;
        if (0 < iAddFactories) {
            AddItemToQueue(7, iAddFactories, grobjPlanet, 1);
        }
        if (0 < iAddMines) {
            AddItemToQueue(8, iAddMines, grobjPlanet, 0);
        }
        if ((0 < iAddAlchemy) && (100 < game.turn)) {
            AddItemToQueue(0xb, iAddAlchemy, grobjPlanet, (uint)!bVar11);
        }
        uVar4 = (uint)(0 < iAddMines + iAddFactories + iAddAlchemy);
    }
    return uVar4;
}

// ======================================================================
// Function: DoCyberFreighter
// Address: 10a8:37b0
// Segment: MEMORY_AI4
// ======================================================================

void DoCyberFreighter(FLEET *lpfl, CYBERINFOTEMP *lpciPlanTemp)

{
    ORDER     *pOVar1;
    PLORD     *pPVar2;
    byte      *pbVar3;
    ushort     uVar4;
    POINT      pt;
    PLANET    *pPVar5;
    bool       bVar6;
    uint       uVar7;
    short      sVar8;
    int        iVar9;
    int        iVar10;
    FLEET     *pFVar11;
    PLORD     *pPVar12;
    ORDER     *pOVar13;
    byte      *pbVar14;
    undefined2 uVar15;
    undefined2 uVar16;
    PLANET    *lppl;
    SCAN       scan;
    short      idPlanDst;
    short      fDropOff;
    PLANET    *lpplCur;
    PLANET    *lpplDst;
    ORDER      ord;

    bVar6 = false;
    uVar15 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar11 = (FLEET *)lpfl;
    lppl = LpplFromId(pFVar11->idPlanet);
    iVar10 = (int)((ulong)lppl >> 0x10);
    pPVar5 = (PLANET *)lppl;
    if ((pPVar5 == 0) && (iVar10 == 0)) {
        pt.y = (pFVar11->pt).y;
        pt.x = (&pFVar11->pt)->x;
        sVar8 = FFindNearestObject(pt, 0x21, &scan);
        if (sVar8 == 0) {
            lpplDst = 0;
        } else {
            lpplDst = LpplFromId(scan.idpl);
        }
    } else {
        if (pPVar5->iPlayer == idPlayer) {
            iVar9 = *(int *)((int)pPVar5->rgwtMin + 0xe);
            if ((iVar9 < 0) || ((iVar9 < 1 && (*(uint *)(pPVar5->rgwtMin + 3) < 0x7d1)))) {
                XferAiSupply(1, pFVar11->idPlanet, 2, lpfl->id, 3, -1000);
                FLookupFleet(lpfl->id, (FLEET *)&sel.fl);
            } else {
                XferAiSupply(1, pFVar11->idPlanet, 2, lpfl->id, 3, 1000);
                FLookupFleet(lpfl->id, (FLEET *)&sel.fl);
                bVar6 = true;
            }
        } else if (((pPVar5->iPlayer == -1) || (sVar8 = GetRaceStat((PLAYER *)rgplr + pPVar5->iPlayer, rsMajorAdv), sVar8 == raMacintosh)) ||
                   ((pPVar5->wFlags_0x4 >> 9 & 1) != 0)) {
            iVar9 = *(int *)((int)pFVar11->rgwtMin + 0xe);
            if ((iVar9 < 0) || ((iVar9 < 1 && ((int)pFVar11->rgwtMin[3] == 0)))) {
                bVar6 = false;
            } else {
                bVar6 = true;
            }
        } else {
            FLookupFleet(lpfl->id, (FLEET *)&sel.fl);
            uVar4 = lppl->id;
            _memset(&ord, 0, 0x12);
            ord.pt.x = ((POINT *)rgptPlan + uVar4)->x;
            ord.pt.y = *(short *)((int)&rgptPlan[0].y + uVar4 * 4);
            ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe0f0 | 0x1101;
            ord.u_ORDER_0x0008.txp.rgia[3].wFlags = (ITEMACTION)((uint)ord.u_ORDER_0x0008.txp.rgia[3].wFlags & 0xfff | 0x2000);
            ord.id = uVar4;
            ChangeMainObjSel(2, lpfl->id);
            uVar16 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
            pPVar12 = (PLORD *)sel.fl.lpplord;
            if (((pPVar12 + 2)->wFlags == uVar4) && ((*(uint *)&pPVar12[2].iordMax >> 8 & 0xf) == 1)) {
                pPVar12 = pPVar12 + 1;
                pOVar13 = &ord;
                for (iVar9 = 9; iVar9 != 0; iVar9 = iVar9 + -1) {
                    pPVar2 = pPVar12;
                    pPVar12 = &pPVar12->iordMax;
                    pOVar1 = pOVar13;
                    pOVar13 = &(pOVar13->pt).y;
                    pPVar2->wFlags = (pOVar1->pt).x;
                }
            } else {
                pbVar14 = &pPVar12[5].iordMax;
                pOVar13 = &ord;
                for (iVar9 = 9; iVar9 != 0; iVar9 = iVar9 + -1) {
                    pbVar3 = pbVar14;
                    pbVar14 = pbVar14 + 2;
                    pOVar1 = pOVar13;
                    pOVar13 = &(pOVar13->pt).y;
                    *pbVar3 = (pOVar1->pt).x;
                }
            }
            FLookupFleet(-1, (FLEET *)&sel.fl);
            FMoveToNearestStarbase(lpfl, 0);
            FLookupFleet(lpfl->id, (FLEET *)&sel.fl);
        }
        if (bVar6) {
            lpplDst = LpplFindClosestEnum(lppl, FEnumDropOffStage1);
            if (((PLANET *)lpplDst == 0) && ((int)((ulong)lpplDst >> 0x10) == 0)) {
                lpplDst = LpplFindClosestEnum(lppl, FEnumDropOffStage2);
            }
            if (((PLANET *)lpplDst == 0) && (lpplDst._2_2_ == 0)) {
                if (pPVar5->iPlayer == idPlayer) {
                    XferAiSupply(1, pFVar11->idPlanet, 2, lpfl->id, 3, -1000);
                    FLookupFleet(lpfl->id, (FLEET *)&sel.fl);
                    if ((((CYBERINFOTEMP *)lpciPlanTemp + lppl->id)->wInfo1 >> 1 & 3) < 3) {
                        uVar4 = ((CYBERINFOTEMP *)lpciPlanTemp + lppl->id)->wInfo1;
                        ((CYBERINFOTEMP *)lpciPlanTemp + lppl->id)->wInfo1 = ((CYBERINFOTEMP *)lpciPlanTemp + lppl->id)->wInfo1 & 0xfff9;
                        ((CYBERINFOTEMP *)lpciPlanTemp + lppl->id)->wInfo1 = ((CYBERINFOTEMP *)lpciPlanTemp + lppl->id)->wInfo1 | uVar4 + 2 & 6;
                    }
                }
            } else if ((((CYBERINFOTEMP *)lpciPlanTemp + lpplDst->id)->wInfo1 >> 3 & 3) < 3) {
                uVar4 = ((CYBERINFOTEMP *)lpciPlanTemp + lpplDst->id)->wInfo1;
                ((CYBERINFOTEMP *)lpciPlanTemp + lpplDst->id)->wInfo1 = ((CYBERINFOTEMP *)lpciPlanTemp + lpplDst->id)->wInfo1 & 0xffe7;
                ((CYBERINFOTEMP *)lpciPlanTemp + lpplDst->id)->wInfo1 = ((CYBERINFOTEMP *)lpciPlanTemp + lpplDst->id)->wInfo1 | uVar4 + 8 & 0x18;
            }
        } else {
            lpplDst = LpplFindClosestEnum(lppl, FEnumPickUp);
        }
    }
    if (((PLANET *)lpplDst != 0) || (lpplDst._2_2_ != 0)) {
        _memset(&ord, 0, 0x12);
        ord.pt.x = ((POINT *)rgptPlan + lpplDst->id)->x;
        ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplDst->id * 4);
        ord.id = lpplDst->id;
        ord.wFlags_0x6 = ord.wFlags_0x6 & 0xe0f0 | 0x1100;
        uVar7 = IFindIdealWarp(lpfl, 1);
        ord.wFlags_0x6 = ord.wFlags_0x6 & 0xff0f | (uVar7 & 0xf) << 4;
        sVar8 = FMoveAiFleet(lpfl, &ord, 0);
        if (sVar8 != 0) {
            pFVar11->wFlags_0x4 = pFVar11->wFlags_0x4 & 0x7fff | 0x8000;
        }
    }
    return;
}

// ======================================================================
// Function: FEnumDropOffStage1
// Address: 10a8:3d00
// Segment: MEMORY_AI4
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10a83dde) */

short FEnumDropOffStage1(PLANET *lpplSrc, PLANET *lpplTest)

{
    int            iVar1;
    int            iVar2;
    short          sVar3;
    PLANET        *pPVar4;
    undefined2     uVar5;
    long           lVar6;
    POINT          pt1;
    POINT          pt2;
    short          dOffsetPlanTemp;
    CYBERINFOTEMP *lpciPlanTemp;

    iVar2 = game.cPlanMax * 2 + 2;
    if ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar2) >> 3 & 3) == 3) {
        sVar3 = 0;
    } else {
        uVar5 = (undefined2)((ulong)lpplTest >> 0x10);
        pPVar4 = (PLANET *)lpplTest;
        if ((((pPVar4->iPlayer == idPlayer) && (iVar1 = *(int *)((int)pPVar4->rgwtMin + 0xe), iVar1 < 1)) &&
             ((iVar1 < 0 || (*(uint *)(pPVar4->rgwtMin + 3) < 200)))) &&
            ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar2) >> 3 & 3) == 0)) {
            pt2.y = *(short *)((int)&rgptPlan[0].y + lpplTest->id * 4);
            pt2.x = ((POINT *)rgptPlan + lpplTest->id)->x;
            pt1.y = *(short *)((int)&rgptPlan[0].y + lpplSrc->id * 4);
            pt1.x = ((POINT *)rgptPlan + lpplSrc->id)->x;
            lVar6 = LDistance2(pt1, pt2);
            if (lVar6 < 0x27101) {
                sVar3 = 1;
            } else {
                sVar3 = 0;
            }
        } else {
            sVar3 = 0;
        }
    }
    return sVar3;
}

// ======================================================================
// Function: FEnumDropOffStage2
// Address: 10a8:3dfe
// Segment: MEMORY_AI4
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10a83edf) */

short FEnumDropOffStage2(PLANET *lpplSrc, PLANET *lpplTest)

{
    int            iVar1;
    uint           uVar2;
    PLANET        *pPVar3;
    undefined2     uVar4;
    long           lVar5;
    POINT          pt1;
    POINT          pt2;
    short          dOffsetPlanTemp;
    CYBERINFOTEMP *lpciPlanTemp;

    iVar1 = game.cPlanMax * 2 + 2;
    if ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar1) >> 3 & 3) != 3) {
        uVar4 = (undefined2)((ulong)lpplTest >> 0x10);
        pPVar3 = (PLANET *)lpplTest;
        if (pPVar3->iPlayer == idPlayer) {
            uVar2 = (*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar1) >> 3 & 3) * 0xd2;
            iVar1 = *(int *)((int)pPVar3->rgwtMin + 0xe) + (uint)CARRY2(uVar2, *(uint *)(pPVar3->rgwtMin + 3));
            if ((iVar1 < 1) && ((iVar1 < 0 || (uVar2 + *(uint *)(pPVar3->rgwtMin + 3) < 1000)))) {
                pt2.y = *(short *)((int)&rgptPlan[0].y + lpplTest->id * 4);
                pt2.x = ((POINT *)rgptPlan + lpplTest->id)->x;
                pt1.y = *(short *)((int)&rgptPlan[0].y + lpplSrc->id * 4);
                pt1.x = ((POINT *)rgptPlan + lpplSrc->id)->x;
                lVar5 = LDistance2(pt1, pt2);
                if (160000 < lVar5) {
                    return 0;
                }
                return 1;
            }
        }
    }
    return 0;
}

// ======================================================================
// Function: FEnumPickUp
// Address: 10a8:3f00
// Segment: MEMORY_AI4
// ======================================================================

short FEnumPickUp(PLANET *lpplSrc, PLANET *lpplTest)

{
    int        iVar1;
    short      sVar2;
    PLANET    *pPVar3;
    undefined2 uVar4;

    uVar4 = (undefined2)((ulong)lpplTest >> 0x10);
    pPVar3 = (PLANET *)lpplTest;
    if ((((pPVar3->iPlayer == idPlayer) && (iVar1 = *(int *)((int)pPVar3->rgwtMin + 0xe), -1 < iVar1)) &&
         ((0 < iVar1 || (0x898 < *(uint *)(pPVar3->rgwtMin + 3))))) &&
        ((pPVar3->wFlags_0x4 >> 9 & 1) != 0)) {
        sVar2 = 1;
    } else {
        sVar2 = 0;
    }
    return sVar2;
}

// ======================================================================
// Function: FEnumNeedMinerals
// Address: 10a8:3f5e
// Segment: MEMORY_AI4
// ======================================================================

short FEnumNeedMinerals(PLANET *lpplSrc, PLANET *lpplTest)

{
    int            iVar1;
    POINT          pt1;
    POINT          pt2;
    int            iVar2;
    uint           uVar3;
    PLANET        *pPVar4;
    undefined2     uVar5;
    bool           bVar6;
    bool           bVar7;
    short          dOffsetPlanTemp;
    CYBERINFOTEMP *lpciPlanTemp;
    short          iWarpDst;
    CYBERINFO     *lpciPlan;
    short          iMinLimit;
    short          fTwoMA;
    short          iWarpSrc;
    double         dDistance;

    iVar2 = game.cPlanMax * 2 + 2;
    uVar5 = (undefined2)((ulong)lpplTest >> 0x10);
    if (((((PLANET *)lpplTest)->iPlayer == idPlayer) && ((((PLANET *)lpplTest)->wFlags_0x4 >> 9 & 1) != 0)) &&
        ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + 2) >> 5 & 3) == 0)) {
        uVar5 = (undefined2)((ulong)lpplSrc >> 0x10);
        pPVar4 = (PLANET *)lpplSrc;
        iVar1 = *(int *)((int)pPVar4->rgwtMin + 2);
        if ((((iVar1 < 0) || ((iVar1 < 1 && (*(uint *)pPVar4->rgwtMin < 0x2bd)))) ||
             ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar2) >> 8 & 1) == 0)) &&
            ((((iVar1 = *(int *)((int)pPVar4->rgwtMin + 6), iVar1 < 0 || ((iVar1 < 1 && (*(uint *)(pPVar4->rgwtMin + 1) < 0x2bd)))) ||
               ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar2) >> 9 & 1) == 0)) &&
              ((iVar1 = *(int *)((int)pPVar4->rgwtMin + 10), iVar1 < 0 || (((iVar1 < 1 && (*(uint *)(pPVar4->rgwtMin + 2) < 0x2bd)) ||
                                                                            ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar2) >> 10 & 1) == 0)))))))) {
            uVar3 = 0;
        } else {
            iWarpSrc = IWarpMAFromLppl(lpplSrc, &fTwoMA);
            if (fTwoMA != 0) {
                iWarpSrc = iWarpSrc + 1;
            }
            iWarpDst = IWarpMAFromLppl(lpplTest, &fTwoMA);
            if (fTwoMA != 0) {
                iWarpDst = iWarpDst + 1;
            }
            iVar2 = iWarpSrc;
            if (iWarpDst <= iWarpSrc) {
                iVar2 = iWarpDst;
            }
            dDistance = DOUBLE_3_5__1120_1e56 * (double)(long)iVar2 * (double)(long)iVar2;
            pt1.y = *(short *)((int)&rgptPlan[0].y + lpplSrc->id * 4);
            pt1.x = ((POINT *)rgptPlan + lpplSrc->id)->x;
            pt2.y = *(short *)((int)&rgptPlan[0].y + lpplTest->id * 4);
            pt2.x = ((POINT *)rgptPlan + lpplTest->id)->x;
            LDistance2(pt1, pt2);
            bVar6 = (undefined1 *)0xfff7 < &stack0xffc4;
            bVar7 = &stack0x0000 == (undefined1 *)((int)(ulong *)rgcrPlrHistory + 6);
            __aFfcompp();
            uVar3 = (uint)(bVar6 || bVar7);
        }
    } else {
        uVar3 = 0;
    }
    return uVar3;
}

// ======================================================================
// Function: FEnumPktAttack
// Address: 10a8:4204
// Segment: MEMORY_AI4
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10a84586) */

short FEnumPktAttack(PLANET *lpplSrc, PLANET *lpplTest)

{
    double     dVar1;
    short      sVar2;
    double    *pdVar3;
    PLANET    *pPVar4;
    int        iVar5;
    undefined2 unaff_SI;
    undefined2 unaff_DI;
    undefined2 uVar6;
    bool       bVar7;
    bool       bVar8;
    long       lVar9;
    long       lVar10;
    int        in_stack_0000ffbc;
    undefined2 in_stack_0000ffbe;
    double     dDistanceTgt;
    short      dOffsetPlanTemp;
    short      iWarpDst;
    CYBERINFO *lpciPlan;
    long       lMinNeeded;
    long       lMineral;
    long      *plMinMax;
    short      iWarp;
    double     dMod;
    short      fTwoMA;
    double     dDistance;

    iWarpDst = 0;
    uVar6 = (undefined2)((ulong)lpplTest >> 0x10);
    pPVar4 = (PLANET *)lpplTest;
    if ((((pPVar4->iPlayer == idPlayer) || (pPVar4->iPlayer == -1)) || ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + 2) >> 5 & 3) != 0)) ||
        (sVar2 = GetRaceStat((PLAYER *)rgplr + pPVar4->iPlayer, rsMajorAdv), sVar2 == raMacintosh)) {
        sVar2 = 0;
    } else {
        if ((pPVar4->wFlags_0x4 >> 9 & 1) != 0) {
            iVar5 = pPVar4->iPlayer * 4;
            if ((*(uint *)(*(int *)(iVar5 + rglpshdefSB) + (*(uint *)&pPVar4->lStarbase & 0xf) * 0x93 + 0x7b) & 0xff) != 7) {
                return 0;
            }
            iWarpDst = IWarpMAFromLppl((PLANET *)CONCAT42(CONCAT22(&fTwoMA, uVar6), pPVar4), &fTwoMA);
            if (fTwoMA != 0) {
                iWarpDst = iWarpDst + 1;
            }
        }
        sVar2 = IWarpMAFromLppl((PLANET *)CONCAT42(CONCAT22(&fTwoMA, lpplSrc._2_2_), (PLANET *)lpplSrc), &fTwoMA);
        dVar1 = (double)(long)(sVar2 + 3);
        if (sVar2 + 3 == iWarpDst) {
            sVar2 = 0;
        } else {
            dDistance = dVar1 * dVar1;
            pdVar3 = DGetDistance(((POINT *)rgptPlan + lpplSrc->id)->x, *(short *)((int)&rgptPlan[0].y + lpplSrc->id * 4),
                                  ((POINT *)rgptPlan + lpplTest->id)->x, *(short *)((int)&rgptPlan[0].y + lpplTest->id * 4));
            bVar7 = (undefined1 *)0xfff7 < &stack0xffb0;
            bVar8 = &stack0x0000 == (undefined1 *)((int)(ulong *)rgcrPlrHistory + 0x1a);
            dVar1 = *pdVar3;
            __aFfcompp();
            if (bVar7 || bVar8) {
                if (fTwoMA == 0) {
                    _pow(DOUBLE_0_75__1120_1e3e, dVar1 / dDistance);
                    lVar9 = __ftol((double)CONCAT26(in_stack_0000ffbe, CONCAT24(in_stack_0000ffbc, CONCAT22(unaff_SI, unaff_DI))));
                } else {
                    _pow(DOUBLE_0_875__1120_1e36, dVar1 / dDistance);
                    lVar9 = __ftol((double)CONCAT26(in_stack_0000ffbe, CONCAT24(in_stack_0000ffbc, CONCAT22(unaff_SI, unaff_DI))));
                }
                if ((pPVar4->uGuesses >> 0xc < 100) && ((pPVar4->uGuesses & 0xfff) != 0)) {
                    if (((pPVar4->uGuesses & 0xfff) + 0x19) * 4 < 0x3e9) {
                        in_stack_0000ffbc = ((pPVar4->uGuesses & 0xfff) + 0x19) * 4;
                        in_stack_0000ffbe = 0;
                    }
                    lVar10 = __ftol((double)CONCAT26(in_stack_0000ffbe, CONCAT24(in_stack_0000ffbc, CONCAT22(unaff_SI, unaff_DI))));
                    if (lVar9 < lVar10) {
                        sVar2 = 0;
                    } else {
                        sVar2 = 1;
                    }
                } else {
                    sVar2 = 0;
                }
            } else {
                sVar2 = 0;
            }
        }
    }
    return sVar2;
}

// ======================================================================
// Function: FEnumCalcEnemyPlanets
// Address: 10a8:45a6
// Segment: MEMORY_AI4
// ======================================================================

short FEnumCalcEnemyPlanets(PLANET *lpplSrc, PLANET *lpplTest)

{
    short      sVar1;
    undefined2 uVar2;

    uVar2 = (undefined2)((ulong)lpplTest >> 0x10);
    if ((((PLANET *)lpplTest)->iPlayer == idPlayer) || (((PLANET *)lpplTest)->iPlayer == -1)) {
        sVar1 = 0;
    } else {
        sVar1 = 1;
    }
    return sVar1;
}

// ======================================================================
// Function: iBuildCyberStarbase
// Address: 10a8:45de
// Segment: MEMORY_AI4
// ======================================================================

short iBuildCyberStarbase(PLANET *lppl)

{
    int        iVar1;
    short      sVar2;
    PLANET    *pPVar3;
    undefined2 uVar4;
    PROD       rgprod[64];
    short      ishdefSB;

    uVar4 = (undefined2)((ulong)lppl >> 0x10);
    pPVar3 = (PLANET *)lppl;
    if ((((pPVar3->wFlags_0x4 >> 9 & 1) == 0) && (sVar2 = PctPlanetDesirability(lppl, idPlayer), 0xe < sVar2)) &&
        ((iVar1 = *(int *)((int)pPVar3->rgwtMin + 0xe), 0 < iVar1 || ((-1 < iVar1 && (499 < *(uint *)(pPVar3->rgwtMin + 3))))))) {
        ChangeMainObjSel(1, lppl->id);
        InitProduction(rgprod);
        if ((pPVar3->rgMinConc[0] < 0x10) || ((pPVar3->rgMinConc[1] < 0x10 || (pPVar3->rgMinConc[2] < 0x10)))) {
            sVar2 = IshdefAiSBLatestOF();
        } else {
            sVar2 = IshdefAiSBLatest();
        }
    } else {
        sVar2 = -1;
    }
    return sVar2;
}

// ======================================================================
// Function: EnsureCyberAiShdefs
// Address: 10a8:4826
// Segment: MEMORY_AI4
// ======================================================================

void EnsureCyberAiShdefs(short iroCur)

{
    SHDEF     *pSVar1;
    SHDEF     *pSVar2;
    short      sVar3;
    int        iVar4;
    SHDEF     *pSVar5;
    SHDEF     *pSVar6;
    undefined2 uVar7;
    undefined2 unaff_SS;
    byte      *pbVar8;
    SHDEF      shdef;
    short      high;
    short      i;
    short      ishCur;
    short      ish;
    short      low;

    uVar7 = 0x10a8;
    if ((((((rgshdef[0].wFlags >> 9 & 1) == 0) && (rgshdef[0].hul.ihuldef != ihuldefFrigate)) &&
          (1 < (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7))) &&
         (((int)rgshdef[0].cExist == 0 && (rgshdef[0].cExist._2_2_ == 0)))) &&
        (5 < game.turn)) {
        pSVar5 = (SHDEF *)rgshdef;
        pSVar6 = &shdef;
        for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
            pSVar2 = pSVar6;
            pSVar6 = (pSVar6->hul).rgTech;
            pSVar1 = pSVar5;
            pSVar5 = (pSVar5->hul).rgTech;
            (pSVar2->hul).ihuldef = (pSVar1->hul).ihuldef;
        }
        *&(pSVar6->hul).ihuldef = (char)(pSVar5->hul).ihuldef;
        shdef.wFlags = shdef.wFlags & 0xfdff | 0x200;
        uVar7 = 0x1090;
        FChangeAiShdef(&shdef, 0);
    }
    if ((rgshdef[0].wFlags >> 9 & 1) != 0) {
        pbVar8 = (byte *)CONCAT22(uVar7, (byte *)vrgCyberAip + vrgCyberIshAip[0xc]);
        uVar7 = 0x1090;
        FCreateAiShdef(0, 5, pbVar8);
    }
    if (((rgshdef[4].wFlags >> 9 & 1) != 0) && (0x1e < game.turn)) {
        if (game.turn < 0x4c) {
            pbVar8 = (byte *)CONCAT22(uVar7, (byte *)vrgCyberAip + vrgCyberIshAip[0]);
            uVar7 = 0x1090;
            sVar3 = FCreateAiShdef(4, 6, pbVar8);
            if (sVar3 != 0)
                goto LAB_10a8_497e;
        }
        for (i = 5; 0 < i; i = i + -1) {
            sVar3 = Random(i);
            uVar7 = 0x1090;
            sVar3 = FCreateAiShdef(4, 6, (byte *)CONCAT22(0x1040, (byte *)vrgCyberAip + ((ushort *)vrgCyberIshAip)[sVar3]));
            if (sVar3 != 0)
                break;
        }
    }
LAB_10a8_497e:
    if ((((rgshdef[5].wFlags >> 9 & 1) != 0) && ((rgshdef[4].wFlags >> 9 & 1) == 0)) && (rgshdef[4].turn + 0x14 < game.turn)) {
        if (game.turn < 0x4c) {
            pbVar8 = (byte *)CONCAT22(uVar7, (byte *)vrgCyberAip + vrgCyberIshAip[5]);
            uVar7 = 0x1090;
            sVar3 = FCreateAiShdef(5, 6, pbVar8);
            if (sVar3 != 0)
                goto LAB_10a8_4a2f;
        }
        for (i = 5; 0 < i; i = i + -1) {
            sVar3 = Random(i);
            uVar7 = 0x1090;
            sVar3 = FCreateAiShdef(5, 6, (byte *)CONCAT22(0x1040, (byte *)vrgCyberAip + ((ushort *)vrgCyberIshAip)[sVar3 + 5]));
            if (sVar3 != 0)
                break;
        }
    }
LAB_10a8_4a2f:
    if (((rgshdef[2].wFlags >> 9 & 1) != 0) && (0x14 < game.turn)) {
        pbVar8 = (byte *)CONCAT22(uVar7, (byte *)vrgCyberAip + vrgCyberIshAip[10]);
        uVar7 = 0x1090;
        FCreateAiShdef(2, 0xb, pbVar8);
    }
    if ((((rgshdef[3].wFlags >> 9 & 1) != 0) && ((rgshdef[2].wFlags >> 9 & 1) == 0)) && (rgshdef[2].turn + 0x14 < game.turn)) {
        pbVar8 = (byte *)CONCAT22(uVar7, (byte *)vrgCyberAip + vrgCyberIshAip[0xb]);
        uVar7 = 0x1090;
        FCreateAiShdef(3, 0xb, pbVar8);
    }
    for (ish = 6; ish < 0xb; ish = ish + 4) {
        if (((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0) &&
            (((ish == 6 && (0x28 < game.turn)) || (((rgshdef[6].wFlags >> 9 & 1) == 0 && (rgshdef[6].turn + 0x1e < game.turn)))))) {
            ishCur = ish + 2;
            for (i = 3; 0 < i; i = i + -1) {
                sVar3 = Random(i);
                uVar7 = 0x1090;
                sVar3 = FCreateAiShdef(ishCur, 0x1d, (byte *)CONCAT22(0x1040, (byte *)vrgCyberAip + ((ushort *)vrgCyberIshAip)[sVar3 + 0x21]));
                if (sVar3 != 0) {
                    ishCur = ish + 1;
                    break;
                }
            }
            for (i = 4; 0 < i; i = i + -1) {
                sVar3 = Random(i);
                uVar7 = 0x1090;
                sVar3 = FCreateAiShdef(ishCur, 9, (byte *)CONCAT22(0x1040, (byte *)vrgCyberAip + ((ushort *)vrgCyberIshAip)[sVar3 + 0x1d]));
                if (sVar3 != 0) {
                    ishCur = ishCur + -1;
                    break;
                }
            }
            for (i = 3; 0 < i; i = i + -1) {
                sVar3 = Random(i);
                uVar7 = 0x1090;
                sVar3 = FCreateAiShdef(ishCur, 9, (byte *)CONCAT22(0x1040, (byte *)vrgCyberAip + ((ushort *)vrgCyberIshAip)[sVar3 + 0x1a]));
                if (sVar3 != 0) {
                    ishCur = ishCur + -1;
                    break;
                }
            }
            if (ish <= ishCur) {
                high = (ishCur - ish) * -3 + 9;
                low = 0x1a - high;
            AI4_LCruiser:
                for (i = high; 0 < i; i = i + -1) {
                    sVar3 = Random(i);
                    uVar7 = 0x1090;
                    sVar3 = FCreateAiShdef(ishCur, 7, (byte *)CONCAT22(0x1040, (byte *)vrgCyberAip + ((ushort *)vrgCyberIshAip)[sVar3 + low]));
                    if (sVar3 != 0)
                        break;
                }
                ishCur = ishCur + -1;
                if (ish <= ishCur) {
                    high = 3;
                    if (ishCur == ish) {
                        low = 0x11;
                    } else {
                        low = 0x14;
                    }
                    goto AI4_LCruiser;
                }
            }
            pbVar8 = (byte *)CONCAT22(uVar7, (byte *)vrgCyberAip + vrgCyberIshAip[0x10]);
            uVar7 = 0x1090;
            sVar3 = FCreateAiShdef(ish + 3, 0x1d, pbVar8);
            if (sVar3 == 0) {
                uVar7 = 0x1090;
                sVar3 = FCreateAiShdef(ish + 3, 9, (byte *)CONCAT22(0x1090, (byte *)vrgCyberAip + vrgCyberIshAip[0xf]));
                if (sVar3 == 0) {
                    uVar7 = 0x1090;
                    sVar3 = FCreateAiShdef(ish + 3, 0x13, (byte *)CONCAT22(0x1090, (byte *)vrgCyberAip + vrgCyberIshAip[0xe]));
                    if (sVar3 == 0) {
                        uVar7 = 0x1090;
                        FCreateAiShdef(ish + 3, 0x13, (byte *)CONCAT22(0x1090, (byte *)vrgCyberAip + vrgCyberIshAip[0xd]));
                    }
                }
            }
        }
    }
    ish = 0xe;
    do {
        if (0xf < ish) {
            return;
        }
        if (((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0) &&
            (((ish == 0xe && (0x1e < game.turn)) || (((rgshdef[0xe].wFlags >> 9 & 1) == 0 && (rgshdef[0xe].turn + 0x14 < game.turn)))))) {
            for (i = 7; 0 < i; i = i + -1) {
                sVar3 = Random(i);
                sVar3 = FCreateAiShdef(ish, 9, (byte *)CONCAT22(0x1040, (byte *)vrgCyberAip + ((ushort *)vrgCyberIshAip)[sVar3 + 0x1a]));
                if (sVar3 != 0)
                    break;
            }
            if (i == 0) {
                for (i = 9; 0 < i; i = i + -1) {
                    sVar3 = Random(i);
                    sVar3 = FCreateAiShdef(ish, 7, (byte *)CONCAT22(0x1040, (byte *)vrgCyberAip + ((ushort *)vrgCyberIshAip)[sVar3 + 0x11]));
                    if (sVar3 != 0)
                        break;
                }
            }
            if (i == 0) {
                for (i = 10; 0 < i; i = i + -1) {
                    sVar3 = Random(i);
                    sVar3 = FCreateAiShdef(ish, 6, (byte *)CONCAT22(0x1040, (byte *)vrgCyberAip + ((ushort *)vrgCyberIshAip)[sVar3]));
                    if (sVar3 != 0)
                        break;
                }
            }
        }
        ish = ish + 1;
    } while (true);
}

// ======================================================================
// Function: iAddAttackFleet
// Address: 10a8:4eba
// Segment: MEMORY_AI4
// ======================================================================

short iAddAttackFleet(PLANET *lppl, short iAttackStr, short iBestDestroyer, short iBestBattle, short iBestSBDefender)

{
    short sVar1;
    short sVar2;
    short sVar3;
    int   iVar4;
    int   iVar5;
    short iRand;
    short iMaxMines;
    short iMaxFactories;
    short fRet;

    sVar1 = Random(100);
    sVar2 = CMaxOperableMines(lppl, idPlayer, 0);
    sVar3 = CMinesOperating(lppl);
    if ((uint)(sVar2 - sVar3) < 0x8000) {
        sVar2 = CMaxOperableMines(lppl, idPlayer, 0);
        sVar3 = CMinesOperating(lppl);
        iVar4 = sVar2 - sVar3;
    } else {
        iVar4 = 0;
    }
    sVar2 = CMaxOperableFactories(lppl, idPlayer, 0);
    sVar3 = CFactoriesOperating(lppl);
    if ((uint)(sVar2 - sVar3) < 0x8000) {
        sVar2 = CMaxOperableFactories(lppl, idPlayer, 0);
        sVar3 = CFactoriesOperating(lppl);
        iVar5 = sVar2 - sVar3;
    } else {
        iVar5 = 0;
    }
    sVar2 = Random(100);
    if ((iVar4 < 100) || (iVar5 < 100)) {
        iVar4 = 0x5a;
    } else {
        iVar4 = 0x3c;
    }
    if (sVar2 < iVar4) {
        sVar1 = 0;
    } else if ((iBestBattle == -1) || (sVar1 < 0x33)) {
        if ((iBestSBDefender == -1) || (sVar1 < 0x1a)) {
            if (iBestDestroyer == -1) {
                sVar1 = 0;
            } else {
                AddItemToQueue(iBestDestroyer, 1, grobjFleet, 1);
                sVar1 = 3;
            }
        } else {
            AddItemToQueue(iBestSBDefender, 1, grobjFleet, 1);
            sVar1 = 2;
        }
    } else {
        if ((*(uint *)((int)&rgshdef[0].wFlags + (iBestBattle * 4 + 6) * 0x93) >> 9 & 1) == 0) {
            AddItemToQueue(iBestBattle * 4 + 6, 2, grobjFleet, 1);
        }
        if ((*(uint *)((int)&rgshdef[0].wFlags + (iBestBattle * 4 + 7) * 0x93) >> 9 & 1) == 0) {
            AddItemToQueue(iBestBattle * 4 + 7, 2, grobjFleet, 1);
        }
        if (((*(uint *)((int)&rgshdef[0].wFlags + (iBestBattle * 4 + 8) * 0x93) >> 9 & 1) == 0) && (sVar1 = Random(100), sVar1 < 0x4b)) {
            AddItemToQueue(iBestBattle * 4 + 8, 1, grobjFleet, 1);
        }
        if (((*(uint *)((int)&rgshdef[0].wFlags + (iBestBattle * 4 + 9) * 0x93) >> 9 & 1) == 0) && (sVar1 = Random(100), sVar1 < 0x32)) {
            AddItemToQueue(iBestBattle * 4 + 9, 1, grobjFleet, 1);
        }
        sVar1 = 1;
    }
    return sVar1;
}

// ======================================================================
// Function: TargetCyberArmada
// Address: 10a8:51a4
// Segment: MEMORY_AI4
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10a85203) */

void TargetCyberArmada(FLEET *lpfl)

{
    short     *psVar1;
    ORDER     *pOVar2;
    undefined2 uVar3;
    POINT      pt1;
    POINT      pt2;
    PLANET    *pPVar4;
    int        iVar5;
    short      sVar6;
    int        iVar7;
    FLEET     *pFVar8;
    short     *psVar9;
    ORDER     *pOVar10;
    undefined2 uVar11;
    undefined2 unaff_SS;
    long       lVar12;
    PLANET    *pPVar13;
    FLEET     *pFVar14;
    PLANET    *lpplTarget;
    short      cshWar;
    short      cshBomb;
    PLANET    *lppl;
    ORDER      ord;
    FLEET     *lpflTarget;

    uVar11 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar8 = (FLEET *)lpfl;
    if (1 < pFVar8->cord) {
        uVar3 = *(undefined2 *)((int)&pFVar8->lpplord + 2);
        psVar9 = (short *)(*(int *)&pFVar8->lpplord + 0x16);
        pOVar10 = &ord;
        for (iVar7 = 9; iVar7 != 0; iVar7 = iVar7 + -1) {
            pOVar2 = pOVar10;
            pOVar10 = &(pOVar10->pt).y;
            psVar1 = psVar9;
            psVar9 = psVar9 + 1;
            (pOVar2->pt).x = *psVar1;
        }
        pt1.y = (pFVar8->pt).y;
        pt1.x = (&pFVar8->pt)->x;
        pt2.y = ord.pt.y;
        pt2.x = ord.pt.x;
        lVar12 = LDistance2(pt1, pt2);
        if ((lVar12 < 0xf425) || ((ord.wFlags_0x6 >> 8 & 0xf) != 2)) {
            if ((ord.wFlags_0x6 >> 8 & 0xf) == 2) {
                return;
            }
            if ((ord.wFlags_0x6 >> 8 & 0xf) == 1) {
                pPVar13 = LpplFromId(ord.id);
                iVar7 = (int)((ulong)pPVar13 >> 0x10);
                pPVar4 = (PLANET *)pPVar13;
                if ((pPVar4 == 0) && (iVar7 == 0)) {
                    return;
                }
                if (pPVar4->iPlayer != -1) {
                    if (pPVar4->iPlayer != idPlayer) {
                        return;
                    }
                    if ((pPVar4->wFlags_0x4 >> 9 & 1) != 0) {
                        return;
                    }
                }
                if (pPVar4->turn != game.turn) {
                    return;
                }
            }
        }
    }
    iVar7 = pFVar8->rgcsh[6] + pFVar8->rgcsh[7] + pFVar8->rgcsh[8] * 2 + pFVar8->rgcsh[10] + pFVar8->rgcsh[0xb] + pFVar8->rgcsh[0xc] * 2;
    iVar5 = pFVar8->rgcsh[9] + pFVar8->rgcsh[0xd];
    pFVar8->wFlags_0x4 = pFVar8->wFlags_0x4 & 0x7fff | 0x8000;
    ChangeMainObjSel(2, lpfl->id);
    if (pFVar8->idPlanet == -1) {
        MoveToNearestPlanetOrEnemy(lpfl, 0x1c2);
        return;
    }
    pPVar13 = LpplFromId(pFVar8->idPlanet);
    uVar11 = (undefined2)((ulong)pPVar13 >> 0x10);
    if (((PLANET *)pPVar13)->iPlayer == idPlayer) {
        if ((iVar7 < (int)(uint)vrgAiArmadaPotency[0]) || (iVar5 < (int)(uint)vrgAiArmadaPotency[2])) {
            if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) < 2) {
                return;
            }
            if ((iVar7 <= (int)((uint)vrgAiArmadaPotency[0] * 2)) && (iVar7 < 0x3c)) {
                return;
            }
            sVar6 = Random(10);
            if ((4 < sVar6) && ((iVar7 <= (int)((uint)vrgAiArmadaPotency[0] * 3) || (sVar6 = Random(10), 6 < sVar6)))) {
                if (iVar7 < 0x79) {
                    return;
                }
                sVar6 = Random(10);
                if (6 < sVar6) {
                    return;
                }
            }
        }
    } else if ((iVar7 < (int)(uint)vrgAiArmadaPotency[1]) || (iVar5 < (int)(uint)vrgAiArmadaPotency[3])) {
        ClearAiCurrentTask(lpfl, 0);
        if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) < 2) ||
            ((((iVar7 <= (int)((uint)vrgAiArmadaPotency[0] * 2) || (sVar6 = Random(10), 4 < sVar6)) &&
               ((iVar7 <= (int)((uint)vrgAiArmadaPotency[0] * 4) || (sVar6 = Random(10), 6 < sVar6)))) &&
              ((iVar7 < 0x79 || (sVar6 = Random(10), 6 < sVar6)))))) {
            lpplTarget = LpplFindClosestEnum(pPVar13, FEnumOurStarbase);
            goto AI4_TargetEveryArmada_2;
        }
    } else if (((PLANET *)pPVar13)->iPlayer != -1) {
        return;
    }
    if ((game.wCrap >> 4 & 1) == 0) {
        lpplTarget = 0;
    } else {
        lpplTarget = LpplFindBestEnum(pPVar13, FEnumCalcArmadaHumanDest);
    }
    if (((PLANET *)lpplTarget == 0) && (lpplTarget._2_2_ == 0)) {
        lpplTarget = LpplFindBestEnum(pPVar13, FEnumCalcArmadaDest);
    }
AI4_TargetEveryArmada_2:
    if (((PLANET *)lpplTarget == 0) && (lpplTarget._2_2_ == 0)) {
        pFVar14 = LpflFindClosestEnum(lpfl, FEnumCalcEnemyFleets);
        iVar7 = (int)((ulong)pFVar14 >> 0x10);
        pFVar8 = (FLEET *)pFVar14;
        if ((pFVar8 == 0) && (iVar7 == 0)) {
            return;
        }
        ord.id = pFVar14->id;
        ord.wFlags_0x6 = ord.wFlags_0x6 & 0xf0ff | 0x200;
        ord.pt.x = (&pFVar8->pt)->x;
        ord.pt.y = (pFVar8->pt).y;
    } else {
        ((byte *)vlpbAiPlanet)[lpplTarget->id * 0x10 + 10] = ((byte *)vlpbAiPlanet)[lpplTarget->id * 0x10 + 10] | 0x80;
        ord.id = lpplTarget->id;
        ord.wFlags_0x6 = ord.wFlags_0x6 & 0xf0ff | 0x100;
        ord.pt.x = ((POINT *)rgptPlan + lpplTarget->id)->x;
        ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplTarget->id * 4);
    }
    ord.wFlags_0x6 = ord.wFlags_0x6 & 0xef00 | 0x1040;
    FMoveAiFleet(lpfl, &ord, 0);
    return;
}
