// Decompiled code from stars.exe
// Generated by Ghidra - ExportAllDecompiled.py
// Grouped by nb09_ghidra_globals.json segmap.segname
// 

// ======================================================================
// Function: DoCyberAiTurn
// Address: 10a8:002a
// Segment: MEMORY_AI4
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10a81610) */
/* WARNING: Removing unreachable block (ram,0x10a81952) */
/* WARNING: Removing unreachable block (ram,0x10a81697) */

void DoCyberAiTurn(PROD *rgprod)

{
  byte *pbVar1;
  undefined2 *puVar2;
  undefined2 *puVar3;
  bool bVar4;
  PLORD *pPVar5;
  POINT pt;
  POINT pt1;
  POINT pt2;
  short sVar6;
  int iVar7;
  FLEET *pFVar8;
  PLANET *pPVar9;
  undefined2 *puVar10;
  undefined2 *puVar11;
  undefined2 uVar12;
  undefined *puVar13;
  undefined2 unaff_SS;
  ulong uVar14;
  PLANET *pPVar15;
  long lVar16;
  uint *rgResAvail_00;
  uint *rgResCost_00;
  undefined1 shdef [134];
  byte rgRecycleSBShdef;
  undefined1 uStack_9d;
  short local_9c;
  uint local_9a;
  byte *lpb;
  short fScrap;
  short fWrite;
  short idPlanDst;
  CYBERINFOTEMP *lpciPlanTemp;
  short iAttackStr;
  short dOffsetPlanTemp;
  short iLatestBattle;
  undefined4 lNewPop;
  CYBERINFO *lpciPlan;
  PLANET *lpplMac;
  short local_76;
  short pctValue;
  short ishdefLatestSB;
  ushort cRecyclePeriod;
  short iLatestDestroyer;
  short iBuilt;
  short *lpiHistSize;
  short ipl;
  short pctValueIdeal;
  short iLatestCargo;
  FLEET *lpflAttack;
  undefined2 local_5e;
  short j;
  short iroCur;
  uint cExistCargo;
  int local_56;
  short iLatestSBDefender;
  short cFlArmadas;
  short cFlDestroyers;
  FLEET *lpfl;
  short i;
  short ifl;
  short cMineLayers;
  PLANET *lppl;
  byte rgRecycleShdef [16];
  short cFlMineLayers;
  uint cExistColony;
  int local_2c;
  FLEET *lpflEnemy;
  undefined2 local_28;
  uint rgResAvail [6];
  uint local_1a;
  int local_18;
  short cSBDefenderFleets;
  uint rgResCost [6];
  uint local_8;
  int local_6;
  
  puVar13 = (undefined *)&DAT_1120_10a8;
  dOffsetPlanTemp = game.cPlanMax * 2 + 2;
  cSBDefenderFleets = 0;
  cFlMineLayers = 0;
  cMineLayers = 0;
  cFlArmadas = 0;
  cFlDestroyers = 0;
  lpiHistSize = (short *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData);
  if (*lpiHistSize == 2) {
    puVar13 = (undefined *)0x1118;
    __fmemset((byte *)CONCAT22(vlpbAiData._2_2_,(byte *)vlpbAiData),0,0x2000);
    *lpiHistSize = game.cPlanMax * 2 + 2;
  }
  fMarkedPlanets = 0;
  iroCur = IroEnsureAi((byte *)(ZEXT24(puVar13) << 0x10),0x2a,&ishdefLatestSB,0x11);
  EnsureCyberAiShdefs(iroCur);
  MergeAllShdefs(1);
  MergeAllShdefs(0x30);
  MergeAllShdefs(-0x4000);
  MergeAllShdefs(0x3c0);
  MergeAllShdefs(0x3c00);
  iAttackStr = 1;
  if (0x32 < (uint)game.turn) {
    iAttackStr = (game.turn - 0x32U) / 10 + 1;
  }
  if (100 < (uint)game.turn) {
    fScrap = (game.turn - 100U) / 10;
    iAttackStr = iAttackStr + fScrap * ((uint)game.turn / 100);
  }
  j = 3;
  if (0x82 < (uint)game.turn) {
    j = (game.turn - 0x78U) / 0x14 + 3;
  }
  if (0x32 < (uint)j) {
    j = 0x32;
  }
  vrgAiCyberArmadaPotency[0] = (byte)j;
  vrgAiCyberArmadaPotency[1] = (byte)((ulong)(j & 0xff) / 2);
  j = 6;
  if (0x73 < (uint)game.turn) {
    j = (game.turn - 100U) / 0x16 + 6;
  }
  if (0xc < (uint)j) {
    j = 0xc;
  }
  vrgAiCyberArmadaPotency[2] = (byte)j;
  if ((int)((uint)j / 2 - 1) < 4) {
    vrgAiCyberArmadaPotency[3] = (char)((uint)j / 2) - 1;
  }
  else {
    vrgAiCyberArmadaPotency[3] = 3;
  }
  _memset(rgRecycleShdef,0,0x10);
  if ((uint)game.turn < 0x78) {
    cRecyclePeriod = 0x32;
  }
  else if ((uint)game.turn < 200) {
    cRecyclePeriod = 0x46;
  }
  else if ((uint)game.turn < 400) {
    cRecyclePeriod = 100;
  }
  else {
    cRecyclePeriod = 300;
  }
  CheckAiShdefStatus(4,5,cRecyclePeriod,&iLatestDestroyer,rgRecycleShdef);
  rgRecycleShdef[iLatestDestroyer] = 0;
  CheckAiShdefStatus(0xe,0xf,cRecyclePeriod,&iLatestSBDefender,rgRecycleShdef);
  rgRecycleShdef[iLatestDestroyer] = 0;
  cExistCargo = CheckAiShdefStatus(2,3,cRecyclePeriod,&iLatestCargo,rgRecycleShdef);
  local_56 = (int)cExistCargo >> 0xf;
  rgRecycleShdef[iLatestCargo] = 0;
  iLatestBattle = -1;
  for (i = 0; i < 2; i = i + 1) {
    if (((*(uint *)((int)&rgshdef[0].wFlags + (i * 4 + 6) * 0x93) >> 9 & 1) == 0) &&
       (cRecyclePeriod <
        (uint)(game.turn - *(int *)((int)&rgshdef[0].turn + (i * 4 + 6) * 0x93))))
    {
      fScrap = 1;
      for (j = i * 4 + 9; i * 4 + 6 <= j; j = j + -1) {
        if ((*(uint *)((int)&rgshdef[0].wFlags + j * 0x93) >> 9 & 1) == 0) {
          if (((*(int *)((int)&rgshdef[0].cExist + j * 0x93) == 0) &&
              (*(int *)((int)&rgshdef[0].cExist + 2 + j * 0x93) == 0)) &&
             ((fScrap != 0 || (j != i * 4 + 6)))) {
            puVar10 = (undefined2 *)(j * 0x93 + 0x3f00);
            puVar11 = (undefined2 *)shdef;
            for (iVar7 = 0x49; iVar7 != 0; iVar7 = iVar7 + -1) {
              puVar3 = puVar11;
              puVar11 = puVar11 + 1;
              puVar2 = puVar10;
              puVar10 = puVar10 + 1;
              *puVar3 = *puVar2;
            }
            *(undefined1 *)puVar11 = *(undefined1 *)puVar10;
            shdef._123_2_ = shdef._123_2_ & 0xfdff | 0x200;
            FChangeAiShdef((SHDEF *)shdef,j);
          }
          else {
            rgRecycleShdef[j] = 1;
            fScrap = 0;
          }
        }
      }
    }
    if (((*(uint *)((int)&rgshdef[0].wFlags + (i * 4 + 6) * 0x93) >> 9 & 1) == 0) &&
       ((iLatestBattle == -1 ||
        (fScrap = *(uint *)((int)&rgshdef[0].turn + (i * 4 + 6) * 0x93),
        *(uint *)((int)&rgshdef[0].turn + (iLatestBattle * 4 + 6) * 0x93) < (uint)fScrap))
       )) {
      iLatestBattle = i;
    }
  }
  cExistColony = (uint)rgshdef[1].cExist;
  local_2c = rgshdef[1].cExist._2_2_;
  if (0x50 < (uint)game.turn) {
    SplitOutShdefs(rgRecycleShdef);
    _memset(&rgRecycleSBShdef,0,0x10);
    rgRecycleSBShdef = 2;
    SplitOutShdefs(&rgRecycleSBShdef);
    _memset(&rgRecycleSBShdef,0,0x10);
    uStack_9d = 2;
    SplitOutShdefs(&rgRecycleSBShdef);
    _memset(&rgRecycleSBShdef,0,0x10);
    local_9c = 0x202;
    SplitOutShdefs(&rgRecycleSBShdef);
  }
  lpciPlanTemp = (CYBERINFOTEMP *)
                 CONCAT22(vlpbAiData._2_2_,
                          (CYBERINFOTEMP *)((byte *)vlpbAiData + dOffsetPlanTemp));
  __fmemset((CYBERINFOTEMP *)
                    CONCAT22(vlpbAiData._2_2_,
                             (CYBERINFOTEMP *)((byte *)vlpbAiData + dOffsetPlanTemp)),0,
                    game.cPlanMax << 1);
  lpb = (byte *)CONCAT22((PLANET *)lpPlanets,(byte *)lpb);
  fScrap = lpPlanets._2_2_;
  lpplMac = (PLANET *)lpPlanets + cPlanet;
  local_76 = lpPlanets._2_2_;
  lppl = (PLANET *)CONCAT22(lpPlanets._2_2_,(PLANET *)lpPlanets);
  while ((PLANET *)lppl < lpplMac) {
    lpciPlan = (CYBERINFO *)
               CONCAT22(vlpbAiData._2_2_,
                        (CYBERINFO *)((byte *)vlpbAiData + lppl->id * 2 + 2));
    lpciPlanTemp = (CYBERINFOTEMP *)
                   CONCAT22(vlpbAiData._2_2_,
                            (CYBERINFOTEMP *)
                            ((byte *)vlpbAiData + lppl->id * 2 + dOffsetPlanTemp));
    if (((uint)lpciPlan->wInfo >> 5 & 3) != 0) {
      fScrap = lpciPlan->wInfo - 0x20U & 0x60;
      lpciPlan->wInfo = lpciPlan->wInfo & 0xff9f;
      lpciPlan->wInfo = lpciPlan->wInfo | fScrap;
    }
    uVar12 = (undefined2)((ulong)lppl >> 0x10);
    if ((((PLANET *)lppl)->iPlayer == idPlayer) || (((PLANET *)lppl)->iPlayer == -1)) {
      if ((((PLANET *)lppl)->iPlayer == idPlayer) &&
         (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0)) {
        if (((((*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) == 1) ||
             ((*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) == 3)) ||
            ((*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) == 6)) ||
           ((*(uint *)&((PLANET *)lppl)->field11_0x2c & 0xf) == 8)) {
          iVar7 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 2);
          if ((iVar7 < 1) && ((iVar7 < 0 || (*(uint *)((PLANET *)lppl)->rgwtMin < 10)))) {
            lpciPlanTemp->wInfo1 = lpciPlanTemp->wInfo1 & 0xfeffU | 0x100;
          }
          iVar7 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 6);
          if ((iVar7 < 1) && ((iVar7 < 0 || (*(uint *)(((PLANET *)lppl)->rgwtMin + 1) < 10)))) {
            lpciPlanTemp->wInfo1 = lpciPlanTemp->wInfo1 & 0xfdffU | 0x200;
          }
          iVar7 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 10);
          if ((iVar7 < 1) && ((iVar7 < 0 || (*(uint *)(((PLANET *)lppl)->rgwtMin + 2) < 10)))) {
            lpciPlanTemp->wInfo1 = lpciPlanTemp->wInfo1 & 0xfbffU | 0x400;
          }
        }
        else {
          iVar7 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 2);
          if ((iVar7 < 1) && ((iVar7 < 0 || (*(uint *)((PLANET *)lppl)->rgwtMin < 1000)))) {
            lpciPlanTemp->wInfo1 = lpciPlanTemp->wInfo1 & 0xfeffU | 0x100;
          }
          iVar7 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 6);
          if ((iVar7 < 1) && ((iVar7 < 0 || (*(uint *)(((PLANET *)lppl)->rgwtMin + 1) < 1000)))) {
            lpciPlanTemp->wInfo1 = lpciPlanTemp->wInfo1 & 0xfdffU | 0x200;
          }
          iVar7 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 10);
          if ((iVar7 < 1) && ((iVar7 < 0 || (*(uint *)(((PLANET *)lppl)->rgwtMin + 2) < 1000)))) {
            lpciPlanTemp->wInfo1 = lpciPlanTemp->wInfo1 & 0xfbffU | 0x400;
          }
        }
      }
    }
    else {
      i = (((PLANET *)lppl)->uGuesses & 0xfffU) / 0xfa + 1;
      if (6 < (uint)i) {
        i = 6;
      }
      if (((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0) {
        i = i + 1;
      }
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 10] = (byte)i;
      ((byte *)vlpbAiPlanet)[lppl->id * 0x10 + 9] = 1;
    }
    lppl = (PLANET *)CONCAT22(uVar12,(PLANET *)lppl + 1);
  }
  lpflAttack = (FLEET *)0x0;
  local_5e = 0;
  lpflEnemy = (FLEET *)0x0;
  local_28 = 0;
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar8 = ((FLEET **)rglpfl)[ifl];
    iVar7 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar7,pFVar8);
    if ((pFVar8 == (FLEET *)0x0) && (iVar7 == 0)) break;
    if (fMarkedPlanets == 0) {
      IdNearestColonizablePlanet((FLEET *)CONCAT22(iVar7,pFVar8),(THING **)0x0);
    }
    uVar12 = (undefined2)((ulong)lpfl >> 0x10);
    pFVar8 = (FLEET *)lpfl;
    if (pFVar8->iPlayer == idPlayer) {
      if ((pFVar8->rgcsh[0xe] < 1) && (pFVar8->rgcsh[0xf] < 1)) {
        if (0 < pFVar8->rgcsh[0]) {
          cFlMineLayers = cFlMineLayers + 1;
          cMineLayers = cMineLayers + pFVar8->rgcsh[0];
        }
        for (i = 4; (i < 0xe && (pFVar8->rgcsh[i] < 1)); i = i + 1) {
        }
        if (i < 0xe) {
          *(FLEET **)&pFVar8->lpflNext = lpflAttack;
          *(undefined2 *)((int)&pFVar8->lpflNext + 2) = local_5e;
          lpflAttack = pFVar8;
          local_5e = uVar12;
          if ((j < 6) ||
             (((pFVar8->cord < 2 || (((uint)((PLORD *)pFVar8->lpplord + 7)->wFlags >> 8 & 0xf) != 1)
               ) && (pFVar8->idPlanet == -1)))) {
            cFlDestroyers = cFlDestroyers + 1;
          }
          else {
            if ((pFVar8->cord < 2) ||
               (((uint)((PLORD *)pFVar8->lpplord + 7)->wFlags >> 8 & 0xf) != 1)) {
              fScrap = pFVar8->idPlanet;
            }
            else {
              fScrap = *(short *)&((PLORD *)pFVar8->lpplord)[6].iordMax;
            }
            lpb = (byte *)CONCAT22(vlpbAiPlanet._2_2_,
                                   (byte *)vlpbAiPlanet + fScrap * 0x10 + 10);
            if (*lpb != 0) {
              *lpb = *lpb | 0x80;
            }
            cFlArmadas = cFlArmadas + 1;
          }
        }
        else if ((((0 < pFVar8->rgcsh[2]) || (0 < pFVar8->rgcsh[3])) &&
                 ((1 < pFVar8->cord && (iVar7 = *(int *)((int)pFVar8->rgwtMin + 0xe), -1 < iVar7))))
                && (((0 < iVar7 || ((int)pFVar8->rgwtMin[3] != 0)) &&
                    (((uint)((PLORD *)pFVar8->lpplord + 7)->wFlags >> 8 & 0xf) == 1)))) {
          if (((uint)((CYBERINFOTEMP *)lpciPlanTemp + *(int *)&((PLORD *)pFVar8->lpplord)[6].iordMax
                     )->wInfo1 >> 3 & 3) < 3) {
            fScrap = ((CYBERINFOTEMP *)lpciPlanTemp + *(int *)&((PLORD *)pFVar8->lpplord)[6].iordMax
                     )->wInfo1 + 8U & 0x18;
            ((CYBERINFOTEMP *)lpciPlanTemp + *(int *)&((PLORD *)pFVar8->lpplord)[6].iordMax)->wInfo1
                 = ((CYBERINFOTEMP *)lpciPlanTemp + *(int *)&((PLORD *)pFVar8->lpplord)[6].iordMax)
                   ->wInfo1 & 0xffe7;
            ((CYBERINFOTEMP *)lpciPlanTemp + *(int *)&((PLORD *)pFVar8->lpplord)[6].iordMax)->wInfo1
                 = ((CYBERINFOTEMP *)lpciPlanTemp + *(int *)&((PLORD *)pFVar8->lpplord)[6].iordMax)
                   ->wInfo1 | fScrap;
          }
        }
      }
      else {
        cSBDefenderFleets = cSBDefenderFleets + 1;
      }
    }
    else {
      *(FLEET **)&pFVar8->lpflNext = lpflEnemy;
      *(undefined2 *)((int)&pFVar8->lpflNext + 2) = local_28;
      lpflEnemy = pFVar8;
      local_28 = uVar12;
    }
  }
  UpdateProgressGauge(-0x39e);
  for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
    pFVar8 = ((FLEET **)rglpfl)[ifl];
    iVar7 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
    lpfl = (FLEET *)CONCAT22(iVar7,pFVar8);
    if ((pFVar8 == (FLEET *)0x0) && (iVar7 == 0)) break;
    if (pFVar8->iPlayer == idPlayer) {
      for (i = 0; (i < 0x10 && ((pFVar8->rgcsh[i] < 1 || (rgRecycleShdef[i] != 0)))); i = i + 1) {
      }
      if (i == 0x10) {
        if (pFVar8->idPlanet != -1) {
          lppl = LpplFromId(pFVar8->idPlanet);
          uVar12 = (undefined2)((ulong)lppl >> 0x10);
          if (((lppl != (PLANET *)0x0) && (((PLANET *)lppl)->iPlayer == idPlayer)) &&
             ((((uint)((PLANET *)lppl)->wFlags >> 9 & 1) != 0 ||
              (sVar6 = Random(5), sVar6 == 0)))) {
            ChangeMainObjSel(2,lpfl->id);
            uVar12 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
            *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                 *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
            FLookupFleet(-1,(FLEET *)&sel.fl);
            goto LAB_10a8_0b45;
          }
        }
        uVar12 = (undefined2)((ulong)lpfl >> 0x10);
        if (((1 < ((FLEET *)lpfl)->cord) && (((FLEET *)lpfl)->idPlanet == -1)) ||
           (sVar6 = FMoveToNearestStarbase(lpfl,0), sVar6 != 0)) goto LAB_10a8_0b45;
      }
      uVar12 = (undefined2)((ulong)lpfl >> 0x10);
      pFVar8 = (FLEET *)lpfl;
      if (((pFVar8->rgcsh[0xe] < 1) && (pFVar8->rgcsh[0xf] < 1)) || (pFVar8->idPlanet == -1)) {
        for (i = 4; (i < 0xe && (pFVar8->rgcsh[i] < 1)); i = i + 1) {
        }
        if (i < 0xe) {
          if ((pFVar8->rgcsh[4] < 1) && (pFVar8->rgcsh[4] < 1)) {
            TargetCyberArmada(lpfl);
            if ((((FLEET *)lpfl)->cord == 1) && (sVar6 = Random(100), sVar6 < 0x4b)) {
              if (i < 10) {
                FFindBuddyAndJoinUp(lpfl,6,9,100,200);
              }
              else {
                FFindBuddyAndJoinUp(lpfl,10,0xd,100,200);
              }
            }
          }
          else {
            if ((iAttackStr <= pFVar8->rgcsh[4] + pFVar8->rgcsh[4]) || (1 < pFVar8->cord)) {
              IdTargetAttack(lpfl,(FLEET *)CONCAT22(local_5e,lpflAttack),
                                  (FLEET *)CONCAT22(local_28,lpflEnemy),
                                  (uint)game.wCrap >> 4 & 1);
            }
            if ((((FLEET *)lpfl)->cord == 1) && (sVar6 = Random(100), sVar6 < 0x4b)) {
              FFindBuddyAndJoinUp(lpfl,4,5,100,200);
            }
          }
        }
        else if (pFVar8->cord < 2) {
          if ((((uint)game.turn < 6) && (0 < pFVar8->rgcsh[0])) && (pFVar8->cord == 1)) {
            ChangeMainObjSel(2,lpfl->id);
            uVar12 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
            *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                 *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 5;
            FLookupFleet(-1,(FLEET *)&sel.fl);
          }
          else if (pFVar8->rgcsh[1] < 1) {
LAB_10a8_111c:
            uVar12 = (undefined2)((ulong)lpfl >> 0x10);
            pFVar8 = (FLEET *)lpfl;
            if ((pFVar8->rgcsh[2] < 1) && (pFVar8->rgcsh[3] < 1)) {
              if (((0 < pFVar8->rgcsh[0]) && (0x28 < (uint)game.turn)) && (pFVar8->cord == 1)
                 ) {
                if (pFVar8->cord < 2) {
                  if (((cFlMineLayers < 0x38) &&
                      ((cFlMineLayers < 0x29 || (sVar6 = Random(3), sVar6 == 0)))) ||
                     (sVar6 = FFindBuddyAndJoinUp(lpfl,0,0,0x48,0x6c), sVar6 == 0)) {
                    if (((((FLEET *)lpfl)->rgcsh[0] < 7) || (sVar6 = Random(5), sVar6 != 0)
                        ) || ((uVar12 = (undefined2)((ulong)lpfl >> 0x10),
                              pt.y = (((FLEET *)lpfl)->pt).y, pt.x = (&((FLEET *)lpfl)->pt)->x,
                              idPlanDst = IdRandomPlanetNearby(pt,0x69,1), idPlanDst == -1 ||
                              (idPlanDst == ((FLEET *)lpfl)->idPlanet)))) {
                      pPVar5 = ((FLEET *)lpfl)->lpplord;
                      if ((*(uint *)&((PLORD *)pPVar5)[2].iordMax & 0xf) != 6) {
                        ChangeMainObjSel(2,lpfl->id);
                        uVar12 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
                        *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax =
                             *(uint *)&((PLORD *)sel.fl.lpplord)[2].iordMax & 0xfff0 | 6;
                        ((PLORD *)sel.fl.lpplord + 3)->wFlags = 5;
                        pbVar1 = &((PLORD *)sel.fl.lpplord)[3].iordMax;
                        pbVar1[0] = 5;
                        pbVar1[1] = 0;
                        FLookupFleet(-1,(FLEET *)&sel.fl);
                      }
                    }
                    else {
                      ClearAiCurrentTask(lpfl,1);
                      local_9c = idPlanDst;
                      shdef._132_2_ = ((POINT *)rgptPlan + idPlanDst)->x;
                      _rgRecycleSBShdef =
                           *(undefined2 *)((int)&rgptPlan[0].y + idPlanDst * 4);
                      local_9a = local_9a & 0xe000 | 0x1146;
                      FMoveAiFleet(lpfl,(ORDER *)(shdef + 0x84),0);
                    }
                  }
                }
                else if ((*(uint *)&((PLORD *)pFVar8->lpplord)[2].iordMax & 0xf) != 0) {
                  ClearAiCurrentTask(lpfl,1);
                }
              }
            }
            else {
              if (pFVar8->iplan != 4) {
                ChangeMainObjSel(2,lpfl->id);
                sel.fl.iplan = 4;
                FLookupFleet(-1,(FLEET *)&sel.fl);
              }
              DoCyberFreighter(lpfl,lpciPlanTemp);
            }
          }
          else {
            idPlanDst = IdNearestColonizablePlanet(lpfl,(THING **)0x0);
            if (idPlanDst == -1) {
              uVar12 = (undefined2)((ulong)lpfl >> 0x10);
              pFVar8 = (FLEET *)lpfl;
              if ((*(uint *)&((PLORD *)pFVar8->lpplord)[2].iordMax >> 8 & 0xf) == 1) {
                ((CYBERINFOTEMP *)lpciPlanTemp + ((PLORD *)pFVar8->lpplord + 2)->wFlags)->wInfo1 =
                     ((CYBERINFOTEMP *)lpciPlanTemp + ((PLORD *)pFVar8->lpplord + 2)->wFlags)->
                     wInfo1 & 0xfffeU | 1;
              }
            }
            else {
              ChangeMainObjSel(2,lpfl->id);
              uVar12 = (undefined2)((ulong)lpfl >> 0x10);
              if ((((FLEET *)lpfl)->idPlanet != -1) &&
                 (FLookupPlanet(((FLEET *)lpfl)->idPlanet,(PLANET *)&sel.pl),
                 sel.pl.iPlayer == idPlayer)) {
                XferAiSupply(1,((FLEET *)lpfl)->idPlanet,2,lpfl->id,3,0xfa);
                FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
              }
              if (idPlanDst == -1) goto LAB_10a8_111c;
              sVar6 = FColonizeAiFleet(lpfl,idPlanDst);
              if (sVar6 != 0) {
                uVar12 = (undefined2)((ulong)lpfl >> 0x10);
                if (1 < ((FLEET *)lpfl)->cord) {
                  pPVar5 = ((FLEET *)lpfl)->lpplord;
                  ((byte *)vlpbAiPlanet)[*(int *)&((PLORD *)pPVar5)[6].iordMax * 0x10 + 0xf]
                       = 4;
                }
              }
            }
          }
        }
      }
      else {
        fScrap = 0;
        if ((uint)(game.turn - rgshdef[0xe].turn) < cRecyclePeriod - 10) {
          fScrap = pFVar8->rgcsh[0xe];
        }
        if ((uint)(game.turn - rgshdef[0xf].turn) < cRecyclePeriod - 10) {
          fScrap = fScrap + pFVar8->rgcsh[0xf];
        }
        if (0 < fScrap) {
          ((CYBERINFOTEMP *)lpciPlanTemp + pFVar8->idPlanet)->wInfo1 =
               ((CYBERINFOTEMP *)lpciPlanTemp + pFVar8->idPlanet)->wInfo1 & 0xffbfU | 0x40;
          bVar4 = fScrap < iAttackStr * 2;
          lpb = (byte *)(ulong)CONCAT12(bVar4,(byte *)lpb);
          pbVar1 = lpb;
          lpb._2_2_ = (uint)bVar4;
          ((CYBERINFOTEMP *)lpciPlanTemp + pFVar8->idPlanet)->wInfo1 =
               ((CYBERINFOTEMP *)lpciPlanTemp + pFVar8->idPlanet)->wInfo1 & 0xffdfU | lpb._2_2_ << 5
          ;
          lpb = pbVar1;
        }
      }
    }
LAB_10a8_0b45:
  }
  UpdateProgressGauge(-0x39e);
  for (ipl = 0; ipl < vclpplAi; ipl = ipl + 1) {
                    /* WARNING: Load size is inaccurate */
    pPVar9 = ((PLANET **)vrglpplAi)[ipl];
    iVar7 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
    lppl = (PLANET *)CONCAT22(iVar7,pPVar9);
    if ((pPVar9 == (PLANET *)0x0) && (iVar7 == 0)) break;
    lpciPlan = (CYBERINFO *)
               CONCAT22(vlpbAiData._2_2_,
                        (CYBERINFO *)((byte *)vlpbAiData + lppl->id * 2 + 2));
    lpciPlanTemp = (CYBERINFOTEMP *)
                   CONCAT22(vlpbAiData._2_2_,
                            (CYBERINFOTEMP *)
                            ((byte *)vlpbAiData + lppl->id * 2 + dOffsetPlanTemp));
    ChangeMainObjSel(1,lppl->id);
    InitProduction(rgprod);
    fWrite = 0;
    sVar6 = PctTrueMaxGrowth(idPlayer);
    uVar12 = (undefined2)((ulong)lppl >> 0x10);
    uVar14 = __aFulmul(CONCAT22(*(undefined2 *)((int)((PLANET *)lppl)->rgwtMin + 0xe),
                                        (int)((PLANET *)lppl)->rgwtMin[3]),(long)sVar6);
    lNewPop = uVar14;
    GetResourcesAvailable(lppl,(long *)rgResAvail);
    GetProdQCost(lppl,(long *)rgResCost);
    for (i = 0; i < 4; i = i + 1) {
      if (((int)rgResAvail[i * 2 + 1] <= (int)rgResCost[i * 2 + 1]) &&
         (((int)rgResAvail[i * 2 + 1] < (int)rgResCost[i * 2 + 1] ||
          (rgResAvail[i * 2] < rgResCost[i * 2])))) goto LAB_10a8_1393;
    }
    pctValue = PctPlanetDesirability(lppl,idPlayer);
    pctValueIdeal = PctPlanetOptValue(lppl,idPlayer);
    if (pctValue < 10) {
      lVar16 = __aFldiv(CONCAT22((local_18 - local_6) - (uint)(local_1a < local_8),
                                         local_1a - local_8),0x46);
      i = (int)lVar16 + 1;
      AddItemToQueue(0xc,i,grobjPlanet,1);
      fWrite = 1;
    }
    else {
      if (pctValue < pctValueIdeal) {
        iVar7 = (local_18 - local_6) - (uint)(local_1a < local_8);
        if ((-1 < iVar7) && ((0 < iVar7 || (0x46 < local_1a - local_8)))) {
          AddItemToQueue(0xc,1,grobjPlanet,1);
          fWrite = 1;
        }
      }
      uVar12 = (undefined2)((ulong)lppl >> 0x10);
      pPVar9 = (PLANET *)lppl;
      if ((((((uint)pPVar9->wFlags >> 9 & 1) != 0) && ((*(uint *)&pPVar9->field11_0x2c & 0xf) != 1))
          && ((*(uint *)&pPVar9->field11_0x2c & 0xf) != 3)) &&
         (((*(uint *)&pPVar9->field11_0x2c & 0xf) != 6 &&
          ((*(uint *)&pPVar9->field11_0x2c & 0xf) != 8)))) {
        if ((((((uint)lpciPlan->wInfo >> 3 & 1) == 0) || (0x157c < (long)lNewPop)) &&
            (((lpciPlanTemp->wInfo1 & 1U) == 0 && (local_2c < 1)))) &&
           ((local_2c < 0 || (cExistColony < 0x28)))) {
          sVar6 = FShouldPlanetBuildColonizer(lppl);
          if (sVar6 == 0) goto LAB_10a8_16c6;
          AddItemToQueue(1,1,grobjFleet,1);
          lpciPlan->wInfo = lpciPlan->wInfo & 0xfff7U | 8;
          fWrite = 1;
          if ((15000 < (long)lNewPop) && ((uint)game.turn < 100)) {
            AddItemToQueue(1,1,grobjFleet,1);
          }
        }
        else {
LAB_10a8_16c6:
          lpciPlan->wInfo = lpciPlan->wInfo & 0xfff7;
        }
        uVar12 = (undefined2)((ulong)lppl >> 0x10);
        iVar7 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 0xe);
        if (((-1 < iVar7) &&
            (((0 < iVar7 || (2000 < *(uint *)(((PLANET *)lppl)->rgwtMin + 3))) &&
             (((uint)rgshdef[2].wFlags >> 9 & 1) == 0)))) &&
           ((local_56 < 1 &&
            (((local_56 < 0 || (cExistCargo < 0x32)) && (((uint)lpciPlanTemp->wInfo1 >> 1 & 3) == 0)
             ))))) {
          pPVar15 = LpplFindClosestEnum(lppl,FEnumDropOffStage2);
          if (pPVar15 != (PLANET *)0x0) {
            AddItemToQueue(iLatestCargo,1,grobjFleet,1);
            fWrite = 1;
          }
        }
        if (rgshdef[0].hul.ihuldef == ihuldefFrigate) {
          sVar6 = Random(4);
          pbVar1 = lpb;
          if ((sVar6 == 0) && (cMineLayers < 10000)) {
            fScrap = lppl->id;
            lpb = (byte *)((ulong)lpb & 0xffff);
            for (ifl = 0; ifl < cFleet; ifl = ifl + 1) {
                    /* WARNING: Load size is inaccurate */
              pFVar8 = ((FLEET **)rglpfl)[ifl];
              iVar7 = *(int *)((int)((FLEET **)rglpfl + ifl) + 2);
              lpfl = (FLEET *)CONCAT22(iVar7,pFVar8);
              if ((pFVar8 == (FLEET *)0x0) && (iVar7 == 0)) break;
              if ((pFVar8->idPlanet == fScrap) &&
                 ((0 < pFVar8->rgcsh[0] && (pFVar8->iPlayer == idPlayer)))) {
                lpb._0_2_ = (byte *)pbVar1;
                lpb = (byte *)CONCAT22(pFVar8->rgcsh[0],(byte *)lpb);
                break;
              }
            }
            if ((int)lpb._2_2_ < 10) {
LAB_10a8_185b:
              sVar6 = Random(lpb._2_2_ * 2 + 1);
              if (sVar6 == 0) {
                AddItemToQueue(0,4,grobjFleet,1);
                fWrite = 1;
              }
            }
            else if ((int)lpb._2_2_ < 0x11) {
              sVar6 = Random(10);
              if (sVar6 == 0) goto LAB_10a8_185b;
            }
          }
        }
        fScrap = iLatestSBDefender;
        if (((uint)lpciPlanTemp->wInfo1 >> 5 & 1) == 0) {
          fScrap = -1;
        }
        if (((fScrap == -1) && (((uint)lpciPlanTemp->wInfo1 >> 6 & 1) == 0)) &&
           (cSBDefenderFleets < 0x28)) {
          lpb = (byte *)LpplFindClosestEnum(lppl,FEnumCalcEnemyPlanets);
          if (((PLANET *)lpb != (PLANET *)0x0) || ((int)((ulong)lpb >> 0x10) != 0)) {
            pt1.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4);
            pt1.x = ((POINT *)rgptPlan + lppl->id)->x;
            pt2.y = *(short *)((int)&rgptPlan[0].y + ((PLANET *)lpb)->id * 4);
            pt2.x = ((POINT *)rgptPlan + ((PLANET *)lpb)->id)->x;
            lVar16 = LDistance2(pt1,pt2);
            if (lVar16 < 0x15f91) {
              sVar6 = Random(100);
              fScrap = iLatestSBDefender;
              if (0x31 < sVar6) {
                fScrap = -1;
              }
              goto LAB_10a8_199f;
            }
          }
          sVar6 = Random(100);
          fScrap = iLatestSBDefender;
          if (9 < sVar6) {
            fScrap = -1;
          }
        }
LAB_10a8_199f:
        if (0x78 < cFlDestroyers) {
          iLatestDestroyer = -1;
        }
        if (0xfa < cFlArmadas) {
          iLatestBattle = -1;
        }
        iBuilt = iAddAttackFleet(lppl,iAttackStr,iLatestDestroyer,iLatestBattle,fScrap);
        fWrite = fWrite | (uint)(iBuilt != 0);
        if (iBuilt == 1) {
          cFlArmadas = cFlArmadas + 1;
        }
        if (iBuilt == 2) {
          cSBDefenderFleets = cSBDefenderFleets + 1;
        }
        if (iBuilt == 3) {
          cFlDestroyers = cFlDestroyers + 1;
        }
      }
    }
LAB_10a8_1393:
    FinishProduction(fWrite);
  }
  UpdateProgressGauge(-0x39e);
  rgResCost_00 = rgResCost;
  rgResAvail_00 = rgResAvail;
  sVar6 = IshdefAiSBLatest();
  HandleBasicAiTasks(iroCur,rgprod,sVar6,(long *)rgResAvail_00,(long *)rgResCost_00);
  UpdateProgressGauge(-0x39e);
  DoCyberPackets();
  UpdateProgressGauge(-0x39e);
  FillProductionQueue();
  return;
}



// ======================================================================
// Function: DoCyberPackets
// Address: 10a8:1a78
// Segment: MEMORY_AI4
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10a820d0) */
/* WARNING: Removing unreachable block (ram,0x10a82345) */
/* WARNING: Removing unreachable block (ram,0x10a824b8) */
/* WARNING: Restarted to delay deadcode elimination for space: stack */

void DoCyberPackets(void)

{
  double dVar1;
  double dVar2;
  int iVar3;
  uint uVar4;
  uint uVar5;
  undefined1 extraout_AH;
  short sVar6;
  uint uVar7;
  PLANET *pPVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar9;
  bool bVar10;
  long lVar11;
  uint *puVar12;
  ulong uVar13;
  long lVar14;
  int in_stack_0000fe72;
  undefined2 in_stack_0000fe74;
  undefined1 local_188 [26];
  CYBERINFO *lpciPlanDst;
  short iPacketAdd;
  ushort cPacket [3];
  double dMod;
  undefined8 dDistance;
  uint *cResLeft;
  undefined4 uStack_150;
  int lPackets;
  short iPacketAdd__330;
  undefined4 iMinLimit;
  short fWrite;
  byte *lpciPlanTemp;
  int local_140;
  short idPlanDst;
  short dOffsetPlanTemp;
  PROD rgprod [64];
  CYBERINFO *lpciPlan;
  short iWarpDst;
  short ipl;
  short i;
  PLANET *lppl;
  PLANET *lpplDst;
  short iWarp;
  uint rgResAvail [4];
  uint local_1e;
  int local_1c;
  undefined2 local_1a;
  undefined2 local_18;
  uint rgResCost;
  int local_14;
  uint local_12;
  int local_10;
  uint local_e;
  int local_c;
  short fTwoMA;
  
  dOffsetPlanTemp = game.cPlanMax * 2 + 2;
  ipl = 0;
  do {
    if (vclpplAi <= ipl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pPVar8 = ((PLANET **)vrglpplAi)[ipl];
    iVar3 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
    lppl = (PLANET *)CONCAT22(iVar3,pPVar8);
    if ((pPVar8 == (PLANET *)0x0) && (iVar3 == 0)) {
      return;
    }
    if (((uint)pPVar8->wFlags >> 9 & 1) != 0) {
      lpciPlan = (CYBERINFO *)
                 CONCAT22(vlpbAiData._2_2_,
                          (CYBERINFO *)((byte *)vlpbAiData + lppl->id * 2 + 2));
      lpciPlanTemp = (byte *)vlpbAiData + lppl->id * 2 + dOffsetPlanTemp;
      local_140 = vlpbAiData._2_2_;
      ChangeMainObjSel(1,lppl->id);
      InitProduction(rgprod);
      fWrite = 0;
      GetResourcesAvailable(lppl,(long *)rgResAvail);
      GetProdQCost(lppl,(long *)&rgResCost);
      if (((uint)lpciPlan->wInfo >> 7 & 1) == 0) {
        uVar9 = (undefined2)((ulong)lppl >> 0x10);
        pPVar8 = (PLANET *)lppl;
        if ((((((*(uint *)&pPVar8->field11_0x2c & 0xf) != 1) &&
              ((*(uint *)&pPVar8->field11_0x2c & 0xf) != 3)) &&
             ((*(uint *)&pPVar8->field11_0x2c & 0xf) != 6)) &&
            ((*(uint *)&pPVar8->field11_0x2c & 0xf) != 8)) ||
           (((iVar3 = *(int *)((int)pPVar8->rgwtMin + 2), iVar3 < 1 &&
             ((iVar3 < 0 || (*(uint *)pPVar8->rgwtMin < 0x2bd)))) &&
            ((iVar3 = *(int *)((int)pPVar8->rgwtMin + 6), iVar3 < 1 &&
             (((iVar3 < 0 || (*(uint *)(pPVar8->rgwtMin + 1) < 0x2bd)) &&
              ((iVar3 = *(int *)((int)pPVar8->rgwtMin + 10), iVar3 < 0 ||
               ((iVar3 < 1 && (*(uint *)(pPVar8->rgwtMin + 2) < 0x2bd))))))))))))
        goto LAB_10a8_1fa3;
        lVar11 = __aFldiv(CONCAT22(local_18,local_1a),2);
        iVar3 = (int)lVar11 / 5;
        iMinLimit = (uint *)CONCAT22(iVar3,(uint *)iMinLimit);
        if (iVar3 < 7) {
          lpplDst = (PLANET *)0x0;
        }
        else {
          lpplDst = LpplFindClosestEnum(lppl,FEnumNeedMinerals);
        }
        if (((PLANET *)lpplDst == (PLANET *)0x0) && (lpplDst._2_2_ == 0)) goto LAB_10a8_1fa3;
        uStack_150._2_2_ = (byte *)vlpbAiData + lpplDst->id * 2 + 2;
        lPackets = vlpbAiData._2_2_;
        cResLeft = (uint *)((byte *)vlpbAiData + lpplDst->id * 2 + dOffsetPlanTemp);
        uStack_150._0_2_ = vlpbAiData._2_2_;
        iPacketAdd__330 = 0;
        if (((((*(uint *)&((PLANET *)lpplDst)->field11_0x2c & 0xf) == 1) ||
             ((*(uint *)&((PLANET *)lpplDst)->field11_0x2c & 0xf) == 3)) ||
            ((*(uint *)&((PLANET *)lpplDst)->field11_0x2c & 0xf) == 6)) ||
           ((*(uint *)&((PLANET *)lpplDst)->field11_0x2c & 0xf) == 8)) {
          iMinLimit = (uint *)CONCAT22(iMinLimit._2_2_,(uint *)0xa);
        }
        else {
          iMinLimit = (uint *)CONCAT22(iMinLimit._2_2_,(uint *)0x3e8);
        }
        iVar3 = *(int *)((int)((PLANET *)lpplDst)->rgwtMin + 2);
        if ((iVar3 < 1) &&
           ((iVar3 < 0 || (*(uint **)((PLANET *)lpplDst)->rgwtMin < (uint *)iMinLimit)))) {
          uVar9 = (undefined2)((ulong)lppl >> 0x10);
          iVar3 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 2);
          if ((-1 < iVar3) && ((0 < iVar3 || (700 < *(uint *)((PLANET *)lppl)->rgwtMin)))) {
            iPacketAdd__330 = iMinLimit._2_2_;
            if (6 < (int)iMinLimit._2_2_) {
              iPacketAdd__330 = 7;
            }
            AddItemToQueue(0xe,iPacketAdd__330,grobjPlanet,0);
            iMinLimit = (uint *)CONCAT22(iMinLimit._2_2_ - iPacketAdd__330,(uint *)iMinLimit);
            *(uint *)CONCAT22((uint)uStack_150,cResLeft) =
                 *(uint *)CONCAT22((uint)uStack_150,cResLeft) & 0xfeff;
            fWrite = 1;
          }
        }
        uVar9 = (undefined2)((ulong)lpplDst >> 0x10);
        iVar3 = *(int *)((int)((PLANET *)lpplDst)->rgwtMin + 6);
        if ((iVar3 <= (int)(uint *)iMinLimit >> 0xf) &&
           ((iVar3 < (int)(uint *)iMinLimit >> 0xf ||
            (*(uint **)(((PLANET *)lpplDst)->rgwtMin + 1) < (uint *)iMinLimit)))) {
          uVar9 = (undefined2)((ulong)lppl >> 0x10);
          iVar3 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 6);
          if ((-1 < iVar3) && ((0 < iVar3 || (700 < *(uint *)(((PLANET *)lppl)->rgwtMin + 1))))) {
            iPacketAdd__330 = iMinLimit._2_2_;
            if (6 < (int)iMinLimit._2_2_) {
              iPacketAdd__330 = 7;
            }
            AddItemToQueue(0xf,iPacketAdd__330,grobjPlanet,0);
            iMinLimit = (uint *)CONCAT22(iMinLimit._2_2_ - iPacketAdd__330,(uint *)iMinLimit);
            *(uint *)CONCAT22((uint)uStack_150,cResLeft) =
                 *(uint *)CONCAT22((uint)uStack_150,cResLeft) & 0xfdff;
            fWrite = 1;
          }
        }
        uVar9 = (undefined2)((ulong)lpplDst >> 0x10);
        iVar3 = *(int *)((int)((PLANET *)lpplDst)->rgwtMin + 10);
        if ((iVar3 <= (int)(uint *)iMinLimit >> 0xf) &&
           ((iVar3 < (int)(uint *)iMinLimit >> 0xf ||
            (*(uint **)(((PLANET *)lpplDst)->rgwtMin + 2) < (uint *)iMinLimit)))) {
          uVar9 = (undefined2)((ulong)lppl >> 0x10);
          iVar3 = *(int *)((int)((PLANET *)lppl)->rgwtMin + 10);
          if ((-1 < iVar3) && ((0 < iVar3 || (700 < *(uint *)(((PLANET *)lppl)->rgwtMin + 2))))) {
            iPacketAdd__330 = iMinLimit._2_2_;
            if (6 < (int)iMinLimit._2_2_) {
              iPacketAdd__330 = 7;
            }
            AddItemToQueue(0x10,iPacketAdd__330,grobjPlanet,0);
            iMinLimit = (uint *)CONCAT22(iMinLimit._2_2_ - iPacketAdd__330,(uint *)iMinLimit);
            *(uint *)CONCAT22((uint)uStack_150,cResLeft) =
                 *(uint *)CONCAT22((uint)uStack_150,cResLeft) & 0xfbff;
            fWrite = 1;
          }
        }
        if (fWrite != 0) {
          sVar6 = IWarpMAFromLppl(lppl,&fTwoMA);
          iVar3 = sVar6 + -4;
          if (fTwoMA != 0) {
            iVar3 = sVar6 + -3;
          }
          dDistance = (double)CONCAT26(iVar3,(undefined6)dDistance);
          sVar6 = IWarpMAFromLppl(lpplDst,&fTwoMA);
          uVar7 = sVar6 - 4;
          if (fTwoMA != 0) {
            uVar7 = sVar6 - 3;
          }
          uVar4 = dDistance._6_2_;
          if ((int)uVar7 <= (int)dDistance._6_2_) {
            uVar4 = uVar7;
          }
          uVar5 = lpplDst->id + 1;
          dDistance = (double)CONCAT44(CONCAT22(dDistance._6_2_,uVar7),
                                       CONCAT22(uVar5,(undefined2)dDistance));
          sel.pl.wFlags =
               sel.pl.wFlags & 0xc000U | (uVar4 & 0xf) << 10 | uVar5 & 0x3ff;
          FLookupPlanet(-1,(PLANET *)&sel.pl);
        }
      }
      else {
LAB_10a8_1fa3:
        if (((uint)lpciPlan->wInfo >> 7 & 1) == 0) {
          if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) < 2) {
            if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) == 1
               ) {
              sVar6 = Random(3);
              if (sVar6 == 0) goto LAB_10a8_200b;
            }
          }
          else {
LAB_10a8_200b:
            iMinLimit = (uint *)CONCAT22(vlpbAiData._2_2_,
                                         (byte *)vlpbAiData +
                                         game.cPlanMax * 2 + dOffsetPlanTemp);
            bVar10 = rgResAvail[0] < rgResCost;
            rgResAvail[0] = rgResAvail[0] - rgResCost;
            rgResAvail[1] = (rgResAvail[1] - local_14) - (uint)bVar10;
            bVar10 = rgResAvail[2] < local_12;
            rgResAvail[2] = rgResAvail[2] - local_12;
            rgResAvail[3] = (rgResAvail[3] - local_10) - (uint)bVar10;
            bVar10 = local_1e < local_e;
            local_1e = local_1e - local_e;
            local_1c = (local_1c - local_c) - (uint)bVar10;
            uVar7 = (rgResAvail[0] - 0x46) + (rgResAvail[2] - 0x46);
            uStack_150._0_2_ = uVar7 + (local_1e - 0x46);
            uStack_150._2_2_ =
                 (byte *)(rgResAvail[1] + (0x45 < rgResAvail[0]) +
                          rgResAvail[3] + (0x45 < rgResAvail[2]) +
                          (uint)CARRY2(rgResAvail[0] - 0x46,rgResAvail[2] - 0x46) +
                          local_1c + -3 + (uint)(0x45 < local_1e) +
                         (uint)CARRY2(uVar7,local_1e - 0x46));
            puVar12 = (uint *)__aFldiv(CONCAT22(local_18,local_1a),2);
            cResLeft = (uint *)puVar12;
            lPackets = ((int)cResLeft + -5) / 5;
            iPacketAdd__330 = lPackets >> 0xf;
            uVar13 = __aFulmul((long)lPackets,0x46);
            if (CONCAT22(uStack_150._2_2_,(uint)uStack_150) < (long)uVar13) {
              uVar13 = CONCAT22(uStack_150._2_2_,(uint)uStack_150);
            }
            else {
              uVar13 = __aFulmul(CONCAT22(iPacketAdd__330,lPackets),0x46);
            }
            *iMinLimit = (uint)uVar13;
            ((uint *)iMinLimit)[1] = (uint)(uVar13 >> 0x10);
            if (((int)uStack_150._2_2_ < 0) ||
               (((int)uStack_150._2_2_ < 1 && ((uint)uStack_150 < 0x97)))) {
              lpplDst = (PLANET *)0x0;
            }
            else {
              lpplDst = LpplFindClosestEnum(lppl,FEnumPktAttack);
            }
            if (((PLANET *)lpplDst != (PLANET *)0x0) || (lpplDst._2_2_ != 0)) {
              cPacket[0] = 0;
              cPacket[1] = 0;
              cPacket[2] = 0;
              lpciPlanDst = (CYBERINFO *)
                            CONCAT22(vlpbAiData._2_2_,
                                     (CYBERINFO *)((byte *)vlpbAiData + lpplDst->id * 2 + 2))
              ;
              if (((uint)((PLANET *)lpplDst)->wFlags >> 9 & 1) == 0) {
                iWarpDst = 0;
              }
              else {
                iWarpDst = IWarpMAFromLppl(lpplDst,&fTwoMA);
                if (fTwoMA != 0) {
                  iWarpDst = iWarpDst + 1;
                }
              }
              sVar6 = IWarpMAFromLppl(lppl,&fTwoMA);
              iWarp = sVar6 + 3;
              dDistance = (double)(long)(iWarp * iWarp);
              dVar2 = DGetDistance(((POINT *)rgptPlan + lppl->id)->x,
                                         *(short *)((int)&rgptPlan[0].y + lppl->id * 4),
                                         ((POINT *)rgptPlan + lpplDst->id)->x,
                                         *(short *)((int)&rgptPlan[0].y + lpplDst->id * 4)
                                        );
              dVar1 = *(double *)CONCAT11(extraout_AH,dVar2);
              uVar9 = (undefined2)((ulong)lpplDst >> 0x10);
              pPVar8 = (PLANET *)lpplDst;
              local_188._2_2_ = 0;
              local_188._0_2_ =
                   (iWarp * iWarp - iWarpDst * iWarpDst) *
                   (100 - (((uint)pPVar8->uGuesses >> 0xc) + 5));
              dMod = (double)local_188._0_4_ / DOUBLE_16000_0__1120_1e2e;
              if (((pPVar8->uGuesses & 0xfffU) + 0x19) * 4 < 0x3e9) {
                in_stack_0000fe72 = ((pPVar8->uGuesses & 0xfffU) + 0x19) * 4;
                in_stack_0000fe74 = 0;
              }
              lVar14 = __ftol((double)CONCAT26(in_stack_0000fe74,
                                                       CONCAT24(in_stack_0000fe72,
                                                                CONCAT22(unaff_SI,unaff_DI))));
              lVar11 = CONCAT22(uStack_150._2_2_,(uint)uStack_150);
              if (lVar14 < lVar11) {
                lVar11 = lVar14;
              }
              uStack_150 = lVar11;
              if (fTwoMA == 0) {
                dVar1 = dVar1 / dDistance;
                _pow(SUB84(DOUBLE_0_75__1120_1e3e,0),
                             (double)CONCAT26((int)((qword)dVar1 >> 0x10),
                                              CONCAT24(SUB82(dVar1,0),
                                                       (long)((qword)DOUBLE_0_75__1120_1e3e >> 0x20)
                                                      )),
                             (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20
                                                                               ))));
                lVar14 = __ftol((double)CONCAT26(in_stack_0000fe74,
                                                         CONCAT24(in_stack_0000fe72,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                uStack_150 = lVar14;
              }
              else {
                dVar1 = dVar1 / dDistance;
                _pow(SUB84(DOUBLE_0_875__1120_1e36,0),
                             (double)CONCAT26((int)((qword)dVar1 >> 0x10),
                                              CONCAT24(SUB82(dVar1,0),
                                                       (long)((qword)DOUBLE_0_875__1120_1e36 >> 0x20
                                                             ))),
                             (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20
                                                                               ))));
                lVar14 = __ftol((double)CONCAT26(in_stack_0000fe74,
                                                         CONCAT24(in_stack_0000fe72,
                                                                  CONCAT22(unaff_SI,unaff_DI))));
                uStack_150 = lVar14;
              }
              local_188._0_10_ = (unkbyte10)lVar11;
              while (uStack_150 = lVar14, 0 < lVar14) {
                local_188._8_2_ = 0;
                if (((int)rgResAvail[1] <= (int)rgResAvail[3]) &&
                   (((int)rgResAvail[1] < (int)rgResAvail[3] || (rgResAvail[0] < rgResAvail[2])))) {
                  local_188._8_2_ = 1;
                }
                if (((int)rgResAvail[local_188._8_2_ * 2 + 1] <= local_1c) &&
                   (((int)rgResAvail[local_188._8_2_ * 2 + 1] < local_1c ||
                    (rgResAvail[local_188._8_2_ * 2] < local_1e)))) {
                  local_188._8_2_ = 2;
                }
                cPacket[local_188._8_2_] = cPacket[local_188._8_2_] + 1;
                puVar12 = rgResAvail + local_188._8_2_ * 2;
                uVar7 = *puVar12;
                *puVar12 = *puVar12 - 0x46;
                rgResAvail[local_188._8_2_ * 2 + 1] =
                     rgResAvail[local_188._8_2_ * 2 + 1] - (uint)(uVar7 < 0x46);
                bVar10 = (uint)uStack_150 < 0x46;
                uStack_150._0_2_ = (uint)uStack_150 - 0x46;
                uStack_150._2_2_ = (byte *)((int)uStack_150._2_2_ - (uint)bVar10);
                lVar14 = CONCAT22(uStack_150._2_2_,(uint)uStack_150);
              }
              if (0 < (int)cPacket[0]) {
                AddItemToQueue(0xe,cPacket[0],grobjPlanet,0);
                lVar14 = uStack_150;
              }
              if (0 < (int)cPacket[1]) {
                uStack_150 = lVar14;
                AddItemToQueue(0xf,cPacket[1],grobjPlanet,0);
                lVar14 = uStack_150;
              }
              if (0 < (int)cPacket[2]) {
                uStack_150 = lVar14;
                AddItemToQueue(0x10,cPacket[2],grobjPlanet,0);
                lVar14 = uStack_150;
              }
              sel.pl.wFlags =
                   sel.pl.wFlags & 0xc000U | (iWarp - 4U & 0xf) << 10 |
                   lpplDst->id + 1U & 0x3ff;
              uStack_150 = lVar14;
              FLookupPlanet(-1,(PLANET *)&sel.pl);
              bVar10 = false;
              lpciPlanDst->wInfo = lpciPlanDst->wInfo & 0xff9fU | 0x60;
              __aFfcompp();
              if (bVar10) {
                lpciPlan->wInfo = lpciPlan->wInfo & 0xff7fU | 0x80;
              }
              lpciPlan->wInfo = lpciPlan->wInfo & 0xffef;
              fWrite = 1;
              goto AI4_LFinish;
            }
          }
        }
        if ((((uint)lpciPlan->wInfo >> 4 & 1) == 0) || (((uint)lpciPlan->wInfo >> 7 & 1) != 0)) {
          if (((uint)lpciPlan->wInfo >> 7 & 1) == 0) {
            i = Random(7);
            if (i == (lpciPlan->wInfo & 7U)) {
              iMinLimit = (uint *)CONCAT22(i + 1U,(uint *)iMinLimit);
              lpciPlan->wInfo = lpciPlan->wInfo & 0xfff8U | i + 1U & 7;
            }
            else {
              lpciPlan->wInfo = lpciPlan->wInfo & 0xfff8U | i & 7U;
            }
            idPlanDst = IdGetBestScannerDest(lppl,lpciPlan->wInfo & 7);
          }
          if ((((uint)lpciPlan->wInfo >> 7 & 1) != 0) || (idPlanDst != -1)) {
            iMinLimit = (uint *)CONCAT22(vlpbAiData._2_2_,
                                         (byte *)vlpbAiData + idPlanDst * 2 + 2);
            if ((*iMinLimit >> 5 & 3) == 0) {
              sVar6 = FAddPacketToQueue(lppl);
              if (sVar6 == 0) goto LAB_10a8_276c;
              *iMinLimit = *iMinLimit & 0xff9f | 0x60;
              iPacketAdd__330 = (short)(((uint)lpciPlan->wInfo >> 7 & 1) == 0);
              lpciPlan->wInfo = lpciPlan->wInfo & 0xffefU | iPacketAdd__330 << 4;
              fWrite = 1;
            }
            else {
LAB_10a8_276c:
              lpciPlan->wInfo = lpciPlan->wInfo & 0xffef;
            }
            sVar6 = IWarpMAFromLppl(lppl,&fTwoMA);
            iWarp = sVar6 - 1;
            uVar7 = (iWarp & 0xfU) << 10;
            if (((uint)lpciPlan->wInfo >> 7 & 1) == 0) {
              sel.pl.wFlags =
                   sel.pl.wFlags & 0xc000U | uVar7 | idPlanDst & 0x3ffU;
            }
            else {
              sel.pl.wFlags = sel.pl.wFlags & 0xc3ffU | uVar7;
              lpciPlan->wInfo = lpciPlan->wInfo & 0xff7f;
            }
            FLookupPlanet(-1,(PLANET *)&sel.pl);
          }
        }
        else {
          lpciPlan->wInfo = lpciPlan->wInfo & 0xffef;
        }
      }
AI4_LFinish:
      FinishProduction(fWrite);
    }
    ipl = ipl + 1;
  } while( true );
}



// ======================================================================
// Function: IdGetBestScannerDest
// Address: 10a8:282a
// Segment: MEMORY_AI4
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10a82b98) */

short IdGetBestScannerDest(PLANET *lppl,short iDir)

{
  POINT pt;
  POINT pt1;
  POINT pt2;
  int iVar1;
  short sVar2;
  int iVar3;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar4;
  SCAN scan;
  int ptEdge;
  int local_12;
  short iSize;
  short dAdjust;
  PLANET *lpplDst;
  short iWarp;
  short iDistance;
  
  ptEdge = ((POINT *)rgptPlan + lppl->id)->x;
  local_12 = *(int *)((int)&rgptPlan[0].y + lppl->id * 4);
  iSize = game.mdSize * 400 + 400;
  sVar2 = IWarpMAFromLppl(lppl,(short *)0x0);
  iWarp = sVar2 + 3;
  iDistance = iWarp * iWarp;
  ptEdge = ptEdge + -1000;
  local_12 = local_12 + -1000;
  switch(iDir) {
  case 0:
    ptEdge = iSize;
    break;
  case 1:
    if (local_12 < iSize - ptEdge) {
      ptEdge = ptEdge + local_12;
      local_12 = 0;
    }
    else {
      local_12 = local_12 - (iSize - ptEdge);
      ptEdge = iSize;
    }
    break;
  case 2:
    local_12 = 0;
    break;
  case 3:
    if (local_12 < ptEdge) {
      ptEdge = ptEdge - local_12;
      local_12 = 0;
    }
    else {
      local_12 = local_12 - ptEdge;
      ptEdge = 0;
    }
    break;
  case 4:
    ptEdge = 0;
    break;
  case 5:
    if (local_12 < iSize - ptEdge) {
      local_12 = local_12 + ptEdge;
      ptEdge = 0;
    }
    else {
      ptEdge = ptEdge - (iSize - local_12);
      local_12 = iSize;
    }
    break;
  case 6:
    local_12 = iSize;
    break;
  case 7:
    if (local_12 < ptEdge) {
      local_12 = local_12 + (iSize - ptEdge);
      ptEdge = iSize;
    }
    else {
      ptEdge = ptEdge + (iSize - local_12);
      local_12 = iSize;
    }
    break;
  default:
    return -1;
  }
  lVar4 = __ftol((double)CONCAT26(iSize >> 0xf,CONCAT24(iSize,CONCAT22(unaff_SI,unaff_DI))))
  ;
  dAdjust = Random((short)lVar4);
  lVar4 = __ftol((double)CONCAT26(iSize >> 0xf,CONCAT24(iSize,CONCAT22(unaff_SI,unaff_DI))))
  ;
  iVar3 = dAdjust - (int)lVar4;
  if ((ptEdge == 0) || (ptEdge == iSize)) {
    local_12 = local_12 + iVar3;
    if (iSize < local_12) {
      dAdjust = local_12 - iSize;
      local_12 = iSize;
    }
    else if (local_12 < 0) {
      dAdjust = -local_12;
      local_12 = 0;
    }
    else {
      dAdjust = 0;
    }
    iVar3 = dAdjust;
    if (ptEdge != 0) {
      iVar3 = -dAdjust;
    }
    ptEdge = ptEdge + iVar3;
  }
  else {
    ptEdge = ptEdge + iVar3;
    if (iSize < ptEdge) {
      dAdjust = ptEdge - iSize;
      ptEdge = iSize;
    }
    else if (ptEdge < 0) {
      dAdjust = -ptEdge;
      ptEdge = 0;
    }
    else {
      dAdjust = 0;
    }
    if (local_12 == 0) {
      local_12 = dAdjust;
    }
    else {
      local_12 = local_12 - dAdjust;
    }
  }
  dAdjust = Random(iDistance);
  iVar3 = ptEdge;
  iVar1 = dAdjust;
  if (local_12 != 0) {
    if (local_12 == iSize) {
      iVar1 = local_12 - dAdjust;
    }
    else {
      iVar3 = dAdjust;
      iVar1 = local_12;
      if ((ptEdge != 0) && (iVar3 = ptEdge, ptEdge == iSize)) {
        iVar3 = ptEdge - dAdjust;
      }
    }
  }
  local_12 = iVar1;
  ptEdge = iVar3;
  local_12 = local_12 + 1000;
  ptEdge = ptEdge + 1000;
  pt.y = local_12;
  pt.x = ptEdge;
  sVar2 = FFindNearestObject(pt,0x21,&scan);
  if (sVar2 == 0) {
    scan.idpl = -1;
  }
  else {
    lpplDst = LpplFromId(scan.idpl);
    iVar3 = (int)((ulong)lpplDst >> 0x10);
    if (((((PLANET *)lpplDst == (PLANET *)0x0) && (iVar3 == 0)) ||
        (((PLANET *)lpplDst)->iPlayer != idPlayer)) &&
       (pt1.y = *(short *)((int)&rgptPlan[0].y + scan.idpl * 4),
       pt1.x = ((POINT *)rgptPlan + scan.idpl)->x,
       pt2.y = *(short *)((int)&rgptPlan[0].y + lppl->id * 4),
       pt2.x = ((POINT *)rgptPlan + lppl->id)->x, lVar4 = LDistance2(pt1,pt2),
       iDistance * iDistance <= lVar4)) {
      scan.idpl = scan.idpl + 1;
    }
    else {
      scan.idpl = -1;
    }
  }
  return scan.idpl;
}



// ======================================================================
// Function: FAddPacketToQueue
// Address: 10a8:2bc0
// Segment: MEMORY_AI4
// ======================================================================


short FAddPacketToQueue(PLANET *lppl)

{
  short sVar1;
  int iVar2;
  int iVar3;
  uint rgResAvail [4];
  uint local_1e;
  int local_1c;
  short iMineral;
  uint rgResCost [4];
  uint local_c;
  int local_a;
  
  iMineral = 0;
  GetResourcesAvailable(lppl,(long *)rgResAvail);
  GetProdQCost(lppl,(long *)rgResCost);
  iVar2 = (rgResAvail[iMineral * 2 + 1] - rgResCost[iMineral * 2 + 1]) -
          (uint)(rgResAvail[iMineral * 2] < rgResCost[iMineral * 2]);
  iVar3 = (rgResAvail[3] - rgResCost[3]) - (uint)(rgResAvail[2] < rgResCost[2]);
  if ((iVar2 <= iVar3) &&
     ((iVar2 < iVar3 ||
      (rgResAvail[iMineral * 2] - rgResCost[iMineral * 2] < rgResAvail[2] - rgResCost[2])))) {
    iMineral = 1;
  }
  iVar2 = (rgResAvail[iMineral * 2 + 1] - rgResCost[iMineral * 2 + 1]) -
          (uint)(rgResAvail[iMineral * 2] < rgResCost[iMineral * 2]);
  iVar3 = (local_1c - local_a) - (uint)(local_1e < local_c);
  if ((iVar2 <= iVar3) &&
     ((iVar2 < iVar3 || (rgResAvail[iMineral * 2] - rgResCost[iMineral * 2] < local_1e - local_c))))
  {
    iMineral = 2;
  }
  iVar2 = (rgResAvail[iMineral * 2 + 1] - rgResCost[iMineral * 2 + 1]) -
          (uint)(rgResAvail[iMineral * 2] < rgResCost[iMineral * 2]);
  if ((iVar2 < 0) || ((iVar2 < 1 && (rgResAvail[iMineral * 2] - rgResCost[iMineral * 2] < 0xaa)))) {
    sVar1 = 0;
  }
  else {
    AddItemToQueue(iMineral + 0xe,1,grobjPlanet,0);
    sVar1 = 1;
  }
  return sVar1;
}



// ======================================================================
// Function: FillProductionQueue
// Address: 10a8:2ce2
// Segment: MEMORY_AI4
// ======================================================================


void FillProductionQueue(void)

{
  PLANET *pPVar1;
  int iVar2;
  short fWrite;
  PROD rgprod [64];
  short ipl;
  PLANET *lppl;
  
  ipl = 0;
  while( true ) {
    if (vclpplAi <= ipl) {
      return;
    }
                    /* WARNING: Load size is inaccurate */
    pPVar1 = ((PLANET **)vrglpplAi)[ipl];
    iVar2 = *(int *)((int)((PLANET **)vrglpplAi + ipl) + 2);
    lppl = (PLANET *)CONCAT22(iVar2,pPVar1);
    if ((pPVar1 == (PLANET *)0x0) && (iVar2 == 0)) break;
    ChangeMainObjSel(1,lppl->id);
    InitProduction(rgprod);
    fWrite = FFillProdMinesAndFactories(lppl);
    FinishProduction(fWrite);
    ipl = ipl + 1;
  }
  return;
}



// ======================================================================
// Function: FFillProdMinesAndFactories
// Address: 10a8:2d72
// Segment: MEMORY_AI4
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10a83333) */
/* WARNING: Removing unreachable block (ram,0x10a83088) */
/* WARNING: Removing unreachable block (ram,0x10a82fba) */
/* WARNING: Removing unreachable block (ram,0x10a82ed5) */
/* WARNING: Removing unreachable block (ram,0x10a82ead) */
/* WARNING: Removing unreachable block (ram,0x10a82f38) */
/* WARNING: Removing unreachable block (ram,0x10a82f8a) */
/* WARNING: Removing unreachable block (ram,0x10a83156) */
/* WARNING: Removing unreachable block (ram,0x10a832eb) */
/* WARNING: Removing unreachable block (ram,0x10a82f10) */
/* WARNING: Removing unreachable block (ram,0x10a831b1) */

short FFillProdMinesAndFactories(PLANET *lppl)

{
  uint uVar1;
  uint uVar2;
  uint uVar3;
  uint uVar4;
  short sVar5;
  short sVar6;
  int iVar7;
  PLPROD *pPVar8;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar9;
  bool bVar10;
  bool bVar11;
  ulong uVar12;
  ulong uVar13;
  long lVar14;
  ushort in_stack_0000ff7c;
  short cAdd;
  PROD *lpprod;
  short fInsert;
  short iMaxMines;
  short iMaxFactBuildable;
  short iMaxFactories;
  short i;
  short iMaxTerra;
  short iAddAlchemy;
  int rgResLeft [4];
  int local_64;
  int local_62;
  uint local_60;
  int local_5e;
  undefined2 rgFactCost;
  undefined2 local_5a;
  undefined2 local_58;
  undefined2 local_56;
  undefined2 local_54;
  undefined2 local_52;
  undefined2 local_50;
  undefined2 local_4e;
  ulong rgMineCost [3];
  undefined2 local_40;
  undefined2 local_3e;
  ulong rgAlchCost [3];
  int local_30;
  int local_2e;
  short prod;
  undefined2 local_2a;
  short iAddMines;
  short iAddFactories;
  uint rgResAvail [8];
  uint rgResCost [9];
  
  uVar13 = CONCAT22(unaff_SI,unaff_DI);
  bVar10 = false;
  GetResourcesAvailable(lppl,(long *)rgResAvail);
  GetProdQCost(lppl,(long *)rgResCost);
  for (i = 0; i < 4; i = i + 1) {
    uVar4 = rgResAvail[i * 2];
    uVar1 = rgResAvail[i * 2 + 1];
    uVar2 = rgResCost[i * 2];
    uVar3 = rgResCost[i * 2 + 1];
    rgResLeft[i * 2] = uVar4 - rgResCost[i * 2];
    rgResLeft[i * 2 + 1] = (uVar1 - uVar3) - (uint)(uVar4 < uVar2);
  }
  if ((local_5e < 1) && (local_5e < 0)) {
    uVar4 = 0;
  }
  else {
    iMaxTerra = 0;
    iMaxMines = 0;
    iAddMines = 0;
    iMaxFactories = 0;
    iAddFactories = 0;
    local_40 = 0;
    local_3e = 0;
    local_50 = 0;
    local_4e = 0;
    local_30 = 0;
    local_2e = 0;
    lpprod = (PROD *)CONCAT22(lpplProdGlob._2_2_,(PLPROD *)lpplProdGlob + 1);
    for (i = 0; iVar7 = cProdGlob,
        i < (int)(uint)((PLPROD *)lpplProdGlob)->iprodMac; i = i + 1) {
      uVar12 = __aFulshr(uVar13,in_stack_0000ff7c);
      if ((((uint)uVar12 & 7) == 1) &&
         (uVar12 = __aFulshr(uVar13,in_stack_0000ff7c), ((uint)uVar12 & 0x7f) == 8)) {
        iAddMines = iAddMines + ((uint)lpprod->dwFlags & 0x3ff);
      }
      uVar12 = __aFulshr(uVar13,in_stack_0000ff7c);
      if ((((uint)uVar12 & 7) == 1) &&
         (uVar12 = __aFulshr(uVar13,in_stack_0000ff7c), ((uint)uVar12 & 0x7f) == 7)) {
        iAddFactories = iAddFactories + ((uint)lpprod->dwFlags & 0x3ff);
      }
      lpprod = (PROD *)CONCAT22(lpprod._2_2_,(PROD *)lpprod + 1);
    }
    while (i = iVar7 + -1, -1 < i) {
      uVar12 = __aFulshr(uVar13,in_stack_0000ff7c);
      iVar7 = i;
      if (((uint)uVar12 & 7) == 1) {
        uVar12 = __aFulshr(uVar13,in_stack_0000ff7c);
        if (((uint)uVar12 & 0x7f) == 8) {
          sVar5 = CMaxOperableMines(lppl,idPlayer,0);
          sVar6 = CMinesOperating(lppl);
          if ((uint)((sVar5 - sVar6) - iAddMines) < 0x8000) {
            sVar5 = CMaxOperableMines(lppl,idPlayer,0);
            sVar6 = CMinesOperating(lppl);
            iMaxMines = (sVar5 - sVar6) - iAddMines;
          }
          else {
            iMaxMines = 0;
          }
          GetProductionCosts
                    (lppl,(PROD *)(pProdGlob + i),rgMineCost,idPlayer,1);
        }
        uVar12 = __aFulshr(uVar13,in_stack_0000ff7c);
        if (((uint)uVar12 & 0x7f) == 7) {
          sVar5 = CMaxOperableFactories(lppl,idPlayer,0);
          sVar6 = CFactoriesOperating(lppl);
          if ((uint)((sVar5 - sVar6) - iAddFactories) < 0x8000) {
            sVar5 = CMaxOperableFactories(lppl,idPlayer,0);
            sVar6 = CFactoriesOperating(lppl);
            iMaxFactories = (sVar5 - sVar6) - iAddFactories;
          }
          else {
            iMaxFactories = 0;
          }
          GetProductionCosts
                    (lppl,(PROD *)(pProdGlob + i),(ulong *)&rgFactCost,idPlayer,1);
        }
        uVar12 = __aFulshr(uVar13,in_stack_0000ff7c);
        if (((uint)uVar12 & 0x7f) == 0xb) {
          GetProductionCosts
                    (lppl,(PROD *)(pProdGlob + i),rgAlchCost,idPlayer,1);
        }
        uVar12 = __aFulshr(uVar13,in_stack_0000ff7c);
        if (((uint)uVar12 & 0x7f) == 0xc) {
          iMaxTerra = (uint)(pProdGlob + i)->dwFlags & 0x3ff;
        }
      }
    }
    if ((iMaxTerra != 0) &&
       (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 0xd == 5)) {
      lVar14 = __aFldiv(CONCAT22(local_5e + (uint)(0xffba < local_60),local_60 + 0x45),0x46)
      ;
      cAdd = (short)lVar14;
      if (iMaxTerra < cAdd) {
        cAdd = iMaxTerra;
      }
      if (0 < cAdd) {
        AddItemToQueue(0xc,cAdd,grobjPlanet,0);
        return 1;
      }
    }
    if (((rgResLeft[1] < 0) ||
        ((((rgResLeft[1] < 1 && (rgResLeft[0] == 0)) || (rgResLeft[3] < 0)) ||
         ((rgResLeft[3] < 1 && (rgResLeft[2] == 0)))))) ||
       ((local_62 < 1 && ((local_62 < 0 || (local_64 == 0)))))) {
      if ((*(int *)&((PLANET *)lppl)->lpplprod != 0) ||
         (*(int *)((int)&((PLANET *)lppl)->lpplprod + 2) != 0)) {
        uVar9 = (undefined2)((ulong)((PLANET *)lppl)->lpplprod >> 0x10);
        pPVar8 = (PLPROD *)((PLANET *)lppl)->lpplprod;
        prod = (pPVar8 + 1)->wFlags;
        local_2a = *(undefined2 *)&pPVar8[1].iprodMax;
        uVar12 = __aFulshr(uVar13,in_stack_0000ff7c);
        if ((((uint)uVar12 & 7) == 1) &&
           ((uVar12 = __aFulshr(uVar13,in_stack_0000ff7c), ((uint)uVar12 & 0x7f) == 3 ||
            (uVar13 = __aFulshr(uVar13,in_stack_0000ff7c), ((uint)uVar13 & 0x7f) == 0xb))))
        {
          return 0;
        }
      }
      if (iMaxMines < 1) {
        iAddMines = 0;
        sVar5 = iAddMines;
      }
      else {
        lVar14 = __aFldiv(CONCAT22(local_5e,local_60),CONCAT22(local_3e,local_40));
        sVar5 = iMaxMines;
        if ((int)lVar14 <= iMaxMines) {
          lVar14 = __aFldiv(CONCAT22(local_5e,local_60),CONCAT22(local_3e,local_40));
          sVar5 = (short)lVar14;
        }
      }
      iAddMines = sVar5;
      uVar13 = __aFulmul((long)iAddMines,CONCAT22(local_3e,local_40));
      bVar10 = local_60 < (uint)uVar13;
      local_60 = local_60 - (uint)uVar13;
      local_5e = (local_5e - (int)(uVar13 >> 0x10)) - (uint)bVar10;
      iAddFactories = 0;
      bVar10 = true;
    }
    else {
      if (0 < iMaxFactories) {
        if (((uint)gd._0_2_ >> 0xb & 1) == 0) {
          lVar14 = __aFldiv(CONCAT22(local_62,local_64),CONCAT22(local_52,local_54));
          if ((int)lVar14 <= iMaxFactories) {
            lVar14 = __aFldiv(CONCAT22(local_62,local_64),CONCAT22(local_52,local_54));
            iMaxFactories = (short)lVar14;
          }
        }
        else {
          lVar14 = __aFldiv(CONCAT22(rgResLeft[1],rgResLeft[0]),
                                    CONCAT22(local_5a,rgFactCost));
          iVar7 = iMaxFactories;
          if ((int)lVar14 <= iMaxFactories) {
            lVar14 = __aFldiv(CONCAT22(rgResLeft[1],rgResLeft[0]),
                                      CONCAT22(local_5a,rgFactCost));
            iVar7 = (int)lVar14;
          }
          lVar14 = __aFldiv(CONCAT22(rgResLeft[3],rgResLeft[2]),CONCAT22(local_56,local_58))
          ;
          if (iVar7 < (int)lVar14) {
            lVar14 = __aFldiv(CONCAT22(rgResLeft[1],rgResLeft[0]),
                                      CONCAT22(local_5a,rgFactCost));
            iVar7 = iMaxFactories;
            if ((int)lVar14 <= iMaxFactories) {
              lVar14 = __aFldiv(CONCAT22(rgResLeft[1],rgResLeft[0]),
                                        CONCAT22(local_5a,rgFactCost));
              iVar7 = (int)lVar14;
            }
          }
          else {
            lVar14 = __aFldiv(CONCAT22(rgResLeft[3],rgResLeft[2]),
                                      CONCAT22(local_56,local_58));
            iVar7 = (int)lVar14;
          }
          lVar14 = __aFldiv(CONCAT22(local_62,local_64),CONCAT22(local_52,local_54));
          if (iVar7 < (int)lVar14) {
            lVar14 = __aFldiv(CONCAT22(rgResLeft[1],rgResLeft[0]),
                                      CONCAT22(local_5a,rgFactCost));
            iVar7 = iMaxFactories;
            if ((int)lVar14 <= iMaxFactories) {
              lVar14 = __aFldiv(CONCAT22(rgResLeft[1],rgResLeft[0]),
                                        CONCAT22(local_5a,rgFactCost));
              iVar7 = (int)lVar14;
            }
            lVar14 = __aFldiv(CONCAT22(rgResLeft[3],rgResLeft[2]),
                                      CONCAT22(local_56,local_58));
            if (iVar7 < (int)lVar14) {
              lVar14 = __aFldiv(CONCAT22(rgResLeft[1],rgResLeft[0]),
                                        CONCAT22(local_5a,rgFactCost));
              if ((int)lVar14 <= iMaxFactories) {
                lVar14 = __aFldiv(CONCAT22(rgResLeft[1],rgResLeft[0]),
                                          CONCAT22(local_5a,rgFactCost));
                iMaxFactories = (short)lVar14;
              }
            }
            else {
              lVar14 = __aFldiv(CONCAT22(rgResLeft[3],rgResLeft[2]),
                                        CONCAT22(local_56,local_58));
              iMaxFactories = (short)lVar14;
            }
          }
          else {
            lVar14 = __aFldiv(CONCAT22(local_62,local_64),CONCAT22(local_52,local_54));
            iMaxFactories = (short)lVar14;
          }
        }
      }
      if (iMaxFactories < 1) {
        iAddFactories = 0;
        sVar5 = iAddFactories;
      }
      else {
        lVar14 = __aFldiv(CONCAT22(local_5e,local_60),CONCAT22(local_4e,local_50));
        sVar5 = iMaxFactories;
        if ((int)lVar14 <= iMaxFactories) {
          lVar14 = __aFldiv(CONCAT22(local_5e,local_60),CONCAT22(local_4e,local_50));
          sVar5 = (short)lVar14;
        }
      }
      iAddFactories = sVar5;
      uVar13 = __aFulmul((long)iAddFactories,CONCAT22(local_4e,local_50));
      bVar11 = local_60 < (uint)uVar13;
      local_60 = local_60 - (uint)uVar13;
      local_5e = (local_5e - (int)(uVar13 >> 0x10)) - (uint)bVar11;
      if (iMaxMines < 1) {
        iAddMines = 0;
        sVar5 = iAddMines;
      }
      else {
        lVar14 = __aFldiv(CONCAT22(local_5e,local_60),CONCAT22(local_3e,local_40));
        sVar5 = iMaxMines;
        if ((int)lVar14 <= iMaxMines) {
          lVar14 = __aFldiv(CONCAT22(local_5e,local_60),CONCAT22(local_3e,local_40));
          sVar5 = (short)lVar14;
        }
      }
      iAddMines = sVar5;
      uVar13 = __aFulmul((long)iAddMines,CONCAT22(local_3e,local_40));
      bVar11 = local_60 < (uint)uVar13;
      local_60 = local_60 - (uint)uVar13;
      local_5e = (local_5e - (int)(uVar13 >> 0x10)) - (uint)bVar11;
    }
    if ((((local_2e < 0) ||
         (((local_2e < 1 && (local_30 == 0)) ||
          (*(char *)((int)rgplr[0].rgTech + 3 + idPlayer * 0xc0) != '\x1a')))) ||
        (((*(char *)((int)rgplr[0].rgTech + 5 + idPlayer * 0xc0) != '\x1a' ||
          (*(char *)((int)rgplr[0].rgTech + idPlayer * 0xc0) != '\x1a')) ||
         (*(char *)((int)rgplr[0].rgTech + 1 + idPlayer * 0xc0) != '\x1a')))) ||
       ((*(char *)((int)rgplr[0].rgTech + 4 + idPlayer * 0xc0) != '\x1a' ||
        (*(char *)((int)rgplr[0].rgTech + 2 + idPlayer * 0xc0) != '\x1a')))) {
      iAddAlchemy = 0;
    }
    else {
      lVar14 = __aFldiv(CONCAT22(local_5e,local_60),CONCAT22(local_2e,local_30));
      if ((int)lVar14 + 1U < 0x8000) {
        lVar14 = __aFldiv(CONCAT22(local_5e,local_60),CONCAT22(local_2e,local_30));
        iAddAlchemy = (int)lVar14 + 1;
      }
      else {
        iAddAlchemy = 0;
      }
    }
    uVar13 = __aFulmul((long)iAddAlchemy,CONCAT22(local_2e,local_30));
    bVar11 = local_60 < (uint)uVar13;
    local_60 = local_60 - (uint)uVar13;
    local_5e = (local_5e - (int)(uVar13 >> 0x10)) - (uint)bVar11;
    if (0 < iAddFactories) {
      AddItemToQueue(7,iAddFactories,grobjPlanet,1);
    }
    if (0 < iAddMines) {
      AddItemToQueue(8,iAddMines,grobjPlanet,0);
    }
    if ((0 < iAddAlchemy) && (100 < (uint)game.turn)) {
      AddItemToQueue(0xb,iAddAlchemy,grobjPlanet,(uint)!bVar10);
    }
    uVar4 = (uint)(0 < iAddMines + iAddFactories + iAddAlchemy);
  }
  return uVar4;
}



// ======================================================================
// Function: DoCyberFreighter
// Address: 10a8:37b0
// Segment: MEMORY_AI4
// ======================================================================


void DoCyberFreighter(FLEET *lpfl,CYBERINFOTEMP *lpciPlanTemp)

{
  ORDER *pOVar1;
  PLORD *pPVar2;
  byte *pbVar3;
  int iVar4;
  POINT pt;
  PLANET *pPVar5;
  uint uVar6;
  short sVar7;
  int iVar8;
  FLEET *pFVar9;
  PLORD *pPVar10;
  ORDER *pOVar11;
  byte *pbVar12;
  undefined2 uVar13;
  undefined2 uVar14;
  SCAN scan;
  short idPlanDst;
  short fDropOff;
  PLANET *lpplCur;
  PLANET *lpplDst;
  ORDER ord;
  
  fDropOff = 0;
  uVar13 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar9 = (FLEET *)lpfl;
  lpplCur = LpplFromId(pFVar9->idPlanet);
  iVar8 = (int)((ulong)lpplCur >> 0x10);
  pPVar5 = (PLANET *)lpplCur;
  if ((pPVar5 == (PLANET *)0x0) && (iVar8 == 0)) {
    pt.y = (pFVar9->pt).y;
    pt.x = (&pFVar9->pt)->x;
    sVar7 = FFindNearestObject(pt,0x21,&scan);
    if (sVar7 == 0) {
      lpplDst = (PLANET *)0x0;
    }
    else {
      lpplDst = LpplFromId(scan.idpl);
    }
  }
  else {
    if (pPVar5->iPlayer == idPlayer) {
      iVar4 = *(int *)((int)pPVar5->rgwtMin + 0xe);
      if ((iVar4 < 0) || ((iVar4 < 1 && (*(uint *)(pPVar5->rgwtMin + 3) < 0x7d1)))) {
        XferAiSupply(1,pFVar9->idPlanet,2,lpfl->id,3,-1000);
        FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
      }
      else {
        XferAiSupply(1,pFVar9->idPlanet,2,lpfl->id,3,1000);
        FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
        fDropOff = 1;
      }
    }
    else if (((pPVar5->iPlayer == -1) ||
             (sVar7 = GetRaceStat((PLAYER *)rgplr + pPVar5->iPlayer,rsMajorAdv),
             sVar7 == raMacintosh)) || (((uint)((PLANET *)lpplCur)->wFlags >> 9 & 1) != 0)) {
      iVar8 = *(int *)((int)pFVar9->rgwtMin + 0xe);
      if ((iVar8 < 0) || ((iVar8 < 1 && ((int)pFVar9->rgwtMin[3] == 0)))) {
        fDropOff = 0;
      }
      else {
        fDropOff = 1;
      }
    }
    else {
      FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
      idPlanDst = lpplCur->id;
      _memset(&ord,0,0x12);
      ord.pt.x = ((POINT *)rgptPlan + idPlanDst)->x;
      ord.pt.y = *(short *)((int)&rgptPlan[0].y + idPlanDst * 4);
      ord.id = idPlanDst;
      ord.wFlags = ord.wFlags & 0xe0f0U | 0x1101;
      ord.txp.rgia[3].wFlags = ord.txp.rgia[3].wFlags & 0xfffU | 0x2000;
      ChangeMainObjSel(2,lpfl->id);
      uVar14 = (undefined2)((ulong)sel.fl.lpplord >> 0x10);
      pPVar10 = (PLORD *)sel.fl.lpplord;
      if (((pPVar10 + 2)->wFlags == idPlanDst) && ((*(uint *)&pPVar10[2].iordMax >> 8 & 0xf) == 1))
      {
        pPVar10 = pPVar10 + 1;
        pOVar11 = &ord;
        for (iVar8 = 9; iVar8 != 0; iVar8 = iVar8 + -1) {
          pPVar2 = pPVar10;
          pPVar10 = (PLORD *)&pPVar10->iordMax;
          pOVar1 = pOVar11;
          pOVar11 = (ORDER *)&(pOVar11->pt).y;
          pPVar2->wFlags = (pOVar1->pt).x;
        }
      }
      else {
        pbVar12 = &pPVar10[5].iordMax;
        pOVar11 = &ord;
        for (iVar8 = 9; iVar8 != 0; iVar8 = iVar8 + -1) {
          pbVar3 = pbVar12;
          pbVar12 = pbVar12 + 2;
          pOVar1 = pOVar11;
          pOVar11 = (ORDER *)&(pOVar11->pt).y;
          *(short *)pbVar3 = (pOVar1->pt).x;
        }
      }
      FLookupFleet(-1,(FLEET *)&sel.fl);
      FMoveToNearestStarbase(lpfl,0);
      FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
    }
    if (fDropOff == 0) {
      lpplDst = LpplFindClosestEnum(lpplCur,FEnumPickUp);
    }
    else {
      lpplDst = LpplFindClosestEnum(lpplCur,FEnumDropOffStage1);
      if (((PLANET *)lpplDst == (PLANET *)0x0) && ((int)((ulong)lpplDst >> 0x10) == 0)) {
        lpplDst = LpplFindClosestEnum(lpplCur,FEnumDropOffStage2);
      }
      if (((PLANET *)lpplDst == (PLANET *)0x0) && (lpplDst._2_2_ == 0)) {
        if (((PLANET *)lpplCur)->iPlayer == idPlayer) {
          XferAiSupply(1,pFVar9->idPlanet,2,lpfl->id,3,-1000);
          FLookupFleet(lpfl->id,(FLEET *)&sel.fl);
          if (((uint)((CYBERINFOTEMP *)lpciPlanTemp + lpplCur->id)->wInfo1 >> 1 & 3) < 3) {
            iVar8 = ((CYBERINFOTEMP *)lpciPlanTemp + lpplCur->id)->wInfo1;
            ((CYBERINFOTEMP *)lpciPlanTemp + lpplCur->id)->wInfo1 =
                 ((CYBERINFOTEMP *)lpciPlanTemp + lpplCur->id)->wInfo1 & 0xfff9;
            ((CYBERINFOTEMP *)lpciPlanTemp + lpplCur->id)->wInfo1 =
                 ((CYBERINFOTEMP *)lpciPlanTemp + lpplCur->id)->wInfo1 | iVar8 + 2U & 6;
          }
        }
      }
      else if (((uint)((CYBERINFOTEMP *)lpciPlanTemp + lpplDst->id)->wInfo1 >> 3 & 3) < 3) {
        iVar8 = ((CYBERINFOTEMP *)lpciPlanTemp + lpplDst->id)->wInfo1;
        ((CYBERINFOTEMP *)lpciPlanTemp + lpplDst->id)->wInfo1 =
             ((CYBERINFOTEMP *)lpciPlanTemp + lpplDst->id)->wInfo1 & 0xffe7;
        ((CYBERINFOTEMP *)lpciPlanTemp + lpplDst->id)->wInfo1 =
             ((CYBERINFOTEMP *)lpciPlanTemp + lpplDst->id)->wInfo1 | iVar8 + 8U & 0x18;
      }
    }
  }
  if (((PLANET *)lpplDst != (PLANET *)0x0) || (lpplDst._2_2_ != 0)) {
    _memset(&ord,0,0x12);
    ord.pt.x = ((POINT *)rgptPlan + lpplDst->id)->x;
    ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplDst->id * 4);
    ord.id = lpplDst->id;
    ord.wFlags = ord.wFlags & 0xe0f0U | 0x1100;
    uVar6 = IFindIdealWarp(lpfl,1);
    ord.wFlags = ord.wFlags & 0xff0fU | (uVar6 & 0xf) << 4;
    sVar7 = FMoveAiFleet(lpfl,&ord,0);
    if (sVar7 != 0) {
      pFVar9->wFlags = pFVar9->wFlags & 0x7fffU | 0x8000;
    }
  }
  return;
}



// ======================================================================
// Function: FEnumDropOffStage1
// Address: 10a8:3d00
// Segment: MEMORY_AI4
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10a83dde) */

short FEnumDropOffStage1(PLANET *lpplSrc,PLANET *lpplTest)

{
  int iVar1;
  int iVar2;
  short sVar3;
  PLANET *pPVar4;
  undefined2 uVar5;
  long lVar6;
  POINT pt1;
  POINT pt2;
  short dOffsetPlanTemp;
  
  iVar2 = game.cPlanMax * 2 + 2;
  if ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar2) >> 3 & 3) == 3) {
    sVar3 = 0;
  }
  else {
    uVar5 = (undefined2)((ulong)lpplTest >> 0x10);
    pPVar4 = (PLANET *)lpplTest;
    if ((((pPVar4->iPlayer == idPlayer) &&
         (iVar1 = *(int *)((int)pPVar4->rgwtMin + 0xe), iVar1 < 1)) &&
        ((iVar1 < 0 || (*(uint *)(pPVar4->rgwtMin + 3) < 200)))) &&
       ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar2) >> 3 & 3) == 0)) {
      pt2.y = *(short *)((int)&rgptPlan[0].y + lpplTest->id * 4);
      pt2.x = ((POINT *)rgptPlan + lpplTest->id)->x;
      pt1.y = *(short *)((int)&rgptPlan[0].y + lpplSrc->id * 4);
      pt1.x = ((POINT *)rgptPlan + lpplSrc->id)->x;
      lVar6 = LDistance2(pt1,pt2);
      if (lVar6 < 0x27101) {
        sVar3 = 1;
      }
      else {
        sVar3 = 0;
      }
    }
    else {
      sVar3 = 0;
    }
  }
  return sVar3;
}



// ======================================================================
// Function: FEnumDropOffStage2
// Address: 10a8:3dfe
// Segment: MEMORY_AI4
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10a83edf) */

short FEnumDropOffStage2(PLANET *lpplSrc,PLANET *lpplTest)

{
  int iVar1;
  uint uVar2;
  PLANET *pPVar3;
  undefined2 uVar4;
  long lVar5;
  POINT pt1;
  POINT pt2;
  short dOffsetPlanTemp;
  
  iVar1 = game.cPlanMax * 2 + 2;
  if ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar1) >> 3 & 3) != 3) {
    uVar4 = (undefined2)((ulong)lpplTest >> 0x10);
    pPVar3 = (PLANET *)lpplTest;
    if (pPVar3->iPlayer == idPlayer) {
      uVar2 = (*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar1) >> 3 & 3) * 0xd2;
      iVar1 = *(int *)((int)pPVar3->rgwtMin + 0xe) +
              (uint)CARRY2(uVar2,*(uint *)(pPVar3->rgwtMin + 3));
      if ((iVar1 < 1) && ((iVar1 < 0 || (uVar2 + *(uint *)(pPVar3->rgwtMin + 3) < 1000)))) {
        pt2.y = *(short *)((int)&rgptPlan[0].y + lpplTest->id * 4);
        pt2.x = ((POINT *)rgptPlan + lpplTest->id)->x;
        pt1.y = *(short *)((int)&rgptPlan[0].y + lpplSrc->id * 4);
        pt1.x = ((POINT *)rgptPlan + lpplSrc->id)->x;
        lVar5 = LDistance2(pt1,pt2);
        if (160000 < lVar5) {
          return 0;
        }
        return 1;
      }
    }
  }
  return 0;
}



// ======================================================================
// Function: FEnumPickUp
// Address: 10a8:3f00
// Segment: MEMORY_AI4
// ======================================================================


short FEnumPickUp(PLANET *lpplSrc,PLANET *lpplTest)

{
  int iVar1;
  short sVar2;
  PLANET *pPVar3;
  undefined2 uVar4;
  
  uVar4 = (undefined2)((ulong)lpplTest >> 0x10);
  pPVar3 = (PLANET *)lpplTest;
  if ((((pPVar3->iPlayer == idPlayer) &&
       (iVar1 = *(int *)((int)pPVar3->rgwtMin + 0xe), -1 < iVar1)) &&
      ((0 < iVar1 || (0x898 < *(uint *)(pPVar3->rgwtMin + 3))))) &&
     (((uint)pPVar3->wFlags >> 9 & 1) != 0)) {
    sVar2 = 1;
  }
  else {
    sVar2 = 0;
  }
  return sVar2;
}



// ======================================================================
// Function: FEnumNeedMinerals
// Address: 10a8:3f5e
// Segment: MEMORY_AI4
// ======================================================================


short FEnumNeedMinerals(PLANET *lpplSrc,PLANET *lpplTest)

{
  int iVar1;
  POINT pt1;
  POINT pt2;
  int iVar2;
  uint uVar3;
  PLANET *pPVar4;
  undefined2 uVar5;
  bool bVar6;
  bool bVar7;
  short dOffsetPlanTemp;
  short iWarpDst;
  short iMinLimit;
  short fTwoMA;
  short iWarpSrc;
  double dDistance;
  
  iVar2 = game.cPlanMax * 2 + 2;
  uVar5 = (undefined2)((ulong)lpplTest >> 0x10);
  if (((((PLANET *)lpplTest)->iPlayer == idPlayer) &&
      (((uint)((PLANET *)lpplTest)->wFlags >> 9 & 1) != 0)) &&
     ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + 2) >> 5 & 3) == 0)) {
    uVar5 = (undefined2)((ulong)lpplSrc >> 0x10);
    pPVar4 = (PLANET *)lpplSrc;
    iVar1 = *(int *)((int)pPVar4->rgwtMin + 2);
    if ((((iVar1 < 0) || ((iVar1 < 1 && (*(uint *)pPVar4->rgwtMin < 0x2bd)))) ||
        ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar2) >> 8 & 1) == 0)) &&
       ((((iVar1 = *(int *)((int)pPVar4->rgwtMin + 6), iVar1 < 0 ||
          ((iVar1 < 1 && (*(uint *)(pPVar4->rgwtMin + 1) < 0x2bd)))) ||
         ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar2) >> 9 & 1) == 0)) &&
        ((iVar1 = *(int *)((int)pPVar4->rgwtMin + 10), iVar1 < 0 ||
         (((iVar1 < 1 && (*(uint *)(pPVar4->rgwtMin + 2) < 0x2bd)) ||
          ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + iVar2) >> 10 & 1) == 0))))))))
    {
      uVar3 = 0;
    }
    else {
      iWarpSrc = IWarpMAFromLppl(lpplSrc,&fTwoMA);
      if (fTwoMA != 0) {
        iWarpSrc = iWarpSrc + 1;
      }
      iWarpDst = IWarpMAFromLppl(lpplTest,&fTwoMA);
      if (fTwoMA != 0) {
        iWarpDst = iWarpDst + 1;
      }
      iVar2 = iWarpSrc;
      if (iWarpDst <= iWarpSrc) {
        iVar2 = iWarpDst;
      }
      dDistance = DOUBLE_3_5__1120_1e56 * (double)(long)iVar2 * (double)(long)iVar2;
      pt1.y = *(short *)((int)&rgptPlan[0].y + lpplSrc->id * 4);
      pt1.x = ((POINT *)rgptPlan + lpplSrc->id)->x;
      pt2.y = *(short *)((int)&rgptPlan[0].y + lpplTest->id * 4);
      pt2.x = ((POINT *)rgptPlan + lpplTest->id)->x;
      LDistance2(pt1,pt2);
      bVar6 = (undefined1 *)0xfff7 < &stack0xffc4;
      bVar7 = &stack0x0000 == (undefined1 *)((int)(ulong *)rgcrPlrHistory + 6);
      __aFfcompp();
      uVar3 = (uint)(bVar6 || bVar7);
    }
  }
  else {
    uVar3 = 0;
  }
  return uVar3;
}



// ======================================================================
// Function: FEnumPktAttack
// Address: 10a8:4204
// Segment: MEMORY_AI4
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10a84586) */

short FEnumPktAttack(PLANET *lpplSrc,PLANET *lpplTest)

{
  double dVar1;
  double dVar2;
  short sVar3;
  undefined1 extraout_AH;
  PLANET *pPVar4;
  int iVar5;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  undefined2 uVar6;
  bool bVar7;
  bool bVar8;
  long lVar9;
  long lVar10;
  int in_stack_0000ffbc;
  undefined2 in_stack_0000ffbe;
  short dOffsetPlanTemp;
  short iWarpDst;
  long *plMinMax;
  short iWarp;
  short fTwoMA;
  double dDistance;
  
  iWarpDst = 0;
  uVar6 = (undefined2)((ulong)lpplTest >> 0x10);
  pPVar4 = (PLANET *)lpplTest;
  if ((((pPVar4->iPlayer == idPlayer) || (pPVar4->iPlayer == -1)) ||
      ((*(uint *)((byte *)vlpbAiData + lpplTest->id * 2 + 2) >> 5 & 3) != 0)) ||
     (sVar3 = GetRaceStat((PLAYER *)rgplr + pPVar4->iPlayer,rsMajorAdv),
     sVar3 == raMacintosh)) {
    sVar3 = 0;
  }
  else {
    if (((uint)pPVar4->wFlags >> 9 & 1) != 0) {
      iVar5 = pPVar4->iPlayer * 4;
      if ((*(uint *)(*(int *)(iVar5 + 0x14c) + (*(uint *)&pPVar4->field11_0x2c & 0xf) * 0x93 + 0x7b)
          & 0xff) != 7) {
        return 0;
      }
      iWarpDst = IWarpMAFromLppl(lpplTest,&fTwoMA);
      if (fTwoMA != 0) {
        iWarpDst = iWarpDst + 1;
      }
    }
    sVar3 = IWarpMAFromLppl(lpplSrc,&fTwoMA);
    dDistance = (double)(long)(sVar3 + 3);
    if (sVar3 + 3 == iWarpDst) {
      sVar3 = 0;
    }
    else {
      dDistance = dDistance * dDistance;
      dVar2 = DGetDistance(((POINT *)rgptPlan + lpplSrc->id)->x,
                                 *(short *)((int)&rgptPlan[0].y + lpplSrc->id * 4),
                                 ((POINT *)rgptPlan + lpplTest->id)->x,
                                 *(short *)((int)&rgptPlan[0].y + lpplTest->id * 4));
      bVar7 = (undefined1 *)0xfff7 < &stack0xffb0;
      bVar8 = &stack0x0000 == (undefined1 *)((int)(ulong *)rgcrPlrHistory + 0x1a);
      dVar1 = *(double *)CONCAT11(extraout_AH,dVar2);
      __aFfcompp();
      if (bVar7 || bVar8) {
        if (fTwoMA == 0) {
          dVar1 = dVar1 / dDistance;
          _pow(SUB84(DOUBLE_0_75__1120_1e3e,0),
                       (double)CONCAT26((int)((qword)dVar1 >> 0x10),
                                        CONCAT24(SUB82(dVar1,0),
                                                 (long)((qword)DOUBLE_0_75__1120_1e3e >> 0x20))),
                       (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20))));
          lVar9 = __ftol((double)CONCAT26(in_stack_0000ffbe,
                                                  CONCAT24(in_stack_0000ffbc,
                                                           CONCAT22(unaff_SI,unaff_DI))));
        }
        else {
          dVar1 = dVar1 / dDistance;
          _pow(SUB84(DOUBLE_0_875__1120_1e36,0),
                       (double)CONCAT26((int)((qword)dVar1 >> 0x10),
                                        CONCAT24(SUB82(dVar1,0),
                                                 (long)((qword)DOUBLE_0_875__1120_1e36 >> 0x20))),
                       (double)CONCAT26(unaff_SI,CONCAT24(unaff_DI,(long)((qword)dVar1 >> 0x20))));
          lVar9 = __ftol((double)CONCAT26(in_stack_0000ffbe,
                                                  CONCAT24(in_stack_0000ffbc,
                                                           CONCAT22(unaff_SI,unaff_DI))));
        }
        if (((uint)pPVar4->uGuesses >> 0xc < 100) && ((pPVar4->uGuesses & 0xfffU) != 0)) {
          if (((pPVar4->uGuesses & 0xfffU) + 0x19) * 4 < 0x3e9) {
            in_stack_0000ffbc = ((pPVar4->uGuesses & 0xfffU) + 0x19) * 4;
            in_stack_0000ffbe = 0;
          }
          lVar10 = __ftol((double)CONCAT26(in_stack_0000ffbe,
                                                   CONCAT24(in_stack_0000ffbc,
                                                            CONCAT22(unaff_SI,unaff_DI))));
          if (lVar9 < lVar10) {
            sVar3 = 0;
          }
          else {
            sVar3 = 1;
          }
        }
        else {
          sVar3 = 0;
        }
      }
      else {
        sVar3 = 0;
      }
    }
  }
  return sVar3;
}



// ======================================================================
// Function: FEnumCalcEnemyPlanets
// Address: 10a8:45a6
// Segment: MEMORY_AI4
// ======================================================================


short FEnumCalcEnemyPlanets(PLANET *lpplSrc,PLANET *lpplTest)

{
  short sVar1;
  undefined2 uVar2;
  
  uVar2 = (undefined2)((ulong)lpplTest >> 0x10);
  if ((((PLANET *)lpplTest)->iPlayer == idPlayer) || (((PLANET *)lpplTest)->iPlayer == -1)) {
    sVar1 = 0;
  }
  else {
    sVar1 = 1;
  }
  return sVar1;
}



// ======================================================================
// Function: iBuildCyberStarbase
// Address: 10a8:45de
// Segment: MEMORY_AI4
// ======================================================================


short iBuildCyberStarbase(PLANET *lppl)

{
  int iVar1;
  short sVar2;
  PLANET *pPVar3;
  undefined2 uVar4;
  PROD rgprod [64];
  short ishdefSB;
  
  uVar4 = (undefined2)((ulong)lppl >> 0x10);
  pPVar3 = (PLANET *)lppl;
  if (((((uint)pPVar3->wFlags >> 9 & 1) == 0) &&
      (sVar2 = PctPlanetDesirability(lppl,idPlayer), 0xe < sVar2)) &&
     ((iVar1 = *(int *)((int)pPVar3->rgwtMin + 0xe), 0 < iVar1 ||
      ((-1 < iVar1 && (499 < *(uint *)(pPVar3->rgwtMin + 3))))))) {
    ChangeMainObjSel(1,lppl->id);
    InitProduction(rgprod);
    if ((pPVar3->rgMinConc[0] < 0x10) ||
       ((pPVar3->rgMinConc[1] < 0x10 || (pPVar3->rgMinConc[2] < 0x10)))) {
      sVar2 = IshdefAiSBLatestOF();
    }
    else {
      sVar2 = IshdefAiSBLatest();
    }
  }
  else {
    sVar2 = -1;
  }
  return sVar2;
}



// ======================================================================
// Function: EnsureCyberAiShdefs
// Address: 10a8:4826
// Segment: MEMORY_AI4
// ======================================================================


void EnsureCyberAiShdefs(short iroCur)

{
  SHDEF *pSVar1;
  SHDEF *pSVar2;
  short sVar3;
  int iVar4;
  SHDEF *pSVar5;
  SHDEF *pSVar6;
  undefined *puVar7;
  undefined2 unaff_SS;
  byte *pbVar8;
  SHDEF shdef;
  short high;
  short i;
  short ishCur;
  short ish;
  short low;
  
  puVar7 = (undefined *)&DAT_1120_10a8;
  if (((((((uint)rgshdef[0].wFlags >> 9 & 1) == 0) &&
        (rgshdef[0].hul.ihuldef != ihuldefFrigate)) &&
       (1 < (*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7))) &&
      (((int)rgshdef[0].cExist == 0 && (rgshdef[0].cExist._2_2_ == 0)))) &&
     (5 < (uint)game.turn)) {
    pSVar5 = (SHDEF *)rgshdef;
    pSVar6 = &shdef;
    for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1) {
      pSVar2 = pSVar6;
      pSVar6 = (SHDEF *)(pSVar6->hul).rgTech;
      pSVar1 = pSVar5;
      pSVar5 = (SHDEF *)(pSVar5->hul).rgTech;
      (pSVar2->hul).ihuldef = (pSVar1->hul).ihuldef;
    }
    *(char *)&(pSVar6->hul).ihuldef = (char)(pSVar5->hul).ihuldef;
    shdef.wFlags = shdef.wFlags & 0xfdffU | 0x200;
    puVar7 = (undefined *)&DAT_1120_1090;
    FChangeAiShdef(&shdef,0);
  }
  if (((uint)rgshdef[0].wFlags >> 9 & 1) != 0) {
    pbVar8 = (byte *)CONCAT22(puVar7,(byte *)vrgCyberAip + vrgCyberIshAip[0xc]);
    puVar7 = (undefined *)&DAT_1120_1090;
    FCreateAiShdef(0,5,pbVar8);
  }
  if ((((uint)rgshdef[4].wFlags >> 9 & 1) != 0) && (0x1e < (uint)game.turn)) {
    if ((uint)game.turn < 0x4c) {
      pbVar8 = (byte *)CONCAT22(puVar7,(byte *)vrgCyberAip + vrgCyberIshAip[0]);
      puVar7 = (undefined *)&DAT_1120_1090;
      sVar3 = FCreateAiShdef(4,6,pbVar8);
      if (sVar3 != 0) goto LAB_10a8_497e;
    }
    for (i = 5; 0 < i; i = i + -1) {
      sVar3 = Random(i);
      puVar7 = (undefined *)&DAT_1120_1090;
      sVar3 = FCreateAiShdef(4,6,(byte *)CONCAT22((undefined *)&DAT_1120_1040,
                                                       (byte *)vrgCyberAip +
                                                       ((ushort *)vrgCyberIshAip)[sVar3]));
      if (sVar3 != 0) break;
    }
  }
LAB_10a8_497e:
  if (((((uint)rgshdef[5].wFlags >> 9 & 1) != 0) &&
      (((uint)rgshdef[4].wFlags >> 9 & 1) == 0)) &&
     (rgshdef[4].turn + 0x14U < (uint)game.turn)) {
    if ((uint)game.turn < 0x4c) {
      pbVar8 = (byte *)CONCAT22(puVar7,(byte *)vrgCyberAip + vrgCyberIshAip[5]);
      puVar7 = (undefined *)&DAT_1120_1090;
      sVar3 = FCreateAiShdef(5,6,pbVar8);
      if (sVar3 != 0) goto LAB_10a8_4a2f;
    }
    for (i = 5; 0 < i; i = i + -1) {
      sVar3 = Random(i);
      puVar7 = (undefined *)&DAT_1120_1090;
      sVar3 = FCreateAiShdef(5,6,(byte *)CONCAT22((undefined *)&DAT_1120_1040,
                                                       (byte *)vrgCyberAip +
                                                       ((ushort *)vrgCyberIshAip)[sVar3 + 5]));
      if (sVar3 != 0) break;
    }
  }
LAB_10a8_4a2f:
  if ((((uint)rgshdef[2].wFlags >> 9 & 1) != 0) && (0x14 < (uint)game.turn)) {
    pbVar8 = (byte *)CONCAT22(puVar7,(byte *)vrgCyberAip + vrgCyberIshAip[10]);
    puVar7 = (undefined *)&DAT_1120_1090;
    FCreateAiShdef(2,0xb,pbVar8);
  }
  if (((((uint)rgshdef[3].wFlags >> 9 & 1) != 0) &&
      (((uint)rgshdef[2].wFlags >> 9 & 1) == 0)) &&
     (rgshdef[2].turn + 0x14U < (uint)game.turn)) {
    pbVar8 = (byte *)CONCAT22(puVar7,(byte *)vrgCyberAip + vrgCyberIshAip[0xb]);
    puVar7 = (undefined *)&DAT_1120_1090;
    FCreateAiShdef(3,0xb,pbVar8);
  }
  for (ish = 6; ish < 0xb; ish = ish + 4) {
    if (((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0) &&
       (((ish == 6 && (0x28 < (uint)game.turn)) ||
        ((((uint)rgshdef[6].wFlags >> 9 & 1) == 0 &&
         (rgshdef[6].turn + 0x1eU < (uint)game.turn)))))) {
      ishCur = ish + 2;
      for (i = 3; 0 < i; i = i + -1) {
        sVar3 = Random(i);
        puVar7 = (undefined *)&DAT_1120_1090;
        sVar3 = FCreateAiShdef(ishCur,0x1d,
                                    (byte *)CONCAT22((undefined *)&DAT_1120_1040,
                                                     (byte *)vrgCyberAip +
                                                     ((ushort *)vrgCyberIshAip)[sVar3 + 0x21]));
        if (sVar3 != 0) {
          ishCur = ishCur + -1;
          break;
        }
      }
      for (i = 4; 0 < i; i = i + -1) {
        sVar3 = Random(i);
        puVar7 = (undefined *)&DAT_1120_1090;
        sVar3 = FCreateAiShdef(ishCur,9,(byte *)CONCAT22((undefined *)&DAT_1120_1040,
                                                              (byte *)vrgCyberAip +
                                                              ((ushort *)vrgCyberIshAip)
                                                              [sVar3 + 0x1d]));
        if (sVar3 != 0) {
          ishCur = ishCur + -1;
          break;
        }
      }
      for (i = 3; 0 < i; i = i + -1) {
        sVar3 = Random(i);
        puVar7 = (undefined *)&DAT_1120_1090;
        sVar3 = FCreateAiShdef(ishCur,9,(byte *)CONCAT22((undefined *)&DAT_1120_1040,
                                                              (byte *)vrgCyberAip +
                                                              ((ushort *)vrgCyberIshAip)
                                                              [sVar3 + 0x1a]));
        if (sVar3 != 0) {
          ishCur = ishCur + -1;
          break;
        }
      }
      if (ish <= ishCur) {
        high = (ishCur - ish) * -3 + 9;
        low = 0x1a - high;
AI4_LCruiser:
        for (i = high; 0 < i; i = i + -1) {
          sVar3 = Random(i);
          puVar7 = (undefined *)&DAT_1120_1090;
          sVar3 = FCreateAiShdef(ishCur,7,(byte *)CONCAT22((undefined *)&DAT_1120_1040,
                                                                (byte *)vrgCyberAip +
                                                                ((ushort *)vrgCyberIshAip)
                                                                [sVar3 + low]));
          if (sVar3 != 0) break;
        }
        ishCur = ishCur + -1;
        if (ish <= ishCur) {
          high = 3;
          if (ishCur == ish) {
            low = 0x11;
          }
          else {
            low = 0x14;
          }
          goto AI4_LCruiser;
        }
      }
      pbVar8 = (byte *)CONCAT22(puVar7,(byte *)vrgCyberAip + vrgCyberIshAip[0x10]);
      puVar7 = (undefined *)&DAT_1120_1090;
      sVar3 = FCreateAiShdef(ish + 3,0x1d,pbVar8);
      if (sVar3 == 0) {
        puVar7 = (undefined *)&DAT_1120_1090;
        sVar3 = FCreateAiShdef(ish + 3,9,
                                    (byte *)CONCAT22((undefined *)&DAT_1120_1090,
                                                     (byte *)vrgCyberAip + vrgCyberIshAip[0xf]));
        if (sVar3 == 0) {
          puVar7 = (undefined *)&DAT_1120_1090;
          sVar3 = FCreateAiShdef(ish + 3,0x13,
                                      (byte *)CONCAT22((undefined *)&DAT_1120_1090,
                                                       (byte *)vrgCyberAip + vrgCyberIshAip[0xe]));
          if (sVar3 == 0) {
            puVar7 = (undefined *)&DAT_1120_1090;
            FCreateAiShdef(ish + 3,0x13,
                                (byte *)CONCAT22((undefined *)&DAT_1120_1090,
                                                 (byte *)vrgCyberAip + vrgCyberIshAip[0xd]));
          }
        }
      }
    }
  }
  ish = 0xe;
  do {
    if (0xf < ish) {
      return;
    }
    if (((*(uint *)((int)&rgshdef[0].wFlags + ish * 0x93) >> 9 & 1) != 0) &&
       (((ish == 0xe && (0x1e < (uint)game.turn)) ||
        ((((uint)rgshdef[0xe].wFlags >> 9 & 1) == 0 &&
         (rgshdef[0xe].turn + 0x14U < (uint)game.turn)))))) {
      for (i = 7; 0 < i; i = i + -1) {
        sVar3 = Random(i);
        sVar3 = FCreateAiShdef(ish,9,(byte *)CONCAT22((undefined *)&DAT_1120_1040,
                                                           (byte *)vrgCyberAip +
                                                           ((ushort *)vrgCyberIshAip)[sVar3 + 0x1a])
                                   );
        if (sVar3 != 0) break;
      }
      if (i == 0) {
        for (i = 9; 0 < i; i = i + -1) {
          sVar3 = Random(i);
          sVar3 = FCreateAiShdef(ish,7,(byte *)CONCAT22((undefined *)&DAT_1120_1040,
                                                             (byte *)vrgCyberAip +
                                                             ((ushort *)vrgCyberIshAip)
                                                             [sVar3 + 0x11]));
          if (sVar3 != 0) break;
        }
      }
      if (i == 0) {
        for (i = 10; 0 < i; i = i + -1) {
          sVar3 = Random(i);
          sVar3 = FCreateAiShdef(ish,6,(byte *)CONCAT22((undefined *)&DAT_1120_1040,
                                                             (byte *)vrgCyberAip +
                                                             ((ushort *)vrgCyberIshAip)[sVar3]));
          if (sVar3 != 0) break;
        }
      }
    }
    ish = ish + 1;
  } while( true );
}



// ======================================================================
// Function: iAddAttackFleet
// Address: 10a8:4eba
// Segment: MEMORY_AI4
// ======================================================================


short iAddAttackFleet
          (PLANET *lppl,short iAttackStr,short iBestDestroyer,short iBestBattle,
          short iBestSBDefender)

{
  short sVar1;
  short sVar2;
  short sVar3;
  int iVar4;
  int iVar5;
  short iRand;
  short iMaxMines;
  short iMaxFactories;
  short fRet;
  
  sVar1 = Random(100);
  sVar2 = CMaxOperableMines(lppl,idPlayer,0);
  sVar3 = CMinesOperating(lppl);
  if ((uint)(sVar2 - sVar3) < 0x8000) {
    sVar2 = CMaxOperableMines(lppl,idPlayer,0);
    sVar3 = CMinesOperating(lppl);
    iVar4 = sVar2 - sVar3;
  }
  else {
    iVar4 = 0;
  }
  sVar2 = CMaxOperableFactories(lppl,idPlayer,0);
  sVar3 = CFactoriesOperating(lppl);
  if ((uint)(sVar2 - sVar3) < 0x8000) {
    sVar2 = CMaxOperableFactories(lppl,idPlayer,0);
    sVar3 = CFactoriesOperating(lppl);
    iVar5 = sVar2 - sVar3;
  }
  else {
    iVar5 = 0;
  }
  sVar2 = Random(100);
  if ((iVar4 < 100) || (iVar5 < 100)) {
    iVar4 = 0x5a;
  }
  else {
    iVar4 = 0x3c;
  }
  if (sVar2 < iVar4) {
    sVar1 = 0;
  }
  else if ((iBestBattle == -1) || (sVar1 < 0x33)) {
    if ((iBestSBDefender == -1) || (sVar1 < 0x1a)) {
      if (iBestDestroyer == -1) {
        sVar1 = 0;
      }
      else {
        AddItemToQueue(iBestDestroyer,1,grobjFleet,1);
        sVar1 = 3;
      }
    }
    else {
      AddItemToQueue(iBestSBDefender,1,grobjFleet,1);
      sVar1 = 2;
    }
  }
  else {
    if ((*(uint *)((int)&rgshdef[0].wFlags + (iBestBattle * 4 + 6) * 0x93) >> 9 & 1) == 0)
    {
      AddItemToQueue(iBestBattle * 4 + 6,2,grobjFleet,1);
    }
    if ((*(uint *)((int)&rgshdef[0].wFlags + (iBestBattle * 4 + 7) * 0x93) >> 9 & 1) == 0)
    {
      AddItemToQueue(iBestBattle * 4 + 7,2,grobjFleet,1);
    }
    if (((*(uint *)((int)&rgshdef[0].wFlags + (iBestBattle * 4 + 8) * 0x93) >> 9 & 1) == 0
        ) && (sVar1 = Random(100), sVar1 < 0x4b)) {
      AddItemToQueue(iBestBattle * 4 + 8,1,grobjFleet,1);
    }
    if (((*(uint *)((int)&rgshdef[0].wFlags + (iBestBattle * 4 + 9) * 0x93) >> 9 & 1) == 0
        ) && (sVar1 = Random(100), sVar1 < 0x32)) {
      AddItemToQueue(iBestBattle * 4 + 9,1,grobjFleet,1);
    }
    sVar1 = 1;
  }
  return sVar1;
}



// ======================================================================
// Function: TargetCyberArmada
// Address: 10a8:51a4
// Segment: MEMORY_AI4
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10a85203) */

void TargetCyberArmada(FLEET *lpfl)

{
  short *psVar1;
  ORDER *pOVar2;
  undefined2 uVar3;
  POINT pt1;
  POINT pt2;
  PLANET *pPVar4;
  int iVar5;
  short sVar6;
  int iVar7;
  FLEET *pFVar8;
  short *psVar9;
  ORDER *pOVar10;
  undefined2 uVar11;
  undefined2 unaff_SS;
  long lVar12;
  PLANET *pPVar13;
  PLANET *lpplTarget;
  short cshWar;
  short cshBomb;
  PLANET *lppl;
  ORDER ord;
  FLEET *lpflTarget;
  
  uVar11 = (undefined2)((ulong)lpfl >> 0x10);
  pFVar8 = (FLEET *)lpfl;
  if (1 < pFVar8->cord) {
    uVar3 = *(undefined2 *)((int)&pFVar8->lpplord + 2);
    psVar9 = (short *)(*(int *)&pFVar8->lpplord + 0x16);
    pOVar10 = &ord;
    for (iVar7 = 9; iVar7 != 0; iVar7 = iVar7 + -1) {
      pOVar2 = pOVar10;
      pOVar10 = (ORDER *)&(pOVar10->pt).y;
      psVar1 = psVar9;
      psVar9 = psVar9 + 1;
      (pOVar2->pt).x = *psVar1;
    }
    pt1.y = (pFVar8->pt).y;
    pt1.x = (&pFVar8->pt)->x;
    pt2.y = ord.pt.y;
    pt2.x = ord.pt.x;
    lVar12 = LDistance2(pt1,pt2);
    if ((lVar12 < 0xf425) || (((uint)ord.wFlags >> 8 & 0xf) != 2)) {
      if (((uint)ord.wFlags >> 8 & 0xf) == 2) {
        return;
      }
      if (((uint)ord.wFlags >> 8 & 0xf) == 1) {
        pPVar13 = LpplFromId(ord.id);
        iVar7 = (int)((ulong)pPVar13 >> 0x10);
        pPVar4 = (PLANET *)pPVar13;
        if ((pPVar4 == (PLANET *)0x0) && (iVar7 == 0)) {
          return;
        }
        if (pPVar4->iPlayer != -1) {
          if (pPVar4->iPlayer != idPlayer) {
            return;
          }
          if (((uint)pPVar4->wFlags >> 9 & 1) != 0) {
            return;
          }
        }
        if (pPVar4->turn != game.turn) {
          return;
        }
      }
    }
  }
  iVar7 = pFVar8->rgcsh[6] + pFVar8->rgcsh[7] + pFVar8->rgcsh[8] * 2 + pFVar8->rgcsh[10] +
          pFVar8->rgcsh[0xb] + pFVar8->rgcsh[0xc] * 2;
  iVar5 = pFVar8->rgcsh[9] + pFVar8->rgcsh[0xd];
  pFVar8->wFlags = pFVar8->wFlags & 0x7fffU | 0x8000;
  ChangeMainObjSel(2,lpfl->id);
  if (pFVar8->idPlanet == -1) {
    MoveToNearestPlanetOrEnemy(lpfl,0x1c2);
    return;
  }
  pPVar13 = LpplFromId(pFVar8->idPlanet);
  uVar11 = (undefined2)((ulong)pPVar13 >> 0x10);
  if (((PLANET *)pPVar13)->iPlayer == idPlayer) {
    if ((iVar7 < (int)(uint)vrgAiArmadaPotency[0]) ||
       (iVar5 < (int)(uint)vrgAiArmadaPotency[2])) {
      if ((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) < 2) {
        return;
      }
      if ((iVar7 <= (int)((uint)vrgAiArmadaPotency[0] * 2)) && (iVar7 < 0x3c)) {
        return;
      }
      sVar6 = Random(10);
      if ((4 < sVar6) &&
         ((iVar7 <= (int)((uint)vrgAiArmadaPotency[0] * 3) ||
          (sVar6 = Random(10), 6 < sVar6)))) {
        if (iVar7 < 0x79) {
          return;
        }
        sVar6 = Random(10);
        if (6 < sVar6) {
          return;
        }
      }
    }
  }
  else if ((iVar7 < (int)(uint)vrgAiArmadaPotency[1]) ||
          (iVar5 < (int)(uint)vrgAiArmadaPotency[3])) {
    ClearAiCurrentTask(lpfl,0);
    if (((*(uint *)((int)&rgplr[0].wMdPlr + idPlayer * 0xc0) >> 10 & 7) < 2) ||
       ((((iVar7 <= (int)((uint)vrgAiArmadaPotency[0] * 2) ||
          (sVar6 = Random(10), 4 < sVar6)) &&
         ((iVar7 <= (int)((uint)vrgAiArmadaPotency[0] * 4) ||
          (sVar6 = Random(10), 6 < sVar6)))) &&
        ((iVar7 < 0x79 || (sVar6 = Random(10), 6 < sVar6)))))) {
      lpplTarget = LpplFindClosestEnum(pPVar13,FEnumOurStarbase);
      goto AI4_TargetEveryArmada_2;
    }
  }
  else if (((PLANET *)pPVar13)->iPlayer != -1) {
    return;
  }
  if (((uint)game.wCrap >> 4 & 1) == 0) {
    lpplTarget = (PLANET *)0x0;
  }
  else {
    lpplTarget = LpplFindBestEnum(pPVar13,FEnumCalcArmadaHumanDest);
  }
  if (((PLANET *)lpplTarget == (PLANET *)0x0) && (lpplTarget._2_2_ == 0)) {
    lpplTarget = LpplFindBestEnum(pPVar13,FEnumCalcArmadaDest);
  }
AI4_TargetEveryArmada_2:
  if (((PLANET *)lpplTarget == (PLANET *)0x0) && (lpplTarget._2_2_ == 0)) {
    lpflTarget = LpflFindClosestEnum(lpfl,FEnumCalcEnemyFleets);
    iVar7 = (int)((ulong)lpflTarget >> 0x10);
    pFVar8 = (FLEET *)lpflTarget;
    if ((pFVar8 == (FLEET *)0x0) && (iVar7 == 0)) {
      return;
    }
    ord.id = lpflTarget->id;
    ord.wFlags = ord.wFlags & 0xf0ffU | 0x200;
    ord.pt.x = (&pFVar8->pt)->x;
    ord.pt.y = (pFVar8->pt).y;
  }
  else {
    ((byte *)vlpbAiPlanet)[lpplTarget->id * 0x10 + 10] =
         ((byte *)vlpbAiPlanet)[lpplTarget->id * 0x10 + 10] | 0x80;
    ord.id = lpplTarget->id;
    ord.wFlags = ord.wFlags & 0xf0ffU | 0x100;
    ord.pt.x = ((POINT *)rgptPlan + lpplTarget->id)->x;
    ord.pt.y = *(short *)((int)&rgptPlan[0].y + lpplTarget->id * 4);
  }
  ord.wFlags = ord.wFlags & 0xef00U | 0x1040;
  FMoveAiFleet(lpfl,&ord,0);
  return;
}



