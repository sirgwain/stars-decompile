// Decompiled code from stars.exe (Stars! 2.60j RC3)
// Generated by Ghidra
// 

// ======================================================================
// Function: CalcPlayerScore
// Address: 1038:58a6
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10385938) */
/* WARNING: Could not reconcile some variable overlaps */

undefined2 __cdecl16far UTIL::CalcPlayerScore(int iPlr,undefined2 *pscore)

{
  long *plVar1;
  int *piVar2;
  SCORE *pSVar3;
  undefined2 *puVar4;
  long lVar5;
  uint uVar6;
  int iVar7;
  ushort uVar8;
  uint uVar9;
  int iVar10;
  int iVar11;
  int iVar12;
  int *piVar13;
  SCORE *pSVar14;
  undefined2 uVar15;
  bool bVar16;
  long lVar17;
  HULDEF *pHVar18;
  undefined4 uVar19;
  short rgType [16];
  long lPower;
  short iTech;
  FLEET *lpfl;
  short ifl;
  short i;
  PLANET *lppl;
  PLANET *lpplMac;
  SCORE score;
  long lTemp;
  long rgcsh [3];
  
  PUBLIC::_memset(&score,0,0x14);
  uVar9 = (int)_DATA::lpPlanets + c_common::cPlanet * 0x38;
  lppl = (PLANET *)CONCAT22(_DATA::lpPlanets._2_2_,(int)_DATA::lpPlanets);
  while ((uint)lppl < uVar9) {
    uVar15 = (undefined2)((ulong)lppl >> 0x10);
    if (*(int *)((uint)lppl + 2) == iPlr) {
      score.cPlanet = score.cPlanet + 1;
      uVar6 = *(uint *)((uint)lppl + 0x28);
      lVar17 = PUBLIC::__aFldiv(uVar6 + 999,*(int *)((uint)lppl + 0x2a) + (uint)(0xfc18 < uVar6),
                                0xe8,0);
      if (6 < lVar17) {
        lVar17 = 6;
      }
      score.lScore = lVar17 + score.lScore;
      if ((*(uint *)((uint)lppl + 4) >> 9 & 1) != 0) {
        pHVar18 = PARTS::LphuldefFromId
                            (*(short *)(*(int *)(iPlr * 4 + 0x14c) +
                                       (*(uint *)((uint)lppl + 0x2c) & 0xf) * 0x93));
        if (*(int *)((int)pHVar18 + 0x34) != 0) {
          score.cStarbase = score.cStarbase + 1;
        }
      }
      uVar6 = PLANET::CResourcesAtPlanet(lppl,iPlr);
      bVar16 = CARRY2((uint)score.cResources,uVar6);
      score.cResources._0_2_ = (uint)score.cResources + uVar6;
      score.cResources._2_2_ = score.cResources._2_2_ + ((int)uVar6 >> 0xf) + (uint)bVar16;
    }
    lppl = (PLANET *)CONCAT22(uVar15,(uint)lppl + 0x38);
  }
  lVar17 = PUBLIC::__aFldiv((uint)score.cResources,score.cResources._2_2_,0x1e,0);
  lVar17 = lVar17 + score.lScore + (long)(score.cStarbase * 3);
  score.lScore._0_2_ = (int)lVar17;
  score.lScore._2_2_ = (int)((ulong)lVar17 >> 0x10);
  if ((*(uint *)(iPlr * 0xc0 + 0x59f6) & 1) == 0) {
    for (i = 0; i < 6; i = i + 1) {
      iVar10 = (int)*(char *)(iPlr * 0xc0 + 0x59bc + i);
      score.cTechLevels = score.cTechLevels + iVar10;
      if (iVar10 < 4) {
        lVar17 = lVar17 + iVar10;
        score.lScore._0_2_ = (int)lVar17;
        score.lScore._2_2_ = (int)((ulong)lVar17 >> 0x10);
      }
      else if (iVar10 < 7) {
        lVar17 = lVar17 + (iVar10 * 2 + -3);
        score.lScore._0_2_ = (int)lVar17;
        score.lScore._2_2_ = (int)((ulong)lVar17 >> 0x10);
      }
      else if (iVar10 < 10) {
        iVar10 = iVar10 * 3 + -9;
        lVar5 = lVar17 + iVar10;
        score.lScore._0_2_ = (int)lVar5;
        score.lScore._2_2_ = (int)((ulong)lVar5 >> 0x10);
        lVar17 = lVar17 + iVar10;
      }
      else {
        iVar10 = iVar10 * 4 + -0x12;
        lVar5 = lVar17 + iVar10;
        score.lScore._0_2_ = (int)lVar5;
        score.lScore._2_2_ = (int)((ulong)lVar5 >> 0x10);
        lVar17 = lVar17 + iVar10;
      }
    }
  }
  for (i = 0; score.lScore = lVar17, i < 0x10; i = i + 1) {
    if ((*(uint *)(*(int *)(iPlr * 4 + 0xfe) + i * 0x93 + 0x7b) >> 9 & 1) == 0) {
      iVar10 = *(int *)(iPlr * 4 + 0x100);
      uVar9 = LComputePower((char)(*(int *)(iPlr * 4 + 0xfe) + i * 0x93),iVar10);
      if ((iVar10 < 1) && ((iVar10 < 0 || (uVar9 == 0)))) {
        rgType[i] = 0;
        lVar17 = score.lScore;
      }
      else if ((iVar10 < 1) && ((iVar10 < 0 || (uVar9 < 2000)))) {
        rgType[i] = 1;
        lVar17 = score.lScore;
      }
      else {
        rgType[i] = 2;
        lVar17 = score.lScore;
      }
    }
    else {
      rgType[i] = -1;
      lVar17 = score.lScore;
    }
  }
  for (i = 0; i < 3; i = i + 1) {
    *(undefined2 *)(rgcsh + i) = 0;
    *(undefined2 *)((int)rgcsh + i * 4 + 2) = 0;
  }
  for (ifl = 0; ifl < c_common::cFleet; ifl = ifl + 1) {
    piVar13 = (int *)((int)_DATA::rglpfl + ifl * 4);
    iVar10 = *piVar13;
    iVar7 = piVar13[1];
    if ((iVar10 == 0) && (iVar7 == 0)) break;
    if ((*(int *)(iVar10 + 2) == iPlr) && ((*(uint *)(iVar10 + 4) >> 10 & 1) == 0)) {
      for (i = 0; i < 0x10; i = i + 1) {
        if ((0 < *(int *)(iVar10 + 0xc + i * 2)) && (rgType[i] != -1)) {
          uVar9 = *(uint *)(iVar10 + 0xc + i * 2);
          iVar11 = rgType[i];
          plVar1 = rgcsh + iVar11;
          uVar6 = *(uint *)plVar1;
          *(uint *)plVar1 = *(uint *)plVar1 + uVar9;
          piVar2 = (int *)((int)rgcsh + iVar11 * 4 + 2);
          *piVar2 = *piVar2 + ((int)uVar9 >> 0xf) + (uint)CARRY2(uVar6,uVar9);
        }
      }
    }
  }
  iVar10 = score.cPlanet >> 0xf;
  if ((iVar10 < rgcsh[1]._2_2_) ||
     ((iVar10 <= rgcsh[1]._2_2_ && ((uint)score.cPlanet <= (uint)rgcsh[1])))) {
    rgcsh[1]._2_2_ = iVar10;
  }
  uVar15 = PUBLIC::__aFlshl();
  iVar10 = score.cPlanet >> 0xf;
  if ((iVar10 < rgcsh[0]._2_2_) ||
     ((iVar10 <= rgcsh[0]._2_2_ && ((uint)score.cPlanet <= (uint)rgcsh[0])))) {
    rgcsh[0]._0_2_ = score.cPlanet;
    rgcsh[0]._2_2_ = iVar10;
  }
  lVar17 = PUBLIC::__aFldiv((uint)rgcsh[0],rgcsh[0]._2_2_,2,0);
  lVar17 = lVar17 + CONCAT22(rgcsh[1]._2_2_,uVar15) + score.lScore;
  score.lScore._0_2_ = (int)lVar17;
  score.lScore._2_2_ = (int)((ulong)lVar17 >> 0x10);
  if ((-1 < rgcsh[2]._2_2_) && ((0 < rgcsh[2]._2_2_ || ((uint)rgcsh[2] != 0)))) {
    iVar11 = score.cPlanet >> 0xf;
    iVar7 = score.cPlanet + (uint)rgcsh[2];
    iVar12 = iVar11 + rgcsh[2]._2_2_ + (uint)CARRY2(score.cPlanet,(uint)rgcsh[2]);
    iVar10 = score.cPlanet;
    score.lScore = lVar17;
    uVar15 = PUBLIC::__aFlshl(score.cPlanet,iVar11,(char)iVar7,iVar12);
    uVar19 = PUBLIC::__aFulmul(uVar15,rgcsh[2]._2_2_,iVar10,iVar11);
    lVar17 = PUBLIC::__aFldiv(uVar19,(char)iVar7,iVar12);
    lVar17 = score.lScore + lVar17;
    score.lScore._0_2_ = (int)lVar17;
    score.lScore._2_2_ = (int)((ulong)lVar17 >> 0x10);
  }
  score.lScore = lVar17;
  for (i = 0; i < 3; i = i + 1) {
    uVar8 = WPackLong(CONCAT22(*(undefined2 *)((int)rgcsh + i * 4 + 2),*(undefined2 *)(rgcsh + i)));
    score.rgcsh[i] = uVar8;
  }
  if (pscore != (undefined2 *)0x0) {
    pSVar14 = &score;
    for (iVar10 = 10; iVar10 != 0; iVar10 = iVar10 + -1) {
      puVar4 = pscore;
      pscore = pscore + 1;
      pSVar3 = pSVar14;
      pSVar14 = (SCORE *)((int)&pSVar14->lScore + 2);
      *puVar4 = *(undefined2 *)&pSVar3->lScore;
    }
  }
  return (undefined2)score.lScore;
}



// ======================================================================
// Function: LComputePower
// Address: 1038:0b32
// ======================================================================


/* WARNING: Removing unreachable block (ram,0x10380da6) */
/* WARNING: Could not reconcile some variable overlaps */

int __cdecl16far UTIL::LComputePower(SHDEF *lpshdef)

{
  uint uVar1;
  int iVar2;
  short sVar3;
  int iVar4;
  int iVar5;
  short *psVar6;
  undefined2 uVar7;
  undefined4 uVar8;
  long lVar9;
  long lVar10;
  long lVar11;
  PART part;
  long dp;
  long dpBombs;
  long dpBeams;
  long pctCap;
  short i;
  long dpTorps;
  short ihs;
  short dxRange;
  short dSpeed;
  
  dpBombs._0_2_ = 0;
  lVar11 = 0;
  dpTorps._0_2_ = 0;
  lVar10 = 1000;
  ihs = 0;
  while( true ) {
    uVar7 = (undefined2)((ulong)lpshdef >> 0x10);
    if ((int)(uint)*(byte *)((int)lpshdef + 0x7a) <= ihs) break;
    psVar6 = (short *)((int)lpshdef + 0x3a + ihs * 4);
    part.hs.grhst = *psVar6;
    part.hs.flags2 = psVar6[1];
    if (((uint)part.hs.flags2 >> 8 != 0) && (sVar3 = PARTS::FLookupPart(&part), sVar3 != 0)) {
      iVar4 = (int)part.pterra;
      uVar7 = (undefined2)((ulong)part.pterra >> 0x10);
      if (part.hs.grhst == 0x10) {
        iVar2 = *(int *)(iVar4 + 0x34) + 3;
        iVar5 = iVar2 >> 0xf;
        iVar4 = *(int *)(iVar4 + 0x36);
        uVar8 = PUBLIC::__aFulmul(iVar4,iVar4 >> 0xf,(uint)part.hs.flags2 >> 8,0);
        PUBLIC::__aFulmul(uVar8,iVar2,iVar5);
        lVar9 = PUBLIC::__aFldiv();
        if ((*(uint *)((int)part.pterra + 0x3a) & 1) != 0) {
          lVar9 = PUBLIC::__aFldiv();
        }
        lVar11 = lVar9 + lVar11;
      }
      else if (part.hs.grhst == 0x20) {
        iVar2 = *(int *)(iVar4 + 0x34) + -2;
        iVar5 = iVar2 >> 0xf;
        iVar4 = *(int *)(iVar4 + 0x36);
        uVar8 = PUBLIC::__aFulmul(iVar4,iVar4 >> 0xf,(uint)part.hs.flags2 >> 8,0);
        PUBLIC::__aFulmul(uVar8,iVar2,iVar5);
        iVar4 = PUBLIC::__aFldiv();
        dpTorps._0_2_ = (int)dpTorps + iVar4;
      }
      else if (part.hs.grhst == 0x40) {
        dpBombs._0_2_ =
             (int)dpBombs +
             (*(int *)(iVar4 + 0x36) + *(int *)(iVar4 + 0x38)) * ((uint)part.hs.flags2 >> 8) * 2;
      }
      else if ((part.hs.grhst == 0x800) &&
              (((part.hs.flags2 & 0xffU) == 0xc || ((part.hs.flags2 & 0xffU) == 0xd)))) {
        for (i = (uint)part.hs.flags2 >> 8; 0 < i; i = i + -1) {
          uVar1 = *(uint *)((int)part.pterra + 0x34);
          PUBLIC::__aFulmul(lVar10,uVar1 + 100,((int)uVar1 >> 0xf) + (uint)(0xff9b < uVar1));
          lVar10 = PUBLIC::__aFldiv();
        }
      }
    }
    ihs = ihs + 1;
  }
  if (lVar10 != 1000) {
    lVar10 = PUBLIC::__aFldiv();
    if (0xff < lVar10) {
      lVar10 = 0xff;
    }
    PUBLIC::__aFulmul(lVar11,lVar10);
    lVar11 = PUBLIC::__aFldiv();
  }
  dpBeams._0_2_ = (int)lVar11;
  sVar3 = BATTLE::SpdOfShip((FLEET *)0x0,0,(TOK *)0x0,0,lpshdef);
  PUBLIC::__aFulmul(lVar11,sVar3 + -4,sVar3 + -4 >> 0xf);
  iVar4 = PUBLIC::__aFldiv();
  return (int)dpBombs + (int)dpBeams + iVar4 + (int)dpTorps;
}



