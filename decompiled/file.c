// Decompiled code from stars.exe (Stars! 2.60j RC3)
// Generated by Ghidra
//

// ======================================================================
// Function: FileError
// Address: 1070:4a10
// ======================================================================

void __cdecl16far FileError(StringId ids)

{
  char *sz;
  short mbType;

  idsFileError = ids;
  if ((fFileErrSilent == 0) && (((uint)gd.flags1 >> 1 & 1) == 0))
  {
    mbType = 0x10;
    sz = PszFormatIds(ids, (short *)0x0);
    AlertSz(sz, mbType);
  }
  return;
}

// ======================================================================
// Function: StreamOpen
// Address: 1070:52ae
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x1070536a) */
/* WARNING: Removing unreachable block (ram,0x10705391) */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void __cdecl16far StreamOpen(char *szFile, short mdOpen)

{
  ulong uVar1;
  undefined2 unaff_SS;
  DWORD DVar2;
  DWORD DVar3;
  ulong dwTickCur;
  short fNoErr;
  OFSTRUCT of;
  ulong dwTick;

  uVar1 = 0;
  while (true)
  {
    hf = OpenFile((LPCSTR)CONCAT22(0x1120, szFile), (undefined2 *)CONCAT22(unaff_SS, &of),
                  mdOpen & 0xbfff);
    if (hf != 0xffff)
    {
      return;
    }
    if ((((uint)gd.flags1 >> 9 & 1) == 0) || (of.nErrCode == 2))
      break;
    DVar2 = GetTickCount();
    if (uVar1 == 0)
    {
      uVar1 = DVar2 + 4000;
    }
    if (uVar1 <= DVar2)
      break;
    do
    {
      DVar3 = GetTickCount();
    } while (DVar3 < DVar2 + 500);
  }
  if ((mdOpen & 0x4000U) == 0)
  {
    FileError(idsCantOpenFile);
  }
  _longjmp(_penvMem, -1);
  return;
}

// ======================================================================
// Function: UnpackBattlePlan
// Address: 1070:40ce
// ======================================================================

void __cdecl16far UnpackBattlePlan(byte *lpb, BTLPLAN *lpbtlplan, short iplan)

{
  int iVar1;
  undefined2 unaff_SS;
  short cOut;
  short cch;
  char szName[33];
  char szTemp[33];

  iVar1 = (int)lpb;
  __fmemmove(lpbtlplan, lpb, 4);
  lpb = (byte *)CONCAT22(lpb._2_2_, (int)lpb + 4);
  cch = (short)*lpb;
  if (cch == 0)
  {
    __fstrcpy((char *)CONCAT22(lpbtlplan._2_2_, (int)lpbtlplan + 4),
              (char *)CONCAT22(lpb._2_2_, iVar1 + 5));
  }
  else
  {
    cOut = 0x20;
    __fmemmove((void *)CONCAT22(unaff_SS, szTemp), (void *)CONCAT22(lpb._2_2_, iVar1 + 5), 0x20);
    FDecompressUserString((char *)CONCAT22(unaff_SS, szTemp), cch, (char *)CONCAT22(unaff_SS, szName), &cOut);
    __fmemmove((void *)CONCAT22(lpbtlplan._2_2_, (int)lpbtlplan + 4),
               (void *)CONCAT22(unaff_SS, szName), cOut);
  }
  lpbtlplan->flags1 = lpbtlplan->flags1 & 0xff0fU | (iplan & 0xfU) << 4;
  return;
}

// ======================================================================
// Function: FBadFileError
// Address: 1070:524e
// ======================================================================

short __cdecl16far FBadFileError(StringId ids)

{
  short sVar1;

  if ((((ids == idsUniverseDefinitionFileSeemsMissingCorrupt) ||
        (ids == idsPlayerLogFileAppearsCorruptUnableLoad)) ||
       (ids == idsHistoryFileAppearsCorruptHistoricalDataWill)) ||
      (((ids == idsGameFileAppearsCorruptUnableLoadFile || (ids == idsErrorWritingFile)) ||
        ((ids == idsFileDate || (ids == idsFileGame))))))
  {
    sVar1 = 1;
  }
  else
  {
    sVar1 = 0;
  }
  return sVar1;
}

// ======================================================================
// Function: ReadRtPlr
// Address: 1070:05e2
// ======================================================================

void __cdecl16far ReadRtPlr(PLAYER *pplr, byte *pbIn)

{
  ushort uVar1;
  short cOut_2;
  PLAYER *pplrRaw;
  short iOff;

  pplrRaw = (PLAYER *)pbIn;
  _memset(pplr, 0, 0xc0);
  if ((pplrRaw->flags4 & 7U) == 7)
  {
    _memmove(pplr, pbIn, 0x70);
    _memmove(pplr->rgmdRelation, pbIn + 0x71, (uint)pbIn[0x70]);
    iOff = pbIn[0x70] + 0x71;
  }
  else
  {
    _memmove(pplr, pbIn, 8);
    iOff = 8;
  }
  if (pbIn[iOff] == 0)
  {
    _strcpy(pplr->szName, (char *)(pbIn + iOff + 1));
    uVar1 = _strlen(pplr->szName);
    iOff = iOff + uVar1 + 2;
  }
  else
  {
    cOut_2 = 0x20;
    FDecompressUserString((char *)CONCAT22(0x1120, pbIn + iOff + 1), (uint)pbIn[iOff],
                          (char *)CONCAT22(0x1120, pplr->szName), &cOut_2);
    iOff = iOff + pbIn[iOff] + 1;
  }
  if ((wVersFile >> 5 & 0x7f) < 0x37)
  {
    cOut_2 = (short)PszPlayerName(0, *(byte *)(pplr->szName[0] + 0x175f) & 1, 1, 0, 0, pplr);
    _strcpy(pplr->szNames, (char *)cOut_2);
  }
  else if (pbIn[iOff] == 0)
  {
    _strcpy(pplr->szNames, (char *)(pbIn + iOff + 1));
  }
  else
  {
    cOut_2 = 0x20;
    FDecompressUserString((char *)CONCAT22(0x1120, pbIn + iOff + 1), (uint)pbIn[iOff],
                          (char *)CONCAT22(0x1120, pplr->szNames), &cOut_2);
  }
  pplr->flags43 = pplr->flags43 & 0xfff7;
  return;
}

// ======================================================================
// Function: UpdateBattleRecords
// Address: 1070:41ac
// ======================================================================

/* WARNING: Could not reconcile some variable overlaps */

void __cdecl16far UpdateBattleRecords(void)

{
  byte bVar1;
  int iVar2;
  uint uVar3;
  int iVar4;
  undefined2 uVar5;
  undefined2 uVar6;
  short itok;
  BTLREC26 *lpbr26;
  HB *lphb;
  short cKill;
  BTLREC *lpbr;
  BTLDATA *lpbd;

  lphb = (HB *)CONCAT22(DAT_1120_0d62, DAT_1120_0d60);
  if ((DAT_1120_0d60 != 0) || (DAT_1120_0d62 != 0))
  {
    lpbd = (BTLDATA *)CONCAT22(DAT_1120_0d62, DAT_1120_0d60 + 0x12);
    while (true)
    {
      while (lpbd->id == -1)
      {
        uVar5 = (undefined2)((ulong)lphb >> 0x10);
        iVar4 = *(int *)((int)lphb + 8);
        iVar2 = *(int *)((int)lphb + 10);
        lphb = (HB *)CONCAT22(iVar2, iVar4);
        if ((iVar4 == 0) && (iVar2 == 0))
        {
          return;
        }
        if (*(uint *)(iVar4 + 6) < 0x11)
        {
          return;
        }
        lpbd = (BTLDATA *)CONCAT22(iVar2, iVar4 + 0x12);
      }
      uVar5 = (undefined2)((ulong)lpbd >> 0x10);
      iVar4 = (int)lpbd;
      if (*(int *)(iVar4 + 6) == 0)
        break;
      iVar2 = iVar4 + 0xe + (uint) * (byte *)(iVar4 + 3) * 0x1d;
      lpbr = (BTLREC *)CONCAT22(uVar5, iVar2);
      lpbr26 = (BTLREC26 *)CONCAT22(uVar5, iVar2);
      uVar3 = iVar4 + *(int *)(iVar4 + 6);
      lpbd = (BTLDATA *)CONCAT22(uVar5, uVar3);
      while ((uint)lpbr < uVar3)
      {
        uVar5 = (undefined2)((ulong)lpbr26 >> 0x10);
        bVar1 = *(byte *)((int)lpbr26 + 2);
        uVar6 = (undefined2)((ulong)lpbr >> 0x10);
        *(uint *)((uint)lpbr + 2) = (uint) * (byte *)((int)lpbr26 + 3);
        *(uint *)((uint)lpbr + 4) = *(uint *)((uint)lpbr + 4) & 0xff | (uint)bVar1 << 8;
        iVar4 = (uint)lpbr + 6 + *(int *)((uint)lpbr + 2) * 8;
        lpbr26 = (BTLREC26 *)CONCAT22(uVar6, iVar4);
        lpbr = (BTLREC *)CONCAT22(uVar6, iVar4);
      }
    }
  }
  return;
}

// ======================================================================
// Function: FReadFleet
// Address: 1070:3a4c
// ======================================================================

short __cdecl16far FReadFleet(FLEET *lpfl)

{
  int *piVar1;
  undefined2 *puVar2;
  undefined2 *puVar3;
  byte *pbVar4;
  ushort *puVar5;
  undefined4 uVar6;
  uint uVar7;
  char *sz;
  ushort uVar8;
  short sVar9;
  uint *puVar10;
  int iVar11;
  undefined2 *puVar12;
  undefined2 *puVar13;
  undefined2 *puVar14;
  undefined2 uVar15;
  undefined2 unaff_SS;
  PL *pPVar16;
  void *pvVar17;
  HeapType HVar18;
  short cOut;
  char szT[33];
  ushort *pus;
  short cch;
  byte *pb;
  short cish;
  short i;
  ORDER *lpord;
  short fByte;
  short cord;
  ushort us;

  cish = 0;
  __fmemset(lpfl, 0, 0x7c);
  __fmemmove(lpfl, rgbCur, 0xc);
  us = rgbCur._12_2_;
  pb = (byte *)((int)rgbCur + 0xe);
  if ((*(uint *)((int)lpfl + 4) >> 0xb & 1) == 0)
  {
    pus = (ushort *)((int)rgbCur + 0xe);
    i = 0;
    for (; us != 0; us = us >> 1)
    {
      if ((us & 1) != 0)
      {
        puVar5 = pus + 1;
        *(ushort *)((int)lpfl + 0xc + i * 2) = *pus;
        pus = puVar5;
        if (*(int *)((int)lpfl + 0xc + i * 2) != 0)
        {
          cish = cish + 1;
        }
      }
      i = i + 1;
    }
    pb = (byte *)pus;
  }
  else
  {
    i = 0;
    for (; us != 0; us = us >> 1)
    {
      if ((us & 1) != 0)
      {
        pbVar4 = pb + 1;
        *(uint *)((int)lpfl + 0xc + i * 2) = (uint)*pb;
        pb = pbVar4;
        if (*(int *)((int)lpfl + 0xc + i * 2) != 0)
        {
          cish = cish + 1;
        }
      }
      i = i + 1;
    }
  }
  if (cish == 0)
  {
    *(uint *)((int)lpfl + 4) = *(uint *)((int)lpfl + 4) & 0xfbff | 0x400;
  }
  if (3 < (*(uint *)((int)lpfl + 4) & 0xff))
  {
    us = *(ushort *)pb;
    pb = pb + 2;
    for (i = 0; i < 5; i = i + 1)
    {
      uVar7 = us & 3;
      if (uVar7 == 1)
      {
        puVar10 = (uint *)((int)lpfl + 0x4c + i * 4);
        *puVar10 = (uint)*pb;
        puVar10[1] = 0;
        pb = pb + 1;
      }
      else if (uVar7 == 2)
      {
        puVar12 = (undefined2 *)((int)lpfl + 0x4c + i * 4);
        *puVar12 = *(undefined2 *)pb;
        puVar12[1] = 0;
        pb = pb + 2;
      }
      else if (uVar7 == 3)
      {
        uVar15 = *(undefined2 *)(pb + 2);
        puVar12 = (undefined2 *)((int)lpfl + 0x4c + i * 4);
        *puVar12 = *(undefined2 *)pb;
        puVar12[1] = uVar15;
        pb = pb + 4;
      }
      us = us >> 2;
    }
  }
  if ((*(uint *)((int)lpfl + 4) & 0xff) < 7)
  {
    uVar15 = *(undefined2 *)(pb + 2);
    *(undefined2 *)((int)lpfl + 0x74) = *(undefined2 *)pb;
    *(undefined2 *)((int)lpfl + 0x76) = uVar15;
    uVar15 = *(undefined2 *)(pb + 6);
    *(undefined2 *)((int)lpfl + 0x2c) = *(undefined2 *)(pb + 4);
    *(undefined2 *)((int)lpfl + 0x2e) = uVar15;
    ReadRt();
    return 1;
  }
  if ((uint)hdrCur.flags1 >> 10 == 0x10)
  {
    us = *(ushort *)pb;
    pus = (ushort *)(pb + 2);
    i = 0;
    for (; us != 0; us = us >> 1)
    {
      if ((us & 1) != 0)
      {
        puVar5 = pus + 1;
        *(ushort *)((int)lpfl + 0x2c + i * 2) = *pus;
        pus = puVar5;
        if (499 < *(uint *)((int)lpfl + 0x2c + i * 2) >> 7)
        {
          *(uint *)((int)lpfl + 0x2c + i * 2) = *(uint *)((int)lpfl + 0x2c + i * 2) & 0x7f | 0xf980;
        }
      }
      i = i + 1;
    }
    *(undefined *)((int)lpfl + 0x60) = *(undefined *)pus;
    *(uint *)((int)lpfl + 0x62) = (uint) * (byte *)((int)pus + 1);
    pPVar16 = LpplAlloc(0x12, *(int *)((int)lpfl + 0x62) + 1, htOrd);
    *(undefined2 *)((int)lpfl + 100) = (int)pPVar16;
    *(undefined2 *)((int)lpfl + 0x66) = (int)((ulong)pPVar16 >> 0x10);
    __fmemset((void *)CONCAT22(*(undefined2 *)((int)lpfl + 0x66),
                               *(int *)((int)lpfl + 100) + 4),
              0,
              (*(int *)((int)lpfl + 0x62) + 1) * 0x12);
    cord = *(short *)((int)lpfl + 0x62);
    lpord = (ORDER *)CONCAT22(*(undefined2 *)((int)lpfl + 0x66), *(int *)((int)lpfl + 100) + 4);
    for (; cord != 0; cord = cord + -1)
    {
      _memset((void *)rgbCur, 0, 0x12);
      ReadRt();
      if (((uint)hdrCur.flags1 >> 10 != 0x13) &&
          ((uint)hdrCur.flags1 >> 10 != 0x14))
        goto IO_Corrupt;
      puVar12 = (undefined2 *)rgbCur;
      uVar15 = (undefined2)((ulong)lpord >> 0x10);
      puVar13 = (undefined2 *)lpord;
      puVar14 = puVar13;
      for (iVar11 = 9; iVar11 != 0; iVar11 = iVar11 + -1)
      {
        puVar3 = puVar14;
        puVar14 = puVar14 + 1;
        puVar2 = puVar12;
        puVar12 = puVar12 + 1;
        *puVar3 = *puVar2;
      }
      puVar13[3] = puVar13[3] & 0xdfff;
      lpord = (ORDER *)CONCAT22(uVar15, puVar13 + 9);
    }
    uVar6 = *(undefined4 *)((int)lpfl + 100);
    *(undefined *)((int)uVar6 + 3) = (char)*(undefined2 *)((int)lpfl + 0x62);
    if (*(int *)((int)lpfl + 6) != -1)
    {
      piVar1 = (int *)((int)lpfl + 6);
      if (*piVar1 != game.cPlanMax && game.cPlanMax <= *piVar1)
      {
        *(undefined2 *)((int)lpfl + 6) = 0xffff;
      }
      if ((*(int *)((int)lpfl + 8) !=
           *(int *)((int)rgptPlan + *(int *)((int)lpfl + 6) * 4)) ||
          (*(int *)((int)lpfl + 10) !=
           *(int *)((int)&rgptPlan[0].y + *(int *)((int)lpfl + 6) * 4)))
      {
        if ((i != 0) || (game.turn != 0))
          goto IO_Corrupt;
        iVar11 = *(int *)((int)lpfl + 6) * 4;
        uVar15 = *(undefined2 *)((int)&rgptPlan[0].y + iVar11);
        *(undefined2 *)((int)lpfl + 8) = *(undefined2 *)((int)rgptPlan + iVar11);
        *(undefined2 *)((int)lpfl + 10) = uVar15;
      }
    }
    ReadRt();
    if ((uint)hdrCur.flags1 >> 10 == 0x15)
    {
      if (rgbCur[0] == 0)
      {
        HVar18 = htString;
        uVar8 = _strlen((char *)((int)rgbCur + 1));
        pvVar17 = LpAlloc(uVar8 + 1, HVar18);
        *(undefined2 *)((int)lpfl + 0x78) = (int)pvVar17;
        *(undefined2 *)((int)lpfl + 0x7a) = (int)((ulong)pvVar17 >> 0x10);
        __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)lpfl + 0x7a),
                                   *(undefined2 *)((int)lpfl + 0x78)),
                  rgbCur + 1);
      }
      else
      {
        cOut = 0x20;
        FDecompressUserString(rgbCur + 1, (int)rgbCur[0],
                              (char *)CONCAT13((char)((uint)unaff_SS >> 8), CONCAT12((char)unaff_SS, szT)), &cOut);
        HVar18 = htString;
        uVar8 = _strlen(szT);
        pvVar17 = LpAlloc(uVar8 + 1, HVar18);
        *(undefined2 *)((int)lpfl + 0x78) = (int)pvVar17;
        *(undefined2 *)((int)lpfl + 0x7a) = (int)((ulong)pvVar17 >> 0x10);
        __fstrcpy((char *)CONCAT22(*(undefined2 *)((int)lpfl + 0x7a),
                                   *(undefined2 *)((int)lpfl + 0x78)),
                  (char *)CONCAT22(unaff_SS, szT));
      }
      ReadRt();
    }
    else
    {
      *(undefined2 *)((int)lpfl + 0x78) = 0;
      *(undefined2 *)((int)lpfl + 0x7a) = 0;
    }
    sVar9 = 1;
  }
  else
  {
  IO_Corrupt:
    sVar9 = 0x10;
    sz = PszFormatIds(idsGameFileAppearsCorruptUnableLoadFile, (short *)0x0);
    AlertSz(sz, sVar9);
    sVar9 = 0;
  }
  return sVar9;
}

// ======================================================================
// Function: FLoadGame
// Address: 1070:0810
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10702da2) */
/* WARNING: Removing unreachable block (ram,0x10701634) */
/* WARNING: Removing unreachable block (ram,0x10702d82) */
/* WARNING: Removing unreachable block (ram,0x10702da7) */
/* WARNING: Variable defined which should be unmapped: szEntry */
/* WARNING: Could not reconcile some variable overlaps */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short __cdecl16far FLoadGame(char *pszFileName, char *pszExt)

{
  int *piVar1;
  uint *puVar2;
  char *pcVar3;
  undefined2 *puVar4;
  undefined2 *puVar5;
  byte bVar6;
  int iVar7;
  undefined4 uVar8;
  byte *pbVar9;
  THING *pTVar10;
  FLEET **ppFVar11;
  undefined2 uVar12;
  short sVar13;
  short sVar14;
  short sVar15;
  char *pcVar16;
  ushort uVar17;
  int iVar18;
  uint uVar19;
  int iVar20;
  undefined2 unaff_SI;
  undefined2 *puVar21;
  int *piVar22;
  undefined2 unaff_DI;
  undefined2 *puVar23;
  undefined2 uVar24;
  undefined2 unaff_SS;
  void *pvVar25;
  PL *pPVar26;
  FLEET *lpfl_00;
  SCOREX *pSVar27;
  byte *pbVar28;
  PLANET *pPVar29;
  ulong uVar30;
  ulong uVar31;
  char szEntry[16];
  char *psz;
  char szSection[16];
  char szIniFile[16];
  char szT[256];
  short x;
  short grf;
  short dt;
  PLANET *lpplMac;
  short j;
  short iPlayer;
  THING *lpthMac;
  short cturn;
  short env[9];
  FLEET *lpfl;
  THING *lpth;
  short i;
  PLANET *lppl;
  short fSilentSav;
  short (*penvMemSav)[9];
  short fHaveHistoryData;
  short cPlanetAlloc;
  STARPACK sp;
  short cPlanetHist;
  short iplrSav;

  uVar31 = CONCAT22(unaff_SI, unaff_DI);
  grf = 0;
  cturn = 0;
  _strcpy((char *)szBase, pszFileName);
  gd.flags3 = gd.flags3 & 0xfbff;
  _penvMem = env;
  sVar13 = __setjmp(env);
  if (sVar13 == 0)
  {
    sVar13 = FOpenFile(0, -1, 0x20);
    if (sVar13 != 0)
    {
      ReadRt();
      if ((uint)hdrCur.flags1 >> 10 == 7)
      {
        puVar21 = (undefined2 *)rgbCur;
        puVar23 = (undefined2 *)&game;
        for (iVar18 = 0x20; iVar18 != 0; iVar18 = iVar18 + -1)
        {
          puVar5 = puVar23;
          puVar23 = puVar23 + 1;
          puVar4 = puVar21;
          puVar21 = puVar21 + 1;
          *puVar5 = *puVar4;
        }
        game.fDirty = 0;
        dGal = game.mdSize * 400 + 400;
        dGalInv = game.mdSize * 400 + 0x960;
        x = 1000;
        for (i = 0; i < game.cPlanMax; i = i + 1)
        {
          RgFromStream((void *)CONCAT13((char)((uint)unaff_SS >> 8), CONCAT12((char)unaff_SS, &sp)), 4);
          x = x + (sp.flags1 & 0x3ffU);
          *(int *)((int)rgptPlan + i * 4) = x;
          uVar30 = __aFulshr(uVar31, szEntry._0_2_);
          *(uint *)((int)&rgptPlan[0].y + i * 4) = (uint)uVar30 & 0xfff;
          uVar30 = __aFulshr(uVar31, szEntry._0_2_);
          *(uint *)((int)rgidPlan + i * 2) = (uint)uVar30 & 0x3ff;
          if (((dGal + 1000 <= x) ||
               (dGal + 1000 <= *(int *)((int)&rgptPlan[0].y + i * 4))) ||
              (999 < *(int *)((int)rgidPlan + i * 2)))
            goto IO_XYCorrupt;
        }
        ReadRt();
        if ((uint)hdrCur.flags1 >> 10 == 0)
        {
          StreamClose();
          if (((*pszExt == 'h') || (*pszExt == 'H')) && ((pszExt[1] == 's' || (pszExt[1] == 'S'))))
          {
            dt = 2;
            iPlayer = -1;
          }
          else
          {
            dt = 3;
            grf = 0x3000;
            sVar13 = _atoi(pszExt + 1);
            iPlayer = sVar13 + -1;
          }
          ResetMessages();
          _memset((void *)rgplr, 0, game.cPlayer * 0xc0);
          ResetHb(htShips);
          idPlayer = iPlayer;
          fSilentSav = fFileErrSilent;
          fFileErrSilent = 1;
          if (iPlayer == -1)
          {
          IO_LNoHistFile:
            cPlanetHist = 0;
            FreeLp(lpPlanets, htPlanets);
            lpPlanets._0_2_ = 0;
            lpPlanets._2_2_ = 0;
            cThing = 0;
            FreeLp(lpThings, htThings);
            lpThings = (THING *)0x0;
          }
          else
          {
            sVar13 = FOpenFile(4, iPlayer, 0x20);
            if (sVar13 == 0)
              goto IO_LNoHistFile;
            ReadRt();
            uVar19 = rgbCur._0_2_;
            vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_, (int)vlpbAiData);
            lpThings = (THING *)CONCAT22(lpThings._2_2_, (int)lpThings);
            szT._252_4_ = (byte *)CONCAT22(szT._254_2_, szT._252_2_);
            if ((uint)hdrCur.flags1 >> 10 != 0x20)
            {
            IO_CorruptHist:
              StreamClose();
              sVar13 = 0x10;
              pcVar16 = PszFormatIds(idsHistoryFileAppearsCorruptHistoricalDataWill,
                                     (short *)0x0);
              AlertSz(pcVar16, sVar13);
              goto IO_LNoHistFile;
            }
            cPlanetHist = rgbCur._0_2_;
            cPlanetAlloc = rgbCur._0_2_ + rgbCur._2_2_;
            if (1000 < cPlanetAlloc)
            {
              cPlanetAlloc = 1000;
            }
            iVar18 = cPlanetAlloc;
            if (cPlanetAlloc < 1)
            {
              iVar18 = 1;
            }
            lpPlanets = (PLANET *)LpAlloc(iVar18 * 0x38, htPlanets);
            ReadRt();
            i = 0;
            lppl = lpPlanets;
            while (true)
            {
              if ((int)uVar19 <= i)
                break;
              if ((uint)hdrCur.flags1 >> 10 != 0xe)
                goto IO_CorruptHist;
              sVar13 = FReadPlanet(iPlayer, lppl, 1, 0);
              if (sVar13 == 0)
                goto IO_CorruptHist;
              if (*(int *)((uint)lppl + 2) == iPlayer)
              {
                *(undefined2 *)((uint)lppl + 2) = 0xffff;
                *(uint *)((uint)lppl + 4) = *(uint *)((uint)lppl + 4) & 0xff00 | 3;
              }
              ReadRt();
              i = i + 1;
              lppl = (PLANET *)CONCAT22(lppl._2_2_, (uint)lppl + 0x38);
            }
            if ((uint)hdrCur.flags1 >> 10 == 0x21)
            {
              vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_, (int)vlpbAiData);
              lpThings = (THING *)CONCAT22(lpThings._2_2_, (int)lpThings);
              szT._252_4_ = (byte *)CONCAT22(szT._254_2_, szT._252_2_);
              if ((uint)cbbitfMsg < (hdrCur.flags1 & 0x3ffU))
                goto IO_CorruptHist;
              _memcpy((void *)bitfMsgFiltered, (void *)rgbCur,
                      hdrCur.flags1 & 0x3ff);
              ReadRt();
            }
            while ((uint)hdrCur.flags1 >> 10 == 6)
            {
              iVar18 = (int)rgbCur[0];
              ReadRtPlr((PLAYER *)((int)rgplr + iVar18 * 0xc0), (byte *)rgbCur);
              *(undefined2 *)((int)&rgplr[0].cPlanet + iVar18 * 0xc0) = 0;
              szT._254_2_ = *(uint *)((int)&rgplr[0].flags3 + iVar18 * 0xc0) & 0xf000;
              *(uint *)((int)&rgplr[0].flags3 + iVar18 * 0xc0) = szT._254_2_;
              ReadRt();
            }
            i = 0;
            while ((uint)hdrCur.flags1 >> 10 == 0x1a)
            {
              for (; (*(char *)((int)&rgplr[0].cShDef + i * 0xc0) == '\0' &&
                      (i < game.cPlayer));
                   i = i + 1)
              {
              }
              if (i == game.cPlayer)
                break;
              if ((*(int *)(i * 4 + 0xfe) == 0) && (*(int *)(i * 4 + 0x100) == 0))
              {
                pvVar25 = LpAlloc(0x930, htShips);
                *(undefined2 *)(i * 4 + 0xfe) = (int)pvVar25;
                *(undefined2 *)(i * 4 + 0x100) = (int)((ulong)pvVar25 >> 0x10);
                for (j = 0; j < 0x10; j = j + 1)
                {
                  szT._254_2_ = *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                  *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) = szT._254_2_;
                  *(undefined2 *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x8b) = 0;
                }
              }
              sVar13 = idPlayer;
              if (idPlayer == -1)
              {
                idPlayer = i;
              }
              else
              {
                idPlayer = -1;
              }
              uVar24 = *(undefined2 *)(i * 4 + 0x100);
              sVar14 = FReadShDef((RTSHDEF *)rgbCur,
                                  (SHDEF *)CONCAT13((char)((uint)uVar24 >> 8),
                                                    CONCAT12((char)uVar24,
                                                             *(undefined2 *)(i * 4 + 0xfe))),
                                  sVar13);
              vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_, (int)vlpbAiData);
              lpThings = (THING *)CONCAT22(lpThings._2_2_, (int)lpThings);
              szT._252_4_ = (byte *)CONCAT22(szT._254_2_, szT._252_2_);
              if (sVar14 == 0)
                goto IO_CorruptHist;
              pcVar3 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
              idPlayer = sVar13;
              *pcVar3 = *pcVar3 + -1;
              ReadRt();
            }
            i = 0;
            while ((uint)hdrCur.flags1 >> 10 == 0x1a)
            {
              for (; (*(uint *)((int)&rgplr[0].flags3 + i * 0xc0) >> 0xc == 0 &&
                      (i < game.cPlayer));
                   i = i + 1)
              {
              }
              if (i == game.cPlayer)
                break;
              if ((*(int *)(i * 4 + 0x14c) == 0) && (*(int *)(i * 4 + 0x14e) == 0))
              {
                pvVar25 = LpAlloc(0x5be, htShips);
                *(undefined2 *)(i * 4 + 0x14c) = (int)pvVar25;
                *(undefined2 *)(i * 4 + 0x14e) = (int)((ulong)pvVar25 >> 0x10);
                for (j = 0; j < 10; j = j + 1)
                {
                  szT._254_2_ = *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfdff |
                                0x200;
                  *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) = szT._254_2_;
                  *(undefined2 *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x8b) = 0;
                }
              }
              sVar13 = idPlayer;
              if (idPlayer == -1)
              {
                idPlayer = i;
              }
              else
              {
                idPlayer = -1;
              }
              uVar24 = *(undefined2 *)(i * 4 + 0x14e);
              sVar14 = FReadShDef((RTSHDEF *)rgbCur,
                                  (SHDEF *)CONCAT13((char)((uint)uVar24 >> 8),
                                                    CONCAT12((char)uVar24,
                                                             *(undefined2 *)(i * 4 + 0x14c))),
                                  sVar13);
              vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_, (int)vlpbAiData);
              lpThings = (THING *)CONCAT22(lpThings._2_2_, (int)lpThings);
              szT._252_4_ = (byte *)CONCAT22(szT._254_2_, szT._252_2_);
              if (sVar14 == 0)
                goto IO_CorruptHist;
              szT._254_2_ = *(int *)((int)&rgplr[0].flags3 + i * 0xc0) - 0x1000U & 0xf000;
              puVar2 = (uint *)((int)&rgplr[0].flags3 + i * 0xc0);
              idPlayer = sVar13;
              *puVar2 = *puVar2 & 0xfff;
              puVar2 = (uint *)((int)&rgplr[0].flags3 + i * 0xc0);
              *puVar2 = *puVar2 | szT._254_2_;
              ReadRt();
            }
            while (true)
            {
              pbVar9 = (byte *)CONCAT22(szT._254_2_, szT._252_2_);
              pbVar28 = (byte *)CONCAT22(vlpbAiData._2_2_, (int)vlpbAiData);
              if ((uint)hdrCur.flags1 >> 10 != 0x2d)
                break;
              szT._254_2_ = rgbCur._0_2_ & 0x1f;
              puVar23 = (undefined2 *)rgbCur;
              puVar21 = (undefined2 *)(szT + 0xe6);
              for (iVar18 = 0xc; iVar18 != 0; iVar18 = iVar18 + -1)
              {
                puVar5 = puVar21;
                puVar21 = puVar21 + 1;
                puVar4 = puVar23;
                puVar23 = puVar23 + 1;
                *puVar5 = *puVar4;
              }
              if ((*(int *)((int)rgsxPlr + szT._254_2_ * 4) == 0) &&
                  (*(int *)(szT._254_2_ * 4 + 0x156e) == 0))
              {
                pvVar25 = LpAlloc(0x978, htMisc);
                *(undefined2 *)((int)rgsxPlr + szT._254_2_ * 4) = (int)pvVar25;
                *(undefined2 *)(szT._254_2_ * 4 + 0x156e) = (int)((ulong)pvVar25 >> 0x10);
                *(undefined2 *)((int)rgcsxPlr + szT._254_2_ * 2) = 0;
              }
              if ((*(int *)((int)rgsxPlr + szT._254_2_ * 4) != 0) ||
                  (*(int *)(szT._254_2_ * 4 + 0x156e) != 0))
              {
                if (szT._230_2_ < 0)
                {
                  szT._226_2_ = szT._232_2_;
                }
                else
                {
                  szT._226_2_ = game.turn;
                }
                szT._228_2_ = 0;
                while ((szT._228_2_ < *(int *)((int)rgcsxPlr + szT._254_2_ * 2) &&
                        (*(uint *)(*(int *)((int)rgsxPlr + szT._254_2_ * 4) +
                                   szT._228_2_ * 0x18 + 2) < szT._226_2_)))
                {
                  szT._228_2_ = szT._228_2_ + 1;
                }
                if (((szT._228_2_ < *(int *)((int)rgcsxPlr + szT._254_2_ * 2)) &&
                     (szT._226_2_ !=
                      *(uint *)(*(int *)((int)rgsxPlr + szT._254_2_ * 4) + szT._228_2_ * 0x18 + 2))) ||
                    (100 < szT._228_2_))
                {
                  if (*(int *)((int)rgcsxPlr + szT._254_2_ * 2) < 0x65)
                  {
                    uVar24 = *(undefined2 *)(szT._254_2_ * 4 + 0x156e);
                    __fmemmove((void *)CONCAT22(*(undefined2 *)(szT._254_2_ * 4 + 0x156e),
                                                *(int *)((int)rgsxPlr +
                                                         szT._254_2_ * 4) +
                                                    (szT._228_2_ + 1) * 0x18),
                               (void *)CONCAT13((char)((uint)uVar24 >> 8),
                                                CONCAT12((char)uVar24,
                                                         *(int *)((int)rgsxPlr +
                                                                  szT._254_2_ * 4) +
                                                             szT._228_2_ * 0x18)),
                               (*(int *)((int)rgcsxPlr + szT._254_2_ * 2) -
                                szT._228_2_) *
                                   0x18);
                    piVar1 = (int *)((int)rgcsxPlr + szT._254_2_ * 2);
                    *piVar1 = *piVar1 + 1;
                  }
                  else if (0 < szT._228_2_)
                  {
                    if (1 < szT._228_2_)
                    {
                      uVar24 = *(undefined2 *)(szT._254_2_ * 4 + 0x156e);
                      __fmemmove((void *)CONCAT22(*(undefined2 *)(szT._254_2_ * 4 + 0x156e),
                                                  *(undefined2 *)((int)rgsxPlr + szT._254_2_ * 4)),
                                 (void *)CONCAT13((char)((uint)uVar24 >> 8),
                                                  CONCAT12((char)uVar24,
                                                           *(int *)((int)rgsxPlr +
                                                                    szT._254_2_ * 4) +
                                                               0x18)),
                                 (szT._228_2_ + -1) * 0x18);
                    }
                    szT._228_2_ = szT._228_2_ + -1;
                  }
                }
                else if (szT._228_2_ == *(int *)((int)rgcsxPlr + szT._254_2_ * 2))
                {
                  piVar1 = (int *)((int)rgcsxPlr + szT._254_2_ * 2);
                  *piVar1 = *piVar1 + 1;
                }
                uVar24 = *(undefined2 *)(szT._254_2_ * 4 + 0x156e);
                puVar23 = (undefined2 *)(*(int *)((int)rgsxPlr + szT._254_2_ * 4) + szT._228_2_ * 0x18);
                puVar21 = (undefined2 *)(szT + 0xe6);
                for (iVar18 = 0xc; iVar18 != 0; iVar18 = iVar18 + -1)
                {
                  puVar5 = puVar23;
                  puVar23 = puVar23 + 1;
                  puVar4 = puVar21;
                  puVar21 = puVar21 + 1;
                  *puVar5 = *puVar4;
                }
                *(uint *)(*(int *)((int)rgsxPlr + szT._254_2_ * 4) + szT._228_2_ * 0x18 + 2) = szT._226_2_;
                szT._224_2_ = *(uint *)(*(int *)((int)rgsxPlr + szT._254_2_ * 4) +
                                        szT._228_2_ * 0x18) &
                                  0x7fff |
                              0x8000;
                *(uint *)(*(int *)((int)rgsxPlr + szT._254_2_ * 4) + szT._228_2_ * 0x18) =
                    szT._224_2_;
              }
              ReadRt();
            }
            if ((uint)hdrCur.flags1 >> 10 == 0x29)
            {
              if ((*(uint *)((int)&rgplr[0].flags4 + idPlayer * 0xc0) >> 9 & 1) ==
                  0)
              {
                while (true)
                {
                  pbVar9 = (byte *)CONCAT22(szT._254_2_, szT._252_2_);
                  pbVar28 = (byte *)CONCAT22(vlpbAiData._2_2_, (int)vlpbAiData);
                  if ((uint)hdrCur.flags1 >> 10 != 0x29)
                    break;
                  ReadRt();
                }
              }
              else
              {
                vlpbAiData = (byte *)CONCAT22(vlpbAiData._2_2_, (int)vlpbAiData);
                pbVar9 = (byte *)CONCAT22(vlpbAiData._2_2_, (int)vlpbAiData);
                if (((int)vlpbAiData == 0) &&
                    (vlpbAiData = pbVar28, pbVar9 = pbVar28, vlpbAiData._2_2_ == 0))
                {
                  vlpbAiData =
                      (byte *)LpAlloc((int)s_R6002___floating_point_support_n_1120_1f8f +
                                          0x11,
                                      htMisc);
                  pbVar9 = vlpbAiData;
                  if (vlpbAiData == (byte *)0x0)
                    goto IO_CorruptHist;
                }
                while (pbVar28 = vlpbAiData, (uint)hdrCur.flags1 >> 10 == 0x29)
                {
                  szT._252_4_ = pbVar9;
                  __fmemmove(pbVar9, rgbCur, hdrCur.flags1 & 0x3ff);
                  szT._252_2_ = szT._252_2_ + (hdrCur.flags1 & 0x3ffU);
                  ReadRt();
                  pbVar9 = (byte *)CONCAT22(szT._254_2_, szT._252_2_);
                }
              }
            }
            if ((uint)hdrCur.flags1 >> 10 == 0x2b)
            {
              cThing = rgbCur._0_2_;
              cThingAlloc = rgbCur._0_2_ + 10;
              if (0xfd2 < cThingAlloc)
              {
                cThingAlloc = 0xfd2;
              }
              vlpbAiData = pbVar28;
              szT._252_4_ = pbVar9;
              lpThings = (THING *)LpAlloc(cThingAlloc * 0x12, htThings);
              if (lpThings == (THING *)0x0)
                goto IO_CorruptHist;
              __fmemset(lpThings, 0, cThingAlloc * 0x12);
              ReadRt();
              lpth = lpThings;
              pbVar9 = szT._252_4_;
              for (i = 0; pbVar28 = vlpbAiData, i < cThing; i = i + 1)
              {
                szT._252_4_ = pbVar9;
                if ((uint)hdrCur.flags1 >> 10 != 0x2b)
                  goto IO_CorruptHist;
                __fmemcpy(lpth, rgbCur, hdrCur.flags1 & 0x3ff);
                ReadRt();
                lpth = (THING *)CONCAT22(lpth._2_2_, (uint)lpth + 0x12);
                pbVar9 = szT._252_4_;
              }
            }
            vlpbAiData = pbVar28;
            szT._252_4_ = pbVar9;
            StreamClose();
          }
          fFileErrSilent = fSilentSav;
          GetFileStatus(dt, iPlayer);
          sVar13 = FOpenFile(dt | grf, iPlayer, 0x20);
          if (sVar13 != 0)
          {
            if (iPlayer == -1)
            {
              szT._252_4_ = (byte *)(CONCAT22((uint)rgbCur._14_2_ >> 0xb, szT._252_2_) &
                                     0x1ffff);
              gd.flags2 =
                  gd.flags2 & 0xfffeU | (uint)rgbCur._14_2_ >> 0xb & 1;
            }
            do
            {
              cturn = cturn + 1;
              cPlanet = 0;
              cFleet = 0;
              ReadRt();
              while (((uint)hdrCur.flags1 >> 10 == 0x1f ||
                      ((uint)hdrCur.flags1 >> 10 == 0x27)))
              {
                if ((uint)hdrCur.flags1 >> 10 != 0x27)
                {
                  if (lpbBattleLog == (byte *)0x0)
                  {
                    lpbBattleCur = (byte *)LpAlloc(0xffc8, htBattle);
                    lpbBattleLog = lpbBattleCur;
                  }
                  if (((uint)lpbBattleCur < 0xffc9) &&
                      (-(uint)lpbBattleCur - 0x38 < rgbCur._6_2_))
                  {
                    *(undefined2 *)lpbBattleCur = 0xffff;
                    lpbBattleCur = (byte *)LpAlloc(0xffc8, htBattle);
                  }
                }
                __fmemmove(lpbBattleCur, rgbCur,
                           hdrCur.flags1 & 0x3ff);
                lpbBattleCur =
                    (byte *)CONCAT22(lpbBattleCur._2_2_,
                                     (uint)lpbBattleCur + (hdrCur.flags1 & 0x3ffU));
                ReadRt();
              }
              if ((((uint)lpbBattleCur != 0) || (lpbBattleCur._2_2_ != 0)) &&
                  (*(undefined2 *)lpbBattleCur = 0xffff, (wVersFile >> 5 & 0x7f) < 0x50))
              {
                UpdateBattleRecords();
              }
              while ((uint)hdrCur.flags1 >> 10 == 6)
              {
                iVar18 = (int)rgbCur[0];
                ReadRtPlr((PLAYER *)((int)rgplr + iVar18 * 0xc0), (byte *)rgbCur);
                cPlanet =
                    cPlanet + *(int *)((int)&rgplr[0].cPlanet + iVar18 * 0xc0);
                *(undefined2 *)((int)&rgplr[0].cPlanet + iVar18 * 0xc0) = 0;
                cFleet =
                    cFleet +
                    (*(uint *)((int)&rgplr[0].flags3 + iVar18 * 0xc0) & 0xfff);
                szT._254_2_ = *(uint *)((int)&rgplr[0].flags3 + iVar18 * 0xc0) & 0xf000;
                *(uint *)((int)&rgplr[0].flags3 + iVar18 * 0xc0) = szT._254_2_;
                ReadRt();
              }
              if (dt == 2)
              {
                if ((uint)hdrCur.flags1 >> 10 == 0x24)
                {
                  lSaltCur._0_2_ = rgbCur._0_2_;
                  lSaltCur._2_2_ = rgbCur._2_2_;
                  ReadRt();
                }
                else
                {
                  lSaltCur._0_2_ = 0;
                  lSaltCur._2_2_ = 0;
                }
              }
              else
              {
                lSaltCur._0_2_ = *(uint *)((int)&rgplr[0].lSalt + iPlayer * 0xc0);
                lSaltCur._2_2_ =
                    *(undefined2 *)((int)&rgplr[0].lSalt + 2 + iPlayer * 0xc0);
              }
              sVar13 = FCheckPassword();
              if (sVar13 == 0)
              {
                if ((((uint)ini.flags6 >> 0xe & 1) != 0) || (ini.flags6 < 0))
                {
                  sVar13 = 0x10;
                  pcVar16 = PszFormatIds(idsPasswordHaveEnteredIncorrectPleaseTry, (short *)0x0);
                  AlertSz(pcVar16, sVar13);
                }
                break;
              }
              ReadPlayerMessages();
              ResetHb(htFleets);
              ResetHb(htOrd);
              FreeLp(rglpfl, htMisc);
              rglpfl._0_2_ = 0;
              rglpfl._2_2_ = 0;
              lppl = lpPlanets;
              if (lpPlanets == (PLANET *)0x0)
              {
                cPlanetAlloc = cPlanet;
                if (cPlanet < 1)
                {
                  cPlanetAlloc = 1;
                }
                pvVar25 = LpAlloc(cPlanetAlloc * 0x38, htPlanets);
                /* WARNING: Ignoring partial resolution of indirect */
                lpPlanets._0_2_ = (int)pvVar25;
                /* WARNING: Ignoring partial resolution of indirect */
                lpPlanets._2_2_ = (int)((ulong)pvVar25 >> 0x10);
                lppl = lpPlanets;
              }
              j = 0;
              lpPlanets = lppl;
              for (i = 0; i < cPlanet; i = i + 1)
              {
                fHaveHistoryData = 0;
                if (cPlanetHist != 0)
                {
                  while ((j < cPlanetHist && (lppl->id < (int)(rgbCur._0_2_ << 5) >> 5)))
                  {
                    j = j + 1;
                    lppl = (PLANET *)CONCAT22(lppl._2_2_, (uint)lppl + 0x38);
                  }
                  if ((j < cPlanetHist) && ((int)(rgbCur._0_2_ << 5) >> 5 == lppl->id))
                  {
                    fHaveHistoryData = 1;
                  }
                  else
                  {
                    if (cPlanetAlloc == cPlanetHist)
                    {
                      cPlanetAlloc = cPlanetAlloc + 8;
                      pvVar25 = LpReAlloc(lpPlanets, cPlanetAlloc * 0x38, htPlanets);
                      /* WARNING: Ignoring partial resolution of indirect */
                      lpPlanets._0_2_ = (int)pvVar25;
                      /* WARNING: Ignoring partial resolution of indirect */
                      lpPlanets._2_2_ = (int)((ulong)pvVar25 >> 0x10);
                      lppl = (PLANET *)
                          CONCAT22(lpPlanets._2_2_, (int)lpPlanets + j * 0x38);
                    }
                    if (j < cPlanetHist)
                    {
                      __fmemmove((void *)CONCAT22(lppl._2_2_, (uint)lppl + 0x38), lppl,
                                 (cPlanetHist - j) * 0x38);
                    }
                    cPlanetHist = cPlanetHist + 1;
                  }
                }
                sVar14 = FReadPlanet(iPlayer, lppl, 0, fHaveHistoryData);
                sVar13 = idPlayer;
                if (sVar14 == 0)
                  goto IO_Corrupt_2;
                if (*(int *)((uint)lppl + 2) != -1)
                {
                  piVar1 = (int *)((int)&rgplr[0].cPlanet +
                                   *(int *)((uint)lppl + 2) * 0xc0);
                  *piVar1 = *piVar1 + 1;
                }
                ReadRt();
                if ((uint)hdrCur.flags1 >> 10 == 0x1c)
                {
                  if ((*(int *)((uint)lppl + 0x34) != 0) ||
                      (pbVar28 = szT._252_4_, *(int *)((uint)lppl + 0x36) != 0))
                  {
                    uVar8 = *(undefined4 *)((uint)lppl + 0x34);
                    bVar6 = *(byte *)((int)uVar8 + 2);
                    szT._254_2_ = (uint)bVar6;
                    pbVar28 = (byte *)(ulong)CONCAT12(bVar6, szT._252_2_);
                    if (szT._254_2_ <= (hdrCur.flags1 & 0x3ffU) / 4)
                    {
                      FreePl((PL *)CONCAT22(*(undefined2 *)((uint)lppl + 0x36),
                                            *(undefined2 *)((uint)lppl + 0x34)));
                      *(undefined2 *)((uint)lppl + 0x34) = 0;
                      *(undefined2 *)((uint)lppl + 0x36) = 0;
                      pbVar28 = (byte *)CONCAT22(szT._254_2_, szT._252_2_);
                    }
                  }
                  if ((*(int *)((uint)lppl + 0x34) == 0) && (*(int *)((uint)lppl + 0x36) == 0))
                  {
                    szT._252_4_ = pbVar28;
                    pPVar26 = LpplAlloc(4, (hdrCur.flags1 & 0x3ffU) / 4 + 2, htOrd);
                    *(undefined2 *)((uint)lppl + 0x34) = (int)pPVar26;
                    *(undefined2 *)((uint)lppl + 0x36) = (int)((ulong)pPVar26 >> 0x10);
                    pbVar28 = szT._252_4_;
                  }
                  szT._252_4_ = pbVar28;
                  __fmemmove((void *)CONCAT22(*(undefined2 *)((uint)lppl + 0x36),
                                              *(int *)((uint)lppl + 0x34) + 4),
                             rgbCur, hdrCur.flags1 & 0x3ff);
                  uVar8 = *(undefined4 *)((uint)lppl + 0x34);
                  *(undefined *)((int)uVar8 + 3) =
                      (char)((ulong)(hdrCur.flags1 & 0x3ff) / 4);
                  ReadRt();
                }
                if (cPlanetHist == 0)
                {
                  lppl = (PLANET *)CONCAT22(lppl._2_2_, (uint)lppl + 0x38);
                }
              }
              if (cPlanetHist != 0)
              {
                cPlanet = cPlanetHist;
              }
              i = 0;
              pbVar28 = szT._252_4_;
              while (true)
              {
                szT._254_2_ = (uint)((ulong)pbVar28 >> 0x10);
                szT._252_2_ = (uint)pbVar28;
                if (game.cPlayer <= i)
                  break;
                if (i == iPlayer)
                {
                  *(undefined2 *)(i * 4 + 0xfe) = 0x3f00;
                  *(undefined2 *)(i * 4 + 0x100) = 0x1120;
                IO_FreeShdef:
                  szT._254_2_ = (uint)((ulong)pbVar28 >> 0x10);
                  szT._252_2_ = (uint)pbVar28;
                  for (j = 0; pbVar28 = (byte *)CONCAT22(szT._254_2_, szT._252_2_), j < 0x10;
                       j = j + 1)
                  {
                    szT._254_2_ = *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfdff |
                                  0x200;
                    *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) = szT._254_2_;
                    *(undefined2 *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x8b) = 0;
                  }
                LAB_1070_1c2c:
                  sVar14 = idPlayer;
                  if (idPlayer == -1)
                  {
                    idPlayer = i;
                  }
                  else if (i != idPlayer)
                  {
                    idPlayer = -1;
                  }
                  szT._252_4_ = pbVar28;
                  for (j = 0; pbVar28 = szT._252_4_,
                      j < *(char *)((int)&rgplr[0].cShDef + i * 0xc0);
                       j = j + 1)
                  {
                    sVar13 = sVar14;
                    if ((uint)hdrCur.flags1 >> 10 != 0x1a)
                      goto IO_Corrupt_2;
                    uVar24 = *(undefined2 *)(i * 4 + 0x100);
                    sVar15 = FReadShDef((RTSHDEF *)rgbCur,
                                        (SHDEF *)CONCAT13((char)((uint)uVar24 >> 8),
                                                          CONCAT12((char)uVar24,
                                                                   *(undefined2 *)(i * 4 + 0xfe))),
                                        sVar14);
                    sVar13 = idPlayer;
                    if (sVar15 == 0)
                      goto IO_Corrupt_2;
                    ReadRt();
                  }
                }
                else
                {
                  sVar14 = idPlayer;
                  if ((*(uint *)((int)&rgplr[0].flags4 + i * 0xc0) >> 8 & 1) != 0)
                  {
                    if ((*(int *)(i * 4 + 0xfe) == 0) && (*(int *)(i * 4 + 0x100) == 0))
                    {
                      szT._252_4_ = pbVar28;
                      pvVar25 = LpAlloc(0x930, htShips);
                      *(undefined2 *)(i * 4 + 0xfe) = (int)pvVar25;
                      *(undefined2 *)(i * 4 + 0x100) = (int)((ulong)pvVar25 >> 0x10);
                      pbVar28 = szT._252_4_;
                      goto IO_FreeShdef;
                    }
                    goto LAB_1070_1c2c;
                  }
                }
                idPlayer = sVar14;
                i = i + 1;
              }
              for (i = 0; i < game.cPlayer; i = i + 1)
              {
                *(undefined *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
                if ((*(int *)(i * 4 + 0xfe) != 0) || (*(int *)(i * 4 + 0x100) != 0))
                {
                  for (j = 0; j < 0x10; j = j + 1)
                  {
                    if ((*(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) >> 9 & 1) == 0)
                    {
                      if (((i == idPlayer) || (((uint)gd.flags1 >> 1 & 1) != 0)) ||
                          ((*(uint *)((int)&rgplr[0].flags43 + i * 0xc0) & 1) == 0))
                      {
                        pcVar3 = (char *)((int)&rgplr[0].cShDef + i * 0xc0);
                        *pcVar3 = *pcVar3 + '\x01';
                      }
                      else
                      {
                        szT._254_2_ = *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0xfdff |
                                      0x200;
                        *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) = szT._254_2_;
                      }
                    }
                  }
                }
              }
              iVar18 = cFleet;
              if (cFleet < 1)
              {
                iVar18 = 1;
              }
              rglpfl = (FLEET **)LpAlloc(iVar18 << 2, htMisc);
              for (i = 0; i < cFleet; i = i + 1)
              {
                lpfl_00 = (FLEET *)LpAlloc(0x7c, htFleets);
                uVar24 = rglpfl._2_2_;
                iVar20 = (int)((ulong)lpfl_00 >> 0x10);
                iVar18 = (int)lpfl_00;
                piVar22 = (int *)((int)rglpfl + i * 4);
                *piVar22 = iVar18;
                piVar22[1] = iVar20;
                sVar13 = FReadFleet(lpfl_00);
                if (sVar13 == 0)
                  goto IO_LError_2;
                szT._254_2_ = *(int *)((int)&rgplr[0].flags3 + *(int *)(iVar18 + 2) * 0xc0) + 1U & 0xfff;
                puVar2 = (uint *)((int)&rgplr[0].flags3 + *(int *)(iVar18 + 2) * 0xc0);
                *puVar2 = *puVar2 & 0xf000;
                puVar2 = (uint *)((int)&rgplr[0].flags3 + *(int *)(iVar18 + 2) * 0xc0);
                *puVar2 = *puVar2 | szT._254_2_;
              }
              for (i = 0; i < game.cPlayer; i = i + 1)
              {
                sVar14 = idPlayer;
                if ((*(uint *)((int)&rgplr[0].flags4 + i * 0xc0) >> 8 & 1) != 0)
                {
                  if ((*(int *)(i * 4 + 0x14c) == 0) && (*(int *)(i * 4 + 0x14e) == 0))
                  {
                    pvVar25 = LpAlloc(0x5be, htShips);
                    *(undefined2 *)(i * 4 + 0x14c) = (int)pvVar25;
                    *(undefined2 *)(i * 4 + 0x14e) = (int)((ulong)pvVar25 >> 0x10);
                    for (j = 0; j < 10; j = j + 1)
                    {
                      szT._254_2_ = *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfdff |
                                    0x200;
                      *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) = szT._254_2_;
                      *(undefined2 *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x8b) = 0;
                    }
                  }
                  sVar14 = idPlayer;
                  if (idPlayer == -1)
                  {
                    idPlayer = i;
                  }
                  else if (i != idPlayer)
                  {
                    idPlayer = -1;
                  }
                  for (j = 0; j < (int)(*(uint *)((int)&rgplr[0].flags3 + i * 0xc0) >> 0xc); j = j + 1)
                  {
                    sVar13 = sVar14;
                    if ((uint)hdrCur.flags1 >> 10 != 0x1a)
                      goto IO_Corrupt_2;
                    uVar24 = *(undefined2 *)(i * 4 + 0x14e);
                    sVar15 = FReadShDef((RTSHDEF *)rgbCur,
                                        (SHDEF *)CONCAT13((char)((uint)uVar24 >> 8),
                                                          CONCAT12((char)uVar24,
                                                                   *(undefined2 *)(i * 4 + 0x14c))),
                                        sVar14);
                    sVar13 = idPlayer;
                    if (sVar15 == 0)
                      goto IO_Corrupt_2;
                    ReadRt();
                  }
                }
                idPlayer = sVar14;
              }
              pSVar27 = vlprgScoreX;
              for (i = 0; vlprgScoreX = pSVar27, i < game.cPlayer; i = i + 1)
              {
                szT._254_2_ = *(uint *)((int)&rgplr[0].flags3 + i * 0xc0) & 0xfff;
                *(uint *)((int)&rgplr[0].flags3 + i * 0xc0) = szT._254_2_;
                if ((*(int *)(i * 4 + 0x14c) != 0) ||
                    (pSVar27 = vlprgScoreX, *(int *)(i * 4 + 0x14e) != 0))
                {
                  for (j = 0; pSVar27 = vlprgScoreX, j < 10; j = j + 1)
                  {
                    if ((*(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) >> 9 & 1) == 0)
                    {
                      if (((i == idPlayer) || (((uint)gd.flags1 >> 1 & 1) != 0)) ||
                          ((*(uint *)((int)&rgplr[0].flags43 + i * 0xc0) & 1) == 0))
                      {
                        szT._254_2_ = *(int *)((int)&rgplr[0].flags3 + i * 0xc0) + 0x1000U & 0xf000;
                        puVar2 = (uint *)((int)&rgplr[0].flags3 + i * 0xc0);
                        *puVar2 = *puVar2 & 0xfff;
                        puVar2 = (uint *)((int)&rgplr[0].flags3 + i * 0xc0);
                        *puVar2 = *puVar2 | szT._254_2_;
                      }
                      else
                      {
                        szT._254_2_ = *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) & 0xfdff | 0x200;
                        *(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) = szT._254_2_;
                      }
                    }
                  }
                }
              }
              if (pSVar27 == (SCOREX *)0x0)
              {
                pSVar27 = (SCOREX *)LpAlloc(game.cPlayer * 0x18, htMisc);
                vlprgScoreX = pSVar27;
                __fmemset(pSVar27, 0, game.cPlayer * 0x18);
                pSVar27 = vlprgScoreX;
              }
              while (true)
              {
                vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar27 >> 0x10);
                uVar24 = vlprgScoreX._2_2_;
                vlprgScoreX._0_2_ = (int)pSVar27;
                vlprgScoreX = pSVar27;
                if ((uint)hdrCur.flags1 >> 10 != 0x2d)
                  break;
                szT._254_2_ = rgbCur._0_2_ & 0x1f;
                puVar23 = (undefined2 *)((int)vlprgScoreX + szT._254_2_ * 0x18);
                puVar21 = (undefined2 *)rgbCur;
                for (iVar18 = 0xc; iVar18 != 0; iVar18 = iVar18 + -1)
                {
                  puVar5 = puVar23;
                  puVar23 = puVar23 + 1;
                  puVar4 = puVar21;
                  puVar21 = puVar21 + 1;
                  *puVar5 = *puVar4;
                }
                pSVar27 = vlprgScoreX;
                if ((*(int *)((int)rgsxPlr + szT._254_2_ * 4) == 0) &&
                    (*(int *)(szT._254_2_ * 4 + 0x156e) == 0))
                {
                  pvVar25 = LpAlloc(0x978, htMisc);
                  *(undefined2 *)((int)rgsxPlr + szT._254_2_ * 4) = (int)pvVar25;
                  *(undefined2 *)(szT._254_2_ * 4 + 0x156e) = (int)((ulong)pvVar25 >> 0x10);
                  *(undefined2 *)((int)rgcsxPlr + szT._254_2_ * 2) = 0;
                  pSVar27 = vlprgScoreX;
                }
                vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar27 >> 0x10);
                vlprgScoreX._0_2_ = (int)pSVar27;
                if ((*(int *)((int)rgsxPlr + szT._254_2_ * 4) != 0) ||
                    (*(int *)(szT._254_2_ * 4 + 0x156e) != 0))
                {
                  if (*(int *)((int)vlprgScoreX + szT._254_2_ * 0x18) < 0)
                  {
                    szT._250_2_ = *(uint *)((int)vlprgScoreX + szT._254_2_ * 0x18 + 2);
                  }
                  else
                  {
                    szT._250_2_ = game.turn;
                  }
                  szT._252_2_ = 0;
                  while (((int)szT._252_2_ < *(int *)((int)rgcsxPlr + szT._254_2_ * 2) &&
                          (*(uint *)(*(int *)((int)rgsxPlr + szT._254_2_ * 4) +
                                     szT._252_2_ * 0x18 + 2) < szT._250_2_)))
                  {
                    szT._252_2_ = szT._252_2_ + 1;
                  }
                  vlprgScoreX = pSVar27;
                  if ((((int)szT._252_2_ < *(int *)((int)rgcsxPlr + szT._254_2_ * 2)) &&
                       (szT._250_2_ !=
                        *(uint *)(*(int *)((int)rgsxPlr + szT._254_2_ * 4) +
                                  szT._252_2_ * 0x18 + 2))) ||
                      (100 < (int)szT._252_2_))
                  {
                    if (*(int *)((int)rgcsxPlr + szT._254_2_ * 2) < 0x65)
                    {
                      uVar24 = *(undefined2 *)(szT._254_2_ * 4 + 0x156e);
                      __fmemmove((void *)CONCAT22(*(undefined2 *)(szT._254_2_ * 4 + 0x156e),
                                                  *(int *)((int)rgsxPlr +
                                                           szT._254_2_ * 4) +
                                                      (szT._252_2_ + 1) * 0x18),
                                 (void *)CONCAT13((char)((uint)uVar24 >> 8),
                                                  CONCAT12((char)uVar24,
                                                           *(int *)((int)rgsxPlr +
                                                                    szT._254_2_ * 4) +
                                                               szT._252_2_ * 0x18)),
                                 (*(int *)((int)rgcsxPlr + szT._254_2_ * 2) -
                                  szT._252_2_) *
                                     0x18);
                      piVar1 = (int *)((int)rgcsxPlr + szT._254_2_ * 2);
                      *piVar1 = *piVar1 + 1;
                      pSVar27 = vlprgScoreX;
                    }
                    else if (0 < (int)szT._252_2_)
                    {
                      if (1 < (int)szT._252_2_)
                      {
                        uVar24 = *(undefined2 *)(szT._254_2_ * 4 + 0x156e);
                        __fmemmove((void *)CONCAT22(*(undefined2 *)(szT._254_2_ * 4 + 0x156e),
                                                    *(undefined2 *)((int)rgsxPlr + szT._254_2_ * 4)),
                                   (void *)CONCAT13((char)((uint)uVar24 >> 8),
                                                    CONCAT12((char)uVar24,
                                                             *(int *)((int)rgsxPlr +
                                                                      szT._254_2_ * 4) +
                                                                 0x18)),
                                   (szT._252_2_ - 1) * 0x18);
                        pSVar27 = vlprgScoreX;
                      }
                      szT._252_2_ = szT._252_2_ - 1;
                    }
                  }
                  else if (szT._252_2_ == *(uint *)((int)rgcsxPlr + szT._254_2_ * 2))
                  {
                    piVar1 = (int *)((int)rgcsxPlr + szT._254_2_ * 2);
                    *piVar1 = *piVar1 + 1;
                    pSVar27 = vlprgScoreX;
                  }
                  vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar27 >> 0x10);
                  uVar12 = vlprgScoreX._2_2_;
                  vlprgScoreX._0_2_ = (int)pSVar27;
                  puVar21 = (undefined2 *)((int)vlprgScoreX + szT._254_2_ * 0x18);
                  uVar24 = *(undefined2 *)(szT._254_2_ * 4 + 0x156e);
                  puVar23 = (undefined2 *)(*(int *)((int)rgsxPlr + szT._254_2_ * 4) + szT._252_2_ * 0x18);
                  vlprgScoreX = pSVar27;
                  for (iVar18 = 0xc; iVar18 != 0; iVar18 = iVar18 + -1)
                  {
                    puVar5 = puVar23;
                    puVar23 = puVar23 + 1;
                    puVar4 = puVar21;
                    puVar21 = puVar21 + 1;
                    *puVar5 = *puVar4;
                  }
                  *(uint *)(*(int *)((int)rgsxPlr + szT._254_2_ * 4) + szT._252_2_ * 0x18 + 2) = szT._250_2_;
                  szT._248_2_ = *(uint *)(*(int *)((int)rgsxPlr + szT._254_2_ * 4) +
                                          szT._252_2_ * 0x18) &
                                    0x7fff |
                                0x8000;
                  *(uint *)(*(int *)((int)rgsxPlr + szT._254_2_ * 4) + szT._252_2_ * 0x18) =
                      szT._248_2_;
                  pSVar27 = vlprgScoreX;
                }
                vlprgScoreX = pSVar27;
                ReadRt();
                pSVar27 = vlprgScoreX;
              }
              if (lpThings != (THING *)0x0)
              {
                FreeLp(lpThings, htThings);
                /* WARNING: Ignoring partial resolution of indirect */
                lpThings._0_2_ = 0;
                /* WARNING: Ignoring partial resolution of indirect */
                lpThings._2_2_ = 0;
                cThing = 0;
                pSVar27 = vlprgScoreX;
              }
              vlprgScoreX = pSVar27;
              if ((uint)hdrCur.flags1 >> 10 == 0x2b)
              {
                szT._252_2_ = (uint)(0 < cThing);
                szT._254_2_ = rgbCur._0_2_;
                cThingAlloc = rgbCur._0_2_;
                if ((int)rgbCur._0_2_ < 10)
                {
                  cThingAlloc = 10;
                }
                if (lpThings == (THING *)0x0)
                {
                  pvVar25 = LpAlloc(cThingAlloc * 0x12, htThings);
                  /* WARNING: Ignoring partial resolution of indirect */
                  lpThings._0_2_ = (int)pvVar25;
                  /* WARNING: Ignoring partial resolution of indirect */
                  lpThings._2_2_ = (int)((ulong)pvVar25 >> 0x10);
                  if (lpThings == (THING *)0x0)
                    break;
                  __fmemset(lpThings, 0, cThingAlloc * 0x12);
                  pSVar27 = vlprgScoreX;
                }
                vlprgScoreX = pSVar27;
                ReadRt();
                lpth = lpThings;
                j = 0;
                for (i = 0; i < (int)szT._254_2_; i = i + 1)
                {
                  if (szT._252_2_ == 0)
                  {
                  LAB_1070_270b:
                    cThing = cThing + 1;
                  }
                  else
                  {
                    while ((j < cThing && (*(uint *)lpth < rgbCur._0_2_)))
                    {
                      j = j + 1;
                      lpth = (THING *)CONCAT22(lpth._2_2_, (uint)lpth + 0x12);
                    }
                    if ((cThing <= j) || (rgbCur._0_2_ != *(uint *)lpth))
                    {
                      if (cThingAlloc == cThing)
                      {
                        cThingAlloc = cThingAlloc + 8;
                        pvVar25 = LpReAlloc(lpThings, cThingAlloc * 0x12,
                                            htThings);
                        /* WARNING: Ignoring partial resolution of indirect */
                        lpThings._0_2_ = (int)pvVar25;
                        /* WARNING: Ignoring partial resolution of indirect */
                        lpThings._2_2_ = (int)((ulong)pvVar25 >> 0x10);
                        lpth = (THING *)CONCAT22(lpThings._2_2_,
                                                 (int)lpThings + j * 0x12);
                      }
                      if (j < cThing)
                      {
                        __fmemmove((void *)CONCAT22(lpth._2_2_, (uint)lpth + 0x12), lpth,
                                   (cThing - j) * 0x12);
                        __fmemset(lpth, 0, 0x12);
                      }
                      goto LAB_1070_270b;
                    }
                  }
                  __fmemcpy(lpth, rgbCur, hdrCur.flags1 & 0x3ff);
                  *(short *)((uint)lpth + 0x10) = game.turn;
                  lpth = (THING *)CONCAT22(lpth._2_2_, (uint)lpth + 0x12);
                  j = j + 1;
                  ReadRt();
                }
              }
              else
              {
                cThing = 0;
                cThingAlloc = 10;
                pvVar25 = LpAlloc(0xb4, htThings);
                /* WARNING: Ignoring partial resolution of indirect */
                lpThings._0_2_ = (int)pvVar25;
                /* WARNING: Ignoring partial resolution of indirect */
                lpThings._2_2_ = (int)((ulong)pvVar25 >> 0x10);
              }
              if ((uint)hdrCur.flags1 >> 10 == 0x16)
              {
                ReadRt();
              }
              while (sVar13 = idPlayer, (uint)hdrCur.flags1 >> 10 == 0x1e)
              {
                idPlayer = rgbCur._0_2_ & 0xf;
                szT._254_2_ = idPlayer;
                if ((*(int *)((int)rglpbtlplan + idPlayer * 4) == 0) &&
                    (*(int *)((int)&DAT_1120_593a + idPlayer * 4) == 0))
                {
                  pvVar25 = LpAlloc(0x240, htShips);
                  *(undefined2 *)((int)rglpbtlplan + szT._254_2_ * 4) = (int)pvVar25;
                  *(undefined2 *)((int)&DAT_1120_593a + szT._254_2_ * 4) =
                      (int)((ulong)pvVar25 >> 0x10);
                }
                uVar24 = *(undefined2 *)((int)&DAT_1120_593a + szT._254_2_ * 4);
                UnpackBattlePlan((byte *)rgbCur,
                                 (BTLPLAN *)
                                     CONCAT13((char)((uint)uVar24 >> 8),
                                              CONCAT12((char)uVar24,
                                                       *(int *)((int)rglpbtlplan +
                                                                szT._254_2_ * 4) +
                                                           (uint) * (byte *)((int)rgcbtlplan + szT._254_2_) * 0x24)),
                                 (uint) * (byte *)((int)rgcbtlplan + szT._254_2_));
                pcVar3 = (char *)((int)rgcbtlplan + szT._254_2_);
                *pcVar3 = *pcVar3 + '\x01';
                ReadRt();
                idPlayer = sVar13;
              }
              if ((uint)hdrCur.flags1 >> 10 != 0)
              {
              IO_Corrupt_2:
                idPlayer = sVar13;
                sVar13 = 0x10;
                pcVar16 = PszFormatIds(idsGameFileAppearsCorruptUnableLoadFile, (short *)0x0);
                AlertSz(pcVar16, sVar13);
                break;
              }
              szT._252_4_ = (byte *)__filelength(hf);
              pbVar28 = (byte *)__tell(hf);
              if (pbVar28 == szT._252_4_)
                goto LAB_1070_2a56;
              ReadRt();
              if ((uint)hdrCur.flags1 >> 10 != 8)
                goto LAB_1070_2a35;
              game.turn = rgbCur._10_2_;
              game.flags9 =
                  game.flags9 & 0xf1ffU | ((uint)rgbCur._14_2_ >> 0xd) << 9;
              i = 0;
              lppl = lpPlanets;
              while (true)
              {
                lpPlanets._2_2_ = (uint)((ulong)lppl >> 0x10);
                lpPlanets._0_2_ = (int)lppl;
                lpPlanets = lppl;
                if (game.cPlayer <= i)
                  break;
                *(undefined *)((int)&rgplr[0].cShDef + i * 0xc0) = 0;
                *(uint *)((int)&rgplr[0].flags3 + i * 0xc0) =
                    *(uint *)((int)&rgplr[0].flags3 + i * 0xc0) & 0xf000;
                *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
                *(uint *)((int)&rgplr[0].flags3 + i * 0xc0) =
                    *(uint *)((int)&rgplr[0].flags3 + i * 0xc0) & 0xfff;
                *(undefined *)((int)rgcbtlplan + i) = 0;
                i = i + 1;
                lppl = lpPlanets;
              }
              szT._252_2_ = (int)lpPlanets;
              szT._254_2_ = lpPlanets._2_2_;
              uVar19 = (int)lpPlanets + cPlanet * 0x38;
              while (true)
              {
                if (uVar19 <= (uint)lppl)
                  break;
                uVar24 = (undefined2)((ulong)lppl >> 0x10);
                if (*(int *)((uint)lppl + 2) == iPlayer)
                {
                  *(undefined2 *)((uint)lppl + 2) = 0xffff;
                  *(uint *)((uint)lppl + 4) = *(uint *)((uint)lppl + 4) & 0xff00 | 3;
                  if ((*(int *)((uint)lppl + 0x34) != 0) || (*(int *)((uint)lppl + 0x36) != 0))
                  {
                    FreePl((PL *)CONCAT22(*(undefined2 *)((uint)lppl + 0x36),
                                          *(undefined2 *)((uint)lppl + 0x34)));
                    *(undefined2 *)((uint)lppl + 0x34) = 0;
                    *(undefined2 *)((uint)lppl + 0x36) = 0;
                  }
                }
                lppl = (PLANET *)CONCAT22(uVar24, (uint)lppl + 0x38);
              }
              cPlanetHist = cPlanet;
            } while (true);
          }
          goto IO_LError_2;
        }
      }
    IO_XYCorrupt:
      sVar13 = 0x10;
      pcVar16 = PszFormatIds(idsUniverseDefinitionFileSeemsMissingCorrupt, (short *)0x0);
      AlertSz(pcVar16, sVar13);
    }
  }
IO_LError_2:
  game.fDirty = 0;
  DestroyCurGame();
  StreamClose();
  if (((((uint)ini.flags6 >> 0xe & 1) == 0) && (-1 < ini.flags6)) &&
      (hwndTitle == 0))
  {
    sVar13 = GetSystemMetrics(0);
    szT._252_2_ = sVar13;
    szT._254_2_ = GetSystemMetrics(1);
    hwndTitle =
        CreateWindow(szTitle, (LPCSTR)0x11200752, 0x90000000, 0, 0, szT._252_2_, szT._254_2_,
                     hwndFrame, 0, hInst, (void *)0x0);
    fFreeingTitle = 0;
    ShowWindow(hwndFrame, 0);
  }
  sVar13 = 0;
  pbVar28 = vlpbAiData;
  pTVar10 = lpThings;
  pPVar29 = lpPlanets;
  ppFVar11 = rglpfl;
  pSVar27 = vlprgScoreX;
  pbVar9 = lpbBattleLog;
LAB_1070_3200:
  lpbBattleLog._2_2_ = (undefined2)((ulong)pbVar9 >> 0x10);
  lpbBattleLog._0_2_ = SUB42(pbVar9, 0);
  vlprgScoreX._2_2_ = (undefined2)((ulong)pSVar27 >> 0x10);
  vlprgScoreX._0_2_ = (int)pSVar27;
  rglpfl._2_2_ = (undefined2)((ulong)ppFVar11 >> 0x10);
  rglpfl._0_2_ = (int)ppFVar11;
  lpPlanets._2_2_ = (uint)((ulong)pPVar29 >> 0x10);
  lpPlanets._0_2_ = (int)pPVar29;
  lpThings._2_2_ = (short)((ulong)pTVar10 >> 0x10);
  lpThings._0_2_ = (int)pTVar10;
  vlpbAiData._2_2_ = (int)((ulong)pbVar28 >> 0x10);
  vlpbAiData._0_2_ = (int)pbVar28;
  return sVar13;
LAB_1070_2a35:
  sVar13 = 0x10;
  pcVar16 = PszFormatIds(idsWarningIgnoringUnexpectedDataAfterEof, (short *)0x0);
  AlertSz(pcVar16, sVar13);
LAB_1070_2a56:
  StreamClose();
  if ((((1 < cturn) && ((*(uint *)((int)&rgplr[0].flags4 + iPlayer * 0xc0) >> 9 & 1) == 0)) && (((uint)ini.flags6 >> 0xc & 1) == 0)) &&
      ((((uint)ini.flags6 >> 0xb & 1) == 0 &&
        (((uint)ini.flags6 >> 0xd & 1) == 0))))
  {
    pcVar16 = PszGetCompressedString(idsNoteDYearsDataRead);
    _WSPRINTF((LPSTR)CONCAT22(cturn, 0x1120), (LPCSTR)CONCAT22(pcVar16, 0x1120), (int)szWork);
    AlertSz((char *)szWork, 0x40);
  }
  sVar13 = __strnicmp(pszExt, (char *)0x759, 3);
  ppFVar11 = rglpfl;
  if (sVar13 != 0)
  {
    lppl = lpPlanets;
    if ((*(uint *)((int)&rgplr[0].flags4 + iPlayer * 0xc0) >> 9 & 1) == 0)
    {
      szT._240_2_ = (int)lpThings;
      szT._242_2_ = lpThings._2_2_;
      lpth = lpThings;
      uVar19 = (int)lpThings + cThing * 0x12;
      while (true)
      {
        lpPlanets._2_2_ = (uint)((ulong)lppl >> 0x10);
        lpPlanets._0_2_ = (int)lppl;
        lpPlanets = lppl;
        if (uVar19 <= (uint)lpth)
          break;
        uVar24 = (undefined2)((ulong)lpth >> 0x10);
        if ((*(uint *)lpth >> 0xd == 1) && ((*(uint *)((uint)lpth + 6) >> 10 & 0xf) != 0))
        {
          pPVar29 = LpplFromId(*(uint *)((uint)lpth + 6) & 0x3ff);
          iVar18 = (int)((ulong)pPVar29 >> 0x10);
          lppl = lpPlanets;
          if ((((int)pPVar29 != 0) || (iVar18 != 0)) && (*(int *)((int)pPVar29 + 2) == iPlayer))
          {
            szT._242_2_ = IWarpMAFromLppl(pPVar29, (short *)(szT + 0xf0));
            lppl = lpPlanets;
            if (szT._242_2_ + szT._240_2_ < (int)((*(uint *)((uint)lpth + 6) >> 10 & 0xf) + 4))
            {
              FSendPlrMsg2XGen(0, idmMassPacketAppearsCollisionCourseWhichCurrently, -6, *(short *)lpth,
                               pPVar29->id);
              lppl = lpPlanets;
            }
          }
        }
        lpth = (THING *)CONCAT22(uVar24, (uint)lpth + 0x12);
      }
      lppl = lppl;
      if (((uint)game.flags9 >> 3 & 1) == 0)
      {
        szT._240_2_ = (int)lpPlanets;
        szT._242_2_ = lpPlanets._2_2_;
        uVar19 = (int)lpPlanets + cPlanet * 0x38;
        while ((uint)lppl < uVar19)
        {
          uVar24 = (undefined2)((ulong)lppl >> 0x10);
          if ((((*(int *)((uint)lppl + 2) == iPlayer) && ((*(uint *)((uint)lppl + 4) >> 9 & 1) != 0)) && ((*(int *)((uint)lppl + 0x34) != 0 || (*(int *)((uint)lppl + 0x36) != 0)))) &&
              (iVar18 = *(int *)((uint)lppl + 2) * 4,
               *(int *)(*(int *)(iVar18 + 0x14c) + (*(uint *)((uint)lppl + 0x2c) & 0xf) * 0x93) !=
                   0x20))
          {
            szT._254_2_ = 0;
            szT._252_2_ = 0;
            szT._244_2_ = *(int *)((uint)lppl + 0x34);
            szT._246_2_ = *(undefined2 *)((uint)lppl + 0x36);
            for (; szT._244_2_ = szT._244_2_ + 4, uVar8 = *(undefined4 *)((uint)lppl + 0x34),
                   (int)szT._252_2_ < (int)(uint) * (byte *)((int)uVar8 + 3);
                 szT._252_2_ = szT._252_2_ + 1)
            {
              EstimateItemProdSched(lppl, (PLPROD *)0x0, szT._252_2_, (short *)(szT + 0xfa), (short *)(szT + 0xf8));
              if (1 < (int)szT._248_2_)
              {
                szT._254_2_ = 0;
                break;
              }
              if (szT._248_2_ == 1)
              {
                uVar30 = __aFulshr(uVar31, szEntry._0_2_);
                if (((uint)uVar30 & 7) == 1)
                {
                  uVar30 = __aFulshr(uVar31, szEntry._0_2_);
                  if (((uint)uVar30 & 0x7f) < 7)
                    goto LAB_1070_2cf9;
                }
                szT._254_2_ = 1;
              }
            LAB_1070_2cf9:
            }
            if (szT._254_2_ != 0)
            {
              FSendPlrMsg2XGen(0, idmStarbaseScheduledCompleteRemainingProductionItem, lppl->id, lppl->id, 0);
            }
          }
          lppl = (PLANET *)CONCAT22(uVar24, (uint)lppl + 0x38);
        }
        sVar13 = CBattles();
        lppl = lpPlanets;
        if (0 < sVar13)
        {
          FSendPlrMsg2XGen(1, (1 < sVar13) + idmHaveReceivedOneBattleRecordingYear, -7, sVar13, 0);
          lppl = lpPlanets;
        }
      }
    }
    if (((uint)gd.flags2 >> 1 & 1) == 0)
    {
      lpPlanets = lppl;
      _WSPRINTF((LPSTR)CONCAT22(pszFileName, 0x1120), (LPCSTR)0x75d1120, (int)szWork);
      sVar13 = FLoadLogFile((char *)szWork);
      if (sVar13 != 0)
      {
        sVar13 = FRunLogFile();
        lppl = lpPlanets;
        if (sVar13 != 0)
          goto LAB_1070_2eb1;
      }
      sVar13 = 0x10;
      pcVar16 = PszFormatIds(idsPlayerLogFileAppearsCorruptUnableLoad, (short *)0x0);
      AlertSz(pcVar16, sVar13);
      goto IO_LError_2;
    }
  LAB_1070_2eb1:
    i = 0;
    while (true)
    {
      lpPlanets._2_2_ = (uint)((ulong)lppl >> 0x10);
      lpPlanets._0_2_ = (int)lppl;
      iVar18 = (int)lpPlanets;
      lpPlanets = lppl;
      if (game.cPlayer <= i)
        break;
      *(uint *)((int)&rgplr[0].flags3 + i * 0xc0) =
          *(uint *)((int)&rgplr[0].flags3 + i * 0xc0) & 0xf000;
      *(undefined2 *)((int)&rgplr[0].cPlanet + i * 0xc0) = 0;
      i = i + 1;
      lppl = lpPlanets;
    }
    szT._254_2_ = lpPlanets._2_2_;
    uVar19 = (int)lpPlanets + cPlanet * 0x38;
    while ((uint)lppl < uVar19)
    {
      uVar24 = (undefined2)((ulong)lppl >> 0x10);
      if (*(int *)((uint)lppl + 2) == -1)
      {
        *(uint *)((uint)lppl + 4) = *(uint *)((uint)lppl + 4) & 0xfdff;
      }
      else
      {
        piVar1 = (int *)((int)&rgplr[0].cPlanet + *(int *)((uint)lppl + 2) * 0xc0);
        *piVar1 = *piVar1 + 1;
      }
      lppl = (PLANET *)CONCAT22(uVar24, (uint)lppl + 0x38);
    }
    i = 0;
    ppFVar11 = rglpfl;
    while (true)
    {
      rglpfl._2_2_ = (undefined2)((ulong)ppFVar11 >> 0x10);
      rglpfl._0_2_ = (int)ppFVar11;
      szT._252_4_ = (byte *)CONCAT22(szT._254_2_, iVar18);
      if (cFleet <= i)
        break;
      piVar22 = (int *)((int)rglpfl + i * 4);
      iVar20 = *piVar22;
      iVar7 = piVar22[1];
      if ((iVar20 == 0) && (szT._252_4_ = (byte *)CONCAT22(szT._254_2_, iVar18), iVar7 == 0))
        break;
      iVar20 = *(int *)(iVar20 + 2);
      szT._254_2_ = *(int *)((int)&rgplr[0].flags3 + iVar20 * 0xc0) + 1U & 0xfff;
      puVar2 = (uint *)((int)&rgplr[0].flags3 + iVar20 * 0xc0);
      rglpfl = ppFVar11;
      *puVar2 = *puVar2 & 0xf000;
      puVar2 = (uint *)((int)&rgplr[0].flags3 + iVar20 * 0xc0);
      *puVar2 = *puVar2 | szT._254_2_;
      i = i + 1;
      ppFVar11 = rglpfl;
    }
  }
  idPlayer = iPlayer;
  pbVar28 = vlpbAiData;
  pTVar10 = lpThings;
  pPVar29 = lpPlanets;
  pSVar27 = vlprgScoreX;
  pbVar9 = lpbBattleLog;
  if (((iPlayer != -1) &&
       ((*(uint *)((int)&rgplr[0].flags4 + iPlayer * 0xc0) >> 9 & 1) == 0)) &&
      (((int)vrgszMRU != 0 || (vrgszMRU._2_2_ != 0))))
  {
    rglpfl = ppFVar11;
    _strcpy(szT, pszFileName);
    _strcat(szT, (char *)0x764);
    _strcat(szT, pszExt);
    sVar13 = __fstricmp((char *)CONCAT22(unaff_SS, szT),
                        (char *)CONCAT22(vrgszMRU._2_2_, (int)vrgszMRU));
    pbVar28 = vlpbAiData;
    pTVar10 = lpThings;
    pPVar29 = lpPlanets;
    pSVar27 = vlprgScoreX;
    ppFVar11 = rglpfl;
    pbVar9 = lpbBattleLog;
    if (sVar13 != 0)
    {
      for (i = 1; i < 8; i = i + 1)
      {
        sVar13 = __fstricmp((char *)CONCAT22(unaff_SS, szT),
                            (char *)CONCAT22(vrgszMRU._2_2_,
                                             (int)vrgszMRU + i * 0x100));
        if (sVar13 == 0)
          break;
      }
      for (; 0 < i; i = i + -1)
      {
        __fstrcpy((char *)CONCAT22(vrgszMRU._2_2_, (int)vrgszMRU + i * 0x100),
                  (char *)CONCAT22(vrgszMRU._2_2_,
                                   (int)vrgszMRU + (i + -1) * 0x100));
      }
      __fstrcpy((char *)CONCAT22(vrgszMRU._2_2_, (int)vrgszMRU),
                (char *)CONCAT22(unaff_SS, szT));
      CchGetString(idsStarsIni, szIniFile);
      CchGetString(idsFiles, szSection);
      CchGetString(idsFile1, szEntry);
      uVar17 = _strlen(szEntry);
      for (i = 0; pbVar28 = vlpbAiData, pTVar10 = lpThings, pPVar29 = lpPlanets, pSVar27 = vlprgScoreX, ppFVar11 = rglpfl, pbVar9 = lpbBattleLog,
          i < 9;
           i = i + 1)
      {
        szSection[uVar17 - 0x13] = (char)i + '1';
        __fstrcpy((char *)CONCAT22(unaff_SS, szT),
                  (char *)CONCAT22(vrgszMRU._2_2_, (int)vrgszMRU + i * 0x100));
        WritePrivateProfileString((LPCSTR)CONCAT22(unaff_SS, szSection), (LPCSTR)CONCAT22(unaff_SS, szEntry),
                                  (LPCSTR)CONCAT22(unaff_SS, szT), (LPCSTR)CONCAT22(unaff_SS, szIniFile));
      }
    }
  }
  sVar13 = 1;
  goto LAB_1070_3200;
}

// ======================================================================
// Function: FReadShDef
// Address: 1070:0006
// ======================================================================

/* WARNING: Could not reconcile some variable overlaps */

short __cdecl16far FReadShDef(RTSHDEF *lprt, SHDEF *lpshdef, short iplrLoad)

{
  SHDEF *pSVar1;
  HullDef *pHVar2;
  int iVar3;
  int iVar4;
  HullSlotType *pHVar5;
  SHDEF *pSVar6;
  HullDef *pHVar7;
  undefined2 uVar8;
  undefined2 unaff_SS;
  HULDEF *pHVar9;
  PART part;
  HUL *lphul;
  short c;
  ulong wt;
  HUL *lphulBase;
  short fOkay;
  short cch;
  short ishdef;
  byte *lpb;
  SHDEF shdef;
  char szTemp[40];

  _memset(&shdef, 0, 0x93);
  uVar8 = (undefined2)((ulong)lprt >> 0x10);
  iVar4 = (int)lprt;
  shdef.hul.ihuldef = (HullDef) * (byte *)(iVar4 + 2);
  shdef.flags62 = lprt->flags1;
  shdef.hul.chs = *(byte *)(iVar4 + 6);
  shdef.hul.ibmp = (short)*(byte *)(iVar4 + 3);
  if ((shdef.flags62 & 0xffU) == 7)
  {
    shdef.hul.dp = *(short *)(iVar4 + 4);
    shdef.turn = *(short *)(iVar4 + 7);
    shdef.cBuilt._0_2_ = *(undefined2 *)(iVar4 + 9);
    shdef.cBuilt._2_2_ = *(undefined2 *)(iVar4 + 0xb);
    shdef.cExist._0_2_ = *(undefined2 *)(iVar4 + 0xd);
    shdef.cExist._2_2_ = *(undefined2 *)(iVar4 + 0xf);
    lpb = (byte *)CONCAT22(uVar8, iVar4 + 0x11);
    __fmemmove((void *)CONCAT22(unaff_SS, shdef.hul.rghs),
               (void *)CONCAT22(uVar8, iVar4 + 0x11), (uint) * (byte *)(iVar4 + 6) << 2);
    lpb = (byte *)CONCAT22(lpb._2_2_, (int)lpb + (uint) * (byte *)(iVar4 + 6) * 4);
  }
  else
  {
    shdef.hul.wtEmpty = *(short *)(iVar4 + 4);
    lpb = (byte *)CONCAT22(uVar8, iVar4 + 6);
  }
  pHVar9 = LphuldefFromId(shdef.hul.ihuldef);
  fOkay = *(uint *)((int)pHVar9 + 0x32);
  if ((shdef.hul.ibmp < fOkay) || ((int)(fOkay + 4U) <= shdef.hul.ibmp))
  {
    shdef.hul.ibmp = shdef.hul.ibmp & 3U | fOkay;
  }
  cch = (short)*lpb;
  iVar4 = (int)lpb + 1;
  lpb = (byte *)CONCAT22(lpb._2_2_, iVar4);
  if (cch == 0)
  {
    __fstrcpy((char *)CONCAT22(unaff_SS, shdef.hul.szClass), (char *)CONCAT22(lpb._2_2_, iVar4));
  }
  else
  {
    fOkay = 0x20;
    if (0x20 < (uint)cch)
    {
      return 0;
    }
    __fmemmove((void *)CONCAT22(unaff_SS, szTemp), (void *)CONCAT22(lpb._2_2_, iVar4), cch);
    FDecompressUserString((char *)CONCAT22(unaff_SS, szTemp), cch, (char *)CONCAT22(unaff_SS, shdef.hul.szClass),
                          &fOkay);
  }
  ishdef = (uint)shdef.flags62 >> 10 & 0x1f;
  if (0xf < (uint)ishdef)
  {
    ishdef = ishdef - 0x10;
  }
  if ((((shdef.flags62 & 0xffU) == 7) ||
       ((*(uint *)((int)lpshdef + ishdef * 0x93 + 0x7b) >> 9 & 1) != 0)) ||
      ((*(uint *)((int)lpshdef + ishdef * 0x93 + 0x7b) & 0xff) < 7))
  {
    pHVar7 = (HullDef *)((int)lpshdef + ishdef * 0x93);
    pSVar6 = &shdef;
    for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1)
    {
      pHVar2 = pHVar7;
      pHVar7 = pHVar7 + 1;
      pSVar1 = pSVar6;
      pSVar6 = (SHDEF *)(pSVar6->hul).rgTech;
      *pHVar2 = (pSVar1->hul).ihuldef;
    }
    *(undefined *)pHVar7 = *(undefined *)&(pSVar6->hul).ihuldef;
  }
  else if ((shdef.hul.ihuldef != *(HullDef *)((int)lpshdef + ishdef * 0x93)) ||
           (shdef.hul.ibmp != *(int *)((int)lpshdef + ishdef * 0x93 + 0x32)))
  {
    pHVar7 = (HullDef *)((int)lpshdef + ishdef * 0x93);
    pSVar6 = &shdef;
    for (iVar4 = 0x49; iVar4 != 0; iVar4 = iVar4 + -1)
    {
      pHVar2 = pHVar7;
      pHVar7 = pHVar7 + 1;
      pSVar1 = pSVar6;
      pSVar6 = (SHDEF *)(pSVar6->hul).rgTech;
      *pHVar2 = (pSVar1->hul).ihuldef;
    }
    *(undefined *)pHVar7 = *(undefined *)&(pSVar6->hul).ihuldef;
  }
  if (idPlayer != -1)
  {
    UpdateShdefCost((SHDEF *)CONCAT22(lpshdef._2_2_, (int)lpshdef + ishdef * 0x93));
  }
  if ((*(uint *)((int)lpshdef + ishdef * 0x93 + 0x7b) & 0xff) == 7)
  {
    iVar3 = (int)lpshdef + ishdef * 0x93;
    lphul = (HUL *)CONCAT22(lpshdef._2_2_, iVar3);
    pHVar9 = LphuldefFromId(lphul->ihuldef);
    uVar8 = (undefined2)((ulong)pHVar9 >> 0x10);
    iVar4 = (int)pHVar9;
    wt._0_2_ = *(int *)(iVar4 + 0x28);
    for (c = 0; c < (int)(uint) * (byte *)(iVar3 + 0x7a); c = c + 1)
    {
      if (*(uint *)(iVar3 + c * 4 + 0x3c) >> 8 != 0)
      {
        pHVar5 = (HullSlotType *)(iVar3 + 0x3a + c * 4);
        part.hs.grhst = *pHVar5;
        part.hs.flags2 = pHVar5[1];
        fOkay = FLookupPart(&part);
        if (idPlayer == -1)
        {
          fOkay = 0;
        }
        if ((((part.hs.grhst & *(HullSlotType *)(iVar4 + 0x3a + c * 4)) ==
              ~(hstEngine | hstScanner | hstShield | hstArmor | hstBeam | hstTorp | hstBomb | hstMining | hstMines |
                hstSpecialSB | hstSBHull | hstSpecialE | hstSpecialM | hstTerra | hstHull | hstPlanetary)) ||
             ((1 < fOkay && (-1 < shdef.flags62)))) ||
            (*(uint *)(iVar4 + c * 4 + 0x3c) >> 8 < (uint)part.hs.flags2 >> 8))
        {
          *(uint *)(iVar3 + c * 4 + 0x3c) = *(uint *)(iVar3 + c * 4 + 0x3c) & 0xff;
        }
        wt._0_2_ = (int)wt + *(int *)((int)part.pcom + 0x28) *
                                 (*(uint *)(iVar3 + c * 4 + 0x3c) >> 8);
      }
      if (((c == 0) && (*(uint *)(iVar3 + 0x3c) >> 8 == 0)) && (*(int *)(iVar4 + 0x3a) == 1))
      {
        *(undefined2 *)(iVar3 + 0x3a) = 1;
        *(uint *)(iVar3 + 0x3c) = *(uint *)(iVar3 + 0x3c) & 0xff00 | 1;
        *(uint *)(iVar3 + 0x3c) = *(uint *)(iVar3 + 0x3c) & 0xff | *(uint *)(iVar4 + 0x3c) & 0xff00;
        part.hs.grhst = *(HullSlotType *)(iVar3 + 0x3a);
        part.hs.flags2 = *(short *)(iVar3 + 0x3c);
        FLookupPart(&part);
        wt._0_2_ = (int)wt + *(int *)((int)part.pcom + 0x28) * (*(uint *)(iVar3 + 0x3c) >> 8);
      }
    }
    *(int *)(iVar3 + 0x28) = (int)wt;
  }
  return 1;
}

// ======================================================================
// Function: ReadRt
// Address: 1070:5168
// ======================================================================

void __cdecl16far ReadRt(void)

{
  RgFromStream(&hdrCur, 2);
  if ((hdrCur.flags1 & 0x3ffU) != 0)
  {
    RgFromStream(rgbCur, hdrCur.flags1 & 0x3ff);
  }
  if ((uint)hdrCur.flags1 >> 10 == 8)
  {
    SetFileXorStream(CONCAT22(rgbCur._6_2_, rgbCur._4_2_),
                     (int)rgbCur._12_2_ >> 5, rgbCur._10_2_,
                     (int)(rgbCur._12_2_ << 0xb) >> 0xb, (uint)rgbCur._14_2_ >> 0xc & 1);
  }
  else if ((uint)hdrCur.flags1 >> 10 != 0)
  {
    XorFileBuf((char *)rgbCur, hdrCur.flags1 & 0x3ff);
  }
  return;
}

// ======================================================================
// Function: FOpenFile
// Address: 1070:4ac2
// ======================================================================

/* WARNING: Variable defined which should be unmapped: env */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short __cdecl16far FOpenFile(ushort dt, short iPlayer, short md)

{
  undefined2 *puVar1;
  RTBOF *pRVar2;
  uint dt_00;
  undefined2 uVar3;
  short sVar4;
  StringId ids_00;
  char *sz;
  short sVar5;
  int iVar6;
  undefined2 *puVar7;
  RTBOF *pRVar8;
  undefined2 unaff_SS;
  short env[9];
  short (*penvMemSav)[9];
  short fSilentSav;
  short fRewind;
  short fCheckMulti;
  short ids;
  RTBOF rtbof;

  sVar5 = fFileErrSilent;
  gd.flags2 = gd.flags2 & 0xff7f;
  dt_00 = dt & 0xff;
  SetSzWorkFromDt(dt_00, iPlayer);
  uVar3 = _penvMem;
  _penvMem = env;
  sVar4 = __setjmp(env);
  if (sVar4 != 0)
  {
    fFileErrSilent = sVar5;
    FileError(idsCantOpenFile);
    StreamClose();
    _penvMem = (short *)uVar3;
    return 0;
  }
  fFileErrSilent = 1;
  StreamOpen((char *)szWork, md);
  sVar4 = 0x1070;
  fFileErrSilent = sVar5;
  ReadRt();
  if (((((uint)hdrCur.flags1 >> 10 == 8) && ((uint)rgbCur._8_2_ >> 0xc == 2)) &&
       (0x30 < ((uint)rgbCur._8_2_ >> 5 & 0x7f))) &&
      (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x54))
  {
    puVar7 = (undefined2 *)rgbCur;
    pRVar8 = &rtbof;
    for (iVar6 = 8; iVar6 != 0; iVar6 = iVar6 + -1)
    {
      pRVar2 = pRVar8;
      pRVar8 = (RTBOF *)(pRVar8->rgid + 2);
      puVar1 = puVar7;
      puVar7 = puVar7 + 1;
      *(undefined2 *)pRVar2->rgid = *puVar1;
    }
    if ((rtbof.flags7 << 0xb) >> 0xb == iPlayer)
    {
      if (((int)game.lid == 0) && (game.lid._2_2_ == 0))
        goto LAB_1070_4ebd;
      if (((int)rtbof.lidGame == (int)game.lid) &&
          (rtbof.lidGame._2_2_ == game.lid._2_2_))
      {
        if (dt_00 == 4)
        {
          if ((rtbof.flags7 << 0xb) >> 0xb == iPlayer)
            goto LAB_1070_4ebd;
        }
        else
        {
          if (((dt & 0x2000) != 0) && (((uint)rtbof.flags8 >> 10 & 1) != 0))
          {
            __lseek(hf, -4, 2);
            env[0] = 0x1118;
            sVar4 = 0x1070;
            ReadRt();
            if (((uint)hdrCur.flags1 >> 10 != 0) &&
                ((hdrCur.flags1 & 0x3ffU) != 2))
              goto IO_LBadFile_2;
            rtbof.turn = rgbCur._0_2_;
            game.flags9 = game.flags9 & 0xf1ffU | ((uint)rtbof.flags8 >> 0xd) << 9;
          }
          sVar4 = 0x1070;
          if ((game.turn == 0) && (rtbof.turn != 0))
          {
            game.turn = rtbof.turn;
            game.flags9 = game.flags9 & 0xf1ffU | ((uint)rtbof.flags8 >> 0xd) << 9;
          LAB_1070_4ebd:
            if ((dt & 0x1000) != 0)
            {
              env[0] = 0;
              __lseek(hf, 0, 0);
              env[4] = 0x1118;
              env[3] = (int)rgbCur + 0x34b;
              ReadRt();
            }
            _penvMem = (short *)uVar3;
            wVersFile = rtbof.flags5;
            gd.flags2 = gd.flags2 & 0xfffbU | ((uint)rtbof.flags8 >> 0xc & 1) << 2;
            return 1;
          }
          if (rtbof.turn == game.turn)
          {
            if (((dt_00 == 2) && (((uint)gd.flags1 >> 3 & 1) == 0)) &&
                (((uint)rtbof.flags8 >> 9 & 1) != 0))
            {
              env[0] = (int)s_M6102__MATH___floating_point_err_1120_2022 + 2;
              sz = PszFormatIds(idsHostFileMarkedUseAnotherInstanceStars, (short *)0x0);
              sVar4 = 0x1040;
              sVar5 = AlertSz(sz, env[0]);
              if (sVar5 == 6)
                goto LAB_1070_4ebd;
            }
            else if (((((uint)rtbof.flags8 >> 8 & 1) == 0) &&
                      (((uint)gd.flags1 >> 1 & 1) != 0)) &&
                     (((uint)gd.flags1 >> 2 & 1) == 0))
            {
              gd.flags2 = gd.flags2 & 0xff7fU | 0x80;
            }
            else
            {
              if (((dt_00 != 1) || (((uint)game.flags9 >> 3 & 1) != 0)) ||
                  ((uint)rtbof.flags8 >> 0xd == ((uint)game.flags9 >> 9 & 7)))
                goto LAB_1070_4ebd;
              env[0] = 0x1d;
              sVar4 = 0x1070;
              FileError(idsFileGame);
            }
          }
          else
          {
            env[0] = 0x1c;
            sVar4 = 0x1070;
            FileError(idsFileDate);
          }
        }
      }
      else
      {
        sVar4 = 0x1070;
        FileError(idsFileGame);
      }
    }
    else
    {
      sVar4 = 0x1070;
      FileError(idsGameFileAppearsCorruptUnableLoadFile);
    }
  }
  else if ((uint)hdrCur.flags1 >> 10 == 8)
  {
    if (((uint)rgbCur._8_2_ >> 0xc < 3) &&
        (((uint)rgbCur._8_2_ >> 0xc != 2 ||
          (((uint)rgbCur._8_2_ >> 5 & 0x7f) < 0x55))))
    {
      ids_00 = idsSorryFileCreatedOlderVersionStarsIncompatible;
    }
    else
    {
      ids_00 = idsFileCreatedNewerVersionStarsMustUpgrade;
    }
    sVar4 = 0x1070;
    FileError(ids_00);
  }
  else
  {
    sVar4 = 0x1070;
    FileError(idsFileDoesBelongVersionStars);
  }
IO_LBadFile_2:
  env[0] = sVar4;
  StreamClose();
  _penvMem = (short *)uVar3;
  return 0;
}

// ======================================================================
// Function: AskSaveDialog
// Address: 1070:432a
// ======================================================================

/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

short __pascal16far AskSaveDialog(ushort hwnd, ushort message, ushort wParam, long lParam)

{
  short sVar1;

  if (message != 2)
  {
    if (message == 0x110)
    {
      return 1;
    }
    if (message == 0x111)
    {
      if (((wParam == 0x429) || (wParam == 0x42b)) || (wParam == 0x42a))
      {
        if (wParam == 0x42b)
        {
          sVar1 = 0;
        }
        else if (wParam == 0x42a)
        {
          sVar1 = -1;
        }
        else
        {
          sVar1 = 1;
        }
        EndDialog(hwnd, sVar1);
        return 1;
      }
      if (wParam == 0x76)
      {
        WinHelp(hwnd, (LPCSTR)CONCAT22(0x1120, _szHelpFile), 1, 0x442);
        return 1;
      }
    }
  }
  return 0;
}

// ======================================================================
// Function: StreamClose
// Address: 1070:53cc
// ======================================================================

void __cdecl16far StreamClose(void)

{
  if (hf != -1)
  {
    _lclose(hf);
    hf = -1;
  }
  return;
}

// ======================================================================
// Function: FNewTurnAvail
// Address: 1070:4f22
// ======================================================================

short __cdecl16far FNewTurnAvail(short idPlayer)

{
  short sVar1;
  uint uVar2;
  short sVar3;
  short fNew;
  ushort turnOld;
  ushort wGenOld;

  sVar1 = game.turn;
  uVar2 = (uint)game.flags9 >> 9;
  fFileErrSilent = 1;
  game.turn = 0;
  sVar3 = FOpenFile((int)s_M6101__MATH___floating_point_err_1120_1ff1 + 0x12, idPlayer, 0x20);
  if (sVar3 == 0)
  {
    fNew = 0;
  }
  else
  {
    StreamClose();
    fNew = (short)((uint)sVar1 < (uint)game.turn);
  }
  game.turn = sVar1;
  game.flags9 = game.flags9 & 0xf1ffU | (uVar2 & 7) << 9;
  return fNew;
}

// ======================================================================
// Function: GetFileStatus
// Address: 1070:4a60
// ======================================================================

void __cdecl16far GetFileStatus(short dt, short iPlayer)

{
  short sVar1;

  SetSzWorkFromDt(dt, iPlayer);
  sVar1 = __access((char *)szWork, 2);
  gd.flags2 = gd.flags2 & 0xffdfU | (uint)(sVar1 != 0) << 5;
  return;
}

// ======================================================================
// Function: FReadPlanet
// Address: 1070:3206
// ======================================================================

short __cdecl16far FReadPlanet(short iPlayer, PLANET *lppl, short fHistory, short fPreInited)

{
  uint uVar1;
  undefined2 uVar2;
  bool bVar3;
  byte bVar4;
  uint uVar5;
  short sVar6;
  short sVar7;
  undefined2 *puVar8;
  uint *puVar9;
  undefined2 unaff_SI;
  undefined2 unaff_DI;
  long lVar10;
  ushort in_stack_0000ffea;
  short pct;
  short pctOpt;
  short idm;
  byte *pb;
  short i;
  byte bMask;
  short fRouting;
  short fFirstYear;

  lVar10 = CONCAT22(unaff_SI, unaff_DI);
  bVar3 = false;
  if (fPreInited == 0)
  {
    __fmemset(lppl, 0, 0x38);
  }
  if ((fHistory == 0) && (iPlayer != -1))
  {
    if (fPreInited == 0)
    {
      bVar3 = true;
      *(uint *)((int)lppl + 4) = *(uint *)((int)lppl + 4) & 0xf7ff | 0x800;
    }
    else if ((*(uint *)((int)lppl + 4) >> 0xb & 1) != 0)
    {
      if (*(int *)((int)lppl + 0x32) == game.turn)
      {
        bVar3 = true;
      }
      else
      {
        *(uint *)((int)lppl + 4) = *(uint *)((int)lppl + 4) & 0xf7ff;
      }
    }
  }
  else
  {
    *(uint *)((int)lppl + 4) =
        *(uint *)((int)lppl + 4) & 0xf7ff | ((uint)rgbCur._2_2_ >> 0xf) << 0xb;
  }
  lppl->id = (int)(rgbCur._0_2_ << 5) >> 5;
  *(int *)((int)lppl + 2) = (int)rgbCur._0_2_ >> 0xb;
  if ((*(uint *)((int)lppl + 4) & 0xff) < (rgbCur._2_2_ & 0x7f))
  {
    *(uint *)((int)lppl + 4) = *(uint *)((int)lppl + 4) & 0xff00 | rgbCur._2_2_ & 0x7f;
  }
  *(uint *)((int)lppl + 4) =
      *(uint *)((int)lppl + 4) & 0xfeff | ((uint)rgbCur._2_2_ >> 8 & 1) << 8;
  *(uint *)((int)lppl + 4) =
      *(uint *)((int)lppl + 4) & 0xfdff | ((uint)rgbCur._2_2_ >> 9 & 1) << 9;
  *(uint *)((int)lppl + 4) =
      *(uint *)((int)lppl + 4) & 0xfbff | ((uint)rgbCur._2_2_ >> 7 & 1) << 10;
  uVar5 = (uint)rgbCur._2_2_ >> 0xe;
  if (((*(uint *)((int)lppl + 4) >> 9 & 1) != 0) && (*(int *)((int)lppl + 2) == -1))
  {
    *(uint *)((int)lppl + 4) = *(uint *)((int)lppl + 4) & 0xfdff;
  }
  if (fHistory == 0)
  {
    *(short *)((int)lppl + 0x32) = game.turn;
  }
  pb = (byte *)((int)rgbCur + 4);
  if (2 < (rgbCur._2_2_ & 0x7f))
  {
    bMask = rgbCur[4];
    pb = (byte *)((int)rgbCur + 5);
    for (i = 0; i < 3; i = i + 1)
    {
      if ((bMask & 3) == 0)
      {
        *(undefined *)((int)lppl + 6 + i) = 0;
      }
      else
      {
        if ((bMask & 3) != 1)
        {
          return 0;
        }
        *(byte *)((int)lppl + 6 + i) = *pb;
        pb = pb + 1;
      }
      bMask = (byte)((int)(uint)bMask >> 2);
    }
    for (i = 0; i < 3; i = i + 1)
    {
      *(byte *)((int)lppl + 9 + i) = *pb;
      pb = pb + 1;
    }
    for (i = 0; i < 3; i = i + 1)
    {
      if (100 < *pb)
      {
        return 0;
      }
      bVar4 = *pb;
      *(byte *)((int)lppl + 0xf + i) = bVar4;
      *(byte *)((int)lppl + 0xc + i) = bVar4;
      pb = pb + 1;
    }
    if (((uint)rgbCur._2_2_ >> 10 & 1) != 0)
    {
      for (i = 0; i < 3; i = i + 1)
      {
        if (100 < *pb)
        {
          return 0;
        }
        *(byte *)((int)lppl + 0xf + i) = *pb;
        pb = pb + 1;
      }
    }
    if ((int)rgbCur._0_2_ >> 0xb != -1)
    {
      *(undefined2 *)((int)lppl + 0x12) = *(undefined2 *)pb;
      pb = pb + 2;
    }
    if (3 < (*(uint *)((int)lppl + 4) & 0xff))
    {
      if (((uint)rgbCur._2_2_ >> 0xd & 1) != 0)
      {
        bMask = *pb;
        pb = pb + 1;
        for (i = 0; i < 4; i = i + 1)
        {
          bVar4 = bMask & 3;
          if ((bMask & 3) == 0)
          {
            puVar8 = (undefined2 *)((int)lppl + 0x1c + i * 4);
            *puVar8 = 0;
            puVar8[1] = 0;
          }
          else if (bVar4 == 1)
          {
            puVar9 = (uint *)((int)lppl + 0x1c + i * 4);
            *puVar9 = (uint)*pb;
            puVar9[1] = 0;
            pb = pb + 1;
          }
          else if (bVar4 == 2)
          {
            puVar8 = (undefined2 *)((int)lppl + 0x1c + i * 4);
            *puVar8 = *(undefined2 *)pb;
            puVar8[1] = 0;
            pb = pb + 2;
          }
          else if (bVar4 == 3)
          {
            uVar2 = *(undefined2 *)(pb + 2);
            puVar8 = (undefined2 *)((int)lppl + 0x1c + i * 4);
            *puVar8 = *(undefined2 *)pb;
            puVar8[1] = uVar2;
            pb = pb + 4;
          }
          bMask = (byte)((int)(uint)bMask >> 2);
        }
      }
      if ((uint)hdrCur.flags1 >> 10 != 0xe)
      {
        if (((uint)rgbCur._2_2_ >> 0xb & 1) == 0)
        {
          lVar10 = __aFlshl(lVar10, in_stack_0000ffea);
          uVar1 = *(uint *)((int)lppl + 0x1a);
          *(uint *)((int)lppl + 0x18) = *(uint *)((int)lppl + 0x18) | (uint)lVar10;
          *(uint *)((int)lppl + 0x1a) = uVar1 & 0xffbf | (uint)((ulong)lVar10 >> 0x10);
          uVar1 = *(uint *)((int)lppl + 0x1a);
          *(uint *)((int)lppl + 0x18) = *(uint *)((int)lppl + 0x18) & 0xfff | 0xf000;
          *(uint *)((int)lppl + 0x1a) = uVar1 & 0xfffe | 1;
          uVar2 = *(undefined2 *)((int)lppl + 0x1a);
          *(uint *)((int)lppl + 0x18) = *(uint *)((int)lppl + 0x18) & 0xf000;
          *(undefined2 *)((int)lppl + 0x1a) = uVar2;
        }
        else
        {
          __fmemmove((void *)CONCAT22(lppl._2_2_, (int)lppl + 0x14),
                     (void *)CONCAT22(0x1120, pb), 8);
          pb = pb + 8;
        }
        if (*(int *)((int)lppl + 2) != -1)
        {
          if ((*(uint *)((int)lppl + 4) >> 9 & 1) != 0)
          {
            uVar2 = *(undefined2 *)(pb + 2);
            *(undefined2 *)((int)lppl + 0x2c) = *(undefined2 *)pb;
            *(undefined2 *)((int)lppl + 0x2e) = uVar2;
            *(uint *)((int)lppl + 0x2e) = *(uint *)((int)lppl + 0x2e) & 0xbfff;
            pb = pb + 4;
          }
          if ((uVar5 & 1) != 0)
          {
            *(undefined2 *)((int)lppl + 0x30) = *(undefined2 *)pb;
          }
        }
        return 1;
      }
    }
  }
  if ((*(uint *)((int)lppl + 4) >> 9 & 1) != 0)
  {
    *(uint *)((int)lppl + 0x2c) = *(uint *)((int)lppl + 0x2c) & 0xfff0 | *pb & 0xf;
    pb = pb + 1;
  }
  if (fHistory == 0)
  {
    if (bVar3)
    {
      if (*(int *)((int)lppl + 2) == -1)
      {
        if ((*(uint *)((int)lppl + 4) & 0xff) < 2)
        {
          FSendPlrMsg2XGen(0, idmHaveFoundNewPlanetDontKnowIf, lppl->id, lppl->id, 0);
        }
        else
        {
          sVar6 = GetRaceStat((PLAYER *)((int)rgplr + iPlayer * 0xc0), rsMajorAdv);
          if (sVar6 == 3)
          {
            sVar6 = PctPlanetOptValue(lppl, iPlayer);
            FSendPlrMsg2XGen(0, idmHaveInfoNewPlanetIfColonizeCan, lppl->id, lppl->id, sVar6);
          }
          else
          {
            sVar6 = PctPlanetDesirability(lppl, iPlayer);
            if (sVar6 < 1)
            {
              sVar7 = PctPlanetOptValue(lppl, iPlayer);
              if (sVar7 < 1)
              {
                pct = sVar6 * 10;
                idm = 0xab;
              }
              else
              {
                sVar6 = PctTrueMaxGrowth(iPlayer);
                pct = sVar6 * sVar7;
                idm = 0xae;
              }
            }
            else
            {
              sVar7 = PctTrueMaxGrowth(iPlayer);
              pct = sVar7 * sVar6;
              idm = 0xac;
            }
            sVar6 = lppl->id;
            sVar7 = _abs(pct);
            FSendPlrMsg2XGen(0, idm, lppl->id, sVar7, sVar6);
          }
        }
      }
      else
      {
        FSendPlrMsg2XGen(0, idmHaveFoundPlanetOccupiedSomeoneElseCurrently, lppl->id, lppl->id,
                         *(uint *)((int)lppl + 2) | 0x30);
      }
    }
  }
  else
  {
    *(undefined2 *)((int)lppl + 0x32) = *(undefined2 *)pb;
  }
  return 1;
}

// ======================================================================
// Function: PromptSaveGame
// Address: 1070:43ee
// ======================================================================

void __cdecl16far PromptSaveGame(void)

{
  undefined2 uVar1;
  short sVar2;
  FARPROC pvVar3;
  short fRet;
  void *lpProc;

  pvVar3 = MakeProcInstance(AskSaveDialog, hInst);
  if (((uint)game.flags9 >> 2 & 1) == 0)
  {
    uVar1 = 0x42c;
  }
  else
  {
    uVar1 = 0x7e9;
  }
  sVar2 = DialogBox(0, (LPCSTR)CONCAT22(uVar1, hwndFrame), (HWND)((ulong)pvVar3 >> 0x10),
                    (int)pvVar3);
  FreeProcInstance(pvVar3);
  if (sVar2 != 0)
  {
    gd.flags1 = gd.flags1 & 0xffefU | (uint)(sVar2 == -1) << 4;
    FWriteLogFile((char *)szBase, idPlayer);
    FWriteHistFile(idPlayer);
  }
  return;
}

// ======================================================================
// Function: FCheckFile
// Address: 1070:4fb2
// ======================================================================

short __cdecl16far FCheckFile(ushort dt, short iPlayer, ushort md)

{
  short sVar1;
  uint uVar2;
  short sVar3;
  short fErrSav;
  short f;
  ushort wGenOld;
  short fOpened;
  short fReturn;

  sVar1 = fFileErrSilent;
  uVar2 = (uint)game.flags9 >> 9;
  if (dt == 2)
  {
    f = (uint)gd.flags1 >> 3 & 1;
    gd.flags1 = gd.flags1 & 0xfff7U | 8;
  }
  fFileErrSilent = 1;
  sVar3 = FOpenFile(dt, iPlayer, 0x20);
  if (md == 1)
  {
    if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 9 & 1) != 0))
    {
      fReturn = 1;
    }
    else
    {
      fReturn = 0;
    }
  }
  else if (md == 2)
  {
    if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 8 & 1) == 0))
    {
      fReturn = 0;
    }
    else
    {
      fReturn = 1;
    }
  }
  else if (md == 4)
  {
    if ((sVar3 == 0) || (((uint)rgbCur._14_2_ >> 10 & 1) == 0))
    {
      fReturn = 0;
    }
    else
    {
      fReturn = 1;
    }
  }
  else if (md == 8)
  {
    if (sVar3 == 0)
    {
      fReturn = 0;
    }
    else
    {
      do
      {
        ReadRt();
        if ((uint)hdrCur.flags1 >> 10 == 6)
          break;
      } while (rgbCur[0] != iPlayer);
      fReturn = (uint)rgbCur._6_2_ >> 9 & 1;
    }
  }
  if (sVar3 != 0)
  {
    StreamClose();
  }
  if (dt == 2)
  {
    gd.flags1 = gd.flags1 & 0xfff7U | (f & 1U) << 3;
  }
  fFileErrSilent = sVar1;
  game.flags9 = game.flags9 & 0xf1ffU | (uVar2 & 7) << 9;
  return fReturn;
}

// ======================================================================
// Function: FValidSerialLong
// Address: 1070:48c4
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10704975) */
/* WARNING: Removing unreachable block (ram,0x10704994) */

short __cdecl16far FValidSerialLong(ulong lSerial)

{
  short sVar1;
  ulong uVar2;
  ulong uVar3;
  ulong lSeries;
  short i;
  ulong lNumber;

  sVar1 = FBogusLong(lSerial);
  if (sVar1 == 0)
  {
    uVar2 = lSerial;
    for (i = 0; i < 4; i = i + 1)
    {
      uVar2 = __aFuldiv(uVar2, 0x24);
    }
    uVar3 = uVar2;
    for (i = 0; i < 4; i = i + 1)
    {
      uVar3 = __aFulmul(uVar3, 0x24);
    }
    uVar3 = lSerial - uVar3;
    if ((((int)(uVar3 >> 0x10) == 0) && ((uint)uVar3 < 100)) || (1500000 < uVar3))
    {
      sVar1 = 0;
    }
    else if (((uVar2 == 0x12) || (uVar2 == 0x16)) ||
             ((uVar2 == 2 || ((uVar2 == 4 || (uVar2 == 6))))))
    {
      sVar1 = 1;
    }
    else
    {
      sVar1 = 0;
    }
  }
  else
  {
    sVar1 = 0;
  }
  return sVar1;
}

// ======================================================================
// Function: DestroyCurGame
// Address: 1070:44b0
// ======================================================================

/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void __cdecl16far DestroyCurGame(void)

{
  short i;

  if (((uint)gd.flags1 >> 8 & 1) != 0)
  {
    FFinishPlrMsgEntry(0);
  }
  if ((idPlayer != -1) && (game.fDirty != 0))
  {
    PromptSaveGame();
  }
  ResetHb(htPlanets);
  lpPlanets._0_2_ = 0;
  lpPlanets._2_2_ = 0;
  cPlanet = 0;
  ResetHb(htFleets);
  rglpfl._0_2_ = 0;
  rglpfl._2_2_ = 0;
  cFleet = 0;
  ResetHb(htThings);
  lpThings._0_2_ = 0;
  lpThings._2_2_ = 0;
  cThing = 0;
  cThingAlloc = 0;
  vlprgScoreX._0_2_ = 0;
  vlprgScoreX._2_2_ = 0;
  vrptFleet.fCached = 0;
  vrptPlanet.fCached = 0;
  vrptBattle.fCached = 0;
  vrptEFleet.fCached = 0;
  for (i = 0; i < 0x10; i = i + 1)
  {
    *(undefined2 *)((int)rgsxPlr + i * 4) = 0;
    *(undefined2 *)(i * 4 + 0x156e) = 0;
  }
  lpbBattleT._0_2_ = 0;
  lpbBattleT._2_2_ = 0;
  lpbBattleLog._0_2_ = 0;
  lpbBattleLog._2_2_ = 0;
  lpbBattleCur._0_2_ = 0;
  lpbBattleCur._2_2_ = 0;
  gd.flags1 = gd.flags1 & 0xebff;
  gd.flags3 = gd.flags3 & 0xfbff;
  ResetHb(htBattle);
  if ((DAT_1120_0d60 != 0) || (DAT_1120_0d62 != 0))
  {
    *(undefined2 *)(DAT_1120_0d60 + 0x12) = 0xffff;
  }
  ResetHb(htMisc);
  ResetHb(htString);
  ResetHb(htShips);
  ResetHb(htOrd);
  ResetHb(htPlrMsg);
  for (i = 0; i < 0x10; i = i + 1)
  {
    *(undefined2 *)(i * 4 + 0xfe) = 0;
    *(undefined2 *)(i * 4 + 0x100) = 0;
    *(undefined2 *)(i * 4 + 0x14c) = 0;
    *(undefined2 *)(i * 4 + 0x14e) = 0;
    *(undefined2 *)((int)rglpbtlplan + i * 4) = 0;
    *(undefined2 *)((int)&DAT_1120_593a + i * 4) = 0;
    *(undefined *)((int)rgcbtlplan + i) = 0;
  }
  if (sel.grobj != grobjNone)
  {
    ini.flags6 =
        ini.flags6 & 0xfe1fU |
        (sel.grobj & (grobjPlanet | grobjFleet | grobjOther | grobjThing)) << 5;
    ini.iObjSel = sel.id;
    ini.idPlayer = idPlayer;
    ini.lid._0_2_ = (undefined2)game.lid;
    ini.lid._2_2_ = game.lid._2_2_;
  }
  idPlayer = -1;
  imemLogCur = 0;
  imemLogPrev = -1;
  iMsgCur = 0;
  vlpbAiData._0_2_ = 0;
  vlpbAiData._2_2_ = 0;
  ResetMessages();
  lSaltCur._0_2_ = 0;
  lSaltCur._2_2_ = 0;
  ctickLast._0_2_ = 0;
  ctickLast._2_2_ = 0;
  game.lid._0_2_ = 0;
  game.lid._2_2_ = 0;
  game.cPlayer = 0;
  game.cPlanMax = 0;
  game.fDirty = 0;
  game.turn = 0;
  game.szName[0] = '\0';
  gd.flags2 = gd.flags2 & 0xfffe;
  gd.flags1 = gd.flags1 & 0xfeff;
  if (hwndBrowser != 0)
  {
    DestroyWindow(hwndBrowser);
  }
  if (hwndReportDlg != 0)
  {
    DestroyWindow(hwndReportDlg);
  }
  if (hwndPopup != 0)
  {
    DestroyWindow(hwndPopup);
    hwndPopup = 0;
  }
  hwndActive = 0;
  sel.scan.grobjFull = grobjNone;
  sel.scan.grobj = grobjNone;
  sel.scan.iwp = -1;
  sel.scan.ifl = -1;
  sel.scan.idpl = -1;
  fOrdersVis = 0;
  sel.grobjFull = grobjNone;
  sel.grobj = grobjNone;
  sel.id = -1;
  sel.pt.y = 0;
  sel.pt.x = 0;
  sel.pl.id = -1;
  sel.fl.flags1 = -1;
  sel.fl.lpplord._0_2_ = 0;
  sel.fl.lpplord._2_2_ = 0;
  sel.pl.lpplprod._0_2_ = 0;
  sel.pl.lpplprod._2_2_ = 0;
  dxPlanetProdLB = 0;
  dxOrderED = 0;
  dxFleetCompLB = 0;
  dxShipLB = 0;
  dxShipDD = 0;
  for (i = 0; i < 3; i = i + 1)
  {
    *(undefined2 *)(i * 2 + 0x85c) = 0;
  }
  return;
}

// ======================================================================
// Function: RgFromStream
// Address: 1070:53f4
// ======================================================================

/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void __cdecl16far RgFromStream(void *rg, ushort cb)

{
  ushort uVar1;

  if (cb != 0)
  {
    if (((int)vlpMemStream == 0) && (vlpMemStream._2_2_ == 0))
    {
      uVar1 = _lread(cb, rg, hf);
      if (uVar1 != cb)
      {
        FileError(idsGameFileAppearsCorruptUnableLoadFile);
        _longjmp(_penvMem, -1);
      }
    }
    else
    {
      __fmemcpy(rg, (void *)CONCAT22(vlpMemStream._2_2_, (int)vlpMemStream), cb);
      vlpMemStream._0_2_ = (int)vlpMemStream + cb;
    }
  }
  return;
}

// ======================================================================
// Function: FBogusLong
// Address: 1070:484c
// ======================================================================

/* WARNING: Removing unreachable block (ram,0x10704887) */

short __cdecl16far FBogusLong(ulong lSerial)

{
  short i;

  i = 0;
  while (CONCAT22(*(undefined2 *)(i * 4 + 0x768), *(undefined2 *)(i * 4 + 0x766)) <
         (lSerial ^ 0xa5a5a5a5))
  {
    i = i + 1;
  }
  return (uint)((lSerial ^ 0xa5a5a5a5) ==
                CONCAT22(*(undefined2 *)(i * 4 + 0x768), *(undefined2 *)(i * 4 + 0x766)));
}
