// Decompiled code from stars.exe (Stars! 2.60j RC3)
// Generated by Ghidra
// 

// ======================================================================
// Function: FGenerateTurn
// Address: 10b0:0000
// ======================================================================


/* WARNING: Could not reconcile some variable overlaps */
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */
/* WARNING: Restarted to delay deadcode elimination for space: ram */

short __cdecl16far TURN::FGenerateTurn(void)

{
  char *pcVar1;
  undefined2 *puVar2;
  undefined2 *puVar3;
  byte bVar4;
  undefined2 uVar5;
  undefined4 uVar6;
  void *pvVar7;
  TURNSERIAL *pTVar8;
  ushort *puVar9;
  COLDROP *pCVar10;
  XFERFULL *pXVar11;
  FLEET *pFVar12;
  HCURSOR HVar13;
  short sVar14;
  uint uVar15;
  short sVar16;
  ushort uVar17;
  char *pcVar18;
  ushort uVar19;
  uint uVar20;
  char *pcVar21;
  int iVar22;
  int iVar23;
  int *piVar24;
  int iVar25;
  int *piVar26;
  undefined2 *puVar27;
  undefined2 *puVar28;
  undefined2 uVar29;
  undefined2 uVar30;
  undefined2 unaff_SS;
  PL *pPVar31;
  ulong uVar32;
  undefined2 auStack_16c [2];
  short sStack_168;
  uint uStack_166;
  int iStack_162;
  uint uStack_160;
  uint uStack_15e;
  short pctDetect;
  short dRange;
  short dPlanRange;
  int iStack_156;
  short fSuccess;
  char *pchBak;
  short fFollow;
  short idCur;
  ushort hcurSav;
  char szT [256];
  short env [9];
  short i;
  char *pchCur;
  FLEET *lpfl;
  short ifl;
  short (*penvMemSav) [9];
  byte rgfNoXFile [16];
  byte mpiplr2 [16];
  short j;
  short ish;
  char *pchT;
  short fErrSav;
  
                    /* Segment:    23
                       Offset:     0009e840
                       Length:     9eb8
                       Min Alloc:  9eb8
                       Flags:      1d10
                           Code
                           Discardable
                           Moveable
                           LoadOnCall
                           Impure (Non-shareable)
                        */
  idCur = _DATA::idPlayer;
  fSuccess = 0;
  HVar13 = LOADCURSOR(0,(LPCSTR)0x7f02);
  hcurSav = SETCURSOR(HVar13);
  IO::DestroyCurGame();
  if (((uint)_DATA::gd.flags1 >> 0xb & 1) != 0) {
    UTILGEN::Randomize(0x499602d2);
  }
  sVar16 = _DATA::fFileErrSilent;
  _DATA::fFileErrSilent = 1;
  UTILGEN::UpdateProgressGauge(0x168);
  sVar14 = IO::FLoadGame((char *)c_common::szBase,(char *)0x9c4);
  if (sVar14 == 0) {
    _DATA::fFileErrSilent = sVar16;
    SETCURSOR(hcurSav);
    UTIL::TurnLog(idsCantFindHostFile);
    pXVar11 = (XFERFULL *)CONCAT22(_DATA::lpxf._2_2_,_DATA::lpxf._0_2_);
    pCVar10 = (COLDROP *)CONCAT22(_DATA::lpcd._2_2_,_DATA::lpcd._0_2_);
    puVar9 = (ushort *)CONCAT22(_DATA::vrgPlanResExtra._2_2_,_DATA::vrgPlanResExtra._0_2_);
    pTVar8 = (TURNSERIAL *)CONCAT22(_DATA::vrgts._2_2_,(int)_DATA::vrgts);
    fSuccess = 0;
  }
  else {
    UTIL::TurnLog(idsGeneratingYearD);
    _DATA::fFileErrSilent = sVar16;
    if (_DATA::wVersFile >> 0xc == 0) {
      i = 0;
      while ((i < _DATA::game.cPlayer &&
             ((*(uint *)((int)&c_common::rgplr[0].flags4 + i * 0xc0) >> 3 & 0x1f) == 0))) {
        i = i + 1;
      }
      if (i == _DATA::game.cPlayer) {
        for (i = 0; i < _DATA::game.cPlayer; i = i + 1) {
          uVar20 = (i & 0x1fU) << 3;
          uVar15 = *(uint *)((int)&c_common::rgplr[0].flags4 + i * 0xc0) & 0xff07 | uVar20;
          _dRange = (FLEET *)CONCAT22(uVar20,uVar15);
          *(uint *)((int)&c_common::rgplr[0].flags4 + i * 0xc0) = uVar15;
        }
      }
    }
    _penvMem = env;
    sVar16 = PUBLIC::__setjmp(env);
    if (sVar16 == 0) {
      _DATA::lpcd = (COLDROP *)MEMORY::LpAlloc(12000,htMisc);
      _DATA::lpxf = (XFERFULL *)MEMORY::LpAlloc(25000,htMisc);
      _DATA::vrgPlanResExtra = (ushort *)MEMORY::LpAlloc(_DATA::game.cPlanMax << 1,htMisc);
      PUBLIC::__fmemset(_DATA::vrgPlanResExtra,0,_DATA::game.cPlanMax << 1);
      _DATA::vrgts = (TURNSERIAL *)MEMORY::LpAlloc(_DATA::game.cPlayer << 4,htMisc);
      UTILGEN::UpdateProgressGauge(0x172);
      c_common::cColDrop = 0;
      c_common::cXferFull = 0;
      _DATA::gd.flags1 = _DATA::gd.flags1 & 0xfdfdU | 0x202;
      _DATA::imemMsgCur = 0;
      for (i = 0; i < _DATA::game.cPlayer; i = i + 1) {
        mpiplr2[i] = (byte)i;
      }
      for (i = 0; i < _DATA::game.cPlayer; i = i + 1) {
        sVar16 = UTILGEN::Random(_DATA::game.cPlayer - i);
        iVar22 = sVar16 + i;
        if (iVar22 != i) {
          bVar4 = mpiplr2[iVar22];
          idCur = (short)bVar4;
          mpiplr2[iVar22] = mpiplr2[i];
          mpiplr2[i] = bVar4;
        }
      }
      for (i = 0; i < _DATA::game.cPlayer; i = i + 1) {
        uVar20 = (uint)mpiplr2[i];
        _WSPRINTF((LPSTR)0x56a21120,(LPCSTR)0x9c81120,(int)c_common::szWork);
        uVar29 = _DATA::vrgts._2_2_;
        puVar28 = (undefined2 *)((int)_DATA::vrgts + uVar20 * 0x10);
        _DATA::idPlayer = uVar20;
        *puVar28 = 0xffff;
        puVar28[1] = 0xffff;
        sVar16 = PLANET::FLoadLogFile((char *)c_common::szWork);
        if (sVar16 != 0) {
          sVar16 = PLANET::FRunLogFile();
          if (sVar16 == 0) {
            sVar16 = 0x10;
            pcVar18 = MSG::PszFormatIds(idsPlayerLogFileAppearsCorruptUnableLoad,(short *)0x0);
            UTILGEN::AlertSz(pcVar18,sVar16);
            goto TURN_FreeStuffUp;
          }
        }
        sVar16 = MULDIV(0x3c,i + 1,_DATA::game.cPlayer);
        UTILGEN::UpdateProgressGauge(sVar16 + 0x172);
      }
      _DATA::idPlayer = -1;
      i = 0;
      pTVar8 = _DATA::vrgts;
      while( true ) {
        _DATA::vrgts._2_2_ = (undefined2)((ulong)pTVar8 >> 0x10);
        _DATA::vrgts._0_2_ = (int)pTVar8;
        if (_DATA::game.cPlayer <= i) break;
        _DATA::vrgts = pTVar8;
        if ((((*(uint *)((int)&c_common::rgplr[0].flags43 + i * 0xc0) >> 1 & 1) == 0) &&
            ((*(uint *)((int)&c_common::rgplr[0].flags4 + i * 0xc0) >> 9 & 1) == 0)) &&
           ((((uint)_DATA::gd.flags1 >> 0xb & 1) == 0 || (i != 0)))) {
          piVar24 = (int *)((int)_DATA::vrgts + i * 0x10);
          if ((*piVar24 != -1) || (piVar24[1] != -1)) {
            puVar28 = (undefined2 *)((int)_DATA::vrgts + i * 0x10);
            puVar2 = puVar28;
            puVar3 = puVar28 + 1;
            sVar16 = IO::FValidSerialLong(CONCAT22(*puVar3,*puVar2));
            pTVar8 = _DATA::vrgts;
            if (sVar16 == 0) {
              _dRange = (FLEET *)(CONCAT22(*(undefined2 *)
                                            ((int)&c_common::rgplr[0].flags43 + i * 0xc0),dRange) &
                                  0xfffbffff | 0x40000);
              *(short *)((int)&c_common::rgplr[0].flags43 + i * 0xc0) = dPlanRange;
              pTVar8 = _DATA::vrgts;
              goto LAB_10b0_03c3;
            }
          }
          _DATA::vrgts._2_2_ = (undefined2)((ulong)pTVar8 >> 0x10);
          _DATA::vrgts._0_2_ = (int)pTVar8;
          piVar24 = (int *)((int)_DATA::vrgts + i * 0x10);
          if ((*piVar24 != -1) || (piVar24[1] != -1)) {
            _dRange = (FLEET *)(CONCAT22(*(undefined2 *)
                                          ((int)&c_common::rgplr[0].flags43 + i * 0xc0),dRange) &
                               0xfffbffff);
            _DATA::vrgts = pTVar8;
            *(short *)((int)&c_common::rgplr[0].flags43 + i * 0xc0) = dPlanRange;
            j = 0;
            pTVar8 = _DATA::vrgts;
            while( true ) {
              _DATA::vrgts._2_2_ = (undefined2)((ulong)pTVar8 >> 0x10);
              _DATA::vrgts._0_2_ = (int)pTVar8;
              if (i <= j) break;
              if (((*(uint *)((int)&c_common::rgplr[0].flags43 + j * 0xc0) >> 1 & 1) == 0) &&
                 ((*(uint *)((int)&c_common::rgplr[0].flags4 + j * 0xc0) >> 9 & 1) == 0)) {
                piVar24 = (int *)((int)_DATA::vrgts + j * 0x10);
                piVar26 = (int *)((int)_DATA::vrgts + i * 0x10);
                if ((*piVar26 == *piVar24) && (piVar26[1] == piVar24[1])) {
                  iVar22 = (int)_DATA::vrgts + j * 0x10;
                  pvVar7 = (void *)CONCAT22(_DATA::vrgts._2_2_,(int)_DATA::vrgts + i * 0x10 + 4);
                  _DATA::vrgts = pTVar8;
                  sVar16 = PUBLIC::__fmemcmp(pvVar7,(void *)CONCAT13((char)((ulong)pTVar8 >> 0x18),
                                                                     CONCAT12((char)((ulong)pTVar8
                                                                                    >> 0x10),
                                                                              iVar22 + 4)),0xb);
                  pTVar8 = _DATA::vrgts;
                  if (sVar16 != 0) {
                    uVar20 = *(uint *)((int)&c_common::rgplr[0].flags43 + j * 0xc0) & 0xfffb | 4;
                    *(uint *)((int)&c_common::rgplr[0].flags43 + j * 0xc0) = uVar20;
                    _dRange = (FLEET *)CONCAT22(1,uVar20);
                    pctDetect = 4;
                    uStack_15e = *(uint *)((int)&c_common::rgplr[0].flags43 + i * 0xc0) & 0xfffb | 4
                    ;
                    *(uint *)((int)&c_common::rgplr[0].flags43 + i * 0xc0) = uStack_15e;
                    pTVar8 = _DATA::vrgts;
                  }
                }
              }
              j = j + 1;
            }
          }
        }
        else {
          _dRange = (FLEET *)(CONCAT22(*(undefined2 *)((int)&c_common::rgplr[0].flags43 + i * 0xc0),
                                       dRange) & 0xfffbffff);
          *(short *)((int)&c_common::rgplr[0].flags43 + i * 0xc0) = dPlanRange;
          pTVar8 = _DATA::vrgts;
        }
LAB_10b0_03c3:
        i = i + 1;
      }
      for (i = 0; i < _DATA::game.cPlayer; i = i + 1) {
        if ((*(uint *)((int)&c_common::rgplr[0].flags43 + i * 0xc0) >> 2 & 1) != 0) {
          _DATA::vrgts = pTVar8;
          sVar16 = MAIN::IPlrAlsoCheater(i);
          MSG::FSendPlrMsg2(i,(sVar16 != -1) + idmPopulationSuspectsUsurperProductivityOff20Growth,
                            -5,sVar16,0);
          pTVar8 = _DATA::vrgts;
          if ((10 < (uint)_DATA::game.turn) && ((_DATA::game.turn & 7U) == (i & 7U))) {
            MSG::FSendPlrMsg2(i,idmFleetCaptainsHaveStagedStrikeDemandFree,-5,0,0);
            pTVar8 = _DATA::vrgts;
          }
        }
      }
      for (i = 0; i < _DATA::game.cPlayer; i = i + 1) {
        for (ish = 0; ish < 0x10; ish = ish + 1) {
          if (((*(uint *)(*(int *)(i * 4 + 0xfe) + ish * 0x93 + 0x7b) >> 9 & 1) == 0) &&
             (*(int *)(*(int *)(i * 4 + 0xfe) + ish * 0x93 + 0x3a) != 1)) {
            _DATA::vrgts = pTVar8;
            *(undefined2 *)(*(int *)(i * 4 + 0xfe) + ish * 0x93 + 0x3a) = 1;
            uVar32 = CONCAT22(*(undefined2 *)(*(int *)(i * 4 + 0xfe) + ish * 0x93 + 0x3c),dRange) &
                     0xff00ffff;
            _dRange = (FLEET *)(uVar32 | 0x10000);
            *(short *)(*(int *)(i * 4 + 0xfe) + ish * 0x93 + 0x3c) = dPlanRange;
            pTVar8 = _DATA::vrgts;
            if (*(uint *)(*(int *)(i * 4 + 0xfe) + ish * 0x93 + 0x3c) >> 8 == 0) {
              dRange = (short)uVar32;
              _dRange = (FLEET *)(CONCAT22(*(undefined2 *)
                                            (*(int *)(i * 4 + 0xfe) + ish * 0x93 + 0x3c),dRange) &
                                  0xffffff | 0x1000000);
              *(short *)(*(int *)(i * 4 + 0xfe) + ish * 0x93 + 0x3c) = dPlanRange;
              pTVar8 = _DATA::vrgts;
            }
          }
        }
      }
      fFollow = 0;
      for (ifl = 0; _DATA::vrgts = pTVar8, ifl < c_common::cFleet; ifl = ifl + 1) {
        piVar24 = (int *)((int)_DATA::rglpfl + ifl * 4);
        iVar22 = *piVar24;
        iVar25 = piVar24[1];
        lpfl = (FLEET *)CONCAT22(iVar25,iVar22);
        if ((iVar22 == 0) && (iVar25 == 0)) break;
        *(uint *)(iVar22 + 4) = *(uint *)(iVar22 + 4) & 0xbfff;
        if ((*(int *)(iVar22 + 0x62) == 1) &&
           (uVar6 = *(undefined4 *)(iVar22 + 100), (*(uint *)((int)uVar6 + 10) >> 8 & 0xf) == 2)) {
          fFollow = 1;
          *(uint *)(iVar22 + 4) = *(uint *)(iVar22 + 4) & 0x7fff | 0x8000;
          pTVar8 = _DATA::vrgts;
        }
        else {
          uVar6 = *(undefined4 *)(iVar22 + 100);
          if (((*(uint *)((int)uVar6 + 10) >> 8 & 0xf) == 2) && (*(int *)(iVar22 + 0x62) == 1)) {
            MSG::FSendPlrMsg(*(short *)(iVar22 + 2),idmHadOrdersFollowFleetWhichDidntMove,
                             lpfl->flags1 | 0x8000,lpfl->flags1,0,0,0,0,0,0);
          }
          *(uint *)(iVar22 + 4) = *(uint *)(iVar22 + 4) & 0x7fff;
          pTVar8 = _DATA::vrgts;
        }
      }
      UTIL::ValidateWaypoints();
      if (fFollow != 0) {
        fFollow = 1;
        i = 0;
        while ((i < 8 && (fFollow != 0))) {
          fFollow = 0;
          for (ifl = 0; ifl < c_common::cFleet; ifl = ifl + 1) {
            piVar24 = (int *)((int)_DATA::rglpfl + ifl * 4);
            iVar22 = *piVar24;
            iVar25 = piVar24[1];
            lpfl = (FLEET *)CONCAT22(iVar25,iVar22);
            if ((iVar22 == 0) && (iVar25 == 0)) break;
            if ((*(int *)(iVar22 + 4) < 0) && (*(int *)(iVar22 + 0x62) == 1)) {
              uVar29 = *(undefined2 *)(iVar22 + 0x66);
              puVar27 = (undefined2 *)(*(int *)(iVar22 + 100) + 4);
              puVar28 = auStack_16c;
              for (iVar22 = 9; iVar22 != 0; iVar22 = iVar22 + -1) {
                puVar3 = puVar28;
                puVar28 = puVar28 + 1;
                puVar2 = puVar27;
                puVar27 = puVar27 + 1;
                *puVar3 = *puVar2;
              }
              iVar22 = (int)lpfl;
              uVar29 = (undefined2)((ulong)lpfl >> 0x10);
              if ((uStack_166 >> 8 & 0xf) == 2) {
                _dRange = UTIL::LpflFromId(sStack_168);
                iVar23 = (int)((ulong)_dRange >> 0x10);
                iVar25 = (int)_dRange;
                if (((iVar25 != 0) || (iVar23 != 0)) &&
                   ((*(int *)(iVar25 + 0x62) != 1 ||
                    (uVar6 = *(undefined4 *)(iVar25 + 100),
                    (*(uint *)((int)uVar6 + 10) >> 8 & 0xf) == 2)))) {
                  if (*(int *)(iVar25 + 0x62) != 1) {
                    fFollow = 1;
                    uVar6 = *(undefined4 *)(iVar22 + 100);
                    if (*(byte *)((int)uVar6 + 2) < 2) {
                      uVar5 = *(undefined2 *)(iVar22 + 0x66);
                      pPVar31 = MEMORY::LpplReAlloc((PL *)CONCAT13((char)((uint)uVar5 >> 8),
                                                                   CONCAT12((char)uVar5,
                                                                            *(undefined2 *)
                                                                             (iVar22 + 100))),2);
                      *(undefined2 *)(iVar22 + 100) = (int)pPVar31;
                      *(undefined2 *)(iVar22 + 0x66) = (int)((ulong)pPVar31 >> 0x10);
                    }
                    uVar30 = (undefined2)((ulong)_dRange >> 0x10);
                    uVar5 = *(undefined2 *)((int)_dRange + 0x66);
                    puVar28 = (undefined2 *)(*(int *)((int)_dRange + 100) + 0x16);
                    uVar30 = *(undefined2 *)(iVar22 + 0x66);
                    puVar27 = (undefined2 *)(*(int *)(iVar22 + 100) + 0x16);
                    for (iVar25 = 9; iVar25 != 0; iVar25 = iVar25 + -1) {
                      puVar3 = puVar27;
                      puVar27 = puVar27 + 1;
                      puVar2 = puVar28;
                      puVar28 = puVar28 + 1;
                      *puVar3 = *puVar2;
                    }
                    uVar5 = *(undefined2 *)(iVar22 + 0x66);
                    puVar28 = (undefined2 *)(*(int *)(iVar22 + 100) + 0xc);
                    uVar30 = *(undefined2 *)(iVar22 + 0x66);
                    puVar27 = (undefined2 *)(*(int *)(iVar22 + 100) + 0x1e);
                    for (iVar25 = 5; iVar25 != 0; iVar25 = iVar25 + -1) {
                      puVar3 = puVar27;
                      puVar27 = puVar27 + 1;
                      puVar2 = puVar28;
                      puVar28 = puVar28 + 1;
                      *puVar3 = *puVar2;
                    }
                    *(undefined2 *)(iVar22 + 0x62) = 2;
                    uVar6 = *(undefined4 *)(iVar22 + 100);
                    *(undefined *)((int)uVar6 + 3) = 2;
                  }
                  goto LAB_10b0_09f2;
                }
                MSG::FSendPlrMsg(*(short *)(iVar22 + 2),idmHadOrdersFollowFleetWhichDidntMove,
                                 lpfl->flags1 | 0x8000,lpfl->flags1,0,0,0,0,0,0);
              }
              *(uint *)(iVar22 + 4) = *(uint *)(iVar22 + 4) & 0x7fff;
            }
LAB_10b0_09f2:
          }
          i = i + 1;
        }
      }
      UTILGEN::UpdateProgressGauge(0x1b8);
      DoOrders(0);
      UTILGEN::UpdateProgressGauge(0x212);
      for (i = 0; i < _DATA::game.cPlayer; i = i + 1) {
        _dRange = (FLEET *)((ulong)_dRange & 0xffff0000);
        while (dRange < 0x10) {
          sVar16 = RACE::GetRaceStat((PLAYER *)((int)c_common::rgplr + i * 0xc0),dRange);
          RACE::SetRaceStat((PLAYER *)((int)c_common::rgplr + i * 0xc0),dRange,sVar16);
          _dRange = (FLEET *)CONCAT22(dPlanRange,dRange + 1);
        }
        if ((*(char *)((int)&c_common::rgplr[0].pctResearch + i * 0xc0) < '\0') ||
           ('d' < *(char *)((int)&c_common::rgplr[0].pctResearch + i * 0xc0))) {
          *(undefined *)((int)&c_common::rgplr[0].pctResearch + i * 0xc0) = 0xf;
        }
        if (*(char *)((int)&c_common::rgplr[0].pctIdealGrowth + i * 0xc0) < '\0') {
          *(undefined *)((int)&c_common::rgplr[0].pctIdealGrowth + i * 0xc0) = 1;
        }
        if ('\x14' < *(char *)((int)&c_common::rgplr[0].pctIdealGrowth + i * 0xc0)) {
          *(undefined *)((int)&c_common::rgplr[0].pctIdealGrowth + i * 0xc0) = 0x14;
        }
        _dRange = (FLEET *)(CONCAT22(dPlanRange,
                                     *(uint *)((int)&c_common::rgplr[0].flags43 + i * 0xc0) >> 4) &
                           0xffff0001);
        sVar16 = RACE::CAdvantagePoints((PLAYER *)((int)c_common::rgplr + i * 0xc0));
        _dRange = (FLEET *)CONCAT22(sVar16,dRange);
        pFVar12 = _dRange;
        if (((sVar16 < 0) ||
            (dRange != (*(uint *)((int)&c_common::rgplr[0].flags43 + i * 0xc0) >> 4 & 1))) &&
           ((*(uint *)((int)&c_common::rgplr[0].flags4 + i * 0xc0) >> 9 & 1) == 0)) {
          MSG::FSendPlrMsg2(i,idmRaceDefinitionHasTamperedStatisticsHaveAltered,-1,0,0);
          _dRange = (FLEET *)((ulong)_dRange & 0xffff0000);
          while (dRange < _DATA::game.cPlayer) {
            if ((i != dRange) &&
               ((*(uint *)((int)&c_common::rgplr[0].flags4 + i * 0xc0) >> 9 & 1) == 0)) {
              MSG::FSendPlrMsg2(dRange,idmHackedRaceDiscoveredRaceStatisticsHaveAltered,-1,i,0);
            }
            _dRange = (FLEET *)CONCAT22(dPlanRange,dRange + 1);
          }
          pctDetect = *(uint *)((int)&c_common::rgplr[0].flags43 + i * 0xc0) & 0xffef | 0x10;
          *(uint *)((int)&c_common::rgplr[0].flags43 + i * 0xc0) = pctDetect;
          pFVar12 = _dRange;
          iVar22 = dPlanRange;
          while ((iVar22 < 500 && (*(char *)((int)c_common::rgplr[0].rgAttr + i * 0xc0) < '\x19')))
          {
            pcVar1 = (char *)((int)c_common::rgplr[0].rgAttr + i * 0xc0);
            *pcVar1 = *pcVar1 + '\x01';
            _dRange = pFVar12;
            iVar22 = RACE::CAdvantagePoints((PLAYER *)((int)c_common::rgplr + i * 0xc0));
            _dRange = (FLEET *)CONCAT22(iVar22,dRange);
            pFVar12 = _dRange;
          }
          dPlanRange = (short)((ulong)pFVar12 >> 0x10);
          iVar22 = dPlanRange;
          while ((iVar22 < 500 &&
                 ('\x01' < *(char *)((int)&c_common::rgplr[0].pctIdealGrowth + i * 0xc0)))) {
            pcVar1 = (char *)((int)&c_common::rgplr[0].pctIdealGrowth + i * 0xc0);
            *pcVar1 = *pcVar1 + -1;
            _dRange = pFVar12;
            iVar22 = RACE::CAdvantagePoints((PLAYER *)((int)c_common::rgplr + i * 0xc0));
            _dRange = (FLEET *)CONCAT22(iVar22,dRange);
            pFVar12 = _dRange;
          }
          dPlanRange = (short)((ulong)pFVar12 >> 0x10);
          if (dPlanRange < 500) {
            _dRange = (FLEET *)CONCAT22(dPlanRange,8);
            while (pFVar12 = _dRange, dRange < 0xe) {
              *(undefined *)(i * 0xc0 + 0x59e0 + dRange) = 0;
              sVar16 = RACE::CAdvantagePoints((PLAYER *)((int)c_common::rgplr + i * 0xc0));
              _dRange = (FLEET *)CONCAT22(sVar16,dRange);
              pFVar12 = _dRange;
              if (499 < sVar16) break;
              _dRange = (FLEET *)CONCAT22(sVar16,dRange + 1);
            }
          }
        }
        _dRange = pFVar12;
      }
      TURN2::UnmarkMineFields();
      MoveThings(0);
      UTILGEN::UpdateProgressGauge(0x226);
      MoveFleets();
      uVar20 = _DATA::lpPlanets._2_2_;
      pctDetect = _DATA::lpPlanets._2_2_;
      uStack_15e = (int)_DATA::lpPlanets + c_common::cPlanet * 0x38;
      iStack_162 = (int)_DATA::lpPlanets;
      for (dRange = iStack_162; (uint)dRange < uStack_15e; dRange = dRange + 0x38) {
        *(uint *)(dRange + 4) = *(uint *)(dRange + 4) & 0xfbff;
      }
      uStack_160 = pctDetect;
      for (i = 0; i < _DATA::game.cPlayer; i = i + 1) {
        uStack_160 = *(uint *)((int)_DATA::lpPlanets +
                               *(int *)((int)&c_common::rgplr[0].idPlanetHome + i * 0xc0) * 0x38 + 4
                              ) & 0xfbff | 0x400;
        *(uint *)((int)_DATA::lpPlanets +
                  *(int *)((int)&c_common::rgplr[0].idPlanetHome + i * 0xc0) * 0x38 + 4) =
             uStack_160;
      }
      dPlanRange = pctDetect;
      UTILGEN::UpdateProgressGauge(0x28a);
      TURN2::ThingDecay();
      TURN2::BreedColonistsInTransit();
      UTILGEN::UpdateProgressGauge(700);
      TURN2::Produce();
      UTILGEN::UpdateProgressGauge(0x2ee);
      MoveThings(1);
      UTILGEN::UpdateProgressGauge(0x302);
      FuelFleets();
      DoOrders(1);
      TURN2::SweepForMines();
      TURN2::HealShips();
      TURN2::AutoTerraform();
      TURN2::RemoteTerraforming();
      UTILGEN::UpdateProgressGauge(0x352);
      BATTLE::SpankTheCheaters();
      UTIL::ValidateWaypoints();
      TURN2::UpdateGuesses();
      UTILGEN::UpdateProgressGauge(0x354);
      IO::FMarkFile(2,-1,1,0);
      TURN2::CreateBackupDir();
      _DATA::game.turn = _DATA::game.turn + 1;
      uVar17 = PUBLIC::_strlen((char *)c_common::szBase);
      pcVar21 = (char *)((int)c_common::szBase + uVar17);
      pcVar18 = PUBLIC::_strrchr((char *)c_common::szBase,0x5c);
      PUBLIC::_strcpy(szT,(char *)c_common::szBackup);
      if (pcVar18 == (char *)0x0) {
        PUBLIC::_strcat(szT,(char *)c_common::szBase);
      }
      else {
        PUBLIC::_strcat(szT,pcVar18 + 1);
      }
      uVar19 = PUBLIC::_strlen(szT);
      pchBak = szT + uVar19;
      UTILGEN::UpdateProgressGauge(0x356);
      TURN2::UpdatePlayerScores();
      for (i = 0; i < _DATA::game.cPlayer; i = i + 1) {
        for (j = 0; j < 10; j = j + 1) {
          if ((*(uint *)(*(int *)(i * 4 + 0x14c) + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
            sVar16 = PLANET::PctCloakFromHuldef
                               ((HUL *)CONCAT22(*(undefined2 *)(i * 4 + 0x14e),
                                                *(int *)(i * 4 + 0x14c) + j * 0x93),i,(short *)0x0);
            iVar22 = 100 - sVar16;
            _dRange = (FLEET *)(long)iVar22;
            uVar29 = *(undefined2 *)(i * 4 + 0x14e);
            iVar25 = *(int *)(i * 4 + 0x14c) + j * 0x93;
            *(int *)(iVar25 + 0x87) = iVar22;
            *(int *)(iVar25 + 0x89) = iVar22 >> 0xf;
            uVar29 = *(undefined2 *)(i * 4 + 0x14e);
            iVar22 = *(int *)(i * 4 + 0x14c) + j * 0x93;
            uVar5 = *(undefined2 *)(i * 4 + 0x14e);
            iVar25 = *(int *)(i * 4 + 0x14c) + j * 0x93;
            uVar32 = PUBLIC::__aFulmul(CONCAT22(*(undefined2 *)(iVar25 + 0x89),
                                                *(undefined2 *)(iVar25 + 0x87)),
                                       CONCAT22(*(undefined2 *)(iVar22 + 0x89),
                                                *(undefined2 *)(iVar22 + 0x87)));
            dPlanRange = (short)(uVar32 >> 0x10);
            dRange = (short)uVar32;
            uVar29 = *(undefined2 *)(i * 4 + 0x14e);
            iVar22 = *(int *)(i * 4 + 0x14c) + j * 0x93;
            *(short *)(iVar22 + 0x87) = dRange;
            *(short *)(iVar22 + 0x89) = dPlanRange;
          }
        }
        for (j = 0; j < 0x10; j = j + 1) {
          if ((*(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) >> 9 & 1) == 0) {
            dRange = UTIL::GetShdefScannerRange
                               ((SHDEF *)CONCAT22(*(undefined2 *)(i * 4 + 0x100),
                                                  *(int *)(i * 4 + 0xfe) + j * 0x93),i,&dPlanRange,
                                (short *)&uStack_15e,&pctDetect);
            *(short *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x8d) = dRange;
            *(short *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x8f) = dPlanRange;
            *(undefined *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x91) = (char)uStack_15e;
            uStack_160 = pctDetect;
            *(undefined *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x92) = (char)pctDetect;
            uVar29 = *(undefined2 *)(i * 4 + 0x100);
            sVar16 = UTIL::FCanBuildShdef
                               ((SHDEF *)CONCAT13((char)((uint)uVar29 >> 8),
                                                  CONCAT12((char)uVar29,
                                                           *(int *)(i * 4 + 0xfe) + j * 0x93)),i);
            if (sVar16 == 0) {
              uStack_160 = *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) & 0x7fff | 0x8000;
              *(uint *)(*(int *)(i * 4 + 0xfe) + j * 0x93 + 0x7b) = uStack_160;
            }
          }
        }
      }
      j = 0x358;
      iStack_156 = 0;
      PUBLIC::_memset(rgfNoXFile,0,0x10);
      i = 0;
      while (iStack_156 == 0) {
        UTILGEN::UpdateProgressGauge(j);
        j = j + (int)(0x11 / (long)(_DATA::game.cPlayer + 1));
        if (_DATA::game.cPlayer <= i) {
          i = -1;
          iStack_156 = 1;
        }
        if (i < 0) {
          PUBLIC::_strcpy(pcVar21,(char *)0x9d4);
          PUBLIC::_strcpy(pchBak,(char *)0x9d9);
        }
        else {
          _WSPRINTF((LPSTR)CONCAT22(i + 1,0x1120),(LPCSTR)0x9cf1120,pcVar21);
          PUBLIC::_strcpy(pchBak,pcVar21);
          PUBLIC::_remove(szT);
          sVar16 = PUBLIC::__access((char *)c_common::szBase,0);
          if (sVar16 == -1) {
            rgfNoXFile[i] = 1;
          }
          else {
            PUBLIC::_rename((char *)c_common::szBase,szT);
          }
          pchBak[1] = 'm';
          *(undefined *)((int)c_common::szBase + 1 + uVar17) = 0x6d;
        }
        PUBLIC::_remove(szT);
        if ((i < 0) || (rgfNoXFile[i] == 0)) {
          PUBLIC::_rename((char *)c_common::szBase,szT);
        }
        else {
          UTILGEN::CopyFile((char *)c_common::szBase,szT);
        }
        *pcVar21 = '\0';
        i = i + 1;
      }
      j = 0x36b;
      iStack_156 = 0;
      uVar20 = UTILGEN::Random(8);
      _dRange = (FLEET *)CONCAT22(uVar20,dRange);
      _DATA::game.flags9 = _DATA::game.flags9 & 0xf1ffU | (uVar20 & 7) << 9;
      i = 0;
      while (iStack_156 == 0) {
        UTILGEN::UpdateProgressGauge(j);
        j = j + (int)(0x7a / (long)(_DATA::game.cPlayer + 1));
        if (_DATA::game.cPlayer <= i) {
          i = -1;
          iStack_156 = 1;
        }
        if ((i == -1) || (rgfNoXFile[i] == 0)) {
          sVar16 = 0;
        }
        else {
          sVar16 = 1;
        }
        IO::FWriteDataFile((char *)c_common::szBase,i,sVar16);
        i = i + 1;
      }
      UTILGEN::UpdateProgressGauge(0x3e6);
      _DATA::imemLogCur = 0;
      fSuccess = 1;
    }
TURN_FreeStuffUp:
    UTILGEN::UpdateProgressGauge(1000);
    MEMORY::FreeLp(_DATA::vrgPlanResExtra,htMisc);
                    /* WARNING: Ignoring partial resolution of indirect */
    _DATA::vrgPlanResExtra._0_2_ = 0;
                    /* WARNING: Ignoring partial resolution of indirect */
    _DATA::vrgPlanResExtra._2_2_ = 0;
    MEMORY::FreeLp(_DATA::vrgts,htMisc);
                    /* WARNING: Ignoring partial resolution of indirect */
    _DATA::vrgts._0_2_ = 0;
                    /* WARNING: Ignoring partial resolution of indirect */
    _DATA::vrgts._2_2_ = 0;
    MEMORY::FreeLp(_DATA::lpcd,htMisc);
                    /* WARNING: Ignoring partial resolution of indirect */
    _DATA::lpcd._0_2_ = 0;
                    /* WARNING: Ignoring partial resolution of indirect */
    _DATA::lpcd._2_2_ = 0;
    MEMORY::FreeLp(_DATA::lpxf,htMisc);
                    /* WARNING: Ignoring partial resolution of indirect */
    _DATA::lpxf._0_2_ = 0;
                    /* WARNING: Ignoring partial resolution of indirect */
    _DATA::lpxf._2_2_ = 0;
    _DATA::gd.flags1 = _DATA::gd.flags1 & 0xfdfd;
    _DATA::idPlayer = -1;
    if ((fSuccess != 0) && (((uint)c_common::ini.flags6 >> 3 & 1) != 0)) {
      _DATA::vretExitValue = 1;
    }
    SETCURSOR(hcurSav);
    UTIL::TurnLog(fSuccess + idsFailed);
    pTVar8 = _DATA::vrgts;
    puVar9 = _DATA::vrgPlanResExtra;
    pCVar10 = _DATA::lpcd;
    pXVar11 = _DATA::lpxf;
  }
  _DATA::lpxf._2_2_ = (undefined2)((ulong)pXVar11 >> 0x10);
  _DATA::lpxf._0_2_ = SUB42(pXVar11,0);
  _DATA::lpcd._2_2_ = (undefined2)((ulong)pCVar10 >> 0x10);
  _DATA::lpcd._0_2_ = SUB42(pCVar10,0);
  _DATA::vrgPlanResExtra._2_2_ = (undefined2)((ulong)puVar9 >> 0x10);
  _DATA::vrgPlanResExtra._0_2_ = SUB42(puVar9,0);
  _DATA::vrgts._2_2_ = (undefined2)((ulong)pTVar8 >> 0x10);
  _DATA::vrgts._0_2_ = (int)pTVar8;
  return fSuccess;
}



